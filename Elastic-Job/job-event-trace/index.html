
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">

    <meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E">
    <meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0">
    <meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214">
    <meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1">
    <meta name="sogou_site_verification" content="MpPsku240L">

  
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šäº‹ä»¶è¿½è¸ª | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="ç‹æ–‡æ–Œ">
    
    <meta name="description" content="æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«

1. æ¦‚è¿°
2. ä½œä¸šäº‹ä»¶æ€»çº¿
3. ä½œä¸šäº‹ä»¶
3.1 ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶
3.2 ä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶
3.3 ä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨
3.4 ä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢


4. ä½œä¸šç›‘å¬å™¨
666. å½©è›‹




ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ">
    

    
    <meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨">
    

    
    
    <link rel="alternate" href="atom.xml" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/favicon.ico">
    
    
    <link rel="stylesheet" href="/css/style.css">
    
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            var _bdId ='9e70e3362807c1bd185a79655b307027';
             hm.src = "//hm.baidu.com/hm.js?" + _bdId;
             var s = document.getElementsByTagName("script")[0]; 
             s.parentNode.insertBefore(hm, s);
        })();
    </script>
    

    <!-- ç™¾åº¦ç«™é•¿-è¢«åŠ¨æ¨é€ -->
    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

    <!-- 360æœç´¢-è‡ªåŠ¨æ”¶å½• -->
    <script>
        (function(){
            var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";
            document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

    <!-- ä¸è’œå­ç»Ÿè®¡ -->
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</head>
</html>
  <body>
    <header>
      <div>
    
    <div id="textlogo">
        <h1 class="site-name"><a href="/" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG">èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</a></h1>
        <a class="blog-motto">
            
            æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼
            
        </a>
    </div>
    <div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•">
        </a></div>
    <nav class="animated">
        <ul>
            <ul>
                
                <li><a href="/">æ–‡ç« </a></li>
                
                <li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li>
                
                <li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li>
                
                <li><a href="/link_url">å‹é“¾</a></li>
                
                <!--<li>-->
                    <!---->
                        <!--<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">-->
                            <!--<label>Search</label>-->
                            <!--<input type="text" id="search" name="q" autocomplete="off" maxlength="20"-->
                                   <!--placeholder="æœç´¢"/>-->
                            <!--<input type="hidden" name="q" value="site:www.iocoder.cn">-->
                        <!--</form>-->
                        <!---->
                <!--</li>-->
            </ul>
    </ul></nav>
</div>

    </header>
    <div id="container">
        <div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div>

<div id="toc" class="toc-aside">
    <strong class="toc-title">æ–‡ç« ç›®å½•</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-ä½œä¸šäº‹ä»¶æ€»çº¿"><span class="toc-number">2.</span> <span class="toc-text">2. ä½œä¸šäº‹ä»¶æ€»çº¿</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-ä½œä¸šäº‹ä»¶"><span class="toc-number">3.</span> <span class="toc-text">3. ä½œä¸šäº‹ä»¶</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-ä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 ä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-ä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 ä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-ä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 ä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-ä½œä¸šç›‘å¬å™¨"><span class="toc-number">4.</span> <span class="toc-text">4. ä½œä¸šç›‘å¬å™¨</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-å½©è›‹"><span class="toc-number">5.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol>
</div>

<div id="asidepart">
    <!--<div class="closeaside"><a class="closebutton" href="#" title="éšè—ä¾§è¾¹æ "></a></div>-->
    <aside class="clearfix">
        <div id="authorInfo">
            <!---->
            <!--<div class="author-logo"></div>-->
            <!---->

            <div> <img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"> </div>

            <div class="social-list">
                
                
                
                
                
            </div>
        </div>

        
        <div class="categorieslist">
    <p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p>
    <ul>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg"> 0. é˜…è¯»æºç è‘µèŠ±å®å…¸ </a></li>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg"> 1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç  </a> </li>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg"> 2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ </a> </li>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg"> 3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–° </a> </li>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤ </a> </li>


    </ul>
</div>
        
        
<div class="categorieslist">
	<p class="asidetitle">åˆ†ç±»</p>
		<ul>
		
            
			    <li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li>
            
		
            
			    <li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li>
            
		
            
			    <li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li>
            
		
            
			    <li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li>
            
		
            
			    <li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li>
            
		
            
			    <li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li>
            
		
            
			    <li><a href="/categories/TCC-Transaction/" title="TCC-Transaction">TCC-Transaction<sup>2</sup></a></li>
            
		
            
			    <li><a href="/categories/æŠ€æœ¯æ‚æ–‡/" title="æŠ€æœ¯æ‚æ–‡">æŠ€æœ¯æ‚æ–‡<sup>3</sup></a></li>
            
		
		</ul>
</div>

        
    </aside>
</div>
        <div id="main" class="post" itemscope="" itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/Elastic-Job/job-event-trace/" title="Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šäº‹ä»¶è¿½è¸ª" itemprop="url">Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šäº‹ä»¶è¿½è¸ª</a>
  </h1>
  <p class="article-author">
      <!--By-->
    <!---->
      <!--<a href="http://www.iocoder.cn" title="ç‹æ–‡æ–Œ">ç‹æ–‡æ–Œ</a>-->
    <!---->
  </p>
  <p class="article-time">
    <!--<time datetime="2017-11-13T16:00:00.000Z" itemprop="datePublished">2017-11-14</time>-->
    <!--æ›´æ–°æ—¥æœŸ:<time datetime="2017-09-06T12:09:34.000Z" itemprop="dateModified">2017-09-06</time>-->
    <!---->
      æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡
  </p>
</header>
	<div class="article-content">
		
		
		<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ä½œä¸šäº‹ä»¶æ€»çº¿</a></li>
<li><a href="#">3. ä½œä¸šäº‹ä»¶</a><ul>
<li><a href="#">3.1 ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶</a></li>
<li><a href="#">3.2 ä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶</a></li>
<li><a href="#">3.3 ä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨</a></li>
<li><a href="#">3.4 ä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢</a></li>
</ul>
</li>
<li><a href="#">4. ä½œä¸šç›‘å¬å™¨</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šäº‹ä»¶è¿½è¸ª</strong>ã€‚</p>
<p>å¦å¤–ï¼Œ<strong>Elastic-Job-Cloud ä½œä¸šäº‹ä»¶è¿½è¸ª</strong> å’Œ Elastic-Job-Lite åŸºæœ¬ç±»ä¼¼ï¼Œä¸å•ç‹¬å¼€ä¸€ç¯‡æ–‡ç« ï¼Œè®°å½•åœ¨è¯¥æ–‡ç« é‡Œã€‚å¦‚æœä½ å¯¹ Elastic-Job-Cloud æš‚æ—¶ä¸æ„Ÿå…´è¶£ï¼Œå¯ä»¥è·³è¿‡ç›¸åº”éƒ¨åˆ†ã€‚</p>
<p>Elastic-Job æä¾›äº†äº‹ä»¶è¿½è¸ªåŠŸèƒ½ï¼Œå¯é€šè¿‡äº‹ä»¶è®¢é˜…çš„æ–¹å¼å¤„ç†è°ƒåº¦è¿‡ç¨‹çš„é‡è¦äº‹ä»¶ï¼Œç”¨äºæŸ¥è¯¢ã€ç»Ÿè®¡å’Œç›‘æ§ã€‚Elastic-Job ç›®å‰è®¢é˜…ä¸¤ç§äº‹ä»¶ï¼ŒåŸºäº<strong>å…³ç³»å‹æ•°æ®åº“</strong>è®°å½•äº‹ä»¶ã€‚</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_11_14/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_11_14/01.png" alt=""></p>
<ul>
<li>ä»¥ä¸Šç±»åœ¨ <code>com.dangdang.ddframe.job.event</code> åŒ…ï¼Œä¸ä»…ä¸º Elastic-Job-Liteï¼Œè€Œä¸”ä¸º Elastic-Job-Cloud å®ç°äº†äº‹ä»¶è¿½è¸ªåŠŸèƒ½ã€‚</li>
<li>ä½œä¸š<strong>äº‹ä»¶</strong>ï¼šç²‰è‰²çš„ç±»ã€‚</li>
<li>ä½œä¸š<strong>äº‹ä»¶æ€»çº¿</strong>ï¼šé»„è‰²çš„ç±»ã€‚</li>
<li>ä½œä¸š<strong>äº‹ä»¶ç›‘å¬å™¨</strong>ï¼šè“è‰²çš„ç±»ã€‚ </li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-ä½œä¸šäº‹ä»¶æ€»çº¿"><a href="#2-ä½œä¸šäº‹ä»¶æ€»çº¿" class="headerlink" title="2. ä½œä¸šäº‹ä»¶æ€»çº¿"></a>2. ä½œä¸šäº‹ä»¶æ€»çº¿</h1><p>JobEventBusï¼Œä½œä¸šäº‹ä»¶æ€»çº¿ï¼Œæä¾›äº†æ³¨å†Œç›‘å¬å™¨ã€å‘å¸ƒäº‹ä»¶ä¸¤ä¸ªæ–¹æ³•ã€‚</p>
<p><strong>åˆ›å»º</strong> JobEventBus ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobEventBus</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šäº‹ä»¶é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobEventConfiguration jobEventConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * çº¿ç¨‹æ± æ‰§è¡ŒæœåŠ¡å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutorServiceObject executorServiceObject;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹ä»¶æ€»çº¿</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventBus eventBus;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦æ³¨å†Œä½œä¸šç›‘å¬å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isRegistered;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobEventBus</span><span class="params">()</span> </span>&#123;</div><div class="line">        jobEventConfig = <span class="keyword">null</span>;</div><div class="line">        executorServiceObject = <span class="keyword">null</span>;</div><div class="line">        eventBus = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobEventBus</span><span class="params">(<span class="keyword">final</span> JobEventConfiguration jobEventConfig)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.jobEventConfig = jobEventConfig;</div><div class="line">        executorServiceObject = <span class="keyword">new</span> ExecutorServiceObject(<span class="string">"job-event"</span>, Runtime.getRuntime().availableProcessors() * <span class="number">2</span>);</div><div class="line">        <span class="comment">// åˆ›å»º å¼‚æ­¥äº‹ä»¶æ€»çº¿</span></div><div class="line">        eventBus = <span class="keyword">new</span> AsyncEventBus(executorServiceObject.createExecutorService());</div><div class="line">        <span class="comment">// æ³¨å†Œ äº‹ä»¶ç›‘å¬å™¨</span></div><div class="line">        register();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>JobEventBus åŸºäº <a href="https://github.com/google/guava/wiki/EventBusExplained" rel="external nofollow noopener noreferrer" target="_blank">Google Guava EventBus</a>ï¼Œåœ¨<a href="http://www.iocoder.cn/Sharding-JDBC/sql-execute">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œã€‹ã€Œ4.1 EventBusã€</a>æœ‰è¯¦ç»†åˆ†äº«ã€‚è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ AsyncEventBus( <strong>å¼‚æ­¥äº‹ä»¶æ€»çº¿</strong> )ï¼Œæ³¨å†Œåœ¨å…¶ä¸Šé¢çš„ç›‘å¬å™¨æ˜¯<strong>å¼‚æ­¥</strong>ç›‘å¬æ‰§è¡Œï¼Œäº‹ä»¶å‘å¸ƒæ— éœ€é˜»å¡ç­‰å¾…ç›‘å¬å™¨æ‰§è¡Œå®Œé€»è¾‘ï¼Œæ‰€ä»¥å¯¹æ€§èƒ½ä¸å­˜åœ¨å½±å“ã€‚</li>
<li><p>ä½¿ç”¨ JobEventConfiguration( ä½œä¸šäº‹ä»¶é…ç½® ) åˆ›å»ºäº‹ä»¶ç›‘å¬å™¨ï¼Œè°ƒç”¨ <code>#register()</code> æ–¹æ³•è¿›è¡Œæ³¨å†Œç›‘å¬ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       eventBus.register(jobEventConfig.createJobEventListener());</div><div class="line">       isRegistered = <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> JobEventListenerConfigurationException ex) &#123;</div><div class="line">       log.error(<span class="string">"Elastic job: create JobEventListener failure, error is: "</span>, ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è¯¥æ–¹æ³•æ˜¯ç§æœ‰( <code>private</code> )æ–¹æ³•ï¼Œåªèƒ½ä½¿ç”¨ JobEventConfiguration åˆ›å»ºäº‹ä»¶ç›‘å¬å™¨æ³¨å†Œã€‚å½“ä¸ä¼ é€’è¯¥é…ç½®æ—¶ï¼Œæ„å‘³ç€ä¸å¼€å¯<strong>äº‹ä»¶è¿½è¸ª</strong>åŠŸèƒ½ã€‚</li>
</ul>
</li>
</ul>
<p><strong>å‘å¸ƒä½œä¸šäº‹ä»¶</strong></p>
<p>å‘å¸ƒä½œä¸šäº‹ä»¶( JobEvent ) ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventBus.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(<span class="keyword">final</span> JobEvent event)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (isRegistered &amp;&amp; !executorServiceObject.isShutdown()) &#123;</div><div class="line">       eventBus.post(event);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ Elaistc-Job-Lite é‡Œï¼ŒLiteJobFacade å¯¹ <code>JobEventBus#post(...)</code> è¿›è¡Œå°è£…ï¼Œæä¾›ç»™ä½œä¸šæ‰§è¡Œå™¨( AbstractElasticJobExecutor )è°ƒç”¨( Elastic-Job-Cloud å®é™…ä¹Ÿè¿›è¡Œäº†å°è£… )ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postJobExecutionEvent</span><span class="params">(<span class="keyword">final</span> JobExecutionEvent jobExecutionEvent)</span> </span>&#123;</div><div class="line">   jobEventBus.post(jobExecutionEvent);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postJobStatusTraceEvent</span><span class="params">(<span class="keyword">final</span> String taskId, <span class="keyword">final</span> State state, <span class="keyword">final</span> String message)</span> </span>&#123;</div><div class="line">   TaskContext taskContext = TaskContext.from(taskId);</div><div class="line">   jobEventBus.post(<span class="keyword">new</span> JobStatusTraceEvent(taskContext.getMetaInfo().getJobName(), taskContext.getId(),</div><div class="line">           taskContext.getSlaveId(), Source.LITE_EXECUTOR, taskContext.getType(), taskContext.getMetaInfo().getShardingItems().toString(), state, message));</div><div class="line">   <span class="keyword">if</span> (!Strings.isNullOrEmpty(message)) &#123;</div><div class="line">       log.trace(message);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>TaskContext é€šè¿‡ <code>#from(...)</code> æ–¹æ³•ï¼Œå¯¹ä½œä¸šä»»åŠ¡ID( <code>taskId</code> ) è§£æï¼Œè·å–ä»»åŠ¡ä¸Šä¸‹æ–‡ã€‚TaskContext ä»£ç æ³¨é‡Šå¾ˆå®Œæ•´ï¼Œç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/8926e94aa7c48dc635a36518da2c4b10194420a5/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/context/TaskContext.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</li>
</ul>
<h1 id="3-ä½œä¸šäº‹ä»¶"><a href="#3-ä½œä¸šäº‹ä»¶" class="headerlink" title="3. ä½œä¸šäº‹ä»¶"></a>3. ä½œä¸šäº‹ä»¶</h1><p>ç›®å‰æœ‰ä¸¤ç§ä½œä¸šäº‹ä»¶( JobEvent )ï¼š</p>
<ul>
<li>JobStatusTraceEventï¼Œä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶ã€‚</li>
<li>JobExecutionEventï¼Œä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶ã€‚</li>
</ul>
<p>æœ¬å°èŠ‚åˆ†äº«ä¸¤æ–¹é¢ï¼š</p>
<ul>
<li>ä½œä¸šäº‹ä»¶<strong>å‘å¸ƒæ—¶æœº</strong>ã€‚</li>
<li>Elastic-Job åŸºäº<strong>å…³ç³»å‹æ•°æ®åº“</strong>è®°å½•äº‹ä»¶çš„<strong>è¡¨ç»“æ„</strong>ã€‚</li>
</ul>
<h2 id="3-1-ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶"><a href="#3-1-ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶" class="headerlink" title="3.1 ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶"></a>3.1 ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶</h2><p>JobStatusTraceEventï¼Œä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobStatusTraceEvent</span> <span class="keyword">implements</span> <span class="title">JobEvent</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä¸»é”®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String id = UUID.randomUUID().toString();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šåç§°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åŸä½œä¸šä»»åŠ¡ID</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> String originalTaskId = <span class="string">""</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šä»»åŠ¡ID</span></div><div class="line"><span class="comment">     * æ¥è‡ª &#123;<span class="doctag">@link</span> com.dangdang.ddframe.job.executor.ShardingContexts#taskId&#125;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String taskId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ‰§è¡Œä½œä¸šæœåŠ¡å™¨çš„åå­—</span></div><div class="line"><span class="comment">     * Elastic-Job-Liteï¼Œä½œä¸šèŠ‚ç‚¹çš„ IP åœ°å€</span></div><div class="line"><span class="comment">     * Elastic-Job-Cloudï¼ŒMesos æ‰§è¡Œæœºä¸»é”®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String slaveId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»»åŠ¡æ¥æº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Source source;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»»åŠ¡æ‰§è¡Œç±»å‹</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutionType executionType;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line"><span class="comment">     * å¤šä¸ªåˆ†ç‰‡é¡¹ä»¥é€—å·åˆ†éš”</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String shardingItems;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> State state;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç›¸å…³ä¿¡æ¯</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String message;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®°å½•åˆ›å»ºæ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Date creationTime = <span class="keyword">new</span> Date();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>ExecutionTypeï¼Œæ‰§è¡Œç±»å‹ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ExecutionType &#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‡†å¤‡æ‰§è¡Œçš„ä»»åŠ¡.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    READY,</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¤±æ•ˆè½¬ç§»çš„ä»»åŠ¡.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    FAILOVER</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Sourceï¼Œä»»åŠ¡æ¥æºã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Source &#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Elastic-Job-Cloud è°ƒåº¦å™¨</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   CLOUD_SCHEDULER,</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Elastic-Job-Cloud æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   CLOUD_EXECUTOR,</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Elastic-Job-Lite æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   LITE_EXECUTOR</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Stateï¼Œä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> State &#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * å¼€å§‹ä¸­</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   TASK_STAGING,</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * è¿è¡Œä¸­</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   TASK_RUNNING,</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * å®Œæˆï¼ˆæ­£å¸¸ï¼‰</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   TASK_FINISHED,</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * å®Œæˆï¼ˆå¼‚å¸¸ï¼‰</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   TASK_ERROR,</div><div class="line">       </div><div class="line">   TASK_KILLED, TASK_LOST, TASK_FAILED,  TASK_DROPPED, TASK_GONE, TASK_GONE_BY_OPERATOR, TASK_UNREACHABLE, TASK_UNKNOWN</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Elastic-Job-Lite ä½¿ç”¨  TASK_STAGINGã€TASK_RUNNINGã€TASK_FINISHEDã€TASK_ERROR å››ç§æ‰§è¡ŒçŠ¶æ€ã€‚</li>
<li>Elastic-Job-Cloud ä½¿ç”¨æ‰€æœ‰æ‰§è¡ŒçŠ¶æ€ã€‚</li>
</ul>
</li>
</ul>
<p>å…³ç³»æ•°æ®åº“è¡¨ <code>JOB_STATUS_TRACE_LOG</code> ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`JOB_STATUS_TRACE_LOG`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">varchar</span>(<span class="number">40</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`job_name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`original_task_id`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`task_id`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`slave_id`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`source`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`execution_type`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`sharding_item`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`state`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`message`</span> <span class="built_in">varchar</span>(<span class="number">4000</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`creation_time`</span> <span class="keyword">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`TASK_ID_STATE_INDEX`</span> (<span class="string">`task_id`</span>,<span class="string">`state`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COLLATE</span>=utf8_bin</div></pre></td></tr></table></figure>
<ul>
<li><p>Elastic-Job-Lite ä¸€æ¬¡ä½œä¸šæ‰§è¡Œè®°å½•å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_11_14/02.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p>  <img src="http://www.iocoder.cn/images/Elastic-Job/2017_11_14/02.png" alt=""></p>
</li>
</ul>
<p><strong>JobStatusTraceEvent åœ¨ Elastic-Job-Lite å‘å¸ƒæ—¶æœº</strong>ï¼š</p>
<ul>
<li><p>State.TASK_STAGINGï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">    <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_STAGING)</span></div><div class="line">    <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">        jobFacade.postJobStatusTraceEvent(shardingContexts.getTaskId(), State.TASK_STAGING, String.format(<span class="string">"Job '%s' execute begin."</span>, jobName));</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>State.TASK_RUNNINGï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">   <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_RUNNING)</span></div><div class="line">   <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">       jobFacade.postJobStatusTraceEvent(taskId, State.TASK_RUNNING, <span class="string">""</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>State.TASK_FINISHEDã€State.TASK_ERRORã€ç¬¬ä¸€ç§ã€‘ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">    <span class="comment">// è·³è¿‡ å­˜åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡ä½œä¸š</span></div><div class="line">    <span class="keyword">if</span> (jobFacade.misfireIfRunning(shardingContexts.getShardingItemParameters().keySet())) &#123;</div><div class="line">      <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_FINISHED)</span></div><div class="line">      <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">          jobFacade.postJobStatusTraceEvent(shardingContexts.getTaskId(), State.TASK_FINISHED, String.format(</div><div class="line">                  <span class="string">"Previous job '%s' - shardingItems '%s' is still running, misfired job will start after previous job completed."</span>, jobName, </div><div class="line">                  shardingContexts.getShardingItemParameters().keySet()));</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>State.TASK_FINISHEDã€State.TASK_ERRORã€ç¬¬äºŒç§ã€‘ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">  <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      process(shardingContexts, executionSource);</div><div class="line">  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">      <span class="comment">// æ ¹æ®æ˜¯å¦æœ‰å¼‚å¸¸ï¼Œå‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_FINISHED / State.TASK_ERROR)</span></div><div class="line">      <span class="keyword">if</span> (itemErrorMessages.isEmpty()) &#123;</div><div class="line">          <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">              jobFacade.postJobStatusTraceEvent(taskId, State.TASK_FINISHED, <span class="string">""</span>);</div><div class="line">          &#125;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">              jobFacade.postJobStatusTraceEvent(taskId, State.TASK_ERROR, itemErrorMessages.toString());</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>JobStatusTraceEvent åœ¨ Elastic-Job-Cloud å‘å¸ƒæ—¶æœº</strong>ï¼š</p>
<p>Elastic-Job-Cloud é™¤äº†ä¸Šæ–‡ Elastic-Job-Lite ä¼šå¤šä¸€ä¸ªåœºæ™¯ä¸‹è®°å½•ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶( <strong>State.TASK_STAGING</strong> )ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TaskLaunchScheduledService.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> JobStatusTraceEvent <span class="title">createJobStatusTraceEvent</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">  TaskContext.MetaInfo metaInfo = taskContext.getMetaInfo();</div><div class="line">  JobStatusTraceEvent result = <span class="keyword">new</span> JobStatusTraceEvent(metaInfo.getJobName(), taskContext.getId(), taskContext.getSlaveId(),</div><div class="line">          Source.CLOUD_SCHEDULER, taskContext.getType(), String.valueOf(metaInfo.getShardingItems()), JobStatusTraceEvent.State.TASK_STAGING, <span class="string">""</span>);</div><div class="line">  <span class="comment">// å¤±æ•ˆè½¬ç§»</span></div><div class="line">  <span class="keyword">if</span> (ExecutionType.FAILOVER == taskContext.getType()) &#123;</div><div class="line">      Optional&lt;String&gt; taskContextOptional = facadeService.getFailoverTaskId(metaInfo);</div><div class="line">      <span class="keyword">if</span> (taskContextOptional.isPresent()) &#123;</div><div class="line">          result.setOriginalTaskId(taskContextOptional.get());</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä»»åŠ¡æäº¤è°ƒåº¦æœåŠ¡( TaskLaunchScheduledService )æäº¤ä»»åŠ¡æ—¶ï¼Œè®°å½•å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_STAGING)ã€‚</li>
</ul>
<p>Elastic-Job-Cloud æ ¹æ® Mesos Master é€šçŸ¥ä»»åŠ¡çŠ¶æ€å˜æ›´ï¼Œè®°å½•<strong>å¤šç§</strong>ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerEngine.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">statusUpdate</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver, <span class="keyword">final</span> Protos.TaskStatus taskStatus)</span> </span>&#123;</div><div class="line">   String taskId = taskStatus.getTaskId().getValue();</div><div class="line">   TaskContext taskContext = TaskContext.from(taskId);</div><div class="line">   String jobName = taskContext.getMetaInfo().getJobName();</div><div class="line">   log.trace(<span class="string">"call statusUpdate task state is: &#123;&#125;, task id is: &#123;&#125;"</span>, taskStatus.getState(), taskId);</div><div class="line">   <span class="comment">//</span></div><div class="line">   jobEventBus.post(<span class="keyword">new</span> JobStatusTraceEvent(jobName, taskContext.getId(), taskContext.getSlaveId(), Source.CLOUD_SCHEDULER,</div><div class="line">           taskContext.getType(), String.valueOf(taskContext.getMetaInfo().getShardingItems()), State.valueOf(taskStatus.getState().name()), taskStatus.getMessage()));</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-2-ä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶"><a href="#3-2-ä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶" class="headerlink" title="3.2 ä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶"></a>3.2 ä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶</h2><p>JobExecutionEventï¼Œä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobExecutionEvent</span> <span class="keyword">implements</span> <span class="title">JobEvent</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä¸»é”®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String id = UUID.randomUUID().toString();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä¸»æœºåç§°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String hostname = IpUtils.getHostName();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * IP</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String ip = IpUtils.getIp();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šä»»åŠ¡ID</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String taskId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šåå­—</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ‰§è¡Œæ¥æº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutionSource source;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> shardingItem;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¼€å§‹æ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Date startTime = <span class="keyword">new</span> Date();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç»“æŸæ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> Date completeTime;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦æ‰§è¡ŒæˆåŠŸ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> success;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ‰§è¡Œå¤±è´¥åŸå› </span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> JobExecutionEventThrowable failureCause;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>ExecutionSourceï¼Œæ‰§è¡Œæ¥æº</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ExecutionSource &#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * æ™®é€šè§¦å‘æ‰§è¡Œ</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   NORMAL_TRIGGER,</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * è¢«é”™è¿‡æ‰§è¡Œ</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   MISFIRE,</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * å¤±æ•ˆè½¬ç§»æ‰§è¡Œ</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   FAILOVER</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>å…³ç³»æ•°æ®åº“è¡¨ <code>JOB_EXECUTION_LOG</code> ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`JOB_EXECUTION_LOG`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">varchar</span>(<span class="number">40</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`job_name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`task_id`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`hostname`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`ip`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`sharding_item`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`execution_source`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`failure_cause`</span> <span class="built_in">varchar</span>(<span class="number">4000</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`is_success`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`start_time`</span> <span class="keyword">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`complete_time`</span> <span class="keyword">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COLLATE</span>=utf8_bin</div></pre></td></tr></table></figure>
<ul>
<li><p>Elastic-Job-Lite ä¸€æ¬¡ä½œä¸š<strong>å¤šä½œä¸šåˆ†ç‰‡é¡¹</strong>æ‰§è¡Œè®°å½•å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_11_14/03.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p>  <img src="http://www.iocoder.cn/images/Elastic-Job/2017_11_14/03.png" alt=""></p>
</li>
</ul>
<p><strong>JobExecutionEvent åœ¨ Elastic-Job-Lite å‘å¸ƒæ—¶æœº</strong>ï¼š</p>
<pre><code><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> <span class="keyword">int</span> item, <span class="keyword">final</span> JobExecutionEvent startEvent)</span> </span>&#123;</div><div class="line">   <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(å¼€å§‹)</span></div><div class="line">   <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">       jobFacade.postJobExecutionEvent(startEvent);</div><div class="line">   &#125;</div><div class="line">   JobExecutionEvent completeEvent;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// æ‰§è¡Œå•ä¸ªä½œä¸š</span></div><div class="line">       process(<span class="keyword">new</span> ShardingContext(shardingContexts, item));</div><div class="line">       <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(æˆåŠŸ)</span></div><div class="line">       completeEvent = startEvent.executionSuccess();</div><div class="line">       <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">           jobFacade.postJobExecutionEvent(completeEvent);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable cause) &#123;</div><div class="line">       <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(å¤±è´¥)</span></div><div class="line">       completeEvent = startEvent.executionFailure(cause);</div><div class="line">       jobFacade.postJobExecutionEvent(completeEvent);</div><div class="line">       <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p><strong>JobExecutionEvent åœ¨ Elastic-Job-Cloud å‘å¸ƒæ—¶æœº</strong>ï¼š</p>
<p>å’Œ Elastic-Job-Cloud ä¸€è‡´ã€‚</p>
<h2 id="3-3-ä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨"><a href="#3-3-ä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨" class="headerlink" title="3.3 ä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨"></a>3.3 ä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨</h2><p>JobEventRdbStorageï¼Œä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨ã€‚</p>
<p><strong>åˆ›å»º</strong> JobEventRdbStorage ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">JobEventRdbStorage(<span class="keyword">final</span> DataSource dataSource) <span class="keyword">throws</span> SQLException &#123;</div><div class="line">   <span class="keyword">this</span>.dataSource = dataSource;</div><div class="line">   initTablesAndIndexes();</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initTablesAndIndexes</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">try</span> (Connection conn = dataSource.getConnection()) &#123;</div><div class="line">       createJobExecutionTableAndIndexIfNeeded(conn);</div><div class="line">       createJobStatusTraceTableAndIndexIfNeeded(conn);</div><div class="line">       databaseType = DatabaseType.valueFrom(conn.getMetaData().getDatabaseProductName());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>#createJobExecutionTableAndIndexIfNeeded(...)</code> åˆ›å»º <code>JOB_EXECUTION_LOG</code> è¡¨å’Œç´¢å¼•ã€‚</li>
<li>è°ƒç”¨ <code>#createJobStatusTraceTableAndIndexIfNeeded(...)</code> åˆ›å»º <code>JOB_STATUS_TRACE_LOG</code> è¡¨å’Œç´¢å¼•ã€‚</li>
</ul>
<p><strong>å­˜å‚¨</strong> JobStatusTraceEvent ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventRdbStorage.java</span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">addJobStatusTraceEvent</span><span class="params">(<span class="keyword">final</span> JobStatusTraceEvent jobStatusTraceEvent)</span> </span>&#123;</div><div class="line">   String originalTaskId = jobStatusTraceEvent.getOriginalTaskId();</div><div class="line">   <span class="keyword">if</span> (State.TASK_STAGING != jobStatusTraceEvent.getState()) &#123;</div><div class="line">       originalTaskId = getOriginalTaskId(jobStatusTraceEvent.getTaskId());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line">   String sql = <span class="string">"INSERT INTO `"</span> + TABLE_JOB_STATUS_TRACE_LOG + <span class="string">"` (`id`, `job_name`, `original_task_id`, `task_id`, `slave_id`, `source`, `execution_type`, `sharding_item`,  "</span> </div><div class="line">           + <span class="string">"`state`, `message`, `creation_time`) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);"</span>;</div><div class="line">   <span class="comment">// ... çœç•¥ä½ æ‡‚çš„ä»£ç </span></div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getOriginalTaskId</span><span class="params">(<span class="keyword">final</span> String taskId)</span> </span>&#123;</div><div class="line">   String sql = String.format(<span class="string">"SELECT original_task_id FROM %s WHERE task_id = '%s' and state='%s'"</span>, TABLE_JOB_STATUS_TRACE_LOG, taskId, State.TASK_STAGING);</div><div class="line">   <span class="comment">// ... çœç•¥ä½ æ‡‚çš„ä»£ç </span></div><div class="line">   <span class="keyword">return</span> original_task_id;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>originalTaskId</code>ï¼ŒåŸä»»åŠ¡ä½œä¸šIDã€‚<ul>
<li>Elastic-Job-Lite æš‚æœªä½¿ç”¨åˆ°è¯¥å­—æ®µï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ã€‚</li>
<li>Elastic-Job-Cloud åœ¨<strong>ä½œä¸šå¤±æ•ˆè½¬ç§»</strong>åœºæ™¯ä¸‹ä½¿ç”¨è¯¥å­—æ®µï¼Œå­˜å‚¨å¤±æ•ˆè½¬ç§»çš„ä»»åŠ¡ä½œä¸šIDã€‚</li>
</ul>
</li>
</ul>
<p><strong>å­˜å‚¨</strong> JobExecutionEvent ä»£ç å¦‚ä¸‹ï¼š     </p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventRdbStorage.java</span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">addJobExecutionEvent</span><span class="params">(<span class="keyword">final</span> JobExecutionEvent jobExecutionEvent)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> == jobExecutionEvent.getCompleteTime()) &#123; <span class="comment">// ä½œä¸šåˆ†ç‰‡é¡¹æ‰§è¡Œå¼€å§‹</span></div><div class="line">       <span class="keyword">return</span> insertJobExecutionEvent(jobExecutionEvent);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">if</span> (jobExecutionEvent.isSuccess()) &#123; <span class="comment">// ä½œä¸šåˆ†ç‰‡é¡¹æ‰§è¡Œå®Œæˆï¼ˆæ­£å¸¸ï¼‰</span></div><div class="line">           <span class="keyword">return</span> updateJobExecutionEventWhenSuccess(jobExecutionEvent);</div><div class="line">       &#125; <span class="keyword">else</span> &#123; <span class="comment">// ä½œä¸šåˆ†ç‰‡é¡¹æ‰§è¡Œå®Œæˆï¼ˆå¼‚å¸¸ï¼‰</span></div><div class="line">           <span class="keyword">return</span> updateJobExecutionEventFailure(jobExecutionEvent);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä½œä¸šåˆ†ç‰‡é¡¹æ‰§è¡Œå®Œæˆè¿›è¡Œçš„æ˜¯<strong>æ›´æ–°</strong>æ“ä½œã€‚</li>
</ul>
<h2 id="3-4-ä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢"><a href="#3-4-ä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢" class="headerlink" title="3.4 ä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢"></a>3.4 ä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢</h2><p>JobEventRdbSearchï¼Œä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢ï¼Œæä¾›ç»™è¿ç»´å¹³å°è°ƒç”¨æŸ¥è¯¢æ•°æ®ã€‚æ„Ÿå…´è¶£çš„åŒå­¦ç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/8283acf01548222f39f7bfc202a8f89d27728e6c/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/event/rdb/JobEventRdbSearch.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</p>
<h1 id="4-ä½œä¸šç›‘å¬å™¨"><a href="#4-ä½œä¸šç›‘å¬å™¨" class="headerlink" title="4. ä½œä¸šç›‘å¬å™¨"></a>4. ä½œä¸šç›‘å¬å™¨</h1><p>åœ¨ä¸Šæ–‡æˆ‘ä»¬çœ‹åˆ°ï¼Œä½œä¸šç›‘å¬å™¨é€šè¿‡ä¼ é€’ä½œä¸šäº‹ä»¶é…ç½®( JobEventConfiguration )ç»™ä½œä¸šäº‹ä»¶æ€»çº¿( JobEventBus ) <strong>è¿›è¡Œåˆ›å»ºç›‘å¬å™¨ï¼Œå¹¶æ³¨å†Œç›‘å¬å™¨åˆ°äº‹ä»¶æ€»çº¿</strong>ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ Elastic-Job æä¾›çš„åŸºäº<strong>å…³ç³»æ•°æ®åº“</strong>çš„äº‹ä»¶é…ç½®å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventConfiguration.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JobEventConfiguration</span> <span class="keyword">extends</span> <span class="title">JobEventIdentity</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ›å»ºä½œä¸šäº‹ä»¶ç›‘å¬å™¨.</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> ä½œä¸šäº‹ä»¶ç›‘å¬å™¨.</span></div><div class="line"><span class="comment">     * <span class="doctag">@throws</span> JobEventListenerConfigurationException ä½œä¸šäº‹ä»¶ç›‘å¬å™¨é…ç½®å¼‚å¸¸</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">JobEventListener <span class="title">createJobEventListener</span><span class="params">()</span> <span class="keyword">throws</span> JobEventListenerConfigurationException</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobEventRdbConfiguration.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobEventRdbConfiguration</span> <span class="keyword">extends</span> <span class="title">JobEventRdbIdentity</span> <span class="keyword">implements</span> <span class="title">JobEventConfiguration</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">transient</span> DataSource dataSource;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> JobEventListener <span class="title">createJobEventListener</span><span class="params">()</span> <span class="keyword">throws</span> JobEventListenerConfigurationException </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JobEventRdbListener(dataSource);</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobEventListenerConfigurationException(ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>JobEventRdbConfigurationï¼Œä½œä¸šæ•°æ®åº“äº‹ä»¶é…ç½®ã€‚è°ƒç”¨ <code>#createJobEventListener()</code> åˆ›å»ºä½œä¸šäº‹ä»¶æ•°æ®åº“ç›‘å¬å™¨( JobEventRdbListener )ã€‚</li>
</ul>
<p>JobEventRdbListenerï¼Œä½œä¸šäº‹ä»¶æ•°æ®åº“ç›‘å¬å™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventListener.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JobEventListener</span> <span class="keyword">extends</span> <span class="title">JobEventIdentity</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šæ‰§è¡Œäº‹ä»¶ç›‘å¬æ‰§è¡Œ.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> jobExecutionEvent ä½œä¸šæ‰§è¡Œäº‹ä»¶</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Subscribe</span></div><div class="line">    <span class="meta">@AllowConcurrentEvents</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">listen</span><span class="params">(JobExecutionEvent jobExecutionEvent)</span></span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šçŠ¶æ€ç—•è¿¹äº‹ä»¶ç›‘å¬æ‰§è¡Œ.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> jobStatusTraceEvent ä½œä¸šçŠ¶æ€ç—•è¿¹äº‹ä»¶</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Subscribe</span></div><div class="line">    <span class="meta">@AllowConcurrentEvents</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">listen</span><span class="params">(JobStatusTraceEvent jobStatusTraceEvent)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobEventRdbListener.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobEventRdbListener</span> <span class="keyword">extends</span> <span class="title">JobEventRdbIdentity</span> <span class="keyword">implements</span> <span class="title">JobEventListener</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobEventRdbStorage repository;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobEventRdbListener</span><span class="params">(<span class="keyword">final</span> DataSource dataSource)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        repository = <span class="keyword">new</span> JobEventRdbStorage(dataSource);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(<span class="keyword">final</span> JobExecutionEvent executionEvent)</span> </span>&#123;</div><div class="line">        repository.addJobExecutionEvent(executionEvent);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(<span class="keyword">final</span> JobStatusTraceEvent jobStatusTraceEvent)</span> </span>&#123;</div><div class="line">        repository.addJobStatusTraceEvent(jobStatusTraceEvent);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>é€šè¿‡ JobEventRdbStorage å­˜å‚¨ä½œä¸šäº‹ä»¶åˆ°å…³ç³»å‹æ•°æ®åº“ã€‚</li>
</ul>
<p><strong>å¦‚ä½•è‡ªå®šä¹‰ä½œä¸šç›‘å¬å™¨ï¼Ÿ</strong></p>
<p>æœ‰äº›åŒå­¦å¯èƒ½å¸Œæœ›ä½¿ç”¨ ES æˆ–è€…å…¶ä»–æ•°æ®åº“å­˜å‚¨ä½œä¸šäº‹ä»¶ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥é€šè¿‡å®ç° JobEventConfigurationã€JobEventListener è¿›è¡Œæ‹“å±•ã€‚</p>
<p><strong>Elastic-Job-Cloud JobEventConfiguration æ€ä¹ˆé…ç½®ï¼Ÿ</strong></p>
<ul>
<li><p>Elastic-Job-Cloud-Schedulerï¼šä» <code>conf/elastic-job-cloud-scheduler.properties</code> é…ç½®æ–‡ä»¶è¯»å–å¦‚ä¸‹å±æ€§ï¼Œç”Ÿæˆ JobEventConfiguration é…ç½®å¯¹è±¡ã€‚</p>
<ul>
<li><code>event_trace_rdb_driver</code></li>
<li><code>event_trace_rdb_url</code></li>
<li><code>event_trace_rdb_username</code></li>
<li><code>event_trace_rdb_password</code></li>
</ul>
</li>
<li><p>Elastic-Job-Cloud-Executorï¼šé€šè¿‡æ¥æ”¶åˆ°ä»»åŠ¡æ‰§è¡Œä¿¡æ¯é‡Œè¯»å–JobEventConfigurationï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TaskExecutor.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registered</span><span class="params">(<span class="keyword">final</span> ExecutorDriver executorDriver, <span class="keyword">final</span> Protos.ExecutorInfo executorInfo, <span class="keyword">final</span> Protos.FrameworkInfo frameworkInfo, <span class="keyword">final</span> Protos.SlaveInfo slaveInfo)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!executorInfo.getData().isEmpty()) &#123;</div><div class="line">       Map&lt;String, String&gt; data = SerializationUtils.deserialize(executorInfo.getData().toByteArray());</div><div class="line">       BasicDataSource dataSource = <span class="keyword">new</span> BasicDataSource();</div><div class="line">       dataSource.setDriverClassName(data.get(<span class="string">"event_trace_rdb_driver"</span>));</div><div class="line">       dataSource.setUrl(data.get(<span class="string">"event_trace_rdb_url"</span>));</div><div class="line">       dataSource.setPassword(data.get(<span class="string">"event_trace_rdb_password"</span>));</div><div class="line">       dataSource.setUsername(data.get(<span class="string">"event_trace_rdb_username"</span>));</div><div class="line">       jobEventBus = <span class="keyword">new</span> JobEventBus(<span class="keyword">new</span> JobEventRdbConfiguration(dataSource));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šçæ¯”æ¯”äº†è¿™ä¹ˆé•¿ï¼Œèƒ½ä¸èƒ½ç®€å•ç²—æš´ä¸€ç‚¹ã€‚<br>èŠ‹é“å›ï¼šæ˜¯æ˜¯æ˜¯ã€‚</p>
<p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_11_14/04.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
  
	</div>
		<footer class="article-footer clearfix">


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Elastic-Job-Lite/">Elastic-Job-Lite</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://www.iocoder.cn/Elastic-Job/job-event-trace/" data-title="Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šäº‹ä»¶è¿½è¸ª | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev">
 <a href="/Elastic-Job/job-listener/" title="Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šç›‘å¬å™¨">
  <strong>PREVIOUS:</strong><br>
  <span>
  Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šç›‘å¬å™¨</span>
</a>
</div>


<div class="next">
<a href="/Elastic-Job/job-failover/" title="Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»">
 <strong>NEXT:</strong><br> 
 <span>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»
</span>
</a>
</div>

</nav>

	

</div>  
    </div>
    <footer><div id="footer">
    <img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display: none">
    
            <p class="copyright"> Â© 2017 
		
		<a href="http://www.iocoder.cn" target="_blank" title="ç‹æ–‡æ–Œ">ç‹æ–‡æ–Œ</a>
		
            && <span style="display: inline;" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span>
            && <span style="display: inline;" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span>
            && Hosted by <a href="https://pages.coding.me" style="font-weight: bold" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a>
            && Powered by <a href="http://hexo.io" target="_blank" title="hexo" rel="external nofollow noopener noreferrer">hexo</a> && Theme by <a href="http://gengbiao.me" target="_blank" title="coney" rel="external nofollow noopener noreferrer">coney</a>
            </p></div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>






<link rel="stylesheet" href="/alert/css/alert.css">
<script src="/alert/js/alert.js"></script>
<script src="/js/jquery.cookie.js"></script>
<script src="/js/util.js"></script>




  </body>


