<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œ | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="ç‹æ–‡æ–Œ"><meta name="description" content="æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«

1. æ¦‚è¿°
2. Liteè°ƒåº¦ä½œä¸š
3. æ‰§è¡Œå™¨åˆ›å»º
3.1 åŠ è½½ä½œä¸šé…ç½®
3.2 è·å–ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± 
3.3 è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨


4. æ‰§è¡Œå™¨æ‰§è¡Œ
4.1 æ£€æŸ¥ä½œä¸šæ‰§è¡Œç¯å¢ƒ
4.2 è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡
4.3 å‘å¸ƒä½œä¸šçŠ¶æ€"><meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?9e70e3362807c1bd185a79655b307027";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG">èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</a></h1><a class="blog-motto">æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li><li><a href="/link_url">å‹é“¾</a></li></ul></ul></nav></div></header><div id="container"><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Liteè°ƒåº¦ä½œä¸š"><span class="toc-number">2.</span> <span class="toc-text">2. Liteè°ƒåº¦ä½œä¸š</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-æ‰§è¡Œå™¨åˆ›å»º"><span class="toc-number">3.</span> <span class="toc-text">3. æ‰§è¡Œå™¨åˆ›å»º</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-åŠ è½½ä½œä¸šé…ç½®"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 åŠ è½½ä½œä¸šé…ç½®</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-è·å–ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± "><span class="toc-number">3.2.</span> <span class="toc-text">3.2 è·å–ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-æ‰§è¡Œå™¨æ‰§è¡Œ"><span class="toc-number">4.</span> <span class="toc-text">4. æ‰§è¡Œå™¨æ‰§è¡Œ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-æ£€æŸ¥ä½œä¸šæ‰§è¡Œç¯å¢ƒ"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 æ£€æŸ¥ä½œä¸šæ‰§è¡Œç¯å¢ƒ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-æ‰§è¡Œä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•"><span class="toc-number">4.5.</span> <span class="toc-text">4.5 æ‰§è¡Œä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6-æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸š"><span class="toc-number">4.6.</span> <span class="toc-text">4.6 æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸š</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-1-ç®€å•ä½œä¸šæ‰§è¡Œå™¨"><span class="toc-number">4.6.1.</span> <span class="toc-text">4.6.1 ç®€å•ä½œä¸šæ‰§è¡Œå™¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-2-æ•°æ®æµä½œä¸šæ‰§è¡Œå™¨"><span class="toc-number">4.6.2.</span> <span class="toc-text">4.6.2 æ•°æ®æµä½œä¸šæ‰§è¡Œå™¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-3-è„šæœ¬ä½œä¸šæ‰§è¡Œå™¨"><span class="toc-number">4.6.3.</span> <span class="toc-text">4.6.3 è„šæœ¬ä½œä¸šæ‰§è¡Œå™¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-7-æ‰§è¡Œè¢«é”™è¿‡è§¦å‘çš„ä½œä¸š"><span class="toc-number">4.7.</span> <span class="toc-text">4.7 æ‰§è¡Œè¢«é”™è¿‡è§¦å‘çš„ä½œä¸š</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-8-æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»"><span class="toc-number">4.8.</span> <span class="toc-text">4.8 æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-9-æ‰§è¡Œä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•"><span class="toc-number">4.9.</span> <span class="toc-text">4.9 æ‰§è¡Œä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-å½©è›‹"><span class="toc-number">5.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>5</sup></a></li><li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/æŠ€æœ¯æ‚æ–‡/" title="æŠ€æœ¯æ‚æ–‡">æŠ€æœ¯æ‚æ–‡<sup>3</sup></a></li></ul></div></aside></div><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/Elastic-Job/job-execute/" title="Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œ" itemprop="url">Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œ</a></h1><p class="article-author"></p><p class="article-time">æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. æ¦‚è¿°</a></li><li><a href="#2-lite%E8%B0%83%E5%BA%A6%E4%BD%9C%E4%B8%9A">2. Liteè°ƒåº¦ä½œä¸š</a></li><li><a href="#3-%E6%89%A7%E8%A1%8C%E5%99%A8%E5%88%9B%E5%BB%BA">3. æ‰§è¡Œå™¨åˆ›å»º</a><ul><li><a href="#31-%E5%8A%A0%E8%BD%BD%E4%BD%9C%E4%B8%9A%E9%85%8D%E7%BD%AE">3.1 åŠ è½½ä½œä¸šé…ç½®</a></li><li><a href="#32-%E8%8E%B7%E5%8F%96%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0">3.2 è·å–ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± </a></li><li><a href="#33-%E8%8E%B7%E5%8F%96%E4%BD%9C%E4%B8%9A%E5%BC%82%E5%B8%B8%E6%89%A7%E8%A1%8C%E5%99%A8">3.3 è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨</a></li></ul></li><li><a href="#4-%E6%89%A7%E8%A1%8C%E5%99%A8%E6%89%A7%E8%A1%8C">4. æ‰§è¡Œå™¨æ‰§è¡Œ</a><ul><li><a href="#41-%E6%A3%80%E6%9F%A5%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E7%8E%AF%E5%A2%83">4.1 æ£€æŸ¥ä½œä¸šæ‰§è¡Œç¯å¢ƒ</a></li><li><a href="#42-%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E4%BD%9C%E4%B8%9A%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%88%86%E7%89%87%E4%B8%8A%E4%B8%8B%E6%96%87">4.2 è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡</a></li><li><a href="#43-%E5%8F%91%E5%B8%83%E4%BD%9C%E4%B8%9A%E7%8A%B6%E6%80%81%E8%BF%BD%E8%B8%AA%E4%BA%8B%E4%BB%B6">4.3 å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶</a></li><li><a href="#44-%E8%B7%B3%E8%BF%87%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E4%B8%AD%E7%9A%84%E8%A2%AB%E9%94%99%E8%BF%87%E6%89%A7%E8%A1%8C%E7%9A%84%E4%BD%9C%E4%B8%9A">4.4 è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š</a></li><li><a href="#45-%E6%89%A7%E8%A1%8C%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E5%89%8D%E7%9A%84%E6%96%B9%E6%B3%95">4.5 æ‰§è¡Œä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•</a></li><li><a href="#46-%E6%89%A7%E8%A1%8C%E6%99%AE%E9%80%9A%E8%A7%A6%E5%8F%91%E7%9A%84%E4%BD%9C%E4%B8%9A">4.6 æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸š</a><ul><li><a href="#461-%E7%AE%80%E5%8D%95%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E5%99%A8">4.6.1 ç®€å•ä½œä¸šæ‰§è¡Œå™¨</a></li><li><a href="#462-%E6%95%B0%E6%8D%AE%E6%B5%81%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E5%99%A8">4.6.2 æ•°æ®æµä½œä¸šæ‰§è¡Œå™¨</a></li><li><a href="#463-%E8%84%9A%E6%9C%AC%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E5%99%A8">4.6.3 è„šæœ¬ä½œä¸šæ‰§è¡Œå™¨</a></li></ul></li><li><a href="#47-%E6%89%A7%E8%A1%8C%E8%A2%AB%E9%94%99%E8%BF%87%E8%A7%A6%E5%8F%91%E7%9A%84%E4%BD%9C%E4%B8%9A">4.7 æ‰§è¡Œè¢«é”™è¿‡è§¦å‘çš„ä½œä¸š</a></li><li><a href="#48-%E6%89%A7%E8%A1%8C%E4%BD%9C%E4%B8%9A%E5%A4%B1%E6%95%88%E8%BD%AC%E7%A7%BB">4.8 æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»</a></li><li><a href="#49-%E6%89%A7%E8%A1%8C%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E5%90%8E%E7%9A%84%E6%96%B9%E6%B3%95">4.9 æ‰§è¡Œä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•</a></li></ul></li><li><a href="#666-%E5%BD%A9%E8%9B%8B">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šæ‰§è¡Œ</strong>ã€‚</p><p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_09_23/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_09_23/01.png" alt=""></p><ul><li><strong>é»„è‰²</strong>çš„ç±»åœ¨ <code>elastic-job-common-core</code> é¡¹ç›®é‡Œï¼Œä¸º Elastic-Job-Liteã€Elastic-Job-Cloud <strong>å…¬ç”¨</strong>ä½œä¸šæ‰§è¡Œç±»ã€‚</li></ul><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><h1 id="2-Liteè°ƒåº¦ä½œä¸š"><a href="#2-Liteè°ƒåº¦ä½œä¸š" class="headerlink" title="2. Liteè°ƒåº¦ä½œä¸š"></a>2. Liteè°ƒåº¦ä½œä¸š</h1><p>Liteè°ƒåº¦ä½œä¸š( LiteJob )ï¼Œä½œä¸šè¢«è°ƒåº¦åï¼Œè°ƒç”¨ <code>#execute()</code> æ‰§è¡Œä½œä¸šã€‚</p><p><strong>ä¸ºä»€ä¹ˆæ˜¯ LiteJob ä½œä¸ºå…¥å£å‘¢ï¼Ÿ</strong></p><p>åœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-init/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆå§‹åŒ–ã€‹çš„ã€Œ3.2.3ã€åˆ›å»ºä½œä¸šè°ƒåº¦æ§åˆ¶å™¨</a>é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Quartz çš„ JobDetail åˆ›å»ºä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">JobDetail result = JobBuilder.newJob(LiteJob.class).withIdentity(liteJobConfig.getJobName()).build();</div></pre></td></tr></table></figure><p><code>#newJob()</code> é‡Œçš„å‚æ•°æ˜¯ LiteJobï¼Œå› æ­¤ï¼Œæ¯æ¬¡ Quartz åˆ°è¾¾è°ƒåº¦æ—¶é—´æ—¶ï¼Œä¼šåˆ›å»ºè¯¥å¯¹è±¡è¿›è¡Œä½œä¸šæ‰§è¡Œã€‚</p><hr><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LiteJob</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> ElasticJob elasticJob;</div><div class="line">    </div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> JobFacade jobFacade;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</div><div class="line">        JobExecutorFactory.getJobExecutor(elasticJob, jobFacade).execute();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>LiteJob é€šè¿‡ JobExecutorFactory è·å¾—åˆ°ä½œä¸šæ‰§è¡Œå™¨( AbstractElasticJobExecutor )ï¼Œå¹¶è¿›è¡Œæ‰§è¡Œï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobExecutorFactory</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–ä½œä¸šæ‰§è¡Œå™¨.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> elasticJob åˆ†å¸ƒå¼å¼¹æ€§ä½œä¸š</div><div class="line">     * <span class="doctag">@param</span> jobFacade ä½œä¸šå†…éƒ¨æœåŠ¡é—¨é¢æœåŠ¡</div><div class="line">     * <span class="doctag">@return</span> ä½œä¸šæ‰§è¡Œå™¨</div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AbstractElasticJobExecutor <span class="title">getJobExecutor</span><span class="params">(<span class="keyword">final</span> ElasticJob elasticJob, <span class="keyword">final</span> JobFacade jobFacade)</span> </span>&#123;</div><div class="line">        <span class="comment">// ScriptJob</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == elasticJob) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ScriptJobExecutor(jobFacade);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// SimpleJob</span></div><div class="line">        <span class="keyword">if</span> (elasticJob <span class="keyword">instanceof</span> SimpleJob) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SimpleJobExecutor((SimpleJob) elasticJob, jobFacade);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// DataflowJob</span></div><div class="line">        <span class="keyword">if</span> (elasticJob <span class="keyword">instanceof</span> DataflowJob) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DataflowJobExecutor((DataflowJob) elasticJob, jobFacade);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Cannot support job type '%s'"</span>, elasticJob.getClass().getCanonicalName());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>JobExecutorFactoryï¼Œä½œä¸šæ‰§è¡Œå™¨å·¥å‚ï¼Œæ ¹æ®ä¸åŒçš„ä½œä¸šç±»å‹ï¼Œè¿”å›å¯¹åº”çš„<strong>ä½œä¸šæ‰§è¡Œå™¨</strong>ã€‚</li></ul></li></ul><table><thead><tr><th style="text-align:left">ä½œä¸š</th><th style="text-align:left">ä½œä¸šæ¥å£</th><th style="text-align:left">æ‰§è¡Œå™¨</th></tr></thead><tbody><tr><td style="text-align:left">ç®€å•ä½œä¸š</td><td style="text-align:left">SimpleJob</td><td style="text-align:left">SimpleJobExecutor</td></tr><tr><td style="text-align:left">æ•°æ®æµä½œä¸š</td><td style="text-align:left">DataflowJob</td><td style="text-align:left">DataflowJobExecutor</td></tr><tr><td style="text-align:left">è„šæœ¬ä½œä¸š</td><td style="text-align:left">ScriptJob</td><td style="text-align:left">ScriptJobExecutor</td></tr></tbody></table><h1 id="3-æ‰§è¡Œå™¨åˆ›å»º"><a href="#3-æ‰§è¡Œå™¨åˆ›å»º" class="headerlink" title="3. æ‰§è¡Œå™¨åˆ›å»º"></a>3. æ‰§è¡Œå™¨åˆ›å»º</h1><p>AbstractElasticJobExecutorï¼Œä½œä¸šæ‰§è¡Œå™¨æŠ½è±¡ç±»ã€‚ä¸åŒä½œä¸šæ‰§è¡Œå™¨éƒ½ç»§æ‰¿è¯¥ç±»ï¼Œåˆ›å»ºçš„è¿‡ç¨‹æ˜¯ä¸€è‡´çš„ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šé—¨é¢å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span>(AccessLevel.PROTECTED)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobFacade jobFacade;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šé…ç½®</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span>(AccessLevel.PROTECTED)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobRootConfiguration jobRootConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåç§°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± </div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutorService executorService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šå¼‚å¸¸å¤„ç†å™¨</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobExceptionHandler jobExceptionHandler;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ†ç‰‡é”™è¯¯ä¿¡æ¯é›†åˆ</div><div class="line">     * keyï¼šåˆ†ç‰‡åºå·</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, String&gt; itemErrorMessages;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">AbstractElasticJobExecutor</span><span class="params">(<span class="keyword">final</span> JobFacade jobFacade)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.jobFacade = jobFacade;</div><div class="line">        <span class="comment">// åŠ è½½ ä½œä¸šé…ç½®</span></div><div class="line">        jobRootConfig = jobFacade.loadJobRootConfiguration(<span class="keyword">true</span>);</div><div class="line">        jobName = jobRootConfig.getTypeConfig().getCoreConfig().getJobName();</div><div class="line">        <span class="comment">// è·å– ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± </span></div><div class="line">        executorService = ExecutorServiceHandlerRegistry.getExecutorServiceHandler(jobName, (ExecutorServiceHandler) getHandler(JobProperties.JobPropertiesEnum.EXECUTOR_SERVICE_HANDLER));</div><div class="line">        <span class="comment">// è·å– ä½œä¸šå¼‚å¸¸å¤„ç†å™¨</span></div><div class="line">        jobExceptionHandler = (JobExceptionHandler) getHandler(JobProperties.JobPropertiesEnum.JOB_EXCEPTION_HANDLER);</div><div class="line">        <span class="comment">// è®¾ç½® åˆ†ç‰‡é”™è¯¯ä¿¡æ¯é›†åˆ</span></div><div class="line">        itemErrorMessages = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(jobRootConfig.getTypeConfig().getCoreConfig().getShardingTotalCount(), <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SimpleJobExecutor.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleJobExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç®€å•ä½œä¸šå®ç°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SimpleJob simpleJob;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleJobExecutor</span><span class="params">(<span class="keyword">final</span> SimpleJob simpleJob, <span class="keyword">final</span> JobFacade jobFacade)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(jobFacade);</div><div class="line">        <span class="keyword">this</span>.simpleJob = simpleJob;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DataflowJobExecutor.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DataflowJobExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•°æ®æµä½œä¸šå¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataflowJob&lt;Object&gt; dataflowJob;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataflowJobExecutor</span><span class="params">(<span class="keyword">final</span> DataflowJob&lt;Object&gt; dataflowJob, <span class="keyword">final</span> JobFacade jobFacade)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(jobFacade);</div><div class="line">        <span class="keyword">this</span>.dataflowJob = dataflowJob;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ScriptJobExecutor.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ScriptJobExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ScriptJobExecutor</span><span class="params">(<span class="keyword">final</span> JobFacade jobFacade)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(jobFacade);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="3-1-åŠ è½½ä½œä¸šé…ç½®"><a href="#3-1-åŠ è½½ä½œä¸šé…ç½®" class="headerlink" title="3.1 åŠ è½½ä½œä¸šé…ç½®"></a>3.1 åŠ è½½ä½œä¸šé…ç½®</h2><p>ä»<strong>ç¼“å­˜</strong>ä¸­è¯»å–ä½œä¸šé…ç½®ã€‚åœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-config/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹çš„ã€Œ3.1ã€è¯»å–ä½œä¸šé…ç½®</a> å·²ç»è§£æã€‚</p><h2 id="3-2-è·å–ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± "><a href="#3-2-è·å–ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± " class="headerlink" title="3.2 è·å–ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± "></a>3.2 è·å–ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± </h2><p>ä½œä¸šæ¯æ¬¡æ‰§è¡Œæ—¶ï¼Œå¯èƒ½åˆ†é…åˆ°<strong>å¤šä¸ªåˆ†ç‰‡é¡¹</strong>ï¼Œéœ€è¦ä½¿ç”¨çº¿ç¨‹æ± å®ç°<strong>å¹¶è¡Œ</strong>æ‰§è¡Œã€‚è€ƒè™‘åˆ°ä¸åŒä½œä¸šä¹‹é—´çš„éš”ç¦»æ€§ï¼Œé€šè¿‡<strong>ä¸€ä¸ªä½œä¸šä¸€ä¸ªçº¿ç¨‹æ± </strong>å®ç°ã€‚çº¿ç¨‹æ± æœåŠ¡å¤„ç†å™¨æ³¨å†Œè¡¨( ExecutorServiceHandlerRegistry ) è·å–ä½œä¸šçº¿ç¨‹æ± ( <code>#getExecutorServiceHandler(....)</code> )ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorServiceHandlerRegistry</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * çº¿ç¨‹æ± é›†åˆ</div><div class="line">     * keyï¼šä½œä¸šåå­—</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, ExecutorService&gt; REGISTRY = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–çº¿ç¨‹æ± æœåŠ¡.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> jobName ä½œä¸šåç§°</div><div class="line">     * <span class="doctag">@param</span> executorServiceHandler çº¿ç¨‹æ± æœåŠ¡å¤„ç†å™¨</div><div class="line">     * <span class="doctag">@return</span> çº¿ç¨‹æ± æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> ExecutorService <span class="title">getExecutorServiceHandler</span><span class="params">(<span class="keyword">final</span> String jobName, <span class="keyword">final</span> ExecutorServiceHandler executorServiceHandler)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!REGISTRY.containsKey(jobName)) &#123;</div><div class="line">            REGISTRY.put(jobName, executorServiceHandler.createExecutorService(jobName));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> REGISTRY.get(jobName);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ExecutorServiceHandlerRegistry ä½¿ç”¨ ExecutorServiceHandler åˆ›å»ºçº¿ç¨‹æ± ã€‚ExecutorServiceHandler æœ¬èº«æ˜¯ä¸ª<strong>æ¥å£</strong>ï¼Œé»˜è®¤ä½¿ç”¨ DefaultExecutorServiceHandler å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ExecutorServiceHandler.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExecutorServiceHandler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ›å»ºçº¿ç¨‹æ± æœåŠ¡å¯¹è±¡.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> jobName ä½œä¸šå</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span> çº¿ç¨‹æ± æœåŠ¡å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="function">ExecutorService <span class="title">createExecutorService</span><span class="params">(<span class="keyword">final</span> String jobName)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DefaultExecutorServiceHandler.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultExecutorServiceHandler</span> <span class="keyword">implements</span> <span class="title">ExecutorServiceHandler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ExecutorService <span class="title">createExecutorService</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ExecutorServiceObject(<span class="string">"inner-job-"</span> + jobName, Runtime.getRuntime().availableProcessors() * <span class="number">2</span>).createExecutorService();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ ExecutorServiceObject çš„ <code>#createExecutorService(....)</code> æ–¹æ³•åˆ›å»ºçº¿ç¨‹æ± ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorServiceObject</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor threadPoolExecutor;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExecutorServiceObject</span><span class="params">(<span class="keyword">final</span> String namingPattern, <span class="keyword">final</span> <span class="keyword">int</span> threadSize)</span> </span>&#123;</div><div class="line">        workQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line">        threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(threadSize, threadSize, <span class="number">5L</span>, TimeUnit.MINUTES, workQueue, </div><div class="line">                <span class="keyword">new</span> BasicThreadFactory.Builder().namingPattern(Joiner.on(<span class="string">"-"</span>).join(namingPattern, <span class="string">"%s"</span>)).build());</div><div class="line">        threadPoolExecutor.allowCoreThreadTimeOut(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ›å»ºçº¿ç¨‹æ± æœåŠ¡å¯¹è±¡.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> çº¿ç¨‹æ± æœåŠ¡å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> ExecutorService <span class="title">createExecutorService</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> MoreExecutors.listeningDecorator(MoreExecutors.getExitingExecutorService(threadPoolExecutor));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>MoreExecutors#listeningDecorator(...)</code> åœ¨<a href="http://www.iocoder.cn/Sharding-JDBC/sql-execute/?self">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œã€‹</a> å·²ç»è§£æã€‚</li><li><p><code>MoreExecutors#getExitingExecutorService(...)</code> æ–¹æ³•é€»è¾‘ï¼šå°† ThreadPoolExecutor è½¬æ¢æˆ ExecutorServiceï¼Œå¹¶å¢åŠ  JVM å…³é—­é’©å­ï¼Œå®ç° <strong>120s</strong> ç­‰å¾…ä»»åŠ¡å®Œæˆï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">service.shutdown();</div><div class="line">service.awaitTermination(terminationTimeout, timeUnit);</div></pre></td></tr></table></figure></li></ul></li></ul><p><strong>å¦‚ä½•å®ç°è‡ªå®šä¹‰ ExecutorServiceHandler ?</strong></p><p>å…ˆçœ‹ä¸‹ AbstractElasticJobExecutor æ˜¯å¦‚ä½•è·å¾—<strong>æ¯ä¸ªä½œä¸š</strong>çš„ ExecutorServiceHandler ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—ã€è‡ªå®šä¹‰ã€‘å¤„ç†å™¨</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> jobPropertiesEnum ä½œä¸šå±æ€§æšä¸¾</div><div class="line">* <span class="doctag">@return</span> å¤„ç†å™¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getHandler</span><span class="params">(<span class="keyword">final</span> JobProperties.JobPropertiesEnum jobPropertiesEnum)</span> </span>&#123;</div><div class="line">   String handlerClassName = jobRootConfig.getTypeConfig().getCoreConfig().getJobProperties().get(jobPropertiesEnum);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Class&lt;?&gt; handlerClass = Class.forName(handlerClassName);</div><div class="line">       <span class="keyword">if</span> (jobPropertiesEnum.getClassType().isAssignableFrom(handlerClass)) &#123; <span class="comment">// å¿…é¡»æ˜¯æ¥å£å®ç°ï¼Œæ‰ä½¿ç”¨ã€è‡ªå®šä¹‰ã€‘</span></div><div class="line">           <span class="keyword">return</span> handlerClass.newInstance();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> getDefaultHandler(jobPropertiesEnum, handlerClassName);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ReflectiveOperationException ex) &#123;</div><div class="line">       <span class="keyword">return</span> getDefaultHandler(jobPropertiesEnum, handlerClassName);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—ã€é»˜è®¤ã€‘å¤„ç†å™¨</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> jobPropertiesEnum ä½œä¸šå±æ€§æšä¸¾</div><div class="line">* <span class="doctag">@param</span> handlerClassName å¤„ç†å™¨ç±»å</div><div class="line">* <span class="doctag">@return</span> å¤„ç†å™¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getDefaultHandler</span><span class="params">(<span class="keyword">final</span> JobProperties.JobPropertiesEnum jobPropertiesEnum, <span class="keyword">final</span> String handlerClassName)</span> </span>&#123;</div><div class="line">   log.warn(<span class="string">"Cannot instantiation class '&#123;&#125;', use default '&#123;&#125;' class."</span>, handlerClassName, jobPropertiesEnum.getKey());</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">return</span> Class.forName(jobPropertiesEnum.getDefaultValue()).newInstance();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ClassNotFoundException | InstantiationException | IllegalAccessException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(e);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>æ¯ä¸ªå¤„ç†å™¨éƒ½ä¼šå¯¹åº”ä¸€ä¸ª JobPropertiesEnumï¼Œä½¿ç”¨æšä¸¾è·å¾—å¤„ç†å™¨ã€‚ä¼˜å…ˆä» <code>JobProperties.map</code> è·å–<strong>è‡ªå®šä¹‰</strong>çš„å¤„ç†å™¨å®ç°ç±»ï¼Œå¦‚æœä¸ç¬¦åˆæ¡ä»¶( æœªå®ç°æ­£ç¡®æ¥å£ æˆ–è€… åˆ›å»ºå¤„ç†å™¨å¤±è´¥ )ï¼Œä½¿ç”¨<strong>é»˜è®¤</strong>çš„å¤„ç†å™¨å®ç°ã€‚</li><li>æ¯ä¸ªä½œä¸šå¯ä»¥é…ç½®<strong>ä¸åŒ</strong>çš„å¤„ç†å™¨ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-config/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹çš„ã€Œ2.2.2ã€ä½œä¸šæ ¸å¿ƒé…ç½®</a> å·²ç»è§£æã€‚</li></ul><h2 id="3-3-è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨"><a href="#3-3-è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨" class="headerlink" title="3.3 è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨"></a>3.3 è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨</h2><p>è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨( JobExceptionHandler )å’Œ ExecutorServiceHandler( ExecutorServiceHandler )<strong>ç›¸åŒ</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ExecutorServiceHandler.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JobExceptionHandler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¤„ç†ä½œä¸šå¼‚å¸¸.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> jobName ä½œä¸šåç§°</div><div class="line">     * <span class="doctag">@param</span> cause å¼‚å¸¸åŸå› </div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handleException</span><span class="params">(String jobName, Throwable cause)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DefaultJobExceptionHandler.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultJobExceptionHandler</span> <span class="keyword">implements</span> <span class="title">JobExceptionHandler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleException</span><span class="params">(<span class="keyword">final</span> String jobName, <span class="keyword">final</span> Throwable cause)</span> </span>&#123;</div><div class="line">        log.error(String.format(<span class="string">"Job '%s' exception occur in job processing"</span>, jobName), cause);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>é»˜è®¤å®ç° DefaultJobExceptionHandler <strong>æ‰“å°å¼‚å¸¸æ—¥å¿—ï¼Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸</strong>ã€‚</li></ul><h1 id="4-æ‰§è¡Œå™¨æ‰§è¡Œ"><a href="#4-æ‰§è¡Œå™¨æ‰§è¡Œ" class="headerlink" title="4. æ‰§è¡Œå™¨æ‰§è¡Œ"></a>4. æ‰§è¡Œå™¨æ‰§è¡Œ</h1><p>æ‰§è¡Œé€»è¾‘ä¸»æµç¨‹å¦‚ä¸‹å›¾( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_09_23/02.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_09_23/02.png" alt=""></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// æ£€æŸ¥ ä½œä¸šæ‰§è¡Œç¯å¢ƒ</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       jobFacade.checkJobExecutionEnvironment();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> JobExecutionEnvironmentException cause) &#123;</div><div class="line">       jobExceptionHandler.handleException(jobName, cause);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è·å– å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡</span></div><div class="line">   ShardingContexts shardingContexts = jobFacade.getShardingContexts();</div><div class="line">   <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_STAGING)</span></div><div class="line">   <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">       jobFacade.postJobStatusTraceEvent(shardingContexts.getTaskId(), State.TASK_STAGING, String.format(<span class="string">"Job '%s' execute begin."</span>, jobName));</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è·³è¿‡ å­˜åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡ä½œä¸š</span></div><div class="line">   <span class="keyword">if</span> (jobFacade.misfireIfRunning(shardingContexts.getShardingItemParameters().keySet())) &#123;</div><div class="line">       <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_FINISHED)</span></div><div class="line">       <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">           jobFacade.postJobStatusTraceEvent(shardingContexts.getTaskId(), State.TASK_FINISHED, String.format(</div><div class="line">                   <span class="string">"Previous job '%s' - shardingItems '%s' is still running, misfired job will start after previous job completed."</span>, jobName, </div><div class="line">                   shardingContexts.getShardingItemParameters().keySet()));</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ‰§è¡Œ ä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       jobFacade.beforeJobExecuted(shardingContexts);</div><div class="line">       <span class="comment">//CHECKSTYLE:OFF</span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable cause) &#123;</div><div class="line">       <span class="comment">//CHECKSTYLE:ON</span></div><div class="line">       jobExceptionHandler.handleException(jobName, cause);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ‰§è¡Œ æ™®é€šè§¦å‘çš„ä½œä¸š</span></div><div class="line">   execute(shardingContexts, JobExecutionEvent.ExecutionSource.NORMAL_TRIGGER);</div><div class="line">   <span class="comment">// æ‰§è¡Œ è¢«è·³è¿‡è§¦å‘çš„ä½œä¸š</span></div><div class="line">   <span class="keyword">while</span> (jobFacade.isExecuteMisfired(shardingContexts.getShardingItemParameters().keySet())) &#123;</div><div class="line">       jobFacade.clearMisfire(shardingContexts.getShardingItemParameters().keySet());</div><div class="line">       execute(shardingContexts, JobExecutionEvent.ExecutionSource.MISFIRE);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ‰§è¡Œ ä½œä¸šå¤±æ•ˆè½¬ç§»</span></div><div class="line">   jobFacade.failoverIfNecessary();</div><div class="line">   <span class="comment">// æ‰§è¡Œ ä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       jobFacade.afterJobExecuted(shardingContexts);</div><div class="line">       <span class="comment">//CHECKSTYLE:OFF</span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable cause) &#123;</div><div class="line">       <span class="comment">//CHECKSTYLE:ON</span></div><div class="line">       jobExceptionHandler.handleException(jobName, cause);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ä»£ç æ­¥éª¤æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥å¾€ä¸‹çœ‹ã€‚</p><h2 id="4-1-æ£€æŸ¥ä½œä¸šæ‰§è¡Œç¯å¢ƒ"><a href="#4-1-æ£€æŸ¥ä½œä¸šæ‰§è¡Œç¯å¢ƒ" class="headerlink" title="4.1 æ£€æŸ¥ä½œä¸šæ‰§è¡Œç¯å¢ƒ"></a>4.1 æ£€æŸ¥ä½œä¸šæ‰§è¡Œç¯å¢ƒ</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkJobExecutionEnvironment</span><span class="params">()</span> <span class="keyword">throws</span> JobExecutionEnvironmentException </span>&#123;</div><div class="line">   configService.checkMaxTimeDiffSecondsTolerable();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>ConfigService#checkMaxTimeDiffSecondsTolerable()</code> æ–¹æ³•æ ¡éªŒæœ¬æœºæ—¶é—´æ˜¯å¦åˆæ³•ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-config/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹çš„ã€Œ3.3ã€æ ¡éªŒæœ¬æœºæ—¶é—´æ˜¯å¦åˆæ³•</a> å·²ç»è§£æã€‚</li><li>å½“æ ¡éªŒæœ¬æœºæ—¶é—´ä¸åˆæ³•æ—¶ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚è‹¥ä½¿ç”¨ DefaultJobExceptionHandler ä½œä¸ºå¼‚å¸¸å¤„ç†ï¼Œ<strong>åªæ‰“å°æ—¥å¿—ï¼Œä¸ä¼šç»ˆæ­¢ä½œä¸šæ‰§è¡Œ</strong>ã€‚å¦‚æœä½ çš„ä½œä¸šå¯¹æ—¶é—´ç²¾å‡†åº¦æœ‰æ¯”è¾ƒé«˜çš„è¦æ±‚ï¼ŒæœŸæœ›ä½œä¸š<strong>ç»ˆæ­¢</strong>æ‰§è¡Œï¼Œå¯ä»¥è‡ªå®šä¹‰ JobExceptionHandler å®ç°å¯¹å¼‚å¸¸çš„å¤„ç†ã€‚</li></ul><h2 id="4-2-è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡"><a href="#4-2-è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡" class="headerlink" title="4.2 è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡"></a>4.2 è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡</h2><p>è°ƒç”¨ <code>LiteJobFacade#getShardingContexts()</code> æ–¹æ³•è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡ã€‚é€šè¿‡è¿™ä¸ªæ–¹æ³•ï¼Œä½œä¸šè·å¾—<strong>å…¶æ‰€åˆ†é…æ‰§è¡Œçš„åˆ†ç‰‡é¡¹</strong>ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p><h2 id="4-3-å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶"><a href="#4-3-å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶" class="headerlink" title="4.3 å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶"></a>4.3 å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶</h2><p>è°ƒç”¨ <code>LiteJobFacade#postJobStatusTraceEvent()</code> æ–¹æ³•å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-event-trace/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šäº‹ä»¶è¿½è¸ªã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p><h2 id="4-4-è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š"><a href="#4-4-è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š" class="headerlink" title="4.4 è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š"></a>4.4 è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š</h2><p>è¯¥é€»è¾‘å’Œ<strong>ã€Œ4.7ã€æ‰§è¡Œè¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š</strong>ï¼Œä¸€èµ·è§£æï¼Œå¯ä»¥æ•´ä½“æ€§çš„ç†è§£ Elastic-Job-Lite å¯¹è¢«é”™è¿‡æ‰§è¡Œ( misfired )çš„ä½œä¸šå¤„ç†ã€‚</p><h2 id="4-5-æ‰§è¡Œä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•"><a href="#4-5-æ‰§è¡Œä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•" class="headerlink" title="4.5 æ‰§è¡Œä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•"></a>4.5 æ‰§è¡Œä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (ElasticJobListener each : elasticJobListeners) &#123;</div><div class="line">       each.beforeJobExecuted(shardingContexts);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ä½œä¸šç›‘å¬å™¨æ‰§è¡Œä½œä¸š<strong>æ‰§è¡Œå‰</strong>çš„æ–¹æ³•ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-listener/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šç›‘å¬å™¨ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li></ul><h2 id="4-6-æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸š"><a href="#4-6-æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸š" class="headerlink" title="4.6 æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸š"></a>4.6 æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸š</h2><p>è¿™ä¸ªå°èŠ‚çš„æ ‡é¢˜ä¸å¤ªå‡†ç¡®ï¼Œå…¶ä»–<strong>ä½œä¸šæ¥æº</strong>( ExecutionSource )ä¹Ÿæ˜¯æ‰§è¡Œè¿™æ ·çš„é€»è¾‘ã€‚æœ¬å°èŠ‚æ‰§è¡Œä½œä¸šä¼šç»å† 4 ä¸ªæ–¹æ³•ï¼Œæ–¹æ³•<strong>é¡ºåº</strong>å¾€ä¸‹è°ƒç”¨ï¼Œæˆ‘ä»¬é€ä¸ªæ¥çœ‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œå¤šä¸ªä½œä¸šçš„åˆ†ç‰‡</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</div><div class="line">* <span class="doctag">@param</span> executionSource æ‰§è¡Œæ¥æº</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œå¤šä¸ªä½œä¸šçš„åˆ†ç‰‡</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</div><div class="line">* <span class="doctag">@param</span> executionSource æ‰§è¡Œæ¥æº</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œå•ä¸ªä½œä¸šçš„åˆ†ç‰‡</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</div><div class="line">* <span class="doctag">@param</span> item åˆ†ç‰‡åºå·</div><div class="line">* <span class="doctag">@param</span> startEvent æ‰§è¡Œäº‹ä»¶(å¼€å§‹)</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> <span class="keyword">int</span> item, <span class="keyword">final</span> JobExecutionEvent startEvent)</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œå•ä¸ªä½œä¸šçš„åˆ†ç‰‡ã€å­ç±»å®ç°ã€‘</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContext åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(ShardingContext shardingContext)</span></span>;</div></pre></td></tr></table></figure><p>psï¼š<strong>ä½œä¸šäº‹ä»¶</strong>ç›¸å…³é€»è¾‘ï¼Œå…ˆç»Ÿä¸€è·³è¿‡ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-event-trace/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šäº‹ä»¶è¿½è¸ªã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p><hr><p><strong>private void execute(shardingContexts, executionSource)</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ— å¯æ‰§è¡Œçš„åˆ†ç‰‡ï¼Œå‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_FINISHED)</span></div><div class="line">   <span class="keyword">if</span> (shardingContexts.getShardingItemParameters().isEmpty()) &#123;</div><div class="line">       <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">           jobFacade.postJobStatusTraceEvent(shardingContexts.getTaskId(), State.TASK_FINISHED, String.format(<span class="string">"Sharding item for job '%s' is empty."</span>, jobName));</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯</span></div><div class="line">   jobFacade.registerJobBegin(shardingContexts);</div><div class="line">   <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_RUNNING)</span></div><div class="line">   String taskId = shardingContexts.getTaskId();</div><div class="line">   <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">       jobFacade.postJobStatusTraceEvent(taskId, State.TASK_RUNNING, <span class="string">""</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// TODO</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       process(shardingContexts, executionSource);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="comment">// TODO è€ƒè™‘å¢åŠ ä½œä¸šå¤±è´¥çš„çŠ¶æ€ï¼Œå¹¶ä¸”è€ƒè™‘å¦‚ä½•å¤„ç†ä½œä¸šå¤±è´¥çš„æ•´ä½“å›è·¯</span></div><div class="line">       <span class="comment">// æ³¨å†Œä½œä¸šå®Œæˆä¿¡æ¯</span></div><div class="line">       jobFacade.registerJobCompleted(shardingContexts);</div><div class="line">       <span class="comment">// æ ¹æ®æ˜¯å¦æœ‰å¼‚å¸¸ï¼Œå‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_FINISHED / State.TASK_ERROR)</span></div><div class="line">       <span class="keyword">if</span> (itemErrorMessages.isEmpty()) &#123;</div><div class="line">           <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">               jobFacade.postJobStatusTraceEvent(taskId, State.TASK_FINISHED, <span class="string">""</span>);</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">               jobFacade.postJobStatusTraceEvent(taskId, State.TASK_ERROR, itemErrorMessages.toString());</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>æ–¹æ³•å‚æ•° <code>executionSource</code> ä»£è¡¨æ‰§è¡Œæ¥æº( ExecutionSource )ï¼Œä¸€å…±æœ‰ä¸‰ç§ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ExecutionSource &#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * æ™®é€šè§¦å‘æ‰§è¡Œ</div><div class="line">    */</div><div class="line">   NORMAL_TRIGGER,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * è¢«é”™è¿‡æ‰§è¡Œ</div><div class="line">    */</div><div class="line">   MISFIRE,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * å¤±æ•ˆè½¬ç§»æ‰§è¡Œ</div><div class="line">    */</div><div class="line">   FAILOVER</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>LiteJobFacade#registerJobBegin(...)</code> æ–¹æ³•æ³¨å†Œä½œä¸š<strong>å¯åŠ¨</strong>ä¿¡æ¯ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerJobBegin</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   executionService.registerJobBegin(shardingContexts);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ExecutionService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerJobBegin</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   JobRegistry.getInstance().setJobRunning(jobName, <span class="keyword">true</span>);</div><div class="line">   <span class="keyword">if</span> (!configService.load(<span class="keyword">true</span>).isMonitorExecution()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingContexts.getShardingItemParameters().keySet()) &#123;</div><div class="line">       jobNodeStorage.fillEphemeralJobNode(ShardingNode.getRunningNode(each), <span class="string">""</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä»…å½“ä½œä¸šé…ç½®è®¾ç½®<strong>ç›‘æ§ä½œä¸šè¿è¡Œæ—¶çŠ¶æ€</strong>( <code>LiteJobConfiguration.monitorExecution = true</code> )æ—¶ï¼Œè®°å½•ä½œä¸šè¿è¡ŒçŠ¶æ€ã€‚</li><li>è°ƒç”¨ <code>JobNodeStorage#fillEphemeralJobNode(...)</code> æ–¹æ³•è®°å½•<strong>åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹</strong>æ­£åœ¨è¿è¡Œä¸­ã€‚å¦‚ä½•è®°å½•çš„ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-storage/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ•°æ®å­˜å‚¨ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>LiteJobFacade#registerJobCompleted(...)</code> æ–¹æ³•æ³¨å†Œä½œä¸š<strong>å®Œæˆ</strong>ä¿¡æ¯ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerJobCompleted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   executionService.registerJobCompleted(shardingContexts);</div><div class="line">   <span class="keyword">if</span> (configService.load(<span class="keyword">true</span>).isFailover()) &#123;</div><div class="line">       failoverService.updateFailoverComplete(shardingContexts.getShardingItemParameters().keySet());</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ExecutionService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ³¨å†Œä½œä¸šå®Œæˆä¿¡æ¯.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerJobCompleted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   JobRegistry.getInstance().setJobRunning(jobName, <span class="keyword">false</span>);</div><div class="line">   <span class="keyword">if</span> (!configService.load(<span class="keyword">true</span>).isMonitorExecution()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingContexts.getShardingItemParameters().keySet()) &#123;</div><div class="line">       jobNodeStorage.removeJobNodeIfExisted(ShardingNode.getRunningNode(each));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä»…å½“ä½œä¸šé…ç½®è®¾ç½®<strong>ç›‘æ§ä½œä¸šè¿è¡Œæ—¶çŠ¶æ€</strong>( <code>LiteJobConfiguration.monitorExecution = true</code> )ï¼Œç§»é™¤ä½œä¸šè¿è¡ŒçŠ¶æ€ã€‚</li><li>è°ƒç”¨ <code>JobNodeStorage#removeJobNodeIfExisted(...)</code> æ–¹æ³•<strong>ç§»é™¤åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹</strong>æ­£åœ¨è¿è¡Œä¸­çš„æ ‡è®°ï¼Œè¡¨ç¤ºä½œä¸šåˆ†ç‰‡é¡¹ä¸åœ¨è¿è¡Œä¸­çŠ¶æ€ã€‚</li><li>è°ƒç”¨ <code>FailoverService#updateFailoverComplete(...)</code> æ–¹æ³•æ›´æ–°æ‰§è¡Œå®Œæ¯•å¤±æ•ˆè½¬ç§»çš„åˆ†ç‰‡é¡¹çŠ¶æ€ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-failover/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li></ul></li></ul><hr><p><strong>private void process(shardingContexts, executionSource)</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">   Collection&lt;Integer&gt; items = shardingContexts.getShardingItemParameters().keySet();</div><div class="line">   <span class="comment">// å•åˆ†ç‰‡ï¼Œç›´æ¥æ‰§è¡Œ</span></div><div class="line">   <span class="keyword">if</span> (<span class="number">1</span> == items.size()) &#123;</div><div class="line">       <span class="keyword">int</span> item = shardingContexts.getShardingItemParameters().keySet().iterator().next();</div><div class="line">       JobExecutionEvent jobExecutionEvent =  <span class="keyword">new</span> JobExecutionEvent(shardingContexts.getTaskId(), jobName, executionSource, item);</div><div class="line">       <span class="comment">// æ‰§è¡Œä¸€ä¸ªä½œä¸š</span></div><div class="line">       process(shardingContexts, item, jobExecutionEvent);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å¤šåˆ†ç‰‡ï¼Œå¹¶è¡Œæ‰§è¡Œ</span></div><div class="line">   <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(items.size());</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">final</span> <span class="keyword">int</span> each : items) &#123;</div><div class="line">       <span class="keyword">final</span> JobExecutionEvent jobExecutionEvent = <span class="keyword">new</span> JobExecutionEvent(shardingContexts.getTaskId(), jobName, executionSource, each);</div><div class="line">       <span class="keyword">if</span> (executorService.isShutdown()) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">       executorService.submit(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">           </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">// æ‰§è¡Œä¸€ä¸ªä½œä¸š</span></div><div class="line">                   process(shardingContexts, each, jobExecutionEvent);</div><div class="line">               &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                   latch.countDown();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç­‰å¾…å¤šåˆ†ç‰‡å…¨éƒ¨å®Œæˆ</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       latch.await();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException ex) &#123;</div><div class="line">       Thread.currentThread().interrupt();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>åˆ†é…<strong>å•</strong>åˆ†ç‰‡é¡¹æ—¶ï¼Œç›´æ¥æ‰§è¡Œï¼Œæ— éœ€ä½¿ç”¨çº¿ç¨‹æ± ï¼Œæ€§èƒ½æ›´ä¼˜ã€‚</li><li>åˆ†é…<strong>å¤š</strong>åˆ†ç‰‡é¡¹æ—¶ï¼Œä½¿ç”¨çº¿ç¨‹æ± <strong>å¹¶å‘</strong>æ‰§è¡Œï¼Œé€šè¿‡ CountDownLatch å®ç°ç­‰å¾…åˆ†ç‰‡é¡¹å…¨éƒ¨æ‰§è¡Œå®Œæˆã€‚</li></ul><hr><p><strong>private void process(shardingContexts, item, startEvent)</strong><br><strong>protected abstract void process(shardingContext)</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> <span class="keyword">int</span> item, <span class="keyword">final</span> JobExecutionEvent startEvent)</span> </span>&#123;</div><div class="line">   <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(å¼€å§‹)</span></div><div class="line">   <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">       jobFacade.postJobExecutionEvent(startEvent);</div><div class="line">   &#125;</div><div class="line">   log.trace(<span class="string">"Job '&#123;&#125;' executing, item is: '&#123;&#125;'."</span>, jobName, item);</div><div class="line">   JobExecutionEvent completeEvent;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// æ‰§è¡Œå•ä¸ªä½œä¸š</span></div><div class="line">       process(<span class="keyword">new</span> ShardingContext(shardingContexts, item));</div><div class="line">       <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(æˆåŠŸ)</span></div><div class="line">       completeEvent = startEvent.executionSuccess();</div><div class="line">       log.trace(<span class="string">"Job '&#123;&#125;' executed, item is: '&#123;&#125;'."</span>, jobName, item);</div><div class="line">       <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">           jobFacade.postJobExecutionEvent(completeEvent);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// CHECKSTYLE:OFF</span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable cause) &#123;</div><div class="line">       <span class="comment">// CHECKSTYLE:ON</span></div><div class="line">       <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(å¤±è´¥)</span></div><div class="line">       completeEvent = startEvent.executionFailure(cause);</div><div class="line">       jobFacade.postJobExecutionEvent(completeEvent);</div><div class="line">       <span class="comment">// è®¾ç½®è¯¥åˆ†ç‰‡æ‰§è¡Œå¼‚å¸¸ä¿¡æ¯</span></div><div class="line">       itemErrorMessages.put(item, ExceptionUtil.transform(cause));</div><div class="line">       <span class="comment">//</span></div><div class="line">       jobExceptionHandler.handleException(jobName, cause);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(ShardingContext shardingContext)</span></span>;</div></pre></td></tr></table></figure><ul><li>ä¸åŒä½œä¸šæ‰§è¡Œå™¨å®ç°ç±»é€šè¿‡å®ç° <code>#process(shardingContext)</code> æŠ½è±¡æ–¹æ³•ï¼Œå®ç°å¯¹<strong>å•ä¸ªåˆ†ç‰‡é¡¹</strong>ä½œä¸šçš„å¤„ç†ã€‚</li><li>ä¸åŒä½œä¸šæ‰§è¡Œå™¨å®ç°ç±»é€šè¿‡å®ç° <code>#process(shardingContext)</code> æŠ½è±¡æ–¹æ³•ï¼Œå®ç°å¯¹<strong>å•ä¸ªåˆ†ç‰‡é¡¹</strong>ä½œä¸šçš„å¤„ç†ã€‚</li><li>ä¸åŒä½œä¸šæ‰§è¡Œå™¨å®ç°ç±»é€šè¿‡å®ç° <code>#process(shardingContext)</code> æŠ½è±¡æ–¹æ³•ï¼Œå®ç°å¯¹<strong>å•ä¸ªåˆ†ç‰‡é¡¹</strong>ä½œä¸šçš„å¤„ç†ã€‚</li></ul><h3 id="4-6-1-ç®€å•ä½œä¸šæ‰§è¡Œå™¨"><a href="#4-6-1-ç®€å•ä½œä¸šæ‰§è¡Œå™¨" class="headerlink" title="4.6.1 ç®€å•ä½œä¸šæ‰§è¡Œå™¨"></a>4.6.1 ç®€å•ä½œä¸šæ‰§è¡Œå™¨</h3><p>SimpleJobExecutorï¼Œç®€å•ä½œä¸šæ‰§è¡Œå™¨</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleJobExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç®€å•ä½œä¸šå®ç°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SimpleJob simpleJob;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">        simpleJob.execute(shardingContext);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>SimpleJob#execute()</code> æ–¹æ³•å¯¹å•ä¸ªåˆ†ç‰‡é¡¹ä½œä¸šè¿›è¡Œå¤„ç†ã€‚</li></ul><h3 id="4-6-2-æ•°æ®æµä½œä¸šæ‰§è¡Œå™¨"><a href="#4-6-2-æ•°æ®æµä½œä¸šæ‰§è¡Œå™¨" class="headerlink" title="4.6.2 æ•°æ®æµä½œä¸šæ‰§è¡Œå™¨"></a>4.6.2 æ•°æ®æµä½œä¸šæ‰§è¡Œå™¨</h3><p>DataflowJobExecutorï¼Œæ•°æ®æµä½œä¸šæ‰§è¡Œå™¨ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DataflowJobExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•°æ®æµä½œä¸šå¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataflowJob&lt;Object&gt; dataflowJob;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">        DataflowJobConfiguration dataflowConfig = (DataflowJobConfiguration) getJobRootConfig().getTypeConfig();</div><div class="line">        <span class="keyword">if</span> (dataflowConfig.isStreamingProcess()) &#123; <span class="comment">// æµå¼å¤„ç†æ•°æ®</span></div><div class="line">            streamingExecute(shardingContext);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            oneOffExecute(shardingContext);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æµå¼å¤„ç†</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> shardingContext åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">streamingExecute</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">        List&lt;Object&gt; data = fetchData(shardingContext);</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">null</span> != data &amp;&amp; !data.isEmpty()) &#123;</div><div class="line">            processData(shardingContext, data);</div><div class="line">            <span class="keyword">if</span> (!getJobFacade().isEligibleForJobRunning()) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            data = fetchData(shardingContext);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸€æ¬¡å¤„ç†</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> shardingContext åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">oneOffExecute</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">        List&lt;Object&gt; data = fetchData(shardingContext);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != data &amp;&amp; !data.isEmpty()) &#123;</div><div class="line">            processData(shardingContext, data);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>å½“ä½œä¸šé…ç½®è®¾ç½®æµå¼å¤„ç†æ•°æ®( <code>DataflowJobConfiguration.streamingProcess = true</code> ) æ—¶ï¼Œè°ƒç”¨ <code>#streamingExecute()</code> <strong>ä¸æ–­</strong>åŠ è½½æ•°æ®ï¼Œ<strong>ä¸æ–­</strong>å¤„ç†æ•°æ®ï¼Œç›´åˆ°<strong>æ•°æ®ä¸ºç©º</strong> æˆ–è€… <strong>ä½œä¸šä¸é€‚åˆç»§ç»­è¿è¡Œ</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEligibleForJobRunning</span><span class="params">()</span> </span>&#123;</div><div class="line">   LiteJobConfiguration liteJobConfig = configService.load(<span class="keyword">true</span>);</div><div class="line">   <span class="keyword">if</span> (liteJobConfig.getTypeConfig() <span class="keyword">instanceof</span> DataflowJobConfiguration) &#123;</div><div class="line">       <span class="keyword">return</span> !shardingService.isNeedSharding() <span class="comment">// ä½œä¸šä¸éœ€è¦é‡æ–°åˆ†ç‰‡</span></div><div class="line">               &amp;&amp; ((DataflowJobConfiguration) liteJobConfig.getTypeConfig()).isStreamingProcess();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> !shardingService.isNeedSharding(); <span class="comment">// ä½œä¸šä¸éœ€è¦é‡æ–°åˆ†ç‰‡</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>ä½œä¸šéœ€è¦é‡æ–°åˆ†ç‰‡ï¼Œæ‰€ä»¥ä¸é€‚åˆç»§ç»­æµå¼æ•°æ®å¤„ç†ã€‚</p><blockquote><p>å¦‚æœé‡‡ç”¨æµå¼ä½œä¸šå¤„ç†æ–¹å¼ï¼Œå»ºè®®processDataå¤„ç†æ•°æ®åæ›´æ–°å…¶çŠ¶æ€ï¼Œé¿å…fetchDataå†æ¬¡æŠ“å–åˆ°ï¼Œä»è€Œä½¿å¾—ä½œä¸šæ°¸ä¸åœæ­¢ã€‚ æµå¼æ•°æ®å¤„ç†å‚ç…§TbScheduleè®¾è®¡ï¼Œé€‚ç”¨äºä¸é—´æ­‡çš„æ•°æ®å¤„ç†ã€‚</p></blockquote></li></ul></li><li><p>å½“ä½œä¸šé…ç½®<strong>ä¸</strong>è®¾ç½®æµå¼å¤„ç†æ•°æ®( <code>DataflowJobConfiguration.streamingProcess = false</code> ) æ—¶ï¼Œè°ƒç”¨ <code>#oneOffExecute()</code> <strong>ä¸€æ¬¡</strong>åŠ è½½æ•°æ®ï¼Œ<strong>ä¸€æ¬¡</strong>å¤„ç†æ•°æ®ã€‚</p></li><li><p>è°ƒç”¨ <code>#fetchData()</code> æ–¹æ³•åŠ è½½æ•°æ®ï¼›è°ƒç”¨ <code>#processData(...)</code> æ–¹æ³•å¤„ç†æ•°æ®ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DataflowJobExecutor.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åŠ è½½æ•°æ®</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContext åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">* <span class="doctag">@return</span> æ•°æ®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> List&lt;Object&gt; <span class="title">fetchData</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> dataflowJob.fetchData(shardingContext);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* å¤„ç†æ•°æ®</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContext åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">* <span class="doctag">@param</span> data æ•°æ®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processData</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext, <span class="keyword">final</span> List&lt;Object&gt; data)</span> </span>&#123;</div><div class="line">   dataflowJob.processData(shardingContext, data);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><h3 id="4-6-3-è„šæœ¬ä½œä¸šæ‰§è¡Œå™¨"><a href="#4-6-3-è„šæœ¬ä½œä¸šæ‰§è¡Œå™¨" class="headerlink" title="4.6.3 è„šæœ¬ä½œä¸šæ‰§è¡Œå™¨"></a>4.6.3 è„šæœ¬ä½œä¸šæ‰§è¡Œå™¨</h3><p>ScriptJobExecutorï¼Œè„šæœ¬ä½œä¸šæ‰§è¡Œå™¨ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ScriptJobExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> String scriptCommandLine = ((ScriptJobConfiguration) getJobRootConfig().getTypeConfig()).getScriptCommandLine();</div><div class="line">        <span class="keyword">if</span> (Strings.isNullOrEmpty(scriptCommandLine)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Cannot find script command line for job '%s', job is not executed."</span>, shardingContext.getJobName());</div><div class="line">        &#125;</div><div class="line">        executeScript(shardingContext, scriptCommandLine);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰§è¡Œè„šæœ¬</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> shardingContext åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">     * <span class="doctag">@param</span> scriptCommandLine æ‰§è¡Œè„šæœ¬è·¯å¾„</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeScript</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext, <span class="keyword">final</span> String scriptCommandLine)</span> </span>&#123;</div><div class="line">        CommandLine commandLine = CommandLine.parse(scriptCommandLine);</div><div class="line">        <span class="comment">// JSON æ ¼å¼ä¼ é€’å‚æ•°</span></div><div class="line">        commandLine.addArgument(GsonFactory.getGson().toJson(shardingContext), <span class="keyword">false</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">new</span> DefaultExecutor().execute(commandLine);</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Execute script failure."</span>, ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p><code>scriptCommandLine</code> ä¼ é€’çš„æ˜¯<strong>è„šæœ¬è·¯å¾„</strong>ã€‚ä½¿ç”¨ <a href="https://commons.apache.org/proper/commons-exec/" rel="external nofollow noopener noreferrer" target="_blank">Apache Commons Exec</a> å·¥å…·åŒ…å®ç°è„šæœ¬è°ƒç”¨ï¼š</p><blockquote><p>Scriptç±»å‹ä½œä¸šæ„ä¸ºè„šæœ¬ç±»å‹ä½œä¸šï¼Œæ”¯æŒshellï¼Œpythonï¼Œperlç­‰æ‰€æœ‰ç±»å‹è„šæœ¬ã€‚åªéœ€é€šè¿‡æ§åˆ¶å°æˆ–ä»£ç é…ç½®scriptCommandLineå³å¯ï¼Œæ— éœ€ç¼–ç ã€‚æ‰§è¡Œè„šæœ¬è·¯å¾„å¯åŒ…å«å‚æ•°ï¼Œå‚æ•°ä¼ é€’å®Œæ¯•åï¼Œä½œä¸šæ¡†æ¶ä¼šè‡ªåŠ¨è¿½åŠ æœ€åä¸€ä¸ªå‚æ•°ä¸ºä½œä¸šè¿è¡Œæ—¶ä¿¡æ¯ã€‚</p></blockquote></li><li><p>è„šæœ¬å‚æ•°ä¼ é€’ä½¿ç”¨ JSON æ ¼å¼ã€‚</p></li></ul><h2 id="4-7-æ‰§è¡Œè¢«é”™è¿‡è§¦å‘çš„ä½œä¸š"><a href="#4-7-æ‰§è¡Œè¢«é”™è¿‡è§¦å‘çš„ä½œä¸š" class="headerlink" title="4.7 æ‰§è¡Œè¢«é”™è¿‡è§¦å‘çš„ä½œä¸š"></a>4.7 æ‰§è¡Œè¢«é”™è¿‡è§¦å‘çš„ä½œä¸š</h2><p>å½“ä½œä¸šæ‰§è¡Œè¿‡ä¹…ï¼Œå¯¼è‡´åˆ°è¾¾ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´æœªè¿›è¡Œä¸‹ä¸€æ¬¡ä½œä¸šæ‰§è¡Œï¼ŒElastic-Job-Lite ä¼šè®¾ç½®è¯¥ä½œä¸šåˆ†ç‰‡é¡¹ä¸ºè¢«é”™è¿‡æ‰§è¡Œ( misfired )ã€‚ä¸‹ä¸€æ¬¡ä½œä¸šæ‰§è¡Œæ—¶ï¼Œä¼š<strong>è¡¥å……</strong>æ‰§è¡Œè¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p><p><strong>æ ‡è®°ä½œä¸šè¢«é”™è¿‡æ‰§è¡Œ</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobScheduler.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> Scheduler <span class="title">createScheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">   Scheduler result;</div><div class="line">   <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">   result.getListenerManager().addTriggerListener(schedulerFacade.newJobTriggerListener());</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Properties <span class="title">getBaseQuartzProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">   result.put(<span class="string">"org.quartz.jobStore.misfireThreshold"</span>, <span class="string">"1"</span>);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobScheduleController.class</span></div><div class="line"><span class="function"><span class="keyword">private</span> CronTrigger <span class="title">createTrigger</span><span class="params">(<span class="keyword">final</span> String cron)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> TriggerBuilder.newTrigger()</div><div class="line">           .withIdentity(triggerIdentity)</div><div class="line">           .withSchedule(CronScheduleBuilder.cronSchedule(cron)</div><div class="line">           .withMisfireHandlingInstructionDoNothing())</div><div class="line">           .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>org.quartz.jobStore.misfireThreshold</code> è®¾ç½®è¶…è¿‡ 1 æ¯«ç§’ï¼Œä½œä¸šåˆ†ç‰‡é¡¹å³è¢«è§†ä¸ºé”™è¿‡æ‰§è¡Œã€‚</li><li><code>#withMisfireHandlingInstructionDoNothing()</code> è®¾ç½® Quartz ç³»ç»Ÿä¸ä¼šç«‹åˆ»å†æ‰§è¡Œä»»åŠ¡ï¼Œè€Œæ˜¯ç­‰åˆ°è·ç¦»ç›®å‰æ—¶é—´æœ€è¿‘çš„é¢„è®¡æ—¶é—´æ‰§è¡Œã€‚<strong>é‡æ–°æ‰§è¡Œè¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸šäº¤ç»™ Elastic-Job-Lite å¤„ç†</strong>ã€‚</li><li><p>ä½¿ç”¨ TriggerListener ç›‘å¬è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸šåˆ†ç‰‡é¡¹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobTriggerListener.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobTriggerListener</span> <span class="keyword">extends</span> <span class="title">TriggerListenerSupport</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">triggerMisfired</span><span class="params">(<span class="keyword">final</span> Trigger trigger)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != trigger.getPreviousFireTime()) &#123;</div><div class="line">            executionService.setMisfire(shardingService.getLocalShardingItems());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ExecutionService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMisfire</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; items)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : items) &#123;</div><div class="line">       jobNodeStorage.createJobNodeIfNeeded(ShardingNode.getMisfireNode(each));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#setMisfire(...)</code> è®¾ç½®ä½œä¸šåˆ†ç‰‡é¡¹è¢«é”™è¿‡æ‰§è¡Œã€‚</li></ul></li></ul><p><strong>è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">misfireIfRunning</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> executionService.misfireIfHasRunningItems(shardingItems);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ExecutionService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">misfireIfHasRunningItems</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; items)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!hasRunningItems(items)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">   setMisfire(items);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasRunningItems</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; items)</span> </span>&#123;</div><div class="line">   LiteJobConfiguration jobConfig = configService.load(<span class="keyword">true</span>);</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> == jobConfig || !jobConfig.isMonitorExecution()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : items) &#123;</div><div class="line">       <span class="keyword">if</span> (jobNodeStorage.isJobNodeExisted(ShardingNode.getRunningNode(each))) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å½“åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹é‡Œå­˜åœ¨<strong>ä»»æ„ä¸€ä¸ªåˆ†ç‰‡æ­£åœ¨è¿è¡Œ</strong>ä¸­ï¼Œè®¾ç½®åˆ†ç‰‡é¡¹<strong>éƒ½</strong>è¢«é”™è¿‡æ‰§è¡Œ( <code>misfired</code> )ï¼Œå¹¶ä¸æ‰§è¡Œè¿™äº›ä½œä¸šåˆ†ç‰‡ã€‚å¦‚æœä¸è¿›è¡Œè·³è¿‡ï¼Œåˆ™å¯èƒ½å¯¼è‡´<strong>åŒæ—¶</strong>è¿è¡ŒæŸä¸ªä½œä¸šåˆ†ç‰‡ã€‚</li><li>è¯¥åŠŸèƒ½ä¾èµ–ä½œä¸šé…ç½®<strong>ç›‘æ§ä½œä¸šè¿è¡Œæ—¶çŠ¶æ€</strong>( <code>LiteJobConfiguration.monitorExecution = true</code> )æ—¶ç”Ÿæ•ˆã€‚</li></ul><p><strong>æ‰§è¡Œè¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸šåˆ†ç‰‡é¡¹</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">   <span class="comment">// æ‰§è¡Œ è¢«è·³è¿‡è§¦å‘çš„ä½œä¸š</span></div><div class="line">   <span class="keyword">while</span> (jobFacade.isExecuteMisfired(shardingContexts.getShardingItemParameters().keySet())) &#123;</div><div class="line">       jobFacade.clearMisfire(shardingContexts.getShardingItemParameters().keySet());</div><div class="line">       execute(shardingContexts, JobExecutionEvent.ExecutionSource.MISFIRE);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExecuteMisfired</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> isEligibleForJobRunning() <span class="comment">// åˆé€‚ç»§ç»­è¿è¡Œ</span></div><div class="line">           &amp;&amp; configService.load(<span class="keyword">true</span>).getTypeConfig().getCoreConfig().isMisfire() <span class="comment">// ä½œä¸šé…ç½®å¼€å¯ä½œä¸šè¢«é”™è¿‡è§¦å‘</span></div><div class="line">           &amp;&amp; !executionService.getMisfiredJobItems(shardingItems).isEmpty(); <span class="comment">// æ‰€æ‰§è¡Œçš„ä½œä¸šåˆ†ç‰‡å­˜åœ¨è¢«é”™è¿‡( misfired )</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearMisfire</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   executionService.clearMisfire(shardingItems);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>æ¸…é™¤åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹è¢«é”™è¿‡æ‰§è¡Œçš„æ ‡è¯†ï¼Œå¹¶æ‰§è¡Œä½œä¸šåˆ†ç‰‡é¡¹ã€‚</li><li>ä¸ºä»€ä¹ˆæ­¤å¤„ä½¿ç”¨ <strong>while(â€¦)</strong>ï¼Ÿ<strong>é˜²å¾¡æ€§ç¼–ç¨‹</strong>ï¼Œ<code>#isExecuteMisfired(...)</code> åˆ¤æ–­ä½¿ç”¨<strong>å†…å­˜ç¼“å­˜</strong>çš„æ•°æ®ï¼Œè€Œè¯¥æ•°æ®çš„æ›´æ–°ä¾èµ– Zookeeper é€šçŸ¥è¿›è¡Œ<strong>å¼‚æ­¥</strong>æ›´æ–°ï¼Œå¯èƒ½å› ä¸ºå„ç§æƒ…å†µï¼Œä¾‹å¦‚ç½‘ç»œï¼Œæ•°æ®å¯èƒ½æœªåŠæ—¶æ›´æ–°å¯¼è‡´<strong>æ•°æ®ä¸ä¸€è‡´</strong>ã€‚ä½¿ç”¨ <strong>while(â€¦)</strong> è¿›è¡Œé˜²å¾¡ç¼–ç¨‹ï¼Œä¿è¯<strong>å†…å­˜ç¼“å­˜</strong>çš„æ•°æ®å·²ç»æ›´æ–°ã€‚</li></ul><h2 id="4-8-æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»"><a href="#4-8-æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»" class="headerlink" title="4.8 æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»"></a>4.8 æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failoverIfNecessary</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (configService.load(<span class="keyword">true</span>).isFailover()) &#123;</div><div class="line">       failoverService.failoverIfNecessary();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ä½œä¸šå¤±æ•ˆè½¬ç§»æœåŠ¡( FailoverService )æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»( <code>#failoverIfNecessary()</code> )ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-failover/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li></ul><h2 id="4-9-æ‰§è¡Œä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•"><a href="#4-9-æ‰§è¡Œä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•" class="headerlink" title="4.9 æ‰§è¡Œä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•"></a>4.9 æ‰§è¡Œä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (ElasticJobListener each : elasticJobListeners) &#123;</div><div class="line">       each.afterJobExecuted(shardingContexts);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ä½œä¸šç›‘å¬å™¨æ‰§è¡Œä½œä¸š<strong>æ‰§è¡Œå</strong>çš„æ–¹æ³•ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-listener/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šç›‘å¬å™¨ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å‘¼ï¼ç•¥é•¿ç•¥é•¿ç•¥é•¿ï¼</p><p>ä¸‹é¢ä¼šæ›´æ–°å¦‚ä¸‹ä¸¤ç¯‡æ–‡ç« ï¼Œä¸ºåç»­çš„ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€å¤±æ•ˆè½¬ç§»ã€ä½œä¸šåˆ†ç‰‡ç­–ç•¥ç­‰æ–‡ç« åšé“ºå«ï¼š</p><ul><li><a href="http://www.iocoder.cn/Elastic-Job/reg-center-zookeeper/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” æ³¨å†Œä¸­å¿ƒã€‹</a></li><li><a href="http://www.iocoder.cn/Elastic-Job/job-storage/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ•°æ®å­˜å‚¨ã€‹</a></li></ul><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p><p>å•Šå•Šå•Šï¼Œæˆ‘å¥½æƒ³é©¬ä¸Šæ‹œè¯» Elastic-Job-Cloudã€‚ä¸ºäº†ä½ ä»¬ï¼Œæˆ‘å¿ä½äº†å¿ƒç¢ã€‚</p><p>æ—ç™½å›ï¼šç…ç¬”ç¬”è€…å·²ç»å·å·åœ¨è¯»äº†ã€‚<br>èŠ‹é“å›ï¼šæ—ç™½å›ï¼Œä½ å¤§çˆ·ï¼</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/Elastic-Job-Lite/">Elastic-Job-Lite</a></div><div class="article-share" id="share"><div data-url="http://www.iocoder.cn/Elastic-Job/job-execute/" data-title="Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œ | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/Elastic-Job/reg-center-zookeeper/" title="Elastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒ"><strong>PREVIOUS:</strong><br><span>Elastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒ</span></a></div><div class="next"><a href="/Elastic-Job/job-init/" title="Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆå§‹åŒ–"><strong>NEXT:</strong><br><span>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆå§‹åŒ–</span></a></div></nav></div></div><footer><div id="footer"><img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display:none"><p class="copyright">Â© 2017 <a href="http://www.iocoder.cn" target="_blank" title="ç‹æ–‡æ–Œ">ç‹æ–‡æ–Œ</a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a> && Powered by <a href="http://hexo.io" target="_blank" title="hexo" rel="external nofollow noopener noreferrer">hexo</a> && Theme by <a href="http://gengbiao.me" target="_blank" title="coney" rel="external nofollow noopener noreferrer">coney</a></p></div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2");ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script src="/js/util.js"></script></body>