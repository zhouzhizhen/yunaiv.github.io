<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="ç‹æ–‡æ–Œ"><meta name="description" content="æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«

1. æ¦‚è¿°
2. ä½œä¸šæ‰§è¡Œç±»å‹
3. Producer å‘å¸ƒä»»åŠ¡
3.1 å¸¸é©»ä½œä¸š
3.2 ç¬æ—¶ä½œä¸š
3.2.1 TransientProducerScheduler
3.2.2 æ³¨å†Œç¬æ—¶ä½œä¸š
3.2.3 ProducerJob


3.3"><meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?9e70e3362807c1bd185a79655b307027";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG">èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</a></h1><a class="blog-motto">æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li><li><a href="/link_url">å‹é“¾</a></li></ul></ul></nav></div></header><div id="container"><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-ä½œä¸šæ‰§è¡Œç±»å‹"><span class="toc-number">2.</span> <span class="toc-text">2. ä½œä¸šæ‰§è¡Œç±»å‹</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Producer-å‘å¸ƒä»»åŠ¡"><span class="toc-number">3.</span> <span class="toc-text">3. Producer å‘å¸ƒä»»åŠ¡</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-å¸¸é©»ä½œä¸š"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 å¸¸é©»ä½œä¸š</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-ç¬æ—¶ä½œä¸š"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 ç¬æ—¶ä½œä¸š</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-TransientProducerScheduler"><span class="toc-number">3.2.1.</span> <span class="toc-text">3.2.1 TransientProducerScheduler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-æ³¨å†Œç¬æ—¶ä½œä¸š"><span class="toc-number">3.2.2.</span> <span class="toc-text">3.2.2 æ³¨å†Œç¬æ—¶ä½œä¸š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-ProducerJob"><span class="toc-number">3.2.3.</span> <span class="toc-text">3.2.3 ProducerJob</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-å°ç»“"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 å°ç»“</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-TaskLaunchScheduledService-æäº¤ä»»åŠ¡"><span class="toc-number">4.</span> <span class="toc-text">4. TaskLaunchScheduledService æäº¤ä»»åŠ¡</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-åˆ›å»º-Fenzo-ä»»åŠ¡è¯·æ±‚"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 åˆ›å»º Fenzo ä»»åŠ¡è¯·æ±‚</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-AppConstraintEvaluator"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 AppConstraintEvaluator</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ°-Mesos-Offer"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ° Mesos Offer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-åˆ›å»º-Mesos-ä»»åŠ¡ä¿¡æ¯"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 åˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-1-åˆ›å»ºå•ä¸ª-Mesos-ä»»åŠ¡ä¿¡æ¯"><span class="toc-number">4.4.1.</span> <span class="toc-text">4.4.1 åˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ä¿¡æ¯</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—"><span class="toc-number">4.5.</span> <span class="toc-text">4.5 å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6-ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š"><span class="toc-number">4.6.</span> <span class="toc-text">4.6 ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-7-æäº¤ä»»åŠ¡ç»™-Mesos"><span class="toc-number">4.7.</span> <span class="toc-text">4.7 æäº¤ä»»åŠ¡ç»™ Mesos</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-TaskExecutor-æ‰§è¡Œä»»åŠ¡"><span class="toc-number">5.</span> <span class="toc-text">5. TaskExecutor æ‰§è¡Œä»»åŠ¡</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-TaskThread"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 TaskThread</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-DaemonTaskScheduler"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 DaemonTaskScheduler</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-SchedulerEngine-å¤„ç†ä»»åŠ¡çš„çŠ¶æ€å˜æ›´"><span class="toc-number">6.</span> <span class="toc-text">6. SchedulerEngine å¤„ç†ä»»åŠ¡çš„çŠ¶æ€å˜æ›´</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-å½©è›‹"><span class="toc-number">7.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li><li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/TCC-Transaction/" title="TCC-Transaction">TCC-Transaction<sup>6</sup></a></li><li><a href="/categories/æŠ€æœ¯æ‚æ–‡/" title="æŠ€æœ¯æ‚æ–‡">æŠ€æœ¯æ‚æ–‡<sup>4</sup></a></li></ul></div></aside></div><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/Elastic-Job/cloud-job-scheduler-and-executor-first/" title="Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰" itemprop="url">Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰</a></h1><p class="article-author"></p><p class="article-time">æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. ä½œä¸šæ‰§è¡Œç±»å‹</a></li><li><a href="#">3. Producer å‘å¸ƒä»»åŠ¡</a><ul><li><a href="#">3.1 å¸¸é©»ä½œä¸š</a></li><li><a href="#">3.2 ç¬æ—¶ä½œä¸š</a><ul><li><a href="#">3.2.1 TransientProducerScheduler</a></li><li><a href="#">3.2.2 æ³¨å†Œç¬æ—¶ä½œä¸š</a></li><li><a href="#">3.2.3 ProducerJob</a></li></ul></li><li><a href="#">3.3 å°ç»“</a></li></ul></li><li><a href="#">4. TaskLaunchScheduledService æäº¤ä»»åŠ¡</a><ul><li><a href="#">4.1 åˆ›å»º Fenzo ä»»åŠ¡è¯·æ±‚</a></li><li><a href="#">4.2 AppConstraintEvaluator</a></li><li><a href="#">4.3 å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ° Mesos Offer</a></li><li><a href="#">4.4 åˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯</a><ul><li><a href="#">4.4.1 åˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ä¿¡æ¯</a></li></ul></li><li><a href="#">4.5 å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—</a></li><li><a href="#">4.6 ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š</a></li><li><a href="#">4.7 æäº¤ä»»åŠ¡ç»™ Mesos</a></li></ul></li><li><a href="#">5. TaskExecutor æ‰§è¡Œä»»åŠ¡</a><ul><li><a href="#">5.1 TaskThread</a></li><li><a href="#">5.2 DaemonTaskScheduler</a></li></ul></li><li><a href="#">6. SchedulerEngine å¤„ç†ä»»åŠ¡çš„çŠ¶æ€å˜æ›´</a></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Cloud è°ƒåº¦ä¸»æµç¨‹</strong>ã€‚å¯¹åº”åˆ° Elastic-Job-Lite æºç è§£ææ–‡ç« å¦‚ä¸‹ï¼š</p><ul><li><a href="http://www.iocoder.cn/Elastic-Job/job-init/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆå§‹åŒ–ã€‹</a></li><li><a href="http://www.iocoder.cn/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a></li><li><a href="http://www.iocoder.cn/Elastic-Job/job-sharding/">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a></li></ul><p>å¦‚æœä½ é˜…è¯»è¿‡ä»¥ä¸‹æ–‡ç« ï¼Œæœ‰åŠ©äºå¯¹æœ¬æ–‡çš„ç†è§£ï¼š</p><ul><li><a href="http://www.infoq.com/cn/news/2016/09/Mesos-Elastic-Job-Cloud" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠåŸºäºMesosçš„å½“å½“ä½œä¸šäº‘Elastic Job Cloudã€‹</a></li><li><a href="https://segmentfault.com/a/1190000007723430" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç”±æµ…å…¥æ·± | å¦‚ä½•ä¼˜é›…åœ°å†™ä¸€ä¸ªMesos Frameworkã€‹</a></li></ul><p>ğŸ˜ˆ å¦å¤–ï¼Œç¬”è€…å‡è®¾ä½ å·²ç»å¯¹ <strong><a href="http://www.iocoder.cn/categories/Elastic-Job/?self">ã€ŠElastic-Job-Lite æºç åˆ†æç³»åˆ—ã€‹</a></strong> æœ‰ä¸€å®šçš„äº†è§£ã€‚</p><p>æœ¬æ–‡æ¶‰åŠåˆ°ä¸»ä½“ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/01.png" alt=""></p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>Elastic-Job-Cloud åŸºäº Mesos å®ç°åˆ†å¸ƒå¼ä½œä¸šè°ƒåº¦ï¼Œæˆ–è€…è¯´ Elastic-Job-Cloud æ˜¯ Mesos ä¸Šçš„ æ¡†æ¶( Framework )ã€‚</p><p>ä¸€ä¸ª Mesos æ¡†æ¶ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>æ§åˆ¶å™¨éƒ¨åˆ†ï¼Œç§°ä¸ºè°ƒåº¦å™¨( Scheduler )ã€‚</li><li>å·¥ä½œå•å…ƒéƒ¨åˆ†ï¼Œç§°ä¸ºæ‰§è¡Œå™¨( Executor )ã€‚</li></ul><p>Elastic-Job-Cloud ç”±ä¸¤ä¸ªé¡¹ç›®ç»„æˆï¼š</p><ul><li>Elastic-Job-Cloud-Schedulerï¼Œå®ç°è°ƒåº¦å™¨ï¼Œå®ç°ç±»ä¸º <code>com.dangdang.ddframe.job.cloud.scheduler.mesos.SchedulerEngine</code>ã€‚</li><li>Elastic-Job-Cloud-Executorï¼Œå®ç°æ‰§è¡Œå™¨ï¼Œå®ç°ç±»ä¸º <code>com.dangdang.ddframe.job.cloud.executor.TaskExecutor</code>ã€‚</li></ul><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/11.png" alt=""></p><p>æœ¬æ–‡ç•¥å¾®<strong>â€œå•°å—¦â€</strong>ï¼Œè¯·ä¿æŒ<strong>è€å¿ƒ</strong>ã€‚æ­é…<a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç”¨Mesosæ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a>ä¸€èµ·é˜…è¯»ï¼Œç†è§£éš¾åº¦é™ä½ 99%ã€‚OKï¼Œå¼€å§‹æˆ‘ä»¬çš„ Cloud ä¹‹æ—…ã€‚</p><h1 id="2-ä½œä¸šæ‰§è¡Œç±»å‹"><a href="#2-ä½œä¸šæ‰§è¡Œç±»å‹" class="headerlink" title="2. ä½œä¸šæ‰§è¡Œç±»å‹"></a>2. ä½œä¸šæ‰§è¡Œç±»å‹</h1><p>åœ¨ Elastic-Job-Cloudï¼Œä½œä¸šæ‰§è¡Œåˆ†æˆä¸¤ç§ç±»å‹ï¼š</p><ul><li>å¸¸é©»ä½œä¸š</li></ul><blockquote><p>å¸¸é©»ä½œä¸šæ˜¯ä½œä¸šä¸€æ—¦å¯åŠ¨ï¼Œæ— è®ºè¿è¡Œä¸å¦å‡å ç”¨ç³»ç»Ÿèµ„æºï¼›<br>å¸¸é©»ä½œä¸šé€‚åˆåˆå§‹åŒ–æ—¶é—´é•¿ã€è§¦å‘é—´éš”çŸ­ã€å®æ—¶æ€§è¦æ±‚é«˜çš„ä½œä¸šï¼Œè¦æ±‚èµ„æºé…å¤‡å……è¶³ã€‚</p></blockquote><ul><li>ç¬æ—¶ä½œä¸š</li></ul><blockquote><p>ç¬æ—¶ä½œä¸šæ˜¯åœ¨ä½œä¸šå¯åŠ¨æ—¶å ç”¨èµ„æºï¼Œè¿è¡Œå®Œæˆåé‡Šæ”¾èµ„æºã€‚<br>ç¬æ—¶ä½œä¸šé€‚åˆåˆå§‹åŒ–æ—¶é—´çŸ­ã€è§¦å‘é—´éš”é•¿ã€å…è®¸å»¶è¿Ÿçš„ä½œä¸šï¼Œä¸€èˆ¬ç”¨äºèµ„æºä¸å¤ªå……åˆ†ï¼Œæˆ–ä½œä¸šè¦æ±‚çš„èµ„æºå¤šï¼Œé€‚åˆèµ„æºé”™å³°ä½¿ç”¨çš„åœºæ™¯ã€‚</p></blockquote><p>Elastic-Job-Cloud ä¸åŒäº Elastic-Job-Lite å»ä¸­å¿ƒåŒ–æ‰§è¡Œè°ƒåº¦ï¼Œè½¬å˜ä¸º <strong>Mesos Framework çš„ä¸­å¿ƒèŠ‚ç‚¹è°ƒåº¦</strong>ã€‚è¿™é‡Œä¸å¤ªç†è§£ï¼Œæ²¡å…³ç³»ï¼Œä¸‹æ–‡çœ‹åˆ°å…·ä½“ä»£ç å°±èƒ½æ˜ç™½äº†ã€‚</p><p>å¸¸é©»ä½œä¸šã€ç¬æ—¶ä½œä¸šåœ¨è°ƒåº¦ä¸­ä¼šç•¥æœ‰ä¸åŒï¼Œå¤§ä½“<strong>ç²—ç•¥</strong>æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/02.png" alt=""></p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬é’ˆå¯¹æ¯ä¸ªè¿‡ç¨‹ä¸€èŠ‚ä¸€èŠ‚è§£æã€‚</p><h1 id="3-Producer-å‘å¸ƒä»»åŠ¡"><a href="#3-Producer-å‘å¸ƒä»»åŠ¡" class="headerlink" title="3. Producer å‘å¸ƒä»»åŠ¡"></a>3. Producer å‘å¸ƒä»»åŠ¡</h1><p>åœ¨ä¸Šæ–‡<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-config/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹çš„ã€Œ3.1.1 æ“ä½œäº‘ä½œä¸šé…ç½®ã€</a>å¯ä»¥çœ‹åˆ°æ·»åŠ äº‘ä½œä¸šé…ç½®åï¼ŒElastic-Job-Cloud-Scheduler ä¼šæ‰§è¡Œ<strong>ä½œä¸šè°ƒåº¦</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ProducerManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è°ƒåº¦ä½œä¸š.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">schedule</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   <span class="comment">// åº”ç”¨ æˆ– ä½œä¸š è¢«ç¦ç”¨ï¼Œä¸è°ƒåº¦</span></div><div class="line">   <span class="keyword">if</span> (disableAppService.isDisabled(jobConfig.getAppName()) || disableJobService.isDisabled(jobConfig.getJobName())) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (CloudJobExecutionType.TRANSIENT == jobConfig.getJobExecutionType()) &#123; <span class="comment">// ç¬æ—¶ä½œä¸š</span></div><div class="line">       transientProducerScheduler.register(jobConfig);</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (CloudJobExecutionType.DAEMON == jobConfig.getJobExecutionType()) &#123; <span class="comment">// å¸¸é©»ä½œä¸š</span></div><div class="line">       readyService.addDaemon(jobConfig.getJobName());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ç¬æ—¶ä½œä¸šå’Œå¸¸é©»ä½œä¸šåœ¨è°ƒåº¦ä¸Šä¼šæœ‰ä¸€å®šçš„ä¸åŒã€‚</li></ul><h2 id="3-1-å¸¸é©»ä½œä¸š"><a href="#3-1-å¸¸é©»ä½œä¸š" class="headerlink" title="3.1 å¸¸é©»ä½œä¸š"></a>3.1 å¸¸é©»ä½œä¸š</h2><p>å¸¸é©»ä½œä¸šåœ¨è°ƒåº¦æ—¶ï¼Œç›´æ¥æ·»åŠ åˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ã€‚Whatï¼Ÿå²‚ä¸æ˜¯é©¬ä¸Šå°±è¿è¡Œäº†ï¼No No Noï¼Œç­”æ¡ˆåœ¨ã€Œ5. TaskExecutor æ‰§è¡Œä»»åŠ¡ã€ï¼Œè¿™é‡Œå…ˆæ‰“ä½ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ReadyService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å°†å¸¸é©»ä½œä¸šæ”¾å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobName ä½œä¸šåç§°</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDaemon</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (regCenter.getNumChildren(ReadyNode.ROOT) &gt; env.getFrameworkConfiguration().getJobStateQueueSize()) &#123;</div><div class="line">       log.warn(<span class="string">"Cannot add daemon job, caused by read state queue size is larger than &#123;&#125;."</span>, env.getFrameworkConfiguration().getJobStateQueueSize());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   Optional&lt;CloudJobConfiguration&gt; cloudJobConfig = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (!cloudJobConfig.isPresent() || CloudJobExecutionType.DAEMON != cloudJobConfig.get().getJobExecutionType() || runningService.isJobRunning(jobName)) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°å¾…æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line">   regCenter.persist(ReadyNode.getReadyJobNodePath(jobName), <span class="string">"1"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ReadyNode.java</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadyNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = StateNode.ROOT + <span class="string">"/ready"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String READY_JOB = ROOT + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;JOB_NAME&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ReadyServiceï¼Œå¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—æœåŠ¡ï¼Œæä¾›å¯¹å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—çš„å„ç§æ“ä½œæ–¹æ³•ã€‚</li><li><p><strong>å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong>å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${NAMESPACE}/state/ready/${JOB_NAME}</code>ï¼Œå­˜å‚¨å€¼ä¸ºå¾…æ‰§è¡Œæ¬¡æ•°ã€‚ä¾‹å¦‚æ­¤å¤„ï¼Œå¾…æ‰§è¡Œæ¬¡æ•°ä¸º <code>1</code>ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 4] ls /elastic-job-cloud/state/ready</div><div class="line">[test_job_simple]</div><div class="line">[zk: localhost:2181(CONNECTED) 5] get /elastic-job-cloud/state/ready/test_job_simple</div><div class="line">1</div></pre></td></tr></table></figure></li><li><p>åœ¨è¿ç»´å¹³å°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/10.png" alt=""></p></li><li><p>ä»å®˜æ–¹çš„ RoadMap æ¥çœ‹ï¼Œ<strong>å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong>æœªæ¥ä¼šä½¿ç”¨ Redis å­˜å‚¨ä»¥æé«˜æ€§èƒ½ã€‚</p><blockquote><p>FROM <a href="http://elasticjob.io/docs/elastic-job-cloud/03-design/roadmap/" rel="external nofollow noopener noreferrer" target="_blank">http://elasticjob.io/docs/elastic-job-cloud/03-design/roadmap/</a><br>Redis Based Queue Improvement</p></blockquote></li></ul><h2 id="3-2-ç¬æ—¶ä½œä¸š"><a href="#3-2-ç¬æ—¶ä½œä¸š" class="headerlink" title="3.2 ç¬æ—¶ä½œä¸š"></a>3.2 ç¬æ—¶ä½œä¸š</h2><p>ç¬æ—¶ä½œä¸šåœ¨è°ƒåº¦æ—¶ï¼Œä½¿ç”¨<strong>å‘å¸ƒç¬æ—¶ä½œä¸šä»»åŠ¡çš„è°ƒåº¦å™¨</strong>( TransientProducerScheduler )è°ƒåº¦ä½œä¸šã€‚å½“ç¬æ—¶ä½œä¸šåˆ°è¾¾ä½œä¸šæ‰§è¡Œæ—¶é—´ï¼Œæ·»åŠ åˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ã€‚</p><h3 id="3-2-1-TransientProducerScheduler"><a href="#3-2-1-TransientProducerScheduler" class="headerlink" title="3.2.1 TransientProducerScheduler"></a>3.2.1 TransientProducerScheduler</h3><p>TransientProducerSchedulerï¼Œå‘å¸ƒç¬æ—¶ä½œä¸šä»»åŠ¡çš„è°ƒåº¦å™¨ï¼ŒåŸºäº Quartz å®ç°å¯¹ç¬æ—¶ä½œä¸šçš„è°ƒåº¦ã€‚åˆå§‹åŒ–ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransientProducerScheduler.java</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">   scheduler = getScheduler();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       scheduler.start();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Scheduler <span class="title">getScheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">   StdSchedulerFactory factory = <span class="keyword">new</span> StdSchedulerFactory();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       factory.initialize(getQuartzProperties());</div><div class="line">       <span class="keyword">return</span> factory.getScheduler();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> Properties <span class="title">getQuartzProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">   Properties result = <span class="keyword">new</span> Properties();</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.class"</span>, SimpleThreadPool.class.getName());</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.threadCount"</span>, Integer.toString(Runtime.getRuntime().availableProcessors() * <span class="number">2</span>)); <span class="comment">// çº¿ç¨‹æ± æ•°é‡</span></div><div class="line">   result.put(<span class="string">"org.quartz.scheduler.instanceName"</span>, <span class="string">"ELASTIC_JOB_CLOUD_TRANSIENT_PRODUCER"</span>);</div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.class"</span>, ShutdownHookPlugin.class.getName());</div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.cleanShutdown"</span>, Boolean.TRUE.toString());</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="3-2-2-æ³¨å†Œç¬æ—¶ä½œä¸š"><a href="#3-2-2-æ³¨å†Œç¬æ—¶ä½œä¸š" class="headerlink" title="3.2.2 æ³¨å†Œç¬æ—¶ä½œä¸š"></a>3.2.2 æ³¨å†Œç¬æ—¶ä½œä¸š</h3><p>è°ƒç”¨ <code>TransientProducerScheduler#register(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œç¬æ—¶ä½œä¸šã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransientProducerScheduler.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> TransientProducerRepository repository;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   String cron = jobConfig.getTypeConfig().getCoreConfig().getCron();</div><div class="line">   <span class="comment">// æ·»åŠ  cron ä½œä¸šé›†åˆ</span></div><div class="line">   JobKey jobKey = buildJobKey(cron);</div><div class="line">   repository.put(jobKey, jobConfig.getJobName());</div><div class="line">   <span class="comment">// è°ƒåº¦ ä½œä¸š</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">if</span> (!scheduler.checkExists(jobKey)) &#123;</div><div class="line">           scheduler.scheduleJob(buildJobDetail(jobKey), buildTrigger(jobKey.getName()));</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#buildJobKey(...)</code> æ–¹æ³•ï¼Œåˆ›å»º Quartz JobKeyã€‚ä½ ä¼šå‘ç°å¾ˆæœ‰æ„æ€çš„ä½¿ç”¨çš„æ˜¯ <code>cron</code> å‚æ•°ä½œä¸ºä¸»é”®ã€‚Whyï¼Ÿåœ¨çœ‹ä¸‹ <code>!scheduler.checkExists(jobKey)</code> å¤„ï¼Œç›¸åŒ JobKey( <code>cron</code> ) çš„ä½œä¸šä¸é‡å¤æ³¨å†Œåˆ° Quartz Schedulerã€‚Whyï¼Ÿæ­¤å¤„æ˜¯ä¸€ä¸ªä¼˜åŒ–ï¼Œç›¸åŒ <code>cron</code> ä½¿ç”¨åŒä¸€ä¸ª Quartz Jobï¼ŒElastic-Job-Cloud-Scheduler å¯èƒ½ä¼šæ³¨å†Œå¤§é‡çš„ç¬æ—¶ä½œä¸šï¼Œå¦‚æœä¸€ä¸ªç¬æ—¶ä½œä¸šåˆ›å»ºä¸€ä¸ª Quartz Job å¤ªè¿‡æµªè´¹ï¼Œç‰¹åˆ«æ˜¯ <code>cron</code> æ¯åˆ†é’Ÿã€æ¯5åˆ†é’Ÿã€æ¯å°æ—¶ã€æ¯å¤©å·²ç»è¦†ç›–äº†å¤§é‡çš„ç¬æ—¶ä½œä¸šçš„æƒ…å†µã€‚å› æ­¤ï¼Œç›¸åŒ <code>cron</code> ä½¿ç”¨åŒä¸€ä¸ª Quartz Jobã€‚</li><li><p>è°ƒç”¨ <code>TransientProducerRepository#put(...)</code> ä»¥ Quartz JobKey ä¸ºä¸»é”®èšåˆä½œä¸šã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TransientProducerRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * cron ä½œä¸šé›†åˆ</span></div><div class="line"><span class="comment">     * keyï¼šä½œä¸šKey</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;JobKey, List&lt;String&gt;&gt; cronTasks = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>, <span class="number">1</span>);</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">final</span> JobKey jobKey, <span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">        remove(jobName);</div><div class="line">        List&lt;String&gt; taskList = cronTasks.get(jobKey);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == taskList) &#123;</div><div class="line">            taskList = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</div><div class="line">            taskList.add(jobName);</div><div class="line">            cronTasks.put(jobKey, taskList);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!taskList.contains(jobName)) &#123;</div><div class="line">            taskList.add(jobName);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>#buildJobDetail(...)</code> åˆ›å»º Quartz Job ä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> JobDetail <span class="title">buildJobDetail</span><span class="params">(<span class="keyword">final</span> JobKey jobKey)</span> </span>&#123;</div><div class="line">    JobDetail result = JobBuilder.newJob(ProducerJob.class) <span class="comment">// ProducerJob.java</span></div><div class="line">            .withIdentity(jobKey).build();</div><div class="line">    result.getJobDataMap().put(<span class="string">"repository"</span>, repository);</div><div class="line">    result.getJobDataMap().put(<span class="string">"readyService"</span>, readyService);</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>JobBuilder#newJob(...)</code> çš„å‚æ•°æ˜¯ ProducerJobï¼Œä¸‹æ–‡ä¼šè®²è§£åˆ°ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>#buildTrigger(...)</code> åˆ›å»º Quartz Triggerã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Trigger <span class="title">buildTrigger</span><span class="params">(<span class="keyword">final</span> String cron)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> TriggerBuilder.newTrigger()</div><div class="line">           .withIdentity(cron)</div><div class="line">           .withSchedule(CronScheduleBuilder.cronSchedule(cron) <span class="comment">// cron</span></div><div class="line">           .withMisfireHandlingInstructionDoNothing())</div><div class="line">           .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><h3 id="3-2-3-ProducerJob"><a href="#3-2-3-ProducerJob" class="headerlink" title="3.2.3 ProducerJob"></a>3.2.3 ProducerJob</h3><p>ProducerJobï¼Œå½“ Quartz Job åˆ°è¾¾ <code>cron</code> æ‰§è¡Œæ—¶é—´( å³ä½œä¸šæ‰§è¡Œæ—¶é—´)ï¼Œå°†ç›¸åº”çš„ç¬æ—¶ä½œä¸šæ·»åŠ åˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerJob</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</div><div class="line">        </div><div class="line">   <span class="keyword">private</span> TransientProducerRepository repository;</div><div class="line">   </div><div class="line">   <span class="keyword">private</span> ReadyService readyService;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</div><div class="line">       List&lt;String&gt; jobNames = repository.get(context.getJobDetail().getKey());</div><div class="line">       <span class="keyword">for</span> (String each : jobNames) &#123;</div><div class="line">           readyService.addTransient(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>TransientProducerRepository#get(...)</code> æ–¹æ³•ï¼Œè·å¾—è¯¥ Job å¯¹åº”çš„ä½œä¸šé›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TransientProducerRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * cron ä½œä¸šé›†åˆ</span></div><div class="line"><span class="comment">     * keyï¼šä½œä¸šKey</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;JobKey, List&lt;String&gt;&gt; cronTasks = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>, <span class="number">1</span>);</div><div class="line">    </div><div class="line">    <span class="function">List&lt;String&gt; <span class="title">get</span><span class="params">(<span class="keyword">final</span> JobKey jobKey)</span> </span>&#123;</div><div class="line">        List&lt;String&gt; result = cronTasks.get(jobKey);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span> == result ? Collections.&lt;String&gt;emptyList() : result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>ReadyService#addTransient(...)</code> æ–¹æ³•ï¼Œæ·»åŠ ç¬æ—¶ä½œä¸šåˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å°†ç¬æ—¶ä½œä¸šæ”¾å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobName ä½œä¸šåç§°</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addTransient</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   <span class="comment">//</span></div><div class="line">   <span class="keyword">if</span> (regCenter.getNumChildren(ReadyNode.ROOT) &gt; env.getFrameworkConfiguration().getJobStateQueueSize()) &#123;</div><div class="line">       log.warn(<span class="string">"Cannot add transient job, caused by read state queue size is larger than &#123;&#125;."</span>, env.getFrameworkConfiguration().getJobStateQueueSize());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">//</span></div><div class="line">   Optional&lt;CloudJobConfiguration&gt; cloudJobConfig = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (!cloudJobConfig.isPresent() || CloudJobExecutionType.TRANSIENT != cloudJobConfig.get().getJobExecutionType()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// </span></div><div class="line">   String readyJobNode = ReadyNode.getReadyJobNodePath(jobName);</div><div class="line">   String times = regCenter.getDirectly(readyJobNode);</div><div class="line">   <span class="keyword">if</span> (cloudJobConfig.get().getTypeConfig().getCoreConfig().isMisfire()) &#123;</div><div class="line">       regCenter.persist(readyJobNode, Integer.toString(<span class="keyword">null</span> == times ? <span class="number">1</span> : Integer.parseInt(times) + <span class="number">1</span>));</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       regCenter.persist(ReadyNode.getReadyJobNodePath(jobName), <span class="string">"1"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>æ·»åŠ ç¬æ—¶ä½œä¸šåˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong> å’Œ <strong>æ·»åŠ å¸¸é©»ä½œä¸šåˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong>åŸºæœ¬æ˜¯ä¸€è‡´çš„ã€‚</li><li>å½“ä½œä¸šé…ç½®å…è®¸ <code>misfire</code>ï¼Œåˆ™ä¸æ–­ç´¯ç§¯ä½œä¸šå¯æ‰§è¡Œæ¬¡æ•°ã€‚</li></ul></li></ul><h2 id="3-3-å°ç»“"><a href="#3-3-å°ç»“" class="headerlink" title="3.3 å°ç»“"></a>3.3 å°ç»“</h2><p>æ— è®ºæ˜¯å¸¸é©»ä½œä¸šè¿˜æ˜¯ç¬æ—¶ä½œä¸šï¼Œéƒ½ä¼šåŠ å…¥åˆ°<strong>å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong>ã€‚ç›®å‰æˆ‘ä»¬çœ‹åˆ°ç¬æ—¶ä½œä¸šçš„æ¯æ¬¡è°ƒåº¦æ˜¯ TransientProducerScheduler è´Ÿè´£ã€‚é‚£ä¹ˆå¸¸é©»ä½œä¸šçš„æ¯æ¬¡è°ƒåº¦å‘¢ï¼Ÿã€Œ5. TaskExecutor æ‰§è¡Œä»»åŠ¡ã€ä¼šçœ‹åˆ°å®ƒçš„è°ƒåº¦ï¼Œè¿™æ˜¯ Elastic-Job-Cloud è®¾è®¡å·§å¦™æœ‰è¶£çš„åœ°æ–¹ã€‚</p><h1 id="4-TaskLaunchScheduledService-æäº¤ä»»åŠ¡"><a href="#4-TaskLaunchScheduledService-æäº¤ä»»åŠ¡" class="headerlink" title="4. TaskLaunchScheduledService æäº¤ä»»åŠ¡"></a>4. TaskLaunchScheduledService æäº¤ä»»åŠ¡</h1><p>TaskLaunchScheduledServiceï¼Œä»»åŠ¡æäº¤è°ƒåº¦æœåŠ¡ã€‚å®ƒç»§æ‰¿ Guava AbstractScheduledService å®ç°å®šæ—¶å°†å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—çš„ä½œä¸šæäº¤åˆ° Mesos è¿›è¡Œè°ƒåº¦æ‰§è¡Œã€‚å®ç°<strong>å®šæ—¶</strong>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskLaunchScheduledService</span> <span class="keyword">extends</span> <span class="title">AbstractScheduledService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">serviceName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"task-launch-processor"</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Scheduler <span class="title">scheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Scheduler.newFixedDelaySchedule(<span class="number">2</span>, <span class="number">10</span>, TimeUnit.SECONDS);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">runOneIteration</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥éƒ¨åˆ†æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>æ¯ 10 ç§’æ‰§è¡Œæäº¤ä»»åŠ¡( <code>#runOneIteration()</code> )ã€‚å¯¹ Guava AbstractScheduledService ä¸äº†è§£çš„åŒå­¦ï¼Œå¯ä»¥é˜…è¯»å®Œæœ¬æ–‡å Google ä¸‹ã€‚å› ä¸ºæ˜¯é€šè¿‡æ¯ 10 ç§’è½®è¯¢çš„æ–¹å¼æäº¤ä»»åŠ¡ï¼Œæ‰€ä»¥<strong>ç¬æ—¶ä½œä¸š</strong>çš„æ‰§è¡Œæ—¶é—´ä¸æ˜¯éå¸¸ä¸¥æ ¼ï¼Œå­˜åœ¨ç•¥æœ‰å»¶è¿Ÿï¼Œè¿™ä¸ªå®é™…åœ¨ä½¿ç”¨éœ€è¦æ³¨æ„çš„ã€‚é‚£<strong>å¸¸é©»ä½œä¸š</strong>å‘¢ï¼Œçœ‹å®Œæœ¬æ–‡ï¼Œä½ å°±ä¼šçŸ¥é“ç­”æ¡ˆã€‚</li></ul><p><code>#runOneIteration()</code> æ–¹æ³•ç›¸å¯¹æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬ä¸€å—ä¸€å—æ‹†è§£ï¼Œ<strong>è€å¿ƒ</strong>ç†è§£ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">runOneIteration</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       System.out.println(<span class="string">"runOneIteration:"</span> + <span class="keyword">new</span> Date());</div><div class="line">       <span class="comment">// åˆ›å»º Fenzo ä»»åŠ¡è¯·æ±‚</span></div><div class="line">       LaunchingTasks launchingTasks = <span class="keyword">new</span> LaunchingTasks(facadeService.getEligibleJobContext());</div><div class="line">       List&lt;TaskRequest&gt; taskRequests = launchingTasks.getPendingTasks();</div><div class="line">       <span class="comment">// è·å–æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„äº‘ä½œä¸šApp https://github.com/Netflix/Fenzo/wiki/Constraints</span></div><div class="line">       <span class="keyword">if</span> (!taskRequests.isEmpty()) &#123;</div><div class="line">           AppConstraintEvaluator.getInstance().loadAppRunningState();</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ° Mesos Offer</span></div><div class="line">       Collection&lt;VMAssignmentResult&gt; vmAssignmentResults = taskScheduler.scheduleOnce(taskRequests, LeasesQueue.getInstance().drainTo()).getResultMap().values();</div><div class="line">       <span class="comment">// åˆ›å»º Mesos ä»»åŠ¡è¯·æ±‚</span></div><div class="line">       List&lt;TaskContext&gt; taskContextsList = <span class="keyword">new</span> LinkedList&lt;&gt;(); <span class="comment">// ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line">       Map&lt;List&lt;Protos.OfferID&gt;, List&lt;Protos.TaskInfo&gt;&gt; offerIdTaskInfoMap = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">// Mesos ä»»åŠ¡ä¿¡æ¯é›†åˆ</span></div><div class="line">       <span class="keyword">for</span> (VMAssignmentResult each: vmAssignmentResults) &#123;</div><div class="line">           List&lt;VirtualMachineLease&gt; leasesUsed = each.getLeasesUsed();</div><div class="line">           List&lt;Protos.TaskInfo&gt; taskInfoList = <span class="keyword">new</span> ArrayList&lt;&gt;(each.getTasksAssigned().size() * <span class="number">10</span>);</div><div class="line">           taskInfoList.addAll(getTaskInfoList(</div><div class="line">                   launchingTasks.getIntegrityViolationJobs(vmAssignmentResults), <span class="comment">// è·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</span></div><div class="line">                   each, leasesUsed.get(<span class="number">0</span>).hostname(), leasesUsed.get(<span class="number">0</span>).getOffer()));</div><div class="line">           <span class="keyword">for</span> (Protos.TaskInfo taskInfo : taskInfoList) &#123;</div><div class="line">               taskContextsList.add(TaskContext.from(taskInfo.getTaskId().getValue()));</div><div class="line">           &#125;</div><div class="line">           offerIdTaskInfoMap.put(getOfferIDs(leasesUsed), <span class="comment">// è·å¾— Offer ID é›†åˆ</span></div><div class="line">                   taskInfoList);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// éå†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line">       <span class="keyword">for</span> (TaskContext each : taskContextsList) &#123;</div><div class="line">           <span class="comment">// å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—</span></div><div class="line">           facadeService.addRunning(each);</div><div class="line">           <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_STAGING)</span></div><div class="line">           jobEventBus.post(createJobStatusTraceEvent(each));</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š</span></div><div class="line">       facadeService.removeLaunchTasksFromQueue(taskContextsList);</div><div class="line">       <span class="comment">// æäº¤ä»»åŠ¡ç»™ Mesos</span></div><div class="line">       <span class="keyword">for</span> (Entry&lt;List&lt;OfferID&gt;, List&lt;TaskInfo&gt;&gt; each : offerIdTaskInfoMap.entrySet()) &#123;</div><div class="line">           schedulerDriver.launchTasks(each.getKey(), each.getValue());</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</div><div class="line">       log.error(<span class="string">"Launch task error"</span>, throwable);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="comment">// æ¸…ç† AppConstraintEvaluator æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„äº‘ä½œä¸šApp</span></div><div class="line">       AppConstraintEvaluator.getInstance().clearAppRunningState();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="4-1-åˆ›å»º-Fenzo-ä»»åŠ¡è¯·æ±‚"><a href="#4-1-åˆ›å»º-Fenzo-ä»»åŠ¡è¯·æ±‚" class="headerlink" title="4.1 åˆ›å»º Fenzo ä»»åŠ¡è¯·æ±‚"></a>4.1 åˆ›å»º Fenzo ä»»åŠ¡è¯·æ±‚</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line">LaunchingTasks launchingTasks = <span class="keyword">new</span> LaunchingTasks(facadeService.getEligibleJobContext());</div><div class="line">List&lt;TaskRequest&gt; taskRequests = launchingTasks.getPendingTasks();</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>FacadeService#getEligibleJobContext()</code> æ–¹æ³•ï¼Œè·å–æœ‰èµ„æ ¼è¿è¡Œçš„ä½œä¸šã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å–æœ‰èµ„æ ¼è¿è¡Œçš„ä½œä¸š.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> ä½œä¸šä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;JobContext&gt; <span class="title">getEligibleJobContext</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ä»å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡</span></div><div class="line">   Collection&lt;JobContext&gt; failoverJobContexts = failoverService.getAllEligibleJobContexts();</div><div class="line">   <span class="comment">// ä»å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡</span></div><div class="line">   Collection&lt;JobContext&gt; readyJobContexts = readyService.getAllEligibleJobContexts(failoverJobContexts);</div><div class="line">   <span class="comment">// åˆå¹¶</span></div><div class="line">   Collection&lt;JobContext&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(failoverJobContexts.size() + readyJobContexts.size());</div><div class="line">   result.addAll(failoverJobContexts);</div><div class="line">   result.addAll(readyJobContexts);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>FailoverService#getAllEligibleJobContexts()</code> æ–¹æ³•ï¼Œä»<strong>å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</strong>ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡ã€‚<strong>TaskLaunchScheduledService æäº¤çš„ä»»åŠ¡è¿˜å¯èƒ½æ¥è‡ªå¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</strong>ã€‚æœ¬æ–‡æš‚æ—¶ä¸è§£æå¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ç›¸å…³å®ç°ï¼Œé¿å…å¢åŠ å¤æ‚åº¦å½±å“å¤§å®¶çš„ç†è§£ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-failover/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>è¯¦ç»†è§£æã€‚</li><li><p>è°ƒç”¨ <code>ReadyService#getAllEligibleJobContexts(...)</code> æ–¹æ³•ï¼Œä»<strong>å¾…æ‰§è¡Œé˜Ÿåˆ—</strong>ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ReadyService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä»å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> ineligibleJobContexts æ— èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;JobContext&gt; <span class="title">getAllEligibleJobContexts</span><span class="params">(<span class="keyword">final</span> Collection&lt;JobContext&gt; ineligibleJobContexts)</span> </span>&#123;</div><div class="line">   <span class="comment">// ä¸å­˜åœ¨ å¾…æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(ReadyNode.ROOT)) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ— èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡ è½¬æ¢æˆ æ— èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šé›†åˆ</span></div><div class="line">   Collection&lt;String&gt; ineligibleJobNames = Collections2.transform(ineligibleJobContexts, <span class="keyword">new</span> Function&lt;JobContext, String&gt;() &#123;</div><div class="line">       </div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(<span class="keyword">final</span> JobContext input)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> input.getJobConfig().getJobName();</div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line">   <span class="comment">// è·å– å¾…æ‰§è¡Œé˜Ÿåˆ— æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡</span></div><div class="line">   List&lt;String&gt; jobNames = regCenter.getChildrenKeys(ReadyNode.ROOT);</div><div class="line">   List&lt;JobContext&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(jobNames.size());</div><div class="line">   <span class="keyword">for</span> (String each : jobNames) &#123;</div><div class="line">       <span class="keyword">if</span> (ineligibleJobNames.contains(each)) &#123;</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// æ’é™¤ ä½œä¸šé…ç½® ä¸å­˜åœ¨çš„ä½œä¸š</span></div><div class="line">       Optional&lt;CloudJobConfiguration&gt; jobConfig = configService.load(each);</div><div class="line">       <span class="keyword">if</span> (!jobConfig.isPresent()) &#123;</div><div class="line">           regCenter.remove(ReadyNode.getReadyJobNodePath(each));</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!runningService.isJobRunning(each)) &#123; <span class="comment">// æ’é™¤ è¿è¡Œä¸­ çš„ä½œä¸š</span></div><div class="line">           result.add(JobContext.from(jobConfig.get(), ExecutionType.READY));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li></li></ul></li><li><p>JobContextï¼Œä½œä¸šè¿è¡Œä¸Šä¸‹æ–‡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobContext.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobContext</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CloudJobConfiguration jobConfig;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Integer&gt; assignedShardingItems;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutionType type;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é€šè¿‡ä½œä¸šé…ç½®åˆ›å»ºä½œä¸šè¿è¡Œä¸Šä¸‹æ–‡.</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> type æ‰§è¡Œç±»å‹</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> ä½œä¸šè¿è¡Œä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobContext <span class="title">from</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig, <span class="keyword">final</span> ExecutionType type)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> shardingTotalCount = jobConfig.getTypeConfig().getCoreConfig().getShardingTotalCount();</div><div class="line">        <span class="comment">// åˆ†ç‰‡é¡¹</span></div><div class="line">        List&lt;Integer&gt; shardingItems = <span class="keyword">new</span> ArrayList&lt;&gt;(shardingTotalCount);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shardingTotalCount; i++) &#123;</div><div class="line">            shardingItems.add(i);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JobContext(jobConfig, shardingItems, type);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul></li></ul><ul><li><p>LaunchingTasksï¼Œåˆ†é…ä»»åŠ¡è¡Œä¸ºåŒ…ã€‚åˆ›å»º LaunchingTasks ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LaunchingTasks</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line"><span class="comment">     * keyï¼šä½œä¸šå</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, JobContext&gt; eligibleJobContextsMap;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LaunchingTasks</span><span class="params">(<span class="keyword">final</span> Collection&lt;JobContext&gt; eligibleJobContexts)</span> </span>&#123;</div><div class="line">        eligibleJobContextsMap = <span class="keyword">new</span> HashMap&lt;&gt;(eligibleJobContexts.size(), <span class="number">1</span>);</div><div class="line">        <span class="keyword">for</span> (JobContext each : eligibleJobContexts) &#123;</div><div class="line">            eligibleJobContextsMap.put(each.getJobConfig().getJobName(), each);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>LaunchingTasks#getPendingTasks()</code> æ–¹æ³•ï¼Œè·å¾—å¾…æ‰§è¡Œä»»åŠ¡é›†åˆã€‚<strong>è¿™é‡Œè¦æ³¨æ„ï¼Œæ¯ä¸ªä½œä¸šå¦‚æœæœ‰å¤šä¸ªåˆ†ç‰‡ï¼Œåˆ™ä¼šç”Ÿæˆå¤šä¸ªå¾…æ‰§è¡Œä»»åŠ¡ï¼Œå³æ­¤å¤„å®Œæˆäº†ä½œä¸šåˆ†ç‰‡</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LaunchingTasks.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å¾—å¾…æ‰§è¡Œä»»åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> å¾…æ‰§è¡Œä»»åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function">List&lt;TaskRequest&gt; <span class="title">getPendingTasks</span><span class="params">()</span> </span>&#123;</div><div class="line">   List&lt;TaskRequest&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(eligibleJobContextsMap.size() * <span class="number">10</span>);</div><div class="line">   <span class="keyword">for</span> (JobContext each : eligibleJobContextsMap.values()) &#123;</div><div class="line">       result.addAll(createTaskRequests(each));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºå¾…æ‰§è¡Œä»»åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobContext ä½œä¸šè¿è¡Œä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> å¾…æ‰§è¡Œä»»åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;TaskRequest&gt; <span class="title">createTaskRequests</span><span class="params">(<span class="keyword">final</span> JobContext jobContext)</span> </span>&#123;</div><div class="line">   Collection&lt;TaskRequest&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(jobContext.getAssignedShardingItems().size());</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : jobContext.getAssignedShardingItems()) &#123;</div><div class="line">       result.add(<span class="keyword">new</span> JobTaskRequest(<span class="keyword">new</span> TaskContext(jobContext.getJobConfig().getJobName(), Collections.singletonList(each), jobContext.getType()), jobContext.getJobConfig()));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// TaskContext.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskContext</span> </span>&#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * ä»»åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> String id;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * ä»»åŠ¡å…ƒä¿¡æ¯</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> MetaInfo metaInfo;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * æ‰§è¡Œç±»å‹</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> ExecutionType type;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Mesos Slave ç¼–å·</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> String slaveId;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * æ˜¯å¦é—²ç½®</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">boolean</span> idle;</div><div class="line">   </div><div class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MetaInfo</span> </span>&#123;</div><div class="line"></div><div class="line">       <span class="comment">/**</span></div><div class="line"><span class="comment">        * ä½œä¸šå</span></div><div class="line"><span class="comment">        */</span></div><div class="line">       <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">       <span class="comment">/**</span></div><div class="line"><span class="comment">        * ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line"><span class="comment">        */</span></div><div class="line">       <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Integer&gt; shardingItems;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="comment">// ... çœç•¥éƒ¨åˆ†æ–¹æ³•</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobTaskRequest.JAVA</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobTaskRequest</span> <span class="keyword">implements</span> <span class="title">TaskRequest</span> </span>&#123;</div><div class="line">    </div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> TaskContext taskContext;</div><div class="line">       </div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> CloudJobConfiguration jobConfig;</div><div class="line">       </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> taskContext.getId();</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getCPUs</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> jobConfig.getCpuCount();</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getMemory</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> jobConfig.getMemoryMB();</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="comment">// ... çœç•¥éƒ¨åˆ†æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#createTaskRequests(...)</code> æ–¹æ³•ï¼Œ<strong>å°†å•ä¸ªä½œä¸šæŒ‰ç…§å…¶ä½œä¸šåˆ†ç‰‡æ€»æ•°æ‹†åˆ†æˆä¸€ä¸ªæˆ–å¤šä¸ªå¾…æ‰§è¡Œä»»åŠ¡é›†åˆ</strong>ã€‚</li><li>TaskContextï¼Œä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡ã€‚</li><li>JobTaskRequestï¼Œä½œä¸šä»»åŠ¡è¯·æ±‚å¯¹è±¡ã€‚</li></ul></li><li>å› ä¸ºå¯¹è±¡æœ‰ç‚¹å¤šï¼Œæˆ‘ä»¬æ¥è´´ä¸€ä¸ª <code>LaunchingTasks#getPendingTasks()</code> æ–¹æ³•çš„è¿”å›ç»“æœã€‚<br><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/03.png" alt=""></li></ul><p><strong>å‹æƒ…æç¤ºï¼Œä»£ç å¯èƒ½æ¯”è¾ƒå¤šï¼Œè¯·è€å¿ƒè§‚çœ‹ã€‚</strong></p><h2 id="4-2-AppConstraintEvaluator"><a href="#4-2-AppConstraintEvaluator" class="headerlink" title="4.2 AppConstraintEvaluator"></a>4.2 AppConstraintEvaluator</h2><p>åœ¨è¯´ AppConstraintEvaluator ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä¸€èµ·äº†<strong>ç®€å•</strong>è§£ä¸‹ <a href="https://github.com/Netflix/Fenzo/wiki" rel="external nofollow noopener noreferrer" target="_blank">Netflix Fenzo</a>ã€‚</p><blockquote><p>FROM <a href="http://dockone.io/article/636" rel="external nofollow noopener noreferrer" target="_blank">http://dockone.io/article/636</a><br>Fenzoæ˜¯ä¸€ä¸ªåœ¨Mesosæ¡†æ¶ä¸Šåº”ç”¨çš„é€šç”¨ä»»åŠ¡è°ƒåº¦å™¨ã€‚å®ƒå¯ä»¥è®©ä½ é€šè¿‡å®ç°å„ç§ä¼˜åŒ–ç­–ç•¥çš„æ’ä»¶ï¼Œæ¥ä¼˜åŒ–ä»»åŠ¡è°ƒåº¦ï¼ŒåŒæ—¶è¿™ä¹Ÿæœ‰åˆ©äºé›†ç¾¤çš„è‡ªåŠ¨ç¼©æ”¾ã€‚</p></blockquote><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/05.png" alt=""></p><p>Elastic-Job-Cloud-Scheduler åŸºäº Fenzo å®ç°å¯¹ Mesos çš„å¼¹æ€§èµ„æºåˆ†é…ã€‚</p><p>ä¾‹å¦‚ï¼ŒAppConstraintEvaluatorï¼ŒApp ç›®æ ‡ Mesos Slave é€‚é…åº¦é™åˆ¶å™¨ï¼Œé€‰æ‹© Slave æ—¶éœ€è¦è€ƒè™‘å…¶ä¸Šæ˜¯å¦è¿è¡Œæœ‰ App çš„ Executorï¼Œå¦‚æœæ²¡æœ‰è¿è¡Œ Executor éœ€è¦å°†å…¶èµ„æºæ¶ˆè€—è€ƒè™‘è¿›é€‚é…è®¡ç®—ç®—æ³•ä¸­ã€‚å®ƒæ˜¯ <a href="https://github.com/Netflix/Fenzo/blob/5de0e0861def4a655be35a9624e67318a6c0afac/fenzo-core/src/main/java/com/netflix/fenzo/ConstraintEvaluator.java" rel="external nofollow noopener noreferrer" target="_blank">Fenzo ConstraintEvaluator æ¥å£</a> åœ¨ Elastic-Job-Cloud-Scheduler çš„è‡ªå®šä¹‰ä»»åŠ¡çº¦æŸå®ç°ã€‚é€šè¿‡è¿™ä¸ªä»»åŠ¡çº¦æŸï¼Œåœ¨ä¸‹æ–‡è°ƒç”¨ <code>TaskScheduler#scheduleOnce(...)</code> æ–¹æ³•è°ƒåº¦ä»»åŠ¡æ‰€éœ€èµ„æºæ—¶ï¼Œä¼šå°† AppConstraintEvaluator è€ƒè™‘è¿›å»ã€‚</p><p>é‚£ä¹ˆä½œä¸šä»»åŠ¡è¯·æ±‚( JobTaskRequest ) æ˜¯æ€ä¹ˆå…³è”ä¸Š AppConstraintEvaluator çš„å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobTaskRequest.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobTaskRequest</span> <span class="keyword">implements</span> <span class="title">TaskRequest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> List&lt;? extends ConstraintEvaluator&gt; getHardConstraints() &#123;</div><div class="line">        <span class="keyword">return</span> Collections.singletonList(AppConstraintEvaluator.getInstance());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><a href="https://github.com/Netflix/Fenzo/blob/20d71b5c3213063fc938cd2841dc7569601d1d99/fenzo-core/src/main/java/com/netflix/fenzo/TaskRequest.java" rel="external nofollow noopener noreferrer" target="_blank">Fenzo TaskRequest æ¥å£</a> æ˜¯ Fenzo çš„ä»»åŠ¡è¯·æ±‚æ¥å£ï¼Œé€šè¿‡å®ç° <code>#getHardConstraints()</code> æ–¹æ³•ï¼Œå…³è”ä¸Š TaskRequest å’Œ ConstraintEvaluatorã€‚</li></ul><p>å…³è”ä¸Šä¹‹åï¼Œä»»åŠ¡åŒ¹é… Mesos Slave èµ„æºæ—¶ï¼Œè°ƒç”¨ <code>ConstraintEvaluator#evaluate(...)</code> å®ç°æ–¹æ³•åˆ¤æ–­æ˜¯å¦ç¬¦åˆçº¦æŸï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConstraintEvaluator</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Result</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isSuccessful;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String failureReason;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Inspects a target to decide whether or not it meets the constraints appropriate to a particular task.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> taskRequest a description of the task to be assigned</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> targetVM a description of the host that is a potential match for the task</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> taskTrackerState the current status of tasks and task assignments in the system at large</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> a successful Result if the target meets the constraints enforced by this constraint evaluator, or</span></div><div class="line"><span class="comment">     *         an unsuccessful Result otherwise</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">evaluate</span><span class="params">(TaskRequest taskRequest, VirtualMachineCurrentState targetVM,</span></span></div><div class="line"><span class="function"><span class="params">                           TaskTrackerState taskTrackerState)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>OKï¼Œç®€å•äº†è§£ç»“æŸï¼Œæœ‰å…´è¶£äº†è§£æ›´å¤šçš„åŒå­¦ï¼Œè¯·ç‚¹å‡»<a href="https://github.com/Netflix/Fenzo/wiki/Constraints" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Constraintsã€‹</a>ã€‚ä¸‹é¢æ¥çœ‹çœ‹ Elastic-Job-Cloud-Scheduler è‡ªå®šä¹‰å®ç°çš„ä»»åŠ¡çº¦æŸ AppConstraintEvaluatorã€‚</p><hr><p>è°ƒç”¨ <code>AppConstraintEvaluator#loadAppRunningState()</code> æ–¹æ³•ï¼ŒåŠ è½½å½“å‰è¿è¡Œä¸­çš„<strong>äº‘ä½œä¸šApp</strong>ï¼Œä¸º <code>AppConstraintEvaluator#evaluate(...)</code> æ–¹æ³•æä¾›è¯¥æ•°æ®ã€‚ä»£ç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AppConstraintEvaluator.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; runningApps = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">loadAppRunningState</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">for</span> (MesosStateService.ExecutorStateInfo each : facadeService.loadExecutorInfo()) &#123;</div><div class="line">           runningApps.add(each.getId());</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> JSONException | UniformInterfaceException | ClientHandlerException e) &#123;</div><div class="line">       clearAppRunningState();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>FacadeService#loadExecutorInfo()</code> æ–¹æ³•ï¼Œä» Mesos è·å–æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ Mesos æ‰§è¡Œå™¨( Executor )çš„ä¿¡æ¯ã€‚æ‰§è¡Œå™¨å’Œäº‘ä½œä¸šAppæœ‰å•¥å…³ç³»ï¼Ÿ<strong>æ¯ä¸ªäº‘ä½œä¸šApp å³æ˜¯ä¸€ä¸ª Elastic-Job-Cloud-Executor å®ä¾‹ã€‚</strong>ã€‚<code>FacadeService#loadExecutorInfo()</code> æ–¹æ³•è¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦è‡ªå·±çœ‹ä¸‹ï¼Œä¸»è¦æ˜¯å¯¹ Mesos çš„ APIæ“ä½œï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ <code>runningApps</code> çš„ç»“æœï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/04.png" alt=""></p></li></ul><hr><p>è°ƒç”¨ <code>TaskScheduler#scheduleOnce(...)</code> æ–¹æ³•è°ƒåº¦æäº¤ä»»åŠ¡æ‰€éœ€èµ„æºæ—¶ï¼Œä¼šè°ƒç”¨ <code>ConstraintEvaluator#loadAppRunningState()</code> æ£€æŸ¥åˆ†é…çš„èµ„æºæ˜¯å¦ç¬¦åˆä»»åŠ¡çš„çº¦æŸæ¡ä»¶ã€‚<code>AppConstraintEvaluator#loadAppRunningState()</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AppConstraintEvaluator.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">evaluate</span><span class="params">(<span class="keyword">final</span> TaskRequest taskRequest, <span class="keyword">final</span> VirtualMachineCurrentState targetVM, <span class="keyword">final</span> TaskTrackerState taskTrackerState)</span> </span>&#123;</div><div class="line">   <span class="keyword">double</span> assigningCpus = <span class="number">0.0</span>d;</div><div class="line">   <span class="keyword">double</span> assigningMemoryMB = <span class="number">0.0</span>d;</div><div class="line">   <span class="keyword">final</span> String slaveId = targetVM.getAllCurrentOffers().iterator().next().getSlaveId().getValue();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// åˆ¤æ–­å½“å‰åˆ†é…çš„ Mesos Slave æ˜¯å¦è¿è¡Œç€è¯¥ä½œä¸šä»»åŠ¡è¯·æ±‚å¯¹åº”çš„äº‘ä½œä¸šApp</span></div><div class="line">       <span class="keyword">if</span> (isAppRunningOnSlave(taskRequest.getId(), slaveId)) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, <span class="string">""</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// åˆ¤æ–­å½“å‰åˆ†é…çš„ Mesos Slave å¯åŠ¨äº‘ä½œä¸šApp æ˜¯å¦è¶…è¿‡èµ„æºé™åˆ¶</span></div><div class="line">       Set&lt;String&gt; calculatedApps = <span class="keyword">new</span> HashSet&lt;&gt;(); <span class="comment">// å·²è®¡ç®—ä½œä¸šAppé›†åˆ</span></div><div class="line">       List&lt;TaskRequest&gt; taskRequests = <span class="keyword">new</span> ArrayList&lt;&gt;(targetVM.getTasksCurrentlyAssigned().size() + <span class="number">1</span>);</div><div class="line">       taskRequests.add(taskRequest);</div><div class="line">       <span class="keyword">for</span> (TaskAssignmentResult each : targetVM.getTasksCurrentlyAssigned()) &#123; <span class="comment">// å½“å‰å·²ç»åˆ†é…ä½œä¸šè¯·æ±‚</span></div><div class="line">           taskRequests.add(each.getRequest());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">for</span> (TaskRequest each : taskRequests) &#123;</div><div class="line">           assigningCpus += each.getCPUs();</div><div class="line">           assigningMemoryMB += each.getMemory();</div><div class="line">           <span class="keyword">if</span> (isAppRunningOnSlave(each.getId(), slaveId)) &#123; <span class="comment">// ä½œä¸šAppå·²ç»å¯åŠ¨</span></div><div class="line">               <span class="keyword">continue</span>;</div><div class="line">           &#125;</div><div class="line">           CloudAppConfiguration assigningAppConfig = getAppConfiguration(each.getId());</div><div class="line">           <span class="keyword">if</span> (!calculatedApps.add(assigningAppConfig.getAppName())) &#123; <span class="comment">// æ˜¯å¦å·²ç»è®¡ç®—è¯¥App</span></div><div class="line">               <span class="keyword">continue</span>;</div><div class="line">           &#125;</div><div class="line">           assigningCpus += assigningAppConfig.getCpuCount();</div><div class="line">           assigningMemoryMB += assigningAppConfig.getMemoryMB();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> LackConfigException ex) &#123;</div><div class="line">       log.warn(<span class="string">"Lack config, disable &#123;&#125;"</span>, getName(), ex);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, <span class="string">""</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (assigningCpus &gt; targetVM.getCurrAvailableResources().cpuCores()) &#123; <span class="comment">// cpu</span></div><div class="line">       log.debug(<span class="string">"Failure &#123;&#125; &#123;&#125; cpus:&#123;&#125;/&#123;&#125;"</span>, taskRequest.getId(), slaveId, assigningCpus, targetVM.getCurrAvailableResources().cpuCores());</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>, String.format(<span class="string">"cpu:%s/%s"</span>, assigningCpus, targetVM.getCurrAvailableResources().cpuCores()));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (assigningMemoryMB &gt; targetVM.getCurrAvailableResources().memoryMB()) &#123; <span class="comment">// memory</span></div><div class="line">       log.debug(<span class="string">"Failure &#123;&#125; &#123;&#125; mem:&#123;&#125;/&#123;&#125;"</span>, taskRequest.getId(), slaveId, assigningMemoryMB, targetVM.getCurrAvailableResources().memoryMB());</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>, String.format(<span class="string">"mem:%s/%s"</span>, assigningMemoryMB, targetVM.getCurrAvailableResources().memoryMB()));</div><div class="line">   &#125;</div><div class="line">   log.debug(<span class="string">"Success &#123;&#125; &#123;&#125; cpus:&#123;&#125;/&#123;&#125; mem:&#123;&#125;/&#123;&#125;"</span>, taskRequest.getId(), slaveId, assigningCpus, targetVM.getCurrAvailableResources()</div><div class="line">           .cpuCores(), assigningMemoryMB, targetVM.getCurrAvailableResources().memoryMB());</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, String.format(<span class="string">"cpus:%s/%s mem:%s/%s"</span>, assigningCpus, targetVM.getCurrAvailableResources()</div><div class="line">           .cpuCores(), assigningMemoryMB, targetVM.getCurrAvailableResources().memoryMB()));</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#isAppRunningOnSlave()</code> æ–¹æ³•ï¼Œåˆ¤æ–­å½“å‰åˆ†é…çš„ Mesos Slave æ˜¯å¦è¿è¡Œç€è¯¥ä½œä¸šä»»åŠ¡è¯·æ±‚å¯¹åº”çš„äº‘ä½œä¸šAppã€‚è‹¥äº‘ä½œä¸šAppæœªè¿è¡Œï¼Œåˆ™è¯¥ä½œä¸šä»»åŠ¡è¯·æ±‚æäº¤ç»™ Mesos åï¼Œè¯¥ Mesos Slave ä¼šå¯åŠ¨è¯¥äº‘ä½œä¸š Appï¼ŒApp æœ¬èº«ä¼šå ç”¨ä¸€å®šçš„ <code>CloudAppConfiguration#cpu</code> å’Œ <code>CloudAppConfiguration#memory</code>ï¼Œè®¡ç®—æ—¶éœ€è¦ç»Ÿè®¡ï¼Œé¿å…è¶…è¿‡å½“å‰ Mesos Slave å‰©ä½™ <code>cpu</code> å’Œ <code>memory</code>ã€‚</li><li>å½“è®¡ç®—ç¬¦åˆçº¦æŸæ—¶ï¼Œè¿”å› <code>Result(true, ...)</code>ï¼›å¦åˆ™ï¼Œè¿”å› <code>Result(false, ...)</code>ã€‚</li><li>TODO å¼‚å¸¸ä¸ºå•¥è¿”å›trueã€‚</li></ul><h2 id="4-3-å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ°-Mesos-Offer"><a href="#4-3-å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ°-Mesos-Offer" class="headerlink" title="4.3 å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ° Mesos Offer"></a>4.3 å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ° Mesos Offer</h2><p>æˆ‘ä»¬å…ˆ<strong>ç®€å•</strong>äº†è§£ä¸‹ Elastic-Job-Cloud-Scheduler å®ç°çš„ Mesos Scheduler ç±» <code>com.dangdang.ddframe.job.cloud.scheduler.mesos.SchedulerEngine</code>ã€‚è°ƒåº¦å™¨çš„ä¸»è¦èŒè´£ä¹‹ä¸€ï¼š<strong>åœ¨æ¥å—åˆ°çš„ Offer ä¸Šå¯åŠ¨ä»»åŠ¡</strong>ã€‚SchedulerEngine æ¥æ”¶åˆ°èµ„æº Offerï¼Œå…ˆå­˜å‚¨åˆ°èµ„æºé¢„å é˜Ÿåˆ—( LeasesQueue )ï¼Œç­‰åˆ°ä½œä¸šè¢«è°ƒåº¦éœ€è¦å¯åŠ¨ä»»åŠ¡æ—¶è¿›è¡Œä½¿ç”¨ã€‚å­˜å‚¨åˆ°èµ„æºé¢„å é˜Ÿåˆ—å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerEngine</span> <span class="keyword">implements</span> <span class="title">Scheduler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">resourceOffers</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver, <span class="keyword">final</span> List&lt;Protos.Offer&gt; offers)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Protos.Offer offer: offers) &#123;</div><div class="line">            log.trace(<span class="string">"Adding offer &#123;&#125; from host &#123;&#125;"</span>, offer.getId(), offer.getHostname());</div><div class="line">            LeasesQueue.getInstance().offer(offer);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>org.apache.mesos.Scheduler</code>ï¼ŒMesos è°ƒåº¦å™¨<strong>æ¥å£</strong>ï¼Œå®ç°è¯¥æ¥å£æˆä¸ºè‡ªå®šä¹‰ Mesos è°ƒåº¦å™¨ã€‚</li><li><p>å®ç° <code>#resourceOffers(...)</code> æ–¹æ³•ï¼Œæœ‰æ–°çš„èµ„æº Offer æ—¶ï¼Œä¼šè¿›è¡Œè°ƒç”¨ã€‚åœ¨ SchedulerEngine ä¼šè°ƒç”¨ <code>#offer(...)</code> æ–¹æ³•ï¼Œå­˜å‚¨ Offer åˆ°èµ„æºé¢„å é˜Ÿåˆ—ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LeasesQueue</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•ä¾‹</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LeasesQueue INSTANCE = <span class="keyword">new</span> LeasesQueue();</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;VirtualMachineLease&gt; queue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·å–å®ä¾‹.</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> å•ä¾‹å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LeasesQueue <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> INSTANCE;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ·»åŠ èµ„æºè‡³é˜Ÿåˆ—é¢„å .</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> offer èµ„æº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offer</span><span class="params">(<span class="keyword">final</span> Protos.Offer offer)</span> </span>&#123;</div><div class="line">        queue.offer(<span class="keyword">new</span> VMLeaseObject(offer));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥ #drainTo() æ–¹æ³•ï¼Œä¸‹æ–‡è§£æã€‚</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>VMLeaseObjectï¼Œ<a href="#">Netflix Fenzo</a> å¯¹ Mesos Offer çš„æŠ½è±¡åŒ…è£…ï¼Œç‚¹å‡»<a href="https://github.com/Netflix/Fenzo/blob/faa8a4dd411fff1792c9d788d1288a11e3635ba7/fenzo-core/src/main/java/com/netflix/fenzo/plugins/VMLeaseObject.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹å®ç°ä»£ç ï¼Œé©¬ä¸Šä¼šçœ‹åˆ°å®ƒçš„ç”¨é€”ã€‚</li></ul></li></ul><p>å¦å¤–ï¼Œå¯èƒ½æœ‰åŒå­¦å¯¹ Mesos Offer ç†è§£æ¯”è¾ƒç”Ÿæ¶©ï¼ŒOffer å®šä¹‰å¦‚ä¸‹ï¼š</p><blockquote><p>FROM <a href="https://segmentfault.com/a/1190000007723430" rel="external nofollow noopener noreferrer" target="_blank">https://segmentfault.com/a/1190000007723430</a><br>Offeræ˜¯Mesosèµ„æºçš„æŠ½è±¡ï¼Œæ¯”å¦‚è¯´æœ‰å¤šå°‘CPUã€å¤šå°‘memoryï¼Œdiscæ˜¯å¤šå°‘ï¼Œéƒ½æ”¾åœ¨Offeré‡Œï¼Œæ‰“åŒ…ç»™ä¸€ä¸ªFrameworkï¼Œç„¶åFrameworkæ¥å†³å®šåˆ°åº•æ€ä¹ˆç”¨è¿™ä¸ªOfferã€‚</p></blockquote><hr><p>OKï¼ŒçŸ¥è¯†é“ºå«å®Œæˆï¼Œå›åˆ°æœ¬å°èŠ‚çš„é‡å¿ƒï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line">Collection&lt;VMAssignmentResult&gt; vmAssignmentResults = taskScheduler.scheduleOnce(taskRequests, LeasesQueue.getInstance().drainTo()).getResultMap().values();</div><div class="line"></div><div class="line"><span class="comment">// LeasesQueue.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LeasesQueue</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;VirtualMachineLease&gt; queue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;VirtualMachineLease&gt; <span class="title">drainTo</span><span class="params">()</span> </span>&#123;</div><div class="line">        List&lt;VirtualMachineLease&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(queue.size());</div><div class="line">        queue.drainTo(result);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>è°ƒç”¨ <code>TaskScheduler#scheduleOnce(...)</code> æ–¹æ³•ï¼Œå°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ° Mesos Offerã€‚é€šè¿‡ Fenzo TaskScheduler å®ç°å¯¹å¤šä¸ªä»»åŠ¡åˆ†é…åˆ°å¤šä¸ª Mesos Offer çš„<strong>åˆç†ä¼˜åŒ–åˆ†é…</strong>ã€‚è¿™æ˜¯ä¸€ä¸ªç›¸å¯¹å¤æ‚çš„é—®é¢˜ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿ</p><blockquote><p>FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P76<br>å°†ä»»åŠ¡åŒ¹é…åˆ° offer ä¸Šï¼Œé¦–æ¬¡é€‚é…é€šå¸¸æ˜¯æœ€å¥½çš„ç®—æ³•ã€‚ä½ å¯èƒ½ä¼šæƒ³ï¼Œå¦‚æœåœ¨æ›´å¤šçš„å·¥ä½œé‡Œå°è¯•è®¡ç®—å‡ºåŒ¹é…è¯¥ offer çš„ä¼˜åŒ–ç»„åˆï¼Œå¯èƒ½æ¯”é¦–æ¬¡é€‚é…æ›´èƒ½é«˜æ•ˆåœ°åˆ©ç”¨ offerã€‚è¿™ç»å¯¹æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯è¦è€ƒè™‘å¦‚ä¸‹è¿™äº›æ–¹é¢ï¼šå¯¹äºå¯åŠ¨æ‰€æœ‰ç­‰å¾…è¿è¡Œçš„ä»»åŠ¡æ¥è¯´ï¼Œé›†ç¾¤é‡Œè¦ä¹ˆæœ‰å……è¶³çš„èµ„æºè¦ä¹ˆæ²¡æœ‰ã€‚å¦‚æœèµ„æºå¾ˆå¤šï¼Œé‚£ä¹ˆé¦–æ¬¡é€‚é…è‚¯å®šä¸€ç›´éƒ½èƒ½ä¿è¯æ¯ä¸ªä»»åŠ¡çš„å¯åŠ¨ã€‚å¦‚æœèµ„æºä¸å¤Ÿï¼Œæ€ä¹ˆéƒ½æ— æ³•å¯åŠ¨æ‰€æœ‰ä»»åŠ¡ã€‚å› æ­¤ï¼Œç¼–å†™ä»£ç é€‰æ‹©æ¥ä¸‹æ¥ä¼šè¿è¡Œå“ªä¸ªä»»åŠ¡æ˜¯å¾ˆè‡ªç„¶çš„ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯æœåŠ¡çš„è´¨é‡ã€‚åªæœ‰å½“èµ„æºåˆšå¤Ÿç”¨æ—¶ï¼Œæ‰éœ€è¦æ›´ä¸ºç²¾ç»†çš„æ‰“åŒ…ç®—æ³•ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™é‡Œçš„é—®é¢˜ â€”â€” é€šå¸¸ç§°ä¸ºèƒŒåŒ…é—®é¢˜( Knapsack problem ) â€”â€” æ˜¯ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„ NP å®Œå…¨é—®é¢˜ã€‚NP å®Œå…¨é—®é¢˜æŒ‡çš„æ˜¯éœ€è¦ç›¸å½“é•¿æ—¶é—´æ‰èƒ½æ‰¾åˆ°æœ€ä¼˜è§£å†³æ–¹æ¡ˆçš„é—®é¢˜ï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•å·²çŸ¥é“æŠ€å·§èƒ½å¤Ÿå¿«é€Ÿè§£å†³è¿™ç±»é—®é¢˜ã€‚</p></blockquote><p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œåªè€ƒè™‘ <code>memory</code> èµ„æºæƒ…å†µä¸‹ï¼Œæœ‰ä¸€å° Slave å†…å­˜ä¸º 8GB ï¼Œç°åœ¨è¦è¿è¡Œä¸‰ä¸ª 1GB çš„ä½œä¸šå’Œ 5GB çš„ä½œä¸šã€‚å…¶ä¸­ 5GB çš„ä½œä¸šåœ¨ 1GB è¿è¡Œå¤šæ¬¡ä¹‹åæ‰æ‰§è¡Œã€‚</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/06.png" alt=""></p><p>å®é™…æƒ…å†µä¼šæ¯”å›¾æ›´åŠ å¤æ‚çš„å¤šçš„å¤šã€‚é€šè¿‡ä½¿ç”¨ Fenzo ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„ï¼Œå¹¶ä¸”ä»¤äººæ»¡æ„çš„åˆ†é…ã€‚ä¸ºäº†è®©ä½ å¯¹ Fenzo æœ‰æ›´åŠ é€å½»çš„ç†è§£ï¼Œè¿™é‡Œå†å¼•ç”¨ä¸€æ®µå¯¹å…¶çš„ä»‹ç»ï¼š</p><blockquote><p>FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P80<br><strong>è°ƒç”¨åº“å‡½æ•° Fenzo</strong><br>Fenzo æ˜¯ Nettflix åœ¨ 2015 å¹´å¤å¤©å‘å¸ƒçš„åº“å‡½æ•°ã€‚Fenzo ä¸ºåŸºäº java çš„è°ƒåº¦å™¨æä¾›äº†å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œå®Œæˆ offer ç¼“å†²ï¼Œå¤šä»»åŠ¡å¯åŠ¨ï¼Œä»¥åŠè½¯å’Œç¡¬çº¦æŸæ¡ä»¶çš„åŒ¹é…ã€‚å°±ç®—ä¸æ˜¯æ‰€æœ‰çš„ï¼Œä¹Ÿæ˜¯å¾ˆå¤šè°ƒåº¦å™¨éƒ½èƒ½å¤Ÿå—ç›Šäºä½¿ç”¨ Fenzo æ¥å®Œæˆè®¡ç®—ä»»åŠ¡åˆ†é…ï¼Œè€Œä¸ç”¨è‡ªå·±ç¼–å†™ offer ç¼“å†²ã€æ‰“åŒ…å’Œæ”¾ç½®è·¯ç”±ç­‰ã€‚</p></blockquote><p>ä¸‹é¢ï¼Œæ¥çœ‹ä¸¤æ¬¡ <code>TaskScheduler#scheduleOnce(...)</code> çš„è¿”å›ï¼š</p><ul><li>ç¬¬ä¸€æ¬¡è°ƒåº¦ï¼š<img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/07.png" alt=""></li><li>ç¬¬äºŒæ¬¡è°ƒåº¦ï¼š<img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/08.png" alt=""></li><li><p><code>com.netflix.fenzo.VMAssignmentResult</code>ï¼Œæ¯å°ä¸»æœºåˆ†é…ä»»åŠ¡ç»“æœã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VMAssignmentResult</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä¸»æœº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String hostname;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½¿ç”¨çš„ Mesos Offer</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;VirtualMachineLease&gt; leasesUsed;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ†é…çš„ä»»åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;TaskAssignmentResult&gt; tasksAssigned;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><p>å—é™äºç¬”è€…çš„èƒ½åŠ›ï¼Œå»ºè®®ä½ å¯ä»¥åœ¨é˜…è¯»å¦‚ä¸‹æ–‡ç« ï¼Œæ›´é€å½»çš„ç†è§£ TaskScheduler ï¼š</p><ul><li><a href="https://github.com/Netflix/Fenzo/wiki/How-to-use-Fenzo" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Constraintsã€‹</a></li><li><a href="https://github.com/Netflix/Fenzo/wiki/Building-Your-Scheduler" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Building Your Schedulerã€‹</a></li><li><a href="https://github.com/Netflix/Fenzo/wiki/Scheduling-Tasks" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Scheduling Tasksã€‹</a></li><li><a href="https://github.com/Netflix/Fenzo/wiki/Insights#how-to-learn-which-tasks-are-assigned-to-which-hosts" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” How to Learn Which Tasks Are Assigned to Which Hostsã€‹</a></li></ul><h2 id="4-4-åˆ›å»º-Mesos-ä»»åŠ¡ä¿¡æ¯"><a href="#4-4-åˆ›å»º-Mesos-ä»»åŠ¡ä¿¡æ¯" class="headerlink" title="4.4 åˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯"></a>4.4 åˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line">List&lt;TaskContext&gt; taskContextsList = <span class="keyword">new</span> LinkedList&lt;&gt;(); <span class="comment">// ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line">Map&lt;List&lt;Protos.OfferID&gt;, List&lt;Protos.TaskInfo&gt;&gt; offerIdTaskInfoMap = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">// Mesos ä»»åŠ¡ä¿¡æ¯é›†åˆ</span></div><div class="line"><span class="keyword">for</span> (VMAssignmentResult each: vmAssignmentResults) &#123;</div><div class="line">    List&lt;VirtualMachineLease&gt; leasesUsed = each.getLeasesUsed();</div><div class="line">    List&lt;Protos.TaskInfo&gt; taskInfoList = <span class="keyword">new</span> ArrayList&lt;&gt;(each.getTasksAssigned().size() * <span class="number">10</span>);</div><div class="line">    taskInfoList.addAll(getTaskInfoList(</div><div class="line">            launchingTasks.getIntegrityViolationJobs(vmAssignmentResults), <span class="comment">// è·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</span></div><div class="line">            each, leasesUsed.get(<span class="number">0</span>).hostname(), leasesUsed.get(<span class="number">0</span>).getOffer()));</div><div class="line">    <span class="keyword">for</span> (Protos.TaskInfo taskInfo : taskInfoList) &#123;</div><div class="line">        taskContextsList.add(TaskContext.from(taskInfo.getTaskId().getValue()));</div><div class="line">    &#125;</div><div class="line">    offerIdTaskInfoMap.put(getOfferIDs(leasesUsed), <span class="comment">// è·å¾— Offer ID é›†åˆ</span></div><div class="line">            taskInfoList);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p><code>offerIdTaskInfoMap</code>ï¼ŒMesos ä»»åŠ¡ä¿¡æ¯é›†åˆã€‚key å’Œ value éƒ½ä¸ºç›¸åŒ Mesos Slave Offer å’Œ ä»»åŠ¡ã€‚ä¸ºä»€ä¹ˆï¼Ÿè°ƒç”¨ <code>SchedulerDriver#launchTasks(...)</code> æ–¹æ³•æäº¤<strong>ä¸€æ¬¡</strong>ä»»åŠ¡æ—¶ï¼Œå¿…é¡»ä¿è¯æ‰€æœ‰ä»»åŠ¡å’Œ Offer åœ¨ç›¸åŒ Mesos Slave ä¸Šã€‚</p><blockquote><p>FROM FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P61<br><strong>ç»„åˆ offer</strong><br>latchTasks æ¥å— offer åˆ—è¡¨ä¸ºè¾“å…¥ï¼Œè¿™å°±å…è®¸ç”¨æˆ·å°†ä¸€äº›ç›¸åŒ slave çš„ offer ç»„åˆèµ·æ¥ï¼Œä»è€Œå°†è¿™äº› offer çš„èµ„æºæ”¾åˆ°æ± é‡Œã€‚å®ƒè¿˜èƒ½æ¥å—ä»»åŠ¡åˆ—è¡¨ä¸ºè¾“å…¥ï¼Œè¿™æ ·å°±èƒ½å¤Ÿå¯åŠ¨é€‚åˆç»™å®š offer çš„è¶³å¤Ÿå¤šçš„ä»»åŠ¡ã€‚æ³¨æ„æ‰€æœ‰ä»»åŠ¡å’Œ offer éƒ½å¿…é¡»æ˜¯åŒä¸€å° slave â€”â€” å¦‚æœä¸åœ¨åŒä¸€å° slave ä¸Šï¼ŒlaunchTasks å°±ä¼šå¤±è´¥ã€‚å¦‚æœæƒ³åœ¨å¤šå° slave ä¸Šå¯åŠ¨ä»»åŠ¡ï¼Œå¤šæ¬¡è°ƒç”¨ latchTasks å³å¯ã€‚</p></blockquote></li><li><p>è°ƒç”¨ <code>LaunchingTasks#getIntegrityViolationJobs(...)</code> æ–¹æ³•ï¼Œè·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆã€‚<strong>ä¸€ä¸ªä½œä¸šæœ‰å¤šä¸ªåˆ†ç‰‡ï¼Œå› ä¸º Mesos Offer ä¸è¶³ï¼Œå¯¼è‡´æœ‰éƒ¨åˆ†åˆ†ç‰‡ä¸èƒ½æ‰§è¡Œï¼Œåˆ™æ•´ä¸ªä½œä¸šéƒ½ä¸è¿›è¡Œæ‰§è¡Œ</strong>ã€‚ä»£ç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LaunchingTasks.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> vmAssignmentResults ä¸»æœºåˆ†é…ä»»åŠ¡ç»“æœé›†åˆ</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function">Collection&lt;String&gt; <span class="title">getIntegrityViolationJobs</span><span class="params">(<span class="keyword">final</span> Collection&lt;VMAssignmentResult&gt; vmAssignmentResults)</span> </span>&#123;</div><div class="line">   Map&lt;String, Integer&gt; assignedJobShardingTotalCountMap = getAssignedJobShardingTotalCountMap(vmAssignmentResults);</div><div class="line">   Collection&lt;String&gt; result = <span class="keyword">new</span> HashSet&lt;&gt;(assignedJobShardingTotalCountMap.size(), <span class="number">1</span>);</div><div class="line">   <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : assignedJobShardingTotalCountMap.entrySet()) &#123;</div><div class="line">       JobContext jobContext = eligibleJobContextsMap.get(entry.getKey());</div><div class="line">       <span class="keyword">if</span> (ExecutionType.FAILOVER != jobContext.getType() <span class="comment">// ä¸åŒ…æ‹¬ FAILOVER æ‰§è¡Œç±»å‹çš„ä½œä¸š</span></div><div class="line">               &amp;&amp; !entry.getValue().equals(jobContext.getJobConfig().getTypeConfig().getCoreConfig().getShardingTotalCount())) &#123;</div><div class="line">           log.warn(<span class="string">"Job &#123;&#125; is not assigned at this time, because resources not enough to run all sharding instances."</span>, entry.getKey());</div><div class="line">           result.add(entry.getKey());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å¾—æ¯ä¸ªä½œä¸šåˆ†ç‰‡æ•°é›†åˆ</span></div><div class="line"><span class="comment">* keyï¼šä½œä¸šå</span></div><div class="line"><span class="comment">* valueï¼šåˆ†ç‰‡æ€»æ•°</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> vmAssignmentResults ä¸»æœºåˆ†é…ä»»åŠ¡ç»“æœé›†åˆ</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ¯ä¸ªä½œä¸šåˆ†ç‰‡æ•°é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, Integer&gt; <span class="title">getAssignedJobShardingTotalCountMap</span><span class="params">(<span class="keyword">final</span> Collection&lt;VMAssignmentResult&gt; vmAssignmentResults)</span> </span>&#123;</div><div class="line">   Map&lt;String, Integer&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;(eligibleJobContextsMap.size(), <span class="number">1</span>);</div><div class="line">   <span class="keyword">for</span> (VMAssignmentResult vmAssignmentResult: vmAssignmentResults) &#123;</div><div class="line">       <span class="keyword">for</span> (TaskAssignmentResult tasksAssigned: vmAssignmentResult.getTasksAssigned()) &#123;</div><div class="line">           String jobName = TaskContext.from(tasksAssigned.getTaskId()).getMetaInfo().getJobName();</div><div class="line">           <span class="keyword">if</span> (result.containsKey(jobName)) &#123;</div><div class="line">               result.put(jobName, result.get(jobName) + <span class="number">1</span>);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               result.put(jobName, <span class="number">1</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><ul><li><p>è°ƒç”¨ <code>#getTaskInfoList(...)</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>å•ä¸ªä¸»æœº</strong>çš„ Mesos ä»»åŠ¡ä¿¡æ¯é›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> List&lt;Protos.TaskInfo&gt; getTaskInfoList(<span class="keyword">final</span> Collection&lt;String&gt; integrityViolationJobs, <span class="keyword">final</span> VMAssignmentResult vmAssignmentResult, <span class="keyword">final</span> String hostname, <span class="keyword">final</span> Protos.Offer offer) &#123;</div><div class="line">   List&lt;Protos.TaskInfo&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(vmAssignmentResult.getTasksAssigned().size());</div><div class="line">   <span class="keyword">for</span> (TaskAssignmentResult each: vmAssignmentResult.getTasksAssigned()) &#123;</div><div class="line">       TaskContext taskContext = TaskContext.from(each.getTaskId());</div><div class="line">       String jobName = taskContext.getMetaInfo().getJobName();</div><div class="line">       <span class="keyword">if</span> (!integrityViolationJobs.contains(jobName) <span class="comment">// æ’é™¤ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä»»åŠ¡</span></div><div class="line">               &amp;&amp; !facadeService.isRunning(taskContext) <span class="comment">// æ’é™¤æ­£åœ¨è¿è¡Œä¸­çš„ä»»åŠ¡</span></div><div class="line">               &amp;&amp; !facadeService.isJobDisabled(jobName)) &#123; <span class="comment">// æ’é™¤è¢«ç¦ç”¨çš„ä»»åŠ¡</span></div><div class="line">           <span class="comment">// åˆ›å»º Mesos ä»»åŠ¡</span></div><div class="line">           Protos.TaskInfo taskInfo = getTaskInfo(offer, each);</div><div class="line">           <span class="keyword">if</span> (<span class="keyword">null</span> != taskInfo) &#123;</div><div class="line">               result.add(taskInfo);</div><div class="line">               <span class="comment">// æ·»åŠ ä»»åŠ¡ä¸»é”®å’Œä¸»æœºåç§°çš„æ˜ å°„</span></div><div class="line">               facadeService.addMapping(taskInfo.getTaskId().getValue(), hostname);</div><div class="line">               <span class="comment">// é€šçŸ¥ TaskScheduler ä¸»æœºåˆ†é…äº†è¿™ä¸ªä»»åŠ¡</span></div><div class="line">               taskScheduler.getTaskAssigner().call(each.getRequest(), hostname);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#getTaskInfo(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ï¼Œåœ¨<a href="#">ã€Œ4.4.1 åˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ä¿¡æ¯ã€</a>è¯¦ç»†è§£æã€‚</li><li><p>è°ƒç”¨ <code>FacadeService#addMapping(...)</code> æ–¹æ³•ï¼Œæ·»åŠ ä»»åŠ¡ä¸»é”®å’Œä¸»æœºåç§°çš„æ˜ å°„ã€‚é€šè¿‡è¯¥æ˜ å°„ï¼Œå¯ä»¥æ ¹æ®ä»»åŠ¡ä¸»é”®æŸ¥è¯¢åˆ°å¯¹åº”çš„ä¸»æœºåã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ·»åŠ ä»»åŠ¡ä¸»é”®å’Œä¸»æœºåç§°çš„æ˜ å°„.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskId ä»»åŠ¡ä¸»é”®</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> hostname ä¸»æœºåç§°</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMapping</span><span class="params">(<span class="keyword">final</span> String taskId, <span class="keyword">final</span> String hostname)</span> </span>&#123;</div><div class="line">   runningService.addMapping(taskId, hostname);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RunningService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä»»åŠ¡ä¸»é”®å’Œä¸»æœºåç§°çš„æ˜ å°„</span></div><div class="line"><span class="comment">* key: ä»»åŠ¡ä¸»é”®</span></div><div class="line"><span class="comment">* value: ä¸»æœºåç§°</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, String&gt; TASK_HOSTNAME_MAPPER = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(TASK_INITIAL_SIZE);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMapping</span><span class="params">(<span class="keyword">final</span> String taskId, <span class="keyword">final</span> String hostname)</span> </span>&#123;</div><div class="line">   TASK_HOSTNAME_MAPPER.putIfAbsent(taskId, hostname);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>TaskScheduler#getTaskAssigner()#call(...)</code> æ–¹æ³•ï¼Œé€šçŸ¥ TaskScheduler ä»»åŠ¡è¢«<strong>ç¡®è®¤</strong>åˆ†é…åˆ°è¿™ä¸ªä¸»æœºã€‚TaskScheduler åšä»»åŠ¡å’Œ Offer çš„åŒ¹é…ï¼Œå¯¹å“ªäº›ä»»åŠ¡è¿è¡Œåœ¨å“ªäº›ä¸»æœºæ˜¯æœ‰ä¾èµ–çš„ï¼Œä¸ç„¶æ€ä¹ˆåšåŒ¹é…ä¼˜åŒ–å‘¢ã€‚åœ¨<a href="https://github.com/Netflix/Fenzo/wiki/How-to-use-Fenzo#notify-the-scheduler-of-assigns-and-unassigns-of-tasks" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Notify the Scheduler of Assigns and UnAssigns of Tasksã€‹</a>å¯ä»¥è¿›ä¸€æ­¥äº†è§£ã€‚</p></li></ul></li><li><p>è°ƒç”¨ <code>#getOfferIDs(...)</code> æ–¹æ³•ï¼Œè·å¾— Offer ID é›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> List&lt;Protos.OfferID&gt; getOfferIDs(<span class="keyword">final</span> List&lt;VirtualMachineLease&gt; leasesUsed) &#123;</div><div class="line">   List&lt;Protos.OfferID&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (VirtualMachineLease virtualMachineLease: leasesUsed) &#123;</div><div class="line">       result.add(virtualMachineLease.getOffer().getId());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><h3 id="4-4-1-åˆ›å»ºå•ä¸ª-Mesos-ä»»åŠ¡ä¿¡æ¯"><a href="#4-4-1-åˆ›å»ºå•ä¸ª-Mesos-ä»»åŠ¡ä¿¡æ¯" class="headerlink" title="4.4.1 åˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ä¿¡æ¯"></a>4.4.1 åˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ä¿¡æ¯</h3><p>è°ƒç”¨ <code>#getTaskInfo()</code> æ–¹æ³•ï¼Œåˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><strong>å¦‚ä¸‹ä¼šæ¶‰åŠå¤§é‡çš„ Mesos API</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.<span class="function">TaskInfo <span class="title">getTaskInfo</span><span class="params">(<span class="keyword">final</span> Protos.Offer offer, <span class="keyword">final</span> TaskAssignmentResult taskAssignmentResult)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ ¡éªŒ ä½œä¸šé…ç½® æ˜¯å¦å­˜åœ¨</span></div><div class="line">   TaskContext taskContext = TaskContext.from(taskAssignmentResult.getTaskId());</div><div class="line">   Optional&lt;CloudJobConfiguration&gt; jobConfigOptional = facadeService.load(taskContext.getMetaInfo().getJobName());</div><div class="line">   <span class="keyword">if</span> (!jobConfigOptional.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">   CloudJobConfiguration jobConfig = jobConfigOptional.get();</div><div class="line">   <span class="comment">// æ ¡éªŒ ä½œä¸šé…ç½® æ˜¯å¦å­˜åœ¨</span></div><div class="line">   Optional&lt;CloudAppConfiguration&gt; appConfigOptional = facadeService.loadAppConfig(jobConfig.getAppName());</div><div class="line">   <span class="keyword">if</span> (!appConfigOptional.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">   CloudAppConfiguration appConfig = appConfigOptional.get();</div><div class="line">   <span class="comment">// è®¾ç½® Mesos Slave ID</span></div><div class="line">   taskContext.setSlaveId(offer.getSlaveId().getValue());</div><div class="line">   <span class="comment">// è·å¾— åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line">   ShardingContexts shardingContexts = getShardingContexts(taskContext, appConfig, jobConfig);</div><div class="line">   <span class="comment">// ç¬æ—¶çš„è„šæœ¬ä½œä¸šï¼Œä½¿ç”¨ Mesos å‘½ä»¤è¡Œæ‰§è¡Œï¼Œæ— éœ€ä½¿ç”¨æ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">boolean</span> isCommandExecutor = CloudJobExecutionType.TRANSIENT == jobConfig.getJobExecutionType() &amp;&amp; JobType.SCRIPT == jobConfig.getTypeConfig().getJobType();</div><div class="line">   String script = appConfig.getBootstrapScript();</div><div class="line">   <span class="keyword">if</span> (isCommandExecutor) &#123;</div><div class="line">       script = ((ScriptJobConfiguration) jobConfig.getTypeConfig()).getScriptCommandLine();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// åˆ›å»º å¯åŠ¨å‘½ä»¤</span></div><div class="line">   Protos.CommandInfo.URI uri = buildURI(appConfig, isCommandExecutor);</div><div class="line">   Protos.CommandInfo command = buildCommand(uri, script, shardingContexts, isCommandExecutor);</div><div class="line">   <span class="comment">// åˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯</span></div><div class="line">   <span class="keyword">if</span> (isCommandExecutor) &#123;</div><div class="line">       <span class="keyword">return</span> buildCommandExecutorTaskInfo(taskContext, jobConfig, shardingContexts, offer, command);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">return</span> buildCustomizedExecutorTaskInfo(taskContext, appConfig, jobConfig, shardingContexts, offer, command);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>#getShardingContexts(...)</code> æ–¹æ³•ï¼Œ è·å¾—åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ShardingContexts <span class="title">getShardingContexts</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> CloudAppConfiguration appConfig, <span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   Map&lt;Integer, String&gt; shardingItemParameters = <span class="keyword">new</span> ShardingItemParameters(jobConfig.getTypeConfig().getCoreConfig().getShardingItemParameters()).getMap();</div><div class="line">   Map&lt;Integer, String&gt; assignedShardingItemParameters = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1</span>, <span class="number">1</span>);</div><div class="line">   <span class="keyword">int</span> shardingItem = taskContext.getMetaInfo().getShardingItems().get(<span class="number">0</span>); <span class="comment">// å•ä¸ªä½œä¸šåˆ†ç‰‡</span></div><div class="line">   assignedShardingItemParameters.put(shardingItem, shardingItemParameters.containsKey(shardingItem) ? shardingItemParameters.get(shardingItem) : <span class="string">""</span>);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ShardingContexts(taskContext.getId(), jobConfig.getJobName(), jobConfig.getTypeConfig().getCoreConfig().getShardingTotalCount(),</div><div class="line">           jobConfig.getTypeConfig().getCoreConfig().getJobParameter(), assignedShardingItemParameters, appConfig.getEventTraceSamplingCount());</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>å½“ä»»åŠ¡ä¸º<strong>ç¬æ—¶</strong>çš„<strong>è„šæœ¬</strong>ä½œä¸šæ—¶ï¼Œä½¿ç”¨ Mesos Slave å‘½ä»¤è¡Œè°ƒç”¨å³å¯ï¼Œæ— éœ€ä½¿ç”¨ Elastic-Job-Cloud-Executorã€‚</p></li><li><p>è°ƒç”¨ <code>#buildURI(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºæ‰§è¡Œå™¨çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½åœ°å€ã€‚è¯•ä¸‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.CommandInfo.<span class="function">URI <span class="title">buildURI</span><span class="params">(<span class="keyword">final</span> CloudAppConfiguration appConfig, <span class="keyword">final</span> <span class="keyword">boolean</span> isCommandExecutor)</span> </span>&#123;</div><div class="line">   Protos.CommandInfo.URI.Builder result = Protos.CommandInfo.URI.newBuilder()</div><div class="line">           .setValue(appConfig.getAppURL())</div><div class="line">           .setCache(appConfig.isAppCacheEnable()); <span class="comment">// cache</span></div><div class="line">   <span class="keyword">if</span> (isCommandExecutor &amp;&amp; !SupportedExtractionType.isExtraction(appConfig.getAppURL())) &#123;</div><div class="line">       result.setExecutable(<span class="keyword">true</span>); <span class="comment">// æ˜¯å¦å¯æ‰§è¡Œ</span></div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       result.setExtract(<span class="keyword">true</span>); <span class="comment">// æ˜¯å¦éœ€è¦è§£å‹</span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.build();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>äº‘ä½œä¸šåº”ç”¨é…ç½® <code>CloudAppConfiguration.appURL</code> ï¼Œé€šè¿‡ Mesos å®ç°æ–‡ä»¶çš„ä¸‹è½½ã€‚</li><li><p>äº‘ä½œä¸šåº”ç”¨é…ç½® <code>CloudAppConfiguration.appCacheEnable</code>ï¼Œåº”ç”¨æ–‡ä»¶ä¸‹è½½æ˜¯å¦ç¼“å­˜ã€‚</p><blockquote><p>FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P99<br><strong>Fetcher ç¼“å­˜</strong><br>Mesos 0.23 é‡Œå‘å¸ƒç§°ä¸º fetcher ç¼“å­˜çš„æ–°åŠŸèƒ½ã€‚fetcher ç¼“å­˜ç¡®ä¿æ¯ä¸ª artifact åœ¨æ¯ä¸ª slave åªä¼šä¸‹è½½ä¸€æ¬¡ï¼Œå³ä½¿å¤šä¸ªæ‰§è¡Œå™¨è¯·æ±‚åŒä¸€ä¸ª artifactï¼Œä¹Ÿåªéœ€è¦ç­‰å¾…å•è¯ä¸‹è½½å®Œæˆå³å¯ã€‚</p></blockquote></li></ul></li><li><p>è°ƒç”¨ <code>#buildCommand(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºæ‰§è¡Œå™¨å¯åŠ¨å‘½ä»¤ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.<span class="function">CommandInfo <span class="title">buildCommand</span><span class="params">(<span class="keyword">final</span> Protos.CommandInfo.URI uri, <span class="keyword">final</span> String script, <span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> <span class="keyword">boolean</span> isCommandExecutor)</span> </span>&#123;</div><div class="line">   Protos.CommandInfo.Builder result = Protos.CommandInfo.newBuilder().addUris(uri).setShell(<span class="keyword">true</span>);</div><div class="line">   <span class="keyword">if</span> (isCommandExecutor) &#123;</div><div class="line">       CommandLine commandLine = CommandLine.parse(script);</div><div class="line">       commandLine.addArgument(GsonFactory.getGson().toJson(shardingContexts), <span class="keyword">false</span>);</div><div class="line">       result.setValue(Joiner.on(<span class="string">" "</span>).join(commandLine.getExecutable(), Joiner.on(<span class="string">" "</span>).join(commandLine.getArguments())));</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       result.setValue(script);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><ul><li><p>è°ƒç”¨ <code>#buildCommandExecutorTaskInfo(...)</code> æ–¹æ³•ï¼Œä¸º<strong>ç¬æ—¶</strong>çš„<strong>è„šæœ¬</strong>ä½œä¸šåˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.<span class="function">TaskInfo <span class="title">buildCommandExecutorTaskInfo</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> CloudJobConfiguration jobConfig, <span class="keyword">final</span> ShardingContexts shardingContexts,</span></span></div><div class="line"><span class="function"><span class="params">                                                    <span class="keyword">final</span> Protos.Offer offer, <span class="keyword">final</span> Protos.CommandInfo command)</span> </span>&#123;</div><div class="line">   Protos.TaskInfo.Builder result = Protos.TaskInfo.newBuilder().setTaskId(Protos.TaskID.newBuilder().setValue(taskContext.getId()).build())</div><div class="line">           .setName(taskContext.getTaskName()).setSlaveId(offer.getSlaveId())</div><div class="line">           .addResources(buildResource(<span class="string">"cpus"</span>, jobConfig.getCpuCount(), offer.getResourcesList()))</div><div class="line">           .addResources(buildResource(<span class="string">"mem"</span>, jobConfig.getMemoryMB(), offer.getResourcesList()))</div><div class="line">           .setData(ByteString.copyFrom(<span class="keyword">new</span> TaskInfoData(shardingContexts, jobConfig).serialize())); <span class="comment">//</span></div><div class="line">   <span class="keyword">return</span> result.setCommand(command).build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><ul><li><p>è°ƒç”¨ <code>#buildCustomizedExecutorTaskInfo(...)</code> æ–¹æ³•ï¼Œåˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.<span class="function">TaskInfo <span class="title">buildCustomizedExecutorTaskInfo</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> CloudAppConfiguration appConfig, <span class="keyword">final</span> CloudJobConfiguration jobConfig, </span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> Protos.Offer offer, <span class="keyword">final</span> Protos.CommandInfo command)</span> </span>&#123;</div><div class="line">   Protos.TaskInfo.Builder result = Protos.TaskInfo.newBuilder().setTaskId(Protos.TaskID.newBuilder().setValue(taskContext.getId()).build())</div><div class="line">           .setName(taskContext.getTaskName()).setSlaveId(offer.getSlaveId())</div><div class="line">           .addResources(buildResource(<span class="string">"cpus"</span>, jobConfig.getCpuCount(), offer.getResourcesList()))</div><div class="line">           .addResources(buildResource(<span class="string">"mem"</span>, jobConfig.getMemoryMB(), offer.getResourcesList()))</div><div class="line">           .setData(ByteString.copyFrom(<span class="keyword">new</span> TaskInfoData(shardingContexts, jobConfig).serialize()));</div><div class="line">   <span class="comment">// ExecutorInfo</span></div><div class="line">   Protos.ExecutorInfo.Builder executorBuilder = Protos.ExecutorInfo.newBuilder().setExecutorId(Protos.ExecutorID.newBuilder()</div><div class="line">           .setValue(taskContext.getExecutorId(jobConfig.getAppName()))) <span class="comment">// æ‰§è¡Œå™¨ ID</span></div><div class="line">           .setCommand(command)</div><div class="line">           .addResources(buildResource(<span class="string">"cpus"</span>, appConfig.getCpuCount(), offer.getResourcesList()))</div><div class="line">           .addResources(buildResource(<span class="string">"mem"</span>, appConfig.getMemoryMB(), offer.getResourcesList()));</div><div class="line">   <span class="keyword">if</span> (env.getJobEventRdbConfiguration().isPresent()) &#123;</div><div class="line">       executorBuilder.setData(ByteString.copyFrom(SerializationUtils.serialize(env.getJobEventRdbConfigurationMap()))).build();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.setExecutor(executorBuilder.build()).build();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>Protos.ExecutorInfo.Builder#setValue(...)</code> æ–¹æ³•ï¼Œè®¾ç½®<strong>æ‰§è¡Œå™¨ç¼–å·</strong>ã€‚å¤§å¤šæ•°åœ¨ Mesos å®ç°çš„æ‰§è¡Œå™¨ï¼Œä¸€ä¸ªä»»åŠ¡å¯¹åº”ä¸€ä¸ªæ‰§è¡Œå™¨ã€‚è€Œ Elastic-Job-Cloud-Executor ä¸åŒäºå¤§å¤šæ•°åœ¨ Mesos ä¸Šçš„æ‰§è¡Œå™¨ï¼Œä¸€ä¸ªæ‰§è¡Œå™¨å¯ä»¥å¯¹åº”å¤šä¸ªä½œä¸šã€‚ä»€ä¹ˆæ„æ€ï¼Ÿåœ¨ä¸€ä¸ª Mesos Slaveï¼Œ<strong>ç›¸åŒ</strong>ä½œä¸šåº”ç”¨ï¼Œåªä¼šå¯åŠ¨ä¸€ä¸ª Elastic-Job-Cloud-Schedulerã€‚å½“è¯¥æ‰§è¡Œå™¨ä¸å­˜åœ¨æ—¶ï¼Œå¯åŠ¨ä¸€ä¸ªã€‚å½“è¯¥æ‰§è¡Œå™¨å·²ç»å­˜åœ¨ï¼Œå¤ç”¨è¯¥æ‰§è¡Œå™¨ã€‚é‚£ä¹ˆæ˜¯å¦‚ä½•å®ç°è¯¥åŠŸèƒ½çš„å‘¢ï¼Ÿ<strong>ç›¸åŒ</strong>ä½œä¸šåº”ç”¨ï¼Œåœ¨åŒä¸€ä¸ª Mesos Slaveï¼Œä½¿ç”¨ç›¸åŒæ‰§è¡Œå™¨ç¼–å·ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * è·å–ä»»åŠ¡æ‰§è¡Œå™¨ä¸»é”®.</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> appName åº”ç”¨åç§°</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> ä»»åŠ¡æ‰§è¡Œå™¨ä¸»é”®</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getExecutorId</span><span class="params">(<span class="keyword">final</span> String appName)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Joiner.on(DELIMITER).join(appName, slaveId);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul></li></ul><h2 id="4-5-å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—"><a href="#4-5-å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—" class="headerlink" title="4.5 å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—"></a>4.5 å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—</h2><p>è°ƒç”¨ <code>FacadeService#addRunning(...)</code> æ–¹æ³•ï¼Œå°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRunning</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   runningService.add(taskContext);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RunningService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!configurationService.load(taskContext.getMetaInfo().getJobName()).isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°è¿è¡Œä¸­çš„ä»»åŠ¡é›†åˆ</span></div><div class="line">   getRunningTasks(taskContext.getMetaInfo().getJobName()).add(taskContext);</div><div class="line">   <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºå¸¸é©»ä»»åŠ¡</span></div><div class="line">   <span class="keyword">if</span> (!isDaemon(taskContext.getMetaInfo().getJobName())) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°è¿è¡Œä¸­é˜Ÿåˆ—</span></div><div class="line">   String runningTaskNodePath = RunningNode.getRunningTaskNodePath(taskContext.getMetaInfo().toString());</div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(runningTaskNodePath)) &#123;</div><div class="line">       regCenter.persist(runningTaskNodePath, taskContext.getId());</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RunningNode.java</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RunningNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = StateNode.ROOT + <span class="string">"/running"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RUNNING_JOB = ROOT + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;JOB_NAME&#125;</span></div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RUNNING_TASK = RUNNING_JOB + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;TASK_META_INFO&#125;ã€‚$&#123;TASK_META_INFO&#125;=$&#123;JOB_NAME&#125;@-@$&#123;ITEM_ID&#125;ã€‚</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>RunningServiceï¼Œä»»åŠ¡è¿è¡Œæ—¶æœåŠ¡ï¼Œæä¾›å¯¹è¿è¡Œä¸­çš„ä»»åŠ¡é›†åˆã€è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—çš„å„ç§æ“ä½œæ–¹æ³•ã€‚</li><li><p>è°ƒç”¨ <code>#getRunningTasks()</code> æ–¹æ³•ï¼Œè·å¾—<strong>è¿è¡Œä¸­çš„ä»»åŠ¡é›†åˆ</strong>ï¼Œå¹¶å°†å½“å‰ä»»åŠ¡æ·»åŠ åˆ°å…¶ä¸­ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;TaskContext&gt; <span class="title">getRunningTasks</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   Set&lt;TaskContext&gt; taskContexts = <span class="keyword">new</span> CopyOnWriteArraySet&lt;&gt;();</div><div class="line">   Collection&lt;TaskContext&gt; result = RUNNING_TASKS.putIfAbsent(jobName, taskContexts);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span> == result ? taskContexts : result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>åœ¨è¿ç»´å¹³å°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å½“å‰ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/09.png" alt=""></p></li><li><p>å¸¸é©»ä½œä¸šä¼šå­˜å‚¨åœ¨<strong>è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—</strong>ã€‚è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${NAMESPACE}/state/running/${JOB_NAME}/${TASK_META_INFO}</code>ï¼Œå­˜å‚¨å€¼ä¸ºä»»åŠ¡ç¼–å·ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 14] ls /elastic-job-cloud/state/running/test_job_simple</div><div class="line">[test_job_simple@-@0, test_job_simple@-@1, test_job_simple@-@2]</div><div class="line">[zk: localhost:2181(CONNECTED) 15] get /elastic-job-cloud/state/running/test_job_simple/test_job_simple@-@0</div><div class="line">test_job_simple@-@0@-@READY@-@400197d9-76ca-464b-b2f0-e0fba5c2a598-S0@-@9780ed12-9612-45e3-ac14-feb2911896ff</div></pre></td></tr></table></figure></li></ul><h2 id="4-6-ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š"><a href="#4-6-ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š" class="headerlink" title="4.6 ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š"></a>4.6 ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line">facadeService.removeLaunchTasksFromQueue(taskContextsList);</div><div class="line"></div><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContexts ä»»åŠ¡ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeLaunchTasksFromQueue</span><span class="params">(<span class="keyword">final</span> List&lt;TaskContext&gt; taskContexts)</span> </span>&#123;</div><div class="line">   List&lt;TaskContext&gt; failoverTaskContexts = <span class="keyword">new</span> ArrayList&lt;&gt;(taskContexts.size());</div><div class="line">   Collection&lt;String&gt; readyJobNames = <span class="keyword">new</span> HashSet&lt;&gt;(taskContexts.size(), <span class="number">1</span>);</div><div class="line">   <span class="keyword">for</span> (TaskContext each : taskContexts) &#123;</div><div class="line">       <span class="keyword">switch</span> (each.getType()) &#123;</div><div class="line">           <span class="keyword">case</span> FAILOVER:</div><div class="line">               failoverTaskContexts.add(each);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> READY:</div><div class="line">               readyJobNames.add(each.getMetaInfo().getJobName());</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">default</span>:</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ä»å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ä¸­åˆ é™¤ç›¸å…³ä»»åŠ¡</span></div><div class="line">   failoverService.remove(Lists.transform(failoverTaskContexts, <span class="keyword">new</span> Function&lt;TaskContext, TaskContext.MetaInfo&gt;() &#123;</div><div class="line">       </div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="keyword">public</span> TaskContext.<span class="function">MetaInfo <span class="title">apply</span><span class="params">(<span class="keyword">final</span> TaskContext input)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> input.getMetaInfo();</div><div class="line">       &#125;</div><div class="line">   &#125;));</div><div class="line">   <span class="comment">// ä»å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­åˆ é™¤ç›¸å…³ä½œä¸š</span></div><div class="line">   readyService.remove(readyJobNames);</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="4-7-æäº¤ä»»åŠ¡ç»™-Mesos"><a href="#4-7-æäº¤ä»»åŠ¡ç»™-Mesos" class="headerlink" title="4.7 æäº¤ä»»åŠ¡ç»™ Mesos"></a>4.7 æäº¤ä»»åŠ¡ç»™ Mesos</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line"><span class="keyword">for</span> (Entry&lt;List&lt;OfferID&gt;, List&lt;TaskInfo&gt;&gt; each : offerIdTaskInfoMap.entrySet()) &#123;</div><div class="line">   schedulerDriver.launchTasks(each.getKey(), each.getValue());</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>SchedulerDriver#launchTasks(...)</code> æ–¹æ³•ï¼Œæäº¤ä»»åŠ¡ç»™ Mesos Masterã€‚ç”± Mesos Master è°ƒåº¦ä»»åŠ¡ç»™ Mesos Slaveã€‚Mesos Slave æäº¤æ‰§è¡Œå™¨æ‰§è¡Œä»»åŠ¡ã€‚</li></ul><h1 id="5-TaskExecutor-æ‰§è¡Œä»»åŠ¡"><a href="#5-TaskExecutor-æ‰§è¡Œä»»åŠ¡" class="headerlink" title="5. TaskExecutor æ‰§è¡Œä»»åŠ¡"></a>5. TaskExecutor æ‰§è¡Œä»»åŠ¡</h1><p>TaskExecutorï¼Œå®ç°äº† Mesos Executor æ¥å£ <code>org.apache.mesos.Executor</code>ã€‚æ‰§è¡Œå™¨çš„ä¸»è¦èŒè´£ä¹‹ä¸€ï¼š<strong>æ‰§è¡Œè°ƒåº¦å™¨æ‰€è¯·æ±‚çš„ä»»åŠ¡</strong>ã€‚TaskExecutor æ¥æ”¶åˆ° Mesos Slave æäº¤çš„ä»»åŠ¡ï¼Œè°ƒç”¨ <code>#launchTask(...)</code> æ–¹æ³•ï¼Œå¤„ç†ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DaemonTaskScheduler.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">launchTask</span><span class="params">(<span class="keyword">final</span> ExecutorDriver executorDriver, <span class="keyword">final</span> Protos.TaskInfo taskInfo)</span> </span>&#123;</div><div class="line">   executorService.submit(<span class="keyword">new</span> TaskThread(executorDriver, taskInfo));</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>ExecutorService#submit(...)</code> æ–¹æ³•ï¼Œæäº¤ TaskThread åˆ°çº¿ç¨‹æ± ï¼Œæ‰§è¡Œä»»åŠ¡ã€‚</li></ul><h2 id="5-1-TaskThread"><a href="#5-1-TaskThread" class="headerlink" title="5.1 TaskThread"></a>5.1 TaskThread</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@RequiredArgsConstructor</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> ExecutorDriver executorDriver;</div><div class="line">   </div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> TaskInfo taskInfo;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œè¿è¡Œä¸­ã€‚</span></div><div class="line">       executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_RUNNING).build());</div><div class="line">       <span class="comment">//</span></div><div class="line">       Map&lt;String, Object&gt; data = SerializationUtils.deserialize(taskInfo.getData().toByteArray());</div><div class="line">       ShardingContexts shardingContexts = (ShardingContexts) data.get(<span class="string">"shardingContext"</span>);</div><div class="line">       <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">       JobConfigurationContext jobConfig = <span class="keyword">new</span> JobConfigurationContext((Map&lt;String, String&gt;) data.get(<span class="string">"jobConfigContext"</span>));</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// è·å¾— åˆ†å¸ƒå¼ä½œä¸š</span></div><div class="line">           ElasticJob elasticJob = getElasticJobInstance(jobConfig);</div><div class="line">           <span class="comment">// è°ƒåº¦å™¨æä¾›å†…éƒ¨æœåŠ¡çš„é—¨é¢å¯¹è±¡</span></div><div class="line">           <span class="keyword">final</span> CloudJobFacade jobFacade = <span class="keyword">new</span> CloudJobFacade(shardingContexts, jobConfig, jobEventBus);</div><div class="line">           <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">           <span class="keyword">if</span> (jobConfig.isTransient()) &#123;</div><div class="line">               <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">               JobExecutorFactory.getJobExecutor(elasticJob, jobFacade).execute();</div><div class="line">               <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œå·²å®Œæˆã€‚</span></div><div class="line">               executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_FINISHED).build());</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="comment">// åˆå§‹åŒ– å¸¸é©»ä½œä¸šè°ƒåº¦å™¨</span></div><div class="line">               <span class="keyword">new</span> DaemonTaskScheduler(elasticJob, jobConfig, jobFacade, executorDriver, taskInfo.getTaskId()).init();</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// CHECKSTYLE:OFF</span></div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable ex) &#123;</div><div class="line">           <span class="comment">// CHECKSTYLE:ON</span></div><div class="line">           log.error(<span class="string">"Elastic-Job-Cloud-Executor error"</span>, ex);</div><div class="line">           executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_ERROR).setMessage(ExceptionUtil.transform(ex)).build());</div><div class="line">           executorDriver.stop();</div><div class="line">           <span class="keyword">throw</span> ex;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä» <code>TaskInfo.data</code> å±æ€§ä¸­ï¼Œå¯ä»¥è·å¾—æäº¤ä»»åŠ¡é™„å¸¦çš„æ•°æ®ï¼Œä¾‹å¦‚åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ( ShardingContexts )ï¼Œå†…éƒ¨çš„ä½œä¸šé…ç½®ä¸Šä¸‹æ–‡( JobConfigurationContext )ã€‚</li><li><p>è°ƒç”¨ <code>#getElasticJobInstance()</code> æ–¹æ³•ï¼Œè·å¾—ä»»åŠ¡éœ€è¦æ‰§è¡Œçš„åˆ†å¸ƒå¼ä½œä¸š( Elastic-Job )ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ElasticJob <span class="title">getElasticJobInstance</span><span class="params">(<span class="keyword">final</span> JobConfigurationContext jobConfig)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!Strings.isNullOrEmpty(jobConfig.getBeanName()) &amp;&amp; !Strings.isNullOrEmpty(jobConfig.getApplicationContext())) &#123; <span class="comment">// spring ç¯å¢ƒ</span></div><div class="line">      <span class="keyword">return</span> getElasticJobBean(jobConfig);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">return</span> getElasticJobClass(jobConfig);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä» Spring å®¹å™¨ä¸­è·å¾—ä½œä¸šå¯¹è±¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> ä½œä¸šå¯¹è±¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> ElasticJob <span class="title">getElasticJobBean</span><span class="params">(<span class="keyword">final</span> JobConfigurationContext jobConfig)</span> </span>&#123;</div><div class="line">  String applicationContextFile = jobConfig.getApplicationContext();</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">null</span> == applicationContexts.get(applicationContextFile)) &#123;</div><div class="line">      <span class="keyword">synchronized</span> (applicationContexts) &#123;</div><div class="line">          <span class="keyword">if</span> (<span class="keyword">null</span> == applicationContexts.get(applicationContextFile)) &#123;</div><div class="line">              applicationContexts.put(applicationContextFile, <span class="keyword">new</span> ClassPathXmlApplicationContext(applicationContextFile));</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> (ElasticJob) applicationContexts.get(applicationContextFile).getBean(jobConfig.getBeanName());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºä½œä¸šå¯¹è±¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> ä½œä¸šå¯¹è±¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> ElasticJob <span class="title">getElasticJobClass</span><span class="params">(<span class="keyword">final</span> JobConfigurationContext jobConfig)</span> </span>&#123;</div><div class="line">  String jobClass = jobConfig.getTypeConfig().getJobClass();</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      Class&lt;?&gt; elasticJobClass = Class.forName(jobClass);</div><div class="line">      <span class="keyword">if</span> (!ElasticJob.class.isAssignableFrom(elasticJobClass)) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(<span class="string">"Elastic-Job: Class '%s' must implements ElasticJob interface."</span>, jobClass);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (elasticJobClass != ScriptJob.class) &#123;</div><div class="line">          <span class="keyword">return</span> (ElasticJob) elasticJobClass.newInstance();</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">  &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ReflectiveOperationException ex) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(<span class="string">"Elastic-Job: Class '%s' initialize failure, the error message is '%s'."</span>, jobClass, ex.getMessage());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å½“ä½œä¸šæ˜¯<strong>ç¬æ—¶</strong>ä½œä¸šæ—¶ï¼Œè°ƒç”¨ <code>AbstractElasticJobExecutor#execute(...)</code> æ‰§è¡Œä½œä¸šé€»è¾‘ï¼Œå¹¶è°ƒç”¨ <code>ExecutorDriver#sendStatusUpdate(...)</code> å‘é€çŠ¶æ€ï¼Œæ›´æ–° Mesos ä»»åŠ¡å·²å®Œæˆ( Protos.TaskState.TASK_FINISHED )ã€‚<code>AbstractElasticJobExecutor#execute(...)</code> å®ç°ä»£ç ï¼Œåœ¨ Elastic-Job-Lite å’Œ Elastic-Job-Cloud åŸºæœ¬ä¸€è‡´ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li><li>å½“ä½œä¸šæ˜¯<strong>å¸¸é©»</strong>ä½œä¸šæ—¶ï¼Œè°ƒç”¨ <code>DaemonTaskScheduler#init()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–ä½œä¸šè°ƒåº¦ï¼Œåœ¨ã€Œ5.2 DaemonTaskSchedulerã€è¯¦ç»†è§£æã€‚</li></ul></li></ul><h2 id="5-2-DaemonTaskScheduler"><a href="#5-2-DaemonTaskScheduler" class="headerlink" title="5.2 DaemonTaskScheduler"></a>5.2 DaemonTaskScheduler</h2><p><strong>ç¬æ—¶</strong>ä½œä¸šï¼Œé€šè¿‡ Elastic-Job-Cloud-Scheduler è°ƒåº¦ä»»åŠ¡ï¼Œæäº¤ Elastic-Job-Cloud-Executor æ‰§è¡Œåï¼Œç­‰å¾… Elastic-Job-Scheduler è¿›è¡Œä¸‹æ¬¡è°ƒåº¦ã€‚</p><p><strong>å¸¸é©»</strong>ä½œä¸šï¼Œé€šè¿‡ Elastic-Job-Scheduler æäº¤ Elastic-Job-Cloud-Executor è¿›è¡Œè°ƒåº¦ã€‚Elastic-Job-Cloud-Executor ä½¿ç”¨ DaemonTaskScheduler ä¸æ–­å¯¹å¸¸é©»ä½œä¸šè¿›è¡Œè°ƒåº¦è€Œæ— éœ€ Elastic-Job-Cloud-Scheduler å‚ä¸å…¶ä¸­ã€‚</p><p>è¿™å°±æ˜¯<strong>ç¬æ—¶</strong>ä½œä¸šå’Œ<strong>å¸¸é©»</strong>ä½œä¸šä¸åŒä¹‹å¤„ã€‚</p><p>DaemonTaskSchedulerï¼Œå¸¸é©»ä½œä¸šè°ƒåº¦å™¨ã€‚è°ƒç”¨ <code>DaemonTaskScheduler#init()</code> æ–¹æ³•ï¼Œå¯¹<strong>ä¸€ä¸ª</strong>ä½œä¸šåˆå§‹åŒ–è°ƒåº¦ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆå§‹åŒ–ä½œä¸š.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// Quartz JobDetail</span></div><div class="line">   JobDetail jobDetail = JobBuilder.newJob(DaemonJob.class)</div><div class="line">           .withIdentity(jobRootConfig.getTypeConfig().getCoreConfig().getJobName()).build();</div><div class="line">   jobDetail.getJobDataMap().put(ELASTIC_JOB_DATA_MAP_KEY, elasticJob);</div><div class="line">   jobDetail.getJobDataMap().put(JOB_FACADE_DATA_MAP_KEY, jobFacade);</div><div class="line">   jobDetail.getJobDataMap().put(EXECUTOR_DRIVER_DATA_MAP_KEY, executorDriver);</div><div class="line">   jobDetail.getJobDataMap().put(TASK_ID_DATA_MAP_KEY, taskId);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       scheduleJob(initializeScheduler(), jobDetail, taskId.getValue(), jobRootConfig.getTypeConfig().getCoreConfig().getCron());</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> Scheduler <span class="title">initializeScheduler</span><span class="params">()</span> <span class="keyword">throws</span> SchedulerException </span>&#123;</div><div class="line">   StdSchedulerFactory factory = <span class="keyword">new</span> StdSchedulerFactory();</div><div class="line">   factory.initialize(getBaseQuartzProperties());</div><div class="line">   <span class="keyword">return</span> factory.getScheduler();</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> Properties <span class="title">getBaseQuartzProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">   Properties result = <span class="keyword">new</span> Properties();</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.class"</span>, org.quartz.simpl.SimpleThreadPool.class.getName());</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.threadCount"</span>, <span class="string">"1"</span>); <span class="comment">// çº¿ç¨‹æ•°ï¼š1</span></div><div class="line">   result.put(<span class="string">"org.quartz.scheduler.instanceName"</span>, taskId.getValue());</div><div class="line">   <span class="keyword">if</span> (!jobRootConfig.getTypeConfig().getCoreConfig().isMisfire()) &#123;</div><div class="line">       result.put(<span class="string">"org.quartz.jobStore.misfireThreshold"</span>, <span class="string">"1"</span>);</div><div class="line">   &#125;</div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.class"</span>, ShutdownHookPlugin.class.getName());</div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.cleanShutdown"</span>, Boolean.TRUE.toString());</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleJob</span><span class="params">(<span class="keyword">final</span> Scheduler scheduler, <span class="keyword">final</span> JobDetail jobDetail, <span class="keyword">final</span> String triggerIdentity, <span class="keyword">final</span> String cron)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">if</span> (!scheduler.checkExists(jobDetail.getKey())) &#123;</div><div class="line">           scheduler.scheduleJob(jobDetail, createTrigger(triggerIdentity, cron));</div><div class="line">       &#125;</div><div class="line">       scheduler.start();</div><div class="line">       RUNNING_SCHEDULERS.putIfAbsent(scheduler.getSchedulerName(), scheduler);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> CronTrigger <span class="title">createTrigger</span><span class="params">(<span class="keyword">final</span> String triggerIdentity, <span class="keyword">final</span> String cron)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> TriggerBuilder.newTrigger()</div><div class="line">           .withIdentity(triggerIdentity)</div><div class="line">           .withSchedule(CronScheduleBuilder.cronSchedule(cron)</div><div class="line">           .withMisfireHandlingInstructionDoNothing())</div><div class="line">           .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>DaemonTaskScheduler åŸºäº Quartz å®ç°ä½œä¸šè°ƒåº¦ã€‚è¿™é‡Œå¤§å®¶çœ‹ä¸‹æºç ï¼Œå°±ä¸å•°å—¦è§£é‡Šå•¦ã€‚</li><li>JobBuilder#newJob(â€¦) çš„å‚æ•°æ˜¯ DaemonJobï¼Œä¸‹æ–‡ä¼šè®²è§£åˆ°ã€‚</li></ul><p><strong>DaemonJob å®ç°ä»£ç </strong>å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DaemonJob</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> ElasticJob elasticJob;</div><div class="line">   </div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> JobFacade jobFacade;</div><div class="line">   </div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> ExecutorDriver executorDriver;</div><div class="line">    </div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> Protos.TaskID taskId;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</div><div class="line">       ShardingContexts shardingContexts = jobFacade.getShardingContexts();</div><div class="line">       <span class="keyword">int</span> jobEventSamplingCount = shardingContexts.getJobEventSamplingCount();</div><div class="line">       <span class="keyword">int</span> currentJobEventSamplingCount = shardingContexts.getCurrentJobEventSamplingCount();</div><div class="line">       <span class="keyword">if</span> (jobEventSamplingCount &gt; <span class="number">0</span> &amp;&amp; ++currentJobEventSamplingCount &lt; jobEventSamplingCount) &#123;</div><div class="line">           shardingContexts.setCurrentJobEventSamplingCount(currentJobEventSamplingCount);</div><div class="line">           <span class="comment">//</span></div><div class="line">           jobFacade.getShardingContexts().setAllowSendJobEvent(<span class="keyword">false</span>);</div><div class="line">           <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">           JobExecutorFactory.getJobExecutor(elasticJob, jobFacade).execute();</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">//</span></div><div class="line">           jobFacade.getShardingContexts().setAllowSendJobEvent(<span class="keyword">true</span>);</div><div class="line">           <span class="comment">//</span></div><div class="line">           executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskId).setState(Protos.TaskState.TASK_RUNNING).setMessage(<span class="string">"BEGIN"</span>).build());</div><div class="line">           <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">           JobExecutorFactory.getJobExecutor(elasticJob, jobFacade).execute();</div><div class="line">           <span class="comment">//</span></div><div class="line">           executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskId).setState(Protos.TaskState.TASK_RUNNING).setMessage(<span class="string">"COMPLETE"</span>).build());</div><div class="line">           <span class="comment">// </span></div><div class="line">           shardingContexts.setCurrentJobEventSamplingCount(<span class="number">0</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>AbstractElasticJobExecutor#execute(...)</code> æ‰§è¡Œä½œä¸šé€»è¾‘ã€‚<code>AbstractElasticJobExecutor#execute(...)</code> å®ç°ä»£ç ï¼Œåœ¨ Elastic-Job-Lite å’Œ Elastic-Job-Cloud åŸºæœ¬ä¸€è‡´ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li><li><p><code>jobEventSamplingCount</code> æ¥è‡ªåº”ç”¨é…ç½® (<code>CloudAppConfiguration.eventTraceSamplingCount</code>) å±æ€§ï¼Œå¸¸é©»ä½œä¸šäº‹ä»¶é‡‡æ ·ç‡ç»Ÿè®¡æ¡æ•°ï¼Œé»˜è®¤é‡‡æ ·å…¨éƒ¨è®°å½•ã€‚ä¸ºé¿å…æ•°æ®é‡è¿‡å¤§ï¼Œå¯å¯¹é¢‘ç¹è°ƒåº¦çš„å¸¸é©»ä½œä¸šé…ç½®é‡‡æ ·ç‡ï¼Œå³ä½œä¸šæ¯æ‰§è¡ŒNæ¬¡ï¼Œæ‰ä¼šè®°å½•ä½œä¸šæ‰§è¡ŒåŠè¿½è¸ªç›¸å…³æ•°æ®ã€‚</p><p>å½“æ»¡è¶³é‡‡æ ·æ¡ä»¶æ—¶ï¼Œè°ƒç”¨ <code>ShardingContexts#setAllowSendJobEvent(true)</code>ï¼Œæ ‡è®°<strong>è¦</strong>è®°å½•ä½œä¸šäº‹ä»¶ã€‚å¦åˆ™ï¼Œè°ƒç”¨ <code>ShardingContexts#setAllowSendJobEvent(false)</code>ï¼Œæ ‡è®°<strong>ä¸</strong>è®°å½•ä½œä¸šæ—¶é—´ã€‚ä½œä¸šäº‹ä»¶è¿½è¸ªåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-event-trace/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šäº‹ä»¶è¿½è¸ªã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</p><p>å¦å¤–ï¼Œå½“æ»¡è¶³é‡‡æ ·è°ƒè¯•æ—¶ï¼Œä¹Ÿä¼šè°ƒç”¨ <code>ExecutorDriver#sendStatusUpdate(...)</code> æ–¹æ³•ï¼Œæ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸ºè¿è¡Œä¸­ï¼Œå¹¶é™„å¸¦ <code>&quot;BEGIN&quot;</code> æˆ– <code>&quot;COMPLETE&quot;</code> æ¶ˆæ¯ã€‚</p></li></ul><h1 id="6-SchedulerEngine-å¤„ç†ä»»åŠ¡çš„çŠ¶æ€å˜æ›´"><a href="#6-SchedulerEngine-å¤„ç†ä»»åŠ¡çš„çŠ¶æ€å˜æ›´" class="headerlink" title="6. SchedulerEngine å¤„ç†ä»»åŠ¡çš„çŠ¶æ€å˜æ›´"></a>6. SchedulerEngine å¤„ç†ä»»åŠ¡çš„çŠ¶æ€å˜æ›´</h1><p>Mesos è°ƒåº¦å™¨çš„èŒè´£ä¹‹ä¸€ï¼Œ<strong>å¤„ç†ä»»åŠ¡çš„çŠ¶æ€ï¼Œç‰¹åˆ«æ˜¯å“åº”ä»»åŠ¡å’Œæ•…éšœ</strong>ã€‚å› æ­¤åœ¨ Elastic-Job-Cloud-Executor è°ƒç”¨ <code>ExecutorDriver#sendStatusUpdate(...)</code> æ–¹æ³•ï¼Œæ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€æ—¶ï¼Œè§¦å‘è°ƒç”¨ Elastic-Job-Cloud-Scheduler çš„ SchedulerEngine çš„ <code>#statusUpdate(...)</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">statusUpdate</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver, <span class="keyword">final</span> Protos.TaskStatus taskStatus)</span> </span>&#123;</div><div class="line">   String taskId = taskStatus.getTaskId().getValue();</div><div class="line">   TaskContext taskContext = TaskContext.from(taskId);</div><div class="line">   String jobName = taskContext.getMetaInfo().getJobName();</div><div class="line">   log.trace(<span class="string">"call statusUpdate task state is: &#123;&#125;, task id is: &#123;&#125;"</span>, taskStatus.getState(), taskId);</div><div class="line">   jobEventBus.post(<span class="keyword">new</span> JobStatusTraceEvent(jobName, taskContext.getId(), taskContext.getSlaveId(), Source.CLOUD_SCHEDULER, </div><div class="line">           taskContext.getType(), String.valueOf(taskContext.getMetaInfo().getShardingItems()), State.valueOf(taskStatus.getState().name()), taskStatus.getMessage()));</div><div class="line">   <span class="keyword">switch</span> (taskStatus.getState()) &#123;</div><div class="line">       <span class="keyword">case</span> TASK_RUNNING:</div><div class="line">           <span class="keyword">if</span> (!facadeService.load(jobName).isPresent()) &#123;</div><div class="line">               schedulerDriver.killTask(Protos.TaskID.newBuilder().setValue(taskId).build());</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (<span class="string">"BEGIN"</span>.equals(taskStatus.getMessage())) &#123;</div><div class="line">               facadeService.updateDaemonStatus(taskContext, <span class="keyword">false</span>);</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"COMPLETE"</span>.equals(taskStatus.getMessage())) &#123;</div><div class="line">               facadeService.updateDaemonStatus(taskContext, <span class="keyword">true</span>);</div><div class="line">               statisticManager.taskRunSuccessfully();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> TASK_FINISHED:</div><div class="line">           facadeService.removeRunning(taskContext);</div><div class="line">           unAssignTask(taskId);</div><div class="line">           statisticManager.taskRunSuccessfully();</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> TASK_KILLED:</div><div class="line">           log.warn(<span class="string">"task id is: &#123;&#125;, status is: &#123;&#125;, message is: &#123;&#125;, source is: &#123;&#125;"</span>, taskId, taskStatus.getState(), taskStatus.getMessage(), taskStatus.getSource());</div><div class="line">           facadeService.removeRunning(taskContext);</div><div class="line">           facadeService.addDaemonJobToReadyQueue(jobName);</div><div class="line">           unAssignTask(taskId);</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> TASK_LOST:</div><div class="line">       <span class="keyword">case</span> TASK_DROPPED:</div><div class="line">       <span class="keyword">case</span> TASK_GONE:</div><div class="line">       <span class="keyword">case</span> TASK_GONE_BY_OPERATOR:</div><div class="line">       <span class="keyword">case</span> TASK_FAILED:</div><div class="line">       <span class="keyword">case</span> TASK_ERROR:</div><div class="line">           log.warn(<span class="string">"task id is: &#123;&#125;, status is: &#123;&#125;, message is: &#123;&#125;, source is: &#123;&#125;"</span>, taskId, taskStatus.getState(), taskStatus.getMessage(), taskStatus.getSource());</div><div class="line">           facadeService.removeRunning(taskContext);</div><div class="line">           facadeService.recordFailoverTask(taskContext);</div><div class="line">           unAssignTask(taskId);</div><div class="line">           statisticManager.taskRunFailed();</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> TASK_UNKNOWN:</div><div class="line">       <span class="keyword">case</span> TASK_UNREACHABLE:</div><div class="line">           log.error(<span class="string">"task id is: &#123;&#125;, status is: &#123;&#125;, message is: &#123;&#125;, source is: &#123;&#125;"</span>, taskId, taskStatus.getState(), taskStatus.getMessage(), taskStatus.getSource());</div><div class="line">           statisticManager.taskRunFailed();</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">default</span>:</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>å½“æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸º <code>TASK_RUNNING</code> æ—¶ï¼Œæ ¹æ®é™„å¸¦æ¶ˆæ¯ä¸º <code>&quot;BEGIN&quot;</code> æˆ– <code>&quot;COMPLETE&quot;</code>ï¼Œåˆ†åˆ«è°ƒç”¨ <code>FacadeService#updateDaemonStatus(false / true)</code> æ–¹æ³•ï¼Œæ›´æ–°ä½œä¸šé—²ç½®çŠ¶æ€ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ›´æ–°å¸¸é©»ä½œä¸šè¿è¡ŒçŠ¶æ€.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> isIdle æ˜¯å¦ç©ºé—²</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateDaemonStatus</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> <span class="keyword">boolean</span> isIdle)</span> </span>&#123;</div><div class="line">   runningService.updateIdle(taskContext, isIdle);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">// RunningService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ›´æ–°ä½œä¸šé—²ç½®çŠ¶æ€.</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> isIdle æ˜¯å¦é—²ç½®</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateIdle</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> <span class="keyword">boolean</span> isIdle)</span> </span>&#123;</div><div class="line">   <span class="keyword">synchronized</span> (RUNNING_TASKS) &#123;</div><div class="line">       Optional&lt;TaskContext&gt; taskContextOptional = findTask(taskContext);</div><div class="line">       <span class="keyword">if</span> (taskContextOptional.isPresent()) &#123;</div><div class="line">           taskContextOptional.get().setIdle(isIdle);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           add(taskContext);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>è‹¥ä½œä¸šé…ç½®ä¸å­˜åœ¨æ—¶ï¼Œè°ƒç”¨ <code>SchedulerDriver#killTask(...)</code> æ–¹æ³•ï¼Œæ€æ­»è¯¥ Mesos ä»»åŠ¡ã€‚åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-second/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆäºŒï¼‰ã€‹</a>è¿›ä¸€æ­¥è§£æã€‚</p></li><li><p>å½“æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸º <code>TASK_FINISHED</code> æ—¶ï¼Œè°ƒç”¨ <code>FacadeService#removeRunning(...)</code> æ–¹æ³•ï¼Œå°†ä»»åŠ¡ä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å°†ä»»åŠ¡ä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeRunning</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   runningService.remove(taskContext);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RunningService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å°†ä»»åŠ¡ä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   <span class="comment">// ç§»é™¤è¿è¡Œä¸­çš„ä»»åŠ¡é›†åˆ</span></div><div class="line">   getRunningTasks(taskContext.getMetaInfo().getJobName()).remove(taskContext);</div><div class="line">   <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºå¸¸é©»ä»»åŠ¡</span></div><div class="line">   <span class="keyword">if</span> (!isDaemonOrAbsent(taskContext.getMetaInfo().getJobName())) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å°†ä»»åŠ¡ä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤</span></div><div class="line">   regCenter.remove(RunningNode.getRunningTaskNodePath(taskContext.getMetaInfo().toString()));</div><div class="line">   String jobRootNode = RunningNode.getRunningJobNodePath(taskContext.getMetaInfo().getJobName());</div><div class="line">   <span class="keyword">if</span> (regCenter.isExisted(jobRootNode) &amp;&amp; regCenter.getChildrenKeys(jobRootNode).isEmpty()) &#123;</div><div class="line">       regCenter.remove(jobRootNode);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>å½“è¯¥ä½œä¸šå¯¹åº”çš„æ‰€æœ‰ Mesos ä»»åŠ¡çŠ¶æ€éƒ½æ›´æ–°ä¸º <code>TASK_FINISHED</code> åï¼Œä½œä¸šå¯ä»¥å†æ¬¡è¢« Elastic-Job-Cloud-Scheduler è°ƒåº¦ã€‚</p><p>è°ƒç”¨ <code>#unAssignTask(...)</code> æ–¹æ³•ï¼Œé€šçŸ¥ TaskScheduler ä»»åŠ¡è¢«<strong>ç¡®è®¤</strong>æœªåˆ†é…åˆ°è¿™ä¸ªä¸»æœºã€‚TaskScheduler åšä»»åŠ¡å’Œ Offer çš„åŒ¹é…ï¼Œå¯¹å“ªäº›ä»»åŠ¡è¿è¡Œåœ¨å“ªäº›ä¸»æœºæ˜¯æœ‰ä¾èµ–çš„ï¼Œä¸ç„¶æ€ä¹ˆåšåŒ¹é…ä¼˜åŒ–å‘¢ã€‚åœ¨<a href="https://github.com/Netflix/Fenzo/wiki/How-to-use-Fenzo#notify-the-scheduler-of-assigns-and-unassigns-of-tasks" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Notify the Scheduler of Assigns and UnAssigns of Tasksã€‹</a>å¯ä»¥è¿›ä¸€æ­¥äº†è§£ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unAssignTask</span><span class="params">(<span class="keyword">final</span> String taskId)</span> </span>&#123;</div><div class="line">    String hostname = facadeService.popMapping(taskId);</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != hostname) &#123;</div><div class="line">        taskScheduler.getTaskUnAssigner().call(TaskContext.getIdForUnassignedSlave(taskId), hostname);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul></li><li><p>å½“æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸º <code>TASK_KILLED</code> æ—¶ï¼Œè°ƒç”¨ <code>FacadeService#addDaemonJobToReadyQueue(...)</code> æ–¹æ³•ï¼Œå°†å¸¸é©»ä½œä¸šæ”¾å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—ã€‚<strong>ä¸ºä»€ä¹ˆè¦å°†å¸¸é©»ä½œä¸šæ”¾å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—å‘¢ï¼Ÿ</strong>è¢« Kill æ‰çš„ä½œä¸šåç»­è¦ç»§ç»­è°ƒåº¦æ‰§è¡Œï¼Œå¦‚æœä¸åŠ å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—ï¼ŒTaskLaunchScheduledService å°±æ— æ³•æäº¤ä½œä¸šç»™ Elastic-Job-Cloud-Executor ç»§ç»­è°ƒåº¦æ‰§è¡Œã€‚</p><p>å¦å¤–ä¼šè°ƒç”¨ <code>FacadeService#removeRunning(...)</code>ã€<code>#unAssignTask(...)</code> æ–¹æ³•ã€‚</p></li><li><p>å½“æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸º <code>TASK_ERROR</code> ç­‰ç­‰æ—¶ï¼Œè°ƒç”¨ <code>FacadeService#recordFailoverTask(...)</code> æ–¹æ³•ï¼Œåœ¨ <a href="http://www.iocoder.cn/Elastic-Job/cloud-job-failover/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>è¯¦ç»†è§£æã€‚</p><p>å¦å¤–ä¼šè°ƒç”¨ <code>FacadeService#removeRunning(...)</code> å’Œ <code>#unAssignTask(...)</code> æ–¹æ³•ã€‚</p></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šçœŸçš„çœŸçš„çœŸçš„ï¼Œå¥½é•¿å¥½é•¿å¥½é•¿å•Šã€‚ä½†æ˜¯çœŸçš„çœŸçš„çœŸçš„ï¼Œå¹²è´§ï¼<br>èŠ‹é“å›ï¼šé‚£å¿…é¡»çš„ï¼</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/12.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/Elastic-Job-Cloud/">Elastic-Job-Cloud</a></div><div class="article-share" id="share"><div data-url="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/" data-title="Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/Elastic-Job/cloud-job-scheduler-and-executor-second/" title="Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆäºŒï¼‰"><strong>PREVIOUS:</strong><br><span>Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆäºŒï¼‰</span></a></div><div class="next"><a href="/Architecture/how-to-read-article/" title="é—²èŠå¦‚ä½•é˜…è¯»æ–‡ç« "><strong>NEXT:</strong><br><span>é—²èŠå¦‚ä½•é˜…è¯»æ–‡ç« </span></a></div></nav></div></div><footer><div id="footer"><img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display:none"><p class="copyright">Â© 2017 <a href="http://www.iocoder.cn" target="_blank" title="ç‹æ–‡æ–Œ">ç‹æ–‡æ–Œ</a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a> && Powered by <a href="http://hexo.io" target="_blank" title="hexo" rel="external nofollow noopener noreferrer">hexo</a> && Theme by <a href="http://gengbiao.me" target="_blank" title="coney" rel="external nofollow noopener noreferrer">coney</a></p></div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2");ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script src="/js/util.js"></script></body>