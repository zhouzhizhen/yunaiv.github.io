<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§» | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="ç‹æ–‡æ–Œ"><meta name="description" content="æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«

1. æ¦‚è¿°
2. è®°å½•ä½œä¸šå¤±æ•ˆè½¬ç§»
3. æäº¤å¤±æ•ˆè½¬ç§»ä½œä¸š
666. å½©è›‹




ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘æœ‰ç¦åˆ©ï¼š  

RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨  
Rock"><meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?9e70e3362807c1bd185a79655b307027";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG">èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</a></h1><a class="blog-motto">æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li><li><a href="/link_url">å‹é“¾</a></li></ul></ul></nav></div></header><div id="container"><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-è®°å½•ä½œä¸šå¤±æ•ˆè½¬ç§»"><span class="toc-number">2.</span> <span class="toc-text">2. è®°å½•ä½œä¸šå¤±æ•ˆè½¬ç§»</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-æäº¤å¤±æ•ˆè½¬ç§»ä½œä¸š"><span class="toc-number">3.</span> <span class="toc-text">3. æäº¤å¤±æ•ˆè½¬ç§»ä½œä¸š</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-å½©è›‹"><span class="toc-number">4.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li><li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/æŠ€æœ¯æ‚æ–‡/" title="æŠ€æœ¯æ‚æ–‡">æŠ€æœ¯æ‚æ–‡<sup>3</sup></a></li></ul></div></aside></div><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/Elastic-Job/cloud-job-failover/" title="Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»" itemprop="url">Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»</a></h1><p class="article-author"></p><p class="article-time">æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. è®°å½•ä½œä¸šå¤±æ•ˆè½¬ç§»</a></li><li><a href="#">3. æäº¤å¤±æ•ˆè½¬ç§»ä½œä¸š</a></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Cloud ä½œä¸šå¤±æ•ˆè½¬ç§»</strong>ã€‚å¯¹åº”åˆ° Elastic-Job-Lite æºç è§£ææ–‡ç« ä¸º<a href="http://www.iocoder.cn/Elastic-Job/job-failover/?self">ã€ŠElastic-Job-Lite ä½œä¸šä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>ã€‚</p><p>ä½ éœ€è¦å¯¹<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>æœ‰ä¸€å®šçš„äº†è§£ã€‚</p><p>å½“ä½œä¸šä»»åŠ¡åœ¨ Elastic-Job-Cloud-Executor å¼‚å¸¸å´©æºƒæ—¶ï¼Œè¯¥ä»»åŠ¡åœ¨ä¸‹æ¬¡è°ƒåº¦ä¹‹å‰ä¸ä¼šè¢«é‡æ–°æ‰§è¡Œã€‚å¼€å¯å¤±æ•ˆè½¬ç§»åŠŸèƒ½åï¼Œè¯¥ä½œä¸šä»»åŠ¡ä¼šç«‹å³è¢« Elastic-Job-Cloud-Scheduler é‡æ–°è°ƒåº¦ï¼Œæäº¤ Elastic-Job-Cloud-Executor <strong>ç«‹å³</strong>æ‰§è¡Œã€‚</p><p>åœ¨ Elastic-Job-Cloud é‡Œï¼Œæˆ‘ä»¬äº†è§£åˆ°ä½œä¸šåˆ†æˆ<strong>ç¬æ—¶</strong>ä½œä¸šå’Œ<strong>å¸¸é©»</strong>ä½œä¸šã€‚å®é™…ä¸Šé¢å¤±æ•ˆè½¬ç§»çš„å®šä¹‰æš‚æ—¶åªé€‚ç”¨äº<strong>ç¬æ—¶</strong>ä½œä¸šã€‚å¯¹äº<strong>å¸¸é©»</strong>ä½œä¸šï¼Œä½œä¸šä»»åŠ¡å¼‚å¸¸å´©æºƒåï¼Œæ— è®ºä½ æ˜¯å¦å¼€å¯å¤±æ•ˆè½¬ç§»åŠŸèƒ½ï¼ŒElastic-Job-Cloud-Scheduler ä¼šç«‹åˆ»æäº¤ Elastic-Job-Cloud-Executor <strong>é‡æ–°è°ƒåº¦</strong>æ‰§è¡Œã€‚</p><p><strong>ä¸ºä»€ä¹ˆæ­¤å¤„ä½¿ç”¨çš„æ˜¯â€œé‡æ–°è°ƒåº¦â€ï¼Œè€Œä¸æ˜¯â€œç«‹å³æ‰§è¡Œâ€å‘¢</strong>ï¼Ÿç›®å‰ç‰ˆæœ¬ Elasitc-Job-Cloud æš‚æ—¶ä¸æ”¯æŒ<strong>å¸¸é©»</strong>ä½œä¸šçš„å¤±æ•ˆè½¬ç§»ï¼Œå½“ä½œä¸šä»»åŠ¡å¼‚å¸¸å´©æºƒï¼Œæœ¬æ¬¡æ‰§è¡Œ<strong>ä¸ä¼šé‡æ–°æ‰§è¡Œ</strong>ï¼Œä½†æ˜¯ä¸ºäº†ä½œä¸šä»»åŠ¡åç»­èƒ½å¤Ÿè°ƒåº¦æ‰§è¡Œï¼Œæ‰€ä»¥å†æ¬¡æäº¤ Elastic-Job-Cloud-Schedulerã€‚</p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>OKï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ä½œä¸šå¤±æ•ˆè½¬ç§»çš„å®ç°æ–¹å¼å’Œä½œä¸šä»»åŠ¡å¼‚å¸¸å´©æºƒçš„å¤šé‡åœºæ™¯ã€‚</p><h1 id="2-è®°å½•ä½œä¸šå¤±æ•ˆè½¬ç§»"><a href="#2-è®°å½•ä½œä¸šå¤±æ•ˆè½¬ç§»" class="headerlink" title="2. è®°å½•ä½œä¸šå¤±æ•ˆè½¬ç§»"></a>2. è®°å½•ä½œä¸šå¤±æ•ˆè½¬ç§»</h1><p>å½“ä½œä¸šä»»åŠ¡å¼‚å¸¸å´©æºƒæ—¶ï¼ŒElastic-Job-Cloud-Scheduler é€šè¿‡ Mesos ä»»åŠ¡çŠ¶æ€å˜æ›´æ¥å£( <code>#statusUpdate()</code> )å®ç°å¯¹ä»»åŠ¡çŠ¶æ€çš„ç›‘å¬å¤„ç†ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerEngine</span> <span class="keyword">implements</span> <span class="title">Scheduler</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">statusUpdate</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver, <span class="keyword">final</span> Protos.TaskStatus taskStatus)</span> </span>&#123;</div><div class="line">        String taskId = taskStatus.getTaskId().getValue();</div><div class="line">        TaskContext taskContext = TaskContext.from(taskId);</div><div class="line">        String jobName = taskContext.getMetaInfo().getJobName();</div><div class="line">        log.trace(<span class="string">"call statusUpdate task state is: &#123;&#125;, task id is: &#123;&#125;"</span>, taskStatus.getState(), taskId);</div><div class="line">        jobEventBus.post(<span class="keyword">new</span> JobStatusTraceEvent(jobName, taskContext.getId(), taskContext.getSlaveId(), Source.CLOUD_SCHEDULER, </div><div class="line">                taskContext.getType(), String.valueOf(taskContext.getMetaInfo().getShardingItems()), State.valueOf(taskStatus.getState().name()), taskStatus.getMessage()));</div><div class="line">        <span class="keyword">switch</span> (taskStatus.getState()) &#123;</div><div class="line">            <span class="keyword">case</span> TASK_RUNNING:</div><div class="line">                <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> TASK_FINISHED:</div><div class="line">                <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> TASK_KILLED:</div><div class="line">                <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> TASK_LOST:</div><div class="line">            <span class="keyword">case</span> TASK_DROPPED:</div><div class="line">            <span class="keyword">case</span> TASK_GONE:</div><div class="line">            <span class="keyword">case</span> TASK_GONE_BY_OPERATOR:</div><div class="line">            <span class="keyword">case</span> TASK_FAILED: <span class="comment">// æ‰§è¡Œä½œä¸šä»»åŠ¡è¢«é”™è¯¯ç»ˆæ­¢</span></div><div class="line">            <span class="keyword">case</span> TASK_ERROR: <span class="comment">// ä»»åŠ¡é”™è¯¯</span></div><div class="line">                log.warn(<span class="string">"task id is: &#123;&#125;, status is: &#123;&#125;, message is: &#123;&#125;, source is: &#123;&#125;"</span>, taskId, taskStatus.getState(), taskStatus.getMessage(), taskStatus.getSource());</div><div class="line">                <span class="comment">// å°†ä»»åŠ¡ä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤</span></div><div class="line">                facadeService.removeRunning(taskContext);</div><div class="line">                <span class="comment">// è®°å½•å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</span></div><div class="line">                facadeService.recordFailoverTask(taskContext);</div><div class="line">                <span class="comment">// é€šçŸ¥ TaskScheduler ä»»åŠ¡ä¸åˆ†é…åœ¨å¯¹åº”ä¸»æœºä¸Š</span></div><div class="line">                unAssignTask(taskId);</div><div class="line">                <span class="comment">// ç»Ÿè®¡</span></div><div class="line">                statisticManager.taskRunFailed();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> TASK_UNKNOWN:</div><div class="line">            <span class="keyword">case</span> TASK_UNREACHABLE:</div><div class="line">                log.error(<span class="string">"task id is: &#123;&#125;, status is: &#123;&#125;, message is: &#123;&#125;, source is: &#123;&#125;"</span>, taskId, taskStatus.getState(), taskStatus.getMessage(), taskStatus.getSource());</div><div class="line">                statisticManager.taskRunFailed();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ä¸€å…±æœ‰ 6 ç§çŠ¶æ€åˆ¤å®šä¸ºä½œä¸šä»»åŠ¡å´©æºƒï¼Œæˆ‘ä»¬æ¥ä¸€ä¸ªä¸€ä¸ªçœ‹çœ‹ï¼š</p><ul><li><p>TASK_DROPPED / TASK_GONE / TASK_GONE_BY_OPERATOR</p><p>è¿™ä¸‰ä¸ªçŠ¶æ€ï¼Œç¬”è€…æš‚æ—¶ä¸å¤ªäº†è§£ï¼Œè¿™é‡Œå…ˆå¼•ç”¨ä¸€äº›èµ„æ–™ï¼Œæ¬¢è¿æœ‰äº†è§£çš„åŒå­¦æŒ‡æ•™ä¸€ä¸‹ã€‚</p><blockquote><p>FROM <a href="http://mesos.apache.org/api/latest/java/org/apache/mesos/Protos.TaskState.html" rel="external nofollow noopener noreferrer" target="_blank">http://mesos.apache.org/api/latest/java/org/apache/mesos/Protos.TaskState.html</a><br><strong>TASK_DROPPED</strong>ï¼šThe task failed to launch because of a transient error.<br><strong>TASK_GONE</strong>ï¼šThe task is no longer running.<br><strong>TASK_GONE_BY_OPERATOR</strong>ï¼šThe task was running on an agent that the master cannot contact; the operator has asserted that the agent has been shutdown, but this has not been directly confirmed by the master.</p><p>FROM <a href="http://mesos.apache.org/blog/mesos-1-1-0-released/" rel="external nofollow noopener noreferrer" target="_blank">http://mesos.apache.org/blog/mesos-1-1-0-released/</a><br>[MESOS-5344] - Experimental support for partition-aware Mesos frameworks. In previous Mesos releases, when an agent is partitioned from the master and then reregisters with the cluster, all tasks running on the agent are terminated and the agent is shutdown. In Mesos 1.1, partitioned agents will no longer be shutdown when they reregister with the master. By default, tasks running on such agents will still be killed (for backward compatibility); however, frameworks can opt-in to the new PARTITION_AWARE capability. If they do this, their tasks will not be killed when a partition is healed. This allows frameworks to define their own policies for how to handle partitioned tasks. Enabling the PARTITION_AWARE capability also introduces a new set of task states: TASK_UNREACHABLE, TASK_DROPPED, TASK_GONE, TASK_GONE_BY_OPERATOR, and TASK_UNKNOWN. <strong>These new states are intended to eventually replace the TASK_LOST state</strong>.</p></blockquote></li><li><p>TASK_FAILED</p><p>æ‰§è¡Œä½œä¸šä»»åŠ¡è¢«<strong>é”™è¯¯</strong>ç»ˆæ­¢ã€‚ä¾‹å¦‚ï¼Œæ‰§è¡Œå™¨( Elastic-Job-Cloud-Executor )å¼‚å¸¸å´©æºƒï¼Œæˆ–è€…è¢«æ€æ­»ã€‚</p></li><li><p>TASK_ERROR</p><p>ä»»åŠ¡å¯åŠ¨å°è¯•å¤±è´¥é”™è¯¯ã€‚ä¾‹å¦‚ï¼Œæ‰§è¡Œå™¨( Elastic-Job-Cloud-Executor ) æ¥æ”¶åˆ°çš„ä»»åŠ¡çš„ä½œä¸šé…ç½®ä¸æ­£ç¡®ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">    <span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œè¿è¡Œä¸­ã€‚</span></div><div class="line">    executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_RUNNING).build());</div><div class="line">    <span class="comment">//</span></div><div class="line">    Map&lt;String, Object&gt; data = SerializationUtils.deserialize(taskInfo.getData().toByteArray());</div><div class="line">    ShardingContexts shardingContexts = (ShardingContexts) data.get(<span class="string">"shardingContext"</span>);</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    JobConfigurationContext jobConfig = <span class="keyword">new</span> JobConfigurationContext((Map&lt;String, String&gt;) data.get(<span class="string">"jobConfigContext"</span>));</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// è·å¾— åˆ†å¸ƒå¼ä½œä¸š</span></div><div class="line">        ElasticJob elasticJob = getElasticJobInstance(jobConfig);</div><div class="line">        <span class="comment">// è°ƒåº¦å™¨æä¾›å†…éƒ¨æœåŠ¡çš„é—¨é¢å¯¹è±¡</span></div><div class="line">        <span class="keyword">final</span> CloudJobFacade jobFacade = <span class="keyword">new</span> CloudJobFacade(shardingContexts, jobConfig, jobEventBus);</div><div class="line">        <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">        <span class="keyword">if</span> (jobConfig.isTransient()) &#123;</div><div class="line">            <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">            JobExecutorFactory.getJobExecutor(elasticJob, jobFacade).execute();</div><div class="line">            <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œå·²å®Œæˆã€‚</span></div><div class="line">            executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_FINISHED).build());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// åˆå§‹åŒ– å¸¸é©»ä½œä¸šè°ƒåº¦å™¨</span></div><div class="line">            <span class="keyword">new</span> DaemonTaskScheduler(elasticJob, jobConfig, jobFacade, executorDriver, taskInfo.getTaskId()).init();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// CHECKSTYLE:OFF</span></div><div class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable ex) &#123;</div><div class="line">        <span class="comment">// CHECKSTYLE:ON</span></div><div class="line">        log.error(<span class="string">"Elastic-Job-Cloud-Executor error"</span>, ex);</div><div class="line">        <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œé”™è¯¯ã€‚</span></div><div class="line">        executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_ERROR).setMessage(ExceptionUtil.transform(ex)).build());</div><div class="line">        <span class="comment">// åœæ­¢è‡ªå·±</span></div><div class="line">        executorDriver.stop();</div><div class="line">        <span class="keyword">throw</span> ex;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#getElasticJobInstance()</code> æ–¹æ³•ï¼Œå› ä¸ºä»»åŠ¡çš„ä½œä¸šé…ç½®ä¸æ­£ç¡®æŠ›å‡º<strong>å¼‚å¸¸</strong>ã€‚ä¾‹å¦‚ï¼Œä»»åŠ¡ç±»ä¸å­˜åœ¨ï¼›Spring çš„ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼›Spring å®¹å™¨åˆå§‹åŒ–å‡ºé”™ï¼›Spring Bean å¯¹è±¡åˆå§‹åŒ–æˆ–è·å–å‡ºé”™ï¼›ä»¥åŠç­‰ç­‰ã€‚</li><li><p><strong>ç¬æ—¶</strong>ä½œä¸šï¼Œè°ƒç”¨ <code>AbstractElasticJobExecutor#execute(...)</code> æ–¹æ³•ï¼Œå‘ç”Ÿ<strong>å¼‚å¸¸</strong>ï¼Œå¹¶ä¸”<strong>å¼‚å¸¸è¢«æŠ›å‡º</strong>ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒAbstractElasticJobExecutor å†…éƒ¨ä½¿ç”¨ DefaultJobExceptionHandler å¤„ç†å‘ç”Ÿçš„å¼‚å¸¸ï¼Œ<strong>ä¸ä¼šæŠ›å‡ºå¼‚å¸¸</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultJobExceptionHandler</span> <span class="keyword">implements</span> <span class="title">JobExceptionHandler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleException</span><span class="params">(<span class="keyword">final</span> String jobName, <span class="keyword">final</span> Throwable cause)</span> </span>&#123;</div><div class="line">        log.error(String.format(<span class="string">"Job '%s' exception occur in job processing"</span>, jobName), cause);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li></li></ul></li><li><p><strong>å¸¸é©»</strong>ä½œä¸šï¼Œè°ƒç”¨ <code>DaemonTaskScheduler#(...)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–å‘ç”Ÿ<strong>å¼‚å¸¸</strong>ã€‚</p></li><li>å› ä¸ºä¸Šè¿°çš„ç§ç§å¼‚å¸¸ï¼Œè°ƒç”¨ <code>ExecutorDriver#sendStatusUpdate(...)</code>ï¼Œæ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸º TASK_ERRORã€‚å¦å¤–ï¼Œè°ƒç”¨ <code>ExecutorDriver#stop()</code> æ–¹æ³•ï¼Œå…³é—­è‡ªå·±ã€‚<strong>è¿™æ„å‘³ç€ï¼Œä¸€ä¸ªæ‰§è¡Œå™¨ä¸Šå¦‚æœå­˜åœ¨ä¸€ä¸ªä½œä¸šä»»åŠ¡å‘ç”Ÿ TASK_ERRORï¼Œå…¶ä»–ä½œä¸šä»»åŠ¡å³ä½¿æ˜¯æ­£å¸¸çš„ï¼Œä¹Ÿä¼šæ›´æ–°ä½œä¸šä»»åŠ¡çŠ¶æ€ä¸º TASK_FAILED</strong>ã€‚è¿™å—åƒä¸‡è¦æ³¨æ„ã€‚TODO è¿™ä¸ªéœ€è¦ç¡®è®¤ä¸‹ã€‚</li></ul></li><li><p>TASK_LOST</p><p>æ‰§è¡Œä½œä¸šä»»åŠ¡çš„ Elastic-Job-Cloud-Executor æ‰€åœ¨çš„ Mesos Slave ä¸ Mesos Master å› ä¸º<strong>ç½‘ç»œé—®é¢˜æˆ– Mesos Slave å´©æºƒ</strong>å¼•èµ·ä¸¢å¤±è¿æ¥ï¼Œ<strong>å¯èƒ½</strong>å¯¼è‡´å…¶ä¸Šçš„æ‰€æœ‰ä½œä¸šä»»åŠ¡çŠ¶æ€å˜ä¸º TASK_LOSTã€‚</p><p><strong>å½“ Slave å®•æœºåé‡å¯ï¼Œå¯¼è‡´ TASK_LOST æ—¶ï¼ŒMesosåˆæ˜¯æ€ä¹ˆæ¥å¤„ç†çš„å‘¢ï¼Ÿ</strong></p><blockquote><p>FROM <a href="http://dockone.io/article/2513" rel="external nofollow noopener noreferrer" target="_blank">http://dockone.io/article/2513</a><br>åœ¨ Master å’Œ Slave ä¹‹é—´ï¼Œä¸€èˆ¬éƒ½æ˜¯ç”± Master ä¸»åŠ¨å‘æ¯ä¸€ä¸ª Slave å‘é€Pingæ¶ˆæ¯ï¼Œå¦‚æœåœ¨è®¾å®šæ—¶é—´å†…ï¼ˆflag.slave_ping_timeoutï¼Œé»˜è®¤15sï¼‰æ²¡æœ‰æ”¶åˆ°Slave çš„å›å¤ï¼Œå¹¶ä¸”è¾¾åˆ°ä¸€å®šæ¬¡æ•°ï¼ˆflag.max_slave_ping_timeoutsï¼Œé»˜è®¤æ¬¡æ•°ä¸º5ï¼‰ï¼Œé‚£ä¹ˆ Master ä¼šæ“ä½œä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li>å°†è¯¥ Slave ä» Master ä¸­åˆ é™¤ï¼Œæ­¤æ—¶è¯¥ Slave çš„èµ„æºå°†ä¸ä¼šå†åˆ†é…ç»™Schedulerã€‚</li><li>éå†è¯¥ Slave ä¸Šè¿è¡Œçš„æ‰€æœ‰ä»»åŠ¡ï¼Œå‘å¯¹åº”çš„ Framework å‘é€ä»»åŠ¡çš„ Task_Lost çŠ¶æ€æ›´æ–°ï¼ŒåŒæ—¶æŠŠè¿™äº›ä»»åŠ¡ä»Masterä¸­åˆ é™¤ã€‚</li><li>éå†è¯¥ Slave ä¸Šçš„æ‰€æœ‰ Executorï¼Œå¹¶åˆ é™¤ã€‚</li><li>è§¦å‘ Rescind Offerï¼ŒæŠŠè¿™ä¸ª Slave ä¸Šå·²ç»åˆ†é…ç»™ Scheduler çš„ Offer æ’¤é”€ã€‚</li><li>æŠŠè¿™ä¸ª Slave ä» Master çš„ Replicated log ä¸­åˆ é™¤ï¼ˆMesos Master ä¾èµ– Replicated log ä¸­çš„éƒ¨åˆ†æŒä¹…åŒ–é›†ç¾¤é…ç½®ä¿¡æ¯è¿›è¡Œ failer over / recoveryï¼‰ã€‚</li></ol></blockquote><ul><li><p>å¿…é¡» Slave è¿›è¡Œé‡å¯ï¼Œå› ä¸ºå¯¹æ‰§è¡Œå™¨çš„ç›¸å…³æ“ä½œåªèƒ½é€šè¿‡ Mesos Slaveï¼Œå³ <strong>Scheduler &lt;=&gt; Mesos Master &lt;=&gt; Mesos Slave &lt;=&gt; Executor</strong>ã€‚å¦‚æœ Slave ä¸€ç›´ä¸è¿›è¡Œé‡å¯ï¼Œæ‰§è¡Œå™¨ä¼šä¸€ç›´è¿è¡Œï¼Œé™¤éæœ‰å¦å¤–çš„æœºåˆ¶ï¼Œ<strong>é€šçŸ¥</strong>åˆ°æ‰§è¡Œå™¨ã€‚</p><p>Butâ€¦â€¦â€¦â€¦â€¦â€¦<br>ç¬”è€…å°è¯•å¦‚ä¸Šæµç¨‹ï¼Œä½¿ç”¨ <code>kill -9</code> æ¨¡æ‹Ÿ Mesos Slave å¼‚å¸¸å´©æºƒï¼Œç­‰å¾… Mesos Master å‘ç° Mesos Slave å·²ç»å…³é—­ï¼Œ<strong>é‡å¯ Mesos Slave</strong>ï¼Œç»“æœæ‰§è¡Œå™¨( Elastic-Job-Cloud-Executor )æœªå…³é—­ï¼Œè°ƒåº¦å™¨( Elastic-Job-Cloud-Scheduler )å¹¶æœªæ”¶åˆ°ä»»åŠ¡çš„ TASK_LOSTã€‚ï¼Ÿï¼Ÿï¼Ÿä»€ä¹ˆæƒ…å†µï¼Ÿï¼Ÿï¼Ÿç¿»æŸ¥å¦‚ä¸‹æ–‡æ¡£ï¼š</p></li><li><p><a href="http://mesos.apache.org/documentation/latest/high-availability-framework-guide/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos å®˜æ–¹æ–‡æ¡£ â€”â€” high-availability-framework-guideã€‹</a>æœç´¢æ ‡é¢˜ â€œDealing with Partitioned or Failed Agentsâ€ã€‚</p></li><li><p><a href="http://mesos.apache.org/documentation/latest/agent-recovery/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos å®˜æ–¹æ–‡æ¡£ â€”â€” agent-recoveryã€‹</a>æœç´¢å…³æ ‡é¢˜ â€œAgent Recoveryâ€ã€‚</p><p>å› ä¸º Elastic-Job-Cloud-Scheduler æ³¨å†Œåˆ° Mesos Master æ—¶ï¼Œå¼€å¯äº† <code>checkpoint</code> å’Œ <code>PARTITION_AWARE</code>ã€‚å¼€å¯ <code>checkpoint</code> åï¼ŒMesos Slave ä¼šå°†è®°å½•<strong>æ£€æŸ¥ç‚¹</strong>ä¿¡æ¯ï¼Œ Mesos Slave é‡å¯åï¼Œä¼šè¯»å–æ£€æŸ¥ç‚¹æ£€æŸ¥ä¿¡æ¯ï¼Œ<strong>é‡æ–°è¿æ¥ä¸Š( ä¸ä¼šå…³é—­ )</strong>è¿è¡Œåœ¨å®ƒä¸Šé¢çš„æ‰§è¡Œå™¨( Elastic-Job-Cloud-Scheduler )ã€‚å¼€å¯ <code>PARTITION_AWARE</code> åï¼ŒTASK_LOST ä¼šè¢«åŒºåˆ†æˆ TASK_UNREACHABLE, TASK_DROPPED, TASK_GONE, TASK_GONE_BY_OPERATOR, and TASK_UNKNOWNã€‚è¡¨ç°å¦‚ä¸‹ï¼š</p><ul><li><code>kill -9</code> æ¨¡æ‹Ÿ Mesos Slave å¼‚å¸¸å´©æºƒï¼Œç­‰å¾… Mesos Master å‘ç° Mesos Slave å·²ç»å…³é—­</li><li>è°ƒåº¦å™¨( Elastic-Job-Cloud-Scheduler ) æ¥æ”¶ç›´æ¥ç”± Mesos Master å‘é€çš„è¯¥ Mesos Slave ä¸Šçš„æ¯ä¸ªä»»åŠ¡ TASK_UNREACHABLEã€‚</li><li>Mesos Slave é‡å¯å®Œæˆã€‚</li><li>æ‰§è¡Œå™¨( Elastic-Job-Cloud-Executor ) é‡æ–°æ³¨å†Œåˆ°é‡å¯å¥½çš„ Mesos Slave ï¼Œå¹¶ç»§ç»­è¿è¡Œä»»åŠ¡ã€‚</li></ul></li></ul><p>å¦‚æœ Elastic-Job-Cloud-Scheduler æ³¨å†Œåˆ° Mesos Master æ—¶ï¼Œå…³é—­äº† <code>PARTITION_AWARE</code> å’Œ <code>checkpoint</code>ï¼Œè¡¨ç°åŒ <strong>TASK_LOST</strong> æè¿°çš„è¿‡ç¨‹ã€‚</p><p>å¼€å¯ <code>checkpoint</code> å’Œ <code>PARTITION_AWARE</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><pre><code><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerService.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> SchedulerDriver <span class="title">getSchedulerDriver</span><span class="params">(<span class="keyword">final</span> TaskScheduler taskScheduler, <span class="keyword">final</span> JobEventBus jobEventBus, <span class="keyword">final</span> FrameworkIDService frameworkIDService)</span> </span>&#123;</div><div class="line">      Protos.FrameworkInfo.Builder builder = Protos.FrameworkInfo.newBuilder();</div><div class="line">      <span class="comment">// PARTITION_AWARE</span></div><div class="line">      builder.addCapabilitiesBuilder().setType(Protos.FrameworkInfo.Capability.Type.PARTITION_AWARE);</div><div class="line">      Protos.FrameworkInfo frameworkInfo = builder.setUser(mesosConfig.getUser()).setName(frameworkName)</div><div class="line">          .setHostname(mesosConfig.getHostname()).setFailoverTimeout(FRAMEWORK_FAILOVER_TIMEOUT_SECONDS)</div><div class="line">          .setWebuiUrl(WEB_UI_PROTOCOL + env.getFrameworkHostPort())</div><div class="line">          .setCheckpoint(<span class="keyword">true</span>) <span class="comment">// checkpoint</span></div><div class="line">          .build();</div><div class="line">      <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line"> &#125;</div></pre></td></tr></table></figure>
</code></pre><p><strong>æ˜¯ä¸æ˜¯å¼€å¯äº† <code>checkpoint</code>ï¼ŒMesos Slave é‡å¯ä¸ä¼šå…³é—­æ‰§è¡Œå™¨ï¼Ÿ</strong></p><p>ç­”æ¡ˆå½“ç„¶æ˜¯ä¸æ˜¯çš„ã€‚å½“ Mesos Slave é…ç½® <code>recover = cleanup</code> æˆ–è€… é‡å¯æ—¶é—´è¶…è¿‡ <code>recovery_timeout</code> ( é»˜è®¤ï¼Œ15 åˆ†é’Ÿ )æ—¶ï¼Œé‡å¯å®Œæˆåï¼ŒMesos Slave å…³é—­è¿è¡Œåœ¨å®ƒä¸Šé¢çš„æ‰§è¡Œå™¨( Elastic-Job-Cloud-Executor )ï¼Œè°ƒåº¦å™¨( Elastic-Job-Cloud-Scheduler ) æ¥æ”¶åˆ°çš„è¯¥ Mesos Slave ä¸Šçš„æ¯ä¸ªä»»åŠ¡ TASK_FAILEDã€‚</p><ul><li>å‚è€ƒæ–‡æ¡£ï¼š<a href="http://mesos.apache.org/documentation/latest/agent-recovery/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos å®˜æ–¹æ–‡æ¡£ â€”â€” agent-recoveryã€‹</a>æœç´¢æ ‡é¢˜ â€œAgent Configurationâ€ã€‚</li></ul></li></ul><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_10/01.png" alt=""></p><hr><p>è°ƒç”¨ <code>FacadeService#recordFailoverTask(...)</code> æ–¹æ³•ï¼Œè®°å½•å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordFailoverTask</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   Optional&lt;CloudJobConfiguration&gt; jobConfigOptional = jobConfigService.load(taskContext.getMetaInfo().getJobName());</div><div class="line">   <span class="keyword">if</span> (!jobConfigOptional.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (isDisable(jobConfigOptional.get())) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   CloudJobConfiguration jobConfig = jobConfigOptional.get();</div><div class="line">   <span class="keyword">if</span> (jobConfig.getTypeConfig().getCoreConfig().isFailover() <span class="comment">// å¼€å¯å¤±æ•ˆè½¬ç§»</span></div><div class="line">           || CloudJobExecutionType.DAEMON == jobConfig.getJobExecutionType()) &#123; <span class="comment">// å¸¸é©»ä½œä¸š</span></div><div class="line">       failoverService.add(taskContext);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å¯¹äº<strong>ç¬æ—¶</strong>ä½œä¸šï¼Œå¿…é¡»å¼€å¯ <code>JobCoreConfiguration.failover = true</code>ï¼Œæ‰èƒ½å¤±æ•ˆè½¬ç§»ï¼Œè¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£ã€‚</li><li>å¯¹äº<strong>å¸¸é©»</strong>ä½œä¸šï¼Œæš‚æ—¶ä¸æ”¯æŒå¤±æ•ˆè½¬ç§»ã€‚å› ä¸ºå¸¸é©»ä½œä¸šæ˜¯åœ¨æ‰§è¡Œå™¨( Elastic-Job-Executor ) è¿›è¡Œè°ƒåº¦æ‰§è¡Œï¼Œå¦‚æœä¸æ·»åŠ åˆ°å¤±æ•ˆè½¬ç§»ä½œä¸šé˜Ÿåˆ—ï¼Œé‡æ–°æäº¤åˆ°æ‰§è¡Œå™¨( Elastic-Job-Executor )ï¼Œåç»­å°±ä¸èƒ½è°ƒåº¦æ‰§è¡Œè¯¥ä½œä¸šäº†ã€‚</li><li>è°ƒç”¨ <code>FailoverService#add(...)</code> æ–¹æ³•ï¼Œå°†ä»»åŠ¡æ”¾å…¥å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (regCenter.getNumChildren(FailoverNode.ROOT) &gt; env.getFrameworkConfiguration().getJobStateQueueSize()) &#123;</div><div class="line">       log.warn(<span class="string">"Cannot add job, caused by read state queue size is larger than &#123;&#125;."</span>, env.getFrameworkConfiguration().getJobStateQueueSize());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   String failoverTaskNodePath = FailoverNode.getFailoverTaskNodePath(taskContext.getMetaInfo().toString());</div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(failoverTaskNodePath) <span class="comment">// åˆ¤æ–­ä¸åœ¨å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</span></div><div class="line">           &amp;&amp; !runningService.isTaskRunning(taskContext.getMetaInfo())) &#123; <span class="comment">// åˆ¤æ–­ä¸åœ¨è¿è¡Œä¸­</span></div><div class="line">       regCenter.persist(failoverTaskNodePath, taskContext.getId());</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// FailoverNode.java</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FailoverNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = StateNode.ROOT + <span class="string">"/failover"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FAILOVER_JOB = ROOT + <span class="string">"/%s"</span>; <span class="comment">// %s=$&#123;JOB_NAME&#125;</span></div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FAILOVER_TASK = FAILOVER_JOB + <span class="string">"/%s"</span>; <span class="comment">// %s=$&#123;TASK_META_INFO&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>FailoverServiceï¼Œå¤±æ•ˆè½¬ç§»é˜Ÿåˆ—æœåŠ¡ã€‚</li><li><p><strong>å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</strong>å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${NAMESPACE}/state/failover/${JOB_NAME}/${TASK_META_INFO}</code>ï¼Œå­˜å‚¨å€¼ä¸ºä»»åŠ¡ç¼–å·ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">    [zk: localhost:2181(CONNECTED) 2] ls /elastic-job-cloud/state/failover/test_job_simple</div><div class="line">[test_job_simple@-@0]</div><div class="line">[zk: localhost:2181(CONNECTED) 3] get /elastic-job-cloud/state/failover/test_job_simple/test_job_simple@-@0</div><div class="line">test_job_simple@-@0@-@READY@-@4da72be3-43d5-4f02-9d7e-45feb30b8fcb-S2@-@8f2a5bb5-2941-4ece-b192-0f936e60faa7</div></pre></td></tr></table></figure></li><li><p>åœ¨è¿ç»´å¹³å°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_10/02.png" alt=""></p></li></ul><h1 id="3-æäº¤å¤±æ•ˆè½¬ç§»ä½œä¸š"><a href="#3-æäº¤å¤±æ•ˆè½¬ç§»ä½œä¸š" class="headerlink" title="3. æäº¤å¤±æ•ˆè½¬ç§»ä½œä¸š"></a>3. æäº¤å¤±æ•ˆè½¬ç§»ä½œä¸š</h1><p>åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹ã€Œ4.1 åˆ›å»º Fenzo ä»»åŠ¡è¯·æ±‚ã€</a>é‡Œï¼Œè°ƒç”¨ <code>FacadeService#getEligibleJobContext()</code> æ–¹æ³•ï¼Œè·å–æœ‰èµ„æ ¼è¿è¡Œçš„ä½œä¸šæ—¶ã€‚<code>FacadeService#getEligibleJobContext()</code> ä¸ä»…è°ƒç”¨ <code>ReadyService#getAllEligibleJobContexts(...)</code> æ–¹æ³•ï¼Œä»<strong>å¾…æ‰§è¡Œé˜Ÿåˆ—</strong>ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡ï¼Œä¹Ÿè°ƒç”¨ <code>FailoverService#getAllEligibleJobContexts()</code> æ–¹æ³•ï¼Œä»<strong>å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</strong>ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;JobContext&gt; <span class="title">getAllEligibleJobContexts</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ä¸å­˜åœ¨ å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</span></div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(FailoverNode.ROOT)) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è·å– å¤±æ•ˆè½¬ç§»é˜Ÿåˆ— çš„ä½œä¸šä»¬</span></div><div class="line">   List&lt;String&gt; jobNames = regCenter.getChildrenKeys(FailoverNode.ROOT);</div><div class="line">   Collection&lt;JobContext&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(jobNames.size());</div><div class="line">   Set&lt;HashCode&gt; assignedTasks = <span class="keyword">new</span> HashSet&lt;&gt;(jobNames.size() * <span class="number">10</span>, <span class="number">1</span>);</div><div class="line">   <span class="keyword">for</span> (String each : jobNames) &#123;</div><div class="line">       <span class="comment">// ä¸ºç©ºæ—¶ï¼Œç§»é™¤ å¤±æ•ˆè½¬ç§»é˜Ÿåˆ— çš„ä½œä¸š</span></div><div class="line">       List&lt;String&gt; taskIdList = regCenter.getChildrenKeys(FailoverNode.getFailoverJobNodePath(each));</div><div class="line">       <span class="keyword">if</span> (taskIdList.isEmpty()) &#123;</div><div class="line">           regCenter.remove(FailoverNode.getFailoverJobNodePath(each));</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// æ’é™¤ ä½œä¸šé…ç½® ä¸å­˜åœ¨çš„ä½œä¸š</span></div><div class="line">       Optional&lt;CloudJobConfiguration&gt; jobConfig = configService.load(each);</div><div class="line">       <span class="keyword">if</span> (!jobConfig.isPresent()) &#123;</div><div class="line">           regCenter.remove(FailoverNode.getFailoverJobNodePath(each));</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// è·å¾—å¾…æ‰§è¡Œçš„åˆ†ç‰‡é›†åˆ</span></div><div class="line">       List&lt;Integer&gt; assignedShardingItems = getAssignedShardingItems(each, taskIdList, assignedTasks);</div><div class="line">       <span class="comment">//</span></div><div class="line">       <span class="keyword">if</span> (!assignedShardingItems.isEmpty() &amp;&amp; jobConfig.isPresent()) &#123;</div><div class="line">           result.add(<span class="keyword">new</span> JobContext(jobConfig.get(), assignedShardingItems, ExecutionType.FAILOVER));    </div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> List&lt;Integer&gt; <span class="title">getAssignedShardingItems</span><span class="params">(<span class="keyword">final</span> String jobName, <span class="keyword">final</span> List&lt;String&gt; taskIdList, <span class="keyword">final</span> Set&lt;HashCode&gt; assignedTasks)</span> </span>&#123;</div><div class="line">   List&lt;Integer&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(taskIdList.size());</div><div class="line">   <span class="keyword">for</span> (String each : taskIdList) &#123;</div><div class="line">       TaskContext.MetaInfo metaInfo = TaskContext.MetaInfo.from(each);</div><div class="line">       <span class="keyword">if</span> (assignedTasks.add(Hashing.md5().newHasher().putString(jobName, Charsets.UTF_8).putInt(metaInfo.getShardingItems().get(<span class="number">0</span>)).hash()) <span class="comment">// æ’é‡</span></div><div class="line">               &amp;&amp; !runningService.isTaskRunning(metaInfo)) &#123; <span class="comment">// æ’é™¤æ­£åœ¨è¿è¡Œä¸­</span></div><div class="line">           result.add(metaInfo.getShardingItems().get(<span class="number">0</span>));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><hr><p>åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹ã€Œ4.4 åˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯ã€</a>é‡Œï¼Œè°ƒç”¨ <code>LaunchingTasks#getIntegrityViolationJobs()</code> æ–¹æ³•ï¼Œè·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LaunchingTasks.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> vmAssignmentResults ä¸»æœºåˆ†é…ä»»åŠ¡ç»“æœé›†åˆ</div><div class="line">* <span class="doctag">@return</span> ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</div><div class="line">*/</div><div class="line"><span class="function">Collection&lt;String&gt; <span class="title">getIntegrityViolationJobs</span><span class="params">(<span class="keyword">final</span> Collection&lt;VMAssignmentResult&gt; vmAssignmentResults)</span> </span>&#123;</div><div class="line">   Map&lt;String, Integer&gt; assignedJobShardingTotalCountMap = getAssignedJobShardingTotalCountMap(vmAssignmentResults);</div><div class="line">   Collection&lt;String&gt; result = <span class="keyword">new</span> HashSet&lt;&gt;(assignedJobShardingTotalCountMap.size(), <span class="number">1</span>);</div><div class="line">   <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : assignedJobShardingTotalCountMap.entrySet()) &#123;</div><div class="line">       JobContext jobContext = eligibleJobContextsMap.get(entry.getKey());</div><div class="line">       <span class="keyword">if</span> (ExecutionType.FAILOVER != jobContext.getType() <span class="comment">// ä¸åŒ…æ‹¬ FAILOVER æ‰§è¡Œç±»å‹çš„ä½œä¸š</span></div><div class="line">               &amp;&amp; !entry.getValue().equals(jobContext.getJobConfig().getTypeConfig().getCoreConfig().getShardingTotalCount())) &#123;</div><div class="line">           log.warn(<span class="string">"Job &#123;&#125; is not assigned at this time, because resources not enough to run all sharding instances."</span>, entry.getKey());</div><div class="line">           result.add(entry.getKey());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä¸€ä¸ªä½œä¸šå¯èƒ½å­˜åœ¨éƒ¨åˆ†åˆ†ç‰‡éœ€è¦å¤±æ•ˆè½¬ç§»ï¼Œä¸éœ€è¦è€ƒè™‘å®Œæ•´æ€§ã€‚</li></ul><hr><p>åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹ã€Œ4.7 ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸šã€</a>é‡Œï¼Œè°ƒç”¨ <code>FailoverService#remove(...)</code> æ–¹æ³•ï¼Œä»å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ä¸­åˆ é™¤ç›¸å…³ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> Collection&lt;TaskContext.MetaInfo&gt; metaInfoList)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (TaskContext.MetaInfo each : metaInfoList) &#123;</div><div class="line">       regCenter.remove(FailoverNode.getFailoverTaskNodePath(each.toString()));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>åŸæœ¬ä»¥ä¸ºä¼šæ˜¯ä¸€ç¯‡æ°´æ›´ï¼Œåé¢ç ”ç©¶ TASK_LOSTï¼Œå‘ç°æ”¶è·å¤§å¤§çš„ï¼Œå¹²è´§å¦¥å¦¥çš„ã€‚</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_10/03.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/Elastic-Job-Cloud/">Elastic-Job-Cloud</a></div><div class="article-share" id="share"><div data-url="http://www.iocoder.cn/Elastic-Job/cloud-job-failover/" data-title="Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§» | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/Elastic-Job/cloud-high-availability/" title="Elastic-Job-Cloud æºç åˆ†æ â€”â€” é«˜å¯ç”¨"><strong>PREVIOUS:</strong><br><span>Elastic-Job-Cloud æºç åˆ†æ â€”â€” é«˜å¯ç”¨</span></a></div><div class="next"><a href="/Elastic-Job/cloud-local-executor/" title="Elastic-Job-Cloud æºç åˆ†æ â€”â€” æœ¬åœ°è¿è¡Œæ¨¡å¼"><strong>NEXT:</strong><br><span>Elastic-Job-Cloud æºç åˆ†æ â€”â€” æœ¬åœ°è¿è¡Œæ¨¡å¼</span></a></div></nav></div></div><footer><div id="footer"><img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display:none"><p class="copyright">Â© 2017 <a href="http://www.iocoder.cn" target="_blank" title="ç‹æ–‡æ–Œ">ç‹æ–‡æ–Œ</a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a> && Powered by <a href="http://hexo.io" target="_blank" title="hexo" rel="external nofollow noopener noreferrer">hexo</a> && Theme by <a href="http://gengbiao.me" target="_blank" title="coney" rel="external nofollow noopener noreferrer">coney</a></p></div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2"),ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script src="/js/util.js"></script></body>