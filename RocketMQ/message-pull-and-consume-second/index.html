<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸‹ï¼‰ | èŠ‹è‰¿Vçš„åšå®¢</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="ç‹æ–‡æ–Œ"><meta name="description" content="ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘æœ‰ç¦åˆ©ï¼š  

RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨  
RocketMQ / MyCAT / Sharding-JDBC ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€  
æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚ç”šè‡³ä¸"><meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹è‰¿Vçš„åšå®¢" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?ef4ed89f6dc83d01803a2440ae21e666";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹è‰¿Vçš„åšå®¢">èŠ‹è‰¿Vçš„åšå®¢</a></h1><a class="blog-motto">æ„¿ç¼–ç åŠç”Ÿï¼Œå¦‚è€å‹ç›¸ä¼´ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li></ul></ul></nav></div></header><div id="container"><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1ã€æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1ã€æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2ã€Consumer"><span class="toc-number">2.</span> <span class="toc-text">2ã€Consumer</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3ã€PushConsumer-ä¸€è§ˆ"><span class="toc-number">3.</span> <span class="toc-text">3ã€PushConsumer ä¸€è§ˆ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4ã€PushConsumer-è®¢é˜…"><span class="toc-number">4.</span> <span class="toc-text">4ã€PushConsumer è®¢é˜…</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumerImpl-subscribe-â€¦"><span class="toc-number">4.1.</span> <span class="toc-text">DefaultMQPushConsumerImpl#subscribe(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FilterAPI-buildSubscriptionData-â€¦"><span class="toc-number">4.1.1.</span> <span class="toc-text">FilterAPI.buildSubscriptionData(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumer-registerMessageListener-â€¦"><span class="toc-number">4.2.</span> <span class="toc-text">DefaultMQPushConsumer#registerMessageListener(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5ã€PushConsumer-æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…"><span class="toc-number">5.</span> <span class="toc-text">5ã€PushConsumer æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RebalanceService"><span class="toc-number">5.1.</span> <span class="toc-text">RebalanceService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MQClientInstance-doRebalance-â€¦"><span class="toc-number">5.2.</span> <span class="toc-text">MQClientInstance#doRebalance(â€¦)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumerImpl-doRebalance-â€¦"><span class="toc-number">5.3.</span> <span class="toc-text">DefaultMQPushConsumerImpl#doRebalance(â€¦)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RebalanceImpl-doRebalance-â€¦"><span class="toc-number">5.4.</span> <span class="toc-text">RebalanceImpl#doRebalance(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RebalanceImpl-rebalanceByTopic-â€¦"><span class="toc-number">5.4.1.</span> <span class="toc-text">RebalanceImpl#rebalanceByTopic(â€¦)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RebalanceImpl-removeUnnecessaryMessageQueue-â€¦"><span class="toc-number">5.4.2.</span> <span class="toc-text">RebalanceImpl#removeUnnecessaryMessageQueue(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RebalancePushImpl-removeUnnecessaryMessageQueue-â€¦"><span class="toc-number">5.4.2.1.</span> <span class="toc-text">RebalancePushImpl#removeUnnecessaryMessageQueue(â€¦)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PullConsumer-RebalancePullImpl-removeUnnecessaryMessageQueue-â€¦"><span class="toc-number">5.4.2.2.</span> <span class="toc-text">[PullConsumer] RebalancePullImpl#removeUnnecessaryMessageQueue(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RebalancePushImpl-dispatchPullRequest-â€¦"><span class="toc-number">5.4.3.</span> <span class="toc-text">RebalancePushImpl#dispatchPullRequest(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DefaultMQPushConsumerImpl-executePullRequestImmediately-â€¦"><span class="toc-number">5.4.3.1.</span> <span class="toc-text">DefaultMQPushConsumerImpl#executePullRequestImmediately(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AllocateMessageQueueStrategy"><span class="toc-number">5.4.4.</span> <span class="toc-text">AllocateMessageQueueStrategy</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AllocateMessageQueueAveragely"><span class="toc-number">5.4.4.1.</span> <span class="toc-text">AllocateMessageQueueAveragely</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AllocateMessageQueueByMachineRoom"><span class="toc-number">5.4.4.2.</span> <span class="toc-text">AllocateMessageQueueByMachineRoom</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AllocateMessageQueueAveragelyByCircle"><span class="toc-number">5.4.4.3.</span> <span class="toc-text">AllocateMessageQueueAveragelyByCircle</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AllocateMessageQueueByConfig"><span class="toc-number">5.4.4.4.</span> <span class="toc-text">AllocateMessageQueueByConfig</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5ã€PushConsumer-æ¶ˆè´¹è¿›åº¦è¯»å–"><span class="toc-number">6.</span> <span class="toc-text">5ã€PushConsumer æ¶ˆè´¹è¿›åº¦è¯»å–</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RebalancePushImpl-computePullFromWhere-â€¦"><span class="toc-number">6.1.</span> <span class="toc-text">RebalancePushImpl#computePullFromWhere(â€¦)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PullConsumer-RebalancePullImpl-computePullFromWhere-â€¦"><span class="toc-number">6.2.</span> <span class="toc-text">[PullConsumer] RebalancePullImpl#computePullFromWhere(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6ã€PushConsumer-æ‹‰å–æ¶ˆæ¯"><span class="toc-number">7.</span> <span class="toc-text">6ã€PushConsumer æ‹‰å–æ¶ˆæ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PullMessageService"><span class="toc-number">7.1.</span> <span class="toc-text">PullMessageService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumerImpl-pullMessage-â€¦"><span class="toc-number">7.2.</span> <span class="toc-text">DefaultMQPushConsumerImpl#pullMessage(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PullAPIWrapper-pullKernelImpl-â€¦"><span class="toc-number">7.2.1.</span> <span class="toc-text">PullAPIWrapper#pullKernelImpl(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PullAPIWrapper-recalculatePullFromWhichNode-â€¦"><span class="toc-number">7.2.1.1.</span> <span class="toc-text">PullAPIWrapper#recalculatePullFromWhichNode(â€¦)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MQClientInstance-findBrokerAddressInSubscribe-â€¦"><span class="toc-number">7.2.1.2.</span> <span class="toc-text">MQClientInstance#findBrokerAddressInSubscribe(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PullAPIWrapper-processPullResult-â€¦"><span class="toc-number">7.2.2.</span> <span class="toc-text">PullAPIWrapper#processPullResult(â€¦)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProcessQueue-putMessage-â€¦"><span class="toc-number">7.2.3.</span> <span class="toc-text">ProcessQueue#putMessage(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ€»ç»“"><span class="toc-number">7.3.</span> <span class="toc-text">æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6ã€PushConsumer-æ¶ˆè´¹æ¶ˆæ¯"><span class="toc-number">8.</span> <span class="toc-text">6ã€PushConsumer æ¶ˆè´¹æ¶ˆæ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-æäº¤æ¶ˆè´¹è¯·æ±‚"><span class="toc-number">8.1.</span> <span class="toc-text">ConsumeMessageConcurrentlyService æäº¤æ¶ˆè´¹è¯·æ±‚</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-submitConsumeRequest-â€¦"><span class="toc-number">8.1.1.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#submitConsumeRequest(â€¦)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-submitConsumeRequestLater"><span class="toc-number">8.1.2.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#submitConsumeRequestLater</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumeRequest"><span class="toc-number">8.2.</span> <span class="toc-text">ConsumeRequest</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-processConsumeResult-â€¦"><span class="toc-number">8.3.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#processConsumeResult(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ProcessQueue-removeMessage-â€¦"><span class="toc-number">8.3.1.</span> <span class="toc-text">ProcessQueue#removeMessage(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-cleanExpireMsg-â€¦"><span class="toc-number">8.4.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#cleanExpireMsg(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ProcessQueue-cleanExpiredMsg-â€¦"><span class="toc-number">8.4.1.</span> <span class="toc-text">ProcessQueue#cleanExpiredMsg(â€¦)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7ã€PushConsumer-å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯"><span class="toc-number">9.</span> <span class="toc-text">7ã€PushConsumer å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumerImpl-sendMessageBack-â€¦"><span class="toc-number">9.1.</span> <span class="toc-text">DefaultMQPushConsumerImpl#sendMessageBack(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MQClientAPIImpl-consumerSendMessageBack-â€¦"><span class="toc-number">9.1.1.</span> <span class="toc-text">MQClientAPIImpl#consumerSendMessageBack(â€¦)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8ã€Consumer-æ¶ˆè´¹è¿›åº¦"><span class="toc-number">10.</span> <span class="toc-text">8ã€Consumer æ¶ˆè´¹è¿›åº¦</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#OffsetStore"><span class="toc-number">10.1.</span> <span class="toc-text">OffsetStore</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OffsetStore-load-â€¦"><span class="toc-number">10.1.1.</span> <span class="toc-text">OffsetStore#load(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LocalFileOffsetStore-load-â€¦"><span class="toc-number">10.1.1.1.</span> <span class="toc-text">LocalFileOffsetStore#load(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#OffsetSerializeWrapper"><span class="toc-number">10.1.1.1.1.</span> <span class="toc-text">OffsetSerializeWrapper</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RemoteBrokerOffsetStore-load-â€¦"><span class="toc-number">10.1.1.2.</span> <span class="toc-text">RemoteBrokerOffsetStore#load(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OffsetStore-readOffset-â€¦"><span class="toc-number">10.1.2.</span> <span class="toc-text">OffsetStore#readOffset(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LocalFileOffsetStore-readOffset-â€¦"><span class="toc-number">10.1.2.1.</span> <span class="toc-text">LocalFileOffsetStore#readOffset(â€¦)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RemoteBrokerOffsetStore-readOffset-â€¦"><span class="toc-number">10.1.2.2.</span> <span class="toc-text">RemoteBrokerOffsetStore#readOffset(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OffsetStore-updateOffset-â€¦"><span class="toc-number">10.1.3.</span> <span class="toc-text">OffsetStore#updateOffset(â€¦)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OffsetStore-persistAll-â€¦"><span class="toc-number">10.1.4.</span> <span class="toc-text">OffsetStore#persistAll(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LocalFileOffsetStore-persistAll-â€¦"><span class="toc-number">10.1.4.1.</span> <span class="toc-text">LocalFileOffsetStore#persistAll(â€¦)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RemoteBrokerOffsetStore-persistAll-â€¦"><span class="toc-number">10.1.4.2.</span> <span class="toc-text">RemoteBrokerOffsetStore#persistAll(â€¦)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MQClientInstance-persistAllConsumerOffset-â€¦"><span class="toc-number">10.1.4.3.</span> <span class="toc-text">MQClientInstance#persistAllConsumerOffset(â€¦)</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9ã€ç»“å°¾"><span class="toc-number">11.</span> <span class="toc-text">9ã€ç»“å°¾</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/Elastic-Job/" title="Elastic-Job">Elastic-Job<sup>1</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/æŠ€æœ¯æ‚æ–‡/" title="æŠ€æœ¯æ‚æ–‡">æŠ€æœ¯æ‚æ–‡<sup>2</sup></a></li></ul></div></aside></div><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/RocketMQ/message-pull-and-consume-second/" title="RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸‹ï¼‰" itemprop="url">RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸‹ï¼‰</a></h1><p class="article-author"></p><p class="article-time">æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><div id="toc" class="toc-article"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1ã€æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1ã€æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2ã€Consumer"><span class="toc-number">2.</span> <span class="toc-text">2ã€Consumer</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3ã€PushConsumer-ä¸€è§ˆ"><span class="toc-number">3.</span> <span class="toc-text">3ã€PushConsumer ä¸€è§ˆ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4ã€PushConsumer-è®¢é˜…"><span class="toc-number">4.</span> <span class="toc-text">4ã€PushConsumer è®¢é˜…</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumerImpl-subscribe-â€¦"><span class="toc-number">4.1.</span> <span class="toc-text">DefaultMQPushConsumerImpl#subscribe(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FilterAPI-buildSubscriptionData-â€¦"><span class="toc-number">4.1.1.</span> <span class="toc-text">FilterAPI.buildSubscriptionData(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumer-registerMessageListener-â€¦"><span class="toc-number">4.2.</span> <span class="toc-text">DefaultMQPushConsumer#registerMessageListener(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5ã€PushConsumer-æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…"><span class="toc-number">5.</span> <span class="toc-text">5ã€PushConsumer æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RebalanceService"><span class="toc-number">5.1.</span> <span class="toc-text">RebalanceService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MQClientInstance-doRebalance-â€¦"><span class="toc-number">5.2.</span> <span class="toc-text">MQClientInstance#doRebalance(â€¦)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumerImpl-doRebalance-â€¦"><span class="toc-number">5.3.</span> <span class="toc-text">DefaultMQPushConsumerImpl#doRebalance(â€¦)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RebalanceImpl-doRebalance-â€¦"><span class="toc-number">5.4.</span> <span class="toc-text">RebalanceImpl#doRebalance(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RebalanceImpl-rebalanceByTopic-â€¦"><span class="toc-number">5.4.1.</span> <span class="toc-text">RebalanceImpl#rebalanceByTopic(â€¦)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RebalanceImpl-removeUnnecessaryMessageQueue-â€¦"><span class="toc-number">5.4.2.</span> <span class="toc-text">RebalanceImpl#removeUnnecessaryMessageQueue(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RebalancePushImpl-removeUnnecessaryMessageQueue-â€¦"><span class="toc-number">5.4.2.1.</span> <span class="toc-text">RebalancePushImpl#removeUnnecessaryMessageQueue(â€¦)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PullConsumer-RebalancePullImpl-removeUnnecessaryMessageQueue-â€¦"><span class="toc-number">5.4.2.2.</span> <span class="toc-text">[PullConsumer] RebalancePullImpl#removeUnnecessaryMessageQueue(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RebalancePushImpl-dispatchPullRequest-â€¦"><span class="toc-number">5.4.3.</span> <span class="toc-text">RebalancePushImpl#dispatchPullRequest(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DefaultMQPushConsumerImpl-executePullRequestImmediately-â€¦"><span class="toc-number">5.4.3.1.</span> <span class="toc-text">DefaultMQPushConsumerImpl#executePullRequestImmediately(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AllocateMessageQueueStrategy"><span class="toc-number">5.4.4.</span> <span class="toc-text">AllocateMessageQueueStrategy</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AllocateMessageQueueAveragely"><span class="toc-number">5.4.4.1.</span> <span class="toc-text">AllocateMessageQueueAveragely</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AllocateMessageQueueByMachineRoom"><span class="toc-number">5.4.4.2.</span> <span class="toc-text">AllocateMessageQueueByMachineRoom</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AllocateMessageQueueAveragelyByCircle"><span class="toc-number">5.4.4.3.</span> <span class="toc-text">AllocateMessageQueueAveragelyByCircle</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AllocateMessageQueueByConfig"><span class="toc-number">5.4.4.4.</span> <span class="toc-text">AllocateMessageQueueByConfig</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5ã€PushConsumer-æ¶ˆè´¹è¿›åº¦è¯»å–"><span class="toc-number">6.</span> <span class="toc-text">5ã€PushConsumer æ¶ˆè´¹è¿›åº¦è¯»å–</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RebalancePushImpl-computePullFromWhere-â€¦"><span class="toc-number">6.1.</span> <span class="toc-text">RebalancePushImpl#computePullFromWhere(â€¦)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PullConsumer-RebalancePullImpl-computePullFromWhere-â€¦"><span class="toc-number">6.2.</span> <span class="toc-text">[PullConsumer] RebalancePullImpl#computePullFromWhere(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6ã€PushConsumer-æ‹‰å–æ¶ˆæ¯"><span class="toc-number">7.</span> <span class="toc-text">6ã€PushConsumer æ‹‰å–æ¶ˆæ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PullMessageService"><span class="toc-number">7.1.</span> <span class="toc-text">PullMessageService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumerImpl-pullMessage-â€¦"><span class="toc-number">7.2.</span> <span class="toc-text">DefaultMQPushConsumerImpl#pullMessage(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PullAPIWrapper-pullKernelImpl-â€¦"><span class="toc-number">7.2.1.</span> <span class="toc-text">PullAPIWrapper#pullKernelImpl(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PullAPIWrapper-recalculatePullFromWhichNode-â€¦"><span class="toc-number">7.2.1.1.</span> <span class="toc-text">PullAPIWrapper#recalculatePullFromWhichNode(â€¦)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MQClientInstance-findBrokerAddressInSubscribe-â€¦"><span class="toc-number">7.2.1.2.</span> <span class="toc-text">MQClientInstance#findBrokerAddressInSubscribe(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PullAPIWrapper-processPullResult-â€¦"><span class="toc-number">7.2.2.</span> <span class="toc-text">PullAPIWrapper#processPullResult(â€¦)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProcessQueue-putMessage-â€¦"><span class="toc-number">7.2.3.</span> <span class="toc-text">ProcessQueue#putMessage(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ€»ç»“"><span class="toc-number">7.3.</span> <span class="toc-text">æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6ã€PushConsumer-æ¶ˆè´¹æ¶ˆæ¯"><span class="toc-number">8.</span> <span class="toc-text">6ã€PushConsumer æ¶ˆè´¹æ¶ˆæ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-æäº¤æ¶ˆè´¹è¯·æ±‚"><span class="toc-number">8.1.</span> <span class="toc-text">ConsumeMessageConcurrentlyService æäº¤æ¶ˆè´¹è¯·æ±‚</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-submitConsumeRequest-â€¦"><span class="toc-number">8.1.1.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#submitConsumeRequest(â€¦)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-submitConsumeRequestLater"><span class="toc-number">8.1.2.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#submitConsumeRequestLater</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumeRequest"><span class="toc-number">8.2.</span> <span class="toc-text">ConsumeRequest</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-processConsumeResult-â€¦"><span class="toc-number">8.3.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#processConsumeResult(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ProcessQueue-removeMessage-â€¦"><span class="toc-number">8.3.1.</span> <span class="toc-text">ProcessQueue#removeMessage(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-cleanExpireMsg-â€¦"><span class="toc-number">8.4.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#cleanExpireMsg(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ProcessQueue-cleanExpiredMsg-â€¦"><span class="toc-number">8.4.1.</span> <span class="toc-text">ProcessQueue#cleanExpiredMsg(â€¦)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7ã€PushConsumer-å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯"><span class="toc-number">9.</span> <span class="toc-text">7ã€PushConsumer å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumerImpl-sendMessageBack-â€¦"><span class="toc-number">9.1.</span> <span class="toc-text">DefaultMQPushConsumerImpl#sendMessageBack(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MQClientAPIImpl-consumerSendMessageBack-â€¦"><span class="toc-number">9.1.1.</span> <span class="toc-text">MQClientAPIImpl#consumerSendMessageBack(â€¦)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8ã€Consumer-æ¶ˆè´¹è¿›åº¦"><span class="toc-number">10.</span> <span class="toc-text">8ã€Consumer æ¶ˆè´¹è¿›åº¦</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#OffsetStore"><span class="toc-number">10.1.</span> <span class="toc-text">OffsetStore</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OffsetStore-load-â€¦"><span class="toc-number">10.1.1.</span> <span class="toc-text">OffsetStore#load(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LocalFileOffsetStore-load-â€¦"><span class="toc-number">10.1.1.1.</span> <span class="toc-text">LocalFileOffsetStore#load(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#OffsetSerializeWrapper"><span class="toc-number">10.1.1.1.1.</span> <span class="toc-text">OffsetSerializeWrapper</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RemoteBrokerOffsetStore-load-â€¦"><span class="toc-number">10.1.1.2.</span> <span class="toc-text">RemoteBrokerOffsetStore#load(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OffsetStore-readOffset-â€¦"><span class="toc-number">10.1.2.</span> <span class="toc-text">OffsetStore#readOffset(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LocalFileOffsetStore-readOffset-â€¦"><span class="toc-number">10.1.2.1.</span> <span class="toc-text">LocalFileOffsetStore#readOffset(â€¦)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RemoteBrokerOffsetStore-readOffset-â€¦"><span class="toc-number">10.1.2.2.</span> <span class="toc-text">RemoteBrokerOffsetStore#readOffset(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OffsetStore-updateOffset-â€¦"><span class="toc-number">10.1.3.</span> <span class="toc-text">OffsetStore#updateOffset(â€¦)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OffsetStore-persistAll-â€¦"><span class="toc-number">10.1.4.</span> <span class="toc-text">OffsetStore#persistAll(â€¦)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LocalFileOffsetStore-persistAll-â€¦"><span class="toc-number">10.1.4.1.</span> <span class="toc-text">LocalFileOffsetStore#persistAll(â€¦)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RemoteBrokerOffsetStore-persistAll-â€¦"><span class="toc-number">10.1.4.2.</span> <span class="toc-text">RemoteBrokerOffsetStore#persistAll(â€¦)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MQClientInstance-persistAllConsumerOffset-â€¦"><span class="toc-number">10.1.4.3.</span> <span class="toc-text">MQClientInstance#persistAllConsumerOffset(â€¦)</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9ã€ç»“å°¾"><span class="toc-number">11.</span> <span class="toc-text">9ã€ç»“å°¾</span></a></li></ol></div><p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><ul><li><a href="#">1ã€æ¦‚è¿°</a></li><li><a href="#">2ã€Consumer</a></li><li><a href="#">3ã€PushConsumer ä¸€è§ˆ</a></li><li><a href="#">4ã€PushConsumer è®¢é˜…</a><ul><li><a href="#">DefaultMQPushConsumerImpl#subscribe(â€¦)</a><ul><li><a href="#">FilterAPI.buildSubscriptionData(â€¦)</a></li></ul></li><li><a href="#">DefaultMQPushConsumer#registerMessageListener(â€¦)</a></li></ul></li><li><a href="#">5ã€PushConsumer æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…</a><ul><li><a href="#">RebalanceService</a></li><li><a href="#">MQClientInstance#doRebalance(â€¦)</a></li><li><a href="#">DefaultMQPushConsumerImpl#doRebalance(â€¦)</a></li><li><a href="#">RebalanceImpl#doRebalance(â€¦)</a><ul><li><a href="#">RebalanceImpl#rebalanceByTopic(â€¦)</a></li><li><a href="#">RebalanceImpl#removeUnnecessaryMessageQueue(â€¦)</a><ul><li><a href="#">RebalancePushImpl#removeUnnecessaryMessageQueue(â€¦)</a></li><li><a href="#">[PullConsumer] RebalancePullImpl#removeUnnecessaryMessageQueue(â€¦)</a></li></ul></li><li><a href="#">RebalancePushImpl#dispatchPullRequest(â€¦)</a><ul><li><a href="#">DefaultMQPushConsumerImpl#executePullRequestImmediately(â€¦)</a></li></ul></li><li><a href="#">AllocateMessageQueueStrategy</a><ul><li><a href="#">AllocateMessageQueueAveragely</a></li><li><a href="#">AllocateMessageQueueByMachineRoom</a></li><li><a href="#">AllocateMessageQueueAveragelyByCircle</a></li><li><a href="#">AllocateMessageQueueByConfig</a></li></ul></li></ul></li></ul></li><li><a href="#">5ã€PushConsumer æ¶ˆè´¹è¿›åº¦è¯»å–</a><ul><li><a href="#">RebalancePushImpl#computePullFromWhere(â€¦)</a></li><li><a href="#">[PullConsumer] RebalancePullImpl#computePullFromWhere(â€¦)</a></li></ul></li><li><a href="#">6ã€PushConsumer æ‹‰å–æ¶ˆæ¯</a><ul><li><a href="#">PullMessageService</a></li><li><a href="#">DefaultMQPushConsumerImpl#pullMessage(â€¦)</a><ul><li><a href="#">PullAPIWrapper#pullKernelImpl(â€¦)</a><ul><li><a href="#">PullAPIWrapper#recalculatePullFromWhichNode(â€¦)</a></li><li><a href="#">MQClientInstance#findBrokerAddressInSubscribe(â€¦)</a></li></ul></li><li><a href="#">PullAPIWrapper#processPullResult(â€¦)</a></li><li><a href="#">ProcessQueue#putMessage(â€¦)</a></li></ul></li><li><a href="#">æ€»ç»“</a></li></ul></li><li><a href="#">6ã€PushConsumer æ¶ˆè´¹æ¶ˆæ¯</a><ul><li><a href="#">ConsumeMessageConcurrentlyService æäº¤æ¶ˆè´¹è¯·æ±‚</a><ul><li><a href="#">ConsumeMessageConcurrentlyService#submitConsumeRequest(â€¦)</a></li><li><a href="#">ConsumeMessageConcurrentlyService#submitConsumeRequestLater</a></li></ul></li><li><a href="#">ConsumeRequest</a></li><li><a href="#">ConsumeMessageConcurrentlyService#processConsumeResult(â€¦)</a><ul><li><a href="#">ProcessQueue#removeMessage(â€¦)</a></li></ul></li><li><a href="#">ConsumeMessageConcurrentlyService#cleanExpireMsg(â€¦)</a><ul><li><a href="#">ProcessQueue#cleanExpiredMsg(â€¦)</a></li></ul></li></ul></li><li><a href="#">7ã€PushConsumer å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯</a><ul><li><a href="#">DefaultMQPushConsumerImpl#sendMessageBack(â€¦)</a><ul><li><a href="#">MQClientAPIImpl#consumerSendMessageBack(â€¦)</a></li></ul></li></ul></li><li><a href="#">8ã€Consumer æ¶ˆè´¹è¿›åº¦</a><ul><li><a href="#">OffsetStore</a><ul><li><a href="#">OffsetStore#load(â€¦)</a><ul><li><a href="#">LocalFileOffsetStore#load(â€¦)</a><ul><li><a href="#">OffsetSerializeWrapper</a></li></ul></li><li><a href="#">RemoteBrokerOffsetStore#load(â€¦)</a></li></ul></li><li><a href="#">OffsetStore#readOffset(â€¦)</a><ul><li><a href="#">LocalFileOffsetStore#readOffset(â€¦)</a></li><li><a href="#">RemoteBrokerOffsetStore#readOffset(â€¦)</a></li></ul></li><li><a href="#">OffsetStore#updateOffset(â€¦)</a></li><li><a href="#">OffsetStore#persistAll(â€¦)</a><ul><li><a href="#">LocalFileOffsetStore#persistAll(â€¦)</a></li><li><a href="#">RemoteBrokerOffsetStore#persistAll(â€¦)</a></li><li><a href="#">MQClientInstance#persistAllConsumerOffset(â€¦)</a></li></ul></li></ul></li></ul></li><li><a href="#">9ã€ç»“å°¾</a></li></ul><hr><h1 id="1ã€æ¦‚è¿°"><a href="#1ã€æ¦‚è¿°" class="headerlink" title="1ã€æ¦‚è¿°"></a>1ã€æ¦‚è¿°</h1><p>æœ¬æ–‡æ¥ï¼š<a href="http://www.yunai.me/RocketMQ/message-pull-and-consume-first/">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰ã€‹</a>ã€‚</p><p>ä¸»è¦è§£æ <code>Consumer</code> åœ¨ <strong>æ¶ˆè´¹</strong> é€»è¾‘æ¶‰åŠåˆ°çš„æºç ã€‚</p><h1 id="2ã€Consumer"><a href="#2ã€Consumer" class="headerlink" title="2ã€Consumer"></a>2ã€Consumer</h1><p>MQ æä¾›äº†ä¸¤ç±»æ¶ˆè´¹è€…ï¼š</p><ul><li>PushConsumerï¼š<ul><li>åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹ä½¿ç”¨ã€‚</li><li>åå­—è™½ç„¶æ˜¯ <code>Push</code> å¼€å¤´ï¼Œå®é™…åœ¨å®ç°æ—¶ï¼Œä½¿ç”¨ <code>Pull</code> æ–¹å¼å®ç°ã€‚é€šè¿‡ <code>Pull</code> <strong>ä¸æ–­ä¸æ–­ä¸æ–­</strong>è½®è¯¢ <code>Broker</code> è·å–æ¶ˆæ¯ã€‚å½“ä¸å­˜åœ¨æ–°æ¶ˆæ¯æ—¶ï¼Œ<code>Broker</code> ä¼š<strong>æŒ‚èµ·è¯·æ±‚</strong>ï¼Œç›´åˆ°æœ‰æ–°æ¶ˆæ¯äº§ç”Ÿï¼Œå–æ¶ˆæŒ‚èµ·ï¼Œè¿”å›æ–°æ¶ˆæ¯ã€‚è¿™æ ·ï¼ŒåŸºæœ¬å’Œ <code>Broker</code> ä¸»åŠ¨ <code>Push</code> åšåˆ°<strong>æ¥è¿‘</strong>çš„å®æ—¶æ€§ï¼ˆå½“ç„¶ï¼Œè¿˜æ˜¯æœ‰ç›¸åº”çš„å®æ—¶æ€§æŸå¤±ï¼‰ã€‚åŸç†ç±»ä¼¼ <strong><a href="https://www.ibm.com/developerworks/cn/web/wa-lo-comet/" rel="external nofollow noopener noreferrer" target="_blank">é•¿è½®è¯¢( <code>Long-Polling</code> )</a></strong>ã€‚</li></ul></li><li>PullConsumer</li></ul><p><strong>æœ¬æ–‡ä¸»è¦è®²è§£<code>PushConsumer</code>ï¼Œéƒ¨åˆ†è®²è§£<code>PullConsumer</code>ï¼Œè·³è¿‡<code>é¡ºåºæ¶ˆè´¹</code>ã€‚</strong><br><strong>æœ¬æ–‡ä¸»è¦è®²è§£<code>PushConsumer</code>ï¼Œéƒ¨åˆ†è®²è§£<code>PullConsumer</code>ï¼Œè·³è¿‡<code>é¡ºåºæ¶ˆè´¹</code>ã€‚</strong><br><strong>æœ¬æ–‡ä¸»è¦è®²è§£<code>PushConsumer</code>ï¼Œéƒ¨åˆ†è®²è§£<code>PullConsumer</code>ï¼Œè·³è¿‡<code>é¡ºåºæ¶ˆè´¹</code>ã€‚</strong></p><h1 id="3ã€PushConsumer-ä¸€è§ˆ"><a href="#3ã€PushConsumer-ä¸€è§ˆ" class="headerlink" title="3ã€PushConsumer ä¸€è§ˆ"></a>3ã€PushConsumer ä¸€è§ˆ</h1><p>å…ˆçœ‹ä¸€å¼  <code>PushConsumer</code> åŒ…å«çš„ç»„ä»¶ä»¥åŠç»„ä»¶ä¹‹é—´çš„äº¤äº’å›¾ï¼š</p><p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/09.png" alt="PushConsumeræ‰‹ç»˜å›¾.png"></p><ul><li><code>RebalanceService</code>ï¼šå‡è¡¡æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œè´Ÿè´£åˆ†é…å½“å‰ <code>Consumer</code> å¯æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>MessageQueue</code> )ã€‚å½“æœ‰æ–°çš„ <code>Consumer</code> çš„åŠ å…¥æˆ–ç§»é™¤ï¼Œéƒ½ä¼šé‡æ–°åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li><li><code>PullMessageService</code>ï¼šæ‹‰å–æ¶ˆæ¯æœåŠ¡ï¼Œ<strong>ä¸æ–­ä¸æ–­ä¸æ–­</strong>ä» <code>Broker</code> æ‹‰å–æ¶ˆæ¯ï¼Œå¹¶æäº¤æ¶ˆè´¹ä»»åŠ¡åˆ° <code>ConsumeMessageService</code>ã€‚</li><li><code>ConsumeMessageService</code>ï¼šæ¶ˆè´¹æ¶ˆæ¯æœåŠ¡ï¼Œ<strong>ä¸æ–­ä¸æ–­ä¸æ–­</strong>æ¶ˆè´¹æ¶ˆæ¯ï¼Œå¹¶å¤„ç†æ¶ˆè´¹ç»“æœã€‚</li><li><code>RemoteBrokerOffsetStore</code>ï¼š<code>Consumer</code> æ¶ˆè´¹è¿›åº¦ç®¡ç†ï¼Œè´Ÿè´£ä» <code>Broker</code> è·å–æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ° <code>Broker</code>ã€‚</li><li><code>ProcessQueue</code> ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ã€‚</li><li><code>MQClientInstance</code> ï¼šå°è£…å¯¹ <code>Namesrv</code>ï¼Œ<code>Broker</code> çš„ APIè°ƒç”¨ï¼Œæä¾›ç»™ <code>Producer</code>ã€<code>Consumer</code> ä½¿ç”¨ã€‚</li></ul><h1 id="4ã€PushConsumer-è®¢é˜…"><a href="#4ã€PushConsumer-è®¢é˜…" class="headerlink" title="4ã€PushConsumer è®¢é˜…"></a>4ã€PushConsumer è®¢é˜…</h1><h2 id="DefaultMQPushConsumerImpl-subscribe-â€¦"><a href="#DefaultMQPushConsumerImpl-subscribe-â€¦" class="headerlink" title="DefaultMQPushConsumerImpl#subscribe(â€¦)"></a>DefaultMQPushConsumerImpl#subscribe(â€¦)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(String topic, String subExpression)</span> <span class="keyword">throws</span> MQClientException </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">3</span>:         <span class="comment">// åˆ›å»ºè®¢é˜…æ•°æ®</span></div><div class="line"> <span class="number">4</span>:         SubscriptionData subscriptionData = FilterAPI.buildSubscriptionData(<span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup(), <span class="comment">//</span></div><div class="line"> <span class="number">5</span>:             topic, subExpression);</div><div class="line"> <span class="number">6</span>:         <span class="keyword">this</span>.rebalanceImpl.getSubscriptionInner().put(topic, subscriptionData);</div><div class="line"> <span class="number">7</span>:         <span class="comment">// é€šè¿‡å¿ƒè·³åŒæ­¥Consumerä¿¡æ¯åˆ°Broker</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.mQClientFactory != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">9</span>:             <span class="keyword">this</span>.mQClientFactory.sendHeartbeatToAllBrokerWithLock();</div><div class="line"><span class="number">10</span>:         &#125;</div><div class="line"><span class="number">11</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">12</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"subscription exception"</span>, e);</div><div class="line"><span class="number">13</span>:     &#125;</div><div class="line"><span class="number">14</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šè®¢é˜… <code>Topic</code> ã€‚</li><li>ç¬¬ 3 è‡³ 6 è¡Œ ï¼šåˆ›å»ºè®¢é˜…æ•°æ®ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#filterapibuildsubscriptiondata">FilterAPI.buildSubscriptionData(â€¦)</a>ã€‚</li><li>ç¬¬ 7 è‡³ 10 è¡Œ ï¼šé€šè¿‡å¿ƒè·³åŒæ­¥ <code>Consumer</code> ä¿¡æ¯åˆ° <code>Broker</code>ã€‚</li></ul><h3 id="FilterAPI-buildSubscriptionData-â€¦"><a href="#FilterAPI-buildSubscriptionData-â€¦" class="headerlink" title="FilterAPI.buildSubscriptionData(â€¦)"></a>FilterAPI.buildSubscriptionData(â€¦)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SubscriptionData <span class="title">buildSubscriptionData</span><span class="params">(<span class="keyword">final</span> String consumerGroup, String topic,</span></span></div><div class="line"> <span class="number">2</span>:     String subString) <span class="keyword">throws</span> Exception &#123;</div><div class="line"> <span class="number">3</span>:     SubscriptionData subscriptionData = <span class="keyword">new</span> SubscriptionData();</div><div class="line"> <span class="number">4</span>:     subscriptionData.setTopic(topic);</div><div class="line"> <span class="number">5</span>:     subscriptionData.setSubString(subString);</div><div class="line"> <span class="number">6</span>:     <span class="comment">// å¤„ç†è®¢é˜…è¡¨è¾¾å¼</span></div><div class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == subString || subString.equals(SubscriptionData.SUB_ALL) || subString.length() == <span class="number">0</span>) &#123;</div><div class="line"> <span class="number">8</span>:         subscriptionData.setSubString(SubscriptionData.SUB_ALL);</div><div class="line"> <span class="number">9</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">10</span>:         String[] tags = subString.split(<span class="string">"\\|\\|"</span>);</div><div class="line"><span class="number">11</span>:         <span class="keyword">if</span> (tags.length &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">12</span>:             <span class="keyword">for</span> (String tag : tags) &#123;</div><div class="line"><span class="number">13</span>:                 <span class="keyword">if</span> (tag.length() &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">14</span>:                     String trimString = tag.trim();</div><div class="line"><span class="number">15</span>:                     <span class="keyword">if</span> (trimString.length() &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">16</span>:                         subscriptionData.getTagsSet().add(trimString);</div><div class="line"><span class="number">17</span>:                         subscriptionData.getCodeSet().add(trimString.hashCode());</div><div class="line"><span class="number">18</span>:                     &#125;</div><div class="line"><span class="number">19</span>:                 &#125;</div><div class="line"><span class="number">20</span>:             &#125;</div><div class="line"><span class="number">21</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">22</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"subString split error"</span>);</div><div class="line"><span class="number">23</span>:         &#125;</div><div class="line"><span class="number">24</span>:     &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:     <span class="keyword">return</span> subscriptionData;</div><div class="line"><span class="number">27</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šæ ¹æ® <code>Topic</code> å’Œ è®¢é˜…è¡¨è¾¾å¼ åˆ›å»ºè®¢é˜…æ•°æ®</li><li>subscriptionData.subVersion = System.currentTimeMillis()ã€‚</li></ul><h2 id="DefaultMQPushConsumer-registerMessageListener-â€¦"><a href="#DefaultMQPushConsumer-registerMessageListener-â€¦" class="headerlink" title="DefaultMQPushConsumer#registerMessageListener(â€¦)"></a>DefaultMQPushConsumer#registerMessageListener(â€¦)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerMessageListener</span><span class="params">(MessageListenerConcurrently messageListener)</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     <span class="keyword">this</span>.messageListener = messageListener;</div><div class="line"><span class="number">3</span>:     <span class="keyword">this</span>.defaultMQPushConsumerImpl.registerMessageListener(messageListener);</div><div class="line"><span class="number">4</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šæ³¨å†Œæ¶ˆæ¯ç›‘å¬å™¨ã€‚</li></ul><h1 id="5ã€PushConsumer-æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…"><a href="#5ã€PushConsumer-æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…" class="headerlink" title="5ã€PushConsumer æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…"></a>5ã€PushConsumer æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…</h1><p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/10.png" alt="RebalanceService&amp;PushConsumeråˆ†é…é˜Ÿåˆ—"></p><h2 id="RebalanceService"><a href="#RebalanceService" class="headerlink" title="RebalanceService"></a>RebalanceService</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RebalanceService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"> 4:      * ç­‰å¾…é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’</div><div class="line"> 5:      */</div><div class="line"> <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> waitInterval =</div><div class="line"> <span class="number">7</span>:         Long.parseLong(System.getProperty(</div><div class="line"> <span class="number">8</span>:             <span class="string">"rocketmq.client.rebalance.waitInterval"</span>, <span class="string">"20000"</span>));</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Logger log = ClientLogger.getLog();</div><div class="line"><span class="number">11</span>:     <span class="comment">/**</span></div><div class="line">12:      * MQClientå¯¹è±¡</div><div class="line">13:      */</div><div class="line"><span class="number">14</span>:     <span class="keyword">private</span> <span class="keyword">final</span> MQClientInstance mqClientFactory;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>:     <span class="function"><span class="keyword">public</span> <span class="title">RebalanceService</span><span class="params">(MQClientInstance mqClientFactory)</span> </span>&#123;</div><div class="line"><span class="number">17</span>:         <span class="keyword">this</span>.mqClientFactory = mqClientFactory;</div><div class="line"><span class="number">18</span>:     &#125;</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">21</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">22</span>:         log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service started"</span>);</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:         <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</div><div class="line"><span class="number">25</span>:             <span class="keyword">this</span>.waitForRunning(waitInterval);</div><div class="line"><span class="number">26</span>:             <span class="keyword">this</span>.mqClientFactory.doRebalance();</div><div class="line"><span class="number">27</span>:         &#125;</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>:         log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service end"</span>);</div><div class="line"><span class="number">30</span>:     &#125;</div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">33</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getServiceName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">34</span>:         <span class="keyword">return</span> RebalanceService.class.getSimpleName();</div><div class="line"><span class="number">35</span>:     &#125;</div><div class="line"><span class="number">36</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šå‡è¡¡æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œè´Ÿè´£åˆ†é…å½“å‰ <code>Consumer</code> å¯æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>MessageQueue</code> )ã€‚</li><li><p>ç¬¬ 26 è¡Œ ï¼šè°ƒç”¨ <code>MQClientInstance#doRebalance(...)</code> åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚ç›®å‰æœ‰ä¸‰ç§æƒ…å†µæƒ…å†µä¸‹è§¦å‘ï¼š</p><ul><li>å¦‚ <code>ç¬¬ 25 è¡Œ</code> ç­‰å¾…è¶…æ—¶ï¼Œæ¯ 20s è°ƒç”¨ä¸€æ¬¡ã€‚</li><li><code>PushConsumer</code> å¯åŠ¨æ—¶ï¼Œè°ƒç”¨ <code>rebalanceService#wakeup(...)</code> è§¦å‘ã€‚</li><li><code>Broker</code> é€šçŸ¥ <code>Consumer</code> åŠ å…¥ æˆ– ç§»é™¤æ—¶ï¼Œ<code>Consumer</code> å“åº”é€šçŸ¥ï¼Œè°ƒç”¨ <code>rebalanceService#wakeup(...)</code> è§¦å‘ã€‚</li></ul><p>è¯¦ç»†è§£æè§ï¼š<a href="#mqclientinstancedorebalance">MQClientInstance#doRebalance(â€¦)</a>ã€‚</p></li></ul><h2 id="MQClientInstance-doRebalance-â€¦"><a href="#MQClientInstance-doRebalance-â€¦" class="headerlink" title="MQClientInstance#doRebalance(â€¦)"></a>MQClientInstance#doRebalance(â€¦)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRebalance</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">for</span> (Map.Entry&lt;String, MQConsumerInner&gt; entry : <span class="keyword">this</span>.consumerTable.entrySet()) &#123;</div><div class="line"> <span class="number">3</span>:         MQConsumerInner impl = entry.getValue();</div><div class="line"> <span class="number">4</span>:         <span class="keyword">if</span> (impl != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">5</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>:                 impl.doRebalance();</div><div class="line"> <span class="number">7</span>:             &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">8</span>:                 log.error(<span class="string">"doRebalance exception"</span>, e);</div><div class="line"> <span class="number">9</span>:             &#125;</div><div class="line"><span class="number">10</span>:         &#125;</div><div class="line"><span class="number">11</span>:     &#125;</div><div class="line"><span class="number">12</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šéå†å½“å‰ <code>Client</code> åŒ…å«çš„ <code>consumerTable</code>( <code>Consumer</code>é›†åˆ )ï¼Œæ‰§è¡Œæ¶ˆæ¯é˜Ÿåˆ—åˆ†é…ã€‚</li><li><strong>ç–‘é—®</strong>ï¼šç›®å‰ä»£ç è°ƒè¯•ä¸‹æ¥ï¼Œ<code>consumerTable</code> åªåŒ…å« <code>Consumer</code> è‡ªå·±ã€‚ğŸ˜ˆæœ‰å¤§å¤§å¯¹è¿™ä¸ªç–‘é—®æœ‰è§£ç­”çš„ï¼Œçƒ¦è¯·è§£ç­”ä¸‹ã€‚</li><li>ç¬¬ 6 è¡Œ ï¼šè°ƒç”¨ <code>MQConsumerInner#doRebalance(...)</code> è¿›è¡Œé˜Ÿåˆ—åˆ†é…ã€‚<code>DefaultMQPushConsumerImpl</code>ã€<code>DefaultMQPullConsumerImpl</code> åˆ†åˆ«å¯¹è¯¥æ¥å£æ–¹æ³•è¿›è¡Œäº†å®ç°ã€‚<code>DefaultMQPushConsumerImpl#doRebalance(...)</code> è¯¦ç»†è§£æè§ï¼š<a href="defaultmqpushconsumerimpldorebalance">DefaultMQPushConsumerImpl#doRebalance(â€¦)</a>ã€‚</li></ul><h2 id="DefaultMQPushConsumerImpl-doRebalance-â€¦"><a href="#DefaultMQPushConsumerImpl-doRebalance-â€¦" class="headerlink" title="DefaultMQPushConsumerImpl#doRebalance(â€¦)"></a>DefaultMQPushConsumerImpl#doRebalance(â€¦)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRebalance</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     <span class="keyword">if</span> (!<span class="keyword">this</span>.pause) &#123;</div><div class="line"><span class="number">3</span>:         <span class="keyword">this</span>.rebalanceImpl.doRebalance(<span class="keyword">this</span>.isConsumeOrderly());</div><div class="line"><span class="number">4</span>:     &#125;</div><div class="line"><span class="number">5</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ï¼šæ‰§è¡Œæ¶ˆæ¯é˜Ÿåˆ—åˆ†é…ã€‚</li><li>ç¬¬ 3 è¡Œ ï¼šè°ƒç”¨ <code>RebalanceImpl#doRebalance(...)</code> è¿›è¡Œé˜Ÿåˆ—åˆ†é…ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#rebalancepushimpldorebalance">RebalancePushImpl#doRebalance(â€¦)</a>ã€‚</li></ul><h2 id="RebalanceImpl-doRebalance-â€¦"><a href="#RebalanceImpl-doRebalance-â€¦" class="headerlink" title="RebalanceImpl#doRebalance(â€¦)"></a>RebalanceImpl#doRebalance(â€¦)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * æ‰§è¡Œåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 3:  *</div><div class="line"> 4:  * <span class="doctag">@param</span> isOrder æ˜¯å¦é¡ºåºæ¶ˆæ¯</div><div class="line"> 5:  */</div><div class="line"> <span class="number">6</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRebalance</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> isOrder)</span> </span>&#123;</div><div class="line"> <span class="number">7</span>:     <span class="comment">// åˆ†é…æ¯ä¸ª topic çš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"> <span class="number">8</span>:     Map&lt;String, SubscriptionData&gt; subTable = <span class="keyword">this</span>.getSubscriptionInner();</div><div class="line"> <span class="number">9</span>:     <span class="keyword">if</span> (subTable != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">10</span>:         <span class="keyword">for</span> (<span class="keyword">final</span> Map.Entry&lt;String, SubscriptionData&gt; entry : subTable.entrySet()) &#123;</div><div class="line"><span class="number">11</span>:             <span class="keyword">final</span> String topic = entry.getKey();</div><div class="line"><span class="number">12</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">13</span>:                 <span class="keyword">this</span>.rebalanceByTopic(topic, isOrder);</div><div class="line"><span class="number">14</span>:             &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">15</span>:                 <span class="keyword">if</span> (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class="line"><span class="number">16</span>:                     log.warn(<span class="string">"rebalanceByTopic Exception"</span>, e);</div><div class="line"><span class="number">17</span>:                 &#125;</div><div class="line"><span class="number">18</span>:             &#125;</div><div class="line"><span class="number">19</span>:         &#125;</div><div class="line"><span class="number">20</span>:     &#125;</div><div class="line"><span class="number">21</span>:     <span class="comment">// ç§»é™¤æœªè®¢é˜…çš„topicå¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"><span class="number">22</span>:     <span class="keyword">this</span>.truncateMessageQueueNotMyTopic();</div><div class="line"><span class="number">23</span>: &#125;</div><div class="line"><span class="number">24</span>: </div><div class="line"><span class="number">25</span>: <span class="comment">/**</span></div><div class="line">26:  * ç§»é™¤æœªè®¢é˜…çš„æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line">27:  */</div><div class="line"><span class="number">28</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">truncateMessageQueueNotMyTopic</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">29</span>:     Map&lt;String, SubscriptionData&gt; subTable = <span class="keyword">this</span>.getSubscriptionInner();</div><div class="line"><span class="number">30</span>:     <span class="keyword">for</span> (MessageQueue mq : <span class="keyword">this</span>.processQueueTable.keySet()) &#123;</div><div class="line"><span class="number">31</span>:         <span class="keyword">if</span> (!subTable.containsKey(mq.getTopic())) &#123;</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>:             ProcessQueue pq = <span class="keyword">this</span>.processQueueTable.remove(mq);</div><div class="line"><span class="number">34</span>:             <span class="keyword">if</span> (pq != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">35</span>:                 pq.setDropped(<span class="keyword">true</span>);</div><div class="line"><span class="number">36</span>:                 log.info(<span class="string">"doRebalance, &#123;&#125;, truncateMessageQueueNotMyTopic remove unnecessary mq, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">37</span>:             &#125;</div><div class="line"><span class="number">38</span>:         &#125;</div><div class="line"><span class="number">39</span>:     &#125;</div><div class="line"><span class="number">40</span>: &#125;</div></pre></td></tr></table></figure><ul><li><code>#doRebalance(...)</code> è¯´æ˜ ï¼šæ‰§è¡Œåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚<ul><li>ç¬¬ 7 è‡³ 20 è¡Œ ï¼šå¾ªç¯è®¢é˜…ä¸»é¢˜é›†åˆ( <code>subscriptionInner</code> )ï¼Œåˆ†é…æ¯ä¸€ä¸ª <code>Topic</code> çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li><li>ç¬¬ 22 è¡Œ ï¼šç§»é™¤æœªè®¢é˜…çš„ <code>Topic</code> çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li></ul></li><li><code>#truncateMessageQueueNotMyTopic(...)</code> è¯´æ˜ ï¼šç§»é™¤æœªè®¢é˜…çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚<strong>å½“è°ƒç”¨ <code>DefaultMQPushConsumer#unsubscribe(topic)</code> æ—¶ï¼Œåªç§»é™¤è®¢é˜…ä¸»é¢˜é›†åˆ( <code>subscriptionInner</code> )ï¼Œå¯¹åº”æ¶ˆæ¯é˜Ÿåˆ—ç§»é™¤åœ¨è¯¥æ–¹æ³•ã€‚</strong></li></ul><h3 id="RebalanceImpl-rebalanceByTopic-â€¦"><a href="#RebalanceImpl-rebalanceByTopic-â€¦" class="headerlink" title="RebalanceImpl#rebalanceByTopic(â€¦)"></a>RebalanceImpl#rebalanceByTopic(â€¦)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rebalanceByTopic</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">boolean</span> isOrder)</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="keyword">switch</span> (messageModel) &#123;</div><div class="line">  <span class="number">3</span>:         <span class="keyword">case</span> BROADCASTING: &#123;</div><div class="line">  <span class="number">4</span>:             Set&lt;MessageQueue&gt; mqSet = <span class="keyword">this</span>.topicSubscribeInfoTable.get(topic);</div><div class="line">  <span class="number">5</span>:             <span class="keyword">if</span> (mqSet != <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="number">6</span>:                 <span class="keyword">boolean</span> changed = <span class="keyword">this</span>.updateProcessQueueTableInRebalance(topic, mqSet, isOrder);</div><div class="line">  <span class="number">7</span>:                 <span class="keyword">if</span> (changed) &#123;</div><div class="line">  <span class="number">8</span>:                     <span class="keyword">this</span>.messageQueueChanged(topic, mqSet, mqSet);</div><div class="line">  <span class="number">9</span>:                     log.info(<span class="string">"messageQueueChanged &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;"</span>, <span class="comment">//</span></div><div class="line"> <span class="number">10</span>:                         consumerGroup, <span class="comment">//</span></div><div class="line"> <span class="number">11</span>:                         topic, <span class="comment">//</span></div><div class="line"> <span class="number">12</span>:                         mqSet, <span class="comment">//</span></div><div class="line"> <span class="number">13</span>:                         mqSet);</div><div class="line"> <span class="number">14</span>:                 &#125;</div><div class="line"> <span class="number">15</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">16</span>:                 log.warn(<span class="string">"doRebalance, &#123;&#125;, but the topic[&#123;&#125;] not exist."</span>, consumerGroup, topic);</div><div class="line"> <span class="number">17</span>:             &#125;</div><div class="line"> <span class="number">18</span>:             <span class="keyword">break</span>;</div><div class="line"> <span class="number">19</span>:         &#125;</div><div class="line"> <span class="number">20</span>:         <span class="keyword">case</span> CLUSTERING: &#123;</div><div class="line"> <span class="number">21</span>:             <span class="comment">// è·å– topic å¯¹åº”çš„ é˜Ÿåˆ— å’Œ consumerä¿¡æ¯</span></div><div class="line"> <span class="number">22</span>:             Set&lt;MessageQueue&gt; mqSet = <span class="keyword">this</span>.topicSubscribeInfoTable.get(topic);</div><div class="line"> <span class="number">23</span>:             List&lt;String&gt; cidAll = <span class="keyword">this</span>.mQClientFactory.findConsumerIdList(topic, consumerGroup);</div><div class="line"> <span class="number">24</span>:             <span class="keyword">if</span> (<span class="keyword">null</span> == mqSet) &#123;</div><div class="line"> <span class="number">25</span>:                 <span class="keyword">if</span> (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class="line"> <span class="number">26</span>:                     log.warn(<span class="string">"doRebalance, &#123;&#125;, but the topic[&#123;&#125;] not exist."</span>, consumerGroup, topic);</div><div class="line"> <span class="number">27</span>:                 &#125;</div><div class="line"> <span class="number">28</span>:             &#125;</div><div class="line"> <span class="number">29</span>: </div><div class="line"> <span class="number">30</span>:             <span class="keyword">if</span> (<span class="keyword">null</span> == cidAll) &#123;</div><div class="line"> <span class="number">31</span>:                 log.warn(<span class="string">"doRebalance, &#123;&#125; &#123;&#125;, get consumer id list failed"</span>, consumerGroup, topic);</div><div class="line"> <span class="number">32</span>:             &#125;</div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:             <span class="keyword">if</span> (mqSet != <span class="keyword">null</span> &amp;&amp; cidAll != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">35</span>:                 <span class="comment">// æ’åº æ¶ˆæ¯é˜Ÿåˆ— å’Œ æ¶ˆè´¹è€…æ•°ç»„ã€‚å› ä¸ºæ˜¯åœ¨Clientè¿›è¡Œåˆ†é…é˜Ÿåˆ—ï¼Œæ’åºåï¼Œå„Clientçš„é¡ºåºæ‰èƒ½ä¿æŒä¸€è‡´ã€‚</span></div><div class="line"> <span class="number">36</span>:                 List&lt;MessageQueue&gt; mqAll = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"> <span class="number">37</span>:                 mqAll.addAll(mqSet);</div><div class="line"> <span class="number">38</span>: </div><div class="line"> <span class="number">39</span>:                 Collections.sort(mqAll);</div><div class="line"> <span class="number">40</span>:                 Collections.sort(cidAll);</div><div class="line"> <span class="number">41</span>: </div><div class="line"> <span class="number">42</span>:                 AllocateMessageQueueStrategy strategy = <span class="keyword">this</span>.allocateMessageQueueStrategy;</div><div class="line"> <span class="number">43</span>: </div><div class="line"> <span class="number">44</span>:                 <span class="comment">// æ ¹æ® é˜Ÿåˆ—åˆ†é…ç­–ç•¥ åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"> <span class="number">45</span>:                 List&lt;MessageQueue&gt; allocateResult;</div><div class="line"> <span class="number">46</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">47</span>:                     allocateResult = strategy.allocate(<span class="comment">//</span></div><div class="line"> <span class="number">48</span>:                         <span class="keyword">this</span>.consumerGroup, <span class="comment">//</span></div><div class="line"> <span class="number">49</span>:                         <span class="keyword">this</span>.mQClientFactory.getClientId(), <span class="comment">//</span></div><div class="line"> <span class="number">50</span>:                         mqAll, <span class="comment">//</span></div><div class="line"> <span class="number">51</span>:                         cidAll);</div><div class="line"> <span class="number">52</span>:                 &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">53</span>:                     log.error(<span class="string">"AllocateMessageQueueStrategy.allocate Exception. allocateMessageQueueStrategyName=&#123;&#125;"</span>, strategy.getName(),</div><div class="line"> <span class="number">54</span>:                         e);</div><div class="line"> <span class="number">55</span>:                     <span class="keyword">return</span>;</div><div class="line"> <span class="number">56</span>:                 &#125;</div><div class="line"> <span class="number">57</span>: </div><div class="line"> <span class="number">58</span>:                 Set&lt;MessageQueue&gt; allocateResultSet = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"> <span class="number">59</span>:                 <span class="keyword">if</span> (allocateResult != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">60</span>:                     allocateResultSet.addAll(allocateResult);</div><div class="line"> <span class="number">61</span>:                 &#125;</div><div class="line"> <span class="number">62</span>: </div><div class="line"> <span class="number">63</span>:                 <span class="comment">// æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"> <span class="number">64</span>:                 <span class="keyword">boolean</span> changed = <span class="keyword">this</span>.updateProcessQueueTableInRebalance(topic, allocateResultSet, isOrder);</div><div class="line"> <span class="number">65</span>:                 <span class="keyword">if</span> (changed) &#123;</div><div class="line"> <span class="number">66</span>:                     log.info(</div><div class="line"> <span class="number">67</span>:                         <span class="string">"rebalanced result changed. allocateMessageQueueStrategyName=&#123;&#125;, group=&#123;&#125;, topic=&#123;&#125;, clientId=&#123;&#125;, mqAllSize=&#123;&#125;, cidAllSize=&#123;&#125;, rebalanceResultSize=&#123;&#125;, rebalanceResultSet=&#123;&#125;"</span>,</div><div class="line"> <span class="number">68</span>:                         strategy.getName(), consumerGroup, topic, <span class="keyword">this</span>.mQClientFactory.getClientId(), mqSet.size(), cidAll.size(),</div><div class="line"> <span class="number">69</span>:                         allocateResultSet.size(), allocateResultSet);</div><div class="line"> <span class="number">70</span>:                     <span class="keyword">this</span>.messageQueueChanged(topic, mqSet, allocateResultSet);</div><div class="line"> <span class="number">71</span>:                 &#125;</div><div class="line"> <span class="number">72</span>:             &#125;</div><div class="line"> <span class="number">73</span>:             <span class="keyword">break</span>;</div><div class="line"> <span class="number">74</span>:         &#125;</div><div class="line"> <span class="number">75</span>:         <span class="keyword">default</span>:</div><div class="line"> <span class="number">76</span>:             <span class="keyword">break</span>;</div><div class="line"> <span class="number">77</span>:     &#125;</div><div class="line"> <span class="number">78</span>: &#125;</div><div class="line"> <span class="number">79</span>: </div><div class="line"> <span class="number">80</span>: <span class="comment">/**</span></div><div class="line"> 81:  * å½“è´Ÿè½½å‡è¡¡æ—¶ï¼Œæ›´æ–° æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class="line"> 82:  * - ç§»é™¤ åœ¨processQueueTable &amp;&amp; ä¸å­˜åœ¨äº mqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 83:  * - å¢åŠ  ä¸åœ¨processQueueTable &amp;&amp; å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 84:  *</div><div class="line"> 85:  * <span class="doctag">@param</span> topic Topic</div><div class="line"> 86:  * <span class="doctag">@param</span> mqSet è´Ÿè½½å‡è¡¡ç»“æœåçš„æ¶ˆæ¯é˜Ÿåˆ—æ•°ç»„</div><div class="line"> 87:  * <span class="doctag">@param</span> isOrder æ˜¯å¦é¡ºåº</div><div class="line"> 88:  * <span class="doctag">@return</span> æ˜¯å¦å˜æ›´</div><div class="line"> 89:  */</div><div class="line"> <span class="number">90</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateProcessQueueTableInRebalance</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> Set&lt;MessageQueue&gt; mqSet, <span class="keyword">final</span> <span class="keyword">boolean</span> isOrder)</span> </span>&#123;</div><div class="line"> <span class="number">91</span>:     <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</div><div class="line"> <span class="number">92</span>: </div><div class="line"> <span class="number">93</span>:     <span class="comment">// ç§»é™¤ åœ¨processQueueTable &amp;&amp; ä¸å­˜åœ¨äº mqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"> <span class="number">94</span>:     Iterator&lt;Entry&lt;MessageQueue, ProcessQueue&gt;&gt; it = <span class="keyword">this</span>.processQueueTable.entrySet().iterator();</div><div class="line"> <span class="number">95</span>:     <span class="keyword">while</span> (it.hasNext()) &#123; <span class="comment">// TODO å¾…è¯»ï¼š</span></div><div class="line"> <span class="number">96</span>:         Entry&lt;MessageQueue, ProcessQueue&gt; next = it.next();</div><div class="line"> <span class="number">97</span>:         MessageQueue mq = next.getKey();</div><div class="line"> <span class="number">98</span>:         ProcessQueue pq = next.getValue();</div><div class="line"> <span class="number">99</span>: </div><div class="line"><span class="number">100</span>:         <span class="keyword">if</span> (mq.getTopic().equals(topic)) &#123;</div><div class="line"><span class="number">101</span>:             <span class="keyword">if</span> (!mqSet.contains(mq)) &#123; <span class="comment">// ä¸åŒ…å«çš„é˜Ÿåˆ—</span></div><div class="line"><span class="number">102</span>:                 pq.setDropped(<span class="keyword">true</span>);</div><div class="line"><span class="number">103</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.removeUnnecessaryMessageQueue(mq, pq)) &#123;</div><div class="line"><span class="number">104</span>:                     it.remove();</div><div class="line"><span class="number">105</span>:                     changed = <span class="keyword">true</span>;</div><div class="line"><span class="number">106</span>:                     log.info(<span class="string">"doRebalance, &#123;&#125;, remove unnecessary mq, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">107</span>:                 &#125;</div><div class="line"><span class="number">108</span>:             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pq.isPullExpired()) &#123; <span class="comment">// é˜Ÿåˆ—æ‹‰å–è¶…æ—¶ï¼Œè¿›è¡Œæ¸…ç†</span></div><div class="line"><span class="number">109</span>:                 <span class="keyword">switch</span> (<span class="keyword">this</span>.consumeType()) &#123;</div><div class="line"><span class="number">110</span>:                     <span class="keyword">case</span> CONSUME_ACTIVELY:</div><div class="line"><span class="number">111</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">112</span>:                     <span class="keyword">case</span> CONSUME_PASSIVELY:</div><div class="line"><span class="number">113</span>:                         pq.setDropped(<span class="keyword">true</span>);</div><div class="line"><span class="number">114</span>:                         <span class="keyword">if</span> (<span class="keyword">this</span>.removeUnnecessaryMessageQueue(mq, pq)) &#123;</div><div class="line"><span class="number">115</span>:                             it.remove();</div><div class="line"><span class="number">116</span>:                             changed = <span class="keyword">true</span>;</div><div class="line"><span class="number">117</span>:                             log.error(<span class="string">"[BUG]doRebalance, &#123;&#125;, remove unnecessary mq, &#123;&#125;, because pull is pause, so try to fixed it"</span>,</div><div class="line"><span class="number">118</span>:                                 consumerGroup, mq);</div><div class="line"><span class="number">119</span>:                         &#125;</div><div class="line"><span class="number">120</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">121</span>:                     <span class="keyword">default</span>:</div><div class="line"><span class="number">122</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">123</span>:                 &#125;</div><div class="line"><span class="number">124</span>:             &#125;</div><div class="line"><span class="number">125</span>:         &#125;</div><div class="line"><span class="number">126</span>:     &#125;</div><div class="line"><span class="number">127</span>: </div><div class="line"><span class="number">128</span>:     <span class="comment">// å¢åŠ  ä¸åœ¨processQueueTable &amp;&amp; å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</span></div><div class="line"><span class="number">129</span>:     List&lt;PullRequest&gt; pullRequestList = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// æ‹‰æ¶ˆæ¯è¯·æ±‚æ•°ç»„</span></div><div class="line"><span class="number">130</span>:     <span class="keyword">for</span> (MessageQueue mq : mqSet) &#123;</div><div class="line"><span class="number">131</span>:         <span class="keyword">if</span> (!<span class="keyword">this</span>.processQueueTable.containsKey(mq)) &#123;</div><div class="line"><span class="number">132</span>:             <span class="keyword">if</span> (isOrder &amp;&amp; !<span class="keyword">this</span>.lock(mq)) &#123;</div><div class="line"><span class="number">133</span>:                 log.warn(<span class="string">"doRebalance, &#123;&#125;, add a new mq failed, &#123;&#125;, because lock failed"</span>, consumerGroup, mq);</div><div class="line"><span class="number">134</span>:                 <span class="keyword">continue</span>;</div><div class="line"><span class="number">135</span>:             &#125;</div><div class="line"><span class="number">136</span>: </div><div class="line"><span class="number">137</span>:             <span class="keyword">this</span>.removeDirtyOffset(mq);</div><div class="line"><span class="number">138</span>:             ProcessQueue pq = <span class="keyword">new</span> ProcessQueue();</div><div class="line"><span class="number">139</span>:             <span class="keyword">long</span> nextOffset = <span class="keyword">this</span>.computePullFromWhere(mq);</div><div class="line"><span class="number">140</span>:             <span class="keyword">if</span> (nextOffset &gt;= <span class="number">0</span>) &#123;</div><div class="line"><span class="number">141</span>:                 ProcessQueue pre = <span class="keyword">this</span>.processQueueTable.putIfAbsent(mq, pq);</div><div class="line"><span class="number">142</span>:                 <span class="keyword">if</span> (pre != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">143</span>:                     log.info(<span class="string">"doRebalance, &#123;&#125;, mq already exists, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">144</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">145</span>:                     log.info(<span class="string">"doRebalance, &#123;&#125;, add a new mq, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">146</span>:                     PullRequest pullRequest = <span class="keyword">new</span> PullRequest();</div><div class="line"><span class="number">147</span>:                     pullRequest.setConsumerGroup(consumerGroup);</div><div class="line"><span class="number">148</span>:                     pullRequest.setNextOffset(nextOffset);</div><div class="line"><span class="number">149</span>:                     pullRequest.setMessageQueue(mq);</div><div class="line"><span class="number">150</span>:                     pullRequest.setProcessQueue(pq);</div><div class="line"><span class="number">151</span>:                     pullRequestList.add(pullRequest);</div><div class="line"><span class="number">152</span>:                     changed = <span class="keyword">true</span>;</div><div class="line"><span class="number">153</span>:                 &#125;</div><div class="line"><span class="number">154</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">155</span>:                 log.warn(<span class="string">"doRebalance, &#123;&#125;, add new mq failed, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">156</span>:             &#125;</div><div class="line"><span class="number">157</span>:         &#125;</div><div class="line"><span class="number">158</span>:     &#125;</div><div class="line"><span class="number">159</span>: </div><div class="line"><span class="number">160</span>:     <span class="comment">// å‘èµ·æ¶ˆæ¯æ‹‰å–è¯·æ±‚</span></div><div class="line"><span class="number">161</span>:     <span class="keyword">this</span>.dispatchPullRequest(pullRequestList);</div><div class="line"><span class="number">162</span>: </div><div class="line"><span class="number">163</span>:     <span class="keyword">return</span> changed;</div><div class="line"><span class="number">164</span>: &#125;</div></pre></td></tr></table></figure><ul><li><code>#rebalanceByTopic(...)</code> è¯´æ˜ ï¼šåˆ†é… <code>Topic</code> çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚<ul><li>ç¬¬ 3 è‡³ 19 è¡Œ ï¼šå¹¿æ’­æ¨¡å¼( <code>BROADCASTING</code> ) ä¸‹ï¼Œåˆ†é… <code>Topic</code> å¯¹åº”çš„<strong>æ‰€æœ‰</strong>æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li><li>ç¬¬ 20 è‡³ 74 è¡Œ ï¼šé›†ç¾¤æ¨¡å¼( <code>CLUSTERING</code> ) ä¸‹ï¼Œåˆ†é… <code>Topic</code> å¯¹åº”çš„<strong>éƒ¨åˆ†</strong>æ¶ˆæ¯é˜Ÿåˆ—ã€‚<ul><li>ç¬¬ 21 è‡³ 40 è¡Œ ï¼šè·å– <code>Topic</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—å’Œæ¶ˆè´¹è€…ä»¬ï¼Œå¹¶å¯¹å…¶è¿›è¡Œæ’åºã€‚å› ä¸ºå„ <code>Consumer</code> æ˜¯åœ¨æœ¬åœ°åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ’åºåæ‰èƒ½ä¿è¯å„ <code>Consumer</code> é¡ºåºä¸€è‡´ã€‚</li><li>ç¬¬ 42 è‡³ 61 è¡Œ ï¼šæ ¹æ® é˜Ÿåˆ—åˆ†é…ç­–ç•¥( <code>AllocateMessageQueueStrategy</code> ) åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#allocatemessagequeuestrategy">AllocateMessageQueueStrategy</a>ã€‚</li><li>ç¬¬ 63 è‡³ 72 è¡Œ ï¼šæ›´æ–° <code>Topic</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li></ul></li></ul></li><li><code>#updateProcessQueueTableInRebalance(...)</code> è¯´æ˜ ï¼šå½“åˆ†é…é˜Ÿåˆ—æ—¶ï¼Œæ›´æ–° <code>Topic</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶è¿”å›æ˜¯å¦æœ‰å˜æ›´ã€‚<ul><li>ç¬¬ 93 è‡³ 126 è¡Œ ï¼šç§»é™¤ä¸å­˜åœ¨äºåˆ†é…çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>mqSet</code> ) çš„ æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—( <code>processQueueTable</code> )ã€‚<ul><li>ç¬¬ 103 è¡Œ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#rebalancepushimplremoveunnecessarymessagequeue">RebalancePushImpl#removeUnnecessaryMessageQueue(â€¦)</a>ã€‚</li><li>ç¬¬ 108 è‡³ 120 è¡Œ ï¼šé˜Ÿåˆ—æ‹‰å–è¶…æ—¶ï¼Œå³ <code>å½“å‰æ—¶é—´ - æœ€åä¸€æ¬¡æ‹‰å–æ¶ˆæ¯æ—¶é—´ &gt; 120s</code> ( 120s å¯é…ç½®)ï¼Œåˆ¤å®šå‘ç”Ÿ <strong>BUG</strong>ï¼Œè¿‡ä¹…æœªè¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—ã€‚ç§»é™¤åï¼Œä¸‹é¢<strong>#æ–°å¢é˜Ÿåˆ—é€»è¾‘#</strong>å¯ä»¥é‡æ–°åŠ å…¥æ–°çš„è¯¥æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li></ul></li><li>ç¬¬ 128 è‡³ 158 è¡Œ ï¼šå¢åŠ  åˆ†é…çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>mqSet</code> ) æ–°å¢çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚<ul><li>ç¬¬ 132 è‡³ 135 è¡Œ ï¼š<code>é¡ºåºæ¶ˆè´¹</code> ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š<a href="http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹</a>ã€‚</li><li>ç¬¬ 137 è¡Œ ï¼šç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ã€‚</li><li>ç¬¬ 139 è¡Œ ï¼šè·å–é˜Ÿåˆ—æ¶ˆè´¹è¿›åº¦ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#rebalancepushimplcomputepullfromwhere">RebalancePushImpl#computePullFromWhere(â€¦)</a>ã€‚</li><li>ç¬¬ 140 è‡³ 156 è¡Œ ï¼š<strong>æ·»åŠ æ–°æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ï¼Œæ·»åŠ æ¶ˆè´¹æ‹‰å–æ¶ˆæ¯è¯·æ±‚</strong>ã€‚</li></ul></li><li>ç¬¬ 161 è¡Œ ï¼š<strong>å‘èµ·æ–°å¢çš„æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆæ¯æ‹‰å–è¯·æ±‚</strong>ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#rebalancepushimpldispatchpullrequest">RebalancePushImpl#dispatchPullRequest(â€¦)</a>ã€‚</li></ul></li></ul><h3 id="RebalanceImpl-removeUnnecessaryMessageQueue-â€¦"><a href="#RebalanceImpl-removeUnnecessaryMessageQueue-â€¦" class="headerlink" title="RebalanceImpl#removeUnnecessaryMessageQueue(â€¦)"></a>RebalanceImpl#removeUnnecessaryMessageQueue(â€¦)</h3><h4 id="RebalancePushImpl-removeUnnecessaryMessageQueue-â€¦"><a href="#RebalancePushImpl-removeUnnecessaryMessageQueue-â€¦" class="headerlink" title="RebalancePushImpl#removeUnnecessaryMessageQueue(â€¦)"></a>RebalancePushImpl#removeUnnecessaryMessageQueue(â€¦)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeUnnecessaryMessageQueue</span><span class="params">(MessageQueue mq, ProcessQueue pq)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// åŒæ­¥é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚</span></div><div class="line"> <span class="number">3</span>:     <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().persist(mq);</div><div class="line"> <span class="number">4</span>:     <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().removeOffset(mq);</div><div class="line"> <span class="number">5</span>:     <span class="comment">// TODO é¡ºåºæ¶ˆè´¹</span></div><div class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.defaultMQPushConsumerImpl.isConsumeOrderly()</div><div class="line"> <span class="number">7</span>:         &amp;&amp; MessageModel.CLUSTERING.equals(<span class="keyword">this</span>.defaultMQPushConsumerImpl.messageModel())) &#123;</div><div class="line"> <span class="number">8</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">9</span>:             <span class="keyword">if</span> (pq.getLockConsume().tryLock(<span class="number">1000</span>, TimeUnit.MILLISECONDS)) &#123;</div><div class="line"><span class="number">10</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">11</span>:                     <span class="keyword">return</span> <span class="keyword">this</span>.unlockDelay(mq, pq);</div><div class="line"><span class="number">12</span>:                 &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">13</span>:                     pq.getLockConsume().unlock();</div><div class="line"><span class="number">14</span>:                 &#125;</div><div class="line"><span class="number">15</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">16</span>:                 log.warn(<span class="string">"[WRONG]mq is consuming, so can not unlock it, &#123;&#125;. maybe hanged for a while, &#123;&#125;"</span>, <span class="comment">//</span></div><div class="line"><span class="number">17</span>:                     mq, <span class="comment">//</span></div><div class="line"><span class="number">18</span>:                     pq.getTryUnlockTimes());</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>:                 pq.incTryUnlockTimes();</div><div class="line"><span class="number">21</span>:             &#125;</div><div class="line"><span class="number">22</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">23</span>:             log.error(<span class="string">"removeUnnecessaryMessageQueue Exception"</span>, e);</div><div class="line"><span class="number">24</span>:         &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">27</span>:     &#125;</div><div class="line"><span class="number">28</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">29</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯ï¼Œå¹¶è¿”å›æ˜¯å¦ç§»é™¤æˆåŠŸã€‚</li><li>ç¬¬ 2 è‡³ 4 è¡Œ ï¼š<strong>åŒæ­¥</strong>é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚</li><li>ç¬¬ 5 è‡³ 27 è¡Œ ï¼š<code>é¡ºåºæ¶ˆè´¹</code> ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š<a href="http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹</a>ã€‚</li></ul><h4 id="PullConsumer-RebalancePullImpl-removeUnnecessaryMessageQueue-â€¦"><a href="#PullConsumer-RebalancePullImpl-removeUnnecessaryMessageQueue-â€¦" class="headerlink" title="[PullConsumer] RebalancePullImpl#removeUnnecessaryMessageQueue(â€¦)"></a><code>[PullConsumer]</code> RebalancePullImpl#removeUnnecessaryMessageQueue(â€¦)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeUnnecessaryMessageQueue</span><span class="params">(MessageQueue mq, ProcessQueue pq)</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     <span class="keyword">this</span>.defaultMQPullConsumerImpl.getOffsetStore().persist(mq);</div><div class="line"><span class="number">3</span>:     <span class="keyword">this</span>.defaultMQPullConsumerImpl.getOffsetStore().removeOffset(mq);</div><div class="line"><span class="number">4</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">5</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯ï¼Œå¹¶è¿”å›ç§»é™¤æˆåŠŸã€‚<strong>å’Œ<code>RebalancePushImpl#removeUnnecessaryMessageQueue(...)</code>åŸºæœ¬ä¸€è‡´ã€‚</strong></li></ul><h3 id="RebalancePushImpl-dispatchPullRequest-â€¦"><a href="#RebalancePushImpl-dispatchPullRequest-â€¦" class="headerlink" title="RebalancePushImpl#dispatchPullRequest(â€¦)"></a>RebalancePushImpl#dispatchPullRequest(â€¦)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchPullRequest</span><span class="params">(List&lt;PullRequest&gt; pullRequestList)</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     <span class="keyword">for</span> (PullRequest pullRequest : pullRequestList) &#123;</div><div class="line"><span class="number">3</span>:         <span class="keyword">this</span>.defaultMQPushConsumerImpl.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">4</span>:         log.info(<span class="string">"doRebalance, &#123;&#125;, add a new pull request &#123;&#125;"</span>, consumerGroup, pullRequest);</div><div class="line"><span class="number">5</span>:     &#125;</div><div class="line"><span class="number">6</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šå‘èµ·æ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚<strong>è¯¥è°ƒç”¨æ˜¯<code>PushConsumer</code>ä¸æ–­ä¸æ–­ä¸æ–­æ‹‰å–æ¶ˆæ¯çš„èµ·ç‚¹</strong>ã€‚</li></ul><h4 id="DefaultMQPushConsumerImpl-executePullRequestImmediately-â€¦"><a href="#DefaultMQPushConsumerImpl-executePullRequestImmediately-â€¦" class="headerlink" title="DefaultMQPushConsumerImpl#executePullRequestImmediately(â€¦)"></a>DefaultMQPushConsumerImpl#executePullRequestImmediately(â€¦)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executePullRequestImmediately</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     <span class="keyword">this</span>.mQClientFactory.getPullMessageService().executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">3</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šæäº¤æ‹‰å–è¯·æ±‚ã€‚æäº¤åï¼Œ<code>PullMessageService</code> <strong>å¼‚æ­¥æ‰§è¡Œ</strong>ï¼Œ<strong>éé˜»å¡</strong>ã€‚è¯¦ç»†è§£æè§ï¼š<a href="pullmessageservice">PullMessageService</a>ã€‚</li></ul><h3 id="AllocateMessageQueueStrategy"><a href="#AllocateMessageQueueStrategy" class="headerlink" title="AllocateMessageQueueStrategy"></a>AllocateMessageQueueStrategy</h3><p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/01.png" alt="AllocateMessageQueueStrategyç±»å›¾"></p><h4 id="AllocateMessageQueueAveragely"><a href="#AllocateMessageQueueAveragely" class="headerlink" title="AllocateMessageQueueAveragely"></a>AllocateMessageQueueAveragely</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllocateMessageQueueAveragely</span> <span class="keyword">implements</span> <span class="title">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Logger log = ClientLogger.getLog();</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">allocate</span><span class="params">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class="line"> <span class="number">6</span>:         List&lt;String&gt; cidAll) &#123;</div><div class="line"> <span class="number">7</span>:         <span class="comment">// æ ¡éªŒå‚æ•°æ˜¯å¦æ­£ç¡®</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (currentCID == <span class="keyword">null</span> || currentCID.length() &lt; <span class="number">1</span>) &#123;</div><div class="line"> <span class="number">9</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"currentCID is empty"</span>);</div><div class="line"><span class="number">10</span>:         &#125;</div><div class="line"><span class="number">11</span>:         <span class="keyword">if</span> (mqAll == <span class="keyword">null</span> || mqAll.isEmpty()) &#123;</div><div class="line"><span class="number">12</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"mqAll is null or mqAll empty"</span>);</div><div class="line"><span class="number">13</span>:         &#125;</div><div class="line"><span class="number">14</span>:         <span class="keyword">if</span> (cidAll == <span class="keyword">null</span> || cidAll.isEmpty()) &#123;</div><div class="line"><span class="number">15</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"cidAll is null or cidAll empty"</span>);</div><div class="line"><span class="number">16</span>:         &#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:         List&lt;MessageQueue&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="number">19</span>:         <span class="keyword">if</span> (!cidAll.contains(currentCID)) &#123;</div><div class="line"><span class="number">20</span>:             log.info(<span class="string">"[BUG] ConsumerGroup: &#123;&#125; The consumerId: &#123;&#125; not in cidAll: &#123;&#125;"</span>,</div><div class="line"><span class="number">21</span>:                 consumerGroup,</div><div class="line"><span class="number">22</span>:                 currentCID,</div><div class="line"><span class="number">23</span>:                 cidAll);</div><div class="line"><span class="number">24</span>:             <span class="keyword">return</span> result;</div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>:         <span class="comment">// å¹³å‡åˆ†é…</span></div><div class="line"><span class="number">27</span>:         <span class="keyword">int</span> index = cidAll.indexOf(currentCID); <span class="comment">// ç¬¬å‡ ä¸ªconsumerã€‚</span></div><div class="line"><span class="number">28</span>:         <span class="keyword">int</span> mod = mqAll.size() % cidAll.size(); <span class="comment">// ä½™æ•°ï¼Œå³å¤šå°‘æ¶ˆæ¯é˜Ÿåˆ—æ— æ³•å¹³å‡åˆ†é…ã€‚</span></div><div class="line"><span class="number">29</span>:         <span class="keyword">int</span> averageSize =</div><div class="line"><span class="number">30</span>:             mqAll.size() &lt;= cidAll.size() ? <span class="number">1</span> : (mod &gt; <span class="number">0</span> &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size()</div><div class="line"><span class="number">31</span>:                 + <span class="number">1</span> : mqAll.size() / cidAll.size());</div><div class="line"><span class="number">32</span>:         <span class="keyword">int</span> startIndex = (mod &gt; <span class="number">0</span> &amp;&amp; index &lt; mod) ? index * averageSize : index * averageSize + mod; <span class="comment">// æœ‰ä½™æ•°çš„æƒ…å†µä¸‹ï¼Œ[0, mod) å¹³åˆ†ä½™æ•°ï¼Œå³æ¯consumerå¤šåˆ†é…ä¸€ä¸ªèŠ‚ç‚¹ï¼›ç¬¬indexå¼€å§‹ï¼Œè·³è¿‡å‰modä½™æ•°ã€‚</span></div><div class="line"><span class="number">33</span>:         <span class="keyword">int</span> range = Math.min(averageSize, mqAll.size() - startIndex); <span class="comment">// åˆ†é…é˜Ÿåˆ—æ•°é‡ã€‚ä¹‹æ‰€ä»¥è¦Math.min()çš„åŸå› æ˜¯ï¼ŒmqAll.size() &lt;= cidAll.size()ï¼Œéƒ¨åˆ†consumeråˆ†é…ä¸åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚</span></div><div class="line"><span class="number">34</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; range; i++) &#123;</div><div class="line"><span class="number">35</span>:             result.add(mqAll.get((startIndex + i) % mqAll.size()));</div><div class="line"><span class="number">36</span>:         &#125;</div><div class="line"><span class="number">37</span>:         <span class="keyword">return</span> result;</div><div class="line"><span class="number">38</span>:     &#125;</div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">41</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">42</span>:         <span class="keyword">return</span> <span class="string">"AVG"</span>;</div><div class="line"><span class="number">43</span>:     &#125;</div><div class="line"><span class="number">44</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼š<strong>å¹³å‡</strong>åˆ†é…é˜Ÿåˆ—ç­–ç•¥ã€‚</li><li>ç¬¬ 7 è‡³ 25 è¡Œ ï¼šå‚æ•°æ ¡éªŒã€‚</li><li>ç¬¬ 26 è‡³ 36 è¡Œ ï¼šå¹³å‡åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚<ul><li>ç¬¬ 27 è¡Œ ï¼š<code>index</code> ï¼šå½“å‰ <code>Consumer</code> åœ¨æ¶ˆè´¹é›†ç¾¤é‡Œæ˜¯ç¬¬å‡ ä¸ªã€‚è¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦å¯¹ä¼ å…¥çš„ <code>cidAll</code> å‚æ•°å¿…é¡»è¿›è¡Œæ’åºçš„åŸå› ã€‚å¦‚æœä¸æ’åºï¼Œ<code>Consumer</code> åœ¨æœ¬åœ°è®¡ç®—å‡ºæ¥çš„ <code>index</code> æ— æ³•ä¸€è‡´ï¼Œå½±å“è®¡ç®—ç»“æœã€‚</li><li>ç¬¬ 28 è¡Œ ï¼š<code>mod</code> ï¼šä½™æ•°ï¼Œå³å¤šå°‘æ¶ˆæ¯é˜Ÿåˆ—æ— æ³•å¹³å‡åˆ†é…ã€‚</li><li>ç¬¬ 29 è‡³ 31 è¡Œ ï¼š<code>averageSize</code> ï¼šä»£ç å¯ä»¥ç®€åŒ–æˆ <code>(mod &gt; 0 &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size() + 1 : mqAll.size() / cidAll.size())</code>ã€‚<ul><li><code>[ 0, mod )</code> ï¼š<code>mqAll.size() / cidAll.size() + 1</code>ã€‚å‰é¢ <code>mod</code> ä¸ª <code>Consumer</code> å¹³åˆ†ä½™æ•°ï¼Œå¤šè·å¾— 1 ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚</li><li><code>[ mod, cidAll.size() )</code> ï¼š<code>mqAll.size() / cidAll.size()</code>ã€‚</li></ul></li><li>ç¬¬ 32 è¡Œ ï¼š<code>startIndex</code> ï¼š<code>Consumer</code> åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—å¼€å§‹ä½ç½®ã€‚</li><li>ç¬¬ 33 è¡Œ ï¼š<code>range</code> ï¼šåˆ†é…é˜Ÿåˆ—æ•°é‡ã€‚ä¹‹æ‰€ä»¥è¦ <code>Math#min(...)</code> çš„åŸå› ï¼šå½“ <code>mqAll.size() &lt;= cidAll.size()</code> æ—¶ï¼Œæœ€åå‡ ä¸ª <code>Consumer</code> åˆ†é…ä¸åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li><li>ç¬¬ 34 è‡³ 36 è¡Œ ï¼šç”Ÿæˆåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç»“æœã€‚</li></ul></li><li>ä¸¾ä¸ªä¾‹å­ï¼š</li></ul><p>å›ºå®šæ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦ä¸º<strong>4</strong>ã€‚</p><table><thead><tr><th></th><th>Consumer <em>2 </em>å¯ä»¥æ•´é™¤*</th><th>Consumer <em>3 </em>ä¸å¯æ•´é™¤*</th><th>Consumer <em>5 </em>æ— æ³•éƒ½åˆ†é…*</th></tr></thead><tbody><tr><td>æ¶ˆæ¯é˜Ÿåˆ—[0]</td><td>Consumer[0]</td><td>Consumer[0]</td><td>Consumer[0]</td></tr><tr><td>æ¶ˆæ¯é˜Ÿåˆ—[1]</td><td>Consumer[0]</td><td>Consumer[0]</td><td>Consumer[1]</td></tr><tr><td>æ¶ˆæ¯é˜Ÿåˆ—[2]</td><td>Consumer[1]</td><td>Consumer[1]</td><td>Consumer[2]</td></tr><tr><td>æ¶ˆæ¯é˜Ÿåˆ—[3]</td><td>Consumer[1]</td><td>Consumer[2]</td><td>Consumer[3]</td></tr></tbody></table><h4 id="AllocateMessageQueueByMachineRoom"><a href="#AllocateMessageQueueByMachineRoom" class="headerlink" title="AllocateMessageQueueByMachineRoom"></a>AllocateMessageQueueByMachineRoom</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllocateMessageQueueByMachineRoom</span> <span class="keyword">implements</span> <span class="title">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">/**</span></div><div class="line"> 3:      * æ¶ˆè´¹è€…æ¶ˆè´¹brokerNameé›†åˆ</div><div class="line"> 4:      */</div><div class="line"> <span class="number">5</span>:     <span class="keyword">private</span> Set&lt;String&gt; consumeridcs;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">8</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">allocate</span><span class="params">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class="line"> <span class="number">9</span>:         List&lt;String&gt; cidAll) &#123;</div><div class="line"><span class="number">10</span>:         <span class="comment">// å‚æ•°æ ¡éªŒ</span></div><div class="line"><span class="number">11</span>:         List&lt;MessageQueue&gt; result = <span class="keyword">new</span> ArrayList&lt;MessageQueue&gt;();</div><div class="line"><span class="number">12</span>:         <span class="keyword">int</span> currentIndex = cidAll.indexOf(currentCID);</div><div class="line"><span class="number">13</span>:         <span class="keyword">if</span> (currentIndex &lt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">14</span>:             <span class="keyword">return</span> result;</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>:         <span class="comment">// è®¡ç®—ç¬¦åˆå½“å‰é…ç½®çš„æ¶ˆè´¹è€…æ•°ç»„('consumeridcs')å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"><span class="number">17</span>:         List&lt;MessageQueue&gt; premqAll = <span class="keyword">new</span> ArrayList&lt;MessageQueue&gt;();</div><div class="line"><span class="number">18</span>:         <span class="keyword">for</span> (MessageQueue mq : mqAll) &#123;</div><div class="line"><span class="number">19</span>:             String[] temp = mq.getBrokerName().split(<span class="string">"@"</span>);</div><div class="line"><span class="number">20</span>:             <span class="keyword">if</span> (temp.length == <span class="number">2</span> &amp;&amp; consumeridcs.contains(temp[<span class="number">0</span>])) &#123;</div><div class="line"><span class="number">21</span>:                 premqAll.add(mq);</div><div class="line"><span class="number">22</span>:             &#125;</div><div class="line"><span class="number">23</span>:         &#125;</div><div class="line"><span class="number">24</span>:         <span class="comment">// å¹³å‡åˆ†é…</span></div><div class="line"><span class="number">25</span>:         <span class="keyword">int</span> mod = premqAll.size() / cidAll.size();</div><div class="line"><span class="number">26</span>:         <span class="keyword">int</span> rem = premqAll.size() % cidAll.size();</div><div class="line"><span class="number">27</span>:         <span class="keyword">int</span> startIndex = mod * currentIndex;</div><div class="line"><span class="number">28</span>:         <span class="keyword">int</span> endIndex = startIndex + mod;</div><div class="line"><span class="number">29</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; endIndex; i++) &#123;</div><div class="line"><span class="number">30</span>:             result.add(mqAll.get(i));</div><div class="line"><span class="number">31</span>:         &#125;</div><div class="line"><span class="number">32</span>:         <span class="keyword">if</span> (rem &gt; currentIndex) &#123;</div><div class="line"><span class="number">33</span>:             result.add(premqAll.get(currentIndex + mod * cidAll.size()));</div><div class="line"><span class="number">34</span>:         &#125;</div><div class="line"><span class="number">35</span>:         <span class="keyword">return</span> result;</div><div class="line"><span class="number">36</span>:     &#125;</div><div class="line"><span class="number">37</span>: </div><div class="line"><span class="number">38</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">39</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">40</span>:         <span class="keyword">return</span> <span class="string">"MACHINE_ROOM"</span>;</div><div class="line"><span class="number">41</span>:     &#125;</div><div class="line"><span class="number">42</span>: </div><div class="line"><span class="number">43</span>:     <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getConsumeridcs</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">44</span>:         <span class="keyword">return</span> consumeridcs;</div><div class="line"><span class="number">45</span>:     &#125;</div><div class="line"><span class="number">46</span>: </div><div class="line"><span class="number">47</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConsumeridcs</span><span class="params">(Set&lt;String&gt; consumeridcs)</span> </span>&#123;</div><div class="line"><span class="number">48</span>:         <span class="keyword">this</span>.consumeridcs = consumeridcs;</div><div class="line"><span class="number">49</span>:     &#125;</div><div class="line"><span class="number">50</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼š<strong>å¹³å‡</strong>åˆ†é…<strong>å¯æ¶ˆè´¹çš„</strong> <code>Broker</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li><li>ç¬¬ 7 è‡³ 15 è¡Œ ï¼šå‚æ•°æ ¡éªŒã€‚</li><li>ç¬¬ 16 è‡³ 23 è¡Œ ï¼šè®¡ç®—<strong>å¯æ¶ˆè´¹çš„</strong> <code>Broker</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li><li>ç¬¬ 25 è‡³ 34 è¡Œ ï¼šå¹³å‡åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¥<strong>å¹³å‡åˆ†é…</strong>æ–¹å¼å’Œ <code>AllocateMessageQueueAveragely</code> ç•¥æœ‰ä¸åŒï¼Œå…¶æ˜¯å°†å¤šä½™çš„ç»“å°¾éƒ¨åˆ†åˆ†é…ç»™å‰ <code>rem</code> ä¸ª <code>Consumer</code>ã€‚</li><li>ç–‘é—®ï¼š<em>ä½¿ç”¨è¯¥åˆ†é…ç­–ç•¥æ—¶ï¼Œ<code>Consumer</code> å’Œ <code>Broker</code> åˆ†é…éœ€è¦æ€ä¹ˆé…ç½®</em>ã€‚ğŸ˜ˆç­‰ç ”ç©¶<strong>ä¸»ä»</strong>ç›¸å…³æºç æ—¶ï¼Œä»”ç»†è€ƒè™‘ä¸‹ã€‚</li></ul><h4 id="AllocateMessageQueueAveragelyByCircle"><a href="#AllocateMessageQueueAveragelyByCircle" class="headerlink" title="AllocateMessageQueueAveragelyByCircle"></a>AllocateMessageQueueAveragelyByCircle</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllocateMessageQueueAveragelyByCircle</span> <span class="keyword">implements</span> <span class="title">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Logger log = ClientLogger.getLog();</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">allocate</span><span class="params">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class="line"> <span class="number">6</span>:         List&lt;String&gt; cidAll) &#123;</div><div class="line"> <span class="number">7</span>:         <span class="comment">// æ ¡éªŒå‚æ•°æ˜¯å¦æ­£ç¡®</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (currentCID == <span class="keyword">null</span> || currentCID.length() &lt; <span class="number">1</span>) &#123;</div><div class="line"> <span class="number">9</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"currentCID is empty"</span>);</div><div class="line"><span class="number">10</span>:         &#125;</div><div class="line"><span class="number">11</span>:         <span class="keyword">if</span> (mqAll == <span class="keyword">null</span> || mqAll.isEmpty()) &#123;</div><div class="line"><span class="number">12</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"mqAll is null or mqAll empty"</span>);</div><div class="line"><span class="number">13</span>:         &#125;</div><div class="line"><span class="number">14</span>:         <span class="keyword">if</span> (cidAll == <span class="keyword">null</span> || cidAll.isEmpty()) &#123;</div><div class="line"><span class="number">15</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"cidAll is null or cidAll empty"</span>);</div><div class="line"><span class="number">16</span>:         &#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:         List&lt;MessageQueue&gt; result = <span class="keyword">new</span> ArrayList&lt;MessageQueue&gt;();</div><div class="line"><span class="number">19</span>:         <span class="keyword">if</span> (!cidAll.contains(currentCID)) &#123;</div><div class="line"><span class="number">20</span>:             log.info(<span class="string">"[BUG] ConsumerGroup: &#123;&#125; The consumerId: &#123;&#125; not in cidAll: &#123;&#125;"</span>,</div><div class="line"><span class="number">21</span>:                 consumerGroup,</div><div class="line"><span class="number">22</span>:                 currentCID,</div><div class="line"><span class="number">23</span>:                 cidAll);</div><div class="line"><span class="number">24</span>:             <span class="keyword">return</span> result;</div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:         <span class="comment">// ç¯çŠ¶åˆ†é…</span></div><div class="line"><span class="number">28</span>:         <span class="keyword">int</span> index = cidAll.indexOf(currentCID);</div><div class="line"><span class="number">29</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = index; i &lt; mqAll.size(); i++) &#123;</div><div class="line"><span class="number">30</span>:             <span class="keyword">if</span> (i % cidAll.size() == index) &#123;</div><div class="line"><span class="number">31</span>:                 result.add(mqAll.get(i));</div><div class="line"><span class="number">32</span>:             &#125;</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:         <span class="keyword">return</span> result;</div><div class="line"><span class="number">35</span>:     &#125;</div><div class="line"><span class="number">36</span>: </div><div class="line"><span class="number">37</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">38</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">39</span>:         <span class="keyword">return</span> <span class="string">"AVG_BY_CIRCLE"</span>;</div><div class="line"><span class="number">40</span>:     &#125;</div><div class="line"><span class="number">41</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šç¯çŠ¶åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li></ul><h4 id="AllocateMessageQueueByConfig"><a href="#AllocateMessageQueueByConfig" class="headerlink" title="AllocateMessageQueueByConfig"></a>AllocateMessageQueueByConfig</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllocateMessageQueueByConfig</span> <span class="keyword">implements</span> <span class="title">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> List&lt;MessageQueue&gt; messageQueueList;</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">allocate</span><span class="params">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class="line"> <span class="number">6</span>:         List&lt;String&gt; cidAll) &#123;</div><div class="line"> <span class="number">7</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.messageQueueList;</div><div class="line"> <span class="number">8</span>:     &#125;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">11</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">12</span>:         <span class="keyword">return</span> <span class="string">"CONFIG"</span>;</div><div class="line"><span class="number">13</span>:     &#125;</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">getMessageQueueList</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">16</span>:         <span class="keyword">return</span> messageQueueList;</div><div class="line"><span class="number">17</span>:     &#125;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMessageQueueList</span><span class="params">(List&lt;MessageQueue&gt; messageQueueList)</span> </span>&#123;</div><div class="line"><span class="number">20</span>:         <span class="keyword">this</span>.messageQueueList = messageQueueList;</div><div class="line"><span class="number">21</span>:     &#125;</div><div class="line"><span class="number">22</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šåˆ†é…<strong>é…ç½®çš„</strong>æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li><li>ç–‘é—® ï¼š<em>è¯¥åˆ†é…ç­–ç•¥çš„ä½¿ç”¨åœºæ™¯ã€‚</em></li></ul><h1 id="5ã€PushConsumer-æ¶ˆè´¹è¿›åº¦è¯»å–"><a href="#5ã€PushConsumer-æ¶ˆè´¹è¿›åº¦è¯»å–" class="headerlink" title="5ã€PushConsumer æ¶ˆè´¹è¿›åº¦è¯»å–"></a>5ã€PushConsumer æ¶ˆè´¹è¿›åº¦è¯»å–</h1><h2 id="RebalancePushImpl-computePullFromWhere-â€¦"><a href="#RebalancePushImpl-computePullFromWhere-â€¦" class="headerlink" title="RebalancePushImpl#computePullFromWhere(â€¦)"></a>RebalancePushImpl#computePullFromWhere(â€¦)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">computePullFromWhere</span><span class="params">(MessageQueue mq)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">long</span> result = -<span class="number">1</span>;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">final</span> ConsumeFromWhere consumeFromWhere = <span class="keyword">this</span>.defaultMQPushConsumerImpl.getDefaultMQPushConsumer().getConsumeFromWhere();</div><div class="line"> <span class="number">4</span>:     <span class="keyword">final</span> OffsetStore offsetStore = <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore();</div><div class="line"> <span class="number">5</span>:     <span class="keyword">switch</span> (consumeFromWhere) &#123;</div><div class="line"> <span class="number">6</span>:         <span class="keyword">case</span> CONSUME_FROM_LAST_OFFSET_AND_FROM_MIN_WHEN_BOOT_FIRST: <span class="comment">// åºŸå¼ƒ</span></div><div class="line"> <span class="number">7</span>:         <span class="keyword">case</span> CONSUME_FROM_MIN_OFFSET: <span class="comment">// åºŸå¼ƒ</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">case</span> CONSUME_FROM_MAX_OFFSET: <span class="comment">// åºŸå¼ƒ</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">case</span> CONSUME_FROM_LAST_OFFSET: &#123;</div><div class="line"><span class="number">10</span>:             <span class="keyword">long</span> lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);</div><div class="line"><span class="number">11</span>:             <span class="keyword">if</span> (lastOffset &gt;= <span class="number">0</span>) &#123;</div><div class="line"><span class="number">12</span>:                 result = lastOffset;</div><div class="line"><span class="number">13</span>:             &#125;</div><div class="line"><span class="number">14</span>:             <span class="comment">// First start,no offset</span></div><div class="line"><span class="number">15</span>:             <span class="keyword">else</span> <span class="keyword">if</span> (-<span class="number">1</span> == lastOffset) &#123;</div><div class="line"><span class="number">16</span>:                 <span class="keyword">if</span> (mq.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class="line"><span class="number">17</span>:                     result = <span class="number">0L</span>;</div><div class="line"><span class="number">18</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">19</span>:                     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">20</span>:                         result = <span class="keyword">this</span>.mQClientFactory.getMQAdminImpl().maxOffset(mq);</div><div class="line"><span class="number">21</span>:                     &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</div><div class="line"><span class="number">22</span>:                         result = -<span class="number">1</span>;</div><div class="line"><span class="number">23</span>:                     &#125;</div><div class="line"><span class="number">24</span>:                 &#125;</div><div class="line"><span class="number">25</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">26</span>:                 result = -<span class="number">1</span>;</div><div class="line"><span class="number">27</span>:             &#125;</div><div class="line"><span class="number">28</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">29</span>:         &#125;</div><div class="line"><span class="number">30</span>:         <span class="keyword">case</span> CONSUME_FROM_FIRST_OFFSET: &#123;</div><div class="line"><span class="number">31</span>:             <span class="keyword">long</span> lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);</div><div class="line"><span class="number">32</span>:             <span class="keyword">if</span> (lastOffset &gt;= <span class="number">0</span>) &#123;</div><div class="line"><span class="number">33</span>:                 result = lastOffset;</div><div class="line"><span class="number">34</span>:             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (-<span class="number">1</span> == lastOffset) &#123;</div><div class="line"><span class="number">35</span>:                 result = <span class="number">0L</span>;</div><div class="line"><span class="number">36</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">37</span>:                 result = -<span class="number">1</span>;</div><div class="line"><span class="number">38</span>:             &#125;</div><div class="line"><span class="number">39</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">40</span>:         &#125;</div><div class="line"><span class="number">41</span>:         <span class="keyword">case</span> CONSUME_FROM_TIMESTAMP: &#123;</div><div class="line"><span class="number">42</span>:             <span class="keyword">long</span> lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);</div><div class="line"><span class="number">43</span>:             <span class="keyword">if</span> (lastOffset &gt;= <span class="number">0</span>) &#123;</div><div class="line"><span class="number">44</span>:                 result = lastOffset;</div><div class="line"><span class="number">45</span>:             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (-<span class="number">1</span> == lastOffset) &#123;</div><div class="line"><span class="number">46</span>:                 <span class="keyword">if</span> (mq.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class="line"><span class="number">47</span>:                     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">48</span>:                         result = <span class="keyword">this</span>.mQClientFactory.getMQAdminImpl().maxOffset(mq);</div><div class="line"><span class="number">49</span>:                     &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</div><div class="line"><span class="number">50</span>:                         result = -<span class="number">1</span>;</div><div class="line"><span class="number">51</span>:                     &#125;</div><div class="line"><span class="number">52</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">53</span>:                     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">54</span>:                         <span class="keyword">long</span> timestamp = UtilAll.parseDate(<span class="keyword">this</span>.defaultMQPushConsumerImpl.getDefaultMQPushConsumer().getConsumeTimestamp(),</div><div class="line"><span class="number">55</span>:                             UtilAll.YYYY_MMDD_HHMMSS).getTime();</div><div class="line"><span class="number">56</span>:                         result = <span class="keyword">this</span>.mQClientFactory.getMQAdminImpl().searchOffset(mq, timestamp);</div><div class="line"><span class="number">57</span>:                     &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</div><div class="line"><span class="number">58</span>:                         result = -<span class="number">1</span>;</div><div class="line"><span class="number">59</span>:                     &#125;</div><div class="line"><span class="number">60</span>:                 &#125;</div><div class="line"><span class="number">61</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">62</span>:                 result = -<span class="number">1</span>;</div><div class="line"><span class="number">63</span>:             &#125;</div><div class="line"><span class="number">64</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">65</span>:         &#125;</div><div class="line"><span class="number">66</span>: </div><div class="line"><span class="number">67</span>:         <span class="keyword">default</span>:</div><div class="line"><span class="number">68</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">69</span>:     &#125;</div><div class="line"><span class="number">70</span>: </div><div class="line"><span class="number">71</span>:     <span class="keyword">return</span> result;</div><div class="line"><span class="number">72</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šè®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—å¼€å§‹æ¶ˆè´¹ä½ç½®ã€‚</li><li><code>PushConsumer</code> è¯»å–æ¶ˆè´¹è¿›åº¦æœ‰ä¸‰ç§é€‰é¡¹ï¼š<ul><li><code>CONSUME_FROM_LAST_OFFSET</code> ï¼šç¬¬ 6 è‡³ 29 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»<strong>é˜Ÿåˆ—çš„æœ€åä½ç½®</strong>å¼€å§‹æ¶ˆè´¹ã€‚<strong>åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹</strong>ã€‚</li><li><code>CONSUME_FROM_FIRST_OFFSET</code> ï¼šç¬¬ 30 è‡³ 40 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»é˜Ÿåˆ—çš„<strong>æœ€å‰ä½ç½®</strong>å¼€å§‹æ¶ˆè´¹ã€‚<strong>åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹</strong>ã€‚</li><li><code>CONSUME_FROM_TIMESTAMP</code> ï¼šç¬¬ 41 è‡³ 65 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»<strong>æŒ‡å®šæ—¶é—´ç‚¹</strong>å¼€å§‹æ¶ˆè´¹ã€‚<strong>åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹</strong>ã€‚</li></ul></li></ul><h2 id="PullConsumer-RebalancePullImpl-computePullFromWhere-â€¦"><a href="#PullConsumer-RebalancePullImpl-computePullFromWhere-â€¦" class="headerlink" title="[PullConsumer] RebalancePullImpl#computePullFromWhere(â€¦)"></a><code>[PullConsumer]</code> RebalancePullImpl#computePullFromWhere(â€¦)</h2><p>æš‚æ—¶è·³è¿‡ã€‚ğŸ˜ˆ</p><h1 id="6ã€PushConsumer-æ‹‰å–æ¶ˆæ¯"><a href="#6ã€PushConsumer-æ‹‰å–æ¶ˆæ¯" class="headerlink" title="6ã€PushConsumer æ‹‰å–æ¶ˆæ¯"></a>6ã€PushConsumer æ‹‰å–æ¶ˆæ¯</h1><p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/05.png" alt="DefaultMQPushConsumerImplæ‹‰å–æ¶ˆæ¯"></p><h2 id="PullMessageService"><a href="#PullMessageService" class="headerlink" title="PullMessageService"></a>PullMessageService</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PullMessageService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Logger log = ClientLogger.getLog();</div><div class="line">  <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line">  4:      * æ‹‰å–æ¶ˆæ¯è¯·æ±‚é˜Ÿåˆ—</div><div class="line">  5:      */</div><div class="line">  <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">final</span> LinkedBlockingQueue&lt;PullRequest&gt; pullRequestQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line">  <span class="number">7</span>:     <span class="comment">/**</span></div><div class="line">  8:      * MQClientå¯¹è±¡</div><div class="line">  9:      */</div><div class="line"> <span class="number">10</span>:     <span class="keyword">private</span> <span class="keyword">final</span> MQClientInstance mQClientFactory;</div><div class="line"> <span class="number">11</span>:     <span class="comment">/**</span></div><div class="line"> 12:      * å®šæ—¶å™¨ã€‚ç”¨äºå»¶è¿Ÿæäº¤æ‹‰å–è¯·æ±‚</div><div class="line"> 13:      */</div><div class="line"> <span class="number">14</span>:     <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduledExecutorService = Executors</div><div class="line"> <span class="number">15</span>:         .newSingleThreadScheduledExecutor(<span class="keyword">new</span> ThreadFactory() &#123;</div><div class="line"> <span class="number">16</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">17</span>:             <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line"> <span class="number">18</span>:                 <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">"PullMessageServiceScheduledThread"</span>);</div><div class="line"> <span class="number">19</span>:             &#125;</div><div class="line"> <span class="number">20</span>:         &#125;);</div><div class="line"> <span class="number">21</span>: </div><div class="line"> <span class="number">22</span>:     <span class="function"><span class="keyword">public</span> <span class="title">PullMessageService</span><span class="params">(MQClientInstance mQClientFactory)</span> </span>&#123;</div><div class="line"> <span class="number">23</span>:         <span class="keyword">this</span>.mQClientFactory = mQClientFactory;</div><div class="line"> <span class="number">24</span>:     &#125;</div><div class="line"> <span class="number">25</span>: </div><div class="line"> <span class="number">26</span>:     <span class="comment">/**</span></div><div class="line"> 27:      * æ‰§è¡Œå»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class="line"> 28:      *</div><div class="line"> 29:      * <span class="doctag">@param</span> pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class="line"> 30:      * <span class="doctag">@param</span> timeDelay å»¶è¿Ÿæ—¶é•¿</div><div class="line"> 31:      */</div><div class="line"> <span class="number">32</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executePullRequestLater</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest, <span class="keyword">final</span> <span class="keyword">long</span> timeDelay)</span> </span>&#123;</div><div class="line"> <span class="number">33</span>:         <span class="keyword">this</span>.scheduledExecutorService.schedule(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"> <span class="number">34</span>: </div><div class="line"> <span class="number">35</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">36</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">37</span>:                 PullMessageService.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"> <span class="number">38</span>:             &#125;</div><div class="line"> <span class="number">39</span>:         &#125;, timeDelay, TimeUnit.MILLISECONDS);</div><div class="line"> <span class="number">40</span>:     &#125;</div><div class="line"> <span class="number">41</span>: </div><div class="line"> <span class="number">42</span>:     <span class="comment">/**</span></div><div class="line"> 43:      * æ‰§è¡Œç«‹å³æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class="line"> 44:      *</div><div class="line"> 45:      * <span class="doctag">@param</span> pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class="line"> 46:      */</div><div class="line"> <span class="number">47</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executePullRequestImmediately</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class="line"> <span class="number">48</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">49</span>:             <span class="keyword">this</span>.pullRequestQueue.put(pullRequest);</div><div class="line"> <span class="number">50</span>:         &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"> <span class="number">51</span>:             log.error(<span class="string">"executePullRequestImmediately pullRequestQueue.put"</span>, e);</div><div class="line"> <span class="number">52</span>:         &#125;</div><div class="line"> <span class="number">53</span>:     &#125;</div><div class="line"> <span class="number">54</span>: </div><div class="line"> <span class="number">55</span>:     <span class="comment">/**</span></div><div class="line"> 56:      * æ‰§è¡Œå»¶è¿Ÿä»»åŠ¡</div><div class="line"> 57:      *</div><div class="line"> 58:      * <span class="doctag">@param</span> r ä»»åŠ¡</div><div class="line"> 59:      * <span class="doctag">@param</span> timeDelay å»¶è¿Ÿæ—¶é•¿</div><div class="line"> 60:      */</div><div class="line"> <span class="number">61</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeTaskLater</span><span class="params">(<span class="keyword">final</span> Runnable r, <span class="keyword">final</span> <span class="keyword">long</span> timeDelay)</span> </span>&#123;</div><div class="line"> <span class="number">62</span>:         <span class="keyword">this</span>.scheduledExecutorService.schedule(r, timeDelay, TimeUnit.MILLISECONDS);</div><div class="line"> <span class="number">63</span>:     &#125;</div><div class="line"> <span class="number">64</span>: </div><div class="line"> <span class="number">65</span>:     <span class="function"><span class="keyword">public</span> ScheduledExecutorService <span class="title">getScheduledExecutorService</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">66</span>:         <span class="keyword">return</span> scheduledExecutorService;</div><div class="line"> <span class="number">67</span>:     &#125;</div><div class="line"> <span class="number">68</span>: </div><div class="line"> <span class="number">69</span>:     <span class="comment">/**</span></div><div class="line"> 70:      * æ‹‰å–æ¶ˆæ¯</div><div class="line"> 71:      *</div><div class="line"> 72:      * <span class="doctag">@param</span> pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class="line"> 73:      */</div><div class="line"> <span class="number">74</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pullMessage</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class="line"> <span class="number">75</span>:         <span class="keyword">final</span> MQConsumerInner consumer = <span class="keyword">this</span>.mQClientFactory.selectConsumer(pullRequest.getConsumerGroup());</div><div class="line"> <span class="number">76</span>:         <span class="keyword">if</span> (consumer != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">77</span>:             DefaultMQPushConsumerImpl impl = (DefaultMQPushConsumerImpl) consumer;</div><div class="line"> <span class="number">78</span>:             impl.pullMessage(pullRequest);</div><div class="line"> <span class="number">79</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">80</span>:             log.warn(<span class="string">"No matched consumer for the PullRequest &#123;&#125;, drop it"</span>, pullRequest);</div><div class="line"> <span class="number">81</span>:         &#125;</div><div class="line"> <span class="number">82</span>:     &#125;</div><div class="line"> <span class="number">83</span>: </div><div class="line"> <span class="number">84</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">85</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">86</span>:         log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service started"</span>);</div><div class="line"> <span class="number">87</span>: </div><div class="line"> <span class="number">88</span>:         <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</div><div class="line"> <span class="number">89</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">90</span>:                 PullRequest pullRequest = <span class="keyword">this</span>.pullRequestQueue.take();</div><div class="line"> <span class="number">91</span>:                 <span class="keyword">if</span> (pullRequest != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">92</span>:                     <span class="keyword">this</span>.pullMessage(pullRequest);</div><div class="line"> <span class="number">93</span>:                 &#125;</div><div class="line"> <span class="number">94</span>:             &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"> <span class="number">95</span>:             &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">96</span>:                 log.error(<span class="string">"Pull Message Service Run Method exception"</span>, e);</div><div class="line"> <span class="number">97</span>:             &#125;</div><div class="line"> <span class="number">98</span>:         &#125;</div><div class="line"> <span class="number">99</span>: </div><div class="line"><span class="number">100</span>:         log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service end"</span>);</div><div class="line"><span class="number">101</span>:     &#125;</div><div class="line"><span class="number">102</span>: </div><div class="line"><span class="number">103</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">104</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getServiceName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">105</span>:         <span class="keyword">return</span> PullMessageService.class.getSimpleName();</div><div class="line"><span class="number">106</span>:     &#125;</div><div class="line"><span class="number">107</span>: </div><div class="line"><span class="number">108</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯æœåŠ¡ï¼Œä¸æ–­ä¸æ–­ä¸æ–­ä» <code>Broker</code> æ‹‰å–æ¶ˆæ¯ï¼Œå¹¶æäº¤æ¶ˆè´¹ä»»åŠ¡åˆ° <code>ConsumeMessageService</code>ã€‚</li><li><code>#executePullRequestLater(...)</code> ï¼šç¬¬ 26 è‡³ 40 è¡Œ ï¼š æäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li><li><code>#executePullRequestImmediately(...)</code> ï¼šç¬¬ 42 è‡³ 53 è¡Œ ï¼šæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li><li><code>#executeTaskLater(...)</code> ï¼šç¬¬ 55 è‡³ 63 è¡Œ ï¼šæäº¤<strong>å»¶è¿Ÿä»»åŠ¡</strong>ã€‚</li><li><code>#pullMessage(...)</code> ï¼šç¬¬ 69 è‡³ 82 è¡Œ ï¼šæ‰§è¡Œæ‹‰å–æ¶ˆæ¯é€»è¾‘ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#defaultmqpushconsumerimplpullmessage">DefaultMQPushConsumerImpl#pullMessage(â€¦)</a>ã€‚</li><li><code>#run(...)</code> ï¼šç¬¬ 84 è‡³ 101 è¡Œ ï¼šå¾ªç¯æ‹‰å–æ¶ˆæ¯è¯·æ±‚é˜Ÿåˆ—( <code>pullRequestQueue</code> )ï¼Œè¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€‚</li></ul><h2 id="DefaultMQPushConsumerImpl-pullMessage-â€¦"><a href="#DefaultMQPushConsumerImpl-pullMessage-â€¦" class="headerlink" title="DefaultMQPushConsumerImpl#pullMessage(â€¦)"></a>DefaultMQPushConsumerImpl#pullMessage(â€¦)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pullMessage</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="keyword">final</span> ProcessQueue processQueue = pullRequest.getProcessQueue();</div><div class="line">  <span class="number">3</span>:     <span class="keyword">if</span> (processQueue.isDropped()) &#123;</div><div class="line">  <span class="number">4</span>:         log.info(<span class="string">"the pull request[&#123;&#125;] is dropped."</span>, pullRequest.toString());</div><div class="line">  <span class="number">5</span>:         <span class="keyword">return</span>;</div><div class="line">  <span class="number">6</span>:     &#125;</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:     <span class="comment">// è®¾ç½®é˜Ÿåˆ—æœ€åæ‹‰å–æ¶ˆæ¯æ—¶é—´</span></div><div class="line">  <span class="number">9</span>:     pullRequest.getProcessQueue().setLastPullTimestamp(System.currentTimeMillis());</div><div class="line"> <span class="number">10</span>: </div><div class="line"> <span class="number">11</span>:     <span class="comment">// åˆ¤æ–­consumerçŠ¶æ€æ˜¯å¦è¿è¡Œä¸­ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯ã€‚</span></div><div class="line"> <span class="number">12</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">13</span>:         <span class="keyword">this</span>.makeSureStateOK();</div><div class="line"> <span class="number">14</span>:     &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</div><div class="line"> <span class="number">15</span>:         log.warn(<span class="string">"pullMessage exception, consumer state not ok"</span>, e);</div><div class="line"> <span class="number">16</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"> <span class="number">17</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">18</span>:     &#125;</div><div class="line"> <span class="number">19</span>: </div><div class="line"> <span class="number">20</span>:     <span class="comment">// åˆ¤æ–­æ˜¯å¦æš‚åœä¸­ã€‚</span></div><div class="line"> <span class="number">21</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.isPause()) &#123;</div><div class="line"> <span class="number">22</span>:         log.warn(<span class="string">"consumer was paused, execute pull request later. instanceName=&#123;&#125;, group=&#123;&#125;"</span>, <span class="keyword">this</span>.defaultMQPushConsumer.getInstanceName(), <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup());</div><div class="line"> <span class="number">23</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_SUSPEND);</div><div class="line"> <span class="number">24</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">25</span>:     &#125;</div><div class="line"> <span class="number">26</span>: </div><div class="line"> <span class="number">27</span>:     <span class="comment">// åˆ¤æ–­æ˜¯å¦è¶…è¿‡æœ€å¤§æŒæœ‰æ¶ˆæ¯æ•°é‡ã€‚é»˜è®¤æœ€å¤§å€¼ä¸º1000ã€‚</span></div><div class="line"> <span class="number">28</span>:     <span class="keyword">long</span> size = processQueue.getMsgCount().get();</div><div class="line"> <span class="number">29</span>:     <span class="keyword">if</span> (size &gt; <span class="keyword">this</span>.defaultMQPushConsumer.getPullThresholdForQueue()) &#123;</div><div class="line"> <span class="number">30</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL); <span class="comment">// æäº¤å»¶è¿Ÿæ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚50msã€‚</span></div><div class="line"> <span class="number">31</span>:         <span class="keyword">if</span> ((flowControlTimes1++ % <span class="number">1000</span>) == <span class="number">0</span>) &#123;</div><div class="line"> <span class="number">32</span>:             log.warn(</div><div class="line"> <span class="number">33</span>:                 <span class="string">"the consumer message buffer is full, so do flow control, minOffset=&#123;&#125;, maxOffset=&#123;&#125;, size=&#123;&#125;, pullRequest=&#123;&#125;, flowControlTimes=&#123;&#125;"</span>,</div><div class="line"> <span class="number">34</span>:                 processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), size, pullRequest, flowControlTimes1);</div><div class="line"> <span class="number">35</span>:         &#125;</div><div class="line"> <span class="number">36</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">37</span>:     &#125;</div><div class="line"> <span class="number">38</span>: </div><div class="line"> <span class="number">39</span>:     <span class="keyword">if</span> (!<span class="keyword">this</span>.consumeOrderly) &#123; <span class="comment">// åˆ¤æ–­æ¶ˆæ¯è·¨åº¦æ˜¯å¦è¿‡å¤§ã€‚</span></div><div class="line"> <span class="number">40</span>:         <span class="keyword">if</span> (processQueue.getMaxSpan() &gt; <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeConcurrentlyMaxSpan()) &#123;</div><div class="line"> <span class="number">41</span>:             <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL); <span class="comment">// æäº¤å»¶è¿Ÿæ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚50msã€‚</span></div><div class="line"> <span class="number">42</span>:             <span class="keyword">if</span> ((flowControlTimes2++ % <span class="number">1000</span>) == <span class="number">0</span>) &#123;</div><div class="line"> <span class="number">43</span>:                 log.warn(</div><div class="line"> <span class="number">44</span>:                     <span class="string">"the queue's messages, span too long, so do flow control, minOffset=&#123;&#125;, maxOffset=&#123;&#125;, maxSpan=&#123;&#125;, pullRequest=&#123;&#125;, flowControlTimes=&#123;&#125;"</span>,</div><div class="line"> <span class="number">45</span>:                     processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), processQueue.getMaxSpan(),</div><div class="line"> <span class="number">46</span>:                     pullRequest, flowControlTimes2);</div><div class="line"> <span class="number">47</span>:             &#125;</div><div class="line"> <span class="number">48</span>:             <span class="keyword">return</span>;</div><div class="line"> <span class="number">49</span>:         &#125;</div><div class="line"> <span class="number">50</span>:     &#125; <span class="keyword">else</span> &#123; <span class="comment">// TODO é¡ºåºæ¶ˆè´¹</span></div><div class="line"> <span class="number">51</span>:         <span class="keyword">if</span> (processQueue.isLocked()) &#123;</div><div class="line"> <span class="number">52</span>:             <span class="keyword">if</span> (!pullRequest.isLockedFirst()) &#123;</div><div class="line"> <span class="number">53</span>:                 <span class="keyword">final</span> <span class="keyword">long</span> offset = <span class="keyword">this</span>.rebalanceImpl.computePullFromWhere(pullRequest.getMessageQueue());</div><div class="line"> <span class="number">54</span>:                 <span class="keyword">boolean</span> brokerBusy = offset &lt; pullRequest.getNextOffset();</div><div class="line"> <span class="number">55</span>:                 log.info(<span class="string">"the first time to pull message, so fix offset from broker. pullRequest: &#123;&#125; NewOffset: &#123;&#125; brokerBusy: &#123;&#125;"</span>,</div><div class="line"> <span class="number">56</span>:                     pullRequest, offset, brokerBusy);</div><div class="line"> <span class="number">57</span>:                 <span class="keyword">if</span> (brokerBusy) &#123;</div><div class="line"> <span class="number">58</span>:                     log.info(<span class="string">"[NOTIFYME]the first time to pull message, but pull request offset larger than broker consume offset. pullRequest: &#123;&#125; NewOffset: &#123;&#125;"</span>,</div><div class="line"> <span class="number">59</span>:                         pullRequest, offset);</div><div class="line"> <span class="number">60</span>:                 &#125;</div><div class="line"> <span class="number">61</span>: </div><div class="line"> <span class="number">62</span>:                 pullRequest.setLockedFirst(<span class="keyword">true</span>);</div><div class="line"> <span class="number">63</span>:                 pullRequest.setNextOffset(offset);</div><div class="line"> <span class="number">64</span>:             &#125;</div><div class="line"> <span class="number">65</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">66</span>:             <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"> <span class="number">67</span>:             log.info(<span class="string">"pull message later because not locked in broker, &#123;&#125;"</span>, pullRequest);</div><div class="line"> <span class="number">68</span>:             <span class="keyword">return</span>;</div><div class="line"> <span class="number">69</span>:         &#125;</div><div class="line"> <span class="number">70</span>:     &#125;</div><div class="line"> <span class="number">71</span>: </div><div class="line"> <span class="number">72</span>:     <span class="comment">// è·å–Topic å¯¹åº”çš„è®¢é˜…ä¿¡æ¯ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯</span></div><div class="line"> <span class="number">73</span>:     <span class="keyword">final</span> SubscriptionData subscriptionData = <span class="keyword">this</span>.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());</div><div class="line"> <span class="number">74</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == subscriptionData) &#123;</div><div class="line"> <span class="number">75</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"> <span class="number">76</span>:         log.warn(<span class="string">"find the consumer's subscription failed, &#123;&#125;"</span>, pullRequest);</div><div class="line"> <span class="number">77</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">78</span>:     &#125;</div><div class="line"> <span class="number">79</span>: </div><div class="line"> <span class="number">80</span>:     <span class="keyword">final</span> <span class="keyword">long</span> beginTimestamp = System.currentTimeMillis();</div><div class="line"> <span class="number">81</span>: </div><div class="line"> <span class="number">82</span>:     PullCallback pullCallback = <span class="keyword">new</span> PullCallback() &#123;</div><div class="line"> <span class="number">83</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">84</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(PullResult pullResult)</span> </span>&#123;</div><div class="line"> <span class="number">85</span>:             <span class="keyword">if</span> (pullResult != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">86</span>:                 pullResult = DefaultMQPushConsumerImpl.<span class="keyword">this</span>.pullAPIWrapper.processPullResult(pullRequest.getMessageQueue(), pullResult,</div><div class="line"> <span class="number">87</span>:                     subscriptionData);</div><div class="line"> <span class="number">88</span>: </div><div class="line"> <span class="number">89</span>:                 <span class="keyword">switch</span> (pullResult.getPullStatus()) &#123;</div><div class="line"> <span class="number">90</span>:                     <span class="keyword">case</span> FOUND:</div><div class="line"> <span class="number">91</span>:                         <span class="comment">// è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</span></div><div class="line"> <span class="number">92</span>:                         <span class="keyword">long</span> prevRequestOffset = pullRequest.getNextOffset();</div><div class="line"> <span class="number">93</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class="line"> <span class="number">94</span>: </div><div class="line"> <span class="number">95</span>:                         <span class="comment">// ç»Ÿè®¡</span></div><div class="line"> <span class="number">96</span>:                         <span class="keyword">long</span> pullRT = System.currentTimeMillis() - beginTimestamp;</div><div class="line"> <span class="number">97</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.getConsumerStatsManager().incPullRT(pullRequest.getConsumerGroup(),</div><div class="line"> <span class="number">98</span>:                             pullRequest.getMessageQueue().getTopic(), pullRT);</div><div class="line"> <span class="number">99</span>: </div><div class="line"><span class="number">100</span>:                         <span class="keyword">long</span> firstMsgOffset = Long.MAX_VALUE;</div><div class="line"><span class="number">101</span>:                         <span class="keyword">if</span> (pullResult.getMsgFoundList() == <span class="keyword">null</span> || pullResult.getMsgFoundList().isEmpty()) &#123;</div><div class="line"><span class="number">102</span>:                             DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">103</span>:                         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">104</span>:                             firstMsgOffset = pullResult.getMsgFoundList().get(<span class="number">0</span>).getQueueOffset();</div><div class="line"><span class="number">105</span>: </div><div class="line"><span class="number">106</span>:                             <span class="comment">// ç»Ÿè®¡</span></div><div class="line"><span class="number">107</span>:                             DefaultMQPushConsumerImpl.<span class="keyword">this</span>.getConsumerStatsManager().incPullTPS(pullRequest.getConsumerGroup(),</div><div class="line"><span class="number">108</span>:                                 pullRequest.getMessageQueue().getTopic(), pullResult.getMsgFoundList().size());</div><div class="line"><span class="number">109</span>: </div><div class="line"><span class="number">110</span>:                             <span class="comment">// æäº¤æ‹‰å–åˆ°çš„æ¶ˆæ¯åˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</span></div><div class="line"><span class="number">111</span>:                             <span class="keyword">boolean</span> dispathToConsume = processQueue.putMessage(pullResult.getMsgFoundList());</div><div class="line"><span class="number">112</span>: </div><div class="line"><span class="number">113</span>:                             <span class="comment">// æäº¤æ¶ˆè´¹è¯·æ±‚</span></div><div class="line"><span class="number">114</span>:                             DefaultMQPushConsumerImpl.<span class="keyword">this</span>.consumeMessageService.submitConsumeRequest(<span class="comment">//</span></div><div class="line"><span class="number">115</span>:                                 pullResult.getMsgFoundList(), <span class="comment">//</span></div><div class="line"><span class="number">116</span>:                                 processQueue, <span class="comment">//</span></div><div class="line"><span class="number">117</span>:                                 pullRequest.getMessageQueue(), <span class="comment">//</span></div><div class="line"><span class="number">118</span>:                                 dispathToConsume);</div><div class="line"><span class="number">119</span>: </div><div class="line"><span class="number">120</span>:                             <span class="comment">// æäº¤ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯è¯·æ±‚</span></div><div class="line"><span class="number">121</span>:                             <span class="keyword">if</span> (DefaultMQPushConsumerImpl.<span class="keyword">this</span>.defaultMQPushConsumer.getPullInterval() &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">122</span>:                                 DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestLater(pullRequest,</div><div class="line"><span class="number">123</span>:                                     DefaultMQPushConsumerImpl.<span class="keyword">this</span>.defaultMQPushConsumer.getPullInterval());</div><div class="line"><span class="number">124</span>:                             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">125</span>:                                 DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">126</span>:                             &#125;</div><div class="line"><span class="number">127</span>:                         &#125;</div><div class="line"><span class="number">128</span>: </div><div class="line"><span class="number">129</span>:                         <span class="comment">// ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½® æˆ–è€… ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼Œåˆ™åˆ¤å®šä¸ºBUGï¼Œè¾“å‡ºlog</span></div><div class="line"><span class="number">130</span>:                         <span class="keyword">if</span> (pullResult.getNextBeginOffset() &lt; prevRequestOffset<span class="comment">//</span></div><div class="line"><span class="number">131</span>:                             || firstMsgOffset &lt; prevRequestOffset) &#123;</div><div class="line"><span class="number">132</span>:                             log.warn(</div><div class="line"><span class="number">133</span>:                                 <span class="string">"[BUG] pull message result maybe data wrong, nextBeginOffset: &#123;&#125; firstMsgOffset: &#123;&#125; prevRequestOffset: &#123;&#125;"</span>, <span class="comment">//</span></div><div class="line"><span class="number">134</span>:                                 pullResult.getNextBeginOffset(), <span class="comment">//</span></div><div class="line"><span class="number">135</span>:                                 firstMsgOffset, <span class="comment">//</span></div><div class="line"><span class="number">136</span>:                                 prevRequestOffset);</div><div class="line"><span class="number">137</span>:                         &#125;</div><div class="line"><span class="number">138</span>: </div><div class="line"><span class="number">139</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">140</span>:                     <span class="keyword">case</span> NO_NEW_MSG:</div><div class="line"><span class="number">141</span>:                         <span class="comment">// è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</span></div><div class="line"><span class="number">142</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class="line"><span class="number">143</span>: </div><div class="line"><span class="number">144</span>:                         <span class="comment">// æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦</span></div><div class="line"><span class="number">145</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.correctTagsOffset(pullRequest);</div><div class="line"><span class="number">146</span>: </div><div class="line"><span class="number">147</span>:                         <span class="comment">// ç«‹å³æäº¤æ‹‰å–æ¶ˆæ¯è¯·æ±‚</span></div><div class="line"><span class="number">148</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">149</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">150</span>:                     <span class="keyword">case</span> NO_MATCHED_MSG:</div><div class="line"><span class="number">151</span>:                         <span class="comment">// è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</span></div><div class="line"><span class="number">152</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class="line"><span class="number">153</span>: </div><div class="line"><span class="number">154</span>:                         <span class="comment">// æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦</span></div><div class="line"><span class="number">155</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.correctTagsOffset(pullRequest);</div><div class="line"><span class="number">156</span>: </div><div class="line"><span class="number">157</span>:                         <span class="comment">// æäº¤ç«‹å³æ‹‰å–æ¶ˆæ¯è¯·æ±‚</span></div><div class="line"><span class="number">158</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">159</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">160</span>:                     <span class="keyword">case</span> OFFSET_ILLEGAL:</div><div class="line"><span class="number">161</span>:                         log.warn(<span class="string">"the pull request offset illegal, &#123;&#125; &#123;&#125;"</span>, <span class="comment">//</span></div><div class="line"><span class="number">162</span>:                             pullRequest.toString(), pullResult.toString());</div><div class="line"><span class="number">163</span>:                         <span class="comment">// è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</span></div><div class="line"><span class="number">164</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class="line"><span class="number">165</span>: </div><div class="line"><span class="number">166</span>:                         <span class="comment">// è®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸ºdropped</span></div><div class="line"><span class="number">167</span>:                         pullRequest.getProcessQueue().setDropped(<span class="keyword">true</span>);</div><div class="line"><span class="number">168</span>: </div><div class="line"><span class="number">169</span>:                         <span class="comment">// æäº¤å»¶è¿Ÿä»»åŠ¡ï¼Œè¿›è¡Œæ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ç§»é™¤ã€‚ä¸ç«‹å³ç§»é™¤çš„åŸå› ï¼šå¯èƒ½æœ‰åœ°æ–¹æ­£åœ¨ä½¿ç”¨ï¼Œé¿å…å—åˆ°å½±å“ã€‚</span></div><div class="line"><span class="number">170</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executeTaskLater(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"><span class="number">171</span>: </div><div class="line"><span class="number">172</span>:                             <span class="meta">@Override</span></div><div class="line"><span class="number">173</span>:                             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">174</span>:                                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">175</span>:                                     <span class="comment">// æ›´æ–°æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ°Broker</span></div><div class="line"><span class="number">176</span>:                                     DefaultMQPushConsumerImpl.<span class="keyword">this</span>.offsetStore.updateOffset(pullRequest.getMessageQueue(),</div><div class="line"><span class="number">177</span>:                                         pullRequest.getNextOffset(), <span class="keyword">false</span>);</div><div class="line"><span class="number">178</span>:                                     DefaultMQPushConsumerImpl.<span class="keyword">this</span>.offsetStore.persist(pullRequest.getMessageQueue());</div><div class="line"><span class="number">179</span>: </div><div class="line"><span class="number">180</span>:                                     <span class="comment">// ç§»é™¤æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—</span></div><div class="line"><span class="number">181</span>:                                     DefaultMQPushConsumerImpl.<span class="keyword">this</span>.rebalanceImpl.removeProcessQueue(pullRequest.getMessageQueue());</div><div class="line"><span class="number">182</span>: </div><div class="line"><span class="number">183</span>:                                     log.warn(<span class="string">"fix the pull request offset, &#123;&#125;"</span>, pullRequest);</div><div class="line"><span class="number">184</span>:                                 &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">185</span>:                                     log.error(<span class="string">"executeTaskLater Exception"</span>, e);</div><div class="line"><span class="number">186</span>:                                 &#125;</div><div class="line"><span class="number">187</span>:                             &#125;</div><div class="line"><span class="number">188</span>:                         &#125;, <span class="number">10000</span>);</div><div class="line"><span class="number">189</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">190</span>:                     <span class="keyword">default</span>:</div><div class="line"><span class="number">191</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">192</span>:                 &#125;</div><div class="line"><span class="number">193</span>:             &#125;</div><div class="line"><span class="number">194</span>:         &#125;</div><div class="line"><span class="number">195</span>: </div><div class="line"><span class="number">196</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">197</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onException</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line"><span class="number">198</span>:             <span class="keyword">if</span> (!pullRequest.getMessageQueue().getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class="line"><span class="number">199</span>:                 log.warn(<span class="string">"execute the pull request exception"</span>, e);</div><div class="line"><span class="number">200</span>:             &#125;</div><div class="line"><span class="number">201</span>: </div><div class="line"><span class="number">202</span>:             <span class="comment">// æäº¤å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚</span></div><div class="line"><span class="number">203</span>:             DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"><span class="number">204</span>:         &#125;</div><div class="line"><span class="number">205</span>:     &#125;;</div><div class="line"><span class="number">206</span>: </div><div class="line"><span class="number">207</span>:     <span class="comment">// é›†ç¾¤æ¶ˆæ¯æ¨¡å‹ä¸‹ï¼Œè®¡ç®—æäº¤çš„æ¶ˆè´¹è¿›åº¦ã€‚</span></div><div class="line"><span class="number">208</span>:     <span class="keyword">boolean</span> commitOffsetEnable = <span class="keyword">false</span>;</div><div class="line"><span class="number">209</span>:     <span class="keyword">long</span> commitOffsetValue = <span class="number">0L</span>;</div><div class="line"><span class="number">210</span>:     <span class="keyword">if</span> (MessageModel.CLUSTERING == <span class="keyword">this</span>.defaultMQPushConsumer.getMessageModel()) &#123;</div><div class="line"><span class="number">211</span>:         commitOffsetValue = <span class="keyword">this</span>.offsetStore.readOffset(pullRequest.getMessageQueue(), ReadOffsetType.READ_FROM_MEMORY);</div><div class="line"><span class="number">212</span>:         <span class="keyword">if</span> (commitOffsetValue &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">213</span>:             commitOffsetEnable = <span class="keyword">true</span>;</div><div class="line"><span class="number">214</span>:         &#125;</div><div class="line"><span class="number">215</span>:     &#125;</div><div class="line"><span class="number">216</span>: </div><div class="line"><span class="number">217</span>:     <span class="comment">// è®¡ç®—è¯·æ±‚çš„ è®¢é˜…è¡¨è¾¾å¼ å’Œ æ˜¯å¦è¿›è¡Œfiltersrvè¿‡æ»¤æ¶ˆæ¯</span></div><div class="line"><span class="number">218</span>:     String subExpression = <span class="keyword">null</span>;</div><div class="line"><span class="number">219</span>:     <span class="keyword">boolean</span> classFilter = <span class="keyword">false</span>;</div><div class="line"><span class="number">220</span>:     SubscriptionData sd = <span class="keyword">this</span>.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());</div><div class="line"><span class="number">221</span>:     <span class="keyword">if</span> (sd != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">222</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.defaultMQPushConsumer.isPostSubscriptionWhenPull() &amp;&amp; !sd.isClassFilterMode()) &#123;</div><div class="line"><span class="number">223</span>:             subExpression = sd.getSubString();</div><div class="line"><span class="number">224</span>:         &#125;</div><div class="line"><span class="number">225</span>: </div><div class="line"><span class="number">226</span>:         classFilter = sd.isClassFilterMode();</div><div class="line"><span class="number">227</span>:     &#125;</div><div class="line"><span class="number">228</span>: </div><div class="line"><span class="number">229</span>:     <span class="comment">// è®¡ç®—æ‹‰å–æ¶ˆæ¯ç³»ç»Ÿæ ‡è¯†</span></div><div class="line"><span class="number">230</span>:     <span class="keyword">int</span> sysFlag = PullSysFlag.buildSysFlag(<span class="comment">//</span></div><div class="line"><span class="number">231</span>:         commitOffsetEnable, <span class="comment">// commitOffset</span></div><div class="line"><span class="number">232</span>:         <span class="keyword">true</span>, <span class="comment">// suspend</span></div><div class="line"><span class="number">233</span>:         subExpression != <span class="keyword">null</span>, <span class="comment">// subscription</span></div><div class="line"><span class="number">234</span>:         classFilter <span class="comment">// class filter</span></div><div class="line"><span class="number">235</span>:     );</div><div class="line"><span class="number">236</span>: </div><div class="line"><span class="number">237</span>:     <span class="comment">// æ‰§è¡Œæ‹‰å–ã€‚å¦‚æœæ‹‰å–è¯·æ±‚å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæäº¤å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</span></div><div class="line"><span class="number">238</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">239</span>:         <span class="keyword">this</span>.pullAPIWrapper.pullKernelImpl(<span class="comment">//</span></div><div class="line"><span class="number">240</span>:             pullRequest.getMessageQueue(), <span class="comment">// 1</span></div><div class="line"><span class="number">241</span>:             subExpression, <span class="comment">// 2</span></div><div class="line"><span class="number">242</span>:             subscriptionData.getSubVersion(), <span class="comment">// 3</span></div><div class="line"><span class="number">243</span>:             pullRequest.getNextOffset(), <span class="comment">// 4</span></div><div class="line"><span class="number">244</span>:             <span class="keyword">this</span>.defaultMQPushConsumer.getPullBatchSize(), <span class="comment">// 5</span></div><div class="line"><span class="number">245</span>:             sysFlag, <span class="comment">// 6</span></div><div class="line"><span class="number">246</span>:             commitOffsetValue, <span class="comment">// 7</span></div><div class="line"><span class="number">247</span>:             BROKER_SUSPEND_MAX_TIME_MILLIS, <span class="comment">// 8</span></div><div class="line"><span class="number">248</span>:             CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND, <span class="comment">// 9</span></div><div class="line"><span class="number">249</span>:             CommunicationMode.ASYNC, <span class="comment">// 10</span></div><div class="line"><span class="number">250</span>:             pullCallback<span class="comment">// 11</span></div><div class="line"><span class="number">251</span>:         );</div><div class="line"><span class="number">252</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">253</span>:         log.error(<span class="string">"pullKernelImpl exception"</span>, e);</div><div class="line"><span class="number">254</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"><span class="number">255</span>:     &#125;</div><div class="line"><span class="number">256</span>: &#125;</div><div class="line"><span class="number">257</span>: </div><div class="line"><span class="number">258</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">correctTagsOffset</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class="line"><span class="number">259</span>:     <span class="keyword">if</span> (<span class="number">0L</span> == pullRequest.getProcessQueue().getMsgCount().get()) &#123;</div><div class="line"><span class="number">260</span>:         <span class="keyword">this</span>.offsetStore.updateOffset(pullRequest.getMessageQueue(), pullRequest.getNextOffset(), <span class="keyword">true</span>);</div><div class="line"><span class="number">261</span>:     &#125;</div><div class="line"><span class="number">262</span>: &#125;</div></pre></td></tr></table></figure><ul><li><code>#pullMessage(...)</code> è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯ã€‚<ul><li>ç¬¬ 3 è‡³ 6 è¡Œ ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å·²ç»ç»ˆæ­¢ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€‚</li><li>ç¬¬ 9 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æœ€åæ‹‰å–æ¶ˆæ¯æ—¶é—´ã€‚</li><li>ç¬¬ 11 è‡³ 18 è¡Œ ï¼š<code>Consumer</code> æœªå¤„äºè¿è¡Œä¸­çŠ¶æ€ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li><li>ç¬¬ 20 è‡³ 25 è¡Œ ï¼š <code>Consumer</code> å¤„äºæš‚åœä¸­ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li><li>ç¬¬ 27 è‡³ 37 è¡Œ ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯è¶…è¿‡æœ€å¤§å…è®¸å€¼ï¼ˆé»˜è®¤ï¼š1000æ¡ï¼‰ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li><li>ç¬¬ 39 è‡³ 49 è¡Œ ï¼š<code>Consumer</code> ä¸º<strong>å¹¶å‘æ¶ˆè´¹</strong> å¹¶ä¸” æ¶ˆæ¯é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯è·¨åº¦è¿‡å¤§ï¼ˆæ¶ˆæ¯è·¨åº¦ = æŒæœ‰æ¶ˆæ¯æœ€åä¸€æ¡å’Œç¬¬ä¸€æ¡çš„æ¶ˆæ¯ä½ç½®å·®ï¼Œé»˜è®¤ï¼š2000ï¼‰ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li><li>ç¬¬ 50 è‡³ 70 è¡Œ ï¼š<code>é¡ºåºæ¶ˆè´¹</code> ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š<a href="http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹</a>ã€‚</li><li>ç¬¬ 72 è‡³ 78 è¡Œ ï¼š<code>Topic</code> å¯¹åº”çš„è®¢é˜…ä¿¡æ¯ä¸å­˜åœ¨ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li><li>ç¬¬ 222 è‡³ 224 è¡Œ ï¼šåˆ¤æ–­è¯·æ±‚æ˜¯å¦ä½¿ç”¨ <code>Consumer</code> <strong>æœ¬åœ°</strong>çš„è®¢é˜…ä¿¡æ¯( <code>SubscriptionData</code> )ï¼Œè€Œä¸ä½¿ç”¨ <code>Broker</code> é‡Œçš„è®¢é˜…ä¿¡æ¯ã€‚è¯¦ç»†è§£æè§ï¼š<a href="http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageProcessor-processRequest-â€¦">PullMessageProcessor#processRequest(â€¦) ç¬¬ 64 è‡³ 110 è¡Œä»£ç </a>ã€‚</li><li>ç¬¬ 226 è¡Œ ï¼šæ˜¯å¦å¼€å¯è¿‡æ»¤ç±»è¿‡æ»¤æ¨¡å¼ã€‚è¯¦ç»†è§£æè§ï¼š<a href="http://www.yunai.me/RocketMQ/filtersrv/">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Filtersrvã€‹</a>ã€‚</li><li>ç¬¬ 229 è‡³ 235 è¡Œ ï¼šè®¡ç®—æ‹‰å–æ¶ˆæ¯è¯·æ±‚ç³»ç»Ÿæ ‡è¯†ã€‚è¯¦ç»†è§£æè§ï¼š<a href="http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageRequestHeader">PullMessageRequestHeader.sysFlag</a>ã€‚</li><li>ç¬¬ 237 è‡³ 255 è¡Œ ï¼š<ul><li>æ‰§è¡Œæ¶ˆæ¯æ‹‰å–<strong>å¼‚æ­¥</strong>è¯·æ±‚ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#pullapiwrapperpullkernelimpl">PullAPIWrapper#pullKernelImpl(â€¦)</a>ã€‚</li><li>å½“å‘èµ·è¯·æ±‚äº§ç”Ÿå¼‚å¸¸æ—¶ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚å¯¹åº” <code>Broker</code> å¤„ç†æ‹‰å–æ¶ˆæ¯é€»è¾‘è§ï¼š<a href="http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageProcessor-processRequest-â€¦">PullMessageProcessor#processRequest(â€¦)</a>ã€‚</li></ul></li></ul></li><li><code>PullCallback</code> ï¼šæ‹‰å–æ¶ˆæ¯å›è°ƒï¼š<ul><li>ç¬¬ 86 è¡Œ ï¼šå¤„ç†æ‹‰å–ç»“æœã€‚è¯¦ç»†é€»è¾‘è§ï¼š<a href="#pullapiwrapperprocesspullresult">PullAPIWrapper#processPullResult(â€¦)</a>ã€‚</li><li>ç¬¬ 89 è‡³ 192 è¡Œ ï¼šå¤„ç†æ‹‰å–çŠ¶æ€ç»“æœï¼š<ul><li>ç¬¬ 90 è‡³ 139 è¡Œ ï¼šæ‹‰å–åˆ°æ¶ˆæ¯( <code>FOUND</code> ) ï¼š<ul><li>ç¬¬ 91 è‡³ 93 è¡Œ ï¼šè®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li><li>ç¬¬ 95 è‡³ 97 è¡Œ ï¼šç»Ÿè®¡ã€‚</li><li>ç¬¬ 101 è‡³ 102 è¡Œ ï¼šæ‹‰å–åˆ°æ¶ˆæ¯çš„æ¶ˆæ¯åˆ—è¡¨ä¸ºç©ºï¼Œæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚ä¸ºä»€ä¹ˆä¼šå­˜åœ¨æ‹‰å–åˆ°æ¶ˆæ¯ï¼Œä½†æ˜¯æ¶ˆæ¯ç»“æœæœªç©ºå‘¢ï¼ŸåŸå› è§ï¼š<a href="#pullapiwrapperprocesspullresult">PullAPIWrapper#processPullResult(â€¦)</a>ã€‚</li><li>ç¬¬ 106 è‡³ 108 è¡Œ ï¼šç»Ÿè®¡ã€‚</li><li>ç¬¬ 111 è¡Œ ï¼šæäº¤æ‹‰å–åˆ°çš„æ¶ˆæ¯åˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#processqueueputmessage">ProcessQueue#putMessage(â€¦)</a>ã€‚</li><li>ç¬¬ 113 è‡³ 118 è¡Œ ï¼šæäº¤æ¶ˆè´¹è¯·æ±‚åˆ° <code>ConsumeMessageService</code>ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#consumemessageconcurrentlyservice">ConsumeMessageConcurrentlyService</a>ã€‚</li><li>ç¬¬ 120 è‡³ 126 è¡Œ ï¼šæ ¹æ®æ‹‰å–é¢‘ç‡( <code>pullInterval</code> )ï¼Œæäº¤<strong>ç«‹å³æˆ–è€…å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚é»˜è®¤æ‹‰å–é¢‘ç‡ä¸º 0ms ï¼Œæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li><li>ç¬¬ 129 è‡³ 137 è¡Œ ï¼šä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½® æˆ–è€… ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼Œåˆ™åˆ¤å®šä¸º<strong>BUG</strong>ï¼Œè¾“å‡ºè­¦å‘Šæ—¥å¿—ã€‚<ul><li>ç¬¬ 140 è‡³ 149 è¡Œ ï¼šæ²¡æœ‰æ–°æ¶ˆæ¯( <code>NO_NEW_MSG</code> ) ï¼š</li></ul></li><li>ç¬¬ 142 è¡Œ ï¼š è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li><li>ç¬¬ 145 è¡Œ ï¼šæ›´æ­£æ¶ˆè´¹è¿›åº¦ã€‚è¯¦ç»†è§£æè§ï¼š<code>#correctTagsOffset(...)</code>ã€‚</li><li>ç¬¬ 148 è¡Œ ï¼šæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚<ul><li>ç¬¬ 150 è‡³ 159 è¡Œ ï¼šæœ‰æ–°æ¶ˆæ¯ä½†æ˜¯ä¸åŒ¹é…( <code>NO_MATCHED_MSG</code> )ã€‚é€»è¾‘åŒ <code>NO_NEW_MSG</code> ã€‚</li><li>ç¬¬ 160 è‡³ 189 è¡Œ ï¼šæ‹‰å–è¯·æ±‚çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ä¸åˆæ³• (<code>OFFSET_ILLEGAL</code>)ã€‚</li></ul></li><li>ç¬¬ 164 è¡Œ ï¼šè®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li><li>ç¬¬ 167 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸º <code>dropped</code>ã€‚</li><li>ç¬¬ 169 è‡³ 188 è¡Œ ï¼šæäº¤å»¶è¿Ÿä»»åŠ¡ï¼Œè¿›è¡Œé˜Ÿåˆ—ç§»é™¤ã€‚<ul><li>ç¬¬ 175 è‡³ 178 è¡Œ ï¼šæ›´æ–°æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ° <code>Broker</code>ã€‚</li><li>ç¬¬ 181 è¡Œ ï¼šç§»é™¤æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ã€‚<ul><li>ç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸ç«‹å³ç§»é™¤ï¼Ÿï¼Ÿï¼Ÿ<ul><li>ç¬¬ 196 è‡³ 204 è¡Œ ï¼šå‘ç”Ÿå¼‚å¸¸ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li><li><code>#correctTagsOffset(...)</code> ï¼šæ›´æ­£æ¶ˆè´¹è¿›åº¦ã€‚<ul><li>ç¬¬ 258 è‡³ 261 è¡Œ ï¼š å½“æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯æ•°é‡ä¸º <strong>0</strong> æ—¶ï¼Œæ›´æ–°æ¶ˆè´¹è¿›åº¦ä¸ºæ‹‰å–è¯·æ±‚çš„æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li></ul></li></ul><h3 id="PullAPIWrapper-pullKernelImpl-â€¦"><a href="#PullAPIWrapper-pullKernelImpl-â€¦" class="headerlink" title="PullAPIWrapper#pullKernelImpl(â€¦)"></a>PullAPIWrapper#pullKernelImpl(â€¦)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * æ‹‰å–æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•</div><div class="line"> 3:  *</div><div class="line"> 4:  * <span class="doctag">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 5:  * <span class="doctag">@param</span> subExpression è®¢é˜…è¡¨è¾¾å¼</div><div class="line"> 6:  * <span class="doctag">@param</span> subVersion è®¢é˜…ç‰ˆæœ¬å·</div><div class="line"> 7:  * <span class="doctag">@param</span> offset æ‹‰å–é˜Ÿåˆ—å¼€å§‹ä½ç½®</div><div class="line"> 8:  * <span class="doctag">@param</span> maxNums æ‹‰å–æ¶ˆæ¯æ•°é‡</div><div class="line"> 9:  * <span class="doctag">@param</span> sysFlag æ‹‰å–è¯·æ±‚ç³»ç»Ÿæ ‡è¯†</div><div class="line">10:  * <span class="doctag">@param</span> commitOffset æäº¤æ¶ˆè´¹è¿›åº¦</div><div class="line">11:  * <span class="doctag">@param</span> brokerSuspendMaxTimeMillis brokeræŒ‚èµ·è¯·æ±‚æœ€å¤§æ—¶é—´</div><div class="line">12:  * <span class="doctag">@param</span> timeoutMillis è¯·æ±‚brokerè¶…æ—¶æ—¶é•¿</div><div class="line">13:  * <span class="doctag">@param</span> communicationMode é€šè®¯æ¨¡å¼</div><div class="line">14:  * <span class="doctag">@param</span> pullCallback æ‹‰å–å›è°ƒ</div><div class="line">15:  * <span class="doctag">@return</span> æ‹‰å–æ¶ˆæ¯ç»“æœã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶ï¼Œæ‰è¿”å›ç»“æœï¼Œå¦åˆ™è¿”å›nullã€‚</div><div class="line">16:  * <span class="doctag">@throws</span> MQClientException å½“å¯»æ‰¾ä¸åˆ° broker æ—¶ï¼Œæˆ–å‘ç”Ÿå…¶ä»–clientå¼‚å¸¸</div><div class="line">17:  * <span class="doctag">@throws</span> RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class="line">18:  * <span class="doctag">@throws</span> MQBrokerException å½“ broker å‘ç”Ÿå¼‚å¸¸æ—¶ã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶æ‰ä¼šå‘ç”Ÿè¯¥å¼‚å¸¸ã€‚</div><div class="line">19:  * <span class="doctag">@throws</span> InterruptedException å½“å‘ç”Ÿä¸­æ–­å¼‚å¸¸æ—¶</div><div class="line">20:  */</div><div class="line"><span class="number">21</span>: <span class="function"><span class="keyword">protected</span> PullResult <span class="title">pullKernelImpl</span><span class="params">(</span></span></div><div class="line"><span class="number">22</span>:     <span class="keyword">final</span> MessageQueue mq,</div><div class="line"><span class="number">23</span>:     <span class="keyword">final</span> String subExpression,</div><div class="line"><span class="number">24</span>:     <span class="keyword">final</span> <span class="keyword">long</span> subVersion,</div><div class="line"><span class="number">25</span>:     <span class="keyword">final</span> <span class="keyword">long</span> offset,</div><div class="line"><span class="number">26</span>:     <span class="keyword">final</span> <span class="keyword">int</span> maxNums,</div><div class="line"><span class="number">27</span>:     <span class="keyword">final</span> <span class="keyword">int</span> sysFlag,</div><div class="line"><span class="number">28</span>:     <span class="keyword">final</span> <span class="keyword">long</span> commitOffset,</div><div class="line"><span class="number">29</span>:     <span class="keyword">final</span> <span class="keyword">long</span> brokerSuspendMaxTimeMillis,</div><div class="line"><span class="number">30</span>:     <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis,</div><div class="line"><span class="number">31</span>:     <span class="keyword">final</span> CommunicationMode communicationMode,</div><div class="line"><span class="number">32</span>:     <span class="keyword">final</span> PullCallback pullCallback</div><div class="line"><span class="number">33</span>: ) <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</div><div class="line"><span class="number">34</span>:     <span class="comment">// è·å–Brokerä¿¡æ¯</span></div><div class="line"><span class="number">35</span>:     FindBrokerResult findBrokerResult =</div><div class="line"><span class="number">36</span>:         <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),</div><div class="line"><span class="number">37</span>:             <span class="keyword">this</span>.recalculatePullFromWhichNode(mq), <span class="keyword">false</span>);</div><div class="line"><span class="number">38</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == findBrokerResult) &#123;</div><div class="line"><span class="number">39</span>:         <span class="keyword">this</span>.mQClientFactory.updateTopicRouteInfoFromNameServer(mq.getTopic());</div><div class="line"><span class="number">40</span>:         findBrokerResult =</div><div class="line"><span class="number">41</span>:             <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),</div><div class="line"><span class="number">42</span>:                 <span class="keyword">this</span>.recalculatePullFromWhichNode(mq), <span class="keyword">false</span>);</div><div class="line"><span class="number">43</span>:     &#125;</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:     <span class="comment">// è¯·æ±‚æ‹‰å–æ¶ˆæ¯</span></div><div class="line"><span class="number">46</span>:     <span class="keyword">if</span> (findBrokerResult != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">47</span>:         <span class="keyword">int</span> sysFlagInner = sysFlag;</div><div class="line"><span class="number">48</span>: </div><div class="line"><span class="number">49</span>:         <span class="keyword">if</span> (findBrokerResult.isSlave()) &#123;</div><div class="line"><span class="number">50</span>:             sysFlagInner = PullSysFlag.clearCommitOffsetFlag(sysFlagInner);</div><div class="line"><span class="number">51</span>:         &#125;</div><div class="line"><span class="number">52</span>: </div><div class="line"><span class="number">53</span>:         PullMessageRequestHeader requestHeader = <span class="keyword">new</span> PullMessageRequestHeader();</div><div class="line"><span class="number">54</span>:         requestHeader.setConsumerGroup(<span class="keyword">this</span>.consumerGroup);</div><div class="line"><span class="number">55</span>:         requestHeader.setTopic(mq.getTopic());</div><div class="line"><span class="number">56</span>:         requestHeader.setQueueId(mq.getQueueId());</div><div class="line"><span class="number">57</span>:         requestHeader.setQueueOffset(offset);</div><div class="line"><span class="number">58</span>:         requestHeader.setMaxMsgNums(maxNums);</div><div class="line"><span class="number">59</span>:         requestHeader.setSysFlag(sysFlagInner);</div><div class="line"><span class="number">60</span>:         requestHeader.setCommitOffset(commitOffset);</div><div class="line"><span class="number">61</span>:         requestHeader.setSuspendTimeoutMillis(brokerSuspendMaxTimeMillis);</div><div class="line"><span class="number">62</span>:         requestHeader.setSubscription(subExpression);</div><div class="line"><span class="number">63</span>:         requestHeader.setSubVersion(subVersion);</div><div class="line"><span class="number">64</span>: </div><div class="line"><span class="number">65</span>:         String brokerAddr = findBrokerResult.getBrokerAddr();</div><div class="line"><span class="number">66</span>:         <span class="keyword">if</span> (PullSysFlag.hasClassFilterFlag(sysFlagInner)) &#123; <span class="comment">// TODO filtersrv</span></div><div class="line"><span class="number">67</span>:             brokerAddr = computPullFromWhichFilterServer(mq.getTopic(), brokerAddr);</div><div class="line"><span class="number">68</span>:         &#125;</div><div class="line"><span class="number">69</span>: </div><div class="line"><span class="number">70</span>:         PullResult pullResult = <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().pullMessage(</div><div class="line"><span class="number">71</span>:             brokerAddr,</div><div class="line"><span class="number">72</span>:             requestHeader,</div><div class="line"><span class="number">73</span>:             timeoutMillis,</div><div class="line"><span class="number">74</span>:             communicationMode,</div><div class="line"><span class="number">75</span>:             pullCallback);</div><div class="line"><span class="number">76</span>: </div><div class="line"><span class="number">77</span>:         <span class="keyword">return</span> pullResult;</div><div class="line"><span class="number">78</span>:     &#125;</div><div class="line"><span class="number">79</span>: </div><div class="line"><span class="number">80</span>:     <span class="comment">// Brokerä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></div><div class="line"><span class="number">81</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"The broker["</span> + mq.getBrokerName() + <span class="string">"] not exist"</span>, <span class="keyword">null</span>);</div><div class="line"><span class="number">82</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•ã€‚<strong>è¯¥æ–¹æ³•å‚æ•°è¾ƒå¤šï¼Œå¯ä»¥çœ‹ä¸‹ä»£ç æ³¨é‡Šä¸Šæ¯ä¸ªå‚æ•°çš„è¯´æ˜</strong>ğŸ˜ˆã€‚</li><li>ç¬¬ 34 è‡³ 43 è¡Œ ï¼šè·å– <code>Broker</code> ä¿¡æ¯(<code>Broker</code> åœ°å€ã€æ˜¯å¦ä¸ºä»èŠ‚ç‚¹)ã€‚<ul><li><a href="#pullapiwrapperrecalculatepullfromwhichnode">#recalculatePullFromWhichNode(â€¦)</a></li><li><a href="#mqclientinstancefindbrokeraddressinsubscribe">#MQClientInstance#findBrokerAddressInSubscribe(â€¦)</a></li></ul></li><li>ç¬¬ 45 è‡³ 78 è¡Œ ï¼š<strong>è¯·æ±‚æ‹‰å–æ¶ˆæ¯</strong>ã€‚</li><li>ç¬¬ 81 è¡Œ ï¼šå½“ <code>Broker</code> ä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</li></ul><h4 id="PullAPIWrapper-recalculatePullFromWhichNode-â€¦"><a href="#PullAPIWrapper-recalculatePullFromWhichNode-â€¦" class="headerlink" title="PullAPIWrapper#recalculatePullFromWhichNode(â€¦)"></a>PullAPIWrapper#recalculatePullFromWhichNode(â€¦)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * æ¶ˆæ¯é˜Ÿåˆ— ä¸ æ‹‰å–Broker çš„æ˜ å°„</div><div class="line"> 3:  * å½“æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œä¼šé€šè¿‡è¯¥æ˜ å°„è·å–æ‹‰å–è¯·æ±‚å¯¹åº”çš„Broker</div><div class="line"> 4:  */</div><div class="line"> <span class="number">5</span>: <span class="keyword">private</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong<span class="comment">/* brokerId */</span>&gt; pullFromWhichNodeTable =</div><div class="line"> <span class="number">6</span>:     <span class="keyword">new</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt;(<span class="number">32</span>);</div><div class="line"> <span class="number">7</span>: <span class="comment">/**</span></div><div class="line"> 8:  * æ˜¯å¦ä½¿ç”¨é»˜è®¤Broker</div><div class="line"> 9:  */</div><div class="line"><span class="number">10</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> connectBrokerByUser = <span class="keyword">false</span>;</div><div class="line"><span class="number">11</span>: <span class="comment">/**</span></div><div class="line">12:  * é»˜è®¤Brokerç¼–å·</div><div class="line">13:  */</div><div class="line"><span class="number">14</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> defaultBrokerId = MixAll.MASTER_ID;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>: <span class="comment">/**</span></div><div class="line">17:  * è®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯å¯¹åº”çš„Brokerç¼–å·</div><div class="line">18:  *</div><div class="line">19:  * <span class="doctag">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line">20:  * <span class="doctag">@return</span> Brokerç¼–å·</div><div class="line">21:  */</div><div class="line"><span class="number">22</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">recalculatePullFromWhichNode</span><span class="params">(<span class="keyword">final</span> MessageQueue mq)</span> </span>&#123;</div><div class="line"><span class="number">23</span>:     <span class="comment">// è‹¥å¼€å¯é»˜è®¤Brokerå¼€å…³ï¼Œåˆ™è¿”å›é»˜è®¤Brokerç¼–å·</span></div><div class="line"><span class="number">24</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.isConnectBrokerByUser()) &#123;</div><div class="line"><span class="number">25</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.defaultBrokerId;</div><div class="line"><span class="number">26</span>:     &#125;</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>:     <span class="comment">// è‹¥æ¶ˆæ¯é˜Ÿåˆ—æ˜ å°„æ‹‰å–Brokerå­˜åœ¨ï¼Œåˆ™è¿”å›æ˜ å°„Brokerç¼–å·</span></div><div class="line"><span class="number">29</span>:     AtomicLong suggest = <span class="keyword">this</span>.pullFromWhichNodeTable.get(mq);</div><div class="line"><span class="number">30</span>:     <span class="keyword">if</span> (suggest != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">31</span>:         <span class="keyword">return</span> suggest.get();</div><div class="line"><span class="number">32</span>:     &#125;</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>:     <span class="comment">// è¿”å›Brokerä¸»èŠ‚ç‚¹ç¼–å·</span></div><div class="line"><span class="number">35</span>:     <span class="keyword">return</span> MixAll.MASTER_ID;</div><div class="line"><span class="number">36</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šè®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯å¯¹åº”çš„ <code>Broker</code> ç¼–å·ã€‚</li></ul><h4 id="MQClientInstance-findBrokerAddressInSubscribe-â€¦"><a href="#MQClientInstance-findBrokerAddressInSubscribe-â€¦" class="headerlink" title="MQClientInstance#findBrokerAddressInSubscribe(â€¦)"></a>MQClientInstance#findBrokerAddressInSubscribe(â€¦)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * Brokeråå­— å’Œ Brokeråœ°å€ç›¸å…³ Map</div><div class="line"> 3:  */</div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String<span class="comment">/* Broker Name */</span>, HashMap&lt;Long<span class="comment">/* brokerId */</span>, String<span class="comment">/* address */</span>&gt;&gt; brokerAddrTable =</div><div class="line"> <span class="number">5</span>:         <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>: <span class="comment">/**</span></div><div class="line"> 8:  * è·å¾—Brokerä¿¡æ¯</div><div class="line"> 9:  *</div><div class="line">10:  * <span class="doctag">@param</span> brokerName brokeråå­—</div><div class="line">11:  * <span class="doctag">@param</span> brokerId brokerç¼–å·</div><div class="line">12:  * <span class="doctag">@param</span> onlyThisBroker æ˜¯å¦å¿…é¡»æ˜¯è¯¥broker</div><div class="line">13:  * <span class="doctag">@return</span> Brokerä¿¡æ¯</div><div class="line">14:  */</div><div class="line"><span class="number">15</span>: <span class="function"><span class="keyword">public</span> FindBrokerResult <span class="title">findBrokerAddressInSubscribe</span><span class="params">(//</span></span></div><div class="line"><span class="number">16</span>:     <span class="keyword">final</span> String brokerName, //</div><div class="line"><span class="number">17</span>:     <span class="keyword">final</span> <span class="keyword">long</span> brokerId, //</div><div class="line"><span class="number">18</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> onlyThisBroker//</div><div class="line"><span class="number">19</span>: ) &#123;</div><div class="line"><span class="number">20</span>:     String brokerAddr = <span class="keyword">null</span>; <span class="comment">// brokeråœ°å€</span></div><div class="line"><span class="number">21</span>:     <span class="keyword">boolean</span> slave = <span class="keyword">false</span>; <span class="comment">// æ˜¯å¦ä¸ºä»èŠ‚ç‚¹</span></div><div class="line"><span class="number">22</span>:     <span class="keyword">boolean</span> found = <span class="keyword">false</span>; <span class="comment">// æ˜¯å¦æ‰¾åˆ°</span></div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:     <span class="comment">// è·å¾—Brokerä¿¡æ¯</span></div><div class="line"><span class="number">25</span>:     HashMap&lt;Long<span class="comment">/* brokerId */</span>, String<span class="comment">/* address */</span>&gt; map = <span class="keyword">this</span>.brokerAddrTable.get(brokerName);</div><div class="line"><span class="number">26</span>:     <span class="keyword">if</span> (map != <span class="keyword">null</span> &amp;&amp; !map.isEmpty()) &#123;</div><div class="line"><span class="number">27</span>:         brokerAddr = map.get(brokerId);</div><div class="line"><span class="number">28</span>:         slave = brokerId != MixAll.MASTER_ID;</div><div class="line"><span class="number">29</span>:         found = brokerAddr != <span class="keyword">null</span>;</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:         <span class="comment">// å¦‚æœä¸å¼ºåˆ¶è·å¾—ï¼Œé€‰æ‹©ä¸€ä¸ªBroker</span></div><div class="line"><span class="number">32</span>:         <span class="keyword">if</span> (!found &amp;&amp; !onlyThisBroker) &#123;</div><div class="line"><span class="number">33</span>:             Entry&lt;Long, String&gt; entry = map.entrySet().iterator().next();</div><div class="line"><span class="number">34</span>:             brokerAddr = entry.getValue();</div><div class="line"><span class="number">35</span>:             slave = entry.getKey() != MixAll.MASTER_ID;</div><div class="line"><span class="number">36</span>:             found = <span class="keyword">true</span>;</div><div class="line"><span class="number">37</span>:         &#125;</div><div class="line"><span class="number">38</span>:     &#125;</div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>:     <span class="comment">// æ‰¾åˆ°brokerï¼Œåˆ™è¿”å›ä¿¡æ¯</span></div><div class="line"><span class="number">41</span>:     <span class="keyword">if</span> (found) &#123;</div><div class="line"><span class="number">42</span>:         <span class="keyword">return</span> <span class="keyword">new</span> FindBrokerResult(brokerAddr, slave);</div><div class="line"><span class="number">43</span>:     &#125;</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:     <span class="comment">// æ‰¾ä¸åˆ°ï¼Œåˆ™è¿”å›ç©º</span></div><div class="line"><span class="number">46</span>:     <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">47</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šè·å– <code>Broker</code> ä¿¡æ¯(<code>Broker</code> åœ°å€ã€æ˜¯å¦ä¸ºä»èŠ‚ç‚¹)ã€‚</li></ul><h3 id="PullAPIWrapper-processPullResult-â€¦"><a href="#PullAPIWrapper-processPullResult-â€¦" class="headerlink" title="PullAPIWrapper#processPullResult(â€¦)"></a>PullAPIWrapper#processPullResult(â€¦)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * å¤„ç†æ‹‰å–ç»“æœ</div><div class="line"> 3:  * 1. æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯Brokerç¼–å·çš„æ˜ å°„</div><div class="line"> 4:  * 2. è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯</div><div class="line"> 5:  *</div><div class="line"> 6:  * <span class="doctag">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 7:  * <span class="doctag">@param</span> pullResult æ‹‰å–ç»“æœ</div><div class="line"> 8:  * <span class="doctag">@param</span> subscriptionData è®¢é˜…ä¿¡æ¯</div><div class="line"> 9:  * <span class="doctag">@return</span> æ‹‰å–ç»“æœ</div><div class="line">10:  */</div><div class="line"><span class="number">11</span>: <span class="function"><span class="keyword">public</span> PullResult <span class="title">processPullResult</span><span class="params">(<span class="keyword">final</span> MessageQueue mq, <span class="keyword">final</span> PullResult pullResult,</span></span></div><div class="line"><span class="number">12</span>:     <span class="keyword">final</span> SubscriptionData subscriptionData) &#123;</div><div class="line"><span class="number">13</span>:     PullResultExt pullResultExt = (PullResultExt) pullResult;</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:     <span class="comment">// æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯Brokerç¼–å·çš„æ˜ å°„</span></div><div class="line"><span class="number">16</span>:     <span class="keyword">this</span>.updatePullFromWhichNode(mq, pullResultExt.getSuggestWhichBrokerId());</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:     <span class="comment">// è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯</span></div><div class="line"><span class="number">19</span>:     <span class="keyword">if</span> (PullStatus.FOUND == pullResult.getPullStatus()) &#123;</div><div class="line"><span class="number">20</span>:         <span class="comment">// è§£ææ¶ˆæ¯</span></div><div class="line"><span class="number">21</span>:         ByteBuffer byteBuffer = ByteBuffer.wrap(pullResultExt.getMessageBinary());</div><div class="line"><span class="number">22</span>:         List&lt;MessageExt&gt; msgList = MessageDecoder.decodes(byteBuffer);</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:         <span class="comment">// æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯</span></div><div class="line"><span class="number">25</span>:         List&lt;MessageExt&gt; msgListFilterAgain = msgList;</div><div class="line"><span class="number">26</span>:         <span class="keyword">if</span> (!subscriptionData.getTagsSet().isEmpty() &amp;&amp; !subscriptionData.isClassFilterMode()) &#123;</div><div class="line"><span class="number">27</span>:             msgListFilterAgain = <span class="keyword">new</span> ArrayList&lt;&gt;(msgList.size());</div><div class="line"><span class="number">28</span>:             <span class="keyword">for</span> (MessageExt msg : msgList) &#123;</div><div class="line"><span class="number">29</span>:                 <span class="keyword">if</span> (msg.getTags() != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">30</span>:                     <span class="keyword">if</span> (subscriptionData.getTagsSet().contains(msg.getTags())) &#123;</div><div class="line"><span class="number">31</span>:                         msgListFilterAgain.add(msg);</div><div class="line"><span class="number">32</span>:                     &#125;</div><div class="line"><span class="number">33</span>:                 &#125;</div><div class="line"><span class="number">34</span>:             &#125;</div><div class="line"><span class="number">35</span>:         &#125;</div><div class="line"><span class="number">36</span>: </div><div class="line"><span class="number">37</span>:         <span class="comment">// Hook</span></div><div class="line"><span class="number">38</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.hasHook()) &#123;</div><div class="line"><span class="number">39</span>:             FilterMessageContext filterMessageContext = <span class="keyword">new</span> FilterMessageContext();</div><div class="line"><span class="number">40</span>:             filterMessageContext.setUnitMode(unitMode);</div><div class="line"><span class="number">41</span>:             filterMessageContext.setMsgList(msgListFilterAgain);</div><div class="line"><span class="number">42</span>:             <span class="keyword">this</span>.executeHook(filterMessageContext);</div><div class="line"><span class="number">43</span>:         &#125;</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:         <span class="comment">// è®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—å½“å‰æœ€å°/æœ€å¤§ä½ç½®åˆ°æ¶ˆæ¯æ‹“å±•å­—æ®µ</span></div><div class="line"><span class="number">46</span>:         <span class="keyword">for</span> (MessageExt msg : msgListFilterAgain) &#123;</div><div class="line"><span class="number">47</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MIN_OFFSET,</div><div class="line"><span class="number">48</span>:                 Long.toString(pullResult.getMinOffset()));</div><div class="line"><span class="number">49</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MAX_OFFSET,</div><div class="line"><span class="number">50</span>:                 Long.toString(pullResult.getMaxOffset()));</div><div class="line"><span class="number">51</span>:         &#125;</div><div class="line"><span class="number">52</span>: </div><div class="line"><span class="number">53</span>:         <span class="comment">// è®¾ç½®æ¶ˆæ¯åˆ—è¡¨</span></div><div class="line"><span class="number">54</span>:         pullResultExt.setMsgFoundList(msgListFilterAgain);</div><div class="line"><span class="number">55</span>:     &#125;</div><div class="line"><span class="number">56</span>: </div><div class="line"><span class="number">57</span>:     <span class="comment">// æ¸…ç©ºæ¶ˆæ¯äºŒè¿›åˆ¶æ•°ç»„</span></div><div class="line"><span class="number">58</span>:     pullResultExt.setMessageBinary(<span class="keyword">null</span>);</div><div class="line"><span class="number">59</span>: </div><div class="line"><span class="number">60</span>:     <span class="keyword">return</span> pullResult;</div><div class="line"><span class="number">61</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šå¤„ç†æ‹‰å–ç»“æœã€‚<ul><li>æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯ <code>Broker</code> ç¼–å·çš„æ˜ å°„ã€‚</li><li>è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯ <code>tagCode</code>åŒ¹é…åˆé€‚æ¶ˆæ¯ã€‚</li></ul></li><li>ç¬¬ 16 è¡Œ ï¼šæ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯ <code>Broker</code> ç¼–å·çš„æ˜ å°„ã€‚ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œå¦‚æœæœªè®¾ç½®é»˜è®¤æ‹‰å–çš„ <code>Broker</code> ç¼–å·ï¼Œä¼šä½¿ç”¨æ›´æ–°åçš„ <code>Broker</code> ç¼–å·ã€‚</li><li>ç¬¬ 18 è‡³ 55 è¡Œ ï¼šè§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯ <code>tagCode</code> åŒ¹é…åˆé€‚æ¶ˆæ¯ã€‚<ul><li>ç¬¬ 20 è‡³ 22 è¡Œ ï¼šè§£ææ¶ˆæ¯ã€‚è¯¦ç»†è§£æè§ï¼š<a href="http://www.yunai.me/RocketMQ/message/">ã€ŠRocketMQ æºç åˆ†æ â€”â€” MessageåŸºç¡€ã€‹</a> ã€‚</li><li>ç¬¬ 24 è‡³ 35 è¡Œ ï¼šæ ¹æ®è®¢é˜…ä¿¡æ¯<code>tagCode</code> åŒ¹é…æ¶ˆæ¯ã€‚</li><li>ç¬¬ 37 è‡³ 43 è¡Œ ï¼š<code>Hook</code>ã€‚</li><li>ç¬¬ 45 è‡³ 51 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—å½“å‰æœ€å°/æœ€å¤§ä½ç½®åˆ°æ¶ˆæ¯æ‹“å±•å­—æ®µã€‚</li><li>ç¬¬ 54 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li></ul></li><li>ç¬¬ 58 è¡Œ ï¼šæ¸…ç©ºæ¶ˆæ¯äºŒè¿›åˆ¶æ•°ç»„ã€‚</li></ul><h3 id="ProcessQueue-putMessage-â€¦"><a href="#ProcessQueue-putMessage-â€¦" class="headerlink" title="ProcessQueue#putMessage(â€¦)"></a>ProcessQueue#putMessage(â€¦)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>:  <span class="comment">/**</span></div><div class="line"> 2:  * æ¶ˆæ¯æ˜ å°„è¯»å†™é”</div><div class="line"> 3:  */</div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock lockTreeMap = <span class="keyword">new</span> ReentrantReadWriteLock();</div><div class="line"> <span class="number">5</span>: <span class="comment">/**</span></div><div class="line"> 6:  * æ¶ˆæ¯æ˜ å°„</div><div class="line"> 7:  * keyï¼šæ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</div><div class="line"> 8:  */</div><div class="line"> <span class="number">9</span>: <span class="keyword">private</span> <span class="keyword">final</span> TreeMap&lt;Long, MessageExt&gt; msgTreeMap = <span class="keyword">new</span> TreeMap&lt;&gt;();</div><div class="line"><span class="number">10</span>: <span class="comment">/**</span></div><div class="line">11:  * æ¶ˆæ¯æ•°</div><div class="line">12:  */</div><div class="line"><span class="number">13</span>: <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong msgCount = <span class="keyword">new</span> AtomicLong();</div><div class="line"><span class="number">14</span>: <span class="comment">/**</span></div><div class="line">15:  * æ·»åŠ æ¶ˆæ¯æœ€å¤§é˜Ÿåˆ—ä½ç½®</div><div class="line">16:  */</div><div class="line"><span class="number">17</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> queueOffsetMax = <span class="number">0L</span>;</div><div class="line"><span class="number">18</span>: <span class="comment">/**</span></div><div class="line">19:  * æ˜¯å¦æ­£åœ¨æ¶ˆè´¹</div><div class="line">20:  */</div><div class="line"><span class="number">21</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> consuming = <span class="keyword">false</span>;</div><div class="line"><span class="number">22</span>: <span class="comment">/**</span></div><div class="line">23:  * Brokerç´¯è®¡æ¶ˆæ¯æ•°é‡</div><div class="line">24:  * è®¡ç®—å…¬å¼ = queueMaxOffset - æ–°æ·»åŠ æ¶ˆæ¯æ•°ç»„[n - 1].queueOffset</div><div class="line">25:  * Acc = Accumulation</div><div class="line">26:  * cnt = ï¼ˆçŒœæµ‹ï¼‰å¯¹æ¯”åº¦</div><div class="line">27:  */</div><div class="line"><span class="number">28</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> msgAccCnt = <span class="number">0</span>;</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>: <span class="comment">/**</span></div><div class="line">31:  * æ·»åŠ æ¶ˆæ¯ï¼Œå¹¶è¿”å›æ˜¯å¦æäº¤ç»™æ¶ˆè´¹è€…</div><div class="line">32:  * è¿”å›trueï¼Œå½“æœ‰æ–°æ¶ˆæ¯æ·»åŠ æˆåŠŸæ—¶ï¼Œ</div><div class="line">33:  *</div><div class="line">34:  * <span class="doctag">@param</span> msgs æ¶ˆæ¯</div><div class="line">35:  * <span class="doctag">@return</span> æ˜¯å¦æäº¤ç»™æ¶ˆè´¹è€…</div><div class="line">36:  */</div><div class="line"><span class="number">37</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">putMessage</span><span class="params">(<span class="keyword">final</span> List&lt;MessageExt&gt; msgs)</span> </span>&#123;</div><div class="line"><span class="number">38</span>:     <span class="keyword">boolean</span> dispatchToConsume = <span class="keyword">false</span>;</div><div class="line"><span class="number">39</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">40</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"><span class="number">41</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">42</span>:             <span class="comment">// æ·»åŠ æ¶ˆæ¯</span></div><div class="line"><span class="number">43</span>:             <span class="keyword">int</span> validMsgCnt = <span class="number">0</span>;</div><div class="line"><span class="number">44</span>:             <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</div><div class="line"><span class="number">45</span>:                 MessageExt old = msgTreeMap.put(msg.getQueueOffset(), msg);</div><div class="line"><span class="number">46</span>:                 <span class="keyword">if</span> (<span class="keyword">null</span> == old) &#123;</div><div class="line"><span class="number">47</span>:                     validMsgCnt++;</div><div class="line"><span class="number">48</span>:                     <span class="keyword">this</span>.queueOffsetMax = msg.getQueueOffset();</div><div class="line"><span class="number">49</span>:                 &#125;</div><div class="line"><span class="number">50</span>:             &#125;</div><div class="line"><span class="number">51</span>:             msgCount.addAndGet(validMsgCnt);</div><div class="line"><span class="number">52</span>: </div><div class="line"><span class="number">53</span>:             <span class="comment">// è®¡ç®—æ˜¯å¦æ­£åœ¨æ¶ˆè´¹</span></div><div class="line"><span class="number">54</span>:             <span class="keyword">if</span> (!msgTreeMap.isEmpty() &amp;&amp; !<span class="keyword">this</span>.consuming) &#123;</div><div class="line"><span class="number">55</span>:                 dispatchToConsume = <span class="keyword">true</span>;</div><div class="line"><span class="number">56</span>:                 <span class="keyword">this</span>.consuming = <span class="keyword">true</span>;</div><div class="line"><span class="number">57</span>:             &#125;</div><div class="line"><span class="number">58</span>: </div><div class="line"><span class="number">59</span>:             <span class="comment">// Brokerç´¯è®¡æ¶ˆæ¯æ•°é‡</span></div><div class="line"><span class="number">60</span>:             <span class="keyword">if</span> (!msgs.isEmpty()) &#123;</div><div class="line"><span class="number">61</span>:                 MessageExt messageExt = msgs.get(msgs.size() - <span class="number">1</span>);</div><div class="line"><span class="number">62</span>:                 String property = messageExt.getProperty(MessageConst.PROPERTY_MAX_OFFSET);</div><div class="line"><span class="number">63</span>:                 <span class="keyword">if</span> (property != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">64</span>:                     <span class="keyword">long</span> accTotal = Long.parseLong(property) - messageExt.getQueueOffset();</div><div class="line"><span class="number">65</span>:                     <span class="keyword">if</span> (accTotal &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">66</span>:                         <span class="keyword">this</span>.msgAccCnt = accTotal;</div><div class="line"><span class="number">67</span>:                     &#125;</div><div class="line"><span class="number">68</span>:                 &#125;</div><div class="line"><span class="number">69</span>:             &#125;</div><div class="line"><span class="number">70</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">71</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"><span class="number">72</span>:         &#125;</div><div class="line"><span class="number">73</span>:     &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"><span class="number">74</span>:         log.error(<span class="string">"putMessage exception"</span>, e);</div><div class="line"><span class="number">75</span>:     &#125;</div><div class="line"><span class="number">76</span>: </div><div class="line"><span class="number">77</span>:     <span class="keyword">return</span> dispatchToConsume;</div><div class="line"><span class="number">78</span>: &#125;</div></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¦‚æœç”¨æœ€ç®€å•ç²—æš´çš„æ–¹å¼æè¿° <code>PullConsumer</code> æ‹‰å–æ¶ˆæ¯çš„è¿‡ç¨‹ï¼Œé‚£å°±æ˜¯å¦‚ä¸‹çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (ä¸æ»¡è¶³æ‹‰å–æ¶ˆæ¯) &#123;</div><div class="line">        Thread.sleep(é—´éš”);</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line">    ä¸»åŠ¨æ‹‰å–æ¶ˆæ¯();</div><div class="line">&#125;</div></pre></td></tr></table></figure><h1 id="6ã€PushConsumer-æ¶ˆè´¹æ¶ˆæ¯"><a href="#6ã€PushConsumer-æ¶ˆè´¹æ¶ˆæ¯" class="headerlink" title="6ã€PushConsumer æ¶ˆè´¹æ¶ˆæ¯"></a>6ã€PushConsumer æ¶ˆè´¹æ¶ˆæ¯</h1><p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/06.png" alt="DefaultMQPushConsumerImplæ¶ˆè´¹æ¶ˆæ¯"></p><h2 id="ConsumeMessageConcurrentlyService-æäº¤æ¶ˆè´¹è¯·æ±‚"><a href="#ConsumeMessageConcurrentlyService-æäº¤æ¶ˆè´¹è¯·æ±‚" class="headerlink" title="ConsumeMessageConcurrentlyService æäº¤æ¶ˆè´¹è¯·æ±‚"></a>ConsumeMessageConcurrentlyService æäº¤æ¶ˆè´¹è¯·æ±‚</h2><h3 id="ConsumeMessageConcurrentlyService-submitConsumeRequest-â€¦"><a href="#ConsumeMessageConcurrentlyService-submitConsumeRequest-â€¦" class="headerlink" title="ConsumeMessageConcurrentlyService#submitConsumeRequest(â€¦)"></a>ConsumeMessageConcurrentlyService#submitConsumeRequest(â€¦)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * æ¶ˆè´¹çº¿ç¨‹æ± é˜Ÿåˆ—</div><div class="line"> 3:  */</div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; consumeRequestQueue;</div><div class="line"> <span class="number">5</span>: <span class="comment">/**</span></div><div class="line"> 6:  * æ¶ˆè´¹çº¿ç¨‹æ± </div><div class="line"> 7:  */</div><div class="line"> <span class="number">8</span>: <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor consumeExecutor;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submitConsumeRequest</span><span class="params">(//</span></span></div><div class="line"><span class="number">11</span>:     <span class="keyword">final</span> List&lt;MessageExt&gt; msgs, //</div><div class="line"><span class="number">12</span>:     <span class="keyword">final</span> ProcessQueue processQueue, //</div><div class="line"><span class="number">13</span>:     <span class="keyword">final</span> MessageQueue messageQueue, //</div><div class="line"><span class="number">14</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> dispatchToConsume) &#123;</div><div class="line"><span class="number">15</span>:     <span class="keyword">final</span> <span class="keyword">int</span> consumeBatchSize = <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();</div><div class="line"><span class="number">16</span>:     <span class="keyword">if</span> (msgs.size() &lt;= consumeBatchSize) &#123; <span class="comment">// æäº¤æ¶ˆæ¯å°äºæ‰¹é‡æ¶ˆæ¯æ•°ï¼Œç›´æ¥æäº¤æ¶ˆè´¹è¯·æ±‚</span></div><div class="line"><span class="number">17</span>:         ConsumeRequest consumeRequest = <span class="keyword">new</span> ConsumeRequest(msgs, processQueue, messageQueue);</div><div class="line"><span class="number">18</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">19</span>:             <span class="keyword">this</span>.consumeExecutor.submit(consumeRequest);</div><div class="line"><span class="number">20</span>:         &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</div><div class="line"><span class="number">21</span>:             <span class="keyword">this</span>.submitConsumeRequestLater(consumeRequest);</div><div class="line"><span class="number">22</span>:         &#125;</div><div class="line"><span class="number">23</span>:     &#125; <span class="keyword">else</span> &#123; <span class="comment">// æäº¤æ¶ˆæ¯å¤§äºæ‰¹é‡æ¶ˆæ¯æ•°ï¼Œè¿›è¡Œåˆ†æ‹†æˆå¤šä¸ªæ¶ˆè´¹è¯·æ±‚</span></div><div class="line"><span class="number">24</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> total = <span class="number">0</span>; total &lt; msgs.size(); ) &#123;</div><div class="line"><span class="number">25</span>:             <span class="comment">// è®¡ç®—å½“å‰æ‹†åˆ†è¯·æ±‚åŒ…å«çš„æ¶ˆæ¯</span></div><div class="line"><span class="number">26</span>:             List&lt;MessageExt&gt; msgThis = <span class="keyword">new</span> ArrayList&lt;&gt;(consumeBatchSize);</div><div class="line"><span class="number">27</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; consumeBatchSize; i++, total++) &#123;</div><div class="line"><span class="number">28</span>:                 <span class="keyword">if</span> (total &lt; msgs.size()) &#123;</div><div class="line"><span class="number">29</span>:                     msgThis.add(msgs.get(total));</div><div class="line"><span class="number">30</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">31</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">32</span>:                 &#125;</div><div class="line"><span class="number">33</span>:             &#125;</div><div class="line"><span class="number">34</span>: </div><div class="line"><span class="number">35</span>:             <span class="comment">// æäº¤æ‹†åˆ†æ¶ˆè´¹è¯·æ±‚</span></div><div class="line"><span class="number">36</span>:             ConsumeRequest consumeRequest = <span class="keyword">new</span> ConsumeRequest(msgThis, processQueue, messageQueue);</div><div class="line"><span class="number">37</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">38</span>:                 <span class="keyword">this</span>.consumeExecutor.submit(consumeRequest);</div><div class="line"><span class="number">39</span>:             &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</div><div class="line"><span class="number">40</span>:                 <span class="comment">// å¦‚æœè¢«æ‹’ç»ï¼Œåˆ™å°†å½“å‰æ‹†åˆ†æ¶ˆæ¯+å‰©ä½™æ¶ˆæ¯æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚</span></div><div class="line"><span class="number">41</span>:                 <span class="keyword">for</span> (; total &lt; msgs.size(); total++) &#123;</div><div class="line"><span class="number">42</span>:                     msgThis.add(msgs.get(total));</div><div class="line"><span class="number">43</span>:                 &#125;</div><div class="line"><span class="number">44</span>:                 <span class="keyword">this</span>.submitConsumeRequestLater(consumeRequest);</div><div class="line"><span class="number">45</span>:             &#125;</div><div class="line"><span class="number">46</span>:         &#125;</div><div class="line"><span class="number">47</span>:     &#125;</div><div class="line"><span class="number">48</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šæäº¤<strong>ç«‹å³</strong>æ¶ˆè´¹è¯·æ±‚ã€‚</li><li>ç¬¬ 16 è‡³ 22 è¡Œ ï¼šæäº¤æ¶ˆæ¯å°äºç­‰äºæ‰¹é‡æ¶ˆè´¹æ•°ï¼Œç›´æ¥æäº¤æ¶ˆè´¹è¯·æ±‚ã€‚</li><li>ç¬¬ 23 è‡³ 47 è¡Œ ï¼šå½“æäº¤æ¶ˆæ¯å¤§äºæ‰¹é‡æ¶ˆè´¹æ•°ï¼Œè¿›è¡Œåˆ†æ‹†æˆå¤šä¸ªè¯·æ±‚ã€‚<ul><li>ç¬¬ 25 è‡³ 33 è¡Œ ï¼šè®¡ç®—å½“å‰æ‹†åˆ†è¯·æ±‚åŒ…å«çš„æ¶ˆæ¯ã€‚</li><li>ç¬¬ 35 è‡³ 38 è¡Œ ï¼šæäº¤æ‹†åˆ†æ¶ˆè´¹è¯·æ±‚ã€‚</li><li>ç¬¬ 39 è‡³ 44 è¡Œ ï¼šæäº¤è¯·æ±‚è¢«æ‹’ç»ï¼Œåˆ™å°†å½“å‰æ‹†åˆ†æ¶ˆæ¯ + å‰©ä½™æ¶ˆæ¯æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ï¼Œç»“æŸæ‹†åˆ†å¾ªç¯ã€‚</li></ul></li></ul><h3 id="ConsumeMessageConcurrentlyService-submitConsumeRequestLater"><a href="#ConsumeMessageConcurrentlyService-submitConsumeRequestLater" class="headerlink" title="ConsumeMessageConcurrentlyService#submitConsumeRequestLater"></a>ConsumeMessageConcurrentlyService#submitConsumeRequestLater</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚</div><div class="line"> 3:  *</div><div class="line"> 4:  * <span class="doctag">@param</span> msgs æ¶ˆæ¯åˆ—è¡¨</div><div class="line"> 5:  * <span class="doctag">@param</span> processQueue æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class="line"> 6:  * <span class="doctag">@param</span> messageQueue æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 7:  */</div><div class="line"> <span class="number">8</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">submitConsumeRequestLater</span><span class="params">(//</span></span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">final</span> List&lt;MessageExt&gt; msgs, //</div><div class="line"><span class="number">10</span>:     <span class="keyword">final</span> ProcessQueue processQueue, //</div><div class="line"><span class="number">11</span>:     <span class="keyword">final</span> MessageQueue messageQueue//</div><div class="line"><span class="number">12</span>: ) &#123;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>:     <span class="keyword">this</span>.scheduledExecutorService.schedule(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">17</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">18</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.submitConsumeRequest(msgs, processQueue, messageQueue, <span class="keyword">true</span>);</div><div class="line"><span class="number">19</span>:         &#125;</div><div class="line"><span class="number">20</span>:     &#125;, <span class="number">5000</span>, TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">21</span>: &#125;</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>: <span class="comment">/**</span></div><div class="line">24:  * æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚</div><div class="line">25:  * <span class="doctag">@param</span> consumeRequest æ¶ˆè´¹è¯·æ±‚</div><div class="line">26:  */</div><div class="line"><span class="number">27</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">submitConsumeRequestLater</span><span class="params">(<span class="keyword">final</span> ConsumeRequest consumeRequest//</span></span></div><div class="line"><span class="number">28</span>: ) &#123;</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>:     <span class="keyword">this</span>.scheduledExecutorService.schedule(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">33</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">34</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumeExecutor.submit(consumeRequest); <span class="comment">// TODO BUG ?</span></div><div class="line"><span class="number">35</span>:         &#125;</div><div class="line"><span class="number">36</span>:     &#125;, <span class="number">5000</span>, TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">37</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šæäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚</li><li>ç¬¬ 34 è¡Œ ï¼šç›´æ¥è°ƒç”¨ <code>ConsumeMessageConcurrentlyService.this.consumeExecutor.submit(consumeRequest);</code>ã€‚å¦‚æœæ¶ˆæ¯æ•°è¶…è¿‡æ‰¹é‡æ¶ˆè´¹ä¸Šé™ï¼Œä¼šä¸ä¼šæ˜¯<strong>BUG</strong>ã€‚</li></ul><h2 id="ConsumeRequest"><a href="#ConsumeRequest" class="headerlink" title="ConsumeRequest"></a>ConsumeRequest</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="class"><span class="keyword">class</span> <span class="title">ConsumeRequest</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">  <span class="number">2</span>: </div><div class="line">  <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line">  4:      * æ¶ˆè´¹æ¶ˆæ¯åˆ—è¡¨</div><div class="line">  5:      */</div><div class="line">  <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">final</span> List&lt;MessageExt&gt; msgs;</div><div class="line">  <span class="number">7</span>:     <span class="comment">/**</span></div><div class="line">  8:      * æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class="line">  9:      */</div><div class="line"> <span class="number">10</span>:     <span class="keyword">private</span> <span class="keyword">final</span> ProcessQueue processQueue;</div><div class="line"> <span class="number">11</span>:     <span class="comment">/**</span></div><div class="line"> 12:      * æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 13:      */</div><div class="line"> <span class="number">14</span>:     <span class="keyword">private</span> <span class="keyword">final</span> MessageQueue messageQueue;</div><div class="line"> <span class="number">15</span>: </div><div class="line"> <span class="number">16</span>:     <span class="function"><span class="keyword">public</span> <span class="title">ConsumeRequest</span><span class="params">(List&lt;MessageExt&gt; msgs, ProcessQueue processQueue, MessageQueue messageQueue)</span> </span>&#123;</div><div class="line"> <span class="number">17</span>:         <span class="keyword">this</span>.msgs = msgs;</div><div class="line"> <span class="number">18</span>:         <span class="keyword">this</span>.processQueue = processQueue;</div><div class="line"> <span class="number">19</span>:         <span class="keyword">this</span>.messageQueue = messageQueue;</div><div class="line"> <span class="number">20</span>:     &#125;</div><div class="line"> <span class="number">21</span>: </div><div class="line"> <span class="number">22</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">23</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">24</span>:         <span class="comment">// åºŸå¼ƒé˜Ÿåˆ—ä¸è¿›è¡Œæ¶ˆè´¹</span></div><div class="line"> <span class="number">25</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.processQueue.isDropped()) &#123;</div><div class="line"> <span class="number">26</span>:             log.info(<span class="string">"the message queue not be able to consume, because it's dropped. group=&#123;&#125; &#123;&#125;"</span>, ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumerGroup, <span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">27</span>:             <span class="keyword">return</span>;</div><div class="line"> <span class="number">28</span>:         &#125;</div><div class="line"> <span class="number">29</span>: </div><div class="line"> <span class="number">30</span>:         MessageListenerConcurrently listener = ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.messageListener; <span class="comment">// ç›‘å¬å™¨</span></div><div class="line"> <span class="number">31</span>:         ConsumeConcurrentlyContext context = <span class="keyword">new</span> ConsumeConcurrentlyContext(messageQueue); <span class="comment">// æ¶ˆè´¹Context</span></div><div class="line"> <span class="number">32</span>:         ConsumeConcurrentlyStatus status = <span class="keyword">null</span>; <span class="comment">// æ¶ˆè´¹ç»“æœçŠ¶æ€</span></div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:         <span class="comment">// Hook</span></div><div class="line"> <span class="number">35</span>:         ConsumeMessageContext consumeMessageContext = <span class="keyword">null</span>;</div><div class="line"> <span class="number">36</span>:         <span class="keyword">if</span> (ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.hasHook()) &#123;</div><div class="line"> <span class="number">37</span>:             consumeMessageContext = <span class="keyword">new</span> ConsumeMessageContext();</div><div class="line"> <span class="number">38</span>:             consumeMessageContext.setConsumerGroup(defaultMQPushConsumer.getConsumerGroup());</div><div class="line"> <span class="number">39</span>:             consumeMessageContext.setProps(<span class="keyword">new</span> HashMap&lt;String, String&gt;());</div><div class="line"> <span class="number">40</span>:             consumeMessageContext.setMq(messageQueue);</div><div class="line"> <span class="number">41</span>:             consumeMessageContext.setMsgList(msgs);</div><div class="line"> <span class="number">42</span>:             consumeMessageContext.setSuccess(<span class="keyword">false</span>);</div><div class="line"> <span class="number">43</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.executeHookBefore(consumeMessageContext);</div><div class="line"> <span class="number">44</span>:         &#125;</div><div class="line"> <span class="number">45</span>: </div><div class="line"> <span class="number">46</span>:         <span class="keyword">long</span> beginTimestamp = System.currentTimeMillis();</div><div class="line"> <span class="number">47</span>:         <span class="keyword">boolean</span> hasException = <span class="keyword">false</span>;</div><div class="line"> <span class="number">48</span>:         ConsumeReturnType returnType = ConsumeReturnType.SUCCESS; <span class="comment">// æ¶ˆè´¹è¿”å›ç»“æœç±»å‹</span></div><div class="line"> <span class="number">49</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">50</span>:             <span class="comment">// å½“æ¶ˆæ¯ä¸ºé‡è¯•æ¶ˆæ¯ï¼Œè®¾ç½®Topicä¸ºåŸå§‹Topic</span></div><div class="line"> <span class="number">51</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.resetRetryTopic(msgs);</div><div class="line"> <span class="number">52</span>: </div><div class="line"> <span class="number">53</span>:             <span class="comment">// è®¾ç½®å¼€å§‹æ¶ˆè´¹æ—¶é—´</span></div><div class="line"> <span class="number">54</span>:             <span class="keyword">if</span> (msgs != <span class="keyword">null</span> &amp;&amp; !msgs.isEmpty()) &#123;</div><div class="line"> <span class="number">55</span>:                 <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</div><div class="line"> <span class="number">56</span>:                     MessageAccessor.setConsumeStartTimeStamp(msg, String.valueOf(System.currentTimeMillis()));</div><div class="line"> <span class="number">57</span>:                 &#125;</div><div class="line"> <span class="number">58</span>:             &#125;</div><div class="line"> <span class="number">59</span>: </div><div class="line"> <span class="number">60</span>:             <span class="comment">// è¿›è¡Œæ¶ˆè´¹</span></div><div class="line"> <span class="number">61</span>:             status = listener.consumeMessage(Collections.unmodifiableList(msgs), context);</div><div class="line"> <span class="number">62</span>:         &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">63</span>:             log.warn(<span class="string">"consumeMessage exception: &#123;&#125; Group: &#123;&#125; Msgs: &#123;&#125; MQ: &#123;&#125;"</span>,</div><div class="line"> <span class="number">64</span>:                 RemotingHelper.exceptionSimpleDesc(e), <span class="comment">//</span></div><div class="line"> <span class="number">65</span>:                 ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumerGroup,</div><div class="line"> <span class="number">66</span>:                 msgs,</div><div class="line"> <span class="number">67</span>:                 messageQueue);</div><div class="line"> <span class="number">68</span>:             hasException = <span class="keyword">true</span>;</div><div class="line"> <span class="number">69</span>:         &#125;</div><div class="line"> <span class="number">70</span>: </div><div class="line"> <span class="number">71</span>:         <span class="comment">// è§£ææ¶ˆè´¹è¿”å›ç»“æœç±»å‹</span></div><div class="line"> <span class="number">72</span>:         <span class="keyword">long</span> consumeRT = System.currentTimeMillis() - beginTimestamp;</div><div class="line"> <span class="number">73</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == status) &#123;</div><div class="line"> <span class="number">74</span>:             <span class="keyword">if</span> (hasException) &#123;</div><div class="line"> <span class="number">75</span>:                 returnType = ConsumeReturnType.EXCEPTION;</div><div class="line"> <span class="number">76</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">77</span>:                 returnType = ConsumeReturnType.RETURNNULL;</div><div class="line"> <span class="number">78</span>:             &#125;</div><div class="line"> <span class="number">79</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (consumeRT &gt;= defaultMQPushConsumer.getConsumeTimeout() * <span class="number">60</span> * <span class="number">1000</span>) &#123;</div><div class="line"> <span class="number">80</span>:             returnType = ConsumeReturnType.TIME_OUT;</div><div class="line"> <span class="number">81</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ConsumeConcurrentlyStatus.RECONSUME_LATER == status) &#123;</div><div class="line"> <span class="number">82</span>:             returnType = ConsumeReturnType.FAILED;</div><div class="line"> <span class="number">83</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status) &#123;</div><div class="line"> <span class="number">84</span>:             returnType = ConsumeReturnType.SUCCESS;</div><div class="line"> <span class="number">85</span>:         &#125;</div><div class="line"> <span class="number">86</span>: </div><div class="line"> <span class="number">87</span>:         <span class="comment">// Hook</span></div><div class="line"> <span class="number">88</span>:         <span class="keyword">if</span> (ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.hasHook()) &#123;</div><div class="line"> <span class="number">89</span>:             consumeMessageContext.getProps().put(MixAll.CONSUME_CONTEXT_TYPE, returnType.name());</div><div class="line"> <span class="number">90</span>:         &#125;</div><div class="line"> <span class="number">91</span>: </div><div class="line"> <span class="number">92</span>:         <span class="comment">// æ¶ˆè´¹ç»“æœçŠ¶æ€ä¸ºç©ºæ—¶ï¼Œåˆ™è®¾ç½®ä¸ºç¨åé‡æ–°æ¶ˆè´¹</span></div><div class="line"> <span class="number">93</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == status) &#123;</div><div class="line"> <span class="number">94</span>:             log.warn(<span class="string">"consumeMessage return null, Group: &#123;&#125; Msgs: &#123;&#125; MQ: &#123;&#125;"</span>,</div><div class="line"> <span class="number">95</span>:                 ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumerGroup,</div><div class="line"> <span class="number">96</span>:                 msgs,</div><div class="line"> <span class="number">97</span>:                 messageQueue);</div><div class="line"> <span class="number">98</span>:             status = ConsumeConcurrentlyStatus.RECONSUME_LATER;</div><div class="line"> <span class="number">99</span>:         &#125;</div><div class="line"><span class="number">100</span>: </div><div class="line"><span class="number">101</span>:         <span class="comment">// Hook</span></div><div class="line"><span class="number">102</span>:         <span class="keyword">if</span> (ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.hasHook()) &#123;</div><div class="line"><span class="number">103</span>:             consumeMessageContext.setStatus(status.toString());</div><div class="line"><span class="number">104</span>:             consumeMessageContext.setSuccess(ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status);</div><div class="line"><span class="number">105</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.executeHookAfter(consumeMessageContext);</div><div class="line"><span class="number">106</span>:         &#125;</div><div class="line"><span class="number">107</span>: </div><div class="line"><span class="number">108</span>:         <span class="comment">// ç»Ÿè®¡</span></div><div class="line"><span class="number">109</span>:         ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.getConsumerStatsManager()</div><div class="line"><span class="number">110</span>:             .incConsumeRT(ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumerGroup, messageQueue.getTopic(), consumeRT);</div><div class="line"><span class="number">111</span>: </div><div class="line"><span class="number">112</span>:         <span class="comment">// å¤„ç†æ¶ˆè´¹ç»“æœ</span></div><div class="line"><span class="number">113</span>:         <span class="keyword">if</span> (!processQueue.isDropped()) &#123;</div><div class="line"><span class="number">114</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.processConsumeResult(status, context, <span class="keyword">this</span>);</div><div class="line"><span class="number">115</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">116</span>:             log.warn(<span class="string">"processQueue is dropped without process consume result. messageQueue=&#123;&#125;, msgs=&#123;&#125;"</span>, messageQueue, msgs);</div><div class="line"><span class="number">117</span>:         &#125;</div><div class="line"><span class="number">118</span>:     &#125;</div><div class="line"><span class="number">119</span>: </div><div class="line"><span class="number">120</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šæ¶ˆè´¹è¯·æ±‚ã€‚æäº¤è¯·æ±‚æ‰§è¡Œæ¶ˆè´¹ã€‚</li><li>ç¬¬ 24 è‡³ 28 è¡Œ ï¼šåºŸå¼ƒå¤„ç†é˜Ÿåˆ—ä¸è¿›è¡Œæ¶ˆè´¹ã€‚</li><li>ç¬¬ 34 è‡³ 44 è¡Œ ï¼šHookã€‚</li><li>ç¬¬ 51 è¡Œ ï¼šå½“æ¶ˆæ¯ä¸ºé‡è¯•æ¶ˆæ¯ï¼Œè®¾ç½® <code>Topic</code>ä¸ºåŸå§‹ <code>Topic</code>ã€‚ä¾‹å¦‚ï¼šåŸå§‹ <code>Topic</code> ä¸º <code>TopicTest</code>ï¼Œé‡è¯•æ—¶ <code>Topic</code> ä¸º <code>%RETRY%please_rename_unique_group_name_4</code>ï¼Œç»è¿‡è¯¥æ–¹æ³•ï¼Œ<code>Topic</code> è®¾ç½®å› <code>TopicTest</code>ã€‚</li><li>ç¬¬ 53 è‡³ 58 è¡Œ ï¼šè®¾ç½®å¼€å§‹æ¶ˆè´¹æ—¶é—´ã€‚</li><li>ç¬¬ 61 è¡Œ ï¼š<strong>è¿›è¡Œæ¶ˆè´¹</strong>ã€‚</li><li>ç¬¬ 71 è‡³ 85 è¡Œ ï¼šè§£ææ¶ˆè´¹è¿”å›ç»“æœç±»å‹</li><li>ç¬¬ 87 è‡³ 90 è¡Œ ï¼š<code>Hook</code>ã€‚</li><li>ç¬¬ 92 è‡³ 99 è¡Œ ï¼šæ¶ˆè´¹ç»“æœçŠ¶æ€æœªç©ºæ—¶ï¼Œåˆ™è®¾ç½®æ¶ˆè´¹ç»“æœçŠ¶æ€ä¸ºç¨åæ¶ˆè´¹ã€‚</li><li>ç¬¬ 101 è‡³ 106 è¡Œ ï¼š<code>Hook</code>ã€‚</li><li>ç¬¬ 108 è‡³ 110 è¡Œ ï¼šç»Ÿè®¡ã€‚</li><li>ç¬¬ 112 è‡³ 117 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚<strong>å¦‚æœæ¶ˆè´¹å¤„ç†é˜Ÿåˆ—è¢«ç§»é™¤ï¼Œæ°å¥½æ¶ˆæ¯è¢«æ¶ˆè´¹ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼Œå› æ­¤ï¼Œæ¶ˆæ¯æ¶ˆè´¹è¦å°½æœ€å¤§å¯èƒ½æ€§å®ç°å¹‚ç­‰æ€§</strong>ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#consumemessageconcurrentlyserviceprocessconsumeresult">ConsumeMessageConcurrentlyService#processConsumeResult(â€¦)</a>ã€‚</li></ul><h2 id="ConsumeMessageConcurrentlyService-processConsumeResult-â€¦"><a href="#ConsumeMessageConcurrentlyService-processConsumeResult-â€¦" class="headerlink" title="ConsumeMessageConcurrentlyService#processConsumeResult(â€¦)"></a>ConsumeMessageConcurrentlyService#processConsumeResult(â€¦)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processConsumeResult</span><span class="params">(//</span></span></div><div class="line"> <span class="number">2</span>:     <span class="keyword">final</span> ConsumeConcurrentlyStatus status, //</div><div class="line"> <span class="number">3</span>:     <span class="keyword">final</span> ConsumeConcurrentlyContext context, //</div><div class="line"> <span class="number">4</span>:     <span class="keyword">final</span> ConsumeRequest consumeRequest//</div><div class="line"> <span class="number">5</span>: ) &#123;</div><div class="line"> <span class="number">6</span>:     <span class="keyword">int</span> ackIndex = context.getAckIndex();</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:     <span class="comment">// æ¶ˆæ¯ä¸ºç©ºï¼Œç›´æ¥è¿”å›</span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">if</span> (consumeRequest.getMsgs().isEmpty())</div><div class="line"><span class="number">10</span>:         <span class="keyword">return</span>;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:     <span class="comment">// è®¡ç®—ä»consumeRequest.msgs[0]åˆ°consumeRequest.msgs[ackIndex]çš„æ¶ˆæ¯æ¶ˆè´¹æˆåŠŸ</span></div><div class="line"><span class="number">13</span>:     <span class="keyword">switch</span> (status) &#123;</div><div class="line"><span class="number">14</span>:         <span class="keyword">case</span> CONSUME_SUCCESS:</div><div class="line"><span class="number">15</span>:             <span class="keyword">if</span> (ackIndex &gt;= consumeRequest.getMsgs().size()) &#123;</div><div class="line"><span class="number">16</span>:                 ackIndex = consumeRequest.getMsgs().size() - <span class="number">1</span>;</div><div class="line"><span class="number">17</span>:             &#125;</div><div class="line"><span class="number">18</span>:             <span class="comment">// ç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ•°é‡</span></div><div class="line"><span class="number">19</span>:             <span class="keyword">int</span> ok = ackIndex + <span class="number">1</span>;</div><div class="line"><span class="number">20</span>:             <span class="keyword">int</span> failed = consumeRequest.getMsgs().size() - ok;</div><div class="line"><span class="number">21</span>:             <span class="keyword">this</span>.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), ok);</div><div class="line"><span class="number">22</span>:             <span class="keyword">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), failed);</div><div class="line"><span class="number">23</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">24</span>:         <span class="keyword">case</span> RECONSUME_LATER:</div><div class="line"><span class="number">25</span>:             ackIndex = -<span class="number">1</span>;</div><div class="line"><span class="number">26</span>:             <span class="comment">// ç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ•°é‡</span></div><div class="line"><span class="number">27</span>:             <span class="keyword">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(),</div><div class="line"><span class="number">28</span>:                 consumeRequest.getMsgs().size());</div><div class="line"><span class="number">29</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">30</span>:         <span class="keyword">default</span>:</div><div class="line"><span class="number">31</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">32</span>:     &#125;</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>:     <span class="comment">// å¤„ç†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯</span></div><div class="line"><span class="number">35</span>:     <span class="keyword">switch</span> (<span class="keyword">this</span>.defaultMQPushConsumer.getMessageModel()) &#123;</div><div class="line"><span class="number">36</span>:         <span class="keyword">case</span> BROADCASTING: <span class="comment">// å¹¿æ’­æ¨¡å¼ï¼Œæ— è®ºæ˜¯å¦æ¶ˆè´¹å¤±è´¥ï¼Œä¸å‘å›æ¶ˆæ¯åˆ°Brokerï¼Œåªæ‰“å°Log</span></div><div class="line"><span class="number">37</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = ackIndex + <span class="number">1</span>; i &lt; consumeRequest.getMsgs().size(); i++) &#123;</div><div class="line"><span class="number">38</span>:                 MessageExt msg = consumeRequest.getMsgs().get(i);</div><div class="line"><span class="number">39</span>:                 log.warn(<span class="string">"BROADCASTING, the message consume failed, drop it, &#123;&#125;"</span>, msg.toString());</div><div class="line"><span class="number">40</span>:             &#125;</div><div class="line"><span class="number">41</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">42</span>:         <span class="keyword">case</span> CLUSTERING:</div><div class="line"><span class="number">43</span>:             <span class="comment">// å‘å›æ¶ˆæ¯å¤±è´¥åˆ°Brokerã€‚</span></div><div class="line"><span class="number">44</span>:             List&lt;MessageExt&gt; msgBackFailed = <span class="keyword">new</span> ArrayList&lt;&gt;(consumeRequest.getMsgs().size());</div><div class="line"><span class="number">45</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = ackIndex + <span class="number">1</span>; i &lt; consumeRequest.getMsgs().size(); i++) &#123;</div><div class="line"><span class="number">46</span>:                 MessageExt msg = consumeRequest.getMsgs().get(i);</div><div class="line"><span class="number">47</span>:                 <span class="keyword">boolean</span> result = <span class="keyword">this</span>.sendMessageBack(msg, context);</div><div class="line"><span class="number">48</span>:                 <span class="keyword">if</span> (!result) &#123;</div><div class="line"><span class="number">49</span>:                     msg.setReconsumeTimes(msg.getReconsumeTimes() + <span class="number">1</span>);</div><div class="line"><span class="number">50</span>:                     msgBackFailed.add(msg);</div><div class="line"><span class="number">51</span>:                 &#125;</div><div class="line"><span class="number">52</span>:             &#125;</div><div class="line"><span class="number">53</span>: </div><div class="line"><span class="number">54</span>:             <span class="comment">// å‘å›Brokerå¤±è´¥çš„æ¶ˆæ¯ï¼Œç›´æ¥æäº¤å»¶è¿Ÿé‡æ–°æ¶ˆè´¹</span></div><div class="line"><span class="number">55</span>:             <span class="keyword">if</span> (!msgBackFailed.isEmpty()) &#123;</div><div class="line"><span class="number">56</span>:                 consumeRequest.getMsgs().removeAll(msgBackFailed);</div><div class="line"><span class="number">57</span>: </div><div class="line"><span class="number">58</span>:                 <span class="keyword">this</span>.submitConsumeRequestLater(msgBackFailed, consumeRequest.getProcessQueue(), consumeRequest.getMessageQueue());</div><div class="line"><span class="number">59</span>:             &#125;</div><div class="line"><span class="number">60</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">61</span>:         <span class="keyword">default</span>:</div><div class="line"><span class="number">62</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">63</span>:     &#125;</div><div class="line"><span class="number">64</span>: </div><div class="line"><span class="number">65</span>:     <span class="comment">// ç§»é™¤æ¶ˆè´¹æˆåŠŸæ¶ˆæ¯ï¼Œå¹¶æ›´æ–°æœ€æ–°æ¶ˆè´¹è¿›åº¦</span></div><div class="line"><span class="number">66</span>:     <span class="keyword">long</span> offset = consumeRequest.getProcessQueue().removeMessage(consumeRequest.getMsgs());</div><div class="line"><span class="number">67</span>:     <span class="keyword">if</span> (offset &gt;= <span class="number">0</span> &amp;&amp; !consumeRequest.getProcessQueue().isDropped()) &#123;</div><div class="line"><span class="number">68</span>:         <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(consumeRequest.getMessageQueue(), offset, <span class="keyword">true</span>);</div><div class="line"><span class="number">69</span>:     &#125;</div><div class="line"><span class="number">70</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚</li><li>ç¬¬ 8 è‡³ 10 è¡Œ ï¼šæ¶ˆè´¹è¯·æ±‚æ¶ˆæ¯æœªç©ºæ—¶ï¼Œç›´æ¥è¿”å›ã€‚</li><li>ç¬¬ 12 è‡³ 32 è¡Œ ï¼šè®¡ç®— <code>ackIndex</code> å€¼ã€‚<code>consumeRequest.msgs[0 - ackIndex]</code>ä¸ºæ¶ˆè´¹æˆåŠŸï¼Œéœ€è¦è¿›è¡Œ <code>ack</code> ç¡®è®¤ã€‚<ul><li>ç¬¬ 14 è‡³ 23 è¡Œ ï¼š<code>CONSUME_SUCCESS</code> ï¼š<code>ackIndex = context.getAckIndex()</code>ã€‚</li><li>ç¬¬ 24 è‡³ 29 è¡Œ ï¼š<code>RECONSUME_LATER</code> ï¼š<code>ackIndex = -1</code>ã€‚</li></ul></li><li>ç¬¬34 è‡³ 63 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ã€‚<ul><li>ç¬¬ 36 è‡³ 41 è¡Œ ï¼š<code>BROADCASTING</code> ï¼šå¹¿æ’­æ¨¡å¼ï¼Œæ— è®ºæ˜¯å¦æ¶ˆè´¹å¤±è´¥ï¼Œä¸å‘å›æ¶ˆæ¯åˆ° <code>Broker</code>ï¼Œåªæ‰“å°æ—¥å¿—ã€‚</li><li>ç¬¬ 42 è‡³ 60 è¡Œ ï¼š<code>CLUSTERING</code> ï¼šé›†ç¾¤æ¨¡å¼ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯å‘å›åˆ° <code>Broker</code>ã€‚<ul><li>ç¬¬ 43 è‡³ 52 è¡Œ ï¼šå‘å›æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯åˆ° <code>Broker</code>ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#defaultmqpushconsumerimplsendmessageback">DefaultMQPushConsumerImpl#sendMessageBack(â€¦)</a>ã€‚</li><li>ç¬¬ 54 è‡³ 59 è¡Œ ï¼šå‘å› <code>Broker</code> å¤±è´¥çš„æ¶ˆæ¯ï¼Œç›´æ¥æäº¤å»¶è¿Ÿé‡æ–°æ¶ˆè´¹ã€‚</li><li><strong>å¦‚æœå‘å› <code>Broker</code> æˆåŠŸï¼Œç»“æœå› ä¸ºä¾‹å¦‚ç½‘ç»œå¼‚å¸¸ï¼Œå¯¼è‡´ <code>Consumer</code>ä»¥ä¸ºå‘å›å¤±è´¥ï¼Œåˆ¤å®šæ¶ˆè´¹å‘å›å¤±è´¥ï¼Œä¼šå¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼Œå› æ­¤ï¼Œæ¶ˆæ¯æ¶ˆè´¹è¦å°½æœ€å¤§å¯èƒ½æ€§å®ç°å¹‚ç­‰æ€§ã€‚</strong></li></ul></li></ul></li><li>ç¬¬ 65 è‡³ 69 è¡Œ ï¼šç§»é™¤<strong>ã€æ¶ˆè´¹æˆåŠŸã€‘</strong>å’Œ<strong>ã€æ¶ˆè´¹å¤±è´¥ä½†å‘å›<code>Broker</code>æˆåŠŸã€‘</strong>çš„æ¶ˆæ¯ï¼Œå¹¶æ›´æ–°æœ€æ–°æ¶ˆè´¹è¿›åº¦ã€‚<ul><li>ä¸ºä»€ä¹ˆä¼šæœ‰<strong>ã€æ¶ˆè´¹å¤±è´¥ä½†å‘å›<code>Broker</code>æˆåŠŸã€‘</strong>çš„æ¶ˆæ¯ï¼Ÿè§<strong>ç¬¬ 56 è¡Œ</strong>ã€‚</li><li><a href="#processqueueremovemessage">ProcessQueue#removeMessage(â€¦)</a></li></ul></li></ul><h3 id="ProcessQueue-removeMessage-â€¦"><a href="#ProcessQueue-removeMessage-â€¦" class="headerlink" title="ProcessQueue#removeMessage(â€¦)"></a>ProcessQueue#removeMessage(â€¦)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * ç§»é™¤æ¶ˆæ¯ï¼Œå¹¶è¿”å›ç¬¬ä¸€æ¡æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</div><div class="line"> 3:  *</div><div class="line"> 4:  * <span class="doctag">@param</span> msgs æ¶ˆæ¯</div><div class="line"> 5:  * <span class="doctag">@return</span> æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</div><div class="line"> 6:  */</div><div class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">removeMessage</span><span class="params">(<span class="keyword">final</span> List&lt;MessageExt&gt; msgs)</span> </span>&#123;</div><div class="line"> <span class="number">8</span>:     <span class="keyword">long</span> result = -<span class="number">1</span>;</div><div class="line"> <span class="number">9</span>:     <span class="keyword">final</span> <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"><span class="number">10</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">11</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"><span class="number">12</span>:         <span class="keyword">this</span>.lastConsumeTimestamp = now;</div><div class="line"><span class="number">13</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">14</span>:             <span class="keyword">if</span> (!msgTreeMap.isEmpty()) &#123;</div><div class="line"><span class="number">15</span>:                 result = <span class="keyword">this</span>.queueOffsetMax + <span class="number">1</span>; <span class="comment">// è¿™é‡Œ+1çš„åŸå› æ˜¯ï¼šå¦‚æœmsgTreeMapä¸ºç©ºæ—¶ï¼Œä¸‹ä¸€æ¡è·å¾—çš„æ¶ˆæ¯ä½ç½®ä¸ºqueueOffsetMax+1</span></div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:                 <span class="comment">// ç§»é™¤æ¶ˆæ¯</span></div><div class="line"><span class="number">18</span>:                 <span class="keyword">int</span> removedCnt = <span class="number">0</span>;</div><div class="line"><span class="number">19</span>:                 <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</div><div class="line"><span class="number">20</span>:                     MessageExt prev = msgTreeMap.remove(msg.getQueueOffset());</div><div class="line"><span class="number">21</span>:                     <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">22</span>:                         removedCnt--;</div><div class="line"><span class="number">23</span>:                     &#125;</div><div class="line"><span class="number">24</span>:                 &#125;</div><div class="line"><span class="number">25</span>:                 msgCount.addAndGet(removedCnt);</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:                 <span class="keyword">if</span> (!msgTreeMap.isEmpty()) &#123;</div><div class="line"><span class="number">28</span>:                     result = msgTreeMap.firstKey();</div><div class="line"><span class="number">29</span>:                 &#125;</div><div class="line"><span class="number">30</span>:             &#125;</div><div class="line"><span class="number">31</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">32</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:     &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line"><span class="number">35</span>:         log.error(<span class="string">"removeMessage exception"</span>, t);</div><div class="line"><span class="number">36</span>:     &#125;</div><div class="line"><span class="number">37</span>: </div><div class="line"><span class="number">38</span>:     <span class="keyword">return</span> result;</div><div class="line"><span class="number">39</span>: &#125;</div></pre></td></tr></table></figure><h2 id="ConsumeMessageConcurrentlyService-cleanExpireMsg-â€¦"><a href="#ConsumeMessageConcurrentlyService-cleanExpireMsg-â€¦" class="headerlink" title="ConsumeMessageConcurrentlyService#cleanExpireMsg(â€¦)"></a>ConsumeMessageConcurrentlyService#cleanExpireMsg(â€¦)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">this</span>.cleanExpireMsgExecutors.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">6</span>:             cleanExpireMsg();</div><div class="line"> <span class="number">7</span>:         &#125;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:     &#125;, <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeTimeout(), <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeTimeout(), TimeUnit.MINUTES);</div><div class="line"><span class="number">10</span>: &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: <span class="comment">/**</span></div><div class="line">13:  * æ¸…ç†è¿‡æœŸæ¶ˆæ¯</div><div class="line">14:  */</div><div class="line"><span class="number">15</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cleanExpireMsg</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">16</span>:     Iterator&lt;Map.Entry&lt;MessageQueue, ProcessQueue&gt;&gt; it =</div><div class="line"><span class="number">17</span>:         <span class="keyword">this</span>.defaultMQPushConsumerImpl.getRebalanceImpl().getProcessQueueTable().entrySet().iterator();</div><div class="line"><span class="number">18</span>:     <span class="keyword">while</span> (it.hasNext()) &#123;</div><div class="line"><span class="number">19</span>:         Map.Entry&lt;MessageQueue, ProcessQueue&gt; next = it.next();</div><div class="line"><span class="number">20</span>:         ProcessQueue pq = next.getValue();</div><div class="line"><span class="number">21</span>:         pq.cleanExpiredMsg(<span class="keyword">this</span>.defaultMQPushConsumer);</div><div class="line"><span class="number">22</span>:     &#125;</div><div class="line"><span class="number">23</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šå®šæ—¶æ¸…ç†è¿‡æœŸæ¶ˆæ¯ï¼Œé»˜è®¤å‘¨æœŸï¼š15minã€‚</li></ul><h3 id="ProcessQueue-cleanExpiredMsg-â€¦"><a href="#ProcessQueue-cleanExpiredMsg-â€¦" class="headerlink" title="ProcessQueue#cleanExpiredMsg(â€¦)"></a>ProcessQueue#cleanExpiredMsg(â€¦)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanExpiredMsg</span><span class="params">(DefaultMQPushConsumer pushConsumer)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// é¡ºåºæ¶ˆè´¹æ—¶ï¼Œç›´æ¥è¿”å›</span></div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (pushConsumer.getDefaultMQPushConsumerImpl().isConsumeOrderly()) &#123;</div><div class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">5</span>:     &#125;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="comment">// å¾ªç¯ç§»é™¤æ¶ˆæ¯</span></div><div class="line"> <span class="number">8</span>:     <span class="keyword">int</span> loop = msgTreeMap.size() &lt; <span class="number">16</span> ? msgTreeMap.size() : <span class="number">16</span>; <span class="comment">// æ¯æ¬¡å¾ªç¯æœ€å¤šç§»é™¤16æ¡</span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loop; i++) &#123;</div><div class="line"><span class="number">10</span>:         <span class="comment">// è·å–ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œè‹¥ä¸è¶…æ—¶ï¼Œåˆ™ç»“æŸå¾ªç¯</span></div><div class="line"><span class="number">11</span>:         MessageExt msg = <span class="keyword">null</span>;</div><div class="line"><span class="number">12</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">13</span>:             <span class="keyword">this</span>.lockTreeMap.readLock().lockInterruptibly();</div><div class="line"><span class="number">14</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">15</span>:                 <span class="keyword">if</span> (!msgTreeMap.isEmpty() &amp;&amp; System.currentTimeMillis() - Long.parseLong(MessageAccessor.getConsumeStartTimeStamp(msgTreeMap.firstEntry().getValue())) &gt; pushConsumer.getConsumeTimeout() * <span class="number">60</span> * <span class="number">1000</span>) &#123;</div><div class="line"><span class="number">16</span>:                     msg = msgTreeMap.firstEntry().getValue();</div><div class="line"><span class="number">17</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">18</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">19</span>:                 &#125;</div><div class="line"><span class="number">20</span>:             &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">21</span>:                 <span class="keyword">this</span>.lockTreeMap.readLock().unlock();</div><div class="line"><span class="number">22</span>:             &#125;</div><div class="line"><span class="number">23</span>:         &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"><span class="number">24</span>:             log.error(<span class="string">"getExpiredMsg exception"</span>, e);</div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">28</span>:             <span class="comment">// å‘å›è¶…æ—¶æ¶ˆæ¯</span></div><div class="line"><span class="number">29</span>:             pushConsumer.sendMessageBack(msg, <span class="number">3</span>);</div><div class="line"><span class="number">30</span>:             log.info(<span class="string">"send expire msg back. topic=&#123;&#125;, msgId=&#123;&#125;, storeHost=&#123;&#125;, queueId=&#123;&#125;, queueOffset=&#123;&#125;"</span>, msg.getTopic(), msg.getMsgId(), msg.getStoreHost(), msg.getQueueId(), msg.getQueueOffset());</div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>:             <span class="comment">// åˆ¤æ–­æ­¤æ—¶æ¶ˆæ¯æ˜¯å¦ä¾ç„¶æ˜¯ç¬¬ä¸€æ¡ï¼Œè‹¥æ˜¯ï¼Œåˆ™è¿›è¡Œç§»é™¤</span></div><div class="line"><span class="number">33</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">34</span>:                 <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"><span class="number">35</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">36</span>:                     <span class="keyword">if</span> (!msgTreeMap.isEmpty() &amp;&amp; msg.getQueueOffset() == msgTreeMap.firstKey()) &#123;</div><div class="line"><span class="number">37</span>:                         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">38</span>:                             msgTreeMap.remove(msgTreeMap.firstKey());</div><div class="line"><span class="number">39</span>:                         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">40</span>:                             log.error(<span class="string">"send expired msg exception"</span>, e);</div><div class="line"><span class="number">41</span>:                         &#125;</div><div class="line"><span class="number">42</span>:                     &#125;</div><div class="line"><span class="number">43</span>:                 &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">44</span>:                     <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"><span class="number">45</span>:                 &#125;</div><div class="line"><span class="number">46</span>:             &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"><span class="number">47</span>:                 log.error(<span class="string">"getExpiredMsg exception"</span>, e);</div><div class="line"><span class="number">48</span>:             &#125;</div><div class="line"><span class="number">49</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">50</span>:             log.error(<span class="string">"send expired msg exception"</span>, e);</div><div class="line"><span class="number">51</span>:         &#125;</div><div class="line"><span class="number">52</span>:     &#125;</div><div class="line"><span class="number">53</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šç§»é™¤è¿‡æœŸæ¶ˆæ¯ã€‚</li><li>ç¬¬ 2 è‡³ 5 è¡Œ ï¼šé¡ºåºæ¶ˆè´¹æ—¶ï¼Œç›´æ¥è¿”å›ã€‚</li><li>ç¬¬ 7 è‡³ 9 è¡Œ ï¼šå¾ªç¯ç§»é™¤æ¶ˆæ¯ã€‚é»˜è®¤æœ€å¤§å¾ªç¯æ¬¡æ•°ï¼š16æ¬¡ã€‚</li><li>ç¬¬ 10 è‡³ 25 è¡Œ ï¼šè·å–ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œè‹¥ä¸è¶…æ—¶ï¼Œåˆ™ç»“æŸå¾ªç¯ã€‚</li><li>ç¬¬ 29 è¡Œ ï¼š<strong>å‘å›è¶…æ—¶æ¶ˆæ¯åˆ°<code>Broker</code></strong>ã€‚</li><li>ç¬¬ 32 è‡³ 48 è¡Œ ï¼šåˆ¤æ–­æ­¤æ—¶æ¶ˆæ¯æ˜¯å¦ä¾ç„¶æ˜¯ç¬¬ä¸€æ¡ï¼Œè‹¥æ˜¯ï¼Œåˆ™è¿›è¡Œç§»é™¤ã€‚</li></ul><h1 id="7ã€PushConsumer-å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯"><a href="#7ã€PushConsumer-å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯" class="headerlink" title="7ã€PushConsumer å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯"></a>7ã€PushConsumer å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯</h1><h2 id="DefaultMQPushConsumerImpl-sendMessageBack-â€¦"><a href="#DefaultMQPushConsumerImpl-sendMessageBack-â€¦" class="headerlink" title="DefaultMQPushConsumerImpl#sendMessageBack(â€¦)"></a>DefaultMQPushConsumerImpl#sendMessageBack(â€¦)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessageBack</span><span class="params">(MessageExt msg, <span class="keyword">int</span> delayLevel, <span class="keyword">final</span> String brokerName)</span></span></div><div class="line"> 2:     <span class="keyword">throws</span> RemotingException, MQBrokerException, InterruptedException, MQClientException &#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">4</span>:         <span class="comment">// Consumerå‘å›æ¶ˆæ¯</span></div><div class="line"> <span class="number">5</span>:         String brokerAddr = (<span class="keyword">null</span> != brokerName) ? <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInPublish(brokerName)</div><div class="line"> <span class="number">6</span>:             : RemotingHelper.parseSocketAddressAddr(msg.getStoreHost());</div><div class="line"> <span class="number">7</span>:         <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().consumerSendMessageBack(brokerAddr, msg,</div><div class="line"> <span class="number">8</span>:             <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup(), delayLevel, <span class="number">5000</span>, getMaxReconsumeTimes());</div><div class="line"> <span class="number">9</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123; <span class="comment">// TODO ç–‘é—®ï¼šä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”Ÿå¼‚å¸¸</span></div><div class="line"><span class="number">10</span>:         <span class="comment">// å¼‚å¸¸æ—¶ï¼Œä½¿ç”¨Clientå†…ç½®Producerå‘å›æ¶ˆæ¯</span></div><div class="line"><span class="number">11</span>:         log.error(<span class="string">"sendMessageBack Exception, "</span> + <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup(), e);</div><div class="line"><span class="number">12</span>: </div><div class="line"><span class="number">13</span>:         Message newMsg = <span class="keyword">new</span> Message(MixAll.getRetryTopic(<span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup()), msg.getBody());</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:         String originMsgId = MessageAccessor.getOriginMessageId(msg);</div><div class="line"><span class="number">16</span>:         MessageAccessor.setOriginMessageId(newMsg, UtilAll.isBlank(originMsgId) ? msg.getMsgId() : originMsgId);</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:         newMsg.setFlag(msg.getFlag());</div><div class="line"><span class="number">19</span>:         MessageAccessor.setProperties(newMsg, msg.getProperties());</div><div class="line"><span class="number">20</span>:         MessageAccessor.putProperty(newMsg, MessageConst.PROPERTY_RETRY_TOPIC, msg.getTopic());</div><div class="line"><span class="number">21</span>:         MessageAccessor.setReconsumeTime(newMsg, String.valueOf(msg.getReconsumeTimes() + <span class="number">1</span>));</div><div class="line"><span class="number">22</span>:         MessageAccessor.setMaxReconsumeTimes(newMsg, String.valueOf(getMaxReconsumeTimes()));</div><div class="line"><span class="number">23</span>:         newMsg.setDelayTimeLevel(<span class="number">3</span> + msg.getReconsumeTimes());</div><div class="line"><span class="number">24</span>: </div><div class="line"><span class="number">25</span>:         <span class="keyword">this</span>.mQClientFactory.getDefaultMQProducer().send(newMsg);</div><div class="line"><span class="number">26</span>:     &#125;</div><div class="line"><span class="number">27</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šå‘å›æ¶ˆæ¯ã€‚</li><li>ç¬¬ 4 è‡³ 8 è¡Œ ï¼š<code>Consumer</code> å‘å›æ¶ˆæ¯ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#mqclientapiimplconsumersendmessageback">MQClientAPIImpl#consumerSendMessageBack(â€¦)</a>ã€‚</li><li>ç¬¬ 10 è‡³ 25 è¡Œ ï¼šå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œ<code>Consumer</code> å†…ç½®é»˜è®¤ <code>Producer</code> å‘é€æ¶ˆæ¯ã€‚<ul><li>ğŸ˜ˆç–‘é—®ï¼šä»€ä¹ˆæ ·çš„æƒ…å†µä¸‹ä¼šå‘ç”Ÿå¼‚å¸¸å‘¢ï¼Ÿ</li></ul></li></ul><h3 id="MQClientAPIImpl-consumerSendMessageBack-â€¦"><a href="#MQClientAPIImpl-consumerSendMessageBack-â€¦" class="headerlink" title="MQClientAPIImpl#consumerSendMessageBack(â€¦)"></a>MQClientAPIImpl#consumerSendMessageBack(â€¦)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * Consumerå‘å›æ¶ˆæ¯</div><div class="line"> 3:  * <span class="doctag">@param</span> addr Brokeråœ°å€</div><div class="line"> 4:  * <span class="doctag">@param</span> msg æ¶ˆæ¯</div><div class="line"> 5:  * <span class="doctag">@param</span> consumerGroup æ¶ˆè´¹åˆ†ç»„</div><div class="line"> 6:  * <span class="doctag">@param</span> delayLevel å»¶è¿Ÿçº§åˆ«</div><div class="line"> 7:  * <span class="doctag">@param</span> timeoutMillis è¶…æ—¶</div><div class="line"> 8:  * <span class="doctag">@param</span> maxConsumeRetryTimes æ¶ˆè´¹æœ€å¤§é‡è¯•æ¬¡æ•°</div><div class="line"> 9:  * <span class="doctag">@throws</span> RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class="line">10:  * <span class="doctag">@throws</span> MQBrokerException å½“Brokerå‘ç”Ÿå¼‚å¸¸æ—¶</div><div class="line">11:  * <span class="doctag">@throws</span> InterruptedException å½“çº¿ç¨‹ä¸­æ–­æ—¶</div><div class="line">12:  */</div><div class="line"><span class="number">13</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumerSendMessageBack</span><span class="params">(</span></span></div><div class="line"><span class="number">14</span>:     <span class="keyword">final</span> String addr,</div><div class="line"><span class="number">15</span>:     <span class="keyword">final</span> MessageExt msg,</div><div class="line"><span class="number">16</span>:     <span class="keyword">final</span> String consumerGroup,</div><div class="line"><span class="number">17</span>:     <span class="keyword">final</span> <span class="keyword">int</span> delayLevel,</div><div class="line"><span class="number">18</span>:     <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis,</div><div class="line"><span class="number">19</span>:     <span class="keyword">final</span> <span class="keyword">int</span> maxConsumeRetryTimes</div><div class="line"><span class="number">20</span>: ) <span class="keyword">throws</span> RemotingException, MQBrokerException, InterruptedException &#123;</div><div class="line"><span class="number">21</span>:     ConsumerSendMsgBackRequestHeader requestHeader = <span class="keyword">new</span> ConsumerSendMsgBackRequestHeader();</div><div class="line"><span class="number">22</span>:     RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CONSUMER_SEND_MSG_BACK, requestHeader);</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:     requestHeader.setGroup(consumerGroup);</div><div class="line"><span class="number">25</span>:     requestHeader.setOriginTopic(msg.getTopic());</div><div class="line"><span class="number">26</span>:     requestHeader.setOffset(msg.getCommitLogOffset());</div><div class="line"><span class="number">27</span>:     requestHeader.setDelayLevel(delayLevel);</div><div class="line"><span class="number">28</span>:     requestHeader.setOriginMsgId(msg.getMsgId());</div><div class="line"><span class="number">29</span>:     requestHeader.setMaxReconsumeTimes(maxConsumeRetryTimes);</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:     RemotingCommand response = <span class="keyword">this</span>.remotingClient.invokeSync(MixAll.brokerVIPChannel(<span class="keyword">this</span>.clientConfig.isVipChannelEnabled(), addr),</div><div class="line"><span class="number">32</span>:         request, timeoutMillis);</div><div class="line"><span class="number">33</span>:     <span class="keyword">assert</span> response != <span class="keyword">null</span>;</div><div class="line"><span class="number">34</span>:     <span class="keyword">switch</span> (response.getCode()) &#123;</div><div class="line"><span class="number">35</span>:         <span class="keyword">case</span> ResponseCode.SUCCESS: &#123;</div><div class="line"><span class="number">36</span>:             <span class="keyword">return</span>;</div><div class="line"><span class="number">37</span>:         &#125;</div><div class="line"><span class="number">38</span>:         <span class="keyword">default</span>:</div><div class="line"><span class="number">39</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">40</span>:     &#125;</div><div class="line"><span class="number">41</span>: </div><div class="line"><span class="number">42</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> MQBrokerException(response.getCode(), response.getRemark());</div><div class="line"><span class="number">43</span>: &#125;</div></pre></td></tr></table></figure><h1 id="8ã€Consumer-æ¶ˆè´¹è¿›åº¦"><a href="#8ã€Consumer-æ¶ˆè´¹è¿›åº¦" class="headerlink" title="8ã€Consumer æ¶ˆè´¹è¿›åº¦"></a>8ã€Consumer æ¶ˆè´¹è¿›åº¦</h1><h2 id="OffsetStore"><a href="#OffsetStore" class="headerlink" title="OffsetStore"></a>OffsetStore</h2><p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/07.png" alt="OffsetStoreç±»å›¾.png"></p><ul><li><code>RemoteBrokerOffsetStore</code> ï¼š<code>Consumer</code> <strong>é›†ç¾¤æ¨¡å¼</strong> ä¸‹ï¼Œä½¿ç”¨è¿œç¨‹ <code>Broker</code> æ¶ˆè´¹è¿›åº¦ã€‚</li><li><code>LocalFileOffsetStore</code> ï¼š<code>Consumer</code> <strong>å¹¿æ’­æ¨¡å¼</strong>ä¸‹ï¼Œä½¿ç”¨æœ¬åœ° <code>æ–‡ä»¶</code> æ¶ˆè´¹è¿›åº¦ã€‚</li></ul><h3 id="OffsetStore-load-â€¦"><a href="#OffsetStore-load-â€¦" class="headerlink" title="OffsetStore#load(â€¦)"></a>OffsetStore#load(â€¦)</h3><h4 id="LocalFileOffsetStore-load-â€¦"><a href="#LocalFileOffsetStore-load-â€¦" class="headerlink" title="LocalFileOffsetStore#load(â€¦)"></a>LocalFileOffsetStore#load(â€¦)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> <span class="keyword">throws</span> MQClientException </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// ä»æœ¬åœ°ç¡¬ç›˜è¯»å–æ¶ˆè´¹è¿›åº¦</span></div><div class="line"> <span class="number">4</span>:     OffsetSerializeWrapper offsetSerializeWrapper = <span class="keyword">this</span>.readLocalOffset();</div><div class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (offsetSerializeWrapper != <span class="keyword">null</span> &amp;&amp; offsetSerializeWrapper.getOffsetTable() != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">6</span>:         offsetTable.putAll(offsetSerializeWrapper.getOffsetTable());</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:         <span class="comment">// æ‰“å°æ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">for</span> (MessageQueue mq : offsetSerializeWrapper.getOffsetTable().keySet()) &#123;</div><div class="line"><span class="number">10</span>:             AtomicLong offset = offsetSerializeWrapper.getOffsetTable().get(mq);</div><div class="line"><span class="number">11</span>:             log.info(<span class="string">"load consumer's offset, &#123;&#125; &#123;&#125; &#123;&#125;"</span>,</div><div class="line"><span class="number">12</span>:                 <span class="keyword">this</span>.groupName,</div><div class="line"><span class="number">13</span>:                 mq,</div><div class="line"><span class="number">14</span>:                 offset.get());</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>:     &#125;</div><div class="line"><span class="number">17</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šä»æœ¬åœ°æ–‡ä»¶åŠ è½½æ¶ˆè´¹è¿›åº¦åˆ°å†…å­˜ã€‚</li></ul><h5 id="OffsetSerializeWrapper"><a href="#OffsetSerializeWrapper" class="headerlink" title="OffsetSerializeWrapper"></a>OffsetSerializeWrapper</h5><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OffsetSerializeWrapper</span> <span class="keyword">extends</span> <span class="title">RemotingSerializable</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; offsetTable =</div><div class="line"> <span class="number">3</span>:             <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; <span class="title">getOffsetTable</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">6</span>:         <span class="keyword">return</span> offsetTable;</div><div class="line"> <span class="number">7</span>:     &#125;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOffsetTable</span><span class="params">(ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; offsetTable)</span> </span>&#123;</div><div class="line"><span class="number">10</span>:         <span class="keyword">this</span>.offsetTable = offsetTable;</div><div class="line"><span class="number">11</span>:     &#125;</div><div class="line"><span class="number">12</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šæœ¬åœ° <code>Offset</code> å­˜å‚¨åºåˆ—åŒ–ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">Yunai-MacdeMacBook-Pro-2:config yunai$ cat /Users/yunai/.rocketmq_offsets/192.168.17.0@DEFAULT/please_rename_unique_group_name_1/offsets.json</div><div class="line">&#123;</div><div class="line">	<span class="string">"offsetTable"</span>:&#123;&#123;</div><div class="line">			<span class="string">"brokerName"</span>:<span class="string">"broker-a"</span>,</div><div class="line">			<span class="string">"queueId"</span>:3,</div><div class="line">			<span class="string">"topic"</span>:<span class="string">"TopicTest"</span></div><div class="line">		&#125;:1470,&#123;</div><div class="line">			<span class="string">"brokerName"</span>:<span class="string">"broker-a"</span>,</div><div class="line">			<span class="string">"queueId"</span>:2,</div><div class="line">			<span class="string">"topic"</span>:<span class="string">"TopicTest"</span></div><div class="line">		&#125;:1471,&#123;</div><div class="line">			<span class="string">"brokerName"</span>:<span class="string">"broker-a"</span>,</div><div class="line">			<span class="string">"queueId"</span>:1,</div><div class="line">			<span class="string">"topic"</span>:<span class="string">"TopicTest"</span></div><div class="line">		&#125;:1470,&#123;</div><div class="line">			<span class="string">"brokerName"</span>:<span class="string">"broker-a"</span>,</div><div class="line">			<span class="string">"queueId"</span>:0,</div><div class="line">			<span class="string">"topic"</span>:<span class="string">"TopicTest"</span></div><div class="line">		&#125;:1470</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="RemoteBrokerOffsetStore-load-â€¦"><a href="#RemoteBrokerOffsetStore-load-â€¦" class="headerlink" title="RemoteBrokerOffsetStore#load(â€¦)"></a>RemoteBrokerOffsetStore#load(â€¦)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">3</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šä¸è¿›è¡ŒåŠ è½½ï¼Œå®é™…è¯»å–æ¶ˆè´¹è¿›åº¦æ—¶ï¼Œä» <code>Broker</code> è·å–ã€‚</li></ul><h3 id="OffsetStore-readOffset-â€¦"><a href="#OffsetStore-readOffset-â€¦" class="headerlink" title="OffsetStore#readOffset(â€¦)"></a>OffsetStore#readOffset(â€¦)</h3><p>è¯»å–æ¶ˆè´¹è¿›åº¦ç±»å‹ï¼š</p><ul><li><code>READ_FROM_MEMORY</code> ï¼šä»å†…å­˜è¯»å–ã€‚</li><li><code>READ_FROM_STORE</code> ï¼šä»å­˜å‚¨( <code>Broker</code> æˆ– <code>æ–‡ä»¶</code> )è¯»å–ã€‚</li><li><code>MEMORY_FIRST_THEN_STORE</code> ï¼šä¼˜å…ˆä»å†…å­˜è¯»å–ï¼Œè¯»å–ä¸åˆ°ï¼Œä»å­˜å‚¨è¯»å–ã€‚</li></ul><h4 id="LocalFileOffsetStore-readOffset-â€¦"><a href="#LocalFileOffsetStore-readOffset-â€¦" class="headerlink" title="LocalFileOffsetStore#readOffset(â€¦)"></a>LocalFileOffsetStore#readOffset(â€¦)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">readOffset</span><span class="params">(<span class="keyword">final</span> MessageQueue mq, <span class="keyword">final</span> ReadOffsetType type)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (mq != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">4</span>:         <span class="keyword">switch</span> (type) &#123;</div><div class="line"> <span class="number">5</span>:             <span class="keyword">case</span> MEMORY_FIRST_THEN_STORE:</div><div class="line"> <span class="number">6</span>:             <span class="keyword">case</span> READ_FROM_MEMORY: &#123;</div><div class="line"> <span class="number">7</span>:                 AtomicLong offset = <span class="keyword">this</span>.offsetTable.get(mq);</div><div class="line"> <span class="number">8</span>:                 <span class="keyword">if</span> (offset != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">9</span>:                     <span class="keyword">return</span> offset.get();</div><div class="line"><span class="number">10</span>:                 &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ReadOffsetType.READ_FROM_MEMORY == type) &#123;</div><div class="line"><span class="number">11</span>:                     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">12</span>:                 &#125;</div><div class="line"><span class="number">13</span>:             &#125;</div><div class="line"><span class="number">14</span>:             <span class="keyword">case</span> READ_FROM_STORE: &#123;</div><div class="line"><span class="number">15</span>:                 OffsetSerializeWrapper offsetSerializeWrapper;</div><div class="line"><span class="number">16</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">17</span>:                     offsetSerializeWrapper = <span class="keyword">this</span>.readLocalOffset();</div><div class="line"><span class="number">18</span>:                 &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</div><div class="line"><span class="number">19</span>:                     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">20</span>:                 &#125;</div><div class="line"><span class="number">21</span>:                 <span class="keyword">if</span> (offsetSerializeWrapper != <span class="keyword">null</span> &amp;&amp; offsetSerializeWrapper.getOffsetTable() != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">22</span>:                     AtomicLong offset = offsetSerializeWrapper.getOffsetTable().get(mq);</div><div class="line"><span class="number">23</span>:                     <span class="keyword">if</span> (offset != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">24</span>:                         <span class="keyword">this</span>.updateOffset(mq, offset.get(), <span class="keyword">false</span>);</div><div class="line"><span class="number">25</span>:                         <span class="keyword">return</span> offset.get();</div><div class="line"><span class="number">26</span>:                     &#125;</div><div class="line"><span class="number">27</span>:                 &#125;</div><div class="line"><span class="number">28</span>:             &#125;</div><div class="line"><span class="number">29</span>:             <span class="keyword">default</span>:</div><div class="line"><span class="number">30</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">31</span>:         &#125;</div><div class="line"><span class="number">32</span>:     &#125;</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>:     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">35</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 16 è¡Œ ï¼šä» <code>æ–‡ä»¶</code> è¯»å–æ¶ˆè´¹è¿›åº¦ã€‚</li></ul><h4 id="RemoteBrokerOffsetStore-readOffset-â€¦"><a href="#RemoteBrokerOffsetStore-readOffset-â€¦" class="headerlink" title="RemoteBrokerOffsetStore#readOffset(â€¦)"></a>RemoteBrokerOffsetStore#readOffset(â€¦)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">readOffset</span><span class="params">(<span class="keyword">final</span> MessageQueue mq, <span class="keyword">final</span> ReadOffsetType type)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (mq != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">4</span>:         <span class="keyword">switch</span> (type) &#123;</div><div class="line"> <span class="number">5</span>:             <span class="keyword">case</span> MEMORY_FIRST_THEN_STORE:</div><div class="line"> <span class="number">6</span>:             <span class="keyword">case</span> READ_FROM_MEMORY: &#123;</div><div class="line"> <span class="number">7</span>:                 AtomicLong offset = <span class="keyword">this</span>.offsetTable.get(mq);</div><div class="line"> <span class="number">8</span>:                 <span class="keyword">if</span> (offset != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">9</span>:                     <span class="keyword">return</span> offset.get();</div><div class="line"><span class="number">10</span>:                 &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ReadOffsetType.READ_FROM_MEMORY == type) &#123;</div><div class="line"><span class="number">11</span>:                     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">12</span>:                 &#125;</div><div class="line"><span class="number">13</span>:             &#125;</div><div class="line"><span class="number">14</span>:             <span class="keyword">case</span> READ_FROM_STORE: &#123;</div><div class="line"><span class="number">15</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">16</span>:                     <span class="keyword">long</span> brokerOffset = <span class="keyword">this</span>.fetchConsumeOffsetFromBroker(mq);</div><div class="line"><span class="number">17</span>:                     AtomicLong offset = <span class="keyword">new</span> AtomicLong(brokerOffset);</div><div class="line"><span class="number">18</span>:                     <span class="keyword">this</span>.updateOffset(mq, offset.get(), <span class="keyword">false</span>);</div><div class="line"><span class="number">19</span>:                     <span class="keyword">return</span> brokerOffset;</div><div class="line"><span class="number">20</span>:                 &#125;</div><div class="line"><span class="number">21</span>:                 <span class="comment">// No offset in broker</span></div><div class="line"><span class="number">22</span>:                 <span class="keyword">catch</span> (MQBrokerException e) &#123;</div><div class="line"><span class="number">23</span>:                     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">24</span>:                 &#125;</div><div class="line"><span class="number">25</span>:                 <span class="comment">//Other exceptions</span></div><div class="line"><span class="number">26</span>:                 <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">27</span>:                     log.warn(<span class="string">"fetchConsumeOffsetFromBroker exception, "</span> + mq, e);</div><div class="line"><span class="number">28</span>:                     <span class="keyword">return</span> -<span class="number">2</span>;</div><div class="line"><span class="number">29</span>:                 &#125;</div><div class="line"><span class="number">30</span>:             &#125;</div><div class="line"><span class="number">31</span>:             <span class="keyword">default</span>:</div><div class="line"><span class="number">32</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:     &#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>:     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">37</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 16 è¡Œ ï¼šä» <code>Broker</code> è¯»å–æ¶ˆè´¹è¿›åº¦ã€‚</li></ul><h3 id="OffsetStore-updateOffset-â€¦"><a href="#OffsetStore-updateOffset-â€¦" class="headerlink" title="OffsetStore#updateOffset(â€¦)"></a>OffsetStore#updateOffset(â€¦)</h3><p>è¯¥æ–¹æ³• <code>RemoteBrokerOffsetStore</code> ä¸ <code>LocalFileOffsetStore</code> å®ç°ç›¸åŒã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateOffset</span><span class="params">(MessageQueue mq, <span class="keyword">long</span> offset, <span class="keyword">boolean</span> increaseOnly)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (mq != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">4</span>:         AtomicLong offsetOld = <span class="keyword">this</span>.offsetTable.get(mq);</div><div class="line"> <span class="number">5</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == offsetOld) &#123;</div><div class="line"> <span class="number">6</span>:             offsetOld = <span class="keyword">this</span>.offsetTable.putIfAbsent(mq, <span class="keyword">new</span> AtomicLong(offset));</div><div class="line"> <span class="number">7</span>:         &#125;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> != offsetOld) &#123;</div><div class="line"><span class="number">10</span>:             <span class="keyword">if</span> (increaseOnly) &#123;</div><div class="line"><span class="number">11</span>:                 MixAll.compareAndIncreaseOnly(offsetOld, offset);</div><div class="line"><span class="number">12</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">13</span>:                 offsetOld.set(offset);</div><div class="line"><span class="number">14</span>:             &#125;</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>:     &#125;</div><div class="line"><span class="number">17</span>: &#125;</div></pre></td></tr></table></figure><h3 id="OffsetStore-persistAll-â€¦"><a href="#OffsetStore-persistAll-â€¦" class="headerlink" title="OffsetStore#persistAll(â€¦)"></a>OffsetStore#persistAll(â€¦)</h3><h4 id="LocalFileOffsetStore-persistAll-â€¦"><a href="#LocalFileOffsetStore-persistAll-â€¦" class="headerlink" title="LocalFileOffsetStore#persistAll(â€¦)"></a>LocalFileOffsetStore#persistAll(â€¦)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">persistAll</span><span class="params">(Set&lt;MessageQueue&gt; mqs)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == mqs || mqs.isEmpty())</div><div class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:     OffsetSerializeWrapper offsetSerializeWrapper = <span class="keyword">new</span> OffsetSerializeWrapper();</div><div class="line"> <span class="number">7</span>:     <span class="keyword">for</span> (Map.Entry&lt;MessageQueue, AtomicLong&gt; entry : <span class="keyword">this</span>.offsetTable.entrySet()) &#123;</div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (mqs.contains(entry.getKey())) &#123;</div><div class="line"> <span class="number">9</span>:             AtomicLong offset = entry.getValue();</div><div class="line"><span class="number">10</span>:             offsetSerializeWrapper.getOffsetTable().put(entry.getKey(), offset);</div><div class="line"><span class="number">11</span>:         &#125;</div><div class="line"><span class="number">12</span>:     &#125;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>:     String jsonString = offsetSerializeWrapper.toJson(<span class="keyword">true</span>);</div><div class="line"><span class="number">15</span>:     <span class="keyword">if</span> (jsonString != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">16</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">17</span>:             MixAll.string2File(jsonString, <span class="keyword">this</span>.storePath);</div><div class="line"><span class="number">18</span>:         &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line"><span class="number">19</span>:             log.error(<span class="string">"persistAll consumer offset Exception, "</span> + <span class="keyword">this</span>.storePath, e);</div><div class="line"><span class="number">20</span>:         &#125;</div><div class="line"><span class="number">21</span>:     &#125;</div><div class="line"><span class="number">22</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šæŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ã€‚<strong>å°†æ¶ˆè´¹è¿›åº¦å†™å…¥æ–‡ä»¶</strong>ã€‚</li></ul><h4 id="RemoteBrokerOffsetStore-persistAll-â€¦"><a href="#RemoteBrokerOffsetStore-persistAll-â€¦" class="headerlink" title="RemoteBrokerOffsetStore#persistAll(â€¦)"></a>RemoteBrokerOffsetStore#persistAll(â€¦)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">persistAll</span><span class="params">(Set&lt;MessageQueue&gt; mqs)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == mqs || mqs.isEmpty())</div><div class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:     <span class="comment">// æŒä¹…åŒ–æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"> <span class="number">7</span>:     <span class="keyword">final</span> HashSet&lt;MessageQueue&gt; unusedMQ = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (!mqs.isEmpty()) &#123;</div><div class="line"> <span class="number">9</span>:         <span class="keyword">for</span> (Map.Entry&lt;MessageQueue, AtomicLong&gt; entry : <span class="keyword">this</span>.offsetTable.entrySet()) &#123;</div><div class="line"><span class="number">10</span>:             MessageQueue mq = entry.getKey();</div><div class="line"><span class="number">11</span>:             AtomicLong offset = entry.getValue();</div><div class="line"><span class="number">12</span>:             <span class="keyword">if</span> (offset != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">13</span>:                 <span class="keyword">if</span> (mqs.contains(mq)) &#123;</div><div class="line"><span class="number">14</span>:                     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">15</span>:                         <span class="keyword">this</span>.updateConsumeOffsetToBroker(mq, offset.get());</div><div class="line"><span class="number">16</span>:                         log.info(<span class="string">"[persistAll] Group: &#123;&#125; ClientId: &#123;&#125; updateConsumeOffsetToBroker &#123;&#125; &#123;&#125;"</span>,</div><div class="line"><span class="number">17</span>:                             <span class="keyword">this</span>.groupName,</div><div class="line"><span class="number">18</span>:                             <span class="keyword">this</span>.mQClientFactory.getClientId(),</div><div class="line"><span class="number">19</span>:                             mq,</div><div class="line"><span class="number">20</span>:                             offset.get());</div><div class="line"><span class="number">21</span>:                     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">22</span>:                         log.error(<span class="string">"updateConsumeOffsetToBroker exception, "</span> + mq.toString(), e);</div><div class="line"><span class="number">23</span>:                     &#125;</div><div class="line"><span class="number">24</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">25</span>:                     unusedMQ.add(mq);</div><div class="line"><span class="number">26</span>:                 &#125;</div><div class="line"><span class="number">27</span>:             &#125;</div><div class="line"><span class="number">28</span>:         &#125;</div><div class="line"><span class="number">29</span>:     &#125;</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:     <span class="comment">// ç§»é™¤ä¸é€‚ç”¨çš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"><span class="number">32</span>:     <span class="keyword">if</span> (!unusedMQ.isEmpty()) &#123;</div><div class="line"><span class="number">33</span>:         <span class="keyword">for</span> (MessageQueue mq : unusedMQ) &#123;</div><div class="line"><span class="number">34</span>:             <span class="keyword">this</span>.offsetTable.remove(mq);</div><div class="line"><span class="number">35</span>:             log.info(<span class="string">"remove unused mq, &#123;&#125;, &#123;&#125;"</span>, mq, <span class="keyword">this</span>.groupName);</div><div class="line"><span class="number">36</span>:         &#125;</div><div class="line"><span class="number">37</span>:     &#125;</div><div class="line"><span class="number">38</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šæŒä¹…åŒ–æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—æ•°ç»„çš„æ¶ˆè´¹è¿›åº¦åˆ° <code>Broker</code>ï¼Œå¹¶ç§»é™¤éæŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—ã€‚</li></ul><h4 id="MQClientInstance-persistAllConsumerOffset-â€¦"><a href="#MQClientInstance-persistAllConsumerOffset-â€¦" class="headerlink" title="MQClientInstance#persistAllConsumerOffset(â€¦)"></a>MQClientInstance#persistAllConsumerOffset(â€¦)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startScheduledTask</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// å®šæ—¶åŒæ­¥æ¶ˆè´¹è¿›åº¦</span></div><div class="line"> <span class="number">3</span>:     <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">6</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">7</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">8</span>:                 MQClientInstance.<span class="keyword">this</span>.cleanOfflineBroker();</div><div class="line"> <span class="number">9</span>:                 MQClientInstance.<span class="keyword">this</span>.sendHeartbeatToAllBrokerWithLock();</div><div class="line"><span class="number">10</span>:             &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">11</span>:                 log.error(<span class="string">"ScheduledTask sendHeartbeatToAllBroker exception"</span>, e);</div><div class="line"><span class="number">12</span>:             &#125;</div><div class="line"><span class="number">13</span>:         &#125;</div><div class="line"><span class="number">14</span>:     &#125;, <span class="number">1000</span>, <span class="keyword">this</span>.clientConfig.getHeartbeatBrokerInterval(), TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">15</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šå®šæ—¶è¿›è¡ŒæŒä¹…åŒ–ï¼Œé»˜è®¤å‘¨æœŸï¼š5000msã€‚</li><li><strong>é‡è¦è¯´æ˜ ï¼š</strong><ul><li><strong>æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚</strong></li><li><strong>æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚</strong></li><li><strong>æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚</strong></li></ul></li></ul><h1 id="9ã€ç»“å°¾"><a href="#9ã€ç»“å°¾" class="headerlink" title="9ã€ç»“å°¾"></a>9ã€ç»“å°¾</h1><p>ğŸ˜ˆå¯èƒ½æ˜¯æœ¬ç³»åˆ—æœ€é•¿çš„ä¸€ç¯‡æ–‡ç« ï¼Œå¦‚æœ‰è¡¨è¾¾é”™è¯¯å’Œä¸æ¸…æ™°ï¼Œè¯·å¤šå¤šè§è°…ã€‚<br>æ„Ÿè°¢å¯¹æœ¬ç³»åˆ—çš„é˜…è¯»ã€æ”¶è—ã€ç‚¹èµã€åˆ†äº«ï¼Œç‰¹åˆ«æ˜¯ç¿»åˆ°ç»“å°¾ã€‚ğŸ˜œçœŸçš„æœ‰ä¸¢ä¸¢é•¿ã€‚</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/RocketMQ/">RocketMQ</a></div><div class="article-share" id="share"><div data-url="http://www.yunai.me/RocketMQ/message-pull-and-consume-second/" data-title="RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸‹ï¼‰ | èŠ‹è‰¿Vçš„åšå®¢" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/RocketMQ/store-init-and-shutdown/" title="RocketMQ æºç åˆ†æ â€”â€” Store åˆå§‹åŒ–ä¸å…³é—­"><strong>PREVIOUS:</strong><br><span>RocketMQ æºç åˆ†æ â€”â€” Store åˆå§‹åŒ–ä¸å…³é—­</span></a></div><div class="next"><a href="/RocketMQ/message-pull-and-consume-first/" title="RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰"><strong>NEXT:</strong><br><span>RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰</span></a></div></nav></div></div><footer><div id="footer"><p class="copyright">Â© 2017 <a href="http://www.yunai.me" target="_blank" title="ç‹æ–‡æ–Œ">ç‹æ–‡æ–Œ</a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a> && Powered by <a href="http://hexo.io" target="_blank" title="hexo" rel="external nofollow noopener noreferrer">hexo</a> && Theme by <a href="http://gengbiao.me" target="_blank" title="coney" rel="external nofollow noopener noreferrer">coney</a></p></div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2");ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script>$(document).ready(function(){function e(){var e=jqueryAlert({title:"ğŸ‘¼æ¯å‘¨å…­æ›´æ–°ä¸€ç¯‡æºç è§£æï¼Œã€æ‰«ä¸€æ‰«ã€‘å…³æ³¨å…¬ä¼—å·ğŸ‘¼",width:"500",height:"550",modal:!0,content:a+'<p style="color: red">ä»Šæ—¥'+n+"å·²å…³æ³¨äººæ•°ï¼š"+c+'</p><img width="400" src="http://www.yunai.me/images/common/wechat_mp_simple.png" /><p style="color: red">å…³æ³¨åï¼Œå¯åŠ å…¥ã€æºç åœˆã€‘å¾®ä¿¡ç¾¤</p>',buttons:{"å·²å…³æ³¨ï¼Œå…³é—­çª—å£":function(){e.close()}}});$.cookie(o,t+1,{expires:1,path:"/"})}var o="doubi",t=$.cookie(o);t?t=parseInt(t):($.cookie(o,0,{expires:1,path:"/"}),t=0);var i="default",r={juejin:"æ˜é‡‘",oschina:"å¼€æºä¸­å›½",sjdbc:"Sharding-JDBC",jianshu:"ç®€ä¹¦",csdn:"CSDN",iteye:"iteye",cnblogs:"åšå®¢å›­"};for(var o in r)if(location.search.indexOf(o)>=0){i=o;break}"default"===i&&(i=$.cookie("from")||"default"),$.cookie("from",i,{expires:365,path:"/"});var a="",n="";if(i&&r[i]&&(a='<p style="color: red">æ¬¢è¿æ¥è‡ªã€'+r[i]+"ã€‘çš„åŒå­¦</p>",n="ã€"+r[i]+"ã€‘"),t<=3){var c=103+5*(new Date).getHours();setTimeout(e,1e4*(t+1))}})</script></body>