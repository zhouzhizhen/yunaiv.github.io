<!DOCTYPE html>
<html lang="zh">
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E">
    <meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0">
    <meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1">
    <meta name="sogou_site_verification" content="MpPsku240L">
    <meta name="description" content="åŸæ–‡åœ°å€ï¼šhttp://www.yunai.me/RocketMQ/message-send-and-consume-orderly RocketMQ å¸¦æ³¨é‡Šæºç åœ°å€ ï¼šhttps://github.com/YunaiV/incubator-rocketmq ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å·     1. æ¦‚è¿° 2. Producer é¡ºåºå‘é€ 3. Consume">
<meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢">
<meta property="og:type" content="article">
<meta property="og:title" content="RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹">
<meta property="og:url" content="http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/index.html">
<meta property="og:site_name" content="èŠ‹è‰¿Vçš„åšå®¢">
<meta property="og:description" content="åŸæ–‡åœ°å€ï¼šhttp://www.yunai.me/RocketMQ/message-send-and-consume-orderly RocketMQ å¸¦æ³¨é‡Šæºç åœ°å€ ï¼šhttps://github.com/YunaiV/incubator-rocketmq ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å·     1. æ¦‚è¿° 2. Producer é¡ºåºå‘é€ 3. Consume">
<meta property="og:image" content="http://www.yunai.me/images/common/wechat_mp.jpeg">
<meta property="og:image" content="http://www.yunai.me/images/RocketMQ/2017_05_13/01.png">
<meta property="og:updated_time" content="2017-06-09T13:09:13.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹">
<meta name="twitter:description" content="åŸæ–‡åœ°å€ï¼šhttp://www.yunai.me/RocketMQ/message-send-and-consume-orderly RocketMQ å¸¦æ³¨é‡Šæºç åœ°å€ ï¼šhttps://github.com/YunaiV/incubator-rocketmq ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å·     1. æ¦‚è¿° 2. Producer é¡ºåºå‘é€ 3. Consume">
<meta name="twitter:image" content="http://www.yunai.me/images/common/wechat_mp.jpeg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹</title>
    <!-- keywords -->
    
    <meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢">
    
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    


    <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
    <script>AV.initialize("uxUSudJeAFuAk0PKwFMY7MJW-gzGzoHsz", "NTPUE2VIEE0gyPPGbAaLPtLb");</script>
    <!-- ç™¾åº¦ç»Ÿè®¡ -->
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ef4ed89f6dc83d01803a2440ae21e666";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    <!-- ç™¾åº¦ç«™é•¿-è¢«åŠ¨æ¨é€ -->
    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

    <!-- 360æœç´¢-è‡ªåŠ¨æ”¶å½• -->
    <script>
        (function(){
            var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";
            document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:visible;">
    <i class="fa fa-chevron-up fa-lg"></i>
  </a>
  <span id="menu" style="visibility: visible;">
    <span id="nav">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/RocketMQ/high-availability/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$(" #i-prev").toggle();"="" onmouseout="$("></i></a></li>
        
        
        <li><a class="icon" href="/RocketMQ/store-init-and-shutdown/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$(" #i-next").toggle();"="" onmouseout="$("></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$(" #i-top").toggle();"="" onmouseout="$("></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$(" #i-share").toggle();"="" onmouseout="$(" onclick="$(" #share").toggle();return="" false;"=""></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&text=RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&is_video=false&description=RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹&body=Check out this article: http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&name=RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">2.</span> <span class="toc-text">2. Producer é¡ºåºå‘é€</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">3.</span> <span class="toc-text">3. Consumer ä¸¥æ ¼é¡ºåºæ¶ˆè´¹</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 è·å¾—(é”å®š)æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.3.1.</span> <span class="toc-text">3.1.1 æ¶ˆè´¹æ¶ˆæ¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.3.2.</span> <span class="toc-text">3.1.2 å¤„ç†æ¶ˆè´¹ç»“æœ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.3.3.</span> <span class="toc-text">3.13 æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">èŠ‹è‰¿Vçš„åšå®¢</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-05-12T16:00:00.000Z" itemprop="datePublished">2017-05-13</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <blockquote>
<p>åŸæ–‡åœ°å€ï¼š<a href="http://www.yunai.me/RocketMQ/message-send-and-consume-orderly">http://www.yunai.me/RocketMQ/message-send-and-consume-orderly</a><br>
<code>RocketMQ</code> <strong>å¸¦æ³¨é‡Šæºç </strong>åœ°å€ ï¼š<a href="https://github.com/YunaiV/incubator-rocketmq" target="_blank" rel="external">https://github.com/YunaiV/incubator-rocketmq</a><br>
<strong>ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å·</strong></p>
</blockquote>
<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt="wechat_mp"></p>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. Producer é¡ºåºå‘é€</a></li>
<li><a href="#">3. Consumer é¡ºåºæ¶ˆè´¹</a>
<ul>
<li><a href="#">3.1 è·å¾—(é”å®š)æ¶ˆæ¯é˜Ÿåˆ—</a></li>
<li><a href="#">3.2 ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—</a></li>
<li><a href="#">3.3 æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—</a>
<ul>
<li><a href="#">3.1.1 æ¶ˆè´¹æ¶ˆæ¯</a></li>
<li><a href="#">3.1.2 å¤„ç†æ¶ˆè´¹ç»“æœ</a></li>
<li><a href="#">3.13 æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1>1. æ¦‚è¿°</h1>
<p><strong>å»ºè®®</strong>å‰ç½®é˜…è¯»å†…å®¹ï¼š</p>
<ul>
<li><a href="http://www.yunai.me/RocketMQ/message-send-and-receive/">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message å‘é€ä¸æ¥æ”¶ã€‹</a></li>
<li><a href="http://www.yunai.me/RocketMQ/message-pull-and-consume-second/">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸‹ï¼‰ã€‹</a></li>
</ul>
<p>å½“ç„¶å¯¹ <code>Message</code> å‘é€ä¸æ¶ˆè´¹å·²ç»æœ‰ä¸€å®šäº†è§£çš„åŒå­¦ï¼Œå¯ä»¥é€‰æ‹©è·³è¿‡ã€‚</p>
<hr>
<p><code>RocketMQ</code> æä¾›äº†ä¸¤ç§é¡ºåºçº§åˆ«ï¼š</p>
<ul>
<li>æ™®é€šé¡ºåºæ¶ˆæ¯ ï¼š<code>Producer</code> å°†ç›¸å…³è”çš„æ¶ˆæ¯å‘é€åˆ°ç›¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
<li>å®Œå…¨ä¸¥æ ¼é¡ºåº ï¼šåœ¨ <code>æ™®é€šé¡ºåºæ¶ˆæ¯</code> çš„åŸºç¡€ä¸Šï¼Œ<code>Consumer</code> ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚</li>
</ul>
<p>ç»å¤§éƒ¨åˆ†åœºæ™¯ä¸‹åªéœ€è¦ç”¨åˆ°<strong>æ™®é€šé¡ºåºæ¶ˆæ¯</strong>ã€‚<br>
ä¾‹å¦‚è¯´ï¼šç»™ç”¨æˆ·å‘é€çŸ­ä¿¡æ¶ˆæ¯ + å‘é€æ¨é€æ¶ˆæ¯ï¼Œå°†ä¸¤æ¡æ¶ˆæ¯å‘é€åˆ°ä¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè‹¥å…¶ä¸­ä¸€æ¡æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è¾ƒæ…¢é€ æˆå µå¡ï¼Œç”¨æˆ·å¯èƒ½ä¼šæ”¶åˆ°ä¸¤æ¡æ¶ˆæ¯ä¼šå­˜åœ¨ä¸€å®šçš„æ—¶é—´å·®ï¼Œå¸¦æ¥çš„ä½“éªŒä¼šç›¸å¯¹è¾ƒå·®ã€‚å½“ç„¶ç±»ä¼¼è¿™ç§åœºæ™¯ï¼Œå³ä½¿æœ‰ä¸€å®šçš„æ—¶é—´å·®ï¼Œ<strong>ä¸ä¼šäº§ç”Ÿç³»ç»Ÿé€»è¾‘ä¸ŠBUG</strong>ã€‚å¦å¤–ï¼Œ<code>æ™®é€šé¡ºåºæ¶ˆæ¯</code>æ€§èƒ½èƒ½æ›´åŠ å¥½ã€‚<br>
é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä½¿ç”¨ä½¿ç”¨<strong>å®Œå…¨ä¸¥æ ¼é¡ºåº</strong>ï¼Ÿå¦‚ä¸‹æ˜¯æ¥è‡ªå®˜æ–¹æ–‡æ¡£çš„è¯´æ˜ï¼š</p>
<blockquote>
<p>ç›®å‰å·²çŸ¥çš„åº”ç”¨åªæœ‰æ•°æ®åº“ <code>binlog</code> åŒæ­¥å¼ºä¾èµ–ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ï¼Œå…¶ä»–åº”ç”¨ç»å¤§éƒ¨åˆ†éƒ½å¯ä»¥å®¹å¿çŸ­æš‚ä¹±åºï¼Œæ¨èä½¿ç”¨æ™®é€šçš„é¡ºåºæ¶ˆæ¯</p>
</blockquote>
<hr>
<p>ğŸ˜ˆä¸Šä»£ç ï¼ï¼ï¼</p>
<h1>2. <code>Producer</code> é¡ºåºå‘é€</h1>
<p>å®˜æ–¹å‘é€é¡ºåºæ¶ˆæ¯çš„<strong>ä¾‹å­</strong>ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">package</span> org.apache.rocketmq.example.ordermessage;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">import</span> java.io.UnsupportedEncodingException;</div><div class="line"> <span class="number">4</span>: <span class="keyword">import</span> java.util.List;</div><div class="line"> <span class="number">5</span>: <span class="keyword">import</span> org.apache.rocketmq.client.exception.MQBrokerException;</div><div class="line"> <span class="number">6</span>: <span class="keyword">import</span> org.apache.rocketmq.client.exception.MQClientException;</div><div class="line"> <span class="number">7</span>: <span class="keyword">import</span> org.apache.rocketmq.client.producer.DefaultMQProducer;</div><div class="line"> <span class="number">8</span>: <span class="keyword">import</span> org.apache.rocketmq.client.producer.MQProducer;</div><div class="line"> <span class="number">9</span>: <span class="keyword">import</span> org.apache.rocketmq.client.producer.MessageQueueSelector;</div><div class="line"><span class="number">10</span>: <span class="keyword">import</span> org.apache.rocketmq.client.producer.SendResult;</div><div class="line"><span class="number">11</span>: <span class="keyword">import</span> org.apache.rocketmq.common.message.Message;</div><div class="line"><span class="number">12</span>: <span class="keyword">import</span> org.apache.rocketmq.common.message.MessageQueue;</div><div class="line"><span class="number">13</span>: <span class="keyword">import</span> org.apache.rocketmq.remoting.common.RemotingHelper;</div><div class="line"><span class="number">14</span>: <span class="keyword">import</span> org.apache.rocketmq.remoting.exception.RemotingException;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</div><div class="line"><span class="number">17</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> UnsupportedEncodingException </span>&#123;</div><div class="line"><span class="number">18</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">19</span>:             MQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"please_rename_unique_group_name"</span>);</div><div class="line"><span class="number">20</span>:             producer.start();</div><div class="line"><span class="number">21</span>: </div><div class="line"><span class="number">22</span>:             String[] tags = <span class="keyword">new</span> String[] &#123;<span class="string">"TagA"</span>, <span class="string">"TagB"</span>, <span class="string">"TagC"</span>, <span class="string">"TagD"</span>, <span class="string">"TagE"</span>&#125;;</div><div class="line"><span class="number">23</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</div><div class="line"><span class="number">24</span>:                 <span class="keyword">int</span> orderId = i % <span class="number">10</span>;</div><div class="line"><span class="number">25</span>:                 Message msg =</div><div class="line"><span class="number">26</span>:                     <span class="keyword">new</span> Message(<span class="string">"TopicTestjjj"</span>, tags[i % tags.length], <span class="string">"KEY"</span> + i,</div><div class="line"><span class="number">27</span>:                         (<span class="string">"Hello RocketMQ "</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));</div><div class="line"><span class="number">28</span>:                 SendResult sendResult = producer.send(msg, <span class="keyword">new</span> MessageQueueSelector() &#123;</div><div class="line"><span class="number">29</span>:                     <span class="meta">@Override</span></div><div class="line"><span class="number">30</span>:                     <span class="function"><span class="keyword">public</span> MessageQueue <span class="title">select</span><span class="params">(List&lt;MessageQueue&gt; mqs, Message msg, Object arg)</span> </span>&#123;</div><div class="line"><span class="number">31</span>:                         Integer id = (Integer) arg;</div><div class="line"><span class="number">32</span>:                         <span class="keyword">int</span> index = id % mqs.size();</div><div class="line"><span class="number">33</span>:                         <span class="keyword">return</span> mqs.get(index);</div><div class="line"><span class="number">34</span>:                     &#125;</div><div class="line"><span class="number">35</span>:                 &#125;, orderId);</div><div class="line"><span class="number">36</span>: </div><div class="line"><span class="number">37</span>:                 System.out.printf(<span class="string">"%s%n"</span>, sendResult);</div><div class="line"><span class="number">38</span>:             &#125;</div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>:             producer.shutdown();</div><div class="line"><span class="number">41</span>:         &#125; <span class="keyword">catch</span> (MQClientException | RemotingException | MQBrokerException | InterruptedException e) &#123;</div><div class="line"><span class="number">42</span>:             e.printStackTrace();</div><div class="line"><span class="number">43</span>:         &#125;</div><div class="line"><span class="number">44</span>:     &#125;</div><div class="line"><span class="number">45</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬ 28 è‡³ 35 è¡Œ ï¼šå®ç°äº†æ ¹æ® <code>id % mqs.size()</code> æ¥è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—çš„é€‰æ‹©ã€‚å½“å‰ä¾‹å­ï¼Œ<strong>æˆ‘ä»¬ä¼ é€’ <code>orderId</code> ä½œä¸ºå‚æ•°ï¼Œé‚£ä¹ˆç›¸åŒçš„ <code>orderId</code> èƒ½å¤Ÿè¿›å…¥ç›¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—</strong>ã€‚</li>
</ul>
<hr>
<p><code>MessageQueueSelector</code> æ¥å£çš„<strong>æºç </strong>ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MessageQueueSelector</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"> 4:      * é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 5:      *</div><div class="line"> 6:      * <span class="doctag">@param</span> mqs æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 7:      * <span class="doctag">@param</span> msg æ¶ˆæ¯</div><div class="line"> 8:      * <span class="doctag">@param</span> arg å‚æ•°</div><div class="line"> 9:      * <span class="doctag">@return</span> æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line">10:      */</div><div class="line"><span class="number">11</span>:     <span class="function">MessageQueue <span class="title">select</span><span class="params">(<span class="keyword">final</span> List&lt;MessageQueue&gt; mqs, <span class="keyword">final</span> Message msg, <span class="keyword">final</span> Object arg)</span></span>;</div><div class="line"><span class="number">12</span>: &#125;</div></pre></td></tr></table></figure></p>
<hr>
<p><code>Producer</code> é€‰æ‹©é˜Ÿåˆ—å‘é€æ¶ˆæ¯æ–¹æ³•çš„<strong>æºç </strong>ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">16</span>: <span class="function"><span class="keyword">private</span> SendResult <span class="title">sendSelectImpl</span><span class="params">(//</span></span></div><div class="line"><span class="number">17</span>:     Message msg, //</div><div class="line"><span class="number">18</span>:     MessageQueueSelector selector, //</div><div class="line"><span class="number">19</span>:     Object arg, //</div><div class="line"><span class="number">20</span>:     <span class="keyword">final</span> CommunicationMode communicationMode, //</div><div class="line"><span class="number">21</span>:     <span class="keyword">final</span> SendCallback sendCallback, <span class="keyword">final</span> <span class="keyword">long</span> timeout//</div><div class="line"><span class="number">22</span>: ) <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</div><div class="line"><span class="number">23</span>:     <span class="keyword">this</span>.makeSureStateOK();</div><div class="line"><span class="number">24</span>:     Validators.checkMessage(msg, <span class="keyword">this</span>.defaultMQProducer);</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:     TopicPublishInfo topicPublishInfo = <span class="keyword">this</span>.tryToFindTopicPublishInfo(msg.getTopic());</div><div class="line"><span class="number">27</span>:     <span class="keyword">if</span> (topicPublishInfo != <span class="keyword">null</span> &amp;&amp; topicPublishInfo.ok()) &#123;</div><div class="line"><span class="number">28</span>:         MessageQueue mq = <span class="keyword">null</span>;</div><div class="line"><span class="number">29</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">30</span>:             mq = selector.select(topicPublishInfo.getMessageQueueList(), msg, arg);</div><div class="line"><span class="number">31</span>:         &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">32</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"select message queue throwed exception."</span>, e);</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>: </div><div class="line"><span class="number">35</span>:         <span class="keyword">if</span> (mq != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">36</span>:             <span class="keyword">return</span> <span class="keyword">this</span>.sendKernelImpl(msg, mq, communicationMode, sendCallback, <span class="keyword">null</span>, timeout);</div><div class="line"><span class="number">37</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">38</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"select message queue return null."</span>, <span class="keyword">null</span>);</div><div class="line"><span class="number">39</span>:         &#125;</div><div class="line"><span class="number">40</span>:     &#125;</div><div class="line"><span class="number">41</span>: </div><div class="line"><span class="number">42</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"No route info for this topic, "</span> + msg.getTopic(), <span class="keyword">null</span>);</div><div class="line"><span class="number">43</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬ 30 è¡Œ ï¼šé€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
<li>ç¬¬ 36 è¡Œ ï¼šå‘é€æ¶ˆæ¯ã€‚</li>
</ul>
<h1>3. <code>Consumer</code> ä¸¥æ ¼é¡ºåºæ¶ˆè´¹</h1>
<p><code>Consumer</code> åœ¨ä¸¥æ ¼é¡ºåºæ¶ˆè´¹æ—¶ï¼Œé€šè¿‡ <strong>ä¸‰</strong> æŠŠé”ä¿è¯ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚</p>
<ul>
<li><code>Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ï¼ˆ<strong>åˆ†å¸ƒå¼é”</strong>ï¼‰ ï¼š
<ul>
<li>é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œ<code>Consumer</code> ä» <code>Broker</code> è·å¾—è¯¥é”åï¼Œæ‰èƒ½è¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€æ¶ˆè´¹ã€‚</li>
<li>å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œ<code>Consumer</code> æ— éœ€è¯¥é”ã€‚</li>
</ul>
</li>
<li><code>Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—é”ï¼ˆ<strong>æœ¬åœ°é”</strong>ï¼‰ ï¼š<code>Consumer</code> è·å¾—è¯¥é”æ‰èƒ½æ“ä½œæ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
<li><code>Consumer</code> æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ¶ˆè´¹é”ï¼ˆ<strong>æœ¬åœ°é”</strong>ï¼‰ ï¼š<code>Consumer</code> è·å¾—è¯¥é”æ‰èƒ½æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
</ul>
<p><strong>å¯èƒ½åŒå­¦æœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆæœ‰ <code>Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—é”è¿˜éœ€è¦æœ‰ <code>Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”å‘¢</strong>ï¼ŸğŸ˜ˆè®©æˆ‘ä»¬å¸¦ç€ç–‘é—®ç»§ç»­å¾€ä¸‹çœ‹ã€‚</p>
<hr>
<h2>3.1 è·å¾—(é”å®š)æ¶ˆæ¯é˜Ÿåˆ—</h2>
<p><strong>é›†ç¾¤æ¨¡å¼</strong>ä¸‹ï¼Œ<code>Consumer</code> æ›´æ–°å±äºè‡ªå·±çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‘ <code>Broker</code> é”å®šè¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆ<em>å¹¿æ’­æ¨¡å¼ä¸‹ä¸éœ€è¦</em>ï¼‰ã€‚å¦‚æœé”å®šå¤±è´¥ï¼Œåˆ™æ›´æ–°å¤±è´¥ï¼Œå³è¯¥æ¶ˆæ¯é˜Ÿåˆ—ä¸å±äºè‡ªå·±ï¼Œä¸èƒ½è¿›è¡Œæ¶ˆè´¹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalanceImpl.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateProcessQueueTableInRebalance</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> Set&lt;MessageQueue&gt; mqSet, <span class="keyword">final</span> <span class="keyword">boolean</span> isOrder)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: <span class="comment">// ..... æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç  </span></div><div class="line"> <span class="number">4</span>:     <span class="comment">// å¢åŠ  ä¸åœ¨processQueueTable &amp;&amp; å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</span></div><div class="line"> <span class="number">5</span>:     List&lt;PullRequest&gt; pullRequestList = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// æ‹‰æ¶ˆæ¯è¯·æ±‚æ•°ç»„</span></div><div class="line"> <span class="number">6</span>:     <span class="keyword">for</span> (MessageQueue mq : mqSet) &#123;</div><div class="line"> <span class="number">7</span>:         <span class="keyword">if</span> (!<span class="keyword">this</span>.processQueueTable.containsKey(mq)) &#123;</div><div class="line"> <span class="number">8</span>:             <span class="keyword">if</span> (isOrder &amp;&amp; !<span class="keyword">this</span>.lock(mq)) &#123; <span class="comment">// é¡ºåºæ¶ˆæ¯é”å®šæ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"> <span class="number">9</span>:                 log.warn(<span class="string">"doRebalance, &#123;&#125;, add a new mq failed, &#123;&#125;, because lock failed"</span>, consumerGroup, mq);</div><div class="line"><span class="number">10</span>:                 <span class="keyword">continue</span>;</div><div class="line"><span class="number">11</span>:             &#125;</div><div class="line"><span class="number">12</span>: </div><div class="line"><span class="number">13</span>:             <span class="keyword">this</span>.removeDirtyOffset(mq);</div><div class="line"><span class="number">14</span>:             ProcessQueue pq = <span class="keyword">new</span> ProcessQueue();</div><div class="line"><span class="number">15</span>:             <span class="keyword">long</span> nextOffset = <span class="keyword">this</span>.computePullFromWhere(mq);</div><div class="line"><span class="number">16</span>:             <span class="keyword">if</span> (nextOffset &gt;= <span class="number">0</span>) &#123;</div><div class="line"><span class="number">17</span>:                 ProcessQueue pre = <span class="keyword">this</span>.processQueueTable.putIfAbsent(mq, pq);</div><div class="line"><span class="number">18</span>:                 <span class="keyword">if</span> (pre != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">19</span>:                     log.info(<span class="string">"doRebalance, &#123;&#125;, mq already exists, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">20</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">21</span>:                     log.info(<span class="string">"doRebalance, &#123;&#125;, add a new mq, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">22</span>:                     PullRequest pullRequest = <span class="keyword">new</span> PullRequest();</div><div class="line"><span class="number">23</span>:                     pullRequest.setConsumerGroup(consumerGroup);</div><div class="line"><span class="number">24</span>:                     pullRequest.setNextOffset(nextOffset);</div><div class="line"><span class="number">25</span>:                     pullRequest.setMessageQueue(mq);</div><div class="line"><span class="number">26</span>:                     pullRequest.setProcessQueue(pq);</div><div class="line"><span class="number">27</span>:                     pullRequestList.add(pullRequest);</div><div class="line"><span class="number">28</span>:                     changed = <span class="keyword">true</span>;</div><div class="line"><span class="number">29</span>:                 &#125;</div><div class="line"><span class="number">30</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">31</span>:                 log.warn(<span class="string">"doRebalance, &#123;&#125;, add new mq failed, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">32</span>:             &#125;</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:     &#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>: <span class="comment">// ..... æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç  </span></div><div class="line"><span class="number">37</span>: &#125;</div><div class="line"><span class="number">38</span>: </div><div class="line"><span class="number">39</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalanceImpl.javaã€‘</span></div><div class="line"><span class="number">40</span>: <span class="comment">/**</span></div><div class="line">41:  * è¯·æ±‚Brokerè·å¾—æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—çš„åˆ†å¸ƒå¼é”</div><div class="line">42:  *</div><div class="line">43:  * <span class="doctag">@param</span> mq é˜Ÿåˆ—</div><div class="line">44:  * <span class="doctag">@return</span> æ˜¯å¦æˆåŠŸ</div><div class="line">45:  */</div><div class="line"><span class="number">46</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(<span class="keyword">final</span> MessageQueue mq)</span> </span>&#123;</div><div class="line"><span class="number">47</span>:     FindBrokerResult findBrokerResult = <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(), MixAll.MASTER_ID, <span class="keyword">true</span>);</div><div class="line"><span class="number">48</span>:     <span class="keyword">if</span> (findBrokerResult != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">49</span>:         LockBatchRequestBody requestBody = <span class="keyword">new</span> LockBatchRequestBody();</div><div class="line"><span class="number">50</span>:         requestBody.setConsumerGroup(<span class="keyword">this</span>.consumerGroup);</div><div class="line"><span class="number">51</span>:         requestBody.setClientId(<span class="keyword">this</span>.mQClientFactory.getClientId());</div><div class="line"><span class="number">52</span>:         requestBody.getMqSet().add(mq);</div><div class="line"><span class="number">53</span>: </div><div class="line"><span class="number">54</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">55</span>:             <span class="comment">// è¯·æ±‚Brokerè·å¾—æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—çš„åˆ†å¸ƒå¼é”</span></div><div class="line"><span class="number">56</span>:             Set&lt;MessageQueue&gt; lockedMq =</div><div class="line"><span class="number">57</span>:                 <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().lockBatchMQ(findBrokerResult.getBrokerAddr(), requestBody, <span class="number">1000</span>);</div><div class="line"><span class="number">58</span>: </div><div class="line"><span class="number">59</span>:             <span class="comment">// è®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—é”å®šæˆåŠŸã€‚é”å®šæ¶ˆæ¯é˜Ÿåˆ—æˆåŠŸï¼Œå¯èƒ½æœ¬åœ°æ²¡æœ‰æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ï¼Œè®¾ç½®é”å®šæˆåŠŸä¼šåœ¨lockAll()æ–¹æ³•ã€‚</span></div><div class="line"><span class="number">60</span>:             <span class="keyword">for</span> (MessageQueue mmqq : lockedMq) &#123;</div><div class="line"><span class="number">61</span>:                 ProcessQueue processQueue = <span class="keyword">this</span>.processQueueTable.get(mmqq);</div><div class="line"><span class="number">62</span>:                 <span class="keyword">if</span> (processQueue != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">63</span>:                     processQueue.setLocked(<span class="keyword">true</span>);</div><div class="line"><span class="number">64</span>:                     processQueue.setLastLockTimestamp(System.currentTimeMillis());</div><div class="line"><span class="number">65</span>:                 &#125;</div><div class="line"><span class="number">66</span>:             &#125;</div><div class="line"><span class="number">67</span>: </div><div class="line"><span class="number">68</span>:             <span class="keyword">boolean</span> lockOK = lockedMq.contains(mq);</div><div class="line"><span class="number">69</span>:             log.info(<span class="string">"the message queue lock &#123;&#125;, &#123;&#125; &#123;&#125;"</span>,</div><div class="line"><span class="number">70</span>:                 lockOK ? <span class="string">"OK"</span> : <span class="string">"Failed"</span>,</div><div class="line"><span class="number">71</span>:                 <span class="keyword">this</span>.consumerGroup,</div><div class="line"><span class="number">72</span>:                 mq);</div><div class="line"><span class="number">73</span>:             <span class="keyword">return</span> lockOK;</div><div class="line"><span class="number">74</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">75</span>:             log.error(<span class="string">"lockBatchMQ exception, "</span> + mq, e);</div><div class="line"><span class="number">76</span>:         &#125;</div><div class="line"><span class="number">77</span>:     &#125;</div><div class="line"><span class="number">78</span>: </div><div class="line"><span class="number">79</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">80</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>â¬†ï¸â¬†ï¸â¬†ï¸</li>
<li>ç¬¬ 8 è‡³ 11 è¡Œ ï¼šé¡ºåºæ¶ˆè´¹æ—¶ï¼Œé”å®šæ¶ˆæ¯é˜Ÿåˆ—ã€‚å¦‚æœé”å®šå¤±è´¥ï¼Œæ–°å¢æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å¤±è´¥ã€‚</li>
</ul>
<hr>
<p><code>Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ä¼šè¿‡æœŸï¼Œé»˜è®¤é…ç½® 30sã€‚å› æ­¤ï¼Œ<code>Consumer</code> éœ€è¦ä¸æ–­å‘ <code>Broker</code> åˆ·æ–°è¯¥é”è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤é…ç½® 20s åˆ·æ–°ä¸€æ¬¡ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.messageModel())) &#123;</div><div class="line"> <span class="number">4</span>:         <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"> <span class="number">5</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">6</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">7</span>:                 ConsumeMessageOrderlyService.<span class="keyword">this</span>.lockMQPeriodically();</div><div class="line"> <span class="number">8</span>:             &#125;</div><div class="line"> <span class="number">9</span>:         &#125;, <span class="number">1000</span> * <span class="number">1</span>, ProcessQueue.REBALANCE_LOCK_INTERVAL, TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">10</span>:     &#125;</div><div class="line"><span class="number">11</span>: &#125;</div></pre></td></tr></table></figure></p>
<h2>3.2 ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—</h2>
<p>é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œ<code>Consumer</code> ç§»é™¤è‡ªå·±çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‘ <code>Broker</code> è§£é”è¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¹¿æ’­æ¨¡å¼ä¸‹ä¸éœ€è¦ï¼‰ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalancePushImpl.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="comment">/**</span></div><div class="line"> 3:  * ç§»é™¤ä¸éœ€è¦çš„é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯</div><div class="line"> 4:  * 1. æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹</div><div class="line"> 5:  * 2. é¡ºåºæ¶ˆè´¹&amp;é›†ç¾¤æ¨¡å¼ï¼Œè§£é”å¯¹è¯¥é˜Ÿåˆ—çš„é”å®š</div><div class="line"> 6:  *</div><div class="line"> 7:  * <span class="doctag">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 8:  * <span class="doctag">@param</span> pq æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class="line"> 9:  * <span class="doctag">@return</span> æ˜¯å¦ç§»é™¤æˆåŠŸ</div><div class="line">10:  */</div><div class="line"><span class="number">11</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">12</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeUnnecessaryMessageQueue</span><span class="params">(MessageQueue mq, ProcessQueue pq)</span> </span>&#123;</div><div class="line"><span class="number">13</span>:     <span class="comment">// åŒæ­¥é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚</span></div><div class="line"><span class="number">14</span>:     <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().persist(mq);</div><div class="line"><span class="number">15</span>:     <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().removeOffset(mq);</div><div class="line"><span class="number">16</span>:     <span class="comment">// é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œé¡ºåºæ¶ˆè´¹ç§»é™¤æ—¶ï¼Œè§£é”å¯¹é˜Ÿåˆ—çš„é”å®š</span></div><div class="line"><span class="number">17</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.defaultMQPushConsumerImpl.isConsumeOrderly()</div><div class="line"><span class="number">18</span>:         &amp;&amp; MessageModel.CLUSTERING.equals(<span class="keyword">this</span>.defaultMQPushConsumerImpl.messageModel())) &#123;</div><div class="line"><span class="number">19</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">20</span>:             <span class="keyword">if</span> (pq.getLockConsume().tryLock(<span class="number">1000</span>, TimeUnit.MILLISECONDS)) &#123;</div><div class="line"><span class="number">21</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">22</span>:                     <span class="keyword">return</span> <span class="keyword">this</span>.unlockDelay(mq, pq);</div><div class="line"><span class="number">23</span>:                 &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">24</span>:                     pq.getLockConsume().unlock();</div><div class="line"><span class="number">25</span>:                 &#125;</div><div class="line"><span class="number">26</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">27</span>:                 log.warn(<span class="string">"[WRONG]mq is consuming, so can not unlock it, &#123;&#125;. maybe hanged for a while, &#123;&#125;"</span>, <span class="comment">//</span></div><div class="line"><span class="number">28</span>:                     mq, <span class="comment">//</span></div><div class="line"><span class="number">29</span>:                     pq.getTryUnlockTimes());</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:                 pq.incTryUnlockTimes();</div><div class="line"><span class="number">32</span>:             &#125;</div><div class="line"><span class="number">33</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">34</span>:             log.error(<span class="string">"removeUnnecessaryMessageQueue Exception"</span>, e);</div><div class="line"><span class="number">35</span>:         &#125;</div><div class="line"><span class="number">36</span>: </div><div class="line"><span class="number">37</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">38</span>:     &#125;</div><div class="line"><span class="number">39</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">40</span>: &#125;</div><div class="line"><span class="number">41</span>: </div><div class="line"><span class="number">42</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalancePushImpl.javaã€‘</span></div><div class="line"><span class="number">43</span>: <span class="comment">/**</span></div><div class="line">44:  * å»¶è¿Ÿè§£é” Broker æ¶ˆæ¯é˜Ÿåˆ—é”</div><div class="line">45:  * å½“æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸å­˜åœ¨æ¶ˆæ¯ï¼Œåˆ™ç›´æ¥è§£é”</div><div class="line">46:  *</div><div class="line">47:  * <span class="doctag">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line">48:  * <span class="doctag">@param</span> pq æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class="line">49:  * <span class="doctag">@return</span> æ˜¯å¦è§£é”æˆåŠŸ</div><div class="line">50:  */</div><div class="line"><span class="number">51</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">unlockDelay</span><span class="params">(<span class="keyword">final</span> MessageQueue mq, <span class="keyword">final</span> ProcessQueue pq)</span> </span>&#123;</div><div class="line"><span class="number">52</span>:     <span class="keyword">if</span> (pq.hasTempMessage()) &#123; <span class="comment">// TODO ç–‘é—®ï¼šä¸ºä»€ä¹ˆè¦å»¶è¿Ÿç§»é™¤</span></div><div class="line"><span class="number">53</span>:         log.info(<span class="string">"[&#123;&#125;]unlockDelay, begin &#123;&#125; "</span>, mq.hashCode(), mq);</div><div class="line"><span class="number">54</span>:         <span class="keyword">this</span>.defaultMQPushConsumerImpl.getmQClientFactory().getScheduledExecutorService().schedule(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"><span class="number">55</span>:             <span class="meta">@Override</span></div><div class="line"><span class="number">56</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">57</span>:                 log.info(<span class="string">"[&#123;&#125;]unlockDelay, execute at once &#123;&#125;"</span>, mq.hashCode(), mq);</div><div class="line"><span class="number">58</span>:                 RebalancePushImpl.<span class="keyword">this</span>.unlock(mq, <span class="keyword">true</span>);</div><div class="line"><span class="number">59</span>:             &#125;</div><div class="line"><span class="number">60</span>:         &#125;, UNLOCK_DELAY_TIME_MILLS, TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">61</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">62</span>:         <span class="keyword">this</span>.unlock(mq, <span class="keyword">true</span>);</div><div class="line"><span class="number">63</span>:     &#125;</div><div class="line"><span class="number">64</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">65</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>â¬†ï¸â¬†ï¸â¬†ï¸</li>
<li>ç¬¬ 20 è‡³ 32 è¡Œ ï¼šè·å–<strong>æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”</strong>ï¼Œé¿å…å’Œæ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹å†²çªã€‚å¦‚æœè·å–é”å¤±è´¥ï¼Œåˆ™ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—å¤±è´¥ï¼Œç­‰å¾…ä¸‹æ¬¡é‡æ–°åˆ†é…æ¶ˆè´¹é˜Ÿåˆ—æ—¶ï¼Œå†è¿›è¡Œç§»é™¤ã€‚å¦‚æœæœªè·å¾—é”è€Œè¿›è¡Œç§»é™¤ï¼Œåˆ™å¯èƒ½å‡ºç°å¦å¤–çš„  <code>Consumer</code> å’Œå½“å‰ <code>Consumer</code> åŒæ—¶æ¶ˆè´¹è¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯¼è‡´æ¶ˆæ¯æ— æ³•ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚</li>
<li>ç¬¬ 51 è‡³ 64 è¡Œ ï¼šè§£é” <code>Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚å¦‚æœæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å­˜åœ¨å‰©ä½™æ¶ˆæ¯ï¼Œåˆ™å»¶è¿Ÿè§£é” <code>Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚â“ä¸ºä»€ä¹ˆæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å­˜åœ¨å‰©ä½™æ¶ˆæ¯ä¸èƒ½ç›´æ¥è§£é”å‘¢ï¼ŸğŸ˜ˆæˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œç™¾æ€ä¸å¾—å…¶è§£ã€‚å¦‚æœæœ‰çŸ¥é“çš„åŒå­¦éº»çƒ¦æ•™è‚²ä¸‹ä¿ºã€‚</li>
</ul>
<h2>3.3 æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—</h2>
<p>ğŸ˜æœ¬èŠ‚ä¼šç±»æ¯”<strong>å¹¶å‘æ¶ˆè´¹æ¶ˆè´¹é˜Ÿåˆ—</strong>ï¼Œå»ºè®®å¯¹ç…§ <a href="http://www.yunai.me/RocketMQ/message-pull-and-consume-second/#6%E3%80%81PushConsumer-%E6%B6%88%E8%B4%B9%E6%B6%88%E6%81%AF">PushConsumerå¹¶å‘æ¶ˆè´¹æ¶ˆæ¯</a> ä¸€èµ·ç†è§£ã€‚</p>
<h3>3.1.1 æ¶ˆè´¹æ¶ˆæ¯</h3>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_13/01.png" alt="é¡ºåºæ¶ˆè´¹æ´»åŠ¨å›¾-æ¶ˆè´¹æ¶ˆæ¯"></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘</span></div><div class="line">  <span class="number">2</span>: <span class="class"><span class="keyword">class</span> <span class="title">ConsumeRequest</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">  <span class="number">3</span>: </div><div class="line">  <span class="number">4</span>:     <span class="comment">/**</span></div><div class="line">  5:      * æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class="line">  6:      */</div><div class="line">  <span class="number">7</span>:     <span class="keyword">private</span> <span class="keyword">final</span> ProcessQueue processQueue;</div><div class="line">  <span class="number">8</span>:     <span class="comment">/**</span></div><div class="line">  9:      * æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 10:      */</div><div class="line"> <span class="number">11</span>:     <span class="keyword">private</span> <span class="keyword">final</span> MessageQueue messageQueue;</div><div class="line"> <span class="number">12</span>: </div><div class="line"> <span class="number">13</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">14</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">15</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.processQueue.isDropped()) &#123;</div><div class="line"> <span class="number">16</span>:             log.warn(<span class="string">"run, the message queue not be able to consume, because it's dropped. &#123;&#125;"</span>, <span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">17</span>:             <span class="keyword">return</span>;</div><div class="line"> <span class="number">18</span>:         &#125;</div><div class="line"> <span class="number">19</span>: </div><div class="line"> <span class="number">20</span>:         <span class="comment">// è·å¾— Consumer æ¶ˆæ¯é˜Ÿåˆ—é”</span></div><div class="line"> <span class="number">21</span>:         <span class="keyword">final</span> Object objLock = messageQueueLock.fetchLockObject(<span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">22</span>:         <span class="keyword">synchronized</span> (objLock) &#123;</div><div class="line"> <span class="number">23</span>:             <span class="comment">// (å¹¿æ’­æ¨¡å¼) æˆ–è€… (é›†ç¾¤æ¨¡å¼ &amp;&amp; Brokeræ¶ˆæ¯é˜Ÿåˆ—é”æœ‰æ•ˆ)</span></div><div class="line"> <span class="number">24</span>:             <span class="keyword">if</span> (MessageModel.BROADCASTING.equals(ConsumeMessageOrderlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.messageModel())</div><div class="line"> <span class="number">25</span>:                 || (<span class="keyword">this</span>.processQueue.isLocked() &amp;&amp; !<span class="keyword">this</span>.processQueue.isLockExpired())) &#123;</div><div class="line"> <span class="number">26</span>:                 <span class="keyword">final</span> <span class="keyword">long</span> beginTime = System.currentTimeMillis();</div><div class="line"> <span class="number">27</span>:                 <span class="comment">// å¾ªç¯</span></div><div class="line"> <span class="number">28</span>:                 <span class="keyword">for</span> (<span class="keyword">boolean</span> continueConsume = <span class="keyword">true</span>; continueConsume; ) &#123;</div><div class="line"> <span class="number">29</span>:                     <span class="keyword">if</span> (<span class="keyword">this</span>.processQueue.isDropped()) &#123;</div><div class="line"> <span class="number">30</span>:                         log.warn(<span class="string">"the message queue not be able to consume, because it's dropped. &#123;&#125;"</span>, <span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">31</span>:                         <span class="keyword">break</span>;</div><div class="line"> <span class="number">32</span>:                     &#125;</div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:                     <span class="comment">// æ¶ˆæ¯é˜Ÿåˆ—åˆ†å¸ƒå¼é”æœªé”å®šï¼Œæäº¤å»¶è¿Ÿè·å¾—é”å¹¶æ¶ˆè´¹è¯·æ±‚</span></div><div class="line"> <span class="number">35</span>:                     <span class="keyword">if</span> (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.messageModel())</div><div class="line"> <span class="number">36</span>:                         &amp;&amp; !<span class="keyword">this</span>.processQueue.isLocked()) &#123;</div><div class="line"> <span class="number">37</span>:                         log.warn(<span class="string">"the message queue not locked, so consume later, &#123;&#125;"</span>, <span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">38</span>:                         ConsumeMessageOrderlyService.<span class="keyword">this</span>.tryLockLaterAndReconsume(<span class="keyword">this</span>.messageQueue, <span class="keyword">this</span>.processQueue, <span class="number">10</span>);</div><div class="line"> <span class="number">39</span>:                         <span class="keyword">break</span>;</div><div class="line"> <span class="number">40</span>:                     &#125;</div><div class="line"> <span class="number">41</span>:                     <span class="comment">// æ¶ˆæ¯é˜Ÿåˆ—åˆ†å¸ƒå¼é”å·²ç»è¿‡æœŸï¼Œæäº¤å»¶è¿Ÿè·å¾—é”å¹¶æ¶ˆè´¹è¯·æ±‚</span></div><div class="line"> <span class="number">42</span>:                     <span class="keyword">if</span> (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.messageModel())</div><div class="line"> <span class="number">43</span>:                         &amp;&amp; <span class="keyword">this</span>.processQueue.isLockExpired()) &#123;</div><div class="line"> <span class="number">44</span>:                         log.warn(<span class="string">"the message queue lock expired, so consume later, &#123;&#125;"</span>, <span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">45</span>:                         ConsumeMessageOrderlyService.<span class="keyword">this</span>.tryLockLaterAndReconsume(<span class="keyword">this</span>.messageQueue, <span class="keyword">this</span>.processQueue, <span class="number">10</span>);</div><div class="line"> <span class="number">46</span>:                         <span class="keyword">break</span>;</div><div class="line"> <span class="number">47</span>:                     &#125;</div><div class="line"> <span class="number">48</span>: </div><div class="line"> <span class="number">49</span>:                     <span class="comment">// å½“å‰å‘¨æœŸæ¶ˆè´¹æ—¶é—´è¶…è¿‡è¿ç»­æ—¶é•¿ï¼Œé»˜è®¤ï¼š60sï¼Œæäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯æ¶ˆè´¹1åˆ†é’Ÿä¼‘æ¯10msã€‚</span></div><div class="line"> <span class="number">50</span>:                     <span class="keyword">long</span> interval = System.currentTimeMillis() - beginTime;</div><div class="line"> <span class="number">51</span>:                     <span class="keyword">if</span> (interval &gt; MAX_TIME_CONSUME_CONTINUOUSLY) &#123;</div><div class="line"> <span class="number">52</span>:                         ConsumeMessageOrderlyService.<span class="keyword">this</span>.submitConsumeRequestLater(processQueue, messageQueue, <span class="number">10</span>);</div><div class="line"> <span class="number">53</span>:                         <span class="keyword">break</span>;</div><div class="line"> <span class="number">54</span>:                     &#125;</div><div class="line"> <span class="number">55</span>: </div><div class="line"> <span class="number">56</span>:                     <span class="comment">// è·å–æ¶ˆè´¹æ¶ˆæ¯ã€‚æ­¤å¤„å’Œå¹¶å‘æ¶ˆæ¯è¯·æ±‚ä¸åŒï¼Œå¹¶å‘æ¶ˆæ¯è¯·æ±‚å·²ç»å¸¦äº†æ¶ˆè´¹å“ªäº›æ¶ˆæ¯ã€‚</span></div><div class="line"> <span class="number">57</span>:                     <span class="keyword">final</span> <span class="keyword">int</span> consumeBatchSize = ConsumeMessageOrderlyService.<span class="keyword">this</span>.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();</div><div class="line"> <span class="number">58</span>:                     List&lt;MessageExt&gt; msgs = <span class="keyword">this</span>.processQueue.takeMessags(consumeBatchSize);</div><div class="line"> <span class="number">59</span>:                     <span class="keyword">if</span> (!msgs.isEmpty()) &#123;</div><div class="line"> <span class="number">60</span>:                         <span class="keyword">final</span> ConsumeOrderlyContext context = <span class="keyword">new</span> ConsumeOrderlyContext(<span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">61</span>: </div><div class="line"> <span class="number">62</span>:                         ConsumeOrderlyStatus status = <span class="keyword">null</span>;</div><div class="line"> <span class="number">63</span>: </div><div class="line"> <span class="number">64</span>:                         <span class="comment">// ....çœç•¥ä»£ç ï¼šHookï¼šbefore</span></div><div class="line"> <span class="number">65</span>: </div><div class="line"> <span class="number">66</span>:                         <span class="comment">// æ‰§è¡Œæ¶ˆè´¹</span></div><div class="line"> <span class="number">67</span>:                         <span class="keyword">long</span> beginTimestamp = System.currentTimeMillis();</div><div class="line"> <span class="number">68</span>:                         ConsumeReturnType returnType = ConsumeReturnType.SUCCESS;</div><div class="line"> <span class="number">69</span>:                         <span class="keyword">boolean</span> hasException = <span class="keyword">false</span>;</div><div class="line"> <span class="number">70</span>:                         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">71</span>:                             <span class="keyword">this</span>.processQueue.getLockConsume().lock(); <span class="comment">// é”å®šé˜Ÿåˆ—æ¶ˆè´¹é”</span></div><div class="line"> <span class="number">72</span>: </div><div class="line"> <span class="number">73</span>:                             <span class="keyword">if</span> (<span class="keyword">this</span>.processQueue.isDropped()) &#123;</div><div class="line"> <span class="number">74</span>:                                 log.warn(<span class="string">"consumeMessage, the message queue not be able to consume, because it's dropped. &#123;&#125;"</span>,</div><div class="line"> <span class="number">75</span>:                                     <span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">76</span>:                                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">77</span>:                             &#125;</div><div class="line"> <span class="number">78</span>: </div><div class="line"> <span class="number">79</span>:                             status = messageListener.consumeMessage(Collections.unmodifiableList(msgs), context);</div><div class="line"> <span class="number">80</span>:                         &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">81</span>:                             log.warn(<span class="string">"consumeMessage exception: &#123;&#125; Group: &#123;&#125; Msgs: &#123;&#125; MQ: &#123;&#125;"</span>, <span class="comment">//</span></div><div class="line"> <span class="number">82</span>:                                 RemotingHelper.exceptionSimpleDesc(e), <span class="comment">//</span></div><div class="line"> <span class="number">83</span>:                                 ConsumeMessageOrderlyService.<span class="keyword">this</span>.consumerGroup, <span class="comment">//</span></div><div class="line"> <span class="number">84</span>:                                 msgs, <span class="comment">//</span></div><div class="line"> <span class="number">85</span>:                                 messageQueue);</div><div class="line"> <span class="number">86</span>:                             hasException = <span class="keyword">true</span>;</div><div class="line"> <span class="number">87</span>:                         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"> <span class="number">88</span>:                             <span class="keyword">this</span>.processQueue.getLockConsume().unlock(); <span class="comment">// é”å®šé˜Ÿåˆ—æ¶ˆè´¹é”</span></div><div class="line"> <span class="number">89</span>:                         &#125;</div><div class="line"> <span class="number">90</span>: </div><div class="line"> <span class="number">91</span>:                         <span class="comment">// ....çœç•¥ä»£ç ï¼šè§£ææ¶ˆè´¹ç»“æœçŠ¶æ€</span></div><div class="line"> <span class="number">92</span>: </div><div class="line"> <span class="number">93</span>:                         <span class="comment">// ....çœç•¥ä»£ç ï¼šHookï¼šafter</span></div><div class="line"> <span class="number">94</span>: </div><div class="line"> <span class="number">95</span>:                         ConsumeMessageOrderlyService.<span class="keyword">this</span>.getConsumerStatsManager()</div><div class="line"> <span class="number">96</span>:                             .incConsumeRT(ConsumeMessageOrderlyService.<span class="keyword">this</span>.consumerGroup, messageQueue.getTopic(), consumeRT);</div><div class="line"> <span class="number">97</span>: </div><div class="line"> <span class="number">98</span>:                         <span class="comment">// å¤„ç†æ¶ˆè´¹ç»“æœ</span></div><div class="line"> <span class="number">99</span>:                         continueConsume = ConsumeMessageOrderlyService.<span class="keyword">this</span>.processConsumeResult(msgs, status, context, <span class="keyword">this</span>);</div><div class="line"><span class="number">100</span>:                     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">101</span>:                         continueConsume = <span class="keyword">false</span>;</div><div class="line"><span class="number">102</span>:                     &#125;</div><div class="line"><span class="number">103</span>:                 &#125;</div><div class="line"><span class="number">104</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">105</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.processQueue.isDropped()) &#123;</div><div class="line"><span class="number">106</span>:                     log.warn(<span class="string">"the message queue not be able to consume, because it's dropped. &#123;&#125;"</span>, <span class="keyword">this</span>.messageQueue);</div><div class="line"><span class="number">107</span>:                     <span class="keyword">return</span>;</div><div class="line"><span class="number">108</span>:                 &#125;</div><div class="line"><span class="number">109</span>: </div><div class="line"><span class="number">110</span>:                 ConsumeMessageOrderlyService.<span class="keyword">this</span>.tryLockLaterAndReconsume(<span class="keyword">this</span>.messageQueue, <span class="keyword">this</span>.processQueue, <span class="number">100</span>);</div><div class="line"><span class="number">111</span>:             &#125;</div><div class="line"><span class="number">112</span>:         &#125;</div><div class="line"><span class="number">113</span>:     &#125;</div><div class="line"><span class="number">114</span>: </div><div class="line"><span class="number">115</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>â¬†ï¸â¬†ï¸â¬†ï¸</li>
<li>ç¬¬ 20 è¡Œ ï¼šè·å¾— <code>Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚</li>
<li>ç¬¬ 58 è¡Œ ï¼šä»æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—é¡ºåºè·å¾—æ¶ˆæ¯ã€‚<strong>å’Œå¹¶å‘æ¶ˆè´¹è·å¾—æ¶ˆæ¯ä¸åŒã€‚å¹¶å‘æ¶ˆè´¹è¯·æ±‚åœ¨è¯·æ±‚åˆ›å»ºæ—¶ï¼Œå·²ç»è®¾ç½®å¥½æ¶ˆè´¹å“ªäº›æ¶ˆæ¯ã€‚</strong></li>
<li>ç¬¬ 71 è¡Œ ï¼šè·å¾— <code>Consumer</code> æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ¶ˆè´¹é”ã€‚ç›¸æ¯”ã€<code>Consumer</code>æ¶ˆæ¯é˜Ÿåˆ—é”ã€‘ï¼Œå…¶ç²’åº¦è¾ƒå°ã€‚è¿™å°±æ˜¯ä¸Šæ–‡æåˆ°çš„â“<strong>ä¸ºä»€ä¹ˆæœ‰<code>Consumer</code>æ¶ˆæ¯é˜Ÿåˆ—é”è¿˜éœ€è¦æœ‰ Consumer æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”å‘¢</strong>çš„åŸå› ã€‚</li>
<li>ç¬¬ 79 è¡Œ ï¼š<strong>æ‰§è¡Œæ¶ˆè´¹</strong>ã€‚</li>
<li>ç¬¬ 99 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚</li>
</ul>
<h3>3.1.2 å¤„ç†æ¶ˆè´¹ç»“æœ</h3>
<p>é¡ºåºæ¶ˆè´¹æ¶ˆæ¯ç»“æœ (<code>ConsumeOrderlyStatus</code>) æœ‰å››ç§æƒ…å†µï¼š</p>
<ul>
<li><code>SUCCESS</code> ï¼šæ¶ˆè´¹æˆåŠŸ<strong>ä½†ä¸æäº¤</strong>ã€‚</li>
<li><code>ROLLBACK</code> ï¼šæ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆè´¹å›æ»šã€‚</li>
<li><code>COMMIT</code> ï¼šæ¶ˆè´¹æˆåŠŸæäº¤å¹¶ä¸”æäº¤ã€‚</li>
<li><code>SUSPEND_CURRENT_QUEUE_A_MOMENT</code> ï¼šæ¶ˆè´¹å¤±è´¥ï¼ŒæŒ‚èµ·æ¶ˆè´¹é˜Ÿåˆ—ä¸€ä¼šä¼šï¼Œç¨åç»§ç»­æ¶ˆè´¹ã€‚</li>
</ul>
<p>è€ƒè™‘åˆ° <code>ROLLBACK</code> ã€<code>COMMIT</code> æš‚æ—¶åªä½¿ç”¨åœ¨ <code>MySQL binlog</code> åœºæ™¯ï¼Œå®˜æ–¹å°†è¿™ä¸¤çŠ¶æ€æ ‡è®°ä¸º <code>@Deprecated</code>ã€‚å½“ç„¶ï¼Œç›¸åº”çš„å®ç°é€»è¾‘ä¾ç„¶ä¿ç•™ã€‚</p>
<p>åœ¨<strong>å¹¶å‘æ¶ˆè´¹</strong>åœºæ™¯æ—¶ï¼Œå¦‚æœæ¶ˆè´¹å¤±è´¥ï¼Œ<code>Consumer</code> ä¼šå°†æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯å‘å›åˆ° <code>Broker</code> é‡è¯•é˜Ÿåˆ—ï¼Œè·³è¿‡å½“å‰æ¶ˆæ¯ï¼Œç­‰å¾…ä¸‹æ¬¡æ‹‰å–è¯¥æ¶ˆæ¯å†è¿›è¡Œæ¶ˆè´¹ã€‚</p>
<p>ä½†æ˜¯åœ¨<strong>å®Œå…¨ä¸¥æ ¼é¡ºåºæ¶ˆè´¹</strong>æ¶ˆè´¹æ—¶ï¼Œè¿™æ ·åšæ˜¾ç„¶ä¸è¡Œã€‚ä¹Ÿå› æ­¤ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ï¼Œä¼šæŒ‚èµ·é˜Ÿåˆ—ä¸€ä¼šä¼šï¼Œç¨åç»§ç»­æ¶ˆè´¹ã€‚</p>
<p>ä¸è¿‡æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ä¸€ç›´å¤±è´¥ï¼Œä¹Ÿä¸å¯èƒ½ä¸€ç›´æ¶ˆè´¹ã€‚å½“è¶…è¿‡æ¶ˆè´¹é‡è¯•ä¸Šé™æ—¶ï¼Œ<code>Consumer</code> ä¼šå°†æ¶ˆè´¹å¤±è´¥è¶…è¿‡ä¸Šé™çš„æ¶ˆæ¯å‘å›åˆ° <code>Broker</code> æ­»ä¿¡é˜Ÿåˆ—ã€‚</p>
<p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹ä»£ç ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘</span></div><div class="line">  <span class="number">2</span>: <span class="comment">/**</span></div><div class="line">  3:  * å¤„ç†æ¶ˆè´¹ç»“æœï¼Œå¹¶è¿”å›æ˜¯å¦ç»§ç»­æ¶ˆè´¹</div><div class="line">  4:  *</div><div class="line">  5:  * <span class="doctag">@param</span> msgs æ¶ˆæ¯</div><div class="line">  6:  * <span class="doctag">@param</span> status æ¶ˆè´¹ç»“æœçŠ¶æ€</div><div class="line">  7:  * <span class="doctag">@param</span> context æ¶ˆè´¹Context</div><div class="line">  8:  * <span class="doctag">@param</span> consumeRequest æ¶ˆè´¹è¯·æ±‚</div><div class="line">  9:  * <span class="doctag">@return</span> æ˜¯å¦ç»§ç»­æ¶ˆè´¹</div><div class="line"> 10:  */</div><div class="line"> <span class="number">11</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">processConsumeResult</span><span class="params">(//</span></span></div><div class="line"> <span class="number">12</span>:     <span class="keyword">final</span> List&lt;MessageExt&gt; msgs, //</div><div class="line"> <span class="number">13</span>:     <span class="keyword">final</span> ConsumeOrderlyStatus status, //</div><div class="line"> <span class="number">14</span>:     <span class="keyword">final</span> ConsumeOrderlyContext context, //</div><div class="line"> <span class="number">15</span>:     <span class="keyword">final</span> ConsumeRequest consumeRequest//</div><div class="line"> <span class="number">16</span>: ) &#123;</div><div class="line"> <span class="number">17</span>:     <span class="keyword">boolean</span> continueConsume = <span class="keyword">true</span>;</div><div class="line"> <span class="number">18</span>:     <span class="keyword">long</span> commitOffset = -<span class="number">1L</span>;</div><div class="line"> <span class="number">19</span>:     <span class="keyword">if</span> (context.isAutoCommit()) &#123;</div><div class="line"> <span class="number">20</span>:         <span class="keyword">switch</span> (status) &#123;</div><div class="line"> <span class="number">21</span>:             <span class="keyword">case</span> COMMIT:</div><div class="line"> <span class="number">22</span>:             <span class="keyword">case</span> ROLLBACK:</div><div class="line"> <span class="number">23</span>:                 log.warn(<span class="string">"the message queue consume result is illegal, we think you want to ack these message &#123;&#125;"</span>, consumeRequest.getMessageQueue());</div><div class="line"> <span class="number">24</span>:             <span class="keyword">case</span> SUCCESS:</div><div class="line"> <span class="number">25</span>:                 <span class="comment">// æäº¤æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸåˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</span></div><div class="line"> <span class="number">26</span>:                 commitOffset = consumeRequest.getProcessQueue().commit();</div><div class="line"> <span class="number">27</span>:                 <span class="comment">// ç»Ÿè®¡</span></div><div class="line"> <span class="number">28</span>:                 <span class="keyword">this</span>.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class="line"> <span class="number">29</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">30</span>:             <span class="keyword">case</span> SUSPEND_CURRENT_QUEUE_A_MOMENT:</div><div class="line"> <span class="number">31</span>:                 <span class="comment">// ç»Ÿè®¡</span></div><div class="line"> <span class="number">32</span>:                 <span class="keyword">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class="line"> <span class="number">33</span>:                 <span class="keyword">if</span> (checkReconsumeTimes(msgs)) &#123; <span class="comment">// è®¡ç®—æ˜¯å¦æš‚æ—¶æŒ‚èµ·ï¼ˆæš‚åœï¼‰æ¶ˆè´¹Næ¯«ç§’ï¼Œé»˜è®¤ï¼š10ms</span></div><div class="line"> <span class="number">34</span>:                     <span class="comment">// è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹</span></div><div class="line"> <span class="number">35</span>:                     consumeRequest.getProcessQueue().makeMessageToCosumeAgain(msgs);</div><div class="line"> <span class="number">36</span>:                     <span class="comment">// æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚</span></div><div class="line"> <span class="number">37</span>:                     <span class="keyword">this</span>.submitConsumeRequestLater(<span class="comment">//</span></div><div class="line"> <span class="number">38</span>:                         consumeRequest.getProcessQueue(), <span class="comment">//</span></div><div class="line"> <span class="number">39</span>:                         consumeRequest.getMessageQueue(), <span class="comment">//</span></div><div class="line"> <span class="number">40</span>:                         context.getSuspendCurrentQueueTimeMillis());</div><div class="line"> <span class="number">41</span>:                     continueConsume = <span class="keyword">false</span>;</div><div class="line"> <span class="number">42</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">43</span>:                     commitOffset = consumeRequest.getProcessQueue().commit();</div><div class="line"> <span class="number">44</span>:                 &#125;</div><div class="line"> <span class="number">45</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">46</span>:             <span class="keyword">default</span>:</div><div class="line"> <span class="number">47</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">48</span>:         &#125;</div><div class="line"> <span class="number">49</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">50</span>:         <span class="keyword">switch</span> (status) &#123;</div><div class="line"> <span class="number">51</span>:             <span class="keyword">case</span> SUCCESS:</div><div class="line"> <span class="number">52</span>:                 <span class="keyword">this</span>.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class="line"> <span class="number">53</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">54</span>:             <span class="keyword">case</span> COMMIT:</div><div class="line"> <span class="number">55</span>:                 <span class="comment">// æäº¤æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸåˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</span></div><div class="line"> <span class="number">56</span>:                 commitOffset = consumeRequest.getProcessQueue().commit();</div><div class="line"> <span class="number">57</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">58</span>:             <span class="keyword">case</span> ROLLBACK:</div><div class="line"> <span class="number">59</span>:                 <span class="comment">// è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹</span></div><div class="line"> <span class="number">60</span>:                 consumeRequest.getProcessQueue().rollback();</div><div class="line"> <span class="number">61</span>:                 <span class="keyword">this</span>.submitConsumeRequestLater(<span class="comment">//</span></div><div class="line"> <span class="number">62</span>:                     consumeRequest.getProcessQueue(), <span class="comment">//</span></div><div class="line"> <span class="number">63</span>:                     consumeRequest.getMessageQueue(), <span class="comment">//</span></div><div class="line"> <span class="number">64</span>:                     context.getSuspendCurrentQueueTimeMillis());</div><div class="line"> <span class="number">65</span>:                 continueConsume = <span class="keyword">false</span>;</div><div class="line"> <span class="number">66</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">67</span>:             <span class="keyword">case</span> SUSPEND_CURRENT_QUEUE_A_MOMENT: <span class="comment">// è®¡ç®—æ˜¯å¦æš‚æ—¶æŒ‚èµ·ï¼ˆæš‚åœï¼‰æ¶ˆè´¹Næ¯«ç§’ï¼Œé»˜è®¤ï¼š10ms</span></div><div class="line"> <span class="number">68</span>:                 <span class="keyword">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class="line"> <span class="number">69</span>:                 <span class="keyword">if</span> (checkReconsumeTimes(msgs)) &#123;</div><div class="line"> <span class="number">70</span>:                     <span class="comment">// è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹</span></div><div class="line"> <span class="number">71</span>:                     consumeRequest.getProcessQueue().makeMessageToCosumeAgain(msgs);</div><div class="line"> <span class="number">72</span>:                     <span class="comment">// æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚</span></div><div class="line"> <span class="number">73</span>:                     <span class="keyword">this</span>.submitConsumeRequestLater(<span class="comment">//</span></div><div class="line"> <span class="number">74</span>:                         consumeRequest.getProcessQueue(), <span class="comment">//</span></div><div class="line"> <span class="number">75</span>:                         consumeRequest.getMessageQueue(), <span class="comment">//</span></div><div class="line"> <span class="number">76</span>:                         context.getSuspendCurrentQueueTimeMillis());</div><div class="line"> <span class="number">77</span>:                     continueConsume = <span class="keyword">false</span>;</div><div class="line"> <span class="number">78</span>:                 &#125;</div><div class="line"> <span class="number">79</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">80</span>:             <span class="keyword">default</span>:</div><div class="line"> <span class="number">81</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">82</span>:         &#125;</div><div class="line"> <span class="number">83</span>:     &#125;</div><div class="line"> <span class="number">84</span>: </div><div class="line"> <span class="number">85</span>:     <span class="comment">// æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æœªdroppedï¼Œæäº¤æœ‰æ•ˆæ¶ˆè´¹è¿›åº¦</span></div><div class="line"> <span class="number">86</span>:     <span class="keyword">if</span> (commitOffset &gt;= <span class="number">0</span> &amp;&amp; !consumeRequest.getProcessQueue().isDropped()) &#123;</div><div class="line"> <span class="number">87</span>:         <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(consumeRequest.getMessageQueue(), commitOffset, <span class="keyword">false</span>);</div><div class="line"> <span class="number">88</span>:     &#125;</div><div class="line"> <span class="number">89</span>: </div><div class="line"> <span class="number">90</span>:     <span class="keyword">return</span> continueConsume;</div><div class="line"> <span class="number">91</span>: &#125;</div><div class="line"> <span class="number">92</span>: </div><div class="line"> <span class="number">93</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getMaxReconsumeTimes</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">94</span>:     <span class="comment">// default reconsume times: Integer.MAX_VALUE</span></div><div class="line"> <span class="number">95</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.defaultMQPushConsumer.getMaxReconsumeTimes() == -<span class="number">1</span>) &#123;</div><div class="line"> <span class="number">96</span>:         <span class="keyword">return</span> Integer.MAX_VALUE;</div><div class="line"> <span class="number">97</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">98</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.defaultMQPushConsumer.getMaxReconsumeTimes();</div><div class="line"> <span class="number">99</span>:     &#125;</div><div class="line"><span class="number">100</span>: &#125;</div><div class="line"><span class="number">101</span>: </div><div class="line"><span class="number">102</span>: <span class="comment">/**</span></div><div class="line">103:  * è®¡ç®—æ˜¯å¦è¦æš‚åœæ¶ˆè´¹</div><div class="line">104:  * ä¸æš‚åœæ¡ä»¶ï¼šå­˜åœ¨æ¶ˆæ¯éƒ½è¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°å¹¶ä¸”éƒ½å‘å›brokeræˆåŠŸ</div><div class="line">105:  *</div><div class="line">106:  * <span class="doctag">@param</span> msgs æ¶ˆæ¯</div><div class="line">107:  * <span class="doctag">@return</span> æ˜¯å¦è¦æš‚åœ</div><div class="line">108:  */</div><div class="line"><span class="number">109</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkReconsumeTimes</span><span class="params">(List&lt;MessageExt&gt; msgs)</span> </span>&#123;</div><div class="line"><span class="number">110</span>:     <span class="keyword">boolean</span> suspend = <span class="keyword">false</span>;</div><div class="line"><span class="number">111</span>:     <span class="keyword">if</span> (msgs != <span class="keyword">null</span> &amp;&amp; !msgs.isEmpty()) &#123;</div><div class="line"><span class="number">112</span>:         <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</div><div class="line"><span class="number">113</span>:             <span class="keyword">if</span> (msg.getReconsumeTimes() &gt;= getMaxReconsumeTimes()) &#123;</div><div class="line"><span class="number">114</span>:                 MessageAccessor.setReconsumeTime(msg, String.valueOf(msg.getReconsumeTimes()));</div><div class="line"><span class="number">115</span>:                 <span class="keyword">if</span> (!sendMessageBack(msg)) &#123; <span class="comment">// å‘å›å¤±è´¥ï¼Œä¸­æ–­</span></div><div class="line"><span class="number">116</span>:                     suspend = <span class="keyword">true</span>;</div><div class="line"><span class="number">117</span>:                     msg.setReconsumeTimes(msg.getReconsumeTimes() + <span class="number">1</span>);</div><div class="line"><span class="number">118</span>:                 &#125;</div><div class="line"><span class="number">119</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">120</span>:                 suspend = <span class="keyword">true</span>;</div><div class="line"><span class="number">121</span>:                 msg.setReconsumeTimes(msg.getReconsumeTimes() + <span class="number">1</span>);</div><div class="line"><span class="number">122</span>:             &#125;</div><div class="line"><span class="number">123</span>:         &#125;</div><div class="line"><span class="number">124</span>:     &#125;</div><div class="line"><span class="number">125</span>:     <span class="keyword">return</span> suspend;</div><div class="line"><span class="number">126</span>: &#125;</div><div class="line"><span class="number">127</span>: </div><div class="line"><span class="number">128</span>: <span class="comment">/**</span></div><div class="line">129:  * å‘å›æ¶ˆæ¯ã€‚</div><div class="line">130:  * æ¶ˆæ¯å‘å›brokeråï¼Œå¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ­»ä¿¡é˜Ÿåˆ—ã€‚</div><div class="line">131:  *</div><div class="line">132:  * <span class="doctag">@param</span> msg æ¶ˆæ¯</div><div class="line">133:  * <span class="doctag">@return</span> æ˜¯å¦å‘é€æˆåŠŸ</div><div class="line">134:  */</div><div class="line"><span class="number">135</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sendMessageBack</span><span class="params">(<span class="keyword">final</span> MessageExt msg)</span> </span>&#123;</div><div class="line"><span class="number">136</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">137</span>:         <span class="comment">// max reconsume times exceeded then send to dead letter queue.</span></div><div class="line"><span class="number">138</span>:         Message newMsg = <span class="keyword">new</span> Message(MixAll.getRetryTopic(<span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup()), msg.getBody());</div><div class="line"><span class="number">139</span>:         String originMsgId = MessageAccessor.getOriginMessageId(msg);</div><div class="line"><span class="number">140</span>:         MessageAccessor.setOriginMessageId(newMsg, UtilAll.isBlank(originMsgId) ? msg.getMsgId() : originMsgId);</div><div class="line"><span class="number">141</span>:         newMsg.setFlag(msg.getFlag());</div><div class="line"><span class="number">142</span>:         MessageAccessor.setProperties(newMsg, msg.getProperties());</div><div class="line"><span class="number">143</span>:         MessageAccessor.putProperty(newMsg, MessageConst.PROPERTY_RETRY_TOPIC, msg.getTopic());</div><div class="line"><span class="number">144</span>:         MessageAccessor.setReconsumeTime(newMsg, String.valueOf(msg.getReconsumeTimes()));</div><div class="line"><span class="number">145</span>:         MessageAccessor.setMaxReconsumeTimes(newMsg, String.valueOf(getMaxReconsumeTimes()));</div><div class="line"><span class="number">146</span>:         newMsg.setDelayTimeLevel(<span class="number">3</span> + msg.getReconsumeTimes());</div><div class="line"><span class="number">147</span>: </div><div class="line"><span class="number">148</span>:         <span class="keyword">this</span>.defaultMQPushConsumer.getDefaultMQPushConsumerImpl().getmQClientFactory().getDefaultMQProducer().send(newMsg);</div><div class="line"><span class="number">149</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">150</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">151</span>:         log.error(<span class="string">"sendMessageBack exception, group: "</span> + <span class="keyword">this</span>.consumerGroup + <span class="string">" msg: "</span> + msg.toString(), e);</div><div class="line"><span class="number">152</span>:     &#125;</div><div class="line"><span class="number">153</span>: </div><div class="line"><span class="number">154</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">155</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>â¬†ï¸â¬†ï¸â¬†ï¸</li>
<li>ç¬¬ 21 è‡³ 29 è¡Œ ï¼šæ¶ˆè´¹æˆåŠŸã€‚åœ¨è‡ªåŠ¨æäº¤è¿›åº¦( <code>AutoCommit</code> )çš„æƒ…å†µä¸‹ï¼Œ<code>COMMIT</code>ã€<code>ROLLBACK</code>ã€<code>SUCCESS</code> é€»è¾‘<strong>å·²ç»ç»Ÿä¸€</strong>ã€‚</li>
<li>ç¬¬ 30 è‡³ 45 è¡Œ ï¼šæ¶ˆè´¹å¤±è´¥ã€‚å½“æ¶ˆæ¯é‡è¯•æ¬¡æ•°è¶…è¿‡ä¸Šé™ï¼ˆé»˜è®¤ ï¼š16æ¬¡ï¼‰æ—¶ï¼Œå°†æ¶ˆæ¯å‘é€åˆ° <code>Broker</code> æ­»ä¿¡é˜Ÿåˆ—ï¼Œè·³è¿‡è¿™äº›æ¶ˆæ¯ã€‚æ­¤æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—æ— éœ€æŒ‚èµ·ï¼Œç»§ç»­æ¶ˆè´¹åé¢çš„æ¶ˆæ¯ã€‚</li>
<li>ç¬¬ 85 è‡³ 88 è¡Œ ï¼šæäº¤æ¶ˆè´¹è¿›åº¦ã€‚</li>
</ul>
<h3>3.13 æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•</h3>
<p>ğŸ˜ˆæ¶‰åŠåˆ°çš„å››ä¸ªæ ¸å¿ƒæ–¹æ³•çš„æºç ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ProcessQueue.javaã€‘</span></div><div class="line">  <span class="number">2</span>: <span class="comment">/**</span></div><div class="line">  3:  * æ¶ˆæ¯æ˜ å°„</div><div class="line">  4:  * keyï¼šæ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</div><div class="line">  5:  */</div><div class="line">  <span class="number">6</span>: <span class="keyword">private</span> <span class="keyword">final</span> TreeMap&lt;Long, MessageExt&gt; msgTreeMap = <span class="keyword">new</span> TreeMap&lt;&gt;();    <span class="comment">/**</span></div><div class="line">  7:  * æ¶ˆæ¯æ˜ å°„ä¸´æ—¶å­˜å‚¨ï¼ˆæ¶ˆè´¹ä¸­çš„æ¶ˆæ¯ï¼‰</div><div class="line">  8:  */</div><div class="line">  <span class="number">9</span>: <span class="keyword">private</span> <span class="keyword">final</span> TreeMap&lt;Long, MessageExt&gt; msgTreeMapTemp = <span class="keyword">new</span> TreeMap&lt;&gt;();</div><div class="line"> <span class="number">10</span>: </div><div class="line"> <span class="number">11</span>: <span class="comment">/**</span></div><div class="line"> 12:  * å›æ»šæ¶ˆè´¹ä¸­çš„æ¶ˆæ¯</div><div class="line"> 13:  * é€»è¾‘ç±»ä¼¼äº&#123;<span class="doctag">@link</span> #makeMessageToCosumeAgain(List)&#125;</div><div class="line"> 14:  */</div><div class="line"> <span class="number">15</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">16</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">17</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"> <span class="number">18</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">19</span>:             <span class="keyword">this</span>.msgTreeMap.putAll(<span class="keyword">this</span>.msgTreeMapTemp);</div><div class="line"> <span class="number">20</span>:             <span class="keyword">this</span>.msgTreeMapTemp.clear();</div><div class="line"> <span class="number">21</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"> <span class="number">22</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"> <span class="number">23</span>:         &#125;</div><div class="line"> <span class="number">24</span>:     &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"> <span class="number">25</span>:         log.error(<span class="string">"rollback exception"</span>, e);</div><div class="line"> <span class="number">26</span>:     &#125;</div><div class="line"> <span class="number">27</span>: &#125;</div><div class="line"> <span class="number">28</span>: </div><div class="line"> <span class="number">29</span>: <span class="comment">/**</span></div><div class="line"> 30:  * æäº¤æ¶ˆè´¹ä¸­çš„æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸï¼Œè¿”å›æ¶ˆè´¹è¿›åº¦</div><div class="line"> 31:  *</div><div class="line"> 32:  * <span class="doctag">@return</span> æ¶ˆè´¹è¿›åº¦</div><div class="line"> 33:  */</div><div class="line"> <span class="number">34</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">commit</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">35</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">36</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"> <span class="number">37</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">38</span>:             <span class="comment">// æ¶ˆè´¹è¿›åº¦</span></div><div class="line"> <span class="number">39</span>:             Long offset = <span class="keyword">this</span>.msgTreeMapTemp.lastKey();</div><div class="line"> <span class="number">40</span>: </div><div class="line"> <span class="number">41</span>:             <span class="comment">//</span></div><div class="line"> <span class="number">42</span>:             msgCount.addAndGet(<span class="keyword">this</span>.msgTreeMapTemp.size() * (-<span class="number">1</span>));</div><div class="line"> <span class="number">43</span>: </div><div class="line"> <span class="number">44</span>:             <span class="comment">//</span></div><div class="line"> <span class="number">45</span>:             <span class="keyword">this</span>.msgTreeMapTemp.clear();</div><div class="line"> <span class="number">46</span>: </div><div class="line"> <span class="number">47</span>:             <span class="comment">// è¿”å›æ¶ˆè´¹è¿›åº¦</span></div><div class="line"> <span class="number">48</span>:             <span class="keyword">if</span> (offset != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">49</span>:                 <span class="keyword">return</span> offset + <span class="number">1</span>;</div><div class="line"> <span class="number">50</span>:             &#125;</div><div class="line"> <span class="number">51</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"> <span class="number">52</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"> <span class="number">53</span>:         &#125;</div><div class="line"> <span class="number">54</span>:     &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"> <span class="number">55</span>:         log.error(<span class="string">"commit exception"</span>, e);</div><div class="line"> <span class="number">56</span>:     &#125;</div><div class="line"> <span class="number">57</span>: </div><div class="line"> <span class="number">58</span>:     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"> <span class="number">59</span>: &#125;</div><div class="line"> <span class="number">60</span>: </div><div class="line"> <span class="number">61</span>: <span class="comment">/**</span></div><div class="line"> 62:  * æŒ‡å®šæ¶ˆæ¯é‡æ–°æ¶ˆè´¹</div><div class="line"> 63:  * é€»è¾‘ç±»ä¼¼äº&#123;<span class="doctag">@link</span> #rollback()&#125;</div><div class="line"> 64:  *</div><div class="line"> 65:  * <span class="doctag">@param</span> msgs æ¶ˆæ¯</div><div class="line"> 66:  */</div><div class="line"> <span class="number">67</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makeMessageToCosumeAgain</span><span class="params">(List&lt;MessageExt&gt; msgs)</span> </span>&#123;</div><div class="line"> <span class="number">68</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">69</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"> <span class="number">70</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">71</span>:             <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</div><div class="line"> <span class="number">72</span>:                 <span class="keyword">this</span>.msgTreeMapTemp.remove(msg.getQueueOffset());</div><div class="line"> <span class="number">73</span>:                 <span class="keyword">this</span>.msgTreeMap.put(msg.getQueueOffset(), msg);</div><div class="line"> <span class="number">74</span>:             &#125;</div><div class="line"> <span class="number">75</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"> <span class="number">76</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"> <span class="number">77</span>:         &#125;</div><div class="line"> <span class="number">78</span>:     &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"> <span class="number">79</span>:         log.error(<span class="string">"makeMessageToCosumeAgain exception"</span>, e);</div><div class="line"> <span class="number">80</span>:     &#125;</div><div class="line"> <span class="number">81</span>: &#125;</div><div class="line"> <span class="number">82</span>: </div><div class="line"> <span class="number">83</span>: <span class="comment">/**</span></div><div class="line"> 84:  * è·å¾—æŒæœ‰æ¶ˆæ¯å‰Næ¡</div><div class="line"> 85:  *</div><div class="line"> 86:  * <span class="doctag">@param</span> batchSize æ¡æ•°</div><div class="line"> 87:  * <span class="doctag">@return</span> æ¶ˆæ¯</div><div class="line"> 88:  */</div><div class="line"> <span class="number">89</span>: <span class="function"><span class="keyword">public</span> List&lt;MessageExt&gt; <span class="title">takeMessags</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> batchSize)</span> </span>&#123;</div><div class="line"> <span class="number">90</span>:     List&lt;MessageExt&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(batchSize);</div><div class="line"> <span class="number">91</span>:     <span class="keyword">final</span> <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"> <span class="number">92</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">93</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"> <span class="number">94</span>:         <span class="keyword">this</span>.lastConsumeTimestamp = now;</div><div class="line"> <span class="number">95</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">96</span>:             <span class="keyword">if</span> (!<span class="keyword">this</span>.msgTreeMap.isEmpty()) &#123;</div><div class="line"> <span class="number">97</span>:                 <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; batchSize; i++) &#123;</div><div class="line"> <span class="number">98</span>:                     Map.Entry&lt;Long, MessageExt&gt; entry = <span class="keyword">this</span>.msgTreeMap.pollFirstEntry();</div><div class="line"> <span class="number">99</span>:                     <span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">100</span>:                         result.add(entry.getValue());</div><div class="line"><span class="number">101</span>:                         msgTreeMapTemp.put(entry.getKey(), entry.getValue());</div><div class="line"><span class="number">102</span>:                     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">103</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">104</span>:                     &#125;</div><div class="line"><span class="number">105</span>:                 &#125;</div><div class="line"><span class="number">106</span>:             &#125;</div><div class="line"><span class="number">107</span>: </div><div class="line"><span class="number">108</span>:             <span class="keyword">if</span> (result.isEmpty()) &#123;</div><div class="line"><span class="number">109</span>:                 consuming = <span class="keyword">false</span>;</div><div class="line"><span class="number">110</span>:             &#125;</div><div class="line"><span class="number">111</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">112</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"><span class="number">113</span>:         &#125;</div><div class="line"><span class="number">114</span>:     &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"><span class="number">115</span>:         log.error(<span class="string">"take Messages exception"</span>, e);</div><div class="line"><span class="number">116</span>:     &#125;</div><div class="line"><span class="number">117</span>: </div><div class="line"><span class="number">118</span>:     <span class="keyword">return</span> result;</div><div class="line"><span class="number">119</span>: &#125;</div></pre></td></tr></table></figure></p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">2.</span> <span class="toc-text">2. Producer é¡ºåºå‘é€</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">3.</span> <span class="toc-text">3. Consumer ä¸¥æ ¼é¡ºåºæ¶ˆè´¹</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 è·å¾—(é”å®š)æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.3.1.</span> <span class="toc-text">3.1.1 æ¶ˆè´¹æ¶ˆæ¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.3.2.</span> <span class="toc-text">3.1.2 å¤„ç†æ¶ˆè´¹ç»“æœ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.3.3.</span> <span class="toc-text">3.13 æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&text=RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&is_video=false&description=RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹&body=Check out this article: http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&name=RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$(" #toc-footer").toggle();return="" false;"=""><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$(" #share-footer").toggle();return="" false;"=""><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$(" #nav-footer").toggle();return="" false;"=""><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 ç‹æ–‡æ–Œ
  </div>

  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
          <li>
              Hosted by <a href="https://pages.coding.me" style="font-weight: bold" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a>
          </li>
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

<!-- Disqus Comments -->


<!--page counter part-->
<script>
    function addCount(Counter) {
        // TODO å¾…ä¼˜åŒ–ï¼šè¿‡æ»¤ çˆ¬è™«
        url = $('#actions .icon').attr('href').trim(); // æ–‡ç« url
//        alert(url);
        title = $('.posttitle').text().trim(); // æ–‡ç« æ ‡é¢˜
        var query = new AV.Query(Counter);
        //use url as unique idnetfication
        query.equalTo("url", url);
        query.find({
            success: function (results) {
                if (results.length > 0) {
                    var counter = results[0];
                    counter.fetchWhenSave(true); //get recent result
                    counter.increment("time");
                    counter.save();
                    // æ’å…¥æ¬¡æ•°
                    $('.postdate').append('&nbsp;' + (counter.get('time') + 1) + '  Views');
                } else {
                    var newcounter = new Counter();
                    newcounter.set("title", title);
                    newcounter.set("url", url);
                    newcounter.set("time", 1);
                    newcounter.save(null, {
                        success: function (newcounter) {
                            // æ’å…¥æ¬¡æ•°
                            $('.postdate').append('&nbsp;1  Views');
                        },
                        error: function (newcounter, error) {
                        }
                    });
                }
            },
            error: function (error) {
            }
        });
    }

    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(c_name + "=")
            if (c_start != -1) {
                c_start = c_start + c_name.length + 1
                c_end = document.cookie.indexOf(";", c_start)
                if (c_end == -1) c_end = document.cookie.length
                return unescape(document.cookie.substring(c_start, c_end))
            }
        }
        return ""
    }

    function setCookie(c_name, value, expiredays) {
        var exdate = new Date()
        exdate.setDate(exdate.getDate() + expiredays)
        document.cookie = c_name + "=" + escape(value) +
            ((expiredays == null) ? "" : ";expires=" + exdate.toGMTString())
    }

    function addVisitLog() {
        // è·å–uid
        var visitorId = getCookie('blog_visitor_id');
        if (visitorId.length != 36) {
            visitorId = uuid();
            setCookie('blog_visitor_id', visitorId);
        }
        // ip æµè§ˆå™¨æ— æ³•è·å–
        // time æœåŠ¡ç«¯å·²ç»è®°å½•
        var url = location.href;
        var ua = navigator.userAgent;
        var referer = document.referrer;
        var Log = AV.Object.extend("VisitLog");
        var log = new Log();
        log.set('url', url);
        log.set('ua', ua);
        log.set('referer', referer);
        log.set('visitorId', visitorId);
        log.save();
    }

    function uuid() {
        var s = [];
        var hexDigits = "0123456789abcdef";
        for (var i = 0; i < 36; i++) {
            s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
        }
        s[14] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
        s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
        s[8] = s[13] = s[18] = s[23] = "-";

        var uuid = s.join("");
        return uuid;
    }

    // TODO å¾…ä¼˜åŒ–ï¼šæ­¤å¤„æ€§èƒ½è¾ƒå·®ï¼Œå¯èƒ½
    function countVisitLog() {
        var Log = AV.Object.extend("VisitLog");
        var query = new AV.Query(Log);
        query.count({
            success: function (results) {
                $('.footer-left').append('&nbsp;' + results + '  Views');
            },
            error: function (error) {
            }
        });
    }

    $(function () {
        // åˆ¤æ–­æ˜¯å¦åœ¨æ–‡ç« é¡µ
        setTimeout(function () {
            if ($('.posttitle').length == 1) {
                var Counter = AV.Object.extend("Counter");
                // å¢åŠ æ–‡ç« è®¿é—®æ¬¡æ•°
                addCount(Counter);
            }
            // è®°å½•è®¿é—®æ—¥å¿—
            addVisitLog();
            // è®¡ç®—å¤šå°‘äººè®¿é—®
            countVisitLog();
        }, 1000);
    });
</script>
