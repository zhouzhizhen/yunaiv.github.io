<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰ | èŠ‹è‰¿Vçš„åšå®¢</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="ç‹æ–‡æ–Œ"><meta name="description" content="ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘æœ‰ç¦åˆ©ï¼š  

RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨  
RocketMQ / MyCAT / Sharding-JDBC ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€  
æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚ç”šè‡³ä¸"><meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹è‰¿Vçš„åšå®¢" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?ef4ed89f6dc83d01803a2440ae21e666";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹è‰¿Vçš„åšå®¢">èŠ‹è‰¿Vçš„åšå®¢</a></h1><a class="blog-motto">æ„¿ç¼–ç åŠç”Ÿï¼Œå¦‚è€å‹ç›¸ä¼´ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li></ul></ul></nav></div></header><div id="container"><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1ã€æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1ã€æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2ã€ConsumeQueue-ç»“æ„"><span class="toc-number">2.</span> <span class="toc-text">2ã€ConsumeQueue ç»“æ„</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3ã€ConsumeQueue-å­˜å‚¨"><span class="toc-number">3.</span> <span class="toc-text">3ã€ConsumeQueue å­˜å‚¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ReputMessageService"><span class="toc-number">3.1.</span> <span class="toc-text">ReputMessageService</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultMessageStore-doDispatch-â€¦"><span class="toc-number">3.1.1.</span> <span class="toc-text">DefaultMessageStore#doDispatch(â€¦)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConsumeQueue-putMessagePositionInfoWrapper-â€¦"><span class="toc-number">3.1.2.</span> <span class="toc-text">ConsumeQueue#putMessagePositionInfoWrapper(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FlushConsumeQueueService"><span class="toc-number">3.2.</span> <span class="toc-text">FlushConsumeQueueService</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4ã€Broker-æä¾›-æ‹‰å–æ¶ˆæ¯-æ¥å£"><span class="toc-number">4.</span> <span class="toc-text">4ã€Broker æä¾›[æ‹‰å–æ¶ˆæ¯]æ¥å£</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PullMessageRequestHeader"><span class="toc-number">4.1.</span> <span class="toc-text">PullMessageRequestHeader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PullMessageProcessor-processRequest-â€¦"><span class="toc-number">4.2.</span> <span class="toc-text">PullMessageProcessor#processRequest(â€¦)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MessageStore-getMessage-â€¦"><span class="toc-number">4.3.</span> <span class="toc-text">MessageStore#getMessage(â€¦)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMessageFilter-isMessageMatched-â€¦"><span class="toc-number">4.4.</span> <span class="toc-text">DefaultMessageFilter#isMessageMatched(â€¦)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PullRequestHoldService"><span class="toc-number">4.5.</span> <span class="toc-text">PullRequestHoldService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PullMessageProcessor-executeRequestWhenWakeup-â€¦"><span class="toc-number">4.6.</span> <span class="toc-text">PullMessageProcessor#executeRequestWhenWakeup(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5ã€Broker-æä¾›-æ›´æ–°æ¶ˆè´¹è¿›åº¦-æ¥å£"><span class="toc-number">5.</span> <span class="toc-text">5ã€Broker æä¾›[æ›´æ–°æ¶ˆè´¹è¿›åº¦]æ¥å£</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#BrokerController-initialize-â€¦"><span class="toc-number">5.1.</span> <span class="toc-text">BrokerController#initialize(â€¦)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConfigManager"><span class="toc-number">5.2.</span> <span class="toc-text">ConfigManager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MixAll-string2File-â€¦"><span class="toc-number">5.2.1.</span> <span class="toc-text">MixAll#string2File(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumerOffsetManager"><span class="toc-number">5.3.</span> <span class="toc-text">ConsumerOffsetManager</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6ã€Broker-æä¾›-å‘å›æ¶ˆæ¯-æ¥å£"><span class="toc-number">6.</span> <span class="toc-text">6ã€Broker æä¾›[å‘å›æ¶ˆæ¯]æ¥å£</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SendMessageProcessor-consumerSendMsgBack-â€¦"><span class="toc-number">6.1.</span> <span class="toc-text">SendMessageProcessor#consumerSendMsgBack(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7ã€ç»“å°¾"><span class="toc-number">7.</span> <span class="toc-text">7ã€ç»“å°¾</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/Elastic-Job/" title="Elastic-Job">Elastic-Job<sup>6</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/æŠ€æœ¯æ‚æ–‡/" title="æŠ€æœ¯æ‚æ–‡">æŠ€æœ¯æ‚æ–‡<sup>2</sup></a></li></ul></div></aside></div><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/RocketMQ/message-pull-and-consume-first/" title="RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰" itemprop="url">RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰</a></h1><p class="article-author"></p><p class="article-time">æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><div id="toc" class="toc-article"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1ã€æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1ã€æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2ã€ConsumeQueue-ç»“æ„"><span class="toc-number">2.</span> <span class="toc-text">2ã€ConsumeQueue ç»“æ„</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3ã€ConsumeQueue-å­˜å‚¨"><span class="toc-number">3.</span> <span class="toc-text">3ã€ConsumeQueue å­˜å‚¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ReputMessageService"><span class="toc-number">3.1.</span> <span class="toc-text">ReputMessageService</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultMessageStore-doDispatch-â€¦"><span class="toc-number">3.1.1.</span> <span class="toc-text">DefaultMessageStore#doDispatch(â€¦)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConsumeQueue-putMessagePositionInfoWrapper-â€¦"><span class="toc-number">3.1.2.</span> <span class="toc-text">ConsumeQueue#putMessagePositionInfoWrapper(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FlushConsumeQueueService"><span class="toc-number">3.2.</span> <span class="toc-text">FlushConsumeQueueService</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4ã€Broker-æä¾›-æ‹‰å–æ¶ˆæ¯-æ¥å£"><span class="toc-number">4.</span> <span class="toc-text">4ã€Broker æä¾›[æ‹‰å–æ¶ˆæ¯]æ¥å£</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PullMessageRequestHeader"><span class="toc-number">4.1.</span> <span class="toc-text">PullMessageRequestHeader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PullMessageProcessor-processRequest-â€¦"><span class="toc-number">4.2.</span> <span class="toc-text">PullMessageProcessor#processRequest(â€¦)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MessageStore-getMessage-â€¦"><span class="toc-number">4.3.</span> <span class="toc-text">MessageStore#getMessage(â€¦)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMessageFilter-isMessageMatched-â€¦"><span class="toc-number">4.4.</span> <span class="toc-text">DefaultMessageFilter#isMessageMatched(â€¦)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PullRequestHoldService"><span class="toc-number">4.5.</span> <span class="toc-text">PullRequestHoldService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PullMessageProcessor-executeRequestWhenWakeup-â€¦"><span class="toc-number">4.6.</span> <span class="toc-text">PullMessageProcessor#executeRequestWhenWakeup(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5ã€Broker-æä¾›-æ›´æ–°æ¶ˆè´¹è¿›åº¦-æ¥å£"><span class="toc-number">5.</span> <span class="toc-text">5ã€Broker æä¾›[æ›´æ–°æ¶ˆè´¹è¿›åº¦]æ¥å£</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#BrokerController-initialize-â€¦"><span class="toc-number">5.1.</span> <span class="toc-text">BrokerController#initialize(â€¦)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConfigManager"><span class="toc-number">5.2.</span> <span class="toc-text">ConfigManager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MixAll-string2File-â€¦"><span class="toc-number">5.2.1.</span> <span class="toc-text">MixAll#string2File(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumerOffsetManager"><span class="toc-number">5.3.</span> <span class="toc-text">ConsumerOffsetManager</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6ã€Broker-æä¾›-å‘å›æ¶ˆæ¯-æ¥å£"><span class="toc-number">6.</span> <span class="toc-text">6ã€Broker æä¾›[å‘å›æ¶ˆæ¯]æ¥å£</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SendMessageProcessor-consumerSendMsgBack-â€¦"><span class="toc-number">6.1.</span> <span class="toc-text">SendMessageProcessor#consumerSendMsgBack(â€¦)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7ã€ç»“å°¾"><span class="toc-number">7.</span> <span class="toc-text">7ã€ç»“å°¾</span></a></li></ol></div><p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><ul><li><a href="#">1ã€æ¦‚è¿°</a></li><li><a href="#">2ã€ConsumeQueue ç»“æ„</a></li><li><a href="#">3ã€ConsumeQueue å­˜å‚¨</a><ul><li><a href="#">ReputMessageService</a><ul><li><a href="#">DefaultMessageStore#doDispatch(â€¦)</a></li><li><a href="#">ConsumeQueue#putMessagePositionInfoWrapper(â€¦)</a></li></ul></li><li><a href="#">FlushConsumeQueueService</a></li></ul></li><li><a href="#">4ã€Broker æä¾›[æ‹‰å–æ¶ˆæ¯]æ¥å£</a><ul><li><a href="#">PullMessageRequestHeader</a></li><li><a href="#">PullMessageProcessor#processRequest(â€¦)</a></li><li><a href="#">MessageStore#getMessage(â€¦)</a></li><li><a href="#">DefaultMessageFilter#isMessageMatched(â€¦)</a></li><li><a href="#">PullRequestHoldService</a></li><li><a href="#">PullMessageProcessor#executeRequestWhenWakeup(â€¦)</a></li></ul></li><li><a href="#">5ã€Broker æä¾›[æ›´æ–°æ¶ˆè´¹è¿›åº¦]æ¥å£</a><ul><li><a href="#">BrokerController#initialize(â€¦)</a></li><li><a href="#">ConfigManager</a><ul><li><a href="#">MixAll#string2File(â€¦)</a></li></ul></li><li><a href="#">ConsumerOffsetManager</a></li></ul></li><li><a href="#">6ã€Broker æä¾›[å‘å›æ¶ˆæ¯]æ¥å£</a><ul><li><a href="#">SendMessageProcessor#consumerSendMsgBack(â€¦)</a></li></ul></li><li><a href="#">7ã€ç»“å°¾</a></li></ul><h1 id="1ã€æ¦‚è¿°"><a href="#1ã€æ¦‚è¿°" class="headerlink" title="1ã€æ¦‚è¿°"></a>1ã€æ¦‚è¿°</h1><p>æœ¬ç« ä¸»è¦è§£æ <strong>æ¶ˆè´¹</strong> é€»è¾‘æ¶‰åŠåˆ°çš„æºç ã€‚<br>å› ä¸ºç¯‡å¹…è¾ƒé•¿ï¼Œåˆ†æˆä¸Šä¸‹ä¸¤ç¯‡ï¼š</p><ol><li>ä¸Šç¯‡ï¼š<code>Broker</code> ç›¸å…³æºç ã€‚</li><li>ä¸‹ç¯‡ï¼š<code>Consumer</code> ç›¸å…³æºç ã€‚</li></ol><p><em>æœ¬æ–‡å³æ˜¯ä¸Šç¯‡ã€‚</em></p><hr><p>okï¼Œå…ˆçœ‹ç¬¬ä¸€å¼ å…³äºæ¶ˆè´¹é€»è¾‘çš„å›¾ï¼š</p><blockquote><p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/13.png" alt="æ¶ˆè´¹é€»è¾‘å›¾"></p></blockquote><p>å†çœ‹æ¶ˆè´¹é€»è¾‘ç²¾ç®€çš„é¡ºåºå›¾ï¼ˆå®é™…æƒ…å†µä¼šç•¥æœ‰å·®åˆ«ï¼‰ï¼š</p><blockquote><p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/04.png" alt="Consumer&amp;Brokeræ¶ˆè´¹ç²¾ç®€å›¾.png"></p></blockquote><h1 id="2ã€ConsumeQueue-ç»“æ„"><a href="#2ã€ConsumeQueue-ç»“æ„" class="headerlink" title="2ã€ConsumeQueue ç»“æ„"></a>2ã€ConsumeQueue ç»“æ„</h1><p><code>ConsumeQueue</code>ã€<code>MappedFileQueue</code>ã€<code>MappedFile</code> çš„å…³ç³»å¦‚ä¸‹ï¼š</p><blockquote><p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/03.png" alt="ConsumeQueueã€MappedFileQueueã€MappedFileçš„å…³ç³»"><br><code>ConsumeQueue</code> : <code>MappedFileQueue</code> : <code>MappedFile</code> = 1 : 1 : Nã€‚</p></blockquote><p>ååº”åˆ°ç³»ç»Ÿæ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">Yunai-MacdeMacBook-Pro-2:consumequeue yunai$ <span class="built_in">pwd</span></div><div class="line">/Users/yunai/store/consumequeue</div><div class="line">Yunai-MacdeMacBook-Pro-2:consumequeue yunai$ <span class="built_in">cd</span> TopicRead3/</div><div class="line">Yunai-MacdeMacBook-Pro-2:TopicRead3 yunai$ ls -ls</div><div class="line">total 0</div><div class="line">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:52 0</div><div class="line">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 1</div><div class="line">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 2</div><div class="line">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 3</div><div class="line">Yunai-MacdeMacBook-Pro-2:TopicRead3 yunai$ <span class="built_in">cd</span> 0/</div><div class="line">Yunai-MacdeMacBook-Pro-2:0 yunai$ ls -ls</div><div class="line">total 11720</div><div class="line">11720 -rw-r--r--  1 yunai  staff  6000000  4 27 21:55 00000000000000000000</div></pre></td></tr></table></figure><hr><p><code>ConsumeQueue</code>ã€<code>MappedFileQueue</code>ã€<code>MappedFile</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><ul><li><code>MappedFile</code> ï¼š00000000000000000000ç­‰æ–‡ä»¶ã€‚</li><li><code>MappedFileQueue</code> ï¼š<code>MappedFile</code> æ‰€åœ¨çš„æ–‡ä»¶å¤¹ï¼Œå¯¹ <code>MappedFile</code> è¿›è¡Œå°è£…æˆæ–‡ä»¶é˜Ÿåˆ—ï¼Œå¯¹ä¸Šå±‚æä¾›å¯æ— é™ä½¿ç”¨çš„æ–‡ä»¶å®¹é‡ã€‚<ul><li>æ¯ä¸ª <code>MappedFile</code> ç»Ÿä¸€æ–‡ä»¶å¤§å°ã€‚</li><li>æ–‡ä»¶å‘½åæ–¹å¼ï¼šfileName[n] = fileName[n - 1] + mappedFileSizeã€‚åœ¨ <code>ConsumeQueue</code> é‡Œé»˜è®¤ä¸º 6000000Bã€‚</li></ul></li><li><code>ConsumeQueue</code> ï¼šé’ˆå¯¹ <code>MappedFileQueue</code> çš„å°è£…ä½¿ç”¨ã€‚<ul><li><code>Store : ConsumeQueue = ConcurrentHashMap&lt;String/* topic */, ConcurrentHashMap&lt;Integer/* queueId */, ConsumeQueue&gt;&gt;</code>ã€‚</li></ul></li></ul><p><code>ConsumeQueue</code> å­˜å‚¨åœ¨ <code>MappedFile</code> çš„å†…å®¹<strong>å¿…é¡»</strong>å¤§å°æ˜¯ 20B( <code>ConsumeQueue.CQ_STORE_UNIT_SIZE</code> )ï¼Œæœ‰ä¸¤ç§å†…å®¹ç±»å‹ï¼š</p><ol><li><code>MESSAGE_POSITION_INFO</code> ï¼šæ¶ˆæ¯ä½ç½®ä¿¡æ¯ã€‚</li><li><code>BLANK</code> : æ–‡ä»¶å‰ç½®ç©ºç™½å ä½ã€‚å½“å†å² <code>Message</code> è¢«åˆ é™¤æ—¶ï¼Œéœ€è¦ç”¨ <code>BLANK</code>å ä½è¢«åˆ é™¤çš„æ¶ˆæ¯ã€‚</li></ol><p><code>MESSAGE_POSITION_INFO</code> åœ¨ <code>ConsumeQueue</code> å­˜å‚¨ç»“æ„ï¼š</p><table><thead><tr><th style="text-align:left">ç¬¬å‡ ä½</th><th style="text-align:left">å­—æ®µ</th><th style="text-align:left">è¯´æ˜</th><th style="text-align:left">æ•°æ®ç±»å‹</th><th style="text-align:left">å­—èŠ‚æ•°</th></tr></thead><tbody><tr><td style="text-align:left">1</td><td style="text-align:left">offset</td><td style="text-align:left">æ¶ˆæ¯ <code>CommitLog</code> å­˜å‚¨ä½ç½®</td><td style="text-align:left">Long</td><td style="text-align:left">8</td></tr><tr><td style="text-align:left">2</td><td style="text-align:left">size</td><td style="text-align:left">æ¶ˆæ¯é•¿åº¦</td><td style="text-align:left">Int</td><td style="text-align:left">4</td></tr><tr><td style="text-align:left">3</td><td style="text-align:left">tagsCode</td><td style="text-align:left">æ¶ˆæ¯tagsCode</td><td style="text-align:left">Long</td><td style="text-align:left">8</td></tr></tbody></table><p><code>BLANK</code> åœ¨ <code>ConsumeQueue</code> å­˜å‚¨ç»“æ„ï¼š</p><table><thead><tr><th style="text-align:left">ç¬¬å‡ ä½</th><th style="text-align:left">å­—æ®µ</th><th style="text-align:left">è¯´æ˜</th><th style="text-align:left">æ•°æ®ç±»å‹</th><th style="text-align:left">å­—èŠ‚æ•°</th></tr></thead><tbody><tr><td style="text-align:left">1</td><td style="text-align:left"></td><td style="text-align:left">0</td><td style="text-align:left">Long</td><td style="text-align:left">8</td></tr><tr><td style="text-align:left">2</td><td style="text-align:left"></td><td style="text-align:left">Integer.MAX_VALUE</td><td style="text-align:left">Int</td><td style="text-align:left">4</td></tr><tr><td style="text-align:left">3</td><td style="text-align:left"></td><td style="text-align:left">0</td><td style="text-align:left">Long</td><td style="text-align:left">8</td></tr></tbody></table><h1 id="3ã€ConsumeQueue-å­˜å‚¨"><a href="#3ã€ConsumeQueue-å­˜å‚¨" class="headerlink" title="3ã€ConsumeQueue å­˜å‚¨"></a>3ã€ConsumeQueue å­˜å‚¨</h1><p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/02.png" alt="CommitLogé‡æ”¾ConsumeQueueå›¾"></p><p>ä¸»è¦æœ‰ä¸¤ä¸ªç»„ä»¶ï¼š</p><ul><li><code>ReputMessageService</code> ï¼šwrite ConsumeQueueã€‚</li><li><code>FlushConsumeQueueService</code> ï¼šflush ConsumeQueueã€‚</li></ul><h2 id="ReputMessageService"><a href="#ReputMessageService" class="headerlink" title="ReputMessageService"></a>ReputMessageService</h2><p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/12.png" alt="ReputMessageServiceé¡ºåºå›¾"></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="class"><span class="keyword">class</span> <span class="title">ReputMessageService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>&#123;</div><div class="line">  <span class="number">2</span>: </div><div class="line">  <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line">  4:      * å¼€å§‹é‡æ”¾æ¶ˆæ¯çš„CommitLogç‰©ç†ä½ç½®</div><div class="line">  5:      */</div><div class="line">  <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> reputFromOffset = <span class="number">0</span>;</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getReputFromOffset</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="number">9</span>:         <span class="keyword">return</span> reputFromOffset;</div><div class="line"> <span class="number">10</span>:     &#125;</div><div class="line"> <span class="number">11</span>: </div><div class="line"> <span class="number">12</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReputFromOffset</span><span class="params">(<span class="keyword">long</span> reputFromOffset)</span> </span>&#123;</div><div class="line"> <span class="number">13</span>:         <span class="keyword">this</span>.reputFromOffset = reputFromOffset;</div><div class="line"> <span class="number">14</span>:     &#125;</div><div class="line"> <span class="number">15</span>: </div><div class="line"> <span class="number">16</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">17</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">18</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span> &amp;&amp; <span class="keyword">this</span>.isCommitLogAvailable(); i++) &#123;</div><div class="line"> <span class="number">19</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">20</span>:                 Thread.sleep(<span class="number">100</span>);</div><div class="line"> <span class="number">21</span>:             &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</div><div class="line"> <span class="number">22</span>:             &#125;</div><div class="line"> <span class="number">23</span>:         &#125;</div><div class="line"> <span class="number">24</span>: </div><div class="line"> <span class="number">25</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.isCommitLogAvailable()) &#123;</div><div class="line"> <span class="number">26</span>:             log.warn(<span class="string">"shutdown ReputMessageService, but commitlog have not finish to be dispatched, CL: &#123;&#125; reputFromOffset: &#123;&#125;"</span>,</div><div class="line"> <span class="number">27</span>:                 DefaultMessageStore.<span class="keyword">this</span>.commitLog.getMaxOffset(), <span class="keyword">this</span>.reputFromOffset);</div><div class="line"> <span class="number">28</span>:         &#125;</div><div class="line"> <span class="number">29</span>: </div><div class="line"> <span class="number">30</span>:         <span class="keyword">super</span>.shutdown();</div><div class="line"> <span class="number">31</span>:     &#125;</div><div class="line"> <span class="number">32</span>: </div><div class="line"> <span class="number">33</span>:     <span class="comment">/**</span></div><div class="line"> 34:      * å‰©ä½™éœ€è¦é‡æ”¾æ¶ˆæ¯å­—èŠ‚æ•°</div><div class="line"> 35:      *</div><div class="line"> 36:      * <span class="doctag">@return</span> å­—èŠ‚æ•°</div><div class="line"> 37:      */</div><div class="line"> <span class="number">38</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">behind</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">39</span>:         <span class="keyword">return</span> DefaultMessageStore.<span class="keyword">this</span>.commitLog.getMaxOffset() - <span class="keyword">this</span>.reputFromOffset;</div><div class="line"> <span class="number">40</span>:     &#125;</div><div class="line"> <span class="number">41</span>: </div><div class="line"> <span class="number">42</span>:     <span class="comment">/**</span></div><div class="line"> 43:      * æ˜¯å¦commitLogéœ€è¦é‡æ”¾æ¶ˆæ¯</div><div class="line"> 44:      *</div><div class="line"> 45:      * <span class="doctag">@return</span> æ˜¯å¦</div><div class="line"> 46:      */</div><div class="line"> <span class="number">47</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isCommitLogAvailable</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">48</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.reputFromOffset &lt; DefaultMessageStore.<span class="keyword">this</span>.commitLog.getMaxOffset();</div><div class="line"> <span class="number">49</span>:     &#125;</div><div class="line"> <span class="number">50</span>: </div><div class="line"> <span class="number">51</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doReput</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">52</span>:         <span class="keyword">for</span> (<span class="keyword">boolean</span> doNext = <span class="keyword">true</span>; <span class="keyword">this</span>.isCommitLogAvailable() &amp;&amp; doNext; ) &#123;</div><div class="line"> <span class="number">53</span>: </div><div class="line"> <span class="number">54</span>:             <span class="comment">// TODO ç–‘é—®ï¼šè¿™ä¸ªæ˜¯å•¥</span></div><div class="line"> <span class="number">55</span>:             <span class="keyword">if</span> (DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().isDuplicationEnable() <span class="comment">//</span></div><div class="line"> <span class="number">56</span>:                 &amp;&amp; <span class="keyword">this</span>.reputFromOffset &gt;= DefaultMessageStore.<span class="keyword">this</span>.getConfirmOffset()) &#123;</div><div class="line"> <span class="number">57</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">58</span>:             &#125;</div><div class="line"> <span class="number">59</span>: </div><div class="line"> <span class="number">60</span>:             <span class="comment">// è·å–ä»reputFromOffsetå¼€å§‹çš„commitLogå¯¹åº”çš„MappeFileå¯¹åº”çš„MappedByteBuffer</span></div><div class="line"> <span class="number">61</span>:             SelectMappedBufferResult result = DefaultMessageStore.<span class="keyword">this</span>.commitLog.getData(reputFromOffset);</div><div class="line"> <span class="number">62</span>:             <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">63</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">64</span>:                     <span class="keyword">this</span>.reputFromOffset = result.getStartOffset();</div><div class="line"> <span class="number">65</span>: </div><div class="line"> <span class="number">66</span>:                     <span class="comment">// éå†MappedByteBuffer</span></div><div class="line"> <span class="number">67</span>:                     <span class="keyword">for</span> (<span class="keyword">int</span> readSize = <span class="number">0</span>; readSize &lt; result.getSize() &amp;&amp; doNext; ) &#123;</div><div class="line"> <span class="number">68</span>:                         <span class="comment">// ç”Ÿæˆé‡æ”¾æ¶ˆæ¯é‡æ”¾è°ƒåº¦è¯·æ±‚</span></div><div class="line"> <span class="number">69</span>:                         DispatchRequest dispatchRequest = DefaultMessageStore.<span class="keyword">this</span>.commitLog.checkMessageAndReturnSize(result.getByteBuffer(), <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line"> <span class="number">70</span>:                         <span class="keyword">int</span> size = dispatchRequest.getMsgSize(); <span class="comment">// æ¶ˆæ¯é•¿åº¦</span></div><div class="line"> <span class="number">71</span>:                         <span class="comment">// æ ¹æ®è¯·æ±‚çš„ç»“æœå¤„ç†</span></div><div class="line"> <span class="number">72</span>:                         <span class="keyword">if</span> (dispatchRequest.isSuccess()) &#123; <span class="comment">// è¯»å–æˆåŠŸ</span></div><div class="line"> <span class="number">73</span>:                             <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123; <span class="comment">// è¯»å–Message</span></div><div class="line"> <span class="number">74</span>:                                 DefaultMessageStore.<span class="keyword">this</span>.doDispatch(dispatchRequest);</div><div class="line"> <span class="number">75</span>:                                 <span class="comment">// é€šçŸ¥æœ‰æ–°æ¶ˆæ¯</span></div><div class="line"> <span class="number">76</span>:                                 <span class="keyword">if</span> (BrokerRole.SLAVE != DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getBrokerRole()</div><div class="line"> <span class="number">77</span>:                                     &amp;&amp; DefaultMessageStore.<span class="keyword">this</span>.brokerConfig.isLongPollingEnable()) &#123;</div><div class="line"> <span class="number">78</span>:                                     DefaultMessageStore.<span class="keyword">this</span>.messageArrivingListener.arriving(dispatchRequest.getTopic(),</div><div class="line"> <span class="number">79</span>:                                         dispatchRequest.getQueueId(), dispatchRequest.getConsumeQueueOffset() + <span class="number">1</span>,</div><div class="line"> <span class="number">80</span>:                                         dispatchRequest.getTagsCode());</div><div class="line"> <span class="number">81</span>:                                 &#125;</div><div class="line"> <span class="number">82</span>:                                 <span class="comment">// FIXED BUG By shijia</span></div><div class="line"> <span class="number">83</span>:                                 <span class="keyword">this</span>.reputFromOffset += size;</div><div class="line"> <span class="number">84</span>:                                 readSize += size;</div><div class="line"> <span class="number">85</span>:                                 <span class="comment">// ç»Ÿè®¡</span></div><div class="line"> <span class="number">86</span>:                                 <span class="keyword">if</span> (DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getBrokerRole() == BrokerRole.SLAVE) &#123;</div><div class="line"> <span class="number">87</span>:                                     DefaultMessageStore.<span class="keyword">this</span>.storeStatsService</div><div class="line"> <span class="number">88</span>:                                         .getSinglePutMessageTopicTimesTotal(dispatchRequest.getTopic()).incrementAndGet();</div><div class="line"> <span class="number">89</span>:                                     DefaultMessageStore.<span class="keyword">this</span>.storeStatsService</div><div class="line"> <span class="number">90</span>:                                         .getSinglePutMessageTopicSizeTotal(dispatchRequest.getTopic())</div><div class="line"> <span class="number">91</span>:                                         .addAndGet(dispatchRequest.getMsgSize());</div><div class="line"> <span class="number">92</span>:                                 &#125;</div><div class="line"> <span class="number">93</span>:                             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (size == <span class="number">0</span>) &#123; <span class="comment">// è¯»å–åˆ°MappedFileæ–‡ä»¶å°¾</span></div><div class="line"> <span class="number">94</span>:                                 <span class="keyword">this</span>.reputFromOffset = DefaultMessageStore.<span class="keyword">this</span>.commitLog.rollNextFile(<span class="keyword">this</span>.reputFromOffset);</div><div class="line"> <span class="number">95</span>:                                 readSize = result.getSize();</div><div class="line"> <span class="number">96</span>:                             &#125;</div><div class="line"> <span class="number">97</span>:                         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!dispatchRequest.isSuccess()) &#123; <span class="comment">// è¯»å–å¤±è´¥</span></div><div class="line"> <span class="number">98</span>:                             <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123; <span class="comment">// è¯»å–åˆ°Messageå´ä¸æ˜¯Message</span></div><div class="line"> <span class="number">99</span>:                                 log.error(<span class="string">"[BUG]read total count not equals msg total size. reputFromOffset=&#123;&#125;"</span>, reputFromOffset);</div><div class="line"><span class="number">100</span>:                                 <span class="keyword">this</span>.reputFromOffset += size;</div><div class="line"><span class="number">101</span>:                             &#125; <span class="keyword">else</span> &#123; <span class="comment">// è¯»å–åˆ°Blankå´ä¸æ˜¯Blank</span></div><div class="line"><span class="number">102</span>:                                 doNext = <span class="keyword">false</span>;</div><div class="line"><span class="number">103</span>:                                 <span class="keyword">if</span> (DefaultMessageStore.<span class="keyword">this</span>.brokerConfig.getBrokerId() == MixAll.MASTER_ID) &#123;</div><div class="line"><span class="number">104</span>:                                     log.error(<span class="string">"[BUG]the master dispatch message to consume queue error, COMMITLOG OFFSET: &#123;&#125;"</span>,</div><div class="line"><span class="number">105</span>:                                         <span class="keyword">this</span>.reputFromOffset);</div><div class="line"><span class="number">106</span>: </div><div class="line"><span class="number">107</span>:                                     <span class="keyword">this</span>.reputFromOffset += result.getSize() - readSize;</div><div class="line"><span class="number">108</span>:                                 &#125;</div><div class="line"><span class="number">109</span>:                             &#125;</div><div class="line"><span class="number">110</span>:                         &#125;</div><div class="line"><span class="number">111</span>:                     &#125;</div><div class="line"><span class="number">112</span>:                 &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">113</span>:                     result.release();</div><div class="line"><span class="number">114</span>:                 &#125;</div><div class="line"><span class="number">115</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">116</span>:                 doNext = <span class="keyword">false</span>;</div><div class="line"><span class="number">117</span>:             &#125;</div><div class="line"><span class="number">118</span>:         &#125;</div><div class="line"><span class="number">119</span>:     &#125;</div><div class="line"><span class="number">120</span>: </div><div class="line"><span class="number">121</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">122</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">123</span>:         DefaultMessageStore.log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service started"</span>);</div><div class="line"><span class="number">124</span>: </div><div class="line"><span class="number">125</span>:         <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</div><div class="line"><span class="number">126</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">127</span>:                 Thread.sleep(<span class="number">1</span>);</div><div class="line"><span class="number">128</span>:                 <span class="keyword">this</span>.doReput();</div><div class="line"><span class="number">129</span>:             &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">130</span>:                 DefaultMessageStore.log.warn(<span class="keyword">this</span>.getServiceName() + <span class="string">" service has exception. "</span>, e);</div><div class="line"><span class="number">131</span>:             &#125;</div><div class="line"><span class="number">132</span>:         &#125;</div><div class="line"><span class="number">133</span>: </div><div class="line"><span class="number">134</span>:         DefaultMessageStore.log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service end"</span>);</div><div class="line"><span class="number">135</span>:     &#125;</div><div class="line"><span class="number">136</span>: </div><div class="line"><span class="number">137</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">138</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getServiceName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">139</span>:         <span class="keyword">return</span> ReputMessageService.class.getSimpleName();</div><div class="line"><span class="number">140</span>:     &#125;</div><div class="line"><span class="number">141</span>: </div><div class="line"><span class="number">142</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ï¼šé‡æ”¾æ¶ˆæ¯çº¿ç¨‹æœåŠ¡ã€‚<ul><li>è¯¥æœåŠ¡ä¸æ–­ç”Ÿæˆ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° æ¶ˆè´¹é˜Ÿåˆ—(ConsumeQueue)</li><li>è¯¥æœåŠ¡ä¸æ–­ç”Ÿæˆ æ¶ˆæ¯ç´¢å¼• åˆ° ç´¢å¼•æ–‡ä»¶(IndexFile)</li></ul></li><li><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/11.png" alt="ReputMessageServiceç”¨ä¾‹å›¾"><ul><li>ç¬¬ 61 è¡Œ ï¼šè·å– <code>reputFromOffset</code> å¼€å§‹çš„ <code>CommitLog</code> å¯¹åº”çš„ <code>MappedFile</code> å¯¹åº”çš„ <code>MappedByteBuffer</code>ã€‚</li><li>ç¬¬ 67 è¡Œ ï¼šéå† <code>MappedByteBuffer</code>ã€‚</li><li>ç¬¬ 69 è¡Œ ï¼šç”Ÿæˆé‡æ”¾æ¶ˆæ¯é‡æ”¾è°ƒåº¦è¯·æ±‚ (<code>DispatchRequest</code>) ã€‚è¯·æ±‚é‡Œä¸»è¦åŒ…å«ä¸€æ¡æ¶ˆæ¯ (<code>Message</code>) æˆ–è€… æ–‡ä»¶å°¾ (<code>BLANK</code>) çš„åŸºæœ¬ä¿¡æ¯ã€‚</li><li>ç¬¬ 72 è‡³ 96 è¡Œ ï¼šè¯·æ±‚æ˜¯æœ‰æ•ˆè¯·æ±‚ï¼Œè¿›è¡Œé€»è¾‘å¤„ç†ã€‚<ul><li>ç¬¬ 75 è‡³ 81 è¡Œ ï¼šå½“ <code>Broker</code> æ˜¯ä¸»èŠ‚ç‚¹ &amp;&amp; <code>Broker</code> å¼€å¯çš„æ˜¯é•¿è½®è¯¢ï¼Œé€šçŸ¥æ¶ˆè´¹é˜Ÿåˆ—æœ‰æ–°çš„æ¶ˆæ¯ã€‚<code>NotifyMessageArrivingListener</code> ä¼š è°ƒç”¨ <code>PullRequestHoldService#notifyMessageArriving(...)</code> æ–¹æ³•ï¼Œè¯¦ç»†è§£æè§ï¼š<a href="#pullrequestholdservice">PullRequestHoldService</a></li></ul></li><li>ç¬¬ 73 è‡³ 92 è¡Œ ï¼šè¯·æ±‚å¯¹åº”çš„æ˜¯ <code>Message</code>ï¼Œè¿›è¡Œè°ƒåº¦ï¼Œç”Ÿæˆ <code>ConsumeQueue</code> å’Œ <code>IndexFile</code> å¯¹åº”çš„å†…å®¹ã€‚è¯¦ç»†è§£æè§ï¼š</li><li>ç¬¬ 93 è‡³ 96 è¡Œ ï¼šè¯·æ±‚å¯¹åº”çš„æ˜¯ <code>Blank</code>ï¼Œå³æ–‡ä»¶å°¾ï¼Œè·³è½¬æŒ‡å‘ä¸‹ä¸€ä¸ª <code>MappedFile</code>ã€‚</li><li>ç¬¬ 97 è‡³ 110 è¡Œ ï¼šè¯·æ±‚æ˜¯æ— æ•ˆè¯·æ±‚ã€‚å‡ºç°è¯¥æƒ…å†µï¼ŒåŸºæœ¬æ˜¯ä¸€ä¸ª<strong>BUG</strong>ã€‚</li></ul></li><li>ç¬¬ 127 è‡³ 128 è¡Œ ï¼šæ¯ 1ms å¾ªç¯æ‰§è¡Œé‡æ”¾é€»è¾‘ã€‚</li><li>ç¬¬ 18 è‡³ 30 è¡Œ ï¼š<code>shutdown</code>æ—¶ï¼Œå¤šæ¬¡ <code>sleep(100)</code> ç›´åˆ° <code>CommitLog</code> å›æ”¾åˆ°æœ€æ–°ä½ç½®ã€‚æ©ï¼Œå¦‚æœæœªå›æ”¾å®Œï¼Œä¼šè¾“å‡ºè­¦å‘Šæ—¥å¿—ã€‚</li></ul><h3 id="DefaultMessageStore-doDispatch-â€¦"><a href="#DefaultMessageStore-doDispatch-â€¦" class="headerlink" title="DefaultMessageStore#doDispatch(â€¦)"></a>DefaultMessageStore#doDispatch(â€¦)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * æ‰§è¡Œè°ƒåº¦è¯·æ±‚</div><div class="line"> 3:  * 1. éäº‹åŠ¡æ¶ˆæ¯ æˆ– äº‹åŠ¡æäº¤æ¶ˆæ¯ å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue</div><div class="line"> 4:  * 2. å»ºç«‹ ç´¢å¼•ä¿¡æ¯ åˆ° IndexFile</div><div class="line"> 5:  *</div><div class="line"> 6:  * <span class="doctag">@param</span> req è°ƒåº¦è¯·æ±‚</div><div class="line"> 7:  */</div><div class="line"> <span class="number">8</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(DispatchRequest req)</span> </span>&#123;</div><div class="line"> <span class="number">9</span>:     <span class="comment">// éäº‹åŠ¡æ¶ˆæ¯ æˆ– äº‹åŠ¡æäº¤æ¶ˆæ¯ å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue</span></div><div class="line"><span class="number">10</span>:     <span class="keyword">final</span> <span class="keyword">int</span> tranType = MessageSysFlag.getTransactionValue(req.getSysFlag());</div><div class="line"><span class="number">11</span>:     <span class="keyword">switch</span> (tranType) &#123;</div><div class="line"><span class="number">12</span>:         <span class="keyword">case</span> MessageSysFlag.TRANSACTION_NOT_TYPE:</div><div class="line"><span class="number">13</span>:         <span class="keyword">case</span> MessageSysFlag.TRANSACTION_COMMIT_TYPE:</div><div class="line"><span class="number">14</span>:             DefaultMessageStore.<span class="keyword">this</span>.putMessagePositionInfo(req.getTopic(), req.getQueueId(), req.getCommitLogOffset(), req.getMsgSize(),</div><div class="line"><span class="number">15</span>:                 req.getTagsCode(), req.getStoreTimestamp(), req.getConsumeQueueOffset());</div><div class="line"><span class="number">16</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">17</span>:         <span class="keyword">case</span> MessageSysFlag.TRANSACTION_PREPARED_TYPE:</div><div class="line"><span class="number">18</span>:         <span class="keyword">case</span> MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:</div><div class="line"><span class="number">19</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">20</span>:     &#125;</div><div class="line"><span class="number">21</span>:     <span class="comment">// å»ºç«‹ ç´¢å¼•ä¿¡æ¯ åˆ° IndexFile</span></div><div class="line"><span class="number">22</span>:     <span class="keyword">if</span> (DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().isMessageIndexEnable()) &#123;</div><div class="line"><span class="number">23</span>:         DefaultMessageStore.<span class="keyword">this</span>.indexService.buildIndex(req);</div><div class="line"><span class="number">24</span>:     &#125;</div><div class="line"><span class="number">25</span>: &#125;</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>: <span class="comment">/**</span></div><div class="line">28:  * å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue</div><div class="line">29:  *</div><div class="line">30:  * <span class="doctag">@param</span> topic ä¸»é¢˜</div><div class="line">31:  * <span class="doctag">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class="line">32:  * <span class="doctag">@param</span> offset commitLogå­˜å‚¨ä½ç½®</div><div class="line">33:  * <span class="doctag">@param</span> size æ¶ˆæ¯é•¿åº¦</div><div class="line">34:  * <span class="doctag">@param</span> tagsCode æ¶ˆæ¯tagsCode</div><div class="line">35:  * <span class="doctag">@param</span> storeTimestamp å­˜å‚¨æ—¶é—´</div><div class="line">36:  * <span class="doctag">@param</span> logicOffset é˜Ÿåˆ—ä½ç½®</div><div class="line">37:  */</div><div class="line"><span class="number">38</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putMessagePositionInfo</span><span class="params">(String topic, <span class="keyword">int</span> queueId, <span class="keyword">long</span> offset, <span class="keyword">int</span> size, <span class="keyword">long</span> tagsCode, <span class="keyword">long</span> storeTimestamp,</span></span></div><div class="line"><span class="number">39</span>:     <span class="keyword">long</span> logicOffset) &#123;</div><div class="line"><span class="number">40</span>:     ConsumeQueue cq = <span class="keyword">this</span>.findConsumeQueue(topic, queueId);</div><div class="line"><span class="number">41</span>:     cq.putMessagePositionInfoWrapper(offset, size, tagsCode, storeTimestamp, logicOffset);</div><div class="line"><span class="number">42</span>: &#125;</div></pre></td></tr></table></figure><h3 id="ConsumeQueue-putMessagePositionInfoWrapper-â€¦"><a href="#ConsumeQueue-putMessagePositionInfoWrapper-â€¦" class="headerlink" title="ConsumeQueue#putMessagePositionInfoWrapper(â€¦)"></a>ConsumeQueue#putMessagePositionInfoWrapper(â€¦)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">/**</span></div><div class="line">  2:  * æ·»åŠ ä½ç½®ä¿¡æ¯å°è£…</div><div class="line">  3:  *</div><div class="line">  4:  * <span class="doctag">@param</span> offset commitLogå­˜å‚¨ä½ç½®</div><div class="line">  5:  * <span class="doctag">@param</span> size æ¶ˆæ¯é•¿åº¦</div><div class="line">  6:  * <span class="doctag">@param</span> tagsCode æ¶ˆæ¯tagsCode</div><div class="line">  7:  * <span class="doctag">@param</span> storeTimestamp æ¶ˆæ¯å­˜å‚¨æ—¶é—´</div><div class="line">  8:  * <span class="doctag">@param</span> logicOffset é˜Ÿåˆ—ä½ç½®</div><div class="line">  9:  */</div><div class="line"> <span class="number">10</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putMessagePositionInfoWrapper</span><span class="params">(<span class="keyword">long</span> offset, <span class="keyword">int</span> size, <span class="keyword">long</span> tagsCode, <span class="keyword">long</span> storeTimestamp,</span></span></div><div class="line"> <span class="number">11</span>:     <span class="keyword">long</span> logicOffset) &#123;</div><div class="line"> <span class="number">12</span>:     <span class="keyword">final</span> <span class="keyword">int</span> maxRetries = <span class="number">30</span>;</div><div class="line"> <span class="number">13</span>:     <span class="keyword">boolean</span> canWrite = <span class="keyword">this</span>.defaultMessageStore.getRunningFlags().isWriteable();</div><div class="line"> <span class="number">14</span>:     <span class="comment">// å¤šæ¬¡å¾ªç¯å†™ï¼Œç›´åˆ°æˆåŠŸ</span></div><div class="line"> <span class="number">15</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; maxRetries &amp;&amp; canWrite; i++) &#123;</div><div class="line"> <span class="number">16</span>:         <span class="comment">// è°ƒç”¨æ·»åŠ ä½ç½®ä¿¡æ¯</span></div><div class="line"> <span class="number">17</span>:         <span class="keyword">boolean</span> result = <span class="keyword">this</span>.putMessagePositionInfo(offset, size, tagsCode, logicOffset);</div><div class="line"> <span class="number">18</span>:         <span class="keyword">if</span> (result) &#123;</div><div class="line"> <span class="number">19</span>:             <span class="comment">// æ·»åŠ æˆåŠŸï¼Œä½¿ç”¨æ¶ˆæ¯å­˜å‚¨æ—¶é—´ ä½œä¸º å­˜å‚¨check pointã€‚</span></div><div class="line"> <span class="number">20</span>:             <span class="keyword">this</span>.defaultMessageStore.getStoreCheckpoint().setLogicsMsgTimestamp(storeTimestamp);</div><div class="line"> <span class="number">21</span>:             <span class="keyword">return</span>;</div><div class="line"> <span class="number">22</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">23</span>:             <span class="comment">// <span class="doctag">XXX:</span> warn and notify me</span></div><div class="line"> <span class="number">24</span>:             log.warn(<span class="string">"[BUG]put commit log position info to "</span> + topic + <span class="string">":"</span> + queueId + <span class="string">" "</span> + offset</div><div class="line"> <span class="number">25</span>:                 + <span class="string">" failed, retry "</span> + i + <span class="string">" times"</span>);</div><div class="line"> <span class="number">26</span>: </div><div class="line"> <span class="number">27</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">28</span>:                 Thread.sleep(<span class="number">1000</span>);</div><div class="line"> <span class="number">29</span>:             &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"> <span class="number">30</span>:                 log.warn(<span class="string">""</span>, e);</div><div class="line"> <span class="number">31</span>:             &#125;</div><div class="line"> <span class="number">32</span>:         &#125;</div><div class="line"> <span class="number">33</span>:     &#125;</div><div class="line"> <span class="number">34</span>: </div><div class="line"> <span class="number">35</span>:     <span class="comment">// <span class="doctag">XXX:</span> warn and notify me è®¾ç½®å¼‚å¸¸ä¸å¯å†™å…¥</span></div><div class="line"> <span class="number">36</span>:     log.error(<span class="string">"[BUG]consume queue can not write, &#123;&#125; &#123;&#125;"</span>, <span class="keyword">this</span>.topic, <span class="keyword">this</span>.queueId);</div><div class="line"> <span class="number">37</span>:     <span class="keyword">this</span>.defaultMessageStore.getRunningFlags().makeLogicsQueueError();</div><div class="line"> <span class="number">38</span>: &#125;</div><div class="line"> <span class="number">39</span>: </div><div class="line"> <span class="number">40</span>: <span class="comment">/**</span></div><div class="line"> 41:  * æ·»åŠ ä½ç½®ä¿¡æ¯ï¼Œå¹¶è¿”å›æ·»åŠ æ˜¯å¦æˆåŠŸ</div><div class="line"> 42:  *</div><div class="line"> 43:  * <span class="doctag">@param</span> offset commitLogå­˜å‚¨ä½ç½®</div><div class="line"> 44:  * <span class="doctag">@param</span> size æ¶ˆæ¯é•¿åº¦</div><div class="line"> 45:  * <span class="doctag">@param</span> tagsCode æ¶ˆæ¯tagsCode</div><div class="line"> 46:  * <span class="doctag">@param</span> cqOffset é˜Ÿåˆ—ä½ç½®</div><div class="line"> 47:  * <span class="doctag">@return</span> æ˜¯å¦æˆåŠŸ</div><div class="line"> 48:  */</div><div class="line"> <span class="number">49</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">putMessagePositionInfo</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> offset, <span class="keyword">final</span> <span class="keyword">int</span> size, <span class="keyword">final</span> <span class="keyword">long</span> tagsCode,</span></span></div><div class="line"> <span class="number">50</span>:     <span class="keyword">final</span> <span class="keyword">long</span> cqOffset) &#123;</div><div class="line"> <span class="number">51</span>:     <span class="comment">// å¦‚æœå·²ç»é‡æ”¾è¿‡ï¼Œç›´æ¥è¿”å›æˆåŠŸ</span></div><div class="line"> <span class="number">52</span>:     <span class="keyword">if</span> (offset &lt;= <span class="keyword">this</span>.maxPhysicOffset) &#123;</div><div class="line"> <span class="number">53</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"> <span class="number">54</span>:     &#125;</div><div class="line"> <span class="number">55</span>:     <span class="comment">// å†™å…¥ä½ç½®ä¿¡æ¯åˆ°byteBuffer</span></div><div class="line"> <span class="number">56</span>:     <span class="keyword">this</span>.byteBufferIndex.flip();</div><div class="line"> <span class="number">57</span>:     <span class="keyword">this</span>.byteBufferIndex.limit(CQ_STORE_UNIT_SIZE);</div><div class="line"> <span class="number">58</span>:     <span class="keyword">this</span>.byteBufferIndex.putLong(offset);</div><div class="line"> <span class="number">59</span>:     <span class="keyword">this</span>.byteBufferIndex.putInt(size);</div><div class="line"> <span class="number">60</span>:     <span class="keyword">this</span>.byteBufferIndex.putLong(tagsCode);</div><div class="line"> <span class="number">61</span>:     <span class="comment">// è®¡ç®—consumeQueueå­˜å‚¨ä½ç½®ï¼Œå¹¶è·å¾—å¯¹åº”çš„MappedFile</span></div><div class="line"> <span class="number">62</span>:     <span class="keyword">final</span> <span class="keyword">long</span> expectLogicOffset = cqOffset * CQ_STORE_UNIT_SIZE;</div><div class="line"> <span class="number">63</span>:     MappedFile mappedFile = <span class="keyword">this</span>.mappedFileQueue.getLastMappedFile(expectLogicOffset);</div><div class="line"> <span class="number">64</span>:     <span class="keyword">if</span> (mappedFile != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">65</span>:         <span class="comment">// å½“æ˜¯ConsumeQueueç¬¬ä¸€ä¸ªMappedFile &amp;&amp; é˜Ÿåˆ—ä½ç½®éç¬¬ä¸€ä¸ª &amp;&amp; MappedFileæœªå†™å…¥å†…å®¹ï¼Œåˆ™å¡«å……å‰ç½®ç©ºç™½å ä½</span></div><div class="line"> <span class="number">66</span>:         <span class="keyword">if</span> (mappedFile.isFirstCreateInQueue() &amp;&amp; cqOffset != <span class="number">0</span> &amp;&amp; mappedFile.getWrotePosition() == <span class="number">0</span>) &#123; <span class="comment">// TODO ç–‘é—®ï¼šä¸ºå•¥è¿™ä¸ªæ“ä½œã€‚ç›®å‰èƒ½å¤Ÿæƒ³è±¡åˆ°çš„æ˜¯ï¼Œä¸€äº›è€çš„æ¶ˆæ¯å¾ˆä¹…æ²¡å‘é€ï¼Œçªç„¶å‘é€ï¼Œè¿™ä¸ªæ—¶å€™åˆšå¥½æ»¡è¶³ã€‚</span></div><div class="line"> <span class="number">67</span>:             <span class="keyword">this</span>.minLogicOffset = expectLogicOffset;</div><div class="line"> <span class="number">68</span>:             <span class="keyword">this</span>.mappedFileQueue.setFlushedWhere(expectLogicOffset);</div><div class="line"> <span class="number">69</span>:             <span class="keyword">this</span>.mappedFileQueue.setCommittedWhere(expectLogicOffset);</div><div class="line"> <span class="number">70</span>:             <span class="keyword">this</span>.fillPreBlank(mappedFile, expectLogicOffset);</div><div class="line"> <span class="number">71</span>:             log.info(<span class="string">"fill pre blank space "</span> + mappedFile.getFileName() + <span class="string">" "</span> + expectLogicOffset + <span class="string">" "</span></div><div class="line"> <span class="number">72</span>:                 + mappedFile.getWrotePosition());</div><div class="line"> <span class="number">73</span>:         &#125;</div><div class="line"> <span class="number">74</span>:         <span class="comment">// æ ¡éªŒconsumeQueueå­˜å‚¨ä½ç½®æ˜¯å¦åˆæ³•ã€‚TODO å¦‚æœä¸åˆæ³•ï¼Œç»§ç»­å†™å…¥ä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿ</span></div><div class="line"> <span class="number">75</span>:         <span class="keyword">if</span> (cqOffset != <span class="number">0</span>) &#123;</div><div class="line"> <span class="number">76</span>:             <span class="keyword">long</span> currentLogicOffset = mappedFile.getWrotePosition() + mappedFile.getFileFromOffset();</div><div class="line"> <span class="number">77</span>:             <span class="keyword">if</span> (expectLogicOffset != currentLogicOffset) &#123;</div><div class="line"> <span class="number">78</span>:                 LOG_ERROR.warn(</div><div class="line"> <span class="number">79</span>:                     <span class="string">"[BUG]logic queue order maybe wrong, expectLogicOffset: &#123;&#125; currentLogicOffset: &#123;&#125; Topic: &#123;&#125; QID: &#123;&#125; Diff: &#123;&#125;"</span>,</div><div class="line"> <span class="number">80</span>:                     expectLogicOffset,</div><div class="line"> <span class="number">81</span>:                     currentLogicOffset,</div><div class="line"> <span class="number">82</span>:                     <span class="keyword">this</span>.topic,</div><div class="line"> <span class="number">83</span>:                     <span class="keyword">this</span>.queueId,</div><div class="line"> <span class="number">84</span>:                     expectLogicOffset - currentLogicOffset</div><div class="line"> <span class="number">85</span>:                 );</div><div class="line"> <span class="number">86</span>:             &#125;</div><div class="line"> <span class="number">87</span>:         &#125;</div><div class="line"> <span class="number">88</span>:         <span class="comment">// è®¾ç½®commitLogé‡æ”¾æ¶ˆæ¯åˆ°ConsumeQueueä½ç½®ã€‚</span></div><div class="line"> <span class="number">89</span>:         <span class="keyword">this</span>.maxPhysicOffset = offset;</div><div class="line"> <span class="number">90</span>:         <span class="comment">// æ’å…¥mappedFile</span></div><div class="line"> <span class="number">91</span>:         <span class="keyword">return</span> mappedFile.appendMessage(<span class="keyword">this</span>.byteBufferIndex.array());</div><div class="line"> <span class="number">92</span>:     &#125;</div><div class="line"> <span class="number">93</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"> <span class="number">94</span>: &#125;</div><div class="line"> <span class="number">95</span>: </div><div class="line"> <span class="number">96</span>: <span class="comment">/**</span></div><div class="line"> 97:  * å¡«å……å‰ç½®ç©ºç™½å ä½</div><div class="line"> 98:  *</div><div class="line"> 99:  * <span class="doctag">@param</span> mappedFile MappedFile</div><div class="line">100:  * <span class="doctag">@param</span> untilWhere consumeQueueå­˜å‚¨ä½ç½®</div><div class="line">101:  */</div><div class="line"><span class="number">102</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fillPreBlank</span><span class="params">(<span class="keyword">final</span> MappedFile mappedFile, <span class="keyword">final</span> <span class="keyword">long</span> untilWhere)</span> </span>&#123;</div><div class="line"><span class="number">103</span>:     <span class="comment">// å†™å…¥å‰ç½®ç©ºç™½å ä½åˆ°byteBuffer</span></div><div class="line"><span class="number">104</span>:     ByteBuffer byteBuffer = ByteBuffer.allocate(CQ_STORE_UNIT_SIZE);</div><div class="line"><span class="number">105</span>:     byteBuffer.putLong(<span class="number">0L</span>);</div><div class="line"><span class="number">106</span>:     byteBuffer.putInt(Integer.MAX_VALUE);</div><div class="line"><span class="number">107</span>:     byteBuffer.putLong(<span class="number">0L</span>);</div><div class="line"><span class="number">108</span>:     <span class="comment">// å¾ªç¯å¡«ç©º</span></div><div class="line"><span class="number">109</span>:     <span class="keyword">int</span> until = (<span class="keyword">int</span>) (untilWhere % <span class="keyword">this</span>.mappedFileQueue.getMappedFileSize());</div><div class="line"><span class="number">110</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; until; i += CQ_STORE_UNIT_SIZE) &#123;</div><div class="line"><span class="number">111</span>:         mappedFile.appendMessage(byteBuffer.array());</div><div class="line"><span class="number">112</span>:     &#125;</div><div class="line"><span class="number">113</span>: &#125;</div></pre></td></tr></table></figure><ul><li><code>#putMessagePositionInfoWrapper(...)</code> è¯´æ˜ ï¼šæ·»åŠ ä½ç½®ä¿¡æ¯åˆ° <code>ConsumeQueue</code> çš„å°è£…ï¼Œå®é™…éœ€è¦è°ƒç”¨ <code>#putMessagePositionInfo(...)</code> æ–¹æ³•ã€‚<ul><li>ç¬¬ 13 è¡Œ ï¼šåˆ¤æ–­ <code>ConsumeQueue</code> æ˜¯å¦å…è®¸å†™å…¥ã€‚å½“å‘ç”ŸBugæ—¶ï¼Œä¸å…è®¸å†™å…¥ã€‚</li><li>ç¬¬ 17 è¡Œ ï¼šè°ƒç”¨ <code>#putMessagePositionInfo(...)</code> æ–¹æ³•ï¼Œæ·»åŠ ä½ç½®ä¿¡æ¯ã€‚</li><li>ç¬¬ 18 è‡³ 21 è¡Œ ï¼šæ·»åŠ æˆåŠŸï¼Œä½¿ç”¨æ¶ˆæ¯å­˜å‚¨æ—¶é—´ ä½œä¸º å­˜å‚¨æ£€æŸ¥ç‚¹ã€‚<code>StoreCheckpoint</code> çš„è¯¦ç»†è§£æè§ï¼š<a href="http://www.yunai.me/RocketMQ/store-init-and-shutdown/">Storeåˆå§‹åŒ–ä¸å…³é—­</a>ã€‚</li><li>ç¬¬ 22 è‡³ 32 è¡Œ ï¼šæ·»åŠ å¤±è´¥ï¼Œç›®å‰åŸºæœ¬å¯ä»¥è®¤ä¸ºæ˜¯BUGã€‚</li><li>ç¬¬ 35 è‡³ 37 è¡Œ ï¼šå†™å…¥å¤±è´¥æ—¶ï¼Œæ ‡è®° <code>ConsumeQueue</code> å†™å…¥å¼‚å¸¸ï¼Œä¸å…è®¸ç»§ç»­å†™å…¥ã€‚</li></ul></li><li><code>#putMessagePositionInfo(...)</code> è¯´æ˜ ï¼šæ·»åŠ ä½ç½®ä¿¡æ¯åˆ° <code>ConsumeQueue</code>ï¼Œå¹¶è¿”å›æ·»åŠ æ˜¯å¦æˆåŠŸã€‚<ul><li>ç¬¬ 51 è‡³ 54 è¡Œ ï¼šå¦‚æœ <code>offset</code>(å­˜å‚¨ä½ç½®) å°äºç­‰äº <code>maxPhysicOffset</code>(<code>CommitLog</code> æ¶ˆæ¯é‡æ”¾åˆ° <code>ConsumeQueue</code> æœ€å¤§çš„ <code>CommitLog</code> å­˜å‚¨ä½ç½®)ï¼Œè¡¨ç¤ºå·²ç»é‡æ”¾è¿‡ï¼Œæ­¤æ—¶ï¼Œä¸å†é‡å¤å†™å…¥ï¼Œç›´æ¥è¿”å›å†™å…¥æˆåŠŸã€‚</li><li>ç¬¬ 55 è‡³ 60 è¡Œ ï¼šå†™ ä½ç½®ä¿¡æ¯åˆ°byteBufferã€‚</li><li>ç¬¬ 62 è‡³ 63 è¡Œ ï¼šè®¡ç®— <code>ConsumeQueue</code>å­˜å‚¨ä½ç½®ï¼Œå¹¶è·å¾—å¯¹åº”çš„MappedFileã€‚</li><li>ç¬¬ 65 è‡³ 73 è¡Œ ï¼šå½“ <code>MappedFile</code> æ˜¯ <code>ConsumeQueue</code> å½“å‰ç¬¬ä¸€ä¸ªæ–‡ä»¶ &amp;&amp; <code>MappedFile</code> æœªå†™å…¥å†…å®¹ &amp;&amp; é‡æ”¾æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å¤§äº0ï¼Œåˆ™éœ€è¦è¿›è¡Œ <code>MappedFile</code> å¡«å……å‰ç½® <code>BLANK</code>ã€‚<ul><li><em>è¿™å—æ¯”è¾ƒæœ‰ç–‘é—®ï¼Œä»€ä¹ˆåœºæ™¯ä¸‹ä¼šéœ€è¦ã€‚çŒœæµ‹äº§ç”Ÿçš„åŸå› ï¼šä¸€ä¸ª <code>Topic</code> é•¿æœŸæ— æ¶ˆæ¯äº§ç”Ÿï¼Œçªç„¶Nå¤©åè¿›è¡Œå‘é€ï¼Œ<code>Topic</code> å¯¹åº”çš„å†å²æ¶ˆæ¯ä»¥åŠå’Œæ¶ˆè´¹é˜Ÿåˆ—æ•°æ®å·²ç»è¢«æ¸…ç†ï¼Œæ–°ç”Ÿæˆçš„<code>MappedFile</code>éœ€è¦å‰ç½®å ä½ã€‚</em></li></ul></li><li>ç¬¬ 74 è‡³ 87 è¡Œ ï¼šæ ¡éªŒ <code>ConsumeQueue</code> å­˜å‚¨ä½ç½®æ˜¯å¦åˆæ³•ï¼Œä¸åˆæ³•åˆ™è¾“å‡ºæ—¥å¿—ã€‚<ul><li><em>è¿™å—æ¯”è¾ƒæœ‰ç–‘é—®ï¼Œå¦‚æœè®¡ç®—å‡ºæ¥çš„å­˜å‚¨ä½ç½®ä¸åˆæ³•ï¼Œä¸è¿”å›æ·»åŠ å¤±è´¥ï¼Œç»§ç»­è¿›è¡Œæ·»åŠ ä½ç½®ä¿¡æ¯ï¼Œä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿï¼Ÿï¼Ÿ</em></li></ul></li><li>ç¬¬ 89 è¡Œ ï¼šè®¾ç½® <code>CommitLog</code> é‡æ”¾æ¶ˆæ¯åˆ° <code>ConsumeQueue</code> çš„æœ€å¤§ä½ç½®ã€‚</li><li>ç¬¬ 91 è¡Œ ï¼šæ’å…¥æ¶ˆæ¯ä½ç½®åˆ° <code>MappedFile</code>ã€‚</li></ul></li></ul><h2 id="FlushConsumeQueueService"><a href="#FlushConsumeQueueService" class="headerlink" title="FlushConsumeQueueService"></a>FlushConsumeQueueService</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="class"><span class="keyword">class</span> <span class="title">FlushConsumeQueueService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RETRY_TIMES_OVER = <span class="number">3</span>;</div><div class="line"> <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"> 4:      * æœ€åflushæ—¶é—´æˆ³</div><div class="line"> 5:      */</div><div class="line"> <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">long</span> lastFlushTimestamp = <span class="number">0</span>;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doFlush</span><span class="params">(<span class="keyword">int</span> retryTimes)</span> </span>&#123;</div><div class="line"> <span class="number">9</span>:         <span class="keyword">int</span> flushConsumeQueueLeastPages = DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getFlushConsumeQueueLeastPages();</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>:         <span class="comment">// retryTimes == RETRY_TIMES_OVERæ—¶ï¼Œè¿›è¡Œå¼ºåˆ¶flushã€‚ä¸»è¦ç”¨äºshutdownæ—¶ã€‚</span></div><div class="line"><span class="number">12</span>:         <span class="keyword">if</span> (retryTimes == RETRY_TIMES_OVER) &#123;</div><div class="line"><span class="number">13</span>:             flushConsumeQueueLeastPages = <span class="number">0</span>;</div><div class="line"><span class="number">14</span>:         &#125;</div><div class="line"><span class="number">15</span>:         <span class="comment">// å½“æ—¶é—´æ»¡è¶³flushConsumeQueueThoroughIntervalæ—¶ï¼Œå³ä½¿å†™å…¥çš„æ•°é‡ä¸è¶³flushConsumeQueueLeastPagesï¼Œä¹Ÿè¿›è¡Œflush</span></div><div class="line"><span class="number">16</span>:         <span class="keyword">long</span> logicsMsgTimestamp = <span class="number">0</span>;</div><div class="line"><span class="number">17</span>:         <span class="keyword">int</span> flushConsumeQueueThoroughInterval = DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getFlushConsumeQueueThoroughInterval();</div><div class="line"><span class="number">18</span>:         <span class="keyword">long</span> currentTimeMillis = System.currentTimeMillis();</div><div class="line"><span class="number">19</span>:         <span class="keyword">if</span> (currentTimeMillis &gt;= (<span class="keyword">this</span>.lastFlushTimestamp + flushConsumeQueueThoroughInterval)) &#123;</div><div class="line"><span class="number">20</span>:             <span class="keyword">this</span>.lastFlushTimestamp = currentTimeMillis;</div><div class="line"><span class="number">21</span>:             flushConsumeQueueLeastPages = <span class="number">0</span>;</div><div class="line"><span class="number">22</span>:             logicsMsgTimestamp = DefaultMessageStore.<span class="keyword">this</span>.getStoreCheckpoint().getLogicsMsgTimestamp();</div><div class="line"><span class="number">23</span>:         &#125;</div><div class="line"><span class="number">24</span>:         <span class="comment">// flushæ¶ˆè´¹é˜Ÿåˆ—</span></div><div class="line"><span class="number">25</span>:         ConcurrentHashMap&lt;String, ConcurrentHashMap&lt;Integer, ConsumeQueue&gt;&gt; tables = DefaultMessageStore.<span class="keyword">this</span>.consumeQueueTable;</div><div class="line"><span class="number">26</span>:         <span class="keyword">for</span> (ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; maps : tables.values()) &#123;</div><div class="line"><span class="number">27</span>:             <span class="keyword">for</span> (ConsumeQueue cq : maps.values()) &#123;</div><div class="line"><span class="number">28</span>:                 <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line"><span class="number">29</span>:                 <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; retryTimes &amp;&amp; !result; i++) &#123;</div><div class="line"><span class="number">30</span>:                     result = cq.flush(flushConsumeQueueLeastPages);</div><div class="line"><span class="number">31</span>:                 &#125;</div><div class="line"><span class="number">32</span>:             &#125;</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:         <span class="comment">// flush å­˜å‚¨ check point</span></div><div class="line"><span class="number">35</span>:         <span class="keyword">if</span> (<span class="number">0</span> == flushConsumeQueueLeastPages) &#123;</div><div class="line"><span class="number">36</span>:             <span class="keyword">if</span> (logicsMsgTimestamp &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">37</span>:                 DefaultMessageStore.<span class="keyword">this</span>.getStoreCheckpoint().setLogicsMsgTimestamp(logicsMsgTimestamp);</div><div class="line"><span class="number">38</span>:             &#125;</div><div class="line"><span class="number">39</span>:             DefaultMessageStore.<span class="keyword">this</span>.getStoreCheckpoint().flush();</div><div class="line"><span class="number">40</span>:         &#125;</div><div class="line"><span class="number">41</span>:     &#125;</div><div class="line"><span class="number">42</span>: </div><div class="line"><span class="number">43</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">44</span>:         DefaultMessageStore.log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service started"</span>);</div><div class="line"><span class="number">45</span>: </div><div class="line"><span class="number">46</span>:         <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</div><div class="line"><span class="number">47</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">48</span>:                 <span class="keyword">int</span> interval = DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getFlushIntervalConsumeQueue();</div><div class="line"><span class="number">49</span>:                 <span class="keyword">this</span>.waitForRunning(interval);</div><div class="line"><span class="number">50</span>:                 <span class="keyword">this</span>.doFlush(<span class="number">1</span>);</div><div class="line"><span class="number">51</span>:             &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">52</span>:                 DefaultMessageStore.log.warn(<span class="keyword">this</span>.getServiceName() + <span class="string">" service has exception. "</span>, e);</div><div class="line"><span class="number">53</span>:             &#125;</div><div class="line"><span class="number">54</span>:         &#125;</div><div class="line"><span class="number">55</span>: </div><div class="line"><span class="number">56</span>:         <span class="keyword">this</span>.doFlush(RETRY_TIMES_OVER);</div><div class="line"><span class="number">57</span>: </div><div class="line"><span class="number">58</span>:         DefaultMessageStore.log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service end"</span>);</div><div class="line"><span class="number">59</span>:     &#125;</div><div class="line"><span class="number">60</span>: </div><div class="line"><span class="number">61</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">62</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getServiceName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">63</span>:         <span class="keyword">return</span> FlushConsumeQueueService.class.getSimpleName();</div><div class="line"><span class="number">64</span>:     &#125;</div><div class="line"><span class="number">65</span>: </div><div class="line"><span class="number">66</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">67</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getJointime</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">68</span>:         <span class="keyword">return</span> <span class="number">1000</span> * <span class="number">60</span>;</div><div class="line"><span class="number">69</span>:     &#125;</div><div class="line"><span class="number">70</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šflush <code>ConsumeQueue</code>(æ¶ˆè´¹é˜Ÿåˆ—) çº¿ç¨‹æœåŠ¡ã€‚</li><li>ç¬¬ 11 è‡³ 14 è¡Œ ï¼šå½“ <code>retryTimes == RETRY_TIMES_OVER</code> æ—¶ï¼Œè¿›è¡Œå¼ºåˆ¶flushã€‚ç”¨äº <code>shutdown</code> æ—¶ã€‚</li><li>ç¬¬ 15 è‡³ 23 è¡Œ ï¼šæ¯ flushConsumeQueueThoroughInterval å‘¨æœŸï¼Œæ‰§è¡Œä¸€æ¬¡ flush ã€‚å› ä¸ºä¸æ˜¯æ¯æ¬¡å¾ªç¯åˆ°éƒ½èƒ½æ»¡è¶³ flushConsumeQueueLeastPages å¤§å°ï¼Œå› æ­¤ï¼Œéœ€è¦ä¸€å®šå‘¨æœŸè¿›è¡Œä¸€æ¬¡å¼ºåˆ¶ flush ã€‚å½“ç„¶ï¼Œä¸èƒ½æ¯æ¬¡å¾ªç¯éƒ½å»æ‰§è¡Œå¼ºåˆ¶ flushï¼Œè¿™æ ·æ€§èƒ½è¾ƒå·®ã€‚</li><li>ç¬¬ 24 è‡³ 33 è¡Œ ï¼šflush <code>ConsumeQueue</code>(æ¶ˆè´¹é˜Ÿåˆ—)ã€‚<ul><li>flush é€»è¾‘ï¼š<a href="http://www.yunai.me/RocketMQ/message-store/#MappedFile-è½ç›˜">MappedFile#è½ç›˜</a>ã€‚</li></ul></li><li>ç¬¬ 34 è‡³ 40 è¡Œ ï¼šflush <code>StoreCheckpoint</code>ã€‚<code>StoreCheckpoint</code> çš„è¯¦ç»†è§£æè§ï¼š<a href="http://www.yunai.me/RocketMQ/store-init-and-shutdown/">Storeåˆå§‹åŒ–ä¸å…³é—­</a>ã€‚</li><li>ç¬¬ 43 è‡³ 59 è¡Œ ï¼šæ¯ 1000ms æ‰§è¡Œä¸€æ¬¡ <code>flush</code>ã€‚å¦‚æœ wakeup() æ—¶ï¼Œåˆ™ä¼šç«‹å³è¿›è¡Œä¸€æ¬¡ <code>flush</code>ã€‚ç›®å‰ï¼Œæš‚æ—¶ä¸å­˜åœ¨ wakeup() çš„è°ƒç”¨ã€‚</li></ul><h1 id="4ã€Broker-æä¾›-æ‹‰å–æ¶ˆæ¯-æ¥å£"><a href="#4ã€Broker-æä¾›-æ‹‰å–æ¶ˆæ¯-æ¥å£" class="headerlink" title="4ã€Broker æä¾›[æ‹‰å–æ¶ˆæ¯]æ¥å£"></a>4ã€Broker æä¾›[æ‹‰å–æ¶ˆæ¯]æ¥å£</h1><h2 id="PullMessageRequestHeader"><a href="#PullMessageRequestHeader" class="headerlink" title="PullMessageRequestHeader"></a>PullMessageRequestHeader</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PullMessageRequestHeader</span> <span class="keyword">implements</span> <span class="title">CommandCustomHeader</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">/**</span></div><div class="line"> 3:      * æ¶ˆè´¹è€…åˆ†ç»„</div><div class="line"> 4:      */</div><div class="line"> <span class="number">5</span>:     <span class="meta">@CFNotNull</span></div><div class="line"> <span class="number">6</span>:     <span class="keyword">private</span> String consumerGroup;</div><div class="line"> <span class="number">7</span>:     <span class="comment">/**</span></div><div class="line"> 8:      * Topic</div><div class="line"> 9:      */</div><div class="line"><span class="number">10</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">11</span>:     <span class="keyword">private</span> String topic;</div><div class="line"><span class="number">12</span>:     <span class="comment">/**</span></div><div class="line">13:      * é˜Ÿåˆ—ç¼–å·</div><div class="line">14:      */</div><div class="line"><span class="number">15</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">16</span>:     <span class="keyword">private</span> Integer queueId;</div><div class="line"><span class="number">17</span>:     <span class="comment">/**</span></div><div class="line">18:      * é˜Ÿåˆ—å¼€å§‹ä½ç½®</div><div class="line">19:      */</div><div class="line"><span class="number">20</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">21</span>:     <span class="keyword">private</span> Long queueOffset;</div><div class="line"><span class="number">22</span>:     <span class="comment">/**</span></div><div class="line">23:      * æ¶ˆæ¯æ•°é‡</div><div class="line">24:      */</div><div class="line"><span class="number">25</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">26</span>:     <span class="keyword">private</span> Integer maxMsgNums;</div><div class="line"><span class="number">27</span>:     <span class="comment">/**</span></div><div class="line">28:      * ç³»ç»Ÿæ ‡è¯†</div><div class="line">29:      */</div><div class="line"><span class="number">30</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">31</span>:     <span class="keyword">private</span> Integer sysFlag;</div><div class="line"><span class="number">32</span>:     <span class="comment">/**</span></div><div class="line">33:      * æäº¤æ¶ˆè´¹è¿›åº¦ä½ç½®</div><div class="line">34:      */</div><div class="line"><span class="number">35</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">36</span>:     <span class="keyword">private</span> Long commitOffset;</div><div class="line"><span class="number">37</span>:     <span class="comment">/**</span></div><div class="line">38:      * æŒ‚èµ·è¶…æ—¶æ—¶é—´</div><div class="line">39:      */</div><div class="line"><span class="number">40</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">41</span>:     <span class="keyword">private</span> Long suspendTimeoutMillis;</div><div class="line"><span class="number">42</span>:     <span class="comment">/**</span></div><div class="line">43:      * è®¢é˜…è¡¨è¾¾å¼</div><div class="line">44:      */</div><div class="line"><span class="number">45</span>:     <span class="meta">@CFNullable</span></div><div class="line"><span class="number">46</span>:     <span class="keyword">private</span> String subscription;</div><div class="line"><span class="number">47</span>:     <span class="comment">/**</span></div><div class="line">48:      * è®¢é˜…ç‰ˆæœ¬å·</div><div class="line">49:      */</div><div class="line"><span class="number">50</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">51</span>:     <span class="keyword">private</span> Long subVersion;</div><div class="line"><span class="number">52</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ï¼šæ‹‰å–æ¶ˆæ¯è¯·æ±‚Header</li><li>topic + queueId + queueOffset + maxMsgNums</li><li>sysFlag ï¼šç³»ç»Ÿæ ‡è¯†ã€‚<ul><li>ç¬¬ 0 ä½ <code>FLAG_COMMIT_OFFSET</code> ï¼šæ ‡è®°è¯·æ±‚æäº¤æ¶ˆè´¹è¿›åº¦ä½ç½®ï¼Œå’Œ <code>commitOffset</code> é…åˆã€‚</li><li>ç¬¬ 1 ä½ <code>FLAG_SUSPEND</code> ï¼šæ ‡è®°è¯·æ±‚æ˜¯å¦æŒ‚èµ·è¯·æ±‚ï¼Œå’Œ <code>suspendTimeoutMillis</code> é…åˆã€‚å½“æ‹‰å–ä¸åˆ°æ¶ˆæ¯æ—¶ï¼Œ <code>Broker</code> ä¼šæŒ‚èµ·è¯·æ±‚ï¼Œç›´åˆ°æœ‰æ¶ˆæ¯ã€‚æœ€å¤§æŒ‚èµ·æ—¶é—´ï¼š<code>suspendTimeoutMillis</code> æ¯«ç§’ã€‚</li><li>ç¬¬ 2 ä½ <code>FLAG_SUBSCRIPTION</code> ï¼šæ˜¯å¦è¿‡æ»¤è®¢é˜…è¡¨è¾¾å¼ï¼Œå’Œ <code>subscription</code> é…ç½®ã€‚</li></ul></li><li>subVersion ï¼šè®¢é˜…ç‰ˆæœ¬å·ã€‚è¯·æ±‚æ—¶ï¼Œå¦‚æœç‰ˆæœ¬å·ä¸å¯¹ï¼Œåˆ™æ— æ³•æ‹‰å–åˆ°æ¶ˆæ¯ï¼Œéœ€è¦é‡æ–°è·å–è®¢é˜…ä¿¡æ¯ï¼Œä½¿ç”¨æœ€æ–°çš„è®¢é˜…ç‰ˆæœ¬å·ã€‚</li></ul><h2 id="PullMessageProcessor-processRequest-â€¦"><a href="#PullMessageProcessor-processRequest-â€¦" class="headerlink" title="PullMessageProcessor#processRequest(â€¦)"></a>PullMessageProcessor#processRequest(â€¦)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> RemotingCommand <span class="title">processRequest</span><span class="params">(<span class="keyword">final</span> Channel channel, RemotingCommand request, <span class="keyword">boolean</span> brokerAllowSuspend)</span></span></div><div class="line">  2:     <span class="keyword">throws</span> RemotingCommandException &#123;</div><div class="line">  <span class="number">3</span>:     RemotingCommand response = RemotingCommand.createResponseCommand(PullMessageResponseHeader.class);</div><div class="line">  <span class="number">4</span>:     <span class="keyword">final</span> PullMessageResponseHeader responseHeader = (PullMessageResponseHeader) response.readCustomHeader();</div><div class="line">  <span class="number">5</span>:     <span class="keyword">final</span> PullMessageRequestHeader requestHeader =</div><div class="line">  <span class="number">6</span>:         (PullMessageRequestHeader) request.decodeCommandCustomHeader(PullMessageRequestHeader.class);</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:     response.setOpaque(request.getOpaque());</div><div class="line">  <span class="number">9</span>: </div><div class="line"> <span class="number">10</span>:     <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</div><div class="line"> <span class="number">11</span>:         LOG.debug(<span class="string">"receive PullMessage request command, &#123;&#125;"</span>, request);</div><div class="line"> <span class="number">12</span>:     &#125;</div><div class="line"> <span class="number">13</span>: </div><div class="line"> <span class="number">14</span>:     <span class="comment">// æ ¡éªŒ broker æ˜¯å¦å¯è¯»</span></div><div class="line"> <span class="number">15</span>:     <span class="keyword">if</span> (!PermName.isReadable(<span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerPermission())) &#123;</div><div class="line"> <span class="number">16</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"> <span class="number">17</span>:         response.setRemark(String.format(<span class="string">"the broker[%s] pulling message is forbidden"</span>, <span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerIP1()));</div><div class="line"> <span class="number">18</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">19</span>:     &#125;</div><div class="line"> <span class="number">20</span>: </div><div class="line"> <span class="number">21</span>:     <span class="comment">// æ ¡éªŒ consumeråˆ†ç»„é…ç½® æ˜¯å¦å­˜åœ¨</span></div><div class="line"> <span class="number">22</span>:     SubscriptionGroupConfig subscriptionGroupConfig = <span class="keyword">this</span>.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(requestHeader.getConsumerGroup());</div><div class="line"> <span class="number">23</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == subscriptionGroupConfig) &#123;</div><div class="line"> <span class="number">24</span>:         response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);</div><div class="line"> <span class="number">25</span>:         response.setRemark(String.format(<span class="string">"subscription group [%s] does not exist, %s"</span>, requestHeader.getConsumerGroup(), FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST)));</div><div class="line"> <span class="number">26</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">27</span>:     &#125;</div><div class="line"> <span class="number">28</span>:     <span class="comment">// æ ¡éªŒ consumeråˆ†ç»„é…ç½® æ˜¯å¦å¯æ¶ˆè´¹</span></div><div class="line"> <span class="number">29</span>:     <span class="keyword">if</span> (!subscriptionGroupConfig.isConsumeEnable()) &#123;</div><div class="line"> <span class="number">30</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"> <span class="number">31</span>:         response.setRemark(<span class="string">"subscription group no permission, "</span> + requestHeader.getConsumerGroup());</div><div class="line"> <span class="number">32</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">33</span>:     &#125;</div><div class="line"> <span class="number">34</span>: </div><div class="line"> <span class="number">35</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> hasSuspendFlag = PullSysFlag.hasSuspendFlag(requestHeader.getSysFlag()); <span class="comment">// æ˜¯å¦æŒ‚èµ·è¯·æ±‚ï¼Œå½“æ²¡æœ‰æ¶ˆæ¯æ—¶</span></div><div class="line"> <span class="number">36</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> hasCommitOffsetFlag = PullSysFlag.hasCommitOffsetFlag(requestHeader.getSysFlag()); <span class="comment">// æ˜¯å¦æäº¤æ¶ˆè´¹è¿›åº¦</span></div><div class="line"> <span class="number">37</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> hasSubscriptionFlag = PullSysFlag.hasSubscriptionFlag(requestHeader.getSysFlag()); <span class="comment">// æ˜¯å¦è¿‡æ»¤è®¢é˜…è¡¨è¾¾å¼(subscription)</span></div><div class="line"> <span class="number">38</span>:     <span class="keyword">final</span> <span class="keyword">long</span> suspendTimeoutMillisLong = hasSuspendFlag ? requestHeader.getSuspendTimeoutMillis() : <span class="number">0</span>; <span class="comment">// æŒ‚èµ·è¯·æ±‚è¶…æ—¶æ—¶é•¿</span></div><div class="line"> <span class="number">39</span>: </div><div class="line"> <span class="number">40</span>:     <span class="comment">// æ ¡éªŒ topicé…ç½® å­˜åœ¨</span></div><div class="line"> <span class="number">41</span>:     TopicConfig topicConfig = <span class="keyword">this</span>.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());</div><div class="line"> <span class="number">42</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == topicConfig) &#123;</div><div class="line"> <span class="number">43</span>:         LOG.error(<span class="string">"The topic &#123;&#125; not exist, consumer: &#123;&#125; "</span>, requestHeader.getTopic(), RemotingHelper.parseChannelRemoteAddr(channel));</div><div class="line"> <span class="number">44</span>:         response.setCode(ResponseCode.TOPIC_NOT_EXIST);</div><div class="line"> <span class="number">45</span>:         response.setRemark(String.format(<span class="string">"topic[%s] not exist, apply first please! %s"</span>, requestHeader.getTopic(), FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL)));</div><div class="line"> <span class="number">46</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">47</span>:     &#125;</div><div class="line"> <span class="number">48</span>:     <span class="comment">// æ ¡éªŒ topicé…ç½® æƒé™å¯è¯»</span></div><div class="line"> <span class="number">49</span>:     <span class="keyword">if</span> (!PermName.isReadable(topicConfig.getPerm())) &#123;</div><div class="line"> <span class="number">50</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"> <span class="number">51</span>:         response.setRemark(<span class="string">"the topic["</span> + requestHeader.getTopic() + <span class="string">"] pulling message is forbidden"</span>);</div><div class="line"> <span class="number">52</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">53</span>:     &#125;</div><div class="line"> <span class="number">54</span>:     <span class="comment">// æ ¡éªŒ è¯»å–é˜Ÿåˆ— åœ¨ topicé…ç½® é˜Ÿåˆ—èŒƒå›´å†…</span></div><div class="line"> <span class="number">55</span>:     <span class="keyword">if</span> (requestHeader.getQueueId() &lt; <span class="number">0</span> || requestHeader.getQueueId() &gt;= topicConfig.getReadQueueNums()) &#123;</div><div class="line"> <span class="number">56</span>:         String errorInfo = String.format(<span class="string">"queueId[%d] is illegal, topic:[%s] topicConfig.readQueueNums:[%d] consumer:[%s]"</span>,</div><div class="line"> <span class="number">57</span>:                 requestHeader.getQueueId(), requestHeader.getTopic(), topicConfig.getReadQueueNums(), channel.remoteAddress());</div><div class="line"> <span class="number">58</span>:         LOG.warn(errorInfo);</div><div class="line"> <span class="number">59</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"> <span class="number">60</span>:         response.setRemark(errorInfo);</div><div class="line"> <span class="number">61</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">62</span>:     &#125;</div><div class="line"> <span class="number">63</span>: </div><div class="line"> <span class="number">64</span>:     <span class="comment">// æ ¡éªŒ è®¢é˜…å…³ç³»</span></div><div class="line"> <span class="number">65</span>:     SubscriptionData subscriptionData;</div><div class="line"> <span class="number">66</span>:     <span class="keyword">if</span> (hasSubscriptionFlag) &#123;</div><div class="line"> <span class="number">67</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">68</span>:             subscriptionData = FilterAPI.buildSubscriptionData(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class="line"> <span class="number">69</span>:                 requestHeader.getSubscription());</div><div class="line"> <span class="number">70</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">71</span>:             LOG.warn(<span class="string">"Parse the consumer's subscription[&#123;&#125;] failed, group: &#123;&#125;"</span>, requestHeader.getSubscription(), <span class="comment">//</span></div><div class="line"> <span class="number">72</span>:                     requestHeader.getConsumerGroup());</div><div class="line"> <span class="number">73</span>:             response.setCode(ResponseCode.SUBSCRIPTION_PARSE_FAILED);</div><div class="line"> <span class="number">74</span>:             response.setRemark(<span class="string">"parse the consumer's subscription failed"</span>);</div><div class="line"> <span class="number">75</span>:             <span class="keyword">return</span> response;</div><div class="line"> <span class="number">76</span>:         &#125;</div><div class="line"> <span class="number">77</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">78</span>:         <span class="comment">// æ ¡éªŒ æ¶ˆè´¹åˆ†ç»„ä¿¡æ¯ æ˜¯å¦å­˜åœ¨</span></div><div class="line"> <span class="number">79</span>:         ConsumerGroupInfo consumerGroupInfo = <span class="keyword">this</span>.brokerController.getConsumerManager().getConsumerGroupInfo(requestHeader.getConsumerGroup());</div><div class="line"> <span class="number">80</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == consumerGroupInfo) &#123;</div><div class="line"> <span class="number">81</span>:             LOG.warn(<span class="string">"The consumer's group info not exist, group: &#123;&#125;"</span>, requestHeader.getConsumerGroup());</div><div class="line"> <span class="number">82</span>:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_EXIST);</div><div class="line"> <span class="number">83</span>:             response.setRemark(<span class="string">"the consumer's group info not exist"</span> + FAQUrl.suggestTodo(FAQUrl.SAME_GROUP_DIFFERENT_TOPIC));</div><div class="line"> <span class="number">84</span>:             <span class="keyword">return</span> response;</div><div class="line"> <span class="number">85</span>:         &#125;</div><div class="line"> <span class="number">86</span>:         <span class="comment">// æ ¡éªŒ æ¶ˆè´¹åˆ†ç»„ä¿¡æ¯ æ¶ˆæ¯æ¨¡å‹æ˜¯å¦åŒ¹é…</span></div><div class="line"> <span class="number">87</span>:         <span class="keyword">if</span> (!subscriptionGroupConfig.isConsumeBroadcastEnable() <span class="comment">//</span></div><div class="line"> <span class="number">88</span>:             &amp;&amp; consumerGroupInfo.getMessageModel() == MessageModel.BROADCASTING) &#123;</div><div class="line"> <span class="number">89</span>:             response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"> <span class="number">90</span>:             response.setRemark(<span class="string">"the consumer group["</span> + requestHeader.getConsumerGroup() + <span class="string">"] can not consume by broadcast way"</span>);</div><div class="line"> <span class="number">91</span>:             <span class="keyword">return</span> response;</div><div class="line"> <span class="number">92</span>:         &#125;</div><div class="line"> <span class="number">93</span>: </div><div class="line"> <span class="number">94</span>:         <span class="comment">// æ ¡éªŒ è®¢é˜…ä¿¡æ¯ æ˜¯å¦å­˜åœ¨</span></div><div class="line"> <span class="number">95</span>:         subscriptionData = consumerGroupInfo.findSubscriptionData(requestHeader.getTopic());</div><div class="line"> <span class="number">96</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == subscriptionData) &#123;</div><div class="line"> <span class="number">97</span>:             LOG.warn(<span class="string">"The consumer's subscription not exist, group: &#123;&#125;, topic:&#123;&#125;"</span>, requestHeader.getConsumerGroup(), requestHeader.getTopic());</div><div class="line"> <span class="number">98</span>:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_EXIST);</div><div class="line"> <span class="number">99</span>:             response.setRemark(<span class="string">"the consumer's subscription not exist"</span> + FAQUrl.suggestTodo(FAQUrl.SAME_GROUP_DIFFERENT_TOPIC));</div><div class="line"><span class="number">100</span>:             <span class="keyword">return</span> response;</div><div class="line"><span class="number">101</span>:         &#125;</div><div class="line"><span class="number">102</span>:         <span class="comment">// æ ¡éªŒ è®¢é˜…ä¿¡æ¯ç‰ˆæœ¬ æ˜¯å¦åˆæ³•</span></div><div class="line"><span class="number">103</span>:         <span class="keyword">if</span> (subscriptionData.getSubVersion() &lt; requestHeader.getSubVersion()) &#123;</div><div class="line"><span class="number">104</span>:             LOG.warn(<span class="string">"The broker's subscription is not latest, group: &#123;&#125; &#123;&#125;"</span>, requestHeader.getConsumerGroup(),</div><div class="line"><span class="number">105</span>:                     subscriptionData.getSubString());</div><div class="line"><span class="number">106</span>:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_LATEST);</div><div class="line"><span class="number">107</span>:             response.setRemark(<span class="string">"the consumer's subscription not latest"</span>);</div><div class="line"><span class="number">108</span>:             <span class="keyword">return</span> response;</div><div class="line"><span class="number">109</span>:         &#125;</div><div class="line"><span class="number">110</span>:     &#125;</div><div class="line"><span class="number">111</span>: </div><div class="line"><span class="number">112</span>:     <span class="comment">// è·å–æ¶ˆæ¯</span></div><div class="line"><span class="number">113</span>:     <span class="keyword">final</span> GetMessageResult getMessageResult = <span class="keyword">this</span>.brokerController.getMessageStore().getMessage(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class="line"><span class="number">114</span>:             requestHeader.getQueueId(), requestHeader.getQueueOffset(), requestHeader.getMaxMsgNums(), subscriptionData);</div><div class="line"><span class="number">115</span>:     <span class="keyword">if</span> (getMessageResult != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">116</span>:         response.setRemark(getMessageResult.getStatus().name());</div><div class="line"><span class="number">117</span>:         responseHeader.setNextBeginOffset(getMessageResult.getNextBeginOffset());</div><div class="line"><span class="number">118</span>:         responseHeader.setMinOffset(getMessageResult.getMinOffset());</div><div class="line"><span class="number">119</span>:         responseHeader.setMaxOffset(getMessageResult.getMaxOffset());</div><div class="line"><span class="number">120</span>: </div><div class="line"><span class="number">121</span>:         <span class="comment">// TODO å¾…è¯»</span></div><div class="line"><span class="number">122</span>:         <span class="comment">// è®¡ç®—å»ºè®®è¯»å–brokerId</span></div><div class="line"><span class="number">123</span>:         <span class="keyword">if</span> (getMessageResult.isSuggestPullingFromSlave()) &#123;</div><div class="line"><span class="number">124</span>:             responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getWhichBrokerWhenConsumeSlowly());</div><div class="line"><span class="number">125</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">126</span>:             responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</div><div class="line"><span class="number">127</span>:         &#125;</div><div class="line"><span class="number">128</span>: </div><div class="line"><span class="number">129</span>:         <span class="keyword">switch</span> (<span class="keyword">this</span>.brokerController.getMessageStoreConfig().getBrokerRole()) &#123;</div><div class="line"><span class="number">130</span>:             <span class="keyword">case</span> ASYNC_MASTER:</div><div class="line"><span class="number">131</span>:             <span class="keyword">case</span> SYNC_MASTER:</div><div class="line"><span class="number">132</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">133</span>:             <span class="keyword">case</span> SLAVE:</div><div class="line"><span class="number">134</span>:                 <span class="keyword">if</span> (!<span class="keyword">this</span>.brokerController.getBrokerConfig().isSlaveReadEnable()) &#123; <span class="comment">// ä»èŠ‚ç‚¹ä¸å…è®¸è¯»å–ï¼Œå‘Šè¯‰consumerè¯»å–ä¸»èŠ‚ç‚¹ã€‚</span></div><div class="line"><span class="number">135</span>:                     response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class="line"><span class="number">136</span>:                     responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</div><div class="line"><span class="number">137</span>:                 &#125;</div><div class="line"><span class="number">138</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">139</span>:         &#125;</div><div class="line"><span class="number">140</span>: </div><div class="line"><span class="number">141</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getBrokerConfig().isSlaveReadEnable()) &#123;</div><div class="line"><span class="number">142</span>:             <span class="comment">// consume too slow ,redirect to another machine</span></div><div class="line"><span class="number">143</span>:             <span class="keyword">if</span> (getMessageResult.isSuggestPullingFromSlave()) &#123;</div><div class="line"><span class="number">144</span>:                 responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getWhichBrokerWhenConsumeSlowly());</div><div class="line"><span class="number">145</span>:             &#125;</div><div class="line"><span class="number">146</span>:             <span class="comment">// consume ok</span></div><div class="line"><span class="number">147</span>:             <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">148</span>:                 responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getBrokerId());</div><div class="line"><span class="number">149</span>:             &#125;</div><div class="line"><span class="number">150</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">151</span>:             responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</div><div class="line"><span class="number">152</span>:         &#125;</div><div class="line"><span class="number">153</span>: </div><div class="line"><span class="number">154</span>:         <span class="keyword">switch</span> (getMessageResult.getStatus()) &#123;</div><div class="line"><span class="number">155</span>:             <span class="keyword">case</span> FOUND:</div><div class="line"><span class="number">156</span>:                 response.setCode(ResponseCode.SUCCESS);</div><div class="line"><span class="number">157</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">158</span>:             <span class="keyword">case</span> MESSAGE_WAS_REMOVING:</div><div class="line"><span class="number">159</span>:                 response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class="line"><span class="number">160</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">161</span>:             <span class="keyword">case</span> NO_MATCHED_LOGIC_QUEUE:</div><div class="line"><span class="number">162</span>:             <span class="keyword">case</span> NO_MESSAGE_IN_QUEUE:</div><div class="line"><span class="number">163</span>:                 <span class="keyword">if</span> (<span class="number">0</span> != requestHeader.getQueueOffset()) &#123;</div><div class="line"><span class="number">164</span>:                     response.setCode(ResponseCode.PULL_OFFSET_MOVED);</div><div class="line"><span class="number">165</span>: </div><div class="line"><span class="number">166</span>:                     <span class="comment">// <span class="doctag">XXX:</span> warn and notify me</span></div><div class="line"><span class="number">167</span>:                     LOG.info(<span class="string">"the broker store no queue data, fix the request offset &#123;&#125; to &#123;&#125;, Topic: &#123;&#125; QueueId: &#123;&#125; Consumer Group: &#123;&#125;"</span>, <span class="comment">//</span></div><div class="line"><span class="number">168</span>:                         requestHeader.getQueueOffset(), <span class="comment">//</span></div><div class="line"><span class="number">169</span>:                         getMessageResult.getNextBeginOffset(), <span class="comment">//</span></div><div class="line"><span class="number">170</span>:                         requestHeader.getTopic(), <span class="comment">//</span></div><div class="line"><span class="number">171</span>:                         requestHeader.getQueueId(), <span class="comment">//</span></div><div class="line"><span class="number">172</span>:                         requestHeader.getConsumerGroup()<span class="comment">//</span></div><div class="line"><span class="number">173</span>:                     );</div><div class="line"><span class="number">174</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">175</span>:                     response.setCode(ResponseCode.PULL_NOT_FOUND);</div><div class="line"><span class="number">176</span>:                 &#125;</div><div class="line"><span class="number">177</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">178</span>:             <span class="keyword">case</span> NO_MATCHED_MESSAGE:</div><div class="line"><span class="number">179</span>:                 response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class="line"><span class="number">180</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">181</span>:             <span class="keyword">case</span> OFFSET_FOUND_NULL:</div><div class="line"><span class="number">182</span>:                 response.setCode(ResponseCode.PULL_NOT_FOUND);</div><div class="line"><span class="number">183</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">184</span>:             <span class="keyword">case</span> OFFSET_OVERFLOW_BADLY:</div><div class="line"><span class="number">185</span>:                 response.setCode(ResponseCode.PULL_OFFSET_MOVED);</div><div class="line"><span class="number">186</span>:                 <span class="comment">// <span class="doctag">XXX:</span> warn and notify me</span></div><div class="line"><span class="number">187</span>:                 LOG.info(<span class="string">"The request offset:&#123;&#125; over flow badly, broker max offset:&#123;&#125; , consumer: &#123;&#125;"</span>, requestHeader.getQueueOffset(), getMessageResult.getMaxOffset(), channel.remoteAddress());</div><div class="line"><span class="number">188</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">189</span>:             <span class="keyword">case</span> OFFSET_OVERFLOW_ONE:</div><div class="line"><span class="number">190</span>:                 response.setCode(ResponseCode.PULL_NOT_FOUND);</div><div class="line"><span class="number">191</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">192</span>:             <span class="keyword">case</span> OFFSET_TOO_SMALL:</div><div class="line"><span class="number">193</span>:                 response.setCode(ResponseCode.PULL_OFFSET_MOVED);</div><div class="line"><span class="number">194</span>:                 LOG.info(<span class="string">"The request offset is too small. group=&#123;&#125;, topic=&#123;&#125;, requestOffset=&#123;&#125;, brokerMinOffset=&#123;&#125;, clientIp=&#123;&#125;"</span>,</div><div class="line"><span class="number">195</span>:                     requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueOffset(),</div><div class="line"><span class="number">196</span>:                     getMessageResult.getMinOffset(), channel.remoteAddress());</div><div class="line"><span class="number">197</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">198</span>:             <span class="keyword">default</span>:</div><div class="line"><span class="number">199</span>:                 <span class="keyword">assert</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">200</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">201</span>:         &#125;</div><div class="line"><span class="number">202</span>: </div><div class="line"><span class="number">203</span>:         <span class="comment">// hookï¼šbefore</span></div><div class="line"><span class="number">204</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.hasConsumeMessageHook()) &#123;</div><div class="line"><span class="number">205</span>:             ConsumeMessageContext context = <span class="keyword">new</span> ConsumeMessageContext();</div><div class="line"><span class="number">206</span>:             context.setConsumerGroup(requestHeader.getConsumerGroup());</div><div class="line"><span class="number">207</span>:             context.setTopic(requestHeader.getTopic());</div><div class="line"><span class="number">208</span>:             context.setQueueId(requestHeader.getQueueId());</div><div class="line"><span class="number">209</span>: </div><div class="line"><span class="number">210</span>:             String owner = request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER);</div><div class="line"><span class="number">211</span>: </div><div class="line"><span class="number">212</span>:             <span class="keyword">switch</span> (response.getCode()) &#123;</div><div class="line"><span class="number">213</span>:                 <span class="keyword">case</span> ResponseCode.SUCCESS:</div><div class="line"><span class="number">214</span>:                     <span class="keyword">int</span> commercialBaseCount = brokerController.getBrokerConfig().getCommercialBaseCount();</div><div class="line"><span class="number">215</span>:                     <span class="keyword">int</span> incValue = getMessageResult.getMsgCount4Commercial() * commercialBaseCount;</div><div class="line"><span class="number">216</span>: </div><div class="line"><span class="number">217</span>:                     context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_SUCCESS);</div><div class="line"><span class="number">218</span>:                     context.setCommercialRcvTimes(incValue);</div><div class="line"><span class="number">219</span>:                     context.setCommercialRcvSize(getMessageResult.getBufferTotalSize());</div><div class="line"><span class="number">220</span>:                     context.setCommercialOwner(owner);</div><div class="line"><span class="number">221</span>: </div><div class="line"><span class="number">222</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">223</span>:                 <span class="keyword">case</span> ResponseCode.PULL_NOT_FOUND:</div><div class="line"><span class="number">224</span>:                     <span class="keyword">if</span> (!brokerAllowSuspend) &#123;</div><div class="line"><span class="number">225</span>: </div><div class="line"><span class="number">226</span>:                         context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_EPOLLS);</div><div class="line"><span class="number">227</span>:                         context.setCommercialRcvTimes(<span class="number">1</span>);</div><div class="line"><span class="number">228</span>:                         context.setCommercialOwner(owner);</div><div class="line"><span class="number">229</span>: </div><div class="line"><span class="number">230</span>:                     &#125;</div><div class="line"><span class="number">231</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">232</span>:                 <span class="keyword">case</span> ResponseCode.PULL_RETRY_IMMEDIATELY:</div><div class="line"><span class="number">233</span>:                 <span class="keyword">case</span> ResponseCode.PULL_OFFSET_MOVED:</div><div class="line"><span class="number">234</span>:                     context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_EPOLLS);</div><div class="line"><span class="number">235</span>:                     context.setCommercialRcvTimes(<span class="number">1</span>);</div><div class="line"><span class="number">236</span>:                     context.setCommercialOwner(owner);</div><div class="line"><span class="number">237</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">238</span>:                 <span class="keyword">default</span>:</div><div class="line"><span class="number">239</span>:                     <span class="keyword">assert</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">240</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">241</span>:             &#125;</div><div class="line"><span class="number">242</span>: </div><div class="line"><span class="number">243</span>:             <span class="keyword">this</span>.executeConsumeMessageHookBefore(context);</div><div class="line"><span class="number">244</span>:         &#125;</div><div class="line"><span class="number">245</span>: </div><div class="line"><span class="number">246</span>:         <span class="keyword">switch</span> (response.getCode()) &#123;</div><div class="line"><span class="number">247</span>:             <span class="keyword">case</span> ResponseCode.SUCCESS:</div><div class="line"><span class="number">248</span>: </div><div class="line"><span class="number">249</span>:                 <span class="keyword">this</span>.brokerController.getBrokerStatsManager().incGroupGetNums(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class="line"><span class="number">250</span>:                     getMessageResult.getMessageCount());</div><div class="line"><span class="number">251</span>:                 <span class="keyword">this</span>.brokerController.getBrokerStatsManager().incGroupGetSize(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class="line"><span class="number">252</span>:                     getMessageResult.getBufferTotalSize());</div><div class="line"><span class="number">253</span>:                 <span class="keyword">this</span>.brokerController.getBrokerStatsManager().incBrokerGetNums(getMessageResult.getMessageCount());</div><div class="line"><span class="number">254</span>:                 <span class="comment">// è¯»å–æ¶ˆæ¯</span></div><div class="line"><span class="number">255</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getBrokerConfig().isTransferMsgByHeap()) &#123; <span class="comment">// å†…å­˜ä¸­</span></div><div class="line"><span class="number">256</span>:                     <span class="keyword">final</span> <span class="keyword">long</span> beginTimeMills = <span class="keyword">this</span>.brokerController.getMessageStore().now();</div><div class="line"><span class="number">257</span>: </div><div class="line"><span class="number">258</span>:                     <span class="keyword">final</span> <span class="keyword">byte</span>[] r = <span class="keyword">this</span>.readGetMessageResult(getMessageResult, requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueId());</div><div class="line"><span class="number">259</span>: </div><div class="line"><span class="number">260</span>:                     <span class="keyword">this</span>.brokerController.getBrokerStatsManager().incGroupGetLatency(requestHeader.getConsumerGroup(),</div><div class="line"><span class="number">261</span>:                         requestHeader.getTopic(), requestHeader.getQueueId(),</div><div class="line"><span class="number">262</span>:                         (<span class="keyword">int</span>) (<span class="keyword">this</span>.brokerController.getMessageStore().now() - beginTimeMills));</div><div class="line"><span class="number">263</span>:                     response.setBody(r);</div><div class="line"><span class="number">264</span>:                 &#125; <span class="keyword">else</span> &#123; <span class="comment">// zero-copy</span></div><div class="line"><span class="number">265</span>:                     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">266</span>:                         FileRegion fileRegion = <span class="keyword">new</span> ManyMessageTransfer(response.encodeHeader(getMessageResult.getBufferTotalSize()), getMessageResult);</div><div class="line"><span class="number">267</span>:                         channel.writeAndFlush(fileRegion).addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</div><div class="line"><span class="number">268</span>:                             <span class="meta">@Override</span></div><div class="line"><span class="number">269</span>:                             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"><span class="number">270</span>:                                 getMessageResult.release();</div><div class="line"><span class="number">271</span>:                                 <span class="keyword">if</span> (!future.isSuccess()) &#123;</div><div class="line"><span class="number">272</span>:                                     LOG.error(<span class="string">"Fail to transfer messages from page cache to &#123;&#125;"</span>, channel.remoteAddress(), future.cause());</div><div class="line"><span class="number">273</span>:                                 &#125;</div><div class="line"><span class="number">274</span>:                             &#125;</div><div class="line"><span class="number">275</span>:                         &#125;);</div><div class="line"><span class="number">276</span>:                     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">277</span>:                         LOG.error(<span class="string">"Error occurred when transferring messages from page cache"</span>, e);</div><div class="line"><span class="number">278</span>:                         getMessageResult.release();</div><div class="line"><span class="number">279</span>:                     &#125;</div><div class="line"><span class="number">280</span>: </div><div class="line"><span class="number">281</span>:                     response = <span class="keyword">null</span>;</div><div class="line"><span class="number">282</span>:                 &#125;</div><div class="line"><span class="number">283</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">284</span>:             <span class="keyword">case</span> ResponseCode.PULL_NOT_FOUND:</div><div class="line"><span class="number">285</span>:                 <span class="comment">// æ¶ˆæ¯æœªæŸ¥è¯¢åˆ° &amp;&amp; brokerå…è®¸æŒ‚èµ·è¯·æ±‚ &amp;&amp; è¯·æ±‚å…è®¸æŒ‚èµ·</span></div><div class="line"><span class="number">286</span>:                 <span class="keyword">if</span> (brokerAllowSuspend &amp;&amp; hasSuspendFlag) &#123;</div><div class="line"><span class="number">287</span>:                     <span class="keyword">long</span> pollingTimeMills = suspendTimeoutMillisLong;</div><div class="line"><span class="number">288</span>:                     <span class="keyword">if</span> (!<span class="keyword">this</span>.brokerController.getBrokerConfig().isLongPollingEnable()) &#123;</div><div class="line"><span class="number">289</span>:                         pollingTimeMills = <span class="keyword">this</span>.brokerController.getBrokerConfig().getShortPollingTimeMills();</div><div class="line"><span class="number">290</span>:                     &#125;</div><div class="line"><span class="number">291</span>: </div><div class="line"><span class="number">292</span>:                     String topic = requestHeader.getTopic();</div><div class="line"><span class="number">293</span>:                     <span class="keyword">long</span> offset = requestHeader.getQueueOffset();</div><div class="line"><span class="number">294</span>:                     <span class="keyword">int</span> queueId = requestHeader.getQueueId();</div><div class="line"><span class="number">295</span>:                     PullRequest pullRequest = <span class="keyword">new</span> PullRequest(request, channel, pollingTimeMills,</div><div class="line"><span class="number">296</span>:                         <span class="keyword">this</span>.brokerController.getMessageStore().now(), offset, subscriptionData);</div><div class="line"><span class="number">297</span>:                     <span class="keyword">this</span>.brokerController.getPullRequestHoldService().suspendPullRequest(topic, queueId, pullRequest);</div><div class="line"><span class="number">298</span>:                     response = <span class="keyword">null</span>;</div><div class="line"><span class="number">299</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">300</span>:                 &#125;</div><div class="line"><span class="number">301</span>: </div><div class="line"><span class="number">302</span>:             <span class="keyword">case</span> ResponseCode.PULL_RETRY_IMMEDIATELY:</div><div class="line"><span class="number">303</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">304</span>:             <span class="keyword">case</span> ResponseCode.PULL_OFFSET_MOVED:</div><div class="line"><span class="number">305</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE</div><div class="line"><span class="number">306</span>:                     || <span class="keyword">this</span>.brokerController.getMessageStoreConfig().isOffsetCheckInSlave()) &#123; <span class="comment">// TODO å¾…åšå®¢è¡¥å……</span></div><div class="line"><span class="number">307</span>:                     MessageQueue mq = <span class="keyword">new</span> MessageQueue();</div><div class="line"><span class="number">308</span>:                     mq.setTopic(requestHeader.getTopic());</div><div class="line"><span class="number">309</span>:                     mq.setQueueId(requestHeader.getQueueId());</div><div class="line"><span class="number">310</span>:                     mq.setBrokerName(<span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerName());</div><div class="line"><span class="number">311</span>: </div><div class="line"><span class="number">312</span>:                     OffsetMovedEvent event = <span class="keyword">new</span> OffsetMovedEvent();</div><div class="line"><span class="number">313</span>:                     event.setConsumerGroup(requestHeader.getConsumerGroup());</div><div class="line"><span class="number">314</span>:                     event.setMessageQueue(mq);</div><div class="line"><span class="number">315</span>:                     event.setOffsetRequest(requestHeader.getQueueOffset());</div><div class="line"><span class="number">316</span>:                     event.setOffsetNew(getMessageResult.getNextBeginOffset());</div><div class="line"><span class="number">317</span>:                     <span class="keyword">this</span>.generateOffsetMovedEvent(event);</div><div class="line"><span class="number">318</span>:                     LOG.warn(</div><div class="line"><span class="number">319</span>:                         <span class="string">"PULL_OFFSET_MOVED:correction offset. topic=&#123;&#125;, groupId=&#123;&#125;, requestOffset=&#123;&#125;, newOffset=&#123;&#125;, suggestBrokerId=&#123;&#125;"</span>,</div><div class="line"><span class="number">320</span>:                         requestHeader.getTopic(), requestHeader.getConsumerGroup(), event.getOffsetRequest(), event.getOffsetNew(),</div><div class="line"><span class="number">321</span>:                         responseHeader.getSuggestWhichBrokerId());</div><div class="line"><span class="number">322</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">323</span>:                     responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getBrokerId());</div><div class="line"><span class="number">324</span>:                     response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class="line"><span class="number">325</span>:                     LOG.warn(<span class="string">"PULL_OFFSET_MOVED:none correction. topic=&#123;&#125;, groupId=&#123;&#125;, requestOffset=&#123;&#125;, suggestBrokerId=&#123;&#125;"</span>,</div><div class="line"><span class="number">326</span>:                         requestHeader.getTopic(), requestHeader.getConsumerGroup(), requestHeader.getQueueOffset(),</div><div class="line"><span class="number">327</span>:                         responseHeader.getSuggestWhichBrokerId());</div><div class="line"><span class="number">328</span>:                 &#125;</div><div class="line"><span class="number">329</span>: </div><div class="line"><span class="number">330</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">331</span>:             <span class="keyword">default</span>:</div><div class="line"><span class="number">332</span>:                 <span class="keyword">assert</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">333</span>:         &#125;</div><div class="line"><span class="number">334</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">335</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">336</span>:         response.setRemark(<span class="string">"store getMessage return null"</span>);</div><div class="line"><span class="number">337</span>:     &#125;</div><div class="line"><span class="number">338</span>: </div><div class="line"><span class="number">339</span>:     <span class="comment">// è¯·æ±‚è¦æ±‚æŒä¹…åŒ–è¿›åº¦ &amp;&amp; brokeréä¸»ï¼Œè¿›è¡ŒæŒä¹…åŒ–è¿›åº¦ã€‚</span></div><div class="line"><span class="number">340</span>:     <span class="keyword">boolean</span> storeOffsetEnable = brokerAllowSuspend;</div><div class="line"><span class="number">341</span>:     storeOffsetEnable = storeOffsetEnable &amp;&amp; hasCommitOffsetFlag;</div><div class="line"><span class="number">342</span>:     storeOffsetEnable = storeOffsetEnable &amp;&amp; <span class="keyword">this</span>.brokerController.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE;</div><div class="line"><span class="number">343</span>:     <span class="keyword">if</span> (storeOffsetEnable) &#123;</div><div class="line"><span class="number">344</span>:         <span class="keyword">this</span>.brokerController.getConsumerOffsetManager().commitOffset(RemotingHelper.parseChannelRemoteAddr(channel),</div><div class="line"><span class="number">345</span>:             requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueId(), requestHeader.getCommitOffset());</div><div class="line"><span class="number">346</span>:     &#125;</div><div class="line"><span class="number">347</span>:     <span class="keyword">return</span> response;</div><div class="line"><span class="number">348</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ï¼šå¤„ç†æ‹‰å–æ¶ˆæ¯è¯·æ±‚ï¼Œè¿”å›å“åº”ã€‚</li><li>ç¬¬ 14 è‡³ 19 è¡Œ ï¼šæ ¡éªŒ <code>Broker</code> æ˜¯å¦å¯è¯»ã€‚</li><li>ç¬¬ 21 è‡³ 33 è¡Œ ï¼šæ ¡éªŒ <code>SubscriptionGroupConfig</code>(è®¢é˜…åˆ†ç»„é…ç½®) æ˜¯å¦å­˜åœ¨ &amp;&amp; å¯ä»¥æ¶ˆè´¹ã€‚</li><li>ç¬¬ 35 è‡³ 38 è¡Œ ï¼šå¤„ç† <code>PullMessageRequestHeader.sysFlag</code> å¯¹åº”çš„æ ‡å¿—ä½ã€‚</li><li>ç¬¬ 40 è‡³ 62 è¡Œ ï¼šæ ¡éªŒ <code>TopicConfig</code>(ä¸»é¢˜é…ç½®) æ˜¯å¦å­˜åœ¨ &amp;&amp; å¯è¯» &amp;&amp; é˜Ÿåˆ—ç¼–å·æ­£ç¡®ã€‚</li><li>ç¬¬ 64 è‡³ 110 è¡Œ ï¼šæ ¡éªŒ <code>SubscriptionData</code>(è®¢é˜…ä¿¡æ¯) æ˜¯å¦æ­£ç¡®ã€‚</li><li>ç¬¬ 113 è¡Œ ï¼šè°ƒç”¨ <code>MessageStore#getMessage(...)</code> è·å– <code>GetMessageResult</code>(æ¶ˆæ¯)ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#messagestoregetmessage">MessageStore#getMessage(â€¦)</a>ã€‚</li><li>ç¬¬ 122 è‡³ 152 è¡Œ ï¼šè®¡ç®—å»ºè®®æ‹‰å–æ¶ˆæ¯ <code>brokerId</code> ã€‚</li><li>ç¬¬ 154 è‡³ 201 è¡Œ ï¼š<img src="http://www.yunai.me/images/RocketMQ/2017_05_04/08.png" alt="PullMessageProcessoræ‹‰å–æ¶ˆæ¯çŠ¶æ€å›¾"></li><li>ç¬¬ 204 è‡³ 244 è¡Œ ï¼š<code>Hook</code> é€»è¾‘ï¼Œ<code>#executeConsumeMessageHookBefore(...)</code> ã€‚</li><li>ç¬¬ 247 è‡³ 283 è¡Œ ï¼šæ‹‰å–æ¶ˆæ¯æˆåŠŸï¼Œå³æ‹‰å–åˆ°æ¶ˆæ¯ã€‚<ul><li>ç¬¬ 255 è‡³ 263 è¡Œ ï¼šæ–¹å¼ä¸€ ï¼šè°ƒç”¨ <code>readGetMessageResult(...)</code> è·å–æ¶ˆæ¯å†…å®¹åˆ°å †å†…å†…å­˜ï¼Œè®¾ç½®åˆ° å“åº”<code>body</code>ã€‚</li><li>ç¬¬ 265 è‡³ 281 è¡Œ ï¼šæ–¹å¼äºŒ ï¼šåŸºäº <code>zero-copy</code> å®ç°ï¼Œç›´æ¥å“åº”ï¼Œæ— éœ€å †å†…å†…å­˜ï¼Œæ€§èƒ½æ›´ä¼˜ã€‚<em>TODO ï¼šæ­¤å¤„ç­‰å¯¹zero-copyæœ‰ç ”ç©¶ï¼Œå†è¡¥å……ä¸€äº›</em>ã€‚</li></ul></li><li>ç¬¬ 284 è‡³ 300 è¡Œ ï¼šæ‹‰å–ä¸åˆ°æ¶ˆæ¯ï¼Œå½“æ»¡è¶³æ¡ä»¶ (<code>Broker</code> å…è®¸æŒ‚èµ· &amp;&amp; è¯·æ±‚è¦æ±‚æŒ‚èµ·)ï¼Œæ‰§è¡ŒæŒ‚èµ·è¯·æ±‚ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#pullrequestholdservice">PullRequestHoldService</a>ã€‚</li><li>ç¬¬ 304 è‡³ 328 è¡Œ ï¼š<em>TODO ï¼šæ­¤å¤„ç­‰å¯¹<code>tools</code>æ¨¡å—ç ”ç©¶åå†è¡¥å……</em>ã€‚</li><li>ç¬¬ 339 è‡³ 346 ï¼šæŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ï¼Œå½“æ»¡è¶³ (<code>Broker</code> éä¸» &amp;&amp; è¯·æ±‚è¦æ±‚æŒä¹…åŒ–è¿›åº¦)ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#3broker-æä¾›æ›´æ–°æ¶ˆè´¹è¿›åº¦æ¥å£">æ›´æ–°æ¶ˆè´¹è¿›åº¦</a>ã€‚</li></ul><h2 id="MessageStore-getMessage-â€¦"><a href="#MessageStore-getMessage-â€¦" class="headerlink" title="MessageStore#getMessage(â€¦)"></a>MessageStore#getMessage(â€¦)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">/**</span></div><div class="line">  2:  * è·å–æ¶ˆæ¯ç»“æœ</div><div class="line">  3:  *</div><div class="line">  4:  * <span class="doctag">@param</span> group æ¶ˆè´¹åˆ†ç»„</div><div class="line">  5:  * <span class="doctag">@param</span> topic ä¸»é¢˜</div><div class="line">  6:  * <span class="doctag">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class="line">  7:  * <span class="doctag">@param</span> offset é˜Ÿåˆ—ä½ç½®</div><div class="line">  8:  * <span class="doctag">@param</span> maxMsgNums æ¶ˆæ¯æ•°é‡</div><div class="line">  9:  * <span class="doctag">@param</span> subscriptionData è®¢é˜…ä¿¡æ¯</div><div class="line"> 10:  * <span class="doctag">@return</span> æ¶ˆæ¯ç»“æœ</div><div class="line"> 11:  */</div><div class="line"> <span class="number">12</span>: <span class="function"><span class="keyword">public</span> GetMessageResult <span class="title">getMessage</span><span class="params">(<span class="keyword">final</span> String group, <span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> offset, <span class="keyword">final</span> <span class="keyword">int</span> maxMsgNums,</span></span></div><div class="line"> <span class="number">13</span>:     <span class="keyword">final</span> SubscriptionData subscriptionData) &#123;</div><div class="line"> <span class="number">14</span>:     <span class="comment">// æ˜¯å¦å…³é—­</span></div><div class="line"> <span class="number">15</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.shutdown) &#123;</div><div class="line"> <span class="number">16</span>:         log.warn(<span class="string">"message store has shutdown, so getMessage is forbidden"</span>);</div><div class="line"> <span class="number">17</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"> <span class="number">18</span>:     &#125;</div><div class="line"> <span class="number">19</span>:     <span class="comment">// æ˜¯å¦å¯è¯»</span></div><div class="line"> <span class="number">20</span>:     <span class="keyword">if</span> (!<span class="keyword">this</span>.runningFlags.isReadable()) &#123;</div><div class="line"> <span class="number">21</span>:         log.warn(<span class="string">"message store is not readable, so getMessage is forbidden "</span> + <span class="keyword">this</span>.runningFlags.getFlagBits());</div><div class="line"> <span class="number">22</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"> <span class="number">23</span>:     &#125;</div><div class="line"> <span class="number">24</span>: </div><div class="line"> <span class="number">25</span>:     <span class="keyword">long</span> beginTime = <span class="keyword">this</span>.getSystemClock().now();</div><div class="line"> <span class="number">26</span>: </div><div class="line"> <span class="number">27</span>:     GetMessageStatus status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;</div><div class="line"> <span class="number">28</span>:     <span class="keyword">long</span> nextBeginOffset = offset;</div><div class="line"> <span class="number">29</span>:     <span class="keyword">long</span> minOffset = <span class="number">0</span>;</div><div class="line"> <span class="number">30</span>:     <span class="keyword">long</span> maxOffset = <span class="number">0</span>;</div><div class="line"> <span class="number">31</span>: </div><div class="line"> <span class="number">32</span>:     GetMessageResult getResult = <span class="keyword">new</span> GetMessageResult();</div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:     <span class="keyword">final</span> <span class="keyword">long</span> maxOffsetPy = <span class="keyword">this</span>.commitLog.getMaxOffset();</div><div class="line"> <span class="number">35</span>: </div><div class="line"> <span class="number">36</span>:     <span class="comment">// è·å–æ¶ˆè´¹é˜Ÿåˆ—</span></div><div class="line"> <span class="number">37</span>:     ConsumeQueue consumeQueue = findConsumeQueue(topic, queueId);</div><div class="line"> <span class="number">38</span>:     <span class="keyword">if</span> (consumeQueue != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">39</span>:         minOffset = consumeQueue.getMinOffsetInQueue(); <span class="comment">// æ¶ˆè´¹é˜Ÿåˆ— æœ€å°é˜Ÿåˆ—ç¼–å·</span></div><div class="line"> <span class="number">40</span>:         maxOffset = consumeQueue.getMaxOffsetInQueue(); <span class="comment">// æ¶ˆè´¹é˜Ÿåˆ— æœ€å¤§é˜Ÿåˆ—ç¼–å·</span></div><div class="line"> <span class="number">41</span>: </div><div class="line"> <span class="number">42</span>:         <span class="comment">// åˆ¤æ–­ é˜Ÿåˆ—ä½ç½®(offset)</span></div><div class="line"> <span class="number">43</span>:         <span class="keyword">if</span> (maxOffset == <span class="number">0</span>) &#123; <span class="comment">// æ¶ˆè´¹é˜Ÿåˆ—æ— æ¶ˆæ¯</span></div><div class="line"> <span class="number">44</span>:             status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;</div><div class="line"> <span class="number">45</span>:             nextBeginOffset = nextOffsetCorrection(offset, <span class="number">0</span>);</div><div class="line"> <span class="number">46</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (offset &lt; minOffset) &#123; <span class="comment">// æŸ¥è¯¢offset å¤ªå°</span></div><div class="line"> <span class="number">47</span>:             status = GetMessageStatus.OFFSET_TOO_SMALL;</div><div class="line"> <span class="number">48</span>:             nextBeginOffset = nextOffsetCorrection(offset, minOffset);</div><div class="line"> <span class="number">49</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (offset == maxOffset) &#123; <span class="comment">// æŸ¥è¯¢offset è¶…è¿‡ æ¶ˆè´¹é˜Ÿåˆ— ä¸€ä¸ªä½ç½®</span></div><div class="line"> <span class="number">50</span>:             status = GetMessageStatus.OFFSET_OVERFLOW_ONE;</div><div class="line"> <span class="number">51</span>:             nextBeginOffset = nextOffsetCorrection(offset, offset);</div><div class="line"> <span class="number">52</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (offset &gt; maxOffset) &#123; <span class="comment">// æŸ¥è¯¢offset è¶…è¿‡ æ¶ˆè´¹é˜Ÿåˆ— å¤ªå¤š(å¤§äºä¸€ä¸ªä½ç½®)</span></div><div class="line"> <span class="number">53</span>:             status = GetMessageStatus.OFFSET_OVERFLOW_BADLY;</div><div class="line"> <span class="number">54</span>:             <span class="keyword">if</span> (<span class="number">0</span> == minOffset) &#123; <span class="comment">// TODO blog è¿™é‡Œæ˜¯ï¼Ÿï¼Ÿä¸ºå•¥0 == minOffsetåšäº†ç‰¹æ®Šåˆ¤æ–­</span></div><div class="line"> <span class="number">55</span>:                 nextBeginOffset = nextOffsetCorrection(offset, minOffset);</div><div class="line"> <span class="number">56</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">57</span>:                 nextBeginOffset = nextOffsetCorrection(offset, maxOffset);</div><div class="line"> <span class="number">58</span>:             &#125;</div><div class="line"> <span class="number">59</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">60</span>:             <span class="comment">// è·å¾— æ˜ å°„Bufferç»“æœ(MappedFile)</span></div><div class="line"> <span class="number">61</span>:             SelectMappedBufferResult bufferConsumeQueue = consumeQueue.getIndexBuffer(offset);</div><div class="line"> <span class="number">62</span>:             <span class="keyword">if</span> (bufferConsumeQueue != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">63</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">64</span>:                     status = GetMessageStatus.NO_MATCHED_MESSAGE;</div><div class="line"> <span class="number">65</span>: </div><div class="line"> <span class="number">66</span>:                     <span class="keyword">long</span> nextPhyFileStartOffset = Long.MIN_VALUE; <span class="comment">// commitLogä¸‹ä¸€ä¸ªæ–‡ä»¶(MappedFile)å¯¹åº”çš„å¼€å§‹offsetã€‚</span></div><div class="line"> <span class="number">67</span>:                     <span class="keyword">long</span> maxPhyOffsetPulling = <span class="number">0</span>; <span class="comment">// æ¶ˆæ¯ç‰©ç†ä½ç½®æ‹‰å–åˆ°çš„æœ€å¤§offset</span></div><div class="line"> <span class="number">68</span>: </div><div class="line"> <span class="number">69</span>:                     <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line"> <span class="number">70</span>:                     <span class="keyword">final</span> <span class="keyword">int</span> maxFilterMessageCount = <span class="number">16000</span>;</div><div class="line"> <span class="number">71</span>:                     <span class="keyword">final</span> <span class="keyword">boolean</span> diskFallRecorded = <span class="keyword">this</span>.messageStoreConfig.isDiskFallRecorded();</div><div class="line"> <span class="number">72</span>:                     <span class="comment">// å¾ªç¯è·å– æ¶ˆæ¯ä½ç½®ä¿¡æ¯</span></div><div class="line"> <span class="number">73</span>:                     <span class="keyword">for</span> (; i &lt; bufferConsumeQueue.getSize() &amp;&amp; i &lt; maxFilterMessageCount; i += ConsumeQueue.CQ_STORE_UNIT_SIZE) &#123;</div><div class="line"> <span class="number">74</span>:                         <span class="keyword">long</span> offsetPy = bufferConsumeQueue.getByteBuffer().getLong(); <span class="comment">// æ¶ˆæ¯ç‰©ç†ä½ç½®offset</span></div><div class="line"> <span class="number">75</span>:                         <span class="keyword">int</span> sizePy = bufferConsumeQueue.getByteBuffer().getInt(); <span class="comment">// æ¶ˆæ¯é•¿åº¦</span></div><div class="line"> <span class="number">76</span>:                         <span class="keyword">long</span> tagsCode = bufferConsumeQueue.getByteBuffer().getLong(); <span class="comment">// æ¶ˆæ¯tagsCode</span></div><div class="line"> <span class="number">77</span>:                         <span class="comment">// è®¾ç½®æ¶ˆæ¯ç‰©ç†ä½ç½®æ‹‰å–åˆ°çš„æœ€å¤§offset</span></div><div class="line"> <span class="number">78</span>:                         maxPhyOffsetPulling = offsetPy;</div><div class="line"> <span class="number">79</span>:                         <span class="comment">// å½“ offsetPy å°äº nextPhyFileStartOffset æ—¶ï¼Œæ„å‘³ç€å¯¹åº”çš„ Message å·²ç»ç§»é™¤ï¼Œæ‰€ä»¥ç›´æ¥continueï¼Œç›´åˆ°å¯è¯»å–çš„Messageã€‚</span></div><div class="line"> <span class="number">80</span>:                         <span class="keyword">if</span> (nextPhyFileStartOffset != Long.MIN_VALUE) &#123;</div><div class="line"> <span class="number">81</span>:                             <span class="keyword">if</span> (offsetPy &lt; nextPhyFileStartOffset)</div><div class="line"> <span class="number">82</span>:                                 <span class="keyword">continue</span>;</div><div class="line"> <span class="number">83</span>:                         &#125;</div><div class="line"> <span class="number">84</span>:                         <span class="comment">// æ ¡éªŒ commitLog æ˜¯å¦éœ€è¦ç¡¬ç›˜ï¼Œæ— æ³•å…¨éƒ¨æ”¾åœ¨å†…å­˜</span></div><div class="line"> <span class="number">85</span>:                         <span class="keyword">boolean</span> isInDisk = checkInDiskByCommitOffset(offsetPy, maxOffsetPy);</div><div class="line"> <span class="number">86</span>:                         <span class="comment">// æ˜¯å¦å·²ç»è·å¾—è¶³å¤Ÿæ¶ˆæ¯</span></div><div class="line"> <span class="number">87</span>:                         <span class="keyword">if</span> (<span class="keyword">this</span>.isTheBatchFull(sizePy, maxMsgNums, getResult.getBufferTotalSize(), getResult.getMessageCount(),</div><div class="line"> <span class="number">88</span>:                             isInDisk)) &#123;</div><div class="line"> <span class="number">89</span>:                             <span class="keyword">break</span>;</div><div class="line"> <span class="number">90</span>:                         &#125;</div><div class="line"> <span class="number">91</span>:                         <span class="comment">// åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦ç¬¦åˆæ¡ä»¶</span></div><div class="line"> <span class="number">92</span>:                         <span class="keyword">if</span> (<span class="keyword">this</span>.messageFilter.isMessageMatched(subscriptionData, tagsCode)) &#123;</div><div class="line"> <span class="number">93</span>:                             <span class="comment">// ä»commitLogè·å–å¯¹åº”æ¶ˆæ¯ByteBuffer</span></div><div class="line"> <span class="number">94</span>:                             SelectMappedBufferResult selectResult = <span class="keyword">this</span>.commitLog.getMessage(offsetPy, sizePy);</div><div class="line"> <span class="number">95</span>:                             <span class="keyword">if</span> (selectResult != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">96</span>:                                 <span class="keyword">this</span>.storeStatsService.getGetMessageTransferedMsgCount().incrementAndGet();</div><div class="line"> <span class="number">97</span>:                                 getResult.addMessage(selectResult);</div><div class="line"> <span class="number">98</span>:                                 status = GetMessageStatus.FOUND;</div><div class="line"> <span class="number">99</span>:                                 nextPhyFileStartOffset = Long.MIN_VALUE;</div><div class="line"><span class="number">100</span>:                             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">101</span>:                                 <span class="comment">// ä»commitLogæ— æ³•è¯»å–åˆ°æ¶ˆæ¯ï¼Œè¯´æ˜è¯¥æ¶ˆæ¯å¯¹åº”çš„æ–‡ä»¶ï¼ˆMappedFileï¼‰å·²ç»åˆ é™¤ï¼Œè®¡ç®—ä¸‹ä¸€ä¸ªMappedFileçš„èµ·å§‹ä½ç½®</span></div><div class="line"><span class="number">102</span>:                                 <span class="keyword">if</span> (getResult.getBufferTotalSize() == <span class="number">0</span>) &#123;</div><div class="line"><span class="number">103</span>:                                     status = GetMessageStatus.MESSAGE_WAS_REMOVING;</div><div class="line"><span class="number">104</span>:                                 &#125;</div><div class="line"><span class="number">105</span>:                                 nextPhyFileStartOffset = <span class="keyword">this</span>.commitLog.rollNextFile(offsetPy);</div><div class="line"><span class="number">106</span>:                             &#125;</div><div class="line"><span class="number">107</span>:                         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">108</span>:                             <span class="keyword">if</span> (getResult.getBufferTotalSize() == <span class="number">0</span>) &#123;</div><div class="line"><span class="number">109</span>:                                 status = GetMessageStatus.NO_MATCHED_MESSAGE;</div><div class="line"><span class="number">110</span>:                             &#125;</div><div class="line"><span class="number">111</span>: </div><div class="line"><span class="number">112</span>:                             <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line"><span class="number">113</span>:                                 log.debug(<span class="string">"message type not matched, client: "</span> + subscriptionData + <span class="string">" server: "</span> + tagsCode);</div><div class="line"><span class="number">114</span>:                             &#125;</div><div class="line"><span class="number">115</span>:                         &#125;</div><div class="line"><span class="number">116</span>:                     &#125;</div><div class="line"><span class="number">117</span>:                     <span class="comment">// ç»Ÿè®¡å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°</span></div><div class="line"><span class="number">118</span>:                     <span class="keyword">if</span> (diskFallRecorded) &#123;</div><div class="line"><span class="number">119</span>:                         <span class="keyword">long</span> fallBehind = maxOffsetPy - maxPhyOffsetPulling;</div><div class="line"><span class="number">120</span>:                         brokerStatsManager.recordDiskFallBehindSize(group, topic, queueId, fallBehind);</div><div class="line"><span class="number">121</span>:                     &#125;</div><div class="line"><span class="number">122</span>:                     <span class="comment">// è®¡ç®—ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·</span></div><div class="line"><span class="number">123</span>:                     nextBeginOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);</div><div class="line"><span class="number">124</span>:                     <span class="comment">// æ ¹æ®å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°ä¸å†…å­˜åˆ¤æ–­æ˜¯å¦å»ºè®®è¯»å–ä»èŠ‚ç‚¹</span></div><div class="line"><span class="number">125</span>:                     <span class="keyword">long</span> diff = maxOffsetPy - maxPhyOffsetPulling;</div><div class="line"><span class="number">126</span>:                     <span class="keyword">long</span> memory = (<span class="keyword">long</span>) (StoreUtil.TOTAL_PHYSICAL_MEMORY_SIZE</div><div class="line"><span class="number">127</span>:                             * (<span class="keyword">this</span>.messageStoreConfig.getAccessMessageInMemoryMaxRatio() / <span class="number">100.0</span>));</div><div class="line"><span class="number">128</span>:                     getResult.setSuggestPullingFromSlave(diff &gt; memory);</div><div class="line"><span class="number">129</span>:                 &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">130</span>:                     bufferConsumeQueue.release();</div><div class="line"><span class="number">131</span>:                 &#125;</div><div class="line"><span class="number">132</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">133</span>:                 status = GetMessageStatus.OFFSET_FOUND_NULL;</div><div class="line"><span class="number">134</span>:                 nextBeginOffset = nextOffsetCorrection(offset, consumeQueue.rollNextFile(offset));</div><div class="line"><span class="number">135</span>:                 log.warn(<span class="string">"consumer request topic: "</span> + topic + <span class="string">"offset: "</span> + offset + <span class="string">" minOffset: "</span> + minOffset + <span class="string">" maxOffset: "</span></div><div class="line"><span class="number">136</span>:                     + maxOffset + <span class="string">", but access logic queue failed."</span>);</div><div class="line"><span class="number">137</span>:             &#125;</div><div class="line"><span class="number">138</span>:         &#125;</div><div class="line"><span class="number">139</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">140</span>:         status = GetMessageStatus.NO_MATCHED_LOGIC_QUEUE;</div><div class="line"><span class="number">141</span>:         nextBeginOffset = nextOffsetCorrection(offset, <span class="number">0</span>);</div><div class="line"><span class="number">142</span>:     &#125;</div><div class="line"><span class="number">143</span>:     <span class="comment">// ç»Ÿè®¡</span></div><div class="line"><span class="number">144</span>:     <span class="keyword">if</span> (GetMessageStatus.FOUND == status) &#123;</div><div class="line"><span class="number">145</span>:         <span class="keyword">this</span>.storeStatsService.getGetMessageTimesTotalFound().incrementAndGet();</div><div class="line"><span class="number">146</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">147</span>:         <span class="keyword">this</span>.storeStatsService.getGetMessageTimesTotalMiss().incrementAndGet();</div><div class="line"><span class="number">148</span>:     &#125;</div><div class="line"><span class="number">149</span>:     <span class="keyword">long</span> eclipseTime = <span class="keyword">this</span>.getSystemClock().now() - beginTime;</div><div class="line"><span class="number">150</span>:     <span class="keyword">this</span>.storeStatsService.setGetMessageEntireTimeMax(eclipseTime);</div><div class="line"><span class="number">151</span>:     <span class="comment">// è®¾ç½®è¿”å›ç»“æœ</span></div><div class="line"><span class="number">152</span>:     getResult.setStatus(status);</div><div class="line"><span class="number">153</span>:     getResult.setNextBeginOffset(nextBeginOffset);</div><div class="line"><span class="number">154</span>:     getResult.setMaxOffset(maxOffset);</div><div class="line"><span class="number">155</span>:     getResult.setMinOffset(minOffset);</div><div class="line"><span class="number">156</span>:     <span class="keyword">return</span> getResult;</div><div class="line"><span class="number">157</span>: &#125;</div><div class="line"><span class="number">158</span>: </div><div class="line"><span class="number">159</span>: <span class="comment">/**</span></div><div class="line">160:  * æ ¹æ® ä¸»é¢˜ + é˜Ÿåˆ—ç¼–å· è·å– æ¶ˆè´¹é˜Ÿåˆ—</div><div class="line">161:  *</div><div class="line">162:  * <span class="doctag">@param</span> topic ä¸»é¢˜</div><div class="line">163:  * <span class="doctag">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class="line">164:  * <span class="doctag">@return</span> æ¶ˆè´¹é˜Ÿåˆ—</div><div class="line">165:  */</div><div class="line"><span class="number">166</span>: <span class="function"><span class="keyword">public</span> ConsumeQueue <span class="title">findConsumeQueue</span><span class="params">(String topic, <span class="keyword">int</span> queueId)</span> </span>&#123;</div><div class="line"><span class="number">167</span>:     <span class="comment">// è·å– topic å¯¹åº”çš„ æ‰€æœ‰æ¶ˆè´¹é˜Ÿåˆ—</span></div><div class="line"><span class="number">168</span>:     ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; map = consumeQueueTable.get(topic);</div><div class="line"><span class="number">169</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == map) &#123;</div><div class="line"><span class="number">170</span>:         ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; newMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">128</span>);</div><div class="line"><span class="number">171</span>:         ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; oldMap = consumeQueueTable.putIfAbsent(topic, newMap);</div><div class="line"><span class="number">172</span>:         <span class="keyword">if</span> (oldMap != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">173</span>:             map = oldMap;</div><div class="line"><span class="number">174</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">175</span>:             map = newMap;</div><div class="line"><span class="number">176</span>:         &#125;</div><div class="line"><span class="number">177</span>:     &#125;</div><div class="line"><span class="number">178</span>:     <span class="comment">// è·å– queueId å¯¹åº”çš„ æ¶ˆè´¹é˜Ÿåˆ—</span></div><div class="line"><span class="number">179</span>:     ConsumeQueue logic = map.get(queueId);</div><div class="line"><span class="number">180</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == logic) &#123;</div><div class="line"><span class="number">181</span>:         ConsumeQueue newLogic = <span class="keyword">new</span> ConsumeQueue(<span class="comment">//</span></div><div class="line"><span class="number">182</span>:             topic, <span class="comment">//</span></div><div class="line"><span class="number">183</span>:             queueId, <span class="comment">//</span></div><div class="line"><span class="number">184</span>:             StorePathConfigHelper.getStorePathConsumeQueue(<span class="keyword">this</span>.messageStoreConfig.getStorePathRootDir()), <span class="comment">//</span></div><div class="line"><span class="number">185</span>:             <span class="keyword">this</span>.getMessageStoreConfig().getMapedFileSizeConsumeQueue(), <span class="comment">//</span></div><div class="line"><span class="number">186</span>:             <span class="keyword">this</span>);</div><div class="line"><span class="number">187</span>:         ConsumeQueue oldLogic = map.putIfAbsent(queueId, newLogic);</div><div class="line"><span class="number">188</span>:         <span class="keyword">if</span> (oldLogic != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">189</span>:             logic = oldLogic;</div><div class="line"><span class="number">190</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">191</span>:             logic = newLogic;</div><div class="line"><span class="number">192</span>:         &#125;</div><div class="line"><span class="number">193</span>:     &#125;</div><div class="line"><span class="number">194</span>: </div><div class="line"><span class="number">195</span>:     <span class="keyword">return</span> logic;</div><div class="line"><span class="number">196</span>: &#125;</div><div class="line"><span class="number">197</span>: </div><div class="line"><span class="number">198</span>: <span class="comment">/**</span></div><div class="line">199:  * ä¸‹ä¸€ä¸ªè·å–é˜Ÿåˆ—offsetä¿®æ­£</div><div class="line">200:  * ä¿®æ­£æ¡ä»¶ï¼šä¸»èŠ‚ç‚¹ æˆ–è€… ä»èŠ‚ç‚¹å¼€å¯æ ¡éªŒoffsetå¼€å…³</div><div class="line">201:  *</div><div class="line">202:  * <span class="doctag">@param</span> oldOffset è€é˜Ÿåˆ—offset</div><div class="line">203:  * <span class="doctag">@param</span> newOffset æ–°é˜Ÿåˆ—offset</div><div class="line">204:  * <span class="doctag">@return</span> ä¿®æ­£åçš„é˜Ÿåˆ—offset</div><div class="line">205:  */</div><div class="line"><span class="number">206</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">nextOffsetCorrection</span><span class="params">(<span class="keyword">long</span> oldOffset, <span class="keyword">long</span> newOffset)</span> </span>&#123;</div><div class="line"><span class="number">207</span>:     <span class="keyword">long</span> nextOffset = oldOffset;</div><div class="line"><span class="number">208</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE || <span class="keyword">this</span>.getMessageStoreConfig().isOffsetCheckInSlave()) &#123;</div><div class="line"><span class="number">209</span>:         nextOffset = newOffset;</div><div class="line"><span class="number">210</span>:     &#125;</div><div class="line"><span class="number">211</span>:     <span class="keyword">return</span> nextOffset;</div><div class="line"><span class="number">212</span>: &#125;</div><div class="line"><span class="number">213</span>: </div><div class="line"><span class="number">214</span>: <span class="comment">/**</span></div><div class="line">215:  * æ ¡éªŒ commitLog æ˜¯å¦éœ€è¦ç¡¬ç›˜ï¼Œæ— æ³•å…¨éƒ¨æ”¾åœ¨å†…å­˜</div><div class="line">216:  *</div><div class="line">217:  * <span class="doctag">@param</span> offsetPy commitLog æŒ‡å®šoffset</div><div class="line">218:  * <span class="doctag">@param</span> maxOffsetPy commitLog æœ€å¤§offset</div><div class="line">219:  * <span class="doctag">@return</span> æ˜¯å¦éœ€è¦ç¡¬ç›˜</div><div class="line">220:  */</div><div class="line"><span class="number">221</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkInDiskByCommitOffset</span><span class="params">(<span class="keyword">long</span> offsetPy, <span class="keyword">long</span> maxOffsetPy)</span> </span>&#123;</div><div class="line"><span class="number">222</span>:     <span class="keyword">long</span> memory = (<span class="keyword">long</span>) (StoreUtil.TOTAL_PHYSICAL_MEMORY_SIZE * (<span class="keyword">this</span>.messageStoreConfig.getAccessMessageInMemoryMaxRatio() / <span class="number">100.0</span>));</div><div class="line"><span class="number">223</span>:     <span class="keyword">return</span> (maxOffsetPy - offsetPy) &gt; memory;</div><div class="line"><span class="number">224</span>: &#125;</div><div class="line"><span class="number">225</span>: </div><div class="line"><span class="number">226</span>: <span class="comment">/**</span></div><div class="line">227:  * åˆ¤æ–­è·å–æ¶ˆæ¯æ˜¯å¦å·²ç»æ»¡</div><div class="line">228:  *</div><div class="line">229:  * <span class="doctag">@param</span> sizePy å­—èŠ‚æ•°</div><div class="line">230:  * <span class="doctag">@param</span> maxMsgNums æœ€å¤§æ¶ˆæ¯æ•°</div><div class="line">231:  * <span class="doctag">@param</span> bufferTotal ç›®å‰å·²ç»è®¡ç®—å­—èŠ‚æ•°</div><div class="line">232:  * <span class="doctag">@param</span> messageTotal ç›®å‰å·²ç»è®¡ç®—æ¶ˆæ¯æ•°</div><div class="line">233:  * <span class="doctag">@param</span> isInDisk æ˜¯å¦åœ¨ç¡¬ç›˜ä¸­</div><div class="line">234:  * <span class="doctag">@return</span> æ˜¯å¦å·²æ»¡</div><div class="line">235:  */</div><div class="line"><span class="number">236</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isTheBatchFull</span><span class="params">(<span class="keyword">int</span> sizePy, <span class="keyword">int</span> maxMsgNums, <span class="keyword">int</span> bufferTotal, <span class="keyword">int</span> messageTotal, <span class="keyword">boolean</span> isInDisk)</span> </span>&#123;</div><div class="line"><span class="number">237</span>:     <span class="keyword">if</span> (<span class="number">0</span> == bufferTotal || <span class="number">0</span> == messageTotal) &#123;</div><div class="line"><span class="number">238</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">239</span>:     &#125;</div><div class="line"><span class="number">240</span>:     <span class="comment">// æ¶ˆæ¯æ•°é‡å·²ç»æ»¡è¶³è¯·æ±‚æ•°é‡(maxMsgNums)</span></div><div class="line"><span class="number">241</span>:     <span class="keyword">if</span> ((messageTotal + <span class="number">1</span>) &gt;= maxMsgNums) &#123;</div><div class="line"><span class="number">242</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">243</span>:     &#125;</div><div class="line"><span class="number">244</span>:     <span class="comment">// æ ¹æ®æ¶ˆæ¯å­˜å‚¨é…ç½®çš„æœ€å¤§ä¼ è¾“å­—èŠ‚æ•°ã€æœ€å¤§ä¼ è¾“æ¶ˆæ¯æ•°æ˜¯å¦å·²æ»¡</span></div><div class="line"><span class="number">245</span>:     <span class="keyword">if</span> (isInDisk) &#123;</div><div class="line"><span class="number">246</span>:         <span class="keyword">if</span> ((bufferTotal + sizePy) &gt; <span class="keyword">this</span>.messageStoreConfig.getMaxTransferBytesOnMessageInDisk()) &#123;</div><div class="line"><span class="number">247</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">248</span>:         &#125;</div><div class="line"><span class="number">249</span>: </div><div class="line"><span class="number">250</span>:         <span class="keyword">if</span> ((messageTotal + <span class="number">1</span>) &gt; <span class="keyword">this</span>.messageStoreConfig.getMaxTransferCountOnMessageInDisk()) &#123;</div><div class="line"><span class="number">251</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">252</span>:         &#125;</div><div class="line"><span class="number">253</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">254</span>:         <span class="keyword">if</span> ((bufferTotal + sizePy) &gt; <span class="keyword">this</span>.messageStoreConfig.getMaxTransferBytesOnMessageInMemory()) &#123;</div><div class="line"><span class="number">255</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">256</span>:         &#125;</div><div class="line"><span class="number">257</span>: </div><div class="line"><span class="number">258</span>:         <span class="keyword">if</span> ((messageTotal + <span class="number">1</span>) &gt; <span class="keyword">this</span>.messageStoreConfig.getMaxTransferCountOnMessageInMemory()) &#123;</div><div class="line"><span class="number">259</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">260</span>:         &#125;</div><div class="line"><span class="number">261</span>:     &#125;</div><div class="line"><span class="number">262</span>: </div><div class="line"><span class="number">263</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">264</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šæ ¹æ® æ¶ˆæ¯åˆ†ç»„(<code>group</code>) + ä¸»é¢˜(<code>Topic</code>) + é˜Ÿåˆ—ç¼–å·(<code>queueId</code>) + é˜Ÿåˆ—ä½ç½®(<code>offset</code>) + è®¢é˜…ä¿¡æ¯(<code>subscriptionData</code>) è·å– æŒ‡å®šæ¡æ•°(<code>maxMsgNums</code>) æ¶ˆæ¯(<code>Message</code>)ã€‚</li><li>ç¬¬ 14 è‡³ 18 è¡Œ ï¼šåˆ¤æ–­ <code>Store</code> æ˜¯å¦å¤„äºå…³é—­çŠ¶æ€ï¼Œè‹¥å…³é—­ï¼Œåˆ™æ— æ³•è·å–æ¶ˆæ¯ã€‚</li><li>ç¬¬ 19 è‡³ 23 è¡Œ ï¼šåˆ¤æ–­å½“å‰è¿è¡ŒçŠ¶æ€æ˜¯å¦å¯è¯»ï¼Œè‹¥ä¸å¯è¯»ï¼Œåˆ™æ— æ³•è·å–æ¶ˆæ¯ã€‚</li><li>ç¬¬ 37 è¡Œ ï¼šæ ¹æ® ä¸»é¢˜(<code>Topic</code>) + é˜Ÿåˆ—ç¼–å·(<code>queueId</code>) è·å– æ¶ˆæ¯é˜Ÿåˆ—(<code>ConsumeQueue</code>)ã€‚<ul><li><code>#findConsumeQueue(...)</code> ï¼šç¬¬ 159 è‡³ 196 è¡Œã€‚</li></ul></li><li>ç¬¬ 43 è‡³ 58 è¡Œ ï¼šå„ç§é˜Ÿåˆ—ä½ç½®(<code>offset</code>) æ— æ³•è¯»å–æ¶ˆæ¯ï¼Œå¹¶é’ˆå¯¹å¯¹åº”çš„æƒ…å†µï¼Œè®¡ç®—ä¸‹ä¸€æ¬¡ <code>Client</code> é˜Ÿåˆ—æ‹‰å–ä½ç½®ã€‚<ul><li>ç¬¬ 43 è‡³ 45 è¡Œ ï¼šæ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯ã€‚</li><li>ç¬¬ 46 è‡³ 48 è¡Œ ï¼šæŸ¥è¯¢çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ<code>offset</code>ï¼‰ å¤ªå°ã€‚</li><li>ç¬¬ 49 è‡³ 51 è¡Œ ï¼šæŸ¥è¯¢çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ<code>offset</code>ï¼‰ æ°å¥½ç­‰äº æ¶ˆæ¯é˜Ÿåˆ—æœ€å¤§çš„é˜Ÿåˆ—ä½ç½®ã€‚è¯¥æƒ…å†µæ˜¯æ­£å¸¸ç°è±¡ï¼Œç›¸å½“äºæŸ¥è¯¢æœ€æ–°çš„æ¶ˆæ¯ã€‚</li><li>ç¬¬ 52 è‡³ 58 è¡Œ ï¼šæŸ¥è¯¢çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ<code>offset</code>ï¼‰ è¶…è¿‡è¿‡å¤šã€‚</li><li><code>#nextOffsetCorrection(...)</code> ï¼šç¬¬ 198 è‡³ 212 è¡Œã€‚</li></ul></li><li>ç¬¬ 61 è¡Œ ï¼šæ ¹æ® æ¶ˆè´¹é˜Ÿåˆ—ä½ç½®(<code>offset</code>) è·å– å¯¹åº”çš„<code>MappedFile</code>ã€‚</li><li>ç¬¬ 72 è‡³ 128 è¡Œ ï¼š<strong>å¾ªç¯</strong>è·å– <code>æ¶ˆæ¯ä½ç½®ä¿¡æ¯</code>ã€‚<ul><li>ç¬¬ 74 è‡³ 76 è¡Œ ï¼šè¯»å–æ¯ä¸€ä¸ª <code>æ¶ˆæ¯ä½ç½®ä¿¡æ¯</code>ã€‚</li><li>ç¬¬ 79 è‡³ 83 è¡Œ ï¼šå½“ <code>offsetPy</code> å°äº <code>nextPhyFileStartOffset</code> æ—¶ï¼Œæ„å‘³ç€å¯¹<br>åº”çš„ <code>Message</code> å·²ç»ç§»é™¤ï¼Œæ‰€ä»¥ç›´æ¥continueï¼Œç›´åˆ°å¯è¯»å–çš„ <code>Message</code>ã€‚</li><li>ç¬¬ 84 è‡³ 90 è¡Œ ï¼šåˆ¤æ–­æ˜¯å¦å·²ç»è·å¾—è¶³å¤Ÿçš„æ¶ˆæ¯ã€‚<ul><li><code>#checkInDiskByCommitOffset(...)</code> ï¼šç¬¬ 214 è‡³ 224 è¡Œã€‚</li><li><code>#isTheBatchFull(...)</code> ï¼šç¬¬ 226 è‡³ 264 è¡Œã€‚</li></ul></li></ul></li><li>ç¬¬ 92 è¡Œ ï¼šåˆ¤æ–­æ¶ˆæ¯æ˜¯å¦ç¬¦åˆæ¡ä»¶ã€‚è¯¦ç»†è§£æè§ï¼š<a href="defaultmessagefilterismessagematched">DefaultMessageFilter#isMessageMatched(â€¦)</a>ã€‚</li><li>ç¬¬ 94 è¡Œ ï¼šä» <code>CommitLog</code> è·å–å¯¹åº” æ¶ˆæ¯çš„<code>MappedByteBuffer</code>ã€‚</li><li>ç¬¬ 95 è‡³ 99 è¡Œ ï¼šè·å– <code>æ¶ˆæ¯MappedByteBuffer</code> æˆåŠŸã€‚</li><li>ç¬¬ 100 è‡³ 106 è¡Œ ï¼šè·å– <code>æ¶ˆæ¯MappedByteBuffer</code> å¤±è´¥ã€‚ä» <code>CommitLog</code> æ— æ³•è¯»å–åˆ°æ¶ˆæ¯ï¼Œè¯´æ˜ è¯¥æ¶ˆæ¯å¯¹åº”çš„æ–‡ä»¶(<code>MappedFile</code>) å·²ç»åˆ é™¤ï¼Œæ­¤æ—¶è®¡ç®—ä¸‹ä¸€ä¸ª<code>MappedFile</code>çš„èµ·å§‹ä½ç½®ã€‚<strong>è¯¥é€»è¾‘éœ€è¦é…åˆï¼ˆç¬¬ 79 è‡³ 83 è¡Œï¼‰ä¸€èµ·ç†è§£ã€‚</strong></li><li>ç¬¬ 117 è‡³ 120 è¡Œ ï¼šç»Ÿè®¡å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°ã€‚</li><li>ç¬¬ 123 è¡Œ ï¼šè®¡ç®—ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·ã€‚</li><li>ç¬¬ 124 è‡³ 128 è¡Œ ï¼šæ ¹æ®å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°ä¸å†…å­˜åˆ¤æ–­æ˜¯å¦å»ºè®®è¯»å–ä»èŠ‚ç‚¹ã€‚</li><li>ç¬¬ 130 è¡Œ ï¼šé‡Šæ”¾ <code>bufferConsumeQueue</code> å¯¹ <code>MappedFile</code> çš„æŒ‡å‘ã€‚æ­¤å¤„ <code>MappedFile</code> æ˜¯ <code>ConsumeQueue</code> é‡Œçš„æ–‡ä»¶ï¼Œä¸æ˜¯ <code>CommitLog</code> ä¸‹çš„æ–‡ä»¶ã€‚</li><li>ç¬¬ 133 è‡³ 136 è¡Œ ï¼šè·å¾—æ¶ˆè´¹é˜Ÿåˆ—ä½ç½®(<code>offset</code>) è·å– å¯¹åº”çš„<code>MappedFile</code> ä¸º<strong>ç©º</strong>ï¼Œè®¡ç®—<code>ConsumeQueue</code> ä» <code>offset</code> å¼€å§‹çš„ä¸‹ä¸€ä¸ª <code>MappedFile</code> å¯¹åº”çš„ä½ç½®ã€‚</li><li>ç¬¬ 143 è‡³ 150 è¡Œ ï¼šè®°å½•ç»Ÿè®¡ä¿¡æ¯ï¼šæ¶ˆè€—æ—¶é—´ã€æ‹‰å–åˆ°æ¶ˆæ¯/æœªæ‹‰å–åˆ°æ¶ˆæ¯æ¬¡æ•°ã€‚</li><li>ç¬¬ 151 è‡³ 156 è¡Œ ï¼šè®¾ç½®è¿”å›ç»“æœå¹¶è¿”å›ã€‚</li></ul><h2 id="DefaultMessageFilter-isMessageMatched-â€¦"><a href="#DefaultMessageFilter-isMessageMatched-â€¦" class="headerlink" title="DefaultMessageFilter#isMessageMatched(â€¦)"></a>DefaultMessageFilter#isMessageMatched(â€¦)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultMessageFilter</span> <span class="keyword">implements</span> <span class="title">MessageFilter</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">4</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isMessageMatched</span><span class="params">(SubscriptionData subscriptionData, Long tagsCode)</span> </span>&#123;</div><div class="line"> <span class="number">5</span>:         <span class="comment">// æ¶ˆæ¯tagsCode ç©º</span></div><div class="line"> <span class="number">6</span>:         <span class="keyword">if</span> (tagsCode == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">7</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"> <span class="number">8</span>:         &#125;</div><div class="line"> <span class="number">9</span>:         <span class="comment">// è®¢é˜…æ•°æ® ç©º</span></div><div class="line"><span class="number">10</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == subscriptionData) &#123;</div><div class="line"><span class="number">11</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">12</span>:         &#125;</div><div class="line"><span class="number">13</span>:         <span class="comment">// classFilter</span></div><div class="line"><span class="number">14</span>:         <span class="keyword">if</span> (subscriptionData.isClassFilterMode())</div><div class="line"><span class="number">15</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">16</span>:         <span class="comment">// è®¢é˜…è¡¨è¾¾å¼ å…¨åŒ¹é…</span></div><div class="line"><span class="number">17</span>:         <span class="keyword">if</span> (subscriptionData.getSubString().equals(SubscriptionData.SUB_ALL)) &#123;</div><div class="line"><span class="number">18</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">19</span>:         &#125;</div><div class="line"><span class="number">20</span>:         <span class="comment">// è®¢é˜…æ•°æ®codeæ•°ç»„ æ˜¯å¦åŒ…å« æ¶ˆæ¯tagsCode</span></div><div class="line"><span class="number">21</span>:         <span class="keyword">return</span> subscriptionData.getCodeSet().contains(tagsCode.intValue());</div><div class="line"><span class="number">22</span>:     &#125;</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šæ¶ˆæ¯è¿‡æ»¤å™¨é»˜è®¤å®ç°ã€‚</li></ul><h2 id="PullRequestHoldService"><a href="#PullRequestHoldService" class="headerlink" title="PullRequestHoldService"></a>PullRequestHoldService</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PullRequestHoldService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>&#123;</div><div class="line">  <span class="number">2</span>: </div><div class="line">  <span class="number">3</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);</div><div class="line">  <span class="number">4</span>: </div><div class="line">  <span class="number">5</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOPIC_QUEUEID_SEPARATOR = <span class="string">"@"</span>;</div><div class="line">  <span class="number">6</span>: </div><div class="line">  <span class="number">7</span>:     <span class="keyword">private</span> <span class="keyword">final</span> BrokerController brokerController;</div><div class="line">  <span class="number">8</span>: </div><div class="line">  <span class="number">9</span>:     <span class="keyword">private</span> <span class="keyword">final</span> SystemClock systemClock = <span class="keyword">new</span> SystemClock();</div><div class="line"> <span class="number">10</span>:     <span class="comment">/**</span></div><div class="line"> 11:      * æ¶ˆæ¯è¿‡æ»¤å™¨</div><div class="line"> 12:      */</div><div class="line"> <span class="number">13</span>:     <span class="keyword">private</span> <span class="keyword">final</span> MessageFilter messageFilter = <span class="keyword">new</span> DefaultMessageFilter();</div><div class="line"> <span class="number">14</span>:     <span class="comment">/**</span></div><div class="line"> 15:      * æ‹‰å–æ¶ˆæ¯è¯·æ±‚é›†åˆ</div><div class="line"> 16:      */</div><div class="line"> <span class="number">17</span>:     <span class="keyword">private</span> ConcurrentHashMap&lt;String<span class="comment">/* topic@queueId */</span>, ManyPullRequest&gt; pullRequestTable =</div><div class="line"> <span class="number">18</span>:             <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">1024</span>);</div><div class="line"> <span class="number">19</span>: </div><div class="line"> <span class="number">20</span>:     <span class="function"><span class="keyword">public</span> <span class="title">PullRequestHoldService</span><span class="params">(<span class="keyword">final</span> BrokerController brokerController)</span> </span>&#123;</div><div class="line"> <span class="number">21</span>:         <span class="keyword">this</span>.brokerController = brokerController;</div><div class="line"> <span class="number">22</span>:     &#125;</div><div class="line"> <span class="number">23</span>: </div><div class="line"> <span class="number">24</span>:     <span class="comment">/**</span></div><div class="line"> 25:      * æ·»åŠ æ‹‰å–æ¶ˆæ¯æŒ‚èµ·è¯·æ±‚</div><div class="line"> 26:      *</div><div class="line"> 27:      * <span class="doctag">@param</span> topic ä¸»é¢˜</div><div class="line"> 28:      * <span class="doctag">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class="line"> 29:      * <span class="doctag">@param</span> pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class="line"> 30:      */</div><div class="line"> <span class="number">31</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">suspendPullRequest</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class="line"> <span class="number">32</span>:         String key = <span class="keyword">this</span>.buildKey(topic, queueId);</div><div class="line"> <span class="number">33</span>:         ManyPullRequest mpr = <span class="keyword">this</span>.pullRequestTable.get(key);</div><div class="line"> <span class="number">34</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == mpr) &#123;</div><div class="line"> <span class="number">35</span>:             mpr = <span class="keyword">new</span> ManyPullRequest();</div><div class="line"> <span class="number">36</span>:             ManyPullRequest prev = <span class="keyword">this</span>.pullRequestTable.putIfAbsent(key, mpr);</div><div class="line"> <span class="number">37</span>:             <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">38</span>:                 mpr = prev;</div><div class="line"> <span class="number">39</span>:             &#125;</div><div class="line"> <span class="number">40</span>:         &#125;</div><div class="line"> <span class="number">41</span>: </div><div class="line"> <span class="number">42</span>:         mpr.addPullRequest(pullRequest);</div><div class="line"> <span class="number">43</span>:     &#125;</div><div class="line"> <span class="number">44</span>: </div><div class="line"> <span class="number">45</span>:     <span class="comment">/**</span></div><div class="line"> 46:      * æ ¹æ® ä¸»é¢˜ + é˜Ÿåˆ—ç¼–å· åˆ›å»ºå”¯ä¸€æ ‡è¯†</div><div class="line"> 47:      *</div><div class="line"> 48:      * <span class="doctag">@param</span> topic ä¸»é¢˜</div><div class="line"> 49:      * <span class="doctag">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class="line"> 50:      * <span class="doctag">@return</span> key</div><div class="line"> 51:      */</div><div class="line"> <span class="number">52</span>:     <span class="function"><span class="keyword">private</span> String <span class="title">buildKey</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId)</span> </span>&#123;</div><div class="line"> <span class="number">53</span>:         StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line"> <span class="number">54</span>:         sb.append(topic);</div><div class="line"> <span class="number">55</span>:         sb.append(TOPIC_QUEUEID_SEPARATOR);</div><div class="line"> <span class="number">56</span>:         sb.append(queueId);</div><div class="line"> <span class="number">57</span>:         <span class="keyword">return</span> sb.toString();</div><div class="line"> <span class="number">58</span>:     &#125;</div><div class="line"> <span class="number">59</span>: </div><div class="line"> <span class="number">60</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">61</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">62</span>:         log.info(<span class="string">"&#123;&#125; service started"</span>, <span class="keyword">this</span>.getServiceName());</div><div class="line"> <span class="number">63</span>:         <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</div><div class="line"> <span class="number">64</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">65</span>:                 <span class="comment">// æ ¹æ® é•¿è½®è®­ è¿˜æ˜¯ çŸ­è½®è®­ è®¾ç½®ä¸åŒçš„ç­‰å¾…æ—¶é—´</span></div><div class="line"> <span class="number">66</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getBrokerConfig().isLongPollingEnable()) &#123;</div><div class="line"> <span class="number">67</span>:                     <span class="keyword">this</span>.waitForRunning(<span class="number">5</span> * <span class="number">1000</span>);</div><div class="line"> <span class="number">68</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">69</span>:                     <span class="keyword">this</span>.waitForRunning(<span class="keyword">this</span>.brokerController.getBrokerConfig().getShortPollingTimeMills());</div><div class="line"> <span class="number">70</span>:                 &#125;</div><div class="line"> <span class="number">71</span>:                 <span class="comment">// æ£€æŸ¥æŒ‚èµ·è¯·æ±‚æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„</span></div><div class="line"> <span class="number">72</span>:                 <span class="keyword">long</span> beginLockTimestamp = <span class="keyword">this</span>.systemClock.now();</div><div class="line"> <span class="number">73</span>:                 <span class="keyword">this</span>.checkHoldRequest();</div><div class="line"> <span class="number">74</span>:                 <span class="keyword">long</span> costTime = <span class="keyword">this</span>.systemClock.now() - beginLockTimestamp;</div><div class="line"> <span class="number">75</span>:                 <span class="keyword">if</span> (costTime &gt; <span class="number">5</span> * <span class="number">1000</span>) &#123;</div><div class="line"> <span class="number">76</span>:                     log.info(<span class="string">"[NOTIFYME] check hold request cost &#123;&#125; ms."</span>, costTime);</div><div class="line"> <span class="number">77</span>:                 &#125;</div><div class="line"> <span class="number">78</span>:             &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">79</span>:                 log.warn(<span class="keyword">this</span>.getServiceName() + <span class="string">" service has exception. "</span>, e);</div><div class="line"> <span class="number">80</span>:             &#125;</div><div class="line"> <span class="number">81</span>:         &#125;</div><div class="line"> <span class="number">82</span>: </div><div class="line"> <span class="number">83</span>:         log.info(<span class="string">"&#123;&#125; service end"</span>, <span class="keyword">this</span>.getServiceName());</div><div class="line"> <span class="number">84</span>:     &#125;</div><div class="line"> <span class="number">85</span>: </div><div class="line"> <span class="number">86</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">87</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getServiceName</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">88</span>:         <span class="keyword">return</span> PullRequestHoldService.class.getSimpleName();</div><div class="line"> <span class="number">89</span>:     &#125;</div><div class="line"> <span class="number">90</span>: </div><div class="line"> <span class="number">91</span>:     <span class="comment">/**</span></div><div class="line"> 92:      * éå†æŒ‚èµ·è¯·æ±‚ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚ã€‚</div><div class="line"> 93:      */</div><div class="line"> <span class="number">94</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkHoldRequest</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">95</span>:         <span class="keyword">for</span> (String key : <span class="keyword">this</span>.pullRequestTable.keySet()) &#123;</div><div class="line"> <span class="number">96</span>:             String[] kArray = key.split(TOPIC_QUEUEID_SEPARATOR);</div><div class="line"> <span class="number">97</span>:             <span class="keyword">if</span> (<span class="number">2</span> == kArray.length) &#123;</div><div class="line"> <span class="number">98</span>:                 String topic = kArray[<span class="number">0</span>];</div><div class="line"> <span class="number">99</span>:                 <span class="keyword">int</span> queueId = Integer.parseInt(kArray[<span class="number">1</span>]);</div><div class="line"><span class="number">100</span>:                 <span class="keyword">final</span> <span class="keyword">long</span> offset = <span class="keyword">this</span>.brokerController.getMessageStore().getMaxOffsetInQuque(topic, queueId);</div><div class="line"><span class="number">101</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">102</span>:                     <span class="keyword">this</span>.notifyMessageArriving(topic, queueId, offset);</div><div class="line"><span class="number">103</span>:                 &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">104</span>:                     log.error(<span class="string">"check hold request failed. topic=&#123;&#125;, queueId=&#123;&#125;"</span>, topic, queueId, e);</div><div class="line"><span class="number">105</span>:                 &#125;</div><div class="line"><span class="number">106</span>:             &#125;</div><div class="line"><span class="number">107</span>:         &#125;</div><div class="line"><span class="number">108</span>:     &#125;</div><div class="line"><span class="number">109</span>: </div><div class="line"><span class="number">110</span>:     <span class="comment">/**</span></div><div class="line">111:      * æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚</div><div class="line">112:      *</div><div class="line">113:      * <span class="doctag">@param</span> topic ä¸»é¢˜</div><div class="line">114:      * <span class="doctag">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class="line">115:      * <span class="doctag">@param</span> maxOffset æ¶ˆè´¹é˜Ÿåˆ—æœ€å¤§offset</div><div class="line">116:      */</div><div class="line"><span class="number">117</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyMessageArriving</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> maxOffset)</span> </span>&#123;</div><div class="line"><span class="number">118</span>:         notifyMessageArriving(topic, queueId, maxOffset, <span class="keyword">null</span>);</div><div class="line"><span class="number">119</span>:     &#125;</div><div class="line"><span class="number">120</span>: </div><div class="line"><span class="number">121</span>:     <span class="comment">/**</span></div><div class="line">122:      * æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚</div><div class="line">123:      *</div><div class="line">124:      * <span class="doctag">@param</span> topic ä¸»é¢˜</div><div class="line">125:      * <span class="doctag">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class="line">126:      * <span class="doctag">@param</span> maxOffset æ¶ˆè´¹é˜Ÿåˆ—æœ€å¤§offset</div><div class="line">127:      * <span class="doctag">@param</span> tagsCode è¿‡æ»¤tagsCode</div><div class="line">128:      */</div><div class="line"><span class="number">129</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyMessageArriving</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> maxOffset, <span class="keyword">final</span> Long tagsCode)</span> </span>&#123;</div><div class="line"><span class="number">130</span>:         String key = <span class="keyword">this</span>.buildKey(topic, queueId);</div><div class="line"><span class="number">131</span>:         ManyPullRequest mpr = <span class="keyword">this</span>.pullRequestTable.get(key);</div><div class="line"><span class="number">132</span>:         <span class="keyword">if</span> (mpr != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">133</span>:             <span class="comment">//</span></div><div class="line"><span class="number">134</span>:             List&lt;PullRequest&gt; requestList = mpr.cloneListAndClear();</div><div class="line"><span class="number">135</span>:             <span class="keyword">if</span> (requestList != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">136</span>:                 List&lt;PullRequest&gt; replayList = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// ä¸ç¬¦åˆå”¤é†’çš„è¯·æ±‚æ•°ç»„</span></div><div class="line"><span class="number">137</span>: </div><div class="line"><span class="number">138</span>:                 <span class="keyword">for</span> (PullRequest request : requestList) &#123;</div><div class="line"><span class="number">139</span>:                     <span class="comment">// å¦‚æœ maxOffset è¿‡å°ï¼Œåˆ™é‡æ–°è¯»å–ä¸€æ¬¡ã€‚</span></div><div class="line"><span class="number">140</span>:                     <span class="keyword">long</span> newestOffset = maxOffset;</div><div class="line"><span class="number">141</span>:                     <span class="keyword">if</span> (newestOffset &lt;= request.getPullFromThisOffset()) &#123;</div><div class="line"><span class="number">142</span>:                         newestOffset = <span class="keyword">this</span>.brokerController.getMessageStore().getMaxOffsetInQuque(topic, queueId);</div><div class="line"><span class="number">143</span>:                     &#125;</div><div class="line"><span class="number">144</span>:                     <span class="comment">// æœ‰æ–°çš„åŒ¹é…æ¶ˆæ¯ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚</span></div><div class="line"><span class="number">145</span>:                     <span class="keyword">if</span> (newestOffset &gt; request.getPullFromThisOffset()) &#123;</div><div class="line"><span class="number">146</span>:                         <span class="keyword">if</span> (<span class="keyword">this</span>.messageFilter.isMessageMatched(request.getSubscriptionData(), tagsCode)) &#123;</div><div class="line"><span class="number">147</span>:                             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">148</span>:                                 <span class="keyword">this</span>.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(),</div><div class="line"><span class="number">149</span>:                                     request.getRequestCommand());</div><div class="line"><span class="number">150</span>:                             &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">151</span>:                                 log.error(<span class="string">"execute request when wakeup failed."</span>, e);</div><div class="line"><span class="number">152</span>:                             &#125;</div><div class="line"><span class="number">153</span>:                             <span class="keyword">continue</span>;</div><div class="line"><span class="number">154</span>:                         &#125;</div><div class="line"><span class="number">155</span>:                     &#125;</div><div class="line"><span class="number">156</span>:                     <span class="comment">// è¶…è¿‡æŒ‚èµ·æ—¶é—´ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚</span></div><div class="line"><span class="number">157</span>:                     <span class="keyword">if</span> (System.currentTimeMillis() &gt;= (request.getSuspendTimestamp() + request.getTimeoutMillis())) &#123;</div><div class="line"><span class="number">158</span>:                         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">159</span>:                             <span class="keyword">this</span>.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(),</div><div class="line"><span class="number">160</span>:                                 request.getRequestCommand());</div><div class="line"><span class="number">161</span>:                         &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">162</span>:                             log.error(<span class="string">"execute request when wakeup failed."</span>, e);</div><div class="line"><span class="number">163</span>:                         &#125;</div><div class="line"><span class="number">164</span>:                         <span class="keyword">continue</span>;</div><div class="line"><span class="number">165</span>:                     &#125;</div><div class="line"><span class="number">166</span>:                     <span class="comment">// ä¸ç¬¦åˆå†æ¬¡æ‹‰å–çš„è¯·æ±‚ï¼Œå†æ¬¡æ·»åŠ å›å»</span></div><div class="line"><span class="number">167</span>:                     replayList.add(request);</div><div class="line"><span class="number">168</span>:                 &#125;</div><div class="line"><span class="number">169</span>:                 <span class="comment">// æ·»åŠ å›å»</span></div><div class="line"><span class="number">170</span>:                 <span class="keyword">if</span> (!replayList.isEmpty()) &#123;</div><div class="line"><span class="number">171</span>:                     mpr.addPullRequest(replayList);</div><div class="line"><span class="number">172</span>:                 &#125;</div><div class="line"><span class="number">173</span>:             &#125;</div><div class="line"><span class="number">174</span>:         &#125;</div><div class="line"><span class="number">175</span>:     &#125;</div><div class="line"><span class="number">176</span>: &#125;</div></pre></td></tr></table></figure><ul><li><code>PullRequestHoldService</code> è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯è¯·æ±‚æŒ‚èµ·ç»´æŠ¤çº¿ç¨‹æœåŠ¡ã€‚<ul><li>å½“æ‹‰å–æ¶ˆæ¯è¯·æ±‚è·å¾—ä¸äº†æ¶ˆæ¯æ—¶ï¼Œåˆ™ä¼šå°†è¯·æ±‚è¿›è¡ŒæŒ‚èµ·ï¼Œæ·»åŠ åˆ°è¯¥æœåŠ¡ã€‚</li><li>å½“æœ‰ç¬¦åˆæ¡ä»¶ä¿¡æ¯æ—¶ æˆ– æŒ‚èµ·è¶…æ—¶æ—¶ï¼Œé‡æ–°æ‰§è¡Œè·å–æ¶ˆæ¯é€»è¾‘ã€‚</li></ul></li><li><code>#suspendPullRequest(...)</code> è¯´æ˜ ï¼šæ·»åŠ æ‹‰å–æ¶ˆæ¯æŒ‚èµ·è¯·æ±‚åˆ°é›†åˆ( <code>pullRequestTable</code> )ã€‚</li><li><code>#run(...)</code> è¯´æ˜ ï¼š<strong>å®šæ—¶</strong>æ£€æŸ¥æŒ‚èµ·è¯·æ±‚æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥é‡æ–°æ‹‰å–æ¶ˆæ¯å¹¶è¿›è¡Œé€šçŸ¥ã€‚<ul><li>ç¬¬ 65 è‡³ 70 è¡Œ ï¼šæ ¹æ®<code>é•¿è½®è®­</code>or<code>çŸ­è½®è®­</code>è®¾ç½®ä¸åŒçš„ç­‰å¾…æ—¶é—´ã€‚</li><li>ç¬¬ 71 è‡³ 77 è¡Œ ï¼šæ£€æŸ¥æŒ‚èµ·è¯·æ±‚æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„ã€‚</li></ul></li><li><code>#checkHoldRequest(...)</code> è¯´æ˜ ï¼šéå†æŒ‚èµ·è¯·æ±‚ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„ã€‚</li><li><code>#notifyMessageArriving(...)</code> è¯´æ˜ ï¼šæ£€æŸ¥<strong>æŒ‡å®šé˜Ÿåˆ—</strong>æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚ã€‚<ul><li>ç¬¬ 139 è‡³ 143 è¡Œ ï¼šå¦‚æœ <code>maxOffset</code> è¿‡å°ï¼Œé‡æ–°è·å–ä¸€æ¬¡æœ€æ–°çš„ã€‚</li><li>ç¬¬ 144 è‡³ 155 è¡Œ ï¼šæœ‰æ–°çš„åŒ¹é…æ¶ˆæ¯ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚</li><li>ç¬¬ 156 è‡³ 165 è¡Œ ï¼šè¶…è¿‡æŒ‚èµ·æ—¶é—´ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚</li><li>ç¬¬ 148 || 159 è¡Œ ï¼šå”¤é†’è¯·æ±‚ï¼Œå†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚åŸå…ˆæ‹…å¿ƒæ‹‰å–æ¶ˆæ¯æ—¶é—´è¿‡é•¿ï¼Œå¯¼è‡´å½±å“æ•´ä¸ªæŒ‚èµ·è¯·æ±‚çš„éå†ï¼Œåé¢æŸ¥çœ‹<code>#executeRequestWhenWakeup(...)</code>ï¼Œå®é™…æ˜¯ä¸¢åˆ°çº¿ç¨‹æ± è¿›è¡Œä¸€æ­¥çš„æ¶ˆæ¯æ‹‰å–ï¼Œä¸ä¼šæœ‰æ€§èƒ½ä¸Šçš„é—®é¢˜ã€‚è¯¦ç»†è§£æè§ï¼š<a href="pullmessageprocessorexecuterequestwhenwakeup">PullMessageProcessor#executeRequestWhenWakeup(â€¦)</a>ã€‚</li><li>ç¬¬ 166 è‡³ 172 è¡Œ ï¼šä¸ç¬¦åˆå”¤é†’çš„è¯·æ±‚é‡æ–°æ·»åŠ åˆ°é›†åˆ(<code>pullRequestTable</code>)ã€‚</li></ul></li></ul><h2 id="PullMessageProcessor-executeRequestWhenWakeup-â€¦"><a href="#PullMessageProcessor-executeRequestWhenWakeup-â€¦" class="headerlink" title="PullMessageProcessor#executeRequestWhenWakeup(â€¦)"></a>PullMessageProcessor#executeRequestWhenWakeup(â€¦)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeRequestWhenWakeup</span><span class="params">(<span class="keyword">final</span> Channel channel, <span class="keyword">final</span> RemotingCommand request)</span> <span class="keyword">throws</span> RemotingCommandException </span>&#123;</div><div class="line"> <span class="number">2</span>:     Runnable run = <span class="keyword">new</span> Runnable() &#123;</div><div class="line"> <span class="number">3</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">4</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">5</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>:                 <span class="comment">// è°ƒç”¨æ‹‰å–è¯·æ±‚ã€‚æœ¬æ¬¡è°ƒç”¨ï¼Œè®¾ç½®ä¸æŒ‚èµ·è¯·æ±‚ã€‚</span></div><div class="line"> <span class="number">7</span>:                 <span class="keyword">final</span> RemotingCommand response = PullMessageProcessor.<span class="keyword">this</span>.processRequest(channel, request, <span class="keyword">false</span>);</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:                 <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">10</span>:                     response.setOpaque(request.getOpaque());</div><div class="line"><span class="number">11</span>:                     response.markResponseType();</div><div class="line"><span class="number">12</span>:                     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">13</span>:                         channel.writeAndFlush(response).addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</div><div class="line"><span class="number">14</span>:                             <span class="meta">@Override</span></div><div class="line"><span class="number">15</span>:                             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"><span class="number">16</span>:                                 <span class="keyword">if</span> (!future.isSuccess()) &#123;</div><div class="line"><span class="number">17</span>:                                     LOG.error(<span class="string">"ProcessRequestWrapper response to &#123;&#125; failed"</span>, future.channel().remoteAddress(), future.cause());</div><div class="line"><span class="number">18</span>:                                     LOG.error(request.toString());</div><div class="line"><span class="number">19</span>:                                     LOG.error(response.toString());</div><div class="line"><span class="number">20</span>:                                 &#125;</div><div class="line"><span class="number">21</span>:                             &#125;</div><div class="line"><span class="number">22</span>:                         &#125;);</div><div class="line"><span class="number">23</span>:                     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">24</span>:                         LOG.error(<span class="string">"ProcessRequestWrapper process request over, but response failed"</span>, e);</div><div class="line"><span class="number">25</span>:                         LOG.error(request.toString());</div><div class="line"><span class="number">26</span>:                         LOG.error(response.toString());</div><div class="line"><span class="number">27</span>:                     &#125;</div><div class="line"><span class="number">28</span>:                 &#125;</div><div class="line"><span class="number">29</span>:             &#125; <span class="keyword">catch</span> (RemotingCommandException e1) &#123;</div><div class="line"><span class="number">30</span>:                 LOG.error(<span class="string">"ExecuteRequestWhenWakeup run"</span>, e1);</div><div class="line"><span class="number">31</span>:             &#125;</div><div class="line"><span class="number">32</span>:         &#125;</div><div class="line"><span class="number">33</span>:     &#125;;</div><div class="line"><span class="number">34</span>:     <span class="comment">// æäº¤æ‹‰å–è¯·æ±‚åˆ°çº¿ç¨‹æ± </span></div><div class="line"><span class="number">35</span>:     <span class="keyword">this</span>.brokerController.getPullMessageExecutor().submit(<span class="keyword">new</span> RequestTask(run, channel, request));</div><div class="line"><span class="number">36</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šæ‰§è¡Œè¯·æ±‚å”¤é†’ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚è¯¥æ–¹æ³•è°ƒç”¨çº¿ç¨‹æ± ï¼Œå› æ­¤ï¼Œä¸ä¼šé˜»å¡ã€‚</li><li>ç¬¬ 7 è¡Œ ï¼šè°ƒç”¨æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚æœ¬æ¬¡è°ƒç”¨ï¼Œè®¾ç½®å³ä½¿è¯·æ±‚ä¸åˆ°æ¶ˆæ¯ï¼Œä¹Ÿä¸æŒ‚èµ·è¯·æ±‚ã€‚å¦‚æœä¸è®¾ç½®ï¼Œè¯·æ±‚å¯èƒ½è¢«æ— é™æŒ‚èµ·ï¼Œè¢« <code>Broker</code> æ— é™å¾ªç¯ã€‚</li><li>ç¬¬ 35 è¡Œ ï¼š<strong>æäº¤æ‹‰å–æ¶ˆæ¯è¯·æ±‚åˆ°çº¿ç¨‹æ± </strong>ã€‚</li></ul><h1 id="5ã€Broker-æä¾›-æ›´æ–°æ¶ˆè´¹è¿›åº¦-æ¥å£"><a href="#5ã€Broker-æä¾›-æ›´æ–°æ¶ˆè´¹è¿›åº¦-æ¥å£" class="headerlink" title="5ã€Broker æä¾›[æ›´æ–°æ¶ˆè´¹è¿›åº¦]æ¥å£"></a>5ã€Broker æä¾›[æ›´æ–°æ¶ˆè´¹è¿›åº¦]æ¥å£</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">Yunai-MacdeMacBook-Pro-2:config yunai$ <span class="built_in">pwd</span></div><div class="line">/Users/yunai/store/config</div><div class="line">Yunai-MacdeMacBook-Pro-2:config yunai$ ls -ls</div><div class="line">total 40</div><div class="line">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 consumerOffset.json</div><div class="line">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 consumerOffset.json.bak</div><div class="line">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 delayOffset.json</div><div class="line">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 delayOffset.json.bak</div><div class="line">8 -rw-r--r--  1 yunai  staff  1401  4 27 21:51 topics.json</div><div class="line">Yunai-MacdeMacBook-Pro-2:config yunai$ cat consumerOffset.json</div><div class="line">&#123;</div><div class="line">	<span class="string">"offsetTable"</span>:&#123;</div><div class="line">		<span class="string">"%RETRY%please_rename_unique_group_name_4@please_rename_unique_group_name_4"</span>:&#123;0:0</div><div class="line">		&#125;,</div><div class="line">		<span class="string">"TopicRead3@please_rename_unique_group_name_4"</span>:&#123;1:5</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>consumerOffset.json</code> ï¼šæ¶ˆè´¹è¿›åº¦å­˜å‚¨æ–‡ä»¶ã€‚</li><li><code>consumerOffset.json.bak</code> ï¼šæ¶ˆè´¹è¿›åº¦å­˜å‚¨æ–‡ä»¶å¤‡ä»½ã€‚</li><li>æ¯æ¬¡å†™å…¥ <code>consumerOffset.json</code>ï¼Œå°†åŸå†…å®¹å¤‡ä»½åˆ° <code>consumerOffset.json.bak</code>ã€‚å®ç°è§ï¼š<a href="mixallstring2file">MixAll#string2File(â€¦)</a>ã€‚</li></ul><h2 id="BrokerController-initialize-â€¦"><a href="#BrokerController-initialize-â€¦" class="headerlink" title="BrokerController#initialize(â€¦)"></a>BrokerController#initialize(â€¦)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>:<span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"> <span class="number">2</span>:    <span class="meta">@Override</span></div><div class="line"> <span class="number">3</span>:    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">4</span>:        <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">5</span>:            BrokerController.<span class="keyword">this</span>.consumerOffsetManager.persist();</div><div class="line"> <span class="number">6</span>:        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">7</span>:            log.error(<span class="string">"schedule persist consumerOffset error."</span>, e);</div><div class="line"> <span class="number">8</span>:        &#125;</div><div class="line"> <span class="number">9</span>:    &#125;</div><div class="line"><span class="number">10</span>:&#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="keyword">this</span>.brokerConfig.getFlushConsumerOffsetInterval(), TimeUnit.MILLISECONDS);</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šæ¯ 5s æ‰§è¡Œä¸€æ¬¡æŒä¹…åŒ–é€»è¾‘ã€‚</li></ul><h2 id="ConfigManager"><a href="#ConfigManager" class="headerlink" title="ConfigManager"></a>ConfigManager</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigManager</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger PLOG = LoggerFactory.getLogger(LoggerName.COMMON_LOGGER_NAME);</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>: <span class="comment">/**</span></div><div class="line"> 5:  * ç¼–ç å†…å®¹</div><div class="line"> 6:  * <span class="doctag">@return</span> ç¼–ç åçš„å†…å®¹</div><div class="line"> 7:  */</div><div class="line"> <span class="number">8</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">encode</span><span class="params">()</span></span>;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>: <span class="comment">/**</span></div><div class="line">11:  * åŠ è½½æ–‡ä»¶</div><div class="line">12:  *</div><div class="line">13:  * <span class="doctag">@return</span> åŠ è½½æ˜¯å¦æˆåŠŸ</div><div class="line">14:  */</div><div class="line"><span class="number">15</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">16</span>:     String fileName = <span class="keyword">null</span>;</div><div class="line"><span class="number">17</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">18</span>:         fileName = <span class="keyword">this</span>.configFilePath();</div><div class="line"><span class="number">19</span>:         String jsonString = MixAll.file2String(fileName);</div><div class="line"><span class="number">20</span>:         <span class="comment">// å¦‚æœå†…å®¹ä¸å­˜åœ¨ï¼Œåˆ™åŠ è½½å¤‡ä»½æ–‡ä»¶</span></div><div class="line"><span class="number">21</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == jsonString || jsonString.length() == <span class="number">0</span>) &#123;</div><div class="line"><span class="number">22</span>:             <span class="keyword">return</span> <span class="keyword">this</span>.loadBak();</div><div class="line"><span class="number">23</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">24</span>:             <span class="keyword">this</span>.decode(jsonString);</div><div class="line"><span class="number">25</span>:             PLOG.info(<span class="string">"load &#123;&#125; OK"</span>, fileName);</div><div class="line"><span class="number">26</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">27</span>:         &#125;</div><div class="line"><span class="number">28</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">29</span>:         PLOG.error(<span class="string">"load "</span> + fileName + <span class="string">" Failed, and try to load backup file"</span>, e);</div><div class="line"><span class="number">30</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.loadBak();</div><div class="line"><span class="number">31</span>:     &#125;</div><div class="line"><span class="number">32</span>: &#125;</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>: <span class="comment">/**</span></div><div class="line">35:  * é…ç½®æ–‡ä»¶åœ°å€</div><div class="line">36:  *</div><div class="line">37:  * <span class="doctag">@return</span> é…ç½®æ–‡ä»¶åœ°å€</div><div class="line">38:  */</div><div class="line"><span class="number">39</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">configFilePath</span><span class="params">()</span></span>;</div><div class="line"><span class="number">40</span>: </div><div class="line"><span class="number">41</span>: <span class="comment">/**</span></div><div class="line">42:  * åŠ è½½å¤‡ä»½æ–‡ä»¶</div><div class="line">43:  *</div><div class="line">44:  * <span class="doctag">@return</span> æ˜¯å¦æˆåŠŸ</div><div class="line">45:  */</div><div class="line"><span class="number">46</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">loadBak</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">47</span>:     String fileName = <span class="keyword">null</span>;</div><div class="line"><span class="number">48</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">49</span>:         fileName = <span class="keyword">this</span>.configFilePath();</div><div class="line"><span class="number">50</span>:         String jsonString = MixAll.file2String(fileName + <span class="string">".bak"</span>);</div><div class="line"><span class="number">51</span>:         <span class="keyword">if</span> (jsonString != <span class="keyword">null</span> &amp;&amp; jsonString.length() &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">52</span>:             <span class="keyword">this</span>.decode(jsonString);</div><div class="line"><span class="number">53</span>:             PLOG.info(<span class="string">"load "</span> + fileName + <span class="string">" OK"</span>);</div><div class="line"><span class="number">54</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">55</span>:         &#125;</div><div class="line"><span class="number">56</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">57</span>:         PLOG.error(<span class="string">"load "</span> + fileName + <span class="string">" Failed"</span>, e);</div><div class="line"><span class="number">58</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">59</span>:     &#125;</div><div class="line"><span class="number">60</span>: </div><div class="line"><span class="number">61</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">62</span>: &#125;</div><div class="line"><span class="number">63</span>: </div><div class="line"><span class="number">64</span>: <span class="comment">/**</span></div><div class="line">65:  * è§£ç å†…å®¹</div><div class="line">66:  *</div><div class="line">67:  * <span class="doctag">@param</span> jsonString å†…å®¹</div><div class="line">68:  */</div><div class="line"><span class="number">69</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(<span class="keyword">final</span> String jsonString)</span></span>;</div><div class="line"><span class="number">70</span>: </div><div class="line"><span class="number">71</span>: <span class="comment">/**</span></div><div class="line">72:  * æŒä¹…åŒ–</div><div class="line">73:  */</div><div class="line"><span class="number">74</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">persist</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">75</span>:     String jsonString = <span class="keyword">this</span>.encode(<span class="keyword">true</span>);</div><div class="line"><span class="number">76</span>:     <span class="keyword">if</span> (jsonString != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">77</span>:         String fileName = <span class="keyword">this</span>.configFilePath();</div><div class="line"><span class="number">78</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">79</span>:             MixAll.string2File(jsonString, fileName);</div><div class="line"><span class="number">80</span>:         &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line"><span class="number">81</span>:             PLOG.error(<span class="string">"persist file Exception, "</span> + fileName, e);</div><div class="line"><span class="number">82</span>:         &#125;</div><div class="line"><span class="number">83</span>:     &#125;</div><div class="line"><span class="number">84</span>: &#125;</div><div class="line"><span class="number">85</span>: </div><div class="line"><span class="number">86</span>: <span class="comment">/**</span></div><div class="line">87:  * ç¼–ç å­˜å‚¨å†…å®¹</div><div class="line">88:  *</div><div class="line">89:  * <span class="doctag">@param</span> prettyFormat æ˜¯å¦æ ¼å¼åŒ–</div><div class="line">90:  * <span class="doctag">@return</span> å†…å®¹</div><div class="line">91:  */</div><div class="line"><span class="number">92</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">encode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> prettyFormat)</span></span>;</div><div class="line"><span class="number">93</span>: &#125;</div></pre></td></tr></table></figure><h3 id="MixAll-string2File-â€¦"><a href="#MixAll-string2File-â€¦" class="headerlink" title="MixAll#string2File(â€¦)"></a>MixAll#string2File(â€¦)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * å°†å†…å®¹å†™åˆ°æ–‡ä»¶</div><div class="line"> 3:  * å®‰å…¨å†™</div><div class="line"> 4:  * 1. å†™åˆ°.tmpæ–‡ä»¶</div><div class="line"> 5:  * 2. å¤‡ä»½å‡†å¤‡å†™å…¥æ–‡ä»¶åˆ°.bakæ–‡ä»¶</div><div class="line"> 6:  * 3. åˆ é™¤åŸæ–‡ä»¶ï¼Œå°†.tmpä¿®æ”¹æˆæ–‡ä»¶</div><div class="line"> 7:  *</div><div class="line"> 8:  * <span class="doctag">@param</span> str å†…å®¹</div><div class="line"> 9:  * <span class="doctag">@param</span> fileName æ–‡ä»¶å</div><div class="line">10:  * <span class="doctag">@throws</span> IOException å½“IOå‘ç”Ÿå¼‚å¸¸æ—¶</div><div class="line">11:  */</div><div class="line"><span class="number">12</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">string2File</span><span class="params">(<span class="keyword">final</span> String str, <span class="keyword">final</span> String fileName)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"><span class="number">13</span>:     <span class="comment">// å†™åˆ° tmpæ–‡ä»¶</span></div><div class="line"><span class="number">14</span>:     String tmpFile = fileName + <span class="string">".tmp"</span>;</div><div class="line"><span class="number">15</span>:     string2FileNotSafe(str, tmpFile);</div><div class="line"><span class="number">16</span>:     <span class="comment">//</span></div><div class="line"><span class="number">17</span>:     String bakFile = fileName + <span class="string">".bak"</span>;</div><div class="line"><span class="number">18</span>:     String prevContent = file2String(fileName);</div><div class="line"><span class="number">19</span>:     <span class="keyword">if</span> (prevContent != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">20</span>:         string2FileNotSafe(prevContent, bakFile);</div><div class="line"><span class="number">21</span>:     &#125;</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>:     File file = <span class="keyword">new</span> File(fileName);</div><div class="line"><span class="number">24</span>:     file.delete();</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:     file = <span class="keyword">new</span> File(tmpFile);</div><div class="line"><span class="number">27</span>:     file.renameTo(<span class="keyword">new</span> File(fileName));</div><div class="line"><span class="number">28</span>: &#125;</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>: <span class="comment">/**</span></div><div class="line">31:  * å°†å†…å®¹å†™åˆ°æ–‡ä»¶</div><div class="line">32:  * éå®‰å…¨å†™</div><div class="line">33:  *</div><div class="line">34:  * <span class="doctag">@param</span> str å†…å®¹</div><div class="line">35:  * <span class="doctag">@param</span> fileName æ–‡ä»¶å†…å®¹</div><div class="line">36:  * <span class="doctag">@throws</span> IOException å½“IOå‘ç”Ÿå¼‚å¸¸æ—¶</div><div class="line">37:  */</div><div class="line"><span class="number">38</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">string2FileNotSafe</span><span class="params">(<span class="keyword">final</span> String str, <span class="keyword">final</span> String fileName)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"><span class="number">39</span>:     File file = <span class="keyword">new</span> File(fileName);</div><div class="line"><span class="number">40</span>:     <span class="comment">// åˆ›å»ºä¸Šçº§ç›®å½•</span></div><div class="line"><span class="number">41</span>:     File fileParent = file.getParentFile();</div><div class="line"><span class="number">42</span>:     <span class="keyword">if</span> (fileParent != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">43</span>:         fileParent.mkdirs();</div><div class="line"><span class="number">44</span>:     &#125;</div><div class="line"><span class="number">45</span>:     <span class="comment">// å†™å†…å®¹</span></div><div class="line"><span class="number">46</span>:     FileWriter fileWriter = <span class="keyword">null</span>;</div><div class="line"><span class="number">47</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">48</span>:         fileWriter = <span class="keyword">new</span> FileWriter(file);</div><div class="line"><span class="number">49</span>:         fileWriter.write(str);</div><div class="line"><span class="number">50</span>:     &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line"><span class="number">51</span>:         <span class="keyword">throw</span> e;</div><div class="line"><span class="number">52</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">53</span>:         <span class="keyword">if</span> (fileWriter != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">54</span>:             fileWriter.close();</div><div class="line"><span class="number">55</span>:         &#125;</div><div class="line"><span class="number">56</span>:     &#125;</div><div class="line"><span class="number">57</span>: &#125;</div></pre></td></tr></table></figure><h2 id="ConsumerOffsetManager"><a href="#ConsumerOffsetManager" class="headerlink" title="ConsumerOffsetManager"></a>ConsumerOffsetManager</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerOffsetManager</span> <span class="keyword">extends</span> <span class="title">ConfigManager</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);</div><div class="line"> <span class="number">3</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOPIC_GROUP_SEPARATOR = <span class="string">"@"</span>;</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     <span class="comment">/**</span></div><div class="line"> 6:      * æ¶ˆè´¹è¿›åº¦é›†åˆ</div><div class="line"> 7:      */</div><div class="line"> <span class="number">8</span>:     <span class="keyword">private</span> ConcurrentHashMap&lt;String<span class="comment">/* topic@group */</span>, ConcurrentHashMap&lt;Integer, Long&gt;&gt; offsetTable = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">512</span>);</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>:     <span class="keyword">private</span> <span class="keyword">transient</span> BrokerController brokerController;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:     <span class="function"><span class="keyword">public</span> <span class="title">ConsumerOffsetManager</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">13</span>:     &#125;</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:     <span class="function"><span class="keyword">public</span> <span class="title">ConsumerOffsetManager</span><span class="params">(BrokerController brokerController)</span> </span>&#123;</div><div class="line"><span class="number">16</span>:         <span class="keyword">this</span>.brokerController = brokerController;</div><div class="line"><span class="number">17</span>:     &#125;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="comment">/**</span></div><div class="line">20:      * æäº¤æ¶ˆè´¹è¿›åº¦</div><div class="line">21:      *</div><div class="line">22:      * <span class="doctag">@param</span> clientHost æäº¤clientåœ°å€</div><div class="line">23:      * <span class="doctag">@param</span> group æ¶ˆè´¹åˆ†ç»„</div><div class="line">24:      * <span class="doctag">@param</span> topic ä¸»é¢˜</div><div class="line">25:      * <span class="doctag">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class="line">26:      * <span class="doctag">@param</span> offset è¿›åº¦ï¼ˆé˜Ÿåˆ—ä½ç½®ï¼‰</div><div class="line">27:      */</div><div class="line"><span class="number">28</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commitOffset</span><span class="params">(<span class="keyword">final</span> String clientHost, <span class="keyword">final</span> String group, <span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> offset)</span> </span>&#123;</div><div class="line"><span class="number">29</span>:         <span class="comment">// topic@group</span></div><div class="line"><span class="number">30</span>:         String key = topic + TOPIC_GROUP_SEPARATOR + group;</div><div class="line"><span class="number">31</span>:         <span class="keyword">this</span>.commitOffset(clientHost, key, queueId, offset);</div><div class="line"><span class="number">32</span>:     &#125;</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>:     <span class="comment">/**</span></div><div class="line">35:      * æäº¤æ¶ˆè´¹è¿›åº¦</div><div class="line">36:      *</div><div class="line">37:      * <span class="doctag">@param</span> clientHost æäº¤clientåœ°å€</div><div class="line">38:      * <span class="doctag">@param</span> key ä¸»é¢˜@æ¶ˆè´¹åˆ†ç»„</div><div class="line">39:      * <span class="doctag">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class="line">40:      * <span class="doctag">@param</span> offset è¿›åº¦ï¼ˆé˜Ÿåˆ—ä½ç½®ï¼‰</div><div class="line">41:      */</div><div class="line"><span class="number">42</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">commitOffset</span><span class="params">(<span class="keyword">final</span> String clientHost, <span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> offset)</span> </span>&#123;</div><div class="line"><span class="number">43</span>:         ConcurrentHashMap&lt;Integer, Long&gt; map = <span class="keyword">this</span>.offsetTable.get(key);</div><div class="line"><span class="number">44</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == map) &#123;</div><div class="line"><span class="number">45</span>:             map = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">32</span>);</div><div class="line"><span class="number">46</span>:             map.put(queueId, offset);</div><div class="line"><span class="number">47</span>:             <span class="keyword">this</span>.offsetTable.put(key, map);</div><div class="line"><span class="number">48</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">49</span>:             Long storeOffset = map.put(queueId, offset);</div><div class="line"><span class="number">50</span>:             <span class="keyword">if</span> (storeOffset != <span class="keyword">null</span> &amp;&amp; offset &lt; storeOffset) &#123;</div><div class="line"><span class="number">51</span>:                 log.warn(<span class="string">"[NOTIFYME]update consumer offset less than store. clientHost=&#123;&#125;, key=&#123;&#125;, queueId=&#123;&#125;, requestOffset=&#123;&#125;, storeOffset=&#123;&#125;"</span>, clientHost, key, queueId, offset, storeOffset);</div><div class="line"><span class="number">52</span>:             &#125;</div><div class="line"><span class="number">53</span>:         &#125;</div><div class="line"><span class="number">54</span>:     &#125;</div><div class="line"><span class="number">55</span>: </div><div class="line"><span class="number">56</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">57</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.encode(<span class="keyword">false</span>);</div><div class="line"><span class="number">58</span>:     &#125;</div><div class="line"><span class="number">59</span>: </div><div class="line"><span class="number">60</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">61</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">configFilePath</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">62</span>:         <span class="keyword">return</span> BrokerPathConfigHelper.getConsumerOffsetPath(<span class="keyword">this</span>.brokerController.getMessageStoreConfig().getStorePathRootDir());</div><div class="line"><span class="number">63</span>:     &#125;</div><div class="line"><span class="number">64</span>: </div><div class="line"><span class="number">65</span>:     <span class="comment">/**</span></div><div class="line">66:      * è§£ç å†…å®¹</div><div class="line">67:      * æ ¼å¼:JSON</div><div class="line">68:      *</div><div class="line">69:      * <span class="doctag">@param</span> jsonString å†…å®¹</div><div class="line">70:      */</div><div class="line"><span class="number">71</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">72</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(String jsonString)</span> </span>&#123;</div><div class="line"><span class="number">73</span>:         <span class="keyword">if</span> (jsonString != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">74</span>:             ConsumerOffsetManager obj = RemotingSerializable.fromJson(jsonString, ConsumerOffsetManager.class);</div><div class="line"><span class="number">75</span>:             <span class="keyword">if</span> (obj != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">76</span>:                 <span class="keyword">this</span>.offsetTable = obj.offsetTable;</div><div class="line"><span class="number">77</span>:             &#125;</div><div class="line"><span class="number">78</span>:         &#125;</div><div class="line"><span class="number">79</span>:     &#125;</div><div class="line"><span class="number">80</span>: </div><div class="line"><span class="number">81</span>:     <span class="comment">/**</span></div><div class="line">82:      * ç¼–ç å†…å®¹</div><div class="line">83:      * æ ¼å¼ä¸ºJSON</div><div class="line">84:      *</div><div class="line">85:      * <span class="doctag">@param</span> prettyFormat æ˜¯å¦æ ¼å¼åŒ–</div><div class="line">86:      * <span class="doctag">@return</span> ç¼–ç åçš„å†…å®¹</div><div class="line">87:      */</div><div class="line"><span class="number">88</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> prettyFormat)</span> </span>&#123;</div><div class="line"><span class="number">89</span>:         <span class="keyword">return</span> RemotingSerializable.toJson(<span class="keyword">this</span>, prettyFormat);</div><div class="line"><span class="number">90</span>:     &#125;</div><div class="line"><span class="number">91</span>: </div><div class="line"><span class="number">92</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šæ¶ˆè´¹è¿›åº¦ç®¡ç†å™¨ã€‚</li></ul><h1 id="6ã€Broker-æä¾›-å‘å›æ¶ˆæ¯-æ¥å£"><a href="#6ã€Broker-æä¾›-å‘å›æ¶ˆæ¯-æ¥å£" class="headerlink" title="6ã€Broker æä¾›[å‘å›æ¶ˆæ¯]æ¥å£"></a>6ã€Broker æä¾›[å‘å›æ¶ˆæ¯]æ¥å£</h1><p>å¤§éƒ¨åˆ†é€»è¾‘å’Œ <a href="http://www.yunai.me/RocketMQ/message-send-and-receive/#3ã€Broker-æ¥æ”¶æ¶ˆæ¯"><code>Broker</code> æä¾›[æ¥æ”¶æ¶ˆæ¯]æ¥å£</a> ç±»ä¼¼ï¼Œå¯ä»¥å…ˆçœ‹ä¸‹ç›¸å…³å†…å®¹ã€‚</p><h2 id="SendMessageProcessor-consumerSendMsgBack-â€¦"><a href="#SendMessageProcessor-consumerSendMsgBack-â€¦" class="headerlink" title="SendMessageProcessor#consumerSendMsgBack(â€¦)"></a>SendMessageProcessor#consumerSendMsgBack(â€¦)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> RemotingCommand <span class="title">consumerSendMsgBack</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx, <span class="keyword">final</span> RemotingCommand request)</span></span></div><div class="line">  2:     <span class="keyword">throws</span> RemotingCommandException &#123;</div><div class="line">  <span class="number">3</span>: </div><div class="line">  <span class="number">4</span>:     <span class="comment">// åˆå§‹åŒ–å“åº”</span></div><div class="line">  <span class="number">5</span>:     <span class="keyword">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(<span class="keyword">null</span>);</div><div class="line">  <span class="number">6</span>:     <span class="keyword">final</span> ConsumerSendMsgBackRequestHeader requestHeader =</div><div class="line">  <span class="number">7</span>:         (ConsumerSendMsgBackRequestHeader) request.decodeCommandCustomHeader(ConsumerSendMsgBackRequestHeader.class);</div><div class="line">  <span class="number">8</span>: </div><div class="line">  <span class="number">9</span>:     <span class="comment">// hookï¼ˆç‹¬æœ‰ï¼‰</span></div><div class="line"> <span class="number">10</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.hasConsumeMessageHook() &amp;&amp; !UtilAll.isBlank(requestHeader.getOriginMsgId())) &#123;</div><div class="line"> <span class="number">11</span>: </div><div class="line"> <span class="number">12</span>:         ConsumeMessageContext context = <span class="keyword">new</span> ConsumeMessageContext();</div><div class="line"> <span class="number">13</span>:         context.setConsumerGroup(requestHeader.getGroup());</div><div class="line"> <span class="number">14</span>:         context.setTopic(requestHeader.getOriginTopic());</div><div class="line"> <span class="number">15</span>:         context.setCommercialRcvStats(BrokerStatsManager.StatsType.SEND_BACK);</div><div class="line"> <span class="number">16</span>:         context.setCommercialRcvTimes(<span class="number">1</span>);</div><div class="line"> <span class="number">17</span>:         context.setCommercialOwner(request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER));</div><div class="line"> <span class="number">18</span>: </div><div class="line"> <span class="number">19</span>:         <span class="keyword">this</span>.executeConsumeMessageHookAfter(context);</div><div class="line"> <span class="number">20</span>:     &#125;</div><div class="line"> <span class="number">21</span>: </div><div class="line"> <span class="number">22</span>:     <span class="comment">// åˆ¤æ–­æ¶ˆè´¹åˆ†ç»„æ˜¯å¦å­˜åœ¨ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class="line"> <span class="number">23</span>:     SubscriptionGroupConfig subscriptionGroupConfig =</div><div class="line"> <span class="number">24</span>:         <span class="keyword">this</span>.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(requestHeader.getGroup());</div><div class="line"> <span class="number">25</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == subscriptionGroupConfig) &#123;</div><div class="line"> <span class="number">26</span>:         response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);</div><div class="line"> <span class="number">27</span>:         response.setRemark(<span class="string">"subscription group not exist, "</span> + requestHeader.getGroup() + <span class="string">" "</span></div><div class="line"> <span class="number">28</span>:             + FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST));</div><div class="line"> <span class="number">29</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">30</span>:     &#125;</div><div class="line"> <span class="number">31</span>: </div><div class="line"> <span class="number">32</span>:     <span class="comment">// æ£€æŸ¥ broker æ˜¯å¦æœ‰å†™å…¥æƒé™</span></div><div class="line"> <span class="number">33</span>:     <span class="keyword">if</span> (!PermName.isWriteable(<span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerPermission())) &#123;</div><div class="line"> <span class="number">34</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"> <span class="number">35</span>:         response.setRemark(<span class="string">"the broker["</span> + <span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerIP1() + <span class="string">"] sending message is forbidden"</span>);</div><div class="line"> <span class="number">36</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">37</span>:     &#125;</div><div class="line"> <span class="number">38</span>: </div><div class="line"> <span class="number">39</span>:     <span class="comment">// æ£€æŸ¥ é‡è¯•é˜Ÿåˆ—æ•° æ˜¯å¦å¤§äº0ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class="line"> <span class="number">40</span>:     <span class="keyword">if</span> (subscriptionGroupConfig.getRetryQueueNums() &lt;= <span class="number">0</span>) &#123;</div><div class="line"> <span class="number">41</span>:         response.setCode(ResponseCode.SUCCESS);</div><div class="line"> <span class="number">42</span>:         response.setRemark(<span class="keyword">null</span>);</div><div class="line"> <span class="number">43</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">44</span>:     &#125;</div><div class="line"> <span class="number">45</span>: </div><div class="line"> <span class="number">46</span>:     <span class="comment">// è®¡ç®—retry Topic</span></div><div class="line"> <span class="number">47</span>:     String newTopic = MixAll.getRetryTopic(requestHeader.getGroup());</div><div class="line"> <span class="number">48</span>: </div><div class="line"> <span class="number">49</span>:     <span class="comment">// è®¡ç®—é˜Ÿåˆ—ç¼–å·ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class="line"> <span class="number">50</span>:     <span class="keyword">int</span> queueIdInt = Math.abs(<span class="keyword">this</span>.random.nextInt() % <span class="number">99999999</span>) % subscriptionGroupConfig.getRetryQueueNums();</div><div class="line"> <span class="number">51</span>: </div><div class="line"> <span class="number">52</span>:     <span class="comment">// è®¡ç®—sysFlagï¼ˆç‹¬æœ‰ï¼‰</span></div><div class="line"> <span class="number">53</span>:     <span class="keyword">int</span> topicSysFlag = <span class="number">0</span>;</div><div class="line"> <span class="number">54</span>:     <span class="keyword">if</span> (requestHeader.isUnitMode()) &#123;</div><div class="line"> <span class="number">55</span>:         topicSysFlag = TopicSysFlag.buildSysFlag(<span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line"> <span class="number">56</span>:     &#125;</div><div class="line"> <span class="number">57</span>: </div><div class="line"> <span class="number">58</span>:     <span class="comment">// è·å–topicConfigã€‚å¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™è¿›è¡Œåˆ›å»º</span></div><div class="line"> <span class="number">59</span>:     TopicConfig topicConfig = <span class="keyword">this</span>.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(<span class="comment">//</span></div><div class="line"> <span class="number">60</span>:         newTopic, <span class="comment">//</span></div><div class="line"> <span class="number">61</span>:         subscriptionGroupConfig.getRetryQueueNums(), <span class="comment">//</span></div><div class="line"> <span class="number">62</span>:         PermName.PERM_WRITE | PermName.PERM_READ, topicSysFlag);</div><div class="line"> <span class="number">63</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == topicConfig) &#123; <span class="comment">// æ²¡æœ‰é…ç½®</span></div><div class="line"> <span class="number">64</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"> <span class="number">65</span>:         response.setRemark(<span class="string">"topic["</span> + newTopic + <span class="string">"] not exist"</span>);</div><div class="line"> <span class="number">66</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">67</span>:     &#125;</div><div class="line"> <span class="number">68</span>:     <span class="keyword">if</span> (!PermName.isWriteable(topicConfig.getPerm())) &#123; <span class="comment">// ä¸å…è®¸å†™å…¥</span></div><div class="line"> <span class="number">69</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"> <span class="number">70</span>:         response.setRemark(String.format(<span class="string">"the topic[%s] sending message is forbidden"</span>, newTopic));</div><div class="line"> <span class="number">71</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">72</span>:     &#125;</div><div class="line"> <span class="number">73</span>: </div><div class="line"> <span class="number">74</span>:     <span class="comment">// æŸ¥è¯¢æ¶ˆæ¯ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿”å›å¼‚å¸¸é”™è¯¯ã€‚ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class="line"> <span class="number">75</span>:     MessageExt msgExt = <span class="keyword">this</span>.brokerController.getMessageStore().lookMessageByOffset(requestHeader.getOffset());</div><div class="line"> <span class="number">76</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == msgExt) &#123;</div><div class="line"> <span class="number">77</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"> <span class="number">78</span>:         response.setRemark(<span class="string">"look message by offset failed, "</span> + requestHeader.getOffset());</div><div class="line"> <span class="number">79</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">80</span>:     &#125;</div><div class="line"> <span class="number">81</span>: </div><div class="line"> <span class="number">82</span>:     <span class="comment">// è®¾ç½®retryTopicåˆ°æ‹“å±•å±æ€§ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class="line"> <span class="number">83</span>:     <span class="keyword">final</span> String retryTopic = msgExt.getProperty(MessageConst.PROPERTY_RETRY_TOPIC);</div><div class="line"> <span class="number">84</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == retryTopic) &#123;</div><div class="line"> <span class="number">85</span>:         MessageAccessor.putProperty(msgExt, MessageConst.PROPERTY_RETRY_TOPIC, msgExt.getTopic());</div><div class="line"> <span class="number">86</span>:     &#125;</div><div class="line"> <span class="number">87</span>: </div><div class="line"> <span class="number">88</span>:     <span class="comment">// è®¾ç½®æ¶ˆæ¯ä¸ç­‰å¾…å­˜å‚¨å®Œæˆï¼ˆç‹¬æœ‰ï¼‰ TODO ç–‘é—®ï¼šå¦‚æœè®¾ç½®æˆä¸ç­‰å¾…å­˜å‚¨ï¼Œbrokerè®¾ç½®æˆåŒæ­¥è½ç›˜ï¼Œå²‚ä¸æ˜¯ä¸èƒ½æ‰¹é‡æäº¤äº†ï¼Ÿ</span></div><div class="line"> <span class="number">89</span>:     msgExt.setWaitStoreMsgOK(<span class="keyword">false</span>);</div><div class="line"> <span class="number">90</span>: </div><div class="line"> <span class="number">91</span>:     <span class="comment">// å¤„ç† delayLevelï¼ˆç‹¬æœ‰ï¼‰ã€‚</span></div><div class="line"> <span class="number">92</span>:     <span class="keyword">int</span> delayLevel = requestHeader.getDelayLevel();</div><div class="line"> <span class="number">93</span>:     <span class="keyword">int</span> maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();</div><div class="line"> <span class="number">94</span>:     <span class="keyword">if</span> (request.getVersion() &gt;= MQVersion.Version.V3_4_9.ordinal()) &#123;</div><div class="line"> <span class="number">95</span>:         maxReconsumeTimes = requestHeader.getMaxReconsumeTimes();</div><div class="line"> <span class="number">96</span>:     &#125;</div><div class="line"> <span class="number">97</span>:     <span class="keyword">if</span> (msgExt.getReconsumeTimes() &gt;= maxReconsumeTimes<span class="comment">//</span></div><div class="line"> <span class="number">98</span>:         || delayLevel &lt; <span class="number">0</span>) &#123; <span class="comment">// å¦‚æœè¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°ï¼Œåˆ™topicä¿®æ”¹æˆ"%DLQ%" + åˆ†ç»„åï¼Œå³åŠ å…¥ æ­»ä¿¡é˜Ÿåˆ—(Dead Letter Queue)</span></div><div class="line"> <span class="number">99</span>:         newTopic = MixAll.getDLQTopic(requestHeader.getGroup());</div><div class="line"><span class="number">100</span>:         queueIdInt = Math.abs(<span class="keyword">this</span>.random.nextInt() % <span class="number">99999999</span>) % DLQ_NUMS_PER_GROUP;</div><div class="line"><span class="number">101</span>: </div><div class="line"><span class="number">102</span>:         topicConfig = <span class="keyword">this</span>.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(newTopic, <span class="comment">//</span></div><div class="line"><span class="number">103</span>:             DLQ_NUMS_PER_GROUP, <span class="comment">//</span></div><div class="line"><span class="number">104</span>:             PermName.PERM_WRITE, <span class="number">0</span></div><div class="line"><span class="number">105</span>:         );</div><div class="line"><span class="number">106</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == topicConfig) &#123;</div><div class="line"><span class="number">107</span>:             response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">108</span>:             response.setRemark(<span class="string">"topic["</span> + newTopic + <span class="string">"] not exist"</span>);</div><div class="line"><span class="number">109</span>:             <span class="keyword">return</span> response;</div><div class="line"><span class="number">110</span>:         &#125;</div><div class="line"><span class="number">111</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">112</span>:         <span class="keyword">if</span> (<span class="number">0</span> == delayLevel) &#123;</div><div class="line"><span class="number">113</span>:             delayLevel = <span class="number">3</span> + msgExt.getReconsumeTimes();</div><div class="line"><span class="number">114</span>:         &#125;</div><div class="line"><span class="number">115</span>:         msgExt.setDelayTimeLevel(delayLevel);</div><div class="line"><span class="number">116</span>:     &#125;</div><div class="line"><span class="number">117</span>: </div><div class="line"><span class="number">118</span>:     <span class="comment">// åˆ›å»ºMessageExtBrokerInner</span></div><div class="line"><span class="number">119</span>:     MessageExtBrokerInner msgInner = <span class="keyword">new</span> MessageExtBrokerInner();</div><div class="line"><span class="number">120</span>:     msgInner.setTopic(newTopic);</div><div class="line"><span class="number">121</span>:     msgInner.setBody(msgExt.getBody());</div><div class="line"><span class="number">122</span>:     msgInner.setFlag(msgExt.getFlag());</div><div class="line"><span class="number">123</span>:     MessageAccessor.setProperties(msgInner, msgExt.getProperties());</div><div class="line"><span class="number">124</span>:     msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgExt.getProperties()));</div><div class="line"><span class="number">125</span>:     msgInner.setTagsCode(MessageExtBrokerInner.tagsString2tagsCode(<span class="keyword">null</span>, msgExt.getTags()));</div><div class="line"><span class="number">126</span>:     msgInner.setQueueId(queueIdInt);</div><div class="line"><span class="number">127</span>:     msgInner.setSysFlag(msgExt.getSysFlag());</div><div class="line"><span class="number">128</span>:     msgInner.setBornTimestamp(msgExt.getBornTimestamp());</div><div class="line"><span class="number">129</span>:     msgInner.setBornHost(msgExt.getBornHost());</div><div class="line"><span class="number">130</span>:     msgInner.setStoreHost(<span class="keyword">this</span>.getStoreHost());</div><div class="line"><span class="number">131</span>:     msgInner.setReconsumeTimes(msgExt.getReconsumeTimes() + <span class="number">1</span>);</div><div class="line"><span class="number">132</span>: </div><div class="line"><span class="number">133</span>:     <span class="comment">// è®¾ç½®åŸå§‹æ¶ˆæ¯ç¼–å·åˆ°æ‹“å±•å­—æ®µï¼ˆç‹¬æœ‰ï¼‰</span></div><div class="line"><span class="number">134</span>:     String originMsgId = MessageAccessor.getOriginMessageId(msgExt);</div><div class="line"><span class="number">135</span>:     MessageAccessor.setOriginMessageId(msgInner, UtilAll.isBlank(originMsgId) ? msgExt.getMsgId() : originMsgId);</div><div class="line"><span class="number">136</span>: </div><div class="line"><span class="number">137</span>:     <span class="comment">// æ·»åŠ æ¶ˆæ¯</span></div><div class="line"><span class="number">138</span>:     PutMessageResult putMessageResult = <span class="keyword">this</span>.brokerController.getMessageStore().putMessage(msgInner);</div><div class="line"><span class="number">139</span>:     <span class="keyword">if</span> (putMessageResult != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">140</span>:         <span class="keyword">switch</span> (putMessageResult.getPutMessageStatus()) &#123;</div><div class="line"><span class="number">141</span>:             <span class="keyword">case</span> PUT_OK:</div><div class="line"><span class="number">142</span>:                 String backTopic = msgExt.getTopic();</div><div class="line"><span class="number">143</span>:                 String correctTopic = msgExt.getProperty(MessageConst.PROPERTY_RETRY_TOPIC);</div><div class="line"><span class="number">144</span>:                 <span class="keyword">if</span> (correctTopic != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">145</span>:                     backTopic = correctTopic;</div><div class="line"><span class="number">146</span>:                 &#125;</div><div class="line"><span class="number">147</span>: </div><div class="line"><span class="number">148</span>:                 <span class="keyword">this</span>.brokerController.getBrokerStatsManager().incSendBackNums(requestHeader.getGroup(), backTopic);</div><div class="line"><span class="number">149</span>: </div><div class="line"><span class="number">150</span>:                 response.setCode(ResponseCode.SUCCESS);</div><div class="line"><span class="number">151</span>:                 response.setRemark(<span class="keyword">null</span>);</div><div class="line"><span class="number">152</span>: </div><div class="line"><span class="number">153</span>:                 <span class="keyword">return</span> response;</div><div class="line"><span class="number">154</span>:             <span class="keyword">default</span>:</div><div class="line"><span class="number">155</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">156</span>:         &#125;</div><div class="line"><span class="number">157</span>: </div><div class="line"><span class="number">158</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">159</span>:         response.setRemark(putMessageResult.getPutMessageStatus().name());</div><div class="line"><span class="number">160</span>:         <span class="keyword">return</span> response;</div><div class="line"><span class="number">161</span>:     &#125;</div><div class="line"><span class="number">162</span>: </div><div class="line"><span class="number">163</span>:     response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">164</span>:     response.setRemark(<span class="string">"putMessageResult is null"</span>);</div><div class="line"><span class="number">165</span>:     <span class="keyword">return</span> response;</div><div class="line"><span class="number">166</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯´æ˜ ï¼šå½“ <code>Consumer</code> æ¶ˆè´¹æŸæ¡æ¶ˆæ¯å¤±è´¥æ—¶ï¼Œä¼šè°ƒç”¨è¯¥æ¥å£å‘å›æ¶ˆæ¯ã€‚<code>Broker</code> ä¼šå­˜å‚¨å‘å›çš„æ¶ˆæ¯ã€‚è¿™æ ·ï¼Œä¸‹æ¬¡ <code>Consumer</code> æ‹‰å–è¯¥æ¶ˆæ¯ï¼Œèƒ½å¤Ÿä» <code>CommitLog</code> å’Œ <code>ConsumeQueue</code> é¡ºåºè¯»å–ã€‚</li><li>[x] å› ä¸ºå¤§å¤šæ•°é€»è¾‘å’Œ <strong><code>Broker</code> æ¥æ”¶æ™®é€šæ¶ˆæ¯</strong> å¾ˆç›¸ä¼¼ï¼Œæ—¶å€™ <code>TODO</code> æ ‡è®°æˆç‹¬æœ‰çš„é€»è¾‘ã€‚</li><li>ç¬¬ 4 è‡³ 7 è¡Œ ï¼šåˆå§‹åŒ–å“åº”ã€‚</li><li>[x] ç¬¬ 9 è‡³ 20 è¡Œ ï¼šHooké€»è¾‘ã€‚</li><li>[x] ç¬¬22 è‡³ 30 è¡Œ ï¼šåˆ¤æ–­æ¶ˆè´¹åˆ†ç»„æ˜¯å¦å­˜åœ¨ã€‚</li><li>ç¬¬ 32 è‡³ 37 è¡Œ ï¼šæ£€æŸ¥ <code>Broker</code> æ˜¯å¦æœ‰å†™å…¥æƒé™ã€‚</li><li>[x] ç¬¬ 39 è‡³ 44 è¡Œ ï¼šæ£€æŸ¥é‡è¯•é˜Ÿåˆ—æ•°æ˜¯å¦å¤§äº0ã€‚</li><li>ç¬¬ 47 è¡Œ ï¼šè®¡ç®— retry topicã€‚</li><li>[x] ç¬¬ 50 è¡Œ ï¼šéšæœºåˆ†é…é˜Ÿåˆ—ç¼–å·ï¼Œä¾èµ– <code>retryQueueNums</code>ã€‚</li><li>[x] ç¬¬ 52 è‡³ 56 è¡Œ ï¼šè®¡ç®— <code>sysFlag</code>ã€‚</li><li>ç¬¬ 58 è‡³ 72 è¡Œ ï¼šè·å– <code>TopicConfig</code>ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºã€‚</li><li>[x] ç¬¬ 74 è‡³ 80 è¡Œ ï¼šæŸ¥è¯¢æ¶ˆæ¯ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿”å›å¼‚å¸¸é”™è¯¯ã€‚</li><li>[x] ç¬¬ 82 è‡³ 86 è¡Œ ï¼šè®¾ç½® <code>retryTopic</code> åˆ°æ¶ˆæ¯æ‹“å±•å±æ€§ã€‚</li><li>[x] ç¬¬ 89 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯ä¸ç­‰å¾…å­˜å‚¨å®Œæˆã€‚<ul><li>å½“ <code>Broker</code> åˆ·ç›˜æ–¹å¼ä¸ºåŒæ­¥ï¼Œä¼šå¯¼è‡´åŒæ­¥è½ç›˜ä¸èƒ½æ‰¹é‡æäº¤ï¼Œè¿™æ ·ä¼šä¸ä¼šå­˜åœ¨é—®é¢˜ï¼Ÿæœ‰çŸ¥é“çš„åŒå­¦éº»çƒ¦å‘ŠçŸ¥ä¸‹ã€‚ğŸ˜ˆã€‚</li></ul></li><li>[x] ç¬¬ 91 è‡³ 116 è¡Œ ï¼šå¤„ç† <code>delayLevel</code> ã€‚</li><li>ç¬¬ 118 è‡³ 131 è¡Œ ï¼šåˆ›å»º <code>MessageExtBrokerInner</code> ã€‚</li><li>[x] ç¬¬ 133 è‡³ 135 è¡Œ ï¼šè®¾ç½®åŸå§‹æ¶ˆæ¯ç¼–å·åˆ°æ‹“å±•å±æ€§ã€‚</li><li>ç¬¬ 137 è‡³ 161 è¡Œ ï¼šæ·»åŠ æ¶ˆæ¯ã€‚</li></ul><h1 id="7ã€ç»“å°¾"><a href="#7ã€ç»“å°¾" class="headerlink" title="7ã€ç»“å°¾"></a>7ã€ç»“å°¾</h1><p>æ„Ÿè°¢åŒå­¦ä»¬å¯¹æœ¬æ–‡çš„é˜…è¯»ã€æ”¶è—ã€ç‚¹èµã€‚</p><p>ğŸ˜ˆå¦‚æœè§£æå­˜åœ¨é—®é¢˜æˆ–è€…è¡¨è¾¾è¯¯è§£çš„ï¼Œè¡¨ç¤ºæŠ±æ­‰ã€‚å¦‚æœæ–¹ä¾¿çš„è¯ï¼Œå¯ä»¥åŠ ä¸‹ <strong>QQï¼š7685413</strong>ã€‚è®©æˆ‘ä»¬æ¥ä¸€åœº 1 ï¼š1 äº¤æµï¼ˆæåŸºï¼‰ã€‚</p><p>å†æ¬¡è¡¨ç¤ºååˆ†æ„Ÿè°¢ã€‚</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/RocketMQ/">RocketMQ</a></div><div class="article-share" id="share"><div data-url="http://www.yunai.me/RocketMQ/message-pull-and-consume-first/" data-title="RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰ | èŠ‹è‰¿Vçš„åšå®¢" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/RocketMQ/message-pull-and-consume-second/" title="RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸‹ï¼‰"><strong>PREVIOUS:</strong><br><span>RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸‹ï¼‰</span></a></div><div class="next"><a href="/RocketMQ/message-store/" title="RocketMQ æºç åˆ†æ â€”â€” Message å­˜å‚¨"><strong>NEXT:</strong><br><span>RocketMQ æºç åˆ†æ â€”â€” Message å­˜å‚¨</span></a></div></nav></div></div><footer><div id="footer"><p class="copyright">Â© 2017 <a href="http://www.yunai.me" target="_blank" title="ç‹æ–‡æ–Œ">ç‹æ–‡æ–Œ</a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a> && Powered by <a href="http://hexo.io" target="_blank" title="hexo" rel="external nofollow noopener noreferrer">hexo</a> && Theme by <a href="http://gengbiao.me" target="_blank" title="coney" rel="external nofollow noopener noreferrer">coney</a></p></div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2"),ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script>$(document).ready(function(){function e(){var e=jqueryAlert({title:"ğŸ‘¼æ¯å‘¨å…­æ›´æ–°ä¸€ç¯‡æºç è§£æï¼Œã€æ‰«ä¸€æ‰«ã€‘å…³æ³¨å…¬ä¼—å·ğŸ‘¼",width:"500",height:"580",modal:!0,content:n+'<p style="color: red">ä»Šæ—¥'+c+"å·²å…³æ³¨äººæ•°ï¼š"+p+'</p><img width="400" src="http://www.yunai.me/images/common/wechat_mp_simple.png" /><p style="color: red">å…³æ³¨åï¼Œæ¬¢è¿åŠ å…¥ã€æºç åœˆã€‘å¾®ä¿¡ç¾¤äº¤æµ</p><p style="color: red">ä¸€èµ·çœ‹æºç ï¼Œè¯»æºç ï¼Œæå‡æŠ€æœ¯ï¼</p>',buttons:{"å·²å…³æ³¨ï¼Œå…³é—­çª—å£ï¼ˆå…¬ä¼—å·å‘é€ï¼šã€å£ä»¤ã€‘å±è”½å¼¹çª—ï¼‰":function(){e.close()}}});$.cookie(o,i+1,{expires:1,path:"/"})}if(!(location.href.indexOf("vip")>=0||location.href.indexOf("127.0.0.1")>=0)){var o="doubi",i=$.cookie(o);i?i=parseInt(i):($.cookie(o,0,{expires:1,path:"/"}),i=0),$.cookie(o,i,{expires:1,path:"/"});var t="default",r={juejin:"æ˜é‡‘",oschina:"å¼€æºä¸­å›½",sjdbc:"Sharding-JDBC",jianshu:"ç®€ä¹¦",csdn:"CSDN",iteye:"iteye",cnblogs:"åšå®¢å›­"};for(var a in r)if(location.search.indexOf(a)>=0){t=a;break}"default"===t&&(t=$.cookie("from")||"default"),$.cookie("from",t,{expires:365,path:"/"});var n="",c="";if(t&&r[t]&&(n='<p style="color: red">æ¬¢è¿æ¥è‡ªã€'+r[t]+"ã€‘çš„åŒå­¦</p>",c="ã€"+r[t]+"ã€‘"),i<=3){var p=103+5*(new Date).getHours();setTimeout(e,1e4*(i+1))}}})</script></body>