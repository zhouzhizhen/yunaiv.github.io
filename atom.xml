<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>èŠ‹è‰¿Vçš„åšå®¢</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.yunai.me/"/>
  <updated>2017-08-04T18:07:37.000Z</updated>
  <id>http://www.yunai.me/</id>
  
  <author>
    <name>ç‹æ–‡æ–Œ</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-execute/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-execute/</id>
    <published>2017-08-13T16:00:00.000Z</published>
    <updated>2017-08-04T18:07:37.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ExecutorEngine</a><ul>
<li><a href="#">2.1 ListeningExecutorService</a></li>
<li><a href="#">2.2 å…³é—­</a></li>
<li><a href="#">2.3 æ‰§è¡Œ SQL ä»»åŠ¡</a></li>
</ul>
</li>
<li><a href="#">3. Executor</a><ul>
<li><a href="#">3.1 StatementExecutor</a></li>
<li><a href="#">3.2 PreparedStatementExecutor</a></li>
<li><a href="#">3.3 BatchPreparedStatementExecutor</a></li>
</ul>
</li>
<li><a href="#">4. ExecutionEvent</a><ul>
<li><a href="#">4.1 EventBus</a></li>
<li><a href="#">4.2 BestEffortsDeliveryListener</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>è¶Šè¿‡åƒå±±ä¸‡æ°´ï¼ˆSQL è§£æã€SQL è·¯ç”±ã€SQL æ”¹å†™ï¼‰ï¼Œæˆ‘ä»¬ç»ˆäºæ¥åˆ°äº† <strong>SQL æ‰§è¡Œ</strong>ã€‚å¼€æ£®ä¸å¼€æ£®ï¼Ÿï¼</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/01.png" alt=""></p>
<p>æœ¬æ–‡ä¸»è¦åˆ†äº«<strong>SQL æ‰§è¡Œ</strong>çš„è¿‡ç¨‹ï¼Œä¸åŒ…æ‹¬<strong>ç»“æœèšåˆ</strong>ã€‚<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šç»“æœèšåˆã€‹</a> <strong>ä¸œåŠçƒç¬¬äºŒè‰¯å¿ƒç¬”è€…</strong>ä¼šæ›´æ–°ï¼Œå…³æ³¨å¾®ä¿¡å…¬ä¼—å·<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</a>å®Œç¨¿å<strong>ç¬¬ä¸€æ—¶é—´</strong>é€šçŸ¥æ‚¨å“Ÿã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/06.png" alt=""></p>
<p><strong>ç»¿æ¡†éƒ¨åˆ†</strong> SQL æ‰§è¡Œä¸»æµç¨‹ã€‚</p>
<h1 id="2-ExecutorEngine"><a href="#2-ExecutorEngine" class="headerlink" title="2. ExecutorEngine"></a>2. ExecutorEngine</h1><p>ExecutorEngineï¼ŒSQLæ‰§è¡Œå¼•æ“ã€‚</p>
<p>åˆ†è¡¨åˆ†åº“ï¼Œéœ€è¦æ‰§è¡Œçš„ SQL æ•°é‡ä»å•æ¡å˜æˆäº†å¤šæ¡ï¼Œæ­¤æ—¶æœ‰ä¸¤ç§æ–¹å¼æ‰§è¡Œï¼š</p>
<ul>
<li><strong>ä¸²è¡Œ</strong>æ‰§è¡Œ SQL</li>
<li><strong>å¹¶è¡Œ</strong>æ‰§è¡Œ SQL</li>
</ul>
<p>å‰è€…ï¼Œç¼–ç å®¹æ˜“ï¼Œæ€§èƒ½è¾ƒå·®ï¼Œæ€»è€—æ—¶æ˜¯å¤šæ¡ SQL æ‰§è¡Œæ—¶é—´ç´¯åŠ ã€‚<br>åè€…ï¼Œç¼–ç å¤æ‚ï¼Œæ€§èƒ½è¾ƒå¥½ï¼Œæ€»è€—æ—¶çº¦ç­‰äºæ‰§è¡Œæ—¶é—´æœ€é•¿çš„ SQLã€‚</p>
<p>ğŸ‘¼ ExecutorEngine å½“ç„¶é‡‡ç”¨çš„æ˜¯<strong>åè€…</strong>ï¼Œå¹¶è¡Œæ‰§è¡Œ SQLã€‚</p>
<h2 id="2-1-ListeningExecutorService"><a href="#2-1-ListeningExecutorService" class="headerlink" title="2.1 ListeningExecutorService"></a>2.1 ListeningExecutorService</h2><p><a href="http://www.yiibai.com/guava/" rel="external nofollow noopener noreferrer" target="_blank">Guava( Java å·¥å…·åº“ )</a> æä¾›çš„ç»§æ‰¿è‡ª  ExecutorService çš„<strong>çº¿ç¨‹æœåŠ¡æ¥å£</strong>ï¼Œæä¾›åˆ›å»º ListenableFuture åŠŸèƒ½ã€‚ListenableFuture æ¥å£ï¼Œç»§æ‰¿ Future æ¥å£ï¼Œæœ‰å¦‚ä¸‹å¥½å¤„ï¼š</p>
<blockquote>
<p>æˆ‘ä»¬å¼ºçƒˆåœ°å»ºè®®ä½ åœ¨ä»£ç ä¸­å¤šä½¿ç”¨ListenableFutureæ¥ä»£æ›¿JDKçš„ Future, å› ä¸ºï¼š  </p>
<ul>
<li>å¤§å¤šæ•°Futures æ–¹æ³•ä¸­éœ€è¦å®ƒã€‚  </li>
<li>è½¬åˆ°ListenableFuture ç¼–ç¨‹æ¯”è¾ƒå®¹æ˜“ã€‚  </li>
<li>Guavaæä¾›çš„é€šç”¨å…¬å…±ç±»å°è£…äº†å…¬å…±çš„æ“ä½œæ–¹æ–¹æ³•ï¼Œä¸éœ€è¦æä¾›Futureå’ŒListenableFutureçš„æ‰©å±•æ–¹æ³•ã€‚  </li>
</ul>
<p>ä¼ ç»ŸJDKä¸­çš„Futureé€šè¿‡å¼‚æ­¥çš„æ–¹å¼è®¡ç®—è¿”å›ç»“æœ:åœ¨å¤šçº¿ç¨‹è¿ç®—ä¸­å¯èƒ½æˆ–è€…å¯èƒ½åœ¨æ²¡æœ‰ç»“æŸè¿”å›ç»“æœï¼ŒFutureæ˜¯è¿è¡Œä¸­çš„å¤šçº¿ç¨‹çš„ä¸€ä¸ªå¼•ç”¨å¥æŸ„ï¼Œç¡®ä¿åœ¨æœåŠ¡æ‰§è¡Œè¿”å›ä¸€ä¸ªResultã€‚   </p>
<p>ListenableFutureå¯ä»¥å…è®¸ä½ æ³¨å†Œå›è°ƒæ–¹æ³•(callbacks)ï¼Œåœ¨è¿ç®—ï¼ˆå¤šçº¿ç¨‹æ‰§è¡Œï¼‰å®Œæˆçš„æ—¶å€™è¿›è¡Œè°ƒç”¨,  æˆ–è€…åœ¨è¿ç®—ï¼ˆå¤šçº¿ç¨‹æ‰§è¡Œï¼‰å®Œæˆåç«‹å³æ‰§è¡Œã€‚è¿™æ ·ç®€å•çš„æ”¹è¿›ï¼Œä½¿å¾—å¯ä»¥æ˜æ˜¾çš„æ”¯æŒæ›´å¤šçš„æ“ä½œï¼Œè¿™æ ·çš„åŠŸèƒ½åœ¨JDK concurrentä¸­çš„Futureæ˜¯ä¸æ”¯æŒçš„ã€‚</p>
</blockquote>
<p>å¦‚ä¸Šå†…å®¹æ¥è‡ª<a href="http://ifeve.com/google-guava-listenablefuture/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠGoogle GuavaåŒ…çš„ListenableFutureè§£æ<br>ã€‹</a>ï¼Œæ–‡ç« å†™çš„å¾ˆæ£’ã€‚ä¸‹æ–‡ä½ ä¼šçœ‹åˆ° Sharding-JDBC æ˜¯<strong>å¦‚ä½•é€šè¿‡ ListenableFuture ç®€åŒ–å¹¶å‘ç¼–ç¨‹çš„</strong>ã€‚</p>
<p>ä¸‹é¢çœ‹çœ‹ ExecutorEngine å¦‚ä½•<strong>åˆå§‹åŒ–</strong> ListeningExecutorService </p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingDataSource.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ShardingDataSource</span><span class="params">(<span class="keyword">final</span> ShardingRule shardingRule, <span class="keyword">final</span> Properties props)</span> </span>&#123;</div><div class="line">    <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">   shardingProperties = <span class="keyword">new</span> ShardingProperties(props);</div><div class="line">   <span class="keyword">int</span> executorSize = shardingProperties.getValue(ShardingPropertiesConstant.EXECUTOR_SIZE);</div><div class="line">   executorEngine = <span class="keyword">new</span> ExecutorEngine(executorSize);</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ExecutorEngine</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ExecutorEngine</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> executorSize)</span> </span>&#123;</div><div class="line">   executorService = MoreExecutors.listeningDecorator(<span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">           executorSize, executorSize, <span class="number">0</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(),</div><div class="line">           <span class="keyword">new</span> ThreadFactoryBuilder().setDaemon(<span class="keyword">true</span>).setNameFormat(<span class="string">"ShardingJDBC-%d"</span>).build()));</div><div class="line">   MoreExecutors.addDelayedShutdownHook(executorService, <span class="number">60</span>, TimeUnit.SECONDS);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä¸€ä¸ªåˆ†ç‰‡æ•°æ®æº( ShardingDataSource ) <strong>ç‹¬å </strong> ä¸€ä¸ª SQLæ‰§è¡Œå¼•æ“( ExecutorEngine )ã€‚</li>
<li><code>MoreExecutors#listeningDecorator()</code> åˆ›å»º ListeningExecutorServiceï¼Œè¿™æ · <code>#submit()</code>ï¼Œ<code>#invokeAll()</code> å¯ä»¥è¿”å› ListenableFutureã€‚</li>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ± å¤§å°ä¸º <strong>8</strong>ã€‚å¯ä»¥æ ¹æ®å®é™…ä¸šåŠ¡éœ€è¦ï¼Œè®¾ç½® ShardingProperties è¿›è¡Œè°ƒæ•´ã€‚</li>
<li><code>#setNameFormat()</code> å¹¶å‘ç¼–ç¨‹æ—¶ï¼Œä¸€å®šè¦å¯¹çº¿ç¨‹åå­—åšä¸‹å®šä¹‰ï¼Œè¿™æ ·æ’æŸ¥é—®é¢˜ä¼šæ–¹ä¾¿å¾ˆå¤šã€‚</li>
<li><code>MoreExecutors#addDelayedShutdownHook()</code>ï¼Œ<strong>åº”ç”¨å…³é—­</strong>æ—¶ï¼Œç­‰å¾…<strong>æ‰€æœ‰ä»»åŠ¡å…¨éƒ¨å®Œæˆ</strong>å†å…³é—­ã€‚é»˜è®¤é…ç½®ç­‰å¾…æ—¶é—´ä¸º 60 ç§’ï¼Œ<strong>å»ºè®®</strong>å°†ç­‰å¾…æ—¶é—´åšæˆå¯é…çš„ã€‚</li>
</ul>
<h2 id="2-2-å…³é—­"><a href="#2-2-å…³é—­" class="headerlink" title="2.2 å…³é—­"></a>2.2 å…³é—­</h2><p>æ•°æ®æºå…³é—­æ—¶ï¼Œä¼šè°ƒç”¨ ExecutorEngine ä¹Ÿè¿›è¡Œå…³é—­ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingDataSource.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</div><div class="line">   executorEngine.close();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ExecutorEngine</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</div><div class="line">   executorService.shutdownNow();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       executorService.awaitTermination(<span class="number">5</span>, TimeUnit.SECONDS);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException ignored) &#123;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (!executorService.isTerminated()) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ShardingJdbcException(<span class="string">"ExecutorEngine can not been terminated"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#shutdownNow()</code> å°è¯•ä½¿ç”¨ <code>Thread.interrupt()</code> æ‰“æ–­æ­£åœ¨æ‰§è¡Œä¸­çš„ä»»åŠ¡ï¼Œæœªæ‰§è¡Œçš„ä»»åŠ¡ä¸å†æ‰§è¡Œã€‚<strong>å»ºè®®</strong>æ‰“å°ä¸‹å“ªäº›ä»»åŠ¡æœªæ‰§è¡Œï¼Œå› ä¸º SQL æœªæ‰§è¡Œï¼Œå¯èƒ½æ•°æ®æœªèƒ½æŒä¹…åŒ–ã€‚</li>
<li><code>#awaitTermination()</code> å› ä¸º <code>#shutdownNow()</code> æ‰“æ–­ä¸æ˜¯<strong>ç«‹å³</strong>ç»“æŸï¼Œéœ€è¦ä¸€ä¸ªè¿‡ç¨‹ï¼Œå› æ­¤è¿™é‡Œ<strong>ç­‰å¾…</strong>äº† 5 ç§’ã€‚</li>
<li><strong>ç­‰å¾…</strong> 5 ç§’åï¼Œçº¿ç¨‹æ± ä¸ä¸€å®šå·²ç»å…³é—­ï¼Œæ­¤æ—¶æŠ›å‡ºå¼‚å¸¸ç»™ä¸Šå±‚ã€‚<strong>å»ºè®®</strong>æ‰“å°ä¸‹æ—¥å¿—ï¼Œè®°å½•å‡ºç°è¿™ä¸ªæƒ…å†µã€‚</li>
</ul>
<h2 id="2-3-æ‰§è¡Œ-SQL-ä»»åŠ¡"><a href="#2-3-æ‰§è¡Œ-SQL-ä»»åŠ¡" class="headerlink" title="2.3 æ‰§è¡Œ SQL ä»»åŠ¡"></a>2.3 æ‰§è¡Œ SQL ä»»åŠ¡</h2><p>ExecutorEngine å¯¹å¤–æš´éœ² <code>#executeStatement()</code>ï¼Œ<code>#executePreparedStatement()</code>ï¼Œ<code>#executeBatch()</code> </p>
<p>ä¸‰ä¸ªæ–¹æ³•åˆ†åˆ«æä¾›ç»™ StatementExecutorã€PreparedStatementExecutorã€BatchPreparedStatementExecutor è°ƒç”¨ã€‚è€Œè¿™ä¸‰ä¸ªæ–¹æ³•ï¼Œå†…éƒ¨è°ƒç”¨çš„éƒ½æ˜¯ <code>#execute()</code> ç§æœ‰æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ExecutorEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡ŒStatement.</div><div class="line">* <span class="doctag">@param</span> sqlType SQLç±»å‹</div><div class="line">* <span class="doctag">@param</span> statementUnits è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒé›†åˆ</div><div class="line">* <span class="doctag">@param</span> executeCallback æ‰§è¡Œå›è°ƒå‡½æ•°</div><div class="line">* <span class="doctag">@param</span> &lt;T&gt; è¿”å›å€¼ç±»å‹</div><div class="line">* <span class="doctag">@return</span> æ‰§è¡Œç»“æœ</div><div class="line">*/</div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">executeStatement</span><span class="params">(<span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;StatementUnit&gt; statementUnits, <span class="keyword">final</span> ExecuteCallback&lt;T&gt; executeCallback)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> execute(sqlType, statementUnits, Collections.&lt;List&lt;Object&gt;&gt;emptyList(), executeCallback);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡ŒPreparedStatement.</div><div class="line">* <span class="doctag">@param</span> sqlType SQLç±»å‹</div><div class="line">* <span class="doctag">@param</span> preparedStatementUnits è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒé›†åˆ</div><div class="line">* <span class="doctag">@param</span> parameters å‚æ•°åˆ—è¡¨</div><div class="line">* <span class="doctag">@param</span> executeCallback æ‰§è¡Œå›è°ƒå‡½æ•°</div><div class="line">* <span class="doctag">@param</span> &lt;T&gt; è¿”å›å€¼ç±»å‹</div><div class="line">* <span class="doctag">@return</span> æ‰§è¡Œç»“æœ</div><div class="line">*/</div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">executePreparedStatement</span><span class="params">(</span></span></div><div class="line">       <span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;PreparedStatementUnit&gt; preparedStatementUnits, <span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> ExecuteCallback&lt;T&gt; executeCallback) &#123;</div><div class="line">   <span class="keyword">return</span> execute(sqlType, preparedStatementUnits, Collections.singletonList(parameters), executeCallback);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡ŒBatch.</div><div class="line">* <span class="doctag">@param</span> sqlType SQLç±»å‹</div><div class="line">* <span class="doctag">@param</span> batchPreparedStatementUnits è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒé›†åˆ</div><div class="line">* <span class="doctag">@param</span> parameterSets å‚æ•°åˆ—è¡¨é›†</div><div class="line">* <span class="doctag">@param</span> executeCallback æ‰§è¡Œå›è°ƒå‡½æ•°</div><div class="line">* <span class="doctag">@return</span> æ‰§è¡Œç»“æœ</div><div class="line">*/</div><div class="line"><span class="keyword">public</span> List&lt;<span class="keyword">int</span>[]&gt; executeBatch(</div><div class="line">       <span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;BatchPreparedStatementUnit&gt; batchPreparedStatementUnits, <span class="keyword">final</span> List&lt;List&lt;Object&gt;&gt; parameterSets, <span class="keyword">final</span> ExecuteCallback&lt;<span class="keyword">int</span>[]&gt; executeCallback) &#123;</div><div class="line">   <span class="keyword">return</span> execute(sqlType, batchPreparedStatementUnits, parameterSets, executeCallback);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>#execute()</code> æ‰§è¡Œè¿‡ç¨‹å¤§ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/02.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œ</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlType SQL ç±»å‹</div><div class="line">* <span class="doctag">@param</span> baseStatementUnits è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒé›†åˆ</div><div class="line">* <span class="doctag">@param</span> parameterSets å‚æ•°åˆ—è¡¨é›†</div><div class="line">* <span class="doctag">@param</span> executeCallback æ‰§è¡Œå›è°ƒå‡½æ•°</div><div class="line">* <span class="doctag">@param</span> &lt;T&gt; è¿”å›å€¼ç±»å‹</div><div class="line">* <span class="doctag">@return</span> æ‰§è¡Œç»“æœ</div><div class="line">*/</div><div class="line"><span class="keyword">private</span>  &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">execute</span><span class="params">(</span></span></div><div class="line">       <span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;? extends BaseStatementUnit&gt; baseStatementUnits, <span class="keyword">final</span> List&lt;List&lt;Object&gt;&gt; parameterSets, <span class="keyword">final</span> ExecuteCallback&lt;T&gt; executeCallback) &#123;</div><div class="line">   <span class="keyword">if</span> (baseStatementUnits.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   Iterator&lt;? extends BaseStatementUnit&gt; iterator = baseStatementUnits.iterator();</div><div class="line">   BaseStatementUnit firstInput = iterator.next();</div><div class="line">   <span class="comment">// ç¬¬äºŒä¸ªä»»åŠ¡å¼€å§‹æ‰€æœ‰ SQLä»»åŠ¡ æäº¤çº¿ç¨‹æ± ã€å¼‚æ­¥ã€‘æ‰§è¡Œä»»åŠ¡</span></div><div class="line">   ListenableFuture&lt;List&lt;T&gt;&gt; restFutures = asyncExecute(sqlType, Lists.newArrayList(iterator), parameterSets, executeCallback);</div><div class="line">   T firstOutput;</div><div class="line">   List&lt;T&gt; restOutputs;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// ç¬¬ä¸€ä¸ªä»»åŠ¡ã€åŒæ­¥ã€‘æ‰§è¡Œä»»åŠ¡</span></div><div class="line">       firstOutput = syncExecute(sqlType, firstInput, parameterSets, executeCallback);</div><div class="line">       <span class="comment">// ç­‰å¾…ç¬¬äºŒä¸ªä»»åŠ¡å¼€å§‹æ‰€æœ‰ SQLä»»åŠ¡å®Œæˆ</span></div><div class="line">       restOutputs = restFutures.get();</div><div class="line">       <span class="comment">//CHECKSTYLE:OFF</span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       <span class="comment">//CHECKSTYLE:ON</span></div><div class="line">       ExecutorExceptionHandler.handleException(ex);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è¿”å›ç»“æœ</span></div><div class="line">   List&lt;T&gt; result = Lists.newLinkedList(restOutputs);</div><div class="line">   result.add(<span class="number">0</span>, firstOutput);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ç¬¬ä¸€ä¸ªä»»åŠ¡<strong>ã€åŒæ­¥ã€‘</strong>è°ƒç”¨ <code>#executeInternal()</code> æ‰§è¡Œä»»åŠ¡ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">syncExecute</span><span class="params">(<span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> BaseStatementUnit baseStatementUnit, <span class="keyword">final</span> List&lt;List&lt;Object&gt;&gt; parameterSets, <span class="keyword">final</span> ExecuteCallback&lt;T&gt; executeCallback)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">   <span class="comment">// ã€åŒæ­¥ã€‘æ‰§è¡Œä»»åŠ¡</span></div><div class="line">   <span class="keyword">return</span> executeInternal(sqlType, baseStatementUnit, parameterSets, executeCallback, ExecutorExceptionHandler.isExceptionThrown(), ExecutorDataMap.getDataMap());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ç¬¬äºŒä¸ªå¼€å§‹çš„ä»»åŠ¡<strong>æäº¤çº¿ç¨‹æ± å¼‚æ­¥</strong>è°ƒç”¨ <code>#executeInternal()</code> æ‰§è¡Œä»»åŠ¡ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> &lt;T&gt; ListenableFuture&lt;List&lt;T&gt;&gt; asyncExecute(</div><div class="line">       <span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;BaseStatementUnit&gt; baseStatementUnits, <span class="keyword">final</span> List&lt;List&lt;Object&gt;&gt; parameterSets, <span class="keyword">final</span> ExecuteCallback&lt;T&gt; executeCallback) &#123;</div><div class="line">   List&lt;ListenableFuture&lt;T&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(baseStatementUnits.size());</div><div class="line">   <span class="keyword">final</span> <span class="keyword">boolean</span> isExceptionThrown = ExecutorExceptionHandler.isExceptionThrown();</div><div class="line">   <span class="keyword">final</span> Map&lt;String, Object&gt; dataMap = ExecutorDataMap.getDataMap();</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">final</span> BaseStatementUnit each : baseStatementUnits) &#123;</div><div class="line">       <span class="comment">// æäº¤çº¿ç¨‹æ± ã€å¼‚æ­¥ã€‘æ‰§è¡Œä»»åŠ¡</span></div><div class="line">       result.add(executorService.submit(<span class="keyword">new</span> Callable&lt;T&gt;() &#123;</div><div class="line">           </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> T <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">               <span class="keyword">return</span> executeInternal(sqlType, each, parameterSets, executeCallback, isExceptionThrown, dataMap);</div><div class="line">           &#125;</div><div class="line">       &#125;));</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è¿”å› ListenableFuture</span></div><div class="line">   <span class="keyword">return</span> Futures.allAsList(result);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æˆ‘ä»¬æ³¨æ„ä¸‹ <code>Futures.allAsList(result);</code> å’Œ <code>restOutputs = restFutures.get();</code>ã€‚ç¥å™¨ Guava <strong>ç®€åŒ–å¹¶å‘ç¼–ç¨‹</strong> çš„å¥½å¤„å°±æç°å‡ºæ¥äº†ã€‚<code>ListenableFuture#get()</code> å½“<strong>æ‰€æœ‰ä»»åŠ¡éƒ½æˆåŠŸ</strong>æ—¶ï¼Œè¿”å›æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œç»“æœï¼›å½“<strong>ä»»ä½•ä¸€ä¸ªä»»åŠ¡å¤±è´¥</strong>æ—¶ï¼Œ<strong>é©¬ä¸Š</strong>æŠ›å‡ºå¼‚å¸¸ï¼Œæ— éœ€ç­‰å¾…å…¶ä»–ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/03.gif" alt=""></p>
<p>_ğŸ˜® Guava çœŸå¥¹å–µç¥å™¨ï¼Œå…¬ä¼—å·ï¼š<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</a>ä¼šæ›´æ–° Guava æºç åˆ†äº«çš„ä¸€ä¸ªç³»åˆ—å“Ÿï¼è€å¸æœºè¿˜ä¸èµ¶ç´§ä¸Šè½¦ï¼Ÿ_</p>
<ul>
<li>ä¸ºä»€ä¹ˆä¼šåˆ†åŒæ­¥æ‰§è¡Œå’Œå¼‚æ­¥æ‰§è¡Œå‘¢ï¼ŸçŒœæµ‹ï¼Œå½“<strong>SQL æ‰§è¡Œæ˜¯å•è¡¨æ—¶</strong>ï¼Œåªè¦è¿›è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡çš„åŒæ­¥è°ƒç”¨ï¼Œæ€§èƒ½æ›´åŠ ä¼˜ç§€ã€‚ç­‰è·Ÿå¼ äº®å¤§ç¥è¯·æ•™ç¡®è®¤åŸå› åï¼Œå’±ä¼šè¿›è¡Œæ›´æ–°ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ExecutorEngine.java</span></div><div class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">executeInternal</span><span class="params">(<span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> BaseStatementUnit baseStatementUnit, <span class="keyword">final</span> List&lt;List&lt;Object&gt;&gt; parameterSets, <span class="keyword">final</span> ExecuteCallback&lt;T&gt; executeCallback, </span></span></div><div class="line">                     <span class="keyword">final</span> <span class="keyword">boolean</span> isExceptionThrown, <span class="keyword">final</span> Map&lt;String, Object&gt; dataMap) <span class="keyword">throws</span> Exception &#123;</div><div class="line">   <span class="keyword">synchronized</span> (baseStatementUnit.getStatement().getConnection()) &#123;</div><div class="line">       T result;</div><div class="line">       ExecutorExceptionHandler.setExceptionThrown(isExceptionThrown);</div><div class="line">       ExecutorDataMap.setDataMap(dataMap);</div><div class="line">       List&lt;AbstractExecutionEvent&gt; events = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">       <span class="comment">// ç”Ÿæˆ Event</span></div><div class="line">       <span class="keyword">if</span> (parameterSets.isEmpty()) &#123;</div><div class="line">           events.add(getExecutionEvent(sqlType, baseStatementUnit, Collections.emptyList()));</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">for</span> (List&lt;Object&gt; each : parameterSets) &#123;</div><div class="line">               events.add(getExecutionEvent(sqlType, baseStatementUnit, each));</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// EventBus å‘å¸ƒ EventExecutionType.BEFORE_EXECUTE</span></div><div class="line">       <span class="keyword">for</span> (AbstractExecutionEvent event : events) &#123;</div><div class="line">           EventBusInstance.getInstance().post(event);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// æ‰§è¡Œå›è°ƒå‡½æ•°</span></div><div class="line">           result = executeCallback.execute(baseStatementUnit);</div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">           <span class="comment">// EventBus å‘å¸ƒ EventExecutionType.EXECUTE_FAILURE</span></div><div class="line">           <span class="keyword">for</span> (AbstractExecutionEvent each : events) &#123;</div><div class="line">               each.setEventExecutionType(EventExecutionType.EXECUTE_FAILURE);</div><div class="line">               each.setException(Optional.of(ex));</div><div class="line">               EventBusInstance.getInstance().post(each);</div><div class="line">               ExecutorExceptionHandler.handleException(ex);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// EventBus å‘å¸ƒ EventExecutionType.EXECUTE_SUCCESS</span></div><div class="line">       <span class="keyword">for</span> (AbstractExecutionEvent each : events) &#123;</div><div class="line">           each.setEventExecutionType(EventExecutionType.EXECUTE_SUCCESS);</div><div class="line">           EventBusInstance.getInstance().post(each);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>result = executeCallback.execute(baseStatementUnit);</code> æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚StatementExecutorï¼ŒPreparedStatementExecutorï¼ŒBatchPreparedStatementExecutor é€šè¿‡ä¼ é€’<strong>æ‰§è¡Œå›è°ƒå‡½æ•°</strong>( ExecuteCallback )å®ç°ç»™ ExecutorEngine å®ç°å¹¶è¡Œæ‰§è¡Œã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExecuteCallback</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰§è¡Œä»»åŠ¡.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> baseStatementUnit è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒ</div><div class="line">     * <span class="doctag">@return</span> å¤„ç†ç»“æœ</div><div class="line">     * <span class="doctag">@throws</span> Exception æ‰§è¡ŒæœŸå¼‚å¸¸</div><div class="line">     */</div><div class="line">    <span class="function">T <span class="title">execute</span><span class="params">(BaseStatementUnit baseStatementUnit)</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>synchronized (baseStatementUnit.getStatement().getConnection())</code> åŸä»¥ä¸º Connection éçº¿ç¨‹å®‰å…¨ï¼Œå› æ­¤éœ€è¦ç”¨<strong>åŒæ­¥</strong>ï¼Œåç¿»æŸ¥èµ„æ–™<a href="http://blog.csdn.net/goldenfish1919/article/details/9089667" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ•°æ®åº“è¿æ¥æ± ä¸ºä»€ä¹ˆè¦å»ºç«‹å¤šä¸ªè¿æ¥ã€‹</a>ï¼ŒConnection æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ç­‰è·Ÿå¼ äº®å¤§ç¥è¯·æ•™ç¡®è®¤åŸå› åï¼Œå’±ä¼šè¿›è¡Œæ›´æ–°ã€‚</li>
<li>ExecutionEvent è¿™é‡Œå…ˆä¸è§£é‡Šï¼Œåœ¨æœ¬æ–‡ç¬¬å››èŠ‚ã€EventBusã€‘åˆ†äº«ã€‚</li>
<li>ExecutorExceptionHandlerã€ExecutorDataMap å’Œ æŸ”æ€§äº‹åŠ¡ ( AbstractSoftTransaction )ï¼Œæ”¾åœ¨<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠæŸ”æ€§äº‹åŠ¡ã€‹</a>åˆ†äº«ã€‚</li>
</ul>
<h1 id="3-Executor"><a href="#3-Executor" class="headerlink" title="3. Executor"></a>3. Executor</h1><p>Executorï¼Œæ‰§è¡Œå™¨ï¼Œç›®å‰ä¸€å…±æœ‰ä¸‰ä¸ªæ‰§è¡Œå™¨ã€‚ä¸åŒçš„æ‰§è¡Œå™¨å¯¹åº”ä¸åŒçš„æ‰§è¡Œå•å…ƒ (BaseStatementUnit)ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">æ‰§è¡Œå™¨ç±»</th>
<th style="text-align:left">æ‰§è¡Œå™¨å</th>
<th style="text-align:left">æ‰§è¡Œå•å…ƒ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">StatementExecutor</td>
<td style="text-align:left">é™æ€è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒ</td>
<td style="text-align:left">StatementUnit</td>
</tr>
<tr>
<td style="text-align:left">PreparedStatementExecutor</td>
<td style="text-align:left">é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡è¯·æ±‚çš„æ‰§è¡Œå™¨</td>
<td style="text-align:left">PreparedStatementUnit</td>
</tr>
<tr>
<td style="text-align:left">BatchPreparedStatementExecutor</td>
<td style="text-align:left">æ‰¹é‡é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡è¯·æ±‚çš„æ‰§è¡Œå™¨</td>
<td style="text-align:left">BatchPreparedStatementUnit</td>
</tr>
</tbody>
</table>
<ul>
<li>æ‰§è¡Œå™¨æä¾›çš„æ–¹æ³•ä¸åŒï¼Œå› æ­¤ä¸å­˜åœ¨å…¬ç”¨æ¥å£æˆ–è€…æŠ½è±¡ç±»ã€‚</li>
<li>æ‰§è¡Œå•å…ƒç»§æ‰¿è‡ª BaseStatementUnit</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/04.png" alt=""></p>
<h2 id="3-1-StatementExecutor"><a href="#3-1-StatementExecutor" class="headerlink" title="3.1 StatementExecutor"></a>3.1 StatementExecutor</h2><p>StatementExecutorï¼Œ<strong>å¤šçº¿ç¨‹</strong>æ‰§è¡Œé™æ€è¯­å¥å¯¹è±¡è¯·æ±‚çš„æ‰§è¡Œå™¨ï¼Œä¸€å…±æœ‰ä¸‰ç±»æ–¹æ³•ï¼š</p>
<ul>
<li><code>#executeQuery()</code> </li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// StatementExecutor.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡ŒSQLæŸ¥è¯¢.</div><div class="line">* <span class="doctag">@return</span> ç»“æœé›†åˆ—è¡¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;ResultSet&gt; <span class="title">executeQuery</span><span class="params">()</span> </span>&#123;</div><div class="line">   Context context = MetricsContext.start(<span class="string">"ShardingStatement-executeQuery"</span>);</div><div class="line">   List&lt;ResultSet&gt; result;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       result = executorEngine.executeStatement(sqlType, statementUnits, <span class="keyword">new</span> ExecuteCallback&lt;ResultSet&gt;() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> ResultSet <span class="title">execute</span><span class="params">(<span class="keyword">final</span> BaseStatementUnit baseStatementUnit)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">               <span class="keyword">return</span> baseStatementUnit.getStatement().executeQuery(baseStatementUnit.getSqlExecutionUnit().getSql());</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       MetricsContext.stop(context);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#executeUpdate()</code> å› ä¸ºæœ‰å››ä¸ªä¸åŒæƒ…å†µçš„<code>#executeUpdate()</code>ï¼Œæ‰€ä»¥æŠ½è±¡äº† Updater æ¥å£ï¼Œä»è€Œè¾¾åˆ°é€»è¾‘é‡ç”¨ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// StatementExecutor.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡ŒSQLæ›´æ–°.</div><div class="line">* <span class="doctag">@return</span> æ›´æ–°æ•°é‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> executeUpdate(<span class="keyword">new</span> Updater() &#123;</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">(<span class="keyword">final</span> Statement statement, <span class="keyword">final</span> String sql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">           <span class="keyword">return</span> statement.executeUpdate(sql);</div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">(<span class="keyword">final</span> Updater updater)</span> </span>&#123;</div><div class="line">   Context context = MetricsContext.start(<span class="string">"ShardingStatement-executeUpdate"</span>);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       List&lt;Integer&gt; results = executorEngine.executeStatement(sqlType, statementUnits, <span class="keyword">new</span> ExecuteCallback&lt;Integer&gt;() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> Integer <span class="title">execute</span><span class="params">(<span class="keyword">final</span> BaseStatementUnit baseStatementUnit)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">               <span class="keyword">return</span> updater.executeUpdate(baseStatementUnit.getStatement(), baseStatementUnit.getSqlExecutionUnit().getSql());</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       <span class="keyword">return</span> accumulate(results);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       MetricsContext.stop(context);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¡ç®—æ€»çš„æ›´æ–°æ•°é‡</div><div class="line">* <span class="doctag">@param</span> results æ›´æ–°æ•°é‡æ•°ç»„</div><div class="line">* <span class="doctag">@return</span> æ›´æ–°æ•°é‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">accumulate</span><span class="params">(<span class="keyword">final</span> List&lt;Integer&gt; results)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> result = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (Integer each : results) &#123;</div><div class="line">       result += <span class="keyword">null</span> == each ? <span class="number">0</span> : each;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#execute()</code> å› ä¸ºæœ‰å››ä¸ªä¸åŒæƒ…å†µçš„<code>#execute()</code>ï¼Œæ‰€ä»¥æŠ½è±¡äº† Executor æ¥å£ï¼Œä»è€Œè¾¾åˆ°é€»è¾‘é‡ç”¨ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡ŒSQLè¯·æ±‚.</div><div class="line">* <span class="doctag">@return</span> trueè¡¨ç¤ºæ‰§è¡ŒDQLè¯­å¥, falseè¡¨ç¤ºæ‰§è¡Œçš„DMLè¯­å¥</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> execute(<span class="keyword">new</span> Executor() &#123;</div><div class="line">       </div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Statement statement, <span class="keyword">final</span> String sql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">           <span class="keyword">return</span> statement.execute(sql);</div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Executor executor)</span> </span>&#123;</div><div class="line">   Context context = MetricsContext.start(<span class="string">"ShardingStatement-execute"</span>);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       List&lt;Boolean&gt; result = executorEngine.executeStatement(sqlType, statementUnits, <span class="keyword">new</span> ExecuteCallback&lt;Boolean&gt;() &#123; </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> Boolean <span class="title">execute</span><span class="params">(<span class="keyword">final</span> BaseStatementUnit baseStatementUnit)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">               <span class="keyword">return</span> executor.execute(baseStatementUnit.getStatement(), baseStatementUnit.getSqlExecutionUnit().getSql());</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> == result || result.isEmpty() || <span class="keyword">null</span> == result.get(<span class="number">0</span>)) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> result.get(<span class="number">0</span>);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       MetricsContext.stop(context);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-2-PreparedStatementExecutor"><a href="#3-2-PreparedStatementExecutor" class="headerlink" title="3.2 PreparedStatementExecutor"></a>3.2 PreparedStatementExecutor</h2><p>PreparedStatementExecutorï¼Œ<strong>å¤šçº¿ç¨‹</strong>æ‰§è¡Œé¢„ç¼–è¯‘è¯­å¥å¯¹è±¡è¯·æ±‚çš„æ‰§è¡Œå™¨ã€‚æ¯” StatementExecutor å¤šäº† <code>parameters</code> å‚æ•°ï¼Œæ–¹æ³•é€»è¾‘ä¸ŠåŸºæœ¬ä¸€è‡´ï¼Œå°±ä¸é‡å¤åˆ†äº«å•¦ã€‚</p>
<h2 id="3-3-BatchPreparedStatementExecutor"><a href="#3-3-BatchPreparedStatementExecutor" class="headerlink" title="3.3 BatchPreparedStatementExecutor"></a>3.3 BatchPreparedStatementExecutor</h2><p>BatchPreparedStatementExecutorï¼Œ<strong>å¤šçº¿ç¨‹</strong>æ‰§è¡Œæ‰¹é‡é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡è¯·æ±‚çš„æ‰§è¡Œå™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// BatchPreparedStatementExecutor.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œæ‰¹é‡SQL.</div><div class="line">* </div><div class="line">* <span class="doctag">@return</span> æ‰§è¡Œç»“æœ</div><div class="line">*/</div><div class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] executeBatch() &#123;</div><div class="line">   Context context = MetricsContext.start(<span class="string">"ShardingPreparedStatement-executeBatch"</span>);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">return</span> accumulate(executorEngine.executeBatch(sqlType, batchPreparedStatementUnits, parameterSets, <span class="keyword">new</span> ExecuteCallback&lt;<span class="keyword">int</span>[]&gt;() &#123;</div><div class="line">           </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="keyword">public</span> <span class="keyword">int</span>[] execute(<span class="keyword">final</span> BaseStatementUnit baseStatementUnit) <span class="keyword">throws</span> Exception &#123;</div><div class="line">               <span class="keyword">return</span> baseStatementUnit.getStatement().executeBatch();</div><div class="line">           &#125;</div><div class="line">       &#125;));</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       MetricsContext.stop(context);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¡ç®—æ¯ä¸ªè¯­å¥çš„æ›´æ–°æ•°é‡</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> results æ¯æ¡ SQL æ›´æ–°æ•°é‡</div><div class="line">* <span class="doctag">@return</span> æ¯ä¸ªè¯­å¥çš„æ›´æ–°æ•°é‡</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span>[] accumulate(<span class="keyword">final</span> List&lt;<span class="keyword">int</span>[]&gt; results) &#123;</div><div class="line">   <span class="keyword">int</span>[] result = <span class="keyword">new</span> <span class="keyword">int</span>[parameterSets.size()];</div><div class="line">   <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">   <span class="comment">// æ¯ä¸ªè¯­å¥æŒ‰ç…§é¡ºåºï¼Œè¯»å–åˆ°å…¶å¯¹åº”çš„æ¯ä¸ªåˆ†ç‰‡SQLå½±å“çš„è¡Œæ•°è¿›è¡Œç´¯åŠ </span></div><div class="line">   <span class="keyword">for</span> (BatchPreparedStatementUnit each : batchPreparedStatementUnits) &#123;</div><div class="line">       <span class="keyword">for</span> (Map.Entry&lt;Integer, Integer&gt; entry : each.getJdbcAndActualAddBatchCallTimesMap().entrySet()) &#123;</div><div class="line">           result[entry.getKey()] += <span class="keyword">null</span> == results.get(count) ? <span class="number">0</span> : results.get(count)[entry.getValue()];</div><div class="line">       &#125;</div><div class="line">       count++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>çœ¼å°–</strong>çš„åŒå­¦ä¼šå‘ç°ï¼Œä¸ºä»€ä¹ˆæœ‰ BatchPreparedStatementExecutorï¼Œè€Œæ²¡æœ‰ BatchStatementExecutor å‘¢ï¼Ÿç›®å‰ Sharding-JDBC ä¸æ”¯æŒ Statement æ‰¹é‡æ“ä½œï¼Œåªèƒ½è¿›è¡Œ PreparedStatement çš„æ‰¹æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PreparedStatement æ‰¹é‡æ“ä½œï¼Œä¸ä¼šæŠ¥é”™</span></div><div class="line">PreparedStatement ps = conn.prepareStatement(sql)</div><div class="line">ps.addBatch();</div><div class="line">ps.addBatch();</div><div class="line"></div><div class="line"><span class="comment">// Statement æ‰¹é‡æ“ä½œï¼Œä¼šæŠ¥é”™</span></div><div class="line">ps.addBatch(sql); <span class="comment">// æŠ¥é”™ï¼šat com.dangdang.ddframe.rdb.sharding.jdbc.unsupported.AbstractUnsupportedOperationStatement.addBatch</span></div></pre></td></tr></table></figure>
<h1 id="4-ExecutionEvent"><a href="#4-ExecutionEvent" class="headerlink" title="4. ExecutionEvent"></a>4. ExecutionEvent</h1><p>AbstractExecutionEventï¼ŒSQL æ‰§è¡Œäº‹ä»¶æŠ½è±¡æ¥å£ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractExecutionEvent</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * äº‹ä»¶ç¼–å·</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String id;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•°æ®æº</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String dataSource;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String sql;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å‚æ•°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; parameters;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * äº‹ä»¶ç±»å‹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> EventExecutionType eventExecutionType;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¼‚å¸¸</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Optional&lt;SQLException&gt; exception;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AbstractExecutionEvent æœ‰ä¸¤ä¸ªå®ç°å­ç±»ï¼š</p>
<ul>
<li>DMLExecutionEventï¼šDMLç±»SQLæ‰§è¡Œæ—¶äº‹ä»¶</li>
<li>DQLExecutionEventï¼šDQLç±»SQLæ‰§è¡Œæ—¶äº‹ä»¶</li>
</ul>
<p>EventExecutionTypeï¼Œäº‹ä»¶è§¦å‘ç±»å‹ã€‚</p>
<ul>
<li>BEFORE_EXECUTEï¼šæ‰§è¡Œå‰</li>
<li>EXECUTE_SUCCESSï¼šæ‰§è¡ŒæˆåŠŸ</li>
<li>EXECUTE_FAILUREï¼šæ‰§è¡Œå¤±è´¥</li>
</ul>
<h2 id="4-1-EventBus"><a href="#4-1-EventBus" class="headerlink" title="4.1 EventBus"></a>4.1 EventBus</h2><p><strong>é‚£ç©¶ç«Ÿæœ‰ä»€ä¹ˆç”¨é€”å‘¢ï¼Ÿ</strong> Sharding-JDBC ä½¿ç”¨ Guavaï¼ˆ<strong>æ²¡é”™ï¼Œåˆæ˜¯å®ƒ</strong>ï¼‰çš„ <strong>EventBus</strong> å®ç°äº†<strong>äº‹ä»¶çš„å‘å¸ƒå’Œè®¢é˜…</strong>ã€‚ä»ä¸Šæ–‡ <code>ExecutorEngine#executeInternal()</code> æˆ‘ä»¬å¯ä»¥çœ‹åˆ°<strong>æ¯ä¸ªåˆ†ç‰‡</strong> SQL æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¼šå‘å¸ƒç›¸åº”äº‹ä»¶ï¼š</p>
<ul>
<li>æ‰§è¡Œ SQL å‰ï¼šå‘å¸ƒç±»å‹ç±»å‹ä¸º BEFORE_EXECUTE çš„äº‹ä»¶</li>
<li>æ‰§è¡Œ SQL æˆåŠŸï¼šå‘å¸ƒç±»å‹ç±»å‹ä¸º EXECUTE_SUCCESS çš„äº‹ä»¶</li>
<li>æ‰§è¡Œ SQL å¤±è´¥ï¼šå‘å¸ƒç±»å‹ç±»å‹ä¸º EXECUTE_FAILURE çš„äº‹ä»¶</li>
</ul>
<p><strong>æ€ä¹ˆè®¢é˜…äº‹ä»¶å‘¢ï¼Ÿ</strong>éå¸¸ç®€å•ï¼Œä¾‹å­å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">EventBusInstance.getInstance().register(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Subscribe</span> <span class="comment">// è®¢é˜…</span></div><div class="line">  <span class="meta">@AllowConcurrentEvents</span> <span class="comment">// æ˜¯å¦å…è®¸å¹¶å‘æ‰§è¡Œï¼Œå³çº¿ç¨‹å®‰å…¨</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(<span class="keyword">final</span> DMLExecutionEvent event)</span> </span>&#123; <span class="comment">// DMLExecutionEvent</span></div><div class="line">      System.out.println(<span class="string">"DMLExecutionEventï¼š"</span> + event.getSql() + <span class="string">"\t"</span> + event.getEventExecutionType());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Subscribe</span> <span class="comment">// è®¢é˜…</span></div><div class="line">  <span class="meta">@AllowConcurrentEvents</span> <span class="comment">// æ˜¯å¦å…è®¸å¹¶å‘æ‰§è¡Œï¼Œå³çº¿ç¨‹å®‰å…¨</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen2</span><span class="params">(<span class="keyword">final</span> DQLExecutionEvent event)</span> </span>&#123; <span class="comment">//DQLExecutionEvent</span></div><div class="line">      System.out.println(<span class="string">"DQLExecutionEventï¼š"</span> + event.getSql() + <span class="string">"\t"</span> + event.getEventExecutionType());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ul>
<li><code>#register()</code> ä»»ä½•ç±»éƒ½å¯ä»¥ï¼Œå¹¶éä¸€å®šéœ€è¦ä½¿ç”¨ Runnable ç±»ã€‚æ­¤å¤„ä¾‹å­å•çº¯å› ä¸ºæ–¹ä¾¿</li>
<li><code>@Subscribe</code> æ³¨è§£åœ¨æ–¹æ³•ä¸Šï¼Œå®ç°å¯¹äº‹ä»¶çš„è®¢é˜…</li>
<li><code>@AllowConcurrentEvents</code> æ³¨è§£åœ¨æ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºçº¿ç¨‹å®‰å…¨ï¼Œå…è®¸å¹¶å‘æ‰§è¡Œ</li>
<li>æ–¹æ³•ä¸Šçš„<strong>å‚æ•°å¯¹åº”çš„ç±»</strong>å³æ˜¯è®¢é˜…çš„äº‹ä»¶ã€‚ä¾‹å¦‚ï¼Œ<code>#listen()</code> è®¢é˜…äº† DMLExecutionEvent äº‹ä»¶</li>
<li><code>EventBus#post()</code> å‘å¸ƒäº‹ä»¶ï¼Œ<strong>åŒæ­¥</strong>è°ƒç”¨è®¢é˜…é€»è¾‘</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/05.png" alt=""></p>
<ul>
<li>æ¨èé˜…è¯»æ–‡ç« ï¼š<a href="http://www.cnblogs.com/peida/p/EventBus.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠGuavaå­¦ä¹ ç¬”è®°ï¼šEventBusã€‹</a></li>
</ul>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h2 id="4-2-BestEffortsDeliveryListener"><a href="#4-2-BestEffortsDeliveryListener" class="headerlink" title="4.2 BestEffortsDeliveryListener"></a>4.2 BestEffortsDeliveryListener</h2><p>BestEffortsDeliveryListenerï¼Œæœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨ã€‚</p>
<p>æœ¬æ–‡æš‚æ—¶æš‚æ—¶ä¸åˆ†æå…¶å®ç°ï¼Œä»…ä»…ä½œä¸ºå¦å¤–ä¸€ä¸ª<strong>è®¢é˜…è€…</strong>çš„ä¾‹å­ã€‚æˆ‘ä»¬ä¼šåœ¨<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠæŸ”æ€§äº‹åŠ¡ã€‹</a>è¿›è¡Œåˆ†äº«ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BestEffortsDeliveryListener</span> </span>&#123;</div><div class="line">    <span class="meta">@Subscribe</span></div><div class="line">    <span class="meta">@AllowConcurrentEvents</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(<span class="keyword">final</span> DMLExecutionEvent event)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!isProcessContinuously()) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        SoftTransactionConfiguration transactionConfig = SoftTransactionManager.getCurrentTransactionConfiguration().get();</div><div class="line">        TransactionLogStorage transactionLogStorage = TransactionLogStorageFactory.createTransactionLogStorage(transactionConfig.buildTransactionLogDataSource());</div><div class="line">        BEDSoftTransaction bedSoftTransaction = (BEDSoftTransaction) SoftTransactionManager.getCurrentTransaction().get();</div><div class="line">        <span class="keyword">switch</span> (event.getEventExecutionType()) &#123;</div><div class="line">            <span class="keyword">case</span> BEFORE_EXECUTE:</div><div class="line">                <span class="comment">//TODO å¯¹äºæ‰¹é‡æ‰§è¡Œçš„SQLéœ€è¦è§£ææˆä¸¤å±‚åˆ—è¡¨</span></div><div class="line">                transactionLogStorage.add(<span class="keyword">new</span> TransactionLog(event.getId(), bedSoftTransaction.getTransactionId(), bedSoftTransaction.getTransactionType(), </div><div class="line">                        event.getDataSource(), event.getSql(), event.getParameters(), System.currentTimeMillis(), <span class="number">0</span>));</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            <span class="keyword">case</span> EXECUTE_SUCCESS: </div><div class="line">                transactionLogStorage.remove(event.getId());</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            <span class="keyword">case</span> EXECUTE_FAILURE: </div><div class="line">                <span class="keyword">boolean</span> deliverySuccess = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; transactionConfig.getSyncMaxDeliveryTryTimes(); i++) &#123;</div><div class="line">                    <span class="keyword">if</span> (deliverySuccess) &#123;</div><div class="line">                        <span class="keyword">return</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">boolean</span> isNewConnection = <span class="keyword">false</span>;</div><div class="line">                    Connection conn = <span class="keyword">null</span>;</div><div class="line">                    PreparedStatement preparedStatement = <span class="keyword">null</span>;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        conn = bedSoftTransaction.getConnection().getConnection(event.getDataSource(), SQLType.UPDATE);</div><div class="line">                        <span class="keyword">if</span> (!isValidConnection(conn)) &#123;</div><div class="line">                            bedSoftTransaction.getConnection().release(conn);</div><div class="line">                            conn = bedSoftTransaction.getConnection().getConnection(event.getDataSource(), SQLType.UPDATE);</div><div class="line">                            isNewConnection = <span class="keyword">true</span>;</div><div class="line">                        &#125;</div><div class="line">                        preparedStatement = conn.prepareStatement(event.getSql());</div><div class="line">                        <span class="comment">//TODO å¯¹äºæ‰¹é‡äº‹ä»¶éœ€è¦è§£ææˆä¸¤å±‚åˆ—è¡¨</span></div><div class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> parameterIndex = <span class="number">0</span>; parameterIndex &lt; event.getParameters().size(); parameterIndex++) &#123;</div><div class="line">                            preparedStatement.setObject(parameterIndex + <span class="number">1</span>, event.getParameters().get(parameterIndex));</div><div class="line">                        &#125;</div><div class="line">                        preparedStatement.executeUpdate();</div><div class="line">                        deliverySuccess = <span class="keyword">true</span>;</div><div class="line">                        transactionLogStorage.remove(event.getId());</div><div class="line">                    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">                        log.error(String.format(<span class="string">"Delivery times %s error, max try times is %s"</span>, i + <span class="number">1</span>, transactionConfig.getSyncMaxDeliveryTryTimes()), ex);</div><div class="line">                    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                        close(isNewConnection, conn, preparedStatement);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            <span class="keyword">default</span>: </div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(event.getEventExecutionType().toString());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æœ¬æ–‡å®Œï¼Œä½†ä¹Ÿæœªå®Œã€‚</p>
<p><strong>è·¨åˆ†ç‰‡äº‹åŠ¡é—®é¢˜</strong>ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">UPDATE</span> t_order <span class="keyword">SET</span> nickname = ? <span class="keyword">WHERE</span> user_id = ?</div></pre></td></tr></table></figure>
<p>A èŠ‚ç‚¹ <code>connection.commit()</code> æ—¶ï¼Œåº”ç”¨çªç„¶æŒ‚äº†ï¼BèŠ‚ç‚¹ <code>connection.commit()</code> è¿˜æ¥ä¸åŠæ‰§è¡Œã€‚<br>æˆ‘ä»¬ä¸€èµ·å»<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠæŸ”æ€§äº‹åŠ¡ã€‹</a>å¯»æ‰¾ç­”æ¡ˆã€‚</p>
<p><strong>é“å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼Ÿ</strong></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/stron
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” åˆ†å¸ƒå¼ä¸»é”®</title>
    <link href="http://www.yunai.me/Sharding-JDBC/distributed-id/"/>
    <id>http://www.yunai.me/Sharding-JDBC/distributed-id/</id>
    <published>2017-08-11T16:00:00.000Z</published>
    <updated>2017-08-04T18:10:59.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2.KeyGenerator</a><ul>
<li><a href="#">2.1 DefaultKeyGenerator</a></li>
<li><a href="#">2.2 HostNameKeyGenerator</a></li>
<li><a href="#">2.3 IPKeyGenerator</a></li>
<li><a href="#">2.4 IPSectionKeyGenerator</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« Sharding-JDBC <strong>åˆ†å¸ƒå¼ä¸»é”®</strong>å®ç°ã€‚</p>
<p>å®˜æ–¹æ–‡æ¡£<a href="http://dangdangdotcom.github.io/sharding-jdbc/02-guide/key-generator/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šåˆ†å¸ƒå¼ä¸»é”®ã€‹</a>å¯¹å…¶ä»‹ç»åŠä½¿ç”¨æ–¹å¼ä»‹ç»å¾ˆå®Œæ•´ï¼Œå¼ºçƒˆå…ˆé˜…è¯»ã€‚ä¸‹é¢å…ˆå¼•ç”¨ä¸‹åˆ†å¸ƒå¼ä¸»é”®çš„<strong>å®ç°åŠ¨æœº</strong>ï¼š</p>
<blockquote>
<p>ä¼ ç»Ÿæ•°æ®åº“è½¯ä»¶å¼€å‘ä¸­ï¼Œä¸»é”®è‡ªåŠ¨ç”ŸæˆæŠ€æœ¯æ˜¯åŸºæœ¬éœ€æ±‚ã€‚è€Œå„å¤§æ•°æ®åº“å¯¹äºè¯¥éœ€æ±‚ä¹Ÿæä¾›äº†ç›¸åº”çš„æ”¯æŒï¼Œæ¯”å¦‚MySQLçš„è‡ªå¢é”®ã€‚å¯¹äºMySQLè€Œè¨€ï¼Œåˆ†åº“åˆ†è¡¨ä¹‹åï¼Œä¸åŒè¡¨ç”Ÿæˆå…¨å±€å”¯ä¸€çš„Idæ˜¯éå¸¸æ£˜æ‰‹çš„é—®é¢˜ã€‚å› ä¸ºåŒä¸€ä¸ªé€»è¾‘è¡¨å†…çš„ä¸åŒå®é™…è¡¨ä¹‹é—´çš„è‡ªå¢é”®æ˜¯æ— æ³•äº’ç›¸æ„ŸçŸ¥çš„ï¼Œè¿™æ ·ä¼šé€ æˆé‡å¤Idçš„ç”Ÿæˆã€‚æˆ‘ä»¬å½“ç„¶å¯ä»¥é€šè¿‡çº¦æŸè¡¨ç”Ÿæˆé”®çš„è§„åˆ™æ¥è¾¾åˆ°æ•°æ®çš„ä¸é‡å¤ï¼Œä½†æ˜¯è¿™éœ€è¦å¼•å…¥é¢å¤–çš„è¿ç»´åŠ›é‡æ¥è§£å†³é‡å¤æ€§é—®é¢˜ï¼Œå¹¶ä½¿æ¡†æ¶ç¼ºä¹æ‰©å±•æ€§ã€‚  </p>
<p>ç›®å‰æœ‰è®¸å¤šç¬¬ä¸‰æ–¹è§£å†³æ–¹æ¡ˆå¯ä»¥å®Œç¾è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚UUIDç­‰ä¾é ç‰¹å®šç®—æ³•è‡ªç”Ÿæˆä¸é‡å¤é”®ï¼Œæˆ–è€…é€šè¿‡å¼•å…¥Idç”ŸæˆæœåŠ¡ç­‰ã€‚ ä½†ä¹Ÿæ­£å› ä¸ºè¿™ç§å¤šæ ·æ€§å¯¼è‡´äº†Sharding-JDBCå¦‚æœå¼ºä¾èµ–äºä»»ä½•ä¸€ç§æ–¹æ¡ˆå°±ä¼šé™åˆ¶å…¶è‡ªèº«çš„å‘å±•ã€‚  </p>
<p>åŸºäºä»¥ä¸Šçš„åŸå› ï¼Œæœ€ç»ˆé‡‡ç”¨äº†ä»¥JDBCæ¥å£æ¥å®ç°å¯¹äºç”ŸæˆIdçš„è®¿é—®ï¼Œè€Œå°†åº•å±‚å…·ä½“çš„Idç”Ÿæˆå®ç°åˆ†ç¦»å‡ºæ¥ã€‚  </p>
</blockquote>
<hr>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1 id="2-KeyGenerator"><a href="#2-KeyGenerator" class="headerlink" title="2. KeyGenerator"></a>2. KeyGenerator</h1><p>KeyGeneratorï¼Œä¸»é”®ç”Ÿæˆå™¨æ¥å£ã€‚å®ç°ç±»é€šè¿‡å®ç° <code>#generateKey()</code> æ–¹æ³•å¯¹å¤–æä¾›<strong>ç”Ÿæˆä¸»é”®</strong>çš„åŠŸèƒ½ã€‚</p>
<h2 id="2-1-DefaultKeyGenerator"><a href="#2-1-DefaultKeyGenerator" class="headerlink" title="2.1 DefaultKeyGenerator"></a>2.1 DefaultKeyGenerator</h2><p>DefaultKeyGeneratorï¼Œé»˜è®¤çš„ä¸»é”®ç”Ÿæˆå™¨ã€‚è¯¥ç”Ÿæˆå™¨é‡‡ç”¨ Twitter Snowflake ç®—æ³•å®ç°ï¼Œç”Ÿæˆ <strong>64 Bits</strong> çš„ <strong>Long</strong> å‹ç¼–å·ã€‚å›½å†…å¦å¤–ä¸€æ¬¾æ•°æ®åº“ä¸­é—´ä»¶ MyCAT åˆ†å¸ƒå¼ä¸»é”®ä¹Ÿæ˜¯åŸºäºè¯¥ç®—æ³•å®ç°ã€‚å›½å†…å¾ˆå¤šå¤§å‹äº’è”ç½‘å…¬å¸<strong>å‘å·å™¨</strong>æœåŠ¡åŸºäºè¯¥ç®—æ³•åŠ éƒ¨åˆ†æ”¹é€ å®ç°ã€‚æ‰€ä»¥ DefaultKeyGenerator å¿…é¡»æ˜¯<strong>æ ¹æ­£è‹—çº¢</strong>ã€‚å¦‚æœä½ å¯¹<strong>åˆ†å¸ƒå¼ä¸»é”®</strong>æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹çœ‹é€—æ¯”ç¬”è€…æ•´ç†çš„<a href="http://www.yunai.me/Architecture/talk-about-global-id/?self">ã€Šè°ˆè°ˆ IDã€‹</a>ã€‚</p>
<p>å’³å’³å’³ï¼Œæœ‰ç‚¹è·‘é¢˜äº†ã€‚<strong>ç¼–å·</strong>ç”±å››éƒ¨åˆ†ç»„æˆï¼Œä»é«˜ä½åˆ°ä½ä½ï¼ˆä»å·¦åˆ°å³ï¼‰åˆ†åˆ«æ˜¯ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_12/01.png" alt=""></p>
<table>
<thead>
<tr>
<th style="text-align:left">Bits</th>
<th style="text-align:left">åå­—</th>
<th style="text-align:left">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">ç¬¦å·ä½</td>
<td style="text-align:left">ç­‰äº 0</td>
</tr>
<tr>
<td style="text-align:left">41</td>
<td style="text-align:left">æ—¶é—´æˆ³</td>
<td style="text-align:left">ä» 2016/11/01 é›¶ç‚¹å¼€å§‹çš„æ¯«ç§’æ•°ï¼Œæ”¯æŒ 2 ^41 /365/24/60/60/1000=69.7å¹´</td>
</tr>
<tr>
<td style="text-align:left">10</td>
<td style="text-align:left">å·¥ä½œè¿›ç¨‹ç¼–å·</td>
<td style="text-align:left">æ”¯æŒ 1024 ä¸ªè¿›ç¨‹</td>
</tr>
<tr>
<td style="text-align:left">12</td>
<td style="text-align:left">åºåˆ—å·</td>
<td style="text-align:left">æ¯æ¯«ç§’ä» 0 å¼€å§‹è‡ªå¢ï¼Œæ”¯æŒ 4096 ä¸ªç¼–å·</td>
</tr>
</tbody>
</table>
<ul>
<li>æ¯ä¸ªå·¥ä½œè¿›ç¨‹æ¯ç§’å¯ä»¥äº§ç”Ÿ 4096000 ä¸ªç¼–å·ã€‚æ˜¯ä¸æ˜¯ç°å¸¸ç‰›æ¯” ğŸ’¯</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// </span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultKeyGenerator</span> <span class="keyword">implements</span> <span class="title">KeyGenerator</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ—¶é—´åç§»é‡ï¼Œä»2016å¹´11æœˆ1æ—¥é›¶ç‚¹å¼€å§‹</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> EPOCH;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è‡ªå¢é‡å ç”¨æ¯”ç‰¹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SEQUENCE_BITS = <span class="number">12L</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å·¥ä½œè¿›ç¨‹IDæ¯”ç‰¹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> WORKER_ID_BITS = <span class="number">10L</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è‡ªå¢é‡æ©ç ï¼ˆæœ€å¤§å€¼ï¼‰</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SEQUENCE_MASK = (<span class="number">1</span> &lt;&lt; SEQUENCE_BITS) - <span class="number">1</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å·¥ä½œè¿›ç¨‹IDå·¦ç§»æ¯”ç‰¹æ•°ï¼ˆä½æ•°ï¼‰</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> WORKER_ID_LEFT_SHIFT_BITS = SEQUENCE_BITS;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ—¶é—´æˆ³å·¦ç§»æ¯”ç‰¹æ•°ï¼ˆä½æ•°ï¼‰</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> TIMESTAMP_LEFT_SHIFT_BITS = WORKER_ID_LEFT_SHIFT_BITS + WORKER_ID_BITS;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å·¥ä½œè¿›ç¨‹IDæœ€å¤§å€¼</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> WORKER_ID_MAX_VALUE = <span class="number">1L</span> &lt;&lt; WORKER_ID_BITS;</div><div class="line">    </div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> TimeService timeService = <span class="keyword">new</span> TimeService();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å·¥ä½œè¿›ç¨‹ID</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> workerId;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        Calendar calendar = Calendar.getInstance();</div><div class="line">        calendar.set(<span class="number">2016</span>, Calendar.NOVEMBER, <span class="number">1</span>);</div><div class="line">        calendar.set(Calendar.HOUR_OF_DAY, <span class="number">0</span>);</div><div class="line">        calendar.set(Calendar.MINUTE, <span class="number">0</span>);</div><div class="line">        calendar.set(Calendar.SECOND, <span class="number">0</span>);</div><div class="line">        calendar.set(Calendar.MILLISECOND, <span class="number">0</span>);</div><div class="line">        EPOCH = calendar.getTimeInMillis();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æœ€åè‡ªå¢é‡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> sequence;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æœ€åç”Ÿæˆç¼–å·æ—¶é—´æˆ³ï¼Œå•ä½ï¼šæ¯«ç§’</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> lastTime;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è®¾ç½®å·¥ä½œè¿›ç¨‹Id.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> workerId å·¥ä½œè¿›ç¨‹Id</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setWorkerId</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> workerId)</span> </span>&#123;</div><div class="line">        Preconditions.checkArgument(workerId &gt;= <span class="number">0L</span> &amp;&amp; workerId &lt; WORKER_ID_MAX_VALUE);</div><div class="line">        DefaultKeyGenerator.workerId = workerId;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç”ŸæˆId.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span> è¿”å›@&#123;<span class="doctag">@link</span> Long&#125;ç±»å‹çš„Id</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Number <span class="title">generateKey</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// ä¿è¯å½“å‰æ—¶é—´å¤§äºæœ€åæ—¶é—´ã€‚æ—¶é—´å›é€€ä¼šå¯¼è‡´äº§ç”Ÿé‡å¤id</span></div><div class="line">        <span class="keyword">long</span> currentMillis = timeService.getCurrentMillis();</div><div class="line">        Preconditions.checkState(lastTime &lt;= currentMillis, <span class="string">"Clock is moving backwards, last time is %d milliseconds, current time is %d milliseconds"</span>, lastTime, currentMillis);</div><div class="line">        <span class="comment">// è·å–åºåˆ—å·</span></div><div class="line">        <span class="keyword">if</span> (lastTime == currentMillis) &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="number">0L</span> == (sequence = ++sequence &amp; SEQUENCE_MASK)) &#123; <span class="comment">// å½“è·å¾—åºå·è¶…è¿‡æœ€å¤§å€¼æ—¶ï¼Œå½’0ï¼Œå¹¶å»è·å¾—æ–°çš„æ—¶é—´</span></div><div class="line">                currentMillis = waitUntilNextTime(currentMillis);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            sequence = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// è®¾ç½®æœ€åæ—¶é—´æˆ³</span></div><div class="line">        lastTime = currentMillis;</div><div class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">            log.debug(<span class="string">"&#123;&#125;-&#123;&#125;-&#123;&#125;"</span>, <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss.SSS"</span>).format(<span class="keyword">new</span> Date(lastTime)), workerId, sequence);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// ç”Ÿæˆç¼–å·</span></div><div class="line">        <span class="keyword">return</span> ((currentMillis - EPOCH) &lt;&lt; TIMESTAMP_LEFT_SHIFT_BITS) | (workerId &lt;&lt; WORKER_ID_LEFT_SHIFT_BITS) | sequence;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸åœè·å¾—æ—¶é—´ï¼Œç›´åˆ°å¤§äºæœ€åæ—¶é—´</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> lastTime æœ€åæ—¶é—´</div><div class="line">     * <span class="doctag">@return</span> æ—¶é—´</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">waitUntilNextTime</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> lastTime)</span> </span>&#123;</div><div class="line">        <span class="keyword">long</span> time = timeService.getCurrentMillis();</div><div class="line">        <span class="keyword">while</span> (time &lt;= lastTime) &#123;</div><div class="line">            time = timeService.getCurrentMillis();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> time;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>EPOCH = calendar.getTimeInMillis();</code> è®¡ç®— 2016/11/01 é›¶ç‚¹å¼€å§‹çš„æ¯«ç§’æ•°ã€‚</li>
<li><code>#generateKey()</code> å®ç°é€»è¾‘<ol>
<li>æ ¡éªŒå½“å‰æ—¶é—´<strong>å°äºç­‰äº</strong>æœ€åç”Ÿæˆç¼–å·æ—¶é—´æˆ³ï¼Œé¿å…æœåŠ¡å™¨æ—¶é’ŸåŒæ­¥ï¼Œå¯èƒ½äº§ç”Ÿæ—¶é—´å›é€€ï¼Œå¯¼è‡´äº§ç”Ÿ<strong>é‡å¤</strong>ç¼–å·</li>
</ol>
<ul>
<li>è·å¾—åºåˆ—å·ã€‚å½“å‰æ—¶é—´æˆ³å¯è·å¾—è‡ªå¢é‡åˆ°è¾¾æœ€å¤§å€¼æ—¶ï¼Œè°ƒç”¨ <code>#waitUntilNextTime()</code> è·å¾—ä¸‹ä¸€æ¯«ç§’</li>
<li>è®¾ç½®æœ€åç”Ÿæˆç¼–å·æ—¶é—´æˆ³ï¼Œç”¨äºæ ¡éªŒæ—¶é—´å›é€€æƒ…å†µ</li>
<li>ä½æ“ä½œç”Ÿæˆ<strong>ç¼–å·</strong></li>
</ul>
</li>
</ul>
<p>æ€»çš„æ¥è¯´ï¼ŒTwitter Snowflake ç®—æ³•å®ç°ä¸Šæ˜¯ç›¸å¯¹ç®€å•æ˜“æ‡‚çš„ï¼Œè¾ƒä¸ºéº»çƒ¦çš„æ˜¯<strong>æ€ä¹ˆè§£å†³å·¥ä½œè¿›ç¨‹ç¼–å·çš„åˆ†é…</strong>ï¼Ÿ</p>
<ol>
<li>è¶…è¿‡ 1024 ä¸ªæ€ä¹ˆåŠï¼Ÿ</li>
<li>æ€ä¹ˆä¿è¯å…¨å±€å”¯ä¸€ï¼Ÿ</li>
</ol>
<p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå°†åˆ†å¸ƒå¼ä¸»é”®ç”Ÿæˆç‹¬ç«‹æˆä¸€ä¸ª<strong>å‘å·å™¨</strong>æœåŠ¡ï¼Œæä¾›ç”Ÿæˆåˆ†å¸ƒå¼ç¼–å·çš„åŠŸèƒ½ã€‚è¿™ä¸ªä¸åœ¨æœ¬æ–‡çš„èŒƒå›´å†…ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ Google ä¸‹ã€‚</p>
<p>ç¬¬äºŒä¸ªé—®é¢˜ï¼Œé€šè¿‡ Zookeeperã€Consulã€Etcd ç­‰æä¾›åˆ†å¸ƒå¼é…ç½®åŠŸèƒ½çš„ä¸­é—´ä»¶ã€‚å½“ç„¶ Sharding-JDBC ä¹Ÿæä¾›äº†ä¸ä¾èµ–è¿™äº›æœåŠ¡çš„æ–¹å¼ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªå¾€ä¸‹çœ‹ã€‚</p>
<h2 id="2-2-HostNameKeyGenerator"><a href="#2-2-HostNameKeyGenerator" class="headerlink" title="2.2 HostNameKeyGenerator"></a>2.2 HostNameKeyGenerator</h2><blockquote>
<p>æ ¹æ®<strong>æœºå™¨åæœ€åçš„æ•°å­—ç¼–å·</strong>è·å–å·¥ä½œè¿›ç¨‹ç¼–å·ã€‚<br>å¦‚æœçº¿ä¸Šæœºå™¨å‘½åæœ‰ç»Ÿä¸€è§„èŒƒ,å»ºè®®ä½¿ç”¨æ­¤ç§æ–¹å¼ã€‚<br>ä¾‹å¦‚ï¼Œæœºå™¨çš„ HostName ä¸º: <code>dangdang-db-sharding-dev-01</code>(å…¬å¸å-éƒ¨é—¨å-æœåŠ¡å-ç¯å¢ƒå-ç¼–å·)ï¼Œä¼šæˆªå– HostName æœ€åçš„ç¼–å· 01 ä½œä¸ºå·¥ä½œè¿›ç¨‹ç¼–å·( workId )ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// HostNameKeyGenerator.java</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initWorkerId</span><span class="params">()</span> </span>&#123;</div><div class="line">   InetAddress address;</div><div class="line">   Long workerId;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       address = InetAddress.getLocalHost();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> UnknownHostException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot get LocalHost InetAddress, please check your network!"</span>);</div><div class="line">   &#125;</div><div class="line">   String hostName = address.getHostName();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       workerId = Long.valueOf(hostName.replace(hostName.replaceAll(<span class="string">"\\d+$"</span>, <span class="string">""</span>), <span class="string">""</span>));</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> NumberFormatException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(<span class="string">"Wrong hostname:%s, hostname must be end with number!"</span>, hostName));</div><div class="line">   &#125;</div><div class="line">   DefaultKeyGenerator.setWorkerId(workerId);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-3-IPKeyGenerator"><a href="#2-3-IPKeyGenerator" class="headerlink" title="2.3 IPKeyGenerator"></a>2.3 IPKeyGenerator</h2><blockquote>
<p>æ ¹æ®<strong>æœºå™¨IP</strong>è·å–å·¥ä½œè¿›ç¨‹ç¼–å·ã€‚<br>å¦‚æœçº¿ä¸Šæœºå™¨çš„IPäºŒè¿›åˆ¶è¡¨ç¤ºçš„æœ€å10ä½ä¸é‡å¤,å»ºè®®ä½¿ç”¨æ­¤ç§æ–¹å¼ã€‚<br>ä¾‹å¦‚ï¼Œæœºå™¨çš„IPä¸º192.168.1.108ï¼ŒäºŒè¿›åˆ¶è¡¨ç¤º:<code>11000000 10101000 00000001 01101100</code>ï¼Œæˆªå–æœ€å 10 ä½ <code>01 01101100</code>ï¼Œè½¬ä¸ºåè¿›åˆ¶ 364ï¼Œè®¾ç½®å·¥ä½œè¿›ç¨‹ç¼–å·ä¸º 364ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// IPKeyGenerator.java</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initWorkerId</span><span class="params">()</span> </span>&#123;</div><div class="line">   InetAddress address;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       address = InetAddress.getLocalHost();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> UnknownHostException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot get LocalHost InetAddress, please check your network!"</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">byte</span>[] ipAddressByteArray = address.getAddress();</div><div class="line">   DefaultKeyGenerator.setWorkerId((<span class="keyword">long</span>) (((ipAddressByteArray[ipAddressByteArray.length - <span class="number">2</span>] &amp; <span class="number">0B11</span>) &lt;&lt; Byte.SIZE)</div><div class="line">           + (ipAddressByteArray[ipAddressByteArray.length - <span class="number">1</span>] &amp; <span class="number">0xFF</span>)));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-4-IPSectionKeyGenerator"><a href="#2-4-IPSectionKeyGenerator" class="headerlink" title="2.4 IPSectionKeyGenerator"></a>2.4 IPSectionKeyGenerator</h2><p>æ¥è‡ª <strong>DogFc</strong> è´¡çŒ®ï¼Œå¯¹ IPKeyGenerator è¿›è¡Œæ”¹é€ ã€‚</p>
<blockquote>
<p>æµè§ˆ IPKeyGenerator å·¥ä½œè¿›ç¨‹ç¼–å·ç”Ÿæˆçš„è§„åˆ™åï¼Œæ„Ÿè§‰å¯¹æœåŠ¡å™¨IPå10ä½ï¼ˆç‰¹åˆ«æ˜¯IPV6ï¼‰æ•°å€¼æ¯”è¾ƒçº¦æŸã€‚<br>æœ‰ä»¥ä¸‹ä¼˜åŒ–æ€è·¯ï¼š<br>å› ä¸ºå·¥ä½œè¿›ç¨‹ç¼–å·æœ€å¤§é™åˆ¶æ˜¯ 2^10ï¼Œæˆ‘ä»¬ç”Ÿæˆçš„å·¥ç¨‹è¿›ç¨‹ç¼–å·åªè¦æ»¡è¶³å°äº 1024 å³å¯ã€‚<br>1.é’ˆå¯¹IPV4:<br>â€¦.IPæœ€å¤§ 255.255.255.255ã€‚è€Œï¼ˆ255+255+255+255) &lt; 1024ã€‚<br>â€¦.å› æ­¤é‡‡ç”¨IPæ®µæ•°å€¼ç›¸åŠ å³å¯ç”Ÿæˆå”¯ä¸€çš„workerIdï¼Œä¸å—IPä½é™åˆ¶ã€‚   </p>
<ol>
<li>é’ˆå¯¹IPV6:<br>â€¦.IPæœ€å¤§ ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff<br>â€¦.ä¸ºäº†ä¿è¯ç›¸åŠ ç”Ÿæˆå‡ºçš„å·¥ç¨‹è¿›ç¨‹ç¼–å· &lt; 1024,æ€è·¯æ˜¯å°†æ¯ä¸ª Bit ä½çš„å6ä½ç›¸åŠ ã€‚è¿™æ ·åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¹Ÿå¯ä»¥æ»¡è¶³workerIdä¸é‡å¤çš„é—®é¢˜ã€‚<br>ä½¿ç”¨è¿™ç§ IP ç”Ÿæˆå·¥ä½œè¿›ç¨‹ç¼–å·çš„æ–¹æ³•,å¿…é¡»ä¿è¯IPæ®µç›¸åŠ ä¸èƒ½é‡å¤  </li>
</ol>
</blockquote>
<p>å¯¹äº IPV6 ï¼š2^ 6 = 64ã€‚64 * 8 = 512 &lt; 1024ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// IPSectionKeyGenerator.java</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initWorkerId</span><span class="params">()</span> </span>&#123;</div><div class="line">   InetAddress address;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       address = InetAddress.getLocalHost();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> UnknownHostException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot get LocalHost InetAddress, please check your network!"</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">byte</span>[] ipAddressByteArray = address.getAddress();</div><div class="line">   <span class="keyword">long</span> workerId = <span class="number">0L</span>;</div><div class="line">   <span class="comment">// IPV4</span></div><div class="line">   <span class="keyword">if</span> (ipAddressByteArray.length == <span class="number">4</span>) &#123;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">byte</span> byteNum : ipAddressByteArray) &#123;</div><div class="line">           workerId += byteNum &amp; <span class="number">0xFF</span>;</div><div class="line">       &#125;</div><div class="line">   <span class="comment">// IPV6</span></div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ipAddressByteArray.length == <span class="number">16</span>) &#123;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">byte</span> byteNum : ipAddressByteArray) &#123;</div><div class="line">           workerId += byteNum &amp; <span class="number">0B111111</span>;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Bad LocalHost InetAddress, please check your network!"</span>);</div><div class="line">   &#125;</div><div class="line">   DefaultKeyGenerator.setWorkerId(workerId);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ²¡æœ‰å½©è›‹ã€‚HOHOHO</p>
<p>é“å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ã€‚</p>
<p>æ„Ÿè°¢ä½ ï¼ŒæŠ€æœ¯å¦‚æ­¤åªå¥½ï¼Œè¿˜å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€‚</p>
<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/stron
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±æ”¹å†™</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-rewrite/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-rewrite/</id>
    <published>2017-08-09T16:00:00.000Z</published>
    <updated>2017-08-03T13:12:30.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. SQLToken</a></li>
<li><a href="#">3.SQL æ”¹å†™</a><ul>
<li><a href="#">3.1 TableToken</a></li>
<li><a href="#">3.2 ItemsToken</a></li>
<li><a href="#">3.3 OffsetToken</a></li>
<li><a href="#">3.4 RowCountToken</a><ul>
<li><a href="#">3.4.1 åˆ†é¡µè¡¥å……</a></li>
</ul>
</li>
<li><a href="#">3.5 OrderByToken</a></li>
<li><a href="#">3.6 GeneratedKeyToken</a></li>
</ul>
</li>
<li><a href="#">4. SQL ç”Ÿæˆ</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>å‰ç½®é˜…è¯»ï¼š<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-3/?mp">ã€ŠSQL è§£æï¼ˆä¸‰ï¼‰ä¹‹æŸ¥è¯¢SQLã€‹</a></p>
<p>æœ¬æ–‡åˆ†äº«<strong>SQL æ”¹å†™</strong>çš„æºç å®ç°ã€‚ä¸»è¦æ¶‰åŠä¸¤æ–¹é¢ï¼š</p>
<ol>
<li>SQL æ”¹å†™ï¼šæ”¹å†™ SQLï¼Œè§£å†³åˆ†åº“åˆ†è¡¨åï¼ŒæŸ¥è¯¢ç»“æœéœ€è¦èšåˆï¼Œéœ€è¦å¯¹ SQL è¿›è¡Œè°ƒæ•´ï¼Œä¾‹å¦‚åˆ†é¡µ</li>
<li>SQL ç”Ÿæˆï¼šç”Ÿæˆåˆ†è¡¨åˆ†åº“çš„æ‰§è¡Œ SQL</li>
</ol>
<p>SQLRewriteEngineï¼ŒSQLé‡å†™å¼•æ“ï¼Œå®ç° SQL æ”¹å†™ã€ç”ŸæˆåŠŸèƒ½ã€‚ä» Sharding-JDBC 1.5.0 ç‰ˆæœ¬ï¼ŒSQL æ”¹å†™è¿›è¡Œäº†è°ƒæ•´å’Œå¤§é‡ä¼˜åŒ–ã€‚</p>
<blockquote>
<p>1.4.xåŠä¹‹å‰ç‰ˆæœ¬ï¼ŒSQLæ”¹å†™æ˜¯åœ¨SQLè·¯ç”±ä¹‹å‰å®Œæˆçš„ï¼Œåœ¨1.5.xä¸­è°ƒæ•´ä¸ºSQLè·¯ç”±ä¹‹åï¼Œå› ä¸ºSQLæ”¹å†™å¯ä»¥æ ¹æ®è·¯ç”±è‡³å•åº“è¡¨è¿˜æ˜¯å¤šåº“è¡¨è€Œè¿›è¡Œè¿›ä¸€æ­¥ä¼˜åŒ–ã€‚</p>
</blockquote>
<p>ğŸ˜† å¾ˆå¤šåŒå­¦çœ‹å®Œ<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL è§£æ-ç³»åˆ—ã€‹</a> å¯èƒ½æ˜¯ä¸€è„¸æ‡µé€¼ï¼Œç‰¹åˆ«å¯¹<strong>â€œSQL åŠç†è§£â€</strong>ã€‚<img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/01.png" alt="">å¸Œæœ›æœ¬æ–‡èƒ½ç»™ä½ ä¸€äº›å¯å‘ã€‚</p>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1 id="2-SQLToken"><a href="#2-SQLToken" class="headerlink" title="2. SQLToken"></a>2. SQLToken</h1><p>ğŸ˜ SQLToken åœ¨æœ¬æ–‡ä¸­å¾ˆé‡è¦ï¼Œæ‰€ä»¥å³ä½¿åœ¨<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL è§£æ-ç³»åˆ—ã€‹</a>å·²ç»åˆ†äº«è¿‡ï¼Œæˆ‘ä»¬ä¹Ÿæ¢ä¸ªå§¿åŠ¿ï¼Œå†æ¥ä¸€æ¬¡ã€‚</p>
<p>SQLTokenï¼ŒSQLæ ‡è®°å¯¹è±¡<strong>æ¥å£</strong>ã€‚SQLRewriteEngine åŸºäº SQLToken å®ç° <strong>SQLæ”¹å†™</strong>ã€‚SQLè§£æå™¨åœ¨ SQLè§£æè¿‡ç¨‹ä¸­ï¼Œå¾ˆé‡è¦çš„ä¸€ä¸ªç›®çš„æ˜¯<strong>æ ‡è®°éœ€è¦SQLæ”¹å†™çš„éƒ¨åˆ†</strong>ï¼Œä¹Ÿå°±æ˜¯ SQLTokenã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/02.png" alt=""></p>
<p><strong>å„ SQLToken ç”Ÿæˆæ¡ä»¶å¦‚ä¸‹</strong>(<em>æ‚²ä¼¤ï¼Œåšæˆè¡¨æ ¼å½¢å¼æ’ç‰ˆæ˜¯ä¹±çš„</em>)ï¼š</p>
<ol>
<li>GeneratedKeyToken è‡ªå¢ä¸»é”®æ ‡è®°å¯¹è±¡<ul>
<li>æ’å…¥SQLè‡ªå¢åˆ—ä¸å­˜åœ¨ï¼š<code>INSERT INTO t_order(nickname) VALUES ...</code> ä¸­æ²¡æœ‰è‡ªå¢åˆ— <code>order_id</code></li>
</ul>
</li>
<li>TableToken è¡¨æ ‡è®°å¯¹è±¡<ul>
<li>æŸ¥è¯¢åˆ—çš„è¡¨åˆ«åï¼š<code>SELECT o.order_id</code> çš„ <code>o</code> </li>
<li>æŸ¥è¯¢çš„è¡¨åï¼š<code>SELECT * FROM t_order</code> çš„ <code>t_order</code></li>
</ul>
</li>
<li>ItemsToken é€‰æ‹©é¡¹æ ‡è®°å¯¹è±¡<ul>
<li>AVGæŸ¥è¯¢åˆ—ï¼š<code>SELECT AVG(price) FROM t_order</code> çš„ <code>AVG(price)</code></li>
<li>ORDER BY å­—æ®µä¸åœ¨æŸ¥è¯¢åˆ—ï¼š<code>SELECT order_id FROM t_order ORDER BY create_time</code> çš„ <code>create_time</code></li>
<li>GROUP BY å­—æ®µä¸åœ¨æŸ¥è¯¢åˆ—ï¼š<code>SELECT COUNT(order_id) FROM t_order GROUP BY user_id</code> çš„ <code>user_id</code></li>
<li>è‡ªå¢ä¸»é”®æœªåœ¨æ’å…¥åˆ—ä¸­ï¼š<code>INSERT INTO t_order(nickname) VALUES ...</code> ä¸­æ²¡æœ‰è‡ªå¢åˆ— <code>order_id</code></li>
</ul>
</li>
<li>OffsetToken åˆ†é¡µåç§»é‡æ ‡è®°å¯¹è±¡<ul>
<li>åˆ†é¡µæœ‰åç§»é‡ï¼Œä½†<strong>ä¸æ˜¯</strong>å ä½ç¬¦ <code>?</code></li>
</ul>
</li>
<li>RowCountToken åˆ†é¡µé•¿åº¦æ ‡è®°å¯¹è±¡<ul>
<li>åˆ†é¡µæœ‰é•¿åº¦ï¼Œä½†<strong>ä¸æ˜¯</strong>å ä½ç¬¦ <code>?</code></li>
</ul>
</li>
<li>OrderByToken æ’åºæ ‡è®°å¯¹è±¡<ul>
<li>æœ‰ GROUP BY æ¡ä»¶ï¼Œæ—  ORDER BY æ¡ä»¶ï¼š<code>SELECT COUNT(*) FROM t_order GROUP BY order_id</code> çš„ <code>order_id</code></li>
</ul>
</li>
</ol>
<h1 id="3-SQL-æ”¹å†™"><a href="#3-SQL-æ”¹å†™" class="headerlink" title="3.SQL æ”¹å†™"></a>3.SQL æ”¹å†™</h1><p><code>SQLRewriteEngine#rewrite()</code> å®ç°äº† <strong>SQLæ”¹å†™</strong> åŠŸèƒ½ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* SQLæ”¹å†™.</div><div class="line">* <span class="doctag">@param</span> isRewriteLimit æ˜¯å¦é‡å†™Limit</div><div class="line">* <span class="doctag">@return</span> SQLæ„å»ºå™¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> SQLBuilder <span class="title">rewrite</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> isRewriteLimit)</span> </span>&#123;</div><div class="line">   SQLBuilder result = <span class="keyword">new</span> SQLBuilder();</div><div class="line">   <span class="keyword">if</span> (sqlTokens.isEmpty()) &#123;</div><div class="line">       result.appendLiterals(originalSQL);</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">   <span class="comment">// æ’åºSQLTokenï¼ŒæŒ‰ç…§ beginPosition é€’å¢</span></div><div class="line">   sortByBeginPosition();</div><div class="line">   <span class="keyword">for</span> (SQLToken each : sqlTokens) &#123;</div><div class="line">       <span class="keyword">if</span> (<span class="number">0</span> == count) &#123; <span class="comment">// æ‹¼æ¥ç¬¬ä¸€ä¸ª SQLToken å‰çš„å­—ç¬¦ä¸²</span></div><div class="line">           result.appendLiterals(originalSQL.substring(<span class="number">0</span>, each.getBeginPosition()));</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// æ‹¼æ¥æ¯ä¸ªSQLToken</span></div><div class="line">       <span class="keyword">if</span> (each <span class="keyword">instanceof</span> TableToken) &#123;</div><div class="line">           appendTableToken(result, (TableToken) each, count, sqlTokens);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (each <span class="keyword">instanceof</span> ItemsToken) &#123;</div><div class="line">           appendItemsToken(result, (ItemsToken) each, count, sqlTokens);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (each <span class="keyword">instanceof</span> RowCountToken) &#123;</div><div class="line">           appendLimitRowCount(result, (RowCountToken) each, count, sqlTokens, isRewriteLimit);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (each <span class="keyword">instanceof</span> OffsetToken) &#123;</div><div class="line">           appendLimitOffsetToken(result, (OffsetToken) each, count, sqlTokens, isRewriteLimit);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (each <span class="keyword">instanceof</span> OrderByToken) &#123;</div><div class="line">           appendOrderByToken(result);</div><div class="line">       &#125;</div><div class="line">       count++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>SQLæ”¹å†™ä»¥ SQLToken ä¸º<strong>é—´éš”</strong>ï¼Œ<strong>é¡ºåº</strong>æ”¹å†™ã€‚<ul>
<li>é¡ºåºï¼šè°ƒç”¨ <code>#sortByBeginPosition()</code> å°† SQLToken æŒ‰ç…§ <code>beginPosition</code> <strong>å‡åº</strong>ã€‚</li>
<li>é—´éš”ï¼šéå† SQLTokenï¼Œé€ä¸ªæ‹¼æ¥ã€‚</li>
</ul>
</li>
</ul>
<p>ä¾‹å¦‚ï¼š<br>    <img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/03.png" alt=""></p>
<hr>
<p>SQLBuilderï¼ŒSQLæ„å»ºå™¨ã€‚ä¸‹æ–‡ä¼šå¤§é‡ç”¨åˆ°ï¼Œæˆ‘ä»¬çœ‹ä¸‹å®ç°ä»£ç ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SQLBuilder</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ®µé›†åˆ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; segments;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å½“å‰æ®µ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> StringBuilder currentSegment;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SQLBuilder</span><span class="params">()</span> </span>&#123;</div><div class="line">        segments = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">        currentSegment = <span class="keyword">new</span> StringBuilder();</div><div class="line">        segments.add(currentSegment);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¿½åŠ å­—é¢é‡.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> literals å­—é¢é‡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendLiterals</span><span class="params">(<span class="keyword">final</span> String literals)</span> </span>&#123;</div><div class="line">        currentSegment.append(literals);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¿½åŠ è¡¨å ä½ç¬¦.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> tableName è¡¨åç§°</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendTable</span><span class="params">(<span class="keyword">final</span> String tableName)</span> </span>&#123;</div><div class="line">        <span class="comment">// æ·»åŠ  TableToken</span></div><div class="line">        segments.add(<span class="keyword">new</span> TableToken(tableName));</div><div class="line">        <span class="comment">// æ–°å»ºå½“å‰æ®µ</span></div><div class="line">        currentSegment = <span class="keyword">new</span> StringBuilder();</div><div class="line">        segments.add(currentSegment);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toSQL</span><span class="params">(<span class="keyword">final</span> Map&lt;String, String&gt; tableTokens)</span> </span>&#123;</div><div class="line">        <span class="comment">// ... çœç•¥ä»£ç ï¼Œã€SQLç”Ÿæˆã€‘å¤„åˆ†äº«</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@RequiredArgsConstructor</span></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">TableToken</span> </span>&#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * è¡¨å</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String tableName;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>ç°åœ¨æˆ‘ä»¬æ¥é€ä¸ªåˆ†ææ¯ç§ SQLToken çš„<strong>æ‹¼æ¥</strong>å®ç°ã€‚</p>
<h2 id="3-1-TableToken"><a href="#3-1-TableToken" class="headerlink" title="3.1 TableToken"></a>3.1 TableToken</h2><p>è°ƒç”¨ <code>#appendTableToken()</code> æ–¹æ³•æ‹¼æ¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‹¼æ¥ TableToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLæ„å»ºå™¨</div><div class="line">* <span class="doctag">@param</span> tableToken tableToken</div><div class="line">* <span class="doctag">@param</span> count tableToken åœ¨ sqlTokens çš„é¡ºåº</div><div class="line">* <span class="doctag">@param</span> sqlTokens sqlTokens</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendTableToken</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder, <span class="keyword">final</span> TableToken tableToken, <span class="keyword">final</span> <span class="keyword">int</span> count, <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ‹¼æ¥ TableToken</span></div><div class="line">   String tableName = sqlStatement.getTables().getTableNames().contains(tableToken.getTableName()) ? tableToken.getTableName() : tableToken.getOriginalLiterals();</div><div class="line">   sqlBuilder.appendTable(tableName);</div><div class="line">   <span class="comment">// æ‹¼æ¥ SQLToken åé¢çš„å­—ç¬¦ä¸²</span></div><div class="line">   <span class="keyword">int</span> beginPosition = tableToken.getBeginPosition() + tableToken.getOriginalLiterals().length();</div><div class="line">   <span class="keyword">int</span> endPosition = sqlTokens.size() - <span class="number">1</span> == count ? originalSQL.length() : sqlTokens.get(count + <span class="number">1</span>).getBeginPosition();</div><div class="line">   sqlBuilder.appendLiterals(originalSQL.substring(beginPosition, endPosition));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>SQLBuilder#appendTable()</code> æ‹¼æ¥ TableTokenã€‚</li>
<li><code>sqlStatement.getTables().getTableNames().contains(tableToken.getTableName())</code> ç›®çš„æ˜¯å¤„ç†æ‰<strong>è¡¨åå‰åæœ‰çš„ç‰¹æ®Šå­—ç¬¦</strong>ï¼Œä¾‹å¦‚<code>SELECT * FROM &#39;t_order&#39;</code> ä¸­ <code>t_order</code> å‰åæœ‰ <code>&#39;</code> ç¬¦å·ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TableToken.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–è¡¨åç§°.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getTableName</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> SQLUtil.getExactlyValue(originalLiterals);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SQLUtil.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getExactlyValue</span><span class="params">(<span class="keyword">final</span> String value)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span> == value ? <span class="keyword">null</span> : CharMatcher.anyOf(<span class="string">"[]`'\""</span>).removeFrom(value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å½“ SQL ä¸º <code>SELECT o.* FROM t_order o</code><ul>
<li>TableToken ä¸ºæŸ¥è¯¢åˆ—å‰çš„è¡¨åˆ«å <code>o</code> æ—¶è¿”å›ç»“æœï¼š<br>  <img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/04.png" alt=""></li>
<li>TableToken ä¸ºè¡¨å <code>t_order</code> æ—¶è¿”å›ç»“æœï¼š<br>  <img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/05.png" alt=""></li>
</ul>
</li>
</ul>
<h2 id="3-2-ItemsToken"><a href="#3-2-ItemsToken" class="headerlink" title="3.2 ItemsToken"></a>3.2 ItemsToken</h2><p>è°ƒç”¨ <code>#appendItemsToken()</code> æ–¹æ³•æ‹¼æ¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‹¼æ¥ TableToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLæ„å»ºå™¨</div><div class="line">* <span class="doctag">@param</span> itemsToken itemsToken</div><div class="line">* <span class="doctag">@param</span> count itemsToken åœ¨ sqlTokens çš„é¡ºåº</div><div class="line">* <span class="doctag">@param</span> sqlTokens sqlTokens</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendItemsToken</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder, <span class="keyword">final</span> ItemsToken itemsToken, <span class="keyword">final</span> <span class="keyword">int</span> count, <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ‹¼æ¥ ItemsToken</span></div><div class="line">   <span class="keyword">for</span> (String item : itemsToken.getItems()) &#123;</div><div class="line">       sqlBuilder.appendLiterals(<span class="string">", "</span>);</div><div class="line">       sqlBuilder.appendLiterals(item);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// SQLToken åé¢çš„å­—ç¬¦ä¸²</span></div><div class="line">   <span class="keyword">int</span> beginPosition = itemsToken.getBeginPosition();</div><div class="line">   <span class="keyword">int</span> endPosition = sqlTokens.size() - <span class="number">1</span> == count ? originalSQL.length() : sqlTokens.get(count + <span class="number">1</span>).getBeginPosition();</div><div class="line">   sqlBuilder.appendLiterals(originalSQL.substring(beginPosition, endPosition));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ç¬¬ä¸€ç§æƒ…å†µï¼Œ<strong>AVGæŸ¥è¯¢åˆ—</strong>ï¼ŒSQL ä¸º <code>SELECT AVG(order_id) FROM t_order o</code> æ—¶è¿”å›ç»“æœï¼š<br><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/06.png" alt=""></li>
<li>ç¬¬äºŒç§æƒ…å†µï¼Œ<strong>ORDER BY å­—æ®µä¸åœ¨æŸ¥è¯¢åˆ—</strong>ï¼ŒSQL ä¸º <code>SELECT userId FROM t_order o ORDER BY order_id</code> æ—¶è¿”å›ç»“æœï¼š<br><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/07.png" alt=""></li>
<li>ç¬¬ä¸‰ç§æƒ…å†µï¼Œ<strong>GROUP BY å­—æ®µä¸åœ¨æŸ¥è¯¢åˆ—</strong>ï¼Œç±»ä¼¼ç¬¬äºŒç§æƒ…å†µï¼Œå°±ä¸ä¸¾ä¾‹å­åˆ—ã€‚</li>
</ul>
<h2 id="3-3-OffsetToken"><a href="#3-3-OffsetToken" class="headerlink" title="3.3 OffsetToken"></a>3.3 OffsetToken</h2><p>è°ƒç”¨ <code>#appendLimitOffsetToken()</code> æ–¹æ³•æ‹¼æ¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‹¼æ¥ OffsetToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLæ„å»ºå™¨</div><div class="line">* <span class="doctag">@param</span> offsetToken offsetToken</div><div class="line">* <span class="doctag">@param</span> count offsetToken åœ¨ sqlTokens çš„é¡ºåº</div><div class="line">* <span class="doctag">@param</span> sqlTokens sqlTokens</div><div class="line">* <span class="doctag">@param</span> isRewrite æ˜¯å¦é‡å†™ã€‚å½“è·¯ç”±ç»“æœä¸ºå•åˆ†ç‰‡æ—¶æ— éœ€é‡å†™</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendLimitOffsetToken</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder, <span class="keyword">final</span> OffsetToken offsetToken, <span class="keyword">final</span> <span class="keyword">int</span> count, <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens, <span class="keyword">final</span> <span class="keyword">boolean</span> isRewrite)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ‹¼æ¥ OffsetToken</span></div><div class="line">   sqlBuilder.appendLiterals(isRewrite ? <span class="string">"0"</span> : String.valueOf(offsetToken.getOffset()));</div><div class="line">   <span class="comment">// SQLToken åé¢çš„å­—ç¬¦ä¸²</span></div><div class="line">   <span class="keyword">int</span> beginPosition = offsetToken.getBeginPosition() + String.valueOf(offsetToken.getOffset()).length();</div><div class="line">   <span class="keyword">int</span> endPosition = sqlTokens.size() - <span class="number">1</span> == count ? originalSQL.length() : sqlTokens.get(count + <span class="number">1</span>).getBeginPosition();</div><div class="line">   sqlBuilder.appendLiterals(originalSQL.substring(beginPosition, endPosition));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å½“åˆ†é¡µ<strong>è·¨åˆ†ç‰‡</strong>æ—¶ï¼Œéœ€è¦æ¯ä¸ªåˆ†ç‰‡éƒ½æŸ¥è¯¢ååœ¨<strong>å†…å­˜</strong>ä¸­è¿›è¡Œèšåˆã€‚æ­¤æ—¶ <code>isRewrite = true</code>ã€‚ä¸ºä»€ä¹ˆæ˜¯ <code>&quot;0&quot;</code> å¼€å§‹å‘¢ï¼Ÿæ¯ä¸ªåˆ†ç‰‡åœ¨ [0, offset) çš„è®°å½•<strong>å¯èƒ½</strong>å±äºå®é™…åˆ†é¡µç»“æœï¼Œå› è€ŒæŸ¥è¯¢æ¯ä¸ªåˆ†ç‰‡éœ€è¦ä» 0 å¼€å§‹ã€‚</li>
<li>å½“åˆ†é¡µ<strong>å•åˆ†ç‰‡</strong>æ—¶ï¼Œåˆ™æ— éœ€é‡å†™ï¼Œè¯¥åˆ†ç‰‡æ‰§è¡Œçš„ç»“æœå³æ˜¯æœ€ç»ˆç»“æœã€‚<strong>SQLæ”¹å†™åœ¨SQLè·¯ç”±ä¹‹åå°±æœ‰è¿™ä¸ªå¥½å¤„</strong>ã€‚å¦‚æœå…ˆæ”¹å†™ï¼Œå› ä¸ºæ²¡åŠæ³•çŸ¥é“æœ€ç»ˆæ˜¯å•åˆ†ç‰‡è¿˜æ˜¯è·¨åˆ†ç‰‡ï¼Œè€ƒè™‘æ­£ç¡®æ€§ï¼Œåªèƒ½ç»Ÿä¸€ä½¿ç”¨è·¨åˆ†ç‰‡ã€‚</li>
</ul>
<h2 id="3-4-RowCountToken"><a href="#3-4-RowCountToken" class="headerlink" title="3.4 RowCountToken"></a>3.4 RowCountToken</h2><p>è°ƒç”¨ <code>#appendLimitRowCount()</code> æ–¹æ³•æ‹¼æ¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendLimitRowCount</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder, <span class="keyword">final</span> RowCountToken rowCountToken, <span class="keyword">final</span> <span class="keyword">int</span> count, <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens, <span class="keyword">final</span> <span class="keyword">boolean</span> isRewrite)</span> </span>&#123;</div><div class="line">   SelectStatement selectStatement = (SelectStatement) sqlStatement;</div><div class="line">   Limit limit = selectStatement.getLimit();</div><div class="line">   <span class="keyword">if</span> (!isRewrite) &#123; <span class="comment">// è·¯ç”±ç»“æœä¸ºå•åˆ†ç‰‡</span></div><div class="line">       sqlBuilder.appendLiterals(String.valueOf(rowCountToken.getRowCount()));</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((!selectStatement.getGroupByItems().isEmpty() || <span class="comment">// [1.1] è·¨åˆ†ç‰‡åˆ†ç»„éœ€è¦åœ¨å†…å­˜è®¡ç®—ï¼Œå¯èƒ½éœ€è¦å…¨éƒ¨åŠ è½½</span></div><div class="line">           !selectStatement.getAggregationSelectItems().isEmpty()) <span class="comment">// [1.2] è·¨åˆ†ç‰‡èšåˆåˆ—éœ€è¦åœ¨å†…å­˜è®¡ç®—ï¼Œå¯èƒ½éœ€è¦å…¨éƒ¨åŠ è½½</span></div><div class="line">           &amp;&amp; !selectStatement.isSameGroupByAndOrderByItems()) &#123; <span class="comment">// [2] å¦‚æœæ’åºä¸€è‡´ï¼Œå³å„åˆ†ç‰‡å·²ç»æ’åºå¥½ç»“æœï¼Œå°±ä¸éœ€è¦å…¨éƒ¨åŠ è½½</span></div><div class="line">       sqlBuilder.appendLiterals(String.valueOf(Integer.MAX_VALUE));</div><div class="line">   &#125; <span class="keyword">else</span> &#123; <span class="comment">// è·¯ç”±ç»“æœä¸ºå¤šåˆ†ç‰‡</span></div><div class="line">       sqlBuilder.appendLiterals(String.valueOf(limit.isRowCountRewriteFlag() ? rowCountToken.getRowCount() + limit.getOffsetValue() : rowCountToken.getRowCount()));</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// SQLToken åé¢çš„å­—ç¬¦ä¸²</span></div><div class="line">   <span class="keyword">int</span> beginPosition = rowCountToken.getBeginPosition() + String.valueOf(rowCountToken.getRowCount()).length();</div><div class="line">   <span class="keyword">int</span> endPosition = sqlTokens.size() - <span class="number">1</span> == count ? originalSQL.length() : sqlTokens.get(count + <span class="number">1</span>).getBeginPosition();</div><div class="line">   sqlBuilder.appendLiterals(originalSQL.substring(beginPosition, endPosition));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>[1.1] <code>!selectStatement.getGroupByItems().isEmpty()</code> è·¨åˆ†ç‰‡<strong>åˆ†ç»„</strong>éœ€è¦åœ¨å†…å­˜è®¡ç®—ï¼Œ<strong>å¯èƒ½</strong>éœ€è¦å…¨éƒ¨åŠ è½½ã€‚å¦‚æœä¸å…¨éƒ¨åŠ è½½ï¼Œéƒ¨åˆ†ç»“æœè¢«åˆ†é¡µæ¡ä»¶é”™è¯¯ç»“æœï¼Œä¼šå¯¼è‡´ç»“æœä¸æ­£ç¡®ã€‚</li>
<li>[1.2] <code>!selectStatement.getAggregationSelectItems().isEmpty())</code> è·¨åˆ†ç‰‡<strong>èšåˆåˆ—</strong>éœ€è¦åœ¨å†…å­˜è®¡ç®—ï¼Œ<strong>å¯èƒ½</strong>éœ€è¦å…¨éƒ¨åŠ è½½ã€‚å¦‚æœä¸å…¨éƒ¨åŠ è½½ï¼Œéƒ¨åˆ†ç»“æœè¢«åˆ†é¡µæ¡ä»¶é”™è¯¯ç»“æœï¼Œä¼šå¯¼è‡´ç»“æœä¸æ­£ç¡®ã€‚</li>
<li>[1.1][1.2]ï¼Œ<strong>å¯èƒ½</strong>å˜æˆå¿…é¡»çš„å‰ææ˜¯ GROUP BY å’Œ ORDER BY æ’åºä¸ä¸€è‡´ã€‚å¦‚æœä¸€è‡´ï¼Œå„åˆ†ç‰‡å·²ç»æ’åºå®Œæˆï¼Œæ— éœ€å†…å­˜ä¸­æ’åºã€‚</li>
</ul>
<h3 id="3-4-1-åˆ†é¡µè¡¥å……"><a href="#3-4-1-åˆ†é¡µè¡¥å……" class="headerlink" title="3.4.1 åˆ†é¡µè¡¥å……"></a>3.4.1 åˆ†é¡µè¡¥å……</h3><p>OffsetTokenã€RowCountToken åªæœ‰åœ¨åˆ†é¡µå¯¹åº”ä½ç½®éå ä½ç¬¦ <code>?</code> æ‰å­˜åœ¨ã€‚å½“å¯¹åº”ä½ç½®æ˜¯å ä½ç¬¦æ—¶ï¼Œä¼šå¯¹<strong>åˆ†é¡µæ¡ä»¶å¯¹åº”çš„é¢„ç¼–è¯‘ SQL å ä½ç¬¦å‚æ•°</strong>è¿›è¡Œé‡å†™ï¼Œ<strong>æ•´ä½“é€»è¾‘å’Œ OffsetTokenã€RowCountToken æ˜¯ä¸€è‡´çš„</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ğŸ‘¼ ParsingSQLRouter#route() è°ƒç”¨ #processLimit() </span></div><div class="line"></div><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å¤„ç†åˆ†é¡µæ¡ä»¶</div><div class="line">*</div><div class="line">* <span class="doctag">@see</span> SQLRewriteEngine#appendLimitRowCount(SQLBuilder, RowCountToken, int, List, boolean) </div><div class="line">* <span class="doctag">@param</span> parameters å ä½ç¬¦å¯¹åº”å‚æ•°åˆ—è¡¨</div><div class="line">* <span class="doctag">@param</span> selectStatement Select SQLè¯­å¥å¯¹è±¡</div><div class="line">* <span class="doctag">@param</span> isSingleRouting æ˜¯å¦å•è¡¨è·¯ç”±</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processLimit</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SelectStatement selectStatement, <span class="keyword">final</span> <span class="keyword">boolean</span> isSingleRouting)</span> </span>&#123;</div><div class="line">   <span class="keyword">boolean</span> isNeedFetchAll = (!selectStatement.getGroupByItems().isEmpty() <span class="comment">// // [1.1] è·¨åˆ†ç‰‡åˆ†ç»„éœ€è¦åœ¨å†…å­˜è®¡ç®—ï¼Œå¯èƒ½éœ€è¦å…¨éƒ¨åŠ è½½</span></div><div class="line">                               || !selectStatement.getAggregationSelectItems().isEmpty()) <span class="comment">// [1.2] è·¨åˆ†ç‰‡èšåˆåˆ—éœ€è¦åœ¨å†…å­˜è®¡ç®—ï¼Œå¯èƒ½éœ€è¦å…¨éƒ¨åŠ è½½</span></div><div class="line">                           &amp;&amp; !selectStatement.isSameGroupByAndOrderByItems(); <span class="comment">// [2] å¦‚æœæ’åºä¸€è‡´ï¼Œå³å„åˆ†ç‰‡å·²ç»æ’åºå¥½ç»“æœï¼Œå°±ä¸éœ€è¦å…¨éƒ¨åŠ è½½</span></div><div class="line">   selectStatement.getLimit().processParameters(parameters, !isSingleRouting, isNeedFetchAll);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Limit.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å¡«å……æ”¹å†™åˆ†é¡µå‚æ•°.</div><div class="line">* <span class="doctag">@param</span> parameters å‚æ•°</div><div class="line">* <span class="doctag">@param</span> isRewrite æ˜¯å¦é‡å†™å‚æ•°</div><div class="line">* <span class="doctag">@param</span> isFetchAll æ˜¯å¦è·å–æ‰€æœ‰æ•°æ®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processParameters</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> <span class="keyword">boolean</span> isRewrite, <span class="keyword">final</span> <span class="keyword">boolean</span> isFetchAll)</span> </span>&#123;</div><div class="line">   fill(parameters);</div><div class="line">   <span class="keyword">if</span> (isRewrite) &#123;</div><div class="line">       rewrite(parameters, isFetchAll);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* å°†å ä½ç¬¦å‚æ•°é‡Œæ˜¯åˆ†é¡µçš„å‚æ•°èµ‹å€¼ç»™ offset ã€rowCount</div><div class="line">* èµ‹å€¼çš„å‰ææ¡ä»¶æ˜¯ offsetã€rowCount æ˜¯ å ä½ç¬¦</div><div class="line">* <span class="doctag">@param</span> parameters å ä½ç¬¦å‚æ•°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fill</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> offset = <span class="number">0</span>;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != <span class="keyword">this</span>.offset) &#123;</div><div class="line">       offset = -<span class="number">1</span> == <span class="keyword">this</span>.offset.getIndex() ? getOffsetValue() : NumberUtil.roundHalfUp(parameters.get(<span class="keyword">this</span>.offset.getIndex()));</div><div class="line">       <span class="keyword">this</span>.offset.setValue(offset);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">int</span> rowCount = <span class="number">0</span>;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != <span class="keyword">this</span>.rowCount) &#123;</div><div class="line">       rowCount = -<span class="number">1</span> == <span class="keyword">this</span>.rowCount.getIndex() ? getRowCountValue() : NumberUtil.roundHalfUp(parameters.get(<span class="keyword">this</span>.rowCount.getIndex()));</div><div class="line">       <span class="keyword">this</span>.rowCount.setValue(rowCount);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (offset &lt; <span class="number">0</span> || rowCount &lt; <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingException(<span class="string">"LIMIT offset and row count can not be a negative value."</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* é‡å†™åˆ†é¡µæ¡ä»¶å¯¹åº”çš„å‚æ•°</div><div class="line">* <span class="doctag">@param</span> parameters å‚æ•°</div><div class="line">* <span class="doctag">@param</span> isFetchAll æ˜¯å¦æ‹‰å–æ‰€æœ‰</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rewrite</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> <span class="keyword">boolean</span> isFetchAll)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> rewriteOffset = <span class="number">0</span>;</div><div class="line">   <span class="keyword">int</span> rewriteRowCount;</div><div class="line">   <span class="comment">// é‡å†™</span></div><div class="line">   <span class="keyword">if</span> (isFetchAll) &#123;</div><div class="line">       rewriteRowCount = Integer.MAX_VALUE;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rowCountRewriteFlag) &#123;</div><div class="line">       rewriteRowCount = <span class="keyword">null</span> == rowCount ? -<span class="number">1</span> : getOffsetValue() + rowCount.getValue();</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       rewriteRowCount = rowCount.getValue();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å‚æ•°è®¾ç½®</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != offset &amp;&amp; offset.getIndex() &gt; -<span class="number">1</span>) &#123;</div><div class="line">       parameters.set(offset.getIndex(), rewriteOffset);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != rowCount &amp;&amp; rowCount.getIndex() &gt; -<span class="number">1</span>) &#123;</div><div class="line">       parameters.set(rowCount.getIndex(), rewriteRowCount);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-5-OrderByToken"><a href="#3-5-OrderByToken" class="headerlink" title="3.5 OrderByToken"></a>3.5 OrderByToken</h2><p>è°ƒç”¨ <code>#appendOrderByToken()</code> æ–¹æ³•æ‹¼æ¥ã€‚æ•°æ®åº“é‡Œï¼Œå½“æ—  ORDER BYæ¡ä»¶ è€Œæœ‰ GROUP BY æ¡ä»¶æ—¶å€™ï¼Œä¼šä½¿ç”¨ GROUP BYæ¡ä»¶å°†ç»“æœå‡åºæ’åºï¼š</p>
<ul>
<li><code>SELECT order_id FROM t_order GROUP BY order_id</code> ç­‰ä»·äº <code>SELECT order_id FROM t_order GROUP BY order_id ORDER BY order_id ASC</code></li>
<li><code>SELECT order_id FROM t_order GROUP BY order_id DESC</code> ç­‰ä»·äº <code>SELECT order_id FROM t_order GROUP BY order_id ORDER BY order_id DESC</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‹¼æ¥ OrderByToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLæ„å»ºå™¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendOrderByToken</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder)</span> </span>&#123;</div><div class="line">   SelectStatement selectStatement = (SelectStatement) sqlStatement;</div><div class="line">   <span class="comment">// æ‹¼æ¥ OrderByToken</span></div><div class="line">   StringBuilder orderByLiterals = <span class="keyword">new</span> StringBuilder(<span class="string">" ORDER BY "</span>);</div><div class="line">   <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (OrderItem each : selectStatement.getOrderByItems()) &#123;</div><div class="line">       <span class="keyword">if</span> (<span class="number">0</span> == i) &#123;</div><div class="line">           orderByLiterals.append(each.getColumnLabel()).append(<span class="string">" "</span>).append(each.getType().name());</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           orderByLiterals.append(<span class="string">","</span>).append(each.getColumnLabel()).append(<span class="string">" "</span>).append(each.getType().name());</div><div class="line">       &#125;</div><div class="line">       i++;</div><div class="line">   &#125;</div><div class="line">   orderByLiterals.append(<span class="string">" "</span>);</div><div class="line">   sqlBuilder.appendLiterals(orderByLiterals.toString());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å½“ SQL ä¸º <code>SELECT order_id FROM t_order o GROUP BY order_id</code> è¿”å›ç»“æœï¼š<br>  <img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/08.png" alt=""></li>
</ul>
<h2 id="3-6-GeneratedKeyToken"><a href="#3-6-GeneratedKeyToken" class="headerlink" title="3.6 GeneratedKeyToken"></a>3.6 GeneratedKeyToken</h2><p>å‰ç½®é˜…è¯»ï¼š<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-4/?mp">ã€ŠSQL è§£æï¼ˆå››ï¼‰ä¹‹æ’å…¥SQLã€‹</a></p>
<p>GeneratedKeyTokenï¼Œå’Œå…¶å®ƒ SQLToken ä¸åŒï¼Œåœ¨ <strong>SQLè§£æ</strong> å®Œè¿›è¡Œå¤„ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLStatement <span class="title">parse</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> <span class="keyword">int</span> parametersSize)</span> </span>&#123;</div><div class="line">   SQLParsingEngine parsingEngine = <span class="keyword">new</span> SQLParsingEngine(databaseType, logicSQL, shardingRule);</div><div class="line">   Context context = MetricsContext.start(<span class="string">"Parse SQL"</span>);</div><div class="line">   SQLStatement result = parsingEngine.parse();</div><div class="line">   <span class="keyword">if</span> (result <span class="keyword">instanceof</span> InsertStatement) &#123; <span class="comment">// å¤„ç† GenerateKeyToken</span></div><div class="line">       ((InsertStatement) result).appendGenerateKeyToken(shardingRule, parametersSize);</div><div class="line">   &#125;</div><div class="line">   MetricsContext.stop(context);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// InsertStatement.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è¿½åŠ è‡ªå¢ä¸»é”®æ ‡è®°å¯¹è±¡.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingRule åˆ†ç‰‡è§„åˆ™</div><div class="line">* <span class="doctag">@param</span> parametersSize å‚æ•°ä¸ªæ•°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendGenerateKeyToken</span><span class="params">(<span class="keyword">final</span> ShardingRule shardingRule, <span class="keyword">final</span> <span class="keyword">int</span> parametersSize)</span> </span>&#123;</div><div class="line">   <span class="comment">// SQL é‡Œæœ‰ä¸»é”®åˆ—</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != generatedKey) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// TableRule å­˜åœ¨</span></div><div class="line">   Optional&lt;TableRule&gt; tableRule = shardingRule.tryFindTableRule(getTables().getSingleTableName());</div><div class="line">   <span class="keyword">if</span> (!tableRule.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// GeneratedKeyToken å­˜åœ¨</span></div><div class="line">   Optional&lt;GeneratedKeyToken&gt; generatedKeysToken = findGeneratedKeyToken();</div><div class="line">   <span class="keyword">if</span> (!generatedKeysToken.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å¤„ç† GenerateKeyToken</span></div><div class="line">   ItemsToken valuesToken = <span class="keyword">new</span> ItemsToken(generatedKeysToken.get().getBeginPosition());</div><div class="line">   <span class="keyword">if</span> (<span class="number">0</span> == parametersSize) &#123;</div><div class="line">       appendGenerateKeyToken(shardingRule, tableRule.get(), valuesToken);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       appendGenerateKeyToken(shardingRule, tableRule.get(), valuesToken, parametersSize);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç§»é™¤ generatedKeysToken</span></div><div class="line">   getSqlTokens().remove(generatedKeysToken.get());</div><div class="line">   <span class="comment">// æ–°å¢ ItemsToken</span></div><div class="line">   getSqlTokens().add(valuesToken);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ ¹æ®<strong>å ä½ç¬¦å‚æ•°</strong>æ•°é‡ä¸åŒï¼Œè°ƒç”¨çš„ <code>#appendGenerateKeyToken()</code> æ˜¯<strong>ä¸åŒ</strong>çš„ï¼š</li>
<li><strong>å ä½ç¬¦å‚æ•°æ•°é‡ = 0</strong> æ—¶ï¼Œç›´æ¥ç”Ÿæˆ<strong>åˆ†å¸ƒå¼ä¸»é”®</strong>ï¼Œä¿æŒæ— å ä½ç¬¦çš„åšæ³•ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// InsertStatement.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendGenerateKeyToken</span><span class="params">(<span class="keyword">final</span> ShardingRule shardingRule, <span class="keyword">final</span> TableRule tableRule, <span class="keyword">final</span> ItemsToken valuesToken)</span> </span>&#123;</div><div class="line">   <span class="comment">// ç”Ÿæˆåˆ†å¸ƒå¼ä¸»é”®</span></div><div class="line">   Number generatedKey = shardingRule.generateKey(tableRule.getLogicTable());</div><div class="line">   <span class="comment">// æ·»åŠ åˆ° ItemsToken</span></div><div class="line">   valuesToken.getItems().add(generatedKey.toString());</div><div class="line">   <span class="comment">// å¢åŠ  Conditionï¼Œç”¨äºè·¯ç”±</span></div><div class="line">   getConditions().add(<span class="keyword">new</span> Condition(<span class="keyword">new</span> Column(tableRule.getGenerateKeyColumn(), tableRule.getLogicTable()), <span class="keyword">new</span> SQLNumberExpression(generatedKey)), shardingRule);</div><div class="line">   <span class="comment">// ç”Ÿæˆ GeneratedKey</span></div><div class="line">   <span class="keyword">this</span>.generatedKey = <span class="keyword">new</span> GeneratedKey(tableRule.getLogicTable(), -<span class="number">1</span>, generatedKey);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>å ä½ç¬¦å‚æ•°æ•°é‡ &gt; 0</strong> æ—¶ï¼Œç”Ÿæˆè‡ªå¢åˆ—çš„å ä½ç¬¦ï¼Œä¿æŒæœ‰å ä½ç¬¦çš„åšæ³•ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendGenerateKeyToken</span><span class="params">(<span class="keyword">final</span> ShardingRule shardingRule, <span class="keyword">final</span> TableRule tableRule, <span class="keyword">final</span> ItemsToken valuesToken, <span class="keyword">final</span> <span class="keyword">int</span> parametersSize)</span> </span>&#123;</div><div class="line">   <span class="comment">// ç”Ÿæˆå ä½ç¬¦</span></div><div class="line">   valuesToken.getItems().add(<span class="string">"?"</span>);</div><div class="line">   <span class="comment">// å¢åŠ  Conditionï¼Œç”¨äºè·¯ç”±</span></div><div class="line">   getConditions().add(<span class="keyword">new</span> Condition(<span class="keyword">new</span> Column(tableRule.getGenerateKeyColumn(), tableRule.getLogicTable()), <span class="keyword">new</span> SQLPlaceholderExpression(parametersSize)), shardingRule);</div><div class="line">   <span class="comment">// ç”Ÿæˆ GeneratedKey</span></div><div class="line">   generatedKey = <span class="keyword">new</span> GeneratedKey(tableRule.getGenerateKeyColumn(), parametersSize, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å› ä¸º GenerateKeyToken å·²ç»å¤„ç†å®Œï¼Œæ‰€ä»¥ç§»é™¤ï¼Œé¿å… <code>SQLRewriteEngine#rewrite()</code> äºŒæ¬¡æ”¹å†™ã€‚å¦å¤–ï¼Œé€šè¿‡ ItemsToken è¡¥å……è‡ªå¢åˆ—ã€‚</li>
<li>ç”Ÿæˆ GeneratedKey ä¼šåœ¨ ParsingSQLRouter è¿›ä¸€æ­¥å¤„ç†ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLRouteResult <span class="title">route</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   <span class="keyword">final</span> Context context = MetricsContext.start(<span class="string">"Route SQL"</span>);</div><div class="line">   SQLRouteResult result = <span class="keyword">new</span> SQLRouteResult(sqlStatement);</div><div class="line">   <span class="comment">// å¤„ç† æ’å…¥SQL ä¸»é”®å­—æ®µ</span></div><div class="line">   <span class="keyword">if</span> (sqlStatement <span class="keyword">instanceof</span> InsertStatement &amp;&amp; <span class="keyword">null</span> != ((InsertStatement) sqlStatement).getGeneratedKey()) &#123;</div><div class="line">       processGeneratedKey(parameters, (InsertStatement) sqlStatement, result);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">&#125;  </div><div class="line"><span class="comment">/**</span></div><div class="line">* å¤„ç† æ’å…¥SQL ä¸»é”®å­—æ®µ</div><div class="line">* å½“ ä¸»é”®ç¼–å· æœªç”Ÿæˆæ—¶ï¼Œ&#123;<span class="doctag">@link</span> ShardingRule#generateKey(String)&#125; è¿›è¡Œç”Ÿæˆ</div><div class="line">* <span class="doctag">@param</span> parameters å ä½ç¬¦å‚æ•°</div><div class="line">* <span class="doctag">@param</span> insertStatement Insert SQLè¯­å¥å¯¹è±¡</div><div class="line">* <span class="doctag">@param</span> sqlRouteResult SQLè·¯ç”±ç»“æœ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processGeneratedKey</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> InsertStatement insertStatement, <span class="keyword">final</span> SQLRouteResult sqlRouteResult)</span> </span>&#123;</div><div class="line">   GeneratedKey generatedKey = insertStatement.getGeneratedKey();</div><div class="line">   <span class="keyword">if</span> (parameters.isEmpty()) &#123; <span class="comment">// å·²æœ‰ä¸»é”®ï¼Œæ— å ä½ç¬¦ï¼ŒINSERT INTO t_order(order_id, user_id) VALUES (1, 100);</span></div><div class="line">       sqlRouteResult.getGeneratedKeys().add(generatedKey.getValue());</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parameters.size() == generatedKey.getIndex()) &#123; <span class="comment">// ä¸»é”®å­—æ®µä¸å­˜åœ¨å­˜åœ¨ï¼ŒINSERT INTO t_order(user_id) VALUES(?);</span></div><div class="line">       Number key = shardingRule.generateKey(insertStatement.getTables().getSingleTableName()); <span class="comment">// ç”Ÿæˆä¸»é”®ç¼–å·</span></div><div class="line">       parameters.add(key);</div><div class="line">       setGeneratedKeys(sqlRouteResult, key);</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (-<span class="number">1</span> != generatedKey.getIndex()) &#123; <span class="comment">// ä¸»é”®å­—æ®µå­˜åœ¨ï¼ŒINSERT INTO t_order(order_id, user_id) VALUES(?, ?);</span></div><div class="line">       setGeneratedKeys(sqlRouteResult, (Number) parameters.get(generatedKey.getIndex()));</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¾ç½® ä¸»é”®ç¼–å· åˆ° SQLè·¯ç”±ç»“æœ</div><div class="line">* <span class="doctag">@param</span> sqlRouteResult SQLè·¯ç”±ç»“æœ</div><div class="line">* <span class="doctag">@param</span> generatedKey ä¸»é”®ç¼–å·</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setGeneratedKeys</span><span class="params">(<span class="keyword">final</span> SQLRouteResult sqlRouteResult, <span class="keyword">final</span> Number generatedKey)</span> </span>&#123;</div><div class="line">   generatedKeys.add(generatedKey);</div><div class="line">   sqlRouteResult.getGeneratedKeys().clear();</div><div class="line">   sqlRouteResult.getGeneratedKeys().addAll(generatedKeys);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>parameters.size() == generatedKey.getIndex()</code> å¤„å¯¹åº” <code>#appendGenerateKeyToken()</code> çš„ <strong>å ä½ç¬¦å‚æ•°æ•°é‡ &gt; 0</strong> æƒ…å†µï¼Œæ­¤æ—¶ä¼šç”Ÿæˆ<strong>åˆ†å¸ƒå¼ä¸»é”®</strong>ã€‚ğŸ˜ˆ è¯¥å¤„æ˜¯ä¸æ˜¯å¯ä»¥è€ƒè™‘æŠŠç”Ÿæˆ<strong>åˆ†å¸ƒå¼ä¸»é”®</strong>æŒªåˆ° <code>#appendGenerateKeyToken()</code>ï¼Œè¿™æ ·æ›´åŠ ç»Ÿä¸€ä¸€äº›ã€‚</li>
</ul>
<h1 id="4-SQL-ç”Ÿæˆ"><a href="#4-SQL-ç”Ÿæˆ" class="headerlink" title="4. SQL ç”Ÿæˆ"></a>4. SQL ç”Ÿæˆ</h1><p><strong>SQLè·¯ç”±</strong>å®Œåï¼Œä¼šç”Ÿæˆå„æ•°æ®åˆ†ç‰‡çš„<strong>æ‰§è¡ŒSQL</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLRouteResult <span class="title">route</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   SQLRouteResult result = <span class="keyword">new</span> SQLRouteResult(sqlStatement);</div><div class="line">   <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç ... å¤„ç† æ’å…¥SQL ä¸»é”®å­—æ®µ</span></div><div class="line">   </div><div class="line">   <span class="comment">// è·¯ç”±</span></div><div class="line">   RoutingResult routingResult = route(parameters, sqlStatement);</div><div class="line">   </div><div class="line">   <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç ... SQLé‡å†™å¼•æ“</span></div><div class="line">   SQLRewriteEngine rewriteEngine = <span class="keyword">new</span> SQLRewriteEngine(shardingRule, logicSQL, sqlStatement);</div><div class="line">   <span class="keyword">boolean</span> isSingleRouting = routingResult.isSingleRouting();</div><div class="line">   <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç ... å¤„ç†åˆ†é¡µ</span></div><div class="line">   <span class="comment">// SQL é‡å†™</span></div><div class="line">   SQLBuilder sqlBuilder = rewriteEngine.rewrite(!isSingleRouting);</div><div class="line">   <span class="comment">// ç”Ÿæˆ ExecutionUnit</span></div><div class="line">   <span class="keyword">if</span> (routingResult <span class="keyword">instanceof</span> CartesianRoutingResult) &#123;</div><div class="line">       <span class="keyword">for</span> (CartesianDataSource cartesianDataSource : ((CartesianRoutingResult) routingResult).getRoutingDataSources()) &#123;</div><div class="line">           <span class="keyword">for</span> (CartesianTableReference cartesianTableReference : cartesianDataSource.getRoutingTableReferences()) &#123;</div><div class="line">               <span class="comment">// ğŸ‘¼ ç”Ÿæˆ SQL</span></div><div class="line">               result.getExecutionUnits().add(<span class="keyword">new</span> SQLExecutionUnit(cartesianDataSource.getDataSource(), rewriteEngine.generateSQL(cartesianTableReference, sqlBuilder)));</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">for</span> (TableUnit each : routingResult.getTableUnits().getTableUnits()) &#123;</div><div class="line">           <span class="comment">// ğŸ‘¼ ç”Ÿæˆ SQL</span></div><div class="line">           result.getExecutionUnits().add(<span class="keyword">new</span> SQLExecutionUnit(each.getDataSourceName(), rewriteEngine.generateSQL(each, sqlBuilder)));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>RewriteEngine#generateSQL()</code> ç”Ÿæˆ<strong>æ‰§è¡ŒSQL</strong>ã€‚å¯¹äºç¬›å¡å°”ç§¯è·¯ç”±ç»“æœå’Œç®€å•è·¯ç”±ç»“æœä¼ é€’çš„å‚æ•°ç•¥æœ‰ä¸åŒï¼šå‰è€…ä½¿ç”¨ CartesianDataSource ( CartesianTableReference )ï¼Œåè€…ä½¿ç”¨è·¯ç”±è¡¨å•å…ƒ ( TableUnit )ã€‚å¯¹è·¯ç”±ç»“æœä¸æ˜¯å¾ˆäº†è§£çš„åŒå­¦ï¼Œå»ºè®®çœ‹ä¸‹ <a href="http://www.yunai.me/Sharding-JDBC/sql-route-2/?mp">ã€ŠSQL è·¯ç”±ï¼ˆäºŒï¼‰ä¹‹åˆ†åº“åˆ†è¡¨è·¯ç”±ã€‹</a>ã€‚</li>
</ul>
<p><code>RewriteEngine#generateSQL()</code> å¯¹äºç¬›å¡å°”ç§¯è·¯ç”±ç»“æœå’Œç®€å•è·¯ç”±ç»“æœä¸¤ç§æƒ…å†µï¼Œå¤„ç†ä¸Šå¤§ä½“æ˜¯ä¸€è‡´çš„ï¼š1. è·å¾— SQL ç›¸å…³<strong>é€»è¾‘è¡¨</strong>å¯¹åº”çš„<strong>çœŸå®è¡¨</strong>æ˜ å°„ï¼Œ2. æ ¹æ®æ˜ å°„æ”¹å†™ SQL ç›¸å…³<strong>é€»è¾‘è¡¨</strong>ä¸º<strong>çœŸå®è¡¨</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ç”ŸæˆSQLè¯­å¥.</div><div class="line">* <span class="doctag">@param</span> tableUnit è·¯ç”±è¡¨å•å…ƒ</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLæ„å»ºå™¨</div><div class="line">* <span class="doctag">@return</span> SQLè¯­å¥</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">generateSQL</span><span class="params">(<span class="keyword">final</span> TableUnit tableUnit, <span class="keyword">final</span> SQLBuilder sqlBuilder)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> sqlBuilder.toSQL(getTableTokens(tableUnit));</div><div class="line">&#125;  </div><div class="line"><span class="comment">/**</span></div><div class="line">* ç”ŸæˆSQLè¯­å¥.</div><div class="line">* <span class="doctag">@param</span> cartesianTableReference ç¬›å¡å°”ç§¯è·¯ç”±è¡¨å•å…ƒ</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLæ„å»ºå™¨</div><div class="line">* <span class="doctag">@return</span> SQLè¯­å¥</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">generateSQL</span><span class="params">(<span class="keyword">final</span> CartesianTableReference cartesianTableReference, <span class="keyword">final</span> SQLBuilder sqlBuilder)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> sqlBuilder.toSQL(getTableTokens(cartesianTableReference));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">// SQLBuilder.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ç”ŸæˆSQLè¯­å¥.</div><div class="line">* <span class="doctag">@param</span> tableTokens å ä½ç¬¦é›†åˆï¼ˆé€»è¾‘è¡¨ä¸çœŸå®è¡¨æ˜ å°„ï¼‰</div><div class="line">* <span class="doctag">@return</span> SQLè¯­å¥</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toSQL</span><span class="params">(<span class="keyword">final</span> Map&lt;String, String&gt; tableTokens)</span> </span>&#123;</div><div class="line">   StringBuilder result = <span class="keyword">new</span> StringBuilder();</div><div class="line">   <span class="keyword">for</span> (Object each : segments) &#123;</div><div class="line">       <span class="keyword">if</span> (each <span class="keyword">instanceof</span> TableToken &amp;&amp; tableTokens.containsKey(((TableToken) each).tableName)) &#123;</div><div class="line">           result.append(tableTokens.get(((TableToken) each).tableName));</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           result.append(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#toSQL()</code> ç»“æœå¦‚å›¾ï¼š <img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/09.png" alt=""><br>ğŸ˜œ å¯¹ <strong>SQLæ”¹å†™</strong> æ˜¯ä¸æ˜¯æ¸…æ™°å¾ˆå¤šäº†ã€‚</li>
</ul>
<hr>
<p>ä¸‹é¢æˆ‘ä»¬ä»¥<strong>ç¬›å¡å°”ç§¯è·¯ç”±ç»“æœ</strong>è·å¾— SQL ç›¸å…³<strong>é€»è¾‘è¡¨</strong>å¯¹åº”çš„<strong>çœŸå®è¡¨</strong>æ˜ å°„ä¸ºä¾‹å­(<em>ç®€å•è·¯ç”±ç»“æœåŸºæœ¬ç±»ä¼¼è€Œä¸”ç®€å•</em>)ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—ï¼ˆç¬›å¡å°”ç§¯è¡¨è·¯ç”±ç»„é‡Œçš„è·¯ç”±è¡¨å•å…ƒé€»è¾‘è¡¨ å’Œ ä¸å…¶äº’ä¸ºBindingTableå…³ç³»çš„é€»è¾‘è¡¨ï¼‰å¯¹åº”çš„çœŸå®è¡¨æ˜ å°„ï¼ˆé€»è¾‘è¡¨éœ€è¦åœ¨ SQL ä¸­å­˜åœ¨ï¼‰</div><div class="line">* <span class="doctag">@param</span> cartesianTableReference ç¬›å¡å°”ç§¯è¡¨è·¯ç”±ç»„</div><div class="line">* <span class="doctag">@return</span> é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">getTableTokens</span><span class="params">(<span class="keyword">final</span> CartesianTableReference cartesianTableReference)</span> </span>&#123;</div><div class="line">   Map&lt;String, String&gt; tableTokens = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (TableUnit each : cartesianTableReference.getTableUnits()) &#123;</div><div class="line">       tableTokens.put(each.getLogicTableName(), each.getActualTableName());</div><div class="line">       <span class="comment">// æŸ¥æ‰¾ BindingTableRule</span></div><div class="line">       Optional&lt;BindingTableRule&gt; bindingTableRule = shardingRule.findBindingTableRule(each.getLogicTableName());</div><div class="line">       <span class="keyword">if</span> (bindingTableRule.isPresent()) &#123;</div><div class="line">           tableTokens.putAll(getBindingTableTokens(each, bindingTableRule.get()));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> tableTokens;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾— BindingTable å…³ç³»çš„é€»è¾‘è¡¨å¯¹åº”çš„çœŸå®è¡¨æ˜ å°„ï¼ˆé€»è¾‘è¡¨éœ€è¦åœ¨ SQL ä¸­å­˜åœ¨ï¼‰</div><div class="line">* <span class="doctag">@param</span> tableUnit è·¯ç”±å•å…ƒ</div><div class="line">* <span class="doctag">@param</span> bindingTableRule Bindingè¡¨è§„åˆ™é…ç½®å¯¹è±¡</div><div class="line">* <span class="doctag">@return</span> æ˜ å°„</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">getBindingTableTokens</span><span class="params">(<span class="keyword">final</span> TableUnit tableUnit, <span class="keyword">final</span> BindingTableRule bindingTableRule)</span> </span>&#123;</div><div class="line">   Map&lt;String, String&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (String eachTable : sqlStatement.getTables().getTableNames()) &#123;</div><div class="line">       <span class="keyword">if</span> (!eachTable.equalsIgnoreCase(tableUnit.getLogicTableName()) &amp;&amp; bindingTableRule.hasLogicTable(eachTable)) &#123;</div><div class="line">           result.put(eachTable, bindingTableRule.getBindingActualTable(tableUnit.getDataSourceName(), eachTable, tableUnit.getActualTableName()));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ç¬›å¡å°”ç§¯è¡¨è·¯ç”±ç»„( CartesianTableReference )åŒ…å«<strong>å¤šä¸ª</strong>è·¯ç”±è¡¨å•å…ƒ( TableUnit )ã€‚æ¯ä¸ªè·¯ç”±è¡¨å•å…ƒéœ€è¦éå†ã€‚</li>
<li>è·¯ç”±è¡¨å•å…ƒæœ¬èº«åŒ…å«é€»è¾‘è¡¨å’ŒçœŸå®è¡¨ï¼Œç›´æ¥æ·»åŠ åˆ°æ˜ å°„å³å¯ã€‚</li>
<li>äº’ä¸º BindingTable å…³ç³»çš„è¡¨åªè®¡ç®—ä¸€æ¬¡è·¯ç”±åˆ†ç‰‡ï¼Œå› æ­¤<strong>æœªè®¡ç®—</strong>çš„çœŸå®è¡¨éœ€è¦ä»¥å…¶å¯¹åº”çš„<strong>å·²è®¡ç®—</strong>çš„çœŸå®è¡¨å»æŸ¥æ‰¾ï¼Œå³ <code>bindingTableRule.getBindingActualTable(tableUnit.getDataSourceName(), eachTable, tableUnit.getActualTableName())</code> å¤„é€»è¾‘ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// BindingTableRule.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ ¹æ®å…¶ä»–Bindingè¡¨çœŸå®è¡¨åç§°è·å–ç›¸åº”çš„çœŸå®Bindingè¡¨åç§°.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> dataSource æ•°æ®æºåç§°</div><div class="line">* <span class="doctag">@param</span> logicTable é€»è¾‘è¡¨åç§°</div><div class="line">* <span class="doctag">@param</span> otherActualTable å…¶ä»–çœŸå®Bindingè¡¨åç§°</div><div class="line">* <span class="doctag">@return</span> çœŸå®Bindingè¡¨åç§°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getBindingActualTable</span><span class="params">(<span class="keyword">final</span> String dataSource, <span class="keyword">final</span> String logicTable, <span class="keyword">final</span> String otherActualTable)</span> </span>&#123;</div><div class="line">   <span class="comment">// è®¡ç®— otherActualTable åœ¨å…¶ TableRule çš„ actualTable æ˜¯ç¬¬å‡ ä¸ª</span></div><div class="line">   <span class="keyword">int</span> index = -<span class="number">1</span>;</div><div class="line">   <span class="keyword">for</span> (TableRule each : tableRules) &#123;</div><div class="line">       <span class="keyword">if</span> (each.isDynamic()) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Dynamic table cannot support Binding table."</span>);</div><div class="line">       &#125;</div><div class="line">       index = each.findActualTableIndex(dataSource, otherActualTable);</div><div class="line">       <span class="keyword">if</span> (-<span class="number">1</span> != index) &#123;</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   Preconditions.checkState(-<span class="number">1</span> != index, String.format(<span class="string">"Actual table [%s].[%s] is not in table config"</span>, dataSource, otherActualTable));</div><div class="line">   <span class="comment">// è®¡ç®— logicTable åœ¨å…¶ TableRule çš„ ç¬¬index çš„ çœŸå®è¡¨</span></div><div class="line">   <span class="keyword">for</span> (TableRule each : tableRules) &#123;</div><div class="line">       <span class="keyword">if</span> (each.getLogicTable().equalsIgnoreCase(logicTable)) &#123;</div><div class="line">           <span class="keyword">return</span> each.getActualTables().get(index).getTableName();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(String.format(<span class="string">"Cannot find binding actual table, data source: %s, logic table: %s, other actual table: %s"</span>, dataSource, logicTable, otherActualTable));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯èƒ½çœ‹èµ·æ¥æœ‰äº›ç»•ï¼Œæˆ‘ä»¬çœ‹å¼ å›¾ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/10.png" alt=""></p>
<p><strong>å‹æƒ…æç¤º</strong>ï¼šè¿™é‡Œä¸å«Œå•°å—¦åœ¨æä¸€å¥ï¼Œäº’ä¸º BindingTable çš„è¡¨ï¼Œé…ç½® TableRule æ—¶ï¼Œ<code>actualTables</code> æ•°é‡ä¸€å®šè¦ä¸€è‡´ï¼Œå¦åˆ™å¤šå‡ºæ¥çš„è¡¨ï¼Œå¯èƒ½ä¼šæ— æ³•è¢«è·¯ç”±åˆ°ã€‚</p>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å“ˆå“ˆå“ˆï¼Œçœ‹å®Œ<strong>SQLæ”¹å†™</strong>åï¼Œ<strong>SQLè§£æ</strong>æ˜¯ä¸æ˜¯æ¸…æ™°å¤šäº†ï¼å˜¿å˜¿å˜¿ï¼Œåæ­£æˆ‘ç°åœ¨æœ‰ç‚¹å—¨ã€‚æ©ï¼Œè›®å—¨çš„ã€‚</p>
<p>å½“ç„¶ï¼Œå¦‚æœ<strong>SQLè§£æ</strong>ç†è§£ä¸Šæœ‰ç‚¹ç–‘æƒ‘çš„ä½ ï¼Œ<strong>æ¬¢è¿</strong>åŠ æˆ‘çš„å¾®ä¿¡ï¼Œå’± <strong>1å¯¹1</strong> æåŸºã€‚å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ï¼š<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</a> å³å¯è·å¾—ã€‚</p>
<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<p>é“å‹ï¼Œè½¬å‘ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>
<p>Letâ€™s Go! <a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šåˆ†å¸ƒå¼ä¸»é”®ã€‹</a>ã€<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL æ‰§è¡Œã€‹</a>ã€<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šç»“æœèšåˆã€‹</a> ç»§ç»­ã€‚</p>
<p><em>æ„Ÿè°¢æŠ€æœ¯ç‰›é€¼å¦‚ä½ è€å¿ƒçš„é˜…è¯»æœ¬æ–‡ã€‚</em></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/stron
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±ï¼ˆä¸‰ï¼‰ä¹‹Springä¸YAMLé…ç½®</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-route-3/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-route-3/</id>
    <published>2017-08-07T16:00:00.000Z</published>
    <updated>2017-08-02T08:27:19.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<p>æŠ±æ­‰ï¼Œç«™å‘æ–‡ã€‚è¿‘æœŸçœ‹æƒ…å†µæ›´æ–°ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/stron
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±ï¼ˆäºŒï¼‰ä¹‹åˆ†åº“åˆ†è¡¨è·¯ç”±</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-route-2/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-route-2/</id>
    <published>2017-08-05T16:00:00.000Z</published>
    <updated>2017-08-02T09:39:24.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. SQLRouteResult</a></li>
<li><a href="#">3. è·¯ç”±ç­–ç•¥ x ç®—æ³•</a></li>
<li><a href="#">4. SQL è·¯ç”±</a></li>
<li><a href="#">5. DatabaseHintSQLRouter</a></li>
<li><a href="#">6. ParsingSQLRouter</a><ul>
<li><a href="#">6.1 SimpleRoutingEngine</a></li>
<li><a href="#">6.2 ComplexRoutingEngine</a></li>
<li><a href="#">6.3 CartesianRoutingEngine</a></li>
<li><a href="#">6.3 ParsingSQLRouter ä¸»#route()</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº«åˆ†è¡¨åˆ†åº“<strong>è·¯ç”±</strong>ç›¸å…³çš„å®ç°ã€‚æ¶‰åŠå†…å®¹å¦‚ä¸‹ï¼š</p>
<ol>
<li>SQL è·¯ç”±ç»“æœ</li>
<li>è·¯ç”±ç­–ç•¥ x ç®—æ³•</li>
<li>SQL è·¯ç”±å™¨</li>
</ol>
<p>å†…å®¹é¡ºåºå¦‚ç¼–å·ã€‚</p>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<p>SQL è·¯ç”±å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/06.png" alt=""></p>
<h1 id="2-SQLRouteResult"><a href="#2-SQLRouteResult" class="headerlink" title="2. SQLRouteResult"></a>2. SQLRouteResult</h1><p>ç»è¿‡ <strong>SQLè§£æ</strong>ã€<strong>SQLè·¯ç”±</strong>åï¼Œäº§ç”Ÿ<strong>SQLè·¯ç”±ç»“æœ</strong>ï¼Œå³ SQLRouteResultã€‚æ ¹æ®è·¯ç”±ç»“æœï¼Œ<strong>ç”ŸæˆSQL</strong>ï¼Œ<strong>æ‰§è¡ŒSQL</strong>ã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/01.png" alt=""></p>
<ul>
<li><code>sqlStatement</code> ï¼šSQLè¯­å¥å¯¹è±¡ï¼Œç»è¿‡<strong>SQLè§£æ</strong>çš„ç»“æœå¯¹è±¡ã€‚</li>
<li><code>executionUnits</code> ï¼šSQLæœ€å°æ‰§è¡Œå•å…ƒé›†åˆã€‚<strong>SQLæ‰§è¡Œ</strong>æ—¶ï¼Œæ‰§è¡Œæ¯ä¸ªå•å…ƒã€‚</li>
<li><code>generatedKeys</code> ï¼š<strong>æ’å…¥</strong>SQLè¯­å¥ç”Ÿæˆçš„ä¸»é”®ç¼–å·é›†åˆã€‚ç›®å‰ä¸æ”¯æŒæ‰¹é‡æ’å…¥è€Œä½¿ç”¨é›†åˆçš„åŸå› ï¼ŒçŒœæµ‹æ˜¯ä¸ºäº†æœªæ¥æ”¯æŒæ‰¹é‡æ’å…¥åšå‡†å¤‡ã€‚</li>
</ul>
<h1 id="3-è·¯ç”±ç­–ç•¥-x-ç®—æ³•"><a href="#3-è·¯ç”±ç­–ç•¥-x-ç®—æ³•" class="headerlink" title="3. è·¯ç”±ç­–ç•¥ x ç®—æ³•"></a>3. è·¯ç”±ç­–ç•¥ x ç®—æ³•</h1><p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_04/04.png" alt=""></p>
<p>ShardingStrategyï¼Œåˆ†ç‰‡ç­–ç•¥ã€‚ç›®å‰æ”¯æŒä¸¤ç§åˆ†ç‰‡ï¼š  </p>
<p><em>åˆ†ç‰‡èµ„æºï¼šåœ¨åˆ†åº“ç­–ç•¥é‡ŒæŒ‡çš„æ˜¯åº“ï¼Œåœ¨åˆ†è¡¨ç­–ç•¥é‡ŒæŒ‡çš„æ˜¯è¡¨ã€‚</em>  </p>
<p>ã€1ã€‘ è®¡ç®—<strong>é™æ€</strong>åˆ†ç‰‡ï¼ˆå¸¸ç”¨ï¼‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingStrategy.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¡ç®—é™æ€åˆ†ç‰‡.</div><div class="line">* <span class="doctag">@param</span> sqlType SQLè¯­å¥çš„ç±»å‹</div><div class="line">* <span class="doctag">@param</span> availableTargetNames æ‰€æœ‰çš„å¯ç”¨åˆ†ç‰‡èµ„æºé›†åˆ</div><div class="line">* <span class="doctag">@param</span> shardingValues åˆ†ç‰‡å€¼é›†åˆ</div><div class="line">* <span class="doctag">@return</span> åˆ†åº“åæŒ‡å‘çš„æ•°æ®æºåç§°é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doStaticSharding</span><span class="params">(<span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> Collection&lt;ShardingValue&lt;?&gt;&gt; shardingValues)</span> </span>&#123;</div><div class="line">   Collection&lt;String&gt; result = <span class="keyword">new</span> TreeSet&lt;&gt;(String.CASE_INSENSITIVE_ORDER);</div><div class="line">   <span class="keyword">if</span> (shardingValues.isEmpty()) &#123;</div><div class="line">       Preconditions.checkState(!isInsertMultiple(sqlType, availableTargetNames), <span class="string">"INSERT statement should contain sharding value."</span>); <span class="comment">// æ’å…¥ä¸èƒ½æœ‰å¤šèµ„æºå¯¹è±¡</span></div><div class="line">       result.addAll(availableTargetNames);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       result.addAll(doSharding(shardingValues, availableTargetNames));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* æ’å…¥SQL æ˜¯å¦æ’å…¥å¤šä¸ªåˆ†ç‰‡</div><div class="line">* <span class="doctag">@param</span> sqlType SQLç±»å‹</div><div class="line">* <span class="doctag">@param</span> availableTargetNames æ‰€æœ‰çš„å¯ç”¨åˆ†ç‰‡èµ„æºé›†åˆ</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isInsertMultiple</span><span class="params">(<span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> SQLType.INSERT == sqlType &amp;&amp; availableTargetNames.size() &gt; <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ’å…¥SQL éœ€è¦æœ‰ç‰‡é”®å€¼ï¼Œå¦åˆ™æ— æ³•åˆ¤æ–­å•ä¸ªåˆ†ç‰‡èµ„æºã€‚<em>ï¼ˆSharding-JDBC ç›®å‰ä»…æ”¯æŒå•æ¡è®°å½•æ’å…¥ï¼‰</em></li>
</ul>
<p>ã€2ã€‘è®¡ç®—<strong>åŠ¨æ€</strong>åˆ†ç‰‡</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingStrategy.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¡ç®—åŠ¨æ€åˆ†ç‰‡.</div><div class="line">* <span class="doctag">@param</span> shardingValues åˆ†ç‰‡å€¼é›†åˆ</div><div class="line">* <span class="doctag">@return</span> åˆ†åº“åæŒ‡å‘çš„åˆ†ç‰‡èµ„æºé›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doDynamicSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;ShardingValue&lt;?&gt;&gt; shardingValues)</span> </span>&#123;</div><div class="line">   Preconditions.checkState(!shardingValues.isEmpty(), <span class="string">"Dynamic table should contain sharding value."</span>); <span class="comment">// åŠ¨æ€åˆ†ç‰‡å¿…é¡»æœ‰åˆ†ç‰‡å€¼</span></div><div class="line">   Collection&lt;String&gt; availableTargetNames = Collections.emptyList();</div><div class="line">   Collection&lt;String&gt; result = <span class="keyword">new</span> TreeSet&lt;&gt;(String.CASE_INSENSITIVE_ORDER);</div><div class="line">   result.addAll(doSharding(shardingValues, availableTargetNames));</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>åŠ¨æ€åˆ†ç‰‡å¯¹åº” <code>TableRule.dynamic=true</code></li>
<li>åŠ¨æ€åˆ†ç‰‡å¿…é¡»æœ‰åˆ†ç‰‡å€¼</li>
</ul>
<p>ğŸ˜ˆ é—·äº†ï¼Œçœ‹èµ·æ¥ä¸¤è€…æ²¡å•¥åŒºåˆ«ï¼Ÿç­”æ¡ˆåœ¨<strong>åˆ†ç‰‡ç®—æ³•</strong>ä¸Šã€‚æˆ‘ä»¬å…ˆçœ‹ <code>#doSharding()</code> æ–¹æ³•çš„å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingStrategy.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¡ç®—åˆ†ç‰‡</div><div class="line">* <span class="doctag">@param</span> shardingValues åˆ†ç‰‡å€¼é›†åˆ</div><div class="line">* <span class="doctag">@param</span> availableTargetNames æ‰€æœ‰çš„å¯ç”¨åˆ†ç‰‡èµ„æºé›†åˆ</div><div class="line">* <span class="doctag">@return</span> åˆ†åº“åæŒ‡å‘çš„åˆ†ç‰‡èµ„æºé›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;String&gt; <span class="title">doSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;ShardingValue&lt;?&gt;&gt; shardingValues, <span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ— ç‰‡é”®</span></div><div class="line">   <span class="keyword">if</span> (shardingAlgorithm <span class="keyword">instanceof</span> NoneKeyShardingAlgorithm) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.singletonList(((NoneKeyShardingAlgorithm) shardingAlgorithm).doSharding(availableTargetNames, shardingValues.iterator().next()));</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å•ç‰‡é”®</span></div><div class="line">   <span class="keyword">if</span> (shardingAlgorithm <span class="keyword">instanceof</span> SingleKeyShardingAlgorithm) &#123;</div><div class="line">       SingleKeyShardingAlgorithm&lt;?&gt; singleKeyShardingAlgorithm = (SingleKeyShardingAlgorithm&lt;?&gt;) shardingAlgorithm;</div><div class="line">       ShardingValue shardingValue = shardingValues.iterator().next();</div><div class="line">       <span class="keyword">switch</span> (shardingValue.getType()) &#123;</div><div class="line">           <span class="keyword">case</span> SINGLE:</div><div class="line">               <span class="keyword">return</span> Collections.singletonList(singleKeyShardingAlgorithm.doEqualSharding(availableTargetNames, shardingValue));</div><div class="line">           <span class="keyword">case</span> LIST:</div><div class="line">               <span class="keyword">return</span> singleKeyShardingAlgorithm.doInSharding(availableTargetNames, shardingValue);</div><div class="line">           <span class="keyword">case</span> RANGE:</div><div class="line">               <span class="keyword">return</span> singleKeyShardingAlgorithm.doBetweenSharding(availableTargetNames, shardingValue);</div><div class="line">           <span class="keyword">default</span>:</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(shardingValue.getType().getClass().getName());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å¤šç‰‡é”®</span></div><div class="line">   <span class="keyword">if</span> (shardingAlgorithm <span class="keyword">instanceof</span> MultipleKeysShardingAlgorithm) &#123;</div><div class="line">       <span class="keyword">return</span> ((MultipleKeysShardingAlgorithm) shardingAlgorithm).doSharding(availableTargetNames, shardingValues);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(shardingAlgorithm.getClass().getName());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ— åˆ†ç‰‡é”®ç®—æ³•ï¼šå¯¹åº” NoneKeyShardingAlgorithm åˆ†ç‰‡ç®—æ³•æ¥å£ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NoneKeyShardingAlgorithm</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;?&gt;&gt; <span class="keyword">extends</span> <span class="title">ShardingAlgorithm</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">doSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, ShardingValue&lt;T&gt; shardingValue)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å•ç‰‡é”®ç®—æ³•ï¼šå¯¹åº” SingleKeyShardingAlgorithm åˆ†ç‰‡ç®—æ³•æ¥å£ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SingleKeyShardingAlgorithm</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;?&gt;&gt; <span class="keyword">extends</span> <span class="title">ShardingAlgorithm</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">doEqualSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, ShardingValue&lt;T&gt; shardingValue)</span></span>;</div><div class="line">    <span class="function">Collection&lt;String&gt; <span class="title">doInSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, ShardingValue&lt;T&gt; shardingValue)</span></span>;</div><div class="line">    <span class="function">Collection&lt;String&gt; <span class="title">doBetweenSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, ShardingValue&lt;T&gt; shardingValue)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left">ShardingValueType</th>
<th style="text-align:left">SQL æ“ä½œç¬¦</th>
<th style="text-align:left">æ¥å£æ–¹æ³•</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">SINGLE</td>
<td style="text-align:left">=</td>
<td style="text-align:left"><code>#doEqualSharding()</code></td>
</tr>
<tr>
<td style="text-align:left">LIST</td>
<td style="text-align:left">IN</td>
<td style="text-align:left"><code>#doInSharding()</code></td>
</tr>
<tr>
<td style="text-align:left">RANGE</td>
<td style="text-align:left">BETWEEN</td>
<td style="text-align:left"><code>#doBetweenSharding()</code></td>
</tr>
</tbody>
</table>
<ul>
<li>å¤šç‰‡é”®ç®—æ³•ï¼šå¯¹åº” MultipleKeysShardingAlgorithm åˆ†ç‰‡ç®—æ³•æ¥å£ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MultipleKeysShardingAlgorithm</span> <span class="keyword">extends</span> <span class="title">ShardingAlgorithm</span> </span>&#123;</div><div class="line">    <span class="function">Collection&lt;String&gt; <span class="title">doSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, Collection&lt;ShardingValue&lt;?&gt;&gt; shardingValues)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ†ç‰‡ç®—æ³•ç±»ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/02.png" alt=""></p>
<p>æ¥çœ‹çœ‹ Sharding-JDBC å®ç°çš„æ— éœ€åˆ†åº“çš„åˆ†ç‰‡ç®—æ³• NoneDatabaseShardingAlgorithm (NoneTableShardingAlgorithm åŸºæœ¬ä¸€æ¨¡ä¸€æ ·)ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NoneDatabaseShardingAlgorithm</span> <span class="keyword">implements</span> <span class="title">SingleKeyDatabaseShardingAlgorithm</span>&lt;<span class="title">String</span>&gt;, <span class="title">MultipleKeysDatabaseShardingAlgorithm</span> </span>&#123; </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> Collection&lt;ShardingValue&lt;?&gt;&gt; shardingValues)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> availableTargetNames;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doEqualSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> ShardingValue&lt;String&gt; shardingValue)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> availableTargetNames.isEmpty() ? <span class="keyword">null</span> : availableTargetNames.iterator().next();</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doInSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> ShardingValue&lt;String&gt; shardingValue)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> availableTargetNames;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doBetweenSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> ShardingValue&lt;String&gt; shardingValue)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> availableTargetNames;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>ä¸€å®šè¦æ³¨æ„ï¼ŒNoneXXXXShardingAlgorithm åªé€‚ç”¨äºæ— åˆ†åº“/è¡¨çš„éœ€æ±‚ï¼Œå¦åˆ™ä¼šæ˜¯é”™è¯¯çš„è·¯ç”±ç»“æœã€‚</strong>ä¾‹å¦‚ï¼Œ<code>#doEqualSharding()</code> è¿”å›çš„æ˜¯ç¬¬ä¸€ä¸ªåˆ†ç‰‡èµ„æºã€‚</li>
</ul>
<hr>
<p>å†æ¥çœ‹æµ‹è¯•ç›®å½•ä¸‹å®ç°çš„<strong>ä½™æ•°åŸºå¶åˆ†è¡¨ç®—æ³•</strong> ModuloTableShardingAlgorithm çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// com.dangdang.ddframe.rdb.integrate.fixture.ModuloTableShardingAlgorithm.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ModuloTableShardingAlgorithm</span> <span class="keyword">implements</span> <span class="title">SingleKeyTableShardingAlgorithm</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doEqualSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; tableNames, <span class="keyword">final</span> ShardingValue&lt;Integer&gt; shardingValue)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (String each : tableNames) &#123;</div><div class="line">            <span class="keyword">if</span> (each.endsWith(shardingValue.getValue() % <span class="number">2</span> + <span class="string">""</span>)) &#123;</div><div class="line">                <span class="keyword">return</span> each;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doInSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; tableNames, <span class="keyword">final</span> ShardingValue&lt;Integer&gt; shardingValue)</span> </span>&#123;</div><div class="line">        Collection&lt;String&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(tableNames.size());</div><div class="line">        <span class="keyword">for</span> (Integer value : shardingValue.getValues()) &#123;</div><div class="line">            <span class="keyword">for</span> (String tableName : tableNames) &#123;</div><div class="line">                <span class="keyword">if</span> (tableName.endsWith(value % <span class="number">2</span> + <span class="string">""</span>)) &#123;</div><div class="line">                    result.add(tableName);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doBetweenSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; tableNames, <span class="keyword">final</span> ShardingValue&lt;Integer&gt; shardingValue)</span> </span>&#123;</div><div class="line">        Collection&lt;String&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(tableNames.size());</div><div class="line">        Range&lt;Integer&gt; range = shardingValue.getValueRange();</div><div class="line">        <span class="keyword">for</span> (Integer i = range.lowerEndpoint(); i &lt;= range.upperEndpoint(); i++) &#123;</div><div class="line">            <span class="keyword">for</span> (String each : tableNames) &#123;</div><div class="line">                <span class="keyword">if</span> (each.endsWith(i % <span class="number">2</span> + <span class="string">""</span>)) &#123;</div><div class="line">                    result.add(each);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æˆ‘ä»¬å¯ä»¥å‚è€ƒè¿™ä¸ªä¾‹å­ç¼–å†™è‡ªå·±çš„åˆ†ç‰‡ç®—å“Ÿ ğŸ‘¼ã€‚</li>
<li>å¤šç‰‡é”®åˆ†åº“ç®—æ³•æ¥å£å®ç°ä¾‹å­ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/test/java/com/dangdang/ddframe/rdb/integrate/fixture/MultipleKeysModuloDatabaseShardingAlgorithm.java" rel="external nofollow noopener noreferrer" target="_blank">MultipleKeysModuloDatabaseShardingAlgorithm.java</a></li>
</ul>
<hr>
<p>ğŸ˜ˆ æ¥çœ‹çœ‹<strong>åŠ¨æ€è®¡ç®—åˆ†ç‰‡</strong>éœ€è¦æ€ä¹ˆå®ç°åˆ†ç‰‡ç®—æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// com.dangdang.ddframe.rdb.integrate.fixture.SingleKeyDynamicModuloTableShardingAlgorithm.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleKeyDynamicModuloTableShardingAlgorithm</span> <span class="keyword">implements</span> <span class="title">SingleKeyTableShardingAlgorithm</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * è¡¨å‰ç¼€</div><div class="line">    */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String tablePrefix;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doEqualSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> ShardingValue&lt;Integer&gt; shardingValue)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> tablePrefix + shardingValue.getValue() % <span class="number">10</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doInSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> ShardingValue&lt;Integer&gt; shardingValue)</span> </span>&#123;</div><div class="line">        Collection&lt;String&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(shardingValue.getValues().size());</div><div class="line">        <span class="keyword">for</span> (Integer value : shardingValue.getValues()) &#123;</div><div class="line">            result.add(tablePrefix + value % <span class="number">10</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doBetweenSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> ShardingValue&lt;Integer&gt; shardingValue)</span> </span>&#123;</div><div class="line">        Collection&lt;String&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(availableTargetNames.size());</div><div class="line">        Range&lt;Integer&gt; range = shardingValue.getValueRange();</div><div class="line">        <span class="keyword">for</span> (Integer i = range.lowerEndpoint(); i &lt;= range.upperEndpoint(); i++) &#123;</div><div class="line">            result.add(tablePrefix + i % <span class="number">10</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>éªšå¹´ï¼Œæ˜¯ä¸æ˜¯æ˜ç™½äº†ä¸€äº›ï¼Ÿ<strong>åŠ¨æ€è¡¨</strong>æ— éœ€æŠŠçœŸå®è¡¨é…ç½®åˆ° TableRuleï¼Œè€Œæ˜¯é€šè¿‡<strong>åˆ†ç‰‡ç®—æ³•</strong>è®¡ç®—å‡º<strong>çœŸå®è¡¨</strong>ã€‚</li>
</ul>
<h1 id="4-SQL-è·¯ç”±"><a href="#4-SQL-è·¯ç”±" class="headerlink" title="4. SQL è·¯ç”±"></a>4. SQL è·¯ç”±</h1><p>SQLRouterï¼ŒSQL è·¯ç”±å™¨æ¥å£ï¼Œå…±æœ‰ä¸¤ç§å®ç°ï¼š</p>
<ul>
<li>DatabaseHintSQLRouterï¼šé€šè¿‡æç¤ºä¸”ä»…è·¯ç”±è‡³æ•°æ®åº“çš„SQLè·¯ç”±å™¨</li>
<li>ParsingSQLRouterï¼šéœ€è¦è§£æçš„SQLè·¯ç”±å™¨</li>
</ul>
<p>å®ƒä»¬å®ç° <code>#parse()</code>è¿›è¡Œ<strong>SQLè§£æ</strong>ï¼Œ<code>#route()</code>è¿›è¡Œ<strong>SQLè·¯ç”±</strong>ã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/03.png" alt=""></p>
<hr>
<p>RoutingEngineï¼Œè·¯ç”±å¼•æ“æ¥å£ï¼Œå…±æœ‰å››ç§å®ç°ï¼š</p>
<ul>
<li>DatabaseHintRoutingEngineï¼šåŸºäºæ•°æ®åº“æç¤ºçš„è·¯ç”±å¼•æ“</li>
<li>SimpleRoutingEngineï¼šç®€å•è·¯ç”±å¼•æ“</li>
<li>CartesianRoutingEngineï¼šç¬›å¡å°”ç§¯çš„åº“è¡¨è·¯ç”±</li>
<li>ComplexRoutingEngineï¼šæ··åˆå¤šåº“è¡¨è·¯ç”±å¼•æ“</li>
</ul>
<p><strong>ComplexRoutingEngine æ ¹æ®è·¯ç”±ç»“æœä¼šè½¬åŒ–æˆ SimpleRoutingEngine æˆ– ComplexRoutingEngine</strong>ã€‚ä¸‹æ–‡ä¼šçœ‹ç›¸åº”æºç ã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/04.png" alt=""></p>
<hr>
<p>è·¯ç”±ç»“æœæœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>RoutingResultï¼šç®€å•è·¯ç”±ç»“æœ</li>
<li>CartesianRoutingResultï¼šç¬›å¡å°”ç§¯è·¯ç”±ç»“æœ</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/05.png" alt=""></p>
<p>ä»å›¾ä¸­ï¼Œæˆ‘ä»¬å·²ç»èƒ½å¤§æ¦‚çœ‹åˆ°ä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œæ›´å…·ä½“çš„ä¸‹æ–‡éšæºç ä¸€èµ·åˆ†äº«ã€‚</p>
<p>ğŸ˜ˆ SQLRouteResult å’Œ RoutingResult æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p>
<ul>
<li>SQLRouteResultï¼š<strong>æ•´ä¸ªSQLè·¯ç”±</strong>è¿”å›çš„è·¯ç”±ç»“æœ</li>
<li>RoutingResultï¼š<strong>RoutingEngine</strong>è¿”å›è·¯ç”±ç»“æœ</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/06.png" alt=""></p>
<hr>
<p>ä¸€ä¸‹å­çœ‹åˆ°è¿™ä¹ˆå¤š<strong>â€œå¯¹è±¡â€</strong>ï¼Œå¯èƒ½æœ‰ç‚¹<strong>ç´§å¼ </strong>ã€‚ä¸è¦ç´§å¼ ï¼Œæˆ‘ä»¬ä¸€èµ·åœ¨æ•´ç†ä¸‹ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">è·¯ç”±å™¨</th>
<th style="text-align:left">è·¯ç”±å¼•æ“</th>
<th style="text-align:left">è·¯ç”±ç»“æœ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">DatabaseHintSQLRouter</td>
<td style="text-align:left">DatabaseHintRoutingEngine</td>
<td style="text-align:left">RoutingResult</td>
</tr>
<tr>
<td style="text-align:left">ParsingSQLRouter</td>
<td style="text-align:left">SimpleRoutingEngine</td>
<td style="text-align:left">RoutingResult</td>
</tr>
<tr>
<td style="text-align:left">ParsingSQLRouter</td>
<td style="text-align:left">CartesianRoutingEngine</td>
<td style="text-align:left">CartesianRoutingResult</td>
</tr>
</tbody>
</table>
<p>ğŸ˜ˆ é€—æ¯”åšä¸»ç»™å¤§å®¶è§£å†³äº†<strong>â€œå¯¹è±¡â€</strong>ï¼Œæ˜¯ä¸æ˜¯åº”è¯¥<strong>åˆ†äº«æœ‹å‹åœˆ</strong>ã€‚</p>
<h1 id="5-DatabaseHintSQLRouter"><a href="#5-DatabaseHintSQLRouter" class="headerlink" title="5. DatabaseHintSQLRouter"></a>5. DatabaseHintSQLRouter</h1><p>DatabaseHintSQLRouterï¼ŒåŸºäºæ•°æ®åº“æç¤ºçš„è·¯ç”±å¼•æ“ã€‚è·¯ç”±å™¨å·¥å‚ SQLRouterFactory åˆ›å»ºè·¯ç”±å™¨æ—¶ï¼Œåˆ¤æ–­åˆ°ä½¿ç”¨æ•°æ®åº“æç¤º( Hint ) æ—¶ï¼Œåˆ›å»º DatabaseHintSQLRouterã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DatabaseHintRoutingEngine.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SQLRouter <span class="title">createSQLRouter</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> HintManagerHolder.isDatabaseShardingOnly() ? <span class="keyword">new</span> DatabaseHintSQLRouter(shardingContext) : <span class="keyword">new</span> ParsingSQLRouter(shardingContext);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…ˆæ¥çœ‹ä¸‹ HintManagerHolderã€HintManager <strong>éƒ¨åˆ†ç›¸å…³</strong>çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// HintManagerHolder.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HintManagerHolder</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * HintManager çº¿ç¨‹å˜é‡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;HintManager&gt; HINT_MANAGER_HOLDER = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ¤æ–­æ˜¯å¦å½“å‰åªåˆ†åº“.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span> æ˜¯å¦å½“å‰åªåˆ†åº“.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isDatabaseShardingOnly</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span> != HINT_MANAGER_HOLDER.get() &amp;&amp; HINT_MANAGER_HOLDER.get().isDatabaseShardingOnly();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ¸…ç†çº¿ç´¢åˆ†ç‰‡ç®¡ç†å™¨çš„æœ¬åœ°çº¿ç¨‹æŒæœ‰è€….</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</div><div class="line">        HINT_MANAGER_HOLDER.remove();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// HintManager.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HintManager</span> <span class="keyword">implements</span> <span class="title">AutoCloseable</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åº“åˆ†ç‰‡å€¼é›†åˆ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ShardingKey, ShardingValue&lt;?&gt;&gt; databaseShardingValues = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åªåšåº“åˆ†ç‰‡</div><div class="line">     * &#123;<span class="doctag">@link</span> DatabaseHintRoutingEngine&#125;</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> databaseShardingOnly;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–çº¿ç´¢åˆ†ç‰‡ç®¡ç†å™¨å®ä¾‹.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span> çº¿ç´¢åˆ†ç‰‡ç®¡ç†å™¨å®ä¾‹</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HintManager <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        HintManager result = <span class="keyword">new</span> HintManager();</div><div class="line">        HintManagerHolder.setHintManager(result);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è®¾ç½®åˆ†åº“åˆ†ç‰‡å€¼.</div><div class="line">     * </div><div class="line">     * &lt;p&gt;åˆ†ç‰‡æ“ä½œç¬¦ä¸ºç­‰å·.è¯¥æ–¹æ³•é€‚ç”¨äºåªåˆ†åº“çš„åœºæ™¯&lt;/p&gt;</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> value åˆ†ç‰‡å€¼</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDatabaseShardingValue</span><span class="params">(<span class="keyword">final</span> Comparable&lt;?&gt; value)</span> </span>&#123;</div><div class="line">        databaseShardingOnly = <span class="keyword">true</span>;</div><div class="line">        addDatabaseShardingValue(HintManagerHolder.DB_TABLE_NAME, HintManagerHolder.DB_COLUMN_NAME, value);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é‚£ä¹ˆå¦‚æœè¦ä½¿ç”¨ DatabaseHintSQLRouterï¼Œæˆ‘ä»¬åªéœ€è¦ <code>HintManager.getInstance().setDatabaseShardingValue(åº“åˆ†ç‰‡å€¼)</code> å³å¯ã€‚è¿™é‡Œæœ‰ä¸¤ç‚¹è¦æ³¨æ„ä¸‹ï¼š</p>
<ul>
<li><code>HintManager#getInstance()</code>ï¼Œæ¯æ¬¡è·å–åˆ°çš„éƒ½æ˜¯<strong>æ–°</strong>çš„ HintManagerï¼Œå¤šæ¬¡èµ‹å€¼éœ€è¦å°å¿ƒã€‚</li>
<li><code>HintManager#close()</code>ï¼Œä½¿ç”¨å®Œéœ€è¦å»æ¸…ç†ï¼Œé¿å…ä¸‹ä¸ªè¯·æ±‚è¯»åˆ°é—æ¼çš„çº¿ç¨‹å˜é‡ã€‚</li>
</ul>
<hr>
<p>çœ‹çœ‹ DatabaseHintSQLRouter çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DatabaseHintSQLRouter.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLStatement <span class="title">parse</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> <span class="keyword">int</span> parametersSize)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> SQLJudgeEngine(logicSQL).judge(); <span class="comment">// åªè§£æ SQL ç±»å‹</span></div><div class="line">&#125;  </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="comment">// TODO insertçš„SQLä»ç„¶éœ€è¦è§£æè‡ªå¢ä¸»é”®</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLRouteResult <span class="title">route</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   Context context = MetricsContext.start(<span class="string">"Route SQL"</span>);</div><div class="line">   SQLRouteResult result = <span class="keyword">new</span> SQLRouteResult(sqlStatement);</div><div class="line">   <span class="comment">// è·¯ç”±</span></div><div class="line">   RoutingResult routingResult = <span class="keyword">new</span> DatabaseHintRoutingEngine(shardingRule.getDataSourceRule(), shardingRule.getDatabaseShardingStrategy(), sqlStatement.getType())</div><div class="line">           .route();</div><div class="line">   <span class="comment">// SQLæœ€å°æ‰§è¡Œå•å…ƒ</span></div><div class="line">   <span class="keyword">for</span> (TableUnit each : routingResult.getTableUnits().getTableUnits()) &#123;</div><div class="line">       result.getExecutionUnits().add(<span class="keyword">new</span> SQLExecutionUnit(each.getDataSourceName(), logicSQL));</div><div class="line">   &#125;</div><div class="line">   MetricsContext.stop(context);</div><div class="line">   <span class="keyword">if</span> (showSQL) &#123;</div><div class="line">       SQLLogger.logSQL(logicSQL, sqlStatement, result.getExecutionUnits(), parameters);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#parse()</code> åªè§£æäº† SQL ç±»å‹ï¼Œå³ SELECT / UPDATE / DELETE / INSERT ã€‚</li>
<li><strong>ä½¿ç”¨çš„åˆ†åº“ç­–ç•¥æ¥è‡ª ShardingRuleï¼Œä¸æ˜¯ TableRuleï¼Œè¿™ä¸ªä¸€å®šè¦ç•™å¿ƒã€‚</strong>â“å› ä¸º SQL æœªè§£æ<strong>è¡¨å</strong>ã€‚å› æ­¤ï¼Œå³ä½¿åœ¨ TableRule è®¾ç½®äº† <code>actualTables</code> å±æ€§ä¹Ÿæ˜¯æ²¡æœ‰æ•ˆæœçš„ã€‚</li>
<li>ç›®å‰ä¸æ”¯æŒ Sharding-JDBC çš„ä¸»é”®è‡ªå¢ã€‚â“å› ä¸º SQL æœªè§£æ<strong>è‡ªå¢ä¸»é”®</strong>ã€‚ä»ä»£ç ä¸Šçš„<code>TODO</code>åº”è¯¥ä¼šæ”¯æŒã€‚</li>
<li><code>HintManager.getInstance().setDatabaseShardingValue(åº“åˆ†ç‰‡å€¼)</code> è®¾ç½®çš„åº“åˆ†ç‰‡å€¼ä½¿ç”¨çš„æ˜¯  EQUALSï¼Œå› è€Œåˆ†åº“ç­–ç•¥è®¡ç®—å‡ºæ¥çš„åªæœ‰<strong>ä¸€ä¸ªåº“åˆ†ç‰‡</strong>ï¼Œå³ TableUnit åªæœ‰ä¸€ä¸ªï¼ŒSQLExecutionUnit åªæœ‰ä¸€ä¸ªã€‚</li>
</ul>
<hr>
<p>çœ‹çœ‹ DatabaseHintSQLRouter çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DatabaseHintRoutingEngine.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> RoutingResult <span class="title">route</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ä» Hint è·å¾— åˆ†ç‰‡é”®å€¼</span></div><div class="line">   Optional&lt;ShardingValue&lt;?&gt;&gt; shardingValue = HintManagerHolder.getDatabaseShardingValue(<span class="keyword">new</span> ShardingKey(HintManagerHolder.DB_TABLE_NAME, HintManagerHolder.DB_COLUMN_NAME));</div><div class="line">   Preconditions.checkState(shardingValue.isPresent());</div><div class="line">   log.debug(<span class="string">"Before database sharding only db:&#123;&#125; sharding values: &#123;&#125;"</span>, dataSourceRule.getDataSourceNames(), shardingValue.get());</div><div class="line">   <span class="comment">// è·¯ç”±ã€‚è¡¨åˆ†ç‰‡è§„åˆ™ä½¿ç”¨çš„æ˜¯ ShardingRule é‡Œçš„ã€‚å› ä¸ºæ²¡ SQL è§£æã€‚</span></div><div class="line">   Collection&lt;String&gt; routingDataSources = databaseShardingStrategy.doStaticSharding(sqlType, dataSourceRule.getDataSourceNames(), Collections.&lt;ShardingValue&lt;?&gt;&gt;singleton(shardingValue.get()));</div><div class="line">   Preconditions.checkState(!routingDataSources.isEmpty(), <span class="string">"no database route info"</span>);</div><div class="line">   log.debug(<span class="string">"After database sharding only result: &#123;&#125;"</span>, routingDataSources);</div><div class="line">   <span class="comment">// è·¯ç”±ç»“æœ</span></div><div class="line">   RoutingResult result = <span class="keyword">new</span> RoutingResult();</div><div class="line">   <span class="keyword">for</span> (String each : routingDataSources) &#123;</div><div class="line">       result.getTableUnits().getTableUnits().add(<span class="keyword">new</span> TableUnit(each, <span class="string">""</span>, <span class="string">""</span>));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>åª</strong>è°ƒç”¨ <code>databaseShardingStrategy.doStaticSharding()</code> æ–¹æ³•è®¡ç®—<strong>åº“</strong>åˆ†ç‰‡ã€‚</li>
<li><code>new TableUnit(each, &quot;&quot;, &quot;&quot;)</code> çš„ <code>logicTableName</code>ï¼Œ<code>actualTableName</code> éƒ½æ˜¯ç©ºä¸²ï¼Œç›¸ä¿¡åŸå› ä½ å·²ç»çŸ¥é“ã€‚</li>
</ul>
<h1 id="6-ParsingSQLRouter"><a href="#6-ParsingSQLRouter" class="headerlink" title="6. ParsingSQLRouter"></a>6. ParsingSQLRouter</h1><p>ParsingSQLRouterï¼Œéœ€è¦è§£æçš„SQLè·¯ç”±å™¨ã€‚</p>
<p>ParsingSQLRouter ä½¿ç”¨ SQLParsingEngine <strong>è§£æSQL</strong>ã€‚å¯¹<strong>SQLè§£æ</strong>æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹çœ‹æ‹™ä½œ<a href="http://www.yunai.me/categories/Sharding-JDBC/?mp">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æã€‹</a>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLStatement <span class="title">parse</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> <span class="keyword">int</span> parametersSize)</span> </span>&#123;</div><div class="line">   SQLParsingEngine parsingEngine = <span class="keyword">new</span> SQLParsingEngine(databaseType, logicSQL, shardingRule);</div><div class="line">   Context context = MetricsContext.start(<span class="string">"Parse SQL"</span>);</div><div class="line">   SQLStatement result = parsingEngine.parse();</div><div class="line">   <span class="keyword">if</span> (result <span class="keyword">instanceof</span> InsertStatement) &#123;</div><div class="line">       ((InsertStatement) result).appendGenerateKeyToken(shardingRule, parametersSize);</div><div class="line">   &#125;</div><div class="line">   MetricsContext.stop(context);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#appendGenerateKeyToken()</code> ä¼šåœ¨<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL æ”¹å†™ã€‹</a>åˆ†äº«</li>
</ul>
<hr>
<p>ParsingSQLRouter åœ¨è·¯ç”±æ—¶ï¼Œä¼šæ ¹æ®<strong>è¡¨æƒ…å†µ</strong>ä½¿ç”¨ SimpleRoutingEngine æˆ– CartesianRoutingEngine è¿›è¡Œè·¯ç”±ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> RoutingResult <span class="title">route</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   Collection&lt;String&gt; tableNames = sqlStatement.getTables().getTableNames();</div><div class="line">   RoutingEngine routingEngine;</div><div class="line">   <span class="keyword">if</span> (<span class="number">1</span> == tableNames.size() || shardingRule.isAllBindingTables(tableNames)) &#123;</div><div class="line">       routingEngine = <span class="keyword">new</span> SimpleRoutingEngine(shardingRule, parameters, tableNames.iterator().next(), sqlStatement);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="comment">// TODO å¯é…ç½®æ˜¯å¦æ‰§è¡Œç¬›å¡å°”ç§¯</span></div><div class="line">       routingEngine = <span class="keyword">new</span> ComplexRoutingEngine(shardingRule, parameters, tableNames, sqlStatement);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> routingEngine.route();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å½“åªè¿›è¡Œ<strong>ä¸€å¼ è¡¨</strong>æˆ–è€…<strong>å¤šè¡¨äº’ä¸ºBindingTableå…³ç³»</strong>æ—¶ï¼Œä½¿ç”¨ SimpleRoutingEngine ç®€å•è·¯ç”±å¼•æ“ã€‚<strong>å¤šè¡¨äº’ä¸ºBindingTableå…³ç³»</strong>æ—¶ï¼Œæ¯å¼ è¡¨çš„è·¯ç”±ç»“æœæ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥åªè¦è®¡ç®—ç¬¬ä¸€å¼ è¡¨çš„åˆ†ç‰‡å³å¯ã€‚</li>
<li><code>tableNames.iterator().next()</code> æ³¨æ„ä¸‹ï¼Œ<code>tableNames</code> å˜é‡æ˜¯ <code>new TreeMap&lt;&gt;(String.CASE_INSENSITIVE_ORDER)</code>ã€‚æ‰€ä»¥ <code>SELECT * FROM t_order o join t_order_item i ON o.order_id = i.order_id</code> å³ä½¿ <code>t_order_item</code> æ’åœ¨ <code>t_order</code> å‰é¢ï¼Œ<code>tableNames.iterator().next()</code> è¿”å›çš„æ˜¯ <code>t_order</code>ã€‚å½“ <code>t_order</code> å’Œ <code>t_order_item</code> ä¸º <strong>BindingTableå…³ç³»</strong> æ—¶ï¼Œè®¡ç®—çš„æ˜¯ <code>t_order</code> è·¯ç”±åˆ†ç‰‡ã€‚</li>
<li>BindingTableå…³ç³»åœ¨ ShardingRule çš„ <code>tableRules</code> é…ç½®ã€‚é…ç½®è¯¥å…³ç³» TableRule æœ‰å¦‚ä¸‹éœ€è¦éµå®ˆçš„è§„åˆ™ï¼š<ul>
<li>åˆ†ç‰‡ç­–ç•¥ä¸ç®—æ³•ç›¸åŒ</li>
<li>æ•°æ®æºé…ç½®å¯¹è±¡ç›¸åŒ</li>
<li>çœŸå®è¡¨<strong>æ•°é‡</strong>ç›¸åŒ  </li>
</ul>
</li>
</ul>
<p><strong>ä¸¾ä¸ªä¾‹å­</strong>ï¼š  </p>
<ul>
<li>SQL ï¼š<code>SELECT * FROM t_order o join t_order_item i ON o.order_id = i.order_id</code>  </li>
<li>åˆ†åº“åˆ†è¡¨æƒ…å†µï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">multi_db_multi_table_01</div><div class="line">  â”œâ”€â”€ t_order_0                        â”œâ”€â”€ t_order_item_01</div><div class="line">  â””â”€â”€ t_order_1                        â”œâ”€â”€ t_order_item_02</div><div class="line">                                       â”œâ”€â”€ t_order_item_03</div><div class="line">                                       â”œâ”€â”€ t_order_item_04</div><div class="line">multi_db_multi_table_02</div><div class="line">  â”œâ”€â”€ t_order_0                        â”œâ”€â”€ t_order_item_01</div><div class="line">  â””â”€â”€ t_order_1                        â”œâ”€â”€ t_order_item_02</div><div class="line">                                       â”œâ”€â”€ t_order_item_03</div><div class="line">                                       â”œâ”€â”€ t_order_item_04</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆæ‰§è¡Œçš„SQLå¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order_item_01 i <span class="keyword">JOIN</span> t_order_01 o <span class="keyword">ON</span> o.order_id = i.order_id </div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order_item_01 i <span class="keyword">JOIN</span> t_order_01 o <span class="keyword">ON</span> o.order_id = i.order_id </div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order_item_02 i <span class="keyword">JOIN</span> t_order_02 o <span class="keyword">ON</span> o.order_id = i.order_id</div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order_item_02 i <span class="keyword">JOIN</span> t_order_02 o <span class="keyword">ON</span> o.order_id = i.order_id</div></pre></td></tr></table></figure>
<ul>
<li><code>t_order_item_03</code>ã€<code>t_order_item_04</code> æ— æ³•è¢«æŸ¥è¯¢åˆ°ã€‚</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹ <code>#isAllBindingTables()</code> å¦‚ä½•å®ç°<strong>å¤šè¡¨äº’ä¸ºBindingTableå…³ç³»</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingRule.java</span></div><div class="line"><span class="comment">// è°ƒç”¨é¡ºåº #isAllBindingTables()=&gt;#filterAllBindingTables()=&gt;#findBindingTableRule()=&gt;#findBindingTableRule()</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ¤æ–­é€»è¾‘è¡¨åç§°é›†åˆæ˜¯å¦å…¨éƒ¨å±äºBindingè¡¨.</div><div class="line">* <span class="doctag">@param</span> logicTables é€»è¾‘è¡¨åç§°é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAllBindingTables</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; logicTables)</span> </span>&#123;</div><div class="line">   Collection&lt;String&gt; bindingTables = filterAllBindingTables(logicTables);</div><div class="line">   <span class="keyword">return</span> !bindingTables.isEmpty() &amp;&amp; bindingTables.containsAll(logicTables);</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è¿‡æ»¤å‡ºæ‰€æœ‰çš„Bindingè¡¨åç§°.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">filterAllBindingTables</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; logicTables)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (logicTables.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   Optional&lt;BindingTableRule&gt; bindingTableRule = findBindingTableRule(logicTables);</div><div class="line">   <span class="keyword">if</span> (!bindingTableRule.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// äº¤é›†</span></div><div class="line">   Collection&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(bindingTableRule.get().getAllLogicTables());</div><div class="line">   result.retainAll(logicTables);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—åŒ…å«&lt;strong&gt;ä»»ä¸€&lt;/strong&gt;åœ¨é€»è¾‘è¡¨åç§°é›†åˆçš„bindingè¡¨é…ç½®çš„é€»è¾‘è¡¨åç§°é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Optional&lt;BindingTableRule&gt; <span class="title">findBindingTableRule</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; logicTables)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (String each : logicTables) &#123;</div><div class="line">       Optional&lt;BindingTableRule&gt; result = findBindingTableRule(each);</div><div class="line">       <span class="keyword">if</span> (result.isPresent()) &#123;</div><div class="line">           <span class="keyword">return</span> result;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> Optional.absent();</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* æ ¹æ®é€»è¾‘è¡¨åç§°è·å–bindingè¡¨é…ç½®çš„é€»è¾‘è¡¨åç§°é›†åˆ.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Optional&lt;BindingTableRule&gt; <span class="title">findBindingTableRule</span><span class="params">(<span class="keyword">final</span> String logicTable)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (BindingTableRule each : bindingTableRules) &#123;</div><div class="line">       <span class="keyword">if</span> (each.hasLogicTable(logicTable)) &#123;</div><div class="line">           <span class="keyword">return</span> Optional.of(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> Optional.absent();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>é€»è¾‘çœ‹èµ·æ¥æ¯”è¾ƒé•¿ï¼Œç›®çš„æ˜¯æ‰¾åˆ°ä¸€æ¡ BindingTableRule åŒ…å«<strong>æ‰€æœ‰</strong>é€»è¾‘è¡¨é›†åˆ</li>
<li>ä¸æ”¯æŒ<a href="https://zh.wikipedia.org/wiki/%E4%BC%A0%E9%80%92%E5%85%B3%E7%B3%BB" rel="external nofollow noopener noreferrer" target="_blank">ã€Šä¼ é€’å…³ç³»ã€‹</a>ï¼šé…ç½® BindingTableRule æ—¶ï¼Œ<strong>ç›¸åŒç»‘å®šå…³ç³»ä¸€å®šè¦é…ç½®åœ¨ä¸€æ¡</strong>ï¼Œå¿…é¡»æ˜¯ <code>[a, b, c]</code>ï¼Œè€Œä¸èƒ½æ˜¯ <code>[a, b], [b, c]</code>ã€‚</li>
</ul>
<h2 id="6-1-SimpleRoutingEngine"><a href="#6-1-SimpleRoutingEngine" class="headerlink" title="6.1 SimpleRoutingEngine"></a>6.1 SimpleRoutingEngine</h2><p>SimpleRoutingEngineï¼Œç®€å•è·¯ç”±å¼•æ“ã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/07.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SimpleRoutingEngine.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;String&gt; <span class="title">routeDataSources</span><span class="params">(<span class="keyword">final</span> TableRule tableRule)</span> </span>&#123;</div><div class="line">   DatabaseShardingStrategy strategy = shardingRule.getDatabaseShardingStrategy(tableRule);</div><div class="line">   List&lt;ShardingValue&lt;?&gt;&gt; shardingValues = HintManagerHolder.isUseShardingHint() ? getDatabaseShardingValuesFromHint(strategy.getShardingColumns())</div><div class="line">           : getShardingValues(strategy.getShardingColumns());</div><div class="line">   Collection&lt;String&gt; result = strategy.doStaticSharding(sqlStatement.getType(), tableRule.getActualDatasourceNames(), shardingValues);</div><div class="line">   Preconditions.checkState(!result.isEmpty(), <span class="string">"no database route info"</span>);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="keyword">private</span> List&lt;ShardingValue&lt;?&gt;&gt; getShardingValues(<span class="keyword">final</span> Collection&lt;String&gt; shardingColumns) &#123;</div><div class="line">   List&lt;ShardingValue&lt;?&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(shardingColumns.size());</div><div class="line">   <span class="keyword">for</span> (String each : shardingColumns) &#123;</div><div class="line">       Optional&lt;Condition&gt; condition = sqlStatement.getConditions().find(<span class="keyword">new</span> Column(each, logicTableName));</div><div class="line">       <span class="keyword">if</span> (condition.isPresent()) &#123;</div><div class="line">           result.add(condition.get().getShardingValue(parameters));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥ä½¿ç”¨ HintManager è®¾ç½®<strong>åº“</strong>åˆ†ç‰‡å€¼è¿›è¡Œ<strong>å¼ºåˆ¶è·¯ç”±</strong>ã€‚</li>
<li><code>#getShardingValues()</code> æˆ‘ä»¬çœ‹åˆ°äº†<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹</a>åˆ†äº«çš„ Condition å¯¹è±¡ã€‚ä¹‹å‰æˆ‘ä»¬æåˆ°è¿‡<strong>Parser åŠç†è§£SQLçš„ç›®çš„ä¹‹ä¸€æ˜¯ï¼šæç‚¼åˆ†ç‰‡ä¸Šä¸‹æ–‡</strong>ï¼Œæ­¤å¤„å³æ˜¯è¯¥ç›®çš„çš„ä½“ç°ã€‚Condition é‡Œåªæ”¾<strong>æ˜ç¡®</strong>å½±å“è·¯ç”±çš„æ¡ä»¶ï¼Œä¾‹å¦‚ï¼š<code>order_id = 1</code>, <code>order_id IN (1, 2)</code>, <code>order_id BETWEEN (1, 3)</code>ï¼Œä¸æ”¾<strong>æ— æ³•è®¡ç®—</strong>çš„æ¡ä»¶ï¼Œä¾‹å¦‚ï¼š<code>o.order_id = i.order_id</code>ã€‚è¯¥æ–¹æ³•é‡Œï¼Œä½¿ç”¨<strong>åˆ†ç‰‡é”®</strong>ä» Condition æŸ¥æ‰¾ <strong>åˆ†ç‰‡å€¼</strong>ã€‚ğŸ™‚ æ˜¯ä¸æ˜¯å¯¹ Condition çš„è®¤è¯†æ›´åŠ æ¸…æ™°ä¸€ä¸¢ä¸¢è½ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SimpleRoutingEngine.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;String&gt; <span class="title">routeTables</span><span class="params">(<span class="keyword">final</span> TableRule tableRule, <span class="keyword">final</span> Collection&lt;String&gt; routedDataSources)</span> </span>&#123;</div><div class="line">   TableShardingStrategy strategy = shardingRule.getTableShardingStrategy(tableRule);</div><div class="line">   List&lt;ShardingValue&lt;?&gt;&gt; shardingValues = HintManagerHolder.isUseShardingHint() ? getTableShardingValuesFromHint(strategy.getShardingColumns())</div><div class="line">           : getShardingValues(strategy.getShardingColumns());</div><div class="line">   Collection&lt;String&gt; result = tableRule.isDynamic() ? strategy.doDynamicSharding(shardingValues)</div><div class="line">           : strategy.doStaticSharding(sqlStatement.getType(), tableRule.getActualTableNames(routedDataSources), shardingValues);</div><div class="line">   Preconditions.checkState(!result.isEmpty(), <span class="string">"no table route info"</span>);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥ä½¿ç”¨ HintManager è®¾ç½®<strong>è¡¨</strong>åˆ†ç‰‡å€¼è¿›è¡Œ<strong>å¼ºåˆ¶è·¯ç”±</strong>ã€‚</li>
<li>æ ¹æ® <code>dynamic</code> å±æ€§æ¥åˆ¤æ–­è°ƒç”¨ <code>#doDynamicSharding()</code> è¿˜æ˜¯ <code>#doStaticSharding()</code> è®¡ç®—åˆ†ç‰‡ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SimpleRoutingEngine.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> RoutingResult <span class="title">generateRoutingResult</span><span class="params">(<span class="keyword">final</span> TableRule tableRule, <span class="keyword">final</span> Collection&lt;String&gt; routedDataSources, <span class="keyword">final</span> Collection&lt;String&gt; routedTables)</span> </span>&#123;</div><div class="line">   RoutingResult result = <span class="keyword">new</span> RoutingResult();</div><div class="line">   <span class="keyword">for</span> (DataNode each : tableRule.getActualDataNodes(routedDataSources, routedTables)) &#123;</div><div class="line">       result.getTableUnits().getTableUnits().add(<span class="keyword">new</span> TableUnit(each.getDataSourceName(), logicTableName, each.getTableName()));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// TableRule.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ ¹æ®æ•°æ®æºåç§°è¿‡æ»¤è·å–çœŸå®æ•°æ®å•å…ƒ.</div><div class="line">* <span class="doctag">@param</span> targetDataSources æ•°æ®æºåç§°é›†åˆ</div><div class="line">* <span class="doctag">@param</span> targetTables çœŸå®è¡¨åç§°é›†åˆ</div><div class="line">* <span class="doctag">@return</span> çœŸå®æ•°æ®å•å…ƒ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;DataNode&gt; <span class="title">getActualDataNodes</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; targetDataSources, <span class="keyword">final</span> Collection&lt;String&gt; targetTables)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> dynamic ? getDynamicDataNodes(targetDataSources, targetTables) : getStaticDataNodes(targetDataSources, targetTables);</div><div class="line">&#125;  </div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;DataNode&gt; <span class="title">getDynamicDataNodes</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; targetDataSources, <span class="keyword">final</span> Collection&lt;String&gt; targetTables)</span> </span>&#123;</div><div class="line">   Collection&lt;DataNode&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(targetDataSources.size() * targetTables.size());</div><div class="line">   <span class="keyword">for</span> (String targetDataSource : targetDataSources) &#123;</div><div class="line">       <span class="keyword">for</span> (String targetTable : targetTables) &#123;</div><div class="line">           result.add(<span class="keyword">new</span> DataNode(targetDataSource, targetTable));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125; </div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;DataNode&gt; <span class="title">getStaticDataNodes</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; targetDataSources, <span class="keyword">final</span> Collection&lt;String&gt; targetTables)</span> </span>&#123;</div><div class="line">   Collection&lt;DataNode&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(actualTables.size());</div><div class="line">   <span class="keyword">for</span> (DataNode each : actualTables) &#123;</div><div class="line">       <span class="keyword">if</span> (targetDataSources.contains(each.getDataSourceName()) &amp;&amp; targetTables.contains(each.getTableName())) &#123;</div><div class="line">           result.add(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>åœ¨ SimpleRoutingEngine åªç”Ÿæˆäº†å½“å‰è¡¨çš„ TableUnitsã€‚å¦‚æœå­˜åœ¨<strong>ä¸å…¶äº’ä¸ºBindingTableå…³ç³»</strong>çš„è¡¨çš„ TableUnits æ€ä¹ˆè·å¾—ï¼Ÿä½ å¯ä»¥æƒ³æƒ³å™¢ï¼Œå½“ç„¶åœ¨åæ–‡<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL æ”¹å†™ã€‹</a>ä¹Ÿä¼šç»™å‡ºç­”æ¡ˆï¼Œçœ‹çœ‹å’Œä½ æƒ³çš„æ˜¯å¦ä¸€æ ·ã€‚</li>
</ul>
<h2 id="6-2-ComplexRoutingEngine"><a href="#6-2-ComplexRoutingEngine" class="headerlink" title="6.2 ComplexRoutingEngine"></a>6.2 ComplexRoutingEngine</h2><p>ComplexRoutingEngineï¼Œæ··åˆå¤šåº“è¡¨è·¯ç”±å¼•æ“ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ComplexRoutingEngine.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> RoutingResult <span class="title">route</span><span class="params">()</span> </span>&#123;</div><div class="line">   Collection&lt;RoutingResult&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(logicTables.size());</div><div class="line">   Collection&lt;String&gt; bindingTableNames = <span class="keyword">new</span> TreeSet&lt;&gt;(String.CASE_INSENSITIVE_ORDER);</div><div class="line">   <span class="comment">// è®¡ç®—æ¯ä¸ªé€»è¾‘è¡¨çš„ç®€å•è·¯ç”±åˆ†ç‰‡</span></div><div class="line">   <span class="keyword">for</span> (String each : logicTables) &#123;</div><div class="line">       Optional&lt;TableRule&gt; tableRule = shardingRule.tryFindTableRule(each);</div><div class="line">       <span class="keyword">if</span> (tableRule.isPresent()) &#123;</div><div class="line">           <span class="keyword">if</span> (!bindingTableNames.contains(each)) &#123;</div><div class="line">               result.add(<span class="keyword">new</span> SimpleRoutingEngine(shardingRule, parameters, tableRule.get().getLogicTable(), sqlStatement).route());</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// äº’ä¸º BindingTable å…³ç³»çš„è¡¨åŠ åˆ° bindingTableNames é‡Œï¼Œä¸é‡å¤è®¡ç®—åˆ†ç‰‡</span></div><div class="line">           Optional&lt;BindingTableRule&gt; bindingTableRule = shardingRule.findBindingTableRule(each);</div><div class="line">           <span class="keyword">if</span> (bindingTableRule.isPresent()) &#123;</div><div class="line">               bindingTableNames.addAll(Lists.transform(bindingTableRule.get().getTableRules(), <span class="keyword">new</span> Function&lt;TableRule, String&gt;() &#123;</div><div class="line">                   </div><div class="line">                   <span class="meta">@Override</span></div><div class="line">                   <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(<span class="keyword">final</span> TableRule input)</span> </span>&#123;</div><div class="line">                       <span class="keyword">return</span> input.getLogicTable();</div><div class="line">                   &#125;</div><div class="line">               &#125;));</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   log.trace(<span class="string">"mixed tables sharding result: &#123;&#125;"</span>, result);</div><div class="line">   <span class="keyword">if</span> (result.isEmpty()) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ShardingJdbcException(<span class="string">"Cannot find table rule and default data source with logic tables: '%s'"</span>, logicTables);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// é˜²å¾¡æ€§ç¼–ç¨‹ã€‚shardingRule#isAllBindingTables() å·²ç»è¿‡æ»¤äº†è¿™ä¸ªæƒ…å†µã€‚</span></div><div class="line">   <span class="keyword">if</span> (<span class="number">1</span> == result.size()) &#123;</div><div class="line">       <span class="keyword">return</span> result.iterator().next();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// äº¤ç»™ CartesianRoutingEngine å½¢æˆç¬›å¡å°”ç§¯ç»“æœ</span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> CartesianRoutingEngine(result).route();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ComplexRoutingEngine è®¡ç®—æ¯ä¸ªé€»è¾‘è¡¨çš„ç®€å•è·¯ç”±åˆ†ç‰‡ï¼Œè·¯ç”±ç»“æœäº¤ç»™ CartesianRoutingEngine <strong>ç»§ç»­</strong>è·¯ç”±å½¢æˆç¬›å¡å°”ç§¯ç»“æœã€‚</li>
</ul>
<p><img src="http://www.yunai.me//images/Sharding-JDBC/2017_08_06/08.png" alt=""></p>
<ul>
<li>ç”±äºç›®å‰ ComplexRoutingEngine è·¯ç”±å‰å·²ç»åˆ¤æ–­<strong>å…¨éƒ¨è¡¨äº’ä¸º BindingTable å…³ç³»</strong>ï¼Œå› è€Œä¸ä¼šå‡ºç° <code>result.size == 1</code>ï¼Œå±äºé˜²å¾¡æ€§ç¼–ç¨‹ã€‚</li>
<li><strong>éƒ¨åˆ†è¡¨äº’ä¸º BindingTable å…³ç³»</strong>æ—¶ï¼ŒComplexRoutingEngine ä¸é‡å¤è®¡ç®—åˆ†ç‰‡ã€‚</li>
</ul>
<h2 id="6-3-CartesianRoutingEngine"><a href="#6-3-CartesianRoutingEngine" class="headerlink" title="6.3 CartesianRoutingEngine"></a>6.3 CartesianRoutingEngine</h2><p>CartesianRoutingEngineï¼Œç¬›å¡å°”ç§¯çš„åº“è¡¨è·¯ç”±ã€‚</p>
<p>å®ç°é€»è¾‘ä¸Š<strong>ç›¸å¯¹</strong>å¤æ‚ï¼Œè¯·ä¿æŒè€å¿ƒå“Ÿï¼ŒğŸ˜ˆ å…¶å®ç›®çš„å°±æ˜¯å®ç°<strong>è¿è¿çœ‹</strong>çš„æ•ˆæœï¼š</p>
<ul>
<li>RoutingResult[0] <code>x</code> RoutingResult[1] â€¦â€¦ <code>x</code> RoutingResult[n- 1] <code>x</code> RoutingResult[n]</li>
<li><strong>åŒåº“</strong> æ‰å¯ä»¥è¿›è¡Œç¬›å¡å°”ç§¯</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CartesianRoutingEngine.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> CartesianRoutingResult <span class="title">route</span><span class="params">()</span> </span>&#123;</div><div class="line">   CartesianRoutingResult result = <span class="keyword">new</span> CartesianRoutingResult();</div><div class="line">   <span class="keyword">for</span> (Entry&lt;String, Set&lt;String&gt;&gt; entry : getDataSourceLogicTablesMap().entrySet()) &#123; <span class="comment">// Entry&lt;æ•°æ®æºï¼ˆåº“ï¼‰, Set&lt;é€»è¾‘è¡¨&gt;&gt; entry</span></div><div class="line">       <span class="comment">// è·å¾—å½“å‰æ•°æ®æºï¼ˆåº“ï¼‰çš„ è·¯ç”±è¡¨å•å…ƒåˆ†ç»„</span></div><div class="line">       List&lt;Set&lt;String&gt;&gt; actualTableGroups = getActualTableGroups(entry.getKey(), entry.getValue()); <span class="comment">// List&lt;Set&lt;çœŸå®è¡¨&gt;&gt;</span></div><div class="line">       List&lt;Set&lt;TableUnit&gt;&gt; tableUnitGroups = toTableUnitGroups(entry.getKey(), actualTableGroups);</div><div class="line">       <span class="comment">// ç¬›å¡å°”ç§¯ï¼Œå¹¶åˆå¹¶ç»“æœ</span></div><div class="line">       result.merge(entry.getKey(), getCartesianTableReferences(Sets.cartesianProduct(tableUnitGroups)));</div><div class="line">   &#125;</div><div class="line">   log.trace(<span class="string">"cartesian tables sharding result: &#123;&#125;"</span>, result);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ç¬¬ä¸€æ­¥ï¼Œè·å¾—<strong>åŒåº“</strong>å¯¹åº”çš„<strong>é€»è¾‘è¡¨</strong>é›†åˆï¼Œå³ <strong>Entry&lt;æ•°æ®æºï¼ˆåº“ï¼‰, Set&lt;é€»è¾‘è¡¨&gt;&gt; entry</strong>ã€‚</li>
<li>ç¬¬äºŒæ­¥ï¼Œéå†<strong>æ•°æ®æºï¼ˆåº“ï¼‰</strong>ï¼Œè·å¾—å½“å‰<strong>æ•°æ®æºï¼ˆåº“ï¼‰</strong>çš„<strong>è·¯ç”±è¡¨å•å…ƒåˆ†ç»„</strong>ã€‚</li>
<li>ç¬¬ä¸‰æ­¥ï¼Œå¯¹<strong>è·¯ç”±è¡¨å•å…ƒåˆ†ç»„</strong>è¿›è¡Œ<strong>ç¬›å¡å°”ç§¯</strong>ï¼Œå¹¶åˆå¹¶åˆ°è·¯ç”±ç»“æœã€‚</li>
</ul>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬ä¸€èµ·é€æ­¥çœ‹çœ‹ä»£ç å®ç°ã€‚</p>
<ul>
<li>SQL ï¼š<code>SELECT * FROM t_order o join t_order_item i ON o.order_id = i.order_id</code></li>
<li>åˆ†åº“åˆ†è¡¨æƒ…å†µï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">multi_db_multi_table_01</div><div class="line">  â”œâ”€â”€ t_order_0                        â”œâ”€â”€ t_order_item_01</div><div class="line">  â””â”€â”€ t_order_1                        â”œâ”€â”€ t_order_item_02</div><div class="line">multi_db_multi_table_02</div><div class="line">  â”œâ”€â”€ t_order_0                        â”œâ”€â”€ t_order_item_01</div><div class="line">  â””â”€â”€ t_order_1                        â”œâ”€â”€ t_order_item_02</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ç¬¬ä¸€æ­¥</span></div><div class="line"><span class="comment">// CartesianRoutingEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—åŒåº“å¯¹åº”çš„é€»è¾‘è¡¨é›†åˆ</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> Map&lt;String, Set&lt;String&gt;&gt; getDataSourceLogicTablesMap() &#123;</div><div class="line">   Collection&lt;String&gt; intersectionDataSources = getIntersectionDataSources();</div><div class="line">   Map&lt;String, Set&lt;String&gt;&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;(routingResults.size());</div><div class="line">   <span class="comment">// è·å¾—åŒåº“å¯¹åº”çš„é€»è¾‘è¡¨é›†åˆ</span></div><div class="line">   <span class="keyword">for</span> (RoutingResult each : routingResults) &#123;</div><div class="line">       <span class="keyword">for</span> (Entry&lt;String, Set&lt;String&gt;&gt; entry : each.getTableUnits().getDataSourceLogicTablesMap(intersectionDataSources).entrySet()) &#123; <span class="comment">// è¿‡æ»¤æ‰ä¸åœ¨æ•°æ®æºï¼ˆåº“ï¼‰äº¤é›†çš„é€»è¾‘è¡¨</span></div><div class="line">           <span class="keyword">if</span> (result.containsKey(entry.getKey())) &#123;</div><div class="line">               result.get(entry.getKey()).addAll(entry.getValue());</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               result.put(entry.getKey(), entry.getValue());</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—æ‰€æœ‰è·¯ç”±ç»“æœé‡Œçš„æ•°æ®æºï¼ˆåº“ï¼‰äº¤é›†</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;String&gt; <span class="title">getIntersectionDataSources</span><span class="params">()</span> </span>&#123;</div><div class="line">   Collection&lt;String&gt; result = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (RoutingResult each : routingResults) &#123;</div><div class="line">       <span class="keyword">if</span> (result.isEmpty()) &#123;</div><div class="line">           result.addAll(each.getTableUnits().getDataSourceNames());</div><div class="line">       &#125;</div><div class="line">       result.retainAll(each.getTableUnits().getDataSourceNames()); <span class="comment">// äº¤é›†</span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#getDataSourceLogicTablesMap()</code> è¿”å›å¦‚å›¾ï¼š<img src="http://www.yunai.me//images/Sharding-JDBC/2017_08_06/09.png" alt=""></li>
</ul>
<hr>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ç¬¬äºŒæ­¥</span></div><div class="line"><span class="comment">// CartesianRoutingEngine.java</span></div><div class="line"><span class="keyword">private</span> List&lt;Set&lt;String&gt;&gt; getActualTableGroups(<span class="keyword">final</span> String dataSource, <span class="keyword">final</span> Set&lt;String&gt; logicTables) &#123;</div><div class="line">   List&lt;Set&lt;String&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(logicTables.size());</div><div class="line">   <span class="keyword">for</span> (RoutingResult each : routingResults) &#123;</div><div class="line">       result.addAll(each.getTableUnits().getActualTableNameGroups(dataSource, logicTables));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="keyword">private</span> List&lt;Set&lt;TableUnit&gt;&gt; toTableUnitGroups(<span class="keyword">final</span> String dataSource, <span class="keyword">final</span> List&lt;Set&lt;String&gt;&gt; actualTableGroups) &#123;</div><div class="line">   List&lt;Set&lt;TableUnit&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(actualTableGroups.size());</div><div class="line">   <span class="keyword">for</span> (Set&lt;String&gt; each : actualTableGroups) &#123;</div><div class="line">       result.add(<span class="keyword">new</span> HashSet&lt;&gt;(Lists.transform(<span class="keyword">new</span> ArrayList&lt;&gt;(each), <span class="keyword">new</span> Function&lt;String, TableUnit&gt;() &#123;</div><div class="line">    </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> TableUnit <span class="title">apply</span><span class="params">(<span class="keyword">final</span> String input)</span> </span>&#123;</div><div class="line">               <span class="keyword">return</span> findTableUnit(dataSource, input);</div><div class="line">           &#125;</div><div class="line">       &#125;)));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#getActualTableGroups()</code> è¿”å›å¦‚å›¾ï¼š<img src="http://www.yunai.me//images/Sharding-JDBC/2017_08_06/10.png" alt=""></li>
<li><code>#toTableUnitGroups()</code> è¿”å›å¦‚å›¾ï¼š<img src="http://www.yunai.me//images/Sharding-JDBC/2017_08_06/11.png" alt=""></li>
</ul>
<hr>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CartesianRoutingEngine.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> List&lt;CartesianTableReference&gt; <span class="title">getCartesianTableReferences</span><span class="params">(<span class="keyword">final</span> Set&lt;List&lt;TableUnit&gt;&gt; cartesianTableUnitGroups)</span> </span>&#123;</div><div class="line">   List&lt;CartesianTableReference&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(cartesianTableUnitGroups.size());</div><div class="line">   <span class="keyword">for</span> (List&lt;TableUnit&gt; each : cartesianTableUnitGroups) &#123;</div><div class="line">       result.add(<span class="keyword">new</span> CartesianTableReference(each));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CartesianRoutingResult.java</span></div><div class="line"><span class="meta">@Getter</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;CartesianDataSource&gt; routingDataSources = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">final</span> String dataSource, <span class="keyword">final</span> Collection&lt;CartesianTableReference&gt; routingTableReferences)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (CartesianTableReference each : routingTableReferences) &#123;</div><div class="line">       merge(dataSource, each);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">final</span> String dataSource, <span class="keyword">final</span> CartesianTableReference routingTableReference)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (CartesianDataSource each : routingDataSources) &#123;</div><div class="line">       <span class="keyword">if</span> (each.getDataSource().equalsIgnoreCase(dataSource)) &#123;</div><div class="line">           each.getRoutingTableReferences().add(routingTableReference);</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   routingDataSources.add(<span class="keyword">new</span> CartesianDataSource(dataSource, routingTableReference));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>Sets.cartesianProduct(tableUnitGroups)</code> è¿”å›å¦‚å›¾ï¼ˆGuava å·¥å…·åº“çœŸå¼ºå¤§ï¼‰ï¼š<img src="http://www.yunai.me//images/Sharding-JDBC/2017_08_06/12.png" alt=""></li>
<li><p><code>#getCartesianTableReferences()</code> è¿”å›å¦‚å›¾ï¼š<img src="http://www.yunai.me//images/Sharding-JDBC/2017_08_06/13.png" alt=""></p>
<p>  CartesianTableReferenceï¼Œç¬›å¡å°”ç§¯è¡¨<strong>è·¯ç”±ç»„</strong>ï¼ŒåŒ…å«<strong>å¤šæ¡</strong> TableUnitï¼Œå³ TableUnit[0] <code>x</code> TableUnit[1] â€¦â€¦ <code>x</code> TableUnit[n]ã€‚ä¾‹å¦‚å›¾ä¸­ï¼š<code>t_order_01 x t_order_item_02</code>ï¼Œæœ€ç»ˆè½¬æ¢æˆ SQL ä¸º <code>SELECT * FROM t_order_01 o join t_order_item_02 i ON o.order_id = i.order_id</code>ã€‚</p>
</li>
<li><code>#merge()</code> åˆå¹¶ç¬›å¡å°”ç§¯è·¯ç”±ç»“æœã€‚CartesianRoutingResult åŒ…å«å¤šä¸ª CartesianDataSourceï¼Œå› æ­¤éœ€è¦å°† CartesianTableReference åˆå¹¶ï¼ˆæ·»åŠ ï¼‰åˆ°å¯¹åº”çš„ CartesianDataSourceã€‚å½“ç„¶ï¼Œç›®å‰åœ¨å®ç°æ—¶å·²ç»æ˜¯æŒ‰ç…§<strong>æ•°æ®æºï¼ˆåº“ï¼‰</strong>ç”Ÿæˆå¯¹åº”çš„ CartesianTableReferenceã€‚</li>
</ul>
<h2 id="6-4-ParsingSQLRouter-ä¸»-route"><a href="#6-4-ParsingSQLRouter-ä¸»-route" class="headerlink" title="6.4 ParsingSQLRouter ä¸»#route()"></a>6.4 ParsingSQLRouter ä¸»#route()</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLRouteResult <span class="title">route</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   <span class="keyword">final</span> Context context = MetricsContext.start(<span class="string">"Route SQL"</span>);</div><div class="line">   SQLRouteResult result = <span class="keyword">new</span> SQLRouteResult(sqlStatement);</div><div class="line">   <span class="comment">// å¤„ç† æ’å…¥SQL ä¸»é”®å­—æ®µ</span></div><div class="line">   <span class="keyword">if</span> (sqlStatement <span class="keyword">instanceof</span> InsertStatement &amp;&amp; <span class="keyword">null</span> != ((InsertStatement) sqlStatement).getGeneratedKey()) &#123;</div><div class="line">       processGeneratedKey(parameters, (InsertStatement) sqlStatement, result);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ğŸ’ğŸ’ğŸ’ è·¯ç”± ğŸ’ğŸ’ğŸ’</span></div><div class="line">   RoutingResult routingResult = route(parameters, sqlStatement);</div><div class="line">   <span class="comment">// SQLé‡å†™å¼•æ“</span></div><div class="line">   SQLRewriteEngine rewriteEngine = <span class="keyword">new</span> SQLRewriteEngine(shardingRule, logicSQL, sqlStatement);</div><div class="line">   <span class="keyword">boolean</span> isSingleRouting = routingResult.isSingleRouting();</div><div class="line">   <span class="comment">// å¤„ç†åˆ†é¡µ</span></div><div class="line">   <span class="keyword">if</span> (sqlStatement <span class="keyword">instanceof</span> SelectStatement &amp;&amp; <span class="keyword">null</span> != ((SelectStatement) sqlStatement).getLimit()) &#123;</div><div class="line">       processLimit(parameters, (SelectStatement) sqlStatement, isSingleRouting);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// SQL é‡å†™</span></div><div class="line">   SQLBuilder sqlBuilder = rewriteEngine.rewrite(!isSingleRouting);</div><div class="line">   <span class="comment">// ç”Ÿæˆ ExecutionUnit</span></div><div class="line">   <span class="keyword">if</span> (routingResult <span class="keyword">instanceof</span> CartesianRoutingResult) &#123;</div><div class="line">       <span class="keyword">for</span> (CartesianDataSource cartesianDataSource : ((CartesianRoutingResult) routingResult).getRoutingDataSources()) &#123;</div><div class="line">           <span class="keyword">for</span> (CartesianTableReference cartesianTableReference : cartesianDataSource.getRoutingTableReferences()) &#123;</div><div class="line">               result.getExecutionUnits().add(<span class="keyword">new</span> SQLExecutionUnit(cartesianDataSource.getDataSource(), rewriteEngine.generateSQL(cartesianTableReference, sqlBuilder))); <span class="comment">// ç”Ÿæˆ SQL</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">for</span> (TableUnit each : routingResult.getTableUnits().getTableUnits()) &#123;</div><div class="line">           result.getExecutionUnits().add(<span class="keyword">new</span> SQLExecutionUnit(each.getDataSourceName(), rewriteEngine.generateSQL(each, sqlBuilder))); <span class="comment">// ç”Ÿæˆ SQL</span></div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   MetricsContext.stop(context);</div><div class="line">   <span class="comment">// æ‰“å° SQL</span></div><div class="line">   <span class="keyword">if</span> (showSQL) &#123;</div><div class="line">       SQLLogger.logSQL(logicSQL, sqlStatement, result.getExecutionUnits(), parameters);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>RoutingResult routingResult = route(parameters, sqlStatement);</code> <strong>è°ƒç”¨</strong>çš„å°±æ˜¯ä¸Šæ–‡åˆ†æçš„ SimpleRoutingEngineã€ComplexRoutingEngineã€CartesianRoutingEngine çš„ <code>#route()</code> æ–¹æ³•ã€‚</li>
<li><code>#processGeneratedKey()</code>ã€<code>#processLimit()</code>ã€<code>#rewrite()</code>ã€<code>#generateSQL()</code> ç­‰ä¼šæ”¾åœ¨<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL æ”¹å†™ã€‹</a> åˆ†äº«ã€‚</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ç¯‡å¹…æœ‰äº›é•¿ï¼Œå¸Œæœ›èƒ½è®©å¤§å®¶å¯¹<strong>è·¯ç”±</strong>æœ‰æ¯”è¾ƒå®Œæ•´çš„è®¤è¯†ã€‚<br>å¦‚æœå†…å®¹æœ‰é”™è¯¯ï¼Œçƒ¦è¯·æ‚¨æŒ‡æ­£ï¼Œæˆ‘ä¼š<strong>è®¤çœŸ</strong>ä¿®æ”¹ã€‚<br>å¦‚æœè¡¨è¿°ä¸æ¸…æ™°ï¼Œä¸å¤ªç†è§£çš„ï¼Œæ¬¢è¿åŠ æˆ‘å¾®ä¿¡ï¼ˆwangwenbin-serverï¼‰ä¸€èµ·æ¢è®¨ã€‚</p>
<p>è°¢è°¢ä½ æŠ€æœ¯è¿™ä¹ˆå¥½ï¼Œè¿˜<strong>è€å¿ƒ</strong>çœ‹å®Œäº†æœ¬æ–‡ã€‚</p>
<p>å¼ºåˆ¶è·¯ç”± HintManager è®²çš„ç›¸å¯¹ç•¥è¿‡ï¼Œå¯ä»¥çœ‹å¦‚ä¸‹å†…å®¹è¿›ä¸€æ­¥äº†è§£ï¼š</p>
<ol>
<li><a href="http://dangdangdotcom.github.io/sharding-jdbc/02-guide/hint-sharding-value/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£-å¼ºåˆ¶è·¯ç”±ã€‹</a></li>
<li><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/9354031743b63e44cbded5618980ae71a15f0260/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/api/HintManager.java#L41" rel="external nofollow noopener noreferrer" target="_blank">HintManager.java æºç </a></li>
</ol>
<p>åšç€è„¸çš®ï¼Œé“å‹ï¼Œè¾›è‹¦<strong>åˆ†äº«æœ‹å‹åœˆ</strong>å¯å¥½ï¼Ÿï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/stron
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±ï¼ˆä¸€ï¼‰ä¹‹åˆ†åº“åˆ†è¡¨é…ç½®</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-route-1/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-route-1/</id>
    <published>2017-08-03T16:00:00.000Z</published>
    <updated>2017-08-02T14:39:47.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. TableRule</a><ul>
<li><a href="#">2.1 logicTable</a></li>
<li><a href="#">2.2 æ•°æ®å•å…ƒ</a><ul>
<li><a href="#">2.2.1 DataNode</a></li>
<li><a href="#">2.2.2 DynamicDataNode</a></li>
</ul>
</li>
<li><a href="#">2.3 åˆ†åº“/åˆ†è¡¨ç­–ç•¥</a></li>
<li><a href="#">2.4 ä¸»é”®ç”Ÿæˆ</a></li>
</ul>
</li>
<li><a href="#">3. ShardingRule</a><ul>
<li><a href="#">3.1 dataSourceRule</a></li>
<li><a href="#">3.2 tableRules</a></li>
<li><a href="#">3.3 bindingTableRules</a></li>
</ul>
</li>
<li><a href="#">4. ShardingStrategy</a></li>
<li><a href="#">5. ShardingAlgorithm</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>ğŸ˜†<a href="http://www.yunai.me/categories/Sharding-JDBC/?self">ã€ŠSQL è§£æã€‹</a> å·²ç»å‘Šäºæ®µè½ï¼Œæˆ‘ä»¬è¦å¼€å§‹æ–°çš„æ—…ç¨‹ï¼š<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL è·¯ç”±ã€‹</a>ã€‚ç›¸æ¯”<strong>SQLè§£æ</strong>ï¼Œè·¯ç”±ä¼šå®¹æ˜“ç†è§£å¾ˆå¤šï¼Œéª—äººæ˜¯å°ğŸ·ã€‚æ•´ä¸ªç³»åˆ—é¢„è®¡ä¼šæ‹†åˆ†æˆ<strong>ä¸‰å°ç¯‡</strong>æ–‡ç« ï¼š</p>
<ol>
<li>ã€Šåˆ†åº“åˆ†è¡¨é…ç½®ã€‹</li>
<li>ã€Šåˆ†è¡¨åˆ†åº“è·¯ç”±ã€‹</li>
<li>ã€ŠSpringä¸YAMLé…ç½®ã€‹</li>
</ol>
<p>ç¬¬ä¸€ã€äºŒç¯‡ä¼šåœ¨<strong>è¿‘æœŸ</strong>æ›´æ–°ã€‚ç¬¬ä¸‰ç¯‡ä¼šåœ¨<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL æ”¹å†™ã€‹</a>ã€<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL æ‰§è¡Œã€‹</a>å®Œæˆåè¿›è¡Œæ›´æ–°ã€‚ğŸ˜ˆæ”¹å†™å’Œæ‰§è¡Œç›¸å¯¹æœ‰è¶£ã€‚</p>
<p>ğŸ‘¼é“å‹ï¼Œæ‚¨çœ‹ï¼Œé€—æ¯”åšä¸»<strong>â€œå¾ˆæœ‰è§„åˆ’â€</strong>ï¼Œæ˜¯å…³æ³¨å…¬ä¼—å·ä¸€æ³¢<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</a>è¿˜æ˜¯åˆ†äº«æœ‹å‹åœˆã€‚</p>
<hr>
<p>é˜…è¯»æœ¬æ–‡ä¹‹å‰ï¼Œå»ºè®®å·²ç»è¯»è¿‡<strong>å®˜æ–¹</strong>ç›¸å…³æ–‡ç« ï¼š</p>
<ul>
<li><a href="http://dangdangdotcom.github.io/sharding-jdbc/02-guide/concepts/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSharding-JDBC æ ¸å¿ƒæ¦‚å¿µã€‹</a></li>
<li><a href="http://dangdangdotcom.github.io/sharding-jdbc/02-guide/sharding/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSharding-JDBC åˆ†è¡¨åˆ†åº“ã€‹</a></li>
</ul>
<p>åˆ†è¡¨åˆ†åº“é…ç½®ä¼šæ¶‰åŠå¦‚ä¸‹ç±»ï¼š</p>
<ul>
<li>TableRule è¡¨è§„åˆ™é…ç½®å¯¹è±¡</li>
<li>ShardingRule åˆ†åº“åˆ†è¡¨è§„åˆ™é…ç½®å¯¹è±¡</li>
<li>ShardingStrategy åˆ†ç‰‡ç­–ç•¥</li>
<li>ShardingAlgorithm åˆ†ç‰‡ç®—æ³•</li>
</ul>
<p>æˆ‘ä»¬æ¥ä¸€èµ·é€ä¸ªç±»å¾€ä¸‹çœ‹ã€‚</p>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1 id="2-TableRule"><a href="#2-TableRule" class="headerlink" title="2. TableRule"></a>2. TableRule</h1><p>TableRuleï¼Œè¡¨è§„åˆ™é…ç½®å¯¹è±¡ï¼Œå†…åµŒ TableRuleBuilder å¯¹è±¡è¿›è¡Œåˆ›å»ºã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_04/01.png" alt=""></p>
<h2 id="2-1-logicTable"><a href="#2-1-logicTable" class="headerlink" title="2.1 logicTable"></a>2.1 logicTable</h2><blockquote>
<p>æ•°æ®åˆ†ç‰‡çš„<strong>é€»è¾‘è¡¨</strong>ï¼Œå¯¹äºæ°´å¹³æ‹†åˆ†çš„æ•°æ®åº“(è¡¨)ï¼ŒåŒä¸€ç±»è¡¨çš„æ€»ç§°ã€‚<br>ä¾‹ï¼šè®¢å•æ•°æ®æ ¹æ®ä¸»é”®å°¾æ•°æ‹†åˆ†ä¸º10å¼ è¡¨,åˆ†åˆ«æ˜¯t_order_0åˆ°t_order_9ï¼Œä»–ä»¬çš„é€»è¾‘è¡¨åä¸ºt_orderã€‚</p>
</blockquote>
<h2 id="2-2-æ•°æ®å•å…ƒ"><a href="#2-2-æ•°æ®å•å…ƒ" class="headerlink" title="2.2 æ•°æ®å•å…ƒ"></a>2.2 æ•°æ®å•å…ƒ</h2><p>Sharding-JDBC æœ‰ä¸¤ç§ç±»å‹<strong>æ•°æ®å•å…ƒ</strong>ï¼š</p>
<ul>
<li>DataNode ï¼š<strong>é™æ€</strong>åˆ†åº“åˆ†è¡¨æ•°æ®å•å…ƒ</li>
</ul>
<blockquote>
<p>æ•°æ®åˆ†ç‰‡çš„æœ€å°å•å…ƒï¼Œç”±æ•°æ®æºåç§°å’Œæ•°æ®è¡¨ç»„æˆã€‚<br>ä¾‹ï¼šds_1.t_order_0ã€‚é…ç½®æ—¶é»˜è®¤å„ä¸ªåˆ†ç‰‡æ•°æ®åº“çš„è¡¨ç»“æ„å‡ç›¸åŒï¼Œç›´æ¥é…ç½®é€»è¾‘è¡¨å’ŒçœŸå®è¡¨å¯¹åº”å…³ç³»å³å¯ã€‚<br>å¦‚æœå„æ•°æ®åº“çš„è¡¨ç»“æœä¸åŒï¼Œå¯ä½¿ç”¨ds.actual_tableé…ç½®ã€‚</p>
</blockquote>
<ul>
<li>DynamicDataNode ï¼š<strong>åŠ¨æ€</strong>è¡¨çš„åˆ†åº“åˆ†è¡¨æ•°æ®å•å…ƒ</li>
</ul>
<blockquote>
<p>é€»è¾‘è¡¨å’ŒçœŸå®è¡¨ä¸ä¸€å®šéœ€è¦åœ¨é…ç½®è§„åˆ™ä¸­é™æ€é…ç½®ã€‚<br>æ¯”å¦‚æŒ‰ç…§æ—¥æœŸåˆ†ç‰‡çš„åœºæ™¯ï¼ŒçœŸå®è¡¨çš„åç§°éšç€æ—¶é—´çš„æ¨ç§»ä¼šäº§ç”Ÿå˜åŒ–ã€‚<br>æ­¤ç±»éœ€æ±‚Sharding-JDBCæ˜¯æ”¯æŒçš„ï¼Œä¸è¿‡ç›®å‰é…ç½®å¹¶ä¸å‹å¥½ï¼Œä¼šåœ¨æ–°ç‰ˆæœ¬ä¸­æå‡ã€‚</p>
</blockquote>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_04/02.png" alt=""></p>
<p>TableRuleBuilder è°ƒç”¨ <code>#build()</code> æ–¹æ³•åˆ›å»º TableRuleã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TableRuleBuilder.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TableRuleBuilder</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> TableRule <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">       KeyGenerator keyGenerator = <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> != generateKeyColumn &amp;&amp; <span class="keyword">null</span> != keyGeneratorClass) &#123;</div><div class="line">           keyGenerator = KeyGeneratorFactory.createKeyGenerator(keyGeneratorClass);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> TableRule(logicTable, dynamic, actualTables, dataSourceRule, dataSourceNames, databaseShardingStrategy, tableShardingStrategy, generateKeyColumn, keyGenerator);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// TableRule.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">TableRule</span><span class="params">(<span class="keyword">final</span> String logicTable, <span class="keyword">final</span> <span class="keyword">boolean</span> dynamic, <span class="keyword">final</span> List&lt;String&gt; actualTables, <span class="keyword">final</span> DataSourceRule dataSourceRule, <span class="keyword">final</span> Collection&lt;String&gt; dataSourceNames,</span></span></div><div class="line">                <span class="keyword">final</span> DatabaseShardingStrategy databaseShardingStrategy, <span class="keyword">final</span> TableShardingStrategy tableShardingStrategy,</div><div class="line">                <span class="keyword">final</span> String generateKeyColumn, <span class="keyword">final</span> KeyGenerator keyGenerator) &#123;</div><div class="line">   Preconditions.checkNotNull(logicTable);</div><div class="line">   <span class="keyword">this</span>.logicTable = logicTable;</div><div class="line">   <span class="keyword">this</span>.dynamic = dynamic;</div><div class="line">   <span class="keyword">this</span>.databaseShardingStrategy = databaseShardingStrategy;</div><div class="line">   <span class="keyword">this</span>.tableShardingStrategy = tableShardingStrategy;</div><div class="line">   <span class="keyword">if</span> (dynamic) &#123; <span class="comment">// åŠ¨æ€è¡¨çš„åˆ†åº“åˆ†è¡¨æ•°æ®å•å…ƒ</span></div><div class="line">       Preconditions.checkNotNull(dataSourceRule);</div><div class="line">       <span class="keyword">this</span>.actualTables = generateDataNodes(dataSourceRule);</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">null</span> == actualTables || actualTables.isEmpty()) &#123; <span class="comment">// é™æ€è¡¨çš„åˆ†åº“åˆ†è¡¨æ•°æ®å•å…ƒ</span></div><div class="line">       Preconditions.checkNotNull(dataSourceRule);</div><div class="line">       <span class="keyword">this</span>.actualTables = generateDataNodes(Collections.singletonList(logicTable), dataSourceRule, dataSourceNames);</div><div class="line">   &#125; <span class="keyword">else</span> &#123; <span class="comment">// é™æ€è¡¨çš„åˆ†åº“åˆ†è¡¨æ•°æ®å•å…ƒ</span></div><div class="line">       <span class="keyword">this</span>.actualTables = generateDataNodes(actualTables, dataSourceRule, dataSourceNames);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">this</span>.generateKeyColumn = generateKeyColumn;</div><div class="line">   <span class="keyword">this</span>.keyGenerator = keyGenerator;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-2-1-DataNode"><a href="#2-2-1-DataNode" class="headerlink" title="2.2.1 DataNode"></a>2.2.1 DataNode</h3><p>å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨<strong>é™æ€</strong>åˆ†åº“åˆ†è¡¨æ•°æ®å•å…ƒï¼Œå³ DataNodeã€‚å¦‚ä¸Šæ–‡æ³¨é‡Šå¤„ <code>é™æ€è¡¨çš„åˆ†åº“åˆ†è¡¨æ•°æ®å•å…ƒ</code> å¤„æ‰€è§ï¼Œåˆ†æˆ<strong>ä¸¤</strong>ç§åˆ¤æ–­ï¼Œå®è´¨ä¸Šç¬¬ä¸€ç§æ˜¯å°† <code>logicTable</code> ä½œä¸º <code>actualTable</code>ï¼Œå³åœ¨<strong>åº“</strong>é‡Œä¸è¿›è¡Œåˆ†è¡¨ï¼Œæ˜¯ç¬¬äºŒç§çš„ä¸€ç§ç‰¹ä¾‹ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹ <code>#generateDataNodes()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TableRule.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ç”Ÿæˆé™æ€æ•°æ®åˆ†ç‰‡èŠ‚ç‚¹</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> actualTables çœŸå®è¡¨</div><div class="line">* <span class="doctag">@param</span> dataSourceRule æ•°æ®æºé…ç½®å¯¹è±¡</div><div class="line">* <span class="doctag">@param</span> actualDataSourceNames æ•°æ®æºåé›†åˆ</div><div class="line">* <span class="doctag">@return</span> é™æ€æ•°æ®åˆ†ç‰‡èŠ‚ç‚¹</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> List&lt;DataNode&gt; <span class="title">generateDataNodes</span><span class="params">(<span class="keyword">final</span> List&lt;String&gt; actualTables, <span class="keyword">final</span> DataSourceRule dataSourceRule, <span class="keyword">final</span> Collection&lt;String&gt; actualDataSourceNames)</span> </span>&#123;</div><div class="line">   Collection&lt;String&gt; dataSourceNames = getDataSourceNames(dataSourceRule, actualDataSourceNames);</div><div class="line">   List&lt;DataNode&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(actualTables.size() * (dataSourceNames.isEmpty() ? <span class="number">1</span> : dataSourceNames.size()));</div><div class="line">   <span class="keyword">for</span> (String actualTable : actualTables) &#123;</div><div class="line">       <span class="keyword">if</span> (DataNode.isValidDataNode(actualTable)) &#123; <span class="comment">// å½“ actualTable ä¸º $&#123;dataSourceName&#125;.$&#123;tableName&#125; æ—¶</span></div><div class="line">           result.add(<span class="keyword">new</span> DataNode(actualTable));</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">for</span> (String dataSourceName : dataSourceNames) &#123;</div><div class="line">               result.add(<span class="keyword">new</span> DataNode(dataSourceName, actualTable));</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* æ ¹æ® æ•°æ®æºé…ç½®å¯¹è±¡ å’Œ æ•°æ®æºåé›†åˆ è·å¾— æœ€ç»ˆçš„æ•°æ®æºåé›†åˆ</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> dataSourceRule æ•°æ®æºé…ç½®å¯¹è±¡</div><div class="line">* <span class="doctag">@param</span> actualDataSourceNames æ•°æ®æºåé›†åˆ</div><div class="line">* <span class="doctag">@return</span> æœ€ç»ˆçš„æ•°æ®æºåé›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;String&gt; <span class="title">getDataSourceNames</span><span class="params">(<span class="keyword">final</span> DataSourceRule dataSourceRule, <span class="keyword">final</span> Collection&lt;String&gt; actualDataSourceNames)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> == dataSourceRule) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> == actualDataSourceNames || actualDataSourceNames.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span> dataSourceRule.getDataSourceNames();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> actualDataSourceNames;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ç¬¬ä¸€ç§æƒ…å†µï¼Œ<strong>è‡ªå®šä¹‰åˆ†å¸ƒ</strong>ã€‚<code>actualTable</code> ä¸º <code>${dataSourceName}.${tableName}</code> æ—¶ï¼Œå³å·²ç»æ˜ç¡®çœŸå®è¡¨æ‰€åœ¨æ•°æ®æºã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">TableRule.builder(<span class="string">"t_order"</span>).actualTables(Arrays.asList(<span class="string">"db0.t_order_0"</span>, <span class="string">"db1.t_order_1"</span>, <span class="string">"db1.t_order_2"</span>))</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">db0</div><div class="line">  â””â”€â”€ t_order_0 </div><div class="line">db1</div><div class="line">  â”œâ”€â”€ t_order_1</div><div class="line">  â””â”€â”€ t_order_2</div></pre></td></tr></table></figure>
<ul>
<li>ç¬¬äºŒç§æƒ…å†µï¼Œ<strong>å‡åŒ€åˆ†å¸ƒ</strong>ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">TableRule.builder(<span class="string">"t_order"</span>).actualTables(Arrays.asList(<span class="string">"t_order_0"</span>, <span class="string">"t_order_1"</span>))</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">db0</div><div class="line">  â”œâ”€â”€ t_order_0 </div><div class="line">  â””â”€â”€ t_order_1 </div><div class="line">db1</div><div class="line">  â”œâ”€â”€ t_order_0 </div><div class="line">  â””â”€â”€ t_order_1</div></pre></td></tr></table></figure>
<p><code>#getDataSourceNames()</code> ä½¿ç”¨ <code>dataSourceRule</code> å’Œ <code>actualDataSourceNames</code> è·å–æ•°æ®æºçš„é€»è¾‘çœ‹èµ·æ¥æœ‰ç§â€œè¯¡å¼‚â€ã€‚<strong>å®é™… TableRuleBuilder åˆ›å»º TableRule æ—¶ï¼Œä½¿ç”¨ <code>dataSourceRule</code> è€Œä¸è¦ä½¿ç”¨ <code>actualDataSourceNames</code></strong>ã€‚</p>
<h3 id="2-2-2-DynamicDataNode"><a href="#2-2-2-DynamicDataNode" class="headerlink" title="2.2.2 DynamicDataNode"></a>2.2.2 DynamicDataNode</h3><p>å°‘æ•°ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨<strong>åŠ¨æ€</strong>åˆ†åº“åˆ†è¡¨æ•°æ®å•å…ƒï¼Œå³ DynamicDataNodeã€‚<br><strong>é€šè¿‡ <code>dynamic=true</code> å±æ€§é…ç½®</strong>ã€‚ç”Ÿæˆä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TableRule.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> List&lt;DataNode&gt; <span class="title">generateDataNodes</span><span class="params">(<span class="keyword">final</span> DataSourceRule dataSourceRule)</span> </span>&#123;</div><div class="line">   Collection&lt;String&gt; dataSourceNames = dataSourceRule.getDataSourceNames();</div><div class="line">   List&lt;DataNode&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(dataSourceNames.size());</div><div class="line">   <span class="keyword">for</span> (String each : dataSourceNames) &#123;</div><div class="line">       result.add(<span class="keyword">new</span> DynamicDataNode(each));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ğŸ˜‚ ä»ä»£ç ä¸Šçœ‹ï¼Œè²Œä¼¼å’Œ<strong>åŠ¨æ€</strong>åˆ†åº“åˆ†è¡¨æ•°æ®å•å…ƒæ²¡ä¸€æ¯›é’±å…³ç³»ï¼Ÿï¼åˆ«æ‰é¸¡ï¼Œç­”æ¡ˆåœ¨<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šåˆ†è¡¨åˆ†åº“è·¯ç”±ã€‹</a> ä¸Šã€‚</p>
<h2 id="2-3-åˆ†åº“-åˆ†è¡¨ç­–ç•¥"><a href="#2-3-åˆ†åº“-åˆ†è¡¨ç­–ç•¥" class="headerlink" title="2.3 åˆ†åº“/åˆ†è¡¨ç­–ç•¥"></a>2.3 åˆ†åº“/åˆ†è¡¨ç­–ç•¥</h2><ul>
<li><code>databaseShardingStrategy</code> ï¼šåˆ†åº“ç­–ç•¥</li>
<li><code>tableShardingStrategy</code> ï¼šåˆ†è¡¨ç­–ç•¥</li>
</ul>
<p>å½“åˆ†åº“/åˆ†è¡¨ç­–ç•¥ä¸é…ç½®æ—¶ï¼Œä½¿ç”¨ ShardingRule é…ç½®çš„åˆ†åº“/åˆ†è¡¨ç­–ç•¥ã€‚</p>
<h2 id="2-4-ä¸»é”®ç”Ÿæˆ"><a href="#2-4-ä¸»é”®ç”Ÿæˆ" class="headerlink" title="2.4 ä¸»é”®ç”Ÿæˆ"></a>2.4 ä¸»é”®ç”Ÿæˆ</h2><ul>
<li><code>generateKeyColumn</code> ï¼šä¸»é”®å­—æ®µ</li>
<li><code>keyGenerator</code> ï¼šä¸»é”®ç”Ÿæˆå™¨</li>
</ul>
<p>å½“ä¸»é”®ç”Ÿæˆå™¨ä¸é…ç½®æ—¶ï¼Œä½¿ç”¨ ShardingRule é…ç½®çš„ä¸»é”®ç”Ÿæˆå™¨ã€‚</p>
<h1 id="3-ShardingRule"><a href="#3-ShardingRule" class="headerlink" title="3. ShardingRule"></a>3. ShardingRule</h1><p>ShardingRuleï¼Œåˆ†åº“åˆ†è¡¨è§„åˆ™é…ç½®å¯¹è±¡ï¼Œå†…åµŒ ShardingRuleBuilder å¯¹è±¡è¿›è¡Œåˆ›å»ºã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_04/03.png" alt=""></p>
<p>å…¶ä¸­ databaseShardingStrategyã€tableShardingStrategyã€keyGeneratorã€defaultGenerator å’Œ TableRule å±æ€§é‡å¤ï¼Œç”¨äºå½“ TableRule æœªé…ç½®å¯¹åº”å±æ€§ï¼Œä½¿ç”¨ ShardingRule æä¾›çš„è¯¥å±æ€§ã€‚</p>
<h2 id="3-1-dataSourceRule"><a href="#3-1-dataSourceRule" class="headerlink" title="3.1 dataSourceRule"></a>3.1 dataSourceRule</h2><p><code>dataSourceRule</code>ï¼Œæ•°æ®æºé…ç½®å¯¹è±¡ã€‚ShardingRule éœ€è¦æ•°æ®æºé…ç½®æ­£ç¡®ã€‚è¿™ç‚¹å’Œ TableRule æ˜¯ä¸åŒçš„ã€‚TableRule å¯¹ <code>dataSourceRule</code> <strong>åªä½¿ç”¨æ•°æ®æºåå­—ï¼Œæœ€ç»ˆæ‰§è¡ŒSQL ä½¿ç”¨æ•°æ®æºåå­—ä» ShardingRule è·å–æ•°æ®æºè¿æ¥</strong>ã€‚å¤§å®¶å¯ä»¥å›åˆ°æœ¬æ–‡ã€2.2.1 DataNodeã€‘ç»†çœ‹ä¸‹ DataNode çš„ç”Ÿæˆè¿‡ç¨‹ã€‚</p>
<h2 id="3-2-tableRules"><a href="#3-2-tableRules" class="headerlink" title="3.2 tableRules"></a>3.2 tableRules</h2><p><code>tableRules</code>ï¼Œè¡¨è§„åˆ™é…ç½®å¯¹è±¡<strong>é›†åˆ</strong>ã€‚</p>
<h2 id="3-3-bindingTableRules"><a href="#3-3-bindingTableRules" class="headerlink" title="3.3 bindingTableRules"></a>3.3 bindingTableRules</h2><blockquote>
<p>æŒ‡åœ¨ä»»ä½•åœºæ™¯ä¸‹åˆ†ç‰‡è§„åˆ™å‡ä¸€è‡´çš„ä¸»è¡¨å’Œå­è¡¨ã€‚<br>ä¾‹ï¼šè®¢å•è¡¨å’Œè®¢å•é¡¹è¡¨ï¼Œå‡æŒ‰ç…§è®¢å•IDåˆ†ç‰‡ï¼Œåˆ™æ­¤ä¸¤å¼ è¡¨äº’ä¸ºBindingTableå…³ç³»ã€‚<br>BindingTableå…³ç³»çš„å¤šè¡¨å…³è”æŸ¥è¯¢ä¸ä¼šå‡ºç°ç¬›å¡å°”ç§¯å…³è”ï¼Œå…³è”æŸ¥è¯¢æ•ˆç‡å°†å¤§å¤§æå‡ã€‚</p>
</blockquote>
<p>ğŸ˜ˆ è¿™ä¹ˆè¯´ï¼Œå¯èƒ½ä¸å¤ªå®¹æ˜“ç†è§£ã€‚<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šåˆ†è¡¨åˆ†åº“è·¯ç”±ã€‹</a>ï¼Œæˆ‘ä»¬åœ¨æºç çš„åŸºç¡€ä¸Šï¼Œå¥½å¥½ç†è§£ä¸‹ã€‚<strong>éå¸¸é‡è¦ï¼Œç‰¹åˆ«æ˜¯æ€§èƒ½ä¼˜åŒ–ä¸Šé¢</strong>ã€‚</p>
<h1 id="4-ShardingStrategy"><a href="#4-ShardingStrategy" class="headerlink" title="4. ShardingStrategy"></a>4. ShardingStrategy</h1><p>ShardingStrategyï¼Œåˆ†ç‰‡ç­–ç•¥ã€‚</p>
<ul>
<li>é’ˆå¯¹åˆ†åº“ã€åˆ†è¡¨æœ‰ä¸¤ä¸ªå­ç±»ã€‚</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_04/04.png" alt=""></p>
<ul>
<li>DatabaseShardingStrategyï¼Œä½¿ç”¨<strong>åˆ†åº“</strong>ç®—æ³•è¿›è¡Œåˆ†ç‰‡</li>
<li>TableShardingStrategyï¼Œä½¿ç”¨<strong>åˆ†è¡¨</strong>ç®—æ³•è¿›è¡Œåˆ†ç‰‡</li>
</ul>
<p><a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šåˆ†è¡¨åˆ†åº“è·¯ç”±ã€‹</a> ä¼šè¿›ä¸€æ­¥è¯´æ˜ã€‚</p>
<h1 id="5-ShardingAlgorithm"><a href="#5-ShardingAlgorithm" class="headerlink" title="5. ShardingAlgorithm"></a>5. ShardingAlgorithm</h1><p>ShardingAlgorithmï¼Œåˆ†ç‰‡ç®—æ³•ã€‚</p>
<ul>
<li>é’ˆå¯¹åˆ†åº“ã€åˆ†è¡¨æœ‰ä¸¤ä¸ªå­<strong>æ¥å£</strong>ã€‚</li>
<li>é’ˆå¯¹<strong>åˆ†ç‰‡é”®</strong>æ•°é‡åˆ†æˆï¼šæ— åˆ†ç‰‡é”®ç®—æ³•ã€å•ç‰‡é”®ç®—æ³•ã€å¤šç‰‡é”®ç®—æ³•ã€‚</li>
</ul>
<p><strong>å…¶ä¸­ NoneKeyDatabaseShardingAlgorithmã€NoneTableShardingAlgorithm ä¸º ShardingRule åœ¨æœªè®¾ç½®åˆ†åº“ã€åˆ†è¡¨ç®—æ³•çš„é»˜è®¤å€¼</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingRule.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ShardingRule</span><span class="params">(</span></span></div><div class="line">       <span class="keyword">final</span> DataSourceRule dataSourceRule, <span class="keyword">final</span> Collection&lt;TableRule&gt; tableRules, <span class="keyword">final</span> Collection&lt;BindingTableRule&gt; bindingTableRules,</div><div class="line">       <span class="keyword">final</span> DatabaseShardingStrategy databaseShardingStrategy, <span class="keyword">final</span> TableShardingStrategy tableShardingStrategy, <span class="keyword">final</span> KeyGenerator keyGenerator) &#123;</div><div class="line">   <span class="comment">// ... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">   <span class="keyword">this</span>.databaseShardingStrategy = <span class="keyword">null</span> == databaseShardingStrategy ? <span class="keyword">new</span> DatabaseShardingStrategy(</div><div class="line">           Collections.&lt;String&gt;emptyList(), <span class="keyword">new</span> NoneDatabaseShardingAlgorithm()) : databaseShardingStrategy;</div><div class="line">   <span class="keyword">this</span>.tableShardingStrategy = <span class="keyword">null</span> == tableShardingStrategy ? <span class="keyword">new</span> TableShardingStrategy(</div><div class="line">           Collections.&lt;String&gt;emptyList(), <span class="keyword">new</span> NoneTableShardingAlgorithm()) : tableShardingStrategy;</div><div class="line">   <span class="comment">// ... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šåˆ†è¡¨åˆ†åº“è·¯ç”±ã€‹</a> ä¼šè¿›ä¸€æ­¥è¯´æ˜ã€‚</p>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æœ¬æ–‡çœ‹ä¼¼åœ¨æ°´æ›´ï¼Œå®æ˜¯ä¸º<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šåˆ†è¡¨åˆ†åº“è·¯ç”±ã€‹</a>åšé“ºå«ï¼ˆä¸€é˜µè„¸çº¢ğŸ˜³ï¼‰ã€‚</p>
<p>Butï¼Œæ— è®ºæ€ä¹ˆè¯´ï¼Œé“å‹ï¼Œæˆ‘åšäº†æ–°çš„å…³æ³¨äºŒç»´ç ï¼ˆæ„Ÿè°¢çŒ«ğŸ±å…ˆç”Ÿï¼‰ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥æ¨èä¸€æ³¢å…¬ä¼—å·ç»™åŸºä½¬ã€‚</p>
<p>æ©ï¼Œç»§ç»­æ›´æ–°ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/stron
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆå…­ï¼‰ä¹‹åˆ é™¤SQL</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-parse-6/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-parse-6/</id>
    <published>2017-08-01T16:00:00.000Z</published>
    <updated>2017-07-31T12:30:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. DeleteStatement</a></li>
<li><a href="#">3. #parse()</a><ul>
<li><a href="#">3.1 #skipBetweenDeleteAndTable()</a></li>
<li><a href="#">3.2 #parseSingleTable()</a></li>
<li><a href="#">3.3 #parseWhere()</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡å‰ç½®é˜…è¯»ï¼š</p>
<ul>
<li><a href="http://www.yunai.me/Sharding-JDBC/sql-parse-1/?self">ã€ŠSQL è§£æï¼ˆä¸€ï¼‰ä¹‹è¯æ³•è§£æã€‹</a></li>
<li><a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹</a></li>
</ul>
<p>æœ¬æ–‡åˆ†äº«<strong>åˆ é™¤SQLè§£æ</strong>çš„æºç å®ç°ã€‚</p>
<p>ğŸ™‚ å¦‚æœä½ å·²ç»ç†è§£<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-3/?self">ã€ŠSQL è§£æï¼ˆä¸‰ï¼‰ä¹‹æŸ¥è¯¢SQLã€‹</a>ï¼Œé‚£æœ¬æ–‡ä¼šæ˜¯ä¸€ç¯‡æ°´æ–‡ï¼Œå½“æˆä¸€ç§æ”¾æ¾å§ã€‚è¿˜æ˜¯è·Ÿå‰æ–‡ä¸€æ ·ï¼Œä»¥ MySQL ä¸¾ä¾‹å­ã€‚æˆ‘ä»¬æ¥ä¸€èµ·çœ‹çœ‹ MySQLDeleteParserã€‚</p>
<p>MySQL DELETE è¯­æ³•ä¸€å…±æœ‰ 2 ç§ ï¼š</p>
<ul>
<li>ç¬¬ä¸€ç§ï¼š<strong>Single-table syntax</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">DELETE</span> [<span class="keyword">LOW_PRIORITY</span>] [<span class="keyword">QUICK</span>] [<span class="keyword">IGNORE</span>] <span class="keyword">FROM</span> tbl_name</div><div class="line">    [<span class="keyword">PARTITION</span> (partition_name,...)]</div><div class="line">    [<span class="keyword">WHERE</span> where_condition]</div><div class="line">    [<span class="keyword">ORDER</span> <span class="keyword">BY</span> ...]</div><div class="line">    [<span class="keyword">LIMIT</span> <span class="keyword">row_count</span>]</div></pre></td></tr></table></figure>
<ul>
<li>ç¬¬äºŒç§ï¼š<strong>Multiple-table syntax</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">DELETE</span> [<span class="keyword">LOW_PRIORITY</span>] [<span class="keyword">QUICK</span>] [<span class="keyword">IGNORE</span>]</div><div class="line">    tbl_name[.*] [, tbl_name[.*]] ...</div><div class="line">    <span class="keyword">FROM</span> table_references</div><div class="line">    [<span class="keyword">WHERE</span> where_condition]</div><div class="line">    </div><div class="line">ã€<span class="keyword">OR</span>ã€‘</div><div class="line"></div><div class="line"><span class="keyword">DELETE</span> [<span class="keyword">LOW_PRIORITY</span>] [<span class="keyword">QUICK</span>] [<span class="keyword">IGNORE</span>]</div><div class="line">    <span class="keyword">FROM</span> tbl_name[.*] [, tbl_name[.*]] ...</div><div class="line">    <span class="keyword">USING</span> table_references</div><div class="line">    [<span class="keyword">WHERE</span> where_condition]</div></pre></td></tr></table></figure>
<p>Sharding-JDBC ç›®å‰ä»…æ”¯æŒç¬¬ä¸€ç§ã€‚ä¸šåŠ¡åœºæ™¯ä¸Šä½¿ç”¨ç¬¬äºŒç§çš„å¾ˆå°‘å¾ˆå°‘ã€‚</p>
<p>Sharding-JDBC æ›´æ–°SQLè§£æä¸»æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_02/01.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractDeleteParser.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> DeleteStatement <span class="title">parse</span><span class="params">()</span> </span>&#123;</div><div class="line">   sqlParser.getLexer().nextToken(); <span class="comment">// è·³è¿‡ DELETE</span></div><div class="line">   skipBetweenDeleteAndTable(); <span class="comment">// // è·³è¿‡å…³é”®å­—ï¼Œä¾‹å¦‚ï¼šMYSQL é‡Œçš„ LOW_PRIORITYã€IGNORE å’Œ FROM</span></div><div class="line">   sqlParser.parseSingleTable(deleteStatement); <span class="comment">// è§£æè¡¨</span></div><div class="line">   sqlParser.skipUntil(DefaultKeyword.WHERE); <span class="comment">// è·³åˆ° WHERE</span></div><div class="line">   sqlParser.parseWhere(deleteStatement); <span class="comment">// è§£æ WHERE</span></div><div class="line">   <span class="keyword">return</span> deleteStatement;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1 id="2-DeleteStatement"><a href="#2-DeleteStatement" class="headerlink" title="2. DeleteStatement"></a>2. DeleteStatement</h1><p>åˆ é™¤SQL è§£æç»“æœã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UpdateStatement</span> <span class="keyword">extends</span> <span class="title">AbstractSQLStatement</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ğŸ˜ˆ å¯¹ï¼Œæ²¡æœ‰å…¶ä»–å±æ€§ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>DELETE IGNORE FROM t_user WHERE user_id = ?</code> çš„<strong>è§£æç»“æœ</strong>ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_02/02.png" alt=""></p>
<h1 id="3-parse"><a href="#3-parse" class="headerlink" title="3. #parse()"></a>3. #parse()</h1><h2 id="3-1-skipBetweenDeleteAndTable"><a href="#3-1-skipBetweenDeleteAndTable" class="headerlink" title="3.1 #skipBetweenDeleteAndTable()"></a>3.1 #skipBetweenDeleteAndTable()</h2><p>åœ¨ <code>DELETE</code> å’Œ è¡¨å ä¹‹é—´æœ‰äº›è¯æ³•ï¼Œå¯¹ SQL è·¯ç”±å’Œæ”¹å†™æ— å½±å“ï¼Œè¿›è¡Œè·³è¿‡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MySQLDeleteParser.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">skipBetweenDeleteAndTable</span><span class="params">()</span> </span>&#123;</div><div class="line">   getSqlParser().skipAll(MySQLKeyword.LOW_PRIORITY, MySQLKeyword.QUICK, MySQLKeyword.IGNORE);</div><div class="line">   getSqlParser().skipIfEqual(DefaultKeyword.FROM);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// OracleDeleteParser.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">skipBetweenDeleteAndTable</span><span class="params">()</span> </span>&#123;</div><div class="line">   getSqlParser().skipIfEqual(DefaultKeyword.FROM);</div><div class="line">   getSqlParser().skipIfEqual(OracleKeyword.ONLY);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-2-parseSingleTable"><a href="#3-2-parseSingleTable" class="headerlink" title="3.2 #parseSingleTable()"></a>3.2 #parseSingleTable()</h2><p>è§£æ<strong>è¡¨</strong>ï¼Œè¯·çœ‹<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹çš„ <code>#parseSingleTable()</code> å°èŠ‚</a>ã€‚</p>
<h2 id="3-3-parseWhere"><a href="#3-3-parseWhere" class="headerlink" title="3.3 #parseWhere()"></a>3.3 #parseWhere()</h2><p>è§£æ WHERE æ¡ä»¶ã€‚è§£æä»£ç ï¼š<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹çš„#parseWhere()å°èŠ‚</a>ã€‚</p>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>é“å‹ï¼Œå¸®æˆ‘åˆ†äº«ä¸€æ³¢æ€ä¹ˆæ ·ï¼Ÿ</p>
<p><strong>åé¢ SQL è·¯ç”±å’Œæ”¹å†™ä¼šæ›´åŠ æœ‰è¶£å“Ÿï¼</strong></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/stron
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆäº”ï¼‰ä¹‹æ›´æ–°SQL</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-parse-5/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-parse-5/</id>
    <published>2017-07-30T16:00:00.000Z</published>
    <updated>2017-07-31T12:30:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. UpdateStatement</a></li>
<li><a href="#">3. #parse()</a><ul>
<li><a href="#">3.1 #skipBetweenUpdateAndTable()</a></li>
<li><a href="#">3.2 #parseSingleTable()</a></li>
<li><a href="#">3.3 #parseSetItems()</a></li>
<li><a href="#">3.4 #parseWhere()</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡å‰ç½®é˜…è¯»ï¼š</p>
<ul>
<li><a href="http://www.yunai.me/Sharding-JDBC/sql-parse-1/?self">ã€ŠSQL è§£æï¼ˆä¸€ï¼‰ä¹‹è¯æ³•è§£æã€‹</a></li>
<li><a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹</a></li>
</ul>
<p>æœ¬æ–‡åˆ†äº«<strong>æ›´æ–°SQLè§£æ</strong>çš„æºç å®ç°ã€‚</p>
<p>æ›´æ–°SQLè§£ææ¯”æŸ¥è¯¢SQLè§£æå¤æ‚åº¦ä½çš„å¤šçš„å¤šã€‚ä¸åŒæ•°æ®åº“åœ¨æ’å…¥SQLè¯­æ³•ä¸Šä¹Ÿç»Ÿä¸€çš„å¤šã€‚<strong>æœ¬æ–‡åˆ†äº« MySQL æ›´æ–°SQLè§£æå™¨ MySQLUpdateParser</strong>ã€‚</p>
<p>MySQL UPDATE è¯­æ³•ä¸€å…±æœ‰ 2 ç§ ï¼š</p>
<ul>
<li>ç¬¬ä¸€ç§ï¼š<strong>Single-table syntax</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">UPDATE</span> [<span class="keyword">LOW_PRIORITY</span>] [<span class="keyword">IGNORE</span>] table_reference</div><div class="line">    <span class="keyword">SET</span> col_name1=&#123;expr1|<span class="keyword">DEFAULT</span>&#125; [, col_name2=&#123;expr2|<span class="keyword">DEFAULT</span>&#125;] ...</div><div class="line">    [<span class="keyword">WHERE</span> where_condition]</div><div class="line">    [<span class="keyword">ORDER</span> <span class="keyword">BY</span> ...]</div><div class="line">    [<span class="keyword">LIMIT</span> <span class="keyword">row_count</span>]</div></pre></td></tr></table></figure>
<ul>
<li>ç¬¬äºŒç§ï¼š<strong>Multiple-table syntax</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">UPDATE</span> [<span class="keyword">LOW_PRIORITY</span>] [<span class="keyword">IGNORE</span>] table_references</div><div class="line">    <span class="keyword">SET</span> col_name1=&#123;expr1|<span class="keyword">DEFAULT</span>&#125; [, col_name2=&#123;expr2|<span class="keyword">DEFAULT</span>&#125;] ...</div><div class="line">    [<span class="keyword">WHERE</span> where_condition]</div></pre></td></tr></table></figure>
<p>Sharding-JDBC ç›®å‰ä»…æ”¯æŒç¬¬ä¸€ç§ã€‚ä¸šåŠ¡åœºæ™¯ä¸Šä½¿ç”¨ç¬¬äºŒç§çš„å¾ˆå°‘å¾ˆå°‘ã€‚</p>
<p>Sharding-JDBC æ›´æ–°SQLè§£æä¸»æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_31/01.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractUpdateParser.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> UpdateStatement <span class="title">parse</span><span class="params">()</span> </span>&#123;</div><div class="line">   sqlParser.getLexer().nextToken(); <span class="comment">// è·³è¿‡ UPDATE</span></div><div class="line">   skipBetweenUpdateAndTable(); <span class="comment">// è·³è¿‡å…³é”®å­—ï¼Œä¾‹å¦‚ï¼šMYSQL é‡Œçš„ LOW_PRIORITYã€IGNORE</span></div><div class="line">   sqlParser.parseSingleTable(updateStatement); <span class="comment">// è§£æè¡¨</span></div><div class="line">   parseSetItems(); <span class="comment">// è§£æ SET</span></div><div class="line">   sqlParser.skipUntil(DefaultKeyword.WHERE);</div><div class="line">   sqlParser.setParametersIndex(parametersIndex);</div><div class="line">   sqlParser.parseWhere(updateStatement);</div><div class="line">   <span class="keyword">return</span> updateStatement; <span class="comment">// è§£æ WHERE</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1 id="2-UpdateStatement"><a href="#2-UpdateStatement" class="headerlink" title="2. UpdateStatement"></a>2. UpdateStatement</h1><p>æ›´æ–°SQL è§£æç»“æœã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UpdateStatement</span> <span class="keyword">extends</span> <span class="title">AbstractSQLStatement</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ğŸ˜ˆ å¯¹ï¼Œæ²¡æœ‰å…¶ä»–å±æ€§ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>UPDATE t_user SET nickname = ?, age = ? WHERE user_id = ?</code> çš„<strong>è§£æç»“æœ</strong>ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_31/02.png" alt=""></p>
<h1 id="3-parse"><a href="#3-parse" class="headerlink" title="3. #parse()"></a>3. #parse()</h1><h2 id="3-1-skipBetweenUpdateAndTable"><a href="#3-1-skipBetweenUpdateAndTable" class="headerlink" title="3.1 #skipBetweenUpdateAndTable()"></a>3.1 #skipBetweenUpdateAndTable()</h2><p>åœ¨ <code>UPDATE</code> å’Œ è¡¨å ä¹‹é—´æœ‰äº›è¯æ³•ï¼Œå¯¹ SQL è·¯ç”±å’Œæ”¹å†™æ— å½±å“ï¼Œè¿›è¡Œè·³è¿‡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MySQLUpdateParser.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">skipBetweenUpdateAndTable</span><span class="params">()</span> </span>&#123;</div><div class="line">   getSqlParser().skipAll(MySQLKeyword.LOW_PRIORITY, MySQLKeyword.IGNORE);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// OracleUpdateParser.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">skipBetweenUpdateAndTable</span><span class="params">()</span> </span>&#123;</div><div class="line">   getSqlParser().skipIfEqual(OracleKeyword.ONLY);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-2-parseSingleTable"><a href="#3-2-parseSingleTable" class="headerlink" title="3.2 #parseSingleTable()"></a>3.2 #parseSingleTable()</h2><p>è§£æ<strong>è¡¨</strong>ï¼Œè¯·çœ‹<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹çš„ <code>#parseSingleTable()</code> å°èŠ‚</a>ã€‚</p>
<h2 id="3-3-parseSetItems"><a href="#3-3-parseSetItems" class="headerlink" title="3.3 #parseSetItems()"></a>3.3 #parseSetItems()</h2><p>è§£æ<code>SET</code>åè¯­å¥ã€‚ </p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractUpdateParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æå¤šä¸ª SET é¡¹</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSetItems</span><span class="params">()</span> </span>&#123;</div><div class="line">   sqlParser.accept(DefaultKeyword.SET);</div><div class="line">   <span class="keyword">do</span> &#123;</div><div class="line">       parseSetItem();</div><div class="line">   &#125; <span class="keyword">while</span> (sqlParser.skipIfEqual(Symbol.COMMA)); <span class="comment">// ä»¥ "," åˆ†éš”</span></div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æå•ä¸ª SET é¡¹</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSetItem</span><span class="params">()</span> </span>&#123;</div><div class="line">   parseSetColumn();</div><div class="line">   sqlParser.skipIfEqual(Symbol.EQ, Symbol.COLON_EQ);</div><div class="line">   parseSetValue();</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æå•ä¸ª SET é¡¹</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSetColumn</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(Symbol.LEFT_PAREN)) &#123;</div><div class="line">       sqlParser.skipParentheses();</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">int</span> beginPosition = sqlParser.getLexer().getCurrentToken().getEndPosition();</div><div class="line">   String literals = sqlParser.getLexer().getCurrentToken().getLiterals();</div><div class="line">   sqlParser.getLexer().nextToken();</div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(Symbol.DOT)) &#123; <span class="comment">// å­—æ®µæœ‰åˆ«å</span></div><div class="line">       <span class="comment">// TableToken</span></div><div class="line">       <span class="keyword">if</span> (updateStatement.getTables().getSingleTableName().equalsIgnoreCase(SQLUtil.getExactlyValue(literals))) &#123;</div><div class="line">           updateStatement.getSqlTokens().add(<span class="keyword">new</span> TableToken(beginPosition - literals.length(), literals));</div><div class="line">       &#125;</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æå•ä¸ª SET å€¼</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSetValue</span><span class="params">()</span> </span>&#123;</div><div class="line">   sqlParser.parseExpression(updateStatement);</div><div class="line">   parametersIndex = sqlParser.getParametersIndex();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-4-parseWhere"><a href="#3-4-parseWhere" class="headerlink" title="3.4 #parseWhere()"></a>3.4 #parseWhere()</h2><p>è§£æ WHERE æ¡ä»¶ã€‚è§£æä»£ç ï¼š<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹çš„#parseWhere()å°èŠ‚</a>ã€‚</p>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ğŸ˜ æ¯”æ›´æ–°SQLè§£ææ˜¯ä¸æ˜¯ç®€å•ï¼Œæ›´ä¸ç”¨å¯¹æ¯”æŸ¥è¯¢SQLè§£æã€‚ğŸ˜³æœ‰ä¸€ç§åœ¨æ°´æ›´çš„æ„Ÿè§‰ã€‚å˜¿å˜¿ï¼Œä¸‹ä¸€ç¯‡ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šåˆ é™¤SQLè§£æã€‹</a>ï¼‰ä¼šæ›´åŠ å®¹æ˜“ã€‚</p>
<p>é“å‹ï¼Œå¸®æˆ‘åˆ†äº«ä¸€æ³¢æ€ä¹ˆæ ·ï¼Ÿ</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/stron
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆå››ï¼‰ä¹‹æ’å…¥SQL</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-parse-4/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-parse-4/</id>
    <published>2017-07-28T16:00:00.000Z</published>
    <updated>2017-07-31T12:30:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. InsertStatement</a></li>
<li><a href="#">3. #parse()</a><ul>
<li><a href="#">3.1 #parseInfo()</a></li>
<li><a href="#">3.2 #parseColumns()</a></li>
<li><a href="#">3.3 #parseValues()</a></li>
<li><a href="#">3.4 #parseCustomizedInsert()</a></li>
<li><a href="#">3.5 #appendGenerateKey()</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡å‰ç½®é˜…è¯»ï¼š</p>
<ul>
<li><a href="http://www.yunai.me/Sharding-JDBC/sql-parse-1/?self">ã€ŠSQL è§£æï¼ˆä¸€ï¼‰ä¹‹è¯æ³•è§£æã€‹</a></li>
<li><a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹</a></li>
</ul>
<p>æœ¬æ–‡åˆ†äº«<strong>æ’å…¥SQLè§£æ</strong>çš„æºç å®ç°ã€‚</p>
<p>ä¸è€ƒè™‘ INSERT SELECT æƒ…å†µä¸‹ï¼Œæ’å…¥SQLè§£ææ¯”æŸ¥è¯¢SQLè§£æå¤æ‚åº¦ä½çš„å¤šçš„å¤šã€‚ä¸åŒæ•°æ®åº“åœ¨æ’å…¥SQLè¯­æ³•ä¸Šä¹Ÿç»Ÿä¸€çš„å¤šã€‚<strong>æœ¬æ–‡åˆ†äº« MySQL æ’å…¥SQLè§£æå™¨ MySQLInsertParser</strong>ã€‚</p>
<p>MySQL INSERT è¯­æ³•ä¸€å…±æœ‰ 3 ç§ ï¼š</p>
<ul>
<li>ç¬¬ä¸€ç§ï¼š<code>INSERT {VALUES | VALUES}</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> [<span class="keyword">LOW_PRIORITY</span> | <span class="keyword">DELAYED</span> | <span class="keyword">HIGH_PRIORITY</span>] [<span class="keyword">IGNORE</span>]</div><div class="line">    [<span class="keyword">INTO</span>] tbl_name</div><div class="line">    [<span class="keyword">PARTITION</span> (partition_name,...)]</div><div class="line">    [(col_name,...)]</div><div class="line">    &#123;<span class="keyword">VALUES</span> | <span class="keyword">VALUE</span>&#125; (&#123;expr | <span class="keyword">DEFAULT</span>&#125;,...),(...),...</div><div class="line">    [ <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span></div><div class="line">      col_name=expr</div><div class="line">        [, col_name=expr] ... ]</div></pre></td></tr></table></figure>
<ul>
<li>ç¬¬äºŒç§ï¼š<code>INSERT SET</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> [<span class="keyword">LOW_PRIORITY</span> | <span class="keyword">DELAYED</span> | <span class="keyword">HIGH_PRIORITY</span>] [<span class="keyword">IGNORE</span>]</div><div class="line">    [<span class="keyword">INTO</span>] tbl_name</div><div class="line">    [<span class="keyword">PARTITION</span> (partition_name,...)]</div><div class="line">    <span class="keyword">SET</span> col_name=&#123;expr | <span class="keyword">DEFAULT</span>&#125;, ...</div><div class="line">    [ <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span></div><div class="line">      col_name=expr</div><div class="line">        [, col_name=expr] ... ]</div></pre></td></tr></table></figure>
<ul>
<li>ç¬¬ä¸‰ç§ï¼š<code>INSERT SELECT</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> [<span class="keyword">LOW_PRIORITY</span> | <span class="keyword">HIGH_PRIORITY</span>] [<span class="keyword">IGNORE</span>]</div><div class="line">    [<span class="keyword">INTO</span>] tbl_name</div><div class="line">    [<span class="keyword">PARTITION</span> (partition_name,...)]</div><div class="line">    [(col_name,...)]</div><div class="line">    <span class="keyword">SELECT</span> ...</div><div class="line">    [ <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span></div><div class="line">      col_name=expr</div><div class="line">        [, col_name=expr] ... ]</div></pre></td></tr></table></figure>
<p>Sharding-JDBC ç›®å‰æ”¯æŒï¼š</p>
<ul>
<li>ç¬¬ä¸€ç§ï¼š<code>INSERT {VALUES | VALUES}</code> <strong>å•æ¡è®°å½•</strong></li>
<li>ç¬¬äºŒç§ï¼š<code>INSERT SET</code></li>
</ul>
<p>Sharding-JDBC æ’å…¥SQLè§£æä¸»æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_29/01.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInsertParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> InsertStatement <span class="title">parse</span><span class="params">()</span> </span>&#123;</div><div class="line">   sqlParser.getLexer().nextToken(); <span class="comment">// è·³è¿‡ INSERT å…³é”®å­—</span></div><div class="line">   parseInto(); <span class="comment">// è§£æINTO</span></div><div class="line">   parseColumns(); <span class="comment">// è§£æè¡¨</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.SELECT, Symbol.LEFT_PAREN)) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support subquery"</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (getValuesKeywords().contains(sqlParser.getLexer().getCurrentToken().getType())) &#123; <span class="comment">// ç¬¬ä¸€ç§æ’å…¥SQLæƒ…å†µ</span></div><div class="line">       parseValues();</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getCustomizedInsertKeywords().contains(sqlParser.getLexer().getCurrentToken().getType())) &#123; <span class="comment">// ç¬¬äºŒç§æ’å…¥SQLæƒ…å†µ</span></div><div class="line">       parseCustomizedInsert();</div><div class="line">   &#125;</div><div class="line">   appendGenerateKey(); <span class="comment">// è‡ªå¢ä¸»é”®</span></div><div class="line">   <span class="keyword">return</span> insertStatement;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1 id="2-InsertStatement"><a href="#2-InsertStatement" class="headerlink" title="2. InsertStatement"></a>2. InsertStatement</h1><p>æ’å…¥SQL è§£æç»“æœã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InsertStatement</span> <span class="keyword">extends</span> <span class="title">AbstractSQLStatement</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ’å…¥å­—æ®µ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Collection&lt;Column&gt; columns = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     *</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> GeneratedKey generatedKey;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ’å…¥å­—æ®µ ä¸‹ä¸€ä¸ªToken å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> columnsListLastPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å€¼å­—æ®µ ä¸‹ä¸€ä¸ªToken å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> valuesListLastPosition;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>INSERT INTO t_order (uid, nickname) VALUES (?, ?)</code> çš„<strong>è§£æç»“æœ</strong>ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_29/02.png" alt=""></p>
<h1 id="3-parse"><a href="#3-parse" class="headerlink" title="3. #parse()"></a>3. #parse()</h1><h2 id="3-1-parseInto"><a href="#3-1-parseInto" class="headerlink" title="3.1 #parseInto()"></a>3.1 #parseInto()</h2><p>è§£æ<strong>è¡¨</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInsertParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æè¡¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseInto</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ä¾‹å¦‚ï¼ŒOracleï¼ŒINSERT FIRST/ALL ç›®å‰ä¸æ”¯æŒ</span></div><div class="line">   <span class="keyword">if</span> (getUnsupportedKeywords().contains(sqlParser.getLexer().getCurrentToken().getType())) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(sqlParser.getLexer().getCurrentToken().getType());</div><div class="line">   &#125;</div><div class="line">   sqlParser.skipUntil(DefaultKeyword.INTO);</div><div class="line">   sqlParser.getLexer().nextToken();</div><div class="line">   <span class="comment">// è§£æè¡¨</span></div><div class="line">   sqlParser.parseSingleTable(insertStatement);</div><div class="line">   skipBetweenTableAndValues();</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·³è¿‡ è¡¨ å’Œ æ’å…¥å­—æ®µ ä¸­é—´çš„ Token</div><div class="line">* ä¾‹å¦‚ MySQL ï¼š[PARTITION (partition_name,...)]</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">skipBetweenTableAndValues</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">while</span> (getSkippedKeywordsBetweenTableAndValues().contains(sqlParser.getLexer().getCurrentToken().getType())) &#123;</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       <span class="keyword">if</span> (sqlParser.equalAny(Symbol.LEFT_PAREN)) &#123;</div><div class="line">           sqlParser.skipParentheses();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­ <code>#parseSingleTable()</code> è¯·çœ‹<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹çš„ <code>#parseSingleTable()</code> å°èŠ‚</a>ã€‚</p>
<h2 id="3-2-parseColumns"><a href="#3-2-parseColumns" class="headerlink" title="3.2 #parseColumns()"></a>3.2 #parseColumns()</h2><p>è§£æ<strong>æ’å…¥å­—æ®µ</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInsertParser.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseColumns</span><span class="params">()</span> </span>&#123;</div><div class="line">   Collection&lt;Column&gt; result = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(Symbol.LEFT_PAREN)) &#123;</div><div class="line">       String tableName = insertStatement.getTables().getSingleTableName();</div><div class="line">       Optional&lt;String&gt; generateKeyColumn = shardingRule.getGenerateKeyColumn(tableName); <span class="comment">// è‡ªåŠ¨ç”Ÿæˆé”®ä¿¡æ¯</span></div><div class="line">       <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">       <span class="keyword">do</span> &#123;</div><div class="line">           <span class="comment">// Column æ’å…¥å­—æ®µ</span></div><div class="line">           sqlParser.getLexer().nextToken();</div><div class="line">           String columnName = SQLUtil.getExactlyValue(sqlParser.getLexer().getCurrentToken().getLiterals());</div><div class="line">           result.add(<span class="keyword">new</span> Column(columnName, tableName));</div><div class="line">           sqlParser.getLexer().nextToken();</div><div class="line">           <span class="comment">// è‡ªåŠ¨ç”Ÿæˆé”®</span></div><div class="line">           <span class="keyword">if</span> (generateKeyColumn.isPresent() &amp;&amp; generateKeyColumn.get().equalsIgnoreCase(columnName)) &#123;</div><div class="line">               generateKeyColumnIndex = count;</div><div class="line">           &#125;</div><div class="line">           count++;</div><div class="line">       &#125; <span class="keyword">while</span> (!sqlParser.equalAny(Symbol.RIGHT_PAREN) &amp;&amp; !sqlParser.equalAny(Assist.END));</div><div class="line">       <span class="comment">//</span></div><div class="line">       insertStatement.setColumnsListLastPosition(sqlParser.getLexer().getCurrentToken().getEndPosition() - sqlParser.getLexer().getCurrentToken().getLiterals().length());</div><div class="line">       <span class="comment">//</span></div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">   &#125;</div><div class="line">   insertStatement.getColumns().addAll(result);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-3-parseValues"><a href="#3-3-parseValues" class="headerlink" title="3.3 #parseValues()"></a>3.3 #parseValues()</h2><p>è§£æ<strong>å€¼å­—æ®µ</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æå€¼å­—æ®µ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseValues</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">boolean</span> parsed = <span class="keyword">false</span>;</div><div class="line">   <span class="keyword">do</span> &#123;</div><div class="line">       <span class="keyword">if</span> (parsed) &#123; <span class="comment">// åªå…è®¸INSERT INTO ä¸€æ¡</span></div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support multiple insert"</span>);</div><div class="line">       &#125;</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       sqlParser.accept(Symbol.LEFT_PAREN);</div><div class="line">       <span class="comment">// è§£æè¡¨è¾¾å¼</span></div><div class="line">       List&lt;SQLExpression&gt; sqlExpressions = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">       <span class="keyword">do</span> &#123;</div><div class="line">           sqlExpressions.add(sqlParser.parseExpression());</div><div class="line">       &#125; <span class="keyword">while</span> (sqlParser.skipIfEqual(Symbol.COMMA));</div><div class="line">       <span class="comment">//</span></div><div class="line">       insertStatement.setValuesListLastPosition(sqlParser.getLexer().getCurrentToken().getEndPosition() - sqlParser.getLexer().getCurrentToken().getLiterals().length());</div><div class="line">       <span class="comment">// è§£æå€¼å­—æ®µ</span></div><div class="line">       <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">       <span class="keyword">for</span> (Column each : insertStatement.getColumns()) &#123;</div><div class="line">           SQLExpression sqlExpression = sqlExpressions.get(count);</div><div class="line">           insertStatement.getConditions().add(<span class="keyword">new</span> Condition(each, sqlExpression), shardingRule);</div><div class="line">           <span class="keyword">if</span> (generateKeyColumnIndex == count) &#123; <span class="comment">// è‡ªåŠ¨ç”Ÿæˆé”®</span></div><div class="line">               insertStatement.setGeneratedKey(createGeneratedKey(each, sqlExpression));</div><div class="line">           &#125;</div><div class="line">           count++;</div><div class="line">       &#125;</div><div class="line">       sqlParser.accept(Symbol.RIGHT_PAREN);</div><div class="line">       parsed = <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">while</span> (sqlParser.equalAny(Symbol.COMMA)); <span class="comment">// å­—æ®µä»¥ "," åˆ†éš”</span></div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ›å»º è‡ªåŠ¨ç”Ÿæˆé”®</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> column å­—æ®µ</div><div class="line">* <span class="doctag">@param</span> sqlExpression è¡¨è¾¾å¼</div><div class="line">* <span class="doctag">@return</span> è‡ªåŠ¨ç”Ÿæˆé”®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> GeneratedKey <span class="title">createGeneratedKey</span><span class="params">(<span class="keyword">final</span> Column column, <span class="keyword">final</span> SQLExpression sqlExpression)</span> </span>&#123;</div><div class="line">   GeneratedKey result;</div><div class="line">   <span class="keyword">if</span> (sqlExpression <span class="keyword">instanceof</span> SQLPlaceholderExpression) &#123; <span class="comment">// å ä½ç¬¦</span></div><div class="line">       result = <span class="keyword">new</span> GeneratedKey(column.getName(), ((SQLPlaceholderExpression) sqlExpression).getIndex(), <span class="keyword">null</span>);</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlExpression <span class="keyword">instanceof</span> SQLNumberExpression) &#123; <span class="comment">// æ•°å­—</span></div><div class="line">       result = <span class="keyword">new</span> GeneratedKey(column.getName(), -<span class="number">1</span>, ((SQLNumberExpression) sqlExpression).getNumber());</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ShardingJdbcException(<span class="string">"Generated key only support number."</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-4-1-GeneratedKey"><a href="#3-4-1-GeneratedKey" class="headerlink" title="3.4.1 GeneratedKey"></a>3.4.1 GeneratedKey</h3><p>è‡ªåŠ¨ç”Ÿæˆé”®ï¼Œ<strong>å±äºåˆ†ç‰‡ä¸Šä¸‹æ–‡ä¿¡æ¯</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GeneratedKey</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å­—æ®µ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String column;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç¬¬å‡ ä¸ªå ä½ç¬¦</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å€¼</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Number value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-4-2-Condition"><a href="#3-4-2-Condition" class="headerlink" title="3.4.2 Condition"></a>3.4.2 Condition</h3><p>æ¡ä»¶å¯¹è±¡ï¼Œ<strong>å±äºåˆ†ç‰‡ä¸Šä¸‹æ–‡ä¿¡æ¯</strong>ã€‚åœ¨<strong>æ’å…¥SQLè§£æ</strong>é‡Œå­˜å‚¨<strong>å½±å“åˆ†ç‰‡çš„å€¼å­—æ®µ</strong>ã€‚åç»­<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL è·¯ç”±ã€‹</a> ä¼šä¸“é—¨åˆ†äº«è¿™å—ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Condition</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å­—æ®µ</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Column column;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥å…¶å®ƒå±æ€§</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Column</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ—å</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¡¨å</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String tableName;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-4-parseCustomizedInsert"><a href="#3-4-parseCustomizedInsert" class="headerlink" title="3.4 #parseCustomizedInsert()"></a>3.4 #parseCustomizedInsert()</h2><p>è§£æ<strong>ç¬¬äºŒç§æ’å…¥SQL</strong>ï¼š<code>INSERT SET</code>ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">test</span> <span class="keyword">SET</span> <span class="keyword">id</span> = <span class="number">4</span>  <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> <span class="keyword">name</span> = <span class="string">'doubi'</span>, <span class="keyword">name</span> = <span class="string">'hehe'</span>;</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">test</span> <span class="keyword">SET</span> <span class="keyword">id</span> = <span class="number">4</span>, <span class="keyword">name</span> = <span class="string">'hehe'</span>;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseInsertSet</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">do</span> &#123;</div><div class="line">       getSqlParser().getLexer().nextToken();</div><div class="line">       <span class="comment">// æ’å…¥å­—æ®µ</span></div><div class="line">       Column column = <span class="keyword">new</span> Column(SQLUtil.getExactlyValue(getSqlParser().getLexer().getCurrentToken().getLiterals()), getInsertStatement().getTables().getSingleTableName());</div><div class="line">       getSqlParser().getLexer().nextToken();</div><div class="line">       <span class="comment">// ç­‰å·</span></div><div class="line">       getSqlParser().accept(Symbol.EQ);</div><div class="line">       <span class="comment">// ã€å€¼ã€‘è¡¨è¾¾å¼</span></div><div class="line">       SQLExpression sqlExpression;</div><div class="line">       <span class="keyword">if</span> (getSqlParser().equalAny(Literals.INT)) &#123;</div><div class="line">           sqlExpression = <span class="keyword">new</span> SQLNumberExpression(Integer.parseInt(getSqlParser().getLexer().getCurrentToken().getLiterals()));</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getSqlParser().equalAny(Literals.FLOAT)) &#123;</div><div class="line">           sqlExpression = <span class="keyword">new</span> SQLNumberExpression(Double.parseDouble(getSqlParser().getLexer().getCurrentToken().getLiterals()));</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getSqlParser().equalAny(Literals.CHARS)) &#123;</div><div class="line">           sqlExpression = <span class="keyword">new</span> SQLTextExpression(getSqlParser().getLexer().getCurrentToken().getLiterals());</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getSqlParser().equalAny(DefaultKeyword.NULL)) &#123;</div><div class="line">           sqlExpression = <span class="keyword">new</span> SQLIgnoreExpression();</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getSqlParser().equalAny(Symbol.QUESTION)) &#123;</div><div class="line">           sqlExpression = <span class="keyword">new</span> SQLPlaceholderExpression(getSqlParser().getParametersIndex());</div><div class="line">           getSqlParser().increaseParametersIndex();</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">""</span>);</div><div class="line">       &#125;</div><div class="line">       getSqlParser().getLexer().nextToken();</div><div class="line">       <span class="comment">// Condition</span></div><div class="line">       <span class="keyword">if</span> (getSqlParser().equalAny(Symbol.COMMA, DefaultKeyword.ON, Assist.END)) &#123;</div><div class="line">           getInsertStatement().getConditions().add(<span class="keyword">new</span> Condition(column, sqlExpression), getShardingRule());</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           getSqlParser().skipUntil(Symbol.COMMA, DefaultKeyword.ON);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">while</span> (getSqlParser().equalAny(Symbol.COMMA)); <span class="comment">// å­—æ®µä»¥ "," åˆ†éš”</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-5-appendGenerateKey"><a href="#3-5-appendGenerateKey" class="headerlink" title="3.5 #appendGenerateKey()"></a>3.5 #appendGenerateKey()</h2><p>å½“è¡¨è®¾ç½®<strong>è‡ªåŠ¨ç”Ÿæˆé”®</strong>ï¼Œå¹¶ä¸”æ’å…¥SQL<strong>æ²¡</strong>å†™è‡ªå¢å­—æ®µï¼Œå¢åŠ è¯¥å­—æ®µã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">// ä¸»é”®ä¸ºuser_id</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user(nickname, age) <span class="keyword">VALUES</span> (?, ?)</div></pre></td></tr></table></figure>
<p>åç»­ SQL æ”¹å†™ä¼šç”Ÿæˆè¯¥è‡ªå¢ç¼–å·ï¼Œå¹¶æ”¹å†™è¯¥ SQLã€‚åç»­<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL æ”¹å†™ã€‹</a> ä¼šä¸“é—¨åˆ†äº«è¿™å—ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendGenerateKey</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// å½“è¡¨è®¾ç½®è‡ªåŠ¨ç”Ÿæˆé”®ï¼Œå¹¶ä¸”æ’å…¥SQLæ²¡å†™è‡ªå¢å­—æ®µ</span></div><div class="line">   String tableName = insertStatement.getTables().getSingleTableName();</div><div class="line">   Optional&lt;String&gt; generateKeyColumn = shardingRule.getGenerateKeyColumn(tableName);</div><div class="line">   <span class="keyword">if</span> (!generateKeyColumn.isPresent() || <span class="keyword">null</span> != insertStatement.getGeneratedKey()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ItemsToken</span></div><div class="line">   ItemsToken columnsToken = <span class="keyword">new</span> ItemsToken(insertStatement.getColumnsListLastPosition());</div><div class="line">   columnsToken.getItems().add(generateKeyColumn.get());</div><div class="line">   insertStatement.getSqlTokens().add(columnsToken);</div><div class="line">   <span class="comment">// GeneratedKeyToken</span></div><div class="line">   insertStatement.getSqlTokens().add(<span class="keyword">new</span> GeneratedKeyToken(insertStatement.getValuesListLastPosition()));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-5-1-GeneratedKeyToken"><a href="#3-5-1-GeneratedKeyToken" class="headerlink" title="3.5.1 GeneratedKeyToken"></a>3.5.1 GeneratedKeyToken</h3><p>è‡ªå¢ä¸»é”®æ ‡è®°å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GeneratedKeyToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ğŸ˜ˆ æ˜¯ä¸æ˜¯æ¯”<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-3/?self">ã€ŠSQL è§£æï¼ˆä¸‰ï¼‰ä¹‹æ’å…¥SQLã€‹</a>ç®€å•å¾ˆå¤šã€‚</p>
<p><strong>é“å‹ï¼Œå¯å¦åˆ†äº«ä¸€æ³¢ã€æœ¬æ–‡ã€‘åˆ°æœ‹å‹åœˆ</strong>ã€‚</p>
<p><strong>ç»§ç»­åŠ æ²¹æ›´æ–°ï¼</strong></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/stron
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆä¸‰ï¼‰ä¹‹æŸ¥è¯¢SQL</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-parse-3/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-parse-3/</id>
    <published>2017-07-26T16:00:00.000Z</published>
    <updated>2017-07-31T12:30:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. SelectStatement</a><ul>
<li><a href="#">2.1 AbstractSQLStatement</a></li>
<li><a href="#">2.2 SQLToken</a></li>
</ul>
</li>
<li><a href="#">3. #query()</a><ul>
<li><a href="#">3.1 #parseDistinct()</a></li>
<li><a href="#">3.2 #parseSelectList()</a></li>
<li><a href="#">3.3 #skipToFrom()</a></li>
<li><a href="#">3.4 #parseFrom()</a></li>
<li><a href="#">3.5 #parseWhere()</a></li>
<li><a href="#">3.6 #parseGroupBy()</a></li>
<li><a href="#">3.7 #parseOrderBy()</a></li>
<li><a href="#">3.8 #parseLimit()</a></li>
<li><a href="#">3.9 #queryRest()</a></li>
</ul>
</li>
<li><a href="#">4. appendDerivedç­‰æ–¹æ³•</a><ul>
<li><a href="#">4.1 appendAvgDerivedColumns</a></li>
<li><a href="#">4.2 appendDerivedOrderColumns</a></li>
<li><a href="#">4.3 ItemsToken</a></li>
<li><a href="#">4.4 appendDerivedOrderBy()</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡å‰ç½®é˜…è¯»ï¼š</p>
<ul>
<li><a href="http://www.yunai.me/Sharding-JDBC/sql-parse-1/?self">ã€ŠSQL è§£æï¼ˆä¸€ï¼‰ä¹‹è¯æ³•è§£æã€‹</a></li>
<li><a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹</a></li>
</ul>
<p>æœ¬æ–‡åˆ†äº«<strong>æ’å…¥SQLè§£æ</strong>çš„æºç å®ç°ã€‚</p>
<p>ç”±äºæ¯ä¸ªæ•°æ®åº“åœ¨éµå®ˆ SQL è¯­æ³•è§„èŒƒçš„åŒæ—¶ï¼Œåˆæœ‰å„è‡ªç‹¬ç‰¹çš„è¯­æ³•ã€‚å› æ­¤ï¼Œåœ¨ Sharding-JDBC é‡Œæ¯ä¸ªæ•°æ®åº“éƒ½æœ‰è‡ªå·±çš„ SELECT è¯­å¥çš„è§£æå™¨å®ç°æ–¹å¼ï¼Œå½“ç„¶ç»å¤§éƒ¨åˆ†é€»è¾‘æ˜¯ç›¸åŒçš„ã€‚<strong>æœ¬æ–‡ä¸»è¦åˆ†äº«ç¬”è€…æœ€å¸¸ç”¨çš„ MySQL æŸ¥è¯¢</strong>ã€‚</p>
<p>æŸ¥è¯¢ SQL è§£æä¸»æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/03.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> SelectStatement <span class="title">parse</span><span class="params">()</span> </span>&#123;</div><div class="line">   query();</div><div class="line">   parseOrderBy();</div><div class="line">   customizedSelect();</div><div class="line">   appendDerivedColumns();</div><div class="line">   appendDerivedOrderBy();</div><div class="line">   <span class="keyword">return</span> selectStatement;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#parseOrderBy()</code> ï¼šå¯¹äº MySQL æŸ¥è¯¢è¯­å¥è§£æå™¨æ— æ•ˆæœï¼Œå› ä¸ºå·²ç»åœ¨ <code>#query()</code> æ–¹æ³•é‡Œé¢å·²ç»è°ƒç”¨ <code>#parseOrderBy()</code>ï¼Œå› æ­¤å›¾ä¸­çœç•¥è¯¥æ–¹æ³•ã€‚</li>
<li><code>#customizedSelect()</code> ï¼šOracleã€SQLServer æŸ¥è¯¢è¯­å¥è§£æå™¨é‡å†™äº†è¯¥æ–¹æ³•ï¼Œå¯¹äº MySQL æŸ¥è¯¢è§£æå™¨æ˜¯ä¸ªç©ºæ–¹æ³•ï¼Œè¿›è¡Œçœç•¥ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å•ç‹¬å»ç ”ç©¶ç ”ç©¶ã€‚</li>
</ul>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<p>ğŸ‘¼ æŸ¥è¯¢è¯­å¥è§£ææ˜¯å¢åˆ æ”¹æŸ¥é‡Œé¢<strong>æœ€çµæ´»ä¹Ÿæ˜¯æœ€å¤æ‚çš„</strong>ï¼Œå¸Œæœ›å¤§å®¶æœ‰è€å¿ƒçœ‹å®Œæœ¬æ–‡ã€‚ç†è§£æŸ¥è¯¢è¯­å¥è§£æï¼Œå¦å¤–ä¸‰ç§è¯­å¥ç†è§£èµ·æ¥ç®€ç›´æ˜¯ SO EASYã€‚éª—äººæ˜¯å°ç‹—ğŸ¶ã€‚<br>ğŸ™‚å¦‚æœå¯¹æœ¬æ–‡æœ‰ä¸ç†è§£çš„åœ°æ–¹ï¼Œå¯ä»¥ç»™æˆ‘çš„å…¬ä¼—å·<strong>ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">èŠ‹è‰¿çš„åç«¯å°å±‹</a>ï¼‰</strong>ç•™è¨€ï¼Œæˆ‘ä¼š<strong>é€æ¡è®¤çœŸè€å¿ƒ</strong>å›å¤ã€‚éª—äººæ˜¯å°çŒªğŸ·ã€‚</p>
<p>OKï¼Œä¸åºŸè¯å•¦ï¼Œå¼€å§‹æˆ‘ä»¬è¿™æ®µç—›å¹¶å¿«ä¹çš„æ—…é€”ã€‚</p>
<h1 id="2-SelectStatement"><a href="#2-SelectStatement" class="headerlink" title="2. SelectStatement"></a>2. SelectStatement</h1><p>ğŸ™‚ <strong>æœ¬èŠ‚åªä»‹ç»è¿™äº›ç±»ï¼Œæ–¹ä¾¿æœ¬æ–‡ä¸‹èŠ‚åˆ†ææºç å®ç°å¤§å®¶èƒ½çŸ¥é“è®¤è¯†å®ƒä»¬</strong> ğŸ™‚  </p>
<p>SelectStatementï¼ŒæŸ¥è¯¢è¯­å¥è§£æç»“æœå¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SelectStatement.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectStatement</span> <span class="keyword">extends</span> <span class="title">AbstractSQLStatement</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ˜¯å¦è¡Œ DISTINCT / DISTINCTROW / UNION</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> distinct;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ˜¯å¦æŸ¥è¯¢æ‰€æœ‰å­—æ®µï¼Œå³ SELECT *</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> containStar;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æœ€åä¸€ä¸ªæŸ¥è¯¢é¡¹ä¸‹ä¸€ä¸ª Token çš„å¼€å§‹ä½ç½®</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #items</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> selectListLastPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æœ€åä¸€ä¸ªåˆ†ç»„é¡¹ä¸‹ä¸€ä¸ª Token çš„å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> groupByLastPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æŸ¥è¯¢é¡¹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;SelectItem&gt; items = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ†ç»„é¡¹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;OrderItem&gt; groupByItems = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ’åºé¡¹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;OrderItem&gt; orderByItems = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ†é¡µ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Limit limit;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯¹å±æ€§æŒ‰ç…§ç±»å‹è¿›è¡Œå½’ç±»ï¼š</p>
<ul>
<li>ç‰¹æ®Š<ul>
<li>distinct </li>
</ul>
</li>
<li>æŸ¥è¯¢å­—æ®µ<ul>
<li>containStar</li>
<li>items</li>
<li>selectListLastPosition</li>
</ul>
</li>
<li>åˆ†ç»„æ¡ä»¶<ul>
<li>groupByItems</li>
<li>groupByLastPosition</li>
</ul>
</li>
<li>æ’åºæ¡ä»¶<ul>
<li>orderByItems</li>
</ul>
</li>
<li>åˆ†é¡µæ¡ä»¶<ul>
<li>limit</li>
</ul>
</li>
</ul>
<h2 id="2-1-AbstractSQLStatement"><a href="#2-1-AbstractSQLStatement" class="headerlink" title="2.1 AbstractSQLStatement"></a>2.1 AbstractSQLStatement</h2><p>å¢åˆ æ”¹æŸ¥è§£æç»“æœå¯¹è±¡çš„<strong>æŠ½è±¡çˆ¶ç±»</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractSQLStatement</span> <span class="keyword">implements</span> <span class="title">SQLStatement</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL ç±»å‹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SQLType type;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¡¨</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Tables tables = <span class="keyword">new</span> Tables();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¿‡æ»¤æ¡ä»¶ã€‚</div><div class="line">     * åªæœ‰å¯¹è·¯ç”±ç»“æœæœ‰å½±å“çš„æ¡ä»¶ï¼Œæ‰æ·»åŠ è¿›æ•°ç»„</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Conditions conditions = <span class="keyword">new</span> Conditions();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQLæ ‡è®°å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-2-SQLToken"><a href="#2-2-SQLToken" class="headerlink" title="2.2 SQLToken"></a>2.2 SQLToken</h2><p>SQLTokenï¼ŒSQLæ ‡è®°å¯¹è±¡æ¥å£ï¼ŒSQL æ”¹å†™æ—¶ä½¿ç”¨åˆ°ã€‚ä¸‹é¢éƒ½æ˜¯å®ƒçš„å®ç°ç±»ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">ç±»</th>
<th style="text-align:left">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GeneratedKeyToken</td>
<td style="text-align:left">è‡ªå¢ä¸»é”®æ ‡è®°å¯¹è±¡</td>
</tr>
<tr>
<td style="text-align:left">TableToken</td>
<td style="text-align:left">è¡¨æ ‡è®°å¯¹è±¡</td>
</tr>
<tr>
<td style="text-align:left">ItemsToken</td>
<td style="text-align:left">é€‰æ‹©é¡¹æ ‡è®°å¯¹è±¡</td>
</tr>
<tr>
<td style="text-align:left">OffsetToken</td>
<td style="text-align:left">åˆ†é¡µåç§»é‡æ ‡è®°å¯¹è±¡</td>
</tr>
<tr>
<td style="text-align:left">OrderByToken</td>
<td style="text-align:left">æ’åºæ ‡è®°å¯¹è±¡</td>
</tr>
<tr>
<td style="text-align:left">RowCountToken</td>
<td style="text-align:left">åˆ†é¡µé•¿åº¦æ ‡è®°å¯¹è±¡</td>
</tr>
</tbody>
</table>
<h1 id="3-query"><a href="#3-query" class="headerlink" title="3. #query()"></a>3. #query()</h1><p><code>#query()</code>ï¼ŒæŸ¥è¯¢ SQL è§£æã€‚</p>
<p><strong>MySQL SELECT Syntax</strong>ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">// https://dev.mysql.com/doc/refman/5.7/en/select.html</div><div class="line"><span class="keyword">SELECT</span></div><div class="line">    [ALL | <span class="keyword">DISTINCT</span> | <span class="keyword">DISTINCTROW</span> ]</div><div class="line">      [<span class="keyword">HIGH_PRIORITY</span>]</div><div class="line">      [<span class="keyword">STRAIGHT_JOIN</span>]</div><div class="line">      [<span class="keyword">SQL_SMALL_RESULT</span>] [<span class="keyword">SQL_BIG_RESULT</span>] [<span class="keyword">SQL_BUFFER_RESULT</span>]</div><div class="line">      [<span class="keyword">SQL_CACHE</span> | SQL_NO_CACHE] [<span class="keyword">SQL_CALC_FOUND_ROWS</span>]</div><div class="line">    select_expr [, select_expr ...]</div><div class="line">    [<span class="keyword">FROM</span> table_references</div><div class="line">      [<span class="keyword">PARTITION</span> partition_list]</div><div class="line">    [<span class="keyword">WHERE</span> where_condition]</div><div class="line">    [<span class="keyword">GROUP</span> <span class="keyword">BY</span> &#123;col_name | expr | <span class="keyword">position</span>&#125;</div><div class="line">      [<span class="keyword">ASC</span> | <span class="keyword">DESC</span>], ... [<span class="keyword">WITH</span> <span class="keyword">ROLLUP</span>]]</div><div class="line">    [<span class="keyword">HAVING</span> where_condition]</div><div class="line">    [<span class="keyword">ORDER</span> <span class="keyword">BY</span> &#123;col_name | expr | <span class="keyword">position</span>&#125;</div><div class="line">      [<span class="keyword">ASC</span> | <span class="keyword">DESC</span>], ...]</div><div class="line">    [<span class="keyword">LIMIT</span> &#123;[<span class="keyword">offset</span>,] <span class="keyword">row_count</span> | <span class="keyword">row_count</span> <span class="keyword">OFFSET</span> <span class="keyword">offset</span>&#125;]</div><div class="line">    [<span class="keyword">PROCEDURE</span> procedure_name(argument_list)]</div><div class="line">    [<span class="keyword">INTO</span> <span class="keyword">OUTFILE</span> <span class="string">'file_name'</span></div><div class="line">        [<span class="built_in">CHARACTER</span> <span class="keyword">SET</span> charset_name]</div><div class="line">        export_options</div><div class="line">      | <span class="keyword">INTO</span> <span class="keyword">DUMPFILE</span> <span class="string">'file_name'</span></div><div class="line">      | <span class="keyword">INTO</span> var_name [, var_name]]</div><div class="line">    [<span class="keyword">FOR</span> <span class="keyword">UPDATE</span> | <span class="keyword">LOCK</span> <span class="keyword">IN</span> <span class="keyword">SHARE</span> <span class="keyword">MODE</span>]]</div></pre></td></tr></table></figure>
<p>å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/04.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MySQLSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (getSqlParser().equalAny(DefaultKeyword.SELECT)) &#123;</div><div class="line">       getSqlParser().getLexer().nextToken();</div><div class="line">       parseDistinct();</div><div class="line">       getSqlParser().skipAll(MySQLKeyword.HIGH_PRIORITY, DefaultKeyword.STRAIGHT_JOIN, MySQLKeyword.SQL_SMALL_RESULT, MySQLKeyword.SQL_BIG_RESULT, MySQLKeyword.SQL_BUFFER_RESULT,</div><div class="line">               MySQLKeyword.SQL_CACHE, MySQLKeyword.SQL_NO_CACHE, MySQLKeyword.SQL_CALC_FOUND_ROWS);</div><div class="line">       parseSelectList(); <span class="comment">// è§£æ æŸ¥è¯¢å­—æ®µ</span></div><div class="line">       skipToFrom(); <span class="comment">// è·³åˆ° FROM å¤„</span></div><div class="line">   &#125;</div><div class="line">   parseFrom();<span class="comment">// è§£æ è¡¨ï¼ˆJOIN ON / FROM å•&amp;å¤šè¡¨ï¼‰</span></div><div class="line">   parseWhere(); <span class="comment">// è§£æ WHERE æ¡ä»¶</span></div><div class="line">   parseGroupBy(); <span class="comment">// è§£æ Group By å’Œ Havingï¼ˆç›®å‰ä¸æ”¯æŒï¼‰æ¡ä»¶</span></div><div class="line">   parseOrderBy(); <span class="comment">// è§£æ Order By æ¡ä»¶</span></div><div class="line">   parseLimit(); <span class="comment">// è§£æ åˆ†é¡µ Limit æ¡ä»¶</span></div><div class="line">   <span class="comment">// [PROCEDURE] æš‚ä¸æ”¯æŒ</span></div><div class="line">   <span class="keyword">if</span> (getSqlParser().equalAny(DefaultKeyword.PROCEDURE)) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(getSqlParser().getLexer().getCurrentToken().getType());</div><div class="line">   &#125;</div><div class="line">   queryRest();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-1-parseDistinct"><a href="#3-1-parseDistinct" class="headerlink" title="3.1 #parseDistinct()"></a>3.1 #parseDistinct()</h2><p>è§£æ DISTINCTã€DISTINCTROWã€UNION è°“è¯­ã€‚</p>
<p>æ ¸å¿ƒä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseDistinct</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.DISTINCT, DefaultKeyword.DISTINCTROW, DefaultKeyword.UNION)) &#123;</div><div class="line">       selectStatement.setDistinct(<span class="keyword">true</span>);</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       <span class="keyword">if</span> (hasDistinctOn() &amp;&amp; sqlParser.equalAny(DefaultKeyword.ON)) &#123; <span class="comment">// PostgreSQL ç‹¬æœ‰è¯­æ³•ï¼š DISTINCT ON</span></div><div class="line">           sqlParser.getLexer().nextToken();</div><div class="line">           sqlParser.skipParentheses();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.ALL)) &#123;</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ­¤å¤„ DISTINCT å’Œ DISTINCT(å­—æ®µ) ä¸åŒï¼Œå®ƒæ˜¯é’ˆå¯¹æŸ¥è¯¢ç»“æœåšå»é‡ï¼Œå³æ•´è¡Œé‡å¤ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">mysql&gt; SELECT item_id, order_id FROM t_order_item;</div><div class="line">+---------+----------+</div><div class="line">| item_id | order_id |</div><div class="line">+---------+----------+</div><div class="line">| 1       | 1        |</div><div class="line">| 1       | 1        |</div><div class="line">+---------+----------+</div><div class="line">2 rows in set (0.03 sec)</div><div class="line"></div><div class="line">mysql&gt; SELECT DISTINCT item_id, order_id FROM t_order_item;</div><div class="line">+---------+----------+</div><div class="line">| item_id | order_id |</div><div class="line">+---------+----------+</div><div class="line">| 1       | 1        |</div><div class="line">+---------+----------+</div><div class="line">1 rows in set (0.02 sec)</div></pre></td></tr></table></figure>
<h2 id="3-2-parseSelectList"><a href="#3-2-parseSelectList" class="headerlink" title="3.2 #parseSelectList()"></a>3.2 #parseSelectList()</h2><table>
<thead>
<tr>
<th>SELECT</th>
<th>o.user_id</th>
<th>COUNT(DISTINCT i.item_id) AS item_count</th>
<th>MAX(i.item_id)</th>
<th>FROM</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>SelectItem</td>
<td>SelectItem</td>
<td>SelectItem</td>
</tr>
</tbody>
</table>
<p>å°† SQL <strong>æŸ¥è¯¢å­—æ®µ</strong> æŒ‰ç…§<strong>é€—å·( , )</strong>åˆ‡å‰²æˆ<strong>å¤šä¸ª</strong>é€‰æ‹©é¡¹( SelectItem)ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseSelectList</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">do</span> &#123;</div><div class="line">       <span class="comment">// è§£æå•ä¸ªé€‰æ‹©é¡¹</span></div><div class="line">       parseSelectItem();</div><div class="line">   &#125; <span class="keyword">while</span> (sqlParser.skipIfEqual(Symbol.COMMA));</div><div class="line">   <span class="comment">// è®¾ç½® æœ€åä¸€ä¸ªæŸ¥è¯¢é¡¹ä¸‹ä¸€ä¸ª Token çš„å¼€å§‹ä½ç½®</span></div><div class="line">   selectStatement.setSelectListLastPosition(sqlParser.getLexer().getCurrentToken().getEndPosition() - sqlParser.getLexer().getCurrentToken().getLiterals().length());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-1-SelectItem-é€‰æ‹©é¡¹"><a href="#3-2-1-SelectItem-é€‰æ‹©é¡¹" class="headerlink" title="3.2.1 SelectItem é€‰æ‹©é¡¹"></a>3.2.1 SelectItem é€‰æ‹©é¡¹</h3><p>SelectItem æ¥å£ï¼Œ<strong>å±äºåˆ†ç‰‡ä¸Šä¸‹æ–‡ä¿¡æ¯</strong>ï¼Œæœ‰ 2 ä¸ªå®ç°ç±»ï¼š</p>
<ul>
<li>CommonSelectItem ï¼šé€šç”¨é€‰æ‹©é¡¹</li>
<li>AggregationSelectItem ï¼šèšåˆé€‰æ‹©é¡¹</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/01.png" alt=""></p>
<p>è§£æå•ä¸ª SelectItem æ ¸å¿ƒä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSelectItem</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ç¬¬å››ç§æƒ…å†µï¼ŒSQL Server ç‹¬æœ‰</span></div><div class="line">   <span class="keyword">if</span> (isRowNumberSelectItem()) &#123;</div><div class="line">       selectStatement.getItems().add(parseRowNumberSelectItem());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   sqlParser.skipIfEqual(DefaultKeyword.CONNECT_BY_ROOT); <span class="comment">// Oracle ç‹¬æœ‰ï¼šhttps://docs.oracle.com/cd/B19306_01/server.102/b14200/operators004.htm</span></div><div class="line">   String literals = sqlParser.getLexer().getCurrentToken().getLiterals();</div><div class="line">   <span class="comment">// ç¬¬ä¸€ç§æƒ…å†µï¼Œ* é€šç”¨é€‰æ‹©é¡¹ï¼ŒSELECT *</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(Symbol.STAR) || Symbol.STAR.getLiterals().equals(SQLUtil.getExactlyValue(literals))) &#123;</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       selectStatement.getItems().add(<span class="keyword">new</span> CommonSelectItem(Symbol.STAR.getLiterals(), sqlParser.parseAlias()));</div><div class="line">       selectStatement.setContainStar(<span class="keyword">true</span>);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç¬¬äºŒç§æƒ…å†µï¼Œèšåˆé€‰æ‹©é¡¹</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.MAX, DefaultKeyword.MIN, DefaultKeyword.SUM, DefaultKeyword.AVG, DefaultKeyword.COUNT)) &#123;</div><div class="line">       selectStatement.getItems().add(<span class="keyword">new</span> AggregationSelectItem(AggregationType.valueOf(literals.toUpperCase()), sqlParser.skipParentheses(), sqlParser.parseAlias()));</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç¬¬ä¸‰ç§æƒ…å†µï¼Œé * é€šç”¨é€‰æ‹©é¡¹</span></div><div class="line">   StringBuilder expression = <span class="keyword">new</span> StringBuilder();</div><div class="line">   Token lastToken = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">while</span> (!sqlParser.equalAny(DefaultKeyword.AS) &amp;&amp; !sqlParser.equalAny(Symbol.COMMA) &amp;&amp; !sqlParser.equalAny(DefaultKeyword.FROM) &amp;&amp; !sqlParser.equalAny(Assist.END)) &#123;</div><div class="line">       String value = sqlParser.getLexer().getCurrentToken().getLiterals();</div><div class="line">       <span class="keyword">int</span> position = sqlParser.getLexer().getCurrentToken().getEndPosition() - value.length();</div><div class="line">       expression.append(value);</div><div class="line">       lastToken = sqlParser.getLexer().getCurrentToken();</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       <span class="keyword">if</span> (sqlParser.equalAny(Symbol.DOT)) &#123;</div><div class="line">           selectStatement.getSqlTokens().add(<span class="keyword">new</span> TableToken(position, value));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ä¸å¸¦ ASï¼Œå¹¶ä¸”æœ‰åˆ«åï¼Œå¹¶ä¸”åˆ«åä¸ç­‰äºè‡ªå·±ï¼ˆtipsï¼šè¿™é‡Œé‡ç‚¹çœ‹ã€‚åˆ¤æ–­è¿™ä¹ˆå¤æ‚çš„åŸå› ï¼šé˜²æ­¢substringæ“ä½œæˆªå–ç»“æœé”™è¯¯ï¼‰</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != lastToken &amp;&amp; Literals.IDENTIFIER == lastToken.getType()</div><div class="line">           &amp;&amp; !isSQLPropertyExpression(expression, lastToken) <span class="comment">// è¿‡æ»¤æ‰ï¼Œåˆ«åæ˜¯è‡ªå·±çš„æƒ…å†µã€1ã€‘ï¼ˆä¾‹å¦‚ï¼ŒSELECT u.user_id u.user_id FROM t_userï¼‰</span></div><div class="line">           &amp;&amp; !expression.toString().equals(lastToken.getLiterals())) &#123; <span class="comment">// è¿‡æ»¤æ‰ï¼Œæ— åˆ«åçš„æƒ…å†µã€2ã€‘ï¼ˆä¾‹å¦‚ï¼ŒSELECT user_id FROM t_userï¼‰</span></div><div class="line">       selectStatement.getItems().add(</div><div class="line">               <span class="keyword">new</span> CommonSelectItem(SQLUtil.getExactlyValue(expression.substring(<span class="number">0</span>, expression.lastIndexOf(lastToken.getLiterals()))), Optional.of(lastToken.getLiterals())));</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å¸¦ ASï¼ˆä¾‹å¦‚ï¼ŒSELECT user_id AS userIdï¼‰ æˆ–è€… æ— åˆ«åï¼ˆä¾‹å¦‚ï¼ŒSELECT user_idï¼‰</span></div><div class="line">   selectStatement.getItems().add(<span class="keyword">new</span> CommonSelectItem(SQLUtil.getExactlyValue(expression.toString()), sqlParser.parseAlias()));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸€å…±åˆ†æˆ 4 ç§å¤§çš„æƒ…å†µï¼Œæˆ‘ä»¬æ¥é€æ¡æ¢³ç†ï¼š</p>
<ul>
<li>ç¬¬ä¸€ç§ï¼š<strong><code>*</code> é€šç”¨é€‰æ‹©é¡¹</strong>ï¼š<br>ä¾‹å¦‚ï¼Œ<code>SELECT * FROM t_user</code> çš„ <code>*</code>ã€‚<br>ä¸ºä»€ä¹ˆè¦åŠ    <code>Symbol.STAR.getLiterals().equals(SQLUtil.getExactlyValue(literals))</code> åˆ¤æ–­å‘¢ï¼Ÿ  </li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="string">`*`</span> <span class="keyword">FROM</span> t_user; // ä¹Ÿèƒ½è¾¾åˆ°æŸ¥è¯¢æ‰€æœ‰å­—æ®µçš„æ•ˆæœ</div></pre></td></tr></table></figure>
<ul>
<li>ç¬¬äºŒç§ï¼š<strong>èšåˆé€‰æ‹©é¡¹</strong>ï¼š<br>ä¾‹å¦‚ï¼Œ<code>SELECT COUNT(user_id) FROM t_user</code> çš„ <code>COUNT(user_id)</code>ã€‚</li>
</ul>
<p>è§£æç»“æœ AggregationSelectItemï¼š<br><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/05.png" alt=""></p>
<p><code>sqlParser.skipParentheses()</code> è§£æè§<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹çš„AbstractParserå°èŠ‚</a>ã€‚</p>
<ul>
<li>ç¬¬ä¸‰ç§ï¼š<strong>é <code>*</code> é€šç”¨é€‰æ‹©é¡¹</strong>ï¼š</li>
</ul>
<p>ä¾‹å¦‚ï¼Œ<code>SELECT user_id FROM t_user</code>ã€‚</p>
<p>ä»å®ç°ä¸Šï¼Œé€»è¾‘ä¼šå¤æ‚å¾ˆå¤šã€‚ç›¸æ¯”ç¬¬ä¸€ç§ï¼Œå¯ä»¥æ ¹æ® <code>*</code> åšå­—æ®µåˆ¤æ–­ï¼›ç›¸æ¯”ç¬¬äºŒç§ï¼Œå¯ä»¥ä½¿ç”¨ <code>(</code> å’Œ <code>)</code> åšå­—æ®µåˆ¤æ–­ã€‚èƒ½å¤Ÿåˆ¤æ–­ä¸€ä¸ª<strong>åŒ…å«åˆ«åçš„</strong> SelectItem ç»“æŸæœ‰ 4 ç§ Tokenï¼Œæ ¹æ®ç»“æŸæ–¹å¼æˆ‘ä»¬åˆ†æˆ 2 ç§ï¼š</p>
<ul>
<li>DefaultKeyword.AS ï¼šèƒ½å¤Ÿæ¥è§¦å‡º SelectItem å­—æ®µï¼Œ<strong>å³ä¸åŒ…å«åˆ«å</strong>ã€‚ä¾‹å¦‚ï¼Œ<code>SELECT user_id AS uid FROM t_user</code>ï¼Œèƒ½å¤Ÿç›´æ¥è§£æå‡º <code>user_id</code>ã€‚</li>
<li>Symbol.COMMA / DefaultKeyword.FROM / Assist.END ï¼š<strong>åŒ…å«åˆ«å</strong>ã€‚ä¾‹å¦‚ï¼Œ<code>SELECT user_id uid FROM t_user</code>ï¼Œè§£æç»“æœä¸º <code>user_id uid</code>ã€‚</li>
</ul>
<p>åŸºäºè¿™ä¸ªåœ¨é…åˆä¸Šé¢çš„ä»£ç æ³¨é‡Šï¼Œå¤§å®¶å†é‡æ–°ç†è§£ä¸‹ç¬¬ä¸‰ç§æƒ…å†µçš„å®ç°ã€‚</p>
<ul>
<li>ç¬¬å››ç§ï¼šSQLServer ROW_NUMBERï¼š</li>
</ul>
<p>ROW_NUMBER æ˜¯ SQLServer ç‹¬æœ‰çš„ã€‚ç”±äºæœ¬æ–‡å¤§éƒ¨åˆ†çš„è¯»è€…ä½¿ç”¨çš„ MySQL / Oracleï¼Œå°±è·³è¿‡äº†ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ <a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/9354031743b63e44cbded5618980ae71a15f0260/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/parsing/parser/dialect/sqlserver/SQLServerSelectParser.java" rel="external nofollow noopener noreferrer" target="_blank">SQLServerSelectParser#parseRowNumberSelectItem()</a> æ–¹æ³•ã€‚</p>
<h3 id="3-2-2-parseAlias-è§£æåˆ«å"><a href="#3-2-2-parseAlias-è§£æåˆ«å" class="headerlink" title="3.2.2 #parseAlias() è§£æåˆ«å"></a>3.2.2 #parseAlias() è§£æåˆ«å</h3><p>è§£æåˆ«åï¼Œåˆ†æˆæ˜¯å¦å¸¦ <code>AS</code> ä¸¤ç§æƒ…å†µã€‚è§£æä»£ç ï¼š<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹çš„#parseAlias()å°èŠ‚</a>ã€‚</p>
<h3 id="3-2-3-TableToken-è¡¨æ ‡è®°å¯¹è±¡"><a href="#3-2-3-TableToken-è¡¨æ ‡è®°å¯¹è±¡" class="headerlink" title="3.2.3 TableToken è¡¨æ ‡è®°å¯¹è±¡"></a>3.2.3 TableToken è¡¨æ ‡è®°å¯¹è±¡</h3><p>TableTokenï¼Œè®°å½•è¡¨ååœ¨ SQL é‡Œå‡ºç°çš„<strong>ä½ç½®</strong>å’Œ<strong>åå­—</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TableToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¡¨è¾¾å¼</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String originalLiterals;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–è¡¨åç§°.</div><div class="line">     * <span class="doctag">@return</span> è¡¨åç§°</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTableName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> SQLUtil.getExactlyValue(originalLiterals);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ä¸Šæ–‡ç¬¬ä¸‰ç§æƒ…å†µã€‚<br><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/06.png" alt=""></p>
<h2 id="3-3-skipToFrom"><a href="#3-3-skipToFrom" class="headerlink" title="3.3 #skipToFrom()"></a>3.3 #skipToFrom()</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* è·³åˆ° FROM å¤„</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">skipToFrom</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">while</span> (!getSqlParser().equalAny(DefaultKeyword.FROM) &amp;&amp; !getSqlParser().equalAny(Assist.END)) &#123;</div><div class="line">       getSqlParser().getLexer().nextToken();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-4-parseFrom"><a href="#3-4-parseFrom" class="headerlink" title="3.4 #parseFrom()"></a>3.4 #parseFrom()</h2><p>è§£æè¡¨ä»¥åŠè¡¨è¿æ¥å…³ç³»ã€‚<strong>è¿™å—ç›¸å¯¹æ¯”è¾ƒå¤æ‚ï¼Œè¯·å¤§å®¶è€å¿ƒ+è€å¿ƒ+è€å¿ƒã€‚</strong></p>
<p><strong>MySQL JOIN Syntax</strong>ï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">// https://dev.mysql.com/doc/refman/5.7/en/join.html</div><div class="line">table_references:</div><div class="line">    escaped_table_reference [, escaped_table_reference] ...</div><div class="line"></div><div class="line">escaped_table_reference:</div><div class="line">    table_reference</div><div class="line">  | &#123; OJ table_reference &#125;</div><div class="line"></div><div class="line">table_reference:</div><div class="line">    table_factor</div><div class="line">  | join_table</div><div class="line"></div><div class="line">table_factor:</div><div class="line">    tbl_name [PARTITION (partition_names)]</div><div class="line">        [[AS] alias] [index_hint_list]</div><div class="line">  | table_subquery [AS] alias</div><div class="line">  | ( table_references )</div><div class="line"></div><div class="line">join_table:</div><div class="line">    table_reference [INNER | CROSS] JOIN table_factor [join_condition]</div><div class="line">  | table_reference STRAIGHT_JOIN table_factor</div><div class="line">  | table_reference STRAIGHT_JOIN table_factor ON conditional_expr</div><div class="line">  | table_reference &#123;LEFT|RIGHT&#125; [OUTER] JOIN table_reference join_condition</div><div class="line">  | table_reference NATURAL [&#123;LEFT|RIGHT&#125; [OUTER]] JOIN table_factor</div><div class="line"></div><div class="line">join_condition:</div><div class="line">    ON conditional_expr</div><div class="line">  | USING (column_list)</div><div class="line"></div><div class="line">index_hint_list:</div><div class="line">    index_hint [, index_hint] ...</div><div class="line"></div><div class="line">index_hint:</div><div class="line">    USE &#123;INDEX|KEY&#125;</div><div class="line">      [FOR &#123;JOIN|ORDER BY|GROUP BY&#125;] ([index_list])</div><div class="line">  | IGNORE &#123;INDEX|KEY&#125;</div><div class="line">      [FOR &#123;JOIN|ORDER BY|GROUP BY&#125;] (index_list)</div><div class="line">  | FORCE &#123;INDEX|KEY&#125;</div><div class="line">      [FOR &#123;JOIN|ORDER BY|GROUP BY&#125;] (index_list)</div><div class="line"></div><div class="line">index_list:</div><div class="line">    index_name [, index_name] ...</div></pre></td></tr></table></figure>
<h3 id="3-4-1-JOIN-ON-FROM-TABLE"><a href="#3-4-1-JOIN-ON-FROM-TABLE" class="headerlink" title="3.4.1 JOIN ON / FROM TABLE"></a>3.4.1 JOIN ON / FROM TABLE</h3><p>å…ˆæŠ›å¼€<strong>å­æŸ¥è¯¢</strong>çš„æƒ…å†µï¼Œåªè€ƒè™‘å¦‚ä¸‹ä¸¤ç§ SQL æƒ…å†µã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">// JOIN ON ï¼š å®é™…å¯ä»¥ç»§ç»­ JOIN ON æ›´å¤šè¡¨</div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o <span class="keyword">JOIN</span> t_order_item i <span class="keyword">ON</span> o.order_id = i.order_id; </div><div class="line">// FROM å¤šè¡¨ ï¼šå®é™…å¯ä»¥ç»§ç»­ FROM å¤šæ›´è¡¨</div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o, t_order_item i</div></pre></td></tr></table></figure>
<p>åœ¨çœ‹å®ç°ä»£ç ä¹‹å‰ï¼Œå…ˆä¸€èµ·çœ‹ä¸‹è°ƒç”¨é¡ºåºå›¾ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/02.png" alt=""></p>
<p>çœ‹æ‡‚ä¸Šå›¾åï¼Œæ¥ç»§ç»­çœ‹ä¸‹å®ç°ä»£ç ï¼ˆğŸ™‚<strong>ä»£ç æœ‰ç‚¹å¤šï¼Œä¸è¦æ–¹ï¼</strong>ï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£ææ‰€æœ‰è¡¨åå’Œè¡¨åˆ«å</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseFrom</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.FROM)) &#123;</div><div class="line">       parseTable();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£ææ‰€æœ‰è¡¨åå’Œè¡¨åˆ«å</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseTable</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è§£æå­æŸ¥è¯¢</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(Symbol.LEFT_PAREN)) &#123;</div><div class="line">       <span class="keyword">if</span> (!selectStatement.getTables().isEmpty()) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support subquery for nested tables."</span>);</div><div class="line">       &#125;</div><div class="line">       selectStatement.setContainStar(<span class="keyword">false</span>);</div><div class="line">       sqlParser.skipUselessParentheses(); <span class="comment">// å»æ‰å­æŸ¥è¯¢å·¦æ‹¬å·</span></div><div class="line">       parse(); <span class="comment">// è§£æå­æŸ¥è¯¢ SQL</span></div><div class="line">       sqlParser.skipUselessParentheses(); <span class="comment">// å»æ‰å­æŸ¥è¯¢å³æ‹¬å·</span></div><div class="line">       <span class="comment">//</span></div><div class="line">       <span class="keyword">if</span> (!selectStatement.getTables().isEmpty()) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   parseTableFactor(); <span class="comment">// è§£æå½“å‰è¡¨</span></div><div class="line">   parseJoinTable(); <span class="comment">// è§£æä¸‹ä¸€ä¸ªè¡¨</span></div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æå•ä¸ªè¡¨åå’Œè¡¨åˆ«å</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseTableFactor</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> beginPosition = sqlParser.getLexer().getCurrentToken().getEndPosition() - sqlParser.getLexer().getCurrentToken().getLiterals().length();</div><div class="line">   String literals = sqlParser.getLexer().getCurrentToken().getLiterals();</div><div class="line">   sqlParser.getLexer().nextToken();</div><div class="line">   <span class="comment">// TODO åŒ…å«Schemaè§£æ</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(Symbol.DOT)) &#123; <span class="comment">// https://dev.mysql.com/doc/refman/5.7/en/information-schema.html ï¼šSELECT table_name, table_type, engine FROM information_schema.tables</span></div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       sqlParser.parseAlias();</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// FIXME æ ¹æ®shardingRuleè¿‡æ»¤table</span></div><div class="line">   selectStatement.getSqlTokens().add(<span class="keyword">new</span> TableToken(beginPosition, literals));</div><div class="line">   <span class="comment">// è¡¨ ä»¥åŠ è¡¨åˆ«å</span></div><div class="line">   selectStatement.getTables().add(<span class="keyword">new</span> Table(SQLUtil.getExactlyValue(literals), sqlParser.parseAlias()));</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æ Join Table æˆ–è€… FROM ä¸‹ä¸€å¼  Table</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseJoinTable</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.skipJoin()) &#123;</div><div class="line">       <span class="comment">// è¿™é‡Œè°ƒç”¨ parseJoinTable() è€Œä¸æ˜¯ parseTableFactor() ï¼šä¸‹ä¸€ä¸ª Table å¯èƒ½æ˜¯å­æŸ¥è¯¢</span></div><div class="line">       <span class="comment">// ä¾‹å¦‚ï¼šSELECT * FROM t_order JOIN (SELECT * FROM t_order_item JOIN t_order_other ON ) .....</span></div><div class="line">       parseTable();</div><div class="line">       <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.ON)) &#123; <span class="comment">// JOIN è¡¨æ—¶ ON æ¡ä»¶</span></div><div class="line">           <span class="keyword">do</span> &#123;</div><div class="line">               parseTableCondition(sqlParser.getLexer().getCurrentToken().getEndPosition());</div><div class="line">               sqlParser.accept(Symbol.EQ);</div><div class="line">               parseTableCondition(sqlParser.getLexer().getCurrentToken().getEndPosition() - sqlParser.getLexer().getCurrentToken().getLiterals().length());</div><div class="line">           &#125; <span class="keyword">while</span> (sqlParser.skipIfEqual(DefaultKeyword.AND));</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.USING)) &#123; <span class="comment">// JOIN è¡¨æ—¶ USING ä¸ºä½¿ç”¨ä¸¤è¡¨ç›¸åŒå­—æ®µç›¸åŒæ—¶å¯¹ ON çš„ç®€åŒ–ã€‚ä¾‹å¦‚ä»¥ä¸‹ä¸¤æ¡ SQL ç­‰ä»·ï¼š</span></div><div class="line">                                                                   <span class="comment">// SELECT * FROM t_order o JOIN t_order_item i USING (order_id);</span></div><div class="line">                                                                   <span class="comment">// SELECT * FROM t_order o JOIN t_order_item i ON o.order_id = i.order_id</span></div><div class="line">           sqlParser.skipParentheses();</div><div class="line">       &#125;</div><div class="line">       parseJoinTable(); <span class="comment">// ç»§ç»­é€’å½’</span></div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æ ON æ¡ä»¶é‡Œçš„ TableToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> startPosition å¼€å§‹ä½ç½®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseTableCondition</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> startPosition)</span> </span>&#123;</div><div class="line">   SQLExpression sqlExpression = sqlParser.parseExpression();</div><div class="line">   <span class="keyword">if</span> (!(sqlExpression <span class="keyword">instanceof</span> SQLPropertyExpression)) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   SQLPropertyExpression sqlPropertyExpression = (SQLPropertyExpression) sqlExpression;</div><div class="line">   <span class="keyword">if</span> (selectStatement.getTables().getTableNames().contains(SQLUtil.getExactlyValue(sqlPropertyExpression.getOwner().getName()))) &#123;</div><div class="line">       selectStatement.getSqlTokens().add(<span class="keyword">new</span> TableToken(startPosition, sqlPropertyExpression.getOwner().getName()));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>OKï¼Œé€’å½’å› ä¸ºå¹³æ—¶æ—¥å¸¸ä¸­å†™çš„æ¯”è¾ƒå°‘ï¼Œå¯èƒ½ç†è§£èµ·æ¥å¯èƒ½ä¼šå›°éš¾ä¸€äº›ï¼ŒåŠªåŠ›çœ‹æ‡‚ï¼ğŸ™‚<strong>å¦‚æœçœŸçš„çœ‹ä¸æ‡‚ï¼Œå¯ä»¥åŠ å¾®ä¿¡å…¬ä¼—å·ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">èŠ‹è‰¿çš„åç«¯å°å±‹</a>ï¼‰ï¼Œæˆ‘æ¥å¸®ä½ ä¸€èµ·ç†è§£ã€‚</strong></p>
<h3 id="3-4-2-å­æŸ¥è¯¢"><a href="#3-4-2-å­æŸ¥è¯¢" class="headerlink" title="3.4.2 å­æŸ¥è¯¢"></a>3.4.2 å­æŸ¥è¯¢</h3><p>Sharding-JDBC ç›®å‰æ”¯æŒ<strong>ç¬¬ä¸€ä¸ª</strong>åŒ…å«å¤šå±‚çº§çš„æ•°æ®å­æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> o3.* <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o) o2) o3;</div><div class="line"><span class="keyword">SELECT</span> o3.* <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o) o2) o3 <span class="keyword">JOIN</span> t_order_item i <span class="keyword">ON</span> o3.order_id = i.order_id;</div></pre></td></tr></table></figure>
<p>ä¸æ”¯æŒ<strong>ç¬¬äºŒä¸ªå¼€å§‹</strong>åŒ…å«å¤šå±‚çº§çš„æ•°æ®å­æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> o3.* <span class="keyword">FROM</span> t_order_item i <span class="keyword">JOIN</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o) o2) o3 <span class="keyword">ON</span> o3.order_id = i.order_id; // æ­¤æ¡ SQL æ˜¯ä¸Šé¢ç¬¬äºŒæ¡ SQL å·¦å³é‡è¡¨é¢ å€’</div><div class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o <span class="keyword">WHERE</span> o.id <span class="keyword">IN</span> (<span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> t_order <span class="keyword">WHERE</span> <span class="keyword">status</span> = ?)) // <span class="keyword">FROM</span> å®˜æ–¹ä¸æ”¯æŒ <span class="keyword">SQL</span> ä¸¾ä¾‹</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨<strong>ç¬¬äºŒä¸ªå¼€å§‹</strong>çš„å­æŸ¥è¯¢ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// AbstractSelectParser.java#parseTable()ç‰‡æ®µ</div><div class="line">if (!selectStatement.getTables().isEmpty()) &#123;</div><div class="line">    throw new UnsupportedOperationException(&quot;Cannot support subquery for nested tables.&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨å­æŸ¥è¯¢ï¼Œå»ºè®®è®¤çœŸé˜…è¯»å®˜æ–¹<a href="http://dangdangdotcom.github.io/sharding-jdbc/02-guide/subquery/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šåˆ†é¡µåŠå­æŸ¥è¯¢ã€‹</a>æ–‡æ¡£ã€‚</p>
<h3 id="3-4-3-parseJoinTable"><a href="#3-4-3-parseJoinTable" class="headerlink" title="3.4.3 #parseJoinTable()"></a>3.4.3 #parseJoinTable()</h3><p>MySQLSelectParser é‡å†™äº† <code>#parseJoinTable()</code> æ–¹æ³•ç”¨äºè§£æ USE / IGNORE / FORCE index_hintã€‚å…·ä½“è¯­æ³•è§ä¸Šæ–‡ <strong>JOIN Syntax</strong>ã€‚è¿™é‡Œå°±è·³è¿‡ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»çœ‹çœ‹ã€‚</p>
<h3 id="3-4-4-Tables-è¡¨é›†åˆå¯¹è±¡"><a href="#3-4-4-Tables-è¡¨é›†åˆå¯¹è±¡" class="headerlink" title="3.4.4 Tables è¡¨é›†åˆå¯¹è±¡"></a>3.4.4 Tables è¡¨é›†åˆå¯¹è±¡</h3><p><strong>å±äºåˆ†ç‰‡ä¸Šä¸‹æ–‡ä¿¡æ¯</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Tables.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Tables</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Table&gt; tables = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Table.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Table</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¡¨</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ«å</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Optional&lt;String&gt; alias;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// AbstractSelectParser.java#parseTableFactor()ç‰‡æ®µ</span></div><div class="line">selectStatement.getTables().add(<span class="keyword">new</span> Table(SQLUtil.getExactlyValue(literals), sqlParser.parseAlias()));</div></pre></td></tr></table></figure>
<h2 id="3-5-parseWhere"><a href="#3-5-parseWhere" class="headerlink" title="3.5 #parseWhere()"></a>3.5 #parseWhere()</h2><p>è§£æ WHERE æ¡ä»¶ã€‚è§£æä»£ç ï¼š<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹çš„#parseWhere()å°èŠ‚</a>ã€‚</p>
<h2 id="3-6-parseGroupBy"><a href="#3-6-parseGroupBy" class="headerlink" title="3.6 #parseGroupBy()"></a>3.6 #parseGroupBy()</h2><p>è§£æåˆ†ç»„æ¡ä»¶ï¼Œå®ç°ä¸Šæ¯”è¾ƒç±»ä¼¼ <code>#parseSelectList</code>ï¼Œä¼šæ›´åŠ ç®€å•ä¸€äº›ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æ Group By å’Œ Havingï¼ˆæš‚æ—¶ä¸æ”¯æŒï¼‰</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseGroupBy</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.GROUP)) &#123;</div><div class="line">       sqlParser.accept(DefaultKeyword.BY);</div><div class="line">       <span class="comment">// è§£æ Group By æ¯ä¸ªå­—æ®µ</span></div><div class="line">       <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">           addGroupByItem(sqlParser.parseExpression(selectStatement));</div><div class="line">           <span class="keyword">if</span> (!sqlParser.equalAny(Symbol.COMMA)) &#123;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           sqlParser.getLexer().nextToken();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">while</span> (sqlParser.equalAny(DefaultKeyword.WITH) || sqlParser.getLexer().getCurrentToken().getLiterals().equalsIgnoreCase(<span class="string">"ROLLUP"</span>)) &#123;</div><div class="line">           sqlParser.getLexer().nextToken();</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// Havingï¼ˆæš‚æ—¶ä¸æ”¯æŒï¼‰</span></div><div class="line">       <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.HAVING)) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support Having"</span>);</div><div class="line">       &#125;</div><div class="line">       selectStatement.setGroupByLastPosition(sqlParser.getLexer().getCurrentToken().getEndPosition());</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.HAVING)) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support Having"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æ Group By å•ä¸ªå­—æ®µ</div><div class="line">* Group By æ¡ä»¶æ˜¯å¸¦æœ‰æ’åºåŠŸèƒ½ï¼Œé»˜è®¤ASC</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlExpression è¡¨è¾¾å¼</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addGroupByItem</span><span class="params">(<span class="keyword">final</span> SQLExpression sqlExpression)</span> </span>&#123;</div><div class="line">   <span class="comment">// Group By å­—æ®µ DESC / ASC / ;é»˜è®¤æ˜¯ ASCã€‚</span></div><div class="line">   OrderType orderByType = OrderType.ASC;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.ASC)) &#123;</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.DESC)) &#123;</div><div class="line">       orderByType = OrderType.DESC;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è§£æ OrderItem</span></div><div class="line">   OrderItem orderItem;</div><div class="line">   <span class="keyword">if</span> (sqlExpression <span class="keyword">instanceof</span> SQLPropertyExpression) &#123;</div><div class="line">       SQLPropertyExpression sqlPropertyExpression = (SQLPropertyExpression) sqlExpression;</div><div class="line">       orderItem = <span class="keyword">new</span> OrderItem(SQLUtil.getExactlyValue(sqlPropertyExpression.getOwner().getName()), SQLUtil.getExactlyValue(sqlPropertyExpression.getName()), orderByType,</div><div class="line">               getAlias(SQLUtil.getExactlyValue(sqlPropertyExpression.getOwner() + <span class="string">"."</span> + SQLUtil.getExactlyValue(sqlPropertyExpression.getName()))));</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlExpression <span class="keyword">instanceof</span> SQLIdentifierExpression) &#123;</div><div class="line">       SQLIdentifierExpression sqlIdentifierExpression = (SQLIdentifierExpression) sqlExpression;</div><div class="line">       orderItem = <span class="keyword">new</span> OrderItem(SQLUtil.getExactlyValue(sqlIdentifierExpression.getName()), orderByType, getAlias(SQLUtil.getExactlyValue(sqlIdentifierExpression.getName())));</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   selectStatement.getGroupByItems().add(orderItem);</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* å­—æ®µåœ¨æŸ¥è¯¢é¡¹é‡Œçš„åˆ«å</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> name å­—æ®µ</div><div class="line">* <span class="doctag">@return</span> åˆ«å</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Optional&lt;String&gt; <span class="title">getAlias</span><span class="params">(<span class="keyword">final</span> String name)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (selectStatement.isContainStar()) &#123;</div><div class="line">       <span class="keyword">return</span> Optional.absent();</div><div class="line">   &#125;</div><div class="line">   String rawName = SQLUtil.getExactlyValue(name);</div><div class="line">   <span class="keyword">for</span> (SelectItem each : selectStatement.getItems()) &#123;</div><div class="line">       <span class="keyword">if</span> (rawName.equalsIgnoreCase(SQLUtil.getExactlyValue(each.getExpression()))) &#123;</div><div class="line">           <span class="keyword">return</span> each.getAlias();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (rawName.equalsIgnoreCase(each.getAlias().orNull())) &#123;</div><div class="line">           <span class="keyword">return</span> Optional.of(rawName);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> Optional.absent();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-6-1-OrderItem-æ’åºé¡¹"><a href="#3-6-1-OrderItem-æ’åºé¡¹" class="headerlink" title="3.6.1 OrderItem æ’åºé¡¹"></a>3.6.1 OrderItem æ’åºé¡¹</h3><p><strong>å±äºåˆ†ç‰‡ä¸Šä¸‹æ–‡ä¿¡æ¯</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderItem</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * æ‰€å±è¡¨åˆ«å</div><div class="line">    */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Optional&lt;String&gt; owner;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * æ’åºå­—æ®µ</div><div class="line">    */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Optional&lt;String&gt; name;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * æ’åºç±»å‹</div><div class="line">    */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderType type;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * æŒ‰ç…§ç¬¬å‡ ä¸ªæŸ¥è¯¢å­—æ®µæ’åº</div><div class="line">    * ORDER BY æ•°å­— çš„ æ•°å­—ä»£è¡¨çš„æ˜¯ç¬¬å‡ ä¸ªå­—æ®µ</div><div class="line">    */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index = -<span class="number">1</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * å­—æ®µåœ¨æŸ¥è¯¢é¡¹(&#123;<span class="doctag">@link</span> com.dangdang.ddframe.rdb.sharding.parsing.parser.context.selectitem.SelectItem&#125; çš„åˆ«å</div><div class="line">    */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> Optional&lt;String&gt; alias;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-7-parseOrderBy"><a href="#3-7-parseOrderBy" class="headerlink" title="3.7 #parseOrderBy()"></a>3.7 #parseOrderBy()</h2><p>è§£ææ’åºæ¡ä»¶ã€‚å®ç°é€»è¾‘ç±»ä¼¼ <code>#parseGroupBy()</code>ï¼Œè¿™é‡Œå°±è·³è¿‡ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»çœ‹çœ‹ã€‚</p>
<h2 id="3-8-parseLimit"><a href="#3-8-parseLimit" class="headerlink" title="3.8 #parseLimit()"></a>3.8 #parseLimit()</h2><p>è§£æåˆ†é¡µ Limit æ¡ä»¶ã€‚ç›¸å¯¹ç®€å•ï¼Œè¿™é‡Œå°±è·³è¿‡ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»çœ‹çœ‹ã€‚æ³¨æ„ä¸‹ï¼Œåˆ†æˆ 3 ç§æƒ…å†µï¼š</p>
<ul>
<li>LIMIT row_count</li>
<li>LIMIT offset, row_count</li>
<li>LIMIT row_count OFFSET offset</li>
</ul>
<h3 id="3-8-1-Limit"><a href="#3-8-1-Limit" class="headerlink" title="3.8.1 Limit"></a>3.8.1 Limit</h3><p>åˆ†é¡µå¯¹è±¡ã€‚<strong>å±äºåˆ†ç‰‡ä¸Šä¸‹æ–‡ä¿¡æ¯</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Limit.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Limit</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ˜¯å¦é‡å†™rowCount</div><div class="line">     * TODO å¾…è¡¥å……ï¼šé¢„è®¡å’Œå†…å­˜åˆ†é¡µåˆå¹¶æœ‰å…³</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> rowCountRewriteFlag;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * offset</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> LimitValue offset;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * row</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> LimitValue rowCount;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// LimitValue.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LimitValue</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å€¼</div><div class="line">     * å½“ value == -1 æ—¶ï¼Œä¸ºå ä½ç¬¦</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> value;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç¬¬å‡ ä¸ªå ä½ç¬¦</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-8-2-OffsetToken-RowCountToken"><a href="#3-8-2-OffsetToken-RowCountToken" class="headerlink" title="3.8.2 OffsetToken RowCountToken"></a>3.8.2 OffsetToken RowCountToken</h3><ul>
<li>OffsetTokenï¼šåˆ†é¡µåç§»é‡æ ‡è®°å¯¹è±¡</li>
<li>RowCountTokenï¼šåˆ†é¡µé•¿åº¦æ ‡è®°å¯¹è±¡</li>
</ul>
<p><strong>åªæœ‰åœ¨å¯¹åº”ä½ç½®éå ä½ç¬¦æ‰æœ‰è¯¥ SQLToken</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// OffsetToken.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OffsetToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL æ‰€åœ¨å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åç§»å€¼</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> offset;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RowCountToken.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RowCountToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL æ‰€åœ¨å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¡Œæ•°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> rowCount;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-9-queryRest"><a href="#3-9-queryRest" class="headerlink" title="3.9 #queryRest()"></a>3.9 #queryRest()</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">queryRest</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.UNION, DefaultKeyword.EXCEPT, DefaultKeyword.INTERSECT, DefaultKeyword.MINUS)) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(sqlParser.getLexer().getCurrentToken().getType());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸æ”¯æŒ UNION / EXCEPT / INTERSECT / MINUS ï¼Œè°ƒç”¨ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<h1 id="4-appendDerivedç­‰æ–¹æ³•"><a href="#4-appendDerivedç­‰æ–¹æ³•" class="headerlink" title="4. appendDerivedç­‰æ–¹æ³•"></a>4. appendDerivedç­‰æ–¹æ³•</h1><p>å› ä¸º Sharding-JDBC å¯¹è¡¨åšäº†åˆ†ç‰‡ï¼Œåœ¨ AVG , GROUP BY , ORDER BY éœ€è¦å¯¹ SQL è¿›è¡Œä¸€äº›æ”¹å†™ï¼Œ<strong>ä»¥è¾¾åˆ°èƒ½åœ¨å†…å­˜é‡Œå¯¹ç»“æœåšè¿›ä¸€æ­¥å¤„ç†</strong>ï¼Œä¾‹å¦‚æ±‚å¹³å‡å€¼ã€åˆ†ç»„ã€æ’åºç­‰ã€‚</p>
<p>ğŸ˜ˆï¼šæ‰“èµ·ç²¾ç¥ï¼Œæ­¤å—æ˜¯éå¸¸æœ‰è¶£çš„ã€‚</p>
<h2 id="4-1-appendAvgDerivedColumns"><a href="#4-1-appendAvgDerivedColumns" class="headerlink" title="4.1 appendAvgDerivedColumns"></a>4.1 appendAvgDerivedColumns</h2><p>è§£å†³ AVG æŸ¥è¯¢ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* é’ˆå¯¹ AVG èšåˆå­—æ®µï¼Œå¢åŠ æ¨å¯¼å­—æ®µ</div><div class="line">* AVG æ”¹å†™æˆ SUM + COUNT æŸ¥è¯¢ï¼Œå†…å­˜è®¡ç®—å‡º AVG ç»“æœã€‚</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> itemsToken é€‰æ‹©é¡¹æ ‡è®°å¯¹è±¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendAvgDerivedColumns</span><span class="params">(<span class="keyword">final</span> ItemsToken itemsToken)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> derivedColumnOffset = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (SelectItem each : selectStatement.getItems()) &#123;</div><div class="line">       <span class="keyword">if</span> (!(each <span class="keyword">instanceof</span> AggregationSelectItem) || AggregationType.AVG != ((AggregationSelectItem) each).getType()) &#123;</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       AggregationSelectItem avgItem = (AggregationSelectItem) each;</div><div class="line">       <span class="comment">// COUNT å­—æ®µ</span></div><div class="line">       String countAlias = String.format(DERIVED_COUNT_ALIAS, derivedColumnOffset);</div><div class="line">       AggregationSelectItem countItem = <span class="keyword">new</span> AggregationSelectItem(AggregationType.COUNT, avgItem.getInnerExpression(), Optional.of(countAlias));</div><div class="line">       <span class="comment">// SUM å­—æ®µ</span></div><div class="line">       String sumAlias = String.format(DERIVED_SUM_ALIAS, derivedColumnOffset);</div><div class="line">       AggregationSelectItem sumItem = <span class="keyword">new</span> AggregationSelectItem(AggregationType.SUM, avgItem.getInnerExpression(), Optional.of(sumAlias));</div><div class="line">       <span class="comment">// AggregationSelectItem è®¾ç½®</span></div><div class="line">       avgItem.getDerivedAggregationSelectItems().add(countItem);</div><div class="line">       avgItem.getDerivedAggregationSelectItems().add(sumItem);</div><div class="line">       <span class="comment">// TODO å°†AVGåˆ—æ›¿æ¢æˆå¸¸æ•°ï¼Œé¿å…æ•°æ®åº“å†è®¡ç®—æ— ç”¨çš„AVGå‡½æ•°</span></div><div class="line">       <span class="comment">// ItemsToken</span></div><div class="line">       itemsToken.getItems().add(countItem.getExpression() + <span class="string">" AS "</span> + countAlias + <span class="string">" "</span>);</div><div class="line">       itemsToken.getItems().add(sumItem.getExpression() + <span class="string">" AS "</span> + sumAlias + <span class="string">" "</span>);</div><div class="line">       <span class="comment">//</span></div><div class="line">       derivedColumnOffset++;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-2-appendDerivedOrderColumns"><a href="#4-2-appendDerivedOrderColumns" class="headerlink" title="4.2 appendDerivedOrderColumns"></a>4.2 appendDerivedOrderColumns</h2><p>è§£å†³ GROUP BY , ORDER BYã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* é’ˆå¯¹ GROUP BY æˆ– ORDER BY å­—æ®µï¼Œå¢åŠ æ¨å¯¼å­—æ®µ</div><div class="line">* å¦‚æœè¯¥å­—æ®µä¸åœ¨æŸ¥è¯¢å­—æ®µé‡Œï¼Œéœ€è¦é¢å¤–æŸ¥è¯¢è¯¥å­—æ®µï¼Œè¿™æ ·æ‰èƒ½åœ¨å†…å­˜é‡Œ GROUP BY æˆ– ORDER BY</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> itemsToken é€‰æ‹©é¡¹æ ‡è®°å¯¹è±¡</div><div class="line">* <span class="doctag">@param</span> orderItems æ’åºå­—æ®µ</div><div class="line">* <span class="doctag">@param</span> aliasPattern åˆ«åæ¨¡å¼</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendDerivedOrderColumns</span><span class="params">(<span class="keyword">final</span> ItemsToken itemsToken, <span class="keyword">final</span> List&lt;OrderItem&gt; orderItems, <span class="keyword">final</span> String aliasPattern)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> derivedColumnOffset = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (OrderItem each : orderItems) &#123;</div><div class="line">       <span class="keyword">if</span> (!isContainsItem(each)) &#123;</div><div class="line">           String alias = String.format(aliasPattern, derivedColumnOffset++);</div><div class="line">           each.setAlias(Optional.of(alias));</div><div class="line">           itemsToken.getItems().add(each.getQualifiedName().get() + <span class="string">" AS "</span> + alias + <span class="string">" "</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* æŸ¥è¯¢å­—æ®µæ˜¯å¦åŒ…å«æ’åºå­—æ®µ</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> orderItem æ’åºå­—æ®µ</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isContainsItem</span><span class="params">(<span class="keyword">final</span> OrderItem orderItem)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (selectStatement.isContainStar()) &#123; <span class="comment">// SELECT *</span></div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (SelectItem each : selectStatement.getItems()) &#123;</div><div class="line">       <span class="keyword">if</span> (-<span class="number">1</span> != orderItem.getIndex()) &#123; <span class="comment">// ORDER BY ä½¿ç”¨æ•°å­—</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (each.getAlias().isPresent() &amp;&amp; orderItem.getAlias().isPresent() &amp;&amp; each.getAlias().get().equalsIgnoreCase(orderItem.getAlias().get())) &#123; <span class="comment">// å­—æ®µåˆ«åæ¯”è¾ƒ</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!each.getAlias().isPresent() &amp;&amp; orderItem.getQualifiedName().isPresent() &amp;&amp; each.getExpression().equalsIgnoreCase(orderItem.getQualifiedName().get())) &#123; <span class="comment">// å­—æ®µåŸåæ¯”è¾ƒ</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-3-ItemsToken"><a href="#4-3-ItemsToken" class="headerlink" title="4.3 ItemsToken"></a>4.3 ItemsToken</h2><p>é€‰æ‹©é¡¹æ ‡è®°å¯¹è±¡ï¼Œ<strong>å±äºåˆ†ç‰‡ä¸Šä¸‹æ–‡ä¿¡æ¯</strong>ï¼Œç›®å‰æœ‰ 3 ä¸ªæƒ…å†µä¼šåˆ›å»ºï¼š</p>
<ol>
<li><code>AVG</code> æŸ¥è¯¢é¢å¤– COUNT å’Œ SUMï¼š<code>#appendAvgDerivedColumns()</code></li>
<li><code>GROUP BY</code> ä¸åœ¨ æŸ¥è¯¢å­—æ®µï¼Œé¢å¤–æŸ¥è¯¢è¯¥å­—æ®µ ï¼š<code>#appendDerivedOrderColumns()</code></li>
<li><code>ORDER BY</code> ä¸åœ¨ æŸ¥è¯¢å­—æ®µï¼Œé¢å¤–æŸ¥è¯¢è¯¥å­—æ®µ ï¼š<code>#appendDerivedOrderColumns()</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemsToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å­—æ®µåæ•°ç»„</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; items = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-4-appendDerivedOrderBy"><a href="#4-4-appendDerivedOrderBy" class="headerlink" title="4.4 appendDerivedOrderBy()"></a>4.4 appendDerivedOrderBy()</h2><p>å½“ SQL æœ‰èšåˆæ¡ä»¶è€Œæ— æ’åºæ¡ä»¶ï¼Œæ ¹æ®èšåˆæ¡ä»¶è¿›è¡Œæ’åºã€‚è¿™æ˜¯æ•°æ®åº“è‡ªå·±çš„æ‰§è¡Œè§„åˆ™ã€‚</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">mysql&gt; SELECT order_id FROM t_order GROUP BY order_id;</div><div class="line">+----------+</div><div class="line">| order_id |</div><div class="line">+----------+</div><div class="line">| 1        |</div><div class="line">| 2        |</div><div class="line">| 3        |</div><div class="line">+----------+</div><div class="line">3 rows in set (0.05 sec)</div><div class="line"></div><div class="line">mysql&gt; SELECT order_id FROM t_order GROUP BY order_id DESC;</div><div class="line">+----------+</div><div class="line">| order_id |</div><div class="line">+----------+</div><div class="line">| 3        |</div><div class="line">| 2        |</div><div class="line">| 1        |</div><div class="line">+----------+</div><div class="line">3 rows in set (0.02 sec)</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å½“æ—  Order By æ¡ä»¶æ—¶ï¼Œä½¿ç”¨ Group By ä½œä¸ºæ’åºæ¡ä»¶ï¼ˆæ•°æ®åº“æœ¬èº«è§„åˆ™ï¼‰</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendDerivedOrderBy</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!getSelectStatement().getGroupByItems().isEmpty() &amp;&amp; getSelectStatement().getOrderByItems().isEmpty()) &#123;</div><div class="line">       getSelectStatement().getOrderByItems().addAll(getSelectStatement().getGroupByItems());</div><div class="line">       getSelectStatement().getSqlTokens().add(<span class="keyword">new</span> OrderByToken(getSelectStatement().getGroupByLastPosition()));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="4-3-1-OrderByToken"><a href="#4-3-1-OrderByToken" class="headerlink" title="4.3.1 OrderByToken"></a>4.3.1 OrderByToken</h3><p>æ’åºæ ‡è®°å¯¹è±¡ã€‚å½“æ—  Order By æ¡ä»¶æ—¶ï¼Œä½¿ç”¨ Group By ä½œä¸ºæ’åºæ¡ä»¶ï¼ˆæ•°æ®åº“æœ¬èº«è§„åˆ™ï¼‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// OrderByToken.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderByToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL æ‰€åœ¨å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å’³å’³å’³ï¼Œç¡®å®æœ‰ä¸€äº›ç•¥é•¿ã€‚ä½†è¯·ç›¸ä¿¡ï¼ŒINSERT / UPDATE / DELETE ä¼šç®€å•å¾ˆå¤šå¾ˆå¤šã€‚è€ƒè¯•è€ƒçš„ SQL æœ€å¤šçš„æ˜¯ä»€ä¹ˆï¼ŸSELECT è¯­å¥å‘€ï¼ä¸ºå•¥ï¼Œéš¾å‘—ã€‚æ©ï¼Œæˆ‘ç›¸ä¿¡çœ‹åˆ°æ­¤å¤„çš„ä½ ï¼Œä¸€å®šæ˜¯èƒ½çœ‹æ‡‚çš„ï¼ŒåŠ æ²¹ï¼</p>
<p>ğŸ™‚å¦‚æœå¯¹æœ¬æ–‡æœ‰ä¸ç†è§£çš„åœ°æ–¹ï¼Œå¯ä»¥å…³æ³¨æˆ‘çš„å…¬ä¼—å·<strong>ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">èŠ‹è‰¿çš„åç«¯å°å±‹</a>ï¼‰</strong>è·å¾—<strong>å¾®ä¿¡å·</strong>ï¼Œæˆ‘ä»¬æ¥ä¸€åœºï¼Œ1 å¯¹ 1 çš„æåŸºå§ï¼Œä¸ä¸ä¸ï¼Œæ˜¯äº¤æµäº¤æµã€‚</p>
<p>é“å‹ï¼Œå¸®æˆ‘åˆ†äº«ä¸€æ³¢æ€ä¹ˆæ ·ï¼Ÿ</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/stron
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æ</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-parse-2/</id>
    <published>2017-07-25T16:00:00.000Z</published>
    <updated>2017-07-31T12:30:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼š<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</a></strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. SQLParsingEngine</a></li>
<li><a href="#">3. SQLParser SQLè§£æå™¨</a><ul>
<li><a href="#">3.1 AbstractParser</a></li>
<li><a href="#">3.2 SQLParser</a><ul>
<li><a href="#">3.2.1 #parseExpression() å’Œ SQLExpression</a></li>
<li><a href="#">3.2.2 #parseAlias()</a></li>
<li><a href="#">3.2.3 #parseSingleTable()</a></li>
<li><a href="#">3.2.4 #skipJoin()</a></li>
<li><a href="#">3.2.5 #parseWhere()</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#">4. StatementParser SQLè¯­å¥è§£æå™¨</a><ul>
<li><a href="#">4.1 StatementParser</a></li>
<li><a href="#">4.2 Statement</a></li>
</ul>
</li>
<li><a href="#">5. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>ä¸Šç¯‡æ–‡ç« <a href="http://www.yunai.me/Sharding-JDBC/sql-parse-1/">ã€Šè¯æ³•è§£æã€‹</a>åˆ†äº«äº†<strong>è¯æ³•è§£æå™¨Lexer</strong>æ˜¯å¦‚ä½•è§£æ SQL é‡Œçš„è¯æ³•ã€‚æœ¬æ–‡åˆ†äº«<strong>SQLè§£æå¼•æ“</strong>æ˜¯å¦‚ä½•è§£æä¸ç†è§£ SQLçš„ã€‚å› ä¸ºæœ¬æ–‡å»ºç«‹åœ¨<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-1/">ã€Šè¯æ³•è§£æã€‹</a>ä¹‹ä¸Šï¼Œä½ éœ€è¦é˜…è¯»å®ƒååœ¨å¼€å§‹è¿™æ®µæ—…ç¨‹ã€‚ğŸ™‚å¦‚æœå¯¹è¯æ³•è§£æä¸å®Œå…¨ç†è§£ï¼Œè¯·ç»™æˆ‘çš„å…¬ä¼—å·<strong>ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">èŠ‹è‰¿çš„åç«¯å°å±‹</a>ï¼‰</strong>ç•™è¨€ï¼Œæˆ‘ä¼š<strong>é€æ¡è®¤çœŸè€å¿ƒ</strong>å›å¤ã€‚</p>
<p>åŒºåˆ«äº Lexerï¼ŒParser <strong>ç†è§£SQL</strong>ï¼š</p>
<ul>
<li><strong>æç‚¼åˆ†ç‰‡ä¸Šä¸‹æ–‡</strong></li>
<li><strong>æ ‡è®°éœ€è¦SQLæ”¹å†™çš„éƒ¨åˆ†</strong></li>
</ul>
<p>Parser æœ‰ä¸‰ä¸ªç»„ä»¶ï¼š</p>
<ul>
<li>SQLParsingEngine ï¼šSQL è§£æå¼•æ“</li>
<li>SQLParser ï¼šSQL è§£æå™¨</li>
<li>StatementParser ï¼šSQLè¯­å¥è§£æå™¨</li>
</ul>
<p>SQLParsingEngine è°ƒç”¨ StatementParser è§£æ SQLã€‚<br>StatementParser è°ƒç”¨ SQLParser è§£æ SQL è¡¨è¾¾å¼ã€‚<br>SQLParser è°ƒç”¨ Lexer è§£æ SQL è¯æ³•ã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/01.png" alt=""></p>
<p>ğŸ˜œ æ˜¯ä¸æ˜¯è§‰å¾— SQLParser å’Œ StatementParser çœ‹èµ·æ¥å¾ˆæ¥è¿‘ï¼Ÿä¸‹æ–‡ä¸ºä½ æ­å¼€è¿™ä¸ªç­”æ¡ˆã€‚</p>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1 id="2-SQLParsingEngine"><a href="#2-SQLParsingEngine" class="headerlink" title="2. SQLParsingEngine"></a>2. SQLParsingEngine</h1><p>SQLParsingEngineï¼ŒSQL è§£æå¼•æ“ã€‚å…¶ <code>#parse()</code> æ–¹æ³•ä½œä¸º SQL è§£æå…¥å£ï¼Œæœ¬èº«ä¸å¸¦å¤æ‚é€»è¾‘ï¼Œé€šè¿‡è°ƒç”¨ SQL å¯¹åº”çš„ StatementParser è¿›è¡Œ SQL è§£æã€‚</p>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParsingEngine.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLStatement <span class="title">parse</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å– SQLè§£æå™¨</span></div><div class="line">   SQLParser sqlParser = getSQLParser();</div><div class="line">   <span class="comment">//</span></div><div class="line">   sqlParser.skipIfEqual(Symbol.SEMI); <span class="comment">// è·³è¿‡ ";"</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.WITH)) &#123; <span class="comment">// WITH Syntax</span></div><div class="line">       skipWith(sqlParser);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è·å–å¯¹åº” SQLè¯­å¥è§£æå™¨ è§£æSQL</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.SELECT)) &#123;</div><div class="line">       <span class="keyword">return</span> SelectParserFactory.newInstance(sqlParser).parse();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.INSERT)) &#123;</div><div class="line">       <span class="keyword">return</span> InsertParserFactory.newInstance(shardingRule, sqlParser).parse();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.UPDATE)) &#123;</div><div class="line">       <span class="keyword">return</span> UpdateParserFactory.newInstance(sqlParser).parse();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.DELETE)) &#123;</div><div class="line">       <span class="keyword">return</span> DeleteParserFactory.newInstance(sqlParser).parse();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(sqlParser.getLexer().getCurrentToken().getType());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="3-SQLParser-SQLè§£æå™¨"><a href="#3-SQLParser-SQLè§£æå™¨" class="headerlink" title="3. SQLParser SQLè§£æå™¨"></a>3. SQLParser SQLè§£æå™¨</h1><p>SQLParserï¼ŒSQL è§£æå™¨ã€‚å’Œè¯æ³•è§£æå™¨ Lexer ä¸€æ ·ï¼Œä¸åŒæ•°æ®åº“æœ‰ä¸åŒçš„å®ç°ã€‚</p>
<p>ç±»å›¾å¦‚ä¸‹ï¼ˆ<strong>åŒ…å«æ‰€æœ‰å±æ€§å’Œæ–¹æ³•</strong>ï¼‰ï¼ˆ<strong><a href="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/02.png">æ”¾å¤§å›¾ç‰‡</a></strong>ï¼‰ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/02.png" alt=""></p>
<h2 id="3-1-AbstractParser"><a href="#3-1-AbstractParser" class="headerlink" title="3.1 AbstractParser"></a>3.1 AbstractParser</h2><p>AbstractParserï¼ŒSQLParser çš„æŠ½è±¡çˆ¶ç±»ï¼Œå¯¹ Lexer ç®€å•å°è£…ã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li><code>#skipIfEqual()</code>ï¼šåˆ¤æ–­å½“å‰è¯æ³•æ ‡è®°ç±»å‹æ˜¯å¦ä¸å…¶ä¸­ä¸€ä¸ªä¼ å…¥å€¼ç›¸ç­‰</li>
<li><code>#equalAny()</code>ï¼šåˆ¤æ–­å½“å‰è¯æ³•æ ‡è®°ç±»å‹æ˜¯å¦ä¸å…¶ä¸­ä¸€ä¸ªä¼ å…¥å€¼ç›¸ç­‰</li>
</ul>
<p><em><strong>è¿™é‡Œæœ‰ä¸€ç‚¹æˆ‘ä»¬éœ€è¦æ³¨æ„ï¼ŒSQLParser å¹¶ä¸æ˜¯ç­‰ Lexer è§£æå®Œè¯æ³•( Token )ï¼Œå†æ ¹æ®è¯æ³•å»ç†è§£ SQLã€‚è€Œæ˜¯ï¼Œåœ¨ç†è§£ SQL çš„è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨ Lexer è¿›è¡Œåˆ†è¯ã€‚</strong></em></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParsingEngine.java#parse()ç‰‡æ®µ</span></div><div class="line"><span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.SELECT)) &#123;</div><div class="line">    <span class="keyword">return</span> SelectParserFactory.newInstance(sqlParser).parse();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// AbstractParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equalAny</span><span class="params">(<span class="keyword">final</span> TokenType... tokenTypes)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (TokenType each : tokenTypes) &#123;</div><div class="line">       <span class="keyword">if</span> (each == lexer.getCurrentToken().getType()) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>â†‘â†‘â†‘ åˆ¤æ–­å½“å‰<strong>è¯æ³•</strong>æ˜¯å¦ä¸º SELECTã€‚å®é™… AbstractParser åªçŸ¥é“å½“å‰è¯æ³•ï¼Œå¹¶<strong>ä¸çŸ¥é“</strong>åé¢è¿˜æœ‰å“ªäº›è¯æ³•ï¼Œä¹Ÿ<strong>ä¸çŸ¥é“</strong>ä¹‹å‰æœ‰å“ªäº›è¯æ³•ã€‚</li>
</ul>
<p>æˆ‘ä»¬æ¥çœ‹ AbstractParser é‡Œæ¯”è¾ƒå¤æ‚çš„æ–¹æ³• <code>#skipParentheses()</code> å¸®åŠ©å¤§å®¶å†ç†è§£ä¸‹ã€‚è¯·è®¤çœŸçœ‹ä»£ç æ³¨é‡Šå™¢ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·³è¿‡å°æ‹¬å·å†…æ‰€æœ‰çš„è¯æ³•æ ‡è®°.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> å°æ‹¬å·å†…æ‰€æœ‰çš„è¯æ³•æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">skipParentheses</span><span class="params">()</span> </span>&#123;</div><div class="line">   StringBuilder result = <span class="keyword">new</span> StringBuilder(<span class="string">""</span>);</div><div class="line">   <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">   <span class="keyword">if</span> (Symbol.LEFT_PAREN == getLexer().getCurrentToken().getType()) &#123;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> beginPosition = getLexer().getCurrentToken().getEndPosition();</div><div class="line">       result.append(Symbol.LEFT_PAREN.getLiterals());</div><div class="line">       getLexer().nextToken();</div><div class="line">       <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">           <span class="keyword">if</span> (equalAny(Symbol.QUESTION)) &#123;</div><div class="line">               increaseParametersIndex();</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// åˆ°è¾¾ç»“å°¾ æˆ–è€… åŒ¹é…åˆé€‚æ•°çš„)å³æ‹¬å·</span></div><div class="line">           <span class="keyword">if</span> (Assist.END == getLexer().getCurrentToken().getType() || (Symbol.RIGHT_PAREN == getLexer().getCurrentToken().getType() &amp;&amp; <span class="number">0</span> == count)) &#123;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// å¤„ç†é‡Œé¢æœ‰å¤šä¸ªæ‹¬å·çš„æƒ…å†µï¼Œä¾‹å¦‚ï¼šSELECT COUNT(DISTINCT(order_id) FROM t_order</span></div><div class="line">           <span class="keyword">if</span> (Symbol.LEFT_PAREN == getLexer().getCurrentToken().getType()) &#123;</div><div class="line">               count++;</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Symbol.RIGHT_PAREN == getLexer().getCurrentToken().getType()) &#123;</div><div class="line">               count--;</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// ä¸‹ä¸€ä¸ªè¯æ³•</span></div><div class="line">           getLexer().nextToken();</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// è·å¾—æ‹¬å·å†…çš„å†…å®¹</span></div><div class="line">       result.append(getLexer().getInput().substring(beginPosition, getLexer().getCurrentToken().getEndPosition()));</div><div class="line">       <span class="comment">// ä¸‹ä¸€ä¸ªè¯æ³•</span></div><div class="line">       getLexer().nextToken();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªç±»å…¶å®ƒæ–¹æ³•å¾ˆé‡è¦ï¼Œé€»è¾‘ç›¸å¯¹ç®€å•ï¼Œæˆ‘ä»¬å°±ä¸å ç”¨ç¯‡å¹…äº†ã€‚å¤§å®¶ä¸€å®šè¦çœ‹å“Ÿï¼Œåé¢è°ƒç”¨éå¸¸éå¸¸å¤šã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/master/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/parsing/parser/AbstractParser.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractParser.java ä¼ é€é—¨</a>ã€‚ğŸ‘¼ä¹Ÿå¯ä»¥å…³æ³¨æˆ‘çš„å…¬ä¼—å·<strong>ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">èŠ‹è‰¿çš„åç«¯å°å±‹</a>ï¼‰</strong>å‘é€å…³é”®å­—ã€sjdbcã€‘è·å–<strong>å¢åŠ æ–¹æ³•å†…æ³¨é‡Šçš„é¡¹ç›®åœ°å€</strong>ã€‚</p>
<h2 id="3-2-SQLParser"><a href="#3-2-SQLParser" class="headerlink" title="3.2 SQLParser"></a>3.2 SQLParser</h2><p>SQLParserï¼ŒSQL è§£æå™¨ï¼Œ<strong>ä¸»è¦æä¾›åªè€ƒè™‘ SQL å—çš„è§£ææ–¹æ³•ï¼Œ<em>ä¸è€ƒè™‘ SQL ä¸Šä¸‹æ–‡</em></strong>ã€‚ä¸‹æ–‡å³å°†æåˆ°çš„ StatementParser å°† SQL æ‹†æˆå¯¹åº”çš„<strong>å—</strong>ï¼Œè°ƒç”¨ SQLParser è¿›è¡Œè§£æã€‚ğŸ¤“ è¿™ä¹ˆè¯´ï¼Œå¯èƒ½ä¼šæœ‰äº›æŠ½è±¡ï¼Œæˆ‘ä»¬ä¸‹é¢æ¥ä¸€èµ·çœ‹ã€‚</p>
<p>SQLParser çœ‹èµ·æ¥æ–¹æ³•ç‰¹åˆ«å¤šï¼Œåˆå¹¶ä¸‹ä¸€å…± 5 ç§ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">æ–¹æ³•</th>
<th style="text-align:left">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">#parseExpression()</td>
<td style="text-align:left">è§£æè¡¨è¾¾å¼</td>
</tr>
<tr>
<td style="text-align:left">#parseAlias()</td>
<td style="text-align:left">è§£æåˆ«å</td>
</tr>
<tr>
<td style="text-align:left">#parseSingleTable()</td>
<td style="text-align:left">è§£æå•è¡¨</td>
</tr>
<tr>
<td style="text-align:left">#skipJoin()</td>
<td style="text-align:left">è·³è¿‡è¡¨å…³è”è¯æ³•</td>
</tr>
<tr>
<td style="text-align:left">#parseWhere()</td>
<td style="text-align:left">è§£ææŸ¥è¯¢æ¡ä»¶</td>
</tr>
</tbody>
</table>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/03.png" alt=""></p>
<p>çœ‹äº†è¿™ 5 ä¸ªæ–¹æ³•æ˜¯å¦æœ‰ç‚¹ç†è§£äº†ï¼ŸSQLParser ä¸è€ƒè™‘ SQL æ˜¯ SELECT / INSERT / UPDATE / DELETE ï¼Œå®ƒè€ƒè™‘çš„æ˜¯ï¼Œ<strong>ç»™æˆ‘çš„æ˜¯ WHERE å¤„è§£ææŸ¥è¯¢æ¡ä»¶ï¼Œæˆ–æ˜¯ INSERT INTO è§£æå•è¡¨ ç­‰</strong>ï¼Œæä¾› SELECT / INSERT / UPDATE / DELETE éœ€è¦çš„ SQL å—å…¬ç”¨è§£æã€‚</p>
<h3 id="3-2-1-parseExpression-å’Œ-SQLExpression"><a href="#3-2-1-parseExpression-å’Œ-SQLExpression" class="headerlink" title="3.2.1 #parseExpression() å’Œ SQLExpression"></a>3.2.1 #parseExpression() å’Œ SQLExpression</h3><p>SQLExpressionï¼ŒSQLè¡¨è¾¾å¼æ¥å£ã€‚ç›®å‰ 6 ç§å®ç°ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">ç±»</th>
<th style="text-align:left">è¯´æ˜</th>
<th style="text-align:left">å¯¹åº”Token</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">SQLIdentifierExpression</td>
<td style="text-align:left">æ ‡è¯†è¡¨è¾¾å¼</td>
<td style="text-align:left">Literals.IDENTIFIER</td>
</tr>
<tr>
<td style="text-align:left">SQLPropertyExpression</td>
<td style="text-align:left">å±æ€§è¡¨è¾¾å¼</td>
<td style="text-align:left">æ— </td>
</tr>
<tr>
<td style="text-align:left">SQLNumberExpression</td>
<td style="text-align:left">æ•°å­—è¡¨è¾¾å¼</td>
<td style="text-align:left">Literals.INT, Literals.HEX</td>
</tr>
<tr>
<td style="text-align:left">SQLPlaceholderExpression</td>
<td style="text-align:left">å ä½ç¬¦è¡¨è¾¾å¼</td>
<td style="text-align:left">Symbol.QUESTION</td>
</tr>
<tr>
<td style="text-align:left">SQLTextExpression</td>
<td style="text-align:left">å­—ç¬¦è¡¨è¾¾å¼</td>
<td style="text-align:left">Literals.CHARS</td>
</tr>
<tr>
<td style="text-align:left">SQLIgnoreExpression</td>
<td style="text-align:left">åˆ†ç‰‡ä¸­æ— éœ€å…³æ³¨çš„SQLè¡¨è¾¾å¼</td>
<td style="text-align:left">æ— </td>
</tr>
</tbody>
</table>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/04.png" alt=""></p>
<ul>
<li>SQLPropertyExpression ä¾‹å¦‚ï¼š<code>SELECT * FROM t_order o ORDER BY o.order_id</code> ä¸­çš„ <code>o.order_id</code>ã€‚<strong>SQLPropertyExpression ä» SQLIdentifierExpression è¿›ä¸€æ­¥åˆ¤æ–­è§£æè€Œæ¥ã€‚</strong><br> <img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/05.png" alt=""> </li>
<li>SQLIgnoreExpression ä¾‹å¦‚ï¼š<code>SELECT * FROM t_order o ORDER BY o.order_id % 2</code> ä¸­çš„<code>o.order_id % 2</code>ã€‚<strong>å¤åˆè¡¨è¾¾å¼éƒ½ä¼šè§£ææˆ SQLIgnoreExpressionã€‚</strong></li>
</ul>
<p>è§£æ SQLExpression æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æè¡¨è¾¾å¼.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> è¡¨è¾¾å¼</div><div class="line">*/</div><div class="line"><span class="comment">// TODO å®Œå–„Expressionè§£æçš„å„ç§åœºæ™¯</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> SQLExpression <span class="title">parseExpression</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è§£æè¡¨è¾¾å¼</span></div><div class="line">   String literals = getLexer().getCurrentToken().getLiterals();</div><div class="line">   <span class="keyword">final</span> SQLExpression expression = getExpression(literals);</div><div class="line">   <span class="comment">// SQLIdentifierExpression éœ€è¦ç‰¹æ®Šå¤„ç†ã€‚è€ƒè™‘è‡ªå®šä¹‰å‡½æ•°ï¼Œè¡¨å.å±æ€§æƒ…å†µã€‚</span></div><div class="line">   <span class="keyword">if</span> (skipIfEqual(Literals.IDENTIFIER)) &#123;</div><div class="line">       <span class="keyword">if</span> (skipIfEqual(Symbol.DOT)) &#123; <span class="comment">// ä¾‹å¦‚ï¼ŒORDER BY o.uid ä¸­çš„ "o.uid"</span></div><div class="line">           String property = getLexer().getCurrentToken().getLiterals();</div><div class="line">           getLexer().nextToken();</div><div class="line">           <span class="keyword">return</span> skipIfCompositeExpression() ? <span class="keyword">new</span> SQLIgnoreExpression() : <span class="keyword">new</span> SQLPropertyExpression(<span class="keyword">new</span> SQLIdentifierExpression(literals), property);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (equalAny(Symbol.LEFT_PAREN)) &#123; <span class="comment">// ä¾‹å¦‚ï¼ŒGROUP BY DATE(create_time) ä¸­çš„ "DATE(create_time)"</span></div><div class="line">           skipParentheses();</div><div class="line">           skipRestCompositeExpression();</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> SQLIgnoreExpression();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> skipIfCompositeExpression() ? <span class="keyword">new</span> SQLIgnoreExpression() : expression;</div><div class="line">   &#125;</div><div class="line">   getLexer().nextToken();</div><div class="line">   <span class="keyword">return</span> skipIfCompositeExpression() ? <span class="keyword">new</span> SQLIgnoreExpression() : expression;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾— è¯æ³•Token å¯¹åº”çš„ SQLExpression</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> literals è¯æ³•å­—é¢é‡æ ‡è®°</div><div class="line">* <span class="doctag">@return</span> SQLExpression</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> SQLExpression <span class="title">getExpression</span><span class="params">(<span class="keyword">final</span> String literals)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (equalAny(Symbol.QUESTION)) &#123;</div><div class="line">       increaseParametersIndex();</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLPlaceholderExpression(getParametersIndex() - <span class="number">1</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.CHARS)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLTextExpression(literals);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// TODO è€ƒè™‘longçš„æƒ…å†µ</span></div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.INT)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLNumberExpression(Integer.parseInt(literals));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.FLOAT)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLNumberExpression(Double.parseDouble(literals));</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// TODO è€ƒè™‘longçš„æƒ…å†µ</span></div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.HEX)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLNumberExpression(Integer.parseInt(literals, <span class="number">16</span>));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.IDENTIFIER)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLIdentifierExpression(SQLUtil.getExactlyValue(literals));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> SQLIgnoreExpression();</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* å¦‚æœæ˜¯ å¤åˆè¡¨è¾¾å¼ï¼Œè·³è¿‡ã€‚</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦è·³è¿‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">skipIfCompositeExpression</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (equalAny(Symbol.PLUS, Symbol.SUB, Symbol.STAR, Symbol.SLASH, Symbol.PERCENT, Symbol.AMP, Symbol.BAR, Symbol.DOUBLE_AMP, Symbol.DOUBLE_BAR, Symbol.CARET, Symbol.DOT, Symbol.LEFT_PAREN)) &#123;</div><div class="line">       skipParentheses();</div><div class="line">       skipRestCompositeExpression();</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·³è¿‡å‰©ä½™å¤åˆè¡¨è¾¾å¼</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">skipRestCompositeExpression</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">while</span> (skipIfEqual(Symbol.PLUS, Symbol.SUB, Symbol.STAR, Symbol.SLASH, Symbol.PERCENT, Symbol.AMP, Symbol.BAR, Symbol.DOUBLE_AMP, Symbol.DOUBLE_BAR, Symbol.CARET, Symbol.DOT)) &#123;</div><div class="line">       <span class="keyword">if</span> (equalAny(Symbol.QUESTION)) &#123;</div><div class="line">           increaseParametersIndex();</div><div class="line">       &#125;</div><div class="line">       getLexer().nextToken();</div><div class="line">       skipParentheses();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è§£æäº† SQLExpression æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿæˆ‘ä»¬ä¼šåœ¨<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠæŸ¥è¯¢SQLè§£æã€‹</a>ã€<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šæ’å…¥SQLè§£æã€‹</a>ã€<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šæ›´æ–°SQLè§£æã€‹</a>ã€<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šåˆ é™¤SQLè§£æã€‹</a>ã€‚ç•™ä¸ªæ‚¬å¿µğŸ˜ˆï¼Œå…³æ³¨æˆ‘çš„å…¬ä¼—å·<strong>ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">èŠ‹è‰¿çš„åç«¯å°å±‹</a>ï¼‰</strong>ï¼Œ<strong>å®æ—¶æ”¶åˆ°æ–°æ–‡æ›´æ–°é€šçŸ¥</strong>ã€‚</p>
<h3 id="3-2-2-parseAlias"><a href="#3-2-2-parseAlias" class="headerlink" title="3.2.2 #parseAlias()"></a>3.2.2 #parseAlias()</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æåˆ«å.ä¸ä»…ä»…æ˜¯å­—æ®µçš„åˆ«åï¼Œä¹Ÿå¯ä»¥æ˜¯è¡¨çš„åˆ«åã€‚</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> åˆ«å</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Optional&lt;String&gt; <span class="title">parseAlias</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è§£æå¸¦ AS æƒ…å†µ</span></div><div class="line">   <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.AS)) &#123;</div><div class="line">       <span class="keyword">if</span> (equalAny(Symbol.values())) &#123;</div><div class="line">           <span class="keyword">return</span> Optional.absent();</div><div class="line">       &#125;</div><div class="line">       String result = SQLUtil.getExactlyValue(getLexer().getCurrentToken().getLiterals());</div><div class="line">       getLexer().nextToken();</div><div class="line">       <span class="keyword">return</span> Optional.of(result);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è§£æåˆ«å</span></div><div class="line">   <span class="comment">// TODO å¢åŠ å“ªäº›æ•°æ®åº“è¯†åˆ«å“ªäº›å…³é”®å­—ä½œä¸ºåˆ«åçš„é…ç½®</span></div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.IDENTIFIER, Literals.CHARS, DefaultKeyword.USER, DefaultKeyword.END, DefaultKeyword.CASE, DefaultKeyword.KEY, DefaultKeyword.INTERVAL, DefaultKeyword.CONSTRAINT)) &#123;</div><div class="line">       String result = SQLUtil.getExactlyValue(getLexer().getCurrentToken().getLiterals());</div><div class="line">       getLexer().nextToken();</div><div class="line">       <span class="keyword">return</span> Optional.of(result);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> Optional.absent();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-3-parseSingleTable"><a href="#3-2-3-parseSingleTable" class="headerlink" title="3.2.3 #parseSingleTable()"></a>3.2.3 #parseSingleTable()</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æå•è¡¨.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlStatement SQLè¯­å¥å¯¹è±¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseSingleTable</span><span class="params">(<span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   <span class="keyword">boolean</span> hasParentheses = <span class="keyword">false</span>;</div><div class="line">   <span class="keyword">if</span> (skipIfEqual(Symbol.LEFT_PAREN)) &#123;</div><div class="line">       <span class="keyword">if</span> (equalAny(DefaultKeyword.SELECT)) &#123; <span class="comment">// multiple-update æˆ–è€… multiple-delete</span></div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support subquery"</span>);</div><div class="line">       &#125;</div><div class="line">       hasParentheses = <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   Table table;</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> beginPosition = getLexer().getCurrentToken().getEndPosition() - getLexer().getCurrentToken().getLiterals().length();</div><div class="line">   String literals = getLexer().getCurrentToken().getLiterals();</div><div class="line">   getLexer().nextToken();</div><div class="line">   <span class="keyword">if</span> (skipIfEqual(Symbol.DOT)) &#123;</div><div class="line">       getLexer().nextToken();</div><div class="line">       <span class="keyword">if</span> (hasParentheses) &#123;</div><div class="line">           accept(Symbol.RIGHT_PAREN);</div><div class="line">       &#125;</div><div class="line">       table = <span class="keyword">new</span> Table(SQLUtil.getExactlyValue(literals), parseAlias());</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">if</span> (hasParentheses) &#123;</div><div class="line">           accept(Symbol.RIGHT_PAREN);</div><div class="line">       &#125;</div><div class="line">       table = <span class="keyword">new</span> Table(SQLUtil.getExactlyValue(literals), parseAlias());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (skipJoin()) &#123; <span class="comment">// multiple-update æˆ–è€… multiple-delete</span></div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support Multiple-Table."</span>);</div><div class="line">   &#125;</div><div class="line">   sqlStatement.getSqlTokens().add(<span class="keyword">new</span> TableToken(beginPosition, literals));</div><div class="line">   sqlStatement.getTables().add(table);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-4-skipJoin"><a href="#3-2-4-skipJoin" class="headerlink" title="3.2.4 #skipJoin()"></a>3.2.4 #skipJoin()</h3><p>è·³è¿‡è¡¨å…³è”è¯æ³•ï¼Œæ”¯æŒ <code>SELECT * FROM t_user, t_order WHERE ...</code>, <code>SELECT * FROM t_user JOIN t_order ON ...</code>ã€‚ä¸‹ç¯‡<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠæŸ¥è¯¢SQLè§£æã€‹</a><strong>è§£æè¡¨</strong>ä¼šç”¨åˆ°è¿™ä¸ªæ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·³è¿‡è¡¨å…³è”è¯æ³•.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦è¡¨å…³è”.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">skipJoin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.LEFT, DefaultKeyword.RIGHT, DefaultKeyword.FULL)) &#123;</div><div class="line">       skipIfEqual(DefaultKeyword.OUTER);</div><div class="line">       accept(DefaultKeyword.JOIN);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.INNER)) &#123;</div><div class="line">       accept(DefaultKeyword.JOIN);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.JOIN, Symbol.COMMA, DefaultKeyword.STRAIGHT_JOIN)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.CROSS)) &#123;</div><div class="line">       <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.JOIN, DefaultKeyword.APPLY)) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.OUTER)) &#123;</div><div class="line">       <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.APPLY)) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-5-parseWhere"><a href="#3-2-5-parseWhere" class="headerlink" title="3.2.5 #parseWhere()"></a>3.2.5 #parseWhere()</h3><p>è§£æ WHERE æŸ¥è¯¢æ¡ä»¶ã€‚ç›®å‰æ”¯æŒ AND æ¡ä»¶ï¼Œä¸æ”¯æŒ OR æ¡ä»¶ã€‚è¿‘æœŸ OR æ¡ä»¶æ”¯æŒçš„å¯èƒ½æ€§æ¯”è¾ƒä½ã€‚å¦å¤–æ¡ä»¶è¿™å—å¯¹æ‹¬å·è§£æéœ€è¦ç»§ç»­ä¼˜åŒ–ï¼Œå®é™…ä½¿ç”¨è¯·å‹¿å†™å†—ä½™çš„æ‹¬å·ã€‚ä¾‹å¦‚ï¼š<code>SELECT * FROM tbl_name1 WHERE ((val1=?) AND (val2=?)) AND val3 =?</code>ã€‚</p>
<p>æ ¹æ®ä¸åŒçš„è¿ç®—æ“ä½œç¬¦ï¼Œåˆ†æˆå¦‚ä¸‹æƒ…å†µï¼š</p>
<table>
<thead>
<tr>
<th>è¿ç®—ç¬¦</th>
<th>é™„åŠ æ¡ä»¶</th>
<th>æ–¹æ³•</th>
</tr>
</thead>
<tbody>
<tr>
<td>=</td>
<td></td>
<td>#parseEqualCondition()</td>
</tr>
<tr>
<td>IN</td>
<td></td>
<td>#parseInCondition()</td>
</tr>
<tr>
<td>BETWEEN</td>
<td></td>
<td>#parseBetweenCondition()</td>
</tr>
<tr>
<td>&lt;, &lt;=, &gt;, &gt;=</td>
<td>Oracle æˆ– SQLServer åˆ†é¡µ</td>
<td>#parseRowNumberCondition()</td>
</tr>
<tr>
<td>&lt;, &lt;=, &gt;, &gt;=</td>
<td></td>
<td>#parseOtherCondition()</td>
</tr>
<tr>
<td>LIKE</td>
<td></td>
<td>parseOtherCondition</td>
</tr>
</tbody>
</table>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£ææ‰€æœ‰æŸ¥è¯¢æ¡ä»¶ã€‚</div><div class="line">* ç›®å‰ä¸æ”¯æŒ OR æ¡ä»¶ã€‚</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlStatement SQL</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseConditions</span><span class="params">(<span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   <span class="comment">// AND æŸ¥è¯¢</span></div><div class="line">   <span class="keyword">do</span> &#123;</div><div class="line">       parseComparisonCondition(sqlStatement);</div><div class="line">   &#125; <span class="keyword">while</span> (skipIfEqual(DefaultKeyword.AND));</div><div class="line">   <span class="comment">// ç›®å‰ä¸æ”¯æŒ OR æ¡ä»¶</span></div><div class="line">   <span class="keyword">if</span> (equalAny(DefaultKeyword.OR)) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(getLexer().getCurrentToken().getType());</div><div class="line">   &#125;</div><div class="line">&#125; </div><div class="line"><span class="comment">// TODO è§£æç»„åˆexpr</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æå•ä¸ªæŸ¥è¯¢æ¡ä»¶</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlStatement SQL</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseComparisonCondition</span><span class="params">(<span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   skipIfEqual(Symbol.LEFT_PAREN);</div><div class="line">   SQLExpression left = parseExpression(sqlStatement);</div><div class="line">   <span class="keyword">if</span> (equalAny(Symbol.EQ)) &#123;</div><div class="line">       parseEqualCondition(sqlStatement, left);</div><div class="line">       skipIfEqual(Symbol.RIGHT_PAREN);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(DefaultKeyword.IN)) &#123;</div><div class="line">       parseInCondition(sqlStatement, left);</div><div class="line">       skipIfEqual(Symbol.RIGHT_PAREN);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(DefaultKeyword.BETWEEN)) &#123;</div><div class="line">       parseBetweenCondition(sqlStatement, left);</div><div class="line">       skipIfEqual(Symbol.RIGHT_PAREN);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(Symbol.LT, Symbol.GT, Symbol.LT_EQ, Symbol.GT_EQ)) &#123;</div><div class="line">       <span class="keyword">if</span> (left <span class="keyword">instanceof</span> SQLIdentifierExpression &amp;&amp; sqlStatement <span class="keyword">instanceof</span> SelectStatement</div><div class="line">               &amp;&amp; isRowNumberCondition((SelectStatement) sqlStatement, ((SQLIdentifierExpression) left).getName())) &#123;</div><div class="line">           parseRowNumberCondition((SelectStatement) sqlStatement);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (left <span class="keyword">instanceof</span> SQLPropertyExpression &amp;&amp; sqlStatement <span class="keyword">instanceof</span> SelectStatement</div><div class="line">               &amp;&amp; isRowNumberCondition((SelectStatement) sqlStatement, ((SQLPropertyExpression) left).getName())) &#123;</div><div class="line">           parseRowNumberCondition((SelectStatement) sqlStatement);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           parseOtherCondition(sqlStatement);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (equalAny(DefaultKeyword.LIKE)) &#123;</div><div class="line">       parseOtherCondition(sqlStatement);</div><div class="line">   &#125;</div><div class="line">   skipIfEqual(Symbol.RIGHT_PAREN);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>#parseComparisonCondition()</code> è§£æåˆ° <code>å·¦SQLè¡¨è¾¾å¼(left)</code> å’Œ è¿ç®—ç¬¦ï¼Œè°ƒç”¨ç›¸åº”æ–¹æ³•è¿›ä¸€æ­¥å¤„ç†ã€‚æˆ‘ä»¬é€‰æ‹© <code>#parseEqualCondition()</code> çœ‹ä¸‹ï¼Œå…¶ä»–æ–¹æ³•æœ‰å…´è¶£è·³è½¬ <a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/master/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/parsing/parser/SQLParser.java" rel="external nofollow noopener noreferrer" target="_blank">SQLParser</a> æŸ¥çœ‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æ = æ¡ä»¶</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlStatement SQL</div><div class="line">* <span class="doctag">@param</span> left å·¦SQLExpression</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseEqualCondition</span><span class="params">(<span class="keyword">final</span> SQLStatement sqlStatement, <span class="keyword">final</span> SQLExpression left)</span> </span>&#123;</div><div class="line">   getLexer().nextToken();</div><div class="line">   SQLExpression right = parseExpression(sqlStatement);</div><div class="line">   <span class="comment">// æ·»åŠ åˆ—</span></div><div class="line">   <span class="comment">// TODO å¦‚æœæœ‰å¤šè¡¨,ä¸”æ‰¾ä¸åˆ°columnæ˜¯å“ªä¸ªè¡¨çš„,åˆ™ä¸åŠ å…¥condition,ä»¥åéœ€è¦è§£æbinding table</span></div><div class="line">   <span class="keyword">if</span> ((sqlStatement.getTables().isSingleTable() || left <span class="keyword">instanceof</span> SQLPropertyExpression)</div><div class="line">           <span class="comment">// åªæœ‰å¯¹è·¯ç”±ç»“æœæœ‰å½±å“çš„æ‰ä¼šæ·»åŠ åˆ° conditionsã€‚SQLPropertyExpression å’Œ SQLIdentifierExpression æ— æ³•åˆ¤æ–­ï¼Œæ‰€ä»¥æœªåŠ å…¥ conditions</span></div><div class="line">           &amp;&amp; (right <span class="keyword">instanceof</span> SQLNumberExpression || right <span class="keyword">instanceof</span> SQLTextExpression || right <span class="keyword">instanceof</span> SQLPlaceholderExpression)) &#123;</div><div class="line">       Optional&lt;Column&gt; column = find(sqlStatement.getTables(), left);</div><div class="line">       <span class="keyword">if</span> (column.isPresent()) &#123;</div><div class="line">           sqlStatement.getConditions().add(<span class="keyword">new</span> Condition(column.get(), right), shardingRule);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>#parseEqualCondition()</code> è§£æåˆ° <code>å³SQLè¡¨è¾¾å¼(right)</code>ï¼Œå¹¶åˆ¤æ–­ <code>å·¦å³SQLè¡¨è¾¾å¼</code> ä¸è·¯ç”±é€»è¾‘æ˜¯å¦æœ‰å½±å“ï¼Œå¦‚æœæœ‰ï¼Œåˆ™åŠ å…¥åˆ° Conditionã€‚<strong>è¿™ä¸ªå°±æ˜¯ <code>#parseWhere()</code> çš„ç›®çš„ï¼šè§£æ WHERE æŸ¥è¯¢æ¡ä»¶å¯¹è·¯ç”±æœ‰å½±å“çš„æ¡ä»¶ã€‚</strong><a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šè·¯ç”±ã€‹</a>ç›¸å…³çš„é€»è¾‘ï¼Œä¼šå•ç‹¬å¼€æ–‡ç« ä»‹ç»ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆç•™æœ‰æ˜ åƒã€‚</p>
<h1 id="4-StatementParser-SQLè¯­å¥è§£æå™¨"><a href="#4-StatementParser-SQLè¯­å¥è§£æå™¨" class="headerlink" title="4. StatementParser SQLè¯­å¥è§£æå™¨"></a>4. StatementParser SQLè¯­å¥è§£æå™¨</h1><h2 id="4-1-StatementParser"><a href="#4-1-StatementParser" class="headerlink" title="4.1 StatementParser"></a>4.1 StatementParser</h2><p>StatementParserï¼ŒSQLè¯­å¥è§£æå™¨ã€‚æ¯ç§ SQLï¼Œéƒ½æœ‰ç›¸åº”çš„ SQLè¯­å¥è§£æå™¨å®ç°ã€‚ä¸åŒæ•°æ®åº“ï¼Œç»§æ‰¿è¿™äº› SQLè¯­å¥è§£æå™¨ï¼Œå®ç°å„è‡ª SQL ä¸Šçš„å·®å¼‚ã€‚å¤§ä½“ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/06.png" alt=""></p>
<p>SQLParsingEngine æ ¹æ®ä¸åŒ SQL è°ƒç”¨å¯¹åº”å·¥å‚åˆ›å»º StatementParserã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectParserFactory</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ›å»ºSelectè¯­å¥è§£æå™¨.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> sqlParser SQLè§£æå™¨</div><div class="line">     * <span class="doctag">@return</span> Selectè¯­å¥è§£æå™¨</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AbstractSelectParser <span class="title">newInstance</span><span class="params">(<span class="keyword">final</span> SQLParser sqlParser)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (sqlParser <span class="keyword">instanceof</span> MySQLParser) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> MySQLSelectParser(sqlParser);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (sqlParser <span class="keyword">instanceof</span> OracleParser) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> OracleSelectParser(sqlParser);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (sqlParser <span class="keyword">instanceof</span> SQLServerParser) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SQLServerSelectParser(sqlParser);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (sqlParser <span class="keyword">instanceof</span> PostgreSQLParser) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PostgreSQLSelectParser(sqlParser);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(String.format(<span class="string">"Cannot support sqlParser class [%s]."</span>, sqlParser.getClass()));</div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è°ƒç”¨ <code>StatementParser#parse()</code> å®ç°æ–¹æ³•ï¼Œå¯¹ SQL è¿›è¡Œè§£æã€‚å…·ä½“è§£æè¿‡ç¨‹ï¼Œå¦å¼€æ–‡ç« åˆ†äº«ã€‚</p>
<h2 id="4-2-Statement"><a href="#4-2-Statement" class="headerlink" title="4.2 Statement"></a>4.2 Statement</h2><p>ä¸åŒ SQL è§£æåï¼Œè¿”å›å¯¹åº”çš„ SQL ç»“æœ,å³ Statementã€‚å¤§ä½“ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/07.png" alt=""></p>
<p>Statement åŒ…å«ä¸¤éƒ¨åˆ†ä¿¡æ¯ï¼š</p>
<ul>
<li><p>åˆ†ç‰‡ä¸Šä¸‹æ–‡ï¼šç”¨äº SQL è·¯ç”±ã€‚</p>
<p>  <img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/08.png" alt=""></p>
</li>
<li><p>SQL æ ‡è®°å¯¹è±¡ï¼šç”¨äº SQL æ”¹å†™ã€‚</p>
<p> <img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/09.png" alt=""></p>
</li>
</ul>
<p>æˆ‘ä»¬ä¼šåœ¨åæ–‡å¢åˆ æ”¹æŸ¥SQLè§£æçš„è¿‡ç¨‹ä¸­åˆ†äº«åˆ°å®ƒä»¬ã€‚</p>
<h2 id="4-3-é¢„å‘Š"><a href="#4-3-é¢„å‘Š" class="headerlink" title="4.3 é¢„å‘Š"></a>4.3 é¢„å‘Š</h2><table>
<thead>
<tr>
<th>Parser</th>
<th>Statement</th>
<th>åˆ†äº«æ–‡ç« </th>
</tr>
</thead>
<tbody>
<tr>
<td>SelectStatementParser</td>
<td>SelectStatement + AbstractSQLStatement</td>
<td><a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠæŸ¥è¯¢SQLè§£æã€‹</a></td>
</tr>
<tr>
<td>InsertStatementParser</td>
<td>InsertStatement</td>
<td><a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šæ’å…¥SQLè§£æã€‹</a></td>
</tr>
<tr>
<td>UpdateStatementParser</td>
<td>UpdateStatement</td>
<td><a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šæ›´æ–°SQLè§£æã€‹</a></td>
</tr>
<tr>
<td>DeleteStatementParser</td>
<td>DeleteStatement</td>
<td><a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šåˆ é™¤SQLè§£æã€‹</a></td>
</tr>
</tbody>
</table>
<h1 id="5-å½©è›‹"><a href="#5-å½©è›‹" class="headerlink" title="5. å½©è›‹"></a>5. å½©è›‹</h1><p>è€é“ï¼Œæ˜¯ä¸æ˜¯æœ‰ä¸¢ä¸¢é•¿ï¼Ÿ<br>å¦‚æœæœ‰åœ°æ–¹é”™è¯¯ï¼Œçƒ¦è¯·æŒ‡å‡ºğŸ™‚ã€‚<br>å¦‚æœæœ‰åœ°æ–¹ä¸æ˜¯å¾ˆç†è§£ï¼Œå¯ä»¥åŠ æˆ‘çš„å…¬ä¼—å·<strong>ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">èŠ‹è‰¿çš„åç«¯å°å±‹</a>ï¼‰</strong>ç•™è¨€ï¼Œæˆ‘ä¼š<strong>é€æ¡è®¤çœŸè€å¿ƒ</strong>å›å¤ã€‚<br>å¦‚æœè§‰å¾—è¿˜å‡‘åˆï¼ŒåŠ³é©¾åˆ†äº«æœ‹å‹åœˆæˆ–è€…åŸºä½¬ã€‚</p>
<p><a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠæŸ¥è¯¢SQLè§£æã€‹</a>å·²ç»å†™äº†ä¸€åŠï¼Œé¢„è®¡å¾ˆå¿«â€¦</p>
<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼š&lt;a href=&quot;http://
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆä¸€ï¼‰ä¹‹è¯æ³•è§£æ</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-parse-1/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-parse-1/</id>
    <published>2017-07-22T16:00:00.000Z</published>
    <updated>2017-07-31T12:30:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. Lexer è¯æ³•è§£æå™¨</a></li>
<li><a href="#">3. Token è¯æ³•æ ‡è®°</a><ul>
<li><a href="#">3.1 DefaultKeyword è¯æ³•å…³é”®è¯</a></li>
<li><a href="#">3.2 Literals è¯æ³•å­—é¢é‡æ ‡è®°</a><ul>
<li><a href="#">3.2.1 Literals.IDENTIFIER è¯æ³•å…³é”®è¯</a></li>
<li><a href="#">3.2.2 Literals.VARIABLE å˜é‡</a></li>
<li><a href="#">3.2.3 Literals.CHARS å­—ç¬¦ä¸²</a></li>
<li><a href="#">3.2.4 Literals.HEX åå…­è¿›åˆ¶</a></li>
<li><a href="#">3.2.5 Literals.INT æ•´æ•°</a></li>
<li><a href="#">3.2.6 Literals.FLOAT æµ®ç‚¹æ•°</a></li>
</ul>
</li>
<li><a href="#">3.3 Symbol è¯æ³•ç¬¦å·æ ‡è®°</a></li>
<li><a href="#">3.4 Assist è¯æ³•è¾…åŠ©æ ‡è®°</a></li>
</ul>
</li>
<li><a href="#">4. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p><strong>SQL è§£æå¼•æ“</strong>ï¼Œæ•°æ®åº“ä¸­é—´ä»¶å¿…å¤‡çš„åŠŸèƒ½å’Œæµç¨‹ã€‚Sharding-JDBC åœ¨ <code>1.5.0.M1</code> æ­£å¼å‘å¸ƒæ—¶ï¼Œå°† SQL è§£æå¼•æ“ä» Druid æ›¿æ¢æˆäº†è‡ªç ”çš„ã€‚<strong>æ–°å¼•æ“ä»…è§£æåˆ†ç‰‡ä¸Šä¸‹æ–‡ï¼Œå¯¹äº SQL é‡‡ç”¨â€åŠç†è§£â€ç†å¿µï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½å’Œå…¼å®¹æ€§ï¼ŒåŒæ—¶é™ä½äº†ä»£ç å¤æ‚åº¦</strong>ï¼ˆä¸ç†è§£æ²¡å…³ç³»ï¼Œæˆ‘ä»¬åç»­ä¼šæ›´æ–°æ–‡ç« è§£é‡Šè¯¥ä¼˜ç‚¹ï¼‰ã€‚ å›½å†…å¦ä¸€æ¬¾æ•°æ®åº“ä¸­é—´ä»¶ MyCAT SQL è§£æå¼•æ“ä¹Ÿæ˜¯ Druidï¼Œç›®å‰ä¹Ÿåœ¨å¼€å‘å±äºè‡ªå·±çš„ SQL è§£æå¼•æ“ã€‚</p>
<p>å¯èƒ½æœ‰åŒå­¦çœ‹åˆ°<strong>SQL è§£æ</strong>ä¼šè¢«å“åˆ°ï¼Œè¯·æ·¡å®šï¼Œè€å¿ƒå¾€ä¸‹çœ‹ã€‚ã€ŠSQL è§£æã€‹å†…å®¹æˆ‘ä»¬ä¼šåˆ†æˆ 5 ç¯‡ç›¸å¯¹ç®€çŸ­çš„æ–‡ç« ï¼Œè®©å¤§å®¶èƒ½å¤Ÿç›¸å¯¹è½»æ¾æ„‰å¿«çš„å»ç†è§£ï¼š</p>
<ol>
<li>è¯æ³•è§£æ</li>
<li>æ’å…¥ SQL è§£æ</li>
<li>æŸ¥è¯¢ SQL è§£æ</li>
<li>æ›´æ–° SQL è§£æ</li>
<li>åˆ é™¤ SQL è§£æ</li>
</ol>
<hr>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_23/01.png" alt=""></p>
<p><strong>SQL è§£æå¼•æ“</strong>åœ¨ <code>parsing</code> åŒ…ä¸‹ï¼Œå¦‚ä¸Šå›¾æ‰€è§åŒ…å«ä¸¤å¤§ç»„ä»¶ï¼š</p>
<ol>
<li>Lexerï¼š<strong>è¯æ³•</strong>è§£æå™¨ã€‚</li>
<li>Parserï¼š<strong>SQL</strong>è§£æå™¨ã€‚</li>
</ol>
<p>ä¸¤è€…éƒ½æ˜¯è§£æå™¨ï¼ŒåŒºåˆ«åœ¨äº Lexer åªåšè¯æ³•çš„è§£æï¼Œä¸å…³æ³¨ä¸Šä¸‹æ–‡ï¼Œå°†å­—ç¬¦ä¸²æ‹†è§£æˆ N ä¸ªè¯æ³•ã€‚è€Œ Parser åœ¨ Lexer çš„åŸºç¡€ä¸Šï¼Œè¿˜éœ€è¦ç†è§£ SQL ã€‚æ‰“ä¸ªæ¯”æ–¹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">SQL ï¼š<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_user  </div><div class="line">Lexer ï¼š[<span class="keyword">SELECT</span>] [ * ] [<span class="keyword">FROM</span>] [t_user]  </div><div class="line">Parser ï¼šè¿™æ˜¯ä¸€æ¡ [<span class="keyword">SELECT</span>] æŸ¥è¯¢è¡¨ä¸º [t_user] ï¼Œå¹¶ä¸”è¿”å› [ * ] æ‰€æœ‰å­—æ®µçš„ <span class="keyword">SQL</span>ã€‚</div></pre></td></tr></table></figure>
<p>ğŸ™‚ä¸å®Œå…¨æ‡‚ï¼Ÿæ²¡å…³ç³»ï¼Œæœ¬æ–‡çš„ä¸»è§’æ˜¯ Lexerï¼Œæˆ‘ä»¬é€šè¿‡æºç ä¸€ç‚¹ä¸€ç‚¹ç†è§£ã€‚ä¸€å…± 1400 è¡Œå·¦å³ä»£ç å·¦å³ï¼Œè¿˜åŒ…å«æ³¨é‡Šç­‰ç­‰ï¼Œå®é™…æ›´å°‘å™¢ã€‚</p>
<h1 id="2-Lexer-è¯æ³•è§£æå™¨"><a href="#2-Lexer-è¯æ³•è§£æå™¨" class="headerlink" title="2. Lexer è¯æ³•è§£æå™¨"></a>2. Lexer è¯æ³•è§£æå™¨</h1><p><strong>Lexer åŸç†</strong>ï¼š<strong>é¡ºåºé¡ºåºé¡ºåº</strong> è§£æ SQLï¼Œå°†å­—ç¬¦ä¸²æ‹†è§£æˆ N ä¸ªè¯æ³•ã€‚</p>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Lexer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¾“å‡ºå­—ç¬¦ä¸²</div><div class="line">     * æ¯”å¦‚ï¼šSQL</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String input;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¯æ³•æ ‡è®°å­—å…¸</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Dictionary dictionary;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è§£æåˆ° SQL çš„ offset</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> offset;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å½“å‰ è¯æ³•æ ‡è®°</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> Token currentToken;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ†æä¸‹ä¸€ä¸ªè¯æ³•æ ‡è®°.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #currentToken</div><div class="line">     * <span class="doctag">@see</span> #offset</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">nextToken</span><span class="params">()</span> </span>&#123;</div><div class="line">        skipIgnoredToken();</div><div class="line">        <span class="keyword">if</span> (isVariableBegin()) &#123; <span class="comment">// å˜é‡</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanVariable();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isNCharBegin()) &#123; <span class="comment">// N\</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, ++offset).scanChars();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isIdentifierBegin()) &#123; <span class="comment">// Keyword + Literals.IDENTIFIER</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanIdentifier();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isHexDecimalBegin()) &#123; <span class="comment">// åå…­è¿›åˆ¶</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanHexDecimal();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isNumberBegin()) &#123; <span class="comment">// æ•°å­—ï¼ˆæ•´æ•°+æµ®ç‚¹æ•°ï¼‰</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanNumber();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isSymbolBegin()) &#123; <span class="comment">// ç¬¦å·</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanSymbol();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isCharsBegin()) &#123; <span class="comment">// å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼š"abc"</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanChars();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isEnd()) &#123; <span class="comment">// ç»“æŸ</span></div><div class="line">            currentToken = <span class="keyword">new</span> Token(Assist.END, <span class="string">""</span>, offset);</div><div class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// åˆ†æé”™è¯¯ï¼Œæ— ç¬¦åˆæ¡ä»¶çš„è¯æ³•æ ‡è®°</span></div><div class="line">            currentToken = <span class="keyword">new</span> Token(Assist.ERROR, <span class="string">""</span>, offset);</div><div class="line">        &#125;</div><div class="line">        offset = currentToken.getEndPosition();</div><div class="line">        <span class="comment">// System.out.println("| " + currentToken.getLiterals() + " | " + currentToken.getType() + " | " + currentToken.getEndPosition() + " |");</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·³è¿‡å¿½ç•¥çš„è¯æ³•æ ‡è®°</div><div class="line">     * 1. ç©ºæ ¼</div><div class="line">     * 2. SQL Hint</div><div class="line">     * 3. SQL æ³¨é‡Š</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">skipIgnoredToken</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// ç©ºæ ¼</span></div><div class="line">        offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipWhitespace();</div><div class="line">        <span class="comment">// SQL Hint</span></div><div class="line">        <span class="keyword">while</span> (isHintBegin()) &#123;</div><div class="line">            offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipHint();</div><div class="line">            offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipWhitespace();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// SQL æ³¨é‡Š</span></div><div class="line">        <span class="keyword">while</span> (isCommentBegin()) &#123;</div><div class="line">            offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipComment();</div><div class="line">            offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipWhitespace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é€šè¿‡ <code>#nextToken()</code> æ–¹æ³•ï¼Œä¸æ–­è§£æå‡º Token(<em>è¯æ³•æ ‡è®°</em>)ã€‚æˆ‘ä»¬æ¥æ‰§è¡Œä¸€æ¬¡ï¼Œçœ‹çœ‹ SQL ä¼šè¢«æ‹†è§£æˆå“ªäº› Tokenã€‚ </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">SQL ï¼š<span class="keyword">SELECT</span> i.* <span class="keyword">FROM</span> t_order o <span class="keyword">JOIN</span> t_order_item i <span class="keyword">ON</span> o.order_id=i.order_id <span class="keyword">WHERE</span> o.user_id=? <span class="keyword">AND</span> o.order_id=?</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>literals</th>
<th>TokenTypeç±»</th>
<th>TokenTypeå€¼</th>
<th>endPosition</th>
</tr>
</thead>
<tbody>
<tr>
<td>SELECT</td>
<td>DefaultKeyword</td>
<td>SELECT</td>
<td>6</td>
</tr>
<tr>
<td>i</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>8</td>
</tr>
<tr>
<td>.</td>
<td>Symbol</td>
<td>DOT</td>
<td>9</td>
</tr>
<tr>
<td>*</td>
<td>Symbol</td>
<td>STAR</td>
<td>10</td>
</tr>
<tr>
<td>FROM</td>
<td>DefaultKeyword</td>
<td>FROM</td>
<td>15</td>
</tr>
<tr>
<td>t_order</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>23</td>
</tr>
<tr>
<td>o</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>25</td>
</tr>
<tr>
<td>JOIN</td>
<td>DefaultKeyword</td>
<td>JOIN</td>
<td>30</td>
</tr>
<tr>
<td>t_order_item</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>43</td>
</tr>
<tr>
<td>i</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>45</td>
</tr>
<tr>
<td>ON</td>
<td>DefaultKeyword</td>
<td>ON</td>
<td>48</td>
</tr>
<tr>
<td>o</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>50</td>
</tr>
<tr>
<td>.</td>
<td>Symbol</td>
<td>DOT</td>
<td>51</td>
</tr>
<tr>
<td>order_id</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>59</td>
</tr>
<tr>
<td>=</td>
<td>Symbol</td>
<td>EQ</td>
<td>60</td>
</tr>
<tr>
<td>i</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>61</td>
</tr>
<tr>
<td>.</td>
<td>Symbol</td>
<td>DOT</td>
<td>62</td>
</tr>
<tr>
<td>order_id</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>70</td>
</tr>
<tr>
<td>WHERE</td>
<td>DefaultKeyword</td>
<td>WHERE</td>
<td>76</td>
</tr>
<tr>
<td>o</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>78</td>
</tr>
<tr>
<td>.</td>
<td>Symbol</td>
<td>DOT</td>
<td>79</td>
</tr>
<tr>
<td>user_id</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>86</td>
</tr>
<tr>
<td>=</td>
<td>Symbol</td>
<td>EQ</td>
<td>87</td>
</tr>
<tr>
<td>?</td>
<td>Symbol</td>
<td>QUESTION</td>
<td>88</td>
</tr>
<tr>
<td>AND</td>
<td>DefaultKeyword</td>
<td>AND</td>
<td>92</td>
</tr>
<tr>
<td>o</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>94</td>
</tr>
<tr>
<td>.</td>
<td>Symbol</td>
<td>DOT</td>
<td>95</td>
</tr>
<tr>
<td>order_id</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>103</td>
</tr>
<tr>
<td>=</td>
<td>Symbol</td>
<td>EQ</td>
<td>104</td>
</tr>
<tr>
<td>?</td>
<td>Symbol</td>
<td>QUESTION</td>
<td>105</td>
</tr>
<tr>
<td></td>
<td>Assist</td>
<td>END</td>
<td>105</td>
</tr>
</tbody>
</table>
<p>çœ¼å°–çš„åŒå­¦å¯èƒ½çœ‹åˆ°äº† Tokenizerã€‚å¯¹çš„ï¼Œå®ƒæ˜¯ Lexer çš„å¥½åŸºä½¬ï¼Œè´Ÿè´£<strong>åˆ†è¯</strong>ã€‚</p>
<p><em>æˆ‘ä»¬æ¥æ€»ç»“ä¸‹ï¼Œ<code>Lexer#nextToken()</code> æ–¹æ³•é‡Œï¼Œä½¿ç”¨ <code>#skipIgnoredToken()</code> æ–¹æ³•è·³è¿‡å¿½ç•¥çš„ Tokenï¼Œé€šè¿‡ <code>#isXXXX()</code> æ–¹æ³•åˆ¤æ–­å¥½ä¸‹ä¸€ä¸ª Token çš„ç±»å‹åï¼Œ<strong>äº¤ç»™ Tokenizer è¿›è¡Œåˆ†è¯è¿”å› Token</strong>ã€‚â€¼ï¸æ­¤å¤„å¯ä»¥è€ƒè™‘åšä¸ªä¼˜åŒ–ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½ <code>new Tokenizer(...)</code> å‡ºæ¥ï¼Œä¸€ä¸ª Lexer æ­é…ä¸€ä¸ª Tokenizerã€‚</em></p>
<hr>
<p>ç”±äºä¸åŒæ•°æ®åº“éµå®ˆ SQL è§„èŒƒç•¥æœ‰ä¸åŒï¼Œæ‰€ä»¥ä¸åŒçš„æ•°æ®åº“å¯¹åº”ä¸åŒçš„ Lexerã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_23/02.png" alt=""></p>
<p>å­ Lexer é€šè¿‡é‡å†™æ–¹æ³•å®ç°è‡ªå·±ç‹¬æœ‰çš„ SQL è¯­æ³•ã€‚</p>
<h1 id="3-Token-è¯æ³•æ ‡è®°"><a href="#3-Token-è¯æ³•æ ‡è®°" class="headerlink" title="3. Token è¯æ³•æ ‡è®°"></a>3. Token è¯æ³•æ ‡è®°</h1><p>ä¸Šæ–‡æˆ‘ä»¬å·²ç»çœ‹è¿‡ Token çš„ä¾‹å­ï¼Œä¸€å…±æœ‰ 3 ä¸ªå±æ€§ï¼š</p>
<ul>
<li>TokenType type ï¼šè¯æ³•æ ‡è®°ç±»å‹</li>
<li>String literals ï¼šè¯æ³•å­—é¢é‡æ ‡è®°</li>
<li>int endPosition ï¼š<code>literals</code> åœ¨ SQL é‡Œçš„ç»“æŸä½ç½®</li>
</ul>
<p>TokenType è¯æ³•æ ‡è®°ç±»å‹ï¼Œä¸€å…±åˆ†æˆ 4 ä¸ªå¤§ç±»ï¼š</p>
<ul>
<li>DefaultKeyword ï¼šè¯æ³•å…³é”®è¯</li>
<li>Literals ï¼šè¯æ³•å­—é¢é‡æ ‡è®°</li>
<li>Symbol ï¼šè¯æ³•ç¬¦å·æ ‡è®°</li>
<li>Assist ï¼šè¯æ³•è¾…åŠ©æ ‡è®°</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_23/03.png" alt=""></p>
<h2 id="3-1-DefaultKeyword-è¯æ³•å…³é”®è¯"><a href="#3-1-DefaultKeyword-è¯æ³•å…³é”®è¯" class="headerlink" title="3.1 DefaultKeyword è¯æ³•å…³é”®è¯"></a>3.1 DefaultKeyword è¯æ³•å…³é”®è¯</h2><p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_23/04.png" alt=""></p>
<p><strong>ä¸åŒæ•°æ®åº“æœ‰è‡ªå·±ç‹¬æœ‰çš„<em>è¯æ³•å…³é”®è¯</em>ï¼Œä¾‹å¦‚ MySQL ç†ŸçŸ¥çš„åˆ†é¡µ Limitã€‚</strong></p>
<p>æˆ‘ä»¬ä»¥ MySQL ä¸¾ä¸ªä¾‹å­ï¼Œå½“åˆ›å»º MySQLLexer æ—¶ï¼Œä¼šåŠ è½½ DefaultKeyword å’Œ MySQLKeywordï¼ˆ <em>OracleLexerã€PostgreSQLLexerã€SQLServerLexer åŒ MySQLLexer</em> ï¼‰ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MySQLLexer.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MySQLLexer</span> <span class="keyword">extends</span> <span class="title">Lexer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å­—å…¸</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Dictionary dictionary = <span class="keyword">new</span> Dictionary(MySQLKeyword.values());</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MySQLLexer</span><span class="params">(<span class="keyword">final</span> String input)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(input, dictionary);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Dictionary.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Dictionary</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¯æ³•å…³é”®è¯Map</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Keyword&gt; tokens = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1024</span>);</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Dictionary</span><span class="params">(<span class="keyword">final</span> Keyword... dialectKeywords)</span> </span>&#123;</div><div class="line">        fill(dialectKeywords);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è£…ä¸Šé»˜è®¤è¯æ³•å…³é”®è¯ + æ–¹è¨€è¯æ³•å…³é”®è¯</div><div class="line">     * ä¸åŒçš„æ•°æ®åº“æœ‰ç›¸åŒçš„é»˜è®¤è¯æ³•å…³é”®è¯ï¼Œæœ‰æœ‰ä¸åŒçš„æ–¹è¨€å…³é”®è¯</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> dialectKeywords æ–¹è¨€è¯æ³•å…³é”®è¯</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fill</span><span class="params">(<span class="keyword">final</span> Keyword... dialectKeywords)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (DefaultKeyword each : DefaultKeyword.values()) &#123;</div><div class="line">            tokens.put(each.name(), each);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (Keyword each : dialectKeywords) &#123;</div><div class="line">            tokens.put(each.toString(), each);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Keyword ä¸ Literals.IDENTIFIER æ˜¯ä¸€èµ·è§£æçš„ï¼Œæˆ‘ä»¬æ”¾åœ¨ Literals.IDENTIFIER å¤„ä¸€èµ·åˆ†æã€‚</p>
<h2 id="3-2-Literals-è¯æ³•å­—é¢é‡æ ‡è®°"><a href="#3-2-Literals-è¯æ³•å­—é¢é‡æ ‡è®°" class="headerlink" title="3.2 Literals è¯æ³•å­—é¢é‡æ ‡è®°"></a>3.2 Literals è¯æ³•å­—é¢é‡æ ‡è®°</h2><p>Literals è¯æ³•å­—é¢é‡æ ‡è®°ï¼Œä¸€å…±åˆ†æˆ 6 ç§ï¼š</p>
<ul>
<li>IDENTIFIER ï¼šè¯æ³•å…³é”®è¯</li>
<li>VARIABLE ï¼šå˜é‡</li>
<li>CHARS ï¼šå­—ç¬¦ä¸²</li>
<li>HEX ï¼šåå…­è¿›åˆ¶</li>
<li>INT ï¼šæ•´æ•°</li>
<li>FLOAT ï¼šæµ®ç‚¹æ•°</li>
</ul>
<h3 id="3-2-1-Literals-IDENTIFIER-è¯æ³•å…³é”®è¯"><a href="#3-2-1-Literals-IDENTIFIER-è¯æ³•å…³é”®è¯" class="headerlink" title="3.2.1 Literals.IDENTIFIER è¯æ³•å…³é”®è¯"></a>3.2.1 Literals.IDENTIFIER è¯æ³•å…³é”®è¯</h3><p>è¯æ³•å…³é”®è¯ã€‚ä¾‹å¦‚ï¼šè¡¨åï¼ŒæŸ¥è¯¢å­—æ®µ ç­‰ç­‰ã€‚</p>
<p>è§£æ Literals.IDENTIFIER ä¸ Keyword æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isIdentifierBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> isIdentifierBegin(getCurrentChar(<span class="number">0</span>));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isIdentifierBegin</span><span class="params">(<span class="keyword">final</span> <span class="keyword">char</span> ch)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> CharType.isAlphabet(ch) || <span class="string">'`'</span> == ch || <span class="string">'_'</span> == ch || <span class="string">'$'</span> == ch;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Tokenizer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰«ææ ‡è¯†ç¬¦.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> æ ‡è¯†ç¬¦æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Token <span class="title">scanIdentifier</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// `å­—æ®µ`ï¼Œä¾‹å¦‚ï¼šSELECT `id` FROM t_user ä¸­çš„ `id`</span></div><div class="line">   <span class="keyword">if</span> (<span class="string">'`'</span> == charAt(offset)) &#123;</div><div class="line">       <span class="keyword">int</span> length = getLengthUntilTerminatedChar(<span class="string">'`'</span>);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Token(Literals.IDENTIFIER, input.substring(offset, offset + length), offset + length);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">int</span> length = <span class="number">0</span>;</div><div class="line">   <span class="keyword">while</span> (isIdentifierChar(charAt(offset + length))) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   String literals = input.substring(offset, offset + length);</div><div class="line">   <span class="comment">// å¤„ç† order / group ä½œä¸ºè¡¨å</span></div><div class="line">   <span class="keyword">if</span> (isAmbiguousIdentifier(literals)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Token(processAmbiguousIdentifier(offset + length, literals), literals, offset + length);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ä» è¯æ³•å…³é”®è¯ æŸ¥æ‰¾æ˜¯å¦æ˜¯ Keywordï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› Keywordï¼Œå¦åˆ™è¿”å› Literals.IDENTIFIER</span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Token(dictionary.findTokenType(literals, Literals.IDENTIFIER), literals, offset + length);</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¡ç®—åˆ°ç»“æŸå­—ç¬¦çš„é•¿åº¦</div><div class="line">*</div><div class="line">* <span class="doctag">@see</span> #hasEscapeChar(char, int) å¤„ç†ç±»ä¼¼ SELECT a AS `b``c` FROM tableã€‚æ­¤å¤„è¿ç»­çš„ "``" ä¸æ˜¯ç»“å°¾ï¼Œå¦‚æœä¼ é€’çš„æ˜¯ "`" ä¼šäº§ç”Ÿè¯¯åˆ¤ï¼Œæ‰€ä»¥åŠ äº†è¿™ä¸ªåˆ¤æ–­</div><div class="line">* <span class="doctag">@param</span> terminatedChar ç»“æŸå­—ç¬¦</div><div class="line">* <span class="doctag">@return</span> é•¿åº¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getLengthUntilTerminatedChar</span><span class="params">(<span class="keyword">final</span> <span class="keyword">char</span> terminatedChar)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> length = <span class="number">1</span>;</div><div class="line">   <span class="keyword">while</span> (terminatedChar != charAt(offset + length) || hasEscapeChar(terminatedChar, offset + length)) &#123;</div><div class="line">       <span class="keyword">if</span> (offset + length &gt;= input.length()) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnterminatedCharException(terminatedChar);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (hasEscapeChar(terminatedChar, offset + length)) &#123;</div><div class="line">           length++;</div><div class="line">       &#125;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> length + <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦æ˜¯ Escape å­—ç¬¦</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> charIdentifier å­—ç¬¦</div><div class="line">* <span class="doctag">@param</span> offset ä½ç½®</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasEscapeChar</span><span class="params">(<span class="keyword">final</span> <span class="keyword">char</span> charIdentifier, <span class="keyword">final</span> <span class="keyword">int</span> offset)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> charIdentifier == charAt(offset) &amp;&amp; charIdentifier == charAt(offset + <span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isIdentifierChar</span><span class="params">(<span class="keyword">final</span> <span class="keyword">char</span> ch)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> CharType.isAlphabet(ch) || CharType.isDigital(ch) || <span class="string">'_'</span> == ch || <span class="string">'$'</span> == ch || <span class="string">'#'</span> == ch;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦æ˜¯å¼•èµ·æ­§ä¹‰çš„æ ‡è¯†ç¬¦</div><div class="line">* ä¾‹å¦‚ "SELECT * FROM group"ï¼Œæ­¤æ—¶ "group" ä»£è¡¨çš„æ˜¯è¡¨åï¼Œè€Œéè¯æ³•å…³é”®è¯</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> literals æ ‡è¯†ç¬¦</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isAmbiguousIdentifier</span><span class="params">(<span class="keyword">final</span> String literals)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> DefaultKeyword.ORDER.name().equalsIgnoreCase(literals) || DefaultKeyword.GROUP.name().equalsIgnoreCase(literals);</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–å¼•èµ·æ­§ä¹‰çš„æ ‡è¯†ç¬¦å¯¹åº”çš„è¯æ³•æ ‡è®°ç±»å‹</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> offset ä½ç½®</div><div class="line">* <span class="doctag">@param</span> literals æ ‡è¯†ç¬¦</div><div class="line">* <span class="doctag">@return</span> è¯æ³•æ ‡è®°ç±»å‹</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> TokenType <span class="title">processAmbiguousIdentifier</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> offset, <span class="keyword">final</span> String literals)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">   <span class="keyword">while</span> (CharType.isWhitespace(charAt(offset + i))) &#123;</div><div class="line">       i++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (DefaultKeyword.BY.name().equalsIgnoreCase(String.valueOf(<span class="keyword">new</span> <span class="keyword">char</span>[] &#123;charAt(offset + i), charAt(offset + i + <span class="number">1</span>)&#125;))) &#123;</div><div class="line">       <span class="keyword">return</span> dictionary.findTokenType(literals);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> Literals.IDENTIFIER;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-2-Literals-VARIABLE-å˜é‡"><a href="#3-2-2-Literals-VARIABLE-å˜é‡" class="headerlink" title="3.2.2 Literals.VARIABLE å˜é‡"></a>3.2.2 Literals.VARIABLE å˜é‡</h3><p>å˜é‡ã€‚ä¾‹å¦‚ï¼š<code>SELECT @@VERSION</code> ã€‚</p>
<p>è§£ææ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦æ˜¯ å˜é‡</div><div class="line">* MySQL ä¸ SQL Server æ”¯æŒ</div><div class="line">* </div><div class="line">* <span class="doctag">@see</span> Tokenizer#scanVariable()</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isVariableBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Tokenizer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰«æå˜é‡.</div><div class="line">* åœ¨ MySQL é‡Œï¼Œ@ä»£è¡¨ç”¨æˆ·å˜é‡ï¼›@@ä»£è¡¨ç³»ç»Ÿå˜é‡ã€‚</div><div class="line">* åœ¨ SQLServer é‡Œï¼Œæœ‰ @@ã€‚</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> å˜é‡æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Token <span class="title">scanVariable</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> length = <span class="number">1</span>;</div><div class="line">   <span class="keyword">if</span> (<span class="string">'@'</span> == charAt(offset + <span class="number">1</span>)) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">while</span> (isVariableChar(charAt(offset + length))) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Token(Literals.VARIABLE, input.substring(offset, offset + length), offset + length);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-3-Literals-CHARS-å­—ç¬¦ä¸²"><a href="#3-2-3-Literals-CHARS-å­—ç¬¦ä¸²" class="headerlink" title="3.2.3 Literals.CHARS å­—ç¬¦ä¸²"></a>3.2.3 Literals.CHARS å­—ç¬¦ä¸²</h3><p>å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚ï¼š<code>SELECT &quot;123&quot;</code> ã€‚</p>
<p>è§£ææ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦ N\</div><div class="line">* ç›®å‰ SQLServer ç‹¬æœ‰ï¼šåœ¨ SQL Server ä¸­è™•ç† Unicode å­—ä¸²å¸¸æ•¸æ™‚ï¼Œå¿…éœ€ç‚ºæ‰€æœ‰çš„ Unicode å­—ä¸²åŠ ä¸Šå‰ç½®è© N</div><div class="line">*</div><div class="line">* <span class="doctag">@see</span> Tokenizer#scanChars()</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isNCharBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> isSupportNChars() &amp;&amp; <span class="string">'N'</span> == getCurrentChar(<span class="number">0</span>) &amp;&amp; <span class="string">'\''</span> == getCurrentChar(<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isCharsBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="string">'\''</span> == getCurrentChar(<span class="number">0</span>) || <span class="string">'\"'</span> == getCurrentChar(<span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Tokenizer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰«æå­—ç¬¦ä¸².</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> å­—ç¬¦ä¸²æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Token <span class="title">scanChars</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> scanChars(charAt(offset));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> Token <span class="title">scanChars</span><span class="params">(<span class="keyword">final</span> <span class="keyword">char</span> terminatedChar)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> length = getLengthUntilTerminatedChar(terminatedChar);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Token(Literals.CHARS, input.substring(offset + <span class="number">1</span>, offset + length - <span class="number">1</span>), offset + length);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-4-Literals-HEX-åå…­è¿›åˆ¶"><a href="#3-2-4-Literals-HEX-åå…­è¿›åˆ¶" class="headerlink" title="3.2.4 Literals.HEX åå…­è¿›åˆ¶"></a>3.2.4 Literals.HEX åå…­è¿›åˆ¶</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦æ˜¯ åå…­è¿›åˆ¶</div><div class="line">*</div><div class="line">* <span class="doctag">@see</span> Tokenizer#scanHexDecimal()</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isHexDecimalBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="string">'0'</span> == getCurrentChar(<span class="number">0</span>) &amp;&amp; <span class="string">'x'</span> == getCurrentChar(<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Tokenizer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰«æåå…­è¿›åˆ¶æ•°.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> åå…­è¿›åˆ¶æ•°æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Token <span class="title">scanHexDecimal</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> length = HEX_BEGIN_SYMBOL_LENGTH;</div><div class="line">   <span class="comment">// è´Ÿæ•°</span></div><div class="line">   <span class="keyword">if</span> (<span class="string">'-'</span> == charAt(offset + length)) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">while</span> (isHex(charAt(offset + length))) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Token(Literals.HEX, input.substring(offset, offset + length), offset + length);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-5-Literals-INT-æ•´æ•°"><a href="#3-2-5-Literals-INT-æ•´æ•°" class="headerlink" title="3.2.5 Literals.INT æ•´æ•°"></a>3.2.5 Literals.INT æ•´æ•°</h3><p>æ•´æ•°ã€‚ä¾‹å¦‚ï¼š<code>SELECT * FROM t_user WHERE id = 1</code>ã€‚</p>
<p>Literals.INT ä¸ Literals.FLOAT æ˜¯ä¸€èµ·è§£æçš„ï¼Œæˆ‘ä»¬æ”¾åœ¨ Literals.FLOAT å¤„ä¸€èµ·åˆ†æã€‚</p>
<h3 id="3-2-6-Literals-FLOAT-æµ®ç‚¹æ•°"><a href="#3-2-6-Literals-FLOAT-æµ®ç‚¹æ•°" class="headerlink" title="3.2.6 Literals.FLOAT æµ®ç‚¹æ•°"></a>3.2.6 Literals.FLOAT æµ®ç‚¹æ•°</h3><p>æµ®ç‚¹æ•°ã€‚ä¾‹å¦‚ï¼š<code>SELECT * FROM t_user WHERE id = 1.0</code>ã€‚<br>æµ®ç‚¹æ•°åŒ…å«å‡ ç§ï¼šâ€1.0â€ï¼Œâ€1.0Fâ€ï¼Œâ€7.823E5â€ï¼ˆç§‘å­¦è®¡æ•°æ³•ï¼‰ã€‚</p>
<p>è§£ææ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦æ˜¯ æ•°å­—</div><div class="line">* '-' éœ€è¦ç‰¹æ®Šå¤„ç†ã€‚".2" è¢«å¤„ç†æˆçœç•¥0çš„å°æ•°ï¼Œ"-.2" ä¸èƒ½è¢«å¤„ç†æˆçœç•¥çš„å°æ•°ï¼Œå¦åˆ™ä¼šå‡ºé—®é¢˜ã€‚</div><div class="line">* ä¾‹å¦‚è¯´ï¼Œ"SELECT a-.2" å¤„ç†çš„ç»“æœæ˜¯ "SELECT" / "a" / "-" / ".2"</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isNumberBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> CharType.isDigital(getCurrentChar(<span class="number">0</span>)) <span class="comment">// æ•°å­—</span></div><div class="line">           || (<span class="string">'.'</span> == getCurrentChar(<span class="number">0</span>) &amp;&amp; CharType.isDigital(getCurrentChar(<span class="number">1</span>)) &amp;&amp; !isIdentifierBegin(getCurrentChar(-<span class="number">1</span>)) <span class="comment">// æµ®ç‚¹æ•°</span></div><div class="line">           || (<span class="string">'-'</span> == getCurrentChar(<span class="number">0</span>) &amp;&amp; (<span class="string">'.'</span> == getCurrentChar(<span class="number">0</span>) || CharType.isDigital(getCurrentChar(<span class="number">1</span>))))); <span class="comment">// è´Ÿæ•°</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Tokenizer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰«ææ•°å­—.</div><div class="line">* è§£ææ•°å­—çš„ç»“æœä¼šæœ‰ä¸¤ç§ï¼šæ•´æ•° å’Œ æµ®ç‚¹æ•°.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> æ•°å­—æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Token <span class="title">scanNumber</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> length = <span class="number">0</span>;</div><div class="line">   <span class="comment">// è´Ÿæ•°</span></div><div class="line">   <span class="keyword">if</span> (<span class="string">'-'</span> == charAt(offset + length)) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æµ®ç‚¹æ•°</span></div><div class="line">   length += getDigitalLength(offset + length);</div><div class="line">   <span class="keyword">boolean</span> isFloat = <span class="keyword">false</span>;</div><div class="line">   <span class="keyword">if</span> (<span class="string">'.'</span> == charAt(offset + length)) &#123;</div><div class="line">       isFloat = <span class="keyword">true</span>;</div><div class="line">       length++;</div><div class="line">       length += getDigitalLength(offset + length);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç§‘å­¦è®¡æ•°è¡¨ç¤ºï¼Œä¾‹å¦‚ï¼šSELECT 7.823E5</span></div><div class="line">   <span class="keyword">if</span> (isScientificNotation(offset + length)) &#123;</div><div class="line">       isFloat = <span class="keyword">true</span>;</div><div class="line">       length++;</div><div class="line">       <span class="keyword">if</span> (<span class="string">'+'</span> == charAt(offset + length) || <span class="string">'-'</span> == charAt(offset + length)) &#123;</div><div class="line">           length++;</div><div class="line">       &#125;</div><div class="line">       length += getDigitalLength(offset + length);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æµ®ç‚¹æ•°ï¼Œä¾‹å¦‚ï¼šSELECT 1.333F</span></div><div class="line">   <span class="keyword">if</span> (isBinaryNumber(offset + length)) &#123;</div><div class="line">       isFloat = <span class="keyword">true</span>;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Token(isFloat ? Literals.FLOAT : Literals.INT, input.substring(offset, offset + length), offset + length);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œè¦ç‰¹åˆ«æ³¨æ„ä¸‹ï¼š<strong>â€œ-â€œ</strong>ã€‚åœ¨æ•°å­—è¡¨è¾¾å®ä¾‹ï¼Œå¯ä»¥åˆ¤å®šä¸º è´Ÿå· å’Œ å‡å·ï¼ˆä¸è€ƒè™‘ç§‘å­¦è®¡æ•°æ³•ï¼‰ã€‚</p>
<ul>
<li>â€œ.2â€  è§£æç»“æœæ˜¯ â€œ.2â€</li>
<li>â€œ-.2â€ è§£æç»“æœä¸èƒ½æ˜¯ â€œ-.2â€ï¼Œè€Œæ˜¯ â€œ-â€œ å’Œ â€œ.2â€ã€‚</li>
</ul>
<h2 id="3-3-Symbol-è¯æ³•ç¬¦å·æ ‡è®°"><a href="#3-3-Symbol-è¯æ³•ç¬¦å·æ ‡è®°" class="headerlink" title="3.3 Symbol è¯æ³•ç¬¦å·æ ‡è®°"></a>3.3 Symbol è¯æ³•ç¬¦å·æ ‡è®°</h2><p>è¯æ³•ç¬¦å·æ ‡è®°ã€‚ä¾‹å¦‚ï¼šâ€{â€œ, â€œ}â€, â€œ&gt;=â€ ç­‰ç­‰ã€‚</p>
<p>è§£ææ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦æ˜¯ ç¬¦å·</div><div class="line">*</div><div class="line">* <span class="doctag">@see</span> Tokenizer#scanSymbol()</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSymbolBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> CharType.isSymbol(getCurrentChar(<span class="number">0</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CharType.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ¤æ–­æ˜¯å¦ä¸ºç¬¦å·.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> ch å¾…åˆ¤æ–­çš„å­—ç¬¦</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦ä¸ºç¬¦å·</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isSymbol</span><span class="params">(<span class="keyword">final</span> <span class="keyword">char</span> ch)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="string">'('</span> == ch || <span class="string">')'</span> == ch || <span class="string">'['</span> == ch || <span class="string">']'</span> == ch || <span class="string">'&#123;'</span> == ch || <span class="string">'&#125;'</span> == ch || <span class="string">'+'</span> == ch || <span class="string">'-'</span> == ch || <span class="string">'*'</span> == ch || <span class="string">'/'</span> == ch || <span class="string">'%'</span> == ch || <span class="string">'^'</span> == ch || <span class="string">'='</span> == ch</div><div class="line">           || <span class="string">'&gt;'</span> == ch || <span class="string">'&lt;'</span> == ch || <span class="string">'~'</span> == ch || <span class="string">'!'</span> == ch || <span class="string">'?'</span> == ch || <span class="string">'&amp;'</span> == ch || <span class="string">'|'</span> == ch || <span class="string">'.'</span> == ch || <span class="string">':'</span> == ch || <span class="string">'#'</span> == ch || <span class="string">','</span> == ch || <span class="string">';'</span> == ch;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Tokenizer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰«æç¬¦å·.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> ç¬¦å·æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Token <span class="title">scanSymbol</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> length = <span class="number">0</span>;</div><div class="line">   <span class="keyword">while</span> (CharType.isSymbol(charAt(offset + length))) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   String literals = input.substring(offset, offset + length);</div><div class="line">   <span class="comment">// å€’åºéå†ï¼ŒæŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„ ç¬¦å·ã€‚ä¾‹å¦‚ literals = ";;"ï¼Œä¼šæ˜¯æ‹†åˆ†æˆä¸¤ä¸ª ";"ã€‚å¦‚æœåŸºäºæ­£åºï¼Œliterals = "&lt;="ï¼Œä¼šè¢«è§£ææˆ "&lt;" + "="ã€‚</span></div><div class="line">   Symbol symbol;</div><div class="line">   <span class="keyword">while</span> (<span class="keyword">null</span> == (symbol = Symbol.literalsOf(literals))) &#123;</div><div class="line">       literals = input.substring(offset, offset + --length);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Token(symbol, literals, offset + length);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-4-Assist-è¯æ³•è¾…åŠ©æ ‡è®°"><a href="#3-4-Assist-è¯æ³•è¾…åŠ©æ ‡è®°" class="headerlink" title="3.4 Assist è¯æ³•è¾…åŠ©æ ‡è®°"></a>3.4 Assist è¯æ³•è¾…åŠ©æ ‡è®°</h2><p>Assist è¯æ³•è¾…åŠ©æ ‡è®°ï¼Œä¸€å…±åˆ†æˆ 2 ç§ï¼š</p>
<ul>
<li>END ï¼šåˆ†æç»“æŸ</li>
<li>ERROR ï¼šåˆ†æé”™è¯¯ã€‚</li>
</ul>
<h1 id="4-å½©è›‹"><a href="#4-å½©è›‹" class="headerlink" title="4. å½©è›‹"></a>4. å½©è›‹</h1><p>è€é“ï¼Œæ˜¯ä¸æ˜¯æ¯”æƒ³è±¡ä¸­ç®€å•ä¸€äº›ï¼Ÿï¼ç»§ç»­åŠ æ²¹å†™ Parser ç›¸å…³çš„æ–‡ç« ï¼æ¥ä¸€æ³¢å¾®ä¿¡å…¬ä¼—å·å…³æ³¨å§ã€‚</p>
<hr>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¹¿çš„åœºæ™¯ã€‚ç™»è®°å§ï¼Œå°‘å¹´ï¼</strong></p>
<hr>
<p><strong>æˆ‘åˆ›å»ºäº†ä¸€ä¸ªå¾®ä¿¡ç¾¤ã€æºç åœˆã€‘ï¼Œå¸Œæœ›å’Œå¤§å®¶åˆ†äº«äº¤æµè¯»æºç çš„ç»éªŒã€‚<br>è¯»æºç å…ˆéš¾åæ˜“ï¼ŒæŒæ¡æ–¹æ³•åï¼Œå¯ä»¥åšæ›´æœ‰æ·±åº¦çš„å­¦ä¹ ã€‚<br>è€Œä¸”æŒæ¡æ–¹æ³•å¹¶ä¸éš¾å™¢ã€‚<br>åŠ ç¾¤æ–¹å¼ï¼šå¾®ä¿¡å…¬ä¼—å·å‘é€å…³é”®å­—ã€qunã€‘ã€‚</strong></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/strong
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>MyCAT æºç åˆ†æ  â€”â€” SQL ON MongoDB</title>
    <link href="http://www.yunai.me/MyCAT/connect-mongodb/"/>
    <id>http://www.yunai.me/MyCAT/connect-mongodb/</id>
    <published>2017-07-18T16:00:00.000Z</published>
    <updated>2017-07-31T12:30:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ä¸»æµç¨‹</a></li>
<li><a href="#">3. æŸ¥è¯¢æ“ä½œ</a></li>
<li><a href="#">4. æ’å…¥æ“ä½œ</a></li>
<li><a href="#">5. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>å¯èƒ½ä½ åœ¨çœ‹åˆ°è¿™ä¸ªæ ‡é¢˜ä¼šå°å°çš„åƒæƒŠï¼ŒMyCAT èƒ½ä½¿ç”¨ MongoDB åšæ•°æ®èŠ‚ç‚¹ã€‚æ˜¯çš„ï¼Œæ²¡é”™ï¼Œç¡®å®å¯ä»¥ã€‚<br>å¼å¼å¼ï¼Œè®©æˆ‘ä»¬å¼€å¯è¿™æ®µç¥å¥‡çš„â€œæ—…é€”â€ã€‚</p>
<p>æœ¬æ–‡ä¸»è¦åˆ†æˆå››éƒ¨åˆ†ï¼š</p>
<ol>
<li>æ€»ä½“æµç¨‹ï¼Œè®©ä½ æœ‰ä¸ªæ•´ä½“çš„è®¤è¯†</li>
<li>æŸ¥è¯¢æ“ä½œ</li>
<li>æ’å…¥æ“ä½œ</li>
<li>å½©è›‹ï¼ŒğŸ˜ˆå½©è›‹ï¼ŒğŸ™‚å½©è›‹</li>
</ol>
<p>å»ºè®®ä½ çœ‹è¿‡è¿™ä¸¤ç¯‡æ–‡ç« ï¼ˆ<em>éå¿…é¡»</em>ï¼‰ï¼š</p>
<ol>
<li><a href="http://www.yunai.me/MyCAT/single-db-single-table-insert/?self">ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹</a></li>
<li><a href="http://www.yunai.me/MyCAT/single-db-single-table-select/?self">ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹</a></li>
</ol>
<h1 id="2-ä¸»æµç¨‹"><a href="#2-ä¸»æµç¨‹" class="headerlink" title="2. ä¸»æµç¨‹"></a>2. ä¸»æµç¨‹</h1><p><img src="http://www.yunai.me/images/MyCAT/2017_07_19/01.png" alt="">   </p>
<ol>
<li><code>MyCAT Server</code> æ¥æ”¶ <code>MySQL Client</code> åŸºäº <strong>MySQLåè®®</strong> çš„è¯·æ±‚ï¼Œç¿»è¯‘ <strong>SQL</strong> æˆ <strong>MongoDBæ“ä½œ</strong> å‘é€ç»™ <code>MongoDB Server</code>ã€‚</li>
<li><code>MyCAT Server</code> æ¥æ”¶ <code>MongoDB Server</code> è¿”å›çš„ <strong>MongoDBæ•°æ®</strong>ï¼Œç¿»è¯‘æˆ <code>MySQLæ•°æ®ç»“æœ</code> è¿”å›ç»™ <code>MySQL Client</code>ã€‚</li>
</ol>
<p>è¿™æ ·ä¸€çœ‹ï¼ŒMyCAT è¿æ¥ MongoDB æ˜¯ä¸æ˜¯å°‘ç¥å¥‡ä¸€ç‚¹åˆ—ã€‚</p>
<hr>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_19/02.png" alt=""></p>
<blockquote>
<p>Javaæ•°æ®åº“è¿æ¥ï¼Œï¼ˆJava Database Connectivityï¼Œç®€ç§°JDBCï¼‰æ˜¯Javaè¯­è¨€ä¸­ç”¨æ¥è§„èŒƒå®¢æˆ·ç«¯ç¨‹åºå¦‚ä½•æ¥è®¿é—®æ•°æ®åº“çš„åº”ç”¨ç¨‹åºæ¥å£ï¼Œæä¾›äº†è¯¸å¦‚æŸ¥è¯¢å’Œæ›´æ–°æ•°æ®åº“ä¸­æ•°æ®çš„æ–¹æ³•ã€‚JDBCä¹Ÿæ˜¯Sun Microsystemsçš„å•†æ ‡ã€‚JDBCæ˜¯é¢å‘å…³ç³»å‹æ•°æ®åº“çš„ã€‚</p>
</blockquote>
<p>MyCAT ä½¿ç”¨ JDBC è§„èŒƒï¼ŒæŠ½è±¡äº†å¯¹ MongoDB çš„è®¿é—®ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼ŒMyCAT ä¹ŸæŠ½è±¡äº† SequoiaDB çš„è®¿é—®ã€‚å¯èƒ½è¿™æ ·è¯´æ³•æœ‰äº›æŠ½è±¡ï¼Œçœ‹ä¸ªç±»å›¾å‹å‹æƒŠã€‚</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_19/03.png" alt=""></p>
<p>æ˜¯ä¸æ˜¯ç†Ÿæ‚‰çš„å‘³é“ã€‚<strong>ä¸å¾—ä¸è¯´ JDBC è§„èŒƒçš„ç²¾å¦™ã€‚</strong></p>
<h1 id="3-æŸ¥è¯¢æ“ä½œ"><a href="#3-æŸ¥è¯¢æ“ä½œ" class="headerlink" title="3. æŸ¥è¯¢æ“ä½œ"></a>3. æŸ¥è¯¢æ“ä½œ</h1><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">id</span>, <span class="keyword">name</span> <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> <span class="keyword">name</span> &gt; <span class="string">''</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> _id <span class="keyword">DESC</span>;</div></pre></td></tr></table></figure>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_19/04.png" alt=""></p>
<p>çœ‹é¡ºåºå›¾å·²ç»å¾ˆæ–¹ä¾¿çš„ç†è§£æ•´ä½“é€»è¾‘ï¼Œæˆ‘å°±ä¸å¤šåºŸè¯å•¦ã€‚æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªæ ¸å¿ƒçš„ä»£ç é€»è¾‘ã€‚</p>
<p><strong>1ã€æŸ¥è¯¢ MongoDB</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MongoSQLParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> MongoData <span class="title">query</span><span class="params">()</span> <span class="keyword">throws</span> MongoSQLException </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!(statement <span class="keyword">instanceof</span> SQLSelectStatement)) &#123;</div><div class="line">       <span class="comment">//return null;</span></div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"not a query sql statement"</span>);</div><div class="line">   &#125;</div><div class="line">   MongoData mongo = <span class="keyword">new</span> MongoData();</div><div class="line">   DBCursor c = <span class="keyword">null</span>;</div><div class="line">   SQLSelectStatement selectStmt = (SQLSelectStatement) statement;</div><div class="line">   SQLSelectQuery sqlSelectQuery = selectStmt.getSelect().getQuery();</div><div class="line">   <span class="keyword">int</span> icount = <span class="number">0</span>;</div><div class="line">   <span class="keyword">if</span> (sqlSelectQuery <span class="keyword">instanceof</span> MySqlSelectQueryBlock) &#123;</div><div class="line">       MySqlSelectQueryBlock mysqlSelectQuery = (MySqlSelectQueryBlock) selectStmt.getSelect().getQuery();</div><div class="line"></div><div class="line">       BasicDBObject fields = <span class="keyword">new</span> BasicDBObject();</div><div class="line"></div><div class="line">       <span class="comment">// æ˜¾ç¤ºï¼ˆè¿”å›ï¼‰çš„å­—æ®µ</span></div><div class="line">       <span class="keyword">for</span> (SQLSelectItem item : mysqlSelectQuery.getSelectList()) &#123;</div><div class="line">           <span class="comment">//System.out.println(item.toString());</span></div><div class="line">           <span class="keyword">if</span> (!(item.getExpr() <span class="keyword">instanceof</span> SQLAllColumnExpr)) &#123;</div><div class="line">               <span class="keyword">if</span> (item.getExpr() <span class="keyword">instanceof</span> SQLAggregateExpr) &#123;</div><div class="line">                   SQLAggregateExpr expr = (SQLAggregateExpr) item.getExpr();</div><div class="line">                   <span class="keyword">if</span> (expr.getMethodName().equals(<span class="string">"COUNT"</span>)) &#123; <span class="comment">// TODO å¾…è¯»ï¼šcountï¼ˆ*ï¼‰</span></div><div class="line">                       icount = <span class="number">1</span>;</div><div class="line">                       mongo.setField(getExprFieldName(expr), Types.BIGINT);</div><div class="line">                   &#125;</div><div class="line">                   fields.put(getExprFieldName(expr), <span class="number">1</span>);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   fields.put(getFieldName(item), <span class="number">1</span>);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// è¡¨å</span></div><div class="line">       SQLTableSource table = mysqlSelectQuery.getFrom();</div><div class="line">       DBCollection coll = <span class="keyword">this</span>._db.getCollection(table.toString());</div><div class="line">       mongo.setTable(table.toString());</div><div class="line"></div><div class="line">       <span class="comment">// WHERE</span></div><div class="line">       SQLExpr expr = mysqlSelectQuery.getWhere();</div><div class="line">       DBObject query = parserWhere(expr);</div><div class="line"></div><div class="line">       <span class="comment">// GROUP BY</span></div><div class="line">       SQLSelectGroupByClause groupby = mysqlSelectQuery.getGroupBy();</div><div class="line">       BasicDBObject gbkey = <span class="keyword">new</span> BasicDBObject();</div><div class="line">       <span class="keyword">if</span> (groupby != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">for</span> (SQLExpr gbexpr : groupby.getItems()) &#123;</div><div class="line">               <span class="keyword">if</span> (gbexpr <span class="keyword">instanceof</span> SQLIdentifierExpr) &#123;</div><div class="line">                   String name = ((SQLIdentifierExpr) gbexpr).getName();</div><div class="line">                   gbkey.put(name, Integer.valueOf(<span class="number">1</span>));</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           icount = <span class="number">2</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// SKIP / LIMIT</span></div><div class="line">       <span class="keyword">int</span> limitoff = <span class="number">0</span>;</div><div class="line">       <span class="keyword">int</span> limitnum = <span class="number">0</span>;</div><div class="line">       <span class="keyword">if</span> (mysqlSelectQuery.getLimit() != <span class="keyword">null</span>) &#123;</div><div class="line">           limitoff = getSQLExprToInt(mysqlSelectQuery.getLimit().getOffset());</div><div class="line">           limitnum = getSQLExprToInt(mysqlSelectQuery.getLimit().getRowCount());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (icount == <span class="number">1</span>) &#123; <span class="comment">// COUNTï¼ˆ*ï¼‰</span></div><div class="line">           mongo.setCount(coll.count(query));</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (icount == <span class="number">2</span>) &#123; <span class="comment">// MapReduce</span></div><div class="line">           BasicDBObject initial = <span class="keyword">new</span> BasicDBObject();</div><div class="line">           initial.put(<span class="string">"num"</span>, <span class="number">0</span>);</div><div class="line">           String reduce = <span class="string">"function (obj, prev) &#123; "</span> + <span class="string">"  prev.num++&#125;"</span>;</div><div class="line">           mongo.setGrouyBy(coll.group(gbkey, query, initial, reduce));</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">if</span> ((limitoff &gt; <span class="number">0</span>) || (limitnum &gt; <span class="number">0</span>)) &#123;</div><div class="line">               c = coll.find(query, fields).skip(limitoff).limit(limitnum);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               c = coll.find(query, fields);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="comment">// order by</span></div><div class="line">           SQLOrderBy orderby = mysqlSelectQuery.getOrderBy();</div><div class="line">           <span class="keyword">if</span> (orderby != <span class="keyword">null</span>) &#123;</div><div class="line">               BasicDBObject order = <span class="keyword">new</span> BasicDBObject();</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; orderby.getItems().size(); i++) &#123;</div><div class="line">                   SQLSelectOrderByItem orderitem = orderby.getItems().get(i);</div><div class="line">                   order.put(orderitem.getExpr().toString(), getSQLExprToAsc(orderitem.getType()));</div><div class="line">               &#125;</div><div class="line">               c.sort(order);</div><div class="line">               <span class="comment">// System.out.println(order);</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       mongo.setCursor(c);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> mongo;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>2ã€æŸ¥è¯¢æ¡ä»¶</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MongoSQLParser.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parserWhere</span><span class="params">(SQLExpr aexpr, BasicDBObject o)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (aexpr <span class="keyword">instanceof</span> SQLBinaryOpExpr) &#123;</div><div class="line">       SQLBinaryOpExpr expr = (SQLBinaryOpExpr) aexpr;</div><div class="line">       SQLExpr exprL = expr.getLeft();</div><div class="line">       <span class="keyword">if</span> (!(exprL <span class="keyword">instanceof</span> SQLBinaryOpExpr)) &#123;</div><div class="line">           <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"="</span>)) &#123;</div><div class="line">               o.put(exprL.toString(), getExpValue(expr.getRight()));</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               String op = <span class="string">""</span>;</div><div class="line">               <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"&lt;"</span>)) &#123;</div><div class="line">                   op = <span class="string">"$lt"</span>;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"&lt;="</span>)) &#123;</div><div class="line">                   op = <span class="string">"$lte"</span>;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"&gt;"</span>)) &#123;</div><div class="line">                   op = <span class="string">"$gt"</span>;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"&gt;="</span>)) &#123;</div><div class="line">                   op = <span class="string">"$gte"</span>;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"!="</span>)) &#123;</div><div class="line">                   op = <span class="string">"$ne"</span>;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"&lt;&gt;"</span>)) &#123;</div><div class="line">                   op = <span class="string">"$ne"</span>;</div><div class="line">               &#125;</div><div class="line">               parserDBObject(o, exprL.toString(), op, getExpValue(expr.getRight()));</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"AND"</span>)) &#123;</div><div class="line">               parserWhere(exprL, o);</div><div class="line">               parserWhere(expr.getRight(), o);</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"OR"</span>)) &#123;</div><div class="line">               orWhere(exprL, expr.getRight(), o);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Can't identify the operation of  of where"</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">orWhere</span><span class="params">(SQLExpr exprL, SQLExpr exprR, BasicDBObject ob)</span> </span>&#123;</div><div class="line">   BasicDBObject xo = <span class="keyword">new</span> BasicDBObject();</div><div class="line">   BasicDBObject yo = <span class="keyword">new</span> BasicDBObject();</div><div class="line">   parserWhere(exprL, xo);</div><div class="line">   parserWhere(exprR, yo);</div><div class="line">   ob.put(<span class="string">"$or"</span>, <span class="keyword">new</span> Object[]&#123;xo, yo&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>3ã€è§£æ MongoDB æ•°æ®</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MongoResultSet.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">MongoResultSet</span><span class="params">(MongoData mongo, String schema)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">this</span>._cursor = mongo.getCursor();</div><div class="line">   <span class="keyword">this</span>._schema = schema;</div><div class="line">   <span class="keyword">this</span>._table = mongo.getTable();</div><div class="line">   <span class="keyword">this</span>.isSum = mongo.getCount() &gt; <span class="number">0</span>;</div><div class="line">   <span class="keyword">this</span>._sum = mongo.getCount();</div><div class="line">   <span class="keyword">this</span>.isGroupBy = mongo.getType();</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.isGroupBy) &#123;</div><div class="line">       dblist = mongo.getGrouyBys();</div><div class="line">       <span class="keyword">this</span>.isSum = <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>._cursor != <span class="keyword">null</span>) &#123;</div><div class="line">       select = _cursor.getKeysWanted().keySet().toArray(<span class="keyword">new</span> String[<span class="number">0</span>]);</div><div class="line">       <span class="comment">// è§£æ fields</span></div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>._cursor.hasNext()) &#123;</div><div class="line">           _cur = _cursor.next();</div><div class="line">           <span class="keyword">if</span> (_cur != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">if</span> (select.length == <span class="number">0</span>) &#123;</div><div class="line">                   SetFields(_cur.keySet());</div><div class="line">               &#125;</div><div class="line">               _row = <span class="number">1</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// è®¾ç½® fields ç±»å‹</span></div><div class="line">       <span class="keyword">if</span> (select.length == <span class="number">0</span>) &#123;</div><div class="line">           select = <span class="keyword">new</span> String[]&#123;<span class="string">"_id"</span>&#125;;</div><div class="line">           SetFieldType(<span class="keyword">true</span>);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           SetFieldType(<span class="keyword">false</span>);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       SetFields(mongo.getFields().keySet());<span class="comment">//new String[]&#123;"COUNT(*)"&#125;;</span></div><div class="line">       SetFieldType(mongo.getFields());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å½“ä½¿ç”¨ <code>SELECT *</code> æŸ¥è¯¢å­—æ®µæ—¶ï¼Œfields ä½¿ç”¨ç¬¬ä¸€æ¡æ•°æ®è¿”å›çš„ fieldsã€‚å³ä½¿ï¼Œåé¢çš„æ•°æ®æœ‰å…¶ä»– fieldsï¼Œä¹Ÿä¸è¿”å›ã€‚</li>
</ul>
<p><strong>4ã€è¿”å›æ•°æ®ç»™ MySQL Client</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JDBCConnection.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ouputResultSet</span><span class="params">(ServerConnection sc, String sql)</span></span></div><div class="line">       <span class="keyword">throws</span> SQLException &#123;</div><div class="line">   ResultSet rs = <span class="keyword">null</span>;</div><div class="line">   Statement stmt = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       stmt = con.createStatement();</div><div class="line">       rs = stmt.executeQuery(sql);</div><div class="line"></div><div class="line">       <span class="comment">// header</span></div><div class="line">       List&lt;FieldPacket&gt; fieldPks = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">       ResultSetUtil.resultSetToFieldPacket(sc.getCharset(), fieldPks, rs, <span class="keyword">this</span>.isSpark);</div><div class="line">       <span class="keyword">int</span> colunmCount = fieldPks.size();</div><div class="line">       ByteBuffer byteBuf = sc.allocate();</div><div class="line">       ResultSetHeaderPacket headerPkg = <span class="keyword">new</span> ResultSetHeaderPacket();</div><div class="line">       headerPkg.fieldCount = fieldPks.size();</div><div class="line">       headerPkg.packetId = ++packetId;</div><div class="line">       byteBuf = headerPkg.write(byteBuf, sc, <span class="keyword">true</span>);</div><div class="line">       byteBuf.flip();</div><div class="line">       <span class="keyword">byte</span>[] header = <span class="keyword">new</span> <span class="keyword">byte</span>[byteBuf.limit()];</div><div class="line">       byteBuf.get(header);</div><div class="line">       byteBuf.clear();</div><div class="line">       List&lt;<span class="keyword">byte</span>[]&gt; fields = <span class="keyword">new</span> ArrayList&lt;<span class="keyword">byte</span>[]&gt;(fieldPks.size());</div><div class="line">       <span class="keyword">for</span> (FieldPacket curField : fieldPks) &#123;</div><div class="line">           curField.packetId = ++packetId;</div><div class="line">           byteBuf = curField.write(byteBuf, sc, <span class="keyword">false</span>);</div><div class="line">           byteBuf.flip();</div><div class="line">           <span class="keyword">byte</span>[] field = <span class="keyword">new</span> <span class="keyword">byte</span>[byteBuf.limit()];</div><div class="line">           byteBuf.get(field);</div><div class="line">           byteBuf.clear();</div><div class="line">           fields.add(field);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// header eof</span></div><div class="line">       EOFPacket eofPckg = <span class="keyword">new</span> EOFPacket();</div><div class="line">       eofPckg.packetId = ++packetId;</div><div class="line">       byteBuf = eofPckg.write(byteBuf, sc, <span class="keyword">false</span>);</div><div class="line">       byteBuf.flip();</div><div class="line">       <span class="keyword">byte</span>[] eof = <span class="keyword">new</span> <span class="keyword">byte</span>[byteBuf.limit()];</div><div class="line">       byteBuf.get(eof);</div><div class="line">       byteBuf.clear();</div><div class="line">       <span class="keyword">this</span>.respHandler.fieldEofResponse(header, fields, eof, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">       <span class="comment">// row</span></div><div class="line">       <span class="keyword">while</span> (rs.next()) &#123;</div><div class="line">           RowDataPacket curRow = <span class="keyword">new</span> RowDataPacket(colunmCount);</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; colunmCount; i++) &#123;</div><div class="line">               <span class="keyword">int</span> j = i + <span class="number">1</span>;</div><div class="line">               <span class="keyword">if</span> (MysqlDefs.isBianry((<span class="keyword">byte</span>) fieldPks.get(i).type)) &#123;</div><div class="line">                   curRow.add(rs.getBytes(j));</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fieldPks.get(i).type == MysqlDefs.FIELD_TYPE_DECIMAL ||</div><div class="line">                       fieldPks.get(i).type == (MysqlDefs.FIELD_TYPE_NEW_DECIMAL - <span class="number">256</span>)) &#123; <span class="comment">// field type is unsigned byte</span></div><div class="line">                   <span class="comment">// ensure that do not use scientific notation format</span></div><div class="line">                   BigDecimal val = rs.getBigDecimal(j);</div><div class="line">                   curRow.add(StringUtil.encode(val != <span class="keyword">null</span> ? val.toPlainString() : <span class="keyword">null</span>, sc.getCharset()));</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   curRow.add(StringUtil.encode(rs.getString(j), sc.getCharset()));</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           curRow.packetId = ++packetId;</div><div class="line">           byteBuf = curRow.write(byteBuf, sc, <span class="keyword">false</span>);</div><div class="line">           byteBuf.flip();</div><div class="line">           <span class="keyword">byte</span>[] row = <span class="keyword">new</span> <span class="keyword">byte</span>[byteBuf.limit()];</div><div class="line">           byteBuf.get(row);</div><div class="line">           byteBuf.clear();</div><div class="line">           <span class="keyword">this</span>.respHandler.rowResponse(row, <span class="keyword">this</span>);</div><div class="line">       &#125;</div><div class="line">       fieldPks.clear();</div><div class="line">       <span class="comment">// row eof</span></div><div class="line">       eofPckg = <span class="keyword">new</span> EOFPacket();</div><div class="line">       eofPckg.packetId = ++packetId;</div><div class="line">       byteBuf = eofPckg.write(byteBuf, sc, <span class="keyword">false</span>);</div><div class="line">       byteBuf.flip();</div><div class="line">       eof = <span class="keyword">new</span> <span class="keyword">byte</span>[byteBuf.limit()];</div><div class="line">       byteBuf.get(eof);</div><div class="line">       sc.recycle(byteBuf);</div><div class="line">       <span class="keyword">this</span>.respHandler.rowEofResponse(eof, <span class="keyword">this</span>);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="keyword">if</span> (rs != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               rs.close();</div><div class="line">           &#125; <span class="keyword">catch</span> (SQLException e) &#123;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (stmt != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               stmt.close();</div><div class="line">           &#125; <span class="keyword">catch</span> (SQLException e) &#123;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// MongoResultSet.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(String columnLabel)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   Object x = getObject(columnLabel);</div><div class="line">   <span class="keyword">if</span> (x == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> x.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å½“è¿”å›å­—æ®µå€¼æ˜¯ Object æ—¶ï¼Œè¿”å›è¯¥å¯¹è±¡.toString()ã€‚ä¾‹å¦‚ï¼š</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">mysql&gt; select * from user order by _id asc;</div><div class="line">+--------------------------+------+-------------------------------+</div><div class="line">| _id                      | name | profile                       |</div><div class="line">+--------------------------+------+-------------------------------+</div><div class="line">| 1                        | 123  | &#123; "age" : 1 , "height" : 100&#125; |</div></pre></td></tr></table></figure>
<h1 id="4-æ’å…¥æ“ä½œ"><a href="#4-æ’å…¥æ“ä½œ" class="headerlink" title="4. æ’å…¥æ“ä½œ"></a>4. æ’å…¥æ“ä½œ</h1><p><img src="http://www.yunai.me/images/MyCAT/2017_07_19/05.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MongoSQLParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">()</span> <span class="keyword">throws</span> MongoSQLException </span>&#123;</div><div class="line">   <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> SQLInsertStatement) &#123;</div><div class="line">       <span class="keyword">return</span> InsertData((SQLInsertStatement) statement);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> SQLUpdateStatement) &#123;</div><div class="line">       <span class="keyword">return</span> UpData((SQLUpdateStatement) statement);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> SQLDropTableStatement) &#123;</div><div class="line">       <span class="keyword">return</span> dropTable((SQLDropTableStatement) statement);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> SQLDeleteStatement) &#123;</div><div class="line">       <span class="keyword">return</span> DeleteDate((SQLDeleteStatement) statement);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> SQLCreateTableStatement) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">InsertData</span><span class="params">(SQLInsertStatement state)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (state.getValues().getValues().size() == <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"number of  columns error"</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (state.getValues().getValues().size() != state.getColumns().size()) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"number of values and columns have to match"</span>);</div><div class="line">   &#125;</div><div class="line">   SQLTableSource table = state.getTableSource();</div><div class="line">   BasicDBObject o = <span class="keyword">new</span> BasicDBObject();</div><div class="line">   <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (SQLExpr col : state.getColumns()) &#123;</div><div class="line">       o.put(getFieldName2(col), getExpValue(state.getValues().getValues().get(i)));</div><div class="line">       i++;</div><div class="line">   &#125;</div><div class="line">   DBCollection coll = <span class="keyword">this</span>._db.getCollection(table.toString());</div><div class="line">   coll.insert(o);</div><div class="line">   <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="5-å½©è›‹"><a href="#5-å½©è›‹" class="headerlink" title="5. å½©è›‹"></a>5. å½©è›‹</h1><p>è€é“ï¼Œçœ‹åˆ°è¿™é‡Œï¼Œæ¥ä¸€æ³¢å¾®ä¿¡å…¬ä¼—å·å…³æ³¨å§ï¼Ÿï¼</p>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt="wechat_mp"></p>
<p><strong>1ã€æ”¯æŒå¤š MongoDB ï¼Œå¹¶ä½¿ç”¨ MyCAT è¿›è¡Œåˆ†ç‰‡ã€‚</strong></p>
<p>MyCAT é…ç½®ï¼š<a href="https://github.com/YunaiV/Mycat-Server/tree/1.6/src/test/resources/multi_mongodb" rel="external nofollow noopener noreferrer" target="_blank">multi_mongodb</a></p>
<p><strong>2ã€æ”¯æŒ MongoDB + MySQL ä½œä¸ºåŒä¸€ä¸ª MyCAT Table çš„æ•°æ®èŠ‚ç‚¹ã€‚æŸ¥è¯¢æ—¶ï¼Œå¯ä»¥åˆå¹¶æ•°æ®ç»“æœã€‚</strong></p>
<p>æŸ¥è¯¢æ—¶ï¼Œè¿”å› MySQL æ•°æ®è®°å½•å­—æ®µè¦æ¯” MongoDB æ•°æ®è®°å½•å­—æ®µå…¨ï¼Œå¦åˆ™ï¼Œåˆå¹¶ç»“æœæ—¶ä¼šæŠ¥é”™ã€‚</p>
<p>MyCAT é…ç½®ï¼š<a href="https://github.com/YunaiV/Mycat-Server/tree/1.6/src/test/resources/single_mongodb_mysql" rel="external nofollow noopener noreferrer" target="_blank">single_mongodb_mysql</a></p>
<p><strong>3ã€MongoDB ä½œä¸ºæ•°æ®èŠ‚ç‚¹æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ MyCAT æä¾›çš„æ•°æ®åº“ä¸»é”®å­—æ®µåŠŸèƒ½ã€‚</strong></p>
<p>MyCAT é…ç½®ï¼š<a href="https://github.com/YunaiV/Mycat-Server/tree/1.6/src/test/resources/single_mongodb" rel="external nofollow noopener noreferrer" target="_blank">single_mongodb</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/strong
    
    </summary>
    
      <category term="MyCAT" scheme="http://www.yunai.me/categories/MyCAT/"/>
    
    
  </entry>
  
  <entry>
    <title>MyCAT æºç åˆ†æ  â€”â€” PreparedStatement é‡æ–°å…¥é—¨</title>
    <link href="http://www.yunai.me/MyCAT/what-is-PreparedStatement/"/>
    <id>http://www.yunai.me/MyCAT/what-is-PreparedStatement/</id>
    <published>2017-07-16T16:00:00.000Z</published>
    <updated>2017-07-31T12:30:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. JDBC Client å®ç°</a></li>
<li><a href="#">3. MyCAT Server å®ç°</a><ul>
<li><a href="#">3.1 åˆ›å»º PreparedStatement</a></li>
<li><a href="#">3.2 æ‰§è¡Œ SQL</a></li>
</ul>
</li>
<li><a href="#">4. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>ç›¸ä¿¡å¾ˆå¤šåŒå­¦åœ¨å­¦ä¹  JDBC æ—¶ï¼Œéƒ½ç¢°åˆ° <code>PreparedStatement</code> å’Œ <code>Statement</code>ã€‚ç©¶ç«Ÿè¯¥ä½¿ç”¨å“ªä¸ªå‘¢ï¼Ÿæœ€ç»ˆå¾ˆå¯èƒ½æ˜¯<strong>æ‡µé‡Œæ‡µæ‡‚</strong>çš„çœ‹äº†å„ç§æ€»ç»“ï¼Œä½¿ç”¨ <code>PreparedStatement</code>ã€‚é‚£ä¹ˆæœ¬æ–‡ï¼Œé€šè¿‡ MyCAT å¯¹ <code>PreparedStatement</code> çš„å®ç°å¯¹å¤§å®¶èƒ½å¤Ÿé‡æ–°ç†è§£ä¸‹ã€‚</p>
<p>æœ¬æ–‡ä¸»è¦åˆ†æˆä¸¤éƒ¨åˆ†ï¼š</p>
<ol>
<li>JDBC Client å¦‚ä½•å®ç° <code>PreparedStatement</code>ã€‚</li>
<li>MyCAT Server å¦‚ä½•å¤„ç† <code>PreparedStatement</code>ã€‚</li>
</ol>
<p>ğŸ˜ˆ Letâ€™s Goã€‚</p>
<h1 id="2-JDBC-Client-å®ç°"><a href="#2-JDBC-Client-å®ç°" class="headerlink" title="2. JDBC Client å®ç°"></a>2. JDBC Client å®ç°</h1><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€æ®µå¤§å®¶æœ€å–œæ¬¢å¤åˆ¶ç²˜è´´ä¹‹ä¸€çš„ä»£ç ï¼ŒJDBC PreparedStatement æŸ¥è¯¢ MySQL æ•°æ®åº“ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PreparedStatementDemo</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException </span>&#123;</div><div class="line">        <span class="comment">// 1. è·å¾—æ•°æ®åº“è¿æ¥</span></div><div class="line">        Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</div><div class="line">        Connection conn = DriverManager.getConnection(<span class="string">"jdbc:mysql://127.0.0.1:8066/dbtest?useServerPrepStmts=true"</span>, <span class="string">"root"</span>, <span class="string">"123456"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// PreparedStatement</span></div><div class="line">        PreparedStatement ps = conn.prepareStatement(<span class="string">"SELECT id, username, password FROM t_user WHERE id = ?"</span>);</div><div class="line">        ps.setLong(<span class="number">1</span>, Math.abs(<span class="keyword">new</span> Random().nextLong()));</div><div class="line"></div><div class="line">        <span class="comment">// execute</span></div><div class="line">        ps.executeQuery();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è·å– MySQL è¿æ¥æ—¶ï¼Œ<code>useServerPrepStmts=true</code>  æ˜¯<strong>éå¸¸éå¸¸éå¸¸é‡è¦</strong>çš„å‚æ•°ã€‚å¦‚æœä¸é…ç½®ï¼Œ<code>PreparedStatement</code> å®é™…æ˜¯ä¸ª<strong>å‡</strong>çš„ <code>PreparedStatement</code>ï¼ˆæ–°ç‰ˆæœ¬é»˜è®¤ä¸º FALSEï¼Œæ®è¯´éƒ¨åˆ†è€ç‰ˆæœ¬é»˜è®¤ä¸º TRUEï¼‰ï¼Œæœªå¼€å¯æœåŠ¡ç«¯çº§åˆ«çš„ SQL é¢„ç¼–è¯‘ã€‚</p>
<p>WHY ï¼Ÿæ¥çœ‹ä¸‹ JDBC é‡Œé¢æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// com.mysql.jdbc.ConnectionImpl.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> PreparedStatement <span class="title">prepareStatement</span><span class="params">(String sql, <span class="keyword">int</span> resultSetType, <span class="keyword">int</span> resultSetConcurrency)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">synchronized</span> (getConnectionMutex()) &#123;</div><div class="line">       checkClosed();</div><div class="line">       </div><div class="line">       PreparedStatement pStmt = <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">boolean</span> canServerPrepare = <span class="keyword">true</span>;</div><div class="line">       String nativeSql = getProcessEscapeCodesForPrepStmts() ? nativeSQL(sql) : sql;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.useServerPreparedStmts &amp;&amp; getEmulateUnsupportedPstmts()) &#123;</div><div class="line">           canServerPrepare = canHandleAsServerPreparedStatement(nativeSql);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.useServerPreparedStmts &amp;&amp; canServerPrepare) &#123;</div><div class="line">           <span class="keyword">if</span> (<span class="keyword">this</span>.getCachePreparedStatements()) &#123; <span class="comment">// ä»ç¼“å­˜ä¸­è·å– pStmt</span></div><div class="line">               <span class="keyword">synchronized</span> (<span class="keyword">this</span>.serverSideStatementCache) &#123;</div><div class="line">                   pStmt = (com.mysql.jdbc.ServerPreparedStatement) <span class="keyword">this</span>.serverSideStatementCache</div><div class="line">                           .remove(makePreparedStatementCacheKey(<span class="keyword">this</span>.database, sql));</div><div class="line"></div><div class="line">                   <span class="keyword">if</span> (pStmt != <span class="keyword">null</span>) &#123;</div><div class="line">                       ((com.mysql.jdbc.ServerPreparedStatement) pStmt).setClosed(<span class="keyword">false</span>);</div><div class="line">                       pStmt.clearParameters(); <span class="comment">// æ¸…ç†ä¸Šæ¬¡ç•™ä¸‹çš„å‚æ•°</span></div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   <span class="keyword">if</span> (pStmt == <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="comment">// .... çœç•¥ä»£ç  ï¼šå‘ Server æäº¤ SQL é¢„ç¼–è¯‘ã€‚</span></div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">// å‘ Server æäº¤ SQL é¢„ç¼–è¯‘ã€‚</span></div><div class="line">                   pStmt = ServerPreparedStatement.getInstance(getMultiHostSafeProxy(), nativeSql, <span class="keyword">this</span>.database, resultSetType, resultSetConcurrency);</div><div class="line"></div><div class="line">                   pStmt.setResultSetType(resultSetType);</div><div class="line">                   pStmt.setResultSetConcurrency(resultSetConcurrency);</div><div class="line">               &#125; <span class="keyword">catch</span> (SQLException sqlEx) &#123;</div><div class="line">                   <span class="comment">// Punt, if necessary</span></div><div class="line">                   <span class="keyword">if</span> (getEmulateUnsupportedPstmts()) &#123;</div><div class="line">                       pStmt = (PreparedStatement) clientPrepareStatement(nativeSql, resultSetType, resultSetConcurrency, <span class="keyword">false</span>);</div><div class="line">                   &#125; <span class="keyword">else</span> &#123;</div><div class="line">                       <span class="keyword">throw</span> sqlEx;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           pStmt = (PreparedStatement) clientPrepareStatement(nativeSql, resultSetType, resultSetConcurrency, <span class="keyword">false</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> pStmt;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ã€å‰è€…ã€‘å½“ Client å¼€å¯ <code>useServerPreparedStmts</code> å¹¶ä¸” Server æ”¯æŒ <code>ServerPrepare</code>ï¼Œ<strong>Client ä¼šå‘ Server æäº¤ SQL é¢„ç¼–è¯‘è¯·æ±‚</strong>ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.useServerPreparedStmts &amp;&amp; canServerPrepare) &#123;</div><div class="line">    pStmt = ServerPreparedStatement.getInstance(getMultiHostSafeProxy(), nativeSql, <span class="keyword">this</span>.database, resultSetType, resultSetConcurrency);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ã€åè€…ã€‘å½“ Client æœªå¼€å¯ <code>useServerPreparedStmts</code> æˆ–è€… Server ä¸æ”¯æŒ <code>ServerPrepare</code>ï¼ŒClient åˆ›å»º <code>PreparedStatement</code>ï¼Œ<strong><em>ä¸ä¼š</em>å‘ Server æäº¤ SQL é¢„ç¼–è¯‘è¯·æ±‚</strong>ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">pStmt = (PreparedStatement) clientPrepareStatement(nativeSql, resultSetType, resultSetConcurrency, <span class="keyword">false</span>);</div></pre></td></tr></table></figure>
<p><strong>å³ä½¿è¿™æ ·ï¼Œç©¶ç«Ÿä¸ºä»€ä¹ˆæ€§èƒ½ä¼šæ›´å¥½å‘¢ï¼Ÿ</strong></p>
<ul>
<li>ã€å‰è€…ã€‘è¿”å›çš„ <code>PreparedStatement</code> å¯¹è±¡ç±»æ˜¯ <code>JDBC42ServerPreparedStatement.java</code>ï¼Œåç»­æ¯æ¬¡æ‰§è¡Œ SQL åªéœ€å°†å¯¹åº”å ä½ç¬¦?å¯¹åº”çš„å€¼æäº¤ç»™ Serverå³å¯ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“å’Œ SQL è§£æå¼€é”€ã€‚  </li>
<li>ã€åè€…ã€‘è¿”å›çš„ <code>PreparedStatement</code> å¯¹è±¡ç±»æ˜¯ <code>JDBC42PreparedStatement.java</code>ï¼Œåç»­æ¯æ¬¡æ‰§è¡Œ SQL éœ€è¦å°†<strong>å®Œæ•´</strong>çš„ SQL æäº¤ç»™ Serverï¼Œå¢åŠ äº†ç½‘ç»œä¼ è¾“å’Œ SQL è§£æå¼€é”€ã€‚</li>
</ul>
<p><em>ğŸŒšï¼šã€å‰è€…ã€‘æ€§èƒ½ä¸€å®šæ¯”ã€åè€…ã€‘å¥½å—ï¼Ÿç›¸ä¿¡ä½ å·²ç»æœ‰äº†æ­£ç¡®çš„ç­”æ¡ˆã€‚</em></p>
<h1 id="3-MyCAT-Server-å®ç°"><a href="#3-MyCAT-Server-å®ç°" class="headerlink" title="3. MyCAT Server å®ç°"></a>3. MyCAT Server å®ç°</h1><h2 id="3-1-åˆ›å»º-PreparedStatement"><a href="#3-1-åˆ›å»º-PreparedStatement" class="headerlink" title="3.1 åˆ›å»º PreparedStatement"></a>3.1 åˆ›å»º PreparedStatement</h2><p>è¯¥æ“ä½œå¯¹åº” Client <code>conn.prepareStatement(....)</code>ã€‚</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_17/01.png" alt=""></p>
<p>MyCAT æ¥æ”¶åˆ°è¯·æ±‚åï¼Œåˆ›å»º <code>PreparedStatement</code>ï¼Œå¹¶è¿”å› <code>statementId</code> ç­‰ä¿¡æ¯ã€‚Client å‘èµ· SQL æ‰§è¡Œæ—¶ï¼Œéœ€è¦å°† <code>statementId</code> å¸¦ç»™ MyCATã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ServerPrepareHandler.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(String sql)</span> </span>&#123;</div><div class="line">LOGGER.debug(<span class="string">"use server prepare, sql: "</span> + sql);</div><div class="line"></div><div class="line">   PreparedStatement pstmt = pstmtForSql.get(sql);</div><div class="line">   <span class="keyword">if</span> (pstmt == <span class="keyword">null</span>) &#123; <span class="comment">// ç¼“å­˜ä¸­è·å–</span></div><div class="line">   	<span class="comment">// è§£æè·å–å­—æ®µä¸ªæ•°å’Œå‚æ•°ä¸ªæ•°</span></div><div class="line">   	<span class="keyword">int</span> columnCount = getColumnCount(sql);</div><div class="line">   	<span class="keyword">int</span> paramCount = getParamCount(sql);</div><div class="line">       pstmt = <span class="keyword">new</span> PreparedStatement(++pstmtId, sql, columnCount, paramCount);</div><div class="line">       pstmtForSql.put(pstmt.getStatement(), pstmt);</div><div class="line">       pstmtForId.put(pstmt.getId(), pstmt);</div><div class="line">   &#125;</div><div class="line">   PreparedStmtResponse.response(pstmt, source);</div><div class="line">&#125;</div><div class="line"><span class="comment">// PreparedStmtResponse.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">response</span><span class="params">(PreparedStatement pstmt, FrontendConnection c)</span> </span>&#123;</div><div class="line">   <span class="keyword">byte</span> packetId = <span class="number">0</span>;</div><div class="line"></div><div class="line">   <span class="comment">// write preparedOk packet</span></div><div class="line">   PreparedOkPacket preparedOk = <span class="keyword">new</span> PreparedOkPacket();</div><div class="line">   preparedOk.packetId = ++packetId;</div><div class="line">   preparedOk.statementId = pstmt.getId();</div><div class="line">   preparedOk.columnsNumber = pstmt.getColumnsNumber();</div><div class="line">   preparedOk.parametersNumber = pstmt.getParametersNumber();</div><div class="line">   ByteBuffer buffer = preparedOk.write(c.allocate(), c,<span class="keyword">true</span>);</div><div class="line"></div><div class="line">   <span class="comment">// write parameter field packet</span></div><div class="line">   <span class="keyword">int</span> parametersNumber = preparedOk.parametersNumber;</div><div class="line">   <span class="keyword">if</span> (parametersNumber &gt; <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parametersNumber; i++) &#123;</div><div class="line">           FieldPacket field = <span class="keyword">new</span> FieldPacket();</div><div class="line">           field.packetId = ++packetId;</div><div class="line">           buffer = field.write(buffer, c,<span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">       EOFPacket eof = <span class="keyword">new</span> EOFPacket();</div><div class="line">       eof.packetId = ++packetId;</div><div class="line">       buffer = eof.write(buffer, c,<span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// write column field packet</span></div><div class="line">   <span class="keyword">int</span> columnsNumber = preparedOk.columnsNumber;</div><div class="line">   <span class="keyword">if</span> (columnsNumber &gt; <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; columnsNumber; i++) &#123;</div><div class="line">           FieldPacket field = <span class="keyword">new</span> FieldPacket();</div><div class="line">           field.packetId = ++packetId;</div><div class="line">           buffer = field.write(buffer, c,<span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">       EOFPacket eof = <span class="keyword">new</span> EOFPacket();</div><div class="line">       eof.packetId = ++packetId;</div><div class="line">       buffer = eof.write(buffer, c,<span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// send buffer</span></div><div class="line">   c.write(buffer);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>æ¯ä¸ªè¿æ¥ä¹‹é—´ï¼ŒPreparedStatement ä¸å…±äº«ï¼Œå³ä¸åŒè¿æ¥ï¼Œå³ä½¿ SQLç›¸åŒï¼Œå¯¹åº”çš„ PreparedStatement ä¸åŒã€‚</strong></p>
<h2 id="3-2-æ‰§è¡Œ-SQL"><a href="#3-2-æ‰§è¡Œ-SQL" class="headerlink" title="3.2 æ‰§è¡Œ SQL"></a>3.2 æ‰§è¡Œ SQL</h2><p>è¯¥æ“ä½œå¯¹åº” Client <code>conn.execute(....)</code>ã€‚</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_17/02.png" alt=""></p>
<p>MyCAT æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå°† PreparedStatement ä½¿ç”¨è¯·æ±‚çš„å‚æ•°æ ¼å¼åŒ–æˆå¯æ‰§è¡Œçš„ SQL è¿›è¡Œæ‰§è¡Œã€‚ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">String sql = pstmt.sql.format(request.params);</div><div class="line">execute(sql);</div></pre></td></tr></table></figure>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ServerPrepareHandler.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</div><div class="line">   <span class="keyword">long</span> pstmtId = ByteUtil.readUB4(data, <span class="number">5</span>);</div><div class="line">   PreparedStatement pstmt = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">if</span> ((pstmt = pstmtForId.get(pstmtId)) == <span class="keyword">null</span>) &#123;</div><div class="line">       source.writeErrMessage(ErrorCode.ER_ERROR_WHEN_EXECUTING_COMMAND, <span class="string">"Unknown pstmtId when executing."</span>);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="comment">// å‚æ•°è¯»å–</span></div><div class="line">       ExecutePacket packet = <span class="keyword">new</span> ExecutePacket(pstmt);</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           packet.read(data, source.getCharset());</div><div class="line">       &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line">           source.writeErrMessage(ErrorCode.ER_ERROR_WHEN_EXECUTING_COMMAND, e.getMessage());</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">       BindValue[] bindValues = packet.values;</div><div class="line">       <span class="comment">// è¿˜åŸsqlä¸­çš„åŠ¨æ€å‚æ•°ä¸ºå®é™…å‚æ•°å€¼</span></div><div class="line">       String sql = prepareStmtBindValue(pstmt, bindValues);</div><div class="line">       <span class="comment">// æ‰§è¡Œsql</span></div><div class="line">       source.getSession2().setPrepared(<span class="keyword">true</span>);</div><div class="line">       source.query(sql);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">prepareStmtBindValue</span><span class="params">(PreparedStatement pstmt, BindValue[] bindValues)</span> </span>&#123;</div><div class="line">   String sql = pstmt.getStatement();</div><div class="line">   <span class="keyword">int</span>[] paramTypes = pstmt.getParametersType();</div><div class="line"></div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">   <span class="keyword">int</span> idx = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, len = sql.length(); i &lt; len; i++) &#123;</div><div class="line">       <span class="keyword">char</span> c = sql.charAt(i);</div><div class="line">       <span class="keyword">if</span> (c != <span class="string">'?'</span>) &#123;</div><div class="line">           sb.append(c);</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// å¤„ç†å ä½ç¬¦?</span></div><div class="line">       <span class="keyword">int</span> paramType = paramTypes[idx];</div><div class="line">       BindValue bindValue = bindValues[idx];</div><div class="line">       idx++;</div><div class="line">       <span class="comment">// å¤„ç†å­—æ®µä¸ºç©ºçš„æƒ…å†µ</span></div><div class="line">       <span class="keyword">if</span> (bindValue.isNull) &#123;</div><div class="line">           sb.append(<span class="string">"NULL"</span>);</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// éç©ºæƒ…å†µ, æ ¹æ®å­—æ®µç±»å‹è·å–å€¼</span></div><div class="line">       <span class="keyword">switch</span> (paramType &amp; <span class="number">0xff</span>) &#123;</div><div class="line">           <span class="keyword">case</span> Fields.FIELD_TYPE_TINY:</div><div class="line">               sb.append(String.valueOf(bindValue.byteBinding));</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> Fields.FIELD_TYPE_SHORT:</div><div class="line">               sb.append(String.valueOf(bindValue.shortBinding));</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> Fields.FIELD_TYPE_LONG:</div><div class="line">               sb.append(String.valueOf(bindValue.intBinding));</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="comment">// .... çœç•¥éæ ¸å¿ƒä»£ç </span></div><div class="line">        &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> sb.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="4-å½©è›‹"><a href="#4-å½©è›‹" class="headerlink" title="4. å½©è›‹"></a>4. å½©è›‹</h1><p>ğŸ’¯ çœ‹åˆ°æ­¤å¤„æ˜¯ä¸æ˜¯çœŸçˆ±ï¼Ÿï¼åæ­£æˆ‘ä¿¡äº†ã€‚<br>ç»™è€é“ä»¬é¢å¤–åŠ ä¸ªğŸ—ã€‚</p>
<p>ç»†å¿ƒçš„åŒå­¦ä»¬å¯èƒ½å·²ç»æ³¨æ„åˆ° JDBC Client æ˜¯æ”¯æŒç¼“å­˜ <code>PreparedStatement</code>ï¼Œæ— éœ€æ¯æ¬¡éƒ½è®© Server è¿›è¡Œåˆ›å»ºã€‚</p>
<p>å½“é…ç½® MySQL æ•°æ®è¿æ¥ <code>cachePrepStmts=true</code> æ—¶å¼€å¯ Client çº§åˆ«çš„ç¼“å­˜ã€‚Butï¼Œ<strong>æ­¤å¤„çš„ç¼“å­˜åˆå’Œä¸€èˆ¬çš„ç¼“å­˜ä¸ä¸€æ ·</strong>ï¼Œæ˜¯ä½¿ç”¨ <code>remove</code> çš„æ–¹å¼è·å¾—çš„ï¼Œå¹¶ä¸”åˆ›å»ºå¥½ <code>PreparedStatement</code> æ—¶ä¹Ÿä¸æ·»åŠ åˆ°ç¼“å­˜ã€‚é‚£ä»€ä¹ˆæ—¶å€™æ·»åŠ ç¼“å­˜å‘¢ï¼Ÿåœ¨ <code>pstmt.close()</code> æ—¶ï¼Œå¹¶ä¸”<strong><code>pstmt</code> æ˜¯é€šè¿‡ç¼“å­˜è·å–æ—¶</strong>ï¼Œæ·»åŠ åˆ°ç¼“å­˜ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ServerPreparedStatement.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   MySQLConnection locallyScopedConn = <span class="keyword">this</span>.connection;</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (locallyScopedConn == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span>; <span class="comment">// already closed</span></div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">synchronized</span> (locallyScopedConn.getConnectionMutex()) &#123;</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.isCached &amp;&amp; isPoolable() &amp;&amp; !<span class="keyword">this</span>.isClosed) &#123;</div><div class="line">           clearParameters();</div><div class="line">           <span class="keyword">this</span>.isClosed = <span class="keyword">true</span>;</div><div class="line">           <span class="keyword">this</span>.connection.recachePreparedStatement(<span class="keyword">this</span>);</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       realClose(<span class="keyword">true</span>, <span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// ConnectionImpl.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recachePreparedStatement</span><span class="params">(ServerPreparedStatement pstmt)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">synchronized</span> (getConnectionMutex()) &#123;</div><div class="line">       <span class="keyword">if</span> (getCachePreparedStatements() &amp;&amp; pstmt.isPoolable()) &#123;</div><div class="line">           <span class="keyword">synchronized</span> (<span class="keyword">this</span>.serverSideStatementCache) &#123;</div><div class="line">               <span class="keyword">this</span>.serverSideStatementCache.put(makePreparedStatementCacheKey(pstmt.currentCatalog, pstmt.originalSql), pstmt);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå®ç°ï¼Ÿ<code>PreparedStatement</code> æ˜¯æœ‰çŠ¶æ€çš„å˜é‡ï¼Œæˆ‘ä»¬ä¼šå» <code>setXXX(pos, value)</code>ï¼Œä¸€æ—¦å¤šçº¿ç¨‹å…±äº«ï¼Œä¼šå¯¼è‡´é”™ä¹±ã€‚</p>
<p>ğŸ—¿ è¿™ä¸ªâ€œå½©è›‹â€è¿˜æ»¡æ„ä¹ˆï¼Ÿ<strong>è¯·å…³æ³¨æˆ‘çš„å…¬ä¼—å·ï¼šèŠ‹è‰¿çš„åç«¯å°å±‹</strong>ã€‚ä¸‹ä¸€ç¯‡æ›´æ–°ï¼šã€ŠMyCATæºç è§£æ â€”â€” MongoDBã€‹ï¼Œæå¤§å¯èƒ½å°±åœ¨æœ¬å‘¨å™¢ã€‚</p>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt="wechat_mp"></p>
<p>å¦å¤–æ¨èä¸€ç¯‡æ–‡ç« ï¼š<a href="https://www.zybuluo.com/stefanlu/note/254899" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJDBC PreparedStatementã€‹</a>ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/strong
    
    </summary>
    
      <category term="MyCAT" scheme="http://www.yunai.me/categories/MyCAT/"/>
    
    
  </entry>
  
  <entry>
    <title>ä¸ºä»€ä¹ˆé˜…è¯» Sharding-JDBC æºç ï¼Ÿ</title>
    <link href="http://www.yunai.me/Sharding-JDBC/why-read-Sharding-JDBC-source-code/"/>
    <id>http://www.yunai.me/Sharding-JDBC/why-read-Sharding-JDBC-source-code/</id>
    <published>2017-07-15T16:00:00.000Z</published>
    <updated>2017-08-04T09:03:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h2 id="ä¸ºä»€ä¹ˆé˜…è¯»-Sharding-JDBC-æºç ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆé˜…è¯»-Sharding-JDBC-æºç ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆé˜…è¯» Sharding-JDBC æºç ï¼Ÿ"></a>ä¸ºä»€ä¹ˆé˜…è¯» Sharding-JDBC æºç ï¼Ÿ</h2><ol>
<li>çœ‹å®Œå¤§éƒ¨åˆ†çš„ MyCAT æºç ï¼Œæœ‰æƒŠå–œçš„åœ°æ–¹ï¼Œä¹Ÿæœ‰å¤±æœ›çš„åœ°æ–¹ï¼Œå› è€Œæƒ³çœ‹çœ‹ Sharding-JDBC è¿›è¡Œä¸‹å¯¹æ¯”ã€‚å°½ç®¡ï¼ŒSharding-JDBC æ˜¯ Client ç«¯çº§åˆ«ï¼ŒMyCAT æ˜¯ Server çº§åˆ«ã€‚</li>
<li>Sharding-JDBC ç»å†è¿‡å½“å½“æœ¬èº«ä¸šåŠ¡çš„è€ƒéªŒï¼Œä»å¯é æ€§ä¸Šæ¥è¯´ä¼šæ›´è®©äººæœ‰ä¿¡èµ–æ„Ÿã€‚</li>
<li>æ–‡æ¡£æ›´åŠ å®Œå–„ï¼Œå¼€å‘ä½“ç³»æ›´åŠ å¥å…¨ã€‚</li>
<li>Sharding-JDBC 1.5.0.M3 å‘å¸ƒã€‚</li>
<li><strong>æœ€å¤§åŠªåŠ›é€è¾¾å‹</strong>äº‹åŠ¡æ”¯æŒï¼Œæƒ³è¦è¿›ä¸€æ­¥äº†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆã€‚Last But Very Importmentã€‚</li>
</ol>
<h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><ul>
<li><p>FROM MyCAT</p>
<p>  <strong>ä» MyCAT é˜…è¯»è®¡åˆ’å¤åˆ¶ï¼Œç”¨äºå¯¹æ¯”ã€‚</strong></p>
</li>
<li><p>[x] <del>NIO</del></p>
</li>
<li>[x] <del>åˆ†å¸ƒå¼äº‹åŠ¡</del></li>
<li>[x] <del>MyCAT ä¸»ä»</del></li>
<li>[x] <del>æ”¯æŒprepareé¢„ç¼–è¯‘æŒ‡ä»¤</del></li>
<li>[x] è‡ªå¢åºåˆ—</li>
<li>[x] å•åº“ä»»æ„ Join</li>
<li>[x] <del>è·¨åº“2è¡¨ Join</del></li>
<li>[x] <del>è·¨åº“å¤šè¡¨ Join</del></li>
<li>[x] SQL è§£æ</li>
<li>[ ] è¯»å†™åˆ†ç¦»</li>
<li>[x] <del>MySQL ä¸»ä»</del></li>
<li>[x] <del>è‡ªåŠ¨æ•…éšœåˆ‡æ¢</del></li>
<li>[x] <del>Galera Cluster é›†ç¾¤</del></li>
<li>[x] <del>MHA é›†ç¾¤</del></li>
<li>[x] <del>Percona é›†ç¾¤</del></li>
<li>[x] <del>æœåŠ¡é™çº§</del></li>
<li>[x] <del>å¤šç§Ÿæˆ·</del></li>
<li>[x] è·¯ç”±</li>
<li>[x] <del>MyCAT é›†ç¾¤</del></li>
<li>[x] <del>æ³¨è§£</del></li>
<li>[x] <del>ç¼“å­˜</del></li>
<li>[x] <del>ç›‘æ§</del></li>
<li>[x] <del>Mongodb</del></li>
<li>[ ] å†…å­˜ç®¡ç†</li>
<li>[ ] æ•°æ®èšåˆ</li>
<li>[ ] æ•°æ®æ’åº</li>
<li>[x] åˆ†è¡¨</li>
<li>[x] åˆ†åº“</li>
<li>[x] <del>å…¨å±€è¡¨</del></li>
<li>[x] <del>E/Rå…³ç³»</del></li>
<li>[x] <del>æœåŠ¡é™çº§</del></li>
<li>[x] <del>SQL æ³¨å…¥æ”»å‡»æ‹¦æˆª</del></li>
<li>[x] <del>MySQL åè®®</del></li>
<li>[x] <del>PostgreSQL åè®®</del></li>
<li><p>[ ] å­˜å‚¨è¿‡ç¨‹</p>
</li>
<li><p>FROM Sharding-JDBC</p>
<p>  <strong>ä» å®˜ç½‘ ä»‹ç»è·å–ã€‚</strong></p>
</li>
<li><p>[ ] åˆ†å¸ƒå¼äº‹åŠ¡ ï¼šæœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡</p>
</li>
<li>[ ] åˆ†å¸ƒå¼äº‹åŠ¡ ï¼šTCCå‹äº‹åŠ¡(TBD)</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/strong
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>MyCAT æºç åˆ†æ  â€”â€” XAåˆ†å¸ƒå¼äº‹åŠ¡</title>
    <link href="http://www.yunai.me/MyCAT/xa-distributed-transaction/"/>
    <id>http://www.yunai.me/MyCAT/xa-distributed-transaction/</id>
    <published>2017-07-14T16:00:00.000Z</published>
    <updated>2017-07-31T12:30:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. XA æ¦‚å¿µ</a></li>
<li><a href="#">3. MyCAT ä»£ç å®ç°</a><ul>
<li><a href="#">3.1 JDBC Demo ä»£ç </a></li>
<li><a href="#">3.2 MyCAT å¼€å¯ XA äº‹åŠ¡</a></li>
<li><a href="#">3.3 MyCAT æ¥æ”¶ SQL</a></li>
<li><a href="#">3.4 MySQL æ¥æ”¶ COMMIT</a><ul>
<li><a href="#">3.4.1 å•èŠ‚ç‚¹äº‹åŠ¡ or å¤šèŠ‚ç‚¹äº‹åŠ¡</a></li>
<li><a href="#">3.4.2 åè°ƒæ—¥å¿—</a></li>
<li><a href="#">3.4.3 MultiNodeCoordinator</a></li>
</ul>
</li>
<li><a href="#">3.5 MyCAT å¯åŠ¨å›æ»š XAäº‹åŠ¡</a></li>
</ul>
</li>
<li><a href="#">4. MyCAT å®ç°ç¼ºé™·</a><ul>
<li><a href="#">4.1 åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½</a></li>
<li><a href="#">4.2 æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨ PREPARE å°±è¿›è¡Œ COMMIT</a></li>
<li><a href="#">4.3 MyCAT å¯åŠ¨å›æ»š PREPARE çš„ XAäº‹åŠ¡</a></li>
<li><a href="#">4.4 å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—</a></li>
<li><a href="#">4.5 XA COMMIT éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†</a></li>
</ul>
</li>
<li><a href="#">5. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æ•°æ®åº“æ‹†åˆ†åï¼Œä¸šåŠ¡ä¸Šä¼šç¢°åˆ°éœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡çš„åœºæ™¯ã€‚MyCAT åŸºäº XA å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚å›½å†…ç›®å‰å¦å¤–ä¸€æ¬¾å¾ˆç«çš„æ•°æ®åº“ä¸­é—´ä»¶ Sharding-JDBC å‡†å¤‡åŸºäº TCC å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚</p>
<p>æœ¬æ–‡å†…å®¹åˆ†æˆä¸‰éƒ¨åˆ†ï¼š</p>
<ol>
<li>XA æ¦‚å¿µç®€è¿°</li>
<li>MyCAT ä»£ç å¦‚ä½•å®ç° XA</li>
<li>MyCAT åœ¨å®ç° XA å­˜åœ¨çš„ä¸€äº›ç¼ºé™·</li>
</ol>
<h1 id="2-XA-æ¦‚å¿µ"><a href="#2-XA-æ¦‚å¿µ" class="headerlink" title="2. XA æ¦‚å¿µ"></a>2. XA æ¦‚å¿µ</h1><p>&gt;<br>X/Open ç»„ç»‡ï¼ˆå³ç°åœ¨çš„ Open Group ï¼‰å®šä¹‰äº†åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†æ¨¡å‹ã€‚ X/Open DTP æ¨¡å‹ï¼ˆ 1994 ï¼‰åŒ…æ‹¬ï¼š  </p>
<ol>
<li>åº”ç”¨ç¨‹åºï¼ˆ <strong>AP</strong> ï¼‰  </li>
<li>äº‹åŠ¡ç®¡ç†å™¨ï¼ˆ <strong>TM</strong> ï¼‰  </li>
<li>èµ„æºç®¡ç†å™¨ï¼ˆ <strong>RM</strong> ï¼‰  </li>
<li>é€šä¿¡èµ„æºç®¡ç†å™¨ï¼ˆ <strong>CRM</strong> ï¼‰<br>ä¸€èˆ¬ï¼Œå¸¸è§çš„äº‹åŠ¡ç®¡ç†å™¨ï¼ˆ TM ï¼‰æ˜¯äº¤æ˜“ä¸­é—´ä»¶ï¼Œå¸¸è§çš„èµ„æºç®¡ç†å™¨ï¼ˆ <strong>RM</strong> ï¼‰æ˜¯æ•°æ®åº“ï¼Œå¸¸è§çš„é€šä¿¡èµ„æºç®¡ç†å™¨ï¼ˆ <strong>CRM</strong> ï¼‰æ˜¯æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œä¸‹å›¾æ˜¯X/Open DTPæ¨¡å‹ï¼š</li>
</ol>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_15/01.png" alt=""></p>
<blockquote>
<p>ä¸€èˆ¬çš„ç¼–ç¨‹æ–¹å¼æ˜¯è¿™æ ·çš„ï¼š  </p>
<ol>
<li>é…ç½® <strong>TM</strong> ï¼Œé€šè¿‡ <strong>TM</strong> æˆ–è€… <strong>RM</strong> æä¾›çš„æ–¹å¼ï¼ŒæŠŠ <strong>RM</strong> æ³¨å†Œåˆ° <strong>TM</strong>ã€‚å¯ä»¥ç†è§£ä¸ºç»™ <strong>TM</strong> æ³¨å†Œ <strong>RM</strong> ä½œä¸ºæ•°æ®æºã€‚ä¸€ä¸ª <strong>TM</strong> å¯ä»¥æ³¨å†Œå¤šä¸ª <strong>RM</strong>ã€‚  </li>
<li><strong>AP</strong> ä» <strong>TM</strong> è·å–èµ„æºç®¡ç†å™¨çš„ä»£ç†ï¼ˆä¾‹å¦‚ï¼šä½¿ç”¨JTAæ¥å£ï¼Œä»TMç®¡ç†çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè·å–å‡ºè¿™ä¸ªTMæ‰€ç®¡ç†çš„RMçš„JDBCè¿æ¥æˆ–JMSè¿æ¥ï¼‰<br><strong>AP</strong> å‘ <strong>TM</strong> å‘èµ·ä¸€ä¸ªå…¨å±€äº‹åŠ¡ã€‚è¿™æ—¶ï¼Œ<strong>TM</strong> ä¼šé€šçŸ¥å„ä¸ª <strong>RM</strong>ã€‚<strong>XID</strong>ï¼ˆå…¨å±€äº‹åŠ¡IDï¼‰ä¼šé€šçŸ¥åˆ°å„ä¸ªRMã€‚  </li>
<li><strong>AP</strong> é€šè¿‡ <strong>TM</strong> ä¸­è·å–çš„è¿æ¥ï¼Œ<strong>é—´æ¥</strong>æ“ä½œ <strong>RM</strong> è¿›è¡Œä¸šåŠ¡æ“ä½œã€‚è¿™æ—¶ï¼Œ<strong>TM</strong> åœ¨æ¯æ¬¡ <strong>AP</strong> æ“ä½œæ—¶æŠŠ <strong>XID</strong>(åŒ…æ‹¬æ‰€å±åˆ†æ”¯çš„ä¿¡æ¯)ä¼ é€’ç»™ <strong>RM</strong>ï¼Œ<strong>RM</strong> æ­£æ˜¯é€šè¿‡è¿™ä¸ª <strong>XID</strong> å…³è”æ¥æ“ä½œå’Œäº‹åŠ¡çš„å…³ç³»çš„ã€‚  </li>
<li><strong>AP</strong> ç»“æŸå…¨å±€äº‹åŠ¡æ—¶ï¼Œ<strong>TM</strong> ä¼šé€šçŸ¥ <strong>RM</strong> å…¨å±€äº‹åŠ¡ç»“æŸã€‚å¼€å§‹äºŒæ®µæäº¤ï¼Œä¹Ÿå°±æ˜¯prepare - commitçš„è¿‡ç¨‹ã€‚</li>
</ol>
</blockquote>
<hr>
<blockquote>
<p>XAåè®®æŒ‡çš„æ˜¯TMï¼ˆäº‹åŠ¡ç®¡ç†å™¨ï¼‰å’ŒRMï¼ˆèµ„æºç®¡ç†å™¨ï¼‰ä¹‹é—´çš„æ¥å£ã€‚ç›®å‰ä¸»æµçš„å…³ç³»å‹æ•°æ®åº“äº§å“éƒ½æ˜¯å®ç°äº†XAæ¥å£çš„ã€‚JTA(Java Transaction API)æ˜¯ç¬¦åˆX/Open DTPæ¨¡å‹çš„ï¼Œäº‹åŠ¡ç®¡ç†å™¨å’Œèµ„æºç®¡ç†å™¨ä¹‹é—´ä¹Ÿä½¿ç”¨äº†XAåè®®ã€‚ æœ¬è´¨ä¸Šä¹Ÿæ˜¯å€ŸåŠ©ä¸¤é˜¶æ®µæäº¤åè®®æ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡çš„ï¼Œä¸‹é¢åˆ†åˆ«æ¥çœ‹çœ‹XAäº‹åŠ¡æˆåŠŸå’Œå¤±è´¥çš„æ¨¡å‹å›¾ï¼š</p>
</blockquote>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_15/02.png" alt="æˆåŠŸ"></p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_15/03.png" alt="å¤±è´¥"></p>
<hr>
<p>ğŸ˜ˆ çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯æœ‰ç§é»‘äººé—®å·çš„æ„Ÿè§‰ï¼Ÿæ·¡å®šï¼æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ MyCAT ä»£ç å±‚é¢æ˜¯å¦‚ä½•å®ç° XA çš„ã€‚å¦å¤–ï¼Œæœ‰å…´è¶£å¯¹æ¦‚å¿µäº†è§£æ›´å¤šçš„ï¼Œå¯ä»¥å‚çœ‹å¦‚ä¸‹æ–‡ç« ï¼š</p>
<ol>
<li><a href="http://www.infoq.com/cn/articles/xa-transactions-handle" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠXAäº‹åŠ¡å¤„ç†ã€‹</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/xa-statements.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠXA Transaction SQL Syntaxã€‹</a></li>
<li><a href="http://www.voidcn.com/blog/gao1738/article/p-4554083.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMySQL XA äº‹åŠ¡æ”¯æŒè°ƒç ”ã€‹</a></li>
</ol>
<h1 id="3-MyCAT-ä»£ç å®ç°"><a href="#3-MyCAT-ä»£ç å®ç°" class="headerlink" title="3. MyCAT ä»£ç å®ç°"></a>3. MyCAT ä»£ç å®ç°</h1><ul>
<li>MyCAT ï¼šTMï¼Œåè°ƒè€…ã€‚</li>
<li>æ•°æ®èŠ‚ç‚¹ ï¼šRMï¼Œå‚ä¸è€…ã€‚</li>
</ul>
<h2 id="3-1-JDBC-Demo-ä»£ç "><a href="#3-1-JDBC-Demo-ä»£ç " class="headerlink" title="3.1 JDBC Demo ä»£ç "></a>3.1 JDBC Demo ä»£ç </h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCATXAClientDemo</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException </span>&#123;</div><div class="line">        <span class="comment">// 1. è·å¾—æ•°æ®åº“è¿æ¥</span></div><div class="line">        Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</div><div class="line">        Connection conn = DriverManager.getConnection(<span class="string">"jdbc:mysql://127.0.0.1:8066/dbtest"</span>, <span class="string">"root"</span>, <span class="string">"123456"</span>);</div><div class="line">        conn.setAutoCommit(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 2. å¼€å¯ MyCAT XA äº‹åŠ¡</span></div><div class="line">        conn.prepareStatement(<span class="string">"set xa=on"</span>).execute();</div><div class="line"></div><div class="line">        <span class="comment">// 3. æ’å…¥ SQL</span></div><div class="line">        <span class="comment">// 3.1 SQL1 Aåº“</span></div><div class="line">        <span class="keyword">long</span> uid = Math.abs(<span class="keyword">new</span> Random().nextLong());</div><div class="line">        String username = UUID.randomUUID().toString();</div><div class="line">        String password = UUID.randomUUID().toString();</div><div class="line">        String sql1 = String.format(<span class="string">"insert into t_user(id, username, password) VALUES (%d, '%s', '%s')"</span>,</div><div class="line">                uid, username, password);</div><div class="line">        conn.prepareStatement(sql1).execute();</div><div class="line">        <span class="comment">// 3.2 SQL2 Båº“</span></div><div class="line">        <span class="keyword">long</span> orderId = Math.abs(<span class="keyword">new</span> Random().nextLong());</div><div class="line">        String nickname = UUID.randomUUID().toString();</div><div class="line">        String sql2 = String.format(<span class="string">"insert into t_order(id, uid, nickname) VALUES(%d, %s, '%s')"</span>, orderId, uid, nickname);</div><div class="line">        conn.prepareStatement(sql2).execute();</div><div class="line"></div><div class="line">        <span class="comment">// 4. æäº¤ XA äº‹åŠ¡</span></div><div class="line">        conn.commit();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>set xa=on</code> MyCAT å¼€å¯ XA äº‹åŠ¡ã€‚</li>
<li><code>conn.commit</code> æäº¤ XA äº‹åŠ¡ã€‚ </li>
</ul>
<h2 id="3-2-MyCAT-å¼€å¯-XA-äº‹åŠ¡"><a href="#3-2-MyCAT-å¼€å¯-XA-äº‹åŠ¡" class="headerlink" title="3.2 MyCAT å¼€å¯ XA äº‹åŠ¡"></a>3.2 MyCAT å¼€å¯ XA äº‹åŠ¡</h2><p>å½“ MyCAT æ¥æ”¶åˆ° <code>set xa = on</code> å‘½ä»¤æ—¶ï¼Œå¼€å¯ XA äº‹åŠ¡ï¼Œå¹¶ç”Ÿæˆ XA äº‹åŠ¡ç¼–å·ã€‚XA äº‹åŠ¡ç¼–å·ç”Ÿæˆç®—æ³•ä¸º UUIDã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SetHandler.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String stmt, ServerConnection c, <span class="keyword">int</span> offset)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> rs = ServerParseSet.parse(stmt, offset);</div><div class="line">		<span class="keyword">switch</span> (rs &amp; <span class="number">0xff</span>) &#123;</div><div class="line">		<span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line">		<span class="keyword">case</span> XA_FLAG_ON: &#123;</div><div class="line">			<span class="keyword">if</span> (c.isAutocommit()) &#123;</div><div class="line">				c.writeErrMessage(ErrorCode.ERR_WRONG_USED, <span class="string">"set xa cmd on can't used in autocommit connection "</span>);</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			c.getSession2().setXATXEnabled(<span class="keyword">true</span>);</div><div class="line">			c.write(c.writeToBuffer(OkPacket.OK, c.allocate()));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">case</span> XA_FLAG_OFF: &#123;</div><div class="line">			c.writeErrMessage(ErrorCode.ERR_WRONG_USED,</div><div class="line">					<span class="string">"set xa cmd off not for external use "</span>);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// NonBlockingSession.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setXATXEnabled</span><span class="params">(<span class="keyword">boolean</span> xaTXEnabled)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (xaTXEnabled) &#123;</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.xaTXID == <span class="keyword">null</span>) &#123;</div><div class="line">           xaTXID = genXATXID(); <span class="comment">// ğŸ˜ˆğŸ˜ˆğŸ˜ˆè·å¾— XA äº‹åŠ¡ç¼–å·</span></div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">this</span>.xaTXID = <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">genXATXID</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> MycatServer.getInstance().getXATXIDGLOBAL();</div><div class="line">&#125;</div><div class="line"><span class="comment">// MycatServer.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getXATXIDGLOBAL</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="string">"'"</span> + getUUID() + <span class="string">"'"</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUUID</span><span class="params">()</span> </span>&#123; <span class="comment">// ğŸ˜ˆğŸ˜ˆğŸ˜ˆ</span></div><div class="line">   String s = UUID.randomUUID().toString();</div><div class="line">   <span class="keyword">return</span> s.substring(<span class="number">0</span>, <span class="number">8</span>) + s.substring(<span class="number">9</span>, <span class="number">13</span>) + s.substring(<span class="number">14</span>, <span class="number">18</span>) + s.substring(<span class="number">19</span>, <span class="number">23</span>) + s.substring(<span class="number">24</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-3-MyCAT-æ¥æ”¶-SQL"><a href="#3-3-MyCAT-æ¥æ”¶-SQL" class="headerlink" title="3.3 MyCAT æ¥æ”¶ SQL"></a>3.3 MyCAT æ¥æ”¶ SQL</h2><p>æ­¤å¤„ SQL æŒ‡çš„æ˜¯ <code>insert</code>ã€<code>update</code>ã€<code>delete</code> æ“ä½œã€‚</p>
<p>å½“å‘æŸä¸ªæ•°æ®èŠ‚ç‚¹<strong>ç¬¬ä¸€æ¬¡</strong>å‘èµ· SQL æ—¶ï¼Œä¼šåœ¨ SQL å‰é¢é™„åŠ  <code>XA START &#39;xaTranId&#39;</code>ï¼Œå¹¶è®¾ç½®è¯¥æ•°æ®èŠ‚ç‚¹<strong>è¿æ¥</strong>äº‹åŠ¡çŠ¶æ€ä¸º <code>TxState.TX_STARTED_STATE</code>ï¼ˆ<em>åˆ†å¸ƒå¼äº‹åŠ¡çŠ¶æ€ï¼Œä¸‹æ–‡ä¼šä¸“é—¨æ•´ç†</em>ï¼‰ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MySQLConnection.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">synAndDoExecute</span><span class="params">(String xaTxID, RouteResultsetNode rrn,</span></span></div><div class="line">                                 <span class="keyword">int</span> clientCharSetIndex, <span class="keyword">int</span> clientTxIsoLation,</div><div class="line">                                 <span class="keyword">boolean</span> clientAutoCommit) &#123;</div><div class="line">   String xaCmd = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">boolean</span> conAutoComit = <span class="keyword">this</span>.autocommit;</div><div class="line">   String conSchema = <span class="keyword">this</span>.schema;</div><div class="line">   <span class="comment">// never executed modify sql,so auto commit</span></div><div class="line">   <span class="keyword">boolean</span> expectAutocommit = !modifiedSQLExecuted || isFromSlaveDB() || clientAutoCommit;</div><div class="line">   <span class="keyword">if</span> (expectAutocommit == <span class="keyword">false</span> &amp;&amp; xaTxID != <span class="keyword">null</span> &amp;&amp; xaStatus == TxState.TX_INITIALIZE_STATE) &#123; <span class="comment">// ğŸ˜ˆğŸ˜ˆğŸ˜ˆ</span></div><div class="line">       xaCmd = <span class="string">"XA START "</span> + xaTxID + <span class="string">';'</span>;</div><div class="line">       <span class="keyword">this</span>.xaStatus = TxState.TX_STARTED_STATE;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">   <span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line">   <span class="keyword">if</span> (xaCmd != <span class="keyword">null</span>) &#123;</div><div class="line">       sb.append(xaCmd);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// and our query sql to multi command at last</span></div><div class="line">   sb.append(rrn.getStatement() + <span class="string">";"</span>);</div><div class="line">   <span class="comment">// syn and execute others</span></div><div class="line">   <span class="keyword">this</span>.sendQueryCmd(sb.toString());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸¾ä¸ª å˜é‡<code>sb</code> çš„ä¾‹å­ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SET</span> <span class="keyword">names</span> utf8;<span class="keyword">SET</span> autocommit=<span class="number">0</span>;XA <span class="keyword">START</span> <span class="string">'1f2da7353e8846e5833b8d8dd041cfb1'</span>,<span class="string">'db2'</span>;<span class="keyword">insert</span> <span class="keyword">into</span> t_user(<span class="keyword">id</span>, username, <span class="keyword">password</span>) <span class="keyword">VALUES</span> (<span class="number">3400</span>, <span class="string">'b7c5ec1f-11cc-4599-851c-06ad617fec42'</span>, <span class="string">'d2694679-f6a2-4623-a339-48d4a868be90'</span>);</div></pre></td></tr></table></figure>
<h2 id="3-4-MySQL-æ¥æ”¶-COMMIT"><a href="#3-4-MySQL-æ¥æ”¶-COMMIT" class="headerlink" title="3.4 MySQL æ¥æ”¶ COMMIT"></a>3.4 MySQL æ¥æ”¶ COMMIT</h2><h3 id="3-4-1-å•èŠ‚ç‚¹äº‹åŠ¡-or-å¤šèŠ‚ç‚¹äº‹åŠ¡"><a href="#3-4-1-å•èŠ‚ç‚¹äº‹åŠ¡-or-å¤šèŠ‚ç‚¹äº‹åŠ¡" class="headerlink" title="3.4.1 å•èŠ‚ç‚¹äº‹åŠ¡ or å¤šèŠ‚ç‚¹äº‹åŠ¡"></a>3.4.1 å•èŠ‚ç‚¹äº‹åŠ¡ or å¤šèŠ‚ç‚¹äº‹åŠ¡</h3><p><code>COMMIT</code> æ‰§è¡Œæ—¶ï¼ŒMyCAT ä¼šåˆ¤æ–­ XA äº‹åŠ¡é‡Œï¼Œæ¶‰åŠåˆ°çš„æ•°æ®åº“èŠ‚ç‚¹æ•°é‡ã€‚</p>
<ul>
<li>å¦‚æœèŠ‚ç‚¹æ•°é‡ä¸º 1ï¼Œå•èŠ‚ç‚¹äº‹åŠ¡ï¼Œä½¿ç”¨ <code>CommitNodeHandler</code> å¤„ç†ã€‚</li>
<li>å¦‚æœèŠ‚ç‚¹æ•°é‡ &gt; 1ï¼Œå¤šèŠ‚ç‚¹äº‹åŠ¡ï¼Œä½¿ç”¨ <code>MultiNodeCoordinator</code> å¤„ç†ã€‚</li>
</ul>
<p><code>CommitNodeHandler</code> ç›¸æ¯” <code>MultiNodeCoordinator</code> æ¥è¯´ï¼Œåªæœ‰ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ï¼Œä¸éœ€è¦è¿›è¡Œå¤šèŠ‚ç‚¹åè°ƒï¼Œé€»è¾‘ä¼šç›¸å¯¹ç®€å•ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å¦å¤–çœ‹ã€‚æˆ‘ä»¬ä¸»è¦åˆ†æ <code>MultiNodeCoordinator</code>ã€‚</p>
<h3 id="3-4-2-åè°ƒæ—¥å¿—"><a href="#3-4-2-åè°ƒæ—¥å¿—" class="headerlink" title="3.4.2 åè°ƒæ—¥å¿—"></a>3.4.2 åè°ƒæ—¥å¿—</h3><p><strong>åè°ƒæ—¥å¿—</strong>ï¼Œè®°å½•åè°ƒè¿‡ç¨‹ä¸­å„æ•°æ®èŠ‚ç‚¹ XA äº‹åŠ¡çŠ¶æ€ï¼Œå¤„ç†<strong>MyCATå¼‚å¸¸å¥”æºƒ</strong>æˆ–è€…<strong>æ•°æ®èŠ‚ç‚¹éƒ¨åˆ†XA COMMITï¼Œå¦å¤–éƒ¨åˆ† XA PREPARE</strong>ä¸‹çš„çŠ¶æ€æ¢å¤ã€‚</p>
<p><strong>XA äº‹åŠ¡å…±æœ‰ç§</strong>ï¼š</p>
<ol>
<li>TX_INITIALIZE_STATE ï¼šäº‹åŠ¡åˆå§‹åŒ–</li>
<li>TX_STARTED_STATE ï¼šäº‹åŠ¡å¼€å§‹å®Œæˆ</li>
<li>TX_PREPARED_STATE ï¼šäº‹åŠ¡å‡†å¤‡å®Œæˆ</li>
<li>TX_COMMITED_STATE ï¼šäº‹åŠ¡æäº¤å®Œæˆ</li>
<li>TX_ROLLBACKED_STATE ï¼šäº‹åŠ¡å›æ»šå®Œæˆ</li>
</ol>
<p><strong>çŠ¶æ€å˜æ›´æµ</strong> ï¼šTX_INITIALIZE_STATE =&gt; TX_STARTED_STATE =&gt; TX_PREPARED_STATE =&gt; TX_COMMITED_STATE / TX_ROLLBACKED_STATE ã€‚</p>
<p><strong>åè°ƒæ—¥å¿—åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†</strong>ï¼š</p>
<ol>
<li>CoordinatorLogEntry ï¼šåè°ƒè€…æ—¥å¿—</li>
<li>ParticipantLogEntry ï¼šå‚ä¸è€…æ—¥å¿—ã€‚<strong>æ­¤å¤„ï¼Œæ•°æ®èŠ‚ç‚¹æ‰®æ¼”å‚ä¸è€…çš„è§’è‰²ã€‚ä¸‹æ–‡ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°å‚ä¸è€…ä¸æ•°æ®èŠ‚ç‚¹æ··ç”¨çš„æƒ…å†µï¼Œæœ›è§è°…ã€‚</strong></li>
</ol>
<p><em>ä¸€æ¬¡ XA äº‹åŠ¡ï¼Œå¯¹åº”ä¸€æ¡ <code>CoordinatorLogEntry</code>ã€‚ä¸€æ¡<code>CoordinatorLogEntry</code> åŒ…å« Næ¡<code>ParticipantLogEntry</code></em>ã€‚ æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CoordinatorLogEntry ï¼šåè°ƒè€…æ—¥å¿—</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CoordinatorLogEntry</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * XA äº‹åŠ¡ç¼–å·</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String id;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å‚ä¸è€…æ—¥å¿—æ•°ç»„</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ParticipantLogEntry[] participants;</div><div class="line">&#125;</div><div class="line"><span class="comment">// ParticipantLogEntry ï¼šå‚ä¸è€…æ—¥å¿—</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParticipantLogEntry</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * XA äº‹åŠ¡ç¼–å·</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> String coordinatorId;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•°æ®åº“ uri</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> String uri;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¿‡æœŸæè¿°</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">long</span> expires;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * XA äº‹åŠ¡çŠ¶æ€</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> txState;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å‚ä¸è€…åå­—</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> String resourceName;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>MyCAT è®°å½•åè°ƒæ—¥å¿—ä»¥ JSONæ ¼å¼ åˆ°æ–‡ä»¶</strong>ã€‚<strong>æ¯è¡Œ</strong>åŒ…å«ä¸€æ¡<code>CoordinatorLogEntry</code>ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;<span class="attr">"id"</span>:<span class="string">"'e827b3fe666c4d968961350d19adda31'"</span>,<span class="attr">"participants"</span>:[&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db3"</span>&#125;,&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db1"</span>&#125;]&#125;</div><div class="line">&#123;<span class="attr">"id"</span>:<span class="string">"'f00b61fa17cb4ec5b8264a6d82f847d0'"</span>,<span class="attr">"participants"</span>:[&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db2"</span>&#125;,&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db1"</span>&#125;]&#125;</div></pre></td></tr></table></figure>
<p>å®ç°ç±»ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// XA åè°ƒè€…æ—¥å¿— å­˜å‚¨æ¥å£ï¼šhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/Repository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Repository</span> </span>&#123;&#125;</div><div class="line"><span class="comment">// XA åè°ƒè€…æ—¥å¿— æ–‡ä»¶å­˜å‚¨ï¼šhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/impl/FileSystemRepository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileSystemRepository</span> <span class="keyword">implements</span> <span class="title">Repository</span> </span>&#123;&#125;</div><div class="line"><span class="comment">// XA åè°ƒè€…æ—¥å¿— æ–‡ä»¶å­˜å‚¨ï¼šhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/impl/InMemoryRepository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InMemoryRepository</span> <span class="keyword">implements</span> <span class="title">Repository</span> </span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>ç›®å‰æ—¥å¿—æ–‡ä»¶å†™å…¥çš„æ–¹å¼æ€§èƒ½è¾ƒå·®ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸åšåˆ†æï¼Œåœ¨ã€4. MyCAT å®ç°ç¼ºé™·ã€‘é‡Œä¸€èµ·è®²ã€‚</p>
<h3 id="3-4-3-MultiNodeCoordinator"><a href="#3-4-3-MultiNodeCoordinator" class="headerlink" title="3.4.3 MultiNodeCoordinator"></a>3.4.3 MultiNodeCoordinator</h3><p>æ•²æ•²æ•²ï¼Œè¿™é‡Œæ˜¯æœ¬æ–‡çš„é‡ç‚¹ä¹‹ä¸€å™¢ã€‚ğŸ˜ˆ</p>
<p><strong>ç¬¬ä¸€é˜¶æ®µï¼šå‘èµ· PREPAREã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeBatchNodeCmd</span><span class="params">(SQLCtrlCommand cmdHandler)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.cmdHandler = cmdHandler;</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> initCount = session.getTargetCount();</div><div class="line">   runningCount.set(initCount);</div><div class="line">   nodeCount = initCount;</div><div class="line">   failed.set(<span class="keyword">false</span>);</div><div class="line">   faileCount.set(<span class="number">0</span>);</div><div class="line">   <span class="comment">//recovery nodes log</span></div><div class="line">   ParticipantLogEntry[] participantLogEntry = <span class="keyword">new</span> ParticipantLogEntry[initCount];</div><div class="line">   <span class="comment">// æ‰§è¡Œ</span></div><div class="line">   <span class="keyword">int</span> started = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (RouteResultsetNode rrn : session.getTargetKeys()) &#123;</div><div class="line">       <span class="keyword">if</span> (rrn == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">final</span> BackendConnection conn = session.getTarget(rrn);</div><div class="line">       <span class="keyword">if</span> (conn != <span class="keyword">null</span>) &#123;</div><div class="line">           conn.setResponseHandler(<span class="keyword">this</span>);</div><div class="line">           <span class="comment">//process the XA_END XA_PREPARE Command</span></div><div class="line">           MySQLConnection mysqlCon = (MySQLConnection) conn;</div><div class="line">           String xaTxId = <span class="keyword">null</span>;</div><div class="line">           <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) &#123;</div><div class="line">               xaTxId = session.getXaTXID() + <span class="string">",'"</span> + mysqlCon.getSchema() + <span class="string">"'"</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (mysqlCon.getXaStatus() == TxState.TX_STARTED_STATE) &#123; <span class="comment">// XA äº‹åŠ¡</span></div><div class="line">               <span class="comment">//recovery Log</span></div><div class="line">               participantLogEntry[started] = <span class="keyword">new</span> ParticipantLogEntry(xaTxId, conn.getHost(), <span class="number">0</span>, conn.getSchema(), ((MySQLConnection) conn).getXaStatus());</div><div class="line">               String[] cmds = <span class="keyword">new</span> String[]&#123;<span class="string">"XA END "</span> + xaTxId, <span class="comment">// XA END å‘½ä»¤</span></div><div class="line">                       <span class="string">"XA PREPARE "</span> + xaTxId&#125;; <span class="comment">// XA PREPARE å‘½ä»¤</span></div><div class="line">               mysqlCon.execBatchCmd(cmds);</div><div class="line">           &#125; <span class="keyword">else</span> &#123; <span class="comment">// é XA äº‹åŠ¡</span></div><div class="line">               <span class="comment">// recovery Log</span></div><div class="line">               participantLogEntry[started] = <span class="keyword">new</span> ParticipantLogEntry(xaTxId, conn.getHost(), <span class="number">0</span>, conn.getSchema(), ((MySQLConnection) conn).getXaStatus());</div><div class="line">               cmdHandler.sendCommand(session, conn);</div><div class="line">           &#125;</div><div class="line">           ++started;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// xa recovery log</span></div><div class="line">   <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) &#123;</div><div class="line">       CoordinatorLogEntry coordinatorLogEntry = <span class="keyword">new</span> CoordinatorLogEntry(session.getXaTXID(), <span class="keyword">false</span>, participantLogEntry);</div><div class="line">       inMemoryRepository.put(session.getXaTXID(), coordinatorLogEntry);</div><div class="line">       fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (started &lt; nodeCount) &#123; <span class="comment">// TODO ç–‘é—®ï¼šå¦‚ä½•è§¦å‘</span></div><div class="line">       runningCount.set(started);</div><div class="line">       LOGGER.warn(<span class="string">"some connection failed to execute "</span> + (nodeCount - started));</div><div class="line">       <span class="comment">/**</span></div><div class="line">        * assumption: only caused by front-end connection close. &lt;br/&gt;</div><div class="line">        * Otherwise, packet must be returned to front-end</div><div class="line">        */</div><div class="line">       failed.set(<span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å‘å„æ•°æ®èŠ‚ç‚¹å‘é€ <code>XA END</code> + <code>XA PREPARE</code> æŒ‡ä»¤ã€‚ä¸¾ä¸ª å˜é‡<code>cmds</code> ä¾‹å­ï¼š</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">XA <span class="keyword">END</span> <span class="string">'4cbb18214d0b47adbdb0658598666677'</span>,<span class="string">'db3'</span>;XA <span class="keyword">PREPARE</span> <span class="string">'4cbb18214d0b47adbdb0658598666677'</span>,<span class="string">'db3'</span>;</div></pre></td></tr></table></figure>
<ul>
<li>è®°å½•åè°ƒæ—¥å¿—ã€‚æ¯æ¡å‚ä¸è€…æ—¥å¿—çŠ¶æ€ä¸º <code>TxState.TX_STARTED_STATE</code>ã€‚</li>
</ul>
<hr>
<p><strong>ç¬¬äºŒé˜¶æ®µï¼šå‘èµ· COMMITã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">okResponse</span><span class="params">(<span class="keyword">byte</span>[] ok, BackendConnection conn)</span> </span>&#123;</div><div class="line">   <span class="comment">// process the XA Transatcion 2pc commit</span></div><div class="line">   <span class="keyword">if</span> (conn <span class="keyword">instanceof</span> MySQLConnection) &#123;</div><div class="line">       MySQLConnection mysqlCon = (MySQLConnection) conn;</div><div class="line">       <span class="keyword">switch</span> (mysqlCon.getXaStatus()) &#123;</div><div class="line">           <span class="keyword">case</span> TxState.TX_STARTED_STATE:</div><div class="line">               <span class="comment">//if there have many SQL execute wait the okResponse,will come to here one by one</span></div><div class="line">               <span class="comment">//should be wait all nodes ready ,then send xa commit to all nodes.</span></div><div class="line">               <span class="keyword">if</span> (mysqlCon.batchCmdFinished()) &#123;</div><div class="line">                   String xaTxId = session.getXaTXID();</div><div class="line">                   String cmd = <span class="string">"XA COMMIT "</span> + xaTxId + <span class="string">",'"</span> + mysqlCon.getSchema() + <span class="string">"'"</span>;</div><div class="line">                   <span class="keyword">if</span> (LOGGER.isDebugEnabled()) &#123;</div><div class="line">                       LOGGER.debug(<span class="string">"Start execute the cmd :"</span> + cmd + <span class="string">",current host:"</span> + mysqlCon.getHost() + <span class="string">":"</span> + mysqlCon.getPort());</div><div class="line">                   &#125;</div><div class="line">                   <span class="comment">// recovery log</span></div><div class="line">                   CoordinatorLogEntry coordinatorLogEntry = inMemoryRepository.get(xaTxId);</div><div class="line">                   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntry.participants.length; i++) &#123;</div><div class="line">                       LOGGER.debug(<span class="string">"[In Memory CoordinatorLogEntry]"</span> + coordinatorLogEntry.participants[i]);</div><div class="line">                       <span class="keyword">if</span> (coordinatorLogEntry.participants[i].resourceName.equals(conn.getSchema())) &#123;</div><div class="line">                           coordinatorLogEntry.participants[i].txState = TxState.TX_PREPARED_STATE;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">                   inMemoryRepository.put(xaTxId, coordinatorLogEntry);</div><div class="line">                   fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">                   <span class="comment">// send commit</span></div><div class="line">                   mysqlCon.setXaStatus(TxState.TX_PREPARED_STATE);</div><div class="line">                   mysqlCon.execCmd(cmd);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           <span class="keyword">case</span> TxState.TX_PREPARED_STATE: &#123;</div><div class="line">               <span class="comment">// recovery log</span></div><div class="line">               String xaTxId = session.getXaTXID();</div><div class="line">               CoordinatorLogEntry coordinatorLogEntry = inMemoryRepository.get(xaTxId);</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntry.participants.length; i++) &#123;</div><div class="line">                   <span class="keyword">if</span> (coordinatorLogEntry.participants[i].resourceName.equals(conn.getSchema())) &#123;</div><div class="line">                       coordinatorLogEntry.participants[i].txState = TxState.TX_COMMITED_STATE;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">               inMemoryRepository.put(xaTxId, coordinatorLogEntry);</div><div class="line">               fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">               <span class="comment">// XA reset status now</span></div><div class="line">               mysqlCon.setXaStatus(TxState.TX_INITIALIZE_STATE);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">default</span>:</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// é‡Šæ”¾è¿æ¥</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.cmdHandler.relaseConOnOK()) &#123;</div><div class="line">       session.releaseConnection(conn);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       session.releaseConnectionIfSafe(conn, LOGGER.isDebugEnabled(), <span class="keyword">false</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ˜¯å¦æ‰€æœ‰èŠ‚ç‚¹éƒ½å®Œæˆcommitï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å›Client æˆåŠŸ</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.finished()) &#123;</div><div class="line">       cmdHandler.okResponse(session, ok);</div><div class="line">       <span class="keyword">if</span> (cmdHandler.isAutoClearSessionCons()) &#123;</div><div class="line">           session.clearResources(<span class="keyword">false</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">/* 1.  äº‹åŠ¡æäº¤å,xa äº‹åŠ¡ç»“æŸ   */</span></div><div class="line">       <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) &#123;</div><div class="line">           session.setXATXEnabled(<span class="keyword">false</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">/* 2. preAcStates ä¸ºtrue,äº‹åŠ¡ç»“æŸå,éœ€è¦è®¾ç½®ä¸ºtrueã€‚preAcStates ä¸ºacä¸Šä¸€ä¸ªçŠ¶æ€    */</span></div><div class="line">       <span class="keyword">if</span> (session.getSource().isPreAcStates()) &#123;</div><div class="line">           session.getSource().setAutocommit(<span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>mysqlCon.batchCmdFinished()</code> æ¯ä¸ªæ•°æ®èŠ‚ç‚¹ï¼Œç¬¬ä¸€æ¬¡è¿”å›çš„æ˜¯ <code>XA END</code> æˆåŠŸï¼Œç¬¬äºŒæ¬¡è¿”å›çš„æ˜¯ <code>XA PREPARE</code>ã€‚åœ¨ <code>XA PREPARE</code> æˆåŠŸåï¼Œè®°å½•è¯¥æ•°æ®èŠ‚ç‚¹çš„<strong>å‚ä¸è€…æ—¥å¿—</strong>çŠ¶æ€ä¸º <code>TxState.TX_PREPARED_STATE</code>ã€‚ä¹‹åï¼Œå‘è¯¥æ•°æ®èŠ‚ç‚¹å‘èµ· <code>XA COMMIT</code> å‘½ä»¤ã€‚</li>
<li><code>XA COMMIT</code> è¿”å›æˆåŠŸåï¼Œè®°å½•è¯¥æ•°æ®èŠ‚ç‚¹çš„<strong>äº‹åŠ¡å‚ä¸è€…æ—¥å¿—</strong>çŠ¶æ€ä¸º <code>TxState.TX_COMMITED_STATE</code>ã€‚</li>
<li>å½“æ‰€æœ‰æ•°æ®èŠ‚ç‚¹ï¼ˆå‚ä¸è€…ï¼‰éƒ½æ‰§è¡Œå®Œæˆ <code>XA COMMIT</code> è¿”å›ï¼Œå³ <code>this.finished() == true</code>ï¼Œè¿”å› MySQL Client XA äº‹åŠ¡æäº¤æˆåŠŸã€‚</li>
</ul>
<p>[x] <code>XA PREPARE</code> å’Œ <code>XA COMMIT</code>ï¼Œæ•°æ®èŠ‚ç‚¹å¯èƒ½è¿”å›å¤±è´¥ï¼Œç›®å‰æš‚æ—¶æ²¡æ¨¡æ‹Ÿå‡ºæ¥ï¼Œå¯¹åº”æ–¹æ³•ä¸º <code>#errorResponse(....)</code>ã€‚ </p>
<h2 id="3-5-MyCAT-å¯åŠ¨å›æ»š-XAäº‹åŠ¡"><a href="#3-5-MyCAT-å¯åŠ¨å›æ»š-XAäº‹åŠ¡" class="headerlink" title="3.5 MyCAT å¯åŠ¨å›æ»š XAäº‹åŠ¡"></a>3.5 MyCAT å¯åŠ¨å›æ»š XAäº‹åŠ¡</h2><p>MyCAT å¯åŠ¨æ—¶ï¼Œä¼š<strong>å›æ»šå¤„äºTxState.TX_PREPARED_STATE</strong>çš„ <code>ParticipantLogEntry</code> å¯¹åº”çš„æ•°æ®èŠ‚ç‚¹çš„ XA äº‹åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MycatServer.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performXARecoveryLog</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// fetch the recovery log</span></div><div class="line">   CoordinatorLogEntry[] coordinatorLogEntries = getCoordinatorLogEntries();</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntries.length; i++) &#123;</div><div class="line">       CoordinatorLogEntry coordinatorLogEntry = coordinatorLogEntries[i];</div><div class="line">       <span class="keyword">boolean</span> needRollback = <span class="keyword">false</span>;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; coordinatorLogEntry.participants.length; j++) &#123;</div><div class="line">           ParticipantLogEntry participantLogEntry = coordinatorLogEntry.participants[j];</div><div class="line">           <span class="keyword">if</span> (participantLogEntry.txState == TxState.TX_PREPARED_STATE) &#123;</div><div class="line">               needRollback = <span class="keyword">true</span>;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (needRollback) &#123;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; coordinatorLogEntry.participants.length; j++) &#123;</div><div class="line">               ParticipantLogEntry participantLogEntry = coordinatorLogEntry.participants[j];</div><div class="line">               <span class="comment">//XA rollback</span></div><div class="line">               String xacmd = <span class="string">"XA ROLLBACK "</span> + coordinatorLogEntry.id + <span class="string">';'</span>;</div><div class="line">               OneRawSQLQueryResultHandler resultHandler = <span class="keyword">new</span> OneRawSQLQueryResultHandler(<span class="keyword">new</span> String[<span class="number">0</span>], <span class="keyword">new</span> XARollbackCallback());</div><div class="line">               outloop:</div><div class="line">               <span class="keyword">for</span> (SchemaConfig schema : MycatServer.getInstance().getConfig().getSchemas().values()) &#123;</div><div class="line">                   <span class="keyword">for</span> (TableConfig table : schema.getTables().values()) &#123;</div><div class="line">                       <span class="keyword">for</span> (String dataNode : table.getDataNodes()) &#123;</div><div class="line">                           PhysicalDBNode dn = MycatServer.getInstance().getConfig().getDataNodes().get(dataNode);</div><div class="line">                           <span class="keyword">if</span> (dn.getDbPool().getSource().getConfig().getIp().equals(participantLogEntry.uri)</div><div class="line">                                   &amp;&amp; dn.getDatabase().equals(participantLogEntry.resourceName)) &#123;</div><div class="line">                               <span class="comment">//XA STATE ROLLBACK</span></div><div class="line">                               participantLogEntry.txState = TxState.TX_ROLLBACKED_STATE;</div><div class="line">                               SQLJob sqlJob = <span class="keyword">new</span> SQLJob(xacmd, dn.getDatabase(), resultHandler, dn.getDbPool().getSource());</div><div class="line">                               sqlJob.run();</div><div class="line">                               <span class="keyword">break</span> outloop;</div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// init into in memory cached</span></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntries.length; i++) &#123;</div><div class="line">  MultiNodeCoordinator.inMemoryRepository.put(coordinatorLogEntries[i].id, coordinatorLogEntries[i]);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// discard the recovery log</span></div><div class="line">    MultiNodeCoordinator.fileRepository.writeCheckpoint(MultiNodeCoordinator.inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="4-MyCAT-å®ç°ç¼ºé™·"><a href="#4-MyCAT-å®ç°ç¼ºé™·" class="headerlink" title="4. MyCAT å®ç°ç¼ºé™·"></a>4. MyCAT å®ç°ç¼ºé™·</h1><p>MyCAT 1.6.5 ç‰ˆæœ¬å®ç°å¼±XAäº‹åŠ¡ï¼Œç›¸å¯¹æ¥è¯´ï¼Œç¬”è€…è®¤ä¸ºè·ç¦»å®é™…ç”Ÿäº§ä½¿ç”¨å­˜åœ¨ä¸€äº›å·®è·ã€‚ä¸‹é¢ç½—åˆ—å¯èƒ½å­˜åœ¨çš„ç¼ºé™·ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œéº»çƒ¦æŒ‡å‡ºã€‚ğŸ™‚å¸Œæœ› MyCAT åœ¨åˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°ä¸Šï¼Œèƒ½å¤Ÿè¶Šæ¥è¶Šç»™åŠ›ã€‚</p>
<h2 id="4-1-åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½"><a href="#4-1-åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½" class="headerlink" title="4.1 åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½"></a>4.1 åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½</h2><p>1ã€<code>CoordinatorLogEntry</code>ã€<code>ParticipantLogEntry</code> åœ¨æ¯æ¬¡å†™å…¥æ–‡ä»¶æ—¶ï¼Œæ˜¯å°†å†…å­˜ä¸­æ‰€æœ‰çš„æ—¥å¿—<strong>å…¨éƒ¨é‡æ–°</strong>å†™å…¥ï¼Œå¯¼è‡´å†™å…¥æ€§èƒ½éšç€ XA äº‹åŠ¡æ¬¡æ•°çš„å¢åŠ ï¼Œæ€§èƒ½ä¼šè¶Šæ¥è¶Šç³Ÿç³•ï¼Œå¯¼è‡´ XA äº‹åŠ¡æ•´ä½“æ€§èƒ½ä¼šéå¸¸å·®ã€‚å¦å¤–ï¼Œè¯¥æ–¹æ³•æ˜¯<strong>åŒæ­¥</strong>çš„ï¼Œä¹ŸåŠ å¤§äº†å†™å…¥çš„å»¶è¿Ÿã€‚</p>
<p>å»ºè®®ï¼šå…ˆè·å¾—å¯å†™å…¥æ–‡ä»¶çš„ OFFSETï¼Œå†™å…¥åè°ƒæ—¥å¿—åˆ°æ–‡ä»¶ï¼Œå†…å­˜ç»´æŠ¤å¥½ XAäº‹åŠ¡ç¼–å· ä¸ OFFSET çš„æ˜ å°„å…³ç³»ï¼Œä»è€Œå®ç°<strong>é¡ºåºå†™å…¥</strong> + <strong>å¹¶è¡Œå†™å…¥</strong>ã€‚</p>
<p>2ã€å†…å­˜é‡Œç»´æŠ¤äº†æ‰€æœ‰çš„åè°ƒæ—¥å¿—ï¼Œå ç”¨å†…å­˜ä¼šè¶Šæ¥è¶Šå¤§ï¼Œå¹¶ä¸”æ— é‡Šæ”¾æœºåˆ¶ã€‚å³ä½¿é‡å¯ï¼Œåè°ƒæ—¥å¿—ä¹Ÿä¼šé‡æ–°åŠ è½½åˆ°å†…å­˜ã€‚</p>
<p>å»ºè®®ï¼šå·²å®Œå…¨å›æ»šæˆ–è€…æäº¤çš„åè°ƒæ—¥å¿—ä¸æ”¾å…¥å†…å­˜ã€‚å¦å¤–æœ‰æ–‡ä»¶å­˜å‚¨å¥½ XAäº‹åŠ¡ç¼–å· ä¸ OFFSET çš„æ˜ å°„å…³ç³»ã€‚</p>
<p>3ã€åè°ƒæ—¥å¿—åªå†™å…¥å•ä¸ªæ–‡ä»¶ã€‚</p>
<p>å»ºè®®ï¼šåˆ†æ‹†åè°ƒæ—¥å¿—æ–‡ä»¶ã€‚</p>
<p>PSï¼šæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹ <code>RocketMQ</code> å¯¹ <code>CommitLog</code> çš„å­˜å‚¨ï¼Œæ€§èƒ½ä¸Šå¾ˆèµï¼</p>
<h2 id="4-2-æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨-PREPARE-å°±è¿›è¡Œ-COMMIT"><a href="#4-2-æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨-PREPARE-å°±è¿›è¡Œ-COMMIT" class="headerlink" title="4.2 æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨ PREPARE å°±è¿›è¡Œ COMMIT"></a>4.2 æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨ PREPARE å°±è¿›è¡Œ COMMIT</h2><p>XA äº‹åŠ¡å®šä¹‰ï¼Œéœ€è¦ç­‰å¾…æ‰€æœ‰å‚ä¸è€…<strong>å…¨éƒ¨</strong> <code>XA PREPARE</code> æˆåŠŸå®Œæˆåå‘èµ· <code>XA COMMIT</code>ã€‚ç›®å‰ MyCAT æ˜¯æŸä¸ªæ•°æ®èŠ‚ç‚¹ <code>XA PREPARE</code> å®Œæˆå<strong>ç«‹å³</strong>è¿›è¡Œ <code>XA COMMIT</code>ã€‚æ¯”å¦‚è¯´ï¼šç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹æäº¤äº† <code>XA END;XA PREPARE</code> æ—¶ï¼Œç¬¬äºŒä¸ªæ•°æ®èŠ‚åœ¨è¿›è¡Œ <code>XA END;XA PREAPRE;</code> å‰æŒ‚äº†ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¾ç„¶ä¼š <code>XA COMMIT</code> æˆåŠŸã€‚</p>
<p>å»ºè®®ï¼šæŒ‰ç…§ä¸¥æ ¼çš„ XA äº‹åŠ¡å®šä¹‰ã€‚</p>
<h2 id="4-3-MyCAT-å¯åŠ¨å›æ»š-PREPARE-çš„-XAäº‹åŠ¡"><a href="#4-3-MyCAT-å¯åŠ¨å›æ»š-PREPARE-çš„-XAäº‹åŠ¡" class="headerlink" title="4.3 MyCAT å¯åŠ¨å›æ»š PREPARE çš„ XAäº‹åŠ¡"></a>4.3 MyCAT å¯åŠ¨å›æ»š PREPARE çš„ XAäº‹åŠ¡</h2><p>1ã€MyCAT å¯åŠ¨æ—¶ï¼Œå›æ»šæ‰€æœ‰çš„ <code>PREPARE</code> çš„ XA äº‹åŠ¡ï¼Œå¯èƒ½æŸä¸ª XA äº‹åŠ¡ï¼Œéƒ¨åˆ† <code>COMMIT</code>ï¼Œéƒ¨åˆ† <code>PREPARE</code>ã€‚æ­¤æ—¶ç›´æ¥å›æ»šï¼Œä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚</p>
<p>å»ºè®®ï¼šå½“åˆ¤æ–­åˆ°æŸä¸ª XA äº‹åŠ¡å­˜åœ¨ <code>PREPARE</code> çš„å‚ä¸è€…ï¼Œ<strong>åŒæ—¶åˆ¤æ–­è¯¥ XA äº‹åŠ¡é‡Œå…¶ä»–å‚ä¸è€…çš„äº‹åŠ¡çŠ¶æ€</strong>ä»¥åŠ<strong>æ•°æ®èŠ‚ç‚¹é‡Œ XA äº‹åŠ¡çŠ¶æ€</strong>ï¼Œæ¯”å¦‚å‚ä¸è€…ä¸º <code>MySQL</code>æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>XA RECOVER</code> æŸ¥è¯¢å¤„äº <code>PREPARE</code> æ‰€æœ‰çš„ XA äº‹åŠ¡ã€‚</p>
<p>2ã€å›æ»š <code>PREPARE</code> æ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œåœ¨æœªè¿›è¡Œå®Œæˆæ—¶å·²ç»è®¾ç½®æ–‡ä»¶é‡Œå›æ»šæˆåŠŸã€‚å¦‚æœå¼‚æ­¥è¿‡ç¨‹ä¸­å¤±è´¥ï¼Œä¼šå¯¼è‡´ XA äº‹åŠ¡çŠ¶æ€ä¸ä¸€è‡´ã€‚</p>
<p>å»ºè®®ï¼šå›è°ƒæˆåŠŸåï¼Œæ›´æ–°è¯¥ XA äº‹åŠ¡çŠ¶æ€ã€‚</p>
<h2 id="4-4-å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—"><a href="#4-4-å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—" class="headerlink" title="4.4 å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—"></a>4.4 å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—</h2><p>è¯¥æƒ…å†µè¾ƒä¸ºæç«¯ã€‚å‘èµ· <code>XA PREPARE</code>å®Œåï¼ŒMyCAT æŒ‚äº†ã€‚é‡å¯åï¼Œè¯¥ XA äº‹åŠ¡åœ¨ MyCAT é‡Œå°±â€œæ¶ˆå¤±â€œäº†ï¼Œå‚ä¸è€…çš„è¯¥ XA äº‹åŠ¡ä¸€ç›´å¤„äº <code>PREPARE</code> çŠ¶æ€ã€‚ä»ç†è®ºä¸Šæ¥è¯´ï¼Œéœ€è¦å›æ»šè¯¥ XA äº‹åŠ¡ã€‚</p>
<p>å»ºè®®ï¼šè®°å½•åè°ƒæ—¥å¿—ã€‚</p>
<h2 id="4-5-XA-COMMIT-éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†"><a href="#4-5-XA-COMMIT-éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†" class="headerlink" title="4.5 XA COMMIT éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†"></a>4.5 XA COMMIT éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†</h2><p>å½“ä¸€éƒ¨åˆ†èŠ‚ç‚¹ <code>XA COMMIT</code> å®Œæˆï¼Œå¦å¤–ä¸€éƒ¨åˆ†æ­¤æ—¶æŒ‚äº†ã€‚åœ¨ç®¡ç†å‘˜é‡å¯æŒ‚æ‰çš„èŠ‚ç‚¹ï¼Œå…¶å¯¹åº”çš„ XA äº‹åŠ¡æœªè¿›ä¸€æ­¥å¤„ç†ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚</p>
<p>å»ºè®®ï¼šğŸ˜ˆæœ¨æœ‰å»ºè®®ã€‚ä¹Ÿå¾ˆå¥½å¥‡ï¼Œå¦‚æœæ˜¯è¿™æ ·çš„æƒ…å†µï¼Œå¦‚ä½•å¤„ç†è¾ƒä¸ºåˆé€‚ã€‚å¦‚æœ‰å¤§å¤§çŸ¥é“ï¼Œçƒ¦è¯·å‘ŠçŸ¥ä¸‹ã€‚</p>
<h1 id="5-å½©è›‹"><a href="#5-å½©è›‹" class="headerlink" title="5. å½©è›‹"></a>5. å½©è›‹</h1><p>ä¾‹è¡Œâ€œå½©è›‹â€ï¼Ÿ</p>
<ul>
<li><a href="http://blog.csdn.net/d6619309/article/details/52330334" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMycatæºç ç¯‡ : MyCatäº‹åŠ¡ç®¡ç†æœºåˆ¶åˆ†æã€‹</a> æ¥è‡ª MyCAT Committer çš„æ–‡ç« </li>
<li><a href="http://mysql.taobao.org/monthly/2015/04/05/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMySQL Â· æ‰è™«åŠ¨æ€ Â· è¿æ¥æ–­å¼€å¯¼è‡´XAäº‹åŠ¡ä¸¢å¤±ã€‹</a></li>
<li><a href="http://www.infoq.com/cn/articles/solution-of-distributed-system-transaction-consistency" rel="external nofollow noopener noreferrer" target="_blank">ã€Šåˆ†å¸ƒå¼ç³»ç»Ÿäº‹åŠ¡ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆã€‹</a></li>
<li><a href="http://blog.csdn.net/fly2749/article/details/44998203" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMySQLæ•°æ®åº“åˆ†å¸ƒå¼äº‹åŠ¡XAä¼˜ç¼ºç‚¹ä¸æ”¹è¿›æ–¹æ¡ˆã€‹</a></li>
<li><a href="http://www.hollischuang.com/archives/1580" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥ç†è§£åˆ†å¸ƒå¼ç³»ç»Ÿçš„2PCå’Œ3PCã€‹</a></li>
<li><a href="https://github.com/YunaiV/yunaiv.github.io/blob/master/source/_drafts/MyCAT/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1.xmind" rel="external nofollow noopener noreferrer" target="_blank">ã€åˆ†å¸ƒå¼äº‹åŠ¡.xmindã€‘</a> ç¬”è€…æ‹™ä½œ </li>
<li><a href="http://www.yunai.me/RocketMQ/message-transaction/?self">ã€ŠRocketMQ æºç åˆ†æ â€”â€” äº‹åŠ¡æ¶ˆæ¯ã€‹</a> ç¬”è€…æ‹™ä½œ</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/strong
    
    </summary>
    
      <category term="MyCAT" scheme="http://www.yunai.me/categories/MyCAT/"/>
    
    
  </entry>
  
  <entry>
    <title>MyCAT æºç åˆ†æ  â€”â€” è·¨åº“ä¸¤è¡¨Join</title>
    <link href="http://www.yunai.me/MyCAT/two-table-share-join/"/>
    <id>http://www.yunai.me/MyCAT/two-table-share-join/</id>
    <published>2017-07-11T16:00:00.000Z</published>
    <updated>2017-07-31T12:30:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ä¸»æµç¨‹</a></li>
<li><a href="#">3. ShareJoin</a><ul>
<li><a href="#">3.1 JoinParser</a></li>
<li><a href="#">3.2 ShareJoin.processSQL(â€¦)</a></li>
<li><a href="#">3.3 BatchSQLJob</a></li>
<li><a href="#">3.4 ShareDBJoinHandler</a></li>
<li><a href="#">3.5 ShareRowOutPutDataHandler</a></li>
</ul>
</li>
<li><a href="#">4. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>MyCAT æ”¯æŒè·¨åº“è¡¨ Joinï¼Œç›®å‰ç‰ˆæœ¬ä»…æ”¯æŒè·¨åº“<strong>ä¸¤</strong>è¡¨ Joinã€‚è™½ç„¶å¦‚æ­¤ï¼Œå·²ç»èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬å¤§éƒ¨åˆ†çš„ä¸šåŠ¡åœºæ™¯ã€‚å†µä¸”ï¼ŒJoin è¿‡å¤šçš„è¡¨å¯èƒ½å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ä¹Ÿæ˜¯å¾ˆéº»çƒ¦çš„ã€‚</p>
<p>æœ¬æ–‡ä¸»è¦åˆ†äº«ï¼š</p>
<ol>
<li>æ•´ä½“æµç¨‹ã€è°ƒç”¨é¡ºåºå›¾</li>
<li>æ ¸å¿ƒä»£ç çš„åˆ†æ</li>
</ol>
<p>å‰ç½®é˜…è¯»ï¼š<a href="http://www.yunai.me/MyCAT/single-db-single-table-select/?yunai">ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹</a>ã€‚</p>
<p>OKï¼ŒLetâ€™s Goã€‚</p>
<h1 id="2-ä¸»æµç¨‹"><a href="#2-ä¸»æµç¨‹" class="headerlink" title="2. ä¸»æµç¨‹"></a>2. ä¸»æµç¨‹</h1><p>å½“æ‰§è¡Œè·¨åº“ä¸¤è¡¨ Join SQL æ—¶ï¼Œç»å†çš„å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_12/01.png" alt=""></p>
<p>SQL ä¸Šï¼Œéœ€è¦æ·»åŠ æ³¨è§£ <code>/*!mycat:catlet=io.mycat.catlets.ShareJoin */ ${SQL}</code> ã€‚<code>RouteService#route(...)</code> è§£ææ³¨è§£ <code>mycat:catlet</code> åï¼Œè·¯ç”±ç»™ <code>HintCatletHandler</code> ä½œè¿›ä¸€æ­¥å¤„ç†ã€‚</p>
<p><code>HintCatletHandler</code> è·å–æ³¨è§£å¯¹åº”çš„ <code>Catlet</code> å®ç°ç±»ï¼Œ<code>io.mycat.catlets.ShareJoin</code> å°±æ˜¯å…¶ä¸­ä¸€ç§å®ç°ï¼ˆç›®å‰ä¹Ÿåªæœ‰è¿™ä¸€ç§å®ç°ï¼‰ï¼Œæä¾›äº†è·¨åº“ä¸¤è¡¨ Join çš„åŠŸèƒ½ã€‚ä»ç±»å‘½åä¸Šçœ‹ï¼Œ<code>ShareJoin</code> å¾ˆå¤§å¯èƒ½æ€§åç»­ä¼šæä¾›<strong>å®Œæ•´</strong>çš„è·¨åº“å¤šè¡¨çš„ Join åŠŸèƒ½ã€‚</p>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// HintCatletHandler.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> RouteResultset <span class="title">route</span><span class="params">(SystemConfig sysConfig, SchemaConfig schema,</span></span></div><div class="line">                           <span class="keyword">int</span> sqlType, String realSQL, String charset, ServerConnection sc,</div><div class="line">                           LayerCachePool cachePool, String hintSQLValue, <span class="keyword">int</span> hintSqlType, Map hintMap)</div><div class="line">       <span class="keyword">throws</span> SQLNonTransientException &#123;</div><div class="line">   String cateletClass = hintSQLValue;</div><div class="line">   <span class="keyword">if</span> (LOGGER.isDebugEnabled()) &#123;</div><div class="line">       LOGGER.debug(<span class="string">"load catelet class:"</span> + hintSQLValue + <span class="string">" to run sql "</span> + realSQL);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Catlet catlet = (Catlet) MycatServer.getInstance().getCatletClassLoader().getInstanceofClass(cateletClass);</div><div class="line">       catlet.route(sysConfig, schema, sqlType, realSQL, charset, sc, cachePool);</div><div class="line">       catlet.processSQL(realSQL, <span class="keyword">new</span> EngineCtx(sc.getSession2()));</div><div class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">       LOGGER.warn(<span class="string">"catlet error "</span> + e);</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLNonTransientException(e);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="3-ShareJoin"><a href="#3-ShareJoin" class="headerlink" title="3. ShareJoin"></a>3. ShareJoin</h1><p>ç›®å‰æ”¯æŒè·¨åº“<strong>ä¸¤</strong>è¡¨ Joinã€‚<code>ShareJoin</code> å°† SQL æ‹†åˆ†æˆå·¦è¡¨ SQL å’Œ å³è¡¨ SQLï¼Œå‘é€ç»™å„æ•°æ®èŠ‚ç‚¹æ‰§è¡Œï¼Œæ±‡æ€»æ•°æ®ç»“æœè¿›è¡Œåˆåè¿”å›ã€‚</p>
<p>ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SELECT u.id, o.id FROM t_order o </span></div><div class="line"><span class="comment">// INNER JOIN t_user u ON o.uid = u.id</span></div><div class="line"><span class="comment">// ã€é¡ºåºã€‘æŸ¥è¯¢å·¦è¡¨</span></div><div class="line">String leftSQL = <span class="string">"SELECT o.id, u.id FROM t_order o"</span>;</div><div class="line">List leftList = dn[<span class="number">0</span>].select(leftSQL) + dn[<span class="number">1</span>].select(leftSQL) + ... + dn[n].select(leftsql);</div><div class="line"><span class="comment">// ã€å¹¶è¡Œã€‘æŸ¥è¯¢å³è¡¨</span></div><div class="line">String rightSQL = <span class="string">"SELECT u.id FROM t_user u WHERE u.id IN ($&#123;leftList.uid&#125;)"</span>;</div><div class="line"><span class="keyword">for</span> (dn : dns) &#123; <span class="comment">// æ­¤å¤„æ˜¯å¹¶è¡Œæ‰§è¡Œï¼Œä½¿ç”¨å›è°ƒé€»è¾‘</span></div><div class="line">    <span class="keyword">for</span> (rightRecord : dn.select(rightSQL)) &#123; <span class="comment">// æŸ¥è¯¢å³è¡¨</span></div><div class="line">        <span class="comment">// åˆå¹¶ç»“æœ</span></div><div class="line">        <span class="keyword">for</span> (leftRecord : leftList) &#123;</div><div class="line">            <span class="keyword">if</span> (leftRecord.uid == rightRecord.id) &#123;</div><div class="line">                write(leftRecord + leftRecord.uid æ‹¼æ¥ç»“æœ);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å®é™…æƒ…å†µä¼šæ›´åŠ å¤æ‚ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä¸€ç‚¹ç‚¹å¾€ä¸‹çœ‹ã€‚</p>
<h2 id="3-1-JoinParser"><a href="#3-1-JoinParser" class="headerlink" title="3.1 JoinParser"></a>3.1 JoinParser</h2><p><code>JoinParser</code> è´Ÿè´£å¯¹ SQL è¿›è¡Œè§£æã€‚æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_12/02.png" alt=""></p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ<code>/*!mycat:catlet=io.mycat.catlets.ShareJoin */ SELECT o.id, u.username from t_order o join t_user u on o.uid = u.id;</code> è§£æåï¼Œ<code>TableFilter</code> ç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_12/03.png" alt=""></p>
<ul>
<li>tName ï¼šè¡¨å</li>
<li>tAlia ï¼šè¡¨è‡ªå®šä¹‰å‘½å</li>
<li>where ï¼šè¿‡æ»¤æ¡ä»¶</li>
<li>order ï¼šæ’åºæ¡ä»¶</li>
<li>parenTable ï¼šå·¦è¿æ¥çš„ Join çš„è¡¨åã€‚<code>t_user</code>è¡¨ åœ¨ <code>join</code>å±æ€§ çš„ <code>parenTable</code> ä¸º â€œoâ€ï¼Œå³ <code>t_order</code>ã€‚</li>
<li>joinParentkey ï¼šå·¦è¿æ¥çš„ Join å­—æ®µ</li>
<li>joinKey ï¼šjoin å­—æ®µã€‚<code>t_user</code>è¡¨ åœ¨ <code>join</code>å±æ€§ ä¸º <code>id</code>ã€‚</li>
<li>join ï¼šå­ tableFilterã€‚å³ï¼Œè¯¥è¡¨è¿æ¥çš„å³è¾¹çš„è¡¨ã€‚</li>
<li>parent ï¼šå’Œ <code>join</code>å±æ€§ ç›¸å¯¹ã€‚</li>
</ul>
<p>çœ‹åˆ°æ­¤å¤„ï¼Œå¤§å®¶å¯èƒ½æœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆè¦æŠŠ SQL è§£ææˆ <code>TableFilter</code>ã€‚<code>JoinParser</code> æ ¹æ® <code>TableFilter</code> ç”Ÿæˆæ•°æ®èŠ‚ç‚¹æ‰§è¡Œ SQLã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TableFilter.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getSQL</span><span class="params">()</span> </span>&#123;</div><div class="line">   String sql = <span class="string">""</span>;</div><div class="line">   <span class="comment">// fields</span></div><div class="line">   <span class="keyword">for</span> (Entry&lt;String, String&gt; entry : fieldAliasMap.entrySet()) &#123;</div><div class="line">       String key = entry.getKey();</div><div class="line">       String val = entry.getValue();</div><div class="line">       <span class="keyword">if</span> (val == <span class="keyword">null</span>) &#123;</div><div class="line">           sql = unionsql(sql, getFieldfrom(key), <span class="string">","</span>);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           sql = unionsql(sql, getFieldfrom(key) + <span class="string">" as "</span> + val, <span class="string">","</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// where</span></div><div class="line">   <span class="keyword">if</span> (parent == <span class="keyword">null</span>) &#123;    <span class="comment">// on/where ç­‰äºå·å·¦è¾¹çš„è¡¨</span></div><div class="line">       String parentJoinKey = getJoinKey(<span class="keyword">true</span>);</div><div class="line">       <span class="comment">// fix sharejoin bugï¼š</span></div><div class="line">       <span class="comment">// (AbstractConnection.java:458) -close connection,reason:program err:java.lang.IndexOutOfBoundsException:</span></div><div class="line">       <span class="comment">// åŸå› æ˜¯å·¦è¡¨çš„selectåˆ—æ²¡æœ‰åŒ…å« join åˆ—ï¼Œåœ¨è·å–ç»“æœæ—¶æŠ¥ä¸Šé¢çš„é”™è¯¯</span></div><div class="line">       <span class="keyword">if</span> (sql != <span class="keyword">null</span> &amp;&amp; parentJoinKey != <span class="keyword">null</span> &amp;&amp;</div><div class="line">               !sql.toUpperCase().contains(parentJoinKey.trim().toUpperCase())) &#123;</div><div class="line">           sql += <span class="string">", "</span> + parentJoinKey;</div><div class="line">       &#125;</div><div class="line">       sql = <span class="string">"select "</span> + sql + <span class="string">" from "</span> + tName;</div><div class="line">       <span class="keyword">if</span> (!(where.trim().equals(<span class="string">""</span>))) &#123;</div><div class="line">           sql += <span class="string">" where "</span> + where.trim();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;    <span class="comment">// on/where ç­‰äºå·å³è¾¹è¾¹çš„è¡¨</span></div><div class="line">       <span class="keyword">if</span> (allField) &#123;</div><div class="line">           sql = <span class="string">"select "</span> + sql + <span class="string">" from "</span> + tName;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           sql = unionField(<span class="string">"select "</span> + joinKey, sql, <span class="string">","</span>);</div><div class="line">           sql = sql + <span class="string">" from "</span> + tName;</div><div class="line">           <span class="comment">//sql="select "+joinKey+","+sql+" from "+tName;</span></div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!(where.trim().equals(<span class="string">""</span>))) &#123;</div><div class="line">           sql += <span class="string">" where "</span> + where.trim() + <span class="string">" and ("</span> + joinKey + <span class="string">" in %s )"</span>;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           sql += <span class="string">" where "</span> + joinKey + <span class="string">" in %s "</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// order</span></div><div class="line">   <span class="keyword">if</span> (!(order.trim().equals(<span class="string">""</span>))) &#123;</div><div class="line">       sql += <span class="string">" order by "</span> + order.trim();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// limit</span></div><div class="line">   <span class="keyword">if</span> (parent == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">if</span> ((rowCount &gt; <span class="number">0</span>) &amp;&amp; (offset &gt; <span class="number">0</span>)) &#123;</div><div class="line">           sql += <span class="string">" limit"</span> + offset + <span class="string">","</span> + rowCount;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">if</span> (rowCount &gt; <span class="number">0</span>) &#123;</div><div class="line">               sql += <span class="string">" limit "</span> + rowCount;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> sql;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å½“ <code>parent</code> ä¸ºç©ºæ—¶ï¼Œå³<strong>on/where ç­‰äºå·å·¦è¾¹çš„è¡¨</strong>ã€‚ä¾‹å¦‚ï¼š<code>select id, uid from t_order</code>ã€‚</li>
<li>å½“ <code>parent</code>  ä¸ä¸ºç©ºæ—¶ï¼Œå³<strong>on/where ç­‰äºå·å³è¾¹çš„è¡¨</strong>ã€‚ä¾‹å¦‚ï¼š<code>select id, username from t_user where id in (1, 2, 3)</code>ã€‚</li>
</ul>
<h2 id="3-2-ShareJoin-processSQL-â€¦"><a href="#3-2-ShareJoin-processSQL-â€¦" class="headerlink" title="3.2 ShareJoin.processSQL(â€¦)"></a>3.2 ShareJoin.processSQL(â€¦)</h2><p>å½“ SQL è§£æå®Œåï¼Œç”Ÿæˆ<strong>å·¦è¾¹çš„è¡¨</strong>æ‰§è¡Œçš„ SQLï¼Œå‘é€ç»™å¯¹åº”çš„æ•°æ®èŠ‚ç‚¹æŸ¥è¯¢æ•°æ®ã€‚å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_12/04.png" alt=""></p>
<p>å½“ SQL ä¸º <code>/*!mycat:catlet=io.mycat.catlets.ShareJoin */ SELECT o.id, u.username from t_order o join t_user u on o.uid = u.id;</code> æ—¶ï¼Œ<br><code>sql = getSql()</code> çš„è¿”å›ç»“æœä¸º <code>select id, uid from t_order</code>ã€‚</p>
<p>ç”Ÿæˆ<strong>å·¦è¾¹çš„è¡¨</strong>æ‰§è¡Œçš„ SQL åï¼Œ<strong>é¡ºåºé¡ºåºé¡ºåº</strong>å‘é€ç»™å¯¹åº”çš„æ•°æ®èŠ‚ç‚¹æŸ¥è¯¢æ•°æ®ã€‚å…·ä½“é¡ºåºæŸ¥è¯¢æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ç«  <strong>BatchSQLJob</strong>ã€‚</p>
<h2 id="3-3-BatchSQLJob"><a href="#3-3-BatchSQLJob" class="headerlink" title="3.3 BatchSQLJob"></a>3.3 BatchSQLJob</h2><p><img src="http://www.yunai.me/images/MyCAT/2017_07_12/05.png" alt=""></p>
<p><code>EngineCtx</code> å¯¹ <code>BatchSQLJob</code> å°è£…ï¼Œæä¾›ä¸Šå±‚ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<ol>
<li>executeNativeSQLSequnceJob ï¼šé¡ºåºï¼ˆéå¹¶å‘ï¼‰åœ¨æ¯ä¸ªæ•°æ®èŠ‚ç‚¹æ‰§è¡ŒSQLä»»åŠ¡</li>
<li>executeNativeSQLParallJob ï¼šå¹¶å‘åœ¨æ¯ä¸ªæ•°æ®èŠ‚ç‚¹æ‰§è¡ŒSQLä»»åŠ¡</li>
</ol>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EngineCtx.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeNativeSQLSequnceJob</span><span class="params">(String[] dataNodes, String sql,</span></span></div><div class="line">		SQLJobHandler jobHandler) &#123;</div><div class="line">	<span class="keyword">for</span> (String dataNode : dataNodes) &#123;</div><div class="line">		SQLJob job = <span class="keyword">new</span> SQLJob(jobId.incrementAndGet(), sql, dataNode,</div><div class="line">				jobHandler, <span class="keyword">this</span>);</div><div class="line">		bachJob.addJob(job, <span class="keyword">false</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeNativeSQLParallJob</span><span class="params">(String[] dataNodes, String sql,</span></span></div><div class="line">		SQLJobHandler jobHandler) &#123;</div><div class="line">	<span class="keyword">for</span> (String dataNode : dataNodes) &#123;</div><div class="line">		SQLJob job = <span class="keyword">new</span> SQLJob(jobId.incrementAndGet(), sql, dataNode,</div><div class="line">				jobHandler, <span class="keyword">this</span>);</div><div class="line">		bachJob.addJob(job, <span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><code>BatchSQLJob</code> é€šè¿‡<strong>æ‰§è¡Œä¸­ä»»åŠ¡åˆ—è¡¨</strong>ã€<strong>å¾…æ‰§è¡Œä»»åŠ¡åˆ—è¡¨</strong>æ¥å®ç°<strong>é¡ºåº/å¹¶å‘</strong>æ‰§è¡Œä»»åŠ¡ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// BatchSQLJob.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œä¸­ä»»åŠ¡åˆ—è¡¨</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> ConcurrentHashMap&lt;Integer, SQLJob&gt; runningJobs = <span class="keyword">new</span> ConcurrentHashMap&lt;Integer, SQLJob&gt;();</div><div class="line"><span class="comment">/**</span></div><div class="line">* å¾…æ‰§è¡Œä»»åŠ¡åˆ—è¡¨</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> ConcurrentLinkedQueue&lt;SQLJob&gt; waitingJobs = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;SQLJob&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addJob</span><span class="params">(SQLJob newJob, <span class="keyword">boolean</span> parallExecute)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (parallExecute) &#123;</div><div class="line">       runJob(newJob);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       waitingJobs.offer(newJob);</div><div class="line">       <span class="keyword">if</span> (runningJobs.isEmpty()) &#123; <span class="comment">// è‹¥æ— æ­£åœ¨æ‰§è¡Œä¸­çš„ä»»åŠ¡ï¼Œåˆ™ä»ç­‰å¾…é˜Ÿåˆ—é‡Œè·å–ä»»åŠ¡è¿›è¡Œæ‰§è¡Œã€‚</span></div><div class="line">           SQLJob job = waitingJobs.poll();</div><div class="line">           <span class="keyword">if</span> (job != <span class="keyword">null</span>) &#123;</div><div class="line">               runJob(job);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">jobFinished</span><span class="params">(SQLJob sqlJob)</span> </span>&#123;</div><div class="line">	runningJobs.remove(sqlJob.getId());</div><div class="line">	SQLJob job = waitingJobs.poll();</div><div class="line">	<span class="keyword">if</span> (job != <span class="keyword">null</span>) &#123;</div><div class="line">		runJob(job);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">if</span> (noMoreJobInput) &#123;</div><div class="line">			<span class="keyword">return</span> runningJobs.isEmpty() &amp;&amp; waitingJobs.isEmpty();</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>é¡ºåº</strong>æ‰§è¡Œæ—¶ï¼Œå½“ <code>runningJobs</code> å­˜åœ¨æ‰§è¡Œä¸­çš„ä»»åŠ¡æ—¶ï¼Œ<code>#addJob(...)</code> æ—¶ï¼Œä¸ç«‹å³æ‰§è¡Œï¼Œæ·»åŠ åˆ° <code>waitingJobs</code>ã€‚å½“ <code>SQLJob</code> å®Œæˆæ—¶ï¼Œé¡ºåºè°ƒç”¨ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚</li>
<li><strong>å¹¶å‘</strong>æ‰§è¡Œæ—¶ï¼Œ<code>#addJob(...)</code> æ—¶ï¼Œç«‹å³æ‰§è¡Œã€‚</li>
</ul>
<hr>
<p><code>SQLJob</code> SQL å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ã€‚å…¶ <code>jobHandler(SQLJobHandler)</code> å±æ€§ï¼Œåœ¨ SQL æ‰§è¡Œæœ‰è¿”å›ç»“æœæ—¶ï¼Œä¼šè¿›è¡Œå›è°ƒï¼Œä»è€Œå®ç°å¼‚æ­¥æ‰§è¡Œã€‚</p>
<p>åœ¨ <code>ShareJoin</code> é‡Œï¼Œ<code>SQLJobHandler</code> æœ‰ä¸¤ä¸ªå®ç°ï¼š<code>ShareDBJoinHandler</code>ã€<code>ShareRowOutPutDataHandler</code>ã€‚å‰è€…ï¼Œ<strong>å·¦è¾¹çš„è¡¨</strong>æ‰§è¡Œçš„ SQL å›è°ƒï¼›åè€…ï¼Œ<strong>å³è¾¹çš„è¡¨</strong>æ‰§è¡Œçš„ SQL å›è°ƒã€‚</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_12/06.png" alt=""></p>
<h2 id="3-4-ShareDBJoinHandler"><a href="#3-4-ShareDBJoinHandler" class="headerlink" title="3.4 ShareDBJoinHandler"></a>3.4 ShareDBJoinHandler</h2><p><code>ShareDBJoinHandler</code>ï¼Œ<strong>å·¦è¾¹çš„è¡¨</strong>æ‰§è¡Œçš„ SQL å›è°ƒã€‚æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_12/07.png" alt=""></p>
<ul>
<li><code>#fieldEofResponse(...)</code> ï¼šæ¥æ”¶æ•°æ®èŠ‚ç‚¹è¿”å›çš„ fieldsï¼Œæ”¾å…¥å†…å­˜ã€‚</li>
<li><code>#rowResponse(...)</code> ï¼šæ¥æ”¶æ•°æ®èŠ‚ç‚¹è¿”å›çš„ rowï¼Œæ”¾å…¥å†…å­˜ã€‚</li>
<li><code>#rowEofResponse(...)</code> ï¼šæ¥æ”¶å®Œä¸€ä¸ªæ•°æ®èŠ‚ç‚¹è¿”å›æ‰€æœ‰çš„ rowã€‚å½“æ‰€æœ‰æ•°æ®èŠ‚ç‚¹éƒ½å®Œæˆ SQL æ‰§è¡Œæ—¶ï¼Œæäº¤<strong>å³è¾¹çš„è¡¨</strong>æ‰§è¡Œçš„ SQL ä»»åŠ¡ï¼Œ<strong>å¹¶è¡Œ</strong>æ‰§è¡Œï¼Œå³å›¾ä¸­<strong>#createQryJob(â€¦)</strong>ã€‚</li>
</ul>
<p>å½“ SQL ä¸º <code>/*!mycat:catlet=io.mycat.catlets.ShareJoin */ SELECT o.id, u.username from t_order o join t_user u on o.uid = u.id;</code> æ—¶ï¼Œ<br><code>sql = getChildSQL()</code> çš„è¿”å›ç»“æœä¸º <code>select id, username from t_user where id in (1, 2, 3)</code>ã€‚</p>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShareJoin.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createQryJob</span><span class="params">(<span class="keyword">int</span> batchSize)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">   Map&lt;String, <span class="keyword">byte</span>[]&gt; batchRows = <span class="keyword">new</span> ConcurrentHashMap&lt;String, <span class="keyword">byte</span>[]&gt;();</div><div class="line">   String theId = <span class="keyword">null</span>;</div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder().append(<span class="string">'('</span>);</div><div class="line">   String svalue = <span class="string">""</span>;</div><div class="line">   <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; e : ids.entrySet()) &#123;</div><div class="line">       theId = e.getKey();</div><div class="line">       <span class="keyword">byte</span>[] rowbyte = rows.remove(theId);</div><div class="line">       <span class="keyword">if</span> (rowbyte != <span class="keyword">null</span>) &#123;</div><div class="line">           batchRows.put(theId, rowbyte);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!svalue.equals(e.getValue())) &#123;</div><div class="line">           <span class="keyword">if</span> (joinKeyType == Fields.FIELD_TYPE_VAR_STRING</div><div class="line">                   || joinKeyType == Fields.FIELD_TYPE_STRING) &#123; <span class="comment">// joinkey ä¸ºvarchar</span></div><div class="line">               sb.append(<span class="string">"'"</span>).append(e.getValue()).append(<span class="string">"'"</span>).append(<span class="string">','</span>); <span class="comment">// ('digdeep','yuanfang')</span></div><div class="line">           &#125; <span class="keyword">else</span> &#123; <span class="comment">// é»˜è®¤joinkeyä¸ºint/long</span></div><div class="line">               sb.append(e.getValue()).append(<span class="string">','</span>); <span class="comment">// (1,2,3)</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       svalue = e.getValue();</div><div class="line">       <span class="keyword">if</span> (count++ &gt; batchSize) &#123;</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   jointTableIsData = <span class="keyword">true</span>;</div><div class="line">   sb.deleteCharAt(sb.length() - <span class="number">1</span>).append(<span class="string">')'</span>);</div><div class="line">   String sql = String.format(joinParser.getChildSQL(), sb);</div><div class="line">   getRoute(sql);</div><div class="line">   ctx.executeNativeSQLParallJob(getDataNodes(), sql, <span class="keyword">new</span> ShareRowOutPutDataHandler(<span class="keyword">this</span>, fields, joinindex, joinParser.getJoinRkey(), batchRows, ctx.getSession()));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-5-ShareRowOutPutDataHandler"><a href="#3-5-ShareRowOutPutDataHandler" class="headerlink" title="3.5 ShareRowOutPutDataHandler"></a>3.5 ShareRowOutPutDataHandler</h2><p><code>ShareRowOutPutDataHandler</code>ï¼Œ<strong>å³è¾¹çš„è¡¨</strong>æ‰§è¡Œçš„ SQL å›è°ƒã€‚æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_12/08.png" alt=""></p>
<ul>
<li><code>#fieldEofResponse(...)</code> ï¼šæ¥æ”¶æ•°æ®èŠ‚ç‚¹è¿”å›çš„ fieldsï¼Œè¿”å› header ç»™ MySQL Clientã€‚</li>
<li><code>#rowResponse(...)</code> ï¼šæ¥æ”¶æ•°æ®èŠ‚ç‚¹è¿”å›çš„ rowï¼ŒåŒ¹é…å·¦è¡¨çš„è®°å½•ï¼Œè¿”å›åˆå¹¶åè¿”å›çš„ row ç»™ MySQL Clientã€‚</li>
<li><code>#rowEofResponse(...)</code> ï¼šå½“æ‰€æœ‰ row éƒ½è¿”å›å®Œåï¼Œè¿”å› eof ç»™ MySQL Clientã€‚</li>
</ul>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShareRowOutPutDataHandler.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onRowData</span><span class="params">(String dataNode, <span class="keyword">byte</span>[] rowData)</span> </span>&#123;</div><div class="line">   RowDataPacket rowDataPkgold = ResultSetUtil.parseRowData(rowData, bfields);</div><div class="line">   <span class="comment">//æ‹·è´ä¸€ä»½batchRows</span></div><div class="line">   Map&lt;String, <span class="keyword">byte</span>[]&gt; batchRowsCopy = <span class="keyword">new</span> ConcurrentHashMap&lt;String, <span class="keyword">byte</span>[]&gt;();</div><div class="line">   batchRowsCopy.putAll(arows);</div><div class="line">   <span class="comment">// è·å–Idå­—æ®µï¼Œ</span></div><div class="line">   String id = ByteUtil.getString(rowDataPkgold.fieldValues.get(joinR));</div><div class="line">   <span class="comment">// æŸ¥æ‰¾IDå¯¹åº”çš„Aè¡¨çš„è®°å½•</span></div><div class="line">   <span class="keyword">byte</span>[] arow = getRow(batchRowsCopy, id, joinL);</div><div class="line">   <span class="keyword">while</span> (arow != <span class="keyword">null</span>) &#123;</div><div class="line">       RowDataPacket rowDataPkg = ResultSetUtil.parseRowData(arow, afields);<span class="comment">//ctx.getAllFields());</span></div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; rowDataPkgold.fieldCount; i++) &#123;</div><div class="line">           <span class="comment">// è®¾ç½®b.name å­—æ®µ</span></div><div class="line">           <span class="keyword">byte</span>[] bname = rowDataPkgold.fieldValues.get(i);</div><div class="line">           rowDataPkg.add(bname);</div><div class="line">           rowDataPkg.addFieldCount(<span class="number">1</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// huangyiming add</span></div><div class="line">       MiddlerResultHandler middlerResultHandler = session.getMiddlerResultHandler();</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> == middlerResultHandler) &#123;</div><div class="line">           ctx.writeRow(rowDataPkg);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">if</span> (middlerResultHandler <span class="keyword">instanceof</span> MiddlerQueryResultHandler) &#123;</div><div class="line">               <span class="keyword">byte</span>[] columnData = rowDataPkg.fieldValues.get(<span class="number">0</span>);</div><div class="line">               <span class="keyword">if</span> (columnData != <span class="keyword">null</span> &amp;&amp; columnData.length &gt; <span class="number">0</span>) &#123;</div><div class="line">                   String rowValue = <span class="keyword">new</span> String(columnData);</div><div class="line">                   middlerResultHandler.add(rowValue);</div><div class="line">               &#125;</div><div class="line">               <span class="comment">//&#125;</span></div><div class="line">           &#125;</div><div class="line"></div><div class="line">       &#125;</div><div class="line">       arow = getRow(batchRowsCopy, id, joinL);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="4-å½©è›‹"><a href="#4-å½©è›‹" class="headerlink" title="4. å½©è›‹"></a>4. å½©è›‹</h1><p>å¦‚ä¸‹æ˜¯æœ¬æ–‡æ¶‰åŠåˆ°çš„æ ¸å¿ƒç±»ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ç¿»ä¸€ç¿»ã€‚</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_12/09.png" alt=""></p>
<p><code>ShareJoin</code> å¦å¤–ä¸æ”¯æŒçš„åŠŸèƒ½ï¼š</p>
<ol>
<li>åªæ”¯æŒ inner joinï¼Œä¸æ”¯æŒ left joinã€right join ç­‰ç­‰è¿æ¥ã€‚</li>
<li>ä¸æ”¯æŒ order byã€‚</li>
<li>ä¸æ”¯æŒ group by ä»¥åŠ ç›¸å…³èšåˆå‡½æ•°ã€‚</li>
<li>å³ä½¿ join å·¦è¡¨çš„å­—æ®µæœªå£°æ˜ä¸ºè¿”å› fields ä¹Ÿä¼šè¿”å›ã€‚</li>
</ol>
<p>æ©ï¼Œ<strong>MyCAT å¼±XA</strong> æºç ç»§ç»­èµ°èµ·ï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/strong
    
    </summary>
    
      <category term="MyCAT" scheme="http://www.yunai.me/categories/MyCAT/"/>
    
    
  </entry>
  
  <entry>
    <title>MyCAT æºç è§£æ â€”â€” åˆ†ç‰‡ç»“æœåˆå¹¶ï¼ˆä¸€ï¼‰</title>
    <link href="http://www.yunai.me/MyCAT/sharding-result-merge-first/"/>
    <id>http://www.yunai.me/MyCAT/sharding-result-merge-first/</id>
    <published>2017-06-12T16:00:00.000Z</published>
    <updated>2017-07-31T12:30:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>ç›¸ä¿¡å¾ˆå¤šåŒå­¦çœ‹è¿‡ MySQL å„ç§ä¼˜åŒ–çš„æ–‡ç« ï¼Œé‡Œé¢ 99% ä¼šæåˆ°ï¼šå•è¡¨æ•°æ®é‡å¤§äº†ï¼Œéœ€è¦è¿›è¡Œåˆ†ç‰‡ï¼ˆæ°´å¹³æ‹†åˆ† or å‚ç›´æ‹†åˆ†ï¼‰ã€‚åˆ†ç‰‡ä¹‹åï¼Œä¸šåŠ¡ä¸Šå¿…ç„¶é¢ä¸´çš„åœºæ™¯ï¼šè·¨åˆ†ç‰‡çš„æ•°æ®åˆå¹¶ã€‚ä»Šå¤©æˆ‘ä»¬å°±ä¸€èµ·æ¥ç…ç… MyCAT æ˜¯å¦‚ä½•å®ç°<strong>åˆ†ç‰‡ç»“æœåˆå¹¶</strong>ã€‚</p>
<p>è·¨åˆ†ç‰‡æŸ¥è¯¢å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/flow.png" alt="flow"></p>
<p>å’Œ <a href="http://www.yunai.me/Mycat/single-db-single-table-select/">ã€Šã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹</a> ä¸åŒçš„ä¸¤ä¸ªè¿‡ç¨‹ï¼š</p>
<ul>
<li>ã€2ã€‘å¤šåˆ†ç‰‡æ‰§è¡Œ SQL</li>
<li>ã€4ã€‘åˆå¹¶å¤šåˆ†ç‰‡ç»“æœ</li>
</ul>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥é€æ¡è®²è§£è¿™ä¸¤ä¸ªè¿‡ç¨‹ã€‚</p>
<h1 id="2-å¤šåˆ†ç‰‡æ‰§è¡Œ-SQL"><a href="#2-å¤šåˆ†ç‰‡æ‰§è¡Œ-SQL" class="headerlink" title="2. å¤šåˆ†ç‰‡æ‰§è¡Œ SQL"></a>2. å¤šåˆ†ç‰‡æ‰§è¡Œ SQL</h1><p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/execute_sql.png" alt="execute_sql"></p>
<p>ç»è¿‡ SQL è§£æåï¼Œè®¡ç®—å‡ºéœ€è¦æ‰§è¡Œ SQL çš„<strong>åˆ†ç‰‡èŠ‚ç‚¹</strong>ï¼Œéå†<strong>åˆ†ç‰‡èŠ‚ç‚¹</strong>å‘é€ SQL è¿›è¡Œæ‰§è¡Œã€‚</p>
<p><strong>æ ¸å¿ƒä»£ç </strong>ï¼š</p>
<ul>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/nio/handler/MultiNodeQueryHandler.java" rel="external nofollow noopener noreferrer" target="_blank">MultiNodeQueryHandler.java#execute(â€¦)</a></li>
</ul>
<p><em><strong>SQL è§£æ</strong> è¯¦ç»†è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ï¼Œé¿å…å†…å®¹è¿‡å¤šï¼Œå½±å“å¤§å®¶å¯¹ <strong>åˆ†ç‰‡ç»“æœåˆå¹¶</strong> æµç¨‹å’Œé€»è¾‘çš„ç†è§£ã€‚</em></p>
<h1 id="3-åˆå¹¶å¤šåˆ†ç‰‡ç»“æœ"><a href="#3-åˆå¹¶å¤šåˆ†ç‰‡ç»“æœ" class="headerlink" title="3. åˆå¹¶å¤šåˆ†ç‰‡ç»“æœ"></a>3. åˆå¹¶å¤šåˆ†ç‰‡ç»“æœ</h1><p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/handle_response.png" alt="handle_response"></p>
<p>å’Œ <a href="http://www.yunai.me/Mycat/single-db-single-table-select/">ã€Šã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹</a> ä¸åŒï¼Œå¤šä¸ª<strong>åˆ†ç‰‡èŠ‚ç‚¹</strong>éƒ½ä¼š<strong>åˆ†åˆ«</strong>å“åº” <em>è®°å½•å¤´(header)</em> å’Œ <em>è®°å½•è¡Œ(row)</em> ã€‚åœ¨å¼€å§‹åˆ†æ MyCAT æ˜¯æ€ä¹ˆåˆå¹¶å¤šåˆ†ç‰‡ç»“æœä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥å›æƒ³ä¸‹ SQL çš„æ‰§è¡Œé¡ºåºã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">FROM       // [1] é€‰æ‹©è¡¨</div><div class="line">WHERE      // [2] è¿‡æ»¤è¡¨</div><div class="line">GROUP BY   // [3] åˆ†ç»„</div><div class="line"><span class="keyword">SELECT</span>     // [<span class="number">4</span>] æ™®é€šå­—æ®µï¼Œ<span class="keyword">max</span> / <span class="keyword">min</span> / <span class="keyword">avg</span> / <span class="keyword">sum</span> / <span class="keyword">count</span> ç­‰å‡½æ•°ï¼Œ<span class="keyword">distinct</span></div><div class="line"><span class="keyword">HAVING</span>     // [<span class="number">5</span>] å†è¿‡æ»¤è¡¨</div><div class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span>   // [<span class="number">6</span>] æ’åº</div><div class="line"><span class="keyword">LIMIT</span>      // [<span class="number">7</span>] åˆ†é¡µ</div></pre></td></tr></table></figure>
<h2 id="3-1-è®°å½•å¤´-header"><a href="#3-1-è®°å½•å¤´-header" class="headerlink" title="3.1 è®°å½•å¤´(header)"></a>3.1 è®°å½•å¤´(header)</h2><p>å¤šä¸ª<strong>åˆ†ç‰‡èŠ‚ç‚¹</strong>å“åº”æ—¶ï¼Œä¼šå“åº”å¤šæ¬¡ <em>è®°å½•å¤´(header)</em> ã€‚MyCAT åœ¨å®é™…å¤„ç†æ—¶ï¼Œåªå¤„ç†ç¬¬ä¸€ä¸ªè¿”å›çš„ <em>è®°å½•å¤´(header)</em> ã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨æ—¶è¦ä¿è¯è¡¨çš„ Schema ç›¸åŒã€‚</p>
<p><strong>åˆ†ç‰‡èŠ‚ç‚¹</strong>å“åº”çš„ <em>è®°å½•å¤´(header)</em> å¯ä»¥ç›´æ¥è¿”å› MySQL Client å—ï¼Ÿç­”æ¡ˆæ˜¯ä¸å¯ä»¥ã€‚<code>AVG</code>å‡½æ•° æ˜¯ç‰¹æ®Šæƒ…å†µï¼ŒMyCAT éœ€è¦å°† <code>AVG</code> æ‹†æˆ <code>SUM</code> + <code>COUNT</code> è¿›è¡Œè®¡ç®—ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">// [1] MySQL Client =&gt; MyCAT ï¼š</div><div class="line">SELECT AVG(age) FROM student;</div><div class="line"></div><div class="line">// [2] MyCAT =&gt; MySQL Server ï¼š</div><div class="line">SELECT SUM(age) AS AVG0SUM, COUNT(age) AS AVG0COUNT FROM student;</div><div class="line"></div><div class="line">// [3] æœ€ç»ˆï¼šAVG(age) = SUM(age) AS AVG0SUM / COUNT(age)</div></pre></td></tr></table></figure>
<p><strong>æ ¸å¿ƒä»£ç </strong>ï¼š</p>
<ul>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/nio/handler/MultiNodeQueryHandler.java" rel="external nofollow noopener noreferrer" target="_blank">MultiNodeQueryHandler.java#fieldEofResponse(â€¦)</a>ã€‚</li>
</ul>
<h2 id="3-2-è®°å½•è¡Œ-row"><a href="#3-2-è®°å½•è¡Œ-row" class="headerlink" title="3.2 è®°å½•è¡Œ(row)"></a>3.2 è®°å½•è¡Œ(row)</h2><h3 id="3-1-AbstractDataNodeMerge"><a href="#3-1-AbstractDataNodeMerge" class="headerlink" title="3.1 AbstractDataNodeMerge"></a>3.1 AbstractDataNodeMerge</h3><p>MyCAT å¯¹åˆ†ç‰‡ç»“æœåˆå¹¶é€šè¿‡ <code>AbstractDataNodeMerge</code> å­ç±»æ¥å®Œæˆã€‚</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/merge_service.png" alt="merge_service"> </p>
<p><code>AbstractDataNodeMerge</code> ï¼š</p>
<ul>
<li>-packs ï¼šå¾…åˆå¹¶è®°å½•è¡Œ(row)é˜Ÿåˆ—ã€‚é˜Ÿåˆ—å°¾éƒ¨æ’å…¥ <code>END_FLAG_PACK</code> è¡¨ç¤ºé˜Ÿåˆ—å·²ç»“æŸã€‚</li>
<li>-running ï¼šåˆå¹¶é€»è¾‘æ˜¯å¦æ­£åœ¨æ‰§è¡Œä¸­çš„æ ‡è®°ã€‚</li>
<li>~onRowMetaData(â€¦) ï¼šæ ¹æ®<strong>è®°å½•åˆ—ä¿¡æ¯(ColMeta)</strong>æ„å»ºå¯¹åº”çš„æ’åºç»„ä»¶å’Œèšåˆç»„ä»¶ã€‚éœ€è¦å­ç±»è¿›è¡Œå®ç°ã€‚</li>
<li>~onNewRecord(â€¦) ï¼šæ’å…¥è®°å½•è¡Œ(row) åˆ° <code>packs</code>ã€‚</li>
<li>~outputMergeResult(â€¦) ï¼šæ’å…¥ <code>END_FLAG_PACK</code> åˆ° <code>packs</code>ã€‚</li>
<li>~run(â€¦) ï¼šæ‰§è¡Œ<strong>åˆå¹¶</strong>åˆ†ç‰‡ç»“æœé€»è¾‘ï¼Œå¹¶å°†åˆå¹¶ç»“æœè¿”å›ç»™ MySQL Clientã€‚éœ€è¦å­ç±»è¿›è¡Œå®ç°ã€‚</li>
</ul>
<p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/AbstractDataNodeMerge_run.png" alt="AbstractDataNodeMerge_run.png"></p>
<p><strong>é€šè¿‡ <code>running</code> æ ‡è®°ä¿è¯åŒä¸€æ¡ SQL åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œï¼Œå¹¶ä¸”ä¸éœ€è¦ç­‰åˆ°æ¯ä¸ªåˆ†ç‰‡ç»“æœéƒ½è¿”å›å°±å¯ä»¥æ‰§è¡Œ<em>èšåˆ</em>é€»è¾‘ã€‚å½“ç„¶ï¼Œ<em>æ’åº</em>é€»è¾‘éœ€è¦ç­‰åˆ°æ‰€æœ‰åˆ†ç‰‡ç»“æœéƒ½è¿”å›æ‰å¯ä»¥æ‰§è¡Œã€‚</strong></p>
<p><strong>æ ¸å¿ƒä»£ç </strong>ï¼š</p>
<ul>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/sqlengine/mpp/AbstractDataNodeMerge.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractDataNodeMerge.java</a></li>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/sqlengine/mpp/DataNodeMergeManager.java" rel="external nofollow noopener noreferrer" target="_blank">DataNodeMergeManager.java#run(â€¦)</a></li>
</ul>
<h3 id="3-2-DataNodeMergeManager"><a href="#3-2-DataNodeMergeManager" class="headerlink" title="3.2 DataNodeMergeManager"></a>3.2 DataNodeMergeManager</h3><p><code>AbstractDataNodeMerge</code> æœ‰ä¸¤ç§å­ç±»å®ç°ï¼š</p>
<ul>
<li><code>DataMergeService</code> ï¼šåŸºäº<strong>å †å†…å†…å­˜</strong>åˆå¹¶åˆ†ç‰‡ç»“æœã€‚</li>
<li><code>DataNodeMergeManager</code> ï¼šåŸºäº<strong>å †å¤–å†…å­˜</strong>åˆå¹¶åˆ†ç‰‡ç»“æœã€‚</li>
</ul>
<p>ç›®å‰å®˜æ–¹é»˜è®¤é…ç½®ä½¿ç”¨ <code>DataNodeMergeManager</code>ã€‚ä¸»è¦æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š</p>
<ol>
<li>å¯ä»¥ä½¿ç”¨æ›´å¤§çš„å†…å­˜ç©ºé—´ã€‚å½“å¹¶å‘é‡å¤§æˆ–è€…æ•°æ®é‡å¤§æ—¶ï¼Œæ›´å¤§çš„å†…å­˜ç©ºé—´æ„å‘³ç€æ›´å¥½çš„æ€§èƒ½ã€‚</li>
<li>å‡å°‘ GC æš‚åœæ—¶é—´ã€‚è®°å½•è¡Œ(row)å¯¹è±¡å°ä¸”é‡ç”¨æ€§å¾ˆä½ï¼Œéœ€è¦èƒ½å¤Ÿè¿›è¡Œç±»ä¼¼ C / C++ çš„è‡ªä¸»å†…å­˜é‡Šæ”¾ã€‚</li>
<li>æ›´å¿«çš„å†…å­˜å¤åˆ¶å’Œè¯»å–é€Ÿåº¦ï¼Œå¯¹æ’åºå’Œèšåˆå¸¦æ¥å¾ˆå¥½çš„æé€Ÿã€‚</li>
</ol>
<p>å¦‚æœå¯¹<strong>å †å¤–å†…å­˜</strong>ä¸å¤ªäº†è§£ï¼Œæ¨èé˜…è¯»å¦‚ä¸‹æ–‡ç« ï¼š</p>
<ol>
<li><a href="http://www.jianshu.com/p/50be08b54bee" rel="external nofollow noopener noreferrer" target="_blank">ã€Šä»0åˆ°1èµ·æ­¥-è·Ÿæˆ‘è¿›å…¥å †å¤–å†…å­˜çš„å¥‡å¦™ä¸–ç•Œã€‹</a></li>
<li><a href="http://www.infoq.com/cn/news/2014/12/external-memory-heap-memory" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå †å†…å†…å­˜è¿˜æ˜¯å †å¤–å†…å­˜ï¼Ÿã€‹</a></li>
<li><a href="http://www.cnblogs.com/moonandstar08/p/5107648.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJAVAå †å¤–å†…å­˜ã€‹</a></li>
<li><a href="https://yq.aliyun.com/articles/2948?spm=5176.100239.blogcont62539.11.a3HdFE" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJVMæºç åˆ†æä¹‹å †å¤–å†…å­˜å®Œå…¨è§£è¯»ã€‹</a></li>
</ol>
<p>æœ¬æ–‡ä¸»è¦åˆ†æ <code>DataNodeMergeManager</code> å®ç°ï¼Œ<code>DataMergeService</code> å¯ä»¥è‡ªå·±é˜…è¯»æˆ–è€…ç­‰å¾…åç»­æ–‡ç« ï¼ˆğŸ˜ˆ<strong>æ¬¢è¿è®¢é˜…æˆ‘çš„å…¬ä¼—å·å™¢</strong>ï¼‰ã€‚</p>
<p><code>DataNodeMergeManager</code> æœ‰ä¸‰ä¸ªç»„ä»¶ï¼š</p>
<ul>
<li><code>globalSorter</code> ï¼š<code>UnsafeExternalRowSorter</code> =&gt; å®ç°è®°å½•è¡Œ(row)<strong>åˆå¹¶å¹¶æ’åº</strong>é€»è¾‘ã€‚</li>
<li><code>globalMergeResult</code> ï¼š<code>UnsafeExternalRowSorter</code> =&gt; å®ç°è®°å½•è¡Œ(row)<strong>åˆå¹¶ä¸æ’åº</strong>é€»è¾‘ã€‚</li>
<li><code>unsafeRowGrouper</code> ï¼š <code>UnsafeRowGrouper</code> =&gt; å®ç°è®°å½•è¡Œ(row)<strong>èšåˆ</strong>é€»è¾‘ã€‚</li>
</ul>
<p><code>DataNodeMergeManager#run(...)</code> é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ul>
<li>[1] å†™å…¥è®°å½•è¡Œ(row)åˆ° <code>UnsafeRow</code>ã€‚</li>
<li>[2] æ ¹æ®æƒ…å†µå°† <code>UnsafeRow</code> æ’å…¥å¯¹åº”ç»„ä»¶ã€‚</li>
<li>[3] å½“æ‰€æœ‰ <code>UnsafeRow</code> æ’å…¥å®Œåï¼Œæ ¹æ®æƒ…å†µä½¿ç”¨ç»„ä»¶èšåˆã€æ’åºã€‚</li>
</ul>
<table>
<thead>
<tr>
<th>æ˜¯å¦æ’åº</th>
<th>æ˜¯å¦èšåˆ</th>
<th>ä¾èµ–ç»„ä»¶</th>
<th>[2]</th>
<th>[3]</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¦</td>
<td>å¦</td>
<td><code>globalSorter</code></td>
<td>æ’å…¥ <code>globalSorter</code></td>
<td>ä½¿ç”¨ <code>globalSorter</code> åˆå¹¶å¹¶æ’åº</td>
</tr>
<tr>
<td>æ˜¯</td>
<td>å¦</td>
<td><code>globalMergeResult</code></td>
<td>æ’å…¥ <code>globalMergeResult</code></td>
<td>ä½¿ç”¨ <code>globalMergeResult</code> åˆå¹¶ä¸æ’åº</td>
</tr>
<tr>
<td>å¦</td>
<td>æ˜¯</td>
<td><code>unsafeRowGrouper</code> + <code>globalSorter</code></td>
<td>æ’å…¥ <code>unsafeRowGrouper</code> è¿›è¡Œèšåˆ</td>
<td>ä½¿ç”¨ <code>globalSorter</code> åˆå¹¶å¹¶æ’åº</td>
</tr>
<tr>
<td>æ˜¯</td>
<td>æ˜¯</td>
<td><code>unsafeRowGrouper</code> + <code>globalMergeResult</code></td>
<td>æ’å…¥ <code>unsafeRowGrouper</code> è¿›è¡Œèšåˆ</td>
<td>ä½¿ç”¨ <code>globalMergeResult</code> åˆå¹¶ä¸æ’åº</td>
</tr>
</tbody>
</table>
<p><strong>æ ¸å¿ƒä»£ç </strong>ï¼š</p>
<ul>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/sqlengine/mpp/DataNodeMergeManager.java" rel="external nofollow noopener noreferrer" target="_blank">DataNodeMergeManager.java</a>ã€‚</li>
</ul>
<p>ğŸ™ƒçœ‹åˆ°è¿™é‡Œï¼Œå¯èƒ½å¾ˆå¤šåŒå­¦éƒ½æœ‰ç‚¹æ‡µé€¼ï¼Œé—®é¢˜ä¸å¤§ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹ç…ã€‚</p>
<h3 id="3-3-UnsafeRow"><a href="#3-3-UnsafeRow" class="headerlink" title="3.3 UnsafeRow"></a>3.3 UnsafeRow</h3><p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/unsafe_row.png" alt="unsafe_row"></p>
<p>è®°å½•è¡Œ(row)å†™åˆ° <code>UnsafeRow</code> çš„ <code>baseObject</code> å±æ€§ï¼Œç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/unsafe_row_object.png" alt="unsafe_row_object"><br><img src="http://www.yunai.me/images/MyCAT/2017_06_13/unsafe_row_2.png" alt="unsafe_row_2.png"></p>
<ul>
<li>æ‹†åˆ†æˆä¸‰ä¸ªåŒºåŸŸï¼Œ<strong>æ¯ä¸ªåŒºåŸŸæŒ‰ç…§æ ¼å­è®°å½•ä¿¡æ¯ï¼Œæ¯ä¸ªæ ¼å­ 64bits(8 Bytes)</strong>ã€‚</li>
<li>è®°å½•è¡Œ(row)æŒ‰ç…§å­—æ®µé¡ºåºä½ç½®è®°å½•åˆ° <code>baseObject</code>ã€‚</li>
<li>[1] ç©ºæ ‡è®°ä½åŒºåŸŸ ï¼šæ ‡è®°å­—æ®µå¯¹åº”çš„å€¼æ˜¯å¦ä¸º NULLã€‚<ul>
<li>å½“å­—æ®µå¯¹åº”çš„å€¼ä¸º NULL æ—¶ï¼Œå…¶å¯¹åº”çš„å­—æ®µé¡ºåºå¯¹åº”çš„ bit è®¾ç½®ä¸º 1ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œç¬¬ 0 ä¸ªä½ç½®å­—æ®µä¸º NULLï¼Œåˆ™ç¬¬ä¸€ä¸ªæ ¼å­å¯¹åº”çš„ 64 bits ä»å³è¾¹ç¬¬ä¸€ä¸ª bit è®¾ç½®ä¸º 1ã€‚</li>
<li>å› ä¸ºæ¯ä¸ªæ ¼å­æ˜¯ 64 bitsï¼Œæ¯ 64 ä¸ªå­—æ®µå ç”¨ä¸€ä¸ªæ ¼å­ï¼Œä¸æ»¡ä¸€ä¸ªæ ¼å­ï¼ŒæŒ‰ç…§ä¸€ä¸ªæ ¼å­è®¡ç®—ã€‚å› æ­¤ï¼Œè¯¥åŒºåŸŸçš„é•¿åº¦(<code>bitSetWidthInBytes</code>) = å­—æ®µå ç”¨çš„æ ¼å­æ•° * 64 bitsã€‚</li>
</ul>
</li>
<li>[2] ä½ç½®é•¿åº¦åŒºåŸŸ ï¼šè®°å½•å­—æ®µå¯¹åº”çš„å€¼åœ¨<code>[3]åŒºåŸŸ</code>æ‰€åœ¨çš„ä½ç½®å’Œé•¿åº¦ã€‚<ul>
<li>æ¯ä¸ªå­—æ®µè®°å½•<code>[2]åŒºåŸŸ</code>çš„ä½ç½® = <code>baseOffset</code> + <code>bitSetWidthInBytes</code> + 8 Bytes * å­—æ®µé¡ºåºã€‚</li>
<li>å ç”¨ä¸€ä¸ªæ ¼å­ï¼Œå‰ 32 bits ä¸º<code>[3]åŒºåŸŸ</code>çš„ä½ç½®ï¼Œå 32 bits ä¸ºå­—æ®µå¯¹åº”çš„å€¼é•¿åº¦ã€‚</li>
</ul>
</li>
<li>[3] å€¼åŒºåŸŸ ï¼šè®°å½•å­—æ®µå¯¹åº”çš„å€¼ã€‚<ul>
<li>æ¯ä¸ªå­—æ®µå¯¹åº”çš„å€¼å ç”¨æ ¼å­æ•° = å­—æ®µå¯¹åº”çš„å€¼é•¿åº¦ / 8 Byteï¼Œå¦‚æœæ— æ³•æ•´é™¤å† + 1ã€‚</li>
<li>å› ä¸ºå­—æ®µå¯¹åº”çš„å€¼å¯èƒ½æ— æ³•åˆšå¥½å æ»¡æ¯ä¸ªæ ¼å­ï¼Œæœªä½¿ç”¨çš„ bit ç”¨ 0 å ä½ã€‚</li>
</ul>
</li>
</ul>
<p><strong>å†™å…¥ <code>UnsafeRow</code>ï¼ŒMyCAT å¯ä»¥é¡ºåºè®¿é—®æ¯ä¸ªå­—æ®µï¼Œè€Œä¸éœ€è¦åœ¨è®°å½•è¡Œ(row)è¿›è¡Œéå†ã€‚</strong>  </p>
<p>ğŸ™ƒæ—¥å¸¸å¼€å‘ä½¿ç”¨ä½æ“ä½œçš„æœºä¼šæ¯”è¾ƒå°‘ï¼Œå¯èƒ½è¾ƒä¸ºéš¾ç†è§£ï¼Œéœ€è¦åå¤ç†è§£ä¸‹ï¼Œç›¸ä¿¡ä¼šè·å¾—å¾ˆå¤§å¯å‘ã€‚æ©ï¼Œè¯¥éƒ¨åˆ†ä»£ç å¼•ç”¨è‡ªå¼€æºè¿ç®—æ¡†æ¶ <code>Spark</code>ï¼Œæ˜¯ä¸æ˜¯æ›´åŠ æœ‰åŠ¨åŠ›åˆ—ğŸ˜ˆã€‚</p>
<p><strong>æ ¸å¿ƒä»£ç </strong>ï¼š</p>
<ul>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/row/UnsafeRow.java" rel="external nofollow noopener noreferrer" target="_blank">UnsafeRow.java</a></li>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/row/BufferHolder.java" rel="external nofollow noopener noreferrer" target="_blank">BufferHolder.java</a></li>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/row/UnsafeRowWriter.java" rel="external nofollow noopener noreferrer" target="_blank">UnsafeRowWriter.java</a></li>
</ul>
<h3 id="3-4-UnsafeExternalRowSorter"><a href="#3-4-UnsafeExternalRowSorter" class="headerlink" title="3.4 UnsafeExternalRowSorter"></a>3.4 UnsafeExternalRowSorter</h3><p>å¦‚æœä½¿ç”¨ Java å®ç° <code>SELECT * FROM student ORDER BY age desc, nickname asc</code>ï¼Œä¸è€ƒè™‘ç®—æ³•ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•å¦‚ä¸‹å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">Collections.sort(students, <span class="keyword">new</span> Comparator&lt;Comparable&gt;() &#123;</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Student o1, Student o2)</span> </span>&#123;</div><div class="line">           <span class="keyword">int</span> cmp = compare(o2.age, o1.age);</div><div class="line">           <span class="keyword">return</span> cmp != <span class="number">0</span> ? cmp : compare(o1.nickname, o2.nickname);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>ä»åŠŸèƒ½ä¸Šï¼Œ<code>UnsafeExternalRowSorter</code> æ˜¯è¿™ä¹ˆå®ç°æ’åºé€»è¾‘ã€‚å½“ç„¶è‚¯å®šçš„æ˜¯ï¼Œä¸æ˜¯è¿™ä¹ˆâ€œç®€å•â€çš„å®ç°ã€‚</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/sorter_write.jpeg" alt="sorter_write"></p>
<p><code>UnsafeRow</code> ä¼šå†™å…¥åˆ°ä¸¤ä¸ªåœ°æ–¹ï¼š</p>
<ol>
<li><code>List&lt;MemoryBlock&gt;</code> ï¼šå†…å­˜å—æ•°ç»„ã€‚å½“å‰ <code>MemoryBlock</code> æ— æ³•å®¹çº³å†™å…¥çš„ <code>UnsafeRow</code> æ—¶ï¼Œç”Ÿæˆæ–°çš„ <code>MemoryBlock</code> æä¾›å†™å…¥ã€‚æ¯æ¡ <code>UnsafeRow</code> å­˜å‚¨åœ¨ <code>MemoryBlock</code> ç”± é•¿åº¦ + å­—èŠ‚å†…å®¹ ç»„æˆã€‚</li>
<li><code>LongArray</code> ï¼šæ¯æ¡ <code>UnsafeRow</code> å­˜å‚¨åœ¨ <code>LongArray</code> ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šaddress + prefixã€‚<ul>
<li><code>address</code> ï¼š<code>UnsafeRow</code> å­˜å‚¨åœ¨ <code>List&lt;MemoryBlock&gt;</code> çš„ä½ç½®ã€‚å‰ 13 bits è®°å½•æ‰€åœ¨ <code>MemoryBlock</code> çš„ indexï¼Œå 51 bit è®°å½•åœ¨ <code>MemoryBlock</code> çš„ offsetã€‚</li>
<li><code>prefix</code> ï¼š<code>UnsafeRow</code> ç¬¬ä¸€ä¸ªæ’åºå­—æ®µ<strong>å€¼</strong>å‰ 64 bits è®¡ç®—çš„å€¼ã€‚</li>
</ul>
</li>
</ol>
<p><strong><code>UnsafeExternalRowSorter</code> æ’åºå®ç°æ–¹å¼</strong> ï¼šæä¾› <strong><a href="http://blog.csdn.net/yangzhongblog/article/details/8184707" rel="external nofollow noopener noreferrer" target="_blank">TimSort</a></strong> å’Œ <strong>RadixSort</strong> ä¸¤ç§æ’åºç®—æ³•ï¼Œå‰è€…ä¸ºé»˜è®¤å®ç°ã€‚<strong>TimSort</strong> æŠ˜åŠæŸ¥æ‰¾æ—¶ï¼Œä½¿ç”¨ <code>LongArray</code>ï¼Œå…ˆæ¯”è¾ƒ <code>prefix</code>ï¼Œè‹¥ç›¸ç­‰ï¼Œåˆ™é¡ºåºå¯¹æ¯”æ¯ä¸ªæ’åºå­—æ®µç›´åˆ°ä¸ç­‰ï¼Œæå‡è®¡ç®—æ•ˆç‡ã€‚æ’å…¥æ“ä½œåœ¨ <code>LongArray</code> æ“ä½œï¼Œ<code>List&lt;MemoryBlock&gt;</code> åªä½œä¸ºåŸå§‹æ•°æ®ã€‚</p>
<p>å¦å¤–ï¼Œå½“éœ€è¦æ’åºç‰¹åˆ«å¤§çš„æ•°æ®é‡æ—¶ï¼Œä¼šä½¿ç”¨å­˜å‚¨æ•°æ®åˆ°æ–‡ä»¶è¿›è¡Œæ’åºã€‚é™äºç¬”è€…æš‚æ—¶æœªé˜…è¯»è¯¥å¤„æºç ï¼Œåç»­ä¼šå¦å¼€æ–‡ç« åˆ†æã€‚ğŸ™‚</p>
<p>æ ¸å¿ƒæºç ï¼š</p>
<ul>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/utils/sort/UnsafeExternalRowSorter.java" rel="external nofollow noopener noreferrer" target="_blank">UnsafeExternalRowSorter.java</a></li>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/utils/sort/UnsafeExternalRowSorter.java" rel="external nofollow noopener noreferrer" target="_blank">UnsafeExternalRowSorter.java</a></li>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/utils/sort/TimSort.java" rel="external nofollow noopener noreferrer" target="_blank">TimSort.java</a></li>
</ul>
<h3 id="3-5-UnsafeRowGrouper"><a href="#3-5-UnsafeRowGrouper" class="headerlink" title="3.5 UnsafeRowGrouper"></a>3.5 UnsafeRowGrouper</h3><p>å¦‚æœä½¿ç”¨ Java å®ç° <code>SELECT nickname, COUNT(*) FROM student group by nickname</code>ï¼Œä¸è€ƒè™‘ç®—æ³•ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•å¦‚ä¸‹å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">Map&lt;String, List&lt;Object&gt;&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"><span class="comment">// èšåˆ</span></div><div class="line"><span class="keyword">for</span> (student : students) &#123;</div><div class="line">    <span class="keyword">if</span> (map.contains(student.nickname)) &#123;</div><div class="line">        map.put(student.nickname, map.get(student.nickname).get(<span class="number">1</span>) + <span class="number">1</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        List&lt;Object&gt; value = <span class="keyword">new</span> Array&lt;&gt;();</div><div class="line">        value.add(nickname);</div><div class="line">        value.add(<span class="number">1</span>);</div><div class="line">        map.put(student.nickname, value);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// è¾“å‡º</span></div><div class="line"><span class="keyword">for</span> (value : map.values) &#123;</div><div class="line">    System.out.println(value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»åŠŸèƒ½ä¸Šï¼Œ<code>UnsafeRowGrouper</code> æ˜¯è¿™ä¹ˆå®ç°æ’åºé€»è¾‘ã€‚å½“ç„¶è‚¯å®šçš„æ˜¯ï¼Œä¹Ÿä¸æ˜¯è¿™ä¹ˆâ€œç®€å•â€çš„å®ç°ã€‚</p>
<p>ğŸ˜ˆå…·ä½“æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿæˆ‘ä»¬åœ¨ã€ŠMyCAT æºç è§£æ â€”â€” åˆ†ç‰‡ç»“æœåˆå¹¶ï¼ˆäºŒï¼‰ã€‹ç»§ç»­åˆ†æã€‚</p>
<h1 id="4-æ•‘æŠ¤ä¸­å¿ƒ"><a href="#4-æ•‘æŠ¤ä¸­å¿ƒ" class="headerlink" title="4. æ•‘æŠ¤ä¸­å¿ƒ"></a>4. æ•‘æŠ¤ä¸­å¿ƒ</h1><p>çœ‹åˆ°æ­¤å¤„çš„åº”è¯¥æ˜¯çœŸçˆ±å§ï¼Ÿï¼å¦‚æœå†…å®¹ä¸Šæœ‰ä»€ä¹ˆé”™è¯¯æˆ–è€…éš¾æ‡‚çš„åœ°æ–¹ï¼Œå¯ä»¥å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ç»™æˆ‘ç•™è¨€ï¼Œæˆ‘ä¼šå¾ˆè®¤çœŸçš„é€æ¡è§£ç­”çš„ã€‚â€œä¸‡ä¸€â€è§‰å¾—æœ¬æ–‡è¿˜å¯ä»¥ï¼Œå¸Œæœ›è½¬å‘åˆ°æœ‹å‹åœˆè®©æ›´å¤šçš„äººçœ‹åˆ°ã€‚</p>
<p>æœ€åçš„æœ€åï¼Œæ„Ÿè°¢è€å¿ƒé˜…è¯»æœ¬æ–‡çš„åŒå­¦ã€‚</p>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt="wechat_mp"></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/strong
    
    </summary>
    
      <category term="MyCAT" scheme="http://www.yunai.me/categories/MyCAT/"/>
    
    
  </entry>
  
  <entry>
    <title>MyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢</title>
    <link href="http://www.yunai.me/MyCAT/single-db-single-table-select/"/>
    <id>http://www.yunai.me/MyCAT/single-db-single-table-select/</id>
    <published>2017-05-29T16:00:00.000Z</published>
    <updated>2017-07-31T12:30:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL</a></li>
<li><a href="#">3. è·å¾—è·¯ç”±ç»“æœ</a></li>
<li><a href="#">4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL</a></li>
<li><a href="#">5. å“åº”æ‰§è¡Œ SQL ç»“æœ</a></li>
<li><a href="#">6. å…¶ä»– ï¼šæ›´æ–° / åˆ é™¤</a></li>
</ul>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><blockquote>
<p>å†…å®¹å½¢æ€ä»¥ é¡ºåºå›¾ + æ ¸å¿ƒä»£ç  ä¸ºä¸»ã€‚<br>å¦‚æœæœ‰åœ°æ–¹è¡¨è¿°ä¸é”™è¯¯æˆ–è€…ä¸æ¸…æ™°ï¼Œæ¬¢è¿ç•™è¨€ã€‚<br>å¯¹äºå†…å®¹å½¢æ€ï¼Œéå¸¸çº ç»“ï¼Œå¦‚æœæœ‰å»ºè®®ï¼Œç‰¹åˆ«ç‰¹åˆ«ç‰¹åˆ«æ¬¢è¿æ‚¨æå‡ºã€‚<br>å¾®ä¿¡å·ï¼šwangwenbin-serverã€‚</p>
</blockquote>
<p>æœ¬æ–‡è®²è§£ ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ æ‰€æ¶‰åŠåˆ°çš„ä»£ç ã€‚</p>
<p>ğŸ˜‚å†…å®¹å’Œ <a href="http://www.yunai.me/Mycat/single-db-single-table-insert/">ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹</a> è¶…çº§ç›¸ä¼¼ï¼Œä¸€æ–¹é¢æœ¬èº«æµç¨‹åŸºæœ¬ç›¸åŒï¼Œå¦å¤–ä¸€æ–¹é¢æ–‡ç« ç»“æ„æ²¡æ‹†åˆ†å¥½ã€‚æˆ‘ä»¬ä½¿ç”¨ ğŸš€ æ ‡è®°å·®å¼‚çš„é€»è¾‘ã€‚</p>
<p>äº¤äº’å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_05_30/01.png" alt="å•åº“å•è¡¨æŸ¥è¯¢ç®€å›¾"></p>
<p>æ•´ä¸ªè¿‡ç¨‹ï¼ŒMyCAT Server æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ¥æ”¶ MySQL Client è¯·æ±‚ï¼Œè§£æ SQLã€‚</li>
<li>è·å¾—è·¯ç”±ç»“æœï¼Œè¿›è¡Œè·¯ç”±ã€‚</li>
<li>è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQLã€‚</li>
<li>å“åº”æ‰§è¡Œç»“æœï¼Œå‘é€ç»“æœç»™ MySQL Clientã€‚</li>
</ol>
<p>æˆ‘ä»¬é€ä¸ªæ­¥éª¤åˆ†æï¼Œä¸€èµ·æ¥çœ‹çœ‹æºç ã€‚</p>
<h1 id="2-æ¥æ”¶è¯·æ±‚ï¼Œè§£æ-SQL"><a href="#2-æ¥æ”¶è¯·æ±‚ï¼Œè§£æ-SQL" class="headerlink" title="2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL"></a>2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL</h1><p><img src="http://www.yunai.me/images/MyCAT/2017_05_30/02.png" alt="ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ01ä¸»æµç¨‹ï¼‰"></p>
<h2 id="ã€1-2ã€‘"><a href="#ã€1-2ã€‘" class="headerlink" title="ã€1 - 2ã€‘"></a>ã€1 - 2ã€‘</h2><p>æ¥æ”¶<strong>ä¸€æ¡</strong> MySQL å‘½ä»¤ã€‚åœ¨ã€1ã€‘ä¹‹å‰ï¼Œè¿˜æœ‰è¯·æ±‚æ•°æ®è¯»å–ã€æ‹†æˆå•æ¡ MySQL SQLã€‚</p>
<h2 id="ã€3ã€‘"><a href="#ã€3ã€‘" class="headerlink" title="ã€3ã€‘"></a>ã€3ã€‘</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendCommandHandler.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FrontendCommandHandler</span> <span class="keyword">implements</span> <span class="title">NIOHandler</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</div><div class="line"> <span class="number">6</span>:     </div><div class="line"> <span class="number">7</span>:         <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">switch</span> (data[<span class="number">4</span>]) <span class="comment">// </span></div><div class="line"> <span class="number">9</span>:         &#123;</div><div class="line"><span class="number">10</span>:             <span class="keyword">case</span> MySQLPacket.COM_INIT_DB:</div><div class="line"><span class="number">11</span>:                 commands.doInitDB();</div><div class="line"><span class="number">12</span>:                 source.initDB(data);</div><div class="line"><span class="number">13</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">14</span>:             <span class="keyword">case</span> MySQLPacket.COM_QUERY: <span class="comment">// æŸ¥è¯¢å‘½ä»¤</span></div><div class="line"><span class="number">15</span>:                 <span class="comment">// è®¡æ•°æŸ¥è¯¢å‘½ä»¤</span></div><div class="line"><span class="number">16</span>:                 commands.doQuery();</div><div class="line"><span class="number">17</span>:                 <span class="comment">// æ‰§è¡ŒæŸ¥è¯¢å‘½ä»¤</span></div><div class="line"><span class="number">18</span>:                 source.query(data);</div><div class="line"><span class="number">19</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">20</span>:             <span class="keyword">case</span> MySQLPacket.COM_PING:</div><div class="line"><span class="number">21</span>:                 commands.doPing();</div><div class="line"><span class="number">22</span>:                 source.ping();</div><div class="line"><span class="number">23</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">24</span>:             <span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>:     &#125;</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>: &#125;</div></pre></td></tr></table></figure>
<p><code>INSERT</code>/<code>SELECT</code>/<code>UPDATE</code>/<code>DELETE</code> ç­‰ SQL å½’å±äº <code>MySQLPacket.COM_QUERY</code>ï¼Œè¯¦ç»†å¯è§ï¼š<a href="http://hutaow.com/blog/2013/11/06/mysql-protocol-analysis/#42-" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMySQLåè®®åˆ†æ#4.2 å®¢æˆ·ç«¯å‘½ä»¤è¯·æ±‚æŠ¥æ–‡ï¼ˆå®¢æˆ·ç«¯ -&gt; æœåŠ¡å™¨ï¼‰ã€‹</a>ã€‚</p>
<h2 id="ã€4ã€‘"><a href="#ã€4ã€‘" class="headerlink" title="ã€4ã€‘"></a>ã€4ã€‘</h2><p>å°† äºŒè¿›åˆ¶æ•°ç»„ è§£ææˆ SQLã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendConnection.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: 	<span class="comment">// å–å¾—è¯­å¥</span></div><div class="line"> <span class="number">4</span>: 	String sql = <span class="keyword">null</span>;		</div><div class="line"> <span class="number">5</span>: 	<span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>: 		MySQLMessage mm = <span class="keyword">new</span> MySQLMessage(data);</div><div class="line"> <span class="number">7</span>: 		mm.position(<span class="number">5</span>);</div><div class="line"> <span class="number">8</span>: 		sql = mm.readString(charset);</div><div class="line"> <span class="number">9</span>: 	&#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line"><span class="number">10</span>: 		writeErrMessage(ErrorCode.ER_UNKNOWN_CHARACTER_SET, <span class="string">"Unknown charset '"</span> + charset + <span class="string">"'"</span>);</div><div class="line"><span class="number">11</span>: 		<span class="keyword">return</span>;</div><div class="line"><span class="number">12</span>: 	&#125;		</div><div class="line"><span class="number">13</span>: 	<span class="comment">// æ‰§è¡Œè¯­å¥</span></div><div class="line"><span class="number">14</span>: 	<span class="keyword">this</span>.query( sql );</div><div class="line"><span class="number">15</span>: &#125;</div></pre></td></tr></table></figure>
<h2 id="ã€5ã€‘"><a href="#ã€5ã€‘" class="headerlink" title="ã€5ã€‘"></a>ã€5ã€‘</h2><p>è§£æ SQL ç±»å‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerQueryHandler.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">3</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">(String sql)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>: 	<span class="comment">// è§£æ SQL ç±»å‹</span></div><div class="line"> <span class="number">5</span>: 	<span class="keyword">int</span> rs = ServerParse.parse(sql);</div><div class="line"> <span class="number">6</span>: 	<span class="keyword">int</span> sqlType = rs &amp; <span class="number">0xff</span>;</div><div class="line"> <span class="number">7</span>: 	</div><div class="line"> <span class="number">8</span>: 	<span class="keyword">switch</span> (sqlType) &#123;</div><div class="line"> <span class="number">9</span>: 	<span class="comment">//explain sql</span></div><div class="line"><span class="number">10</span>: 	<span class="keyword">case</span> ServerParse.EXPLAIN:</div><div class="line"><span class="number">11</span>: 		ExplainHandler.handle(sql, c, rs &gt;&gt;&gt; <span class="number">8</span>);</div><div class="line"><span class="number">12</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">13</span>: 	<span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">14</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">15</span>: 	<span class="keyword">case</span> ServerParse.SELECT:</div><div class="line"><span class="number">16</span>: 		SelectHandler.handle(sql, c, rs &gt;&gt;&gt; <span class="number">8</span>);</div><div class="line"><span class="number">17</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">18</span>: 	<span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">19</span>: 	<span class="keyword">default</span>:</div><div class="line"><span class="number">20</span>: 		<span class="keyword">if</span>(readOnly)&#123;</div><div class="line"><span class="number">21</span>: 			LOGGER.warn(<span class="keyword">new</span> StringBuilder().append(<span class="string">"User readonly:"</span>).append(sql).toString());</div><div class="line"><span class="number">22</span>: 			c.writeErrMessage(ErrorCode.ER_USER_READ_ONLY, <span class="string">"User readonly"</span>);</div><div class="line"><span class="number">23</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">24</span>: 		&#125;</div><div class="line"><span class="number">25</span>: 		c.execute(sql, rs &amp; <span class="number">0xff</span>);</div><div class="line"><span class="number">26</span>: 	&#125;</div><div class="line"><span class="number">27</span>: &#125;</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>:</div><div class="line"><span class="number">30</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerParse.javaã€‘</span></div><div class="line"><span class="number">31</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">parse</span><span class="params">(String stmt)</span> </span>&#123;</div><div class="line"><span class="number">32</span>: 	<span class="keyword">int</span> length = stmt.length();</div><div class="line"><span class="number">33</span>: 	<span class="comment">//FIX BUG FOR SQL SUCH AS /XXXX/SQL</span></div><div class="line"><span class="number">34</span>: 	<span class="keyword">int</span> rt = -<span class="number">1</span>;</div><div class="line"><span class="number">35</span>: 	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</div><div class="line"><span class="number">36</span>: 		<span class="keyword">switch</span> (stmt.charAt(i)) &#123;</div><div class="line"><span class="number">37</span>: 		<span class="comment">// .... çœç•¥éƒ¨åˆ†case			case 'I':</span></div><div class="line"><span class="number">38</span>: 		<span class="keyword">case</span> <span class="string">'i'</span>:</div><div class="line"><span class="number">39</span>: 			rt = insertCheck(stmt, i);</div><div class="line"><span class="number">40</span>: 			<span class="keyword">if</span> (rt != OTHER) &#123;</div><div class="line"><span class="number">41</span>: 				<span class="keyword">return</span> rt;</div><div class="line"><span class="number">42</span>: 			&#125;</div><div class="line"><span class="number">43</span>: 			<span class="keyword">continue</span>;</div><div class="line"><span class="number">44</span>: 			<span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">45</span>: 		<span class="keyword">case</span> <span class="string">'S'</span>:</div><div class="line"><span class="number">46</span>: 		<span class="keyword">case</span> <span class="string">'s'</span>:</div><div class="line"><span class="number">47</span>: 			rt = sCheck(stmt, i);</div><div class="line"><span class="number">48</span>: 			<span class="keyword">if</span> (rt != OTHER) &#123;</div><div class="line"><span class="number">49</span>: 				<span class="keyword">return</span> rt;</div><div class="line"><span class="number">50</span>: 			&#125;</div><div class="line"><span class="number">51</span>: 			<span class="keyword">continue</span>;</div><div class="line"><span class="number">52</span>: 			<span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">53</span>: 		<span class="keyword">default</span>:</div><div class="line"><span class="number">54</span>: 			<span class="keyword">continue</span>;</div><div class="line"><span class="number">55</span>: 		&#125;</div><div class="line"><span class="number">56</span>: 	&#125;</div><div class="line"><span class="number">57</span>: 	<span class="keyword">return</span> OTHER;</div><div class="line"><span class="number">58</span>: &#125;</div></pre></td></tr></table></figure>
<h2 id="ğŸš€ã€6ã€‘ã€7ã€‘"><a href="#ğŸš€ã€6ã€‘ã€7ã€‘" class="headerlink" title="ğŸš€ã€6ã€‘ã€7ã€‘"></a>ğŸš€ã€6ã€‘ã€7ã€‘</h2><p>è§£æ Select SQL ç±»å‹ï¼Œåˆ†å‘åˆ°å¯¹åº”çš„é€»è¾‘ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€SelectHandler.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String stmt, ServerConnection c, <span class="keyword">int</span> offs)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: 	<span class="keyword">int</span> offset = offs;</div><div class="line"> <span class="number">4</span>: 	<span class="keyword">switch</span> (ServerParseSelect.parse(stmt, offs)) &#123; <span class="comment">// è§£æ Select SQL ç±»å‹</span></div><div class="line"> <span class="number">5</span>: 	<span class="keyword">case</span> ServerParseSelect.VERSION_COMMENT: <span class="comment">// select @@VERSION_COMMENT;</span></div><div class="line"> <span class="number">6</span>: 		SelectVersionComment.response(c);</div><div class="line"> <span class="number">7</span>: 		<span class="keyword">break</span>;</div><div class="line"> <span class="number">8</span>: 	<span class="keyword">case</span> ServerParseSelect.DATABASE: <span class="comment">// select DATABASE();</span></div><div class="line"> <span class="number">9</span>: 		SelectDatabase.response(c);</div><div class="line"><span class="number">10</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">11</span>: 	<span class="keyword">case</span> ServerParseSelect.USER: <span class="comment">// select CURRENT_USER();</span></div><div class="line"><span class="number">12</span>:         SelectUser.response(c);</div><div class="line"><span class="number">13</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">14</span>: 	<span class="keyword">case</span> ServerParseSelect.VERSION: <span class="comment">// select VERSION();</span></div><div class="line"><span class="number">15</span>: 		SelectVersion.response(c);</div><div class="line"><span class="number">16</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">17</span>: 	<span class="keyword">case</span> ServerParseSelect.SESSION_INCREMENT: <span class="comment">// select @@session.auto_increment_increment;</span></div><div class="line"><span class="number">18</span>: 		SessionIncrement.response(c);</div><div class="line"><span class="number">19</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">20</span>: 	<span class="keyword">case</span> ServerParseSelect.SESSION_ISOLATION: <span class="comment">// select @@session.tx_isolation;</span></div><div class="line"><span class="number">21</span>: 		SessionIsolation.response(c);</div><div class="line"><span class="number">22</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">23</span>: 	<span class="keyword">case</span> ServerParseSelect.LAST_INSERT_ID: <span class="comment">// select LAST_INSERT_ID();</span></div><div class="line"><span class="number">24</span>: 		<span class="comment">// ....çœç•¥ä»£ç </span></div><div class="line"><span class="number">25</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">26</span>: 	<span class="keyword">case</span> ServerParseSelect.IDENTITY: <span class="comment">// select @@identity</span></div><div class="line"><span class="number">27</span>: 		<span class="comment">// ....çœç•¥ä»£ç </span></div><div class="line"><span class="number">28</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">29</span>:     <span class="keyword">case</span> ServerParseSelect.SELECT_VAR_ALL: <span class="comment">//</span></div><div class="line"><span class="number">30</span>:         SelectVariables.execute(c,stmt);</div><div class="line"><span class="number">31</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">32</span>:     <span class="keyword">case</span> ServerParseSelect.SESSION_TX_READ_ONLY: <span class="comment">//</span></div><div class="line"><span class="number">33</span>:         SelectTxReadOnly.response(c);</div><div class="line"><span class="number">34</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">35</span>: 	<span class="keyword">default</span>: <span class="comment">// å…¶ä»–ï¼Œä¾‹å¦‚ select * from table</span></div><div class="line"><span class="number">36</span>: 		c.execute(stmt, ServerParse.SELECT);</div><div class="line"><span class="number">37</span>: 	&#125;</div><div class="line"><span class="number">38</span>: &#125;</div><div class="line"><span class="number">39</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerParseSelect.javaã€‘</span></div><div class="line"><span class="number">40</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">parse</span><span class="params">(String stmt, <span class="keyword">int</span> offset)</span> </span>&#123;</div><div class="line"><span class="number">41</span>: 	<span class="keyword">int</span> i = offset;</div><div class="line"><span class="number">42</span>: 	<span class="keyword">for</span> (; i &lt; stmt.length(); ++i) &#123;</div><div class="line"><span class="number">43</span>: 		<span class="keyword">switch</span> (stmt.charAt(i)) &#123;</div><div class="line"><span class="number">44</span>: 		<span class="keyword">case</span> <span class="string">' '</span>:</div><div class="line"><span class="number">45</span>: 			<span class="keyword">continue</span>;</div><div class="line"><span class="number">46</span>: 		<span class="keyword">case</span> <span class="string">'/'</span>:</div><div class="line"><span class="number">47</span>: 		<span class="keyword">case</span> <span class="string">'#'</span>:</div><div class="line"><span class="number">48</span>: 			i = ParseUtil.comment(stmt, i);</div><div class="line"><span class="number">49</span>: 			<span class="keyword">continue</span>;</div><div class="line"><span class="number">50</span>: 		<span class="keyword">case</span> <span class="string">'@'</span>:</div><div class="line"><span class="number">51</span>: 			<span class="keyword">return</span> select2Check(stmt, i);</div><div class="line"><span class="number">52</span>: 		<span class="keyword">case</span> <span class="string">'D'</span>:</div><div class="line"><span class="number">53</span>: 		<span class="keyword">case</span> <span class="string">'d'</span>:</div><div class="line"><span class="number">54</span>: 			<span class="keyword">return</span> databaseCheck(stmt, i);</div><div class="line"><span class="number">55</span>: 		<span class="keyword">case</span> <span class="string">'L'</span>:</div><div class="line"><span class="number">56</span>: 		<span class="keyword">case</span> <span class="string">'l'</span>:</div><div class="line"><span class="number">57</span>: 			<span class="keyword">return</span> lastInsertCheck(stmt, i);</div><div class="line"><span class="number">58</span>: 		<span class="keyword">case</span> <span class="string">'U'</span>:</div><div class="line"><span class="number">59</span>: 		<span class="keyword">case</span> <span class="string">'u'</span>:</div><div class="line"><span class="number">60</span>: 			<span class="keyword">return</span> userCheck(stmt, i);</div><div class="line"><span class="number">61</span>: 		<span class="keyword">case</span> <span class="string">'C'</span>:</div><div class="line"><span class="number">62</span>: 		<span class="keyword">case</span> <span class="string">'c'</span>:</div><div class="line"><span class="number">63</span>: 			<span class="keyword">return</span> currentUserCheck(stmt, i);</div><div class="line"><span class="number">64</span>: 		<span class="keyword">case</span> <span class="string">'V'</span>:</div><div class="line"><span class="number">65</span>: 		<span class="keyword">case</span> <span class="string">'v'</span>:</div><div class="line"><span class="number">66</span>: 			<span class="keyword">return</span> versionCheck(stmt, i);</div><div class="line"><span class="number">67</span>: 		<span class="keyword">default</span>:</div><div class="line"><span class="number">68</span>: 			<span class="keyword">return</span> OTHER;</div><div class="line"><span class="number">69</span>: 		&#125;</div><div class="line"><span class="number">70</span>: 	&#125;</div><div class="line"><span class="number">71</span>: 	<span class="keyword">return</span> OTHER;</div><div class="line"><span class="number">72</span>: &#125;</div></pre></td></tr></table></figure>
<h2 id="ã€8ã€‘"><a href="#ã€8ã€‘" class="headerlink" title="ã€8ã€‘"></a>ã€8ã€‘</h2><p>æ‰§è¡Œ SQLï¼Œè¯¦ç»†è§£æè§ä¸‹æ–‡ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerConnection.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerConnection</span> <span class="keyword">extends</span> <span class="title">FrontendConnection</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: 	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(String sql, <span class="keyword">int</span> type)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>: 		<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"> <span class="number">5</span>: 		SchemaConfig schema = MycatServer.getInstance().getConfig().getSchemas().get(db);</div><div class="line"> <span class="number">6</span>: 		<span class="keyword">if</span> (schema == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">7</span>: 			writeErrMessage(ErrorCode.ERR_BAD_LOGICDB,</div><div class="line"> <span class="number">8</span>: 					<span class="string">"Unknown MyCAT Database '"</span> + db + <span class="string">"'"</span>);</div><div class="line"> <span class="number">9</span>: 			<span class="keyword">return</span>;</div><div class="line"><span class="number">10</span>: 		&#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: 		<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>: 		<span class="comment">// è·¯ç”±åˆ°åç«¯æ•°æ®åº“ï¼Œæ‰§è¡Œ SQL</span></div><div class="line"><span class="number">15</span>: 		routeEndExecuteSQL(sql, type, schema);</div><div class="line"><span class="number">16</span>: 	&#125;</div><div class="line"><span class="number">17</span>: 	</div><div class="line"><span class="number">18</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">routeEndExecuteSQL</span><span class="params">(String sql, <span class="keyword">final</span> <span class="keyword">int</span> type, <span class="keyword">final</span> SchemaConfig schema)</span> </span>&#123;</div><div class="line"><span class="number">19</span>: 		<span class="comment">// è·¯ç”±è®¡ç®—</span></div><div class="line"><span class="number">20</span>: 		RouteResultset rrs = <span class="keyword">null</span>;</div><div class="line"><span class="number">21</span>: 		<span class="keyword">try</span> &#123;</div><div class="line"><span class="number">22</span>: 			rrs = MycatServer</div><div class="line"><span class="number">23</span>: 					.getInstance()</div><div class="line"><span class="number">24</span>: 					.getRouterservice()</div><div class="line"><span class="number">25</span>: 					.route(MycatServer.getInstance().getConfig().getSystem(),</div><div class="line"><span class="number">26</span>: 							schema, type, sql, <span class="keyword">this</span>.charset, <span class="keyword">this</span>);</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>: 		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">29</span>: 			StringBuilder s = <span class="keyword">new</span> StringBuilder();</div><div class="line"><span class="number">30</span>: 			LOGGER.warn(s.append(<span class="keyword">this</span>).append(sql).toString() + <span class="string">" err:"</span> + e.toString(),e);</div><div class="line"><span class="number">31</span>: 			String msg = e.getMessage();</div><div class="line"><span class="number">32</span>: 			writeErrMessage(ErrorCode.ER_PARSE_ERROR, msg == <span class="keyword">null</span> ? e.getClass().getSimpleName() : msg);</div><div class="line"><span class="number">33</span>: 			<span class="keyword">return</span>;</div><div class="line"><span class="number">34</span>: 		&#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>: 		<span class="comment">// æ‰§è¡Œ SQL</span></div><div class="line"><span class="number">37</span>: 		<span class="keyword">if</span> (rrs != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">38</span>: 			<span class="comment">// sessionæ‰§è¡Œ</span></div><div class="line"><span class="number">39</span>: 			session.execute(rrs, rrs.isSelectForUpdate() ? ServerParse.UPDATE : type);</div><div class="line"><span class="number">40</span>: 		&#125;</div><div class="line"><span class="number">41</span>: 		</div><div class="line"><span class="number">42</span>:  	&#125;</div><div class="line"><span class="number">43</span>: </div><div class="line"><span class="number">44</span>: &#125;</div></pre></td></tr></table></figure>
<h1 id="3-è·å¾—è·¯ç”±ç»“æœ"><a href="#3-è·å¾—è·¯ç”±ç»“æœ" class="headerlink" title="3. è·å¾—è·¯ç”±ç»“æœ"></a>3. è·å¾—è·¯ç”±ç»“æœ</h1><p><img src="http://www.yunai.me/images/MyCAT/2017_05_30/03.png" alt="ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ02è·å–è·¯ç”±ï¼‰"></p>
<h2 id="ã€-1-5-ã€‘"><a href="#ã€-1-5-ã€‘" class="headerlink" title="ã€ 1 -  5 ã€‘"></a>ã€ 1 -  5 ã€‘</h2><p>è·å¾—è·¯ç”±ä¸»æµç¨‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€SelectHandler.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> RouteResultset <span class="title">route</span><span class="params">(SystemConfig sysconf, SchemaConfig schema,</span></span></div><div class="line"> <span class="number">3</span>: 		<span class="keyword">int</span> sqlType, String stmt, String charset, ServerConnection sc)</div><div class="line"> 4: 		<span class="keyword">throws</span> SQLNonTransientException &#123;</div><div class="line"> <span class="number">5</span>: 	RouteResultset rrs = <span class="keyword">null</span>;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>: 	<span class="comment">// SELECT ç±»å‹çš„SQL, æ£€æµ‹ç¼“å­˜æ˜¯å¦å­˜åœ¨</span></div><div class="line"> <span class="number">8</span>: 	<span class="keyword">if</span> (sqlType == ServerParse.SELECT) &#123;</div><div class="line"> <span class="number">9</span>: 		cacheKey = schema.getName() + stmt;			</div><div class="line"><span class="number">10</span>: 		rrs = (RouteResultset) sqlRouteCache.get(cacheKey);</div><div class="line"><span class="number">11</span>: 		<span class="keyword">if</span> (rrs != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">12</span>: 			checkMigrateRule(schema.getName(),rrs,sqlType);</div><div class="line"><span class="number">13</span>: 			<span class="keyword">return</span> rrs;</div><div class="line"><span class="number">14</span>: 			&#125;</div><div class="line"><span class="number">15</span>: 		&#125;</div><div class="line"><span class="number">16</span>: 	&#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>: 	<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"><span class="number">19</span>: 	<span class="keyword">int</span> hintLength = RouteService.isHintSql(stmt);</div><div class="line"><span class="number">20</span>: 	<span class="keyword">if</span>(hintLength != -<span class="number">1</span>)&#123; <span class="comment">// TODO å¾…è¯»ï¼šhint</span></div><div class="line"><span class="number">21</span>: 		<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"><span class="number">22</span>: 		&#125;</div><div class="line"><span class="number">23</span>: 	&#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">24</span>: 		stmt = stmt.trim();</div><div class="line"><span class="number">25</span>: 		rrs = RouteStrategyFactory.getRouteStrategy().route(sysconf, schema, sqlType, stmt,</div><div class="line"><span class="number">26</span>: 				charset, sc, tableId2DataNodeCache);</div><div class="line"><span class="number">27</span>: 	&#125;</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>: 	<span class="comment">// è®°å½•æŸ¥è¯¢å‘½ä»¤è·¯ç”±ç»“æœç¼“å­˜</span></div><div class="line"><span class="number">30</span>: 	<span class="keyword">if</span> (rrs != <span class="keyword">null</span> &amp;&amp; sqlType == ServerParse.SELECT &amp;&amp; rrs.isCacheAble()) &#123;</div><div class="line"><span class="number">31</span>: 		sqlRouteCache.putIfAbsent(cacheKey, rrs);</div><div class="line"><span class="number">32</span>: 	&#125;</div><div class="line"><span class="number">33</span>: 	<span class="comment">// .... çœç•¥ä»£ç 		return rrs;</span></div><div class="line"><span class="number">34</span>: &#125;</div><div class="line"><span class="number">35</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘</span></div><div class="line"><span class="number">36</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">37</span>: <span class="function"><span class="keyword">public</span> RouteResultset <span class="title">route</span><span class="params">(SystemConfig sysConfig, SchemaConfig schema, <span class="keyword">int</span> sqlType, String origSQL,</span></span></div><div class="line"><span class="number">38</span>: 		String charset, ServerConnection sc, LayerCachePool cachePool) <span class="keyword">throws</span> SQLNonTransientException &#123;</div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>: 	<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"><span class="number">41</span>: </div><div class="line"><span class="number">42</span>: 	<span class="comment">// å¤„ç†ä¸€äº›è·¯ç”±ä¹‹å‰çš„é€»è¾‘;å…¨å±€åºåˆ—å·ï¼Œçˆ¶å­è¡¨æ’å…¥</span></div><div class="line"><span class="number">43</span>: 	<span class="keyword">if</span> (beforeRouteProcess(schema, sqlType, origSQL, sc) ) &#123;</div><div class="line"><span class="number">44</span>: 		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">45</span>: 	&#125;</div><div class="line"><span class="number">46</span>: </div><div class="line"><span class="number">47</span>: 	<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"><span class="number">48</span>: </div><div class="line"><span class="number">49</span>: 	<span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰åˆ†ç‰‡</span></div><div class="line"><span class="number">50</span>: 	<span class="keyword">if</span> (schema.isNoSharding() &amp;&amp; ServerParse.SHOW != sqlType) &#123;</div><div class="line"><span class="number">51</span>: 		rrs = RouterUtil.routeToSingleNode(rrs, schema.getDataNode(), stmt);</div><div class="line"><span class="number">52</span>: 	&#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">53</span>: 		RouteResultset returnedSet = routeSystemInfo(schema, sqlType, stmt, rrs);</div><div class="line"><span class="number">54</span>: 		<span class="keyword">if</span> (returnedSet == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">55</span>: 			rrs = routeNormalSqlWithAST(schema, stmt, rrs, charset, cachePool,sqlType,sc);</div><div class="line"><span class="number">56</span>: 		&#125;</div><div class="line"><span class="number">57</span>: 	&#125;</div><div class="line"><span class="number">58</span>: </div><div class="line"><span class="number">59</span>: 	<span class="keyword">return</span> rrs;</div><div class="line"><span class="number">60</span>: &#125;</div></pre></td></tr></table></figure>
<p>ğŸš€ã€3ã€‘ç¬¬ 7 è‡³ 16 è¡Œ ï¼šå½“ Select SQL å­˜åœ¨è·¯ç”±ç»“æœç¼“å­˜æ—¶ï¼Œç›´æ¥è¿”å›ç¼“å­˜ã€‚<br>ğŸš€ã€6ã€‘ç¬¬ 29 è‡³ 32 è¡Œ ï¼šè®°å½• Select SQL è·¯ç”±ç»“æœåˆ°ç¼“å­˜ã€‚</p>
<p><em><strong>è·¯ç”±</strong> è¯¦ç»†è§£æï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ï¼Œé¿å…å†…å®¹è¿‡å¤šï¼Œå½±å“å¤§å®¶å¯¹ã€æ’å…¥ã€‘æµç¨‹å’Œé€»è¾‘çš„ç†è§£ã€‚</em></p>
<h1 id="4-è·å¾—-MySQL-è¿æ¥ï¼Œæ‰§è¡Œ-SQL"><a href="#4-è·å¾—-MySQL-è¿æ¥ï¼Œæ‰§è¡Œ-SQL" class="headerlink" title="4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL"></a>4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL</h1><p><img src="http://www.yunai.me/images/MyCAT/2017_05_29/03.png" alt="ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ03æ‰§è¡Œ SQLï¼‰"></p>
<h2 id="ã€-1-8-ã€‘"><a href="#ã€-1-8-ã€‘" class="headerlink" title="ã€ 1 - 8 ã€‘"></a>ã€ 1 - 8 ã€‘</h2><p>è·å¾— MySQL è¿æ¥ã€‚</p>
<ul>
<li>PhysicalDBNode ï¼šç‰©ç†æ•°æ®åº“èŠ‚ç‚¹ã€‚</li>
<li>PhysicalDatasource ï¼šç‰©ç†æ•°æ®åº“æ•°æ®æºã€‚</li>
</ul>
<h2 id="ã€-9-13-ã€‘"><a href="#ã€-9-13-ã€‘" class="headerlink" title="ã€ 9 - 13 ã€‘"></a>ã€ 9 - 13 ã€‘</h2><p>å‘é€ SQL åˆ° MySQL Serverï¼Œæ‰§è¡Œ SQLã€‚</p>
<h1 id="ğŸš€-5-å“åº”æ‰§è¡Œ-SQL-ç»“æœ"><a href="#ğŸš€-5-å“åº”æ‰§è¡Œ-SQL-ç»“æœ" class="headerlink" title="ğŸš€ 5. å“åº”æ‰§è¡Œ SQL ç»“æœ"></a>ğŸš€ 5. å“åº”æ‰§è¡Œ SQL ç»“æœ</h1><p><img src="http://www.yunai.me/images/MyCAT/2017_05_30/04.png" alt="ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰"></p>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MySQLConnectionHandler.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">3</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">handleData</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>: 	<span class="keyword">switch</span> (resultStatus) &#123;</div><div class="line"> <span class="number">5</span>: 	<span class="keyword">case</span> RESULT_STATUS_INIT:</div><div class="line"> <span class="number">6</span>: 		<span class="keyword">switch</span> (data[<span class="number">4</span>]) &#123;</div><div class="line"> <span class="number">7</span>: 		<span class="keyword">case</span> OkPacket.FIELD_COUNT:</div><div class="line"> <span class="number">8</span>: 			handleOkPacket(data);</div><div class="line"> <span class="number">9</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">10</span>: 		<span class="keyword">case</span> ErrorPacket.FIELD_COUNT:</div><div class="line"><span class="number">11</span>: 			handleErrorPacket(data);</div><div class="line"><span class="number">12</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">13</span>: 		<span class="keyword">case</span> RequestFilePacket.FIELD_COUNT:</div><div class="line"><span class="number">14</span>: 			handleRequestPacket(data);</div><div class="line"><span class="number">15</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">16</span>: 		<span class="keyword">default</span>: <span class="comment">// åˆå§‹åŒ– header fields</span></div><div class="line"><span class="number">17</span>: 			resultStatus = RESULT_STATUS_HEADER;</div><div class="line"><span class="number">18</span>: 			header = data;</div><div class="line"><span class="number">19</span>: 			fields = <span class="keyword">new</span> ArrayList&lt;<span class="keyword">byte</span>[]&gt;((<span class="keyword">int</span>) ByteUtil.readLength(data,</div><div class="line"><span class="number">20</span>: 					<span class="number">4</span>));</div><div class="line"><span class="number">21</span>: 		&#125;</div><div class="line"><span class="number">22</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">23</span>: 	<span class="keyword">case</span> RESULT_STATUS_HEADER:</div><div class="line"><span class="number">24</span>: 		<span class="keyword">switch</span> (data[<span class="number">4</span>]) &#123;</div><div class="line"><span class="number">25</span>: 		<span class="keyword">case</span> ErrorPacket.FIELD_COUNT:</div><div class="line"><span class="number">26</span>: 			resultStatus = RESULT_STATUS_INIT;</div><div class="line"><span class="number">27</span>: 			handleErrorPacket(data);</div><div class="line"><span class="number">28</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">29</span>: 		<span class="keyword">case</span> EOFPacket.FIELD_COUNT: <span class="comment">// è§£æ fields ç»“æŸ</span></div><div class="line"><span class="number">30</span>: 			resultStatus = RESULT_STATUS_FIELD_EOF;</div><div class="line"><span class="number">31</span>: 			handleFieldEofPacket(data);</div><div class="line"><span class="number">32</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">33</span>: 		<span class="keyword">default</span>: <span class="comment">// è§£æ fields</span></div><div class="line"><span class="number">34</span>: 			fields.add(data);</div><div class="line"><span class="number">35</span>: 		&#125;</div><div class="line"><span class="number">36</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">37</span>: 	<span class="keyword">case</span> RESULT_STATUS_FIELD_EOF:</div><div class="line"><span class="number">38</span>: 		<span class="keyword">switch</span> (data[<span class="number">4</span>]) &#123;</div><div class="line"><span class="number">39</span>: 		<span class="keyword">case</span> ErrorPacket.FIELD_COUNT:</div><div class="line"><span class="number">40</span>: 			resultStatus = RESULT_STATUS_INIT;</div><div class="line"><span class="number">41</span>: 			handleErrorPacket(data);</div><div class="line"><span class="number">42</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">43</span>: 		<span class="keyword">case</span> EOFPacket.FIELD_COUNT: <span class="comment">// è§£æ æ¯è¡Œè®°å½• ç»“æŸ</span></div><div class="line"><span class="number">44</span>: 			resultStatus = RESULT_STATUS_INIT;</div><div class="line"><span class="number">45</span>: 			handleRowEofPacket(data);</div><div class="line"><span class="number">46</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">47</span>: 		<span class="keyword">default</span>: <span class="comment">// æ¯è¡Œè®°å½•</span></div><div class="line"><span class="number">48</span>: 			handleRowPacket(data);</div><div class="line"><span class="number">49</span>: 		&#125;</div><div class="line"><span class="number">50</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">51</span>: 	<span class="keyword">default</span>:</div><div class="line"><span class="number">52</span>: 		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"unknown status!"</span>);</div><div class="line"><span class="number">53</span>: 	&#125;</div><div class="line"><span class="number">54</span>: &#125;</div></pre></td></tr></table></figure>
<h1 id="6-å…¶ä»–-ï¼šæ›´æ–°-åˆ é™¤"><a href="#6-å…¶ä»–-ï¼šæ›´æ–°-åˆ é™¤" class="headerlink" title="6. å…¶ä»– ï¼šæ›´æ–° / åˆ é™¤"></a>6. å…¶ä»– ï¼šæ›´æ–° / åˆ é™¤</h1><p>æµç¨‹åŸºæœ¬å’Œ <a href="http://www.yunai.me/Mycat/single-db-single-table-insert/">ã€ŠMyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹</a> ç›¸åŒã€‚æˆ‘ä»¬å°±ä¸å¦å¤–æ–‡ç« è§£æã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/strong
    
    </summary>
    
      <category term="MyCAT" scheme="http://www.yunai.me/categories/MyCAT/"/>
    
    
  </entry>
  
  <entry>
    <title>MyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æ’å…¥</title>
    <link href="http://www.yunai.me/MyCAT/single-db-single-table-insert/"/>
    <id>http://www.yunai.me/MyCAT/single-db-single-table-insert/</id>
    <published>2017-05-28T16:00:00.000Z</published>
    <updated>2017-07-31T12:30:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL</a></li>
<li><a href="#">3. è·å¾—è·¯ç”±ç»“æœ</a></li>
<li><a href="#">4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL</a></li>
<li><a href="#">5. å“åº”æ‰§è¡Œ SQL ç»“æœ</a></li>
</ul>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><blockquote>
<p>å†…å®¹å½¢æ€ä»¥ é¡ºåºå›¾ + æ ¸å¿ƒä»£ç  ä¸ºä¸»ã€‚<br>å¦‚æœæœ‰åœ°æ–¹è¡¨è¿°ä¸é”™è¯¯æˆ–è€…ä¸æ¸…æ™°ï¼Œæ¬¢è¿ç•™è¨€ã€‚<br>å¯¹äºå†…å®¹å½¢æ€ï¼Œéå¸¸çº ç»“ï¼Œå¦‚æœæœ‰å»ºè®®ï¼Œç‰¹åˆ«ç‰¹åˆ«ç‰¹åˆ«æ¬¢è¿æ‚¨æå‡ºã€‚<br>å¾®ä¿¡å·ï¼šwangwenbin-serverã€‚</p>
</blockquote>
<p>æœ¬æ–‡è®²è§£ ã€å•åº“å•è¡¨ã€‘æ’å…¥ æ‰€æ¶‰åŠåˆ°çš„ä»£ç ã€‚äº¤äº’å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_05_29/05.png" alt="å•åº“å•è¡¨æ’å…¥ç®€å›¾"></p>
<p>æ•´ä¸ªè¿‡ç¨‹ï¼ŒMyCAT Server æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ¥æ”¶ MySQL Client è¯·æ±‚ï¼Œè§£æ SQLã€‚</li>
<li>è·å¾—è·¯ç”±ç»“æœï¼Œè¿›è¡Œè·¯ç”±ã€‚</li>
<li>è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQLã€‚</li>
<li>å“åº”æ‰§è¡Œç»“æœï¼Œå‘é€ç»“æœç»™ MySQL Clientã€‚</li>
</ol>
<p>æˆ‘ä»¬é€ä¸ªæ­¥éª¤åˆ†æï¼Œä¸€èµ·æ¥çœ‹çœ‹æºç ã€‚</p>
<h1 id="2-æ¥æ”¶è¯·æ±‚ï¼Œè§£æ-SQL"><a href="#2-æ¥æ”¶è¯·æ±‚ï¼Œè§£æ-SQL" class="headerlink" title="2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL"></a>2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL</h1><p><img src="http://www.yunai.me/images/MyCAT/2017_05_29/01.png" alt="ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ01ä¸»æµç¨‹ï¼‰"></p>
<h2 id="ã€-1-2-ã€‘"><a href="#ã€-1-2-ã€‘" class="headerlink" title="ã€ 1 - 2 ã€‘"></a>ã€ 1 - 2 ã€‘</h2><p>æ¥æ”¶<strong>ä¸€æ¡</strong> MySQL å‘½ä»¤ã€‚åœ¨ã€1ã€‘ä¹‹å‰ï¼Œè¿˜æœ‰è¯·æ±‚æ•°æ®è¯»å–ã€æ‹†æˆå•æ¡ MySQL SQLã€‚</p>
<h2 id="ã€-3-ã€‘"><a href="#ã€-3-ã€‘" class="headerlink" title="ã€ 3 ã€‘"></a>ã€ 3 ã€‘</h2><p>ä¸åŒ MySQL å‘½ä»¤ï¼Œåˆ†å‘åˆ°ä¸åŒçš„æ–¹æ³•æ‰§è¡Œã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendCommandHandler.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FrontendCommandHandler</span> <span class="keyword">implements</span> <span class="title">NIOHandler</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</div><div class="line"> <span class="number">6</span>:     </div><div class="line"> <span class="number">7</span>:         <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">switch</span> (data[<span class="number">4</span>]) <span class="comment">// </span></div><div class="line"> <span class="number">9</span>:         &#123;</div><div class="line"><span class="number">10</span>:             <span class="keyword">case</span> MySQLPacket.COM_INIT_DB:</div><div class="line"><span class="number">11</span>:                 commands.doInitDB();</div><div class="line"><span class="number">12</span>:                 source.initDB(data);</div><div class="line"><span class="number">13</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">14</span>:             <span class="keyword">case</span> MySQLPacket.COM_QUERY: <span class="comment">// æŸ¥è¯¢å‘½ä»¤</span></div><div class="line"><span class="number">15</span>:                 <span class="comment">// è®¡æ•°æŸ¥è¯¢å‘½ä»¤</span></div><div class="line"><span class="number">16</span>:                 commands.doQuery();</div><div class="line"><span class="number">17</span>:                 <span class="comment">// æ‰§è¡ŒæŸ¥è¯¢å‘½ä»¤</span></div><div class="line"><span class="number">18</span>:                 source.query(data);</div><div class="line"><span class="number">19</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">20</span>:             <span class="keyword">case</span> MySQLPacket.COM_PING:</div><div class="line"><span class="number">21</span>:                 commands.doPing();</div><div class="line"><span class="number">22</span>:                 source.ping();</div><div class="line"><span class="number">23</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">24</span>:             <span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>:     &#125;</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>: &#125;</div></pre></td></tr></table></figure>
<p><code>INSERT</code>/<code>SELECT</code>/<code>UPDATE</code>/<code>DELETE</code> ç­‰ SQL å½’å±äº <code>MySQLPacket.COM_QUERY</code>ï¼Œè¯¦ç»†å¯è§ï¼š<a href="http://hutaow.com/blog/2013/11/06/mysql-protocol-analysis/#42-" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMySQLåè®®åˆ†æ#4.2 å®¢æˆ·ç«¯å‘½ä»¤è¯·æ±‚æŠ¥æ–‡ï¼ˆå®¢æˆ·ç«¯ -&gt; æœåŠ¡å™¨ï¼‰ã€‹</a>ã€‚</p>
<p>##ã€ 4 ã€‘</p>
<p>å°† äºŒè¿›åˆ¶æ•°ç»„ è§£ææˆ SQLã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendConnection.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: 	<span class="comment">// å–å¾—è¯­å¥</span></div><div class="line"> <span class="number">4</span>: 	String sql = <span class="keyword">null</span>;		</div><div class="line"> <span class="number">5</span>: 	<span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>: 		MySQLMessage mm = <span class="keyword">new</span> MySQLMessage(data);</div><div class="line"> <span class="number">7</span>: 		mm.position(<span class="number">5</span>);</div><div class="line"> <span class="number">8</span>: 		sql = mm.readString(charset);</div><div class="line"> <span class="number">9</span>: 	&#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line"><span class="number">10</span>: 		writeErrMessage(ErrorCode.ER_UNKNOWN_CHARACTER_SET, <span class="string">"Unknown charset '"</span> + charset + <span class="string">"'"</span>);</div><div class="line"><span class="number">11</span>: 		<span class="keyword">return</span>;</div><div class="line"><span class="number">12</span>: 	&#125;		</div><div class="line"><span class="number">13</span>: 	<span class="comment">// æ‰§è¡Œè¯­å¥</span></div><div class="line"><span class="number">14</span>: 	<span class="keyword">this</span>.query( sql );</div><div class="line"><span class="number">15</span>: &#125;</div></pre></td></tr></table></figure>
<p>##ã€ 5 ã€‘</p>
<p>è§£æ SQL ç±»å‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerQueryHandler.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">3</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">(String sql)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>: 	<span class="comment">// è§£æ SQL ç±»å‹</span></div><div class="line"> <span class="number">5</span>: 	<span class="keyword">int</span> rs = ServerParse.parse(sql);</div><div class="line"> <span class="number">6</span>: 	<span class="keyword">int</span> sqlType = rs &amp; <span class="number">0xff</span>;</div><div class="line"> <span class="number">7</span>: 	</div><div class="line"> <span class="number">8</span>: 	<span class="keyword">switch</span> (sqlType) &#123;</div><div class="line"> <span class="number">9</span>: 	<span class="comment">//explain sql</span></div><div class="line"><span class="number">10</span>: 	<span class="keyword">case</span> ServerParse.EXPLAIN:</div><div class="line"><span class="number">11</span>: 		ExplainHandler.handle(sql, c, rs &gt;&gt;&gt; <span class="number">8</span>);</div><div class="line"><span class="number">12</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">13</span>: 	<span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">14</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">15</span>: 	<span class="keyword">case</span> ServerParse.SELECT:</div><div class="line"><span class="number">16</span>: 		SelectHandler.handle(sql, c, rs &gt;&gt;&gt; <span class="number">8</span>);</div><div class="line"><span class="number">17</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">18</span>: 	<span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">19</span>: 	<span class="keyword">default</span>:</div><div class="line"><span class="number">20</span>: 		<span class="keyword">if</span>(readOnly)&#123;</div><div class="line"><span class="number">21</span>: 			LOGGER.warn(<span class="keyword">new</span> StringBuilder().append(<span class="string">"User readonly:"</span>).append(sql).toString());</div><div class="line"><span class="number">22</span>: 			c.writeErrMessage(ErrorCode.ER_USER_READ_ONLY, <span class="string">"User readonly"</span>);</div><div class="line"><span class="number">23</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">24</span>: 		&#125;</div><div class="line"><span class="number">25</span>: 		c.execute(sql, rs &amp; <span class="number">0xff</span>);</div><div class="line"><span class="number">26</span>: 	&#125;</div><div class="line"><span class="number">27</span>: &#125;</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>:</div><div class="line"><span class="number">30</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerParse.javaã€‘</span></div><div class="line"><span class="number">31</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">parse</span><span class="params">(String stmt)</span> </span>&#123;</div><div class="line"><span class="number">32</span>: 	<span class="keyword">int</span> length = stmt.length();</div><div class="line"><span class="number">33</span>: 	<span class="comment">//FIX BUG FOR SQL SUCH AS /XXXX/SQL</span></div><div class="line"><span class="number">34</span>: 	<span class="keyword">int</span> rt = -<span class="number">1</span>;</div><div class="line"><span class="number">35</span>: 	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</div><div class="line"><span class="number">36</span>: 		<span class="keyword">switch</span> (stmt.charAt(i)) &#123;</div><div class="line"><span class="number">37</span>: 		<span class="comment">// .... çœç•¥éƒ¨åˆ†case			case 'I':</span></div><div class="line"><span class="number">38</span>: 		<span class="keyword">case</span> <span class="string">'i'</span>:</div><div class="line"><span class="number">39</span>: 			rt = insertCheck(stmt, i);</div><div class="line"><span class="number">40</span>: 			<span class="keyword">if</span> (rt != OTHER) &#123;</div><div class="line"><span class="number">41</span>: 				<span class="keyword">return</span> rt;</div><div class="line"><span class="number">42</span>: 			&#125;</div><div class="line"><span class="number">43</span>: 			<span class="keyword">continue</span>;</div><div class="line"><span class="number">44</span>: 			<span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">45</span>: 		<span class="keyword">case</span> <span class="string">'S'</span>:</div><div class="line"><span class="number">46</span>: 		<span class="keyword">case</span> <span class="string">'s'</span>:</div><div class="line"><span class="number">47</span>: 			rt = sCheck(stmt, i);</div><div class="line"><span class="number">48</span>: 			<span class="keyword">if</span> (rt != OTHER) &#123;</div><div class="line"><span class="number">49</span>: 				<span class="keyword">return</span> rt;</div><div class="line"><span class="number">50</span>: 			&#125;</div><div class="line"><span class="number">51</span>: 			<span class="keyword">continue</span>;</div><div class="line"><span class="number">52</span>: 			<span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">53</span>: 		<span class="keyword">default</span>:</div><div class="line"><span class="number">54</span>: 			<span class="keyword">continue</span>;</div><div class="line"><span class="number">55</span>: 		&#125;</div><div class="line"><span class="number">56</span>: 	&#125;</div><div class="line"><span class="number">57</span>: 	<span class="keyword">return</span> OTHER;</div><div class="line"><span class="number">58</span>: &#125;</div></pre></td></tr></table></figure>
<p>##ã€ 6 ã€‘</p>
<p>æ‰§è¡Œ SQLï¼Œè¯¦ç»†è§£æè§ä¸‹æ–‡ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerConnection.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerConnection</span> <span class="keyword">extends</span> <span class="title">FrontendConnection</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: 	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(String sql, <span class="keyword">int</span> type)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>: 		<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"> <span class="number">5</span>: 		SchemaConfig schema = MycatServer.getInstance().getConfig().getSchemas().get(db);</div><div class="line"> <span class="number">6</span>: 		<span class="keyword">if</span> (schema == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">7</span>: 			writeErrMessage(ErrorCode.ERR_BAD_LOGICDB,</div><div class="line"> <span class="number">8</span>: 					<span class="string">"Unknown MyCAT Database '"</span> + db + <span class="string">"'"</span>);</div><div class="line"> <span class="number">9</span>: 			<span class="keyword">return</span>;</div><div class="line"><span class="number">10</span>: 		&#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: 		<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>: 		<span class="comment">// è·¯ç”±åˆ°åç«¯æ•°æ®åº“ï¼Œæ‰§è¡Œ SQL</span></div><div class="line"><span class="number">15</span>: 		routeEndExecuteSQL(sql, type, schema);</div><div class="line"><span class="number">16</span>: 	&#125;</div><div class="line"><span class="number">17</span>: 	</div><div class="line"><span class="number">18</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">routeEndExecuteSQL</span><span class="params">(String sql, <span class="keyword">final</span> <span class="keyword">int</span> type, <span class="keyword">final</span> SchemaConfig schema)</span> </span>&#123;</div><div class="line"><span class="number">19</span>: 		<span class="comment">// è·¯ç”±è®¡ç®—</span></div><div class="line"><span class="number">20</span>: 		RouteResultset rrs = <span class="keyword">null</span>;</div><div class="line"><span class="number">21</span>: 		<span class="keyword">try</span> &#123;</div><div class="line"><span class="number">22</span>: 			rrs = MycatServer</div><div class="line"><span class="number">23</span>: 					.getInstance()</div><div class="line"><span class="number">24</span>: 					.getRouterservice()</div><div class="line"><span class="number">25</span>: 					.route(MycatServer.getInstance().getConfig().getSystem(),</div><div class="line"><span class="number">26</span>: 							schema, type, sql, <span class="keyword">this</span>.charset, <span class="keyword">this</span>);</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>: 		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">29</span>: 			StringBuilder s = <span class="keyword">new</span> StringBuilder();</div><div class="line"><span class="number">30</span>: 			LOGGER.warn(s.append(<span class="keyword">this</span>).append(sql).toString() + <span class="string">" err:"</span> + e.toString(),e);</div><div class="line"><span class="number">31</span>: 			String msg = e.getMessage();</div><div class="line"><span class="number">32</span>: 			writeErrMessage(ErrorCode.ER_PARSE_ERROR, msg == <span class="keyword">null</span> ? e.getClass().getSimpleName() : msg);</div><div class="line"><span class="number">33</span>: 			<span class="keyword">return</span>;</div><div class="line"><span class="number">34</span>: 		&#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>: 		<span class="comment">// æ‰§è¡Œ SQL</span></div><div class="line"><span class="number">37</span>: 		<span class="keyword">if</span> (rrs != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">38</span>: 			<span class="comment">// sessionæ‰§è¡Œ</span></div><div class="line"><span class="number">39</span>: 			session.execute(rrs, rrs.isSelectForUpdate() ? ServerParse.UPDATE : type);</div><div class="line"><span class="number">40</span>: 		&#125;</div><div class="line"><span class="number">41</span>: 		</div><div class="line"><span class="number">42</span>:  	&#125;</div><div class="line"><span class="number">43</span>: </div><div class="line"><span class="number">44</span>: &#125;</div></pre></td></tr></table></figure>
<h1 id="3-è·å¾—è·¯ç”±ç»“æœ"><a href="#3-è·å¾—è·¯ç”±ç»“æœ" class="headerlink" title="3. è·å¾—è·¯ç”±ç»“æœ"></a>3. è·å¾—è·¯ç”±ç»“æœ</h1><p><img src="http://www.yunai.me/images/MyCAT/2017_05_29/02.png" alt="ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ02è·å–è·¯ç”±ï¼‰"></p>
<h2 id="ã€-1-2-ã€‘ã€-12-ã€‘"><a href="#ã€-1-2-ã€‘ã€-12-ã€‘" class="headerlink" title="ã€ 1 - 2 ã€‘ã€ 12 ã€‘"></a>ã€ 1 - 2 ã€‘ã€ 12 ã€‘</h2><p>è·å¾—è·¯ç”±ä¸»æµç¨‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RouteService.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> RouteResultset <span class="title">route</span><span class="params">(SystemConfig sysconf, SchemaConfig schema,</span></span></div><div class="line"> <span class="number">3</span>: 		<span class="keyword">int</span> sqlType, String stmt, String charset, ServerConnection sc)</div><div class="line"> 4: 		<span class="keyword">throws</span> SQLNonTransientException &#123;</div><div class="line"> <span class="number">5</span>: 	RouteResultset rrs = <span class="keyword">null</span>;</div><div class="line"> <span class="number">6</span>: 	<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"> <span class="number">7</span>: 	<span class="keyword">int</span> hintLength = RouteService.isHintSql(stmt);</div><div class="line"> <span class="number">8</span>: 	<span class="keyword">if</span>(hintLength != -<span class="number">1</span>)&#123; <span class="comment">// TODO å¾…è¯»ï¼šhint</span></div><div class="line"> <span class="number">9</span>: 		<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"><span class="number">10</span>: 		&#125;</div><div class="line"><span class="number">11</span>: 	&#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">12</span>: 		stmt = stmt.trim();</div><div class="line"><span class="number">13</span>: 		rrs = RouteStrategyFactory.getRouteStrategy().route(sysconf, schema, sqlType, stmt,</div><div class="line"><span class="number">14</span>: 				charset, sc, tableId2DataNodeCache);</div><div class="line"><span class="number">15</span>: 	&#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: 	<span class="comment">// .... çœç•¥ä»£ç 		return rrs;</span></div><div class="line"><span class="number">18</span>: &#125;</div><div class="line"><span class="number">19</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘</span></div><div class="line"><span class="number">20</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">21</span>: <span class="function"><span class="keyword">public</span> RouteResultset <span class="title">route</span><span class="params">(SystemConfig sysConfig, SchemaConfig schema, <span class="keyword">int</span> sqlType, String origSQL,</span></span></div><div class="line"><span class="number">22</span>: 		String charset, ServerConnection sc, LayerCachePool cachePool) <span class="keyword">throws</span> SQLNonTransientException &#123;</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>: 	<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>: 	<span class="comment">// å¤„ç†ä¸€äº›è·¯ç”±ä¹‹å‰çš„é€»è¾‘;å…¨å±€åºåˆ—å·ï¼Œçˆ¶å­è¡¨æ’å…¥</span></div><div class="line"><span class="number">27</span>: 	<span class="keyword">if</span> (beforeRouteProcess(schema, sqlType, origSQL, sc) ) &#123;</div><div class="line"><span class="number">28</span>: 		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">29</span>: 	&#125;</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>: 	<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>: 	<span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰åˆ†ç‰‡</span></div><div class="line"><span class="number">34</span>: 	<span class="keyword">if</span> (schema.isNoSharding() &amp;&amp; ServerParse.SHOW != sqlType) &#123;</div><div class="line"><span class="number">35</span>: 		rrs = RouterUtil.routeToSingleNode(rrs, schema.getDataNode(), stmt);</div><div class="line"><span class="number">36</span>: 	&#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">37</span>: 		RouteResultset returnedSet = routeSystemInfo(schema, sqlType, stmt, rrs);</div><div class="line"><span class="number">38</span>: 		<span class="keyword">if</span> (returnedSet == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">39</span>: 			rrs = routeNormalSqlWithAST(schema, stmt, rrs, charset, cachePool,sqlType,sc);</div><div class="line"><span class="number">40</span>: 		&#125;</div><div class="line"><span class="number">41</span>: 	&#125;</div><div class="line"><span class="number">42</span>: </div><div class="line"><span class="number">43</span>: 	<span class="keyword">return</span> rrs;</div><div class="line"><span class="number">44</span>: &#125;</div></pre></td></tr></table></figure>
<p><em><strong>è·¯ç”±</strong> è¯¦ç»†è§£æï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ï¼Œé¿å…å†…å®¹è¿‡å¤šï¼Œå½±å“å¤§å®¶å¯¹ã€æ’å…¥ã€‘æµç¨‹å’Œé€»è¾‘çš„ç†è§£ã€‚</em></p>
<h2 id="ã€-3-6-ã€‘"><a href="#ã€-3-6-ã€‘" class="headerlink" title="ã€ 3 - 6 ã€‘"></a>ã€ 3 - 6 ã€‘</h2><p>è·¯ç”±<strong>å‰ç½®</strong>å¤„ç†ã€‚å½“ç¬¦åˆå¦‚ä¸‹ä¸‰ç§æƒ…å†µä¸‹ï¼Œè¿›è¡Œå¤„ç†ï¼š  </p>
<p>{ 1 } ä½¿ç”¨<strong>å…¨å±€åºåˆ—å·</strong>ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> (<span class="keyword">id</span>, <span class="keyword">name</span>) <span class="keyword">values</span> (<span class="keyword">NEXT</span> <span class="keyword">VALUE</span> <span class="keyword">FOR</span> MYCATSEQ_ID, <span class="string">'name'</span>)</div></pre></td></tr></table></figure>
<p>{ 2 } ER å­è¡¨æ’å…¥<br>{ 3 } ä¸»é”®ä½¿ç”¨è‡ªå¢ ID æ’å…¥ï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">insert into table (name) values ('name')</div><div class="line">===&gt;</div><div class="line">insert into table (id, name) values (NEXT VALUE FOR MYCATSEQ_ID, 'name')</div><div class="line">```  </div><div class="line"></div><div class="line">æƒ…å†µ &#123; 1 &#125; &#123; 3 &#125; æƒ…å†µç±»ä¼¼ï¼Œä½¿ç”¨å…¨å±€åºåˆ—å·ã€‚</div><div class="line"></div><div class="line">æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</div><div class="line"></div><div class="line">```Java</div><div class="line">  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘</div><div class="line">  2: private boolean beforeRouteProcess(SchemaConfig schema, int sqlType, String origSQL, ServerConnection sc)</div><div class="line">  3: 		throws SQLNonTransientException &#123;</div><div class="line">  4: 	return  // å¤„ç† id ä½¿ç”¨ å…¨å±€åºåˆ—å·</div><div class="line">  5:             RouterUtil.processWithMycatSeq(schema, sqlType, origSQL, sc)</div><div class="line">  6:             // å¤„ç† ER å­è¡¨</div><div class="line">  7: 			|| (sqlType == ServerParse.INSERT &amp;&amp; RouterUtil.processERChildTable(schema, origSQL, sc))</div><div class="line">  8:             // å¤„ç† id è‡ªå¢é•¿</div><div class="line">  9: 			|| (sqlType == ServerParse.INSERT &amp;&amp; RouterUtil.processInsert(schema, sqlType, origSQL, sc));</div><div class="line"> 10: &#125;</div></pre></td></tr></table></figure>
<p><code>RouterUtil.java</code> å¤„ç† SQL è€ƒè™‘æ€§èƒ½ï¼Œå®ç°ä¼šæ¯”è¾ƒ C-styleï¼Œä»£ç å’±å°±ä¸è´´äº†ï¼Œä¼ é€é—¨ï¼š<a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/route/util/RouterUtil.javaã€‚" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/route/util/RouterUtil.javaã€‚</a> ï¼ˆğŸ˜ˆè¯¥ä»“åº“ä»å®˜æ–¹ Forkï¼Œé€æ­¥å®Œå–„ä¸­æ–‡æ³¨é‡Šï¼Œæ¬¢è¿ Starï¼‰</p>
<h2 id="ã€-7-11-ã€‘"><a href="#ã€-7-11-ã€‘" class="headerlink" title="ã€ 7 - 11 ã€‘"></a>ã€ 7 - 11 ã€‘</h2><p>å½“<strong>å‰ç½®</strong>è·¯ç”±å¤„ç†<strong>å…¨å±€åºåˆ—å·</strong>æ—¶ï¼Œæ·»åŠ åˆ°å…¨å±€åºåˆ—å¤„ç†å™¨ï¼ˆ<code>MyCATSequnceProcessor</code>ï¼‰ã€‚è¯¥å¤„ç†å™¨ä¼šå¼‚æ­¥ç”Ÿæˆ IDï¼Œæ›¿æ¢ SQL å†…çš„ <code>NEXT VALUE FOR MYCATSEQ_</code> æ­£åˆ™ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> (<span class="keyword">id</span>, <span class="keyword">name</span>) <span class="keyword">values</span> (<span class="keyword">NEXT</span> <span class="keyword">VALUE</span> <span class="keyword">FOR</span> MYCATSEQ_ID, <span class="string">'name'</span>)</div><div class="line">===&gt;</div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> (<span class="keyword">id</span>, <span class="keyword">name</span>) <span class="keyword">values</span> (<span class="number">868348974560579584</span>, <span class="string">'name'</span>)</div></pre></td></tr></table></figure>
<p>å¼‚æ­¥å¤„ç†å®Œåï¼Œè°ƒç”¨ <code>ServerConnection#routeEndExecuteSQL(sql, type, schema)</code> æ–¹æ³•é‡æ–°æ‰§è¡Œ SQLã€‚</p>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RouterUtil.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">processSQL</span><span class="params">(ServerConnection sc,SchemaConfig schema,String sql,<span class="keyword">int</span> sqlType)</span></span>&#123;</div><div class="line"> <span class="number">3</span>: 	SessionSQLPair sessionSQLPair = <span class="keyword">new</span> SessionSQLPair(sc.getSession2(), schema, sql, sqlType);</div><div class="line"> <span class="number">4</span>: 	MycatServer.getInstance().getSequnceProcessor().addNewSql(sessionSQLPair);</div><div class="line"> <span class="number">5</span>: &#125;</div><div class="line"> <span class="number">6</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MyCATSequnceProcessor.javaã€‘</span></div><div class="line"> <span class="number">7</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCATSequnceProcessor</span> </span>&#123;</div><div class="line"> <span class="number">8</span>: 	<span class="keyword">private</span> LinkedBlockingQueue&lt;SessionSQLPair&gt; seqSQLQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;SessionSQLPair&gt;();</div><div class="line"> <span class="number">9</span>: 	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> running=<span class="keyword">true</span>;</div><div class="line"><span class="number">10</span>: 	</div><div class="line"><span class="number">11</span>: 	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addNewSql</span><span class="params">(SessionSQLPair pair)</span> </span>&#123;</div><div class="line"><span class="number">12</span>: 		seqSQLQueue.add(pair);</div><div class="line"><span class="number">13</span>: 	&#125;</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>: 	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeSeq</span><span class="params">(SessionSQLPair pair)</span> </span>&#123;</div><div class="line"><span class="number">16</span>: 		<span class="keyword">try</span> &#123;</div><div class="line"><span class="number">17</span>: 			</div><div class="line"><span class="number">18</span>: 			<span class="comment">// ä½¿ç”¨Druidè§£æå™¨å®ç°sequenceå¤„ç†  @å…µä¸´åŸä¸‹</span></div><div class="line"><span class="number">19</span>: 			DruidSequenceHandler sequenceHandler = <span class="keyword">new</span> DruidSequenceHandler(MycatServer</div><div class="line"><span class="number">20</span>: 					.getInstance().getConfig().getSystem().getSequnceHandlerType());</div><div class="line"><span class="number">21</span>: </div><div class="line"><span class="number">22</span>: 			<span class="comment">// ç”Ÿæˆå¯æ‰§è¡Œ SQL ï¼šç›®å‰ä¸»è¦æ˜¯ç”Ÿæˆ id</span></div><div class="line"><span class="number">23</span>: 			String charset = pair.session.getSource().getCharset();</div><div class="line"><span class="number">24</span>: 			String executeSql = sequenceHandler.getExecuteSql(pair.sql,charset == <span class="keyword">null</span> ? <span class="string">"utf-8"</span>:charset);</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>: 			<span class="comment">// æ‰§è¡Œ SQL</span></div><div class="line"><span class="number">27</span>: 			pair.session.getSource().routeEndExecuteSQL(executeSql, pair.type,pair.schema);</div><div class="line"><span class="number">28</span>: 		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">29</span>: 			LOGGER.error(<span class="string">"MyCATSequenceProcessor.executeSeq(SesionSQLPair)"</span>,e);</div><div class="line"><span class="number">30</span>: 			pair.session.getSource().writeErrMessage(ErrorCode.ER_YES,<span class="string">"mycat sequnce err."</span> + e);</div><div class="line"><span class="number">31</span>: 			<span class="keyword">return</span>;</div><div class="line"><span class="number">32</span>: 		&#125;</div><div class="line"><span class="number">33</span>: 	&#125;</div><div class="line"><span class="number">34</span>: 	</div><div class="line"><span class="number">35</span>: 	<span class="class"><span class="keyword">class</span> <span class="title">ExecuteThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line"><span class="number">36</span>: 		</div><div class="line"><span class="number">37</span>: 		<span class="function"><span class="keyword">public</span> <span class="title">ExecuteThread</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">38</span>: 			setDaemon(<span class="keyword">true</span>); <span class="comment">// è®¾ç½®ä¸ºåå°çº¿ç¨‹,é˜²æ­¢throw RuntimeExecptionè¿›ç¨‹ä»ç„¶å­˜åœ¨çš„é—®é¢˜</span></div><div class="line"><span class="number">39</span>: 		&#125;</div><div class="line"><span class="number">40</span>: 		</div><div class="line"><span class="number">41</span>: 		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">42</span>: 			<span class="keyword">while</span> (running) &#123;</div><div class="line"><span class="number">43</span>: 				<span class="keyword">try</span> &#123;</div><div class="line"><span class="number">44</span>: 					SessionSQLPair pair=seqSQLQueue.poll(<span class="number">100</span>,TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">45</span>: 					<span class="keyword">if</span>(pair!=<span class="keyword">null</span>)&#123;</div><div class="line"><span class="number">46</span>:                         executeSeq(pair);</div><div class="line"><span class="number">47</span>: 					&#125;</div><div class="line"><span class="number">48</span>: 				&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">49</span>: 					LOGGER.warn(<span class="string">"MyCATSequenceProcessor$ExecutorThread"</span>,e);</div><div class="line"><span class="number">50</span>: 				&#125;</div><div class="line"><span class="number">51</span>: 			&#125;</div><div class="line"><span class="number">52</span>: 		&#125;</div><div class="line"><span class="number">53</span>: 	&#125;</div><div class="line"><span class="number">54</span>: &#125;</div></pre></td></tr></table></figure>
<p>â“æ­¤å¤„æœ‰ä¸ªç–‘é—®ï¼š<code>MyCATSequnceProcessor</code> æ˜¯å•çº¿ç¨‹ï¼Œä¼šä¸ä¼šæ’å…¥æ€§èƒ½æœ‰ä¸€å®šçš„å½±å“ï¼Ÿåç»­å’±åšä¸‹æ€§èƒ½æµ‹è¯•ã€‚</p>
<h1 id="4-è·å¾—-MySQL-è¿æ¥ï¼Œæ‰§è¡Œ-SQL"><a href="#4-è·å¾—-MySQL-è¿æ¥ï¼Œæ‰§è¡Œ-SQL" class="headerlink" title="4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL"></a>4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL</h1><p><img src="http://www.yunai.me/images/MyCAT/2017_05_29/03.png" alt="ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ03æ‰§è¡Œ SQLï¼‰"></p>
<h2 id="ã€-1-8-ã€‘"><a href="#ã€-1-8-ã€‘" class="headerlink" title="ã€ 1 - 8 ã€‘"></a>ã€ 1 - 8 ã€‘</h2><p>è·å¾— MySQL è¿æ¥ã€‚</p>
<ul>
<li>PhysicalDBNode ï¼šç‰©ç†æ•°æ®åº“èŠ‚ç‚¹ã€‚</li>
<li>PhysicalDatasource ï¼šç‰©ç†æ•°æ®åº“æ•°æ®æºã€‚</li>
</ul>
<h2 id="ã€-9-13-ã€‘"><a href="#ã€-9-13-ã€‘" class="headerlink" title="ã€ 9 - 13 ã€‘"></a>ã€ 9 - 13 ã€‘</h2><p>å‘é€ SQL åˆ° MySQL Serverï¼Œæ‰§è¡Œ SQLã€‚</p>
<h1 id="5-å“åº”æ‰§è¡Œ-SQL-ç»“æœ"><a href="#5-å“åº”æ‰§è¡Œ-SQL-ç»“æœ" class="headerlink" title="5. å“åº”æ‰§è¡Œ SQL ç»“æœ"></a>5. å“åº”æ‰§è¡Œ SQL ç»“æœ</h1><p><img src="http://www.yunai.me/images/MyCAT/2017_05_29/04.png" alt="ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰"></p>
<h2 id="ã€-1-4-ã€‘"><a href="#ã€-1-4-ã€‘" class="headerlink" title="ã€ 1 - 4 ã€‘"></a>ã€ 1 - 4 ã€‘</h2><p>å¤„ç† MySQL Server å“åº”æ•°æ®åŒ…ã€‚</p>
<h2 id="ã€-5-8-ã€‘"><a href="#ã€-5-8-ã€‘" class="headerlink" title="ã€ 5 - 8 ã€‘"></a>ã€ 5 - 8 ã€‘</h2><p>å‘é€æ’å…¥æˆåŠŸç»“æœç»™ MySQL Clientã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/strong
    
    </summary>
    
      <category term="MyCAT" scheme="http://www.yunai.me/categories/MyCAT/"/>
    
    
  </entry>
  
</feed>
