<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</title>
  <subtitle>æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.yunai.me/"/>
  <updated>2017-09-05T10:12:23.000Z</updated>
  <id>http://www.yunai.me/</id>
  
  <author>
    <name>ç‹æ–‡æ–Œ</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆäºŒï¼‰ã€ç¼–è¾‘ä¸­ã€‘</title>
    <link href="http://www.yunai.me/Elastic-Job/cloud-job-scheduler-and-executor-second/"/>
    <id>http://www.yunai.me/Elastic-Job/cloud-job-scheduler-and-executor-second/</id>
    <published>2017-12-27T16:00:00.000Z</published>
    <updated>2017-09-05T10:12:23.000Z</updated>
    
    <content type="html"><![CDATA[<h1>1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Cloud äº‘ä½œä¸šåº”ç”¨é…ç½®å’Œäº‘ä½œä¸šé…ç½®å˜æ›´å¯¹ä½œä¸šè°ƒåº¦çš„å½±å“</strong>ï¼Œä½œä¸º<a href="http://www.yunai.me/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>çš„è¡¥å……å†…å®¹ã€‚æ‰€ä»¥éœ€è¦ä½ å¯¹<strong>ä½œä¸šè°ƒåº¦</strong>å·²ç»æœ‰ä¸€å®šäº†è§£çš„åŸºç¡€ä¸Šã€‚</p>
<p>ğŸ™‚ å¦‚æœä½ åšä½œä¸šè°ƒåº¦æœ‰ä»»ä½•æƒ³äº¤æµï¼Œæ¬¢è¿åŠ æˆ‘çš„å…¬ä¼—å·( èŠ‹é“æºç  ) æˆ– å¾®ä¿¡( wangwenbin-server ) äº¤æµã€‚</p>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>
åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>
ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1>2. äº‘ä½œä¸šæ“ä½œ</h1>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>è¿ç»´å¹³å°</strong>æˆ– Restful API å¯¹äº‘ä½œä¸šè¿›è¡Œæ“ä½œã€‚å‰è€…æ˜¯å¯¹åè€…çš„ç•Œé¢åŒ…è£…ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="../../../images/Elastic-Job/2017_12_28/01.png" alt=""></p>
<h2>3.1 æ³¨å†Œäº‘ä½œä¸šé…ç½®</h2>
<p><a href="http://www.yunai.me/Elastic-Job/cloud-job-config/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹ã€Œ3.1.1 æ“ä½œäº‘ä½œä¸šé…ç½®ã€</a>æœ‰è¯¦ç»†è§£æã€‚</p>
<h2>3.2 ç¦ç”¨äº‘ä½œä¸šé…ç½®</h2>
<p>è°ƒç”¨ <code>CloudJobRestfulApi#disable(...)</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@POST</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/&#123;jobName&#125;/disable"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disable</span><span class="params">(@PathParam(<span class="string">"jobName"</span>)</span> <span class="keyword">final</span> String jobName) </span>&#123;</div><div class="line">   <span class="keyword">if</span> (configService.load(jobName).isPresent()) &#123;</div><div class="line">       <span class="comment">// å°†ä½œä¸šæ”¾å…¥ç¦ç”¨é˜Ÿåˆ—</span></div><div class="line">       facadeService.disableJob(jobName);</div><div class="line">       <span class="comment">// åœæ­¢è°ƒåº¦ä½œä¸š</span></div><div class="line">       producerManager.unschedule(jobName);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>è°ƒç”¨ <code>FacadeService#disableJob(...)</code> æ–¹æ³•ï¼Œå°†ä½œä¸šæ”¾å…¥<strong>ç¦ç”¨ä½œä¸šé˜Ÿåˆ—</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disableJob</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   disableJobService.add(jobName);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DisableJobService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (regCenter.getNumChildren(DisableJobNode.ROOT) &gt; env.getFrameworkConfiguration().getJobStateQueueSize()) &#123;</div><div class="line">       log.warn(<span class="string">"Cannot add disable job, caused by read state queue size is larger than &#123;&#125;."</span>, env.getFrameworkConfiguration().getJobStateQueueSize());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å°†ä½œä¸šæ”¾å…¥ç¦ç”¨é˜Ÿåˆ—</span></div><div class="line">   String disableJobNodePath = DisableJobNode.getDisableJobNodePath(jobName);</div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(disableJobNodePath)) &#123;</div><div class="line">       regCenter.persist(disableJobNodePath, jobName);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DisableJobNode.java</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DisableJobNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = StateNode.ROOT + <span class="string">"/disable/job"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DISABLE_JOB = ROOT + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;JOB_NAME&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>DisableJobServiceï¼Œç¦ç”¨ä½œä¸šé˜Ÿåˆ—æœåŠ¡ã€‚</p>
</li>
<li>
<p>ç¦ç”¨ä½œä¸šé˜Ÿåˆ—å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${NAMESPACE}/state/disable/job/${JOB_NAME}</code>ï¼Œå­˜å‚¨å€¼ä¸ºç©ºä¸²( <code>&quot;&quot;</code> )ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">    [zk: localhost:2181(CONNECTED) 6] ls /elastic-job-cloud/state/disable/job</div><div class="line">[test_job_simple]</div></pre></td></tr></table></figure></p>
</li>
</ul>
</li>
<li>
<p>è°ƒç”¨ <code>ProducerManager#unschedule(...)</code> æ–¹æ³•ï¼Œåœæ­¢è°ƒåº¦ä½œä¸šã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unschedule</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ€æ­»ä½œä¸šå¯¹åº”çš„ Mesos ä»»åŠ¡ä»¬</span></div><div class="line">   <span class="keyword">for</span> (TaskContext each : runningService.getRunningTasks(jobName)) &#123;</div><div class="line">       schedulerDriver.killTask(Protos.TaskID.newBuilder().setValue(each.getId()).build());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å°†ä½œä¸šä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤</span></div><div class="line">   runningService.remove(jobName);</div><div class="line">   <span class="comment">// å°†ä½œä¸šä»å¾…è¿è¡Œé˜Ÿåˆ—åˆ é™¤</span></div><div class="line">   readyService.remove(Lists.newArrayList(jobName));</div><div class="line">   <span class="comment">// åœæ­¢ä½œä¸šè°ƒåº¦</span></div><div class="line">   Optional&lt;CloudJobConfiguration&gt; jobConfig = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (jobConfig.isPresent()) &#123;</div><div class="line">       transientProducerScheduler.deregister(jobConfig.get());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<pre><code>* è°ƒç”¨ `SchedulerDriver#killTask(...)` æ–¹æ³•ï¼Œæ€æ­»ä½œä¸šå¯¹åº”çš„ Mesos ä»»åŠ¡ä»¬ï¼Œé€‚ç”¨**å¸¸é©»ä½œä¸š**ã€‚Elastic-Job-Cloud-Scheduler ä¼šæ¥æ”¶åˆ° Mesos æ€æ­»ä»»åŠ¡çš„è¯·æ±‚ï¼Œè°ƒç”¨ `TaskExecutor#killTask(...)` æ–¹æ³•ï¼Œåœæ­¢ä»»åŠ¡è°ƒåº¦ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

    <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TaskExecutor.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">killTask</span><span class="params">(<span class="keyword">final</span> ExecutorDriver executorDriver, <span class="keyword">final</span> Protos.TaskID taskID)</span> </span>&#123;</div><div class="line">        <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œå·²æ€æ­»ã€‚</span></div><div class="line">        executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskID).setState(Protos.TaskState.TASK_KILLED).build());</div><div class="line">        <span class="comment">// å…³é—­è¯¥ Mesos ä»»åŠ¡çš„è°ƒåº¦</span></div><div class="line">        DaemonTaskScheduler.shutdown(taskID);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DaemonTaskScheduler.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åœæ­¢ä»»åŠ¡è°ƒåº¦.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> taskID ä»»åŠ¡ä¸»é”®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">(<span class="keyword">final</span> Protos.TaskID taskID)</span> </span>&#123;</div><div class="line">   <span class="comment">// ç§»é™¤ä»»åŠ¡çš„ Quartz Scheduler</span></div><div class="line">   Scheduler scheduler = RUNNING_SCHEDULERS.remove(taskID.getValue());</div><div class="line">   <span class="comment">// å…³é—­ä»»åŠ¡çš„ Quartz Scheduler</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != scheduler) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           scheduler.shutdown();</div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>


* è°ƒç”¨ `RunningService#remove(...)` æ–¹æ³•ï¼Œå°†ä½œä¸šä»**è¿è¡Œæ—¶é˜Ÿåˆ—**åˆ é™¤ã€‚
* è°ƒç”¨ `ReadyService#remove(...)` æ–¹æ³•ï¼Œå°†ä½œä¸šä»**å¾…è¿è¡Œé˜Ÿåˆ—**åˆ é™¤ã€‚
* è°ƒç”¨ `TransientProducerScheduler#deregister(...)` æ–¹æ³•ï¼Œåœæ­¢ä½œä¸šè°ƒåº¦ï¼Œé€‚ç”¨**ç¬æ—¶ä½œä¸š**ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

    <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">deregister</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">    <span class="comment">// ç§»é™¤ä½œä¸š</span></div><div class="line">    repository.remove(jobConfig.getJobName());</div><div class="line">    <span class="comment">// è‹¥ cron ä¸å†å¯¹åº”æœ‰ä½œä¸šè°ƒåº¦ï¼Œç§»é™¤ Quartz Scheduler å¯¹ cron å¯¹åº”çš„ Quartz Job</span></div><div class="line">    String cron = jobConfig.getTypeConfig().getCoreConfig().getCron();</div><div class="line">    <span class="keyword">if</span> (!repository.containsKey(buildJobKey(cron))) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            scheduler.unscheduleJob(TriggerKey.triggerKey(cron));</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre>
<h2>3.4 å¯åŠ¨äº‘ä½œä¸š</h2>
<h2>3.2 æ›´æ–°äº‘ä½œä¸šé…ç½®</h2>
<h2>3.5 æ³¨é”€äº‘ä½œä¸š</h2>
<h2>3.6 è§¦å‘ä¸€æ¬¡äº‘ä½œä¸š</h2>
<h1>2. äº‘ä½œä¸šåº”ç”¨é…ç½®æ“ä½œ</h1>
<h2>2.1 ä¿®æ”¹äº‘ä½œä¸šåº”ç”¨é…ç½®</h2>
<h2>2.2 ç¦ç”¨äº‘ä½œä¸šåº”ç”¨é…ç½®</h2>
<h2>2.3 å¼€å¯äº‘ä½œä¸šåº”ç”¨é…ç½®</h2>
<h2>2.4 æ³¨é”€äº‘ä½œä¸šåº”ç”¨é…ç½®</h2>
<ol>
<li>
<p>SchedulerEngine</p>
<ol>
<li>registered</li>
<li>reregistered</li>
<li>offerRescinded</li>
<li>statusUpdate # TASK_KILLED / # TASK_ERROR</li>
<li>frameworkMessage</li>
<li>disconnected</li>
<li>slaveLost</li>
<li>executorLost</li>
<li>error</li>
</ol>
</li>
<li>
<p>TaskExecutor</p>
<ol>
<li>registered</li>
<li>reregistered</li>
<li>disconnected</li>
<li>killTask</li>
<li>frameworkMessage</li>
<li>shutdown</li>
<li>error</li>
</ol>
</li>
</ol>
<p>é«˜å¯ç”¨</p>
<ol>
<li>Mesos Master æŒ‚æ‰</li>
<li>Mesos Slave æŒ‚æ‰</li>
<li>Cloud Scheduler æŒ‚æ‰</li>
<li>Cloud Executor æŒ‚æ‰</li>
<li>Zookeeper æŒ‚æ‰</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;h1&gt;1. æ¦‚è¿°&lt;/h1&gt;
&lt;p&gt;æœ¬æ–‡ä¸»è¦åˆ†äº« &lt;strong&gt;Elastic-Job-Cloud äº‘ä½œä¸šåº”ç”¨é…ç½®å’Œäº‘ä½œä¸šé…ç½®å˜æ›´å¯¹ä½œä¸šè°ƒåº¦çš„å½±å“&lt;/strong&gt;ï¼Œä½œä¸º&lt;a href=&quot;http://www.yunai.me/Elastic-Job/cloud-job-sch
    
    </summary>
    
      <category term="Elastic-Job-Cloud" scheme="http://www.yunai.me/categories/Elastic-Job-Cloud/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰</title>
    <link href="http://www.yunai.me/Elastic-Job/cloud-job-scheduler-and-executor-first/"/>
    <id>http://www.yunai.me/Elastic-Job/cloud-job-scheduler-and-executor-first/</id>
    <published>2017-12-20T16:00:00.000Z</published>
    <updated>2017-09-05T05:26:16.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ä½œä¸šæ‰§è¡Œç±»å‹</a></li>
<li><a href="#">3. Producer å‘å¸ƒä»»åŠ¡</a>
<ul>
<li><a href="#">3.1 å¸¸é©»ä½œä¸š</a></li>
<li><a href="#">3.2 ç¬æ—¶ä½œä¸š</a>
<ul>
<li><a href="#">3.2.1 TransientProducerScheduler</a></li>
<li><a href="#">3.2.2 æ³¨å†Œç¬æ—¶ä½œä¸š</a></li>
<li><a href="#">3.2.3 ProducerJob</a></li>
</ul>
</li>
<li><a href="#">3.3 å°ç»“</a></li>
</ul>
</li>
<li><a href="#">4. TaskLaunchScheduledService æäº¤ä»»åŠ¡</a>
<ul>
<li><a href="#">4.1 åˆ›å»º Fenzo ä»»åŠ¡è¯·æ±‚</a></li>
<li><a href="#">4.2 AppConstraintEvaluator</a></li>
<li><a href="#">4.3 å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ° Mesos Offer</a></li>
<li><a href="#">4.4 åˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯</a>
<ul>
<li><a href="#">4.4.1 åˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ä¿¡æ¯</a></li>
</ul>
</li>
<li><a href="#">4.5 å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—</a></li>
<li><a href="#">4.6 ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š</a></li>
<li><a href="#">4.7 æäº¤ä»»åŠ¡ç»™ Mesos</a></li>
</ul>
</li>
<li><a href="#">5. TaskExecutor æ‰§è¡Œä»»åŠ¡</a>
<ul>
<li><a href="#">5.1 TaskThread</a></li>
<li><a href="#">5.2 DaemonTaskScheduler</a></li>
</ul>
</li>
<li><a href="#">6. SchedulerEngine å¤„ç†ä»»åŠ¡çš„çŠ¶æ€å˜æ›´</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Cloud è°ƒåº¦ä¸»æµç¨‹</strong>ã€‚å¯¹åº”åˆ° Elastic-Job-Lite æºç è§£ææ–‡ç« å¦‚ä¸‹ï¼š</p>
<ul>
<li><a href="http://www.yunai.me/Elastic-Job/job-init/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆå§‹åŒ–ã€‹</a></li>
<li><a href="http://www.yunai.me/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a></li>
<li><a href="http://www.yunai.me/Elastic-Job/job-sharding/">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a></li>
</ul>
<p>å¦‚æœä½ é˜…è¯»è¿‡ä»¥ä¸‹æ–‡ç« ï¼Œæœ‰åŠ©äºå¯¹æœ¬æ–‡çš„ç†è§£ï¼š</p>
<ul>
<li><a href="http://www.infoq.com/cn/news/2016/09/Mesos-Elastic-Job-Cloud" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠåŸºäºMesosçš„å½“å½“ä½œä¸šäº‘Elastic Job Cloudã€‹</a></li>
<li><a href="https://segmentfault.com/a/1190000007723430" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç”±æµ…å…¥æ·± | å¦‚ä½•ä¼˜é›…åœ°å†™ä¸€ä¸ªMesos Frameworkã€‹</a></li>
</ul>
<p>ğŸ˜ˆ å¦å¤–ï¼Œç¬”è€…å‡è®¾ä½ å·²ç»å¯¹ <strong><a href="http://www.yunai.me/categories/Elastic-Job/?self">ã€ŠElastic-Job-Lite æºç åˆ†æç³»åˆ—ã€‹</a></strong> æœ‰ä¸€å®šçš„äº†è§£ã€‚</p>
<p>æœ¬æ–‡æ¶‰åŠåˆ°ä¸»ä½“ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_12_21/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_12_21/01.png" alt=""></p>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>
åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>
ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<p>Elastic-Job-Cloud åŸºäº Mesos å®ç°åˆ†å¸ƒå¼ä½œä¸šè°ƒåº¦ï¼Œæˆ–è€…è¯´ Elastic-Job-Cloud æ˜¯ Mesos ä¸Šçš„ æ¡†æ¶( Framework )ã€‚</p>
<p>ä¸€ä¸ª Mesos æ¡†æ¶ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š</p>
<ul>
<li>æ§åˆ¶å™¨éƒ¨åˆ†ï¼Œç§°ä¸ºè°ƒåº¦å™¨( Scheduler )ã€‚</li>
<li>å·¥ä½œå•å…ƒéƒ¨åˆ†ï¼Œç§°ä¸ºæ‰§è¡Œå™¨( Executor )ã€‚</li>
</ul>
<p>Elastic-Job-Cloud ç”±ä¸¤ä¸ªé¡¹ç›®ç»„æˆï¼š</p>
<ul>
<li>Elastic-Job-Cloud-Schedulerï¼Œå®ç°è°ƒåº¦å™¨ï¼Œå®ç°ç±»ä¸º <code>com.dangdang.ddframe.job.cloud.scheduler.mesos.SchedulerEngine</code>ã€‚</li>
<li>Elastic-Job-Cloud-Executorï¼Œå®ç°æ‰§è¡Œå™¨ï¼Œå®ç°ç±»ä¸º <code>com.dangdang.ddframe.job.cloud.executor.TaskExecutor</code>ã€‚</li>
</ul>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_12_21/11.png" alt=""></p>
<p>æœ¬æ–‡ç•¥å¾®**â€œå•°å—¦â€<strong>ï¼Œè¯·ä¿æŒ</strong>è€å¿ƒ**ã€‚æ­é…<a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç”¨Mesosæ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a>ä¸€èµ·é˜…è¯»ï¼Œç†è§£éš¾åº¦é™ä½ 99%ã€‚OKï¼Œå¼€å§‹æˆ‘ä»¬çš„ Cloud ä¹‹æ—…ã€‚</p>
<h1>2. ä½œä¸šæ‰§è¡Œç±»å‹</h1>
<p>åœ¨ Elastic-Job-Cloudï¼Œä½œä¸šæ‰§è¡Œåˆ†æˆä¸¤ç§ç±»å‹ï¼š</p>
<ul>
<li>å¸¸é©»ä½œä¸š</li>
</ul>
<blockquote>
<p>å¸¸é©»ä½œä¸šæ˜¯ä½œä¸šä¸€æ—¦å¯åŠ¨ï¼Œæ— è®ºè¿è¡Œä¸å¦å‡å ç”¨ç³»ç»Ÿèµ„æºï¼›<br>
å¸¸é©»ä½œä¸šé€‚åˆåˆå§‹åŒ–æ—¶é—´é•¿ã€è§¦å‘é—´éš”çŸ­ã€å®æ—¶æ€§è¦æ±‚é«˜çš„ä½œä¸šï¼Œè¦æ±‚èµ„æºé…å¤‡å……è¶³ã€‚</p>
</blockquote>
<ul>
<li>ç¬æ—¶ä½œä¸š</li>
</ul>
<blockquote>
<p>ç¬æ—¶ä½œä¸šæ˜¯åœ¨ä½œä¸šå¯åŠ¨æ—¶å ç”¨èµ„æºï¼Œè¿è¡Œå®Œæˆåé‡Šæ”¾èµ„æºã€‚<br>
ç¬æ—¶ä½œä¸šé€‚åˆåˆå§‹åŒ–æ—¶é—´çŸ­ã€è§¦å‘é—´éš”é•¿ã€å…è®¸å»¶è¿Ÿçš„ä½œä¸šï¼Œä¸€èˆ¬ç”¨äºèµ„æºä¸å¤ªå……åˆ†ï¼Œæˆ–ä½œä¸šè¦æ±‚çš„èµ„æºå¤šï¼Œé€‚åˆèµ„æºé”™å³°ä½¿ç”¨çš„åœºæ™¯ã€‚</p>
</blockquote>
<p>Elastic-Job-Cloud ä¸åŒäº Elastic-Job-Lite å»ä¸­å¿ƒåŒ–æ‰§è¡Œè°ƒåº¦ï¼Œè½¬å˜ä¸º <strong>Mesos Framework çš„ä¸­å¿ƒèŠ‚ç‚¹è°ƒåº¦</strong>ã€‚è¿™é‡Œä¸å¤ªç†è§£ï¼Œæ²¡å…³ç³»ï¼Œä¸‹æ–‡çœ‹åˆ°å…·ä½“ä»£ç å°±èƒ½æ˜ç™½äº†ã€‚</p>
<p>å¸¸é©»ä½œä¸šã€ç¬æ—¶ä½œä¸šåœ¨è°ƒåº¦ä¸­ä¼šç•¥æœ‰ä¸åŒï¼Œå¤§ä½“<strong>ç²—ç•¥</strong>æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_12_21/02.png" alt=""></p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬é’ˆå¯¹æ¯ä¸ªè¿‡ç¨‹ä¸€èŠ‚ä¸€èŠ‚è§£æã€‚</p>
<h1>3. Producer å‘å¸ƒä»»åŠ¡</h1>
<p>åœ¨ä¸Šæ–‡<a href="http://www.yunai.me/Elastic-Job/cloud-job-config/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹çš„ã€Œ3.1.1 æ“ä½œäº‘ä½œä¸šé…ç½®ã€</a>å¯ä»¥çœ‹åˆ°æ·»åŠ äº‘ä½œä¸šé…ç½®åï¼ŒElastic-Job-Cloud-Scheduler ä¼šæ‰§è¡Œ<strong>ä½œä¸šè°ƒåº¦</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ProducerManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è°ƒåº¦ä½œä¸š.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">schedule</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   <span class="comment">// åº”ç”¨ æˆ– ä½œä¸š è¢«ç¦ç”¨ï¼Œä¸è°ƒåº¦</span></div><div class="line">   <span class="keyword">if</span> (disableAppService.isDisabled(jobConfig.getAppName()) || disableJobService.isDisabled(jobConfig.getJobName())) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (CloudJobExecutionType.TRANSIENT == jobConfig.getJobExecutionType()) &#123; <span class="comment">// ç¬æ—¶ä½œä¸š</span></div><div class="line">       transientProducerScheduler.register(jobConfig);</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (CloudJobExecutionType.DAEMON == jobConfig.getJobExecutionType()) &#123; <span class="comment">// å¸¸é©»ä½œä¸š</span></div><div class="line">       readyService.addDaemon(jobConfig.getJobName());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬æ—¶ä½œä¸šå’Œå¸¸é©»ä½œä¸šåœ¨è°ƒåº¦ä¸Šä¼šæœ‰ä¸€å®šçš„ä¸åŒã€‚</li>
</ul>
<h2>3.1 å¸¸é©»ä½œä¸š</h2>
<p>å¸¸é©»ä½œä¸šåœ¨è°ƒåº¦æ—¶ï¼Œç›´æ¥æ·»åŠ åˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ã€‚Whatï¼Ÿå²‚ä¸æ˜¯é©¬ä¸Šå°±è¿è¡Œäº†ï¼No No Noï¼Œç­”æ¡ˆåœ¨ã€Œ5. TaskExecutor æ‰§è¡Œä»»åŠ¡ã€ï¼Œè¿™é‡Œå…ˆæ‰“ä½ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ReadyService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å°†å¸¸é©»ä½œä¸šæ”¾å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> jobName ä½œä¸šåç§°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDaemon</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (regCenter.getNumChildren(ReadyNode.ROOT) &gt; env.getFrameworkConfiguration().getJobStateQueueSize()) &#123;</div><div class="line">       log.warn(<span class="string">"Cannot add daemon job, caused by read state queue size is larger than &#123;&#125;."</span>, env.getFrameworkConfiguration().getJobStateQueueSize());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   Optional&lt;CloudJobConfiguration&gt; cloudJobConfig = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (!cloudJobConfig.isPresent() || CloudJobExecutionType.DAEMON != cloudJobConfig.get().getJobExecutionType() || runningService.isJobRunning(jobName)) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°å¾…æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line">   regCenter.persist(ReadyNode.getReadyJobNodePath(jobName), <span class="string">"1"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ReadyNode.java</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadyNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = StateNode.ROOT + <span class="string">"/ready"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String READY_JOB = ROOT + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;JOB_NAME&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>ReadyServiceï¼Œå¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—æœåŠ¡ï¼Œæä¾›å¯¹å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—çš„å„ç§æ“ä½œæ–¹æ³•ã€‚</p>
</li>
<li>
<p><strong>å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong>å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${NAMESPACE}/state/ready/${JOB_NAME}</code>ï¼Œå­˜å‚¨å€¼ä¸ºå¾…æ‰§è¡Œæ¬¡æ•°ã€‚ä¾‹å¦‚æ­¤å¤„ï¼Œå¾…æ‰§è¡Œæ¬¡æ•°ä¸º <code>1</code>ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 4] ls /elastic-job-cloud/state/ready</div><div class="line">[test_job_simple]</div><div class="line">[zk: localhost:2181(CONNECTED) 5] get /elastic-job-cloud/state/ready/test_job_simple</div><div class="line">1</div></pre></td></tr></table></figure></p>
</li>
<li>
<p>åœ¨è¿ç»´å¹³å°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_12_21/10.png" alt=""></p>
</li>
<li>
<p>ä»å®˜æ–¹çš„ RoadMap æ¥çœ‹ï¼Œ<strong>å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong>æœªæ¥ä¼šä½¿ç”¨ Redis å­˜å‚¨ä»¥æé«˜æ€§èƒ½ã€‚</p>
<blockquote>
<p>FROM http://elasticjob.io/docs/elastic-job-cloud/03-design/roadmap/<br>
Redis Based Queue Improvement</p>
</blockquote>
</li>
</ul>
<h2>3.2 ç¬æ—¶ä½œä¸š</h2>
<p>ç¬æ—¶ä½œä¸šåœ¨è°ƒåº¦æ—¶ï¼Œä½¿ç”¨<strong>å‘å¸ƒç¬æ—¶ä½œä¸šä»»åŠ¡çš„è°ƒåº¦å™¨</strong>( TransientProducerScheduler )è°ƒåº¦ä½œä¸šã€‚å½“ç¬æ—¶ä½œä¸šåˆ°è¾¾ä½œä¸šæ‰§è¡Œæ—¶é—´ï¼Œæ·»åŠ åˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ã€‚</p>
<h3>3.2.1 TransientProducerScheduler</h3>
<p>TransientProducerSchedulerï¼Œå‘å¸ƒç¬æ—¶ä½œä¸šä»»åŠ¡çš„è°ƒåº¦å™¨ï¼ŒåŸºäº Quartz å®ç°å¯¹ç¬æ—¶ä½œä¸šçš„è°ƒåº¦ã€‚åˆå§‹åŒ–ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransientProducerScheduler.java</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">   scheduler = getScheduler();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       scheduler.start();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Scheduler <span class="title">getScheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">   StdSchedulerFactory factory = <span class="keyword">new</span> StdSchedulerFactory();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       factory.initialize(getQuartzProperties());</div><div class="line">       <span class="keyword">return</span> factory.getScheduler();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> Properties <span class="title">getQuartzProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">   Properties result = <span class="keyword">new</span> Properties();</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.class"</span>, SimpleThreadPool.class.getName());</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.threadCount"</span>, Integer.toString(Runtime.getRuntime().availableProcessors() * <span class="number">2</span>)); <span class="comment">// çº¿ç¨‹æ± æ•°é‡</span></div><div class="line">   result.put(<span class="string">"org.quartz.scheduler.instanceName"</span>, <span class="string">"ELASTIC_JOB_CLOUD_TRANSIENT_PRODUCER"</span>);</div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.class"</span>, ShutdownHookPlugin.class.getName());</div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.cleanShutdown"</span>, Boolean.TRUE.toString());</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>3.2.2 æ³¨å†Œç¬æ—¶ä½œä¸š</h3>
<p>è°ƒç”¨ <code>TransientProducerScheduler#register(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œç¬æ—¶ä½œä¸šã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransientProducerScheduler.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> TransientProducerRepository repository;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   String cron = jobConfig.getTypeConfig().getCoreConfig().getCron();</div><div class="line">   <span class="comment">// æ·»åŠ  cron ä½œä¸šé›†åˆ</span></div><div class="line">   JobKey jobKey = buildJobKey(cron);</div><div class="line">   repository.put(jobKey, jobConfig.getJobName());</div><div class="line">   <span class="comment">// è°ƒåº¦ ä½œä¸š</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">if</span> (!scheduler.checkExists(jobKey)) &#123;</div><div class="line">           scheduler.scheduleJob(buildJobDetail(jobKey), buildTrigger(jobKey.getName()));</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>è°ƒç”¨ <code>#buildJobKey(...)</code> æ–¹æ³•ï¼Œåˆ›å»º Quartz JobKeyã€‚ä½ ä¼šå‘ç°å¾ˆæœ‰æ„æ€çš„ä½¿ç”¨çš„æ˜¯ <code>cron</code> å‚æ•°ä½œä¸ºä¸»é”®ã€‚Whyï¼Ÿåœ¨çœ‹ä¸‹ <code>!scheduler.checkExists(jobKey)</code> å¤„ï¼Œç›¸åŒ JobKey( <code>cron</code> ) çš„ä½œä¸šä¸é‡å¤æ³¨å†Œåˆ° Quartz Schedulerã€‚Whyï¼Ÿæ­¤å¤„æ˜¯ä¸€ä¸ªä¼˜åŒ–ï¼Œç›¸åŒ <code>cron</code> ä½¿ç”¨åŒä¸€ä¸ª Quartz Jobï¼ŒElastic-Job-Cloud-Scheduler å¯èƒ½ä¼šæ³¨å†Œå¤§é‡çš„ç¬æ—¶ä½œä¸šï¼Œå¦‚æœä¸€ä¸ªç¬æ—¶ä½œä¸šåˆ›å»ºä¸€ä¸ª Quartz Job å¤ªè¿‡æµªè´¹ï¼Œç‰¹åˆ«æ˜¯ <code>cron</code> æ¯åˆ†é’Ÿã€æ¯5åˆ†é’Ÿã€æ¯å°æ—¶ã€æ¯å¤©å·²ç»è¦†ç›–äº†å¤§é‡çš„ç¬æ—¶ä½œä¸šçš„æƒ…å†µã€‚å› æ­¤ï¼Œç›¸åŒ <code>cron</code> ä½¿ç”¨åŒä¸€ä¸ª Quartz Jobã€‚</p>
</li>
<li>
<p>è°ƒç”¨ <code>TransientProducerRepository#put(...)</code> ä»¥ Quartz JobKey ä¸ºä¸»é”®èšåˆä½œä¸šã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TransientProducerRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * cron ä½œä¸šé›†åˆ</div><div class="line">     * keyï¼šä½œä¸šKey</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;JobKey, List&lt;String&gt;&gt; cronTasks = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>, <span class="number">1</span>);</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">final</span> JobKey jobKey, <span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">        remove(jobName);</div><div class="line">        List&lt;String&gt; taskList = cronTasks.get(jobKey);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == taskList) &#123;</div><div class="line">            taskList = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</div><div class="line">            taskList.add(jobName);</div><div class="line">            cronTasks.put(jobKey, taskList);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!taskList.contains(jobName)) &#123;</div><div class="line">            taskList.add(jobName);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
<li>
<p>è°ƒç”¨ <code>#buildJobDetail(...)</code> åˆ›å»º Quartz Job ä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> JobDetail <span class="title">buildJobDetail</span><span class="params">(<span class="keyword">final</span> JobKey jobKey)</span> </span>&#123;</div><div class="line">    JobDetail result = JobBuilder.newJob(ProducerJob.class) <span class="comment">// ProducerJob.java</span></div><div class="line">            .withIdentity(jobKey).build();</div><div class="line">    result.getJobDataMap().put(<span class="string">"repository"</span>, repository);</div><div class="line">    result.getJobDataMap().put(<span class="string">"readyService"</span>, readyService);</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>JobBuilder#newJob(...)</code> çš„å‚æ•°æ˜¯ ProducerJobï¼Œä¸‹æ–‡ä¼šè®²è§£åˆ°ã€‚</li>
</ul>
</li>
<li>
<p>è°ƒç”¨ <code>#buildTrigger(...)</code> åˆ›å»º Quartz Triggerã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Trigger <span class="title">buildTrigger</span><span class="params">(<span class="keyword">final</span> String cron)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> TriggerBuilder.newTrigger()</div><div class="line">           .withIdentity(cron)</div><div class="line">           .withSchedule(CronScheduleBuilder.cronSchedule(cron) <span class="comment">// cron</span></div><div class="line">           .withMisfireHandlingInstructionDoNothing())</div><div class="line">           .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<h3>3.2.3 ProducerJob</h3>
<p>ProducerJobï¼Œå½“ Quartz Job åˆ°è¾¾ <code>cron</code> æ‰§è¡Œæ—¶é—´( å³ä½œä¸šæ‰§è¡Œæ—¶é—´)ï¼Œå°†ç›¸åº”çš„ç¬æ—¶ä½œä¸šæ·»åŠ åˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerJob</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</div><div class="line">        </div><div class="line">   <span class="keyword">private</span> TransientProducerRepository repository;</div><div class="line">   </div><div class="line">   <span class="keyword">private</span> ReadyService readyService;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</div><div class="line">       List&lt;String&gt; jobNames = repository.get(context.getJobDetail().getKey());</div><div class="line">       <span class="keyword">for</span> (String each : jobNames) &#123;</div><div class="line">           readyService.addTransient(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>è°ƒç”¨ <code>TransientProducerRepository#get(...)</code> æ–¹æ³•ï¼Œè·å¾—è¯¥ Job å¯¹åº”çš„ä½œä¸šé›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TransientProducerRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * cron ä½œä¸šé›†åˆ</div><div class="line">     * keyï¼šä½œä¸šKey</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;JobKey, List&lt;String&gt;&gt; cronTasks = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>, <span class="number">1</span>);</div><div class="line">    </div><div class="line">    <span class="function">List&lt;String&gt; <span class="title">get</span><span class="params">(<span class="keyword">final</span> JobKey jobKey)</span> </span>&#123;</div><div class="line">        List&lt;String&gt; result = cronTasks.get(jobKey);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span> == result ? Collections.&lt;String&gt;emptyList() : result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
<li>
<p>è°ƒç”¨ <code>ReadyService#addTransient(...)</code> æ–¹æ³•ï¼Œæ·»åŠ ç¬æ—¶ä½œä¸šåˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* å°†ç¬æ—¶ä½œä¸šæ”¾å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> jobName ä½œä¸šåç§°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addTransient</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   <span class="comment">//</span></div><div class="line">   <span class="keyword">if</span> (regCenter.getNumChildren(ReadyNode.ROOT) &gt; env.getFrameworkConfiguration().getJobStateQueueSize()) &#123;</div><div class="line">       log.warn(<span class="string">"Cannot add transient job, caused by read state queue size is larger than &#123;&#125;."</span>, env.getFrameworkConfiguration().getJobStateQueueSize());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">//</span></div><div class="line">   Optional&lt;CloudJobConfiguration&gt; cloudJobConfig = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (!cloudJobConfig.isPresent() || CloudJobExecutionType.TRANSIENT != cloudJobConfig.get().getJobExecutionType()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// </span></div><div class="line">   String readyJobNode = ReadyNode.getReadyJobNodePath(jobName);</div><div class="line">   String times = regCenter.getDirectly(readyJobNode);</div><div class="line">   <span class="keyword">if</span> (cloudJobConfig.get().getTypeConfig().getCoreConfig().isMisfire()) &#123;</div><div class="line">       regCenter.persist(readyJobNode, Integer.toString(<span class="keyword">null</span> == times ? <span class="number">1</span> : Integer.parseInt(times) + <span class="number">1</span>));</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       regCenter.persist(ReadyNode.getReadyJobNodePath(jobName), <span class="string">"1"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><strong>æ·»åŠ ç¬æ—¶ä½œä¸šåˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong> å’Œ <strong>æ·»åŠ å¸¸é©»ä½œä¸šåˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong>åŸºæœ¬æ˜¯ä¸€è‡´çš„ã€‚</li>
<li>TODO :misfire</li>
</ul>
</li>
</ul>
<h2>3.3 å°ç»“</h2>
<p>æ— è®ºæ˜¯å¸¸é©»ä½œä¸šè¿˜æ˜¯ç¬æ—¶ä½œä¸šï¼Œéƒ½ä¼šåŠ å…¥åˆ°<strong>å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong>ã€‚ç›®å‰æˆ‘ä»¬çœ‹åˆ°ç¬æ—¶ä½œä¸šçš„æ¯æ¬¡è°ƒåº¦æ˜¯ TransientProducerScheduler è´Ÿè´£ã€‚é‚£ä¹ˆå¸¸é©»ä½œä¸šçš„æ¯æ¬¡è°ƒåº¦å‘¢ï¼Ÿã€Œ5. TaskExecutor æ‰§è¡Œä»»åŠ¡ã€ä¼šçœ‹åˆ°å®ƒçš„è°ƒåº¦ï¼Œè¿™æ˜¯ Elastic-Job-Cloud è®¾è®¡å·§å¦™æœ‰è¶£çš„åœ°æ–¹ã€‚</p>
<h1>4. TaskLaunchScheduledService æäº¤ä»»åŠ¡</h1>
<p>TaskLaunchScheduledServiceï¼Œä»»åŠ¡æäº¤è°ƒåº¦æœåŠ¡ã€‚å®ƒç»§æ‰¿ Guava AbstractScheduledService å®ç°å®šæ—¶å°†å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—çš„ä½œä¸šæäº¤åˆ° Mesos è¿›è¡Œè°ƒåº¦æ‰§è¡Œã€‚å®ç°<strong>å®šæ—¶</strong>ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskLaunchScheduledService</span> <span class="keyword">extends</span> <span class="title">AbstractScheduledService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">serviceName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"task-launch-processor"</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Scheduler <span class="title">scheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Scheduler.newFixedDelaySchedule(<span class="number">2</span>, <span class="number">10</span>, TimeUnit.SECONDS);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">runOneIteration</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥éƒ¨åˆ†æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>æ¯ 10 ç§’æ‰§è¡Œæäº¤ä»»åŠ¡( <code>#runOneIteration()</code> )ã€‚å¯¹ Guava AbstractScheduledService ä¸äº†è§£çš„åŒå­¦ï¼Œå¯ä»¥é˜…è¯»å®Œæœ¬æ–‡å Google ä¸‹ã€‚</li>
</ul>
<p><code>#runOneIteration()</code> æ–¹æ³•ç›¸å¯¹æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬ä¸€å—ä¸€å—æ‹†è§£ï¼Œ<strong>è€å¿ƒ</strong>ç†è§£ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">runOneIteration</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       System.out.println(<span class="string">"runOneIteration:"</span> + <span class="keyword">new</span> Date());</div><div class="line">       <span class="comment">// åˆ›å»º Fenzo ä»»åŠ¡è¯·æ±‚</span></div><div class="line">       LaunchingTasks launchingTasks = <span class="keyword">new</span> LaunchingTasks(facadeService.getEligibleJobContext());</div><div class="line">       List&lt;TaskRequest&gt; taskRequests = launchingTasks.getPendingTasks();</div><div class="line">       <span class="comment">// è·å–æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„äº‘ä½œä¸šApp https://github.com/Netflix/Fenzo/wiki/Constraints</span></div><div class="line">       <span class="keyword">if</span> (!taskRequests.isEmpty()) &#123;</div><div class="line">           AppConstraintEvaluator.getInstance().loadAppRunningState();</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ° Mesos Offer</span></div><div class="line">       Collection&lt;VMAssignmentResult&gt; vmAssignmentResults = taskScheduler.scheduleOnce(taskRequests, LeasesQueue.getInstance().drainTo()).getResultMap().values();</div><div class="line">       <span class="comment">// åˆ›å»º Mesos ä»»åŠ¡è¯·æ±‚</span></div><div class="line">       List&lt;TaskContext&gt; taskContextsList = <span class="keyword">new</span> LinkedList&lt;&gt;(); <span class="comment">// ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line">       Map&lt;List&lt;Protos.OfferID&gt;, List&lt;Protos.TaskInfo&gt;&gt; offerIdTaskInfoMap = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">// Mesos ä»»åŠ¡ä¿¡æ¯é›†åˆ</span></div><div class="line">       <span class="keyword">for</span> (VMAssignmentResult each: vmAssignmentResults) &#123;</div><div class="line">           List&lt;VirtualMachineLease&gt; leasesUsed = each.getLeasesUsed();</div><div class="line">           List&lt;Protos.TaskInfo&gt; taskInfoList = <span class="keyword">new</span> ArrayList&lt;&gt;(each.getTasksAssigned().size() * <span class="number">10</span>);</div><div class="line">           taskInfoList.addAll(getTaskInfoList(</div><div class="line">                   launchingTasks.getIntegrityViolationJobs(vmAssignmentResults), <span class="comment">// è·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</span></div><div class="line">                   each, leasesUsed.get(<span class="number">0</span>).hostname(), leasesUsed.get(<span class="number">0</span>).getOffer()));</div><div class="line">           <span class="keyword">for</span> (Protos.TaskInfo taskInfo : taskInfoList) &#123;</div><div class="line">               taskContextsList.add(TaskContext.from(taskInfo.getTaskId().getValue()));</div><div class="line">           &#125;</div><div class="line">           offerIdTaskInfoMap.put(getOfferIDs(leasesUsed), <span class="comment">// è·å¾— Offer ID é›†åˆ</span></div><div class="line">                   taskInfoList);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// éå†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line">       <span class="keyword">for</span> (TaskContext each : taskContextsList) &#123;</div><div class="line">           <span class="comment">// å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—</span></div><div class="line">           facadeService.addRunning(each);</div><div class="line">           <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_STAGING)</span></div><div class="line">           jobEventBus.post(createJobStatusTraceEvent(each));</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š</span></div><div class="line">       facadeService.removeLaunchTasksFromQueue(taskContextsList);</div><div class="line">       <span class="comment">// æäº¤ä»»åŠ¡ç»™ Mesos</span></div><div class="line">       <span class="keyword">for</span> (Entry&lt;List&lt;OfferID&gt;, List&lt;TaskInfo&gt;&gt; each : offerIdTaskInfoMap.entrySet()) &#123;</div><div class="line">           schedulerDriver.launchTasks(each.getKey(), each.getValue());</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</div><div class="line">       log.error(<span class="string">"Launch task error"</span>, throwable);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="comment">// æ¸…ç† AppConstraintEvaluator æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„äº‘ä½œä¸šApp</span></div><div class="line">       AppConstraintEvaluator.getInstance().clearAppRunningState();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>4.1 åˆ›å»º Fenzo ä»»åŠ¡è¯·æ±‚</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line">LaunchingTasks launchingTasks = <span class="keyword">new</span> LaunchingTasks(facadeService.getEligibleJobContext());</div><div class="line">List&lt;TaskRequest&gt; taskRequests = launchingTasks.getPendingTasks();</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>è°ƒç”¨ <code>FacadeService#getEligibleJobContext()</code> æ–¹æ³•ï¼Œè·å–æœ‰èµ„æ ¼è¿è¡Œçš„ä½œä¸šã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–æœ‰èµ„æ ¼è¿è¡Œçš„ä½œä¸š.</div><div class="line">* </div><div class="line">* <span class="doctag">@return</span> ä½œä¸šä¸Šä¸‹æ–‡é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;JobContext&gt; <span class="title">getEligibleJobContext</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ä»å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡</span></div><div class="line">   Collection&lt;JobContext&gt; failoverJobContexts = failoverService.getAllEligibleJobContexts();</div><div class="line">   <span class="comment">// ä»å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡</span></div><div class="line">   Collection&lt;JobContext&gt; readyJobContexts = readyService.getAllEligibleJobContexts(failoverJobContexts);</div><div class="line">   <span class="comment">// åˆå¹¶</span></div><div class="line">   Collection&lt;JobContext&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(failoverJobContexts.size() + readyJobContexts.size());</div><div class="line">   result.addAll(failoverJobContexts);</div><div class="line">   result.addAll(readyJobContexts);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>è°ƒç”¨ <code>FailoverService#getAllEligibleJobContexts()</code> æ–¹æ³•ï¼Œä»<strong>å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</strong>ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡ã€‚<strong>TaskLaunchScheduledService æäº¤çš„ä»»åŠ¡è¿˜å¯èƒ½æ¥è‡ªå¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</strong>ã€‚æœ¬æ–‡æš‚æ—¶ä¸è§£æå¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ç›¸å…³å®ç°ï¼Œé¿å…å¢åŠ å¤æ‚åº¦å½±å“å¤§å®¶çš„ç†è§£ï¼Œåœ¨<a href="http://www.yunai.me?todo">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>è¯¦ç»†è§£æã€‚</p>
</li>
<li>
<p>è°ƒç”¨ <code>ReadyService#getAllEligibleJobContexts(...)</code> æ–¹æ³•ï¼Œä»<strong>å¾…æ‰§è¡Œé˜Ÿåˆ—</strong>ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ReadyService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ä»å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> ineligibleJobContexts æ— èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡</div><div class="line">* <span class="doctag">@return</span> æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;JobContext&gt; <span class="title">getAllEligibleJobContexts</span><span class="params">(<span class="keyword">final</span> Collection&lt;JobContext&gt; ineligibleJobContexts)</span> </span>&#123;</div><div class="line">   <span class="comment">// ä¸å­˜åœ¨ å¾…æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(ReadyNode.ROOT)) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ— èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡ è½¬æ¢æˆ æ— èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šé›†åˆ</span></div><div class="line">   Collection&lt;String&gt; ineligibleJobNames = Collections2.transform(ineligibleJobContexts, <span class="keyword">new</span> Function&lt;JobContext, String&gt;() &#123;</div><div class="line">       </div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(<span class="keyword">final</span> JobContext input)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> input.getJobConfig().getJobName();</div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line">   <span class="comment">// è·å– å¾…æ‰§è¡Œé˜Ÿåˆ— æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡</span></div><div class="line">   List&lt;String&gt; jobNames = regCenter.getChildrenKeys(ReadyNode.ROOT);</div><div class="line">   List&lt;JobContext&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(jobNames.size());</div><div class="line">   <span class="keyword">for</span> (String each : jobNames) &#123;</div><div class="line">       <span class="keyword">if</span> (ineligibleJobNames.contains(each)) &#123;</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// æ’é™¤ ä½œä¸šé…ç½® ä¸å­˜åœ¨çš„ä½œä¸š</span></div><div class="line">       Optional&lt;CloudJobConfiguration&gt; jobConfig = configService.load(each);</div><div class="line">       <span class="keyword">if</span> (!jobConfig.isPresent()) &#123;</div><div class="line">           regCenter.remove(ReadyNode.getReadyJobNodePath(each));</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!runningService.isJobRunning(each)) &#123; <span class="comment">// æ’é™¤ è¿è¡Œä¸­ çš„ä½œä¸š</span></div><div class="line">           result.add(JobContext.from(jobConfig.get(), ExecutionType.READY));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li></li>
</ul>
</li>
<li>
<p>JobContextï¼Œä½œä¸šè¿è¡Œä¸Šä¸‹æ–‡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobContext.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobContext</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CloudJobConfiguration jobConfig;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Integer&gt; assignedShardingItems;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutionType type;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * é€šè¿‡ä½œä¸šé…ç½®åˆ›å»ºä½œä¸šè¿è¡Œä¸Šä¸‹æ–‡.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</div><div class="line">     * <span class="doctag">@param</span> type æ‰§è¡Œç±»å‹</div><div class="line">     * <span class="doctag">@return</span> ä½œä¸šè¿è¡Œä¸Šä¸‹æ–‡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobContext <span class="title">from</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig, <span class="keyword">final</span> ExecutionType type)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> shardingTotalCount = jobConfig.getTypeConfig().getCoreConfig().getShardingTotalCount();</div><div class="line">        <span class="comment">// åˆ†ç‰‡é¡¹</span></div><div class="line">        List&lt;Integer&gt; shardingItems = <span class="keyword">new</span> ArrayList&lt;&gt;(shardingTotalCount);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shardingTotalCount; i++) &#123;</div><div class="line">            shardingItems.add(i);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JobContext(jobConfig, shardingItems, type);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>LaunchingTasksï¼Œåˆ†é…ä»»åŠ¡è¡Œä¸ºåŒ…ã€‚åˆ›å»º LaunchingTasks ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LaunchingTasks</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šä¸Šä¸‹æ–‡é›†åˆ</div><div class="line">     * keyï¼šä½œä¸šå</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, JobContext&gt; eligibleJobContextsMap;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LaunchingTasks</span><span class="params">(<span class="keyword">final</span> Collection&lt;JobContext&gt; eligibleJobContexts)</span> </span>&#123;</div><div class="line">        eligibleJobContextsMap = <span class="keyword">new</span> HashMap&lt;&gt;(eligibleJobContexts.size(), <span class="number">1</span>);</div><div class="line">        <span class="keyword">for</span> (JobContext each : eligibleJobContexts) &#123;</div><div class="line">            eligibleJobContextsMap.put(each.getJobConfig().getJobName(), each);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
<li>
<p>è°ƒç”¨ <code>LaunchingTasks#getPendingTasks()</code> æ–¹æ³•ï¼Œè·å¾—å¾…æ‰§è¡Œä»»åŠ¡é›†åˆã€‚<strong>è¿™é‡Œè¦æ³¨æ„ï¼Œæ¯ä¸ªä½œä¸šå¦‚æœæœ‰å¤šä¸ªåˆ†ç‰‡ï¼Œåˆ™ä¼šç”Ÿæˆå¤šä¸ªå¾…æ‰§è¡Œä»»åŠ¡ï¼Œå³æ­¤å¤„å®Œæˆäº†ä½œä¸šåˆ†ç‰‡</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LaunchingTasks.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—å¾…æ‰§è¡Œä»»åŠ¡</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> å¾…æ‰§è¡Œä»»åŠ¡</div><div class="line">*/</div><div class="line"><span class="function">List&lt;TaskRequest&gt; <span class="title">getPendingTasks</span><span class="params">()</span> </span>&#123;</div><div class="line">   List&lt;TaskRequest&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(eligibleJobContextsMap.size() * <span class="number">10</span>);</div><div class="line">   <span class="keyword">for</span> (JobContext each : eligibleJobContextsMap.values()) &#123;</div><div class="line">       result.addAll(createTaskRequests(each));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ›å»ºå¾…æ‰§è¡Œä»»åŠ¡é›†åˆ</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> jobContext ä½œä¸šè¿è¡Œä¸Šä¸‹æ–‡</div><div class="line">* <span class="doctag">@return</span> å¾…æ‰§è¡Œä»»åŠ¡é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;TaskRequest&gt; <span class="title">createTaskRequests</span><span class="params">(<span class="keyword">final</span> JobContext jobContext)</span> </span>&#123;</div><div class="line">   Collection&lt;TaskRequest&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(jobContext.getAssignedShardingItems().size());</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : jobContext.getAssignedShardingItems()) &#123;</div><div class="line">       result.add(<span class="keyword">new</span> JobTaskRequest(<span class="keyword">new</span> TaskContext(jobContext.getJobConfig().getJobName(), Collections.singletonList(each), jobContext.getType()), jobContext.getJobConfig()));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// TaskContext.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskContext</span> </span>&#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * ä»»åŠ¡ç¼–å·</div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> String id;</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * ä»»åŠ¡å…ƒä¿¡æ¯</div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> MetaInfo metaInfo;</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * æ‰§è¡Œç±»å‹</div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> ExecutionType type;</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Mesos Slave ç¼–å·</div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> String slaveId;</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * æ˜¯å¦é—²ç½®</div><div class="line">    */</div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">boolean</span> idle;</div><div class="line">   </div><div class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MetaInfo</span> </span>&#123;</div><div class="line"></div><div class="line">       <span class="comment">/**</span></div><div class="line">        * ä½œä¸šå</div><div class="line">        */</div><div class="line">       <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">       <span class="comment">/**</span></div><div class="line">        * ä½œä¸šåˆ†ç‰‡é¡¹</div><div class="line">        */</div><div class="line">       <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Integer&gt; shardingItems;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="comment">// ... çœç•¥éƒ¨åˆ†æ–¹æ³•</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobTaskRequest.JAVA</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobTaskRequest</span> <span class="keyword">implements</span> <span class="title">TaskRequest</span> </span>&#123;</div><div class="line">    </div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> TaskContext taskContext;</div><div class="line">       </div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> CloudJobConfiguration jobConfig;</div><div class="line">       </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> taskContext.getId();</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getCPUs</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> jobConfig.getCpuCount();</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getMemory</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> jobConfig.getMemoryMB();</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="comment">// ... çœç•¥éƒ¨åˆ†æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è°ƒç”¨ <code>#createTaskRequests(...)</code> æ–¹æ³•ï¼Œ<strong>å°†å•ä¸ªä½œä¸šæŒ‰ç…§å…¶ä½œä¸šåˆ†ç‰‡æ€»æ•°æ‹†åˆ†æˆä¸€ä¸ªæˆ–å¤šä¸ªå¾…æ‰§è¡Œä»»åŠ¡é›†åˆ</strong>ã€‚</li>
<li>TaskContextï¼Œä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡ã€‚</li>
<li>JobTaskRequestï¼Œä½œä¸šä»»åŠ¡è¯·æ±‚å¯¹è±¡ã€‚</li>
</ul>
</li>
<li>
<p>å› ä¸ºå¯¹è±¡æœ‰ç‚¹å¤šï¼Œæˆ‘ä»¬æ¥è´´ä¸€ä¸ª <code>LaunchingTasks#getPendingTasks()</code> æ–¹æ³•çš„è¿”å›ç»“æœã€‚
<img src="http://www.yunai.me/images/Elastic-Job/2017_12_21/03.png" alt=""></p>
</li>
</ul>
<p><strong>å‹æƒ…æç¤ºï¼Œä»£ç å¯èƒ½æ¯”è¾ƒå¤šï¼Œè¯·è€å¿ƒè§‚çœ‹ã€‚</strong></p>
<h2>4.2 AppConstraintEvaluator</h2>
<p>åœ¨è¯´ AppConstraintEvaluator ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä¸€èµ·äº†<strong>ç®€å•</strong>è§£ä¸‹ <a href="https://github.com/Netflix/Fenzo/wiki" rel="external nofollow noopener noreferrer" target="_blank">Netflix Fenzo</a>ã€‚</p>
<blockquote>
<p>FROM http://dockone.io/article/636<br>
Fenzoæ˜¯ä¸€ä¸ªåœ¨Mesosæ¡†æ¶ä¸Šåº”ç”¨çš„é€šç”¨ä»»åŠ¡è°ƒåº¦å™¨ã€‚å®ƒå¯ä»¥è®©ä½ é€šè¿‡å®ç°å„ç§ä¼˜åŒ–ç­–ç•¥çš„æ’ä»¶ï¼Œæ¥ä¼˜åŒ–ä»»åŠ¡è°ƒåº¦ï¼ŒåŒæ—¶è¿™ä¹Ÿæœ‰åˆ©äºé›†ç¾¤çš„è‡ªåŠ¨ç¼©æ”¾ã€‚</p>
</blockquote>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_12_21/05.png" alt=""></p>
<p>Elastic-Job-Cloud-Scheduler åŸºäº Fenzo å®ç°å¯¹ Mesos çš„å¼¹æ€§èµ„æºåˆ†é…ã€‚</p>
<p>ä¾‹å¦‚ï¼ŒAppConstraintEvaluatorï¼ŒApp ç›®æ ‡ Mesos Slave é€‚é…åº¦é™åˆ¶å™¨ï¼Œé€‰æ‹© Slave æ—¶éœ€è¦è€ƒè™‘å…¶ä¸Šæ˜¯å¦è¿è¡Œæœ‰ App çš„ Executorï¼Œå¦‚æœæ²¡æœ‰è¿è¡Œ Executor éœ€è¦å°†å…¶èµ„æºæ¶ˆè€—è€ƒè™‘è¿›é€‚é…è®¡ç®—ç®—æ³•ä¸­ã€‚å®ƒæ˜¯ <a href="https://github.com/Netflix/Fenzo/blob/5de0e0861def4a655be35a9624e67318a6c0afac/fenzo-core/src/main/java/com/netflix/fenzo/ConstraintEvaluator.java" rel="external nofollow noopener noreferrer" target="_blank">Fenzo ConstraintEvaluator æ¥å£</a> åœ¨ Elastic-Job-Cloud-Scheduler çš„è‡ªå®šä¹‰ä»»åŠ¡çº¦æŸå®ç°ã€‚é€šè¿‡è¿™ä¸ªä»»åŠ¡çº¦æŸï¼Œåœ¨ä¸‹æ–‡è°ƒç”¨ <code>TaskScheduler#scheduleOnce(...)</code> æ–¹æ³•è°ƒåº¦ä»»åŠ¡æ‰€éœ€èµ„æºæ—¶ï¼Œä¼šå°† AppConstraintEvaluator è€ƒè™‘è¿›å»ã€‚</p>
<p>é‚£ä¹ˆä½œä¸šä»»åŠ¡è¯·æ±‚( JobTaskRequest ) æ˜¯æ€ä¹ˆå…³è”ä¸Š AppConstraintEvaluator çš„å‘¢ï¼Ÿ</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobTaskRequest.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobTaskRequest</span> <span class="keyword">implements</span> <span class="title">TaskRequest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> List&lt;? extends ConstraintEvaluator&gt; getHardConstraints() &#123;</div><div class="line">        <span class="keyword">return</span> Collections.singletonList(AppConstraintEvaluator.getInstance());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><a href="https://github.com/Netflix/Fenzo/blob/20d71b5c3213063fc938cd2841dc7569601d1d99/fenzo-core/src/main/java/com/netflix/fenzo/TaskRequest.java" rel="external nofollow noopener noreferrer" target="_blank">Fenzo TaskRequest æ¥å£</a> æ˜¯ Fenzo çš„ä»»åŠ¡è¯·æ±‚æ¥å£ï¼Œé€šè¿‡å®ç° <code>#getHardConstraints()</code> æ–¹æ³•ï¼Œå…³è”ä¸Š TaskRequest å’Œ ConstraintEvaluatorã€‚</li>
</ul>
<p>å…³è”ä¸Šä¹‹åï¼Œä»»åŠ¡åŒ¹é… Mesos Slave èµ„æºæ—¶ï¼Œè°ƒç”¨ <code>ConstraintEvaluator#evaluate(...)</code> å®ç°æ–¹æ³•åˆ¤æ–­æ˜¯å¦ç¬¦åˆçº¦æŸï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConstraintEvaluator</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Result</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isSuccessful;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String failureReason;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Inspects a target to decide whether or not it meets the constraints appropriate to a particular task.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> taskRequest a description of the task to be assigned</div><div class="line">     * <span class="doctag">@param</span> targetVM a description of the host that is a potential match for the task</div><div class="line">     * <span class="doctag">@param</span> taskTrackerState the current status of tasks and task assignments in the system at large</div><div class="line">     * <span class="doctag">@return</span> a successful Result if the target meets the constraints enforced by this constraint evaluator, or</div><div class="line">     *         an unsuccessful Result otherwise</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">evaluate</span><span class="params">(TaskRequest taskRequest, VirtualMachineCurrentState targetVM,</span></span></div><div class="line">                           TaskTrackerState taskTrackerState);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>OKï¼Œç®€å•äº†è§£ç»“æŸï¼Œæœ‰å…´è¶£äº†è§£æ›´å¤šçš„åŒå­¦ï¼Œè¯·ç‚¹å‡»<a href="https://github.com/Netflix/Fenzo/wiki/Constraints" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Constraintsã€‹</a>ã€‚ä¸‹é¢æ¥çœ‹çœ‹ Elastic-Job-Cloud-Scheduler è‡ªå®šä¹‰å®ç°çš„ä»»åŠ¡çº¦æŸ AppConstraintEvaluatorã€‚</p>
<hr>
<p>è°ƒç”¨ <code>AppConstraintEvaluator#loadAppRunningState()</code> æ–¹æ³•ï¼ŒåŠ è½½å½“å‰è¿è¡Œä¸­çš„<strong>äº‘ä½œä¸šApp</strong>ï¼Œä¸º <code>AppConstraintEvaluator#evaluate(...)</code> æ–¹æ³•æä¾›è¯¥æ•°æ®ã€‚ä»£ç å®ç°å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AppConstraintEvaluator.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; runningApps = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">loadAppRunningState</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">for</span> (MesosStateService.ExecutorStateInfo each : facadeService.loadExecutorInfo()) &#123;</div><div class="line">           runningApps.add(each.getId());</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> JSONException | UniformInterfaceException | ClientHandlerException e) &#123;</div><div class="line">       clearAppRunningState();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>è°ƒç”¨ <code>FacadeService#loadExecutorInfo()</code> æ–¹æ³•ï¼Œä» Mesos è·å–æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ Mesos æ‰§è¡Œå™¨( Executor )çš„ä¿¡æ¯ã€‚æ‰§è¡Œå™¨å’Œäº‘ä½œä¸šAppæœ‰å•¥å…³ç³»ï¼Ÿ<strong>æ¯ä¸ªäº‘ä½œä¸šApp å³æ˜¯ä¸€ä¸ª Elastic-Job-Cloud-Executor å®ä¾‹ã€‚</strong>ã€‚<code>FacadeService#loadExecutorInfo()</code> æ–¹æ³•è¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦è‡ªå·±çœ‹ä¸‹ï¼Œä¸»è¦æ˜¯å¯¹ Mesos çš„ APIæ“ä½œï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ <code>runningApps</code> çš„ç»“æœï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_12_21/04.png" alt=""></p>
</li>
</ul>
<hr>
<p>è°ƒç”¨ <code>TaskScheduler#scheduleOnce(...)</code> æ–¹æ³•è°ƒåº¦æäº¤ä»»åŠ¡æ‰€éœ€èµ„æºæ—¶ï¼Œä¼šè°ƒç”¨ <code>ConstraintEvaluator#loadAppRunningState()</code> æ£€æŸ¥åˆ†é…çš„èµ„æºæ˜¯å¦ç¬¦åˆä»»åŠ¡çš„çº¦æŸæ¡ä»¶ã€‚<code>AppConstraintEvaluator#loadAppRunningState()</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AppConstraintEvaluator.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">evaluate</span><span class="params">(<span class="keyword">final</span> TaskRequest taskRequest, <span class="keyword">final</span> VirtualMachineCurrentState targetVM, <span class="keyword">final</span> TaskTrackerState taskTrackerState)</span> </span>&#123;</div><div class="line">   <span class="keyword">double</span> assigningCpus = <span class="number">0.0</span>d;</div><div class="line">   <span class="keyword">double</span> assigningMemoryMB = <span class="number">0.0</span>d;</div><div class="line">   <span class="keyword">final</span> String slaveId = targetVM.getAllCurrentOffers().iterator().next().getSlaveId().getValue();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// åˆ¤æ–­å½“å‰åˆ†é…çš„ Mesos Slave æ˜¯å¦è¿è¡Œç€è¯¥ä½œä¸šä»»åŠ¡è¯·æ±‚å¯¹åº”çš„äº‘ä½œä¸šApp</span></div><div class="line">       <span class="keyword">if</span> (isAppRunningOnSlave(taskRequest.getId(), slaveId)) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, <span class="string">""</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// åˆ¤æ–­å½“å‰åˆ†é…çš„ Mesos Slave å¯åŠ¨äº‘ä½œä¸šApp æ˜¯å¦è¶…è¿‡èµ„æºé™åˆ¶</span></div><div class="line">       Set&lt;String&gt; calculatedApps = <span class="keyword">new</span> HashSet&lt;&gt;(); <span class="comment">// å·²è®¡ç®—ä½œä¸šAppé›†åˆ</span></div><div class="line">       List&lt;TaskRequest&gt; taskRequests = <span class="keyword">new</span> ArrayList&lt;&gt;(targetVM.getTasksCurrentlyAssigned().size() + <span class="number">1</span>);</div><div class="line">       taskRequests.add(taskRequest);</div><div class="line">       <span class="keyword">for</span> (TaskAssignmentResult each : targetVM.getTasksCurrentlyAssigned()) &#123; <span class="comment">// å½“å‰å·²ç»åˆ†é…ä½œä¸šè¯·æ±‚</span></div><div class="line">           taskRequests.add(each.getRequest());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">for</span> (TaskRequest each : taskRequests) &#123;</div><div class="line">           assigningCpus += each.getCPUs();</div><div class="line">           assigningMemoryMB += each.getMemory();</div><div class="line">           <span class="keyword">if</span> (isAppRunningOnSlave(each.getId(), slaveId)) &#123; <span class="comment">// ä½œä¸šAppå·²ç»å¯åŠ¨</span></div><div class="line">               <span class="keyword">continue</span>;</div><div class="line">           &#125;</div><div class="line">           CloudAppConfiguration assigningAppConfig = getAppConfiguration(each.getId());</div><div class="line">           <span class="keyword">if</span> (!calculatedApps.add(assigningAppConfig.getAppName())) &#123; <span class="comment">// æ˜¯å¦å·²ç»è®¡ç®—è¯¥App</span></div><div class="line">               <span class="keyword">continue</span>;</div><div class="line">           &#125;</div><div class="line">           assigningCpus += assigningAppConfig.getCpuCount();</div><div class="line">           assigningMemoryMB += assigningAppConfig.getMemoryMB();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> LackConfigException ex) &#123;</div><div class="line">       log.warn(<span class="string">"Lack config, disable &#123;&#125;"</span>, getName(), ex);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, <span class="string">""</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (assigningCpus &gt; targetVM.getCurrAvailableResources().cpuCores()) &#123; <span class="comment">// cpu</span></div><div class="line">       log.debug(<span class="string">"Failure &#123;&#125; &#123;&#125; cpus:&#123;&#125;/&#123;&#125;"</span>, taskRequest.getId(), slaveId, assigningCpus, targetVM.getCurrAvailableResources().cpuCores());</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>, String.format(<span class="string">"cpu:%s/%s"</span>, assigningCpus, targetVM.getCurrAvailableResources().cpuCores()));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (assigningMemoryMB &gt; targetVM.getCurrAvailableResources().memoryMB()) &#123; <span class="comment">// memory</span></div><div class="line">       log.debug(<span class="string">"Failure &#123;&#125; &#123;&#125; mem:&#123;&#125;/&#123;&#125;"</span>, taskRequest.getId(), slaveId, assigningMemoryMB, targetVM.getCurrAvailableResources().memoryMB());</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>, String.format(<span class="string">"mem:%s/%s"</span>, assigningMemoryMB, targetVM.getCurrAvailableResources().memoryMB()));</div><div class="line">   &#125;</div><div class="line">   log.debug(<span class="string">"Success &#123;&#125; &#123;&#125; cpus:&#123;&#125;/&#123;&#125; mem:&#123;&#125;/&#123;&#125;"</span>, taskRequest.getId(), slaveId, assigningCpus, targetVM.getCurrAvailableResources()</div><div class="line">           .cpuCores(), assigningMemoryMB, targetVM.getCurrAvailableResources().memoryMB());</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, String.format(<span class="string">"cpus:%s/%s mem:%s/%s"</span>, assigningCpus, targetVM.getCurrAvailableResources()</div><div class="line">           .cpuCores(), assigningMemoryMB, targetVM.getCurrAvailableResources().memoryMB()));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è°ƒç”¨ <code>#isAppRunningOnSlave()</code> æ–¹æ³•ï¼Œåˆ¤æ–­å½“å‰åˆ†é…çš„ Mesos Slave æ˜¯å¦è¿è¡Œç€è¯¥ä½œä¸šä»»åŠ¡è¯·æ±‚å¯¹åº”çš„äº‘ä½œä¸šAppã€‚è‹¥äº‘ä½œä¸šAppæœªè¿è¡Œï¼Œåˆ™è¯¥ä½œä¸šä»»åŠ¡è¯·æ±‚æäº¤ç»™ Mesos åï¼Œè¯¥ Mesos Slave ä¼šå¯åŠ¨è¯¥äº‘ä½œä¸š Appï¼ŒApp æœ¬èº«ä¼šå ç”¨ä¸€å®šçš„ <code>CloudAppConfiguration#cpu</code> å’Œ <code>CloudAppConfiguration#memory</code>ï¼Œè®¡ç®—æ—¶éœ€è¦ç»Ÿè®¡ï¼Œé¿å…è¶…è¿‡å½“å‰ Mesos Slave å‰©ä½™ <code>cpu</code> å’Œ <code>memory</code>ã€‚</li>
<li>å½“è®¡ç®—ç¬¦åˆçº¦æŸæ—¶ï¼Œè¿”å› <code>Result(true, ...)</code>ï¼›å¦åˆ™ï¼Œè¿”å› <code>Result(false, ...)</code>ã€‚</li>
<li>TODO å¼‚å¸¸ä¸ºå•¥è¿”å›trueã€‚</li>
</ul>
<h2>4.3 å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ° Mesos Offer</h2>
<p>æˆ‘ä»¬å…ˆ<strong>ç®€å•</strong>äº†è§£ä¸‹ Elastic-Job-Cloud-Scheduler å®ç°çš„ Mesos Scheduler ç±» <code>com.dangdang.ddframe.job.cloud.scheduler.mesos.SchedulerEngine</code>ã€‚è°ƒåº¦å™¨çš„ä¸»è¦èŒè´£ä¹‹ä¸€ï¼š<strong>åœ¨æ¥å—åˆ°çš„ Offer ä¸Šå¯åŠ¨ä»»åŠ¡</strong>ã€‚SchedulerEngine æ¥æ”¶åˆ°èµ„æº Offerï¼Œå…ˆå­˜å‚¨åˆ°èµ„æºé¢„å é˜Ÿåˆ—( LeasesQueue )ï¼Œç­‰åˆ°ä½œä¸šè¢«è°ƒåº¦éœ€è¦å¯åŠ¨ä»»åŠ¡æ—¶è¿›è¡Œä½¿ç”¨ã€‚å­˜å‚¨åˆ°èµ„æºé¢„å é˜Ÿåˆ—å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerEngine</span> <span class="keyword">implements</span> <span class="title">Scheduler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">resourceOffers</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver, <span class="keyword">final</span> List&lt;Protos.Offer&gt; offers)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Protos.Offer offer: offers) &#123;</div><div class="line">            log.trace(<span class="string">"Adding offer &#123;&#125; from host &#123;&#125;"</span>, offer.getId(), offer.getHostname());</div><div class="line">            LeasesQueue.getInstance().offer(offer);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p><code>org.apache.mesos.Scheduler</code>ï¼ŒMesos è°ƒåº¦å™¨<strong>æ¥å£</strong>ï¼Œå®ç°è¯¥æ¥å£æˆä¸ºè‡ªå®šä¹‰ Mesos è°ƒåº¦å™¨ã€‚</p>
</li>
<li>
<p>å®ç° <code>#resourceOffers(...)</code> æ–¹æ³•ï¼Œæœ‰æ–°çš„èµ„æº Offer æ—¶ï¼Œä¼šè¿›è¡Œè°ƒç”¨ã€‚åœ¨ SchedulerEngine ä¼šè°ƒç”¨ <code>#offer(...)</code> æ–¹æ³•ï¼Œå­˜å‚¨ Offer åˆ°èµ„æºé¢„å é˜Ÿåˆ—ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LeasesQueue</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å•ä¾‹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LeasesQueue INSTANCE = <span class="keyword">new</span> LeasesQueue();</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;VirtualMachineLease&gt; queue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–å®ä¾‹.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span> å•ä¾‹å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LeasesQueue <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> INSTANCE;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ·»åŠ èµ„æºè‡³é˜Ÿåˆ—é¢„å .</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> offer èµ„æº</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offer</span><span class="params">(<span class="keyword">final</span> Protos.Offer offer)</span> </span>&#123;</div><div class="line">        queue.offer(<span class="keyword">new</span> VMLeaseObject(offer));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥ #drainTo() æ–¹æ³•ï¼Œä¸‹æ–‡è§£æã€‚</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>VMLeaseObjectï¼Œ<a href="#">Netflix Fenzo</a> å¯¹ Mesos Offer çš„æŠ½è±¡åŒ…è£…ï¼Œç‚¹å‡»<a href="https://github.com/Netflix/Fenzo/blob/faa8a4dd411fff1792c9d788d1288a11e3635ba7/fenzo-core/src/main/java/com/netflix/fenzo/plugins/VMLeaseObject.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹å®ç°ä»£ç ï¼Œé©¬ä¸Šä¼šçœ‹åˆ°å®ƒçš„ç”¨é€”ã€‚</li>
</ul>
</li>
</ul>
<p>å¦å¤–ï¼Œå¯èƒ½æœ‰åŒå­¦å¯¹ Mesos Offer ç†è§£æ¯”è¾ƒç”Ÿæ¶©ï¼ŒOffer å®šä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>FROM https://segmentfault.com/a/1190000007723430<br>
Offeræ˜¯Mesosèµ„æºçš„æŠ½è±¡ï¼Œæ¯”å¦‚è¯´æœ‰å¤šå°‘CPUã€å¤šå°‘memoryï¼Œdiscæ˜¯å¤šå°‘ï¼Œéƒ½æ”¾åœ¨Offeré‡Œï¼Œæ‰“åŒ…ç»™ä¸€ä¸ªFrameworkï¼Œç„¶åFrameworkæ¥å†³å®šåˆ°åº•æ€ä¹ˆç”¨è¿™ä¸ªOfferã€‚</p>
</blockquote>
<hr>
<p>OKï¼ŒçŸ¥è¯†é“ºå«å®Œæˆï¼Œå›åˆ°æœ¬å°èŠ‚çš„é‡å¿ƒï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line">Collection&lt;VMAssignmentResult&gt; vmAssignmentResults = taskScheduler.scheduleOnce(taskRequests, LeasesQueue.getInstance().drainTo()).getResultMap().values();</div><div class="line"></div><div class="line"><span class="comment">// LeasesQueue.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LeasesQueue</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;VirtualMachineLease&gt; queue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;VirtualMachineLease&gt; <span class="title">drainTo</span><span class="params">()</span> </span>&#123;</div><div class="line">        List&lt;VirtualMachineLease&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(queue.size());</div><div class="line">        queue.drainTo(result);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è°ƒç”¨ <code>TaskScheduler#scheduleOnce(...)</code> æ–¹æ³•ï¼Œå°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ° Mesos Offerã€‚é€šè¿‡ Fenzo TaskScheduler å®ç°å¯¹å¤šä¸ªä»»åŠ¡åˆ†é…åˆ°å¤šä¸ª Mesos Offer çš„<strong>åˆç†ä¼˜åŒ–åˆ†é…</strong>ã€‚è¿™æ˜¯ä¸€ä¸ªç›¸å¯¹å¤æ‚çš„é—®é¢˜ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿ</p>
<blockquote>
<p>FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P76<br>
å°†ä»»åŠ¡åŒ¹é…åˆ° offer ä¸Šï¼Œé¦–æ¬¡é€‚é…é€šå¸¸æ˜¯æœ€å¥½çš„ç®—æ³•ã€‚ä½ å¯èƒ½ä¼šæƒ³ï¼Œå¦‚æœåœ¨æ›´å¤šçš„å·¥ä½œé‡Œå°è¯•è®¡ç®—å‡ºåŒ¹é…è¯¥ offer çš„ä¼˜åŒ–ç»„åˆï¼Œå¯èƒ½æ¯”é¦–æ¬¡é€‚é…æ›´èƒ½é«˜æ•ˆåœ°åˆ©ç”¨ offerã€‚è¿™ç»å¯¹æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯è¦è€ƒè™‘å¦‚ä¸‹è¿™äº›æ–¹é¢ï¼šå¯¹äºå¯åŠ¨æ‰€æœ‰ç­‰å¾…è¿è¡Œçš„ä»»åŠ¡æ¥è¯´ï¼Œé›†ç¾¤é‡Œè¦ä¹ˆæœ‰å……è¶³çš„èµ„æºè¦ä¹ˆæ²¡æœ‰ã€‚å¦‚æœèµ„æºå¾ˆå¤šï¼Œé‚£ä¹ˆé¦–æ¬¡é€‚é…è‚¯å®šä¸€ç›´éƒ½èƒ½ä¿è¯æ¯ä¸ªä»»åŠ¡çš„å¯åŠ¨ã€‚å¦‚æœèµ„æºä¸å¤Ÿï¼Œæ€ä¹ˆéƒ½æ— æ³•å¯åŠ¨æ‰€æœ‰ä»»åŠ¡ã€‚å› æ­¤ï¼Œç¼–å†™ä»£ç é€‰æ‹©æ¥ä¸‹æ¥ä¼šè¿è¡Œå“ªä¸ªä»»åŠ¡æ˜¯å¾ˆè‡ªç„¶çš„ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯æœåŠ¡çš„è´¨é‡ã€‚åªæœ‰å½“èµ„æºåˆšå¤Ÿç”¨æ—¶ï¼Œæ‰éœ€è¦æ›´ä¸ºç²¾ç»†çš„æ‰“åŒ…ç®—æ³•ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™é‡Œçš„é—®é¢˜ â€”â€” é€šå¸¸ç§°ä¸ºèƒŒåŒ…é—®é¢˜( Knapsack problem ) â€”â€” æ˜¯ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„ NP å®Œå…¨é—®é¢˜ã€‚NP å®Œå…¨é—®é¢˜æŒ‡çš„æ˜¯éœ€è¦ç›¸å½“é•¿æ—¶é—´æ‰èƒ½æ‰¾åˆ°æœ€ä¼˜è§£å†³æ–¹æ¡ˆçš„é—®é¢˜ï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•å·²çŸ¥é“æŠ€å·§èƒ½å¤Ÿå¿«é€Ÿè§£å†³è¿™ç±»é—®é¢˜ã€‚</p>
</blockquote>
<p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œåªè€ƒè™‘ <code>memory</code> èµ„æºæƒ…å†µä¸‹ï¼Œæœ‰ä¸€å° Slave å†…å­˜ä¸º 8GB ï¼Œç°åœ¨è¦è¿è¡Œä¸‰ä¸ª 1GB çš„ä½œä¸šå’Œ 5GB çš„ä½œä¸šã€‚å…¶ä¸­ 5GB çš„ä½œä¸šåœ¨ 1GB è¿è¡Œå¤šæ¬¡ä¹‹åæ‰æ‰§è¡Œã€‚</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_12_21/06.png" alt=""></p>
<p>å®é™…æƒ…å†µä¼šæ¯”å›¾æ›´åŠ å¤æ‚çš„å¤šçš„å¤šã€‚é€šè¿‡ä½¿ç”¨ Fenzo ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„ï¼Œå¹¶ä¸”ä»¤äººæ»¡æ„çš„åˆ†é…ã€‚ä¸ºäº†è®©ä½ å¯¹ Fenzo æœ‰æ›´åŠ é€å½»çš„ç†è§£ï¼Œè¿™é‡Œå†å¼•ç”¨ä¸€æ®µå¯¹å…¶çš„ä»‹ç»ï¼š</p>
<blockquote>
<p>FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P80<br>
<strong>è°ƒç”¨åº“å‡½æ•° Fenzo</strong><br>
Fenzo æ˜¯ Nettflix åœ¨ 2015 å¹´å¤å¤©å‘å¸ƒçš„åº“å‡½æ•°ã€‚Fenzo ä¸ºåŸºäº java çš„è°ƒåº¦å™¨æä¾›äº†å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œå®Œæˆ offer ç¼“å†²ï¼Œå¤šä»»åŠ¡å¯åŠ¨ï¼Œä»¥åŠè½¯å’Œç¡¬çº¦æŸæ¡ä»¶çš„åŒ¹é…ã€‚å°±ç®—ä¸æ˜¯æ‰€æœ‰çš„ï¼Œä¹Ÿæ˜¯å¾ˆå¤šè°ƒåº¦å™¨éƒ½èƒ½å¤Ÿå—ç›Šäºä½¿ç”¨ Fenzo æ¥å®Œæˆè®¡ç®—ä»»åŠ¡åˆ†é…ï¼Œè€Œä¸ç”¨è‡ªå·±ç¼–å†™ offer ç¼“å†²ã€æ‰“åŒ…å’Œæ”¾ç½®è·¯ç”±ç­‰ã€‚</p>
</blockquote>
<p>ä¸‹é¢ï¼Œæ¥çœ‹ä¸¤æ¬¡ <code>TaskScheduler#scheduleOnce(...)</code> çš„è¿”å›ï¼š</p>
<ul>
<li>
<p>ç¬¬ä¸€æ¬¡è°ƒåº¦ï¼š<img src="http://www.yunai.me/images/Elastic-Job/2017_12_21/07.png" alt=""></p>
</li>
<li>
<p>ç¬¬äºŒæ¬¡è°ƒåº¦ï¼š<img src="http://www.yunai.me/images/Elastic-Job/2017_12_21/08.png" alt=""></p>
</li>
<li>
<p><code>com.netflix.fenzo.VMAssignmentResult</code>ï¼Œæ¯å°ä¸»æœºåˆ†é…ä»»åŠ¡ç»“æœã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VMAssignmentResult</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸»æœº</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String hostname;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½¿ç”¨çš„ Mesos Offer</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;VirtualMachineLease&gt; leasesUsed;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ†é…çš„ä»»åŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;TaskAssignmentResult&gt; tasksAssigned;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<p>å—é™äºç¬”è€…çš„èƒ½åŠ›ï¼Œå»ºè®®ä½ å¯ä»¥åœ¨é˜…è¯»å¦‚ä¸‹æ–‡ç« ï¼Œæ›´é€å½»çš„ç†è§£ TaskScheduler ï¼š</p>
<ul>
<li><a href="https://github.com/Netflix/Fenzo/wiki/How-to-use-Fenzo" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Constraintsã€‹</a></li>
<li><a href="https://github.com/Netflix/Fenzo/wiki/Building-Your-Scheduler" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Building Your Schedulerã€‹</a></li>
<li><a href="https://github.com/Netflix/Fenzo/wiki/Scheduling-Tasks" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Scheduling Tasksã€‹</a></li>
<li><a href="https://github.com/Netflix/Fenzo/wiki/Insights#how-to-learn-which-tasks-are-assigned-to-which-hosts" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” How to Learn Which Tasks Are Assigned to Which Hostsã€‹</a></li>
</ul>
<h2>4.4 åˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line">List&lt;TaskContext&gt; taskContextsList = <span class="keyword">new</span> LinkedList&lt;&gt;(); <span class="comment">// ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line">Map&lt;List&lt;Protos.OfferID&gt;, List&lt;Protos.TaskInfo&gt;&gt; offerIdTaskInfoMap = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">// Mesos ä»»åŠ¡ä¿¡æ¯é›†åˆ</span></div><div class="line"><span class="keyword">for</span> (VMAssignmentResult each: vmAssignmentResults) &#123;</div><div class="line">    List&lt;VirtualMachineLease&gt; leasesUsed = each.getLeasesUsed();</div><div class="line">    List&lt;Protos.TaskInfo&gt; taskInfoList = <span class="keyword">new</span> ArrayList&lt;&gt;(each.getTasksAssigned().size() * <span class="number">10</span>);</div><div class="line">    taskInfoList.addAll(getTaskInfoList(</div><div class="line">            launchingTasks.getIntegrityViolationJobs(vmAssignmentResults), <span class="comment">// è·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</span></div><div class="line">            each, leasesUsed.get(<span class="number">0</span>).hostname(), leasesUsed.get(<span class="number">0</span>).getOffer()));</div><div class="line">    <span class="keyword">for</span> (Protos.TaskInfo taskInfo : taskInfoList) &#123;</div><div class="line">        taskContextsList.add(TaskContext.from(taskInfo.getTaskId().getValue()));</div><div class="line">    &#125;</div><div class="line">    offerIdTaskInfoMap.put(getOfferIDs(leasesUsed), <span class="comment">// è·å¾— Offer ID é›†åˆ</span></div><div class="line">            taskInfoList);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p><code>offerIdTaskInfoMap</code>ï¼ŒMesos ä»»åŠ¡ä¿¡æ¯é›†åˆã€‚key å’Œ value éƒ½ä¸ºç›¸åŒ Mesos Slave Offer å’Œ ä»»åŠ¡ã€‚ä¸ºä»€ä¹ˆï¼Ÿè°ƒç”¨ <code>SchedulerDriver#launchTasks(...)</code> æ–¹æ³•æäº¤<strong>ä¸€æ¬¡</strong>ä»»åŠ¡æ—¶ï¼Œå¿…é¡»ä¿è¯æ‰€æœ‰ä»»åŠ¡å’Œ Offer åœ¨ç›¸åŒ Mesos Slave ä¸Šã€‚</p>
<blockquote>
<p>FROM FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P61<br>
<strong>ç»„åˆ offer</strong><br>
latchTasks æ¥å— offer åˆ—è¡¨ä¸ºè¾“å…¥ï¼Œè¿™å°±å…è®¸ç”¨æˆ·å°†ä¸€äº›ç›¸åŒ slave çš„ offer ç»„åˆèµ·æ¥ï¼Œä»è€Œå°†è¿™äº› offer çš„èµ„æºæ”¾åˆ°æ± é‡Œã€‚å®ƒè¿˜èƒ½æ¥å—ä»»åŠ¡åˆ—è¡¨ä¸ºè¾“å…¥ï¼Œè¿™æ ·å°±èƒ½å¤Ÿå¯åŠ¨é€‚åˆç»™å®š offer çš„è¶³å¤Ÿå¤šçš„ä»»åŠ¡ã€‚æ³¨æ„æ‰€æœ‰ä»»åŠ¡å’Œ offer éƒ½å¿…é¡»æ˜¯åŒä¸€å° slave â€”â€” å¦‚æœä¸åœ¨åŒä¸€å° slave ä¸Šï¼ŒlaunchTasks å°±ä¼šå¤±è´¥ã€‚å¦‚æœæƒ³åœ¨å¤šå° slave ä¸Šå¯åŠ¨ä»»åŠ¡ï¼Œå¤šæ¬¡è°ƒç”¨ latchTasks å³å¯ã€‚</p>
</blockquote>
</li>
<li>
<p>è°ƒç”¨ <code>LaunchingTasks#getIntegrityViolationJobs(...)</code> æ–¹æ³•ï¼Œè·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆã€‚<strong>ä¸€ä¸ªä½œä¸šæœ‰å¤šä¸ªåˆ†ç‰‡ï¼Œå› ä¸º Mesos Offer ä¸è¶³ï¼Œå¯¼è‡´æœ‰éƒ¨åˆ†åˆ†ç‰‡ä¸èƒ½æ‰§è¡Œï¼Œåˆ™æ•´ä¸ªä½œä¸šéƒ½ä¸è¿›è¡Œæ‰§è¡Œ</strong>ã€‚ä»£ç å®ç°å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LaunchingTasks.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> vmAssignmentResults ä¸»æœºåˆ†é…ä»»åŠ¡ç»“æœé›†åˆ</div><div class="line">* <span class="doctag">@return</span> ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</div><div class="line">*/</div><div class="line"><span class="function">Collection&lt;String&gt; <span class="title">getIntegrityViolationJobs</span><span class="params">(<span class="keyword">final</span> Collection&lt;VMAssignmentResult&gt; vmAssignmentResults)</span> </span>&#123;</div><div class="line">   Map&lt;String, Integer&gt; assignedJobShardingTotalCountMap = getAssignedJobShardingTotalCountMap(vmAssignmentResults);</div><div class="line">   Collection&lt;String&gt; result = <span class="keyword">new</span> HashSet&lt;&gt;(assignedJobShardingTotalCountMap.size(), <span class="number">1</span>);</div><div class="line">   <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : assignedJobShardingTotalCountMap.entrySet()) &#123;</div><div class="line">       JobContext jobContext = eligibleJobContextsMap.get(entry.getKey());</div><div class="line">       <span class="keyword">if</span> (ExecutionType.FAILOVER != jobContext.getType() <span class="comment">// ä¸åŒ…æ‹¬ FAILOVER æ‰§è¡Œç±»å‹çš„ä½œä¸š</span></div><div class="line">               &amp;&amp; !entry.getValue().equals(jobContext.getJobConfig().getTypeConfig().getCoreConfig().getShardingTotalCount())) &#123;</div><div class="line">           log.warn(<span class="string">"Job &#123;&#125; is not assigned at this time, because resources not enough to run all sharding instances."</span>, entry.getKey());</div><div class="line">           result.add(entry.getKey());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—æ¯ä¸ªä½œä¸šåˆ†ç‰‡æ•°é›†åˆ</div><div class="line">* keyï¼šä½œä¸šå</div><div class="line">* valueï¼šåˆ†ç‰‡æ€»æ•°</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> vmAssignmentResults ä¸»æœºåˆ†é…ä»»åŠ¡ç»“æœé›†åˆ</div><div class="line">* <span class="doctag">@return</span> æ¯ä¸ªä½œä¸šåˆ†ç‰‡æ•°é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, Integer&gt; <span class="title">getAssignedJobShardingTotalCountMap</span><span class="params">(<span class="keyword">final</span> Collection&lt;VMAssignmentResult&gt; vmAssignmentResults)</span> </span>&#123;</div><div class="line">   Map&lt;String, Integer&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;(eligibleJobContextsMap.size(), <span class="number">1</span>);</div><div class="line">   <span class="keyword">for</span> (VMAssignmentResult vmAssignmentResult: vmAssignmentResults) &#123;</div><div class="line">       <span class="keyword">for</span> (TaskAssignmentResult tasksAssigned: vmAssignmentResult.getTasksAssigned()) &#123;</div><div class="line">           String jobName = TaskContext.from(tasksAssigned.getTaskId()).getMetaInfo().getJobName();</div><div class="line">           <span class="keyword">if</span> (result.containsKey(jobName)) &#123;</div><div class="line">               result.put(jobName, result.get(jobName) + <span class="number">1</span>);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               result.put(jobName, <span class="number">1</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<ul>
<li>
<p>è°ƒç”¨ <code>#getTaskInfoList(...)</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>å•ä¸ªä¸»æœº</strong>çš„ Mesos ä»»åŠ¡ä¿¡æ¯é›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> List&lt;Protos.TaskInfo&gt; getTaskInfoList(<span class="keyword">final</span> Collection&lt;String&gt; integrityViolationJobs, <span class="keyword">final</span> VMAssignmentResult vmAssignmentResult, <span class="keyword">final</span> String hostname, <span class="keyword">final</span> Protos.Offer offer) &#123;</div><div class="line">   List&lt;Protos.TaskInfo&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(vmAssignmentResult.getTasksAssigned().size());</div><div class="line">   <span class="keyword">for</span> (TaskAssignmentResult each: vmAssignmentResult.getTasksAssigned()) &#123;</div><div class="line">       TaskContext taskContext = TaskContext.from(each.getTaskId());</div><div class="line">       String jobName = taskContext.getMetaInfo().getJobName();</div><div class="line">       <span class="keyword">if</span> (!integrityViolationJobs.contains(jobName) <span class="comment">// æ’é™¤ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä»»åŠ¡</span></div><div class="line">               &amp;&amp; !facadeService.isRunning(taskContext) <span class="comment">// æ’é™¤æ­£åœ¨è¿è¡Œä¸­çš„ä»»åŠ¡</span></div><div class="line">               &amp;&amp; !facadeService.isJobDisabled(jobName)) &#123; <span class="comment">// æ’é™¤è¢«ç¦ç”¨çš„ä»»åŠ¡</span></div><div class="line">           <span class="comment">// åˆ›å»º Mesos ä»»åŠ¡</span></div><div class="line">           Protos.TaskInfo taskInfo = getTaskInfo(offer, each);</div><div class="line">           <span class="keyword">if</span> (<span class="keyword">null</span> != taskInfo) &#123;</div><div class="line">               result.add(taskInfo);</div><div class="line">               <span class="comment">// æ·»åŠ ä»»åŠ¡ä¸»é”®å’Œä¸»æœºåç§°çš„æ˜ å°„</span></div><div class="line">               facadeService.addMapping(taskInfo.getTaskId().getValue(), hostname);</div><div class="line">               <span class="comment">// é€šçŸ¥ TaskScheduler ä¸»æœºåˆ†é…äº†è¿™ä¸ªä»»åŠ¡</span></div><div class="line">               taskScheduler.getTaskAssigner().call(each.getRequest(), hostname);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>è°ƒç”¨ <code>#getTaskInfo(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ï¼Œåœ¨<a href="#">ã€Œ4.4.1 åˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ä¿¡æ¯ã€</a>è¯¦ç»†è§£æã€‚</p>
</li>
<li>
<p>è°ƒç”¨ <code>FacadeService#addMapping(...)</code> æ–¹æ³•ï¼Œæ·»åŠ ä»»åŠ¡ä¸»é”®å’Œä¸»æœºåç§°çš„æ˜ å°„ã€‚é€šè¿‡è¯¥æ˜ å°„ï¼Œå¯ä»¥æ ¹æ®ä»»åŠ¡ä¸»é”®æŸ¥è¯¢åˆ°å¯¹åº”çš„ä¸»æœºåã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ·»åŠ ä»»åŠ¡ä¸»é”®å’Œä¸»æœºåç§°çš„æ˜ å°„.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> taskId ä»»åŠ¡ä¸»é”®</div><div class="line">* <span class="doctag">@param</span> hostname ä¸»æœºåç§°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMapping</span><span class="params">(<span class="keyword">final</span> String taskId, <span class="keyword">final</span> String hostname)</span> </span>&#123;</div><div class="line">   runningService.addMapping(taskId, hostname);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RunningService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ä»»åŠ¡ä¸»é”®å’Œä¸»æœºåç§°çš„æ˜ å°„</div><div class="line">* key: ä»»åŠ¡ä¸»é”®</div><div class="line">* value: ä¸»æœºåç§°</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, String&gt; TASK_HOSTNAME_MAPPER = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(TASK_INITIAL_SIZE);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMapping</span><span class="params">(<span class="keyword">final</span> String taskId, <span class="keyword">final</span> String hostname)</span> </span>&#123;</div><div class="line">   TASK_HOSTNAME_MAPPER.putIfAbsent(taskId, hostname);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
<li>
<p>è°ƒç”¨ <code>TaskScheduler#getTaskAssigner()#call(...)</code> æ–¹æ³•ï¼Œé€šçŸ¥ TaskScheduler ä»»åŠ¡è¢«<strong>ç¡®è®¤</strong>åˆ†é…åˆ°è¿™ä¸ªä¸»æœºã€‚TaskScheduler åšä»»åŠ¡å’Œ Offer çš„åŒ¹é…ï¼Œå¯¹å“ªäº›ä»»åŠ¡è¿è¡Œåœ¨å“ªäº›ä¸»æœºæ˜¯æœ‰ä¾èµ–çš„ï¼Œä¸ç„¶æ€ä¹ˆåšåŒ¹é…ä¼˜åŒ–å‘¢ã€‚åœ¨<a href="https://github.com/Netflix/Fenzo/wiki/How-to-use-Fenzo#notify-the-scheduler-of-assigns-and-unassigns-of-tasks" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Notify the Scheduler of Assigns and UnAssigns of Tasksã€‹</a>å¯ä»¥è¿›ä¸€æ­¥äº†è§£ã€‚</p>
</li>
</ul>
</li>
<li>
<p>è°ƒç”¨ <code>#getOfferIDs(...)</code> æ–¹æ³•ï¼Œè·å¾— Offer ID é›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> List&lt;Protos.OfferID&gt; getOfferIDs(<span class="keyword">final</span> List&lt;VirtualMachineLease&gt; leasesUsed) &#123;</div><div class="line">   List&lt;Protos.OfferID&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (VirtualMachineLease virtualMachineLease: leasesUsed) &#123;</div><div class="line">       result.add(virtualMachineLease.getOffer().getId());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<h3>4.4.1 åˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ä¿¡æ¯</h3>
<p>è°ƒç”¨ <code>#getTaskInfo()</code> æ–¹æ³•ï¼Œåˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><strong>å¦‚ä¸‹ä¼šæ¶‰åŠå¤§é‡çš„ Mesos API</strong></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.<span class="function">TaskInfo <span class="title">getTaskInfo</span><span class="params">(<span class="keyword">final</span> Protos.Offer offer, <span class="keyword">final</span> TaskAssignmentResult taskAssignmentResult)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ ¡éªŒ ä½œä¸šé…ç½® æ˜¯å¦å­˜åœ¨</span></div><div class="line">   TaskContext taskContext = TaskContext.from(taskAssignmentResult.getTaskId());</div><div class="line">   Optional&lt;CloudJobConfiguration&gt; jobConfigOptional = facadeService.load(taskContext.getMetaInfo().getJobName());</div><div class="line">   <span class="keyword">if</span> (!jobConfigOptional.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">   CloudJobConfiguration jobConfig = jobConfigOptional.get();</div><div class="line">   <span class="comment">// æ ¡éªŒ ä½œä¸šé…ç½® æ˜¯å¦å­˜åœ¨</span></div><div class="line">   Optional&lt;CloudAppConfiguration&gt; appConfigOptional = facadeService.loadAppConfig(jobConfig.getAppName());</div><div class="line">   <span class="keyword">if</span> (!appConfigOptional.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">   CloudAppConfiguration appConfig = appConfigOptional.get();</div><div class="line">   <span class="comment">// è®¾ç½® Mesos Slave ID</span></div><div class="line">   taskContext.setSlaveId(offer.getSlaveId().getValue());</div><div class="line">   <span class="comment">// è·å¾— åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line">   ShardingContexts shardingContexts = getShardingContexts(taskContext, appConfig, jobConfig);</div><div class="line">   <span class="comment">// ç¬æ—¶çš„è„šæœ¬ä½œä¸šï¼Œä½¿ç”¨ Mesos å‘½ä»¤è¡Œæ‰§è¡Œï¼Œæ— éœ€ä½¿ç”¨æ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">boolean</span> isCommandExecutor = CloudJobExecutionType.TRANSIENT == jobConfig.getJobExecutionType() &amp;&amp; JobType.SCRIPT == jobConfig.getTypeConfig().getJobType();</div><div class="line">   String script = appConfig.getBootstrapScript();</div><div class="line">   <span class="keyword">if</span> (isCommandExecutor) &#123;</div><div class="line">       script = ((ScriptJobConfiguration) jobConfig.getTypeConfig()).getScriptCommandLine();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// åˆ›å»º å¯åŠ¨å‘½ä»¤</span></div><div class="line">   Protos.CommandInfo.URI uri = buildURI(appConfig, isCommandExecutor);</div><div class="line">   Protos.CommandInfo command = buildCommand(uri, script, shardingContexts, isCommandExecutor);</div><div class="line">   <span class="comment">// åˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯</span></div><div class="line">   <span class="keyword">if</span> (isCommandExecutor) &#123;</div><div class="line">       <span class="keyword">return</span> buildCommandExecutorTaskInfo(taskContext, jobConfig, shardingContexts, offer, command);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">return</span> buildCustomizedExecutorTaskInfo(taskContext, appConfig, jobConfig, shardingContexts, offer, command);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>è°ƒç”¨ <code>#getShardingContexts(...)</code> æ–¹æ³•ï¼Œ è·å¾—åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ShardingContexts <span class="title">getShardingContexts</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> CloudAppConfiguration appConfig, <span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   Map&lt;Integer, String&gt; shardingItemParameters = <span class="keyword">new</span> ShardingItemParameters(jobConfig.getTypeConfig().getCoreConfig().getShardingItemParameters()).getMap();</div><div class="line">   Map&lt;Integer, String&gt; assignedShardingItemParameters = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1</span>, <span class="number">1</span>);</div><div class="line">   <span class="keyword">int</span> shardingItem = taskContext.getMetaInfo().getShardingItems().get(<span class="number">0</span>); <span class="comment">// å•ä¸ªä½œä¸šåˆ†ç‰‡</span></div><div class="line">   assignedShardingItemParameters.put(shardingItem, shardingItemParameters.containsKey(shardingItem) ? shardingItemParameters.get(shardingItem) : <span class="string">""</span>);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ShardingContexts(taskContext.getId(), jobConfig.getJobName(), jobConfig.getTypeConfig().getCoreConfig().getShardingTotalCount(),</div><div class="line">           jobConfig.getTypeConfig().getCoreConfig().getJobParameter(), assignedShardingItemParameters, appConfig.getEventTraceSamplingCount());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
<li>
<p>å½“ä»»åŠ¡ä¸º<strong>ç¬æ—¶</strong>çš„<strong>è„šæœ¬</strong>ä½œä¸šæ—¶ï¼Œä½¿ç”¨ Mesos Slave å‘½ä»¤è¡Œè°ƒç”¨å³å¯ï¼Œæ— éœ€ä½¿ç”¨ Elastic-Job-Cloud-Executorã€‚</p>
</li>
<li>
<p>è°ƒç”¨ <code>#buildURI(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºæ‰§è¡Œå™¨çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½åœ°å€ã€‚è¯•ä¸‹ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.CommandInfo.<span class="function">URI <span class="title">buildURI</span><span class="params">(<span class="keyword">final</span> CloudAppConfiguration appConfig, <span class="keyword">final</span> <span class="keyword">boolean</span> isCommandExecutor)</span> </span>&#123;</div><div class="line">   Protos.CommandInfo.URI.Builder result = Protos.CommandInfo.URI.newBuilder()</div><div class="line">           .setValue(appConfig.getAppURL())</div><div class="line">           .setCache(appConfig.isAppCacheEnable()); <span class="comment">// cache</span></div><div class="line">   <span class="keyword">if</span> (isCommandExecutor &amp;&amp; !SupportedExtractionType.isExtraction(appConfig.getAppURL())) &#123;</div><div class="line">       result.setExecutable(<span class="keyword">true</span>); <span class="comment">// æ˜¯å¦å¯æ‰§è¡Œ</span></div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       result.setExtract(<span class="keyword">true</span>); <span class="comment">// æ˜¯å¦éœ€è¦è§£å‹</span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>äº‘ä½œä¸šåº”ç”¨é…ç½® <code>CloudAppConfiguration.appURL</code> ï¼Œé€šè¿‡ Mesos å®ç°æ–‡ä»¶çš„ä¸‹è½½ã€‚</p>
</li>
<li>
<p>äº‘ä½œä¸šåº”ç”¨é…ç½® <code>CloudAppConfiguration.appCacheEnable</code>ï¼Œåº”ç”¨æ–‡ä»¶ä¸‹è½½æ˜¯å¦ç¼“å­˜ã€‚</p>
<blockquote>
<p>FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P99<br>
<strong>Fetcher ç¼“å­˜</strong><br>
Mesos 0.23 é‡Œå‘å¸ƒç§°ä¸º fetcher ç¼“å­˜çš„æ–°åŠŸèƒ½ã€‚fetcher ç¼“å­˜ç¡®ä¿æ¯ä¸ª artifact åœ¨æ¯ä¸ª slave åªä¼šä¸‹è½½ä¸€æ¬¡ï¼Œå³ä½¿å¤šä¸ªæ‰§è¡Œå™¨è¯·æ±‚åŒä¸€ä¸ª artifactï¼Œä¹Ÿåªéœ€è¦ç­‰å¾…å•è¯ä¸‹è½½å®Œæˆå³å¯ã€‚</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>è°ƒç”¨ <code>#buildCommand(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºæ‰§è¡Œå™¨å¯åŠ¨å‘½ä»¤ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.<span class="function">CommandInfo <span class="title">buildCommand</span><span class="params">(<span class="keyword">final</span> Protos.CommandInfo.URI uri, <span class="keyword">final</span> String script, <span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> <span class="keyword">boolean</span> isCommandExecutor)</span> </span>&#123;</div><div class="line">   Protos.CommandInfo.Builder result = Protos.CommandInfo.newBuilder().addUris(uri).setShell(<span class="keyword">true</span>);</div><div class="line">   <span class="keyword">if</span> (isCommandExecutor) &#123;</div><div class="line">       CommandLine commandLine = CommandLine.parse(script);</div><div class="line">       commandLine.addArgument(GsonFactory.getGson().toJson(shardingContexts), <span class="keyword">false</span>);</div><div class="line">       result.setValue(Joiner.on(<span class="string">" "</span>).join(commandLine.getExecutable(), Joiner.on(<span class="string">" "</span>).join(commandLine.getArguments())));</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       result.setValue(script);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<ul>
<li>
<p>è°ƒç”¨ <code>#buildCommandExecutorTaskInfo(...)</code> æ–¹æ³•ï¼Œä¸º<strong>ç¬æ—¶</strong>çš„<strong>è„šæœ¬</strong>ä½œä¸šåˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.<span class="function">TaskInfo <span class="title">buildCommandExecutorTaskInfo</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> CloudJobConfiguration jobConfig, <span class="keyword">final</span> ShardingContexts shardingContexts,</span></span></div><div class="line">                                                    <span class="keyword">final</span> Protos.Offer offer, <span class="keyword">final</span> Protos.CommandInfo command) &#123;</div><div class="line">   Protos.TaskInfo.Builder result = Protos.TaskInfo.newBuilder().setTaskId(Protos.TaskID.newBuilder().setValue(taskContext.getId()).build())</div><div class="line">           .setName(taskContext.getTaskName()).setSlaveId(offer.getSlaveId())</div><div class="line">           .addResources(buildResource(<span class="string">"cpus"</span>, jobConfig.getCpuCount(), offer.getResourcesList()))</div><div class="line">           .addResources(buildResource(<span class="string">"mem"</span>, jobConfig.getMemoryMB(), offer.getResourcesList()))</div><div class="line">           .setData(ByteString.copyFrom(<span class="keyword">new</span> TaskInfoData(shardingContexts, jobConfig).serialize())); <span class="comment">//</span></div><div class="line">   <span class="keyword">return</span> result.setCommand(command).build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<ul>
<li>
<p>è°ƒç”¨ <code>#buildCustomizedExecutorTaskInfo(...)</code> æ–¹æ³•ï¼Œåˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.<span class="function">TaskInfo <span class="title">buildCustomizedExecutorTaskInfo</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> CloudAppConfiguration appConfig, <span class="keyword">final</span> CloudJobConfiguration jobConfig, </span></span></div><div class="line">                                                       <span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> Protos.Offer offer, <span class="keyword">final</span> Protos.CommandInfo command) &#123;</div><div class="line">   Protos.TaskInfo.Builder result = Protos.TaskInfo.newBuilder().setTaskId(Protos.TaskID.newBuilder().setValue(taskContext.getId()).build())</div><div class="line">           .setName(taskContext.getTaskName()).setSlaveId(offer.getSlaveId())</div><div class="line">           .addResources(buildResource(<span class="string">"cpus"</span>, jobConfig.getCpuCount(), offer.getResourcesList()))</div><div class="line">           .addResources(buildResource(<span class="string">"mem"</span>, jobConfig.getMemoryMB(), offer.getResourcesList()))</div><div class="line">           .setData(ByteString.copyFrom(<span class="keyword">new</span> TaskInfoData(shardingContexts, jobConfig).serialize()));</div><div class="line">   <span class="comment">// ExecutorInfo</span></div><div class="line">   Protos.ExecutorInfo.Builder executorBuilder = Protos.ExecutorInfo.newBuilder().setExecutorId(Protos.ExecutorID.newBuilder()</div><div class="line">           .setValue(taskContext.getExecutorId(jobConfig.getAppName()))) <span class="comment">// æ‰§è¡Œå™¨ ID</span></div><div class="line">           .setCommand(command)</div><div class="line">           .addResources(buildResource(<span class="string">"cpus"</span>, appConfig.getCpuCount(), offer.getResourcesList()))</div><div class="line">           .addResources(buildResource(<span class="string">"mem"</span>, appConfig.getMemoryMB(), offer.getResourcesList()));</div><div class="line">   <span class="keyword">if</span> (env.getJobEventRdbConfiguration().isPresent()) &#123;</div><div class="line">       executorBuilder.setData(ByteString.copyFrom(SerializationUtils.serialize(env.getJobEventRdbConfigurationMap()))).build();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.setExecutor(executorBuilder.build()).build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>è°ƒç”¨ <code>Protos.ExecutorInfo.Builder#setValue(...)</code> æ–¹æ³•ï¼Œè®¾ç½®<strong>æ‰§è¡Œå™¨ç¼–å·</strong>ã€‚å¤§å¤šæ•°åœ¨ Mesos å®ç°çš„æ‰§è¡Œå™¨ï¼Œä¸€ä¸ªä»»åŠ¡å¯¹åº”ä¸€ä¸ªæ‰§è¡Œå™¨ã€‚è€Œ Elastic-Job-Cloud-Executor ä¸åŒäºå¤§å¤šæ•°åœ¨ Mesos ä¸Šçš„æ‰§è¡Œå™¨ï¼Œä¸€ä¸ªæ‰§è¡Œå™¨å¯ä»¥å¯¹åº”å¤šä¸ªä½œä¸šã€‚ä»€ä¹ˆæ„æ€ï¼Ÿåœ¨ä¸€ä¸ª Mesos Slaveï¼Œ<strong>ç›¸åŒ</strong>ä½œä¸šåº”ç”¨ï¼Œåªä¼šå¯åŠ¨ä¸€ä¸ª Elastic-Job-Cloud-Schedulerã€‚å½“è¯¥æ‰§è¡Œå™¨ä¸å­˜åœ¨æ—¶ï¼Œå¯åŠ¨ä¸€ä¸ªã€‚å½“è¯¥æ‰§è¡Œå™¨å·²ç»å­˜åœ¨ï¼Œå¤ç”¨è¯¥æ‰§è¡Œå™¨ã€‚é‚£ä¹ˆæ˜¯å¦‚ä½•å®ç°è¯¥åŠŸèƒ½çš„å‘¢ï¼Ÿ<strong>ç›¸åŒ</strong>ä½œä¸šåº”ç”¨ï¼Œåœ¨åŒä¸€ä¸ª Mesos Slaveï¼Œä½¿ç”¨ç›¸åŒæ‰§è¡Œå™¨ç¼–å·ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * è·å–ä»»åŠ¡æ‰§è¡Œå™¨ä¸»é”®.</div><div class="line"> * </div><div class="line"> * <span class="doctag">@param</span> appName åº”ç”¨åç§°</div><div class="line"> * <span class="doctag">@return</span> ä»»åŠ¡æ‰§è¡Œå™¨ä¸»é”®</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getExecutorId</span><span class="params">(<span class="keyword">final</span> String appName)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Joiner.on(DELIMITER).join(appName, slaveId);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
</li>
</ul>
<h2>4.5 å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—</h2>
<p>è°ƒç”¨ <code>FacadeService#addRunning(...)</code> æ–¹æ³•ï¼Œå°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRunning</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   runningService.add(taskContext);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RunningService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!configurationService.load(taskContext.getMetaInfo().getJobName()).isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°è¿è¡Œä¸­çš„ä»»åŠ¡é›†åˆ</span></div><div class="line">   getRunningTasks(taskContext.getMetaInfo().getJobName()).add(taskContext);</div><div class="line">   <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºå¸¸é©»ä»»åŠ¡</span></div><div class="line">   <span class="keyword">if</span> (!isDaemon(taskContext.getMetaInfo().getJobName())) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°è¿è¡Œä¸­é˜Ÿåˆ—</span></div><div class="line">   String runningTaskNodePath = RunningNode.getRunningTaskNodePath(taskContext.getMetaInfo().toString());</div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(runningTaskNodePath)) &#123;</div><div class="line">       regCenter.persist(runningTaskNodePath, taskContext.getId());</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RunningNode.java</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RunningNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = StateNode.ROOT + <span class="string">"/running"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RUNNING_JOB = ROOT + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;JOB_NAME&#125;</span></div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RUNNING_TASK = RUNNING_JOB + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;TASK_META_INFO&#125;ã€‚$&#123;TASK_META_INFO&#125;=$&#123;JOB_NAME&#125;@-@$&#123;ITEM_ID&#125;ã€‚</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>RunningServiceï¼Œä»»åŠ¡è¿è¡Œæ—¶æœåŠ¡ï¼Œæä¾›å¯¹è¿è¡Œä¸­çš„ä»»åŠ¡é›†åˆã€è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—çš„å„ç§æ“ä½œæ–¹æ³•ã€‚</p>
</li>
<li>
<p>è°ƒç”¨ <code>#getRunningTasks()</code> æ–¹æ³•ï¼Œè·å¾—<strong>è¿è¡Œä¸­çš„ä»»åŠ¡é›†åˆ</strong>ï¼Œå¹¶å°†å½“å‰ä»»åŠ¡æ·»åŠ åˆ°å…¶ä¸­ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;TaskContext&gt; <span class="title">getRunningTasks</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   Set&lt;TaskContext&gt; taskContexts = <span class="keyword">new</span> CopyOnWriteArraySet&lt;&gt;();</div><div class="line">   Collection&lt;TaskContext&gt; result = RUNNING_TASKS.putIfAbsent(jobName, taskContexts);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span> == result ? taskContexts : result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨è¿ç»´å¹³å°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å½“å‰ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_12_21/09.png" alt=""></p>
</li>
<li>
<p>å¸¸é©»ä½œä¸šä¼šå­˜å‚¨åœ¨<strong>è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—</strong>ã€‚è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${NAMESPACE}/state/running/${JOB_NAME}/${TASK_META_INFO}</code>ï¼Œå­˜å‚¨å€¼ä¸ºä»»åŠ¡ç¼–å·ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 14] ls /elastic-job-cloud/state/running/test_job_simple</div><div class="line">[test_job_simple@-@0, test_job_simple@-@1, test_job_simple@-@2]</div><div class="line">[zk: localhost:2181(CONNECTED) 15] get /elastic-job-cloud/state/running/test_job_simple/test_job_simple@-@0</div><div class="line">test_job_simple@-@0@-@READY@-@400197d9-76ca-464b-b2f0-e0fba5c2a598-S0@-@9780ed12-9612-45e3-ac14-feb2911896ff</div></pre></td></tr></table></figure></p>
</li>
</ul>
<h2>4.6 ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line">facadeService.removeLaunchTasksFromQueue(taskContextsList);</div><div class="line"></div><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> taskContexts ä»»åŠ¡ä¸Šä¸‹æ–‡é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeLaunchTasksFromQueue</span><span class="params">(<span class="keyword">final</span> List&lt;TaskContext&gt; taskContexts)</span> </span>&#123;</div><div class="line">   List&lt;TaskContext&gt; failoverTaskContexts = <span class="keyword">new</span> ArrayList&lt;&gt;(taskContexts.size());</div><div class="line">   Collection&lt;String&gt; readyJobNames = <span class="keyword">new</span> HashSet&lt;&gt;(taskContexts.size(), <span class="number">1</span>);</div><div class="line">   <span class="keyword">for</span> (TaskContext each : taskContexts) &#123;</div><div class="line">       <span class="keyword">switch</span> (each.getType()) &#123;</div><div class="line">           <span class="keyword">case</span> FAILOVER:</div><div class="line">               failoverTaskContexts.add(each);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> READY:</div><div class="line">               readyJobNames.add(each.getMetaInfo().getJobName());</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">default</span>:</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ä»å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ä¸­åˆ é™¤ç›¸å…³ä»»åŠ¡</span></div><div class="line">   failoverService.remove(Lists.transform(failoverTaskContexts, <span class="keyword">new</span> Function&lt;TaskContext, TaskContext.MetaInfo&gt;() &#123;</div><div class="line">       </div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="keyword">public</span> TaskContext.<span class="function">MetaInfo <span class="title">apply</span><span class="params">(<span class="keyword">final</span> TaskContext input)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> input.getMetaInfo();</div><div class="line">       &#125;</div><div class="line">   &#125;));</div><div class="line">   <span class="comment">// ä»å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­åˆ é™¤ç›¸å…³ä½œä¸š</span></div><div class="line">   readyService.remove(readyJobNames);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>4.7 æäº¤ä»»åŠ¡ç»™ Mesos</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line"><span class="keyword">for</span> (Entry&lt;List&lt;OfferID&gt;, List&lt;TaskInfo&gt;&gt; each : offerIdTaskInfoMap.entrySet()) &#123;</div><div class="line">   schedulerDriver.launchTasks(each.getKey(), each.getValue());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è°ƒç”¨ <code>SchedulerDriver#launchTasks(...)</code> æ–¹æ³•ï¼Œæäº¤ä»»åŠ¡ç»™ Mesos Masterã€‚ç”± Mesos Master è°ƒåº¦ä»»åŠ¡ç»™ Mesos Slaveã€‚Mesos Slave æäº¤æ‰§è¡Œå™¨æ‰§è¡Œä»»åŠ¡ã€‚</li>
</ul>
<h1>5. TaskExecutor æ‰§è¡Œä»»åŠ¡</h1>
<p>TaskExecutorï¼Œå®ç°äº† Mesos Executor æ¥å£ <code>org.apache.mesos.Executor</code>ã€‚æ‰§è¡Œå™¨çš„ä¸»è¦èŒè´£ä¹‹ä¸€ï¼š<strong>æ‰§è¡Œè°ƒåº¦å™¨æ‰€è¯·æ±‚çš„ä»»åŠ¡</strong>ã€‚TaskExecutor æ¥æ”¶åˆ° Mesos Slave æäº¤çš„ä»»åŠ¡ï¼Œè°ƒç”¨ <code>#launchTask(...)</code> æ–¹æ³•ï¼Œå¤„ç†ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DaemonTaskScheduler.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">launchTask</span><span class="params">(<span class="keyword">final</span> ExecutorDriver executorDriver, <span class="keyword">final</span> Protos.TaskInfo taskInfo)</span> </span>&#123;</div><div class="line">   executorService.submit(<span class="keyword">new</span> TaskThread(executorDriver, taskInfo));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è°ƒç”¨ <code>ExecutorService#submit(...)</code> æ–¹æ³•ï¼Œæäº¤ TaskThread åˆ°çº¿ç¨‹æ± ï¼Œæ‰§è¡Œä»»åŠ¡ã€‚</li>
</ul>
<h2>5.1 TaskThread</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@RequiredArgsConstructor</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> ExecutorDriver executorDriver;</div><div class="line">   </div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> TaskInfo taskInfo;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œè¿è¡Œä¸­ã€‚</span></div><div class="line">       executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_RUNNING).build());</div><div class="line">       <span class="comment">//</span></div><div class="line">       Map&lt;String, Object&gt; data = SerializationUtils.deserialize(taskInfo.getData().toByteArray());</div><div class="line">       ShardingContexts shardingContexts = (ShardingContexts) data.get(<span class="string">"shardingContext"</span>);</div><div class="line">       <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">       JobConfigurationContext jobConfig = <span class="keyword">new</span> JobConfigurationContext((Map&lt;String, String&gt;) data.get(<span class="string">"jobConfigContext"</span>));</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// è·å¾— åˆ†å¸ƒå¼ä½œä¸š</span></div><div class="line">           ElasticJob elasticJob = getElasticJobInstance(jobConfig);</div><div class="line">           <span class="comment">// è°ƒåº¦å™¨æä¾›å†…éƒ¨æœåŠ¡çš„é—¨é¢å¯¹è±¡</span></div><div class="line">           <span class="keyword">final</span> CloudJobFacade jobFacade = <span class="keyword">new</span> CloudJobFacade(shardingContexts, jobConfig, jobEventBus);</div><div class="line">           <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">           <span class="keyword">if</span> (jobConfig.isTransient()) &#123;</div><div class="line">               <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">               JobExecutorFactory.getJobExecutor(elasticJob, jobFacade).execute();</div><div class="line">               <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œå·²å®Œæˆã€‚</span></div><div class="line">               executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_FINISHED).build());</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="comment">// åˆå§‹åŒ– å¸¸é©»ä½œä¸šè°ƒåº¦å™¨</span></div><div class="line">               <span class="keyword">new</span> DaemonTaskScheduler(elasticJob, jobConfig, jobFacade, executorDriver, taskInfo.getTaskId()).init();</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// CHECKSTYLE:OFF</span></div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable ex) &#123;</div><div class="line">           <span class="comment">// CHECKSTYLE:ON</span></div><div class="line">           log.error(<span class="string">"Elastic-Job-Cloud-Executor error"</span>, ex);</div><div class="line">           executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_ERROR).setMessage(ExceptionUtil.transform(ex)).build());</div><div class="line">           executorDriver.stop();</div><div class="line">           <span class="keyword">throw</span> ex;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>ä» <code>TaskInfo.data</code> å±æ€§ä¸­ï¼Œå¯ä»¥è·å¾—æäº¤ä»»åŠ¡é™„å¸¦çš„æ•°æ®ï¼Œä¾‹å¦‚åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ( ShardingContexts )ï¼Œå†…éƒ¨çš„ä½œä¸šé…ç½®ä¸Šä¸‹æ–‡( JobConfigurationContext )ã€‚</p>
</li>
<li>
<p>è°ƒç”¨ <code>#getElasticJobInstance()</code> æ–¹æ³•ï¼Œè·å¾—ä»»åŠ¡éœ€è¦æ‰§è¡Œçš„åˆ†å¸ƒå¼ä½œä¸š( Elastic-Job )ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ElasticJob <span class="title">getElasticJobInstance</span><span class="params">(<span class="keyword">final</span> JobConfigurationContext jobConfig)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!Strings.isNullOrEmpty(jobConfig.getBeanName()) &amp;&amp; !Strings.isNullOrEmpty(jobConfig.getApplicationContext())) &#123; <span class="comment">// spring ç¯å¢ƒ</span></div><div class="line">      <span class="keyword">return</span> getElasticJobBean(jobConfig);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">return</span> getElasticJobClass(jobConfig);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* ä» Spring å®¹å™¨ä¸­è·å¾—ä½œä¸šå¯¹è±¡</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</div><div class="line">* <span class="doctag">@return</span> ä½œä¸šå¯¹è±¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> ElasticJob <span class="title">getElasticJobBean</span><span class="params">(<span class="keyword">final</span> JobConfigurationContext jobConfig)</span> </span>&#123;</div><div class="line">  String applicationContextFile = jobConfig.getApplicationContext();</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">null</span> == applicationContexts.get(applicationContextFile)) &#123;</div><div class="line">      <span class="keyword">synchronized</span> (applicationContexts) &#123;</div><div class="line">          <span class="keyword">if</span> (<span class="keyword">null</span> == applicationContexts.get(applicationContextFile)) &#123;</div><div class="line">              applicationContexts.put(applicationContextFile, <span class="keyword">new</span> ClassPathXmlApplicationContext(applicationContextFile));</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> (ElasticJob) applicationContexts.get(applicationContextFile).getBean(jobConfig.getBeanName());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ›å»ºä½œä¸šå¯¹è±¡</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</div><div class="line">* <span class="doctag">@return</span> ä½œä¸šå¯¹è±¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> ElasticJob <span class="title">getElasticJobClass</span><span class="params">(<span class="keyword">final</span> JobConfigurationContext jobConfig)</span> </span>&#123;</div><div class="line">  String jobClass = jobConfig.getTypeConfig().getJobClass();</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      Class&lt;?&gt; elasticJobClass = Class.forName(jobClass);</div><div class="line">      <span class="keyword">if</span> (!ElasticJob.class.isAssignableFrom(elasticJobClass)) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(<span class="string">"Elastic-Job: Class '%s' must implements ElasticJob interface."</span>, jobClass);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (elasticJobClass != ScriptJob.class) &#123;</div><div class="line">          <span class="keyword">return</span> (ElasticJob) elasticJobClass.newInstance();</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">  &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ReflectiveOperationException ex) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(<span class="string">"Elastic-Job: Class '%s' initialize failure, the error message is '%s'."</span>, jobClass, ex.getMessage());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å½“ä½œä¸šæ˜¯<strong>ç¬æ—¶</strong>ä½œä¸šæ—¶ï¼Œè°ƒç”¨ <code>AbstractElasticJobExecutor#execute(...)</code> æ‰§è¡Œä½œä¸šé€»è¾‘ï¼Œå¹¶è°ƒç”¨ <code>ExecutorDriver#sendStatusUpdate(...)</code> å‘é€çŠ¶æ€ï¼Œæ›´æ–° Mesos ä»»åŠ¡å·²å®Œæˆ( Protos.TaskState.TASK_FINISHED )ã€‚<code>AbstractElasticJobExecutor#execute(...)</code> å®ç°ä»£ç ï¼Œåœ¨ Elastic-Job-Lite å’Œ Elastic-Job-Cloud åŸºæœ¬ä¸€è‡´ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li>
<li>å½“ä½œä¸šæ˜¯<strong>å¸¸é©»</strong>ä½œä¸šæ—¶ï¼Œè°ƒç”¨ <code>DaemonTaskScheduler#init()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–ä½œä¸šè°ƒåº¦ï¼Œåœ¨ã€Œ5.2 DaemonTaskSchedulerã€è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
</ul>
<h2>5.2 DaemonTaskScheduler</h2>
<p><strong>ç¬æ—¶</strong>ä½œä¸šï¼Œé€šè¿‡ Elastic-Job-Cloud-Scheduler è°ƒåº¦ä»»åŠ¡ï¼Œæäº¤ Elastic-Job-Cloud-Executor æ‰§è¡Œåï¼Œç­‰å¾… Elastic-Job-Scheduler è¿›è¡Œä¸‹æ¬¡è°ƒåº¦ã€‚</p>
<p><strong>å¸¸é©»</strong>ä½œä¸šï¼Œé€šè¿‡ Elastic-Job-Scheduler æäº¤ Elastic-Job-Cloud-Executor è¿›è¡Œè°ƒåº¦ã€‚Elastic-Job-Cloud-Executor ä½¿ç”¨ DaemonTaskScheduler ä¸æ–­å¯¹å¸¸é©»ä½œä¸šè¿›è¡Œè°ƒåº¦è€Œæ— éœ€ Elastic-Job-Cloud-Scheduler å‚ä¸å…¶ä¸­ã€‚</p>
<p>è¿™å°±æ˜¯<strong>ç¬æ—¶</strong>ä½œä¸šå’Œ<strong>å¸¸é©»</strong>ä½œä¸šä¸åŒä¹‹å¤„ã€‚</p>
<p>DaemonTaskSchedulerï¼Œå¸¸é©»ä½œä¸šè°ƒåº¦å™¨ã€‚è°ƒç”¨ <code>DaemonTaskScheduler#init()</code> æ–¹æ³•ï¼Œå¯¹<strong>ä¸€ä¸ª</strong>ä½œä¸šåˆå§‹åŒ–è°ƒåº¦ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* åˆå§‹åŒ–ä½œä¸š.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// Quartz JobDetail</span></div><div class="line">   JobDetail jobDetail = JobBuilder.newJob(DaemonJob.class)</div><div class="line">           .withIdentity(jobRootConfig.getTypeConfig().getCoreConfig().getJobName()).build();</div><div class="line">   jobDetail.getJobDataMap().put(ELASTIC_JOB_DATA_MAP_KEY, elasticJob);</div><div class="line">   jobDetail.getJobDataMap().put(JOB_FACADE_DATA_MAP_KEY, jobFacade);</div><div class="line">   jobDetail.getJobDataMap().put(EXECUTOR_DRIVER_DATA_MAP_KEY, executorDriver);</div><div class="line">   jobDetail.getJobDataMap().put(TASK_ID_DATA_MAP_KEY, taskId);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       scheduleJob(initializeScheduler(), jobDetail, taskId.getValue(), jobRootConfig.getTypeConfig().getCoreConfig().getCron());</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> Scheduler <span class="title">initializeScheduler</span><span class="params">()</span> <span class="keyword">throws</span> SchedulerException </span>&#123;</div><div class="line">   StdSchedulerFactory factory = <span class="keyword">new</span> StdSchedulerFactory();</div><div class="line">   factory.initialize(getBaseQuartzProperties());</div><div class="line">   <span class="keyword">return</span> factory.getScheduler();</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> Properties <span class="title">getBaseQuartzProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">   Properties result = <span class="keyword">new</span> Properties();</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.class"</span>, org.quartz.simpl.SimpleThreadPool.class.getName());</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.threadCount"</span>, <span class="string">"1"</span>); <span class="comment">// çº¿ç¨‹æ•°ï¼š1</span></div><div class="line">   result.put(<span class="string">"org.quartz.scheduler.instanceName"</span>, taskId.getValue());</div><div class="line">   <span class="keyword">if</span> (!jobRootConfig.getTypeConfig().getCoreConfig().isMisfire()) &#123;</div><div class="line">       result.put(<span class="string">"org.quartz.jobStore.misfireThreshold"</span>, <span class="string">"1"</span>);</div><div class="line">   &#125;</div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.class"</span>, ShutdownHookPlugin.class.getName());</div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.cleanShutdown"</span>, Boolean.TRUE.toString());</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleJob</span><span class="params">(<span class="keyword">final</span> Scheduler scheduler, <span class="keyword">final</span> JobDetail jobDetail, <span class="keyword">final</span> String triggerIdentity, <span class="keyword">final</span> String cron)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">if</span> (!scheduler.checkExists(jobDetail.getKey())) &#123;</div><div class="line">           scheduler.scheduleJob(jobDetail, createTrigger(triggerIdentity, cron));</div><div class="line">       &#125;</div><div class="line">       scheduler.start();</div><div class="line">       RUNNING_SCHEDULERS.putIfAbsent(scheduler.getSchedulerName(), scheduler);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> CronTrigger <span class="title">createTrigger</span><span class="params">(<span class="keyword">final</span> String triggerIdentity, <span class="keyword">final</span> String cron)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> TriggerBuilder.newTrigger()</div><div class="line">           .withIdentity(triggerIdentity)</div><div class="line">           .withSchedule(CronScheduleBuilder.cronSchedule(cron)</div><div class="line">           .withMisfireHandlingInstructionDoNothing())</div><div class="line">           .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>DaemonTaskScheduler åŸºäº Quartz å®ç°ä½œä¸šè°ƒåº¦ã€‚è¿™é‡Œå¤§å®¶çœ‹ä¸‹æºç ï¼Œå°±ä¸å•°å—¦è§£é‡Šå•¦ã€‚</li>
<li>JobBuilder#newJob(...) çš„å‚æ•°æ˜¯ DaemonJobï¼Œä¸‹æ–‡ä¼šè®²è§£åˆ°ã€‚</li>
</ul>
<p><strong>DaemonJob å®ç°ä»£ç </strong>å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DaemonJob</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> ElasticJob elasticJob;</div><div class="line">   </div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> JobFacade jobFacade;</div><div class="line">   </div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> ExecutorDriver executorDriver;</div><div class="line">    </div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> Protos.TaskID taskId;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</div><div class="line">       ShardingContexts shardingContexts = jobFacade.getShardingContexts();</div><div class="line">       <span class="keyword">int</span> jobEventSamplingCount = shardingContexts.getJobEventSamplingCount();</div><div class="line">       <span class="keyword">int</span> currentJobEventSamplingCount = shardingContexts.getCurrentJobEventSamplingCount();</div><div class="line">       <span class="keyword">if</span> (jobEventSamplingCount &gt; <span class="number">0</span> &amp;&amp; ++currentJobEventSamplingCount &lt; jobEventSamplingCount) &#123;</div><div class="line">           shardingContexts.setCurrentJobEventSamplingCount(currentJobEventSamplingCount);</div><div class="line">           <span class="comment">//</span></div><div class="line">           jobFacade.getShardingContexts().setAllowSendJobEvent(<span class="keyword">false</span>);</div><div class="line">           <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">           JobExecutorFactory.getJobExecutor(elasticJob, jobFacade).execute();</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">//</span></div><div class="line">           jobFacade.getShardingContexts().setAllowSendJobEvent(<span class="keyword">true</span>);</div><div class="line">           <span class="comment">//</span></div><div class="line">           executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskId).setState(Protos.TaskState.TASK_RUNNING).setMessage(<span class="string">"BEGIN"</span>).build());</div><div class="line">           <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">           JobExecutorFactory.getJobExecutor(elasticJob, jobFacade).execute();</div><div class="line">           <span class="comment">//</span></div><div class="line">           executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskId).setState(Protos.TaskState.TASK_RUNNING).setMessage(<span class="string">"COMPLETE"</span>).build());</div><div class="line">           <span class="comment">// </span></div><div class="line">           shardingContexts.setCurrentJobEventSamplingCount(<span class="number">0</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>è°ƒç”¨ <code>AbstractElasticJobExecutor#execute(...)</code> æ‰§è¡Œä½œä¸šé€»è¾‘ã€‚<code>AbstractElasticJobExecutor#execute(...)</code> å®ç°ä»£ç ï¼Œåœ¨ Elastic-Job-Lite å’Œ Elastic-Job-Cloud åŸºæœ¬ä¸€è‡´ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</p>
</li>
<li>
<p><code>jobEventSamplingCount</code> æ¥è‡ªåº”ç”¨é…ç½® (<code>CloudAppConfiguration.eventTraceSamplingCount</code>) å±æ€§ï¼Œå¸¸é©»ä½œä¸šäº‹ä»¶é‡‡æ ·ç‡ç»Ÿè®¡æ¡æ•°ï¼Œé»˜è®¤é‡‡æ ·å…¨éƒ¨è®°å½•ã€‚ä¸ºé¿å…æ•°æ®é‡è¿‡å¤§ï¼Œå¯å¯¹é¢‘ç¹è°ƒåº¦çš„å¸¸é©»ä½œä¸šé…ç½®é‡‡æ ·ç‡ï¼Œå³ä½œä¸šæ¯æ‰§è¡ŒNæ¬¡ï¼Œæ‰ä¼šè®°å½•ä½œä¸šæ‰§è¡ŒåŠè¿½è¸ªç›¸å…³æ•°æ®ã€‚</p>
<p>å½“æ»¡è¶³é‡‡æ ·æ¡ä»¶æ—¶ï¼Œè°ƒç”¨ <code>ShardingContexts#setAllowSendJobEvent(true)</code>ï¼Œæ ‡è®°<strong>è¦</strong>è®°å½•ä½œä¸šäº‹ä»¶ã€‚å¦åˆ™ï¼Œè°ƒç”¨ <code>ShardingContexts#setAllowSendJobEvent(false)</code>ï¼Œæ ‡è®°<strong>ä¸</strong>è®°å½•ä½œä¸šæ—¶é—´ã€‚ä½œä¸šäº‹ä»¶è¿½è¸ªåœ¨<a href="http://www.yunai.me/Elastic-Job/job-event-trace/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šäº‹ä»¶è¿½è¸ªã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</p>
<p>å¦å¤–ï¼Œå½“æ»¡è¶³é‡‡æ ·è°ƒè¯•æ—¶ï¼Œä¹Ÿä¼šè°ƒç”¨ <code>ExecutorDriver#sendStatusUpdate(...)</code> æ–¹æ³•ï¼Œæ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸ºè¿è¡Œä¸­ï¼Œå¹¶é™„å¸¦ <code>&quot;BEGIN&quot;</code> æˆ– <code>&quot;COMPLETE&quot;</code> æ¶ˆæ¯ã€‚</p>
</li>
</ul>
<h1>6. SchedulerEngine å¤„ç†ä»»åŠ¡çš„çŠ¶æ€å˜æ›´</h1>
<p>Mesos è°ƒåº¦å™¨çš„èŒè´£ä¹‹ä¸€ï¼Œ<strong>å¤„ç†ä»»åŠ¡çš„çŠ¶æ€ï¼Œç‰¹åˆ«æ˜¯å“åº”ä»»åŠ¡å’Œæ•…éšœ</strong>ã€‚å› æ­¤åœ¨ Elastic-Job-Cloud-Executor è°ƒç”¨ <code>ExecutorDriver#sendStatusUpdate(...)</code> æ–¹æ³•ï¼Œæ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€æ—¶ï¼Œè§¦å‘è°ƒç”¨ Elastic-Job-Cloud-Scheduler çš„ SchedulerEngine çš„ <code>#statusUpdate(...)</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">statusUpdate</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver, <span class="keyword">final</span> Protos.TaskStatus taskStatus)</span> </span>&#123;</div><div class="line">   String taskId = taskStatus.getTaskId().getValue();</div><div class="line">   TaskContext taskContext = TaskContext.from(taskId);</div><div class="line">   String jobName = taskContext.getMetaInfo().getJobName();</div><div class="line">   log.trace(<span class="string">"call statusUpdate task state is: &#123;&#125;, task id is: &#123;&#125;"</span>, taskStatus.getState(), taskId);</div><div class="line">   jobEventBus.post(<span class="keyword">new</span> JobStatusTraceEvent(jobName, taskContext.getId(), taskContext.getSlaveId(), Source.CLOUD_SCHEDULER, </div><div class="line">           taskContext.getType(), String.valueOf(taskContext.getMetaInfo().getShardingItems()), State.valueOf(taskStatus.getState().name()), taskStatus.getMessage()));</div><div class="line">   <span class="keyword">switch</span> (taskStatus.getState()) &#123;</div><div class="line">       <span class="keyword">case</span> TASK_RUNNING:</div><div class="line">           <span class="keyword">if</span> (!facadeService.load(jobName).isPresent()) &#123;</div><div class="line">               schedulerDriver.killTask(Protos.TaskID.newBuilder().setValue(taskId).build());</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (<span class="string">"BEGIN"</span>.equals(taskStatus.getMessage())) &#123;</div><div class="line">               facadeService.updateDaemonStatus(taskContext, <span class="keyword">false</span>);</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"COMPLETE"</span>.equals(taskStatus.getMessage())) &#123;</div><div class="line">               facadeService.updateDaemonStatus(taskContext, <span class="keyword">true</span>);</div><div class="line">               statisticManager.taskRunSuccessfully();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> TASK_FINISHED:</div><div class="line">           facadeService.removeRunning(taskContext);</div><div class="line">           unAssignTask(taskId);</div><div class="line">           statisticManager.taskRunSuccessfully();</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> TASK_KILLED:</div><div class="line">           log.warn(<span class="string">"task id is: &#123;&#125;, status is: &#123;&#125;, message is: &#123;&#125;, source is: &#123;&#125;"</span>, taskId, taskStatus.getState(), taskStatus.getMessage(), taskStatus.getSource());</div><div class="line">           facadeService.removeRunning(taskContext);</div><div class="line">           facadeService.addDaemonJobToReadyQueue(jobName);</div><div class="line">           unAssignTask(taskId);</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> TASK_LOST:</div><div class="line">       <span class="keyword">case</span> TASK_DROPPED:</div><div class="line">       <span class="keyword">case</span> TASK_GONE:</div><div class="line">       <span class="keyword">case</span> TASK_GONE_BY_OPERATOR:</div><div class="line">       <span class="keyword">case</span> TASK_FAILED:</div><div class="line">       <span class="keyword">case</span> TASK_ERROR:</div><div class="line">           log.warn(<span class="string">"task id is: &#123;&#125;, status is: &#123;&#125;, message is: &#123;&#125;, source is: &#123;&#125;"</span>, taskId, taskStatus.getState(), taskStatus.getMessage(), taskStatus.getSource());</div><div class="line">           facadeService.removeRunning(taskContext);</div><div class="line">           facadeService.recordFailoverTask(taskContext);</div><div class="line">           unAssignTask(taskId);</div><div class="line">           statisticManager.taskRunFailed();</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> TASK_UNKNOWN:</div><div class="line">       <span class="keyword">case</span> TASK_UNREACHABLE:</div><div class="line">           log.error(<span class="string">"task id is: &#123;&#125;, status is: &#123;&#125;, message is: &#123;&#125;, source is: &#123;&#125;"</span>, taskId, taskStatus.getState(), taskStatus.getMessage(), taskStatus.getSource());</div><div class="line">           statisticManager.taskRunFailed();</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">default</span>:</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>å½“æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸º <code>TASK_RUNNING</code> æ—¶ï¼Œæ ¹æ®é™„å¸¦æ¶ˆæ¯ä¸º <code>&quot;BEGIN&quot;</code> æˆ– <code>&quot;COMPLETE&quot;</code>ï¼Œåˆ†åˆ«è°ƒç”¨ <code>FacadeService#updateDaemonStatus(false / true)</code> æ–¹æ³•ï¼Œæ›´æ–°ä½œä¸šé—²ç½®çŠ¶æ€ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ›´æ–°å¸¸é©»ä½œä¸šè¿è¡ŒçŠ¶æ€.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</div><div class="line">* <span class="doctag">@param</span> isIdle æ˜¯å¦ç©ºé—²</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateDaemonStatus</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> <span class="keyword">boolean</span> isIdle)</span> </span>&#123;</div><div class="line">   runningService.updateIdle(taskContext, isIdle);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">// RunningService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ›´æ–°ä½œä¸šé—²ç½®çŠ¶æ€.</div><div class="line">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</div><div class="line">* <span class="doctag">@param</span> isIdle æ˜¯å¦é—²ç½®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateIdle</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> <span class="keyword">boolean</span> isIdle)</span> </span>&#123;</div><div class="line">   <span class="keyword">synchronized</span> (RUNNING_TASKS) &#123;</div><div class="line">       Optional&lt;TaskContext&gt; taskContextOptional = findTask(taskContext);</div><div class="line">       <span class="keyword">if</span> (taskContextOptional.isPresent()) &#123;</div><div class="line">           taskContextOptional.get().setIdle(isIdle);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           add(taskContext);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è‹¥ä½œä¸šé…ç½®ä¸å­˜åœ¨æ—¶ï¼Œè°ƒç”¨ <code>SchedulerDriver#killTask(...)</code> æ–¹æ³•ï¼Œæ€æ­»è¯¥ Mesos ä»»åŠ¡ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/cloud-job-scheduler-and-executor-second/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆäºŒï¼‰ã€‹</a>è¿›ä¸€æ­¥è§£æã€‚</p>
</li>
<li>
<p>å½“æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸º <code>TASK_FINISHED</code> æ—¶ï¼Œè°ƒç”¨ <code>FacadeService#removeRunning(...)</code> æ–¹æ³•ï¼Œå°†ä»»åŠ¡ä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å°†ä»»åŠ¡ä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeRunning</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   runningService.remove(taskContext);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RunningService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å°†ä»»åŠ¡ä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   <span class="comment">// ç§»é™¤è¿è¡Œä¸­çš„ä»»åŠ¡é›†åˆ</span></div><div class="line">   getRunningTasks(taskContext.getMetaInfo().getJobName()).remove(taskContext);</div><div class="line">   <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºå¸¸é©»ä»»åŠ¡</span></div><div class="line">   <span class="keyword">if</span> (!isDaemonOrAbsent(taskContext.getMetaInfo().getJobName())) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å°†ä»»åŠ¡ä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤</span></div><div class="line">   regCenter.remove(RunningNode.getRunningTaskNodePath(taskContext.getMetaInfo().toString()));</div><div class="line">   String jobRootNode = RunningNode.getRunningJobNodePath(taskContext.getMetaInfo().getJobName());</div><div class="line">   <span class="keyword">if</span> (regCenter.isExisted(jobRootNode) &amp;&amp; regCenter.getChildrenKeys(jobRootNode).isEmpty()) &#123;</div><div class="line">       regCenter.remove(jobRootNode);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å½“è¯¥ä½œä¸šå¯¹åº”çš„æ‰€æœ‰ Mesos ä»»åŠ¡çŠ¶æ€éƒ½æ›´æ–°ä¸º <code>TASK_FINISHED</code> åï¼Œä½œä¸šå¯ä»¥å†æ¬¡è¢« Elastic-Job-Cloud-Scheduler è°ƒåº¦ã€‚</li>
</ul>
<p>è°ƒç”¨ <code>#unAssignTask(...)</code> æ–¹æ³•ï¼Œé€šçŸ¥ TaskScheduler ä»»åŠ¡è¢«<strong>ç¡®è®¤</strong>æœªåˆ†é…åˆ°è¿™ä¸ªä¸»æœºã€‚TaskScheduler åšä»»åŠ¡å’Œ Offer çš„åŒ¹é…ï¼Œå¯¹å“ªäº›ä»»åŠ¡è¿è¡Œåœ¨å“ªäº›ä¸»æœºæ˜¯æœ‰ä¾èµ–çš„ï¼Œä¸ç„¶æ€ä¹ˆåšåŒ¹é…ä¼˜åŒ–å‘¢ã€‚åœ¨<a href="https://github.com/Netflix/Fenzo/wiki/How-to-use-Fenzo#notify-the-scheduler-of-assigns-and-unassigns-of-tasks" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Notify the Scheduler of Assigns and UnAssigns of Tasksã€‹</a>å¯ä»¥è¿›ä¸€æ­¥äº†è§£ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unAssignTask</span><span class="params">(<span class="keyword">final</span> String taskId)</span> </span>&#123;</div><div class="line">    String hostname = facadeService.popMapping(taskId);</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != hostname) &#123;</div><div class="line">        taskScheduler.getTaskUnAssigner().call(TaskContext.getIdForUnassignedSlave(taskId), hostname);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
<li>
<p>å½“æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸º <code>TASK_KILLED</code> æ—¶ï¼Œè°ƒç”¨ <code>FacadeService#addDaemonJobToReadyQueue(...)</code> æ–¹æ³•ï¼Œå°†å¸¸é©»ä½œä¸šæ”¾å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/cloud-job-scheduler-and-executor-second/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆäºŒï¼‰ã€‹</a>è¿›ä¸€æ­¥è§£æã€‚TODO</p>
<p>å¦å¤–ä¼šè°ƒç”¨ <code>FacadeService#removeRunning(...)</code>ã€<code>#unAssignTask(...)</code> æ–¹æ³•ã€‚</p>
</li>
<li>
<p>å½“æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸º <code>TASK_ERROR</code> ç­‰ç­‰æ—¶ï¼Œè°ƒç”¨ <code>FacadeService#recordFailoverTask(...)</code> æ–¹æ³•ï¼Œåœ¨ <a href="TODO">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>è¯¦ç»†è§£æã€‚</p>
<p>å¦å¤–ä¼šè°ƒç”¨ <code>FacadeService#removeRunning(...)</code> å’Œ <code>#unAssignTask(...)</code> æ–¹æ³•ã€‚</p>
</li>
</ul>
<h1>666. å½©è›‹</h1>
<p>æ—ç™½å›ï¼šçœŸçš„çœŸçš„çœŸçš„ï¼Œå¥½é•¿å¥½é•¿å¥½é•¿å•Šã€‚ä½†æ˜¯çœŸçš„çœŸçš„çœŸçš„ï¼Œå¹²è´§ï¼<br>
èŠ‹é“å›ï¼šé‚£å¿…é¡»çš„ï¼</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_12_21/12.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ä½œä¸šæ‰§è¡Œç±»å‹&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;
    
    </summary>
    
      <category term="Elastic-Job-Cloud" scheme="http://www.yunai.me/categories/Elastic-Job-Cloud/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®</title>
    <link href="http://www.yunai.me/Elastic-Job/cloud-job-config/"/>
    <id>http://www.yunai.me/Elastic-Job/cloud-job-config/</id>
    <published>2017-12-13T16:00:00.000Z</published>
    <updated>2017-09-04T15:19:43.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. äº‘ä½œä¸šApp</a><ul>
<li><a href="#">2.1 äº‘ä½œä¸šAppé…ç½®ç±»</a></li>
<li><a href="#">2.2 æ“ä½œäº‘ä½œä¸šAppé…ç½®</a></li>
</ul>
</li>
<li><a href="#3">3. äº‘ä½œä¸š</a><ul>
<li><a href="#">3.1 äº‘ä½œä¸šé…ç½®</a><ul>
<li><a href="#">3.1.1 æ“ä½œäº‘ä½œä¸šé…ç½®</a></li>
</ul>
</li>
<li><a href="#">3.2 æœ¬åœ°äº‘ä½œä¸šé…ç½®</a></li>
<li><a href="#">3.3 äº‘ä½œä¸šé…ç½®æ€»ç»“</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Cloud ä½œä¸šé…ç½®</strong>ã€‚</p>
<p>å¦‚æœä½ é˜…è¯»è¿‡ä»¥ä¸‹æ–‡ç« ï¼Œæœ‰åŠ©äºå¯¹æœ¬æ–‡çš„ç†è§£ï¼š</p>
<ul>
<li><a href="http://elasticjob.io/docs/elastic-job-cloud/02-guide/cloud-restful-api/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” RESTFUL APIã€‹</a></li>
<li><a href="http://www.yunai.me/Elastic-Job/job-config/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹</a></li>
<li><a href="https://segmentfault.com/a/1190000007723430" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç”±æµ…å…¥æ·± | å¦‚ä½•ä¼˜é›…åœ°å†™ä¸€ä¸ªMesos Frameworkã€‹</a></li>
</ul>
<p>ğŸ˜ˆ å¦å¤–ï¼Œç¬”è€…å‡è®¾ä½ å·²ç»å¯¹ <strong><a href="http://www.yunai.me/categories/Elastic-Job/?self">ã€ŠElastic-Job-Lite æºç åˆ†æç³»åˆ—ã€‹</a></strong> æœ‰ä¸€å®šçš„äº†è§£ã€‚</p>
<p>æœ¬æ–‡æ¶‰åŠåˆ°ä¸»ä½“ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_12_14/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_12_14/01.png" alt=""></p>
<ul>
<li><strong>é»„è‰²</strong>çš„ç±»åœ¨ <code>elastic-job-common-core</code> é¡¹ç›®é‡Œï¼Œä¸º Elastic-Job-Liteã€Elastic-Job-Cloud <strong>å…¬ç”¨</strong>ä½œä¸šé…ç½®ç±»ã€‚</li>
<li><strong>ç´«è‰²</strong>çš„ç±»åœ¨ <code>elastic-job-cloud</code> é¡¹ç›®é‡Œï¼Œä¸º Elastic-Job-Cloud ä½œä¸šé…ç½®ç±»ã€‚</li>
<li><strong>çº¢è‰²</strong>çš„ç±»åœ¨ <code>elastic-job-lite</code> é¡¹ç›®é‡Œï¼Œä¸º Elastic-Job-Lite ä½œä¸šé…ç½®ç±»ã€‚</li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-äº‘ä½œä¸šApp"><a href="#2-äº‘ä½œä¸šApp" class="headerlink" title="2. äº‘ä½œä¸šApp"></a>2. äº‘ä½œä¸šApp</h1><p>é¦–å…ˆï¼Œç†è§£ä¸‹ <strong>äº‘ä½œä¸šApp</strong> çš„å®šä¹‰ï¼š</p>
<blockquote>
<p>FROM <a href="http://dangdangdotcom.github.io/elastic-job/elastic-job-cloud/02-guide/cloud-concepts/" rel="external nofollow noopener noreferrer" target="_blank">http://dangdangdotcom.github.io/elastic-job/elastic-job-cloud/02-guide/cloud-concepts/</a>      </p>
<p>ä½œä¸šAPPæŒ‡ä½œä¸šæ‰“åŒ…éƒ¨ç½²åçš„åº”ç”¨ï¼Œæè¿°äº†ä½œä¸šå¯åŠ¨éœ€è¦ç”¨åˆ°çš„CPUã€å†…å­˜ã€å¯åŠ¨è„šæœ¬åŠåº”ç”¨ä¸‹è½½è·¯å¾„ç­‰åŸºæœ¬ä¿¡æ¯ï¼Œæ¯ä¸ªAPPå¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªä½œä¸šã€‚</p>
</blockquote>
<p>ç®€å•æ¥è¯´ï¼Œä¸€ä¸ªäº‘ä½œä¸šAppå¯ä»¥ç†è§£æˆç”±å¤šä¸ªä½œä¸šæ‰“åœ¨ä¸€èµ·çš„ <code>jar</code>ã€‚</p>
<h2 id="2-1-äº‘ä½œä¸šAppé…ç½®ç±»"><a href="#2-1-äº‘ä½œä¸šAppé…ç½®ç±»" class="headerlink" title="2.1 äº‘ä½œä¸šAppé…ç½®ç±»"></a>2.1 äº‘ä½œä¸šAppé…ç½®ç±»</h2><p>CloudAppConfigurationï¼Œäº‘ä½œä¸šAppé…ç½®ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudAppConfiguration</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åº”ç”¨å</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String appName;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åº”ç”¨åŒ…åœ°å€</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String appURL;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åº”ç”¨å¯åŠ¨è„šæœ¬</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String bootstrapScript;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * cpu æ•°é‡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">double</span> cpuCount = <span class="number">1</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å†…å­˜ å¤§å°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">double</span> memoryMB = <span class="number">128</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ¯æ¬¡æ‰§è¡Œä½œä¸šæ—¶æ˜¯å¦ä»ç¼“å­˜ä¸­è¯»å–åº”ç”¨ã€‚ç¦ç”¨åˆ™æ¯æ¬¡æ‰§è¡Œä»»åŠ¡å‡ä»åº”ç”¨ä»“åº“ä¸‹è½½åº”ç”¨è‡³æœ¬åœ°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> appCacheEnable = <span class="keyword">true</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¸¸é©»ä½œä¸šäº‹ä»¶é‡‡æ ·ç‡ç»Ÿè®¡æ¡æ•°ï¼Œé»˜è®¤ä¸é‡‡æ ·å…¨éƒ¨è®°å½•ã€‚</div><div class="line">     * ä¸ºé¿å…æ•°æ®é‡è¿‡å¤§ï¼Œå¯å¯¹é¢‘ç¹è°ƒåº¦çš„å¸¸é©»ä½œä¸šé…ç½®é‡‡æ ·ç‡ï¼Œå³ä½œä¸šæ¯æ‰§è¡ŒNæ¬¡ï¼Œæ‰ä¼šè®°å½•ä½œä¸šæ‰§è¡ŒåŠè¿½è¸ªç›¸å…³æ•°æ®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> eventTraceSamplingCount;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>åœ¨ Elastic-Job-Lite é‡Œï¼Œæ‰“åŒ…ä½œä¸šï¼Œéƒ¨ç½²åˆ°æœåŠ¡å™¨é‡Œå¯åŠ¨ã€‚è€Œåœ¨ Elastic-Job-Cloud é‡Œï¼Œæ‰“åŒ…ä½œä¸šä¸Šä¼ è‡³å¯ä¸‹è½½çš„åœ°å€ã€‚ä½œä¸šè¢«è°ƒåº¦æ—¶ï¼ŒMesos ä¼šä» <code>appURL</code> ä¸‹è½½åº”ç”¨åŒ…ï¼Œä½¿ç”¨ <code>bootstrapScript</code> å¯åŠ¨åº”ç”¨è¿›è¡Œæ‰§è¡Œã€‚å®é™…æƒ…å†µä¼šæ›´åŠ å¤æ‚ä¸€ä¸¢ä¸¢ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/cloud-job-scheduler-and-executor/?self">ã€ŠElastic-Job-Cloud æºç è§£æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>è¯¦ç»†è§£æã€‚</li>
<li><code>cpuCount</code>, <code>memoryMB</code> é…ç½®<strong>äº‘ä½œä¸šAppè‡ªèº«å ç”¨çš„èµ„æºæƒ…å†µ</strong>ã€‚å…¶åŒ…å«çš„æ¯ä¸ªä½œä¸šå ç”¨çš„èµ„æºæƒ…å†µï¼Œä½¿ç”¨ä½œä¸šå¯¹åº”çš„äº‘ä½œä¸šé…ç½®( CloudJobConfiguration ) ï¼Œä¸‹æ–‡ä¹Ÿä¼šçœ‹åˆ°ã€‚</li>
<li><code>appCacheEnable</code>ï¼šæ¯æ¬¡æ‰§è¡Œä½œä¸šæ—¶æ˜¯å¦ä»ç¼“å­˜ä¸­è¯»å–åº”ç”¨ã€‚ç¦ç”¨åˆ™æ¯æ¬¡æ‰§è¡Œä»»åŠ¡å‡ä»åº”ç”¨ä»“åº“ä¸‹è½½åº”ç”¨è‡³æœ¬åœ°ã€‚</li>
<li><code>eventTraceSamplingCount</code>ï¼šå¸¸é©»ä½œä¸šäº‹ä»¶é‡‡æ ·ç‡ç»Ÿè®¡æ¡æ•°ï¼Œé»˜è®¤é‡‡æ ·å…¨éƒ¨è®°å½•ã€‚ä¸ºé¿å…æ•°æ®é‡è¿‡å¤§ï¼Œå¯å¯¹é¢‘ç¹è°ƒåº¦çš„å¸¸é©»ä½œä¸šé…ç½®é‡‡æ ·ç‡ï¼Œå³ä½œä¸šæ¯æ‰§è¡ŒNæ¬¡ï¼Œæ‰ä¼šè®°å½•ä½œä¸šæ‰§è¡ŒåŠè¿½è¸ªç›¸å…³æ•°æ®ã€‚</li>
</ul>
<h2 id="2-2-æ“ä½œäº‘ä½œä¸šAppé…ç½®"><a href="#2-2-æ“ä½œäº‘ä½œä¸šAppé…ç½®" class="headerlink" title="2.2 æ“ä½œäº‘ä½œä¸šAppé…ç½®"></a>2.2 æ“ä½œäº‘ä½œä¸šAppé…ç½®</h2><p>äº‘ä½œä¸šAppé…ç½®æœ‰å¤šç§æ“ä½œï¼š</p>
<ol>
<li>æ·»åŠ  / æ›´æ–° / åˆ é™¤</li>
<li>å¼€å¯ / ç¦ç”¨</li>
</ol>
<p>æœ‰ä¸¤ç§æ–¹å¼è¿›è¡Œæ“ä½œï¼Œä»¥<strong>æ·»åŠ </strong>ä¸¾ä¾‹å­ï¼š</p>
<ul>
<li><p>è°ƒç”¨ HTTP æ¥å£ï¼š</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">curl -l -H "Content-type: application/json" -X POST -d '&#123;"appName":"foo_app","appURL":"http://app_host:8080/yourJobs.gz","cpuCount":0.1,"memoryMB":64.0,"bootstrapScript":"bin/start.sh","appCacheEnable":true,"eventTraceSamplingCount":0&#125;' http://elastic_job_cloud_host:8899/api/app</div></pre></td></tr></table></figure>
</li>
<li><p>è¿ç»´å¹³å°</p>
<p>  <img src="http://www.yunai.me/images/Elastic-Job/2017_12_14/02.png" alt=""></p>
</li>
</ul>
<p>è¿ç»´å¹³å°æ˜¯å¯¹è°ƒç”¨ HTTP æ¥å£çš„UIå°è£…ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CloudAppRestfulApi</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/app"</span>)</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudAppRestfulApi</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ³¨å†Œåº”ç”¨é…ç½®.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> appConfig åº”ç”¨é…ç½®</div><div class="line">     */</div><div class="line">    <span class="meta">@POST</span></div><div class="line">    <span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> CloudAppConfiguration appConfig)</span> </span>&#123;</div><div class="line">        Optional&lt;CloudAppConfiguration&gt; appConfigFromZk = appConfigService.load(appConfig.getAppName());</div><div class="line">        <span class="keyword">if</span> (appConfigFromZk.isPresent()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AppConfigurationException(<span class="string">"app '%s' already existed."</span>, appConfig.getAppName());</div><div class="line">        &#125;</div><div class="line">        appConfigService.add(appConfig);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CloudAppConfigurationService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ·»åŠ äº‘ä½œä¸šAPPé…ç½®.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> appConfig äº‘ä½œä¸šAppé…ç½®å¯¹è±¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> CloudAppConfiguration appConfig)</span> </span>&#123;</div><div class="line">   regCenter.persist(CloudAppConfigurationNode.getRootNodePath(appConfig.getAppName()), CloudAppConfigurationGsonFactory.toJson(appConfig));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CloudAppConfigurationNode.JAVA</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudAppConfigurationNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT =  <span class="string">"/config/app"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String APP_CONFIG =  ROOT + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;APP_NAME&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>CloudAppRestfulApiï¼Œäº‘ä½œä¸šåº”ç”¨çš„REST APIï¼Œå®ç°äº†äº‘ä½œä¸šAppé…ç½®çš„å¤šç§æ“ä½œçš„ HTTP æ¥å£ã€‚</li>
<li>CloudAppConfigurationServiceï¼Œäº‘ä½œä¸šAppé…ç½®æœåŠ¡ï¼Œå®ç°äº†äº‘ä½œä¸šåº”ç”¨çš„å­˜å‚¨åŠŸèƒ½ã€‚</li>
<li>è°ƒç”¨ <code>AppConfigService#add(...)</code> æ–¹æ³•ï¼Œå­˜å‚¨ CloudAppConfiguration åˆ°æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>${NAMESPACE}/config/app/${APP_NAME}</code>ï¼ŒJSON æ ¼å¼åŒ–å¯¹è±¡ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 1] get /elastic-job-cloud/config/app/exampleApp</div><div class="line">&#123;"appName":"exampleApp","appURL":"http://785j8w.com1.z0.glb.clouddn.com/elastic-job-example-cloud-2.1.5.tar.gz","bootstrapScript":"bin/start.sh","cpuCount":1.0,"memoryMB":128.0,"appCacheEnable":true,"eventTraceSamplingCount":0&#125;</div></pre></td></tr></table></figure>
<h1 id="3-äº‘ä½œä¸š"><a href="#3-äº‘ä½œä¸š" class="headerlink" title="3. äº‘ä½œä¸š"></a>3. äº‘ä½œä¸š</h1><p>ä¸€ä¸ªäº‘ä½œä¸šåº”ç”¨å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªäº‘ä½œä¸šã€‚äº‘ä½œä¸šæœ‰<strong>ä¸¤ç§</strong>ä½œä¸šé…ç½®ï¼šäº‘ä½œä¸šé…ç½®ã€æœ¬åœ°äº‘ä½œä¸šé…ç½®ã€‚ä¸‹é¢æ¥åˆ†åˆ«åˆ†äº«å®ƒä»¬ã€‚</p>
<h2 id="3-1-äº‘ä½œä¸šé…ç½®"><a href="#3-1-äº‘ä½œä¸šé…ç½®" class="headerlink" title="3.1 äº‘ä½œä¸šé…ç½®"></a>3.1 äº‘ä½œä¸šé…ç½®</h2><p>CloudJobConfigurationï¼Œäº‘ä½œä¸šé…ç½®ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudJobConfiguration</span> <span class="keyword">implements</span> <span class="title">JobRootConfiguration</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåº”ç”¨åç§° &#123;<span class="doctag">@link</span> com.dangdang.ddframe.job.cloud.scheduler.config.app.CloudAppConfiguration&#125;</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String appName;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šç±»å‹é…ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobTypeConfiguration typeConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å•ç‰‡ä½œä¸šæ‰€éœ€è¦çš„CPUæ•°é‡ï¼Œæœ€å°å€¼ä¸º0.001</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">double</span> cpuCount;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å•ç‰‡ä½œä¸šæ‰€éœ€è¦çš„å†…å­˜MBï¼Œæœ€å°å€¼ä¸º1</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">double</span> memoryMB;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šæ‰§è¡Œç±»å‹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CloudJobExecutionType jobExecutionType;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Springå®¹å™¨ä¸­é…ç½®çš„beanåç§°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String beanName;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Springæ–¹å¼é…ç½®Springé…ç½®æ–‡ä»¶ç›¸å¯¹è·¯å¾„ä»¥åŠåç§°ï¼Œå¦‚ï¼šMETA-INF\applicationContext.xml</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String applicationContext; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>JobTypeConfigurationï¼Œä½œä¸šç±»å‹é…ç½®ï¼Œåœ¨ <code>elastic-job-common-core</code> é¡¹ç›®é‡Œï¼Œä¸º Elastic-Job-Liteã€Elastic-Job-Cloud <strong>å…¬ç”¨</strong>ä½œä¸šé…ç½®ç±»ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-config/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹çš„ã€Œ2.2.1 ä½œä¸šç±»å‹é…ç½®ã€</a>æœ‰è¯¦ç»†è§£æã€‚</li>
<li><code>cpuCount</code>, <code>memoryMB</code> é…ç½®<strong>å•ç‰‡ä½œä¸šå ç”¨çš„èµ„æºæƒ…å†µ</strong>ã€‚è¿™é‡Œä¸€å®šè¦æ³¨æ„æ˜¯å•ç‰‡ä½œä¸šï¼Œä¾‹å¦‚ä¸€ä¸ªä½œä¸šæœ‰ä¸‰ä¸ªåˆ†ç‰‡( <code>shardingTotalCount = 3</code> )ï¼Œåˆ™å ç”¨èµ„æºä¸º 3 <em> <code>cpuCount</code> + 3 </em> <code>memoryMB</code>ã€‚</li>
<li>ä½œä¸šæ‰§è¡Œç±»å‹( CloudJobExecutionType )æœ‰ä¸¤ç§ï¼šå¸¸é©»ä½œä¸š( DAEMON )ï¼Œç¬æ—¶ä½œä¸š( TRANSIENT )ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/cloud-job-scheduler-and-executor/?self">ã€ŠElastic-Job-Cloud æºç è§£æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>è¯¦ç»†è§£æã€‚Elastic-Job-Cloud ç‹¬æœ‰ï¼Œéå¸¸æœ‰è¶£ã€‚ğŸ‘ğŸ‘ğŸ‘</li>
<li><code>beanName</code>, <code>applicationContext</code> å®ç° Spring å¯åŠ¨æ–¹å¼ä½œä¸šã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/cloud-job-scheduler-and-executor/?self">ã€ŠElastic-Job-Cloud æºç è§£æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li>
</ul>
<h3 id="3-1-1-æ“ä½œäº‘ä½œä¸šé…ç½®"><a href="#3-1-1-æ“ä½œäº‘ä½œä¸šé…ç½®" class="headerlink" title="3.1.1 æ“ä½œäº‘ä½œä¸šé…ç½®"></a>3.1.1 æ“ä½œäº‘ä½œä¸šé…ç½®</h3><p>äº‘ä½œä¸šé…ç½®æœ‰å¤šç§æ“ä½œï¼š</p>
<ol>
<li>æ·»åŠ  / æ›´æ–° / åˆ é™¤</li>
<li>å¼€å¯ / ç¦ç”¨</li>
</ol>
<p>æœ‰ä¸¤ç§æ–¹å¼è¿›è¡Œæ“ä½œï¼Œä»¥<strong>æ·»åŠ </strong>ä¸¾ä¾‹å­ï¼š</p>
<ul>
<li><p>è°ƒç”¨ HTTP æ¥å£ï¼š</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">// Javaå¯åŠ¨æ–¹å¼ä½œä¸šæ³¨å†Œ</div><div class="line">curl -l -H "Content-type: application/json" -X POST -d '&#123;"jobName":"foo_job","appName":"foo_app","jobClass":"yourJobClass","jobType":"SIMPLE","jobExecutionType":"TRANSIENT","cron":"0/5 * * * * ?","shardingTotalCount":5,"cpuCount":0.1,"memoryMB":64.0,"appURL":"http://app_host:8080/foo-job.tar.gz","failover":true,"misfire":true,"bootstrapScript":"bin/start.sh"&#125;' http://elastic_job_cloud_host:8899/api/job/register</div><div class="line"></div><div class="line">// Springå¯åŠ¨æ–¹å¼ä½œä¸šæ³¨å†Œ</div><div class="line">curl -l -H "Content-type: application/json" -X POST -d '&#123;"jobName":"foo_job","jobClass":"yourJobClass","beanName":"yourBeanName","applicationContext":"applicationContext.xml","jobType":"SIMPLE","jobExecutionType":"TRANSIENT","cron":"0/5 * * * * ?","shardingTotalCount":5,"cpuCount":0.1,"memoryMB":64.0,"appURL":"http://file_host:8080/foo-job.tar.gz","failover":false,"misfire":true,"bootstrapScript":"bin/start.sh"&#125;' http://elastic_job_cloud_masterhost:8899/api/job/register</div></pre></td></tr></table></figure>
</li>
<li><p>è¿ç»´å¹³å°</p>
<p>  <img src="http://www.yunai.me/images/Elastic-Job/2017_12_14/03.png" alt=""></p>
</li>
</ul>
<p>è¿ç»´å¹³å°æ˜¯å¯¹è°ƒç”¨ HTTP æ¥å£çš„UIå°è£…ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CloudJobRestfulApi.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudJobRestfulApi</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ³¨å†Œä½œä¸š.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</div><div class="line">     */</div><div class="line">    <span class="meta">@POST</span></div><div class="line">    <span class="meta">@Path</span>(<span class="string">"/register"</span>)</div><div class="line">    <span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">        producerManager.register(jobConfig);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ProducerManager.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerManager</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ³¨å†Œä½œä¸š.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (disableJobService.isDisabled(jobConfig.getJobName())) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Job '%s' has been disable."</span>, jobConfig.getJobName());</div><div class="line">        &#125;</div><div class="line">        Optional&lt;CloudAppConfiguration&gt; appConfigFromZk = appConfigService.load(jobConfig.getAppName());</div><div class="line">        <span class="keyword">if</span> (!appConfigFromZk.isPresent()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AppConfigurationException(<span class="string">"Register app '%s' firstly."</span>, jobConfig.getAppName());</div><div class="line">        &#125;</div><div class="line">        Optional&lt;CloudJobConfiguration&gt; jobConfigFromZk = configService.load(jobConfig.getJobName());</div><div class="line">        <span class="keyword">if</span> (jobConfigFromZk.isPresent()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Job '%s' already existed."</span>, jobConfig.getJobName());</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// æ·»åŠ äº‘ä½œä¸šé…ç½®</span></div><div class="line">        configService.add(jobConfig);</div><div class="line">        <span class="comment">// è°ƒåº¦ä½œä¸š</span></div><div class="line">        schedule(jobConfig);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CloudJobConfigurationService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ·»åŠ äº‘ä½œä¸šé…ç½®.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> jobConfig äº‘ä½œä¸šé…ç½®å¯¹è±¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   regCenter.persist(CloudJobConfigurationNode.getRootNodePath(jobConfig.getJobName()), CloudJobConfigurationGsonFactory.toJson(jobConfig));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CloudJobConfigurationNode.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudJobConfigurationNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT =  <span class="string">"/config/job"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String JOB_CONFIG =  ROOT + <span class="string">"/%s"</span>;  <span class="comment">// %s = $&#123;JOB_NAME&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>CloudJobRestfulApiï¼Œä½œä¸šäº‘Jobçš„REST APIï¼Œå®ç°äº†ä½œä¸šäº‘Jobé…ç½®çš„å¤šç§æ“ä½œã€æŸ¥è¯¢è¿è¡Œä¸­ / å¾…è¿è¡Œ / å¤±æ•ˆè½¬ç§»ä½œä¸šåˆ—è¡¨ç­‰ HTTP æ¥å£ã€‚</li>
<li>ProducerManagerï¼Œå‘å¸ƒä»»åŠ¡ä½œä¸šè°ƒåº¦ç®¡ç†å™¨ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç±»ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/cloud-job-scheduler-and-executor/?self">ã€ŠElastic-Job-Cloud æºç è§£æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>è¯¦ç»†è§£æã€‚</li>
<li>CloudJobConfigurationServiceï¼Œä½œä¸šé…ç½®æœåŠ¡ï¼Œå®ç°äº†ä½œä¸šé…ç½®çš„å­˜å‚¨åŠŸèƒ½ã€‚</li>
<li><p>è°ƒç”¨ <code>CloudJobConfigurationService#add(...)</code> æ–¹æ³•ï¼Œå­˜å‚¨ CloudJobConfiguration åˆ°æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>${NAMESPACE}/config/job/${JOB_NAME}</code>ï¼ŒJSON æ ¼å¼åŒ–å¯¹è±¡ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">    [zk: localhost:2181(CONNECTED) 3] get /elastic-job-cloud/config/job/test_job_simple</div><div class="line">&#123;"jobName":"test_job_simple","jobClass":"com.dangdang.ddframe.job.example.job.simple.JavaSimpleJob","jobType":"SIMPLE","cron":"0/10 * * * * ?","shardingTotalCount":1,"shardingItemParameters":"","jobParameter":"","failover":false,"misfire":false,"description":"","jobProperties":&#123;"job_exception_handler":"com.dangdang.ddframe.job.executor.handler.impl.DefaultJobExceptionHandler","executor_service_handler":"com.dangdang.ddframe.job.executor.handler.impl.DefaultExecutorServiceHandler"&#125;,"appName":"exampleApp","cpuCount":0.1,"memoryMB":64.0,"jobExecutionType":"TRANSIENT"&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>#schedule(...)</code> æ–¹æ³•ï¼Œè°ƒåº¦ä½œä¸šã€‚è¿™æ˜¯ä¸ªå¾ˆæœ‰è¶£çš„æ–¹æ³•ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/cloud-job-scheduler-and-executor/?self">ã€ŠElastic-Job-Cloud æºç è§£æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>è¯¦ç»†è§£æã€‚</p>
</li>
</ul>
<h2 id="3-2-æœ¬åœ°äº‘ä½œä¸šé…ç½®"><a href="#3-2-æœ¬åœ°äº‘ä½œä¸šé…ç½®" class="headerlink" title="3.2 æœ¬åœ°äº‘ä½œä¸šé…ç½®"></a>3.2 æœ¬åœ°äº‘ä½œä¸šé…ç½®</h2><p>LocalCloudJobConfigurationï¼Œæœ¬åœ°äº‘ä½œä¸šé…ç½®ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public final class LocalCloudJobConfiguration implements JobRootConfiguration &#123;</div><div class="line">    </div><div class="line">    private final JobTypeConfiguration typeConfig;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * åˆ†ç‰‡ä½œä¸šåºå·</div><div class="line">     */</div><div class="line">    private final int shardingItem;</div><div class="line">    </div><div class="line">    private String beanName;</div><div class="line">    </div><div class="line">    private String applicationContext;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>shardingItem</code>ï¼Œåˆ†ç‰‡ä½œä¸šåºå·ï¼Œç”¨äºæœ¬åœ°è°ƒè¯•æŒ‡å®šåˆ†ç‰‡ä½œä¸šé¡¹ã€‚</li>
</ul>
<p>åˆ°åº•æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ</p>
<blockquote>
<p>åœ¨å¼€å‘Elastic-Job-Cloudä½œä¸šæ—¶ï¼Œå¼€å‘äººå‘˜å¯ä»¥è„±ç¦»Mesosç¯å¢ƒï¼Œåœ¨æœ¬åœ°è¿è¡Œå’Œè°ƒè¯•ä½œä¸šã€‚å¯ä»¥åˆ©ç”¨æœ¬åœ°è¿è¡Œæ¨¡å¼å……åˆ†çš„è°ƒè¯•ä¸šåŠ¡åŠŸèƒ½ä»¥åŠå•å…ƒæµ‹è¯•ï¼Œå®Œæˆä¹‹åå†éƒ¨ç½²è‡³Mesosé›†ç¾¤ã€‚<br>æœ¬åœ°è¿è¡Œä½œä¸šæ— éœ€å®‰è£…Mesosç¯å¢ƒã€‚</p>
</blockquote>
<p>åœ¨<a href="http://elasticjob.io/docs/elastic-job-cloud/02-guide/local-executor/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” æœ¬åœ°è¿è¡Œæ¨¡å¼ã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</p>
<h2 id="3-3-äº‘ä½œä¸šé…ç½®æ€»ç»“"><a href="#3-3-äº‘ä½œä¸šé…ç½®æ€»ç»“" class="headerlink" title="3.3 äº‘ä½œä¸šé…ç½®æ€»ç»“"></a>3.3 äº‘ä½œä¸šé…ç½®æ€»ç»“</h2><ul>
<li>CloudJobConfigurationï¼šç”Ÿäº§è¿è¡Œä½¿ç”¨ã€‚</li>
<li>LocalCloudJobConfigurationï¼šæœ¬åœ°å¼€å‘è°ƒè¯•ã€‚</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>èŠ‹é“å›ï¼šæœ¬æ–‡ä¸»è¦ä¸º<a href="http://www.yunai.me/Elastic-Job/cloud-job-scheduler-and-executor/?self">ã€ŠElastic-Job-Cloud æºç è§£æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>åšé“ºå«ï¼Œè¿™ä¼šæ˜¯ä¸€ç¯‡é•¿æ–‡ã€‚è¯»æ‡‚ Elastic-Job-Cloud ä½œä¸šè°ƒåº¦åï¼Œæ•´ä¸ªäººè„‘æ´åˆå¼€çš„ä¸è¡Œä¸è¡Œçš„ï¼<br>æ—ç™½å›ï¼šæ”¯æŒ+1024ã€‚</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_12_14/04.png" alt=""></p>
<p>å¦å¤–ï¼Œæ¨èèµ„æ–™å¦‚ä¸‹ï¼Œå¯¹ç†è§£ Elastic-Job-Cloud å¾ˆæœ‰å¸®åŠ©ã€‚</p>
<ul>
<li><a href="http://www.infoq.com/cn/news/2016/09/Mesos-Elastic-Job-Cloud" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠåŸºäºMesosçš„å½“å½“ä½œä¸šäº‘Elastic Job Cloudã€‹</a></li>
<li><a href="http://www.infoq.com/cn/presentations/how-to-build-elastic-job-cloud" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå¦‚ä½•ä»0åˆ°1æ­å»ºå¼¹æ€§ä½œä¸šäº‘Elastic-Job-Cloudã€‹</a></li>
</ul>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. äº‘ä½œä¸šApp&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2
    
    </summary>
    
      <category term="Elastic-Job-Cloud" scheme="http://www.yunai.me/categories/Elastic-Job-Cloud/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” è¿ç»´å¹³å°</title>
    <link href="http://www.yunai.me/Elastic-Job/job-console/"/>
    <id>http://www.yunai.me/Elastic-Job/job-console/</id>
    <published>2017-12-06T16:00:00.000Z</published>
    <updated>2017-09-02T09:56:42.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. Mavenæ¨¡å— elastic-job-common-restful</a></li>
<li><a href="#">3. Mavenæ¨¡å— elastic-job-console</a></li>
<li><a href="#">4. Mavenæ¨¡å— elastic-job-lite-lifecycle</a></li>
<li><a href="#">5. å…¶å®ƒ</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite è¿ç»´å¹³å°</strong>ã€‚å†…å®¹å¯¹åº”<a href="http://dangdangdotcom.github.io/elastic-job/elastic-job-lite/02-guide/web-console/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” è¿ç»´å¹³å°ã€‹</a>ã€‚</p>
<p>è¿ç»´å¹³å°å®ç°ä¸Šæ¯”è¾ƒæ˜“æ‡‚ï¼Œå°±ä¸ç‰¹åˆ«<strong>å•°å—¦</strong>çš„è§£æï¼Œç®€ç•¥è¯´ä¸‹æ¯ä¸ªç±»çš„ç”¨é€”å’Œ UI ä¸Šçš„å…³è”ã€‚</p>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-Mavenæ¨¡å—-elastic-job-common-restful"><a href="#2-Mavenæ¨¡å—-elastic-job-common-restful" class="headerlink" title="2. Mavenæ¨¡å— elastic-job-common-restful"></a>2. Mavenæ¨¡å— elastic-job-common-restful</h1><ol>
<li>RestfulServer å†…åµŒæœåŠ¡å™¨ï¼ŒåŸºäº Jetty å®ç°</li>
<li>GSONProvider åç«¯æ¥å£ JSON æ ¼å¼åŒ– </li>
<li>RestfulExceptionMapper å¼‚å¸¸æ˜ å°„</li>
<li>WwwAuthFilter æˆæƒè®¤è¯ Filter</li>
</ol>
<h1 id="3-Mavenæ¨¡å—-elastic-job-console"><a href="#3-Mavenæ¨¡å—-elastic-job-console" class="headerlink" title="3. Mavenæ¨¡å— elastic-job-console"></a>3. Mavenæ¨¡å— elastic-job-console</h1><h2 id="3-1-domain-åŒ…"><a href="#3-1-domain-åŒ…" class="headerlink" title="3.1 domain åŒ…"></a>3.1 domain åŒ…</h2><ul>
<li>RegistryCenterConfigurations / RegistryCenterConfiguration ï¼šæ³¨å†Œä¸­å¿ƒé…ç½®å®ä½“ç›¸å…³ã€‚</li>
<li>EventTraceDataSourceConfigurations / EventTraceDataSourceConfiguration / EventTraceDataSource / EventTraceDataSourceFactory ï¼šäº‹ä»¶äº‹ä»¶è¿½è¸ªæ•°æ®æºé…ç½®å®ä½“ç›¸å…³ã€‚</li>
</ul>
<h2 id="3-2-filter-åŒ…"><a href="#3-2-filter-åŒ…" class="headerlink" title="3.2 filter åŒ…"></a>3.2 filter åŒ…</h2><ul>
<li>GlobalConfigurationFilter ï¼šå…¨å±€é…ç½®è¿‡æ»¤å™¨ï¼ŒåŠ è½½å½“å‰ä¼šè¯( HttpSession ) é€‰æ‹©çš„ RegistryCenterConfiguration / EventTraceDataSource ã€‚</li>
</ul>
<h2 id="3-3-repository-åŒ…"><a href="#3-3-repository-åŒ…" class="headerlink" title="3.3 repository åŒ…"></a>3.3 repository åŒ…</h2><p>ä½¿ç”¨ <strong>XMLæ–‡ä»¶</strong> å­˜å‚¨ EventTraceDataSource / RegistryCenterConfiguration é…ç½®å®ä½“ã€‚</p>
<h2 id="3-4-restful-åŒ…"><a href="#3-4-restful-åŒ…" class="headerlink" title="3.4 restful åŒ…"></a>3.4 restful åŒ…</h2><ul>
<li><p><code>config</code> / RegistryCenterRestfulApi ï¼šæ³¨å†Œä¸­å¿ƒé…ç½®( RegistryCenterConfiguration )çš„RESTful API<br> <img src="http://www.yunai.me/images/Elastic-Job/2017_12_07/01.png" alt=""></p>
</li>
<li><p><code>config</code> / EventTraceDataSourceRestfulApi ï¼šäº‹ä»¶è¿½è¸ªæ•°æ®æºé…ç½®( EventTraceDataSource )çš„RESTful API<br> <img src="http://www.yunai.me/images/Elastic-Job/2017_12_07/02.png" alt=""></p>
</li>
<li><p><code>config</code> / LiteJobConfigRestfulApi ï¼šä½œä¸šé…ç½®( LiteJobConfiguration )çš„RESTful API<br> <img src="http://www.yunai.me/images/Elastic-Job/2017_12_07/03.png" alt=""></p>
</li>
<li><p>EventTraceHistoryRestfulApi ï¼šäº‹ä»¶è¿½è¸ªå†å²è®°å½•( <code>JOB_EXECUTION_LOG</code> / <code>JOB_STATUS_TRACE_LOG</code> )çš„RESTful API<br> <img src="http://www.yunai.me/images/Elastic-Job/2017_12_07/06.png" alt=""><br> <img src="http://www.yunai.me/images/Elastic-Job/2017_12_07/07.png" alt=""></p>
</li>
<li><p>ServerOperationRestfulApi ï¼šæœåŠ¡å™¨ç»´åº¦æ“ä½œçš„RESTful APIã€‚<br> <img src="http://www.yunai.me/images/Elastic-Job/2017_12_07/05.png" alt=""></p>
</li>
<li><p>JobOperationRestfulApi ï¼šä½œä¸šç»´åº¦æ“ä½œçš„RESTful APIã€‚<br> <img src="http://www.yunai.me/images/Elastic-Job/2017_12_07/04.png" alt=""></p>
</li>
</ul>
<h2 id="3-5-service-åŒ…"><a href="#3-5-service-åŒ…" class="headerlink" title="3.5 service åŒ…"></a>3.5 service åŒ…</h2><ul>
<li>RegistryCenterConfigurationService ï¼šæ³¨å†Œä¸­å¿ƒ( RegistryCenterConfiguration )é…ç½®æœåŠ¡ã€‚</li>
<li>EventTraceDataSourceConfigurationService ï¼šäº‹ä»¶è¿½è¸ªæ•°æ®æºé…ç½®( EventTraceDataSource )æœåŠ¡ã€‚</li>
<li>JobAPIService ï¼šå’Œä½œä¸šç›¸å…³çš„ API é›†åˆæœåŠ¡ã€‚è¿™äº› API åœ¨ Mavenæ¨¡å— <code>elastic-job-lite-lifecycle</code> å®ç°ã€‚<ul>
<li>JobSettingsAPIï¼šä½œä¸šé…ç½®çš„APIã€‚</li>
<li>JobOperateAPI ï¼šæ“ä½œä½œä¸šçš„APIã€‚</li>
<li>ShardingOperateAPI ï¼šæ“ä½œåˆ†ç‰‡çš„APIã€‚</li>
<li>JobStatisticsAPI ï¼šJobStatisticsAPIã€‚</li>
<li>ServerStatisticsAPI ï¼šä½œä¸šæœåŠ¡å™¨çŠ¶æ€å±•ç¤ºçš„APIã€‚</li>
<li>ShardingStatisticsAPI ï¼šä½œä¸šåˆ†ç‰‡çŠ¶æ€å±•ç¤ºçš„APIã€‚</li>
</ul>
</li>
</ul>
<h1 id="4-Mavenæ¨¡å—-elastic-job-lite-lifecycle"><a href="#4-Mavenæ¨¡å—-elastic-job-lite-lifecycle" class="headerlink" title="4. Mavenæ¨¡å— elastic-job-lite-lifecycle"></a>4. Mavenæ¨¡å— elastic-job-lite-lifecycle</h1><p>åœ¨ JobAPIService å·²ç»åŸºæœ¬æåˆ°ï¼Œè¿™é‡Œä¸é‡å¤å™è¿°ã€‚</p>
<h1 id="5-å…¶å®ƒ"><a href="#5-å…¶å®ƒ" class="headerlink" title="5. å…¶å®ƒ"></a>5. å…¶å®ƒ</h1><ol>
<li>å‰åç«¯åˆ†ç¦»ï¼Œåç«¯ä½¿ç”¨ JSON ä¸ºå‰ç«¯æä¾›æ•°æ®æ¥å£ã€‚</li>
<li>åç«¯ API ä½¿ç”¨ Restful è®¾è®¡è§„èŒƒã€‚ </li>
<li>å›½é™…åŒ–ä½¿ç”¨ <code>jquery.i18n.js</code> å®ç°ã€‚</li>
<li>ç•Œé¢ä½¿ç”¨ Bootstrap AdminLTE æ¨¡æ¿å®ç°ã€‚</li>
</ol>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šè¿™å†™çš„â€¦ ç•¥é£˜é€¸ï¼ˆéšæ„ï¼‰<br>èŠ‹é“å›ï¼šå“ˆå“ˆå“ˆï¼Œæˆ‘è¦å¼€å§‹ Elastic-Job-Cloud å•¦å•¦å•¦å•¦ã€‚</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_12_07/08.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. Mavenæ¨¡å— elastic-job-common-restf
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.yunai.me/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>é—²èŠå¦‚ä½•é˜…è¯»æºç ï¼ˆéŸ³é¢‘ï¼‰</title>
    <link href="http://www.yunai.me/Architecture/how-to-read-source-code/"/>
    <id>http://www.yunai.me/Architecture/how-to-read-source-code/</id>
    <published>2017-12-01T16:00:00.000Z</published>
    <updated>2017-08-29T04:52:39.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0-ä»é›¶å¼€å§‹"><a href="#0-ä»é›¶å¼€å§‹" class="headerlink" title="0. ä»é›¶å¼€å§‹"></a>0. ä»é›¶å¼€å§‹</h1><p>è§†é¢‘ï¼š</p>
<iframe frameborder="0" width="640" height="498" src="https://v.qq.com/iframe/player.html?vid=p0543tzm648&tiny=0&auto=0" allowfullscreen></iframe>

<p>è¯·å…³æ³¨ç¬”è€…çš„å…¬ä¼—å·ï¼šèŠ‹é“æºç </p>
<ul>
<li>ä¸“æ³¨æºç è§£æä¸‰åå¹´ï¼</li>
<li>ä¸“æ³¨æºç è§£æä¸‰åå¹´ï¼</li>
<li>ä¸“æ³¨æºç è§£æä¸‰åå¹´ï¼</li>
<li><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></li>
</ul>
<h1 id="1-è°ƒè¯•"><a href="#1-è°ƒè¯•" class="headerlink" title="1. è°ƒè¯•"></a>1. è°ƒè¯•</h1><p>é€šè¿‡ IDE å·¥å…·<strong>è°ƒè¯•</strong>çš„æ–¹å¼é˜…è¯»æºç ã€‚</p>
<h2 id="1-1-Elastic-Job"><a href="#1-1-Elastic-Job" class="headerlink" title="1.1 Elastic-Job"></a>1.1 Elastic-Job</h2><ul>
<li>GitHubåœ°å€ï¼š<a href="https://github.com/dangdangdotcom/elastic-job" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/dangdangdotcom/elastic-job</a><ul>
<li>å¼€æºä¸æ˜“ï¼Œè¯·ç‚¹ Star æ”¯æŒã€‚</li>
<li>ä¸ªäºº Forkï¼Œå¢åŠ éƒ¨åˆ†ä¸­æ–‡æ³¨é‡Š GitHubåœ°å€ï¼š<a href="https://github.com/YunaiV/elastic-job" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/YunaiV/elastic-job</a></li>
</ul>
</li>
<li>ä¸ºä»€ä¹ˆé˜…è¯» Elastic-Job æºç ï¼Ÿï¼š<a href="http://www.yunai.me/Elastic-Job/why-read-Elastic-Job-source-code/">http://www.yunai.me/Elastic-Job/why-read-Elastic-Job-source-code/</a></li>
<li>è°ƒè¯•æ–¹å¼ï¼š<code>com.dangdang.ddframe.job.example.JavaMain</code> ç›´æ¥ DEBUG å³å¯ã€‚</li>
</ul>
<h2 id="1-2-Sharding-JDBC"><a href="#1-2-Sharding-JDBC" class="headerlink" title="1.2 Sharding-JDBC"></a>1.2 Sharding-JDBC</h2><ul>
<li>GitHubåœ°å€ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/dangdangdotcom/sharding-jdbc</a><ul>
<li>å¼€æºä¸æ˜“ï¼Œè¯·ç‚¹ Star æ”¯æŒã€‚</li>
<li>ä¸ªäºº Forkï¼Œå¢åŠ éƒ¨åˆ†ä¸­æ–‡æ³¨é‡Š GitHubåœ°å€ï¼š<a href="https://github.com/YunaiV/sharding-jdbc" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/YunaiV/sharding-jdbc</a><ul>
<li>åŸºäº Sharding-JDBC V1.5.1 ç‰ˆæœ¬ï¼Œå»ºè®®é˜…è¯»æœ€æ–°ç‰ˆæœ¬ä»£ç ï¼Œæˆ‘çš„å¯ä»¥ä½œä¸ºæ³¨é‡Šè¡¥å……ã€‚ </li>
</ul>
</li>
</ul>
</li>
<li>ä¸ºä»€ä¹ˆé˜…è¯» Sharding-JDBC æºç ï¼Ÿï¼š<a href="http://www.yunai.me/Sharding-JDBC/why-read-Sharding-JDBC-source-code/">http://www.yunai.me/Sharding-JDBC/why-read-Sharding-JDBC-source-code/</a></li>
<li>è°ƒè¯•æ–¹å¼ï¼š<code>com.dangdang.ddframe.rdb.sharding.example.jdbc.Main</code> é…ç½®æ•°æ®æºåå¯ä»¥ DEBUGã€‚</li>
<li>æ‹†è§£å›¾ï¼š<img src="http://www.yunai.me/images/Architecture/2017_12_02/01.png" alt=""></li>
</ul>
<h2 id="1-3-MyCAT"><a href="#1-3-MyCAT" class="headerlink" title="1.3 MyCAT"></a>1.3 MyCAT</h2><ul>
<li>GitHubåœ°å€ï¼š<a href="https://github.com/MyCATApache/Mycat-Server" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/MyCATApache/Mycat-Server</a><ul>
<li>å¼€æºä¸æ˜“ï¼Œè¯·ç‚¹ Star æ”¯æŒã€‚</li>
<li>ä¸ªäºº Forkï¼Œå¢åŠ éƒ¨åˆ†ä¸­æ–‡æ³¨é‡Š GitHubåœ°å€ï¼š<a href="https://github.com/YunaiV/Mycat-Server" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/YunaiV/Mycat-Server</a></li>
</ul>
</li>
<li>ä¸ºä»€ä¹ˆé˜…è¯» MyCAT æºç ï¼Ÿï¼š<a href="http://www.yunai.me/MyCAT/why-read-MyCAT-source-code/">http://www.yunai.me/MyCAT/why-read-MyCAT-source-code/</a></li>
<li>è°ƒè¯•æ–¹å¼ï¼š<a href="http://www.yunai.me/MyCAT/build-debugging-environment/">http://www.yunai.me/MyCAT/build-debugging-environment/</a></li>
</ul>
<h2 id="1-4-RocketMQ"><a href="#1-4-RocketMQ" class="headerlink" title="1.4 RocketMQ"></a>1.4 RocketMQ</h2><ul>
<li>GitHubåœ°å€ï¼š<a href="https://github.com/apache/incubator-rocketmq" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/apache/incubator-rocketmq</a><ul>
<li>å¼€æºä¸æ˜“ï¼Œè¯·ç‚¹ Star æ”¯æŒã€‚</li>
<li>ä¸ªäºº Forkï¼Œå¢åŠ éƒ¨åˆ†ä¸­æ–‡æ³¨é‡Š GitHubåœ°å€ï¼š<a href="https://github.com/YunaiV/incubator-rocketmq" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/YunaiV/incubator-rocketmq</a></li>
</ul>
</li>
<li>ä¸ºä»€ä¹ˆé˜…è¯» RocketMQ æºç ï¼Ÿï¼š<a href="http://www.yunai.me/RocketMQ/why-read-RocketMQ-source-code/">http://www.yunai.me/RocketMQ/why-read-RocketMQ-source-code/</a></li>
<li>è°ƒè¯•æ–¹å¼ï¼šæœ‰ç‚¹æƒ³ä¸èµ·æ¥äº†ã€‚ä»¥åè¡¥å……å“ˆã€‚</li>
</ul>
<h2 id="1-5-è¡¥å……"><a href="#1-5-è¡¥å……" class="headerlink" title="1.5 è¡¥å……"></a>1.5 è¡¥å……</h2><p>å¦‚æœæºç æ¯”è¾ƒå¤šï¼Œä½ ä¸å¤ªæ¸…æ¥šæŒ‰ç…§ä»€ä¹ˆæ ·çš„åŠŸèƒ½é¡ºåºè°ƒè¯•ä¸‹å»ï¼Œå¯ä»¥å‚è€ƒæˆ‘å†™çš„åšå®¢ã€‚è¿™ä¸ªä¸æ˜¯å¹¿å‘Šã€‚ç¡®å®æœ‰æœ‹å‹æ˜¯å¯¹ç…§ç€åšå®¢é¡ºåºè°ƒè¯•çš„ã€‚</p>
<h1 id="2-UMLå›¾"><a href="#2-UMLå›¾" class="headerlink" title="2. UMLå›¾"></a>2. UMLå›¾</h1><p>æ¨èä½¿ç”¨ Astah ç¤¾åŒºç‰ˆã€‚å¯¹çš„ï¼Œä¸è¦è€ƒè™‘ç ´è§£ä¸ç ´è§£çš„ã€‚ç¤¾åŒºç‰ˆï¼Œå¤Ÿï¼</p>
<p>å¦å¤–ï¼Œè¯·ä¸è¦çº ç»“ç”¨ä»€ä¹ˆ UML å·¥å…·ç‰›é€¼ï¼é‡ç‚¹å…ˆè¿ˆå‡ºè°ƒè¯•æºç é‚£ä¸€æ­¥ï¼Œå…¶ä»–çš„ï¼Œæ…¢æ…¢ä¼˜åŒ–ã€‚</p>
<p>æ¨èç”»ä¸¤ç§å›¾ï¼š</p>
<ul>
<li><p>ç±»å›¾ï¼šå¯¹æ•´ä½“ã€æˆ–è€…æŸä¸ªæ¨¡å—ï¼Œæœ‰ç³»ç»Ÿæ€§çš„è®¤è¯†ã€‚</p>
<p>  <img src="http://www.yunai.me/images/Architecture/2017_12_02/02.png" alt=""></p>
</li>
<li><p>é¡ºåºå›¾ï¼šå¯¹æµç¨‹çš„è°ƒç”¨é¡ºåºæœ‰æ•´ä½“çš„è®¤è¯†ï¼Œé¿å…è°ƒè¯•ï¼Œè¶Šè°ƒè¯•è¶Šæ™•ã€‚</p>
<p>  <img src="http://www.yunai.me/images/Architecture/2017_12_02/03.png" alt=""></p>
</li>
</ul>
<p>å¦‚æœä½ ä¸ä¼šç”» UML å›¾ï¼Œç›´æ¥ç›´æ¥ Googleï¼Œä¸è¦å»æ‰¾ä»€ä¹ˆ UML çš„ä¹¦ï¼Œå…ˆå¹²èµ·æ¥ï¼</p>
<p>æ©ï¼Œç¬”è€…ä¸æ’é™¤çœ‹ UML ä¹¦ï¼Œå› ä¸ºï¼Œæˆ‘ä¹Ÿçœ‹è¿‡å‡ æœ¬ï¼Œæ”¶è·ä¸å°ï¼Œå“ˆå“ˆå“ˆå“ˆã€‚</p>
<h1 id="3-è¾“å‡º"><a href="#3-è¾“å‡º" class="headerlink" title="3. è¾“å‡º"></a>3. è¾“å‡º</h1><p>é˜…è¯»æºç ï¼Œä¸å°è¯•è¾“å‡ºï¼Œå°±æ˜¯åœ¨è€æµæ°“ã€‚</p>
<p>æ¨èä¸‰ç§è¾“å‡ºæ–¹å¼ï¼š</p>
<ol>
<li>å†™åšå®¢ã€‚</li>
<li>å›¢é˜Ÿåˆ†äº«ã€‚</li>
<li>é€ å°è½®ã€‚</li>
</ol>
<p>åˆšå¼€å§‹æ¨èå†™åšå®¢ã€‚å¯¹çš„ï¼Œä¸å¤ªå»ºè®®åªå†™è‡ªå·±çœ‹å¾—æ‡‚çš„ç¬”è®°ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;0-ä»é›¶å¼€å§‹&quot;&gt;&lt;a href=&quot;#0-ä»é›¶å¼€å§‹&quot; class=&quot;headerlink&quot; title=&quot;0. ä»é›¶å¼€å§‹&quot;&gt;&lt;/a&gt;0. ä»é›¶å¼€å§‹&lt;/h1&gt;&lt;p&gt;è§†é¢‘ï¼š&lt;/p&gt;
&lt;iframe frameborder=&quot;0&quot; width=&quot;640&quot; height=&quot;
    
    </summary>
    
      <category term="æŠ€æœ¯æ‚æ–‡" scheme="http://www.yunai.me/categories/%E6%8A%80%E6%9C%AF%E6%9D%82%E6%96%87/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šç›‘æ§æœåŠ¡</title>
    <link href="http://www.yunai.me/Elastic-Job/job-monitor/"/>
    <id>http://www.yunai.me/Elastic-Job/job-monitor/</id>
    <published>2017-11-30T16:00:00.000Z</published>
    <updated>2017-09-02T09:56:36.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. MonitorService</a></li>
<li><a href="#">3. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šç›‘æ§æœåŠ¡</strong>ã€‚å†…å®¹å¯¹åº”<a href="http://dangdangdotcom.github.io/elastic-job/elastic-job-lite/02-guide/dump/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” DUMPä½œä¸šè¿è¡Œä¿¡æ¯ã€‹</a>ã€‚</p>
<blockquote>
<p>ä½¿ç”¨Elastic-Job-Liteè¿‡ç¨‹ä¸­å¯èƒ½ä¼šç¢°åˆ°ä¸€äº›åˆ†å¸ƒå¼é—®é¢˜ï¼Œå¯¼è‡´ä½œä¸šè¿è¡Œä¸ç¨³å®šã€‚<br>ç”±äºæ— æ³•åœ¨ç”Ÿäº§ç¯å¢ƒè°ƒè¯•ï¼Œé€šè¿‡dumpå‘½ä»¤å¯ä»¥æŠŠä½œä¸šå†…éƒ¨ç›¸å…³ä¿¡æ¯dumpå‡ºæ¥ï¼Œæ–¹ä¾¿å¼€å‘è€…debugåˆ†æï¼› å¦å¤–ä¸ºäº†ä¸æ³„éœ²éšç§ï¼Œå·²å°†ç›¸å…³ä¿¡æ¯ä¸­çš„ipåœ°å€ä»¥ip1, ip2â€¦çš„å½¢å¼è¿‡æ»¤ï¼Œå¯ä»¥åœ¨äº’è”ç½‘ä¸Šå…¬å¼€ä¼ è¾“ç¯å¢ƒä¿¡æ¯ï¼Œä¾¿äºè¿›ä¸€æ­¥å®Œå–„Elastic-Jobã€‚</p>
</blockquote>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_12_01/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_12_01/01.png" alt=""></p>
<ul>
<li>åœ¨ Elastic-Job-lite é‡Œï¼Œä½œä¸šç›‘æ§æœåŠ¡( MonitorService ) å®ç°äº†<strong>DUMPä½œä¸šè¿è¡Œä¿¡æ¯</strong>åŠŸèƒ½ã€‚</li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-MonitorService"><a href="#2-MonitorService" class="headerlink" title="2. MonitorService"></a>2. MonitorService</h1><p>MonitorServiceï¼Œä½œä¸šç›‘æ§æœåŠ¡ã€‚</p>
<p><strong>åˆå§‹åŒ– MonitorService æ–¹æ³•å®ç°å¦‚ä¸‹</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MonitorService.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> port = configService.load(<span class="keyword">true</span>).getMonitorPort();</div><div class="line">   <span class="keyword">if</span> (port &lt; <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       log.info(<span class="string">"Elastic job: Monitor service is running, the port is '&#123;&#125;'"</span>, port);</div><div class="line">       openSocketForMonitor(port);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException ex) &#123;</div><div class="line">       log.error(<span class="string">"Elastic job: Monitor service listen failure, error is: "</span>, ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">openSocketForMonitor</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> port)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">   serverSocket = <span class="keyword">new</span> ServerSocket(port);</div><div class="line">   <span class="keyword">new</span> Thread() &#123;</div><div class="line">       </div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">           <span class="keyword">while</span> (!closed) &#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   process(serverSocket.accept());</div><div class="line">               &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException ex) &#123;</div><div class="line">                   log.error(<span class="string">"Elastic job: Monitor service open socket for monitor failure, error is: "</span>, ex);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>åœ¨ä½œä¸šé…ç½®çš„ç›‘æ§æœåŠ¡ç«¯å£å±æ€§( <code>LiteJobConfiguration.monitorPort</code> )å¯åŠ¨ <strong>ServerSocket</strong>ã€‚ä¸€ä¸ªä½œä¸šå¯¹åº”ä¸€ä¸ªä½œä¸šç›‘æ§ç«¯å£ï¼Œæ‰€ä»¥é…ç½®æ—¶ï¼Œè¯·ä¸è¦é‡å¤ç«¯å£å™¢ã€‚</li>
</ul>
<p><strong>å¤„ç† dumpå‘½ä»¤ æ–¹æ³•å¦‚ä¸‹</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MonitorService.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> Socket socket)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">   <span class="keyword">try</span> (</div><div class="line">           BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(socket.getInputStream()));</div><div class="line">           BufferedWriter writer = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(socket.getOutputStream()));</div><div class="line">           Socket autoCloseSocket = socket) &#123;</div><div class="line">       <span class="comment">// è¯»å–å‘½ä»¤</span></div><div class="line">       String cmdLine = reader.readLine();</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> != cmdLine &amp;&amp; DUMP_COMMAND.equalsIgnoreCase(cmdLine)) &#123; <span class="comment">// DUMP</span></div><div class="line">           List&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">           dumpDirectly(<span class="string">"/"</span> + jobName, result);</div><div class="line">           outputMessage(writer, Joiner.on(<span class="string">"\n"</span>).join(SensitiveInfoUtils.filterSensitiveIps(result)) + <span class="string">"\n"</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#process()</code> æ–¹æ³•ï¼Œç›®å‰åªæ”¯æŒ <code>DUMP</code> å‘½ä»¤ã€‚å¦‚æœä½ æœ‰è‡ªå®šä¹‰å‘½ä»¤çš„éœ€è¦ï¼Œå¯ä»¥æ‹“å±•è¯¥æ–¹æ³•ã€‚</li>
<li><p>è°ƒç”¨ <code>#dumpDirectly()</code> æ–¹æ³•ï¼Œè¾“å‡ºå½“å‰ä½œä¸šåå¯¹åº”çš„ç›¸å…³è°ƒè¯•ä¿¡æ¯ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dumpDirectly</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> List&lt;String&gt; result)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (String each : regCenter.getChildrenKeys(path)) &#123;</div><div class="line">       String zkPath = path + <span class="string">"/"</span> + each;</div><div class="line">       String zkValue = regCenter.get(zkPath);</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> == zkValue) &#123;</div><div class="line">           zkValue = <span class="string">""</span>;</div><div class="line">       &#125;</div><div class="line">       TreeCache treeCache = (TreeCache) regCenter.getRawCache(<span class="string">"/"</span> + jobName);</div><div class="line">       ChildData treeCacheData = treeCache.getCurrentData(zkPath);</div><div class="line">       String treeCachePath =  <span class="keyword">null</span> == treeCacheData ? <span class="string">""</span> : treeCacheData.getPath();</div><div class="line">       String treeCacheValue = <span class="keyword">null</span> == treeCacheData ? <span class="string">""</span> : <span class="keyword">new</span> String(treeCacheData.getData());</div><div class="line">       <span class="comment">// åˆ¤æ–­ TreeCacheç¼“å­˜ å’Œ æ³¨å†Œä¸­å¿ƒ æ•°æ®ä¸€è‡´</span></div><div class="line">       <span class="keyword">if</span> (zkValue.equals(treeCacheValue) &amp;&amp; zkPath.equals(treeCachePath)) &#123;</div><div class="line">           result.add(Joiner.on(<span class="string">" | "</span>).join(zkPath, zkValue));</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           result.add(Joiner.on(<span class="string">" | "</span>).join(zkPath, zkValue, treeCachePath, treeCacheValue));</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// é€’å½’</span></div><div class="line">       dumpDirectly(zkPath, result);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å½“ä½œä¸šæœ¬åœ° <strong>TreeCacheç¼“å­˜</strong> å’Œæ³¨å†Œä¸­å¿ƒæ•°æ®ä¸ä¸€è‡´æ—¶ï¼ŒDUMP å‡º [zkPath, zkValue, treeCachePath, treeCacheValue]ã€‚å½“ç›¸åŒæ—¶ï¼Œåªéœ€ DUMP å‡º [zkPath, zkValue]ï¼Œ<strong>æ–¹ä¾¿çœ‹å‡ºæœ¬åœ°å’Œæ³¨å†Œä¸­å¿ƒæ˜¯å¦å­˜åœ¨æ•°æ®å·®å¼‚ã€‚</strong></li>
</ul>
</li>
<li><p>DUMP ä¿¡æ¯ä¾‹å­å¦‚ä¸‹ï¼š</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">Yunai-MacdeMacBook-Pro-2:elastic-job yunai$ <span class="built_in">echo</span> <span class="string">"dump"</span> | nc 127.0.0.1 10024</div><div class="line">/javaSimpleJob/sharding | </div><div class="line">/javaSimpleJob/sharding/2 | </div><div class="line">/javaSimpleJob/sharding/2/instance | ip198@-@5100</div><div class="line">/javaSimpleJob/sharding/1 | </div><div class="line">/javaSimpleJob/sharding/1/instance | ip198@-@5100</div><div class="line">/javaSimpleJob/sharding/0 | </div><div class="line">/javaSimpleJob/sharding/0/instance | ip198@-@5100</div><div class="line">/javaSimpleJob/servers | </div><div class="line">/javaSimpleJob/servers/ip2 | </div><div class="line">/javaSimpleJob/servers/ip198 | </div><div class="line">/javaSimpleJob/leader | </div><div class="line">/javaSimpleJob/leader/sharding | </div><div class="line">/javaSimpleJob/leader/failover | </div><div class="line">/javaSimpleJob/leader/failover/latch | </div><div class="line">/javaSimpleJob/leader/failover/items | </div><div class="line">/javaSimpleJob/leader/election | </div><div class="line">/javaSimpleJob/leader/election/latch | </div><div class="line">/javaSimpleJob/leader/election/instance | ip198@-@5100</div><div class="line">/javaSimpleJob/instances | </div><div class="line">/javaSimpleJob/instances/ip198@-@5100 | </div><div class="line">/javaSimpleJob/config | &#123;<span class="string">"jobName"</span>:<span class="string">"javaSimpleJob"</span>,<span class="string">"jobClass"</span>:<span class="string">"com.dangdang.ddframe.job.example.job.simple.JavaSimpleJob"</span>,<span class="string">"jobType"</span>:<span class="string">"SIMPLE"</span>,<span class="string">"cron"</span>:<span class="string">"0 0/2 * * * ?"</span>,<span class="string">"shardingTotalCount"</span>:3,<span class="string">"shardingItemParameters"</span>:<span class="string">"0\u003dBeijing,1\u003dShanghai,2\u003dGuangzhou"</span>,<span class="string">"jobParameter"</span>:<span class="string">""</span>,<span class="string">"failover"</span>:<span class="literal">true</span>,<span class="string">"misfire"</span>:<span class="literal">true</span>,<span class="string">"description"</span>:<span class="string">""</span>,<span class="string">"jobProperties"</span>:&#123;<span class="string">"job_exception_handler"</span>:<span class="string">"com.dangdang.ddframe.job.executor.handler.impl.DefaultJobExceptionHandler"</span>,<span class="string">"executor_service_handler"</span>:<span class="string">"com.dangdang.ddframe.job.executor.handler.impl.DefaultExecutorServiceHandler"</span>&#125;,<span class="string">"monitorExecution"</span>:<span class="literal">false</span>,<span class="string">"maxTimeDiffSeconds"</span>:-1,<span class="string">"monitorPort"</span>:10024,<span class="string">"jobShardingStrategyClass"</span>:<span class="string">"com.dangdang.ddframe.job.lite.api.strategy.impl.OdevitySortByNameJobShardingStrategy"</span>,<span class="string">"reconcileIntervalMinutes"</span>:10,<span class="string">"disabled"</span>:<span class="literal">false</span>,<span class="string">"overwrite"</span>:<span class="literal">true</span>&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>èŠ‹é“å›ï¼šæ˜¯æ˜¯æ˜¯ï¼Œå¯¹å¯¹çš„ï¼Œæˆ‘æ°´æ›´å•¦ï¼ğŸ˜†</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_12_01/02.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. MonitorService&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a h
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.yunai.me/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” è‡ªè¯Šæ–­ä¿®å¤</title>
    <link href="http://www.yunai.me/Elastic-Job/reconcile/"/>
    <id>http://www.yunai.me/Elastic-Job/reconcile/</id>
    <published>2017-11-27T16:00:00.000Z</published>
    <updated>2017-09-02T09:56:32.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ReconcileService</a></li>
<li><a href="#">3. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite è‡ªè¯Šæ–­ä¿®å¤</strong>ã€‚</p>
<blockquote>
<p>åœ¨åˆ†å¸ƒå¼çš„åœºæ™¯ä¸‹ç”±äºç½‘ç»œã€æ—¶é’Ÿç­‰åŸå› ï¼Œå¯èƒ½å¯¼è‡´ Zookeeper çš„æ•°æ®ä¸çœŸå®è¿è¡Œçš„ä½œä¸šäº§ç”Ÿä¸ä¸€è‡´ï¼Œè¿™ç§ä¸ä¸€è‡´é€šè¿‡æ­£å‘çš„æ ¡éªŒæ— æ³•å®Œå…¨é¿å…ã€‚éœ€è¦å¦å¤–å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å®šæ—¶æ ¡éªŒæ³¨å†Œä¸­å¿ƒæ•°æ®ä¸çœŸå®ä½œä¸šçŠ¶æ€çš„ä¸€è‡´æ€§ï¼Œå³ç»´æŒ Elastic-Job çš„<strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ã€‚</p>
</blockquote>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_11_28/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_28/01.png" alt=""></p>
<ul>
<li>åœ¨ Elastic-Job-lite é‡Œï¼Œè°ƒè§£åˆ†å¸ƒå¼ä½œä¸šä¸ä¸€è‡´çŠ¶æ€æœåŠ¡( ReconcileService ) å®ç°äº†<strong>è‡ªè¯Šæ–­ä¿®å¤</strong>åŠŸèƒ½ã€‚</li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-ReconcileService"><a href="#2-ReconcileService" class="headerlink" title="2. ReconcileService"></a>2. ReconcileService</h1><p>ReconcileServiceï¼Œè°ƒè§£åˆ†å¸ƒå¼ä½œä¸šä¸ä¸€è‡´çŠ¶æ€æœåŠ¡ã€‚</p>
<p>ReconcileService ç»§æ‰¿ Google Guava AbstractScheduledService æŠ½è±¡ç±»ï¼Œå®ç° <code>#scheduler()</code>ã€<code>#runOneIteration()</code> æ–¹æ³•ï¼Œè¾¾åˆ°<strong>å‘¨æœŸæ€§</strong>æ ¡éªŒæ³¨å†Œä¸­å¿ƒæ•°æ®ä¸çœŸå®ä½œä¸šçŠ¶æ€çš„ä¸€è‡´æ€§ã€‚</p>
<p><strong><code>#scheduler()</code> æ–¹æ³•å®ç°å¦‚ä¸‹</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ReconcileService.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Scheduler <span class="title">scheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> Scheduler.newFixedDelaySchedule(<span class="number">0</span>, <span class="number">1</span>, TimeUnit.MINUTES);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ¯ 1 åˆ†é’Ÿä¼šè°ƒç”¨ä¸€æ¬¡ <code>#runOneIteration()</code> æ–¹æ³•è¿›è¡Œæ ¡éªŒã€‚</li>
<li>Google Guava AbstractScheduledService ç›¸å…³çš„çŸ¥è¯†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·± Google å­¦ä¹ å“Ÿã€‚</li>
</ul>
<p><strong><code>#runOneIteration()</code> æ–¹æ³•å®ç°å¦‚ä¸‹</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ReconcileService.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">runOneIteration</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">   LiteJobConfiguration config = configService.load(<span class="keyword">true</span>);</div><div class="line">   <span class="keyword">int</span> reconcileIntervalMinutes = <span class="keyword">null</span> == config ? -<span class="number">1</span> : config.getReconcileIntervalMinutes();</div><div class="line">   <span class="keyword">if</span> (reconcileIntervalMinutes &gt; <span class="number">0</span> &amp;&amp; (System.currentTimeMillis() - lastReconcileTime &gt;= reconcileIntervalMinutes * <span class="number">60</span> * <span class="number">1000</span>)) &#123; <span class="comment">// æ ¡éªŒæ˜¯å¦è¾¾åˆ°æ ¡éªŒå‘¨æœŸ</span></div><div class="line">       <span class="comment">// è®¾ç½®æœ€åæ ¡éªŒæ—¶é—´</span></div><div class="line">       lastReconcileTime = System.currentTimeMillis();</div><div class="line">       <span class="keyword">if</span> (leaderService.isLeaderUntilBlock() <span class="comment">// ä¸»ä½œä¸šèŠ‚ç‚¹æ‰å¯ä»¥æ‰§è¡Œ</span></div><div class="line">               &amp;&amp; !shardingService.isNeedSharding() <span class="comment">// å½“å‰ä½œä¸šä¸éœ€è¦é‡æ–°åˆ†ç‰‡</span></div><div class="line">               &amp;&amp; shardingService.hasShardingInfoInOfflineServers()) &#123; <span class="comment">// æŸ¥è¯¢æ˜¯åŒ…å«æœ‰åˆ†ç‰‡èŠ‚ç‚¹çš„ä¸åœ¨çº¿æœåŠ¡å™¨</span></div><div class="line">           log.warn(<span class="string">"Elastic Job: job status node has inconsistent value,start reconciling..."</span>);</div><div class="line">           <span class="comment">// è®¾ç½®éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°</span></div><div class="line">           shardingService.setReshardingFlag();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>é€šè¿‡ä½œä¸šé…ç½®ï¼Œè®¾ç½®<strong>ä¿®å¤ä½œä¸šæœåŠ¡å™¨ä¸ä¸€è‡´çŠ¶æ€æœåŠ¡è°ƒåº¦é—´éš”æ—¶é—´</strong>å±æ€§( <code>LiteJobConfiguration.reconcileIntervalMinutes</code> )ã€‚</li>
<li>è°ƒç”¨ <code>ShardingService#setReshardingFlag()</code> æ–¹æ³•ï¼Œè®¾ç½®éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°ã€‚è¿™ä¸ªä¹Ÿæ˜¯ ReconcileService æœ€æœ¬è´¨çš„è¡Œä¸ºï¼Œæœ‰äº†è¿™ä¸ªæ ‡è®°åï¼Œä½œä¸šä¼šé‡æ–°è¿›è¡Œåˆ†ç‰‡ï¼Œ<strong>è¾¾åˆ°ä½œä¸šèŠ‚ç‚¹æœ¬åœ°åˆ†ç‰‡æ•°æ®ä¸ Zookeeper æ•°æ®ä¸€è‡´</strong>ã€‚ä½œä¸šåˆ†ç‰‡é€»è¾‘ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li>
<li><p>è°ƒè§£åˆ†å¸ƒå¼ä½œä¸šä¸ä¸€è‡´çŠ¶æ€æœåŠ¡ä¸€å…±æœ‰ä¸‰ä¸ªæ¡ä»¶ï¼š</p>
<ul>
<li>è°ƒç”¨ <code>LeaderService#isLeaderUntilBlock()</code> æ–¹æ³•ï¼Œåˆ¤æ–­å½“å‰ä½œä¸šèŠ‚ç‚¹æ˜¯å¦ä¸ºä¸»èŠ‚ç‚¹ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/election/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li>
<li>è°ƒç”¨ <code>ShardingService#isNeedSharding()</code> æ–¹æ³•ï¼Œåˆ¤æ–­å½“å‰ä½œä¸šæ˜¯å¦éœ€è¦é‡åˆ†ç‰‡ã€‚å¦‚æœéœ€è¦é‡æ–°åˆ†ç‰‡ï¼Œå°±ä¸è¦é‡å¤è®¾ç½®å½“å‰ä½œä¸šéœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°ã€‚</li>
<li><p>è°ƒç”¨ <code>ShardingService#hasShardingInfoInOfflineServers()</code> æ–¹æ³•ï¼ŒæŸ¥è¯¢æ˜¯å¦åŒ…å«æœ‰åˆ†ç‰‡èŠ‚ç‚¹çš„ä¸åœ¨çº¿æœåŠ¡å™¨ã€‚<strong>æ°¸ä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${JOB_NAME}/sharding/${ITEM_INDEX}/instance</code> å­˜å‚¨åˆ†é…çš„ä½œä¸šèŠ‚ç‚¹ä¸»é”®( <code>${JOB_INSTANCE_ID}</code> )ï¼Œ <strong>ä¸ä¼š</strong>éšç€ä½œä¸šèŠ‚ç‚¹å› ä¸ºå„ç§åŸå› æ–­å¼€åä¼šè¯è¶…æ—¶ç§»é™¤ï¼Œè€Œ<strong>ä¸´æ—¶</strong>æ•°æ®èŠ‚ç‚¹<code>/${JOB_NAME}/instances/${JOB_INSTANCE_ID}</code> <strong>ä¼š</strong>éšç€ä½œä¸šèŠ‚ç‚¹å› ä¸ºå„ç§åŸå› æ–­å¼€åè¶…æ—¶ä¼šè¯è¶…æ—¶ç§»é™¤ã€‚å½“æŸ¥è¯¢åˆ°åŒ…å«æœ‰åˆ†ç‰‡èŠ‚ç‚¹çš„ä¸åœ¨çº¿çš„ä½œä¸šèŠ‚ç‚¹ï¼Œè®¾ç½®éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°åè¿›è¡Œé‡æ–°åˆ†ç‰‡ï¼Œå°†å…¶æŒæœ‰çš„ä½œä¸šåˆ†ç‰‡åˆ†é…ç»™å…¶å®ƒåœ¨çº¿çš„ä½œä¸šèŠ‚ç‚¹ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingService.java</span></div><div class="line"> <span class="comment">/**</span></div><div class="line"> * æŸ¥è¯¢æ˜¯åŒ…å«æœ‰åˆ†ç‰‡èŠ‚ç‚¹çš„ä¸åœ¨çº¿æœåŠ¡å™¨.</div><div class="line"> * </div><div class="line"> * <span class="doctag">@return</span> æ˜¯åŒ…å«æœ‰åˆ†ç‰‡èŠ‚ç‚¹çš„ä¸åœ¨çº¿æœåŠ¡å™¨</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasShardingInfoInOfflineServers</span><span class="params">()</span> </span>&#123;</div><div class="line">    List&lt;String&gt; onlineInstances = jobNodeStorage.getJobNodeChildrenKeys(InstanceNode.ROOT); <span class="comment">// `/$&#123;JOB_NAME&#125;/instances/$&#123;JOB_INSTANCE_ID&#125;`</span></div><div class="line">    <span class="keyword">int</span> shardingTotalCount = configService.load(<span class="keyword">true</span>).getTypeConfig().getCoreConfig().getShardingTotalCount();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shardingTotalCount; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (!onlineInstances.contains(jobNodeStorage.getJobNodeData(ShardingNode.getInstanceNode(i)))) &#123; <span class="comment">// `/$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_INDEX&#125;/instance`</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>èŠ‹é“å›ï¼šã€åŠ¨ä½œï¼šä¸€è„šè¸¢å¼€æ—ç™½å›ã€‘ï¼Œè¿™æ˜¯å¯¹å‰é¢è§£æçš„ä¸»èŠ‚ç‚¹é€‰ä¸¾å’Œä½œä¸šåˆ†ç‰‡çš„å¤ä¹ ï¼ä¸æ˜¯æ°´æ›´ï¼<br>æ—ç™½å›ï¼šä½ æ‰¿è®¤æ°´â€¦ã€åŠ¨ä½œï¼šèŠ‹é“å›åˆæ¥ä¸€è®°åƒå¹´æ€ã€‘</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_28/02.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ReconcileService&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.yunai.me/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šç›‘å¬å™¨</title>
    <link href="http://www.yunai.me/Elastic-Job/job-listener/"/>
    <id>http://www.yunai.me/Elastic-Job/job-listener/</id>
    <published>2017-11-20T16:00:00.000Z</published>
    <updated>2017-09-02T09:56:26.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ElasticJobListener</a></li>
<li><a href="#">3. AbstractDistributeOnceElasticJobListener</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šç›‘å¬å™¨</strong>ã€‚</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_11_21/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_21/01.png" alt=""></p>
<ul>
<li>ç»¿è‰²<strong>ç›‘å¬å™¨</strong>æ¥å£ ElasticJobListenerï¼Œæ¯å°ä½œä¸šèŠ‚ç‚¹å‡æ‰§è¡Œã€‚</li>
<li>ç²‰è‰²<strong>ç›‘å¬å™¨</strong>æ¥å£ AbstractDistributeOnceElasticJobListenerï¼Œåˆ†å¸ƒå¼åœºæ™¯ä¸­ä»…å•ä¸€èŠ‚ç‚¹æ‰§è¡Œã€‚</li>
<li>è“è‰²ç±»åœ¨ <code>com.dangdang.ddframe.job.lite.internal.guarantee</code> é‡Œï¼Œä¿è¯åˆ†å¸ƒå¼ä»»åŠ¡å…¨éƒ¨å¼€å§‹å’Œç»“æŸçŠ¶æ€ã€‚ AbstractDistributeOnceElasticJobListener é€šè¿‡ <code>guarantee</code> åŠŸèƒ½ï¼Œå®ç°åˆ†å¸ƒå¼åœºæ™¯ä¸­ä»…å•ä¸€èŠ‚ç‚¹æ‰§è¡Œã€‚</li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-ElasticJobListener"><a href="#2-ElasticJobListener" class="headerlink" title="2. ElasticJobListener"></a>2. ElasticJobListener</h1><p>ElasticJobListenerï¼Œä½œä¸šç›‘å¬å™¨æ¥å£ï¼Œ<strong>æ¯å°ä½œä¸šèŠ‚ç‚¹å‡æ‰§è¡Œ</strong>ã€‚</p>
<blockquote>
<p>è‹¥ä½œä¸šå¤„ç†ä½œä¸šæœåŠ¡å™¨çš„æ–‡ä»¶ï¼Œå¤„ç†å®Œæˆååˆ é™¤æ–‡ä»¶ï¼Œå¯è€ƒè™‘ä½¿ç”¨æ¯ä¸ªèŠ‚ç‚¹å‡æ‰§è¡Œæ¸…ç†ä»»åŠ¡ã€‚æ­¤ç±»å‹ä»»åŠ¡å®ç°ç®€å•ï¼Œä¸”æ— éœ€è€ƒè™‘å…¨å±€åˆ†å¸ƒå¼ä»»åŠ¡æ˜¯å¦å®Œæˆï¼Œè¯·å°½é‡ä½¿ç”¨æ­¤ç±»å‹ç›‘å¬å™¨ã€‚</p>
</blockquote>
<p>æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ElasticJobListener</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šæ‰§è¡Œå‰çš„æ‰§è¡Œçš„æ–¹æ³•.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">beforeJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span></span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šæ‰§è¡Œåçš„æ‰§è¡Œçš„æ–¹æ³•.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">afterJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è°ƒç”¨æ‰§è¡Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ...çœç•¥æ— å…³ä»£ç </span></div><div class="line">   </div><div class="line">   <span class="comment">// æ‰§è¡Œ ä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       jobFacade.beforeJobExecuted(shardingContexts);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable cause) &#123;</div><div class="line">       jobExceptionHandler.handleException(jobName, cause);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ...çœç•¥æ— å…³ä»£ç ï¼ˆæ‰§è¡Œ æ™®é€šè§¦å‘çš„ä½œä¸šï¼‰</span></div><div class="line">   <span class="comment">// ...çœç•¥æ— å…³ä»£ç ï¼ˆæ‰§è¡Œ è¢«è·³è¿‡è§¦å‘çš„ä½œä¸šï¼‰</span></div><div class="line">   <span class="comment">// ...çœç•¥æ— å…³ä»£ç ï¼ˆæ‰§è¡Œ ä½œä¸šå¤±æ•ˆè½¬ç§»ï¼‰</span></div><div class="line">   </div><div class="line">   <span class="comment">// ...æ‰§è¡Œ ä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       jobFacade.afterJobExecuted(shardingContexts);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable cause) &#123;</div><div class="line">       jobExceptionHandler.handleException(jobName, cause);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>JobFacade å¯¹ä½œä¸šç›‘å¬å™¨ç®€å•å°è£…è¿›è¡Œè°ƒç”¨ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (ElasticJobListener each : elasticJobListeners) &#123;</div><div class="line">       each.beforeJobExecuted(shardingContexts);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (ElasticJobListener each : elasticJobListeners) &#123;</div><div class="line">       each.afterJobExecuted(shardingContexts);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>ä¸‹æ–‡æåˆ°çš„ AbstractDistributeOnceElasticJobListenerï¼Œä¹Ÿæ˜¯è¿™ä¹ˆè°ƒç”¨ã€‚</p>
</li>
</ul>
<h1 id="3-AbstractDistributeOnceElasticJobListener"><a href="#3-AbstractDistributeOnceElasticJobListener" class="headerlink" title="3. AbstractDistributeOnceElasticJobListener"></a>3. AbstractDistributeOnceElasticJobListener</h1><p>AbstractDistributeOnceElasticJobListenerï¼Œåœ¨åˆ†å¸ƒå¼ä½œä¸šä¸­åªæ‰§è¡Œä¸€æ¬¡çš„ç›‘å¬å™¨ã€‚</p>
<blockquote>
<p>è‹¥ä½œä¸šå¤„ç†æ•°æ®åº“æ•°æ®ï¼Œå¤„ç†å®Œæˆååªéœ€ä¸€ä¸ªèŠ‚ç‚¹å®Œæˆæ•°æ®æ¸…ç†ä»»åŠ¡å³å¯ã€‚æ­¤ç±»å‹ä»»åŠ¡å¤„ç†å¤æ‚ï¼Œéœ€åŒæ­¥åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä½œä¸šçš„çŠ¶æ€åŒæ­¥ï¼Œæä¾›äº†è¶…æ—¶è®¾ç½®æ¥é¿å…ä½œä¸šä¸åŒæ­¥å¯¼è‡´çš„æ­»é”ï¼Œè¯·è°¨æ…ä½¿ç”¨ã€‚</p>
</blockquote>
<p><strong>åˆ›å»º</strong> AbstractDistributeOnceElasticJobListener ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDistributeOnceElasticJobListener</span> <span class="keyword">implements</span> <span class="title">ElasticJobListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¼€å§‹è¶…æ—¶æ—¶é—´</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> startedTimeoutMilliseconds;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¼€å§‹ç­‰å¾…å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object startedWait = <span class="keyword">new</span> Object();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å®Œæˆè¶…æ—¶æ—¶é—´</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> completedTimeoutMilliseconds;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å®Œæˆç­‰å¾…å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object completedWait = <span class="keyword">new</span> Object();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¿è¯åˆ†å¸ƒå¼ä»»åŠ¡å…¨éƒ¨å¼€å§‹å’Œç»“æŸçŠ¶æ€çš„æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> GuaranteeService guaranteeService;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> TimeService timeService = <span class="keyword">new</span> TimeService();</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbstractDistributeOnceElasticJobListener</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> startedTimeoutMilliseconds, <span class="keyword">final</span> <span class="keyword">long</span> completedTimeoutMilliseconds)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (startedTimeoutMilliseconds &lt;= <span class="number">0L</span>) &#123;</div><div class="line">            <span class="keyword">this</span>.startedTimeoutMilliseconds = Long.MAX_VALUE;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.startedTimeoutMilliseconds = startedTimeoutMilliseconds;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (completedTimeoutMilliseconds &lt;= <span class="number">0L</span>) &#123;</div><div class="line">            <span class="keyword">this</span>.completedTimeoutMilliseconds = Long.MAX_VALUE; </div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.completedTimeoutMilliseconds = completedTimeoutMilliseconds;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è¶…æ—¶å‚æ•° <code>startedTimeoutMilliseconds</code>ã€<code>completedTimeoutMilliseconds</code> åŠ¡å¿…ä¼ é€’ï¼Œé¿å…ä½œä¸šä¸åŒæ­¥å¯¼è‡´çš„æ­»é”ã€‚</li>
</ul>
<p>ğŸ‘‡ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹æœ¬æ–‡çš„<strong>é‡ç‚¹</strong>ï¼šAbstractDistributeOnceElasticJobListenerï¼Œåœ¨åˆ†å¸ƒå¼ä½œä¸šä¸­åªæ‰§è¡Œä¸€æ¬¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">beforeJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ³¨å†Œä½œä¸šåˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œ</span></div><div class="line">   guaranteeService.registerStart(shardingContexts.getShardingItemParameters().keySet());</div><div class="line">   <span class="comment">// åˆ¤æ–­æ˜¯å¦æ‰€æœ‰çš„åˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œ</span></div><div class="line">   <span class="keyword">if</span> (guaranteeService.isAllStarted()) &#123;</div><div class="line">       <span class="comment">// æ‰§è¡Œ</span></div><div class="line">       doBeforeJobExecutedAtLastStarted(shardingContexts);</div><div class="line">       <span class="comment">// æ¸…ç†å¯åŠ¨ä¿¡æ¯</span></div><div class="line">       guaranteeService.clearAllStartedInfo();</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç­‰å¾…</span></div><div class="line">   <span class="keyword">long</span> before = timeService.getCurrentMillis();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">synchronized</span> (startedWait) &#123;</div><div class="line">           startedWait.wait(startedTimeoutMilliseconds);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException ex) &#123;</div><div class="line">       Thread.interrupted();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç­‰å¾…è¶…æ—¶</span></div><div class="line">   <span class="keyword">if</span> (timeService.getCurrentMillis() - before &gt;= startedTimeoutMilliseconds) &#123;</div><div class="line">       <span class="comment">// æ¸…ç†å¯åŠ¨ä¿¡æ¯</span></div><div class="line">       guaranteeService.clearAllStartedInfo();</div><div class="line">       handleTimeout(startedTimeoutMilliseconds);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>GuaranteeService#registerStart(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œä½œä¸šåˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// GuaranteeService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStart</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingItems) &#123;</div><div class="line">       jobNodeStorage.createJobNodeIfNeeded(GuaranteeNode.getStartedNode(each));</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// GuaranteeNode.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GuaranteeNode</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = <span class="string">"guarantee"</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String STARTED_ROOT = ROOT + <span class="string">"/started"</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> String <span class="title">getStartedNode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> shardingItem)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> Joiner.on(<span class="string">"/"</span>).join(STARTED_ROOT, shardingItem);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Zookeeper æ•°æ®èŠ‚ç‚¹ <code>/${JOB_NAME}/guarantee/started/${ITEM_INDEX}</code> ä¸º<strong>æ°¸ä¹…</strong>èŠ‚ç‚¹ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ã€‚ä¸ºä»€ä¹ˆæ˜¯<strong>æ°¸ä¹…</strong>èŠ‚ç‚¹å‘¢ï¼Ÿåœ¨ <code>GuaranteeService#isAllStarted()</code> è§åˆ†æ™“ã€‚</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>GuaranteeService#isAllStarted()</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦æ‰€æœ‰çš„åˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ¤æ–­æ˜¯å¦æ‰€æœ‰çš„ä»»åŠ¡å‡å¯åŠ¨å®Œæ¯•.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦æ‰€æœ‰çš„ä»»åŠ¡å‡å¯åŠ¨å®Œæ¯•</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAllStarted</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> jobNodeStorage.isJobNodeExisted(GuaranteeNode.STARTED_ROOT)</div><div class="line">           &amp;&amp; configService.load(<span class="keyword">false</span>).getTypeConfig().getCoreConfig().getShardingTotalCount() == jobNodeStorage.getJobNodeChildrenKeys(GuaranteeNode.STARTED_ROOT).size();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å½“ <code>/${JOB_NAME}/guarantee/started/</code> ç›®å½•ä¸‹ï¼Œæ‰€æœ‰ä½œä¸šåˆ†ç‰‡é¡¹éƒ½å¼€å§‹è¿è¡Œï¼Œå³è¿è¡Œæ€»æ•°ç­‰äºä½œä¸šåˆ†ç‰‡æ€»æ•°( <code>JobCoreConfiguration.ShardingTotalCount</code> )ï¼Œ<strong>ä»£è¡¨æ‰€æœ‰çš„ä»»åŠ¡å‡å¯åŠ¨å®Œæ¯•</strong>ã€‚</li>
<li>ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¸æ’é™¤æœ‰ä½œä¸šèŠ‚ç‚¹ä¼šæŒ‚æ‰ï¼Œå¦‚æœ <code>/${JOB_NAME}/guarantee/started/${ITEM_INDEX}</code> å­˜å‚¨<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ï¼Œä¼šå¯¼è‡´ä¸èƒ½æ»¡è¶³æ‰€æœ‰çš„åˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œçš„æ¡ä»¶ã€‚</li>
<li>ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè°ƒæ•´ä½œä¸šåˆ†ç‰‡æ€»æ•°( <code>JobCoreConfiguration.ShardingTotalCount</code> )ï¼Œä¼šå¯¼è‡´å¼‚å¸¸ã€‚</li>
</ul>
</li>
<li><p>å½“ä¸æ»¡è¶³æ‰€æœ‰çš„åˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œæ—¶ï¼Œä½œä¸šèŠ‚ç‚¹è°ƒç”¨ <code>Object#wait(...)</code>  æ–¹æ³•è¿›è¡Œç­‰å¾…ã€‚è¯¥ç­‰å¾…æ€ä¹ˆç»“æŸç­‰å¾…ï¼Ÿå½“æ»¡è¶³æ‰€æœ‰çš„åˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œçš„ä½œä¸šèŠ‚ç‚¹è°ƒç”¨ <code>GuaranteeService#clearAllStartedInfo()</code> æ—¶ï¼ŒStartedNodeRemovedJobListener ä¼šç›‘å¬åˆ° <code>/${JOB_NAME}/guarantee/started/</code> è¢«åˆ é™¤ï¼Œè°ƒç”¨ <code>Object#notifyAll(...)</code> æ–¹æ³•è¿›è¡Œå”¤é†’å…¨éƒ¨ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// GuaranteeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ¸…ç†æ‰€æœ‰ä»»åŠ¡å¯åŠ¨ä¿¡æ¯.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearAllStartedInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">   jobNodeStorage.removeJobNodeIfExisted(GuaranteeNode.STARTED_ROOT);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// StartedNodeRemovedJobListener.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StartedNodeRemovedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (Type.NODE_REMOVED == eventType &amp;&amp; guaranteeNode.isStartedRootNode(path)) &#123;</div><div class="line">           <span class="keyword">for</span> (ElasticJobListener each : elasticJobListeners) &#123;</div><div class="line">               <span class="keyword">if</span> (each <span class="keyword">instanceof</span> AbstractDistributeOnceElasticJobListener) &#123;</div><div class="line">                   ((AbstractDistributeOnceElasticJobListener) each).notifyWaitingTaskStart();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>#doBeforeJobExecutedAtLastStarted(...)</code> æ–¹æ³•ï¼Œæ‰§è¡Œæœ€åä¸€ä¸ªä½œä¸šæ‰§è¡Œå‰çš„æ‰§è¡Œçš„æ–¹æ³•ï¼Œå®ç°è¯¥æŠ½è±¡æ–¹æ³•ï¼Œå®Œæˆè‡ªå®šä¹‰é€»è¾‘ã€‚<code>#doAfterJobExecutedAtLastCompleted(...)</code> å®ç°çš„æ–¹å¼ä¸€æ ·ï¼Œå°±ä¸é‡å¤è§£æäº†ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractDistributeOnceElasticJobListener.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ†å¸ƒå¼ç¯å¢ƒä¸­æœ€åä¸€ä¸ªä½œä¸šæ‰§è¡Œå‰çš„æ‰§è¡Œçš„æ–¹æ³•.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doBeforeJobExecutedAtLastStarted</span><span class="params">(ShardingContexts shardingContexts)</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ†å¸ƒå¼ç¯å¢ƒä¸­æœ€åä¸€ä¸ªä½œä¸šæ‰§è¡Œåçš„æ‰§è¡Œçš„æ–¹æ³•.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doAfterJobExecutedAtLastCompleted</span><span class="params">(ShardingContexts shardingContexts)</span></span>;</div></pre></td></tr></table></figure>
</li>
<li><p>æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š<img src="http://www.yunai.me/images/Elastic-Job/2017_11_21/02.png" alt="">    </p>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šå“å“Ÿå–‚ï¼ŒAbstractDistributeOnceElasticJobListener è¿˜ä¸é”™å“Ÿã€‚<br>èŠ‹é“å›ï¼šé‚£å¿…é¡»å¿…çš„ã€‚</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_21/03.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ElasticJobListener&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.yunai.me/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šäº‹ä»¶è¿½è¸ª</title>
    <link href="http://www.yunai.me/Elastic-Job/job-event-trace/"/>
    <id>http://www.yunai.me/Elastic-Job/job-event-trace/</id>
    <published>2017-11-13T16:00:00.000Z</published>
    <updated>2017-09-05T05:24:02.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ä½œä¸šäº‹ä»¶æ€»çº¿</a></li>
<li><a href="#">3. ä½œä¸šäº‹ä»¶</a>
<ul>
<li><a href="#">3.1 ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶</a></li>
<li><a href="#">3.2 ä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶</a></li>
<li><a href="#">3.3 ä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨</a></li>
<li><a href="#">3.4 ä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢</a></li>
</ul>
</li>
<li><a href="#">4. ä½œä¸šç›‘å¬å™¨</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šäº‹ä»¶è¿½è¸ª</strong>ã€‚</p>
<p>å¦å¤–ï¼Œ<strong>Elastic-Job-Cloud ä½œä¸šäº‹ä»¶è¿½è¸ª</strong> å’Œ Elastic-Job-Lite åŸºæœ¬ç±»ä¼¼ï¼Œä¸å•ç‹¬å¼€ä¸€ç¯‡æ–‡ç« ï¼Œè®°å½•åœ¨è¯¥æ–‡ç« é‡Œã€‚å¦‚æœä½ å¯¹ Elastic-Job-Cloud æš‚æ—¶ä¸æ„Ÿå…´è¶£ï¼Œå¯ä»¥è·³è¿‡ç›¸åº”éƒ¨åˆ†ã€‚</p>
<p>Elastic-Job æä¾›äº†äº‹ä»¶è¿½è¸ªåŠŸèƒ½ï¼Œå¯é€šè¿‡äº‹ä»¶è®¢é˜…çš„æ–¹å¼å¤„ç†è°ƒåº¦è¿‡ç¨‹çš„é‡è¦äº‹ä»¶ï¼Œç”¨äºæŸ¥è¯¢ã€ç»Ÿè®¡å’Œç›‘æ§ã€‚Elastic-Job ç›®å‰è®¢é˜…ä¸¤ç§äº‹ä»¶ï¼ŒåŸºäº<strong>å…³ç³»å‹æ•°æ®åº“</strong>è®°å½•äº‹ä»¶ã€‚</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_11_14/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_14/01.png" alt=""></p>
<ul>
<li>ä»¥ä¸Šç±»åœ¨ <code>com.dangdang.ddframe.job.event</code> åŒ…ï¼Œä¸ä»…ä¸º Elastic-Job-Liteï¼Œè€Œä¸”ä¸º Elastic-Job-Cloud å®ç°äº†äº‹ä»¶è¿½è¸ªåŠŸèƒ½ã€‚</li>
<li>ä½œä¸š<strong>äº‹ä»¶</strong>ï¼šç²‰è‰²çš„ç±»ã€‚</li>
<li>ä½œä¸š<strong>äº‹ä»¶æ€»çº¿</strong>ï¼šé»„è‰²çš„ç±»ã€‚</li>
<li>ä½œä¸š<strong>äº‹ä»¶ç›‘å¬å™¨</strong>ï¼šè“è‰²çš„ç±»ã€‚</li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>
åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>
ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1>2. ä½œä¸šäº‹ä»¶æ€»çº¿</h1>
<p>JobEventBusï¼Œä½œä¸šäº‹ä»¶æ€»çº¿ï¼Œæä¾›äº†æ³¨å†Œç›‘å¬å™¨ã€å‘å¸ƒäº‹ä»¶ä¸¤ä¸ªæ–¹æ³•ã€‚</p>
<p><strong>åˆ›å»º</strong> JobEventBus ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobEventBus</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šäº‹ä»¶é…ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobEventConfiguration jobEventConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * çº¿ç¨‹æ± æ‰§è¡ŒæœåŠ¡å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutorServiceObject executorServiceObject;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * äº‹ä»¶æ€»çº¿</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventBus eventBus;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ˜¯å¦æ³¨å†Œä½œä¸šç›‘å¬å™¨</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isRegistered;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobEventBus</span><span class="params">()</span> </span>&#123;</div><div class="line">        jobEventConfig = <span class="keyword">null</span>;</div><div class="line">        executorServiceObject = <span class="keyword">null</span>;</div><div class="line">        eventBus = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobEventBus</span><span class="params">(<span class="keyword">final</span> JobEventConfiguration jobEventConfig)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.jobEventConfig = jobEventConfig;</div><div class="line">        executorServiceObject = <span class="keyword">new</span> ExecutorServiceObject(<span class="string">"job-event"</span>, Runtime.getRuntime().availableProcessors() * <span class="number">2</span>);</div><div class="line">        <span class="comment">// åˆ›å»º å¼‚æ­¥äº‹ä»¶æ€»çº¿</span></div><div class="line">        eventBus = <span class="keyword">new</span> AsyncEventBus(executorServiceObject.createExecutorService());</div><div class="line">        <span class="comment">// æ³¨å†Œ äº‹ä»¶ç›‘å¬å™¨</span></div><div class="line">        register();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>JobEventBus åŸºäº <a href="https://github.com/google/guava/wiki/EventBusExplained" rel="external nofollow noopener noreferrer" target="_blank">Google Guava EventBus</a>ï¼Œåœ¨<a href="http://www.yunai.me/Sharding-JDBC/sql-execute">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œã€‹ã€Œ4.1 EventBusã€</a>æœ‰è¯¦ç»†åˆ†äº«ã€‚è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ AsyncEventBus( <strong>å¼‚æ­¥äº‹ä»¶æ€»çº¿</strong> )ï¼Œæ³¨å†Œåœ¨å…¶ä¸Šé¢çš„ç›‘å¬å™¨æ˜¯<strong>å¼‚æ­¥</strong>ç›‘å¬æ‰§è¡Œï¼Œäº‹ä»¶å‘å¸ƒæ— éœ€é˜»å¡ç­‰å¾…ç›‘å¬å™¨æ‰§è¡Œå®Œé€»è¾‘ï¼Œæ‰€ä»¥å¯¹æ€§èƒ½ä¸å­˜åœ¨å½±å“ã€‚</p>
</li>
<li>
<p>ä½¿ç”¨ JobEventConfiguration( ä½œä¸šäº‹ä»¶é…ç½® ) åˆ›å»ºäº‹ä»¶ç›‘å¬å™¨ï¼Œè°ƒç”¨ <code>#register()</code> æ–¹æ³•è¿›è¡Œæ³¨å†Œç›‘å¬ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       eventBus.register(jobEventConfig.createJobEventListener());</div><div class="line">       isRegistered = <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> JobEventListenerConfigurationException ex) &#123;</div><div class="line">       log.error(<span class="string">"Elastic job: create JobEventListener failure, error is: "</span>, ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯¥æ–¹æ³•æ˜¯ç§æœ‰( <code>private</code> )æ–¹æ³•ï¼Œåªèƒ½ä½¿ç”¨ JobEventConfiguration åˆ›å»ºäº‹ä»¶ç›‘å¬å™¨æ³¨å†Œã€‚å½“ä¸ä¼ é€’è¯¥é…ç½®æ—¶ï¼Œæ„å‘³ç€ä¸å¼€å¯<strong>äº‹ä»¶è¿½è¸ª</strong>åŠŸèƒ½ã€‚</li>
</ul>
</li>
</ul>
<p><strong>å‘å¸ƒä½œä¸šäº‹ä»¶</strong></p>
<p>å‘å¸ƒä½œä¸šäº‹ä»¶( JobEvent ) ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventBus.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(<span class="keyword">final</span> JobEvent event)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (isRegistered &amp;&amp; !executorServiceObject.isShutdown()) &#123;</div><div class="line">       eventBus.post(event);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨ Elaistc-Job-Lite é‡Œï¼ŒLiteJobFacade å¯¹ <code>JobEventBus#post(...)</code> è¿›è¡Œå°è£…ï¼Œæä¾›ç»™ä½œä¸šæ‰§è¡Œå™¨( AbstractElasticJobExecutor )è°ƒç”¨( Elastic-Job-Cloud å®é™…ä¹Ÿè¿›è¡Œäº†å°è£… )ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postJobExecutionEvent</span><span class="params">(<span class="keyword">final</span> JobExecutionEvent jobExecutionEvent)</span> </span>&#123;</div><div class="line">   jobEventBus.post(jobExecutionEvent);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postJobStatusTraceEvent</span><span class="params">(<span class="keyword">final</span> String taskId, <span class="keyword">final</span> State state, <span class="keyword">final</span> String message)</span> </span>&#123;</div><div class="line">   TaskContext taskContext = TaskContext.from(taskId);</div><div class="line">   jobEventBus.post(<span class="keyword">new</span> JobStatusTraceEvent(taskContext.getMetaInfo().getJobName(), taskContext.getId(),</div><div class="line">           taskContext.getSlaveId(), Source.LITE_EXECUTOR, taskContext.getType(), taskContext.getMetaInfo().getShardingItems().toString(), state, message));</div><div class="line">   <span class="keyword">if</span> (!Strings.isNullOrEmpty(message)) &#123;</div><div class="line">       log.trace(message);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>TaskContext é€šè¿‡ <code>#from(...)</code> æ–¹æ³•ï¼Œå¯¹ä½œä¸šä»»åŠ¡ID( <code>taskId</code> ) è§£æï¼Œè·å–ä»»åŠ¡ä¸Šä¸‹æ–‡ã€‚TaskContext ä»£ç æ³¨é‡Šå¾ˆå®Œæ•´ï¼Œç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/8926e94aa7c48dc635a36518da2c4b10194420a5/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/context/TaskContext.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</li>
</ul>
<h1>3. ä½œä¸šäº‹ä»¶</h1>
<p>ç›®å‰æœ‰ä¸¤ç§ä½œä¸šäº‹ä»¶( JobEvent )ï¼š</p>
<ul>
<li>JobStatusTraceEventï¼Œä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶ã€‚</li>
<li>JobExecutionEventï¼Œä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶ã€‚</li>
</ul>
<p>æœ¬å°èŠ‚åˆ†äº«ä¸¤æ–¹é¢ï¼š</p>
<ul>
<li>ä½œä¸šäº‹ä»¶<strong>å‘å¸ƒæ—¶æœº</strong>ã€‚</li>
<li>Elastic-Job åŸºäº<strong>å…³ç³»å‹æ•°æ®åº“</strong>è®°å½•äº‹ä»¶çš„<strong>è¡¨ç»“æ„</strong>ã€‚</li>
</ul>
<h2>3.1 ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶</h2>
<p>JobStatusTraceEventï¼Œä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobStatusTraceEvent</span> <span class="keyword">implements</span> <span class="title">JobEvent</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸»é”®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String id = UUID.randomUUID().toString();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåç§°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åŸä½œä¸šä»»åŠ¡ID</div><div class="line">     */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> String originalTaskId = <span class="string">""</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šä»»åŠ¡ID</div><div class="line">     * æ¥è‡ª &#123;<span class="doctag">@link</span> com.dangdang.ddframe.job.executor.ShardingContexts#taskId&#125;</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String taskId;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰§è¡Œä½œä¸šæœåŠ¡å™¨çš„åå­—</div><div class="line">     * Elastic-Job-Liteï¼Œä½œä¸šèŠ‚ç‚¹çš„ IP åœ°å€</div><div class="line">     * Elastic-Job-Cloudï¼ŒMesos æ‰§è¡Œæœºä¸»é”®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String slaveId;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä»»åŠ¡æ¥æº</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Source source;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä»»åŠ¡æ‰§è¡Œç±»å‹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutionType executionType;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåˆ†ç‰‡é¡¹</div><div class="line">     * å¤šä¸ªåˆ†ç‰‡é¡¹ä»¥é€—å·åˆ†éš”</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String shardingItems;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> State state;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç›¸å…³ä¿¡æ¯</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String message;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è®°å½•åˆ›å»ºæ—¶é—´</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Date creationTime = <span class="keyword">new</span> Date();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>ExecutionTypeï¼Œæ‰§è¡Œç±»å‹ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ExecutionType &#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å‡†å¤‡æ‰§è¡Œçš„ä»»åŠ¡.</div><div class="line">     */</div><div class="line">    READY,</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¤±æ•ˆè½¬ç§»çš„ä»»åŠ¡.</div><div class="line">     */</div><div class="line">    FAILOVER</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
<li>
<p>Sourceï¼Œä»»åŠ¡æ¥æºã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Source &#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Elastic-Job-Cloud è°ƒåº¦å™¨</div><div class="line">    */</div><div class="line">   CLOUD_SCHEDULER,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Elastic-Job-Cloud æ‰§è¡Œå™¨</div><div class="line">    */</div><div class="line">   CLOUD_EXECUTOR,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Elastic-Job-Lite æ‰§è¡Œå™¨</div><div class="line">    */</div><div class="line">   LITE_EXECUTOR</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
<li>
<p>Stateï¼Œä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> State &#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * å¼€å§‹ä¸­</div><div class="line">    */</div><div class="line">   TASK_STAGING,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * è¿è¡Œä¸­</div><div class="line">    */</div><div class="line">   TASK_RUNNING,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * å®Œæˆï¼ˆæ­£å¸¸ï¼‰</div><div class="line">    */</div><div class="line">   TASK_FINISHED,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * å®Œæˆï¼ˆå¼‚å¸¸ï¼‰</div><div class="line">    */</div><div class="line">   TASK_ERROR,</div><div class="line">       </div><div class="line">   TASK_KILLED, TASK_LOST, TASK_FAILED,  TASK_DROPPED, TASK_GONE, TASK_GONE_BY_OPERATOR, TASK_UNREACHABLE, TASK_UNKNOWN</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>Elastic-Job-Lite / Elastic-Job-Cloud  TASK_STAGINGã€TASK_RUNNINGã€TASK_FINISHEDã€TASK_ERROR å››ç§æ‰§è¡ŒçŠ¶æ€ã€‚</li>
<li>å…¶ä»–æ‰§è¡ŒçŠ¶æ€æš‚æ—¶æœªä½¿ç”¨åˆ°ã€‚</li>
</ul>
</li>
</ul>
<p>å…³ç³»æ•°æ®åº“è¡¨ <code>JOB_STATUS_TRACE_LOG</code> ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`JOB_STATUS_TRACE_LOG`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">varchar</span>(<span class="number">40</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`job_name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`original_task_id`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`task_id`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`slave_id`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`source`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`execution_type`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`sharding_item`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`state`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`message`</span> <span class="built_in">varchar</span>(<span class="number">4000</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`creation_time`</span> <span class="keyword">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`TASK_ID_STATE_INDEX`</span> (<span class="string">`task_id`</span>,<span class="string">`state`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COLLATE</span>=utf8_bin</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>Elastic-Job-Lite ä¸€æ¬¡ä½œä¸šæ‰§è¡Œè®°å½•å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_11_14/02.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_14/02.png" alt=""></p>
</li>
</ul>
<p><strong>JobStatusTraceEvent åœ¨ Elastic-Job-Lite å‘å¸ƒæ—¶æœº</strong>ï¼š</p>
<ul>
<li>
<p>State.TASK_STAGINGï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">    <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_STAGING)</span></div><div class="line">    <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">        jobFacade.postJobStatusTraceEvent(shardingContexts.getTaskId(), State.TASK_STAGING, String.format(<span class="string">"Job '%s' execute begin."</span>, jobName));</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
<li>
<p>State.TASK_RUNNINGï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">   <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_RUNNING)</span></div><div class="line">   <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">       jobFacade.postJobStatusTraceEvent(taskId, State.TASK_RUNNING, <span class="string">""</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
<li>
<p>State.TASK_FINISHEDã€State.TASK_ERRORã€ç¬¬ä¸€ç§ã€‘ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">    <span class="comment">// è·³è¿‡ å­˜åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡ä½œä¸š</span></div><div class="line">    <span class="keyword">if</span> (jobFacade.misfireIfRunning(shardingContexts.getShardingItemParameters().keySet())) &#123;</div><div class="line">      <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_FINISHED)</span></div><div class="line">      <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">          jobFacade.postJobStatusTraceEvent(shardingContexts.getTaskId(), State.TASK_FINISHED, String.format(</div><div class="line">                  <span class="string">"Previous job '%s' - shardingItems '%s' is still running, misfired job will start after previous job completed."</span>, jobName, </div><div class="line">                  shardingContexts.getShardingItemParameters().keySet()));</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<ul>
<li>
<p>State.TASK_FINISHEDã€State.TASK_ERRORã€ç¬¬äºŒç§ã€‘ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">  <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      process(shardingContexts, executionSource);</div><div class="line">  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">      <span class="comment">// æ ¹æ®æ˜¯å¦æœ‰å¼‚å¸¸ï¼Œå‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_FINISHED / State.TASK_ERROR)</span></div><div class="line">      <span class="keyword">if</span> (itemErrorMessages.isEmpty()) &#123;</div><div class="line">          <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">              jobFacade.postJobStatusTraceEvent(taskId, State.TASK_FINISHED, <span class="string">""</span>);</div><div class="line">          &#125;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">              jobFacade.postJobStatusTraceEvent(taskId, State.TASK_ERROR, itemErrorMessages.toString());</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<p><strong>JobStatusTraceEvent åœ¨ Elastic-Job-Cloud å‘å¸ƒæ—¶æœº</strong>ï¼š</p>
<p>Elastic-Job-Cloud é™¤äº†ä¸Šæ–‡ Elastic-Job-Lite ä¼šå¤šä¸€ä¸ªåœºæ™¯ä¸‹è®°å½•ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶( <strong>State.TASK_STAGING</strong> )ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TaskLaunchScheduledService.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> JobStatusTraceEvent <span class="title">createJobStatusTraceEvent</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">  TaskContext.MetaInfo metaInfo = taskContext.getMetaInfo();</div><div class="line">  JobStatusTraceEvent result = <span class="keyword">new</span> JobStatusTraceEvent(metaInfo.getJobName(), taskContext.getId(), taskContext.getSlaveId(),</div><div class="line">          Source.CLOUD_SCHEDULER, taskContext.getType(), String.valueOf(metaInfo.getShardingItems()), JobStatusTraceEvent.State.TASK_STAGING, <span class="string">""</span>);</div><div class="line">  <span class="comment">// å¤±æ•ˆè½¬ç§»</span></div><div class="line">  <span class="keyword">if</span> (ExecutionType.FAILOVER == taskContext.getType()) &#123;</div><div class="line">      Optional&lt;String&gt; taskContextOptional = facadeService.getFailoverTaskId(metaInfo);</div><div class="line">      <span class="keyword">if</span> (taskContextOptional.isPresent()) &#123;</div><div class="line">          result.setOriginalTaskId(taskContextOptional.get());</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ä»»åŠ¡æäº¤è°ƒåº¦æœåŠ¡( TaskLaunchScheduledService )æäº¤ä»»åŠ¡æ—¶ï¼Œè®°å½•å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_STAGING)ã€‚</li>
</ul>
<h2>3.2 ä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶</h2>
<p>JobExecutionEventï¼Œä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobExecutionEvent</span> <span class="keyword">implements</span> <span class="title">JobEvent</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸»é”®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String id = UUID.randomUUID().toString();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸»æœºåç§°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String hostname = IpUtils.getHostName();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * IP</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String ip = IpUtils.getIp();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šä»»åŠ¡ID</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String taskId;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåå­—</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰§è¡Œæ¥æº</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutionSource source;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåˆ†ç‰‡é¡¹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> shardingItem;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¼€å§‹æ—¶é—´</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Date startTime = <span class="keyword">new</span> Date();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç»“æŸæ—¶é—´</div><div class="line">     */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> Date completeTime;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ˜¯å¦æ‰§è¡ŒæˆåŠŸ</div><div class="line">     */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> success;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰§è¡Œå¤±è´¥åŸå› </div><div class="line">     */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> JobExecutionEventThrowable failureCause;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>ExecutionSourceï¼Œæ‰§è¡Œæ¥æº</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ExecutionSource &#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * æ™®é€šè§¦å‘æ‰§è¡Œ</div><div class="line">    */</div><div class="line">   NORMAL_TRIGGER,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * è¢«é”™è¿‡æ‰§è¡Œ</div><div class="line">    */</div><div class="line">   MISFIRE,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * å¤±æ•ˆè½¬ç§»æ‰§è¡Œ</div><div class="line">    */</div><div class="line">   FAILOVER</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<p>å…³ç³»æ•°æ®åº“è¡¨ <code>JOB_EXECUTION_LOG</code> ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`JOB_EXECUTION_LOG`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">varchar</span>(<span class="number">40</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`job_name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`task_id`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`hostname`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`ip`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`sharding_item`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`execution_source`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`failure_cause`</span> <span class="built_in">varchar</span>(<span class="number">4000</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`is_success`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`start_time`</span> <span class="keyword">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`complete_time`</span> <span class="keyword">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COLLATE</span>=utf8_bin</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>Elastic-Job-Lite ä¸€æ¬¡ä½œä¸š<strong>å¤šä½œä¸šåˆ†ç‰‡é¡¹</strong>æ‰§è¡Œè®°å½•å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_11_14/03.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_14/03.png" alt=""></p>
</li>
</ul>
<p><strong>JobExecutionEvent åœ¨ Elastic-Job-Lite å‘å¸ƒæ—¶æœº</strong>ï¼š</p>
<pre><code><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> <span class="keyword">int</span> item, <span class="keyword">final</span> JobExecutionEvent startEvent)</span> </span>&#123;</div><div class="line">   <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(å¼€å§‹)</span></div><div class="line">   <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">       jobFacade.postJobExecutionEvent(startEvent);</div><div class="line">   &#125;</div><div class="line">   JobExecutionEvent completeEvent;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// æ‰§è¡Œå•ä¸ªä½œä¸š</span></div><div class="line">       process(<span class="keyword">new</span> ShardingContext(shardingContexts, item));</div><div class="line">       <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(æˆåŠŸ)</span></div><div class="line">       completeEvent = startEvent.executionSuccess();</div><div class="line">       <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">           jobFacade.postJobExecutionEvent(completeEvent);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable cause) &#123;</div><div class="line">       <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(å¤±è´¥)</span></div><div class="line">       completeEvent = startEvent.executionFailure(cause);</div><div class="line">       jobFacade.postJobExecutionEvent(completeEvent);</div><div class="line">       <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre>
<p><strong>JobExecutionEvent åœ¨ Elastic-Job-Cloud å‘å¸ƒæ—¶æœº</strong>ï¼š</p>
<p>å’Œ Elastic-Job-Cloud ä¸€è‡´ã€‚</p>
<h2>3.3 ä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨</h2>
<p>JobEventRdbStorageï¼Œä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨ã€‚</p>
<p><strong>åˆ›å»º</strong> JobEventRdbStorage ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">JobEventRdbStorage(<span class="keyword">final</span> DataSource dataSource) <span class="keyword">throws</span> SQLException &#123;</div><div class="line">   <span class="keyword">this</span>.dataSource = dataSource;</div><div class="line">   initTablesAndIndexes();</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initTablesAndIndexes</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">try</span> (Connection conn = dataSource.getConnection()) &#123;</div><div class="line">       createJobExecutionTableAndIndexIfNeeded(conn);</div><div class="line">       createJobStatusTraceTableAndIndexIfNeeded(conn);</div><div class="line">       databaseType = DatabaseType.valueFrom(conn.getMetaData().getDatabaseProductName());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è°ƒç”¨ <code>#createJobExecutionTableAndIndexIfNeeded(...)</code> åˆ›å»º <code>JOB_EXECUTION_LOG</code> è¡¨å’Œç´¢å¼•ã€‚</li>
<li>è°ƒç”¨ <code>#createJobStatusTraceTableAndIndexIfNeeded(...)</code> åˆ›å»º <code>JOB_STATUS_TRACE_LOG</code> è¡¨å’Œç´¢å¼•ã€‚</li>
</ul>
<p><strong>å­˜å‚¨</strong> JobStatusTraceEvent ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventRdbStorage.java</span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">addJobStatusTraceEvent</span><span class="params">(<span class="keyword">final</span> JobStatusTraceEvent jobStatusTraceEvent)</span> </span>&#123;</div><div class="line">   String originalTaskId = jobStatusTraceEvent.getOriginalTaskId();</div><div class="line">   <span class="keyword">if</span> (State.TASK_STAGING != jobStatusTraceEvent.getState()) &#123;</div><div class="line">       originalTaskId = getOriginalTaskId(jobStatusTraceEvent.getTaskId());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line">   String sql = <span class="string">"INSERT INTO `"</span> + TABLE_JOB_STATUS_TRACE_LOG + <span class="string">"` (`id`, `job_name`, `original_task_id`, `task_id`, `slave_id`, `source`, `execution_type`, `sharding_item`,  "</span> </div><div class="line">           + <span class="string">"`state`, `message`, `creation_time`) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);"</span>;</div><div class="line">   <span class="comment">// ... çœç•¥ä½ æ‡‚çš„ä»£ç </span></div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getOriginalTaskId</span><span class="params">(<span class="keyword">final</span> String taskId)</span> </span>&#123;</div><div class="line">   String sql = String.format(<span class="string">"SELECT original_task_id FROM %s WHERE task_id = '%s' and state='%s'"</span>, TABLE_JOB_STATUS_TRACE_LOG, taskId, State.TASK_STAGING);</div><div class="line">   <span class="comment">// ... çœç•¥ä½ æ‡‚çš„ä»£ç </span></div><div class="line">   <span class="keyword">return</span> original_task_id;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>originalTaskId</code>ï¼ŒåŸä»»åŠ¡ä½œä¸šIDã€‚
<ul>
<li>Elastic-Job-Lite æš‚æœªä½¿ç”¨åˆ°è¯¥å­—æ®µï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ã€‚</li>
<li>Elastic-Job-Cloud åœ¨<strong>ä½œä¸šå¤±æ•ˆè½¬ç§»</strong>åœºæ™¯ä¸‹ä½¿ç”¨è¯¥å­—æ®µï¼Œå­˜å‚¨å¤±æ•ˆè½¬ç§»çš„ä»»åŠ¡ä½œä¸šIDã€‚</li>
</ul>
</li>
</ul>
<p><strong>å­˜å‚¨</strong> JobExecutionEvent ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventRdbStorage.java</span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">addJobExecutionEvent</span><span class="params">(<span class="keyword">final</span> JobExecutionEvent jobExecutionEvent)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> == jobExecutionEvent.getCompleteTime()) &#123; <span class="comment">// ä½œä¸šåˆ†ç‰‡é¡¹æ‰§è¡Œå¼€å§‹</span></div><div class="line">       <span class="keyword">return</span> insertJobExecutionEvent(jobExecutionEvent);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">if</span> (jobExecutionEvent.isSuccess()) &#123; <span class="comment">// ä½œä¸šåˆ†ç‰‡é¡¹æ‰§è¡Œå®Œæˆï¼ˆæ­£å¸¸ï¼‰</span></div><div class="line">           <span class="keyword">return</span> updateJobExecutionEventWhenSuccess(jobExecutionEvent);</div><div class="line">       &#125; <span class="keyword">else</span> &#123; <span class="comment">// ä½œä¸šåˆ†ç‰‡é¡¹æ‰§è¡Œå®Œæˆï¼ˆå¼‚å¸¸ï¼‰</span></div><div class="line">           <span class="keyword">return</span> updateJobExecutionEventFailure(jobExecutionEvent);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ä½œä¸šåˆ†ç‰‡é¡¹æ‰§è¡Œå®Œæˆè¿›è¡Œçš„æ˜¯<strong>æ›´æ–°</strong>æ“ä½œã€‚</li>
</ul>
<h2>3.4 ä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢</h2>
<p>JobEventRdbSearchï¼Œä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢ï¼Œæä¾›ç»™è¿ç»´å¹³å°è°ƒç”¨æŸ¥è¯¢æ•°æ®ã€‚æ„Ÿå…´è¶£çš„åŒå­¦ç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/8283acf01548222f39f7bfc202a8f89d27728e6c/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/event/rdb/JobEventRdbSearch.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</p>
<h1>4. ä½œä¸šç›‘å¬å™¨</h1>
<p>åœ¨ä¸Šæ–‡æˆ‘ä»¬çœ‹åˆ°ï¼Œä½œä¸šç›‘å¬å™¨é€šè¿‡ä¼ é€’ä½œä¸šäº‹ä»¶é…ç½®( JobEventConfiguration )ç»™ä½œä¸šäº‹ä»¶æ€»çº¿( JobEventBus ) <strong>è¿›è¡Œåˆ›å»ºç›‘å¬å™¨ï¼Œå¹¶æ³¨å†Œç›‘å¬å™¨åˆ°äº‹ä»¶æ€»çº¿</strong>ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ Elastic-Job æä¾›çš„åŸºäº<strong>å…³ç³»æ•°æ®åº“</strong>çš„äº‹ä»¶é…ç½®å®ç°ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventConfiguration.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JobEventConfiguration</span> <span class="keyword">extends</span> <span class="title">JobEventIdentity</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ›å»ºä½œä¸šäº‹ä»¶ç›‘å¬å™¨.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span> ä½œä¸šäº‹ä»¶ç›‘å¬å™¨.</div><div class="line">     * <span class="doctag">@throws</span> JobEventListenerConfigurationException ä½œä¸šäº‹ä»¶ç›‘å¬å™¨é…ç½®å¼‚å¸¸</div><div class="line">     */</div><div class="line">    <span class="function">JobEventListener <span class="title">createJobEventListener</span><span class="params">()</span> <span class="keyword">throws</span> JobEventListenerConfigurationException</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobEventRdbConfiguration.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobEventRdbConfiguration</span> <span class="keyword">extends</span> <span class="title">JobEventRdbIdentity</span> <span class="keyword">implements</span> <span class="title">JobEventConfiguration</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">transient</span> DataSource dataSource;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> JobEventListener <span class="title">createJobEventListener</span><span class="params">()</span> <span class="keyword">throws</span> JobEventListenerConfigurationException </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JobEventRdbListener(dataSource);</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobEventListenerConfigurationException(ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>JobEventRdbConfigurationï¼Œä½œä¸šæ•°æ®åº“äº‹ä»¶é…ç½®ã€‚è°ƒç”¨ <code>#createJobEventListener()</code> åˆ›å»ºä½œä¸šäº‹ä»¶æ•°æ®åº“ç›‘å¬å™¨( JobEventRdbListener )ã€‚</li>
</ul>
<p>JobEventRdbListenerï¼Œä½œä¸šäº‹ä»¶æ•°æ®åº“ç›‘å¬å™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventListener.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JobEventListener</span> <span class="keyword">extends</span> <span class="title">JobEventIdentity</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šæ‰§è¡Œäº‹ä»¶ç›‘å¬æ‰§è¡Œ.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> jobExecutionEvent ä½œä¸šæ‰§è¡Œäº‹ä»¶</div><div class="line">     */</div><div class="line">    <span class="meta">@Subscribe</span></div><div class="line">    <span class="meta">@AllowConcurrentEvents</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">listen</span><span class="params">(JobExecutionEvent jobExecutionEvent)</span></span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šçŠ¶æ€ç—•è¿¹äº‹ä»¶ç›‘å¬æ‰§è¡Œ.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> jobStatusTraceEvent ä½œä¸šçŠ¶æ€ç—•è¿¹äº‹ä»¶</div><div class="line">     */</div><div class="line">    <span class="meta">@Subscribe</span></div><div class="line">    <span class="meta">@AllowConcurrentEvents</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">listen</span><span class="params">(JobStatusTraceEvent jobStatusTraceEvent)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobEventRdbListener.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobEventRdbListener</span> <span class="keyword">extends</span> <span class="title">JobEventRdbIdentity</span> <span class="keyword">implements</span> <span class="title">JobEventListener</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobEventRdbStorage repository;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobEventRdbListener</span><span class="params">(<span class="keyword">final</span> DataSource dataSource)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        repository = <span class="keyword">new</span> JobEventRdbStorage(dataSource);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(<span class="keyword">final</span> JobExecutionEvent executionEvent)</span> </span>&#123;</div><div class="line">        repository.addJobExecutionEvent(executionEvent);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(<span class="keyword">final</span> JobStatusTraceEvent jobStatusTraceEvent)</span> </span>&#123;</div><div class="line">        repository.addJobStatusTraceEvent(jobStatusTraceEvent);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>é€šè¿‡ JobEventRdbStorage å­˜å‚¨ä½œä¸šäº‹ä»¶åˆ°å…³ç³»å‹æ•°æ®åº“ã€‚</li>
</ul>
<p><strong>å¦‚ä½•è‡ªå®šä¹‰ä½œä¸šç›‘å¬å™¨ï¼Ÿ</strong></p>
<p>æœ‰äº›åŒå­¦å¯èƒ½å¸Œæœ›ä½¿ç”¨ ES æˆ–è€…å…¶ä»–æ•°æ®åº“å­˜å‚¨ä½œä¸šäº‹ä»¶ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥é€šè¿‡å®ç° JobEventConfigurationã€JobEventListener è¿›è¡Œæ‹“å±•ã€‚</p>
<p><strong>Elastic-Job-Cloud JobEventConfiguration æ€ä¹ˆé…ç½®ï¼Ÿ</strong></p>
<ul>
<li>
<p>Elastic-Job-Cloud-Schedulerï¼šä» <code>conf/elastic-job-cloud-scheduler.properties</code> é…ç½®æ–‡ä»¶è¯»å–å¦‚ä¸‹å±æ€§ï¼Œç”Ÿæˆ JobEventConfiguration é…ç½®å¯¹è±¡ã€‚</p>
<ul>
<li><code>event_trace_rdb_driver</code></li>
<li><code>event_trace_rdb_url</code></li>
<li><code>event_trace_rdb_username</code></li>
<li><code>event_trace_rdb_password</code></li>
</ul>
</li>
<li>
<p>Elastic-Job-Cloud-Executorï¼šé€šè¿‡æ¥æ”¶åˆ°ä»»åŠ¡æ‰§è¡Œä¿¡æ¯é‡Œè¯»å–JobEventConfigurationï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TaskExecutor.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registered</span><span class="params">(<span class="keyword">final</span> ExecutorDriver executorDriver, <span class="keyword">final</span> Protos.ExecutorInfo executorInfo, <span class="keyword">final</span> Protos.FrameworkInfo frameworkInfo, <span class="keyword">final</span> Protos.SlaveInfo slaveInfo)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!executorInfo.getData().isEmpty()) &#123;</div><div class="line">       Map&lt;String, String&gt; data = SerializationUtils.deserialize(executorInfo.getData().toByteArray());</div><div class="line">       BasicDataSource dataSource = <span class="keyword">new</span> BasicDataSource();</div><div class="line">       dataSource.setDriverClassName(data.get(<span class="string">"event_trace_rdb_driver"</span>));</div><div class="line">       dataSource.setUrl(data.get(<span class="string">"event_trace_rdb_url"</span>));</div><div class="line">       dataSource.setPassword(data.get(<span class="string">"event_trace_rdb_password"</span>));</div><div class="line">       dataSource.setUsername(data.get(<span class="string">"event_trace_rdb_username"</span>));</div><div class="line">       jobEventBus = <span class="keyword">new</span> JobEventBus(<span class="keyword">new</span> JobEventRdbConfiguration(dataSource));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<h1>666. å½©è›‹</h1>
<p>æ—ç™½å›ï¼šçæ¯”æ¯”äº†è¿™ä¹ˆé•¿ï¼Œèƒ½ä¸èƒ½ç®€å•ç²—æš´ä¸€ç‚¹ã€‚<br>
èŠ‹é“å›ï¼šæ˜¯æ˜¯æ˜¯ã€‚</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_14/04.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ä½œä¸šäº‹ä»¶æ€»çº¿&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.yunai.me/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»</title>
    <link href="http://www.yunai.me/Elastic-Job/job-failover/"/>
    <id>http://www.yunai.me/Elastic-Job/job-failover/</id>
    <published>2017-11-06T16:00:00.000Z</published>
    <updated>2017-09-02T09:56:16.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ä½œä¸šèŠ‚ç‚¹å´©æºƒç›‘å¬</a></li>
<li><a href="#">3. ä½œä¸šå¤±æ•ˆè½¬ç§»</a></li>
<li><a href="#">4. è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</a></li>
<li><a href="#">5. ç›‘å¬ä½œä¸šå¤±æ•ˆè½¬ç§»åŠŸèƒ½å…³é—­</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šå¤±æ•ˆè½¬ç§»</strong>ã€‚</p>
<p>å½“ä½œä¸šèŠ‚ç‚¹æ‰§è¡Œä½œä¸šå¼‚å¸¸å´©æºƒæ—¶ï¼Œå…¶æ‰€åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹åœ¨ä¸‹æ¬¡é‡æ–°åˆ†ç‰‡ä¹‹å‰ä¸ä¼šè¢«é‡æ–°æ‰§è¡Œã€‚å¼€å¯å¤±æ•ˆè½¬ç§»åŠŸèƒ½åï¼Œè¿™éƒ¨åˆ†ä½œä¸šåˆ†ç‰‡é¡¹å°†è¢«å…¶ä»–ä½œä¸šèŠ‚ç‚¹æŠ“å–åâ€œæ‰§è¡Œâ€ã€‚ä¸ºä»€ä¹ˆæ­¤å¤„çš„æ‰§è¡Œæ‰“å¼•å·å‘¢ï¼ŸğŸ˜ˆä¸‹æ–‡æˆ‘ä»¬ä¼šåˆ†äº«åˆ°å™¢ï¼Œå–ä¸ªå…³å­ã€‚</p>
<p>ç¬”è€…å¯¹<strong>å¤±æ•ˆè½¬ç§»</strong>ç†è§£äº†è›®ä¹…æ—¶é—´ï¼Œå› æ­¤å¼•ç”¨å®˜æ–¹å¯¹å®ƒçš„è§£é‡Šï¼Œè®©ä½ èƒ½æ›´å¥½çš„ç†è§£ï¼š</p>
<blockquote>
<p>æ¥æºåœ°å€ï¼š<a href="https://my.oschina.net/u/719192/blog/506062" rel="external nofollow noopener noreferrer" target="_blank">https://my.oschina.net/u/719192/blog/506062</a><br>å¤±æ•ˆè½¬ç§»ï¼š è¿è¡Œä¸­çš„ä½œä¸šæœåŠ¡å™¨å´©æºƒä¸ä¼šå¯¼è‡´é‡æ–°åˆ†ç‰‡ï¼Œåªä¼šåœ¨ä¸‹æ¬¡ä½œä¸šå¯åŠ¨æ—¶åˆ†ç‰‡ã€‚å¯ç”¨å¤±æ•ˆè½¬ç§»åŠŸèƒ½å¯ä»¥åœ¨æœ¬æ¬¡ä½œä¸šæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç›‘æµ‹å…¶ä»–ä½œä¸šæœåŠ¡å™¨ç©ºé—²ï¼ŒæŠ“å–æœªå®Œæˆçš„å­¤å„¿åˆ†ç‰‡é¡¹æ‰§è¡Œã€‚<br>â€“ åˆ†éš”ç¬¦ â€“<br>æ¥æºåœ°å€ï¼š<a href="http://dangdangdotcom.github.io/elastic-job/elastic-job-lite/03-design/lite-design/" rel="external nofollow noopener noreferrer" target="_blank">http://dangdangdotcom.github.io/elastic-job/elastic-job-lite/03-design/lite-design/</a><br>å®ç°å¤±æ•ˆè½¬ç§»åŠŸèƒ½ï¼Œåœ¨æŸå°æœåŠ¡å™¨æ‰§è¡Œå®Œæ¯•åä¸»åŠ¨æŠ“å–æœªåˆ†é…çš„åˆ†ç‰‡ï¼Œå¹¶ä¸”åœ¨æŸå°æœåŠ¡å™¨ä¸‹çº¿åä¸»åŠ¨å¯»æ‰¾å¯ç”¨çš„æœåŠ¡å™¨æ‰§è¡Œä»»åŠ¡ã€‚</p>
</blockquote>
<p>è¿™æ ·çœ‹æ¦‚å¿µå¯èƒ½è¿˜æ˜¯æ¯”è¾ƒéš¾ç†è§£ï¼Œä»£ç æèµ·æ¥ï¼</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_11_07/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_07/01.png" alt=""></p>
<ul>
<li>ç²‰è‰²çš„ç±»åœ¨ <code>com.dangdang.ddframe.job.lite.internal.failover</code> åŒ…ä¸‹ï¼Œå®ç°äº† Elastic-Job-Lite ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‚</li>
<li>FailoverServiceï¼Œä½œä¸šå¤±æ•ˆè½¬ç§»æœåŠ¡ã€‚</li>
<li>FailoverNodeï¼Œä½œä¸šå¤±æ•ˆè½¬ç§»æ•°æ®å­˜å‚¨è·¯å¾„ã€‚</li>
<li>FailoverListenerManagerï¼Œä½œä¸šå¤±æ•ˆè½¬ç§»ç›‘å¬ç®¡ç†å™¨ã€‚</li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-ä½œä¸šèŠ‚ç‚¹å´©æºƒç›‘å¬"><a href="#2-ä½œä¸šèŠ‚ç‚¹å´©æºƒç›‘å¬" class="headerlink" title="2. ä½œä¸šèŠ‚ç‚¹å´©æºƒç›‘å¬"></a>2. ä½œä¸šèŠ‚ç‚¹å´©æºƒç›‘å¬</h1><p>å½“ä½œä¸šèŠ‚ç‚¹å´©æºƒæ—¶ï¼Œç›‘å¬å™¨ JobCrashedJobListener ä¼šç›‘å¬åˆ°è¯¥æƒ…å†µï¼Œè¿›è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»å¤„ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobCrashedJobListener.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JobCrashedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (isFailoverEnabled() &amp;&amp; Type.NODE_REMOVED == eventType</div><div class="line">               &amp;&amp; instanceNode.isInstancePath(path)) &#123; <span class="comment">// /$&#123;JOB_NAME&#125;/instances/$&#123;INSTANCE_ID&#125;</span></div><div class="line">           String jobInstanceId = path.substring(instanceNode.getInstanceFullPath().length() + <span class="number">1</span>);</div><div class="line">           <span class="keyword">if</span> (jobInstanceId.equals(JobRegistry.getInstance().getJobInstance(jobName).getJobInstanceId())) &#123;</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           &#125;</div><div class="line">           List&lt;Integer&gt; failoverItems = failoverService.getFailoverItems(jobInstanceId); <span class="comment">// /$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/failover</span></div><div class="line">           <span class="keyword">if</span> (!failoverItems.isEmpty()) &#123;</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> each : failoverItems) &#123;</div><div class="line">                   failoverService.setCrashedFailoverFlag(each);</div><div class="line">                   failoverService.failoverIfNecessary();</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingService.getShardingItems(jobInstanceId)) &#123; <span class="comment">// /$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/instance</span></div><div class="line">                   failoverService.setCrashedFailoverFlag(each);</div><div class="line">                   failoverService.failoverIfNecessary();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>é€šè¿‡åˆ¤æ–­ <code>/${JOB_NAME}/instances/${INSTANCE_ID}</code> è¢«ç§»é™¤ï¼Œæ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»é€»è¾‘ã€‚â“è¯´å¥½çš„ä½œä¸šèŠ‚ç‚¹<strong>å´©æºƒ</strong>å‘¢ï¼Ÿç»è¿‡ç¡®è®¤ï¼Œç›®å‰è¿™å—å­˜åœ¨ BUGï¼Œæœªåˆ¤æ–­ä½œä¸šèŠ‚ç‚¹æ˜¯å¦ä¸ºå¥”æºƒã€‚<strong>æ‰€ä»¥åœ¨å½“å‰ç‰ˆæœ¬ï¼Œä½œä¸šå¤±æ•ˆè½¬ç§»é¢å‘çš„æ˜¯æ‰€æœ‰ä½œä¸šèŠ‚ç‚¹å…³é—­é€»è¾‘ï¼Œä¸ä»…é™äºä½œä¸šå´©æºƒå…³é—­ã€‚</strong></li>
<li><p>ä¼˜å…ˆè°ƒç”¨ <code>FailoverService#getFailoverItems(...)</code> æ–¹æ³•ï¼Œè·å¾—å…³é—­ä½œä¸šèŠ‚ç‚¹( <code>${JOB_INSTANCE_ID}</code> )å¯¹åº”çš„ <code>${JOB_NAME}/sharding/${ITEM_ID}/failover</code> ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p>
<p>è‹¥è¯¥ä½œä¸šåˆ†ç‰‡é¡¹ä¸ºç©ºï¼Œå†è°ƒç”¨ <code>ShardingService#getShardingItems(...)</code> æ–¹æ³•ï¼Œè·å¾—å…³é—­ä½œä¸šèŠ‚ç‚¹( <code>${JOB_INSTANCE_ID}</code> )å¯¹åº”çš„ <code>/${JOB_NAME}/sharding/${ITEM_ID}/instance</code> ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p>
<p>ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·çš„é¡ºåºå‘¢ï¼Ÿæ”¾åœ¨ <code>FailoverService#failoverIfNecessary()</code> ä¸€èµ·è®²ã€‚è¿™é‡Œå…ˆçœ‹ä¸‹ <code>FailoverService#getFailoverItems(...)</code> æ–¹æ³•çš„å®ç°ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getFailoverItems</span><span class="params">(<span class="keyword">final</span> String jobInstanceId)</span> </span>&#123;</div><div class="line">   List&lt;String&gt; items = jobNodeStorage.getJobNodeChildrenKeys(ShardingNode.ROOT);</div><div class="line">   List&lt;Integer&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(items.size());</div><div class="line">   <span class="keyword">for</span> (String each : items) &#123;</div><div class="line">       <span class="keyword">int</span> item = Integer.parseInt(each);</div><div class="line">       String node = FailoverNode.getExecutionFailoverNode(item); <span class="comment">// `$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/failover`</span></div><div class="line">       <span class="keyword">if</span> (jobNodeStorage.isJobNodeExisted(node) &amp;&amp; jobInstanceId.equals(jobNodeStorage.getJobNodeDataDirectly(node))) &#123;</div><div class="line">           result.add(item);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   Collections.sort(result);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>FailoverService#setCrashedFailoverFlag(...)</code> æ–¹æ³•ï¼Œè®¾ç½®å¤±æ•ˆçš„åˆ†ç‰‡é¡¹æ ‡è®° <code>/${JOB_NAME}/leader/failover/items/${ITEM_ID}</code>ã€‚è¯¥æ•°æ®èŠ‚ç‚¹ä¸º<strong>æ°¸ä¹…</strong>èŠ‚ç‚¹ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCrashedFailoverFlag</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> item)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!isFailoverAssigned(item)) &#123;</div><div class="line">       jobNodeStorage.createJobNodeIfNeeded(FailoverNode.getItemsNode(item)); <span class="comment">// /$&#123;JOB_NAME&#125;/leader/failover/items/$&#123;ITEM_ID&#125;</span></div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isFailoverAssigned</span><span class="params">(<span class="keyword">final</span> Integer item)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> jobNodeStorage.isJobNodeExisted(FailoverNode.getExecutionFailoverNode(item));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>FailoverService#failoverIfNecessary()</code> æ–¹æ³•ï¼Œå¦‚æœéœ€è¦å¤±æ•ˆè½¬ç§», åˆ™æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»ã€‚</p>
</li>
</ul>
<h1 id="3-ä½œä¸šå¤±æ•ˆè½¬ç§»"><a href="#3-ä½œä¸šå¤±æ•ˆè½¬ç§»" class="headerlink" title="3. ä½œä¸šå¤±æ•ˆè½¬ç§»"></a>3. ä½œä¸šå¤±æ•ˆè½¬ç§»</h1><p>è°ƒç”¨ <code>FailoverService#failoverIfNecessary()</code> æ–¹æ³•ï¼Œå¦‚æœéœ€è¦å¤±æ•ˆè½¬ç§», åˆ™æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failoverIfNecessary</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (needFailover()) &#123;</div><div class="line">       jobNodeStorage.executeInLeader(FailoverNode.LATCH, <span class="keyword">new</span> FailoverLeaderExecutionCallback());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>#needFailover()</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦æ»¡è¶³å¤±æ•ˆè½¬ç§»æ¡ä»¶ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">needFailover</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="comment">// `$&#123;JOB_NAME&#125;/leader/failover/items/$&#123;ITEM_ID&#125;` æœ‰å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">    <span class="keyword">return</span> jobNodeStorage.isJobNodeExisted(FailoverNode.ITEMS_ROOT) &amp;&amp; !jobNodeStorage.getJobNodeChildrenKeys(FailoverNode.ITEMS_ROOT).isEmpty()</div><div class="line">            <span class="comment">// å½“å‰ä½œä¸šä¸åœ¨è¿è¡Œä¸­</span></div><div class="line">            &amp;&amp; !JobRegistry.getInstance().isJobRunning(jobName);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ¡ä»¶ä¸€ï¼š<code>${JOB_NAME}/leader/failover/items/${ITEM_ID}</code> æœ‰å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</li>
<li><p>æ¡ä»¶äºŒï¼šå½“å‰ä½œä¸šä¸åœ¨è¿è¡Œä¸­ã€‚æ­¤æ¡ä»¶å³æ˜¯ä¸Šæ–‡æäº¤çš„ä½œä¸šèŠ‚ç‚¹<strong>ç©ºé—²</strong>çš„å®šä¹‰ã€‚</p>
<blockquote>
<p>å¤±æ•ˆè½¬ç§»ï¼š è¿è¡Œä¸­çš„ä½œä¸šæœåŠ¡å™¨å´©æºƒä¸ä¼šå¯¼è‡´é‡æ–°åˆ†ç‰‡ï¼Œåªä¼šåœ¨ä¸‹æ¬¡ä½œä¸šå¯åŠ¨æ—¶åˆ†ç‰‡ã€‚å¯ç”¨å¤±æ•ˆè½¬ç§»åŠŸèƒ½å¯ä»¥åœ¨æœ¬æ¬¡ä½œä¸šæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç›‘æµ‹å…¶ä»–ä½œä¸šæœåŠ¡å™¨ã€ç©ºé—²ã€‘ï¼ŒæŠ“å–æœªå®Œæˆçš„å­¤å„¿åˆ†ç‰‡é¡¹æ‰§è¡Œ</p>
</blockquote>
</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>JobNodeStorage#executeInLeader(...)</code> æ–¹æ³•ï¼Œä½¿ç”¨ <code>FailoverNode.LATCH</code>( <code>/${JOB_NAME}/leader/failover/latch</code> ) è·¯å¾„æ„æˆçš„<strong>åˆ†å¸ƒå¼é”</strong>ï¼Œä¿è¯ FailoverLeaderExecutionCallback çš„å›è°ƒæ–¹æ³•åŒä¸€æ—¶é—´ï¼Œå³ä½¿å¤šä¸ªä½œä¸šèŠ‚ç‚¹è°ƒç”¨ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªä½œä¸šèŠ‚ç‚¹è¿›è¡Œæ‰§è¡Œã€‚å¦å¤–ï¼Œè™½ç„¶ <code>JobNodeStorage#executeInLeader(...)</code> æ–¹æ³•ä¸Šå¸¦æœ‰ <code>Leader</code> å…³é”®å­—ï¼Œå®é™…éå¿…é¡»åœ¨ä¸»èŠ‚ç‚¹çš„æ“ä½œï¼Œä»»ä½•ä¸€ä¸ªæ‹¿åˆ°<strong>åˆ†å¸ƒå¼é”</strong>çš„ä½œä¸šèŠ‚ç‚¹éƒ½å¯ä»¥è°ƒç”¨ã€‚ç›®å‰å’Œ<strong>åˆ†å¸ƒå¼é”</strong>ç›¸å…³çš„é€»è¾‘ï¼Œåœ¨ Elastic-Job-Lite é‡Œï¼Œéƒ½ä¼šè°ƒç”¨ <code>JobNodeStorage#executeInLeader(...)</code> æ–¹æ³•ï¼Œæ•°æ®éƒ½å­˜å‚¨åœ¨ <code>/leader/</code> èŠ‚ç‚¹ç›®å½•ä¸‹ã€‚å…³äº<strong>åˆ†å¸ƒå¼é”</strong>ç›¸å…³çš„ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒã€‹ã€Œ3.1 åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œã€</a>æœ‰è¯¦ç»†åˆ†äº«ã€‚</p>
</li>
</ul>
<hr>
<p>FailoverLeaderExecutionCallback å›è°ƒé€»è¾‘å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FailoverLeaderExecutionCallback</span> <span class="keyword">implements</span> <span class="title">LeaderExecutionCallback</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">// åˆ¤æ–­éœ€è¦å¤±æ•ˆè½¬ç§»</span></div><div class="line">       <span class="keyword">if</span> (JobRegistry.getInstance().isShutdown(jobName) || !needFailover()) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// è·å¾—ä¸€ä¸ª `$&#123;JOB_NAME&#125;/leader/failover/items/$&#123;ITEM_ID&#125;` ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">       <span class="keyword">int</span> crashedItem = Integer.parseInt(jobNodeStorage.getJobNodeChildrenKeys(FailoverNode.ITEMS_ROOT).get(<span class="number">0</span>));</div><div class="line">       log.debug(<span class="string">"Failover job '&#123;&#125;' begin, crashed item '&#123;&#125;'"</span>, jobName, crashedItem);</div><div class="line">       <span class="comment">// è®¾ç½®è¿™ä¸ª `$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/failover` ä½œä¸šåˆ†ç‰‡é¡¹ ä¸º å½“å‰ä½œä¸šèŠ‚ç‚¹</span></div><div class="line">       jobNodeStorage.fillEphemeralJobNode(FailoverNode.getExecutionFailoverNode(crashedItem), JobRegistry.getInstance().getJobInstance(jobName).getJobInstanceId());</div><div class="line">       <span class="comment">// ç§»é™¤è¿™ä¸ª `$&#123;JOB_NAME&#125;/leader/failover/items/$&#123;ITEM_ID&#125;` ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">       jobNodeStorage.removeJobNodeIfExisted(FailoverNode.getItemsNode(crashedItem));</div><div class="line">       <span class="comment">// TODO ä¸åº”ä½¿ç”¨triggerJob, è€Œæ˜¯ä½¿ç”¨executorç»Ÿä¸€è°ƒåº¦ ç–‘é—®ï¼šä¸ºä»€ä¹ˆè¦ç”¨executorç»Ÿä¸€ï¼Œåé¢ç ”ç©¶ä¸‹</span></div><div class="line">       <span class="comment">// è§¦å‘ä½œä¸šæ‰§è¡Œ</span></div><div class="line">       JobScheduleController jobScheduleController = JobRegistry.getInstance().getJobScheduleController(jobName);</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> != jobScheduleController) &#123;</div><div class="line">           jobScheduleController.triggerJob();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å†æ¬¡è°ƒç”¨ <code>#needFailover()</code> æ–¹æ³•ï¼Œç¡®ä¿ç»è¿‡åˆ†å¸ƒå¼é”è·å–ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œä»ç„¶éœ€è¦å¤±æ•ˆè½¬ç§»ã€‚å› ä¸ºå¯èƒ½å¤šä¸ªä½œä¸šèŠ‚ç‚¹è°ƒç”¨äº†è¯¥å›è°ƒï¼Œç¬¬ä¸€ä¸ªä½œä¸šèŠ‚ç‚¹æ‰§è¡Œäº†å¤±æ•ˆè½¬ç§»ï¼Œå¯èƒ½ç¬¬äºŒä¸ªä½œä¸šèŠ‚ç‚¹å°±ä¸éœ€è¦æ‰§è¡Œå¤±æ•ˆè½¬ç§»äº†ã€‚</li>
<li><p>è°ƒç”¨ <code>JobNodeStorage#getJobNodeChildrenKeys(FailoverNode.ITEMS_ROOT)#get(0)</code> æ–¹æ³•ï¼Œè·å¾—<strong>ä¸€ä¸ª</strong> <code>${JOB_NAME}/leader/failover/items/${ITEM_ID}</code> ä½œä¸šåˆ†ç‰‡é¡¹ã€‚  </p>
<p>è°ƒç”¨ <code>JobNodeStorage#fillEphemeralJobNode(...)</code> æ–¹æ³•ï¼Œè®¾ç½®è¿™ä¸ª<strong>ä¸´æ—¶</strong>æ•°æ®èŠ‚ç‚¹ <code>${JOB_NAME}/sharding/${ITEM_ID}failover</code> ä½œä¸šåˆ†ç‰‡é¡¹ä¸ºå½“å‰ä½œä¸šèŠ‚ç‚¹( <code>${JOB_INSTANCE_ID}</code> )ã€‚  </p>
<p>è°ƒç”¨ <code>JobNodeStorage#removeJobNodeIfExisted(...)</code> æ–¹æ³•ï¼Œç§»é™¤è¿™ä¸ª<code>${JOB_NAME}/leader/failover/items/${ITEM_ID}</code> ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p>
</li>
<li><p>è°ƒç”¨ <code>JobScheduleController#triggerJob()</code> æ–¹æ³•ï¼Œç«‹å³å¯åŠ¨ä½œä¸šã€‚è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå®é™…ä½œä¸šä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œä»…ä»…æ˜¯è¿›è¡Œè§¦å‘ã€‚å¦‚æœæœ‰å¤šä¸ªå¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹ï¼Œå¤šæ¬¡è°ƒç”¨ <code>JobScheduleController#triggerJob()</code> æ–¹æ³•ä¼šä¸ä¼šå¯¼è‡´ä½œä¸šæ˜¯<strong>å¹¶è¡Œæ‰§è¡Œ</strong>çš„ï¼Ÿç­”æ¡ˆæ˜¯ä¸ä¼šï¼Œå› ä¸ºä¸€ä¸ªä½œä¸šçš„ Quartz çº¿ç¨‹æ•°è®¾ç½®ä¸º 1ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobScheduler.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> Properties <span class="title">getBaseQuartzProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">   Properties result = <span class="keyword">new</span> Properties();</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.threadCount"</span>, <span class="string">"1"</span>); <span class="comment">// Quartz çº¿ç¨‹æ•°ï¼š1</span></div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<p>å¦‚æœè¯´ä½œä¸šåˆ†ç‰‡é¡¹å®ç°è½¬ç§»æ—¶ï¼Œæ¯ä¸ªä½œä¸šèŠ‚ç‚¹éƒ½ä¸å¤„äºéç©ºé—²çŠ¶æ€ï¼Œå²‚ä¸æ˜¯ FailoverLeaderExecutionCallback ä¸€ç›´æ— æ³•è¢«å›è°ƒï¼Ÿç­”æ¡ˆå½“ç„¶ä¸æ˜¯çš„ã€‚ä½œä¸šåœ¨æ‰§è¡Œå®Œåˆ†é…ç»™è‡ªå·±çš„ä½œä¸šåˆ†ç‰‡é¡¹ï¼Œä¼šè°ƒç”¨ <code>LiteJobFacade#failoverIfNecessary()</code> æ–¹æ³•ï¼Œè¿›è¡Œå¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹æŠ“å–ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ...  çœç•¥æ— å…³ä»£ç </span></div><div class="line">   </div><div class="line">   <span class="comment">// æ‰§è¡Œ æ™®é€šè§¦å‘çš„ä½œä¸š</span></div><div class="line">   execute(shardingContexts, JobExecutionEvent.ExecutionSource.NORMAL_TRIGGER);</div><div class="line">   <span class="comment">// æ‰§è¡Œ è¢«è·³è¿‡è§¦å‘çš„ä½œä¸š</span></div><div class="line">   <span class="keyword">while</span> (jobFacade.isExecuteMisfired(shardingContexts.getShardingItemParameters().keySet())) &#123;</div><div class="line">       jobFacade.clearMisfire(shardingContexts.getShardingItemParameters().keySet());</div><div class="line">       execute(shardingContexts, JobExecutionEvent.ExecutionSource.MISFIRE);</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="comment">// æ‰§è¡Œ ä½œä¸šå¤±æ•ˆè½¬ç§»</span></div><div class="line">   jobFacade.failoverIfNecessary();</div><div class="line">   </div><div class="line">   <span class="comment">// ...  çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failoverIfNecessary</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (configService.load(<span class="keyword">true</span>).isFailover()) &#123;</div><div class="line">       failoverService.failoverIfNecessary();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failoverIfNecessary</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (needFailover()) &#123;</div><div class="line">       jobNodeStorage.executeInLeader(FailoverNode.LATCH, <span class="keyword">new</span> FailoverLeaderExecutionCallback());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è®©æˆ‘ä»¬åœ¨ç¿»å› JobCrashedJobListener å¤„ä»£ç ï¼Œä¸ºä»€ä¹ˆè·å–å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹æ˜¯è¿™æ ·çš„ä¼˜å…ˆé¡ºåºï¼Ÿä¸€ä¸ªä½œä¸šèŠ‚ç‚¹æ‹¥æœ‰ <code>${JOB_NAME}/sharding/${ITEM_ID}/failover</code> æ•°æ®åˆ†ç‰‡é¡¹ï¼Œæ„å‘³ç€åˆ†é…ç»™å®ƒçš„ä½œä¸šåˆ†ç‰‡é¡¹å·²ç»æ‰§è¡Œå®Œæˆï¼Œå¦åˆ™æ€ä¹ˆå›è°ƒ FailoverLeaderExecutionCallback æ–¹æ³•ï¼ŒæŠ“å–å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹å‘¢ï¼Ÿï¼</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_07/02.png" alt=""></p>
<p>æ—ç™½å›ï¼šåŒå‡»666ï¼Œå…³æ³¨ç¬”è€…å…¬ä¼—å·ä¸€æ³¢ã€‚</p>
<h1 id="4-è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ"><a href="#4-è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ" class="headerlink" title="4. è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ"></a>4. è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</h1><p>åœ¨<a href="http://www.yunai.me/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹ã€Œ4.2 è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡ã€</a>ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä½œä¸šæ‰§è¡Œå™¨( AbstractElasticJobExecutor ) æ‰§è¡Œä½œä¸šæ—¶ï¼Œä¼šè·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡è¿›è¡Œæ‰§è¡Œã€‚è·å–è¿‡ç¨‹æ€»ä½“å¦‚ä¸‹é¡ºåºå›¾( <a href="http://www.yunai.me/images/Elastic-Job/2017_11_07/03.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_07/03.png" alt=""></p>
<ul>
<li>çº¢è‰²å‰å‰åœ¨<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a>æœ‰è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ShardingContexts <span class="title">getShardingContexts</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å¾— å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">   <span class="keyword">boolean</span> isFailover = configService.load(<span class="keyword">true</span>).isFailover();</div><div class="line">   <span class="keyword">if</span> (isFailover) &#123;</div><div class="line">       List&lt;Integer&gt; failoverShardingItems = failoverService.getLocalFailoverItems();</div><div class="line">       <span class="keyword">if</span> (!failoverShardingItems.isEmpty()) &#123;</div><div class="line">           <span class="comment">// ã€å¿½ç•¥ï¼Œä½œä¸šåˆ†ç‰‡è¯¦è§£ã€‘è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨åˆ†ç‰‡ä¸Šä¸‹æ–‡</span></div><div class="line">           <span class="keyword">return</span> executionContextService.getJobShardingContext(failoverShardingItems);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ã€å¿½ç•¥ï¼Œä½œä¸šåˆ†ç‰‡è¯¦è§£ã€‘ä½œä¸šåˆ†ç‰‡ï¼Œå¦‚æœéœ€è¦åˆ†ç‰‡ä¸”å½“å‰èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹</span></div><div class="line">   shardingService.shardingIfNecessary();</div><div class="line">   <span class="comment">// ã€å¿½ç•¥ï¼Œä½œä¸šåˆ†ç‰‡è¯¦è§£ã€‘è·å¾— åˆ†é…åœ¨æœ¬æœºçš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">   List&lt;Integer&gt; shardingItems = shardingService.getLocalShardingItems();</div><div class="line">   <span class="comment">// ç§»é™¤ åˆ†é…åœ¨æœ¬æœºçš„å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹ç›®</span></div><div class="line">   <span class="keyword">if</span> (isFailover) &#123;</div><div class="line">       shardingItems.removeAll(failoverService.getLocalTakeOffItems());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç§»é™¤ è¢«ç¦ç”¨çš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">   shardingItems.removeAll(executionService.getDisabledItems(shardingItems));</div><div class="line">   <span class="comment">// ã€å¿½ç•¥ï¼Œä½œä¸šåˆ†ç‰‡è¯¦è§£ã€‘è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨åˆ†ç‰‡ä¸Šä¸‹æ–‡</span></div><div class="line">   <span class="keyword">return</span> executionContextService.getJobShardingContext(shardingItems);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>FailoverService#getLocalFailoverItems()</code> æ–¹æ³•ï¼Œè·å–è¿è¡Œåœ¨æœ¬ä½œä¸šèŠ‚ç‚¹çš„å¤±æ•ˆè½¬ç§»åˆ†ç‰‡é¡¹é›†åˆã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getLocalFailoverItems</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (JobRegistry.getInstance().isShutdown(jobName)) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> getFailoverItems(JobRegistry.getInstance().getJobInstance(jobName).getJobInstanceId()); <span class="comment">// `$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/failover`</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>ExecutionContextService#getJobShardingContext()</code> æ–¹æ³•ï¼Œè·å–å½“å‰ä½œä¸šæœåŠ¡å™¨åˆ†ç‰‡ä¸Šä¸‹æ–‡ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹ã€Œ4. è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆã€</a>æœ‰è¯¦ç»†è§£æã€‚</p>
</li>
<li><p>å½“æœ¬ä½œä¸šèŠ‚ç‚¹ä¸å­˜åœ¨æŠ“å–çš„å¤±æ•ˆè½¬ç§»åˆ†ç‰‡é¡¹ï¼Œåˆ™è·å¾—åˆ†é…ç»™æœ¬ä½œä¸šåˆ†è§£çš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚æ­¤æ—¶ä½ ä¼šçœ‹åˆ°ç•¥å¥‡æ€ªçš„æ–¹æ³•è°ƒç”¨ï¼Œ<code>shardingItems.removeAll(failoverService.getLocalTakeOffItems())</code>ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼Œä½œä¸šèŠ‚ç‚¹AæŒæœ‰ä½œä¸šåˆ†ç‰‡é¡¹[0, 1]ï¼Œæ­¤æ—¶å¼‚å¸¸æ–­ç½‘ï¼Œå¯¼è‡´[0, 1]è¢«ä½œä¸šèŠ‚ç‚¹Bå¤±æ•ˆè½¬ç§»æŠ“å–ï¼Œæ­¤æ—¶è‹¥ä½œä¸šèŠ‚ç‚¹Aæ¢å¤ï¼Œä½œä¸šåˆ†ç‰‡é¡¹[0, 1]ä¾ç„¶å±äºä½œä¸šèŠ‚ç‚¹Aï¼Œä½†æ˜¯å¯èƒ½å·²ç»åœ¨ä½œä¸šèŠ‚ç‚¹Bæ‰§è¡Œï¼Œå› æ­¤éœ€è¦è¿›è¡Œç§»é™¤ï¼Œé¿å…å¤šèŠ‚ç‚¹è¿è¡Œç›¸åŒçš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚<code>FailoverService#getLocalTakeOffItems()</code> æ–¹æ³•å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–è¿è¡Œåœ¨æœ¬ä½œä¸šæœåŠ¡å™¨çš„è¢«å¤±æ•ˆè½¬ç§»çš„åºåˆ—å·.</div><div class="line">* </div><div class="line">* <span class="doctag">@return</span> è¿è¡Œåœ¨æœ¬ä½œä¸šæœåŠ¡å™¨çš„è¢«å¤±æ•ˆè½¬ç§»çš„åºåˆ—å·</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getLocalTakeOffItems</span><span class="params">()</span> </span>&#123;</div><div class="line">   List&lt;Integer&gt; shardingItems = shardingService.getLocalShardingItems();</div><div class="line">   List&lt;Integer&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(shardingItems.size());</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingItems) &#123;</div><div class="line">       <span class="keyword">if</span> (jobNodeStorage.isJobNodeExisted(FailoverNode.getExecutionFailoverNode(each))) &#123;</div><div class="line">           result.add(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="5-ç›‘å¬ä½œä¸šå¤±æ•ˆè½¬ç§»åŠŸèƒ½å…³é—­"><a href="#5-ç›‘å¬ä½œä¸šå¤±æ•ˆè½¬ç§»åŠŸèƒ½å…³é—­" class="headerlink" title="5. ç›‘å¬ä½œä¸šå¤±æ•ˆè½¬ç§»åŠŸèƒ½å…³é—­"></a>5. ç›‘å¬ä½œä¸šå¤±æ•ˆè½¬ç§»åŠŸèƒ½å…³é—­</h1><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FailoverSettingsChangedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">        </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (configNode.isConfigPath(path) &amp;&amp; Type.NODE_UPDATED == eventType</div><div class="line">               &amp;&amp; !LiteJobConfigurationGsonFactory.fromJson(data).isFailover()) &#123; <span class="comment">// å…³é—­å¤±æ•ˆè½¬ç§»åŠŸèƒ½</span></div><div class="line">           failoverService.removeFailoverInfo();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šå•Šå•Šå•Šï¼Œæœ‰ç‚¹ç»•ã€‚<br>èŠ‹é“å›ï¼šè€å¿ƒï¼Œè€å¿ƒï¼Œè€å¿ƒã€‚</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_07/04.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘&lt;/strong&gt;æœ‰ç¦
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.yunai.me/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆ†ç‰‡</title>
    <link href="http://www.yunai.me/Elastic-Job/job-sharding/"/>
    <id>http://www.yunai.me/Elastic-Job/job-sharding/</id>
    <published>2017-10-30T16:00:00.000Z</published>
    <updated>2017-09-02T09:56:12.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ä½œä¸šåˆ†ç‰‡æ¡ä»¶</a></li>
<li><a href="#">3. åˆ†é…ä½œä¸šåˆ†ç‰‡é¡¹</a></li>
<li><a href="#">4. è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šåˆ†ç‰‡</strong>ã€‚</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_10_31/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_31/01.png" alt=""></p>
<ul>
<li>ç²‰è‰²çš„ç±»åœ¨ <code>com.dangdang.ddframe.job.lite.internal.sharding</code> åŒ…ä¸‹ï¼Œå®ç°äº† Elastic-Job-Lite ä½œä¸šåˆ†ç‰‡ã€‚</li>
<li>ShardingServiceï¼Œä½œä¸šåˆ†ç‰‡æœåŠ¡ã€‚</li>
<li>ShardingNodeï¼Œä½œä¸šåˆ†ç‰‡æ•°æ®å­˜å‚¨è·¯å¾„ã€‚</li>
<li>ShardingListenerManagerï¼Œä½œä¸šåˆ†ç‰‡ç›‘å¬ç®¡ç†å™¨ã€‚</li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-ä½œä¸šåˆ†ç‰‡æ¡ä»¶"><a href="#2-ä½œä¸šåˆ†ç‰‡æ¡ä»¶" class="headerlink" title="2. ä½œä¸šåˆ†ç‰‡æ¡ä»¶"></a>2. ä½œä¸šåˆ†ç‰‡æ¡ä»¶</h1><p>å½“ä½œä¸šæ»¡è¶³åˆ†ç‰‡æ¡ä»¶æ—¶ï¼Œä¸ä¼š<strong>ç«‹å³</strong>è¿›è¡Œä½œä¸šåˆ†ç‰‡åˆ†é…ï¼Œè€Œæ˜¯è®¾ç½®éœ€è¦é‡æ–°è¿›è¡Œåˆ†ç‰‡çš„<strong>æ ‡è®°</strong>ï¼Œç­‰åˆ°ä½œä¸šåˆ†ç‰‡è·å–æ—¶ï¼Œåˆ¤æ–­æœ‰è¯¥æ ‡è®°å<strong>æ‰§è¡Œ</strong>ä½œä¸šåˆ†é…ã€‚</p>
<p>è®¾ç½®éœ€è¦é‡æ–°è¿›è¡Œåˆ†ç‰‡çš„<strong>æ ‡è®°</strong>çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¾ç½®éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReshardingFlag</span><span class="params">()</span> </span>&#123;</div><div class="line">   jobNodeStorage.createJobNodeIfNeeded(ShardingNode.NECESSARY);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobNodeStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å¦‚æœå­˜åœ¨åˆ™åˆ›å»ºä½œä¸šèŠ‚ç‚¹.</div><div class="line">* å¦‚æœä½œä¸šæ ¹èŠ‚ç‚¹ä¸å­˜åœ¨è¡¨ç¤ºä½œä¸šå·²ç»åœæ­¢, ä¸å†ç»§ç»­åˆ›å»ºèŠ‚ç‚¹.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> node ä½œä¸šèŠ‚ç‚¹åç§°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createJobNodeIfNeeded</span><span class="params">(<span class="keyword">final</span> String node)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (isJobRootNodeExisted() &amp;&amp; !isJobNodeExisted(node)) &#123;</div><div class="line">       regCenter.persist(jobNodePath.getFullPath(node), <span class="string">""</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>#setReshardingFlag()</code> æ–¹æ³•è®¾ç½®<strong>éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°</strong> <code>/${JOB_NAME}/leader/sharding/necessary</code>ã€‚è¯¥ Zookeeper æ•°æ®èŠ‚ç‚¹æ˜¯<strong>æ°¸ä¹…</strong>èŠ‚ç‚¹ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ï¼Œä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 2] ls /elastic-job-example-lite-java/javaSimpleJob/leader/sharding</div><div class="line">[necessary]</div><div class="line">[zk: localhost:2181(CONNECTED) 3] get /elastic-job-example-lite-java/javaSimpleJob/leader/sharding/necessary</div></pre></td></tr></table></figure>
</li>
<li><p>è®¾ç½®æ ‡è®°ä¹‹åï¼Œé€šè¿‡è°ƒç”¨ <code>#isNeedSharding()</code> æ–¹æ³•å³å¯åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°åˆ†ç‰‡ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ¤æ–­æ˜¯å¦éœ€è¦é‡åˆ†ç‰‡.</div><div class="line">* </div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦éœ€è¦é‡åˆ†ç‰‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isNeedSharding</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> jobNodeStorage.isJobNodeExisted(ShardingNode.NECESSARY);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobNodeStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ¤æ–­ä½œä¸šèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> node ä½œä¸šèŠ‚ç‚¹åç§°</div><div class="line">* <span class="doctag">@return</span> ä½œä¸šèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isJobNodeExisted</span><span class="params">(<span class="keyword">final</span> String node)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> regCenter.isExisted(jobNodePath.getFullPath(node));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>è®¾ç½®éœ€è¦é‡æ–°è¿›è¡Œåˆ†ç‰‡æœ‰ 4 ç§æƒ…å†µ</strong></p>
<p><strong>ç¬¬ä¸€ç§</strong>ï¼Œæ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯æ—¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerFacade.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStartUpInfo</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> enabled)</span> </span>&#123;</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">   <span class="comment">// è®¾ç½® éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°</span></div><div class="line">   shardingService.setReshardingFlag();</div><div class="line">  <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>ç¬¬äºŒç§</strong>ï¼Œä½œä¸šåˆ†ç‰‡æ€»æ•°( <code>JobCoreConfiguration.shardingTotalCount</code> )å˜åŒ–æ—¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingTotalCountChangedJobListener.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShardingTotalCountChangedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (configNode.isConfigPath(path)</div><div class="line">               &amp;&amp; <span class="number">0</span> != JobRegistry.getInstance().getCurrentShardingTotalCount(jobName)) &#123;</div><div class="line">           <span class="keyword">int</span> newShardingTotalCount = LiteJobConfigurationGsonFactory.fromJson(data).getTypeConfig().getCoreConfig().getShardingTotalCount();</div><div class="line">           <span class="keyword">if</span> (newShardingTotalCount != JobRegistry.getInstance().getCurrentShardingTotalCount(jobName)) &#123; <span class="comment">// ä½œä¸šåˆ†ç‰‡æ€»æ•°å˜åŒ–</span></div><div class="line">               <span class="comment">// è®¾ç½®éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°</span></div><div class="line">               shardingService.setReshardingFlag();</div><div class="line">               <span class="comment">// è®¾ç½®å½“å‰åˆ†ç‰‡æ€»æ•°</span></div><div class="line">               JobRegistry.getInstance().setCurrentShardingTotalCount(jobName, newShardingTotalCount);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>ç¬¬ä¸‰ç§</strong>ï¼ŒæœåŠ¡å™¨å˜åŒ–æ—¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingListenerManager.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListenServersChangedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (!JobRegistry.getInstance().isShutdown(jobName)</div><div class="line">               &amp;&amp; (isInstanceChange(eventType, path)</div><div class="line">                   || isServerChange(path))) &#123;</div><div class="line">           shardingService.setReshardingFlag();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isInstanceChange</span><span class="params">(<span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String path)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> instanceNode.isInstancePath(path) &amp;&amp; Type.NODE_UPDATED != eventType;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isServerChange</span><span class="params">(<span class="keyword">final</span> String path)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> serverNode.isServerPath(path);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æœåŠ¡å™¨å˜åŒ–æœ‰<strong>ä¸¤ç§</strong>æƒ…å†µã€‚</li>
<li>ç¬¬ä¸€ç§ï¼Œ<code>#isServerChange(...)</code> æœåŠ¡å™¨è¢«å¼€å¯æˆ–ç¦ç”¨ã€‚</li>
<li>ç¬¬äºŒç§ï¼Œ<code>#isInstanceChange(...)</code> ä½œä¸šèŠ‚ç‚¹æ–°å¢æˆ–è€…ç§»é™¤ã€‚</li>
</ul>
<p><strong>ç¬¬å››ç§</strong>ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/reconcile/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” è‡ªè¯Šæ–­ä¿®å¤ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
<h1 id="3-åˆ†é…ä½œä¸šåˆ†ç‰‡é¡¹"><a href="#3-åˆ†é…ä½œä¸šåˆ†ç‰‡é¡¹" class="headerlink" title="3. åˆ†é…ä½œä¸šåˆ†ç‰‡é¡¹"></a>3. åˆ†é…ä½œä¸šåˆ†ç‰‡é¡¹</h1><p>è°ƒç”¨ <code>ShardingService#shardingIfNecessary()</code> æ–¹æ³•ï¼Œå¦‚æœéœ€è¦åˆ†ç‰‡ä¸”å½“å‰èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹, åˆ™ä½œä¸šåˆ†ç‰‡ã€‚</p>
<p>æ€»ä½“æµç¨‹å¦‚ä¸‹<strong>é¡ºåºå›¾</strong>ï¼š( <a href="http://www.yunai.me/images/Elastic-Job/2017_10_31/02.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_31/02.png" alt=""></p>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å¦‚æœéœ€è¦åˆ†ç‰‡ä¸”å½“å‰èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹, åˆ™ä½œä¸šåˆ†ç‰‡.</div><div class="line">* </div><div class="line">* å¦‚æœå½“å‰æ— å¯ç”¨èŠ‚ç‚¹åˆ™ä¸åˆ†ç‰‡.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shardingIfNecessary</span><span class="params">()</span> </span>&#123;</div><div class="line">   List&lt;JobInstance&gt; availableJobInstances = instanceService.getAvailableJobInstances();</div><div class="line">   <span class="keyword">if</span> (!isNeedSharding() <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°åˆ†ç‰‡</span></div><div class="line">           || availableJobInstances.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ã€éä¸»èŠ‚ç‚¹ã€‘ç­‰å¾… ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…å®Œæˆ</span></div><div class="line">   <span class="keyword">if</span> (!leaderService.isLeaderUntilBlock()) &#123; <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºã€ä¸»èŠ‚ç‚¹ã€‘</span></div><div class="line">       blockUntilShardingCompleted();</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ã€ä¸»èŠ‚ç‚¹ã€‘ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…</span></div><div class="line">   <span class="comment">// ç­‰å¾… ä½œä¸šæœªåœ¨è¿è¡Œä¸­çŠ¶æ€</span></div><div class="line">   waitingOtherJobCompleted();</div><div class="line">   <span class="comment">//</span></div><div class="line">   LiteJobConfiguration liteJobConfig = configService.load(<span class="keyword">false</span>);</div><div class="line">   <span class="keyword">int</span> shardingTotalCount = liteJobConfig.getTypeConfig().getCoreConfig().getShardingTotalCount();</div><div class="line">   <span class="comment">// è®¾ç½® ä½œä¸šæ­£åœ¨é‡åˆ†ç‰‡çš„æ ‡è®°</span></div><div class="line">   log.debug(<span class="string">"Job '&#123;&#125;' sharding begin."</span>, jobName);</div><div class="line">   jobNodeStorage.fillEphemeralJobNode(ShardingNode.PROCESSING, <span class="string">""</span>);</div><div class="line">   <span class="comment">// é‡ç½® ä½œä¸šåˆ†ç‰‡é¡¹ä¿¡æ¯</span></div><div class="line">   resetShardingInfo(shardingTotalCount);</div><div class="line">   <span class="comment">// ã€äº‹åŠ¡ä¸­ã€‘è®¾ç½® ä½œä¸šåˆ†ç‰‡é¡¹ä¿¡æ¯</span></div><div class="line">   JobShardingStrategy jobShardingStrategy = JobShardingStrategyFactory.getStrategy(liteJobConfig.getJobShardingStrategyClass());</div><div class="line">   jobNodeStorage.executeInTransaction(<span class="keyword">new</span> PersistShardingInfoTransactionExecutionCallback(jobShardingStrategy.sharding(availableJobInstances, jobName, shardingTotalCount)));</div><div class="line">   log.debug(<span class="string">"Job '&#123;&#125;' sharding complete."</span>, jobName);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>#isNeedSharding()</code> æ–¹æ³•åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°åˆ†ç‰‡ã€‚</li>
<li>è°ƒç”¨ <code>LeaderService#isLeaderUntilBlock()</code> æ–¹æ³•åˆ¤æ–­æ˜¯å¦ä¸º<strong>ä¸»èŠ‚ç‚¹</strong>ã€‚ä½œä¸šåˆ†ç‰‡é¡¹çš„åˆ†é…è¿‡ç¨‹ï¼š<ul>
<li>ã€ä¸»èŠ‚ç‚¹ã€‘<strong>æ‰§è¡Œ</strong>ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…ã€‚</li>
<li>ã€éä¸»èŠ‚ç‚¹ã€‘<strong>ç­‰å¾…</strong>ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…å®Œæˆã€‚</li>
<li><code>LeaderService#isLeaderUntilBlock()</code> æ–¹æ³•åœ¨<a href="http://www.yunai.me/Elastic-Job/election/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‹ã€Œ3. é€‰ä¸¾ä¸»èŠ‚ç‚¹ã€</a>æœ‰è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>#blockUntilShardingCompleted()</code> æ–¹æ³•ã€éä¸»èŠ‚ç‚¹ã€‘<strong>ç­‰å¾…</strong>ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…å®Œæˆã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">blockUntilShardingCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">while</span> (!leaderService.isLeaderUntilBlock() <span class="comment">// å½“å‰ä½œä¸šèŠ‚ç‚¹ä¸ä¸ºã€ä¸»èŠ‚ç‚¹ã€‘</span></div><div class="line">           &amp;&amp; (jobNodeStorage.isJobNodeExisted(ShardingNode.NECESSARY) <span class="comment">// å­˜åœ¨ä½œä¸šéœ€è¦é‡åˆ†ç‰‡çš„æ ‡è®°</span></div><div class="line">               || jobNodeStorage.isJobNodeExisted(ShardingNode.PROCESSING))) &#123; <span class="comment">// å­˜åœ¨ä½œä¸šæ­£åœ¨é‡åˆ†ç‰‡çš„æ ‡è®°</span></div><div class="line">       log.debug(<span class="string">"Job '&#123;&#125;' sleep short time until sharding completed."</span>, jobName);</div><div class="line">       BlockUtils.waitingShortTime();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>#LeaderService#isLeaderUntilBlock()</code> æ–¹æ³•åˆ¤æ–­æ˜¯å¦ä¸º<strong>ä¸»èŠ‚ç‚¹</strong>ã€‚ä¸ºä»€ä¹ˆä¸Šé¢åˆ¤æ–­äº†ä¸€æ¬¡ï¼Œè¿™é‡Œåˆåˆ¤æ–­ä¸€æ¬¡ï¼Ÿä¸»èŠ‚ç‚¹ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…è¿‡ç¨‹ä¸­ï¼Œä¸æ’é™¤è‡ªå·±æŒ‚æ‰äº†ï¼Œæ­¤æ—¶ã€éä¸»èŠ‚ç‚¹ã€‘è‹¥é€‰ä¸¾æˆä¸»èŠ‚ç‚¹ï¼Œæ— éœ€ç»§ç»­ç­‰å¾…ï¼Œå½“ç„¶ä¹Ÿä¸èƒ½ç­‰å¾…ï¼Œå› ä¸ºå·²ç»æ²¡èŠ‚ç‚¹åœ¨æ‰§è¡Œä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šå¡åœ¨è¿™é‡Œã€‚</li>
<li>å½“ <strong>ä½œä¸šéœ€è¦é‡åˆ†ç‰‡çš„æ ‡è®°</strong>ã€<strong>ä½œä¸šæ­£åœ¨é‡åˆ†ç‰‡çš„æ ‡è®°</strong> éƒ½ä¸å­˜åœ¨æ—¶ï¼Œæ„å‘³ç€ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…å·²ç»å®Œæˆï¼Œä¸‹æ–‡ PersistShardingInfoTransactionExecutionCallback ç±»é‡Œæˆ‘ä»¬ä¼šçœ‹åˆ°ã€‚</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>#waitingOtherJobCompleted()</code> æ–¹æ³•ç­‰å¾…ä½œä¸šæœªåœ¨è¿è¡Œä¸­çŠ¶æ€ã€‚ä½œä¸šæ˜¯å¦åœ¨è¿è¡Œä¸­éœ€è¦ <code>LiteJobConfiguration.monitorExecution = true</code>ï¼Œ<a href="http://www.yunai.me/Elastic-Job/election/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹ã€Œ4.6 æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸šã€</a>æœ‰è¯¦ç»†åˆ†äº«ã€‚</p>
</li>
<li>è°ƒç”¨ <code>ConfigurationService#load(...)</code> æ–¹æ³•ä»æ³¨å†Œä¸­å¿ƒè·å–ä½œä¸šé…ç½®( <strong>éç¼“å­˜</strong> )ï¼Œé¿å…ä¸»èŠ‚ç‚¹æœ¬åœ°ä½œä¸šé…ç½®å¯èƒ½éæœ€æ–°çš„ï¼Œä¸»è¦ç›®çš„æ˜¯è·å¾—ä½œä¸šåˆ†ç‰‡æ€»æ•°( <code>shardingTotalCount</code> )ã€‚</li>
<li>è°ƒç”¨ <code>jobNodeStorage.fillEphemeralJobNode(ShardingNode.PROCESSING, &quot;&quot;)</code> è®¾ç½®<strong>ä½œä¸šæ­£åœ¨é‡åˆ†ç‰‡çš„æ ‡è®°</strong> <code>/${JOB_NAME}/leader/sharding/processing</code>ã€‚è¯¥ Zookeeper æ•°æ®èŠ‚ç‚¹æ˜¯<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ï¼Œä»…ç”¨äºæ ‡è®°ä½œä¸šæ­£åœ¨é‡åˆ†ç‰‡ï¼Œæ— ç‰¹åˆ«ä¸šåŠ¡é€»è¾‘ã€‚</li>
<li><p>è°ƒç”¨ <code>#resetShardingInfo(...)</code> æ–¹æ³•<strong>é‡ç½®</strong>ä½œä¸šåˆ†ç‰‡ä¿¡æ¯ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resetShardingInfo</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount)</span> </span>&#123;</div><div class="line">  <span class="comment">// é‡ç½® æœ‰æ•ˆçš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shardingTotalCount; i++) &#123;</div><div class="line">      jobNodeStorage.removeJobNodeIfExisted(ShardingNode.getInstanceNode(i)); <span class="comment">// ç§»é™¤ `/$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/instance`</span></div><div class="line">      jobNodeStorage.createJobNodeIfNeeded(ShardingNode.ROOT + <span class="string">"/"</span> + i); <span class="comment">// åˆ›å»º `/$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;`</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">// ç§»é™¤ å¤šä½™çš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">  <span class="keyword">int</span> actualShardingTotalCount = jobNodeStorage.getJobNodeChildrenKeys(ShardingNode.ROOT).size();</div><div class="line">  <span class="keyword">if</span> (actualShardingTotalCount &gt; shardingTotalCount) &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = shardingTotalCount; i &lt; actualShardingTotalCount; i++) &#123;</div><div class="line">          jobNodeStorage.removeJobNodeIfExisted(ShardingNode.ROOT + <span class="string">"/"</span> + i); <span class="comment">// ç§»é™¤ `/$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;`</span></div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>JobShardingStrategy#sharding(...)</code> æ–¹æ³•<strong>è®¡ç®—</strong>æ¯ä¸ªèŠ‚ç‚¹åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚<a href="http://www.yunai.me/Elastic-Job/job-sharding-strategy/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆ†ç‰‡ç­–ç•¥ã€‹</a>æœ‰è¯¦ç»†åˆ†äº«ã€‚</p>
</li>
<li><p>è°ƒç”¨ <code>JobNodeStorage#executeInTransaction(...)</code> + <code>PersistShardingInfoTransactionExecutionCallback#execute()</code> æ–¹æ³•å®ç°åœ¨<strong>äº‹åŠ¡</strong>ä¸­<strong>è®¾ç½®</strong>æ¯ä¸ªèŠ‚ç‚¹åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PersistShardingInfoTransactionExecutionCallback.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersistShardingInfoTransactionExecutionCallback</span> <span class="keyword">implements</span> <span class="title">TransactionExecutionCallback</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…ç»“æœ</div><div class="line">    * keyï¼šä½œä¸šèŠ‚ç‚¹</div><div class="line">    * valueï¼šä½œä¸šåˆ†ç‰‡é¡¹</div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;JobInstance, List&lt;Integer&gt;&gt; shardingResults;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> CuratorTransactionFinal curatorTransactionFinal)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       <span class="comment">// è®¾ç½® æ¯ä¸ªèŠ‚ç‚¹åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">       <span class="keyword">for</span> (Map.Entry&lt;JobInstance, List&lt;Integer&gt;&gt; entry : shardingResults.entrySet()) &#123;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> shardingItem : entry.getValue()) &#123;</div><div class="line">               curatorTransactionFinal.create().forPath(jobNodePath.getFullPath(ShardingNode.getInstanceNode(shardingItem))</div><div class="line">                       , entry.getKey().getJobInstanceId().getBytes()).and();</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// ç§»é™¤ ä½œä¸šéœ€è¦é‡åˆ†ç‰‡çš„æ ‡è®°ã€ä½œä¸šæ­£åœ¨é‡åˆ†ç‰‡çš„æ ‡è®°</span></div><div class="line">       curatorTransactionFinal.delete().forPath(jobNodePath.getFullPath(ShardingNode.NECESSARY)).and();</div><div class="line">       curatorTransactionFinal.delete().forPath(jobNodePath.getFullPath(ShardingNode.PROCESSING)).and();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobNodeStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> callback æ‰§è¡Œæ“ä½œçš„å›è°ƒ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeInTransaction</span><span class="params">(<span class="keyword">final</span> TransactionExecutionCallback callback)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       CuratorTransactionFinal curatorTransactionFinal = getClient().inTransaction().check().forPath(<span class="string">"/"</span>).and();</div><div class="line">       callback.execute(curatorTransactionFinal);</div><div class="line">       curatorTransactionFinal.commit();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è®¾ç½®<strong>ä¸´æ—¶</strong>æ•°æ®èŠ‚ç‚¹ <code>/${JOB_NAME}/sharding/${ITEM_ID}/instance</code> ä¸ºåˆ†é…çš„ä½œä¸šèŠ‚ç‚¹çš„ä½œä¸šå®ä¾‹ä¸»é”®( <code>jobInstanceId</code> )ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 0] get /elastic-job-example-lite-java/javaSimpleJob/sharding/0/instance</div><div class="line">192.168.3.2@-@31492</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p><strong>ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…æ•´ä½“æµç¨‹æœ‰ç‚¹é•¿ï¼Œè€ç€å¿ƒçœ‹ï¼Œæ¯•ç«Ÿæ˜¯æ ¸å¿ƒä»£ç å“Ÿã€‚å¦‚æœä¸­é—´æœ‰ä»»ä½•ç–‘é—®ï¼Œæ¬¢è¿ç»™æˆ‘å…¬ä¼—å·ï¼š<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">èŠ‹é“æºç </a> ç•™è¨€ã€‚</strong></p>
<h1 id="4-è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ"><a href="#4-è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ" class="headerlink" title="4. è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ"></a>4. è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</h1><p>åœ¨<a href="http://www.yunai.me/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œçš„ã€‹ã€Œ4.2 è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡ã€</a>ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä½œä¸šæ‰§è¡Œå™¨( AbstractElasticJobExecutor ) æ‰§è¡Œä½œä¸šæ—¶ï¼Œä¼šè·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡è¿›è¡Œæ‰§è¡Œã€‚è·å–è¿‡ç¨‹æ€»ä½“å¦‚ä¸‹é¡ºåºå›¾( <a href="http://www.yunai.me/images/Elastic-Job/2017_10_31/03.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_31/03.png" alt=""></p>
<ul>
<li>æ©˜è‰²å‰å‰åœ¨<a href="http://www.yunai.me/Elastic-Job/job-failover/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>æœ‰è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ShardingContexts <span class="title">getShardingContexts</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ã€å¿½ç•¥ï¼Œä½œä¸šå¤±æ•ˆè½¬ç§»è¯¦è§£ã€‘è·å¾— å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">   <span class="keyword">boolean</span> isFailover = configService.load(<span class="keyword">true</span>).isFailover();</div><div class="line">   <span class="keyword">if</span> (isFailover) &#123;</div><div class="line">       List&lt;Integer&gt; failoverShardingItems = failoverService.getLocalFailoverItems();</div><div class="line">       <span class="keyword">if</span> (!failoverShardingItems.isEmpty()) &#123;</div><div class="line">           <span class="keyword">return</span> executionContextService.getJobShardingContext(failoverShardingItems);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ä½œä¸šåˆ†ç‰‡ï¼Œå¦‚æœéœ€è¦åˆ†ç‰‡ä¸”å½“å‰èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹</span></div><div class="line">   shardingService.shardingIfNecessary();</div><div class="line">   <span class="comment">// è·å¾— åˆ†é…åœ¨æœ¬æœºçš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">   List&lt;Integer&gt; shardingItems = shardingService.getLocalShardingItems();</div><div class="line">   <span class="comment">// ã€å¿½ç•¥ï¼Œä½œä¸šå¤±æ•ˆè½¬ç§»è¯¦è§£ã€‘ç§»é™¤ åˆ†é…åœ¨æœ¬æœºçš„å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹ç›®</span></div><div class="line">   <span class="keyword">if</span> (isFailover) &#123;</div><div class="line">       shardingItems.removeAll(failoverService.getLocalTakeOffItems());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç§»é™¤ è¢«ç¦ç”¨çš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">   shardingItems.removeAll(executionService.getDisabledItems(shardingItems));</div><div class="line">   <span class="comment">// è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨åˆ†ç‰‡ä¸Šä¸‹æ–‡</span></div><div class="line">   <span class="keyword">return</span> executionContextService.getJobShardingContext(shardingItems);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>ShardingService#shardingIfNecessary()</code> æ–¹æ³•ï¼Œå¦‚æœéœ€è¦åˆ†ç‰‡ä¸”å½“å‰èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹ï¼Œä½œä¸šåˆ†ç‰‡é¡¹<strong>åˆ†é…</strong>ã€‚<strong>ä¸æ˜¯æ¯æ¬¡éƒ½éœ€è¦ä½œä¸šåˆ†ç‰‡ï¼Œå¿…é¡»æ»¡è¶³ã€Œ2. ä½œä¸šåˆ†ç‰‡æ¡ä»¶ã€æ‰æ‰§è¡Œä½œä¸šåˆ†ç‰‡</strong>ã€‚</li>
<li><p>è°ƒç”¨ <code>ShardingService#getLocalShardingItems()</code>æ–¹æ³•ï¼Œè·å¾—åˆ†é…åœ¨<strong>æœ¬æœº</strong>çš„ä½œä¸šåˆ†ç‰‡é¡¹ï¼Œå³ <code>/${JOB_NAME}/sharding/${ITEM_ID}/instance</code> ä¸ºæœ¬æœºçš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–è¿è¡Œåœ¨æœ¬ä½œä¸šå®ä¾‹çš„åˆ†ç‰‡é¡¹é›†åˆ.</div><div class="line">* </div><div class="line">* <span class="doctag">@return</span> è¿è¡Œåœ¨æœ¬ä½œä¸šå®ä¾‹çš„åˆ†ç‰‡é¡¹é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getLocalShardingItems</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (JobRegistry.getInstance().isShutdown(jobName) || !serverService.isAvailableServer(JobRegistry.getInstance().getJobInstance(jobName).getIp())) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> getShardingItems(JobRegistry.getInstance().getJobInstance(jobName).getJobInstanceId());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–ä½œä¸šè¿è¡Œå®ä¾‹çš„åˆ†ç‰‡é¡¹é›†åˆ.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> jobInstanceId ä½œä¸šè¿è¡Œå®ä¾‹ä¸»é”®</div><div class="line">* <span class="doctag">@return</span> ä½œä¸šè¿è¡Œå®ä¾‹çš„åˆ†ç‰‡é¡¹é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getShardingItems</span><span class="params">(<span class="keyword">final</span> String jobInstanceId)</span> </span>&#123;</div><div class="line">   JobInstance jobInstance = <span class="keyword">new</span> JobInstance(jobInstanceId);</div><div class="line">   <span class="keyword">if</span> (!serverService.isAvailableServer(jobInstance.getIp())) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   List&lt;Integer&gt; result = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">   <span class="keyword">int</span> shardingTotalCount = configService.load(<span class="keyword">true</span>).getTypeConfig().getCoreConfig().getShardingTotalCount();</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shardingTotalCount; i++) &#123;</div><div class="line">       <span class="comment">// `/$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/instance`</span></div><div class="line">       <span class="keyword">if</span> (jobInstance.getJobInstanceId().equals(jobNodeStorage.getJobNodeData(ShardingNode.getInstanceNode(i)))) &#123;</div><div class="line">           result.add(i);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>shardingItems.removeAll(executionService.getDisabledItems(shardingItems))</code>ï¼Œç§»é™¤<strong>è¢«ç¦ç”¨</strong>çš„ä½œä¸šåˆ†ç‰‡é¡¹ï¼Œå³ <code>/${JOB_NAME}/sharding/${ITEM_ID}/disabled</code> <strong>å­˜åœ¨</strong>çš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ExecutionService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–ç¦ç”¨çš„ä»»åŠ¡åˆ†ç‰‡é¡¹.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> items éœ€è¦è·å–ç¦ç”¨çš„ä»»åŠ¡åˆ†ç‰‡é¡¹</div><div class="line">* <span class="doctag">@return</span> ç¦ç”¨çš„ä»»åŠ¡åˆ†ç‰‡é¡¹</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getDisabledItems</span><span class="params">(<span class="keyword">final</span> List&lt;Integer&gt; items)</span> </span>&#123;</div><div class="line">   List&lt;Integer&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(items.size());</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : items) &#123;</div><div class="line">       <span class="comment">// /$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/disabled</span></div><div class="line">       <span class="keyword">if</span> (jobNodeStorage.isJobNodeExisted(ShardingNode.getDisabledNode(each))) &#123;</div><div class="line">           result.add(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>ExecutionContextService#getJobShardingContext(...)</code> æ–¹æ³•ï¼Œè·å–<strong>å½“å‰</strong>ä½œä¸šæœåŠ¡å™¨åˆ†ç‰‡ä¸Šä¸‹æ–‡ã€‚</p>
</li>
</ul>
<p><strong>è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨åˆ†ç‰‡ä¸Šä¸‹æ–‡</strong></p>
<p>è°ƒç”¨ <code>ExecutionContextService#getJobShardingContext(...)</code> æ–¹æ³•ï¼Œè·å–<strong>å½“å‰</strong>ä½œä¸šæœåŠ¡å™¨åˆ†ç‰‡ä¸Šä¸‹æ–‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ExecutionContextService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> ShardingContexts <span class="title">getJobShardingContext</span><span class="params">(<span class="keyword">final</span> List&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   LiteJobConfiguration liteJobConfig = configService.load(<span class="keyword">false</span>);</div><div class="line">   <span class="comment">// ç§»é™¤ æ­£åœ¨è¿è¡Œä¸­çš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">   removeRunningIfMonitorExecution(liteJobConfig.isMonitorExecution(), shardingItems);</div><div class="line">   <span class="comment">//</span></div><div class="line">   <span class="keyword">if</span> (shardingItems.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ShardingContexts(buildTaskId(liteJobConfig, shardingItems), liteJobConfig.getJobName(), liteJobConfig.getTypeConfig().getCoreConfig().getShardingTotalCount(), </div><div class="line">               liteJobConfig.getTypeConfig().getCoreConfig().getJobParameter(), Collections.&lt;Integer, String&gt;emptyMap());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è§£æåˆ†ç‰‡å‚æ•°</span></div><div class="line">   Map&lt;Integer, String&gt; shardingItemParameterMap = <span class="keyword">new</span> ShardingItemParameters(liteJobConfig.getTypeConfig().getCoreConfig().getShardingItemParameters()).getMap();</div><div class="line">   <span class="comment">// åˆ›å»º åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ShardingContexts(buildTaskId(liteJobConfig, shardingItems), <span class="comment">//</span></div><div class="line">           liteJobConfig.getJobName(), liteJobConfig.getTypeConfig().getCoreConfig().getShardingTotalCount(),</div><div class="line">           liteJobConfig.getTypeConfig().getCoreConfig().getJobParameter(),</div><div class="line">           getAssignedShardingItemParameterMap(shardingItems, shardingItemParameterMap)); <span class="comment">// è·å¾—å½“å‰ä½œä¸šèŠ‚ç‚¹çš„åˆ†ç‰‡å‚æ•°</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>#removeRunningIfMonitorExecution()</code> æ–¹æ³•ï¼Œç§»é™¤æ­£åœ¨è¿è¡Œä¸­çš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeRunningIfMonitorExecution</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> monitorExecution, <span class="keyword">final</span> List&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!monitorExecution) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   List&lt;Integer&gt; runningShardingItems = <span class="keyword">new</span> ArrayList&lt;&gt;(shardingItems.size());</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingItems) &#123;</div><div class="line">       <span class="keyword">if</span> (isRunning(each)) &#123;</div><div class="line">           runningShardingItems.add(each); <span class="comment">// /$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/running</span></div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   shardingItems.removeAll(runningShardingItems);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isRunning</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> shardingItem)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> jobNodeStorage.isJobNodeExisted(ShardingNode.getRunningNode(shardingItem));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>ä½¿ç”¨ ShardingItemParameters è§£æä½œä¸šåˆ†ç‰‡å‚æ•°ã€‚ä¾‹å¦‚ä½œä¸šåˆ†ç‰‡å‚æ•°( <code>JobCoreConfiguration.shardingItemParameters=&quot;0=Beijing,1=Shanghai,2=Guangzhou&quot;</code> ) è§£æç»“æœï¼š<br>  <img src="http://www.yunai.me/images/Elastic-Job/2017_10_31/04.png" alt=""></p>
<ul>
<li>ShardingItemParameters ä»£ç æ¸…æ™°æ˜“æ‡‚ï¼Œç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/fd45d3799565f69c6b604db83f78629d8c9a70cd/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/util/config/ShardingItemParameters.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>#buildTaskId(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºä½œä¸šä»»åŠ¡ID( <code>ShardingContexts.taskId</code> )ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">buildTaskId</span><span class="params">(<span class="keyword">final</span> LiteJobConfiguration liteJobConfig, <span class="keyword">final</span> List&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   JobInstance jobInstance = JobRegistry.getInstance().getJobInstance(jobName);</div><div class="line">   <span class="keyword">return</span> Joiner.on(<span class="string">"@-@"</span>).join(liteJobConfig.getJobName(), Joiner.on(<span class="string">","</span>).join(shardingItems), <span class="string">"READY"</span>, </div><div class="line">           <span class="keyword">null</span> == jobInstance.getJobInstanceId() ? <span class="string">"127.0.0.1@-@1"</span> : jobInstance.getJobInstanceId()); </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>taskId</code> = <code>${JOB_NAME}</code> + <code>@-@</code> + <code>${SHARDING_ITEMS}</code> + <code>@-@</code> + <code>READY</code> + <code>@-@</code> + <code>${IP}</code> + <code>@-@</code> + <code>${PID}</code>ã€‚ä¾‹å¦‚ï¼š<code>javaSimpleJob@-@0,1,2@-@READY@-@192.168.3.2@-@38330</code>ã€‚</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>#getAssignedShardingItemParameterMap(...)</code> æ–¹æ³•ï¼Œè·å¾—å½“å‰ä½œä¸šèŠ‚ç‚¹çš„åˆ†ç‰‡å‚æ•°ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">private</span> Map&lt;Integer, String&gt; <span class="title">getAssignedShardingItemParameterMap</span><span class="params">(<span class="keyword">final</span> List&lt;Integer&gt; shardingItems, <span class="keyword">final</span> Map&lt;Integer, String&gt; shardingItemParameterMap)</span> </span>&#123;</div><div class="line">       Map&lt;Integer, String&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;(shardingItemParameterMap.size(), <span class="number">1</span>);</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingItems) &#123;</div><div class="line">           result.put(each, shardingItemParameterMap.get(each));</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    ```    </div><div class="line"></div><div class="line">* ShardingContextsï¼Œåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆã€‚</div><div class="line">    ```Java</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ShardingContexts</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line">        </div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">4585977349142082152L</span>;</div><div class="line">        </div><div class="line">        <span class="comment">/**</span></div><div class="line">         * ä½œä¸šä»»åŠ¡ID.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String taskId;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * ä½œä¸šåç§°.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * åˆ†ç‰‡æ€»æ•°.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * ä½œä¸šè‡ªå®šä¹‰å‚æ•°.</div><div class="line">         * å¯ä»¥é…ç½®å¤šä¸ªç›¸åŒçš„ä½œä¸š, ä½†æ˜¯ç”¨ä¸åŒçš„å‚æ•°ä½œä¸ºä¸åŒçš„è°ƒåº¦å®ä¾‹.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String jobParameter;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * åˆ†é…äºæœ¬ä½œä¸šå®ä¾‹çš„åˆ†ç‰‡é¡¹å’Œå‚æ•°çš„Map.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, String&gt; shardingItemParameters;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * ä½œä¸šäº‹ä»¶é‡‡æ ·ç»Ÿè®¡æ•°.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> jobEventSamplingCount;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * å½“å‰ä½œä¸šäº‹ä»¶é‡‡æ ·ç»Ÿè®¡æ•°.</div><div class="line">         */</div><div class="line">        <span class="meta">@Setter</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> currentJobEventSamplingCount;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * æ˜¯å¦å…è®¸å¯ä»¥å‘é€ä½œä¸šäº‹ä»¶.</div><div class="line">         */</div><div class="line">        <span class="meta">@Setter</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> allowSendJobEvent = <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>jobEventSamplingCount</code>ï¼Œ<code>currentJobEventSamplingCount</code> åœ¨ Elastic-Job-Lite æš‚æœªè¿˜ä½¿ç”¨ï¼Œåœ¨ Elastic-Job-Cloud ä½¿ç”¨ã€‚</li>
</ul>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šå°ä¼™ä¼´ï¼Œæ›´æ–°äº†å¹²è´§å˜›ï¼ŒåŒå‡» 666ã€‚<br>èŠ‹é“å›ï¼šé‚£å¿…é¡»çš„å˜›ï¼Œè€Œä¸”è¿™ä¹ˆå‹¤å¿«æ›´æ–°ï¼æ˜¯ä¸æ˜¯åº”è¯¥åˆ†äº«ä¸€æ³¢æœ‹å‹åœˆã€‚</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_31/05.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ä½œä¸šåˆ†ç‰‡æ¡ä»¶&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.yunai.me/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆ†ç‰‡ç­–ç•¥</title>
    <link href="http://www.yunai.me/Elastic-Job/job-sharding-strategy/"/>
    <id>http://www.yunai.me/Elastic-Job/job-sharding-strategy/</id>
    <published>2017-10-25T16:00:00.000Z</published>
    <updated>2017-09-02T09:56:07.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. è‡ªå¸¦ä½œä¸šåˆ†ç‰‡ç­–ç•¥</a><ul>
<li><a href="#">2.1 AverageAllocationJobShardingStrategy</a></li>
<li><a href="#">2.2 OdevitySortByNameJobShardingStrategy</a></li>
<li><a href="#">2.3 RotateServerByNameJobShardingStrategy</a></li>
</ul>
</li>
<li><a href="#">3. è‡ªå®šä¹‰ä½œä¸šåˆ†ç‰‡ç­–ç•¥</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šåˆ†ç‰‡ç­–ç•¥</strong>ã€‚</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_10_26/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_26/01.png" alt=""></p>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-è‡ªå¸¦ä½œä¸šåˆ†ç‰‡ç­–ç•¥"><a href="#2-è‡ªå¸¦ä½œä¸šåˆ†ç‰‡ç­–ç•¥" class="headerlink" title="2. è‡ªå¸¦ä½œä¸šåˆ†ç‰‡ç­–ç•¥"></a>2. è‡ªå¸¦ä½œä¸šåˆ†ç‰‡ç­–ç•¥</h1><p>JobShardingStrategyï¼Œä½œä¸šåˆ†ç‰‡ç­–ç•¥<strong>æ¥å£</strong>ã€‚åˆ†ç‰‡ç­–ç•¥é€šè¿‡å®ç°æ¥å£çš„ <code>#sharding(...)</code> æ–¹æ³•æä¾›ä½œä¸šåˆ†ç‰‡çš„<strong>è®¡ç®—</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JobShardingStrategy</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåˆ†ç‰‡.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> jobInstances æ‰€æœ‰å‚ä¸åˆ†ç‰‡çš„å•å…ƒåˆ—è¡¨</div><div class="line">     * <span class="doctag">@param</span> jobName ä½œä¸šåç§°</div><div class="line">     * <span class="doctag">@param</span> shardingTotalCount åˆ†ç‰‡æ€»æ•°</div><div class="line">     * <span class="doctag">@return</span> åˆ†ç‰‡ç»“æœ</div><div class="line">     */</div><div class="line">    Map&lt;JobInstance, List&lt;Integer&gt;&gt; sharding(List&lt;JobInstance&gt; jobInstances, String jobName, <span class="keyword">int</span> shardingTotalCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Elastic-Job-Lite æä¾›ä¸‰ç§è‡ªå¸¦çš„ä½œä¸šåˆ†ç‰‡ç­–ç•¥ï¼š</p>
<ul>
<li>AverageAllocationJobShardingStrategyï¼šåŸºäºå¹³å‡åˆ†é…ç®—æ³•çš„åˆ†ç‰‡ç­–ç•¥ã€‚</li>
<li>OdevitySortByNameJobShardingStrategyï¼šæ ¹æ®ä½œä¸šåçš„å“ˆå¸Œå€¼å¥‡å¶æ•°å†³å®šIPå‡é™åºç®—æ³•çš„åˆ†ç‰‡ç­–ç•¥ã€‚</li>
<li>RotateServerByNameJobShardingStrategyï¼šæ ¹æ®ä½œä¸šåçš„å“ˆå¸Œå€¼å¯¹ä½œä¸šèŠ‚ç‚¹åˆ—è¡¨è¿›è¡Œè½®è½¬çš„åˆ†ç‰‡ç­–ç•¥ã€‚</li>
</ul>
<h2 id="2-1-AverageAllocationJobShardingStrategy"><a href="#2-1-AverageAllocationJobShardingStrategy" class="headerlink" title="2.1 AverageAllocationJobShardingStrategy"></a>2.1 AverageAllocationJobShardingStrategy</h2><p>AverageAllocationJobShardingStrategyï¼ŒåŸºäºå¹³å‡åˆ†é…ç®—æ³•çš„åˆ†ç‰‡ç­–ç•¥ã€‚<strong>Elastic-Job-Lite é»˜è®¤çš„ä½œä¸šåˆ†ç‰‡ç­–ç•¥</strong>ã€‚</p>
<blockquote>
<p>å¦‚æœåˆ†ç‰‡ä¸èƒ½æ•´é™¤ï¼Œåˆ™ä¸èƒ½æ•´é™¤çš„å¤šä½™åˆ†ç‰‡å°†ä¾æ¬¡è¿½åŠ åˆ°åºå·å°çš„ä½œä¸šèŠ‚ç‚¹ã€‚å¦‚ï¼š<br>å¦‚æœæœ‰3å°ä½œä¸šèŠ‚ç‚¹ï¼Œåˆ†æˆ9ç‰‡ï¼Œåˆ™æ¯å°ä½œä¸šèŠ‚ç‚¹åˆ†åˆ°çš„åˆ†ç‰‡æ˜¯ï¼š1=[0,1,2], 2=[3,4,5], 3=[6,7,8]<br>å¦‚æœæœ‰3å°ä½œä¸šèŠ‚ç‚¹ï¼Œåˆ†æˆ8ç‰‡ï¼Œåˆ™æ¯å°ä½œä¸šèŠ‚ç‚¹åˆ†åˆ°çš„åˆ†ç‰‡æ˜¯ï¼š1=[0,1,6], 2=[2,3,7], 3=[4,5]<br>å¦‚æœæœ‰3å°ä½œä¸šèŠ‚ç‚¹ï¼Œåˆ†æˆ10ç‰‡ï¼Œåˆ™æ¯å°ä½œä¸šèŠ‚ç‚¹åˆ†åˆ°çš„åˆ†ç‰‡æ˜¯ï¼š1=[0,1,2,9], 2=[3,4,5], 3=[6,7,8]  </p>
</blockquote>
<p>ä»£ç å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AverageAllocationJobShardingStrategy</span> <span class="keyword">implements</span> <span class="title">JobShardingStrategy</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Map&lt;JobInstance, List&lt;Integer&gt;&gt; sharding(<span class="keyword">final</span> List&lt;JobInstance&gt; jobInstances, <span class="keyword">final</span> String jobName, <span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount) &#123;</div><div class="line">        <span class="comment">// ä¸å­˜åœ¨ ä½œä¸šè¿è¡Œå®ä¾‹</span></div><div class="line">        <span class="keyword">if</span> (jobInstances.isEmpty()) &#123;</div><div class="line">            <span class="keyword">return</span> Collections.emptyMap();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// åˆ†é…èƒ½è¢«æ•´é™¤çš„éƒ¨åˆ†</span></div><div class="line">        Map&lt;JobInstance, List&lt;Integer&gt;&gt; result = shardingAliquot(jobInstances, shardingTotalCount);</div><div class="line">        <span class="comment">// åˆ†é…ä¸èƒ½è¢«æ•´é™¤çš„éƒ¨åˆ†</span></div><div class="line">        addAliquant(jobInstances, shardingTotalCount, result);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>#shardingAliquot(...)</code> æ–¹æ³•åˆ†é…èƒ½<strong>è¢«æ•´é™¤</strong>çš„éƒ¨åˆ†ã€‚èƒ½æ•´é™¤çš„å’±å°±ä¸ä¸¾ä¾‹å­ã€‚å¦‚æœæœ‰ 3 å°ä½œä¸šèŠ‚ç‚¹ï¼Œåˆ†æˆ 8 ç‰‡ï¼Œè¢«æ•´é™¤çš„éƒ¨åˆ†æ˜¯å‰ 6 ç‰‡ [0, 1, 2, 3, 4, 5]ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ç»“æœï¼š1=[0,1], 2=[2,3], 3=[4,5]ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Map&lt;JobInstance, List&lt;Integer&gt;&gt; shardingAliquot(<span class="keyword">final</span> List&lt;JobInstance&gt; shardingUnits, <span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount) &#123;</div><div class="line">   Map&lt;JobInstance, List&lt;Integer&gt;&gt; result = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(shardingTotalCount, <span class="number">1</span>);</div><div class="line">   <span class="keyword">int</span> itemCountPerSharding = shardingTotalCount / shardingUnits.size(); <span class="comment">// æ¯ä¸ªä½œä¸šè¿è¡Œå®ä¾‹åˆ†é…çš„å¹³å‡åˆ†ç‰‡æ•°</span></div><div class="line">   <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (JobInstance each : shardingUnits) &#123;</div><div class="line">       List&lt;Integer&gt; shardingItems = <span class="keyword">new</span> ArrayList&lt;&gt;(itemCountPerSharding + <span class="number">1</span>);</div><div class="line">       <span class="comment">// é¡ºåºå‘ä¸‹åˆ†é…</span></div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = count * itemCountPerSharding; i &lt; (count + <span class="number">1</span>) * itemCountPerSharding; i++) &#123;</div><div class="line">           shardingItems.add(i);</div><div class="line">       &#125;</div><div class="line">       result.put(each, shardingItems);</div><div class="line">       count++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>#addAliquant(...)</code> æ–¹æ³•åˆ†é…èƒ½<strong>ä¸è¢«æ•´é™¤</strong>çš„éƒ¨åˆ†ã€‚ç»§ç»­ä¸Šé¢çš„ä¾‹å­ã€‚ä¸èƒ½è¢«æ•´é™¤çš„éƒ¨åˆ†æ˜¯å 2 ç‰‡ [6, 7]ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ç»“æœï¼š1=[0,1] + <strong>[6]</strong>, 2=[2,3] + <strong>[7]</strong>, 3=[4,5]ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addAliquant</span><span class="params">(<span class="keyword">final</span> List&lt;JobInstance&gt; shardingUnits, <span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount, <span class="keyword">final</span> Map&lt;JobInstance, List&lt;Integer&gt;&gt; shardingResults)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> aliquant = shardingTotalCount % shardingUnits.size(); <span class="comment">// ä½™æ•°</span></div><div class="line">   <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (Map.Entry&lt;JobInstance, List&lt;Integer&gt;&gt; entry : shardingResults.entrySet()) &#123;</div><div class="line">       <span class="keyword">if</span> (count &lt; aliquant) &#123;</div><div class="line">           entry.getValue().add(shardingTotalCount / shardingUnits.size() * shardingUnits.size() + count);</div><div class="line">       &#125;</div><div class="line">       count++;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>å¦‚ä½•å®ç°ä¸»å¤‡</strong></p>
<p>é€šè¿‡ä½œä¸šé…ç½®è®¾ç½®æ€»åˆ†ç‰‡æ•°ä¸º 1 ( <code>JobCoreConfiguration.shardingTotalCount = 1</code> )ï¼Œåªæœ‰ä¸€ä¸ªä½œä¸šåˆ†ç‰‡èƒ½å¤Ÿåˆ†é…åˆ°ä½œä¸šåˆ†ç‰‡é¡¹ï¼Œä»è€Œè¾¾åˆ°<strong>ä¸€ä¸»Nå¤‡</strong>ã€‚</p>
<h2 id="2-2-OdevitySortByNameJobShardingStrategy"><a href="#2-2-OdevitySortByNameJobShardingStrategy" class="headerlink" title="2.2 OdevitySortByNameJobShardingStrategy"></a>2.2 OdevitySortByNameJobShardingStrategy</h2><p>OdevitySortByNameJobShardingStrategyï¼Œæ ¹æ®ä½œä¸šåçš„å“ˆå¸Œå€¼å¥‡å¶æ•°å†³å®šIPå‡é™åºç®—æ³•çš„åˆ†ç‰‡ç­–ç•¥ã€‚</p>
<blockquote>
<p>ä½œä¸šåçš„å“ˆå¸Œå€¼ä¸ºå¥‡æ•°åˆ™IP <strong>é™åº</strong>.<br>ä½œä¸šåçš„å“ˆå¸Œå€¼ä¸ºå¶æ•°åˆ™IP <strong>å‡åº</strong>.<br>ç”¨äºä¸åŒçš„ä½œä¸šå¹³å‡åˆ†é…è´Ÿè½½è‡³ä¸åŒçš„ä½œä¸šèŠ‚ç‚¹.<br>å¦‚:   </p>
<ol>
<li>å¦‚æœæœ‰3å°ä½œä¸šèŠ‚ç‚¹, åˆ†æˆ2ç‰‡, ä½œä¸šåç§°çš„å“ˆå¸Œå€¼ä¸ºå¥‡æ•°, åˆ™æ¯å°ä½œä¸šèŠ‚ç‚¹åˆ†åˆ°çš„åˆ†ç‰‡æ˜¯: 1=[ ], 2=[1], 3=[0].  </li>
<li>å¦‚æœæœ‰3å°ä½œä¸šèŠ‚ç‚¹, åˆ†æˆ2ç‰‡, ä½œä¸šåç§°çš„å“ˆå¸Œå€¼ä¸ºå¶æ•°, åˆ™æ¯å°ä½œä¸šèŠ‚ç‚¹åˆ†åˆ°çš„åˆ†ç‰‡æ˜¯: 1=[0], 2=[1], 3=[ ].</li>
</ol>
</blockquote>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> Map&lt;JobInstance, List&lt;Integer&gt;&gt; sharding(<span class="keyword">final</span> List&lt;JobInstance&gt; jobInstances, <span class="keyword">final</span> String jobName, <span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount) &#123;</div><div class="line">   <span class="keyword">long</span> jobNameHash = jobName.hashCode();</div><div class="line">   <span class="keyword">if</span> (<span class="number">0</span> == jobNameHash % <span class="number">2</span>) &#123;</div><div class="line">       Collections.reverse(jobInstances);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> averageAllocationJobShardingStrategy.sharding(jobInstances, jobName, shardingTotalCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>ä»å®ç°ä»£ç ä¸Šï¼Œä»¿ä½›å’Œ IP å‡é™åºæ²¡ä»€ä¹ˆå…³ç³»ï¼Ÿç­”æ¡ˆåœ¨ä¼ é€’è¿›æ¥çš„å‚æ•° <code>jobInstances</code>ã€‚<code>jobInstances</code> å·²ç»æ˜¯æŒ‰ç…§ IP è¿›è¡Œ<strong>é™åº</strong>çš„æ•°ç»„ã€‚æ‰€ä»¥å½“åˆ¤æ–­åˆ°ä½œä¸šåçš„å“ˆå¸Œå€¼ä¸ºå¶æ•°æ—¶ï¼Œè¿›è¡Œæ•°ç»„åè½¬( <code>Collections#reverse(...)</code> )å®ç°æŒ‰ç…§ IP <strong>å‡åº</strong>ã€‚ä¸‹é¢çœ‹ä¸‹ä¸ºä»€ä¹ˆè¯´<code>jobInstances</code> å·²ç»æŒ‰ç…§ IP è¿›è¡Œ<strong>é™åº</strong>ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ZookeeperRegistryCenter.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getChildrenKeys</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       List&lt;String&gt; result = client.getChildren().forPath(key);</div><div class="line">       Collections.sort(result, <span class="keyword">new</span> Comparator&lt;String&gt;() &#123;</div><div class="line">           </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(<span class="keyword">final</span> String o1, <span class="keyword">final</span> String o2)</span> </span>&#123;</div><div class="line">               <span class="keyword">return</span> o2.compareTo(o1);</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>AverageAllocationJobShardingStrategy#sharding(...)</code> æ–¹æ³•å®Œæˆæœ€ç»ˆä½œä¸šåˆ†ç‰‡è®¡ç®—ã€‚</p>
</li>
</ul>
<h2 id="2-3-RotateServerByNameJobShardingStrategy"><a href="#2-3-RotateServerByNameJobShardingStrategy" class="headerlink" title="2.3 RotateServerByNameJobShardingStrategy"></a>2.3 RotateServerByNameJobShardingStrategy</h2><p>RotateServerByNameJobShardingStrategyï¼Œæ ¹æ®ä½œä¸šåçš„å“ˆå¸Œå€¼å¯¹ä½œä¸šèŠ‚ç‚¹åˆ—è¡¨è¿›è¡Œ<strong>è½®è½¬</strong>çš„åˆ†ç‰‡ç­–ç•¥ã€‚è¿™é‡Œçš„<strong>è½®è½¬</strong>æ€ä¹ˆå®šä¹‰å‘¢ï¼Ÿå¦‚æœæœ‰ 3 å°ä½œä¸šèŠ‚ç‚¹ï¼Œé¡ºåºä¸º [0, 1, 2]ï¼Œå¦‚æœä½œä¸šåçš„å“ˆå¸Œå€¼æ ¹æ®ä½œä¸šåˆ†ç‰‡æ€»æ•°å–æ¨¡ä¸º 1, ä½œä¸šèŠ‚ç‚¹é¡ºåºå˜ä¸º [1, 2, 0]ã€‚</p>
<p><strong>åˆ†ç‰‡çš„ç›®çš„</strong>ï¼Œæ˜¯å°†ä½œä¸šçš„è´Ÿè½½åˆç†çš„åˆ†é…åˆ°ä¸åŒçš„ä½œä¸šèŠ‚ç‚¹ä¸Šï¼Œè¦é¿å…åˆ†ç‰‡ç­–ç•¥æ€»æ˜¯è®©å›ºå®šçš„ä½œä¸šèŠ‚ç‚¹è´Ÿè½½ç‰¹åˆ«å¤§ï¼Œå…¶å®ƒå·¥ä½œèŠ‚ç‚¹è´Ÿè½½ç‰¹åˆ«å°ã€‚è¿™ä¸ªä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ<strong>å®˜æ–¹</strong>å¯¹æ¯” RotateServerByNameJobShardingStrategyã€AverageAllocationJobShardingStrategy å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>AverageAllocationJobShardingStrategyçš„ç¼ºç‚¹æ˜¯ï¼Œä¸€æ—¦åˆ†ç‰‡æ•°å°äºä½œä¸šä½œä¸šèŠ‚ç‚¹æ•°ï¼Œä½œä¸šå°†æ°¸è¿œåˆ†é…è‡³IPåœ°å€é å‰çš„ä½œä¸šèŠ‚ç‚¹ï¼Œå¯¼è‡´IPåœ°å€é åçš„ä½œä¸šèŠ‚ç‚¹ç©ºé—²ã€‚å¦‚ï¼š<br>OdevitySortByNameJobShardingStrategyåˆ™å¯ä»¥æ ¹æ®ä½œä¸šåç§°é‡æ–°åˆ†é…ä½œä¸šèŠ‚ç‚¹è´Ÿè½½ã€‚<br>å¦‚æœæœ‰3å°ä½œä¸šèŠ‚ç‚¹ï¼Œåˆ†æˆ2ç‰‡ï¼Œä½œä¸šåç§°çš„å“ˆå¸Œå€¼ä¸ºå¥‡æ•°ï¼Œåˆ™æ¯å°ä½œä¸šèŠ‚ç‚¹åˆ†åˆ°çš„åˆ†ç‰‡æ˜¯ï¼š1=[0], 2=[1], 3=[]<br>å¦‚æœæœ‰3å°ä½œä¸šèŠ‚ç‚¹ï¼Œåˆ†æˆ2ç‰‡ï¼Œä½œä¸šåç§°çš„å“ˆå¸Œå€¼ä¸ºå¶æ•°ï¼Œåˆ™æ¯å°ä½œä¸šèŠ‚ç‚¹åˆ†åˆ°çš„åˆ†ç‰‡æ˜¯ï¼š3=[0], 2=[1], 1=[]  </p>
</blockquote>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RotateServerByNameJobShardingStrategy</span> <span class="keyword">implements</span> <span class="title">JobShardingStrategy</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> AverageAllocationJobShardingStrategy averageAllocationJobShardingStrategy = <span class="keyword">new</span> AverageAllocationJobShardingStrategy();</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Map&lt;JobInstance, List&lt;Integer&gt;&gt; sharding(<span class="keyword">final</span> List&lt;JobInstance&gt; jobInstances, <span class="keyword">final</span> String jobName, <span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount) &#123;</div><div class="line">        <span class="keyword">return</span> averageAllocationJobShardingStrategy.sharding(rotateServerList(jobInstances, jobName), jobName, shardingTotalCount);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> List&lt;JobInstance&gt; <span class="title">rotateServerList</span><span class="params">(<span class="keyword">final</span> List&lt;JobInstance&gt; shardingUnits, <span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> shardingUnitsSize = shardingUnits.size();</div><div class="line">        <span class="keyword">int</span> offset = Math.abs(jobName.hashCode()) % shardingUnitsSize; <span class="comment">// è½®è½¬å¼€å§‹ä½ç½®</span></div><div class="line">        <span class="keyword">if</span> (<span class="number">0</span> == offset) &#123;</div><div class="line">            <span class="keyword">return</span> shardingUnits;</div><div class="line">        &#125;</div><div class="line">        List&lt;JobInstance&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(shardingUnitsSize);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shardingUnitsSize; i++) &#123;</div><div class="line">            <span class="keyword">int</span> index = (i + offset) % shardingUnitsSize;</div><div class="line">            result.add(shardingUnits.get(index));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>#rotateServerList(...)</code> å®ç°ä½œä¸šèŠ‚ç‚¹æ•°ç»„<strong>è½®è½¬</strong>ã€‚</li>
<li>è°ƒç”¨ <code>AverageAllocationJobShardingStrategy#sharding(...)</code> æ–¹æ³•å®Œæˆæœ€ç»ˆä½œä¸šåˆ†ç‰‡è®¡ç®—ã€‚</li>
</ul>
<h1 id="3-è‡ªå®šä¹‰ä½œä¸šåˆ†ç‰‡ç­–ç•¥"><a href="#3-è‡ªå®šä¹‰ä½œä¸šåˆ†ç‰‡ç­–ç•¥" class="headerlink" title="3. è‡ªå®šä¹‰ä½œä¸šåˆ†ç‰‡ç­–ç•¥"></a>3. è‡ªå®šä¹‰ä½œä¸šåˆ†ç‰‡ç­–ç•¥</h1><p>å¯èƒ½åœ¨ä½ çš„ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œéœ€è¦å®ç°è‡ªå®šä¹‰çš„ä½œä¸šåˆ†ç‰‡ç­–ç•¥ã€‚é€šè¿‡å®šä¹‰ç±»å®ç° JobShardingStrategy æ¥å£å³å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OOXXShardingStrategy</span> <span class="keyword">implements</span> <span class="title">JobShardingStrategy</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Map&lt;JobInstance, List&lt;Integer&gt;&gt; sharding(<span class="keyword">final</span> List&lt;JobInstance&gt; jobInstances, <span class="keyword">final</span> String jobName, <span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount) &#123;</div><div class="line">        <span class="comment">// å®ç°é€»è¾‘</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å®ç°åï¼Œé…ç½®å®ç°ç±»çš„<strong>å…¨è·¯å¾„</strong>åˆ° Liteä½œä¸šé…ç½®( LiteJobConfiguration )çš„ <code>jobShardingStrategyClass</code> å±æ€§ã€‚</p>
<p>ä½œä¸šè¿›è¡Œåˆ†ç‰‡è®¡ç®—æ—¶ï¼Œä½œä¸šåˆ†ç‰‡ç­–ç•¥å·¥å‚( JobShardingStrategyFactory ) ä¼šåˆ›å»ºä½œä¸šåˆ†ç‰‡ç­–ç•¥å®ä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobShardingStrategyFactory</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–ä½œä¸šåˆ†ç‰‡ç­–ç•¥å®ä¾‹.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> jobShardingStrategyClassName ä½œä¸šåˆ†ç‰‡ç­–ç•¥ç±»å</div><div class="line">     * <span class="doctag">@return</span> ä½œä¸šåˆ†ç‰‡ç­–ç•¥å®ä¾‹</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobShardingStrategy <span class="title">getStrategy</span><span class="params">(<span class="keyword">final</span> String jobShardingStrategyClassName)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (Strings.isNullOrEmpty(jobShardingStrategyClassName)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AverageAllocationJobShardingStrategy();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Class&lt;?&gt; jobShardingStrategyClass = Class.forName(jobShardingStrategyClassName);</div><div class="line">            <span class="keyword">if</span> (!JobShardingStrategy.class.isAssignableFrom(jobShardingStrategyClass)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Class '%s' is not job strategy class"</span>, jobShardingStrategyClassName);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> (JobShardingStrategy) jobShardingStrategyClass.newInstance();</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ClassNotFoundException | InstantiationException | IllegalAccessException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Sharding strategy class '%s' config error, message details are '%s'"</span>, jobShardingStrategyClassName, ex.getMessage());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šé›¾è‰ï¼Œåˆšå¤¸å¥–ä½ ï¼Œå°±åˆå¼€å§‹æ°´æ›´ã€‚<br>èŠ‹é“å›ï¼šå’³å’³å’³ï¼Œä½œä¸šåˆ†ç‰‡ç­–ç•¥ç‚’é¸¡é‡è¦çš„å¥½ä¸å¥½ï¼å˜¿å˜¿å˜¿ï¼Œä¸º<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a>åšä¸ªé“ºå«å˜›ã€‚</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_26/02.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. è‡ªå¸¦ä½œä¸šåˆ†ç‰‡ç­–ç•¥&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.yunai.me/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä¸»èŠ‚ç‚¹é€‰ä¸¾</title>
    <link href="http://www.yunai.me/Elastic-Job/election/"/>
    <id>http://www.yunai.me/Elastic-Job/election/</id>
    <published>2017-10-20T16:00:00.000Z</published>
    <updated>2017-09-02T09:55:51.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="">1. æ¦‚è¿°</a></li>
<li><a href="">2. ä¸ºä»€ä¹ˆéœ€è¦é€‰ä¸¾ä¸»èŠ‚ç‚¹</a></li>
<li><a href="">3. é€‰ä¸¾ä¸»èŠ‚ç‚¹</a></li>
<li><a href="">4. åˆ é™¤ä¸»èŠ‚ç‚¹</a></li>
<li><a href="">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä¸»èŠ‚ç‚¹é€‰ä¸¾</strong>ã€‚</p>
<p>å»ºè®®å‰ç½®é˜…è¯»ï¼š</p>
<ul>
<li><a href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒã€‹</a></li>
<li><a href="http://www.yunai.me/Elastic-Job/job-storage/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ•°æ®å­˜å‚¨ã€‹</a></li>
<li><a href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper-listener/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒç›‘å¬å™¨ã€‹</a></li>
</ul>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_10_21/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_21/01.png" alt=""></p>
<ul>
<li>ç²‰è‰²çš„ç±»åœ¨ <code>com.dangdang.ddframe.job.lite.internal.election</code> åŒ…ä¸‹ï¼Œå®ç°äº† Elastic-Job-Lite ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‚</li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-ä¸ºä»€ä¹ˆéœ€è¦é€‰ä¸¾ä¸»èŠ‚ç‚¹"><a href="#2-ä¸ºä»€ä¹ˆéœ€è¦é€‰ä¸¾ä¸»èŠ‚ç‚¹" class="headerlink" title="2. ä¸ºä»€ä¹ˆéœ€è¦é€‰ä¸¾ä¸»èŠ‚ç‚¹"></a>2. ä¸ºä»€ä¹ˆéœ€è¦é€‰ä¸¾ä¸»èŠ‚ç‚¹</h1><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€æ®µ<strong>å®˜æ–¹</strong>å¯¹ Elastic-Job-Lite çš„ä»‹ç»ï¼š</p>
<blockquote>
<p>Elastic-Job-Lite å®šä½ä¸ºè½»é‡çº§æ— ä¸­å¿ƒåŒ–è§£å†³æ–¹æ¡ˆï¼Œä½¿ç”¨ jar åŒ…çš„å½¢å¼æä¾›åˆ†å¸ƒå¼ä»»åŠ¡çš„åè°ƒæœåŠ¡ã€‚</p>
</blockquote>
<p><strong>æ— ä¸­å¿ƒåŒ–</strong>ï¼Œæ„å‘³ç€ Elastic-Job-Lite ä¸å­˜åœ¨<strong>ä¸€ä¸ªä¸­å¿ƒ</strong>æ‰§è¡Œä¸€äº›æ“ä½œï¼Œä¾‹å¦‚ï¼šåˆ†é…ä½œä¸šåˆ†ç‰‡é¡¹ã€‚Elastic-Job-Lite é€‰ä¸¾ä¸»èŠ‚ç‚¹ï¼Œé€šè¿‡ä¸»èŠ‚ç‚¹è¿›è¡Œä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…ã€‚ç›®å‰ï¼Œå¿…é¡»åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œçš„æ“ä½œæœ‰ï¼šåˆ†é…ä½œä¸šåˆ†ç‰‡é¡¹ï¼Œè°ƒè§£åˆ†å¸ƒå¼ä½œä¸šä¸ä¸€è‡´çŠ¶æ€ã€‚</p>
<p>å¦å¤–ï¼Œä¸»èŠ‚ç‚¹çš„é€‰ä¸¾æ˜¯ä»¥<strong>ä½œä¸šä¸ºç»´åº¦</strong>ã€‚ä¾‹å¦‚ï¼šæœ‰ä¸€ä¸ª Elastic-Job-Lite é›†ç¾¤æœ‰ä¸‰ä¸ªä½œä¸šèŠ‚ç‚¹ <code>A</code>ã€<code>B</code>ã€<code>C</code>ï¼Œå­˜åœ¨ä¸¤ä¸ªä½œä¸š <code>a</code>ã€<code>b</code>ï¼Œå¯èƒ½ <code>a</code> ä½œä¸šçš„ä¸»èŠ‚ç‚¹æ˜¯ <code>C</code>ï¼Œ<code>b</code> ä½œä¸šçš„ä¸»èŠ‚ç‚¹æ˜¯ <code>A</code>ã€‚</p>
<h1 id="3-é€‰ä¸¾ä¸»èŠ‚ç‚¹"><a href="#3-é€‰ä¸¾ä¸»èŠ‚ç‚¹" class="headerlink" title="3. é€‰ä¸¾ä¸»èŠ‚ç‚¹"></a>3. é€‰ä¸¾ä¸»èŠ‚ç‚¹</h1><p>è°ƒç”¨ <code>LeaderService#electLeader()</code> é€‰ä¸¾ä¸»èŠ‚ç‚¹ã€‚</p>
<p>å¤§ä½“æµç¨‹å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_10_21/02.png">æ‰“å¼€å¤§å›¾</a> )ï¼š<br><img src="http://www.yunai.me/images/Elastic-Job/2017_10_21/02.png" alt=""></p>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LeaderService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* é€‰ä¸¾ä¸»èŠ‚ç‚¹.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">electLeader</span><span class="params">()</span> </span>&#123;</div><div class="line">   log.debug(<span class="string">"Elect a new leader now."</span>);</div><div class="line">   jobNodeStorage.executeInLeader(LeaderNode.LATCH, <span class="keyword">new</span> LeaderElectionExecutionCallback());</div><div class="line">   log.debug(<span class="string">"Leader election completed."</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobNodeStorage.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeInLeader</span><span class="params">(<span class="keyword">final</span> String latchNode, <span class="keyword">final</span> LeaderExecutionCallback callback)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> (LeaderLatch latch = <span class="keyword">new</span> LeaderLatch(getClient(), jobNodePath.getFullPath(latchNode))) &#123;</div><div class="line">       latch.start();</div><div class="line">       latch.await();</div><div class="line">       callback.execute();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       handleException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// LeaderElectionExecutionCallback.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeaderElectionExecutionCallback</span> <span class="keyword">implements</span> <span class="title">LeaderExecutionCallback</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (!hasLeader()) &#123; <span class="comment">// å½“å‰æ— ä¸»èŠ‚ç‚¹</span></div><div class="line">           jobNodeStorage.fillEphemeralJobNode(LeaderNode.INSTANCE, JobRegistry.getInstance().getJobInstance(jobName).getJobInstanceId());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä½¿ç”¨ Curator LeaderLatch åˆ†å¸ƒå¼é”ï¼Œ<strong>ä¿è¯åŒä¸€æ—¶é—´æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹</strong>èƒ½å¤Ÿè°ƒç”¨ <code>LeaderElectionExecutionCallback#execute()</code> æ–¹æ³•æ‰§è¡Œä¸»èŠ‚ç‚¹è®¾ç½®ã€‚Curator LeaderLatch åœ¨<a href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒã€‹ã€Œ3.1 åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œã€</a>æœ‰è¯¦ç»†è§£æã€‚</li>
<li><p>åœ¨ <code>LeaderElectionExecutionCallback#execute()</code> ä¸ºä»€ä¹ˆè¦è°ƒç”¨ <code>#hasLeader()</code> å‘¢ï¼ŸLeaderLatch <strong>åªä¿è¯åŒä¸€æ—¶é—´æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹</strong>ï¼Œåœ¨è·å¾—åˆ†å¸ƒå¼é”çš„å·¥ä½œèŠ‚ç‚¹ç»“æŸé€»è¾‘åï¼Œç¬¬äºŒä¸ªå·¥ä½œèŠ‚ç‚¹ä¼šå¼€å§‹é€»è¾‘ï¼Œå¦‚æœä¸åˆ¤æ–­å½“å‰æ˜¯å¦æœ‰ä¸»èŠ‚ç‚¹ï¼ŒåŸæ¥çš„ä¸»èŠ‚ç‚¹ä¼šè¢«è¦†ç›–ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LeaderService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * åˆ¤æ–­æ˜¯å¦å·²ç»æœ‰ä¸»èŠ‚ç‚¹.</div><div class="line"> * </div><div class="line"> * <span class="doctag">@return</span> æ˜¯å¦å·²ç»æœ‰ä¸»èŠ‚ç‚¹</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasLeader</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> jobNodeStorage.isJobNodeExisted(LeaderNode.INSTANCE);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>é€‰ä¸¾æˆåŠŸåï¼ŒZookeeper å­˜å‚¨<strong>ä½œä¸š</strong>çš„ä¸»èŠ‚ç‚¹ï¼š<code>/${JOB_NAME}/leader/electron/instance</code> ä¸ºå½“å‰èŠ‚ç‚¹ã€‚è¯¥èŠ‚ç‚¹ä¸º<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ã€‚</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 7] get /elastic-job-example-lite-java/javaSimpleJob/leader/election/instance</div><div class="line">192.168.16.137@-@82496</div></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>é€‰ä¸¾ä¸»èŠ‚ç‚¹æ—¶æœº</strong></p>
<p><strong>ç¬¬ä¸€ç§</strong>ï¼Œæ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯æ—¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> enabled ä½œä¸šæ˜¯å¦å¯ç”¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStartUpInfo</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> enabled)</span> </span>&#123;</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†æ–¹æ³•</span></div><div class="line">   <span class="comment">// é€‰ä¸¾ ä¸»èŠ‚ç‚¹</span></div><div class="line">   leaderService.electLeader();</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ–°çš„ä½œä¸šå¯åŠ¨æ—¶ï¼Œå³èƒ½ä¿è¯é€‰ä¸¾å‡ºä¸»èŠ‚ç‚¹ã€‚<ul>
<li>å½“è¯¥ä½œä¸š<strong>ä¸å­˜åœ¨</strong>ä¸»èŠ‚ç‚¹æ—¶ï¼Œå½“å‰ä½œä¸šèŠ‚ç‚¹<strong>æˆä¸º</strong>ä¸»èŠ‚ç‚¹ã€‚</li>
<li>å½“è¯¥ä½œä¸š<strong>å­˜åœ¨</strong>ä¸»èŠ‚ç‚¹ï¼Œå½“å‰ä½œä¸šèŠ‚ä¸»èŠ‚ç‚¹<strong>ä¸å˜</strong>ã€‚</li>
</ul>
</li>
</ul>
<p><strong>ç¬¬äºŒç§</strong>ï¼ŒèŠ‚ç‚¹æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeaderElectionJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (!JobRegistry.getInstance().isShutdown(jobName) &amp;&amp; (isActiveElection(path, data) || isPassiveElection(path, eventType))) &#123;</div><div class="line">           leaderService.electLeader();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ç¬¦åˆé‡æ–°é€‰ä¸¾ä¸»èŠ‚ç‚¹åˆ†æˆä¸¤ç§æƒ…å†µã€‚</li>
<li><p><strong>ä¸»åŠ¨</strong>é€‰ä¸¾ <code>#isActiveElection(...)</code></p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isActiveElection</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> !leaderService.hasLeader() <span class="comment">// ä¸å­˜åœ¨ä¸»èŠ‚ç‚¹</span></div><div class="line">          &amp;&amp; isLocalServerEnabled(path, data); <span class="comment">// å¼€å¯ä½œä¸š</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isLocalServerEnabled</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> serverNode.isLocalServerPath(path) </div><div class="line">       &amp;&amp; !ServerStatus.DISABLED.name().equals(data);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å½“ä½œä¸šè¢«ç¦ç”¨( <code>LiteJobConfiguration.disabled = true</code> )æ—¶ï¼Œä½œä¸šæ˜¯ä¸å­˜åœ¨ä¸»èŠ‚ç‚¹çš„ã€‚é‚£æœ‰åŒå­¦å°±æœ‰ç–‘é—®äº†ï¼Ÿ<code>LeaderService#electLeader()</code> æ²¡åšè¿™ä¸ªé™åˆ¶å‘€ï¼Œä½œä¸š<strong>æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯æ—¶</strong>ä¹Ÿè¿›è¡Œäº†é€‰ä¸¾ã€‚åœ¨ã€Œ4. åˆ é™¤ä¸»èŠ‚ç‚¹ã€å°ç»“ï¼Œæˆ‘ä»¬ä¼šè§£å¼€è¿™ä¸ªç­”æ¡ˆã€‚è¿™é‡Œå¤§å®¶å…ˆè®°ä½è¿™ä¸ªç»“è®ºã€‚</li>
<li>æ ¹æ®ä¸Šé¢æˆ‘ä»¬è¯´çš„ç»“è®ºï¼Œè¿™é‡Œå°±å¾ˆå¥½ç†è§£äº†ï¼Œ<code>#isActiveElection()</code> æ–¹æ³•åˆ¤æ–­äº†ä¸¤ä¸ªæ¡ä»¶ï¼š( 1 ) ä¸å­˜åœ¨ä¸»èŠ‚ç‚¹ï¼›( 2 ) å¼€å¯ä½œä¸šï¼Œä¸å†ç¦ç”¨ï¼Œå› æ­¤éœ€è¦è¿›è¡Œä¸»èŠ‚ç‚¹é€‰ä¸¾è½ã€‚</li>
<li>è¿™é‡Œåˆ¤æ–­å¼€å¯ä½œä¸šçš„æ–¹æ³• <code>#isLocalServerEnabled(...)</code> æœ‰ç‚¹ç‰¹æ®Šï¼Œå®ƒä¸æ˜¯é€šè¿‡ä½œä¸šèŠ‚ç‚¹æ˜¯å¦å¤„äºå¼€å¯çŠ¶æ€ï¼Œè€Œæ˜¯è¯¥æ•°æ®ä¸æ˜¯å°†ä½œä¸šèŠ‚ç‚¹æ›´æ–°æˆå…³é—­çŠ¶æ€ã€‚ä¸¾ä¸ªä¾‹å­ï¼šä½œä¸šèŠ‚ç‚¹å¤„äº<strong>ç¦ç”¨</strong>çŠ¶æ€ï¼Œä½¿ç”¨<strong>è¿ç»´å¹³å°</strong>è®¾ç½®ä½œä¸šèŠ‚ç‚¹å¼€å¯ï¼Œä¼šè¿›è¡Œä¸»èŠ‚ç‚¹é€‰ä¸¾ï¼›ä½œä¸šèŠ‚ç‚¹å¤„äº<strong>å¼€å¯</strong>çŠ¶æ€ï¼Œä½¿ç”¨<strong>è¿ç»´å¹³å°</strong>è®¾ç½®ä½œä¸šèŠ‚ç‚¹ç¦ç”¨ï¼Œä¸ä¼šè¿›è¡Œä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‚</li>
</ul>
</li>
<li><p><strong>è¢«åŠ¨</strong>é€‰ä¸¾ <code>#isPassiveElection(...)</code></p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isPassiveElection</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> isLeaderCrashed(path, eventType) <span class="comment">// ä¸»èŠ‚ç‚¹ Crashed</span></div><div class="line">          &amp;&amp; serverService.isAvailableServer(JobRegistry.getInstance().getJobInstance(jobName).getIp()); <span class="comment">// å½“å‰èŠ‚ç‚¹æ­£åœ¨è¿è¡Œä¸­ï¼ˆæœªæŒ‚æ‰ï¼‰</span></div><div class="line">&#125;</div><div class="line">   </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isLeaderCrashed</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> leaderNode.isLeaderInstancePath(path) &amp;&amp; Type.NODE_REMOVED == eventType;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å½“ä¸»èŠ‚ç‚¹å› ä¸ºå„ç§æƒ…å†µ( ã€Œ4. åˆ é™¤ä¸»èŠ‚ç‚¹ã€ä¼šåˆ—ä¸¾ )è¢«åˆ é™¤ï¼Œéœ€è¦é‡æ–°è¿›è¡Œé€‰ä¸¾ã€‚å¯¹çš„ï¼Œ<strong>å¿…é¡»ä¸»èŠ‚ç‚¹è¢«åˆ é™¤åæ‰å¯ä»¥é‡æ–°è¿›è¡Œé€‰ä¸¾</strong>ã€‚</li>
<li><code>#isPassiveElection(...)</code> æ–¹æ³•åˆ¤æ–­äº†ä¸¤ä¸ªæ¡ä»¶ï¼š( 1 ) åŸä¸»èŠ‚ç‚¹è¢«åˆ é™¤ï¼›( 2 ) å½“å‰èŠ‚ç‚¹æ­£åœ¨è¿è¡Œä¸­ï¼ˆæœªæŒ‚æ‰ï¼‰ï¼Œå¯ä»¥å‚åŠ ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‚</li>
<li><code>#isLeaderCrashed(...)</code> æ–¹æ³•è™½ç„¶å‘½åå¸¦æœ‰ <code>Crashed</code> è‹±æ–‡ï¼Œå®é™…ä¸»ä½œä¸šèŠ‚ç‚¹<strong>æ­£å¸¸</strong>é€€å‡ºä¹Ÿç¬¦åˆ<strong>è¢«åŠ¨</strong>é€‰ä¸¾æ¡ä»¶ã€‚</li>
</ul>
</li>
</ul>
<p><strong>ç­‰å¾…ä¸»èŠ‚ç‚¹é€‰ä¸¾å®Œæˆ</strong></p>
<p>å¿…é¡»åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œçš„æ“ä½œï¼Œæ‰§è¡Œä¹‹å‰ï¼Œéœ€è¦åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºä¸»èŠ‚ç‚¹ã€‚å¦‚æœä¸»èŠ‚ç‚¹å·²ç»é€‰ä¸¾å¥½ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œåˆ¤æ–­ã€‚ä½†æ˜¯ï¼Œä¸æ’é™¤ä¸»èŠ‚ç‚¹è¿˜æ²¡é€‰ä¸¾åˆ°ï¼Œå› è€Œéœ€è¦é˜»å¡ç­‰å¾…åˆ°ä¸»èŠ‚ç‚¹é€‰ä¸¾å®Œæˆåæ‰èƒ½è¿›è¡Œåˆ¤æ–­ã€‚</p>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LeaderService.java</span></div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦æ˜¯ä¸»èŠ‚ç‚¹.</div><div class="line">* </div><div class="line">* å¦‚æœä¸»èŠ‚ç‚¹æ­£åœ¨é€‰ä¸¾ä¸­è€Œå¯¼è‡´å–ä¸åˆ°ä¸»èŠ‚ç‚¹, åˆ™é˜»å¡è‡³ä¸»èŠ‚ç‚¹é€‰ä¸¾å®Œæˆå†è¿”å›.</div><div class="line">* </div><div class="line">* <span class="doctag">@return</span> å½“å‰èŠ‚ç‚¹æ˜¯å¦æ˜¯ä¸»èŠ‚ç‚¹</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLeaderUntilBlock</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ä¸å­˜åœ¨ä¸»èŠ‚ç‚¹ &amp;&amp; æœ‰å¯ç”¨çš„æœåŠ¡å™¨èŠ‚ç‚¹</span></div><div class="line">   <span class="keyword">while</span> (!hasLeader() &amp;&amp; serverService.hasAvailableServers()) &#123;</div><div class="line">       log.info(<span class="string">"Leader is electing, waiting for &#123;&#125; ms"</span>, <span class="number">100</span>);</div><div class="line">       BlockUtils.waitingShortTime();</div><div class="line">       <span class="keyword">if</span> (!JobRegistry.getInstance().isShutdown(jobName)</div><div class="line">               &amp;&amp; serverService.isAvailableServer(JobRegistry.getInstance().getJobInstance(jobName).getIp())) &#123; <span class="comment">// å½“å‰æœåŠ¡å™¨èŠ‚ç‚¹å¯ç”¨</span></div><div class="line">           electLeader();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è¿”å›å½“å‰èŠ‚ç‚¹æ˜¯å¦æ˜¯ä¸»èŠ‚ç‚¹</span></div><div class="line">   <span class="keyword">return</span> isLeader();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>BlockUtils#waitingShortTime()</code> æ–¹æ³•ï¼Œé€‰ä¸¾ä¸åˆ°ä¸»èŠ‚ç‚¹è¿›è¡Œç­‰å¾…ï¼Œé¿å…ä¸é—´æ–­ã€æ— é—´éš”çš„è¿›è¡Œä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‚</li>
</ul>
<h1 id="4-åˆ é™¤ä¸»èŠ‚ç‚¹"><a href="#4-åˆ é™¤ä¸»èŠ‚ç‚¹" class="headerlink" title="4. åˆ é™¤ä¸»èŠ‚ç‚¹"></a>4. åˆ é™¤ä¸»èŠ‚ç‚¹</h1><p>æœ‰ä¸»èŠ‚ç‚¹çš„é€‰ä¸¾ï¼Œå¿…ç„¶æœ‰ä¸»èŠ‚ç‚¹çš„åˆ é™¤ï¼Œå¦åˆ™æ€ä¹ˆè¿›è¡Œ<strong>é‡æ–°é€‰ä¸¾</strong>ã€‚</p>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LeaderService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ é™¤ä¸»èŠ‚ç‚¹ä¾›é‡æ–°é€‰ä¸¾.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeLeader</span><span class="params">()</span> </span>&#123;</div><div class="line">   jobNodeStorage.removeJobNodeIfExisted(LeaderNode.INSTANCE);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>åˆ é™¤ä¸»èŠ‚ç‚¹æ—¶æœº</strong></p>
<p><strong>ç¬¬ä¸€ç§</strong>ï¼Œä¸»èŠ‚ç‚¹è¿›ç¨‹<strong>æ­£å¸¸</strong>å…³é—­æ—¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobShutdownHookPlugin</span> <span class="keyword">extends</span> <span class="title">ShutdownHookPlugin</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line">        CoordinatorRegistryCenter regCenter = JobRegistry.getInstance().getRegCenter(jobName);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == regCenter) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        LeaderService leaderService = <span class="keyword">new</span> LeaderService(regCenter, jobName);</div><div class="line">        <span class="keyword">if</span> (leaderService.isLeader()) &#123;</div><div class="line">            leaderService.removeLeader(); <span class="comment">// ç§»é™¤ä¸»èŠ‚ç‚¹</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">new</span> InstanceService(regCenter, jobName).removeInstance();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£ï¼Œé€€å‡ºè¿›ç¨‹ï¼Œè‹¥è¯¥è¿›ç¨‹ä¸ºä¸»èŠ‚ç‚¹ï¼Œéœ€è¦å°†è‡ªå·±ç§»é™¤ã€‚</li>
</ul>
<p><strong>ç¬¬äºŒç§</strong>ï¼Œä¸»èŠ‚ç‚¹è¿›ç¨‹ CRASHED æ—¶ã€‚</p>
<p><code>${JOB_NAME}/leader/electron/instance</code> æ˜¯<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ï¼Œä¸»èŠ‚ç‚¹è¿›ç¨‹ CRASHED åï¼Œè¶…è¿‡æœ€å¤§ä¼šè¯æ—¶é—´ï¼ŒZookeeper è‡ªåŠ¨è¿›è¡Œåˆ é™¤ï¼Œè§¦å‘é‡æ–°é€‰ä¸¾é€»è¾‘ã€‚</p>
<p><strong>ç¬¬ä¸‰ç§</strong>ï¼Œä½œä¸šè¢«<strong>ç¦ç”¨</strong>æ—¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeaderAbdicationJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (leaderService.isLeader() &amp;&amp; isLocalServerDisabled(path, data)) &#123;</div><div class="line">           leaderService.removeLeader();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isLocalServerDisabled</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> serverNode.isLocalServerPath(path) &amp;&amp; ServerStatus.DISABLED.name().equals(data);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è¿™é‡Œå°±è§£ç­”ä¸Šé¢æˆ‘ä»¬é—ç•™çš„ç–‘é—®ã€‚è¢«ç¦ç”¨çš„ä½œä¸š<strong>æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯æ—¶</strong>å³ä½¿è¿›è¡Œäº†ä¸»èŠ‚ç‚¹é€‰ä¸¾ï¼Œä¹Ÿä¼šè¢«è¯¥ç›‘å¬å™¨å¤„ç†ï¼Œç§»é™¤è¯¥é€‰ä¸¾çš„ä¸»èŠ‚ç‚¹ã€‚</li>
</ul>
<p><strong>ç¬¬å››ç§</strong>ï¼Œä¸»èŠ‚ç‚¹è¿›ç¨‹<strong>è¿œç¨‹</strong>å…³é—­ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// InstanceShutdownStatusJobListener.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">InstanceShutdownStatusJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">        </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (!JobRegistry.getInstance().isShutdown(jobName)</div><div class="line">               &amp;&amp; !JobRegistry.getInstance().getJobScheduleController(jobName).isPaused() <span class="comment">// ä½œä¸šæœªæš‚åœè°ƒåº¦</span></div><div class="line">               &amp;&amp; isRemoveInstance(path, eventType) <span class="comment">// ç§»é™¤ã€è¿è¡Œå®ä¾‹ã€‘äº‹ä»¶</span></div><div class="line">               &amp;&amp; !isReconnectedRegistryCenter()) &#123; <span class="comment">// è¿è¡Œå®ä¾‹è¢«ç§»é™¤</span></div><div class="line">           schedulerFacade.shutdownInstance();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isRemoveInstance</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> instanceNode.isLocalInstancePath(path) &amp;&amp; Type.NODE_REMOVED == eventType;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isReconnectedRegistryCenter</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> instanceService.isLocalJobInstanceExisted();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SchedulerFacade.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ç»ˆæ­¢ä½œä¸šè°ƒåº¦.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdownInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (leaderService.isLeader()) &#123;</div><div class="line">       leaderService.removeLeader(); <span class="comment">// ç§»é™¤ä¸»èŠ‚ç‚¹</span></div><div class="line">   &#125;</div><div class="line">   monitorService.close();</div><div class="line">   <span class="keyword">if</span> (reconcileService.isRunning()) &#123;</div><div class="line">       reconcileService.stopAsync();</div><div class="line">   &#125;</div><div class="line">   JobRegistry.getInstance().shutdown(jobName);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>è¿œç¨‹</strong>å…³é—­ä½œä¸šèŠ‚ç‚¹æœ‰ä¸¤ç§æ–¹å¼ï¼š<ul>
<li>zkClient å‘èµ·å‘½ä»¤ï¼š<code>rmr /${NAMESPACE}/${JOB_NAME}/instances/${JOB_INSTANCE_ID}</code>ã€‚</li>
<li>è¿ç»´å¹³å°å‘èµ· <code>Shutdown</code> æ“ä½œã€‚<code>Shutdown</code> æ“ä½œå®è´¨ä¸Šå°±æ˜¯ç¬¬ä¸€ç§ã€‚<br>  <img src="http://www.yunai.me/images/Elastic-Job/2017_10_21/04.png" alt=""></li>
</ul>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šå“å“Ÿï¼Œè¿™æ¬¡ç«Ÿç„¶åˆ†äº«äº†ç‚¹å¹²è´§ ğŸ˜ˆ<br>èŠ‹é“å›ï¼šå˜¿å‘€å˜¿å‘€ï¼Œå¿…é¡»çš„å•Šï¼Œè™½ç„¶æœ‰ç‚¹ç„¦å¤´çƒ‚é¢å•¦ã€‚  </p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_21/03.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;&quot;&gt;2. ä¸ºä»€ä¹ˆéœ€è¦é€‰ä¸¾ä¸»èŠ‚ç‚¹&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;&quot;
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.yunai.me/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒç›‘å¬å™¨</title>
    <link href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper-listener/"/>
    <id>http://www.yunai.me/Elastic-Job/reg-center-zookeeper-listener/</id>
    <published>2017-10-13T16:00:00.000Z</published>
    <updated>2017-09-02T09:55:42.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ListenerManager</a></li>
<li><a href="#">3. AbstractListenerManager</a></li>
<li><a href="#">4. AbstractJobListener</a></li>
<li><a href="#">5. RegistryCenterConnectionStateListener</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite æ³¨å†Œä¸­å¿ƒç›‘å¬å™¨</strong>ã€‚</p>
<p>å»ºè®®å‰ç½®é˜…è¯»ï¼š</p>
<ul>
<li><a href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒã€‹</a></li>
</ul>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_10_14/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_14/01.png" alt=""></p>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-ListenerManager"><a href="#2-ListenerManager" class="headerlink" title="2. ListenerManager"></a>2. ListenerManager</h1><p>ListenerManagerï¼Œä½œä¸šæ³¨å†Œä¸­å¿ƒçš„ç›‘å¬å™¨ç®¡ç†è€…ã€‚ç®¡ç†è€…<strong>ä¸¤ç±»</strong>ç»„ä»¶ï¼š</p>
<ul>
<li>ç›‘å¬ç®¡ç†å™¨</li>
<li>æ³¨å†Œä¸­å¿ƒè¿æ¥çŠ¶æ€ç›‘å¬å™¨</li>
</ul>
<p>å…¶ä¸­<strong>ç›‘å¬ç®¡ç†å™¨</strong>ç®¡ç†ç€è‡ªå·±çš„ä½œä¸šæ³¨å†Œä¸­å¿ƒç›‘å¬å™¨ã€‚</p>
<p>ä¸€èµ·ä»ä»£ç å±‚é¢çœ‹çœ‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ListenerManager</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobNodeStorage jobNodeStorage;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ElectionListenerManager electionListenerManager;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ShardingListenerManager shardingListenerManager;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FailoverListenerManager failoverListenerManager;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MonitorExecutionListenerManager monitorExecutionListenerManager;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ShutdownListenerManager shutdownListenerManager;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TriggerListenerManager triggerListenerManager;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RescheduleListenerManager rescheduleListenerManager;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GuaranteeListenerManager guaranteeListenerManager;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RegistryCenterConnectionStateListener regCenterConnectionStateListener;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>ç¬¬ä¸€ç±»ï¼š<code>electionListenerManager</code> / <code>shardingListenerManager</code> / <code>failoverListenerManager</code> / <code>MonitorExecutionListenerManager</code> / <code>shutdownListenerManager</code> / <code>triggerListenerManager</code> / <code>rescheduleListenerManager</code> / <code>guaranteeListenerManager</code> æ˜¯ä¸åŒæœåŠ¡çš„<strong>ç›‘å¬ç®¡ç†å™¨</strong>ï¼Œéƒ½ç»§æ‰¿<strong>ä½œä¸šæ³¨å†Œä¸­å¿ƒçš„ç›‘å¬å™¨ç®¡ç†è€…çš„æŠ½è±¡ç±»</strong>( AbstractListenerManager )ã€‚æˆ‘ä»¬ä»¥ä¸‹ä¸€ç¯‡æ–‡ç« ä¼šæ¶‰åŠåˆ°çš„<strong>åˆ†ç‰‡ç›‘å¬ç®¡ç†å™¨</strong>( ShardingListenerManager ) æ¥ç…ç…å†…éƒ¨æ•´ä½“å®ç°ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ShardingListenerManager</span> <span class="keyword">extends</span> <span class="title">AbstractListenerManager</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        addDataListener(<span class="keyword">new</span> ShardingTotalCountChangedJobListener());</div><div class="line">        addDataListener(<span class="keyword">new</span> ListenServersChangedJobListener());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ShardingTotalCountChangedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">        <span class="comment">// .... çœç•¥æ–¹æ³•</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ListenServersChangedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">        <span class="comment">// .... çœç•¥æ–¹æ³•</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ShardingListenerManager å†…éƒ¨ç®¡ç†äº† ShardingTotalCountChangedJobListener / ListenServersChangedJobListener ä¸¤ä¸ªä½œä¸šæ³¨å†Œä¸­å¿ƒç›‘å¬å™¨ã€‚å…·ä½“ä½œä¸šæ³¨å†Œä¸­å¿ƒç›‘å¬å™¨æ˜¯ä»€ä¹ˆï¼Œæœ‰ä»€ä¹ˆç”¨é€”ï¼Œä¸‹æ–‡ä¼šè¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>ç¬¬äºŒç±»ï¼š<code>regCenterConnectionStateListener</code> æ˜¯æ³¨å†Œä¸­å¿ƒè¿æ¥çŠ¶æ€ç›‘å¬å™¨ã€‚ä¸‹æ–‡ä¹Ÿä¼šè¯¦ç»†è§£æã€‚</li>
</ul>
<p>åœ¨<a href="http://www.yunai.me/Elastic-Job/job-init?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆå§‹åŒ–ã€‹ã€Œ3.2.4ã€æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯</a>ï¼Œæˆ‘ä»¬çœ‹åˆ°ä½œä¸šåˆå§‹åŒ–æ—¶ï¼Œä¼šå¼€å¯æ‰€æœ‰æ³¨å†Œä¸­å¿ƒç›‘å¬å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerFacade.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> enabled ä½œä¸šæ˜¯å¦å¯ç”¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStartUpInfo</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> enabled)</span> </span>&#123;</div><div class="line">   <span class="comment">// å¼€å¯ æ‰€æœ‰ç›‘å¬å™¨</span></div><div class="line">   listenerManager.startAllListeners();</div><div class="line">   <span class="comment">// .... çœç•¥æ–¹æ³•</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ListenerManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å¼€å¯æ‰€æœ‰ç›‘å¬å™¨.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startAllListeners</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// å¼€å¯ ä¸åŒæœåŠ¡ç›‘å¬ç®¡ç†å™¨</span></div><div class="line">   electionListenerManager.start();</div><div class="line">   shardingListenerManager.start();</div><div class="line">   failoverListenerManager.start();</div><div class="line">   monitorExecutionListenerManager.start();</div><div class="line">   shutdownListenerManager.start();</div><div class="line">   triggerListenerManager.start();</div><div class="line">   rescheduleListenerManager.start();</div><div class="line">   guaranteeListenerManager.start();</div><div class="line">   <span class="comment">// å¼€å¯ æ³¨å†Œä¸­å¿ƒè¿æ¥çŠ¶æ€ç›‘å¬å™¨</span></div><div class="line">   jobNodeStorage.addConnectionStateListener(regCenterConnectionStateListener);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="3-AbstractListenerManager"><a href="#3-AbstractListenerManager" class="headerlink" title="3. AbstractListenerManager"></a>3. AbstractListenerManager</h1><p>AbstractListenerManagerï¼Œä½œä¸šæ³¨å†Œä¸­å¿ƒçš„ç›‘å¬å™¨ç®¡ç†è€…çš„<strong>æŠ½è±¡ç±»</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractListenerManager</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobNodeStorage jobNodeStorage;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">AbstractListenerManager</span><span class="params">(<span class="keyword">final</span> CoordinatorRegistryCenter regCenter, <span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">        jobNodeStorage = <span class="keyword">new</span> JobNodeStorage(regCenter, jobName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¼€å¯ç›‘å¬å™¨.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ·»åŠ æ³¨å†Œä¸­å¿ƒç›‘å¬å™¨</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> listener æ³¨å†Œä¸­å¿ƒç›‘å¬å™¨</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addDataListener</span><span class="params">(<span class="keyword">final</span> TreeCacheListener listener)</span> </span>&#123;</div><div class="line">        jobNodeStorage.addDataListener(listener);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#addDataListener()</code>ï¼Œå°†ä½œä¸šæ³¨å†Œä¸­å¿ƒçš„ç›‘å¬å™¨æ·»åŠ åˆ°æ³¨å†Œä¸­å¿ƒ TreeCache çš„ç›‘å¬è€…é‡Œã€‚<code>JobNodeStorage#addDataListener(...)</code> åœ¨<a href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆå§‹åŒ–ã€‹ã€Œ2.2ã€ç¼“å­˜</a>å·²ç»è¯¦ç»†è§£æã€‚</li>
<li><p>å­ç±»å®ç° <code>#start()</code> æ–¹æ³•å®ç°ç›‘å¬å™¨åˆå§‹åŒ–ã€‚ç›®å‰æ‰€æœ‰å­ç±»çš„å®ç°éƒ½æ˜¯å°†è‡ªå·±ç®¡ç†çš„æ³¨å†Œä¸­å¿ƒç›‘å¬å™¨è°ƒç”¨ <code>#addDataListener(...)</code>ï¼Œè¿˜æ˜¯ä»¥ ShardingListenerManager ä¸¾ä¾‹å­ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ShardingListenerManager</span> <span class="keyword">extends</span> <span class="title">AbstractListenerManager</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        addDataListener(<span class="keyword">new</span> ShardingTotalCountChangedJobListener());</div><div class="line">        addDataListener(<span class="keyword">new</span> ListenServersChangedJobListener());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="4-AbstractJobListener"><a href="#4-AbstractJobListener" class="headerlink" title="4. AbstractJobListener"></a>4. AbstractJobListener</h1><p>AbstractJobListenerï¼Œä½œä¸šæ³¨å†Œä¸­å¿ƒçš„ç›‘å¬å™¨<strong>æŠ½è±¡ç±»</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractJobListener</span> <span class="keyword">implements</span> <span class="title">TreeCacheListener</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">childEvent</span><span class="params">(<span class="keyword">final</span> CuratorFramework client, <span class="keyword">final</span> TreeCacheEvent event)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        ChildData childData = event.getData();</div><div class="line">        <span class="comment">// å¿½ç•¥æ‰éæ•°æ®å˜åŒ–çš„äº‹ä»¶ï¼Œä¾‹å¦‚ event.type ä¸º CONNECTION_SUSPENDEDã€CONNECTION_RECONNECTEDã€CONNECTION_LOSTã€INITIALIZED äº‹ä»¶</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == childData) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        String path = childData.getPath();</div><div class="line">        <span class="keyword">if</span> (path.isEmpty()) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        dataChanged(path, event.getType(), <span class="keyword">null</span> == childData.getData() ? <span class="string">""</span> : <span class="keyword">new</span> String(childData.getData(), Charsets.UTF_8));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * èŠ‚ç‚¹æ•°æ®å˜åŒ–</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> path èŠ‚ç‚¹è·¯å¾„</div><div class="line">     * <span class="doctag">@param</span> eventType äº‹ä»¶ç±»å‹</div><div class="line">     * <span class="doctag">@param</span> data æ•°æ®</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä½œä¸šæ³¨å†Œä¸­å¿ƒçš„ç›‘å¬å™¨<strong>å®ç°ç±»</strong>å®ç° <code>#dataChanged(...)</code>ï¼Œå¯¹èŠ‚ç‚¹æ•°æ®å˜åŒ–è¿›è¡Œå¤„ç†ã€‚</li>
<li><code>#childEvent(...)</code> å±è”½æ‰éèŠ‚ç‚¹æ•°æ®å˜åŒ–äº‹ä»¶ï¼Œä¾‹å¦‚ï¼šCONNECTION_SUSPENDEDã€CONNECTION_RECONNECTEDã€CONNECTION_LOSTã€INITIALIZED äº‹ä»¶ï¼Œåªå¤„ç† NODE_ADDEDã€NODE_UPDATEDã€NODE_REMOVED äº‹ä»¶ã€‚</li>
</ul>
<p>æˆ‘ä»¬å†æ‹¿ ShardingListenerManager ä¸¾ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ShardingListenerManager</span> <span class="keyword">extends</span> <span class="title">AbstractListenerManager</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ShardingTotalCountChangedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (configNode.isConfigPath(path) &amp;&amp; <span class="number">0</span> != JobRegistry.getInstance().getCurrentShardingTotalCount(jobName)) &#123;</div><div class="line">                <span class="keyword">int</span> newShardingTotalCount = LiteJobConfigurationGsonFactory.fromJson(data).getTypeConfig().getCoreConfig().getShardingTotalCount();</div><div class="line">                <span class="keyword">if</span> (newShardingTotalCount != JobRegistry.getInstance().getCurrentShardingTotalCount(jobName)) &#123;</div><div class="line">                    shardingService.setReshardingFlag();</div><div class="line">                    JobRegistry.getInstance().setCurrentShardingTotalCount(jobName, newShardingTotalCount);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ListenServersChangedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (!JobRegistry.getInstance().isShutdown(jobName) &amp;&amp; (isInstanceChange(eventType, path) || isServerChange(path))) &#123;</div><div class="line">                shardingService.setReshardingFlag();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isInstanceChange</span><span class="params">(<span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String path)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> instanceNode.isInstancePath(path) &amp;&amp; Type.NODE_UPDATED != eventType;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isServerChange</span><span class="params">(<span class="keyword">final</span> String path)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> serverNode.isServerPath(path);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>åœ¨<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä»»åŠ¡åˆ†ç‰‡ã€‹</a>è¯¦ç»†è§£æã€‚</li>
</ul>
<h1 id="5-RegistryCenterConnectionStateListener"><a href="#5-RegistryCenterConnectionStateListener" class="headerlink" title="5. RegistryCenterConnectionStateListener"></a>5. RegistryCenterConnectionStateListener</h1><p>RegistryCenterConnectionStateListenerï¼Œå®ç° Curator ConnectionStateListener æ¥å£ï¼Œæ³¨å†Œä¸­å¿ƒè¿æ¥çŠ¶æ€ç›‘å¬å™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistryCenterConnectionStateListener</span> <span class="keyword">implements</span> <span class="title">ConnectionStateListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stateChanged</span><span class="params">(<span class="keyword">final</span> CuratorFramework client, <span class="keyword">final</span> ConnectionState newState)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (JobRegistry.getInstance().isShutdown(jobName)) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        JobScheduleController jobScheduleController = JobRegistry.getInstance().getJobScheduleController(jobName);</div><div class="line">        <span class="keyword">if</span> (ConnectionState.SUSPENDED == newState || ConnectionState.LOST == newState) &#123; <span class="comment">// Zookeeper è¿æ¥ç»ˆç«¯ æˆ– è¿æ¥ä¸¢å¤±</span></div><div class="line">            <span class="comment">// æš‚åœä½œä¸šè°ƒåº¦</span></div><div class="line">            jobScheduleController.pauseJob();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ConnectionState.RECONNECTED == newState) &#123; <span class="comment">// Zookeeper é‡æ–°è¿ä¸Š</span></div><div class="line">            <span class="comment">// æŒä¹…åŒ–ä½œä¸šæœåŠ¡å™¨ä¸Šçº¿ä¿¡æ¯</span></div><div class="line">            serverService.persistOnline(serverService.isEnableServer(JobRegistry.getInstance().getJobInstance(jobName).getIp()));</div><div class="line">            <span class="comment">// æŒä¹…åŒ–ä½œä¸šè¿è¡Œå®ä¾‹ä¸Šçº¿ç›¸å…³ä¿¡æ¯</span></div><div class="line">            instanceService.persistOnline();</div><div class="line">            <span class="comment">// æ¸…é™¤æœ¬åœ°åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹è¿è¡Œä¸­çš„æ ‡è®°</span></div><div class="line">            executionService.clearRunningInfo(shardingService.getLocalShardingItems());</div><div class="line">            <span class="comment">// æ¢å¤ä½œä¸šè°ƒåº¦</span></div><div class="line">            jobScheduleController.resumeJob();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>å½“æ³¨å†Œä¸­å¿ƒè¿æ¥ SUSPENDED æˆ– LOST æ—¶ï¼Œæš‚åœ<strong>æœ¬åœ°</strong>ä½œä¸šè°ƒåº¦ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobScheduleController.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">pauseJob</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">if</span> (!scheduler.isShutdown()) &#123;</div><div class="line">           scheduler.pauseAll();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>å½“æ³¨å†Œä¸­å¿ƒé‡æ–°è¿æ¥æˆåŠŸ( RECONNECTED )ï¼Œæ¢å¤<strong>æœ¬åœ°</strong>ä½œä¸šè°ƒåº¦ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* æ¢å¤ä½œä¸š.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">resumeJob</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">if</span> (!scheduler.isShutdown()) &#123;</div><div class="line">          scheduler.resumeAll();</div><div class="line">      &#125;</div><div class="line">  &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šèŠ‹é“å›ï¼Œä½ åˆæ°´æ›´äº†ï¼<br>èŠ‹é“å›ï¼šæ˜¯æ˜¯æ˜¯ï¼Œæ˜¯æ˜¯æ˜¯ï¼</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_14/02.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ListenerManager&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a 
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.yunai.me/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ•°æ®å­˜å‚¨</title>
    <link href="http://www.yunai.me/Elastic-Job/job-storage/"/>
    <id>http://www.yunai.me/Elastic-Job/job-storage/</id>
    <published>2017-10-06T16:00:00.000Z</published>
    <updated>2017-09-02T09:55:35.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#1-%E6%A6%82%E8%BF%B0">1. æ¦‚è¿°</a></li>
<li><a href="#2-jobnodepath">2. JobNodePath</a></li>
<li><a href="#3-jobnodestorage">3. JobNodeStorage</a></li>
<li><a href="#4-configurationnode">4. ConfigurationNode</a></li>
<li><a href="#5-servernode">5. ServerNode</a></li>
<li><a href="#6-instancenode">6. InstanceNode</a></li>
<li><a href="#7-shardingnode">7. ShardingNode</a></li>
<li><a href="#8-leadernode">8. LeaderNode</a></li>
<li><a href="#9-failovernode">9. FailoverNode</a></li>
<li><a href="#10-guaranteenode">10. GuaranteeNode</a></li>
<li><a href="#666-%E5%BD%A9%E8%9B%8B">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šæ•°æ®å­˜å‚¨</strong>ã€‚</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_10_07/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_07/01.png" alt=""></p>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-JobNodePath"><a href="#2-JobNodePath" class="headerlink" title="2. JobNodePath"></a>2. JobNodePath</h1><p>JobNodePathï¼Œä½œä¸šèŠ‚ç‚¹è·¯å¾„ç±»ã€‚<strong>ä½œä¸šèŠ‚ç‚¹æ˜¯åœ¨æ™®é€šçš„èŠ‚ç‚¹å‰åŠ ä¸Šä½œä¸šåç§°çš„å‰ç¼€</strong>ã€‚</p>
<p>åœ¨ Zookeeper çœ‹ä¸€ä¸ªä½œä¸šçš„æ•°æ®å­˜å‚¨ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 65] ls /elastic-job-example-lite-java/javaSimpleJob</div><div class="line">[leader, servers, config, instances, sharding]</div></pre></td></tr></table></figure>
<ul>
<li><code>elastic-job-example-lite-java</code>ï¼šä½œä¸šèŠ‚ç‚¹é›†ç¾¤åï¼Œä½¿ç”¨ <code>ZookeeperConfiguration.namespace</code> å±æ€§é…ç½®ã€‚</li>
<li><code>javaSimpleJob</code>ï¼šä½œä¸šåå­—ï¼Œä½¿ç”¨ <code>JobCoreConfiguration.jobName</code> å±æ€§é…ç½®ã€‚</li>
<li><code>config</code> / <code>servers</code> / <code>instances</code> / <code>sharding</code> / <code>leader</code>ï¼šä¸åŒæœåŠ¡çš„æ•°æ®å­˜å‚¨èŠ‚ç‚¹è·¯å¾„ã€‚</li>
</ul>
<p>JobNodePathï¼Œæ³¨é‡Šå¾ˆæ˜“æ‡‚ï¼Œç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/7dc099541a16de49f024fc59e46377a726be7f6b/elastic-job-lite/elastic-job-lite-core/src/main/java/com/dangdang/ddframe/job/lite/internal/storage/JobNodePath.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ã€‚è¿™é‡Œæˆ‘ä»¬æ¢³ç†ä¸‹ JobNodePath å’Œ<strong>å…¶å®ƒèŠ‚ç‚¹è·¯å¾„ç±»</strong>çš„å…³ç³»ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">Zookeeper è·¯å¾„</th>
<th style="text-align:left">JobNodePath é™æ€å±æ€§</th>
<th style="text-align:left">JobNodePath æ–¹æ³•</th>
<th style="text-align:left">èŠ‚ç‚¹è·¯å¾„ç±»</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>config</code></td>
<td style="text-align:left">CONFIG_NODE</td>
<td style="text-align:left"><code>#getConfigNodePath()</code></td>
<td style="text-align:left">ConfigurationNode</td>
</tr>
<tr>
<td style="text-align:left"><code>servers</code></td>
<td style="text-align:left">SERVERS_NODE</td>
<td style="text-align:left"><code>#getServerNodePath()</code></td>
<td style="text-align:left">ServerNode</td>
</tr>
<tr>
<td style="text-align:left"><code>instances</code></td>
<td style="text-align:left">INSTANCES_NODE</td>
<td style="text-align:left"><code>#getInstancesNodePath()</code></td>
<td style="text-align:left">InstanceNode</td>
</tr>
<tr>
<td style="text-align:left"><code>sharding</code></td>
<td style="text-align:left">SHARDING_NODE</td>
<td style="text-align:left"><code>#getShardingNodePath()</code></td>
<td style="text-align:left">ShardingNode</td>
</tr>
<tr>
<td style="text-align:left"><code>leader</code></td>
<td style="text-align:left">/</td>
<td style="text-align:left"><code>#getFullPath(node)</code></td>
<td style="text-align:left">LeaderNode</td>
</tr>
<tr>
<td style="text-align:left"><code>leader/failover</code></td>
<td style="text-align:left">/</td>
<td style="text-align:left"><code>#getFullPath(node)</code></td>
<td style="text-align:left">FailoverNode</td>
</tr>
<tr>
<td style="text-align:left"><code>guarantee</code></td>
<td style="text-align:left">/</td>
<td style="text-align:left"><code>#getFullPath(node)</code></td>
<td style="text-align:left">GuaranteeNode</td>
</tr>
</tbody>
</table>
<h1 id="3-JobNodeStorage"><a href="#3-JobNodeStorage" class="headerlink" title="3. JobNodeStorage"></a>3. JobNodeStorage</h1><p>JobNodeStorageï¼Œä½œä¸šèŠ‚ç‚¹æ•°æ®è®¿é—®ç±»ã€‚</p>
<p>Elastic-Job-Lite ä½¿ç”¨<strong>æ³¨å†Œä¸­å¿ƒ</strong>å­˜å‚¨ä½œä¸šèŠ‚ç‚¹æ•°æ®ï¼ŒJobNodeStorage å¯¹æ³¨å†Œä¸­å¿ƒæä¾›çš„æ–¹æ³•åšä¸‹ç®€å•çš„å°è£…æä¾›è°ƒç”¨ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobNodeStorage.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> CoordinatorRegistryCenter regCenter;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> JobNodePath jobNodePath;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ¤æ–­ä½œä¸šèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> node ä½œä¸šèŠ‚ç‚¹åç§°</div><div class="line">* <span class="doctag">@return</span> ä½œä¸šèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isJobNodeExisted</span><span class="params">(<span class="keyword">final</span> String node)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> regCenter.isExisted(jobNodePath.getFullPath(node));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobNodePath.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–èŠ‚ç‚¹å…¨è·¯å¾„.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> node èŠ‚ç‚¹åç§°</div><div class="line">* <span class="doctag">@return</span> èŠ‚ç‚¹å…¨è·¯å¾„</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getFullPath</span><span class="params">(<span class="keyword">final</span> String node)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> String.format(<span class="string">"/%s/%s"</span>, jobName, node);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä¼ é€’çš„å‚æ•° <code>node</code> åªæ˜¯ç®€å•çš„<strong>ä½œä¸šèŠ‚ç‚¹åç§°</strong>ï¼Œé€šè¿‡è°ƒç”¨ <code>JobNodePath#getFullPath(...)</code> æ–¹æ³•è·å–èŠ‚ç‚¹å…¨è·¯å¾„ã€‚</li>
<li>å…¶å®ƒæ–¹æ³•ç±»ä¼¼ï¼Œæœ‰å…´è¶£çš„åŒå­¦ç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/7dc099541a16de49f024fc59e46377a726be7f6b/elastic-job-lite/elastic-job-lite-core/src/main/java/com/dangdang/ddframe/job/lite/internal/storage/JobNodePath.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ã€‚</li>
</ul>
<h1 id="4-ConfigurationNode"><a href="#4-ConfigurationNode" class="headerlink" title="4. ConfigurationNode"></a>4. ConfigurationNode</h1><p>ConfigurationNodeï¼Œé…ç½®èŠ‚ç‚¹è·¯å¾„ã€‚</p>
<p>åœ¨ Zookeeper çœ‹ä¸€ä¸ªä½œä¸šçš„<strong>é…ç½®</strong>èŠ‚ç‚¹æ•°æ®å­˜å‚¨ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 67] get /elastic-job-example-lite-java/javaSimpleJob/config</div><div class="line">&#123;<span class="string">"jobName"</span>:<span class="string">"javaSimpleJob"</span>,<span class="string">"jobClass"</span>:<span class="string">"com.dangdang.ddframe.job.example.job.simple.JavaSimpleJob"</span>,<span class="string">"jobType"</span>:<span class="string">"SIMPLE"</span>,<span class="string">"cron"</span>:<span class="string">"0/5 * * * * ?"</span>,<span class="string">"shardingTotalCount"</span>:3,<span class="string">"shardingItemParameters"</span>:<span class="string">"0\u003dBeijing,1\u003dShanghai,2\u003dGuangzhou"</span>,<span class="string">"jobParameter"</span>:<span class="string">""</span>,<span class="string">"failover"</span>:<span class="literal">true</span>,<span class="string">"misfire"</span>:<span class="literal">true</span>,<span class="string">"description"</span>:<span class="string">""</span>,<span class="string">"jobProperties"</span>:&#123;<span class="string">"job_exception_handler"</span>:<span class="string">"com.dangdang.ddframe.job.executor.handler.impl.DefaultJobExceptionHandler"</span>,<span class="string">"executor_service_handler"</span>:<span class="string">"com.dangdang.ddframe.job.executor.handler.impl.DefaultExecutorServiceHandler"</span>&#125;,<span class="string">"monitorExecution"</span>:<span class="literal">true</span>,<span class="string">"maxTimeDiffSeconds"</span>:-1,<span class="string">"monitorPort"</span>:-1,<span class="string">"jobShardingStrategyClass"</span>:<span class="string">""</span>,<span class="string">"reconcileIntervalMinutes"</span>:10,<span class="string">"disabled"</span>:<span class="literal">false</span>,<span class="string">"overwrite"</span>:<span class="literal">true</span>&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>/config</code> æ˜¯<strong>æŒä¹…</strong>èŠ‚ç‚¹ï¼Œå­˜å‚¨Liteä½œä¸šé…ç½®( LiteJobConfiguration ) JSONåŒ–å­—ç¬¦ä¸²ã€‚</li>
</ul>
<p>ConfigurationNode ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigurationNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = <span class="string">"config"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ConfigurationNode å¦‚ä½•è¯»å–ã€å­˜å‚¨ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-config/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹çš„ã€Œ3.ã€ä½œä¸šé…ç½®æœåŠ¡</a>å·²ç»è¯¦ç»†è§£æã€‚</p>
<h1 id="5-ServerNode"><a href="#5-ServerNode" class="headerlink" title="5. ServerNode"></a>5. ServerNode</h1><p>ServerNodeï¼ŒæœåŠ¡å™¨èŠ‚ç‚¹è·¯å¾„ã€‚</p>
<p>åœ¨ Zookeeper çœ‹ä¸€ä¸ªä½œä¸šçš„<strong>æœåŠ¡å™¨</strong>èŠ‚ç‚¹æ•°æ®å­˜å‚¨ï¼š </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 72] ls /elastic-job-example-lite-java/javaSimpleJob/servers</div><div class="line">[192.168.16.164, 169.254.93.156, 192.168.252.57, 192.168.16.137, 192.168.3.2, 192.168.43.31]</div><div class="line">[zk: localhost:2181(CONNECTED) 73] get /elastic-job-example-lite-java/javaSimpleJob/servers/192.168.16.164</div></pre></td></tr></table></figure>
<ul>
<li><code>/servers/</code> ç›®å½•ä¸‹ä»¥ <code>IP</code> ä¸ºæ•°æ®èŠ‚ç‚¹è·¯å¾„å­˜å‚¨æ¯ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ã€‚å¦‚æœ<strong>ç›¸åŒIP</strong>æœåŠ¡å™¨æœ‰å¤šä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ï¼Œåªå­˜å‚¨ä¸€ä¸ª <code>IP</code> æ•°æ®èŠ‚ç‚¹ã€‚</li>
<li><code>/servers/${IP}</code> æ˜¯<strong>æŒä¹…</strong>èŠ‚ç‚¹ï¼Œä¸å­˜å‚¨ä»»ä½•ä¿¡æ¯ï¼Œåªæ˜¯ç©ºä¸²( <code>&quot;&quot;</code>);</li>
</ul>
<p>ServerNode ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æœåŠ¡å™¨ä¿¡æ¯æ ¹èŠ‚ç‚¹.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = <span class="string">"servers"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVERS = ROOT + <span class="string">"/%s"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ServerNode å¦‚ä½•å­˜å‚¨ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-init/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆå§‹åŒ–ã€‹çš„ã€Œ3.2.4ã€æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯</a>å·²ç»è¯¦ç»†è§£æã€‚</p>
<h1 id="6-InstanceNode"><a href="#6-InstanceNode" class="headerlink" title="6. InstanceNode"></a>6. InstanceNode</h1><p>InstanceNodeï¼Œè¿è¡Œå®ä¾‹èŠ‚ç‚¹è·¯å¾„ã€‚</p>
<p>åœ¨ Zookeeper çœ‹ä¸€ä¸ªä½œä¸šçš„<strong>è¿è¡Œå®ä¾‹</strong>èŠ‚ç‚¹æ•°æ®å­˜å‚¨ï¼š </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 81] ls /elastic-job-example-lite-java/javaSimpleJob/instances</div><div class="line">[192.168.16.137@-@56010]</div><div class="line">[zk: localhost:2181(CONNECTED) 82] get /elastic-job-example-lite-java/javaSimpleJob/instances</div></pre></td></tr></table></figure>
<ul>
<li><code>/instances</code> ç›®å½•ä¸‹ä»¥ä½œä¸šå®ä¾‹ä¸»é”®( <code>JOB_INSTANCE_ID</code> ) ä¸ºæ•°æ®èŠ‚ç‚¹è·¯å¾„å­˜å‚¨æ¯ä¸ªè¿è¡Œå®ä¾‹èŠ‚ç‚¹ã€‚</li>
<li><code>/instances/${JOB_INSTANCE_ID}</code> æ˜¯<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ï¼Œä¸å­˜å‚¨ä»»ä½•ä¿¡æ¯ï¼Œåªæ˜¯ç©ºä¸²( <code>&quot;&quot;</code>);</li>
<li><p><code>JOB_INSTANCE_ID</code> ç”Ÿæˆæ–¹å¼ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobInstance.java</span></div><div class="line"></div><div class="line">jobInstanceId = IpUtils.getIp()</div><div class="line">                + DELIMITER</div><div class="line">                + ManagementFactory.getRuntimeMXBean().getName().split(<span class="string">"@"</span>)[<span class="number">0</span>]; <span class="comment">// PID</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>InstanceNode ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InstanceNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¿è¡Œå®ä¾‹ä¿¡æ¯æ ¹èŠ‚ç‚¹.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = <span class="string">"instances"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String INSTANCES = ROOT + <span class="string">"/%s"</span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–å½“å‰è¿è¡Œå®ä¾‹èŠ‚ç‚¹è·¯å¾„</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> å½“å‰è¿è¡Œå®ä¾‹èŠ‚ç‚¹è·¯å¾„</div><div class="line">     */</div><div class="line">    <span class="function">String <span class="title">getLocalInstanceNode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> String.format(INSTANCES, JobRegistry.getInstance().getJobInstance(jobName).getJobInstanceId());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>InstanceNode å¦‚ä½•å­˜å‚¨ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-init/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆå§‹åŒ–ã€‹çš„ã€Œ3.2.4ã€æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯</a>å·²ç»è¯¦ç»†è§£æã€‚</p>
<h1 id="7-ShardingNode"><a href="#7-ShardingNode" class="headerlink" title="7. ShardingNode"></a>7. ShardingNode</h1><p>ShardingNodeï¼Œåˆ†ç‰‡èŠ‚ç‚¹è·¯å¾„ã€‚</p>
<p>åœ¨ Zookeeper çœ‹ä¸€ä¸ªä½œä¸šçš„<strong>åˆ†ç‰‡</strong>èŠ‚ç‚¹æ•°æ®å­˜å‚¨ï¼š </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 1] ls /elastic-job-example-lite-java/javaSimpleJob/sharding</div><div class="line">[0, 1, 2]</div><div class="line">[zk: localhost:2181(CONNECTED) 2] ls /elastic-job-example-lite-java/javaSimpleJob/sharding/0</div><div class="line">[running, instance, misfire]</div><div class="line">[zk: localhost:2181(CONNECTED) 3] get /elastic-job-example-lite-java/javaSimpleJob/sharding/0/instance</div><div class="line">192.168.16.137@-@56010</div></pre></td></tr></table></figure>
<ul>
<li><code>/sharding/${ITEM_ID}</code> ç›®å½•ä¸‹ä»¥ä½œä¸šåˆ†ç‰‡é¡¹åºå·( <code>ITEM_ID</code> ) ä¸ºæ•°æ®èŠ‚ç‚¹è·¯å¾„å­˜å‚¨ä½œä¸šåˆ†ç‰‡é¡¹çš„ <code>instance</code> / <code>running</code> / <code>misfire</code> / <code>disable</code> <strong>æ•°æ®èŠ‚ç‚¹</strong>ä¿¡æ¯ã€‚</li>
<li><code>/sharding/${ITEM_ID}/instance</code> æ˜¯<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ï¼Œå­˜å‚¨è¯¥ä½œä¸šåˆ†ç‰‡é¡¹<strong>åˆ†é…åˆ°çš„ä½œä¸šå®ä¾‹ä¸»é”®</strong>( <code>JOB_INSTANCE_ID</code> )ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a>è¯¦ç»†è§£æã€‚</li>
<li><code>/sharding/${ITEM_ID}/running</code> æ˜¯<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ï¼Œå½“è¯¥ä½œä¸šåˆ†ç‰‡é¡¹<strong>æ­£åœ¨è¿è¡Œ</strong>ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ï¼›å½“è¯¥ä½œä¸šåˆ†ç‰‡é¡¹<strong>ä¸åœ¨è¿è¡Œ</strong>ï¼Œç§»é™¤è¯¥æ•°æ®èŠ‚ç‚¹ã€‚<a href="http://www.yunai.me/Elastic-Job/job-init/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹çš„ã€Œ4.6ã€æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸š</a>å·²ç»è¯¦ç»†è§£æã€‚</li>
<li><code>/sharding/${ITEM_ID}/misfire</code> æ˜¯<strong>æ°¸ä¹…èŠ‚ç‚¹</strong>ï¼Œå½“è¯¥ä½œä¸šåˆ†ç‰‡é¡¹<strong>è¢«é”™è¿‡æ‰§è¡Œ</strong>ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ï¼›å½“è¯¥ä½œä¸šåˆ†ç‰‡é¡¹é‡æ–°æ‰§è¡Œï¼Œç§»é™¤è¯¥æ•°æ®èŠ‚ç‚¹ã€‚<a href="http://www.yunai.me/Elastic-Job/job-init/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹çš„ã€Œ4.7ã€æ‰§è¡Œè¢«é”™è¿‡è§¦å‘çš„ä½œä¸š</a>å·²ç»è¯¦ç»†è§£æã€‚</li>
<li><code>/sharding/${ITEM_ID}/disable</code> æ˜¯<strong>æ°¸ä¹…èŠ‚ç‚¹</strong>ï¼Œå½“è¯¥ä½œä¸šåˆ†ç‰‡é¡¹<strong>è¢«ç¦ç”¨</strong>ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ï¼›å½“è¯¥ä½œä¸šåˆ†ç‰‡é¡¹<strong>è¢«å¼€å¯</strong>ï¼Œç§»é™¤æ•°æ®èŠ‚ç‚¹ã€‚</li>
</ul>
<p>ShardingNodeï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ShardingNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰§è¡ŒçŠ¶æ€æ ¹èŠ‚ç‚¹.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = <span class="string">"sharding"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String INSTANCE_APPENDIX = <span class="string">"instance"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String INSTANCE = ROOT + <span class="string">"/%s/"</span> + INSTANCE_APPENDIX;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String RUNNING_APPENDIX = <span class="string">"running"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String RUNNING = ROOT + <span class="string">"/%s/"</span> + RUNNING_APPENDIX;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String MISFIRE = ROOT + <span class="string">"/%s/misfire"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String DISABLED = ROOT + <span class="string">"/%s/disabled"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String LEADER_ROOT = LeaderNode.ROOT + <span class="string">"/"</span> + ROOT;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String NECESSARY = LEADER_ROOT + <span class="string">"/necessary"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String PROCESSING = LEADER_ROOT + <span class="string">"/processing"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>LEADER_ROOT / NECESSARY / PROCESSING æ”¾åœ¨ã€Œ4.7ã€<strong>LeaderNode</strong> è§£æã€‚</li>
</ul>
<h1 id="8-LeaderNode"><a href="#8-LeaderNode" class="headerlink" title="8. LeaderNode"></a>8. LeaderNode</h1><p>LeaderNodeï¼Œä¸»èŠ‚ç‚¹è·¯å¾„ã€‚</p>
<p>åœ¨ <code>leader</code> ç›®å½•ä¸‹ä¸€å…±æœ‰ä¸‰ä¸ªå­˜å‚¨å­èŠ‚ç‚¹ï¼š</p>
<ul>
<li><code>election</code>ï¼šä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‚</li>
<li><code>sharding</code>ï¼šä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…ã€‚</li>
<li><code>failover</code>ï¼šä½œä¸šå¤±æ•ˆè½¬ç§»ã€‚</li>
</ul>
<p><strong>ä¸»èŠ‚ç‚¹é€‰ä¸¾</strong></p>
<p>åœ¨ Zookeeper çœ‹ä¸€ä¸ªä½œä¸šçš„ <strong><code>leader/election</code></strong> èŠ‚ç‚¹æ•°æ®å­˜å‚¨ï¼š </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 1] ls /elastic-job-example-lite-java/javaSimpleJob/leader/election</div><div class="line">[latch, instance]</div><div class="line">[zk: localhost:2181(CONNECTED) 2] get /elastic-job-example-lite-java/javaSimpleJob/leader/election/instance</div><div class="line">192.168.16.137@-@1910</div></pre></td></tr></table></figure>
<ul>
<li><code>/leader/election/instance</code> æ˜¯<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ï¼Œå½“ä½œä¸šé›†ç¾¤å®Œæˆé€‰ä¸¾åï¼Œå­˜å‚¨ä¸»ä½œä¸šå®ä¾‹ä¸»é”®( <code>JOB_INSTANCE_ID</code> )ã€‚</li>
<li><code>/leader/election/latch</code> ä¸»èŠ‚ç‚¹é€‰ä¸¾åˆ†å¸ƒå¼é”ï¼Œæ˜¯ Apache Curator é’ˆå¯¹ Zookeeper å®ç°çš„<strong>åˆ†å¸ƒå¼é”</strong>çš„ä¸€ç§ï¼Œç¬”è€…æš‚æœªäº†è§£å­˜å‚¨å½¢å¼ï¼Œæ— æ³•è§£é‡Šã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒã€‹çš„ã€Œ3.1ã€åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œ</a>è¿›è¡Œäº†ç®€å•è§£æã€‚</li>
</ul>
<p><strong>ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…</strong></p>
<p>åœ¨ Zookeeper çœ‹ä¸€ä¸ªä½œä¸šçš„ <strong><code>leader/sharding</code></strong> èŠ‚ç‚¹æ•°æ®å­˜å‚¨ï¼š </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 1] ls /elastic-job-example-lite-java/javaSimpleJob/leader/sharding</div><div class="line">[necessary, processing]</div><div class="line">[zk: localhost:2181(CONNECTED) 2] ä¸ªget /elastic-job-example-lite-java/javaSimpleJob/leader/sharding</div><div class="line"></div><div class="line">[zk: localhost:2181(CONNECTED) 3] ä¸ªget /elastic-job-example-lite-java/javaSimpleJob/leader/processing</div></pre></td></tr></table></figure>
<ul>
<li><code>/leader/sharding/necessary</code> æ˜¯<strong>æ°¸ä¹…èŠ‚ç‚¹</strong>ï¼Œå½“<strong>ç›¸åŒä½œä¸š</strong>æœ‰æ–°çš„ä½œä¸šèŠ‚ç‚¹åŠ å…¥æˆ–è€…ç§»é™¤æ—¶ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ï¼Œæ ‡è®°éœ€è¦è¿›è¡Œä½œä¸šåˆ†ç‰‡é¡¹é‡æ–°åˆ†é…ï¼›å½“é‡æ–°åˆ†é…å®Œæˆåï¼Œç§»é™¤è¯¥æ•°æ®èŠ‚ç‚¹ã€‚</li>
<li><code>/leader/sharding/processing</code> æ˜¯<strong>ä¸´æ—¶èŠ‚ç‚¹</strong>ï¼Œå½“å¼€å§‹é‡æ–°åˆ†é…ä½œä¸šåˆ†ç‰‡é¡¹æ—¶ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ï¼Œæ ‡è®°æ­£åœ¨è¿›è¡Œé‡æ–°åˆ†é…ï¼›å½“é‡æ–°åˆ†é…å®Œæˆåï¼Œç§»é™¤è¯¥æ•°æ®èŠ‚ç‚¹ã€‚</li>
<li>å½“ä¸”ä»…å½“ä½œä¸šèŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹æ—¶ï¼Œæ‰å¯ä»¥æ‰§è¡Œä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…ï¼Œ<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a>è¯¦ç»†è§£æã€‚</li>
</ul>
<p><strong>ä½œä¸šå¤±æ•ˆè½¬ç§»</strong></p>
<p>ä½œä¸šå¤±æ•ˆè½¬ç§»æ•°æ®èŠ‚ç‚¹åœ¨ FailoverNodeï¼Œæ”¾åœ¨ã€Œ9ã€<strong>FailoverNode</strong> è§£æã€‚</p>
<p>è¿™é‡Œå¤§å®¶å¯èƒ½ä¼šå’Œæˆ‘ä¸€æ ·æ¯”è¾ƒç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆ <code>/leader/failover</code> æ”¾åœ¨ <code>/leader</code> ç›®å½•ä¸‹ï¼Œè€Œä¸ç‹¬ç«‹æˆä¸ºä¸€ä¸ªæ ¹ç›®å½•ï¼Ÿç»è¿‡ç¡®è®¤ï¼Œ<strong>ä½œä¸šå¤±æ•ˆè½¬ç§»</strong> è®¾è®¡åˆ°åˆ†å¸ƒå¼é”ï¼Œç»Ÿä¸€å­˜å‚¨åœ¨ <code>/leader</code> ç›®å½•ä¸‹ã€‚</p>
<hr>
<p>LeaderNodeï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LeaderNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸»èŠ‚ç‚¹æ ¹è·¯å¾„.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = <span class="string">"leader"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ELECTION_ROOT = ROOT + <span class="string">"/election"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String INSTANCE = ELECTION_ROOT + <span class="string">"/instance"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String  LATCH = ELECTION_ROOT + <span class="string">"/latch"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="9-FailoverNode"><a href="#9-FailoverNode" class="headerlink" title="9. FailoverNode"></a>9. FailoverNode</h1><p>FailoverNodeï¼Œå¤±æ•ˆè½¬ç§»èŠ‚ç‚¹è·¯å¾„ã€‚</p>
<p>åœ¨ Zookeeper çœ‹ä¸€ä¸ªä½œä¸šçš„<strong>å¤±æ•ˆè½¬ç§»</strong>èŠ‚ç‚¹æ•°æ®å­˜å‚¨ï¼š </p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">[zk: localhost:<span class="number">2181</span>(CONNECTED) <span class="number">2</span>] ls /elastic-job-example-lite-java/javaSimpleJob/leader/failover</div><div class="line">[latch, items]</div><div class="line">[zk: localhost:<span class="number">2181</span>(CONNECTED) <span class="number">4</span>] ls /elastic-job-example-lite-java/javaSimpleJob/leader/failover/items</div><div class="line">[<span class="number">0</span>]</div></pre></td></tr></table></figure>
<ul>
<li><code>/leader/failover/latch</code> ä½œä¸šå¤±æ•ˆè½¬ç§»åˆ†å¸ƒå¼é”ï¼Œå’Œ <code>/leader/failover/latch</code> æ˜¯ä¸€è‡´çš„ã€‚</li>
<li><code>/leader/items/${ITEM_ID}</code> æ˜¯<strong>æ°¸ä¹…èŠ‚ç‚¹</strong>ï¼Œå½“æŸå°ä½œä¸šèŠ‚ç‚¹ CRASH æ—¶ï¼Œå…¶åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹æ ‡è®°éœ€è¦è¿›è¡Œå¤±æ•ˆè½¬ç§»ï¼Œå­˜å‚¨å…¶åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹çš„ <code>/leader/items/${ITEM_ID}</code> ä¸ºç©ºä¸²( <code>&quot;&quot;</code> )ï¼›å½“å¤±æ•ˆè½¬ç§»æ ‡è®°ï¼Œç§»é™¤ <code>/leader/items/${ITEM_ID}</code>ï¼Œå­˜å‚¨ <code>/sharding/${ITEM_ID}/failover</code> ä¸ºç©ºä¸²( <code>&quot;&quot;</code> )ï¼Œ<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ï¼Œéœ€è¦è¿›è¡Œå¤±æ•ˆè½¬ç§»æ‰§è¡Œã€‚<a href="http://www.yunai.me/Elastic-Job/job-failover/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>è¯¦ç»†è§£æã€‚</li>
</ul>
<p>FailoverNode ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FailoverNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String FAILOVER = <span class="string">"failover"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String LEADER_ROOT = LeaderNode.ROOT + <span class="string">"/"</span> + FAILOVER;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ITEMS_ROOT = LEADER_ROOT + <span class="string">"/items"</span>;</div><div class="line">        </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ITEMS = ITEMS_ROOT + <span class="string">"/%s"</span>;</div><div class="line">        </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String LATCH = LEADER_ROOT + <span class="string">"/latch"</span>;</div><div class="line">        </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXECUTION_FAILOVER = ShardingNode.ROOT + <span class="string">"/%s/"</span> + FAILOVER;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">getItemsNode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> item)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> String.format(ITEMS, item);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">getExecutionFailoverNode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> item)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> String.format(EXECUTION_FAILOVER, item);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="10-GuaranteeNode"><a href="#10-GuaranteeNode" class="headerlink" title="10. GuaranteeNode"></a>10. GuaranteeNode</h1><p>GuaranteeNodeï¼Œä¿è¯åˆ†å¸ƒå¼ä»»åŠ¡å…¨éƒ¨å¼€å§‹å’Œç»“æŸçŠ¶æ€èŠ‚ç‚¹è·¯å¾„ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-listener/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šç›‘å¬å™¨ã€‹</a>è¯¦ç»†è§£æã€‚</p>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šèŠ‹é“å›ï¼Œä½ åˆæ°´æ›´äº†ï¼<br>èŠ‹é“å›ï¼šå±å±å±ï¼ŒåŠ³èµ„æ€¼æ­»ä½ ï¼å¦‚ä¸‹æ˜¯ä½œä¸šæ•°æ®å­˜å‚¨æ•´ç†ï¼Œå“¼å“¼å“ˆå…®ï¼</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_07/02.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-%E6%A6%82%E8%BF%B0&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-jobnodepath&quot;&gt;2.
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.yunai.me/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒ</title>
    <link href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper/"/>
    <id>http://www.yunai.me/Elastic-Job/reg-center-zookeeper/</id>
    <published>2017-09-29T16:00:00.000Z</published>
    <updated>2017-09-02T09:55:30.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. åŸºäº Zookeeper æ³¨å†Œä¸­å¿ƒ</a><ul>
<li><a href="#">2.1 åˆå§‹åŒ–</a></li>
<li><a href="#">2.2 ç¼“å­˜</a></li>
<li><a href="#">2.3 å…³é—­</a></li>
<li><a href="#">2.4 è·å¾—æ•°æ®</a></li>
<li><a href="#">2.5 è·å¾—æ³¨å†Œå­èŠ‚ç‚¹</a></li>
<li><a href="#">2.6 å­˜å‚¨æ³¨å†Œæ•°æ®</a></li>
<li><a href="#">2.7 å­˜å‚¨é¡ºåºæ³¨å†Œæ•°æ®</a></li>
<li><a href="#">2.8 ç§»é™¤æ³¨å†Œæ•°æ®</a></li>
<li><a href="#">2.9 è·å–æ³¨å†Œä¸­å¿ƒå½“å‰æ—¶é—´</a></li>
<li><a href="#">2.10 æ³¨å†Œä¸­å¿ƒå¼‚å¸¸å¤„ç†å™¨</a></li>
</ul>
</li>
<li><a href="#">3. ä½œä¸šèŠ‚ç‚¹æ•°æ®è®¿é—®ç±»</a><ul>
<li><a href="#">3.1 åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œ</a></li>
<li><a href="#">3.2 åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite æ³¨å†Œä¸­å¿ƒ</strong>ã€‚</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_09_30/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_09_30/01.png" alt=""></p>
<ul>
<li><strong>é»„è‰²</strong>çš„ç±»åœ¨ <code>elastic-job-common-core</code> é¡¹ç›®é‡Œï¼Œä¸º Elastic-Job-Liteã€Elastic-Job-Cloud <strong>å…¬ç”¨</strong>æ³¨å†Œä¸­å¿ƒç±»ã€‚</li>
<li>ä½œä¸šèŠ‚ç‚¹æ•°æ®è®¿é—®ç±»( JobNodeStorage )çš„<strong>åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œ</strong>ã€<strong>åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ</strong>ä¸¤ä¸ªæ–¹æ³•å’Œæ³¨å†Œä¸­å¿ƒ<strong>åè°ƒåˆ†å¸ƒå¼æœåŠ¡</strong>æœ‰å…³ç³»ï¼Œä»<a href="http://www.yunai.me/Elastic-Job/job-storage/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ•°æ®å­˜å‚¨ã€‹</a>æ‘˜å‡ºæ¥ï¼Œæ”¾æœ¬æ–‡è§£æã€‚</li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-åŸºäº-Zookeeper-æ³¨å†Œä¸­å¿ƒ"><a href="#2-åŸºäº-Zookeeper-æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="2. åŸºäº Zookeeper æ³¨å†Œä¸­å¿ƒ"></a>2. åŸºäº Zookeeper æ³¨å†Œä¸­å¿ƒ</h1><p>ZookeeperRegistryCenterï¼ŒåŸºäº Zookeeper æ³¨å†Œä¸­å¿ƒã€‚ä»ä¸Šé¢çš„ç±»å›¾å¯ä»¥çœ‹åˆ°ï¼ŒZookeeperRegistryCenter å®ç° CoordinatorRegistryCenter æ¥å£ï¼ŒCoordinatorRegistryCenter ç»§æ‰¿ RegistryCenter æ¥å£ã€‚</p>
<ul>
<li>RegistryCenterï¼Œæ³¨å†Œä¸­å¿ƒï¼Œå®šä¹‰äº†ç®€å•çš„å¢åˆ æ”¹æŸ¥æ³¨å†Œæ•°æ®å’ŒæŸ¥è¯¢æ—¶é—´çš„æ¥å£æ–¹æ³•ã€‚</li>
<li>CoordinatorRegistryCenterï¼Œç”¨äºåè°ƒåˆ†å¸ƒå¼æœåŠ¡çš„æ³¨å†Œä¸­å¿ƒï¼Œå®šä¹‰äº†æŒä¹…èŠ‚ç‚¹ã€ä¸´æ—¶èŠ‚ç‚¹ã€æŒä¹…é¡ºåºèŠ‚ç‚¹ã€ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ç­‰<strong>ç›®å½•æœåŠ¡</strong>æ¥å£æ–¹æ³•ï¼Œéšæ€§çš„è¦æ±‚æä¾›<strong>äº‹åŠ¡</strong>ã€<strong>åˆ†å¸ƒå¼é”</strong>ã€<strong>æ•°æ®è®¢é˜…</strong>ç­‰ç‰¹æ€§ã€‚</li>
</ul>
<p>ZookeeperRegistryCenter ä½¿ç”¨ <a href="https://curator.apache.org/" rel="external nofollow noopener noreferrer" target="_blank">Apache Curator</a> è¿›è¡Œ Zookeeper æ³¨å†Œä¸­å¿ƒã€‚</p>
<h2 id="2-1-åˆå§‹åŒ–"><a href="#2-1-åˆå§‹åŒ–" class="headerlink" title="2.1 åˆå§‹åŒ–"></a>2.1 åˆå§‹åŒ–</h2><p>ZookeeperConfigurationï¼ŒåŸºäº Zookeeper çš„æ³¨å†Œä¸­å¿ƒé…ç½®ï¼Œæ³¨é‡Šå®Œæ•´ï¼Œç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/7dc099541a16de49f024fc59e46377a726be7f6b/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/reg/zookeeper/ZookeeperConfiguration.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">   log.debug(<span class="string">"Elastic job: zookeeper registry center init, server lists is: &#123;&#125;."</span>, zkConfig.getServerLists());</div><div class="line">   CuratorFrameworkFactory.Builder builder = CuratorFrameworkFactory.builder()</div><div class="line">           .connectString(zkConfig.getServerLists())</div><div class="line">           .retryPolicy(<span class="keyword">new</span> ExponentialBackoffRetry(zkConfig.getBaseSleepTimeMilliseconds(), zkConfig.getMaxRetries(), zkConfig.getMaxSleepTimeMilliseconds()))</div><div class="line">           .namespace(zkConfig.getNamespace()); <span class="comment">// å‘½åç©ºé—´</span></div><div class="line">   <span class="keyword">if</span> (<span class="number">0</span> != zkConfig.getSessionTimeoutMilliseconds()) &#123;</div><div class="line">       builder.sessionTimeoutMs(zkConfig.getSessionTimeoutMilliseconds()); <span class="comment">// ä¼šè¯è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ 60 * 1000 æ¯«ç§’</span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (<span class="number">0</span> != zkConfig.getConnectionTimeoutMilliseconds()) &#123;</div><div class="line">       builder.connectionTimeoutMs(zkConfig.getConnectionTimeoutMilliseconds()); <span class="comment">// è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ 15 * 1000 æ¯«ç§’</span></div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è®¤è¯</span></div><div class="line">   <span class="keyword">if</span> (!Strings.isNullOrEmpty(zkConfig.getDigest())) &#123;</div><div class="line">       builder.authorization(<span class="string">"digest"</span>, zkConfig.getDigest().getBytes(Charsets.UTF_8))</div><div class="line">               .aclProvider(<span class="keyword">new</span> ACLProvider() &#123;</div><div class="line">               </div><div class="line">                   <span class="meta">@Override</span></div><div class="line">                   <span class="function"><span class="keyword">public</span> List&lt;ACL&gt; <span class="title">getDefaultAcl</span><span class="params">()</span> </span>&#123;</div><div class="line">                       <span class="keyword">return</span> ZooDefs.Ids.CREATOR_ALL_ACL;</div><div class="line">                   &#125;</div><div class="line">               </div><div class="line">                   <span class="meta">@Override</span></div><div class="line">                   <span class="function"><span class="keyword">public</span> List&lt;ACL&gt; <span class="title">getAclForPath</span><span class="params">(<span class="keyword">final</span> String path)</span> </span>&#123;</div><div class="line">                       <span class="keyword">return</span> ZooDefs.Ids.CREATOR_ALL_ACL;</div><div class="line">                   &#125;</div><div class="line">               &#125;);</div><div class="line">   &#125;</div><div class="line">   client = builder.build();</div><div class="line">   client.start();</div><div class="line">   <span class="comment">// è¿æ¥ Zookeeper</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">if</span> (!client.blockUntilConnected(zkConfig.getMaxSleepTimeMilliseconds() * zkConfig.getMaxRetries(), TimeUnit.MILLISECONDS)) &#123;</div><div class="line">           client.close();</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.OperationTimeoutException();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ExponentialBackoffRetryï¼Œå½“ Zookeeper å¤±å»é“¾æ¥åé‡æ–°è¿æ¥çš„<strong>ä¸€ç§</strong>ç­–ç•¥ï¼šåŠ¨æ€è®¡ç®—æ¯æ¬¡è®¡ç®—é‡è¿çš„é—´éš”ï¼Œæ—¶é—´é—´éš” = <code>baseSleepTimeMs * Math.max(1, random.nextInt(1 &lt;&lt; (retryCount + 1)))</code>ã€‚å¦‚æœå¯¹å…¶å®ƒé‡è¿ç­–ç•¥æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹ <a href="https://github.com/apache/curator/blob/abaabb5f65c2161f77527165a15d2420f6c88219/curator-client/src/main/java/org/apache/curator/RetryPolicy.java" rel="external nofollow noopener noreferrer" target="_blank">RetryPolicy</a> çš„å®ç°ç±»ï¼Œæœ¬æ–‡å°±ä¸å±•å¼€äº†ã€‚</li>
<li><strong>ç›¸åŒ</strong>çš„ä½œä¸šé›†ç¾¤ä½¿ç”¨<strong>ç›¸åŒ</strong>çš„ Zookeeper å‘½åç©ºé—´( <code>ZookeeperConfiguration.namespace</code> )ã€‚</li>
</ul>
<h2 id="2-2-ç¼“å­˜"><a href="#2-2-ç¼“å­˜" class="headerlink" title="2.2 ç¼“å­˜"></a>2.2 ç¼“å­˜</h2><p>é€šè¿‡ Curator TreeCache å®ç°ç›‘æ§æ•´ä¸ªæ ‘( Zookeeperç›®å½• )çš„æ•°æ®è®¢é˜…å’Œç¼“å­˜ï¼ŒåŒ…æ‹¬èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå­èŠ‚ç‚¹çš„çŠ¶æ€ã€‚</p>
<p><strong>åˆå§‹åŒ–ä½œä¸šç¼“å­˜</strong></p>
<p>ä½œä¸šåˆå§‹åŒ–æ³¨å†Œæ—¶ï¼Œåˆå§‹åŒ–ç¼“å­˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobRegistry.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerJob</span><span class="params">(<span class="keyword">final</span> String jobName, <span class="keyword">final</span> JobScheduleController jobScheduleController, <span class="keyword">final</span> CoordinatorRegistryCenter regCenter)</span> </span>&#123;</div><div class="line">   schedulerMap.put(jobName, jobScheduleController);</div><div class="line">   regCenterMap.put(jobName, regCenter);</div><div class="line">   <span class="comment">// æ·»åŠ æ³¨å†Œä¸­å¿ƒç¼“å­˜</span></div><div class="line">   regCenter.addCacheData(<span class="string">"/"</span> + jobName);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">// ZookeeperRegistryCenter.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ç¼“å­˜</div><div class="line">* keyï¼š/ä½œä¸šå/</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, TreeCache&gt; caches = <span class="keyword">new</span> HashMap&lt;&gt;();</div></pre></td></tr></table></figure>
<p><strong>ä½œä¸šæœåŠ¡è®¢é˜…æ•°æ®</strong></p>
<p>æ¯ä¸ªä¸åŒçš„æœåŠ¡ï¼Œéƒ½ä¼šè®¢é˜…æ•°æ®å®ç°åŠŸèƒ½é€»è¾‘ã€‚åœ¨åç»­ä¸åŒæœåŠ¡çš„æ–‡ç« ï¼Œæˆ‘ä»¬ä¼šè¯¦ç»†è§£æã€‚ğŸ™‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDataListener</span><span class="params">(<span class="keyword">final</span> TreeCacheListener listener)</span> </span>&#123;</div><div class="line">   TreeCache cache = (TreeCache) regCenter.getRawCache(<span class="string">"/"</span> + jobName);</div><div class="line">   cache.getListenable().addListener(listener);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>å…³é—­ä½œä¸šç¼“å­˜</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evictCacheData</span><span class="params">(<span class="keyword">final</span> String cachePath)</span> </span>&#123;</div><div class="line">   TreeCache cache = caches.remove(cachePath + <span class="string">"/"</span>);</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != cache) &#123;</div><div class="line">       cache.close();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯¹ Curator TreeCache æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥ç‚¹å‡»<a href="http://colobu.com/2014/12/15/zookeeper-recipes-by-example-5/" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç»§ç»­äº†è§£ã€‚</p>
<h2 id="2-3-å…³é—­"><a href="#2-3-å…³é—­" class="headerlink" title="2.3 å…³é—­"></a>2.3 å…³é—­</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Entry&lt;String, TreeCache&gt; each : caches.entrySet()) &#123;</div><div class="line">       each.getValue().close();</div><div class="line">   &#125;</div><div class="line">   waitForCacheClose();</div><div class="line">   CloseableUtils.closeQuietly(client);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">/* TODO ç­‰å¾…500ms, cacheå…ˆå…³é—­å†å…³é—­client, å¦åˆ™ä¼šæŠ›å¼‚å¸¸</span></div><div class="line">* å› ä¸ºå¼‚æ­¥å¤„ç†, å¯èƒ½ä¼šå¯¼è‡´clientå…ˆå…³é—­è€Œcacheè¿˜æœªå…³é—­ç»“æŸ.</div><div class="line">* ç­‰å¾…Curatoræ–°ç‰ˆæœ¬è§£å†³è¿™ä¸ªbug.</div><div class="line">* BUGåœ°å€ï¼šhttps://issues.apache.org/jira/browse/CURATOR-157</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">waitForCacheClose</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Thread.sleep(<span class="number">500L</span>);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException ex) &#123;</div><div class="line">       Thread.currentThread().interrupt();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-4-è·å¾—æ•°æ®"><a href="#2-4-è·å¾—æ•°æ®" class="headerlink" title="2.4 è·å¾—æ•°æ®"></a>2.4 è·å¾—æ•°æ®</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">   TreeCache cache = findTreeCache(key); <span class="comment">// è·å–ç¼“å­˜</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> == cache) &#123;</div><div class="line">       <span class="keyword">return</span> getDirectly(key);</div><div class="line">   &#125;</div><div class="line">   ChildData resultInCache = cache.getCurrentData(key); <span class="comment">// ç¼“å­˜ä¸­è·å– value</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != resultInCache) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span> == resultInCache.getData() ? <span class="keyword">null</span> : <span class="keyword">new</span> String(resultInCache.getData(), Charsets.UTF_8);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> getDirectly(key);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getDirectly</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> String(client.getData().forPath(key), Charsets.UTF_8);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#get(...)</code> å…ˆä» <strong>TreeCacheç¼“å­˜</strong> è·å–ï¼Œåä» Zookeeper è·å–ã€‚</li>
<li><code>#getDirectly(...)</code> <strong>ç›´æ¥</strong>ä» Zookeeper è·å–ã€‚</li>
<li><p><code>#findTreeCache(...)</code> ä»£ç å¦‚ä¸‹ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> TreeCache <span class="title">findTreeCache</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Entry&lt;String, TreeCache&gt; entry : caches.entrySet()) &#123;</div><div class="line">       <span class="keyword">if</span> (key.startsWith(entry.getKey())) &#123;</div><div class="line">           <span class="keyword">return</span> entry.getValue();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="2-5-è·å¾—æ³¨å†Œå­èŠ‚ç‚¹"><a href="#2-5-è·å¾—æ³¨å†Œå­èŠ‚ç‚¹" class="headerlink" title="2.5 è·å¾—æ³¨å†Œå­èŠ‚ç‚¹"></a>2.5 è·å¾—æ³¨å†Œå­èŠ‚ç‚¹</h2><p><strong>è·å–å­èŠ‚ç‚¹åç§°é›†åˆ(é™åº)</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getChildrenKeys</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       List&lt;String&gt; result = client.getChildren().forPath(key);</div><div class="line">       Collections.sort(result, <span class="keyword">new</span> Comparator&lt;String&gt;() &#123;</div><div class="line">           </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(<span class="keyword">final</span> String o1, <span class="keyword">final</span> String o2)</span> </span>&#123;</div><div class="line">               <span class="keyword">return</span> o2.compareTo(o1);</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>è·å–å­èŠ‚ç‚¹æ•°é‡</strong>    </p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNumChildren</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Stat stat = client.checkExists().forPath(key);</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> != stat) &#123;</div><div class="line">           <span class="keyword">return</span> stat.getNumChildren();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-6-å­˜å‚¨æ³¨å†Œæ•°æ®"><a href="#2-6-å­˜å‚¨æ³¨å†Œæ•°æ®" class="headerlink" title="2.6 å­˜å‚¨æ³¨å†Œæ•°æ®"></a>2.6 å­˜å‚¨æ³¨å†Œæ•°æ®</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">persist</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String value)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">if</span> (!isExisted(key)) &#123;</div><div class="line">           client.create().creatingParentsIfNeeded().withMode(CreateMode.PERSISTENT).forPath(key, value.getBytes(Charsets.UTF_8));</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           update(key, value);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">persistEphemeral</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String value)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">if</span> (isExisted(key)) &#123;</div><div class="line">           client.delete().deletingChildrenIfNeeded().forPath(key);</div><div class="line">       &#125;</div><div class="line">       client.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL).forPath(key, value.getBytes(Charsets.UTF_8));</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#persist(...)</code> å­˜å‚¨<strong>æŒä¹…</strong>èŠ‚ç‚¹æ•°æ®ã€‚é€»è¾‘ç­‰ä»·äº insertOrUpdate æ“ä½œã€‚</li>
<li><code>persistEphemeral(...)</code> å­˜å‚¨<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹æ•°æ®ã€‚èŠ‚ç‚¹ç±»å‹æ— æ³•å˜æ›´ï¼Œå› æ­¤å¦‚æœæ•°æ®å·²å­˜åœ¨ï¼Œéœ€è¦å…ˆè¿›è¡Œåˆ é™¤ã€‚</li>
<li><p><code>#isExisted(...)</code>ã€<code>#update(...)</code> ä»£ç å¦‚ä¸‹ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExisted</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span> != client.checkExists().forPath(key);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">   </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String value)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       client.inTransaction().check().forPath(key).and().setData().forPath(key, value.getBytes(Charsets.UTF_8)).and().commit();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#update(...)</code> ä½¿ç”¨<strong>äº‹åŠ¡</strong>æ ¡éªŒé”®( key )å­˜åœ¨æ‰è¿›è¡Œæ›´æ–°ã€‚</li>
</ul>
</li>
</ul>
<h2 id="2-7-å­˜å‚¨é¡ºåºæ³¨å†Œæ•°æ®"><a href="#2-7-å­˜å‚¨é¡ºåºæ³¨å†Œæ•°æ®" class="headerlink" title="2.7 å­˜å‚¨é¡ºåºæ³¨å†Œæ•°æ®"></a>2.7 å­˜å‚¨é¡ºåºæ³¨å†Œæ•°æ®</h2><p>å®ç°é€»è¾‘å’Œ<strong>å­˜å‚¨æ³¨å†Œæ•°æ®</strong>ç±»ä¼¼ã€‚Elastic-Job æœªä½¿ç”¨è¯¥æ–¹æ³•ï¼Œè·³è¿‡ã€‚</p>
<h2 id="2-8-ç§»é™¤æ³¨å†Œæ•°æ®"><a href="#2-8-ç§»é™¤æ³¨å†Œæ•°æ®" class="headerlink" title="2.8 ç§»é™¤æ³¨å†Œæ•°æ®"></a>2.8 ç§»é™¤æ³¨å†Œæ•°æ®</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       client.delete().deletingChildrenIfNeeded().forPath(key);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-9-è·å–æ³¨å†Œä¸­å¿ƒå½“å‰æ—¶é—´"><a href="#2-9-è·å–æ³¨å†Œä¸­å¿ƒå½“å‰æ—¶é—´" class="headerlink" title="2.9 è·å–æ³¨å†Œä¸­å¿ƒå½“å‰æ—¶é—´"></a>2.9 è·å–æ³¨å†Œä¸­å¿ƒå½“å‰æ—¶é—´</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getRegistryCenterTime</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">   <span class="keyword">long</span> result = <span class="number">0L</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       persist(key, <span class="string">""</span>);</div><div class="line">       result = client.checkExists().forPath(key).getMtime();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">   &#125;</div><div class="line">   Preconditions.checkState(<span class="number">0L</span> != result, <span class="string">"Cannot get registry center time."</span>);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>é€šè¿‡æ›´æ–°èŠ‚ç‚¹ï¼Œè·å¾—è¯¥èŠ‚ç‚¹çš„æœ€åæ›´æ–°æ—¶é—´( <code>mtime</code> )è·å¾— Zookeeper çš„æ—¶é—´ã€‚six six sixã€‚</li>
</ul>
<h2 id="2-10-æ³¨å†Œä¸­å¿ƒå¼‚å¸¸å¤„ç†å™¨"><a href="#2-10-æ³¨å†Œä¸­å¿ƒå¼‚å¸¸å¤„ç†å™¨" class="headerlink" title="2.10 æ³¨å†Œä¸­å¿ƒå¼‚å¸¸å¤„ç†å™¨"></a>2.10 æ³¨å†Œä¸­å¿ƒå¼‚å¸¸å¤„ç†å™¨</h2><p>RegExceptionHandlerï¼Œæ³¨å†Œä¸­å¿ƒå¼‚å¸¸å¤„ç†å™¨ã€‚åœ¨ä¸Šé¢çš„æ“ä½œ Zookeeper å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ <code>RegExceptionHandler.handleException(...)</code> å¤„ç†å¼‚å¸¸ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleException</span><span class="params">(<span class="keyword">final</span> Exception cause)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> == cause) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (isIgnoredException(cause) || <span class="keyword">null</span> != cause.getCause() &amp;&amp; isIgnoredException(cause.getCause())) &#123;</div><div class="line">       log.debug(<span class="string">"Elastic job: ignored exception for: &#123;&#125;"</span>, cause.getMessage());</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> InterruptedException) &#123;</div><div class="line">       Thread.currentThread().interrupt();</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RegException(cause);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isIgnoredException</span><span class="params">(<span class="keyword">final</span> Throwable cause)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> cause <span class="keyword">instanceof</span> ConnectionLossException || cause <span class="keyword">instanceof</span> NoNodeException || cause <span class="keyword">instanceof</span> NodeExistsException;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>éƒ¨åˆ†å¼‚å¸¸ä¼šè¢«æ— è§†ï¼Œä»…æ‰“å°å¼‚å¸¸ã€‚ä¾‹å¦‚è°ƒç”¨ <code>#getDirectly(...)</code> è·å¾—æ³¨å†Œæ•°æ®æ—¶ï¼Œå¯èƒ½èŠ‚ç‚¹ä¸å­˜åœ¨ï¼ŒæŠ›å‡º NodeExistsExceptionï¼Œè¿™ç§å¼‚å¸¸å¯ä»¥æ— è§†ã€‚</li>
</ul>
<h1 id="3-ä½œä¸šèŠ‚ç‚¹æ•°æ®è®¿é—®ç±»"><a href="#3-ä½œä¸šèŠ‚ç‚¹æ•°æ®è®¿é—®ç±»" class="headerlink" title="3. ä½œä¸šèŠ‚ç‚¹æ•°æ®è®¿é—®ç±»"></a>3. ä½œä¸šèŠ‚ç‚¹æ•°æ®è®¿é—®ç±»</h1><p>JobNodeStorageï¼Œä½œä¸šèŠ‚ç‚¹æ•°æ®è®¿é—®ç±»ã€‚</p>
<h2 id="3-1-åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œ"><a href="#3-1-åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œ" class="headerlink" title="3.1 åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œ"></a>3.1 åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œ</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobNodeStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œ.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> latchNode åˆ†å¸ƒå¼é”ä½¿ç”¨çš„èŠ‚ç‚¹ï¼Œä¾‹å¦‚ï¼šleader/election/latch</div><div class="line">* <span class="doctag">@param</span> callback æ‰§è¡Œæ“ä½œçš„å›è°ƒ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeInLeader</span><span class="params">(<span class="keyword">final</span> String latchNode, <span class="keyword">final</span> LeaderExecutionCallback callback)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> (LeaderLatch latch = <span class="keyword">new</span> LeaderLatch(getClient(), jobNodePath.getFullPath(latchNode))) &#123;</div><div class="line">       latch.start();</div><div class="line">       latch.await();</div><div class="line">       callback.execute();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       handleException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><a href="https://curator.apache.org/" rel="external nofollow noopener noreferrer" target="_blank">Apache Curator</a> ä½¿ç”¨ Zookeeper å®ç°äº†ä¸¤ç§åˆ†å¸ƒå¼é”ï¼ŒLeaderLatch æ˜¯å…¶ä¸­çš„ä¸€ç§ã€‚ä½¿ç”¨<strong>ä¸€ä¸ª</strong> Zookeeper èŠ‚ç‚¹è·¯å¾„åˆ›å»º<strong>ä¸€ä¸ª</strong> LeaderLatchï¼Œ<code>#start()</code> åï¼Œè°ƒç”¨ <code>#await()</code> ç­‰å¾…æ‹¿åˆ°è¿™æŠŠ<strong>é”</strong>ã€‚å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹æ‰§è¡Œäº†<strong>ç›¸åŒèŠ‚ç‚¹è·¯å¾„</strong>çš„ LeaderLatch çš„ <code>#await()</code> åï¼ŒåŒä¸€æ—¶åˆ»æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œå…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾…ã€‚å½“è¯¥çº¿ç¨‹é‡Šæ”¾( <code>LeaderLatch#close()</code> )åï¼Œä¸‹ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‹¿åˆ°è¯¥<strong>é”</strong>ç»§ç»­æ‰§è¡Œã€‚ç”¨ Java å¹¶å‘åŒ… Lock ä¸¾ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeInLeader</span><span class="params">(Lock lock)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        lock.lock();</div><div class="line">        <span class="comment">// doSomething();</span></div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        lock.unlock();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><a href="https://github.com/Netflix/curator/wiki/Leader-Latch" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” LeaderLatchã€‹</a>ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹çœ‹ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/election/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‹</a>ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ° <code>#executeInLeader(...)</code> çš„ä½¿ç”¨ã€‚</p>
<p>å¦ä¸€ç§åˆ†å¸ƒå¼é”å®ç°ï¼Œ<a href="https://github.com/Netflix/curator/wiki/Leader-Election" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” LeaderElectionã€‹</a>ï¼Œæœ‰å…´è¶£ä¹Ÿå¯ä»¥çœ‹çœ‹ã€‚åœ¨ Elastic-Job-Cloud ä¸­ä½¿ç”¨åˆ°äº†ï¼Œåç»­è¿›è¡Œè§£æã€‚</p>
<h2 id="3-2-åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ"><a href="#3-2-åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ" class="headerlink" title="3.2 åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ"></a>3.2 åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobNodeStorage.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeInTransaction</span><span class="params">(<span class="keyword">final</span> TransactionExecutionCallback callback)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       CuratorTransactionFinal curatorTransactionFinal = getClient().inTransaction().check().forPath(<span class="string">"/"</span>).and();</div><div class="line">       callback.execute(curatorTransactionFinal);</div><div class="line">       curatorTransactionFinal.commit();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å¼€å¯äº‹åŠ¡ï¼Œæ‰§è¡Œ TransactionExecutionCallback å›è°ƒé€»è¾‘ï¼Œæäº¤äº‹åŠ¡ã€‚</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šç…ç¬”èŠ‹é“å›ï¼Œåˆåœ¨æ°´æ›´<br>èŠ‹é“å›ï¼šäººè‰°ä¸æ‹†ï¼Œå¥½ä¸å¥½ã€‚</p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. åŸº
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.yunai.me/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œ</title>
    <link href="http://www.yunai.me/Elastic-Job/job-execute/"/>
    <id>http://www.yunai.me/Elastic-Job/job-execute/</id>
    <published>2017-09-22T16:00:00.000Z</published>
    <updated>2017-09-02T09:55:24.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#1-%E6%A6%82%E8%BF%B0">1. æ¦‚è¿°</a></li>
<li><a href="#2-lite%E8%B0%83%E5%BA%A6%E4%BD%9C%E4%B8%9A">2. Liteè°ƒåº¦ä½œä¸š</a></li>
<li><a href="#3-%E6%89%A7%E8%A1%8C%E5%99%A8%E5%88%9B%E5%BB%BA">3. æ‰§è¡Œå™¨åˆ›å»º</a><ul>
<li><a href="#31-%E5%8A%A0%E8%BD%BD%E4%BD%9C%E4%B8%9A%E9%85%8D%E7%BD%AE">3.1 åŠ è½½ä½œä¸šé…ç½®</a></li>
<li><a href="#32-%E8%8E%B7%E5%8F%96%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0">3.2 è·å–ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± </a></li>
<li><a href="#33-%E8%8E%B7%E5%8F%96%E4%BD%9C%E4%B8%9A%E5%BC%82%E5%B8%B8%E6%89%A7%E8%A1%8C%E5%99%A8">3.3 è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨</a></li>
</ul>
</li>
<li><a href="#4-%E6%89%A7%E8%A1%8C%E5%99%A8%E6%89%A7%E8%A1%8C">4. æ‰§è¡Œå™¨æ‰§è¡Œ</a><ul>
<li><a href="#41-%E6%A3%80%E6%9F%A5%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E7%8E%AF%E5%A2%83">4.1 æ£€æŸ¥ä½œä¸šæ‰§è¡Œç¯å¢ƒ</a></li>
<li><a href="#42-%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E4%BD%9C%E4%B8%9A%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%88%86%E7%89%87%E4%B8%8A%E4%B8%8B%E6%96%87">4.2 è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡</a></li>
<li><a href="#43-%E5%8F%91%E5%B8%83%E4%BD%9C%E4%B8%9A%E7%8A%B6%E6%80%81%E8%BF%BD%E8%B8%AA%E4%BA%8B%E4%BB%B6">4.3 å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶</a></li>
<li><a href="#44-%E8%B7%B3%E8%BF%87%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E4%B8%AD%E7%9A%84%E8%A2%AB%E9%94%99%E8%BF%87%E6%89%A7%E8%A1%8C%E7%9A%84%E4%BD%9C%E4%B8%9A">4.4 è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š</a></li>
<li><a href="#45-%E6%89%A7%E8%A1%8C%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E5%89%8D%E7%9A%84%E6%96%B9%E6%B3%95">4.5 æ‰§è¡Œä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•</a></li>
<li><a href="#46-%E6%89%A7%E8%A1%8C%E6%99%AE%E9%80%9A%E8%A7%A6%E5%8F%91%E7%9A%84%E4%BD%9C%E4%B8%9A">4.6 æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸š</a><ul>
<li><a href="#461-%E7%AE%80%E5%8D%95%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E5%99%A8">4.6.1 ç®€å•ä½œä¸šæ‰§è¡Œå™¨</a></li>
<li><a href="#462-%E6%95%B0%E6%8D%AE%E6%B5%81%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E5%99%A8">4.6.2 æ•°æ®æµä½œä¸šæ‰§è¡Œå™¨</a></li>
<li><a href="#463-%E8%84%9A%E6%9C%AC%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E5%99%A8">4.6.3 è„šæœ¬ä½œä¸šæ‰§è¡Œå™¨</a></li>
</ul>
</li>
<li><a href="#47-%E6%89%A7%E8%A1%8C%E8%A2%AB%E9%94%99%E8%BF%87%E8%A7%A6%E5%8F%91%E7%9A%84%E4%BD%9C%E4%B8%9A">4.7 æ‰§è¡Œè¢«é”™è¿‡è§¦å‘çš„ä½œä¸š</a></li>
<li><a href="#48-%E6%89%A7%E8%A1%8C%E4%BD%9C%E4%B8%9A%E5%A4%B1%E6%95%88%E8%BD%AC%E7%A7%BB">4.8 æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»</a></li>
<li><a href="#49-%E6%89%A7%E8%A1%8C%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E5%90%8E%E7%9A%84%E6%96%B9%E6%B3%95">4.9 æ‰§è¡Œä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•</a></li>
</ul>
</li>
<li><a href="#666-%E5%BD%A9%E8%9B%8B">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šæ‰§è¡Œ</strong>ã€‚</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_09_23/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_09_23/01.png" alt=""></p>
<ul>
<li><strong>é»„è‰²</strong>çš„ç±»åœ¨ <code>elastic-job-common-core</code> é¡¹ç›®é‡Œï¼Œä¸º Elastic-Job-Liteã€Elastic-Job-Cloud <strong>å…¬ç”¨</strong>ä½œä¸šæ‰§è¡Œç±»ã€‚</li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-Liteè°ƒåº¦ä½œä¸š"><a href="#2-Liteè°ƒåº¦ä½œä¸š" class="headerlink" title="2. Liteè°ƒåº¦ä½œä¸š"></a>2. Liteè°ƒåº¦ä½œä¸š</h1><p>Liteè°ƒåº¦ä½œä¸š( LiteJob )ï¼Œä½œä¸šè¢«è°ƒåº¦åï¼Œè°ƒç”¨ <code>#execute()</code> æ‰§è¡Œä½œä¸šã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆæ˜¯ LiteJob ä½œä¸ºå…¥å£å‘¢ï¼Ÿ</strong></p>
<p>åœ¨<a href="http://www.yunai.me/Elastic-Job/job-init/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆå§‹åŒ–ã€‹çš„ã€Œ3.2.3ã€åˆ›å»ºä½œä¸šè°ƒåº¦æ§åˆ¶å™¨</a>é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Quartz çš„ JobDetail åˆ›å»ºä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">JobDetail result = JobBuilder.newJob(LiteJob.class).withIdentity(liteJobConfig.getJobName()).build();</div></pre></td></tr></table></figure>
<p><code>#newJob()</code> é‡Œçš„å‚æ•°æ˜¯ LiteJobï¼Œå› æ­¤ï¼Œæ¯æ¬¡ Quartz åˆ°è¾¾è°ƒåº¦æ—¶é—´æ—¶ï¼Œä¼šåˆ›å»ºè¯¥å¯¹è±¡è¿›è¡Œä½œä¸šæ‰§è¡Œã€‚</p>
<hr>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LiteJob</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> ElasticJob elasticJob;</div><div class="line">    </div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> JobFacade jobFacade;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</div><div class="line">        JobExecutorFactory.getJobExecutor(elasticJob, jobFacade).execute();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>LiteJob é€šè¿‡ JobExecutorFactory è·å¾—åˆ°ä½œä¸šæ‰§è¡Œå™¨( AbstractElasticJobExecutor )ï¼Œå¹¶è¿›è¡Œæ‰§è¡Œï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobExecutorFactory</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–ä½œä¸šæ‰§è¡Œå™¨.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> elasticJob åˆ†å¸ƒå¼å¼¹æ€§ä½œä¸š</div><div class="line">     * <span class="doctag">@param</span> jobFacade ä½œä¸šå†…éƒ¨æœåŠ¡é—¨é¢æœåŠ¡</div><div class="line">     * <span class="doctag">@return</span> ä½œä¸šæ‰§è¡Œå™¨</div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AbstractElasticJobExecutor <span class="title">getJobExecutor</span><span class="params">(<span class="keyword">final</span> ElasticJob elasticJob, <span class="keyword">final</span> JobFacade jobFacade)</span> </span>&#123;</div><div class="line">        <span class="comment">// ScriptJob</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == elasticJob) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ScriptJobExecutor(jobFacade);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// SimpleJob</span></div><div class="line">        <span class="keyword">if</span> (elasticJob <span class="keyword">instanceof</span> SimpleJob) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SimpleJobExecutor((SimpleJob) elasticJob, jobFacade);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// DataflowJob</span></div><div class="line">        <span class="keyword">if</span> (elasticJob <span class="keyword">instanceof</span> DataflowJob) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DataflowJobExecutor((DataflowJob) elasticJob, jobFacade);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Cannot support job type '%s'"</span>, elasticJob.getClass().getCanonicalName());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>JobExecutorFactoryï¼Œä½œä¸šæ‰§è¡Œå™¨å·¥å‚ï¼Œæ ¹æ®ä¸åŒçš„ä½œä¸šç±»å‹ï¼Œè¿”å›å¯¹åº”çš„<strong>ä½œä¸šæ‰§è¡Œå™¨</strong>ã€‚</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">ä½œä¸š</th>
<th style="text-align:left">ä½œä¸šæ¥å£</th>
<th style="text-align:left">æ‰§è¡Œå™¨</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ç®€å•ä½œä¸š</td>
<td style="text-align:left">SimpleJob</td>
<td style="text-align:left">SimpleJobExecutor</td>
</tr>
<tr>
<td style="text-align:left">æ•°æ®æµä½œä¸š</td>
<td style="text-align:left">DataflowJob</td>
<td style="text-align:left">DataflowJobExecutor</td>
</tr>
<tr>
<td style="text-align:left">è„šæœ¬ä½œä¸š</td>
<td style="text-align:left">ScriptJob</td>
<td style="text-align:left">ScriptJobExecutor</td>
</tr>
</tbody>
</table>
<h1 id="3-æ‰§è¡Œå™¨åˆ›å»º"><a href="#3-æ‰§è¡Œå™¨åˆ›å»º" class="headerlink" title="3. æ‰§è¡Œå™¨åˆ›å»º"></a>3. æ‰§è¡Œå™¨åˆ›å»º</h1><p>AbstractElasticJobExecutorï¼Œä½œä¸šæ‰§è¡Œå™¨æŠ½è±¡ç±»ã€‚ä¸åŒä½œä¸šæ‰§è¡Œå™¨éƒ½ç»§æ‰¿è¯¥ç±»ï¼Œåˆ›å»ºçš„è¿‡ç¨‹æ˜¯ä¸€è‡´çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šé—¨é¢å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span>(AccessLevel.PROTECTED)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobFacade jobFacade;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šé…ç½®</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span>(AccessLevel.PROTECTED)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobRootConfiguration jobRootConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåç§°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± </div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutorService executorService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šå¼‚å¸¸å¤„ç†å™¨</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobExceptionHandler jobExceptionHandler;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ†ç‰‡é”™è¯¯ä¿¡æ¯é›†åˆ</div><div class="line">     * keyï¼šåˆ†ç‰‡åºå·</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, String&gt; itemErrorMessages;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">AbstractElasticJobExecutor</span><span class="params">(<span class="keyword">final</span> JobFacade jobFacade)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.jobFacade = jobFacade;</div><div class="line">        <span class="comment">// åŠ è½½ ä½œä¸šé…ç½®</span></div><div class="line">        jobRootConfig = jobFacade.loadJobRootConfiguration(<span class="keyword">true</span>);</div><div class="line">        jobName = jobRootConfig.getTypeConfig().getCoreConfig().getJobName();</div><div class="line">        <span class="comment">// è·å– ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± </span></div><div class="line">        executorService = ExecutorServiceHandlerRegistry.getExecutorServiceHandler(jobName, (ExecutorServiceHandler) getHandler(JobProperties.JobPropertiesEnum.EXECUTOR_SERVICE_HANDLER));</div><div class="line">        <span class="comment">// è·å– ä½œä¸šå¼‚å¸¸å¤„ç†å™¨</span></div><div class="line">        jobExceptionHandler = (JobExceptionHandler) getHandler(JobProperties.JobPropertiesEnum.JOB_EXCEPTION_HANDLER);</div><div class="line">        <span class="comment">// è®¾ç½® åˆ†ç‰‡é”™è¯¯ä¿¡æ¯é›†åˆ</span></div><div class="line">        itemErrorMessages = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(jobRootConfig.getTypeConfig().getCoreConfig().getShardingTotalCount(), <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SimpleJobExecutor.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleJobExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç®€å•ä½œä¸šå®ç°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SimpleJob simpleJob;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleJobExecutor</span><span class="params">(<span class="keyword">final</span> SimpleJob simpleJob, <span class="keyword">final</span> JobFacade jobFacade)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(jobFacade);</div><div class="line">        <span class="keyword">this</span>.simpleJob = simpleJob;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DataflowJobExecutor.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DataflowJobExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•°æ®æµä½œä¸šå¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataflowJob&lt;Object&gt; dataflowJob;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataflowJobExecutor</span><span class="params">(<span class="keyword">final</span> DataflowJob&lt;Object&gt; dataflowJob, <span class="keyword">final</span> JobFacade jobFacade)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(jobFacade);</div><div class="line">        <span class="keyword">this</span>.dataflowJob = dataflowJob;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ScriptJobExecutor.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ScriptJobExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ScriptJobExecutor</span><span class="params">(<span class="keyword">final</span> JobFacade jobFacade)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(jobFacade);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-1-åŠ è½½ä½œä¸šé…ç½®"><a href="#3-1-åŠ è½½ä½œä¸šé…ç½®" class="headerlink" title="3.1 åŠ è½½ä½œä¸šé…ç½®"></a>3.1 åŠ è½½ä½œä¸šé…ç½®</h2><p>ä»<strong>ç¼“å­˜</strong>ä¸­è¯»å–ä½œä¸šé…ç½®ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-config/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹çš„ã€Œ3.1ã€è¯»å–ä½œä¸šé…ç½®</a> å·²ç»è§£æã€‚</p>
<h2 id="3-2-è·å–ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± "><a href="#3-2-è·å–ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± " class="headerlink" title="3.2 è·å–ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± "></a>3.2 è·å–ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± </h2><p>ä½œä¸šæ¯æ¬¡æ‰§è¡Œæ—¶ï¼Œå¯èƒ½åˆ†é…åˆ°<strong>å¤šä¸ªåˆ†ç‰‡é¡¹</strong>ï¼Œéœ€è¦ä½¿ç”¨çº¿ç¨‹æ± å®ç°<strong>å¹¶è¡Œ</strong>æ‰§è¡Œã€‚è€ƒè™‘åˆ°ä¸åŒä½œä¸šä¹‹é—´çš„éš”ç¦»æ€§ï¼Œé€šè¿‡<strong>ä¸€ä¸ªä½œä¸šä¸€ä¸ªçº¿ç¨‹æ± </strong>å®ç°ã€‚çº¿ç¨‹æ± æœåŠ¡å¤„ç†å™¨æ³¨å†Œè¡¨( ExecutorServiceHandlerRegistry ) è·å–ä½œä¸šçº¿ç¨‹æ± ( <code>#getExecutorServiceHandler(....)</code> )ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorServiceHandlerRegistry</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * çº¿ç¨‹æ± é›†åˆ</div><div class="line">     * keyï¼šä½œä¸šåå­—</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, ExecutorService&gt; REGISTRY = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–çº¿ç¨‹æ± æœåŠ¡.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> jobName ä½œä¸šåç§°</div><div class="line">     * <span class="doctag">@param</span> executorServiceHandler çº¿ç¨‹æ± æœåŠ¡å¤„ç†å™¨</div><div class="line">     * <span class="doctag">@return</span> çº¿ç¨‹æ± æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> ExecutorService <span class="title">getExecutorServiceHandler</span><span class="params">(<span class="keyword">final</span> String jobName, <span class="keyword">final</span> ExecutorServiceHandler executorServiceHandler)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!REGISTRY.containsKey(jobName)) &#123;</div><div class="line">            REGISTRY.put(jobName, executorServiceHandler.createExecutorService(jobName));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> REGISTRY.get(jobName);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ExecutorServiceHandlerRegistry ä½¿ç”¨ ExecutorServiceHandler åˆ›å»ºçº¿ç¨‹æ± ã€‚ExecutorServiceHandler æœ¬èº«æ˜¯ä¸ª<strong>æ¥å£</strong>ï¼Œé»˜è®¤ä½¿ç”¨ DefaultExecutorServiceHandler å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ExecutorServiceHandler.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExecutorServiceHandler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ›å»ºçº¿ç¨‹æ± æœåŠ¡å¯¹è±¡.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> jobName ä½œä¸šå</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span> çº¿ç¨‹æ± æœåŠ¡å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="function">ExecutorService <span class="title">createExecutorService</span><span class="params">(<span class="keyword">final</span> String jobName)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DefaultExecutorServiceHandler.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultExecutorServiceHandler</span> <span class="keyword">implements</span> <span class="title">ExecutorServiceHandler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ExecutorService <span class="title">createExecutorService</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ExecutorServiceObject(<span class="string">"inner-job-"</span> + jobName, Runtime.getRuntime().availableProcessors() * <span class="number">2</span>).createExecutorService();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è°ƒç”¨ ExecutorServiceObject çš„ <code>#createExecutorService(....)</code> æ–¹æ³•åˆ›å»ºçº¿ç¨‹æ± ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorServiceObject</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor threadPoolExecutor;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExecutorServiceObject</span><span class="params">(<span class="keyword">final</span> String namingPattern, <span class="keyword">final</span> <span class="keyword">int</span> threadSize)</span> </span>&#123;</div><div class="line">        workQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line">        threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(threadSize, threadSize, <span class="number">5L</span>, TimeUnit.MINUTES, workQueue, </div><div class="line">                <span class="keyword">new</span> BasicThreadFactory.Builder().namingPattern(Joiner.on(<span class="string">"-"</span>).join(namingPattern, <span class="string">"%s"</span>)).build());</div><div class="line">        threadPoolExecutor.allowCoreThreadTimeOut(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ›å»ºçº¿ç¨‹æ± æœåŠ¡å¯¹è±¡.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> çº¿ç¨‹æ± æœåŠ¡å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> ExecutorService <span class="title">createExecutorService</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> MoreExecutors.listeningDecorator(MoreExecutors.getExitingExecutorService(threadPoolExecutor));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>MoreExecutors#listeningDecorator(...)</code> åœ¨<a href="http://www.yunai.me/Sharding-JDBC/sql-execute/?self">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œã€‹</a> å·²ç»è§£æã€‚</li>
<li><p><code>MoreExecutors#getExitingExecutorService(...)</code> æ–¹æ³•é€»è¾‘ï¼šå°† ThreadPoolExecutor è½¬æ¢æˆ ExecutorServiceï¼Œå¹¶å¢åŠ  JVM å…³é—­é’©å­ï¼Œå®ç° <strong>120s</strong> ç­‰å¾…ä»»åŠ¡å®Œæˆï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">service.shutdown();</div><div class="line">service.awaitTermination(terminationTimeout, timeUnit);</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p><strong>å¦‚ä½•å®ç°è‡ªå®šä¹‰ ExecutorServiceHandler ?</strong></p>
<p>å…ˆçœ‹ä¸‹ AbstractElasticJobExecutor æ˜¯å¦‚ä½•è·å¾—<strong>æ¯ä¸ªä½œä¸š</strong>çš„ ExecutorServiceHandler ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—ã€è‡ªå®šä¹‰ã€‘å¤„ç†å™¨</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> jobPropertiesEnum ä½œä¸šå±æ€§æšä¸¾</div><div class="line">* <span class="doctag">@return</span> å¤„ç†å™¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getHandler</span><span class="params">(<span class="keyword">final</span> JobProperties.JobPropertiesEnum jobPropertiesEnum)</span> </span>&#123;</div><div class="line">   String handlerClassName = jobRootConfig.getTypeConfig().getCoreConfig().getJobProperties().get(jobPropertiesEnum);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Class&lt;?&gt; handlerClass = Class.forName(handlerClassName);</div><div class="line">       <span class="keyword">if</span> (jobPropertiesEnum.getClassType().isAssignableFrom(handlerClass)) &#123; <span class="comment">// å¿…é¡»æ˜¯æ¥å£å®ç°ï¼Œæ‰ä½¿ç”¨ã€è‡ªå®šä¹‰ã€‘</span></div><div class="line">           <span class="keyword">return</span> handlerClass.newInstance();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> getDefaultHandler(jobPropertiesEnum, handlerClassName);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ReflectiveOperationException ex) &#123;</div><div class="line">       <span class="keyword">return</span> getDefaultHandler(jobPropertiesEnum, handlerClassName);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—ã€é»˜è®¤ã€‘å¤„ç†å™¨</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> jobPropertiesEnum ä½œä¸šå±æ€§æšä¸¾</div><div class="line">* <span class="doctag">@param</span> handlerClassName å¤„ç†å™¨ç±»å</div><div class="line">* <span class="doctag">@return</span> å¤„ç†å™¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getDefaultHandler</span><span class="params">(<span class="keyword">final</span> JobProperties.JobPropertiesEnum jobPropertiesEnum, <span class="keyword">final</span> String handlerClassName)</span> </span>&#123;</div><div class="line">   log.warn(<span class="string">"Cannot instantiation class '&#123;&#125;', use default '&#123;&#125;' class."</span>, handlerClassName, jobPropertiesEnum.getKey());</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">return</span> Class.forName(jobPropertiesEnum.getDefaultValue()).newInstance();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ClassNotFoundException | InstantiationException | IllegalAccessException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(e);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ¯ä¸ªå¤„ç†å™¨éƒ½ä¼šå¯¹åº”ä¸€ä¸ª JobPropertiesEnumï¼Œä½¿ç”¨æšä¸¾è·å¾—å¤„ç†å™¨ã€‚ä¼˜å…ˆä» <code>JobProperties.map</code> è·å–<strong>è‡ªå®šä¹‰</strong>çš„å¤„ç†å™¨å®ç°ç±»ï¼Œå¦‚æœä¸ç¬¦åˆæ¡ä»¶( æœªå®ç°æ­£ç¡®æ¥å£ æˆ–è€… åˆ›å»ºå¤„ç†å™¨å¤±è´¥ )ï¼Œä½¿ç”¨<strong>é»˜è®¤</strong>çš„å¤„ç†å™¨å®ç°ã€‚</li>
<li>æ¯ä¸ªä½œä¸šå¯ä»¥é…ç½®<strong>ä¸åŒ</strong>çš„å¤„ç†å™¨ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-config/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹çš„ã€Œ2.2.2ã€ä½œä¸šæ ¸å¿ƒé…ç½®</a> å·²ç»è§£æã€‚</li>
</ul>
<h2 id="3-3-è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨"><a href="#3-3-è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨" class="headerlink" title="3.3 è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨"></a>3.3 è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨</h2><p>è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨( JobExceptionHandler )å’Œ ExecutorServiceHandler( ExecutorServiceHandler )<strong>ç›¸åŒ</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ExecutorServiceHandler.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JobExceptionHandler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¤„ç†ä½œä¸šå¼‚å¸¸.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> jobName ä½œä¸šåç§°</div><div class="line">     * <span class="doctag">@param</span> cause å¼‚å¸¸åŸå› </div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handleException</span><span class="params">(String jobName, Throwable cause)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DefaultJobExceptionHandler.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultJobExceptionHandler</span> <span class="keyword">implements</span> <span class="title">JobExceptionHandler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleException</span><span class="params">(<span class="keyword">final</span> String jobName, <span class="keyword">final</span> Throwable cause)</span> </span>&#123;</div><div class="line">        log.error(String.format(<span class="string">"Job '%s' exception occur in job processing"</span>, jobName), cause);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>é»˜è®¤å®ç° DefaultJobExceptionHandler <strong>æ‰“å°å¼‚å¸¸æ—¥å¿—ï¼Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸</strong>ã€‚</li>
</ul>
<h1 id="4-æ‰§è¡Œå™¨æ‰§è¡Œ"><a href="#4-æ‰§è¡Œå™¨æ‰§è¡Œ" class="headerlink" title="4. æ‰§è¡Œå™¨æ‰§è¡Œ"></a>4. æ‰§è¡Œå™¨æ‰§è¡Œ</h1><p>æ‰§è¡Œé€»è¾‘ä¸»æµç¨‹å¦‚ä¸‹å›¾( <a href="http://www.yunai.me/images/Elastic-Job/2017_09_23/02.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_09_23/02.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// æ£€æŸ¥ ä½œä¸šæ‰§è¡Œç¯å¢ƒ</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       jobFacade.checkJobExecutionEnvironment();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> JobExecutionEnvironmentException cause) &#123;</div><div class="line">       jobExceptionHandler.handleException(jobName, cause);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è·å– å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡</span></div><div class="line">   ShardingContexts shardingContexts = jobFacade.getShardingContexts();</div><div class="line">   <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_STAGING)</span></div><div class="line">   <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">       jobFacade.postJobStatusTraceEvent(shardingContexts.getTaskId(), State.TASK_STAGING, String.format(<span class="string">"Job '%s' execute begin."</span>, jobName));</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è·³è¿‡ å­˜åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡ä½œä¸š</span></div><div class="line">   <span class="keyword">if</span> (jobFacade.misfireIfRunning(shardingContexts.getShardingItemParameters().keySet())) &#123;</div><div class="line">       <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_FINISHED)</span></div><div class="line">       <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">           jobFacade.postJobStatusTraceEvent(shardingContexts.getTaskId(), State.TASK_FINISHED, String.format(</div><div class="line">                   <span class="string">"Previous job '%s' - shardingItems '%s' is still running, misfired job will start after previous job completed."</span>, jobName, </div><div class="line">                   shardingContexts.getShardingItemParameters().keySet()));</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ‰§è¡Œ ä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       jobFacade.beforeJobExecuted(shardingContexts);</div><div class="line">       <span class="comment">//CHECKSTYLE:OFF</span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable cause) &#123;</div><div class="line">       <span class="comment">//CHECKSTYLE:ON</span></div><div class="line">       jobExceptionHandler.handleException(jobName, cause);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ‰§è¡Œ æ™®é€šè§¦å‘çš„ä½œä¸š</span></div><div class="line">   execute(shardingContexts, JobExecutionEvent.ExecutionSource.NORMAL_TRIGGER);</div><div class="line">   <span class="comment">// æ‰§è¡Œ è¢«è·³è¿‡è§¦å‘çš„ä½œä¸š</span></div><div class="line">   <span class="keyword">while</span> (jobFacade.isExecuteMisfired(shardingContexts.getShardingItemParameters().keySet())) &#123;</div><div class="line">       jobFacade.clearMisfire(shardingContexts.getShardingItemParameters().keySet());</div><div class="line">       execute(shardingContexts, JobExecutionEvent.ExecutionSource.MISFIRE);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ‰§è¡Œ ä½œä¸šå¤±æ•ˆè½¬ç§»</span></div><div class="line">   jobFacade.failoverIfNecessary();</div><div class="line">   <span class="comment">// æ‰§è¡Œ ä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       jobFacade.afterJobExecuted(shardingContexts);</div><div class="line">       <span class="comment">//CHECKSTYLE:OFF</span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable cause) &#123;</div><div class="line">       <span class="comment">//CHECKSTYLE:ON</span></div><div class="line">       jobExceptionHandler.handleException(jobName, cause);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»£ç æ­¥éª¤æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥å¾€ä¸‹çœ‹ã€‚</p>
<h2 id="4-1-æ£€æŸ¥ä½œä¸šæ‰§è¡Œç¯å¢ƒ"><a href="#4-1-æ£€æŸ¥ä½œä¸šæ‰§è¡Œç¯å¢ƒ" class="headerlink" title="4.1 æ£€æŸ¥ä½œä¸šæ‰§è¡Œç¯å¢ƒ"></a>4.1 æ£€æŸ¥ä½œä¸šæ‰§è¡Œç¯å¢ƒ</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkJobExecutionEnvironment</span><span class="params">()</span> <span class="keyword">throws</span> JobExecutionEnvironmentException </span>&#123;</div><div class="line">   configService.checkMaxTimeDiffSecondsTolerable();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>ConfigService#checkMaxTimeDiffSecondsTolerable()</code> æ–¹æ³•æ ¡éªŒæœ¬æœºæ—¶é—´æ˜¯å¦åˆæ³•ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-config/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹çš„ã€Œ3.3ã€æ ¡éªŒæœ¬æœºæ—¶é—´æ˜¯å¦åˆæ³•</a> å·²ç»è§£æã€‚</li>
<li>å½“æ ¡éªŒæœ¬æœºæ—¶é—´ä¸åˆæ³•æ—¶ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚è‹¥ä½¿ç”¨ DefaultJobExceptionHandler ä½œä¸ºå¼‚å¸¸å¤„ç†ï¼Œ<strong>åªæ‰“å°æ—¥å¿—ï¼Œä¸ä¼šç»ˆæ­¢ä½œä¸šæ‰§è¡Œ</strong>ã€‚å¦‚æœä½ çš„ä½œä¸šå¯¹æ—¶é—´ç²¾å‡†åº¦æœ‰æ¯”è¾ƒé«˜çš„è¦æ±‚ï¼ŒæœŸæœ›ä½œä¸š<strong>ç»ˆæ­¢</strong>æ‰§è¡Œï¼Œå¯ä»¥è‡ªå®šä¹‰ JobExceptionHandler å®ç°å¯¹å¼‚å¸¸çš„å¤„ç†ã€‚</li>
</ul>
<h2 id="4-2-è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡"><a href="#4-2-è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡" class="headerlink" title="4.2 è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡"></a>4.2 è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡</h2><p>è°ƒç”¨ <code>LiteJobFacade#getShardingContexts()</code> æ–¹æ³•è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡ã€‚é€šè¿‡è¿™ä¸ªæ–¹æ³•ï¼Œä½œä¸šè·å¾—<strong>å…¶æ‰€åˆ†é…æ‰§è¡Œçš„åˆ†ç‰‡é¡¹</strong>ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
<h2 id="4-3-å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶"><a href="#4-3-å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶" class="headerlink" title="4.3 å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶"></a>4.3 å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶</h2><p>è°ƒç”¨ <code>LiteJobFacade#postJobStatusTraceEvent()</code> æ–¹æ³•å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-event-trace/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šäº‹ä»¶è¿½è¸ªã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
<h2 id="4-4-è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š"><a href="#4-4-è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š" class="headerlink" title="4.4 è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š"></a>4.4 è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š</h2><p>è¯¥é€»è¾‘å’Œ<strong>ã€Œ4.7ã€æ‰§è¡Œè¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š</strong>ï¼Œä¸€èµ·è§£æï¼Œå¯ä»¥æ•´ä½“æ€§çš„ç†è§£ Elastic-Job-Lite å¯¹è¢«é”™è¿‡æ‰§è¡Œ( misfired )çš„ä½œä¸šå¤„ç†ã€‚</p>
<h2 id="4-5-æ‰§è¡Œä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•"><a href="#4-5-æ‰§è¡Œä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•" class="headerlink" title="4.5 æ‰§è¡Œä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•"></a>4.5 æ‰§è¡Œä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (ElasticJobListener each : elasticJobListeners) &#123;</div><div class="line">       each.beforeJobExecuted(shardingContexts);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ä½œä¸šç›‘å¬å™¨æ‰§è¡Œä½œä¸š<strong>æ‰§è¡Œå‰</strong>çš„æ–¹æ³•ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-listener/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šç›‘å¬å™¨ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
<h2 id="4-6-æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸š"><a href="#4-6-æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸š" class="headerlink" title="4.6 æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸š"></a>4.6 æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸š</h2><p>è¿™ä¸ªå°èŠ‚çš„æ ‡é¢˜ä¸å¤ªå‡†ç¡®ï¼Œå…¶ä»–<strong>ä½œä¸šæ¥æº</strong>( ExecutionSource )ä¹Ÿæ˜¯æ‰§è¡Œè¿™æ ·çš„é€»è¾‘ã€‚æœ¬å°èŠ‚æ‰§è¡Œä½œä¸šä¼šç»å† 4 ä¸ªæ–¹æ³•ï¼Œæ–¹æ³•<strong>é¡ºåº</strong>å¾€ä¸‹è°ƒç”¨ï¼Œæˆ‘ä»¬é€ä¸ªæ¥çœ‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œå¤šä¸ªä½œä¸šçš„åˆ†ç‰‡</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</div><div class="line">* <span class="doctag">@param</span> executionSource æ‰§è¡Œæ¥æº</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œå¤šä¸ªä½œä¸šçš„åˆ†ç‰‡</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</div><div class="line">* <span class="doctag">@param</span> executionSource æ‰§è¡Œæ¥æº</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œå•ä¸ªä½œä¸šçš„åˆ†ç‰‡</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</div><div class="line">* <span class="doctag">@param</span> item åˆ†ç‰‡åºå·</div><div class="line">* <span class="doctag">@param</span> startEvent æ‰§è¡Œäº‹ä»¶(å¼€å§‹)</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> <span class="keyword">int</span> item, <span class="keyword">final</span> JobExecutionEvent startEvent)</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œå•ä¸ªä½œä¸šçš„åˆ†ç‰‡ã€å­ç±»å®ç°ã€‘</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContext åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(ShardingContext shardingContext)</span></span>;</div></pre></td></tr></table></figure>
<p>psï¼š<strong>ä½œä¸šäº‹ä»¶</strong>ç›¸å…³é€»è¾‘ï¼Œå…ˆç»Ÿä¸€è·³è¿‡ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-event-trace/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šäº‹ä»¶è¿½è¸ªã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
<hr>
<p><strong>private void execute(shardingContexts, executionSource)</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ— å¯æ‰§è¡Œçš„åˆ†ç‰‡ï¼Œå‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_FINISHED)</span></div><div class="line">   <span class="keyword">if</span> (shardingContexts.getShardingItemParameters().isEmpty()) &#123;</div><div class="line">       <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">           jobFacade.postJobStatusTraceEvent(shardingContexts.getTaskId(), State.TASK_FINISHED, String.format(<span class="string">"Sharding item for job '%s' is empty."</span>, jobName));</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯</span></div><div class="line">   jobFacade.registerJobBegin(shardingContexts);</div><div class="line">   <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_RUNNING)</span></div><div class="line">   String taskId = shardingContexts.getTaskId();</div><div class="line">   <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">       jobFacade.postJobStatusTraceEvent(taskId, State.TASK_RUNNING, <span class="string">""</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// TODO</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       process(shardingContexts, executionSource);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="comment">// TODO è€ƒè™‘å¢åŠ ä½œä¸šå¤±è´¥çš„çŠ¶æ€ï¼Œå¹¶ä¸”è€ƒè™‘å¦‚ä½•å¤„ç†ä½œä¸šå¤±è´¥çš„æ•´ä½“å›è·¯</span></div><div class="line">       <span class="comment">// æ³¨å†Œä½œä¸šå®Œæˆä¿¡æ¯</span></div><div class="line">       jobFacade.registerJobCompleted(shardingContexts);</div><div class="line">       <span class="comment">// æ ¹æ®æ˜¯å¦æœ‰å¼‚å¸¸ï¼Œå‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_FINISHED / State.TASK_ERROR)</span></div><div class="line">       <span class="keyword">if</span> (itemErrorMessages.isEmpty()) &#123;</div><div class="line">           <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">               jobFacade.postJobStatusTraceEvent(taskId, State.TASK_FINISHED, <span class="string">""</span>);</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">               jobFacade.postJobStatusTraceEvent(taskId, State.TASK_ERROR, itemErrorMessages.toString());</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>æ–¹æ³•å‚æ•° <code>executionSource</code> ä»£è¡¨æ‰§è¡Œæ¥æº( ExecutionSource )ï¼Œä¸€å…±æœ‰ä¸‰ç§ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ExecutionSource &#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * æ™®é€šè§¦å‘æ‰§è¡Œ</div><div class="line">    */</div><div class="line">   NORMAL_TRIGGER,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * è¢«é”™è¿‡æ‰§è¡Œ</div><div class="line">    */</div><div class="line">   MISFIRE,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * å¤±æ•ˆè½¬ç§»æ‰§è¡Œ</div><div class="line">    */</div><div class="line">   FAILOVER</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>LiteJobFacade#registerJobBegin(...)</code> æ–¹æ³•æ³¨å†Œä½œä¸š<strong>å¯åŠ¨</strong>ä¿¡æ¯ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerJobBegin</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   executionService.registerJobBegin(shardingContexts);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ExecutionService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerJobBegin</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   JobRegistry.getInstance().setJobRunning(jobName, <span class="keyword">true</span>);</div><div class="line">   <span class="keyword">if</span> (!configService.load(<span class="keyword">true</span>).isMonitorExecution()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingContexts.getShardingItemParameters().keySet()) &#123;</div><div class="line">       jobNodeStorage.fillEphemeralJobNode(ShardingNode.getRunningNode(each), <span class="string">""</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä»…å½“ä½œä¸šé…ç½®è®¾ç½®<strong>ç›‘æ§ä½œä¸šè¿è¡Œæ—¶çŠ¶æ€</strong>( <code>LiteJobConfiguration.monitorExecution = true</code> )æ—¶ï¼Œè®°å½•ä½œä¸šè¿è¡ŒçŠ¶æ€ã€‚</li>
<li>è°ƒç”¨ <code>JobNodeStorage#fillEphemeralJobNode(...)</code> æ–¹æ³•è®°å½•<strong>åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹</strong>æ­£åœ¨è¿è¡Œä¸­ã€‚å¦‚ä½•è®°å½•çš„ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-storage/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ•°æ®å­˜å‚¨ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>LiteJobFacade#registerJobCompleted(...)</code> æ–¹æ³•æ³¨å†Œä½œä¸š<strong>å®Œæˆ</strong>ä¿¡æ¯ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerJobCompleted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   executionService.registerJobCompleted(shardingContexts);</div><div class="line">   <span class="keyword">if</span> (configService.load(<span class="keyword">true</span>).isFailover()) &#123;</div><div class="line">       failoverService.updateFailoverComplete(shardingContexts.getShardingItemParameters().keySet());</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ExecutionService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ³¨å†Œä½œä¸šå®Œæˆä¿¡æ¯.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerJobCompleted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   JobRegistry.getInstance().setJobRunning(jobName, <span class="keyword">false</span>);</div><div class="line">   <span class="keyword">if</span> (!configService.load(<span class="keyword">true</span>).isMonitorExecution()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingContexts.getShardingItemParameters().keySet()) &#123;</div><div class="line">       jobNodeStorage.removeJobNodeIfExisted(ShardingNode.getRunningNode(each));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä»…å½“ä½œä¸šé…ç½®è®¾ç½®<strong>ç›‘æ§ä½œä¸šè¿è¡Œæ—¶çŠ¶æ€</strong>( <code>LiteJobConfiguration.monitorExecution = true</code> )ï¼Œç§»é™¤ä½œä¸šè¿è¡ŒçŠ¶æ€ã€‚</li>
<li>è°ƒç”¨ <code>JobNodeStorage#removeJobNodeIfExisted(...)</code> æ–¹æ³•<strong>ç§»é™¤åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹</strong>æ­£åœ¨è¿è¡Œä¸­çš„æ ‡è®°ï¼Œè¡¨ç¤ºä½œä¸šåˆ†ç‰‡é¡¹ä¸åœ¨è¿è¡Œä¸­çŠ¶æ€ã€‚</li>
<li>è°ƒç”¨ <code>FailoverService#updateFailoverComplete(...)</code> æ–¹æ³•æ›´æ–°æ‰§è¡Œå®Œæ¯•å¤±æ•ˆè½¬ç§»çš„åˆ†ç‰‡é¡¹çŠ¶æ€ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-failover/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
</li>
</ul>
<hr>
<p><strong>private void process(shardingContexts, executionSource)</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">   Collection&lt;Integer&gt; items = shardingContexts.getShardingItemParameters().keySet();</div><div class="line">   <span class="comment">// å•åˆ†ç‰‡ï¼Œç›´æ¥æ‰§è¡Œ</span></div><div class="line">   <span class="keyword">if</span> (<span class="number">1</span> == items.size()) &#123;</div><div class="line">       <span class="keyword">int</span> item = shardingContexts.getShardingItemParameters().keySet().iterator().next();</div><div class="line">       JobExecutionEvent jobExecutionEvent =  <span class="keyword">new</span> JobExecutionEvent(shardingContexts.getTaskId(), jobName, executionSource, item);</div><div class="line">       <span class="comment">// æ‰§è¡Œä¸€ä¸ªä½œä¸š</span></div><div class="line">       process(shardingContexts, item, jobExecutionEvent);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å¤šåˆ†ç‰‡ï¼Œå¹¶è¡Œæ‰§è¡Œ</span></div><div class="line">   <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(items.size());</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">final</span> <span class="keyword">int</span> each : items) &#123;</div><div class="line">       <span class="keyword">final</span> JobExecutionEvent jobExecutionEvent = <span class="keyword">new</span> JobExecutionEvent(shardingContexts.getTaskId(), jobName, executionSource, each);</div><div class="line">       <span class="keyword">if</span> (executorService.isShutdown()) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">       executorService.submit(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">           </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">// æ‰§è¡Œä¸€ä¸ªä½œä¸š</span></div><div class="line">                   process(shardingContexts, each, jobExecutionEvent);</div><div class="line">               &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                   latch.countDown();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç­‰å¾…å¤šåˆ†ç‰‡å…¨éƒ¨å®Œæˆ</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       latch.await();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException ex) &#123;</div><div class="line">       Thread.currentThread().interrupt();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>åˆ†é…<strong>å•</strong>åˆ†ç‰‡é¡¹æ—¶ï¼Œç›´æ¥æ‰§è¡Œï¼Œæ— éœ€ä½¿ç”¨çº¿ç¨‹æ± ï¼Œæ€§èƒ½æ›´ä¼˜ã€‚</li>
<li>åˆ†é…<strong>å¤š</strong>åˆ†ç‰‡é¡¹æ—¶ï¼Œä½¿ç”¨çº¿ç¨‹æ± <strong>å¹¶å‘</strong>æ‰§è¡Œï¼Œé€šè¿‡ CountDownLatch å®ç°ç­‰å¾…åˆ†ç‰‡é¡¹å…¨éƒ¨æ‰§è¡Œå®Œæˆã€‚</li>
</ul>
<hr>
<p><strong>private void process(shardingContexts, item, startEvent)</strong><br><strong>protected abstract void process(shardingContext)</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> <span class="keyword">int</span> item, <span class="keyword">final</span> JobExecutionEvent startEvent)</span> </span>&#123;</div><div class="line">   <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(å¼€å§‹)</span></div><div class="line">   <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">       jobFacade.postJobExecutionEvent(startEvent);</div><div class="line">   &#125;</div><div class="line">   log.trace(<span class="string">"Job '&#123;&#125;' executing, item is: '&#123;&#125;'."</span>, jobName, item);</div><div class="line">   JobExecutionEvent completeEvent;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// æ‰§è¡Œå•ä¸ªä½œä¸š</span></div><div class="line">       process(<span class="keyword">new</span> ShardingContext(shardingContexts, item));</div><div class="line">       <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(æˆåŠŸ)</span></div><div class="line">       completeEvent = startEvent.executionSuccess();</div><div class="line">       log.trace(<span class="string">"Job '&#123;&#125;' executed, item is: '&#123;&#125;'."</span>, jobName, item);</div><div class="line">       <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">           jobFacade.postJobExecutionEvent(completeEvent);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// CHECKSTYLE:OFF</span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable cause) &#123;</div><div class="line">       <span class="comment">// CHECKSTYLE:ON</span></div><div class="line">       <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(å¤±è´¥)</span></div><div class="line">       completeEvent = startEvent.executionFailure(cause);</div><div class="line">       jobFacade.postJobExecutionEvent(completeEvent);</div><div class="line">       <span class="comment">// è®¾ç½®è¯¥åˆ†ç‰‡æ‰§è¡Œå¼‚å¸¸ä¿¡æ¯</span></div><div class="line">       itemErrorMessages.put(item, ExceptionUtil.transform(cause));</div><div class="line">       <span class="comment">//</span></div><div class="line">       jobExceptionHandler.handleException(jobName, cause);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(ShardingContext shardingContext)</span></span>;</div></pre></td></tr></table></figure>
<ul>
<li>ä¸åŒä½œä¸šæ‰§è¡Œå™¨å®ç°ç±»é€šè¿‡å®ç° <code>#process(shardingContext)</code> æŠ½è±¡æ–¹æ³•ï¼Œå®ç°å¯¹<strong>å•ä¸ªåˆ†ç‰‡é¡¹</strong>ä½œä¸šçš„å¤„ç†ã€‚</li>
<li>ä¸åŒä½œä¸šæ‰§è¡Œå™¨å®ç°ç±»é€šè¿‡å®ç° <code>#process(shardingContext)</code> æŠ½è±¡æ–¹æ³•ï¼Œå®ç°å¯¹<strong>å•ä¸ªåˆ†ç‰‡é¡¹</strong>ä½œä¸šçš„å¤„ç†ã€‚</li>
<li>ä¸åŒä½œä¸šæ‰§è¡Œå™¨å®ç°ç±»é€šè¿‡å®ç° <code>#process(shardingContext)</code> æŠ½è±¡æ–¹æ³•ï¼Œå®ç°å¯¹<strong>å•ä¸ªåˆ†ç‰‡é¡¹</strong>ä½œä¸šçš„å¤„ç†ã€‚</li>
</ul>
<h3 id="4-6-1-ç®€å•ä½œä¸šæ‰§è¡Œå™¨"><a href="#4-6-1-ç®€å•ä½œä¸šæ‰§è¡Œå™¨" class="headerlink" title="4.6.1 ç®€å•ä½œä¸šæ‰§è¡Œå™¨"></a>4.6.1 ç®€å•ä½œä¸šæ‰§è¡Œå™¨</h3><p>SimpleJobExecutorï¼Œç®€å•ä½œä¸šæ‰§è¡Œå™¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleJobExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç®€å•ä½œä¸šå®ç°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SimpleJob simpleJob;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">        simpleJob.execute(shardingContext);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>SimpleJob#execute()</code> æ–¹æ³•å¯¹å•ä¸ªåˆ†ç‰‡é¡¹ä½œä¸šè¿›è¡Œå¤„ç†ã€‚</li>
</ul>
<h3 id="4-6-2-æ•°æ®æµä½œä¸šæ‰§è¡Œå™¨"><a href="#4-6-2-æ•°æ®æµä½œä¸šæ‰§è¡Œå™¨" class="headerlink" title="4.6.2 æ•°æ®æµä½œä¸šæ‰§è¡Œå™¨"></a>4.6.2 æ•°æ®æµä½œä¸šæ‰§è¡Œå™¨</h3><p>DataflowJobExecutorï¼Œæ•°æ®æµä½œä¸šæ‰§è¡Œå™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DataflowJobExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•°æ®æµä½œä¸šå¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataflowJob&lt;Object&gt; dataflowJob;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">        DataflowJobConfiguration dataflowConfig = (DataflowJobConfiguration) getJobRootConfig().getTypeConfig();</div><div class="line">        <span class="keyword">if</span> (dataflowConfig.isStreamingProcess()) &#123; <span class="comment">// æµå¼å¤„ç†æ•°æ®</span></div><div class="line">            streamingExecute(shardingContext);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            oneOffExecute(shardingContext);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æµå¼å¤„ç†</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> shardingContext åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">streamingExecute</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">        List&lt;Object&gt; data = fetchData(shardingContext);</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">null</span> != data &amp;&amp; !data.isEmpty()) &#123;</div><div class="line">            processData(shardingContext, data);</div><div class="line">            <span class="keyword">if</span> (!getJobFacade().isEligibleForJobRunning()) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            data = fetchData(shardingContext);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸€æ¬¡å¤„ç†</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> shardingContext åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">oneOffExecute</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">        List&lt;Object&gt; data = fetchData(shardingContext);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != data &amp;&amp; !data.isEmpty()) &#123;</div><div class="line">            processData(shardingContext, data);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>å½“ä½œä¸šé…ç½®è®¾ç½®æµå¼å¤„ç†æ•°æ®( <code>DataflowJobConfiguration.streamingProcess = true</code> ) æ—¶ï¼Œè°ƒç”¨ <code>#streamingExecute()</code> <strong>ä¸æ–­</strong>åŠ è½½æ•°æ®ï¼Œ<strong>ä¸æ–­</strong>å¤„ç†æ•°æ®ï¼Œç›´åˆ°<strong>æ•°æ®ä¸ºç©º</strong> æˆ–è€… <strong>ä½œä¸šä¸é€‚åˆç»§ç»­è¿è¡Œ</strong>ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEligibleForJobRunning</span><span class="params">()</span> </span>&#123;</div><div class="line">   LiteJobConfiguration liteJobConfig = configService.load(<span class="keyword">true</span>);</div><div class="line">   <span class="keyword">if</span> (liteJobConfig.getTypeConfig() <span class="keyword">instanceof</span> DataflowJobConfiguration) &#123;</div><div class="line">       <span class="keyword">return</span> !shardingService.isNeedSharding() <span class="comment">// ä½œä¸šä¸éœ€è¦é‡æ–°åˆ†ç‰‡</span></div><div class="line">               &amp;&amp; ((DataflowJobConfiguration) liteJobConfig.getTypeConfig()).isStreamingProcess();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> !shardingService.isNeedSharding(); <span class="comment">// ä½œä¸šä¸éœ€è¦é‡æ–°åˆ†ç‰‡</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>ä½œä¸šéœ€è¦é‡æ–°åˆ†ç‰‡ï¼Œæ‰€ä»¥ä¸é€‚åˆç»§ç»­æµå¼æ•°æ®å¤„ç†ã€‚</p>
<blockquote>
<p>å¦‚æœé‡‡ç”¨æµå¼ä½œä¸šå¤„ç†æ–¹å¼ï¼Œå»ºè®®processDataå¤„ç†æ•°æ®åæ›´æ–°å…¶çŠ¶æ€ï¼Œé¿å…fetchDataå†æ¬¡æŠ“å–åˆ°ï¼Œä»è€Œä½¿å¾—ä½œä¸šæ°¸ä¸åœæ­¢ã€‚ æµå¼æ•°æ®å¤„ç†å‚ç…§TbScheduleè®¾è®¡ï¼Œé€‚ç”¨äºä¸é—´æ­‡çš„æ•°æ®å¤„ç†ã€‚</p>
</blockquote>
</li>
</ul>
</li>
<li><p>å½“ä½œä¸šé…ç½®<strong>ä¸</strong>è®¾ç½®æµå¼å¤„ç†æ•°æ®( <code>DataflowJobConfiguration.streamingProcess = false</code> ) æ—¶ï¼Œè°ƒç”¨ <code>#oneOffExecute()</code> <strong>ä¸€æ¬¡</strong>åŠ è½½æ•°æ®ï¼Œ<strong>ä¸€æ¬¡</strong>å¤„ç†æ•°æ®ã€‚</p>
</li>
<li><p>è°ƒç”¨ <code>#fetchData()</code> æ–¹æ³•åŠ è½½æ•°æ®ï¼›è°ƒç”¨ <code>#processData(...)</code> æ–¹æ³•å¤„ç†æ•°æ®ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DataflowJobExecutor.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åŠ è½½æ•°æ®</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContext åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">* <span class="doctag">@return</span> æ•°æ®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> List&lt;Object&gt; <span class="title">fetchData</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> dataflowJob.fetchData(shardingContext);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* å¤„ç†æ•°æ®</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContext åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">* <span class="doctag">@param</span> data æ•°æ®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processData</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext, <span class="keyword">final</span> List&lt;Object&gt; data)</span> </span>&#123;</div><div class="line">   dataflowJob.processData(shardingContext, data);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="4-6-3-è„šæœ¬ä½œä¸šæ‰§è¡Œå™¨"><a href="#4-6-3-è„šæœ¬ä½œä¸šæ‰§è¡Œå™¨" class="headerlink" title="4.6.3 è„šæœ¬ä½œä¸šæ‰§è¡Œå™¨"></a>4.6.3 è„šæœ¬ä½œä¸šæ‰§è¡Œå™¨</h3><p>ScriptJobExecutorï¼Œè„šæœ¬ä½œä¸šæ‰§è¡Œå™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ScriptJobExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> String scriptCommandLine = ((ScriptJobConfiguration) getJobRootConfig().getTypeConfig()).getScriptCommandLine();</div><div class="line">        <span class="keyword">if</span> (Strings.isNullOrEmpty(scriptCommandLine)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Cannot find script command line for job '%s', job is not executed."</span>, shardingContext.getJobName());</div><div class="line">        &#125;</div><div class="line">        executeScript(shardingContext, scriptCommandLine);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰§è¡Œè„šæœ¬</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> shardingContext åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">     * <span class="doctag">@param</span> scriptCommandLine æ‰§è¡Œè„šæœ¬è·¯å¾„</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeScript</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext, <span class="keyword">final</span> String scriptCommandLine)</span> </span>&#123;</div><div class="line">        CommandLine commandLine = CommandLine.parse(scriptCommandLine);</div><div class="line">        <span class="comment">// JSON æ ¼å¼ä¼ é€’å‚æ•°</span></div><div class="line">        commandLine.addArgument(GsonFactory.getGson().toJson(shardingContext), <span class="keyword">false</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">new</span> DefaultExecutor().execute(commandLine);</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Execute script failure."</span>, ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p><code>scriptCommandLine</code> ä¼ é€’çš„æ˜¯<strong>è„šæœ¬è·¯å¾„</strong>ã€‚ä½¿ç”¨ <a href="https://commons.apache.org/proper/commons-exec/" rel="external nofollow noopener noreferrer" target="_blank">Apache Commons Exec</a> å·¥å…·åŒ…å®ç°è„šæœ¬è°ƒç”¨ï¼š</p>
<blockquote>
<p>Scriptç±»å‹ä½œä¸šæ„ä¸ºè„šæœ¬ç±»å‹ä½œä¸šï¼Œæ”¯æŒshellï¼Œpythonï¼Œperlç­‰æ‰€æœ‰ç±»å‹è„šæœ¬ã€‚åªéœ€é€šè¿‡æ§åˆ¶å°æˆ–ä»£ç é…ç½®scriptCommandLineå³å¯ï¼Œæ— éœ€ç¼–ç ã€‚æ‰§è¡Œè„šæœ¬è·¯å¾„å¯åŒ…å«å‚æ•°ï¼Œå‚æ•°ä¼ é€’å®Œæ¯•åï¼Œä½œä¸šæ¡†æ¶ä¼šè‡ªåŠ¨è¿½åŠ æœ€åä¸€ä¸ªå‚æ•°ä¸ºä½œä¸šè¿è¡Œæ—¶ä¿¡æ¯ã€‚</p>
</blockquote>
</li>
<li><p>è„šæœ¬å‚æ•°ä¼ é€’ä½¿ç”¨ JSON æ ¼å¼ã€‚</p>
</li>
</ul>
<h2 id="4-7-æ‰§è¡Œè¢«é”™è¿‡è§¦å‘çš„ä½œä¸š"><a href="#4-7-æ‰§è¡Œè¢«é”™è¿‡è§¦å‘çš„ä½œä¸š" class="headerlink" title="4.7 æ‰§è¡Œè¢«é”™è¿‡è§¦å‘çš„ä½œä¸š"></a>4.7 æ‰§è¡Œè¢«é”™è¿‡è§¦å‘çš„ä½œä¸š</h2><p>å½“ä½œä¸šæ‰§è¡Œè¿‡ä¹…ï¼Œå¯¼è‡´åˆ°è¾¾ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´æœªè¿›è¡Œä¸‹ä¸€æ¬¡ä½œä¸šæ‰§è¡Œï¼ŒElastic-Job-Lite ä¼šè®¾ç½®è¯¥ä½œä¸šåˆ†ç‰‡é¡¹ä¸ºè¢«é”™è¿‡æ‰§è¡Œ( misfired )ã€‚ä¸‹ä¸€æ¬¡ä½œä¸šæ‰§è¡Œæ—¶ï¼Œä¼š<strong>è¡¥å……</strong>æ‰§è¡Œè¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p>
<p><strong>æ ‡è®°ä½œä¸šè¢«é”™è¿‡æ‰§è¡Œ</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobScheduler.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> Scheduler <span class="title">createScheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">   Scheduler result;</div><div class="line">   <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">   result.getListenerManager().addTriggerListener(schedulerFacade.newJobTriggerListener());</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Properties <span class="title">getBaseQuartzProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">   result.put(<span class="string">"org.quartz.jobStore.misfireThreshold"</span>, <span class="string">"1"</span>);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobScheduleController.class</span></div><div class="line"><span class="function"><span class="keyword">private</span> CronTrigger <span class="title">createTrigger</span><span class="params">(<span class="keyword">final</span> String cron)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> TriggerBuilder.newTrigger()</div><div class="line">           .withIdentity(triggerIdentity)</div><div class="line">           .withSchedule(CronScheduleBuilder.cronSchedule(cron)</div><div class="line">           .withMisfireHandlingInstructionDoNothing())</div><div class="line">           .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>org.quartz.jobStore.misfireThreshold</code> è®¾ç½®è¶…è¿‡ 1 æ¯«ç§’ï¼Œä½œä¸šåˆ†ç‰‡é¡¹å³è¢«è§†ä¸ºé”™è¿‡æ‰§è¡Œã€‚</li>
<li><code>#withMisfireHandlingInstructionDoNothing()</code> è®¾ç½® Quartz ç³»ç»Ÿä¸ä¼šç«‹åˆ»å†æ‰§è¡Œä»»åŠ¡ï¼Œè€Œæ˜¯ç­‰åˆ°è·ç¦»ç›®å‰æ—¶é—´æœ€è¿‘çš„é¢„è®¡æ—¶é—´æ‰§è¡Œã€‚<strong>é‡æ–°æ‰§è¡Œè¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸šäº¤ç»™ Elastic-Job-Lite å¤„ç†</strong>ã€‚</li>
<li><p>ä½¿ç”¨ TriggerListener ç›‘å¬è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸šåˆ†ç‰‡é¡¹ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobTriggerListener.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobTriggerListener</span> <span class="keyword">extends</span> <span class="title">TriggerListenerSupport</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">triggerMisfired</span><span class="params">(<span class="keyword">final</span> Trigger trigger)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != trigger.getPreviousFireTime()) &#123;</div><div class="line">            executionService.setMisfire(shardingService.getLocalShardingItems());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ExecutionService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMisfire</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; items)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : items) &#123;</div><div class="line">       jobNodeStorage.createJobNodeIfNeeded(ShardingNode.getMisfireNode(each));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>#setMisfire(...)</code> è®¾ç½®ä½œä¸šåˆ†ç‰‡é¡¹è¢«é”™è¿‡æ‰§è¡Œã€‚</li>
</ul>
</li>
</ul>
<p><strong>è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">misfireIfRunning</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> executionService.misfireIfHasRunningItems(shardingItems);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ExecutionService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">misfireIfHasRunningItems</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; items)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!hasRunningItems(items)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">   setMisfire(items);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasRunningItems</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; items)</span> </span>&#123;</div><div class="line">   LiteJobConfiguration jobConfig = configService.load(<span class="keyword">true</span>);</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> == jobConfig || !jobConfig.isMonitorExecution()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : items) &#123;</div><div class="line">       <span class="keyword">if</span> (jobNodeStorage.isJobNodeExisted(ShardingNode.getRunningNode(each))) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å½“åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹é‡Œå­˜åœ¨<strong>ä»»æ„ä¸€ä¸ªåˆ†ç‰‡æ­£åœ¨è¿è¡Œ</strong>ä¸­ï¼Œè®¾ç½®åˆ†ç‰‡é¡¹<strong>éƒ½</strong>è¢«é”™è¿‡æ‰§è¡Œ( <code>misfired</code> )ï¼Œå¹¶ä¸æ‰§è¡Œè¿™äº›ä½œä¸šåˆ†ç‰‡ã€‚å¦‚æœä¸è¿›è¡Œè·³è¿‡ï¼Œåˆ™å¯èƒ½å¯¼è‡´<strong>åŒæ—¶</strong>è¿è¡ŒæŸä¸ªä½œä¸šåˆ†ç‰‡ã€‚</li>
<li>è¯¥åŠŸèƒ½ä¾èµ–ä½œä¸šé…ç½®<strong>ç›‘æ§ä½œä¸šè¿è¡Œæ—¶çŠ¶æ€</strong>( <code>LiteJobConfiguration.monitorExecution = true</code> )æ—¶ç”Ÿæ•ˆã€‚</li>
</ul>
<p><strong>æ‰§è¡Œè¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸šåˆ†ç‰‡é¡¹</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">   <span class="comment">// æ‰§è¡Œ è¢«è·³è¿‡è§¦å‘çš„ä½œä¸š</span></div><div class="line">   <span class="keyword">while</span> (jobFacade.isExecuteMisfired(shardingContexts.getShardingItemParameters().keySet())) &#123;</div><div class="line">       jobFacade.clearMisfire(shardingContexts.getShardingItemParameters().keySet());</div><div class="line">       execute(shardingContexts, JobExecutionEvent.ExecutionSource.MISFIRE);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExecuteMisfired</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> isEligibleForJobRunning() <span class="comment">// åˆé€‚ç»§ç»­è¿è¡Œ</span></div><div class="line">           &amp;&amp; configService.load(<span class="keyword">true</span>).getTypeConfig().getCoreConfig().isMisfire() <span class="comment">// ä½œä¸šé…ç½®å¼€å¯ä½œä¸šè¢«é”™è¿‡è§¦å‘</span></div><div class="line">           &amp;&amp; !executionService.getMisfiredJobItems(shardingItems).isEmpty(); <span class="comment">// æ‰€æ‰§è¡Œçš„ä½œä¸šåˆ†ç‰‡å­˜åœ¨è¢«é”™è¿‡( misfired )</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearMisfire</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   executionService.clearMisfire(shardingItems);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ¸…é™¤åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹è¢«é”™è¿‡æ‰§è¡Œçš„æ ‡è¯†ï¼Œå¹¶æ‰§è¡Œä½œä¸šåˆ†ç‰‡é¡¹ã€‚</li>
<li>ä¸ºä»€ä¹ˆæ­¤å¤„ä½¿ç”¨ <strong>while(â€¦)</strong>ï¼Ÿ<strong>é˜²å¾¡æ€§ç¼–ç¨‹</strong>ï¼Œ<code>#isExecuteMisfired(...)</code> åˆ¤æ–­ä½¿ç”¨<strong>å†…å­˜ç¼“å­˜</strong>çš„æ•°æ®ï¼Œè€Œè¯¥æ•°æ®çš„æ›´æ–°ä¾èµ– Zookeeper é€šçŸ¥è¿›è¡Œ<strong>å¼‚æ­¥</strong>æ›´æ–°ï¼Œå¯èƒ½å› ä¸ºå„ç§æƒ…å†µï¼Œä¾‹å¦‚ç½‘ç»œï¼Œæ•°æ®å¯èƒ½æœªåŠæ—¶æ›´æ–°å¯¼è‡´<strong>æ•°æ®ä¸ä¸€è‡´</strong>ã€‚ä½¿ç”¨ <strong>while(â€¦)</strong> è¿›è¡Œé˜²å¾¡ç¼–ç¨‹ï¼Œä¿è¯<strong>å†…å­˜ç¼“å­˜</strong>çš„æ•°æ®å·²ç»æ›´æ–°ã€‚</li>
</ul>
<h2 id="4-8-æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»"><a href="#4-8-æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»" class="headerlink" title="4.8 æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»"></a>4.8 æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failoverIfNecessary</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (configService.load(<span class="keyword">true</span>).isFailover()) &#123;</div><div class="line">       failoverService.failoverIfNecessary();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ä½œä¸šå¤±æ•ˆè½¬ç§»æœåŠ¡( FailoverService )æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»( <code>#failoverIfNecessary()</code> )ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-failover/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
<h2 id="4-9-æ‰§è¡Œä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•"><a href="#4-9-æ‰§è¡Œä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•" class="headerlink" title="4.9 æ‰§è¡Œä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•"></a>4.9 æ‰§è¡Œä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (ElasticJobListener each : elasticJobListeners) &#123;</div><div class="line">       each.afterJobExecuted(shardingContexts);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ä½œä¸šç›‘å¬å™¨æ‰§è¡Œä½œä¸š<strong>æ‰§è¡Œå</strong>çš„æ–¹æ³•ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-listener/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šç›‘å¬å™¨ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å‘¼ï¼ç•¥é•¿ç•¥é•¿ç•¥é•¿ï¼</p>
<p>ä¸‹é¢ä¼šæ›´æ–°å¦‚ä¸‹ä¸¤ç¯‡æ–‡ç« ï¼Œä¸ºåç»­çš„ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€å¤±æ•ˆè½¬ç§»ã€ä½œä¸šåˆ†ç‰‡ç­–ç•¥ç­‰æ–‡ç« åšé“ºå«ï¼š</p>
<ul>
<li><a href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” æ³¨å†Œä¸­å¿ƒã€‹</a></li>
<li><a href="http://www.yunai.me/Elastic-Job/job-storage/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ•°æ®å­˜å‚¨ã€‹</a></li>
</ul>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
<p>å•Šå•Šå•Šï¼Œæˆ‘å¥½æƒ³é©¬ä¸Šæ‹œè¯» Elastic-Job-Cloudã€‚ä¸ºäº†ä½ ä»¬ï¼Œæˆ‘å¿ä½äº†å¿ƒç¢ã€‚</p>
<p>æ—ç™½å›ï¼šç…ç¬”ç¬”è€…å·²ç»å·å·åœ¨è¯»äº†ã€‚<br>èŠ‹é“å›ï¼šæ—ç™½å›ï¼Œä½ å¤§çˆ·ï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-%E6%A6%82%E8%BF%B0&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-lite%E8%B0%83%E
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.yunai.me/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆå§‹åŒ–</title>
    <link href="http://www.yunai.me/Elastic-Job/job-init/"/>
    <id>http://www.yunai.me/Elastic-Job/job-init/</id>
    <published>2017-09-15T16:00:00.000Z</published>
    <updated>2017-09-02T09:55:12.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ä½œä¸šæ³¨å†Œè¡¨</a></li>
<li><a href="#">3. ä½œä¸šè°ƒåº¦å™¨</a><ul>
<li><a href="#">3.1 åˆ›å»º</a></li>
<li><a href="#">3.2 åˆå§‹åŒ–</a><ul>
<li><a href="#">3.2.1 æ›´æ–°ä½œä¸šé…ç½®</a></li>
<li><a href="#">3.2.2 è®¾ç½®å½“å‰ä½œä¸šåˆ†ç‰‡æ€»æ•°</a></li>
<li><a href="#">3.2.3 åˆ›å»ºä½œä¸šè°ƒåº¦æ§åˆ¶å™¨</a></li>
<li><a href="#">3.2.4 æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯</a></li>
<li><a href="#">3.2.5 è°ƒåº¦ä½œä¸š</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šåˆå§‹åŒ–</strong>ã€‚</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_09_09/16.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_09_16/01.png" alt=""></p>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-ä½œä¸šæ³¨å†Œè¡¨"><a href="#2-ä½œä¸šæ³¨å†Œè¡¨" class="headerlink" title="2. ä½œä¸šæ³¨å†Œè¡¨"></a>2. ä½œä¸šæ³¨å†Œè¡¨</h1><p>ä½œä¸šæ³¨å†Œè¡¨( JobRegistry )ï¼Œç»´æŠ¤äº†å•ä¸ª Elastic-Job-Lite <strong>è¿›ç¨‹å†…</strong>ä½œä¸šç›¸å…³ä¿¡æ¯ï¼Œå¯ä»¥ç†è§£æˆå…¶ä¸“å±çš„ Spring IOC å®¹å™¨ã€‚å› æ­¤ï¼Œå…¶æœ¬èº«æ˜¯ä¸€ä¸ª<strong>å•ä¾‹</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å•ä¾‹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> JobRegistry instance;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šè°ƒåº¦æ§åˆ¶å™¨é›†åˆ</div><div class="line">     * keyï¼šä½œä¸šåç§°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Map&lt;String, JobScheduleController&gt; schedulerMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ³¨å†Œä¸­å¿ƒé›†åˆ</div><div class="line">     * keyï¼šä½œä¸šåç§°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Map&lt;String, CoordinatorRegistryCenter&gt; regCenterMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šè¿è¡Œå®ä¾‹é›†åˆ</div><div class="line">     * keyï¼šä½œä¸šåç§°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Map&lt;String, JobInstance&gt; jobInstanceMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¿è¡Œä¸­ä½œä¸šé›†åˆ</div><div class="line">     * keyï¼šä½œä¸šåå­—</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Map&lt;String, Boolean&gt; jobRunningMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šæ€»åˆ†ç‰‡æ•°é‡é›†åˆ</div><div class="line">     * keyï¼šä½œä¸šåå­—</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Map&lt;String, Integer&gt; currentShardingTotalCountMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–ä½œä¸šæ³¨å†Œè¡¨å®ä¾‹.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span> ä½œä¸šæ³¨å†Œè¡¨å®ä¾‹</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobRegistry <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == instance) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (JobRegistry.class) &#123;</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> == instance) &#123;</div><div class="line">                    instance = <span class="keyword">new</span> JobRegistry();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// .... çœç•¥æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>instance</code> æ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œé€šè¿‡ <code>#getInstance()</code> æ–¹æ³•è·å–è¯¥å•ä¾‹ã€‚è¯¥å•ä¾‹çš„åˆ›å»ºæ–¹å¼ä¸º<strong><a href="http://wuchong.me/blog/2014/08/28/how-to-correctly-write-singleton-pattern/#%E5%8F%8C%E9%87%8D%E6%A3%80%E9%AA%8C%E9%94%81" rel="external nofollow noopener noreferrer" target="_blank">åŒé‡æ£€éªŒé”æ¨¡å¼</a></strong>ã€‚</li>
<li>Mapé›†åˆå±æ€§<strong>å…¨éƒ¨</strong>ä»¥<strong>ä½œä¸šåç§°</strong>ä½œä¸º KEYï¼Œé€šè¿‡ä½œä¸šåç§°ï¼Œå¯ä»¥è·å¾—ä½œä¸šç›¸å…³ä¿¡æ¯ã€‚</li>
<li>çœç•¥çš„æ–¹æ³•ï¼Œä¸‹æ–‡åœ¨å®é™…è°ƒç”¨æ—¶ï¼Œè¿›è¡Œè§£æã€‚</li>
</ul>
<h1 id="3-ä½œä¸šè°ƒåº¦å™¨"><a href="#3-ä½œä¸šè°ƒåº¦å™¨" class="headerlink" title="3. ä½œä¸šè°ƒåº¦å™¨"></a>3. ä½œä¸šè°ƒåº¦å™¨</h1><p>ä½œä¸šè°ƒåº¦å™¨( JobScheduler )ï¼Œåˆ›å»ºå¹¶åˆå§‹åŒ–åï¼Œè¿›è¡Œä½œä¸šè°ƒåº¦ã€‚</p>
<p><strong>Elastic-Job-Lite ä½¿ç”¨ Quartz ä½œä¸ºè°ƒåº¦å†…æ ¸ã€‚</strong></p>
<h2 id="3-1-åˆ›å»º"><a href="#3-1-åˆ›å»º" class="headerlink" title="3.1 åˆ›å»º"></a>3.1 åˆ›å»º</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobScheduler</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Liteä½œä¸šé…ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LiteJobConfiguration liteJobConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ³¨å†Œä¸­å¿ƒ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CoordinatorRegistryCenter regCenter;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è°ƒåº¦å™¨é—¨é¢å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SchedulerFacade schedulerFacade;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šé—¨é¢å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobFacade jobFacade;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobScheduler</span><span class="params">(<span class="keyword">final</span> CoordinatorRegistryCenter regCenter, <span class="keyword">final</span> LiteJobConfiguration liteJobConfig, <span class="keyword">final</span> ElasticJobListener... elasticJobListeners)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(regCenter, liteJobConfig, <span class="keyword">new</span> JobEventBus(), elasticJobListeners);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobScheduler</span><span class="params">(<span class="keyword">final</span> CoordinatorRegistryCenter regCenter, <span class="keyword">final</span> LiteJobConfiguration liteJobConfig, <span class="keyword">final</span> JobEventConfiguration jobEventConfig, </span></span></div><div class="line">                        <span class="keyword">final</span> ElasticJobListener... elasticJobListeners) &#123;</div><div class="line">        <span class="keyword">this</span>(regCenter, liteJobConfig, <span class="keyword">new</span> JobEventBus(jobEventConfig), elasticJobListeners);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">JobScheduler</span><span class="params">(<span class="keyword">final</span> CoordinatorRegistryCenter regCenter, <span class="keyword">final</span> LiteJobConfiguration liteJobConfig, <span class="keyword">final</span> JobEventBus jobEventBus, <span class="keyword">final</span> ElasticJobListener... elasticJobListeners)</span> </span>&#123;</div><div class="line">        <span class="comment">// æ·»åŠ  ä½œä¸šè¿è¡Œå®ä¾‹</span></div><div class="line">        JobRegistry.getInstance().addJobInstance(liteJobConfig.getJobName(), <span class="keyword">new</span> JobInstance());</div><div class="line">        <span class="comment">// è®¾ç½® Liteä½œä¸šé…ç½®</span></div><div class="line">        <span class="keyword">this</span>.liteJobConfig = liteJobConfig;</div><div class="line">        <span class="keyword">this</span>.regCenter = regCenter;</div><div class="line">        <span class="comment">// è®¾ç½® ä½œä¸šç›‘å¬å™¨</span></div><div class="line">        List&lt;ElasticJobListener&gt; elasticJobListenerList = Arrays.asList(elasticJobListeners);</div><div class="line">        setGuaranteeServiceForElasticJobListeners(regCenter, elasticJobListenerList);</div><div class="line">        <span class="comment">// è®¾ç½® è°ƒåº¦å™¨é—¨é¢å¯¹è±¡</span></div><div class="line">        schedulerFacade = <span class="keyword">new</span> SchedulerFacade(regCenter, liteJobConfig.getJobName(), elasticJobListenerList);</div><div class="line">        <span class="comment">// è®¾ç½® ä½œä¸šé—¨é¢å¯¹è±¡</span></div><div class="line">        jobFacade = <span class="keyword">new</span> LiteJobFacade(regCenter, liteJobConfig.getJobName(), Arrays.asList(elasticJobListeners), jobEventBus);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>#JobRegistry#addJobInstance()</code> æ–¹æ³•æ·»<strong>åŠ ä½œä¸šè¿è¡Œå®ä¾‹( JobInstance )</strong>ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobRegistry.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ä½œä¸šè¿è¡Œå®ä¾‹é›†åˆ</div><div class="line">* keyï¼šä½œä¸šåç§°</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> Map&lt;String, JobInstance&gt; jobInstanceMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line"><span class="comment">/**</span></div><div class="line">* æ·»åŠ ä½œä¸šå®ä¾‹.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> jobName ä½œä¸šåç§°</div><div class="line">* <span class="doctag">@param</span> jobInstance ä½œä¸šå®ä¾‹</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addJobInstance</span><span class="params">(<span class="keyword">final</span> String jobName, <span class="keyword">final</span> JobInstance jobInstance)</span> </span>&#123;</div><div class="line">   jobInstanceMap.put(jobName, jobInstance);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobInstance.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobInstance</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DELIMITER = <span class="string">"@-@"</span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šå®ä¾‹ä¸»é”®.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobInstanceId;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        jobInstanceId = IpUtils.getIp()</div><div class="line">                + DELIMITER</div><div class="line">                + ManagementFactory.getRuntimeMXBean().getName().split(<span class="string">"@"</span>)[<span class="number">0</span>]; <span class="comment">// PID</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>jobInstanceId</code> æ ¼å¼ï¼š<code>${IP}@-@${PID}</code>ã€‚å…¶ä¸­ <code>PID</code> ä¸ºè¿›ç¨‹ç¼–å·ã€‚åŒä¸€ä¸ª Elastic-Job-Lite å®ä¾‹ï¼Œ<strong>ä¸åŒ</strong>çš„ä½œä¸šä½¿ç”¨<strong>ç›¸åŒ</strong>çš„ä½œä¸šå®ä¾‹ä¸»é”®ã€‚</li>
</ul>
</li>
<li><p>è®¾ç½®ä½œä¸šç›‘å¬å™¨ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-listener/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šç›‘å¬å™¨ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
</li>
<li><p>SchedulerFacadeï¼Œä¸º<strong>è°ƒåº¦å™¨</strong>æä¾›å†…éƒ¨æœåŠ¡çš„é—¨é¢ç±»ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerFacade</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåç§°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šé…ç½®æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConfigurationService configService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåˆ†ç‰‡æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ShardingService shardingService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸»èŠ‚ç‚¹æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LeaderService leaderService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šæœåŠ¡å™¨æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServerService serverService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šè¿è¡Œå®ä¾‹æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InstanceService instanceService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰§è¡Œä½œä¸šæœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutionService executionService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šç›‘æ§æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MonitorService monitorService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è°ƒè§£ä½œä¸šä¸ä¸€è‡´çŠ¶æ€æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReconcileService reconcileService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šæ³¨å†Œä¸­å¿ƒçš„ç›‘å¬å™¨ç®¡ç†è€…</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> ListenerManager listenerManager;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SchedulerFacade</span><span class="params">(<span class="keyword">final</span> CoordinatorRegistryCenter regCenter, <span class="keyword">final</span> String jobName, <span class="keyword">final</span> List&lt;ElasticJobListener&gt; elasticJobListeners)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.jobName = jobName;</div><div class="line">        <span class="comment">// .... çœç•¥ new XXXXX() å¯¹è±¡</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>LiteJobFacadeï¼Œä¸º<strong>ä½œä¸š</strong>æä¾›å†…éƒ¨æœåŠ¡çš„é—¨é¢ç±»ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LiteJobFacade</span> <span class="keyword">implements</span> <span class="title">JobFacade</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šé…ç½®æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConfigurationService configService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåˆ†ç‰‡æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ShardingService shardingService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰§è¡Œä½œä¸šæœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutionService executionService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šè¿è¡Œæ—¶ä¸Šä¸‹æ–‡æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutionContextService executionContextService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šå¤±æ•ˆè½¬ç§»æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FailoverService failoverService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šç›‘å¬å™¨æ•°ç»„</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ElasticJobListener&gt; elasticJobListeners;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šäº‹ä»¶æ€»çº¿</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobEventBus jobEventBus;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LiteJobFacade</span><span class="params">(<span class="keyword">final</span> CoordinatorRegistryCenter regCenter, <span class="keyword">final</span> String jobName, <span class="keyword">final</span> List&lt;ElasticJobListener&gt; elasticJobListeners, <span class="keyword">final</span> JobEventBus jobEventBus)</span> </span>&#123;</div><div class="line">        <span class="comment">// .... çœç•¥ new XXXXX() å¯¹è±¡</span></div><div class="line">        failoverService = <span class="keyword">new</span> FailoverService(regCenter, jobName);</div><div class="line">        <span class="keyword">this</span>.elasticJobListeners = elasticJobListeners;</div><div class="line">        <span class="keyword">this</span>.jobEventBus = jobEventBus;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>SchedulerFacade å’Œ LiteJobFacadeï¼Œçœ‹èµ·æ¥å¾ˆç›¸è¿‘ï¼Œå®é™…å·®åˆ«å¾ˆå¤§ã€‚å®ƒä»¬åˆ†åˆ«ä¸ºè°ƒåº¦å™¨ã€ä½œä¸šæä¾›éœ€è¦çš„æ–¹æ³•ã€‚ä¸‹æ–‡ä¹Ÿä¼šä½“ç°è¿™ä¸€ç‰¹ç‚¹ã€‚</p>
<h2 id="3-2-åˆå§‹åŒ–"><a href="#3-2-åˆå§‹åŒ–" class="headerlink" title="3.2 åˆå§‹åŒ–"></a>3.2 åˆå§‹åŒ–</h2><p>ä½œä¸šè°ƒåº¦å™¨åˆ›å»ºåï¼Œè°ƒç”¨ <code>#init()</code> æ–¹æ³•åˆå§‹åŒ–ï¼Œä½œä¸šæ–¹<strong>å¼€å§‹</strong>è°ƒåº¦ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* åˆå§‹åŒ–ä½œä¸š.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// æ›´æ–° ä½œä¸šé…ç½®</span></div><div class="line">   LiteJobConfiguration liteJobConfigFromRegCenter = schedulerFacade.updateJobConfiguration(liteJobConfig);</div><div class="line">   <span class="comment">// è®¾ç½® å½“å‰ä½œä¸šåˆ†ç‰‡æ€»æ•°</span></div><div class="line">   JobRegistry.getInstance().setCurrentShardingTotalCount(liteJobConfigFromRegCenter.getJobName(), liteJobConfigFromRegCenter.getTypeConfig().getCoreConfig().getShardingTotalCount());</div><div class="line">   <span class="comment">// åˆ›å»º ä½œä¸šè°ƒåº¦æ§åˆ¶å™¨</span></div><div class="line">   JobScheduleController jobScheduleController = <span class="keyword">new</span> JobScheduleController(</div><div class="line">           createScheduler(), createJobDetail(liteJobConfigFromRegCenter.getTypeConfig().getJobClass()), liteJobConfigFromRegCenter.getJobName());</div><div class="line">   <span class="comment">// æ·»åŠ  ä½œä¸šè°ƒåº¦æ§åˆ¶å™¨</span></div><div class="line">   JobRegistry.getInstance().registerJob(liteJobConfigFromRegCenter.getJobName(), jobScheduleController, regCenter);</div><div class="line">   <span class="comment">// æ³¨å†Œ ä½œä¸šå¯åŠ¨ä¿¡æ¯</span></div><div class="line">   schedulerFacade.registerStartUpInfo(!liteJobConfigFromRegCenter.isDisabled());</div><div class="line">   <span class="comment">// è°ƒåº¦ä½œä¸š</span></div><div class="line">   jobScheduleController.scheduleJob(liteJobConfigFromRegCenter.getTypeConfig().getCoreConfig().getCron());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-1-æ›´æ–°ä½œä¸šé…ç½®"><a href="#3-2-1-æ›´æ–°ä½œä¸šé…ç½®" class="headerlink" title="3.2.1 æ›´æ–°ä½œä¸šé…ç½®"></a>3.2.1 æ›´æ–°ä½œä¸šé…ç½®</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerFacade.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ›´æ–°ä½œä¸šé…ç½®.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> liteJobConfig ä½œä¸šé…ç½®</div><div class="line">* <span class="doctag">@return</span> æ›´æ–°åçš„ä½œä¸šé…ç½®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> LiteJobConfiguration <span class="title">updateJobConfiguration</span><span class="params">(<span class="keyword">final</span> LiteJobConfiguration liteJobConfig)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ›´æ–° ä½œä¸šé…ç½®</span></div><div class="line">   configService.persist(liteJobConfig);</div><div class="line">   <span class="comment">// è¯»å– ä½œä¸šé…ç½®</span></div><div class="line">   <span class="keyword">return</span> configService.load(<span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä»<a href="http://www.yunai.me/Elastic-Job/job-config/?self">ã€ŠElastic-Job æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹</a>çš„ã€Œ3.2 æŒä¹…åŒ–ä½œä¸šé…ç½®ã€ï¼Œè°ƒç”¨ <code>ConfigService#persist(...)</code> æ–¹æ³•ä¹Ÿä¸ä¸€å®šä¼šæ›´æ–°ä½œä¸šé…ç½®ï¼Œå› æ­¤è°ƒç”¨ <code>ConfigService#load(...)</code> æ–¹æ³•è¿”å›çš„å¯èƒ½æ˜¯æœ¬åœ°çš„ä½œä¸šé…ç½®ï¼Œä¹Ÿå¯èƒ½æ˜¯<strong>æ³¨å†Œä¸­å¿ƒ</strong>å­˜å‚¨çš„ä½œä¸šé…ç½®ã€‚</li>
</ul>
<h3 id="3-2-2-è®¾ç½®å½“å‰ä½œä¸šåˆ†ç‰‡æ€»æ•°"><a href="#3-2-2-è®¾ç½®å½“å‰ä½œä¸šåˆ†ç‰‡æ€»æ•°" class="headerlink" title="3.2.2 è®¾ç½®å½“å‰ä½œä¸šåˆ†ç‰‡æ€»æ•°"></a>3.2.2 è®¾ç½®å½“å‰ä½œä¸šåˆ†ç‰‡æ€»æ•°</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobRegistry.java</span></div><div class="line"><span class="keyword">private</span> Map&lt;String, Integer&gt; currentShardingTotalCountMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¾ç½®å½“å‰åˆ†ç‰‡æ€»æ•°.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> jobName ä½œä¸šåç§°</div><div class="line">* <span class="doctag">@param</span> currentShardingTotalCount å½“å‰åˆ†ç‰‡æ€»æ•°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCurrentShardingTotalCount</span><span class="params">(<span class="keyword">final</span> String jobName, <span class="keyword">final</span> <span class="keyword">int</span> currentShardingTotalCount)</span> </span>&#123;</div><div class="line">   currentShardingTotalCountMap.put(jobName, currentShardingTotalCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-3-åˆ›å»ºä½œä¸šè°ƒåº¦æ§åˆ¶å™¨"><a href="#3-2-3-åˆ›å»ºä½œä¸šè°ƒåº¦æ§åˆ¶å™¨" class="headerlink" title="3.2.3 åˆ›å»ºä½œä¸šè°ƒåº¦æ§åˆ¶å™¨"></a>3.2.3 åˆ›å»ºä½œä¸šè°ƒåº¦æ§åˆ¶å™¨</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// .... çœç•¥</span></div><div class="line">   <span class="comment">// åˆ›å»º ä½œä¸šè°ƒåº¦æ§åˆ¶å™¨</span></div><div class="line">   JobScheduleController jobScheduleController = <span class="keyword">new</span> JobScheduleController(</div><div class="line">           createScheduler(), createJobDetail(liteJobConfigFromRegCenter.getTypeConfig().getJobClass()), liteJobConfigFromRegCenter.getJobName());</div><div class="line">   <span class="comment">// .... çœç•¥</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>JobScheduleControllerï¼Œä½œä¸šè°ƒåº¦æ§åˆ¶å™¨ï¼Œæä¾›å¯¹ Quartz æ–¹æ³•çš„å°è£…ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobScheduleController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Quartz è°ƒåº¦å™¨</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Scheduler scheduler;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šä¿¡æ¯</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobDetail jobDetail;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è§¦å‘å™¨ç¼–å·</div><div class="line">     * ç›®å‰ä½¿ç”¨å·¥ä½œåå­—( jobName )</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String triggerIdentity;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleJob</span><span class="params">(<span class="keyword">final</span> String cron)</span> </span>&#123;&#125; <span class="comment">// è°ƒåº¦ä½œä¸š</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">rescheduleJob</span><span class="params">(<span class="keyword">final</span> String cron)</span> </span>&#123;&#125; <span class="comment">// é‡æ–°è°ƒåº¦ä½œä¸š</span></div><div class="line">    <span class="function"><span class="keyword">private</span> CronTrigger <span class="title">createTrigger</span><span class="params">(<span class="keyword">final</span> String cron)</span> </span>&#123;&#125; <span class="comment">// åˆ›å»ºè§¦å‘å™¨</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">isPaused</span><span class="params">()</span> </span>&#123;&#125; <span class="comment">// åˆ¤æ–­ä½œä¸šæ˜¯å¦æš‚åœ</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">pauseJob</span><span class="params">()</span> </span>&#123;&#125; <span class="comment">// æš‚åœä½œä¸š</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">resumeJob</span><span class="params">()</span> </span>&#123;&#125; <span class="comment">// æ¢å¤ä½œä¸š</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">triggerJob</span><span class="params">()</span> </span>&#123;&#125; <span class="comment">// ç«‹åˆ»å¯åŠ¨ä½œä¸š</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;&#125; <span class="comment">// å…³é—­è°ƒåº¦å™¨</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>#createScheduler()</code> æ–¹æ³•åˆ›å»º Quartz è°ƒåº¦å™¨ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobScheduler.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> Scheduler <span class="title">createScheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">   Scheduler result;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       StdSchedulerFactory factory = <span class="keyword">new</span> StdSchedulerFactory();</div><div class="line">       factory.initialize(getBaseQuartzProperties());</div><div class="line">       result = factory.getScheduler();</div><div class="line">       result.getListenerManager().addTriggerListener(schedulerFacade.newJobTriggerListener());</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> Properties <span class="title">getBaseQuartzProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">   Properties result = <span class="keyword">new</span> Properties();</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.class"</span>, org.quartz.simpl.SimpleThreadPool.class.getName());</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.threadCount"</span>, <span class="string">"1"</span>); <span class="comment">// Quartz çº¿ç¨‹æ•°ï¼š1</span></div><div class="line">   result.put(<span class="string">"org.quartz.scheduler.instanceName"</span>, liteJobConfig.getJobName());</div><div class="line">   result.put(<span class="string">"org.quartz.jobStore.misfireThreshold"</span>, <span class="string">"1"</span>);</div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.class"</span>, JobShutdownHookPlugin.class.getName()); <span class="comment">// ä½œä¸šå…³é—­é’©å­</span></div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.cleanShutdown"</span>, Boolean.TRUE.toString()); <span class="comment">// å…³é—­æ—¶ï¼Œæ¸…ç†æ‰€æœ‰èµ„æº</span></div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>org.quartz.threadPool.threadCount = 1</code>ï¼Œå³ Quartz æ‰§è¡Œä½œä¸šçº¿ç¨‹æ•°é‡ä¸º 1ã€‚åŸå› ï¼šä¸€ä¸ª<strong>ä½œä¸š( ElasticJob )</strong>çš„è°ƒåº¦ï¼Œéœ€è¦é…ç½®<strong>ç‹¬æœ‰</strong>çš„ä¸€ä¸ª<strong>ä½œä¸šè°ƒåº¦å™¨( JobScheduler )</strong>ï¼Œä¸¤è€…æ˜¯ <code>1 : 1</code> çš„å…³ç³»ã€‚</li>
<li><code>org.quartz.plugin.shutdownhook.class</code> è®¾ç½®ä½œä¸š<strong>ä¼˜é›…å…³é—­</strong>é’©å­ï¼š<a href="https://github.com/dangdangdotcom/elastic-job/blob/7dc099541a16de49f024fc59e46377a726be7f6b/elastic-job-lite/elastic-job-lite-core/src/main/java/com/dangdang/ddframe/job/lite/internal/schedule/JobShutdownHookPlugin.java" rel="external nofollow noopener noreferrer" target="_blank">JobShutdownHookPlugin</a>ã€‚</li>
<li>è§¦å‘å™¨ç›‘å¬å™¨( TriggerListener )ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>#createJobDetail()</code> æ–¹æ³•åˆ›å»º Quartz ä½œä¸šï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobScheduler.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> JobDetail <span class="title">createJobDetail</span><span class="params">(<span class="keyword">final</span> String jobClass)</span> </span>&#123;</div><div class="line">   <span class="comment">// åˆ›å»º Quartz ä½œä¸š</span></div><div class="line">   JobDetail result = JobBuilder.newJob(LiteJob.class).withIdentity(liteJobConfig.getJobName()).build();</div><div class="line">   <span class="comment">//</span></div><div class="line">   result.getJobDataMap().put(JOB_FACADE_DATA_MAP_KEY, jobFacade);</div><div class="line">   <span class="comment">// åˆ›å»º Elastic-Job å¯¹è±¡</span></div><div class="line">   Optional&lt;ElasticJob&gt; elasticJobInstance = createElasticJobInstance();</div><div class="line">   <span class="keyword">if</span> (elasticJobInstance.isPresent()) &#123;</div><div class="line">       result.getJobDataMap().put(ELASTIC_JOB_DATA_MAP_KEY, elasticJobInstance.get());</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!jobClass.equals(ScriptJob.class.getCanonicalName())) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           result.getJobDataMap().put(ELASTIC_JOB_DATA_MAP_KEY, Class.forName(jobClass).newInstance());</div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ReflectiveOperationException ex) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Elastic-Job: Job class '%s' can not initialize."</span>, jobClass);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">protected</span> Optional&lt;ElasticJob&gt; <span class="title">createElasticJobInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> Optional.absent();</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">// SpringJobScheduler.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Optional&lt;ElasticJob&gt; <span class="title">createElasticJobInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> Optional.fromNullable(elasticJob);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>åˆ›å»º Quartz ä½œä¸šè®¾ç½®äº† LiteJob ç±»ï¼Œè¿™æ · Quartz è§¦å‘ä½œä¸šæ‰§è¡Œæ—¶ï¼ŒLiteJob ä¼šå»è°ƒç”¨ Elastic-Job ä½œä¸šå¯¹è±¡ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
<li>åœ¨ Spring é‡Œï¼ŒElastic-Job å¦‚æœå·²ç»åˆ›å»ºå¥½<strong>æ³¨å…¥</strong>åˆ° SpringJobSchedulerï¼Œæ— éœ€è¿›è¡Œåˆ›å»ºã€‚</li>
<li><code>Jodetail.jobDataMap</code> å±æ€§é‡Œæ·»åŠ äº†ä½œä¸šé—¨é¢å¯¹è±¡( LiteJobFacade )ã€Elastic-Job å¯¹è±¡ï¼ŒQuartz  è§¦å‘ä½œä¸šæ—¶ï¼Œä¼šè®¾ç½®åˆ° LiteJob å¯¹è±¡é‡Œã€‚</li>
</ul>
</li>
</ul>
<h3 id="3-2-4-æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯"><a href="#3-2-4-æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯" class="headerlink" title="3.2.4 æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯"></a>3.2.4 æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> enabled ä½œä¸šæ˜¯å¦å¯ç”¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStartUpInfo</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> enabled)</span> </span>&#123;</div><div class="line">   <span class="comment">// å¼€å¯ æ‰€æœ‰ç›‘å¬å™¨</span></div><div class="line">   listenerManager.startAllListeners();</div><div class="line">   <span class="comment">// é€‰ä¸¾ ä¸»èŠ‚ç‚¹</span></div><div class="line">   leaderService.electLeader();</div><div class="line">   <span class="comment">// æŒä¹…åŒ– ä½œä¸šæœåŠ¡å™¨ä¸Šçº¿ä¿¡æ¯</span></div><div class="line">   serverService.persistOnline(enabled);</div><div class="line">   <span class="comment">// æŒä¹…åŒ– ä½œä¸šè¿è¡Œå®ä¾‹ä¸Šçº¿ç›¸å…³ä¿¡æ¯</span></div><div class="line">   instanceService.persistOnline();</div><div class="line">   <span class="comment">// è®¾ç½® éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°</span></div><div class="line">   shardingService.setReshardingFlag();</div><div class="line">   <span class="comment">// åˆå§‹åŒ– ä½œä¸šç›‘å¬æœåŠ¡</span></div><div class="line">   monitorService.listen();</div><div class="line">   <span class="comment">// åˆå§‹åŒ– è°ƒè§£ä½œä¸šä¸ä¸€è‡´çŠ¶æ€æœåŠ¡</span></div><div class="line">   <span class="keyword">if</span> (!reconcileService.isRunning()) &#123;</div><div class="line">       reconcileService.startAsync();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å¼€å¯æ‰€æœ‰ç›‘å¬å™¨ã€‚æ¯ä¸ªåŠŸèƒ½æ¨¡å—éƒ½æœ‰å…¶ç›¸åº”çš„ç›‘å¬å™¨ï¼Œåœ¨<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31_bak.jpg">æ¨¡å—å¯¹åº”ã€Œæ–‡ç« ã€</a>è¯¦ç»†åˆ†äº«ã€‚</li>
<li>é€‰ä¸¾ä¸»èŠ‚ç‚¹ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/election/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
<li><p>è°ƒç”¨ <code>ServerService#persistOnline()</code> æ–¹æ³•ï¼ŒæŒä¹…åŒ–ä½œä¸šæœåŠ¡å™¨ä¸Šçº¿ä¿¡æ¯ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerService</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æŒä¹…åŒ–ä½œä¸šæœåŠ¡å™¨ä¸Šçº¿ä¿¡æ¯.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> enabled ä½œä¸šæ˜¯å¦å¯ç”¨</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">persistOnline</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> enabled)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!JobRegistry.getInstance().isShutdown(jobName)) &#123;</div><div class="line">            jobNodeStorage.fillJobNode(serverNode.getServerNode(JobRegistry.getInstance().getJobInstance(jobName).getIp()), enabled ? <span class="string">""</span> : ServerStatus.DISABLED.name());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å½“ä½œä¸šé…ç½®è®¾ç½®ä½œä¸š<strong>ç¦ç”¨</strong>æ—¶( <code>LiteJobConfiguration.disabled = true</code> )ï¼Œä½œä¸šè°ƒåº¦ä½†<strong>è°ƒåº¦ä½œä¸šåˆ†ç‰‡ä¸ºç©º</strong>ã€‚ä¸å¤ªå¥½ç†è§£ï¼Ÿ<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>InstanceService#persistOnline()</code> æ–¹æ³•ï¼ŒæŒä¹…åŒ–ä½œä¸šè¿è¡Œå®ä¾‹ä¸Šçº¿ç›¸å…³ä¿¡æ¯ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InstanceService</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æŒä¹…åŒ–ä½œä¸šè¿è¡Œå®ä¾‹ä¸Šçº¿ç›¸å…³ä¿¡æ¯.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">persistOnline</span><span class="params">()</span> </span>&#123;</div><div class="line">        jobNodeStorage.fillEphemeralJobNode(instanceNode.getLocalInstanceNode(), <span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è®¾ç½®éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
</li>
<li>åˆå§‹åŒ–ä½œä¸šç›‘å¬æœåŠ¡ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-monitor/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šç›‘æ§æœåŠ¡ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
<li>åˆå§‹åŒ–è°ƒè§£ä½œä¸šä¸ä¸€è‡´çŠ¶æ€æœåŠ¡ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/reconcile/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” è‡ªè¯Šæ–­ä¿®å¤ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
<h3 id="3-2-5-è°ƒåº¦ä½œä¸š"><a href="#3-2-5-è°ƒåº¦ä½œä¸š" class="headerlink" title="3.2.5 è°ƒåº¦ä½œä¸š"></a>3.2.5 è°ƒåº¦ä½œä¸š</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobScheduler.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">   <span class="comment">// è°ƒåº¦ä½œä¸š</span></div><div class="line">   jobScheduleController.scheduleJob(liteJobConfigFromRegCenter.getTypeConfig().getCoreConfig().getCron());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobScheduleController.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è°ƒåº¦ä½œä¸š.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> cron CRONè¡¨è¾¾å¼</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleJob</span><span class="params">(<span class="keyword">final</span> String cron)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">if</span> (!scheduler.checkExists(jobDetail.getKey())) &#123;</div><div class="line">           scheduler.scheduleJob(jobDetail, createTrigger(cron));</div><div class="line">       &#125;</div><div class="line">       scheduler.start();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>#scheduleJob()</code> æ–¹æ³•åï¼Œè¯¥ Elastic-Job ä½œä¸š<strong>å¼€å§‹</strong>è¢«è°ƒåº¦ã€‚</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ä½œä¸šåˆå§‹åŒ–ï¼Œå¦‚æœä½ å¯¹ Quartz ä¸æ˜¯ç‰¹åˆ«äº†è§£ï¼Œå¯ä»¥å†çœ‹ Quartz å†é‡æ–°ç†è§£ã€‚</p>
<p>ä¸‹ä¸€ç¯‡ï¼Œ<a href="http://www.yunai.me/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a> èµ·èˆªï¼</p>
<p>é“å‹ï¼Œåˆ†äº«ä¸€æ³¢<strong>å¾®ä¿¡æœ‹å‹åœˆ</strong>æ”¯æŒæ”¯æŒæ”¯æŒï¼Œå¯å¥½ï¼Ÿ</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ä½œä¸šæ³¨å†Œè¡¨&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;3
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.yunai.me/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®</title>
    <link href="http://www.yunai.me/Elastic-Job/job-config/"/>
    <id>http://www.yunai.me/Elastic-Job/job-config/</id>
    <published>2017-09-08T16:00:00.000Z</published>
    <updated>2017-09-02T09:55:04.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ä½œä¸šé…ç½®</a><ul>
<li><a href="#">2.1 æ³¨å†Œä¸­å¿ƒé…ç½®</a></li>
<li><a href="#">2.2 Liteä½œä¸šé…ç½®</a><ul>
<li><a href="#">2.2.1 ä½œä¸šç±»å‹é…ç½®</a></li>
<li><a href="#">2.2.2 ä½œä¸šæ ¸å¿ƒé…ç½®</a></li>
</ul>
</li>
<li><a href="#">2.3 ä½œä¸šäº‹ä»¶é…ç½®</a></li>
<li><a href="#">2.4 ä½œä¸šç›‘å¬å™¨</a></li>
</ul>
</li>
<li><a href="#">3. ä½œä¸šé…ç½®æœåŠ¡</a><ul>
<li><a href="#">3.1 è¯»å–ä½œä¸šé…ç½®</a></li>
<li><a href="#">3.2 æŒä¹…åŒ–ä½œä¸šé…ç½®</a></li>
<li><a href="#">3.3 æ ¡éªŒæœ¬æœºæ—¶é—´æ˜¯å¦åˆæ³•</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šé…ç½®</strong>ã€‚</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_09_09/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_09_09/01.png" alt=""></p>
<ul>
<li><strong>é»„è‰²</strong>çš„ç±»åœ¨ <code>elastic-job-common-core</code> é¡¹ç›®é‡Œï¼Œä¸º Elastic-Job-Liteã€Elastic-Job-Cloud <strong>å…¬ç”¨</strong>ä½œä¸šé…ç½®ç±»ã€‚</li>
</ul>
<p>å¦å¤–å»ºè®®ä½ å·²ç»( éå¿…é¡» )ï¼š</p>
<ul>
<li>é˜…è¯»è¿‡<a href="http://dangdangdotcom.github.io/elastic-job/elastic-job-lite/02-guide/config-manual/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” é…ç½®æ‰‹å†Œã€‹</a></li>
<li>è¿è¡Œè¿‡ <a href="https://github.com/dangdangdotcom/elastic-job/blob/8926e94aa7c48dc635a36518da2c4b10194420a5/elastic-job-example/elastic-job-example-lite-java/src/main/java/com/dangdang/ddframe/job/example/JavaMain.java" rel="external nofollow noopener noreferrer" target="_blank">JavaMain.java</a></li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-ä½œä¸šé…ç½®"><a href="#2-ä½œä¸šé…ç½®" class="headerlink" title="2. ä½œä¸šé…ç½®"></a>2. ä½œä¸šé…ç½®</h1><p>ä¸€ä¸ª<strong>ä½œä¸š( ElasticJob )</strong>çš„è°ƒåº¦ï¼Œéœ€è¦é…ç½®<strong>ç‹¬æœ‰</strong>çš„ä¸€ä¸ª<strong>ä½œä¸šè°ƒåº¦å™¨( JobScheduler )</strong>ï¼Œä¸¤è€…æ˜¯ <code>1 : 1</code> çš„å…³ç³»ã€‚<strong>è¿™ç‚¹å¤§å®¶è¦æ³¨æ„ä¸‹ï¼Œå½“ç„¶ä¸‹æ–‡çœ‹ä»£ç ä¹Ÿä¼šçœ‹åˆ°ã€‚</strong></p>
<p>ä½œä¸šè°ƒåº¦å™¨çš„åˆ›å»ºå¯ä»¥é…ç½®å››ä¸ªå‚æ•°ï¼š</p>
<ol>
<li>æ³¨å†Œä¸­å¿ƒ( CoordinatorRegistryCenter )ï¼šç”¨äºåè°ƒåˆ†å¸ƒå¼æœåŠ¡ã€‚<strong>å¿…å¡«</strong>ã€‚</li>
<li>Liteä½œä¸šé…ç½®( LiteJobConfiguration )ï¼š<strong>å¿…å¡«</strong>ã€‚</li>
<li>ä½œä¸šäº‹ä»¶æ€»çº¿( JobEventBus )ï¼šå¯¹ä½œä¸šäº‹ä»¶<strong>å¼‚æ­¥</strong>ç›‘å¬ã€‚<strong>é€‰å¡«</strong>ã€‚</li>
<li>ä½œä¸šç›‘å¬å™¨( ElasticJobListener )ï¼šå¯¹ä½œä¸šæ‰§è¡Œå‰ï¼Œæ‰§è¡Œåè¿›è¡Œ<strong>åŒæ­¥</strong>ç›‘å¬ã€‚<strong>é€‰å¡«</strong>ã€‚</li>
</ol>
<h2 id="2-1-æ³¨å†Œä¸­å¿ƒé…ç½®"><a href="#2-1-æ³¨å†Œä¸­å¿ƒé…ç½®" class="headerlink" title="2.1 æ³¨å†Œä¸­å¿ƒé…ç½®"></a>2.1 æ³¨å†Œä¸­å¿ƒé…ç½®</h2><p>Elastic-Job æŠ½è±¡äº†<strong>æ³¨å†Œä¸­å¿ƒæ¥å£( RegistryCenter )</strong>ï¼Œå¹¶æä¾›äº†é»˜è®¤<strong>åŸºäº Zookeeper çš„æ³¨å†Œä¸­å¿ƒå®ç°( ZookeeperRegistryCenter )</strong>ã€‚</p>
<p>ZookeeperRegistryCenter å¯¹åº”é…ç½®ç±»ä¸º ZookeeperConfigurationã€‚è¯¥ç±»æ³¨é‡Šå¾ˆå®Œæ•´ï¼Œå¯ä»¥ç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/7dc099541a16de49f024fc59e46377a726be7f6b/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/reg/zookeeper/ZookeeperConfiguration.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹æºç ï¼Œè¿™é‡Œæˆ‘ä»¬é‡ç‚¹è¯´ä¸‹ <code>namespace</code> å±æ€§ã€‚å¦‚æœä½ æœ‰å¤šä¸ª<strong>ä¸åŒ</strong> Elastic-Jobé›†ç¾¤ æ—¶ï¼Œä½¿ç”¨ç›¸åŒ Zookeeperï¼Œå¯ä»¥é…ç½®ä¸åŒçš„ <code>namespace</code> è¿›è¡Œéš”ç¦»ã€‚</p>
<p>æ³¨å†Œä¸­å¿ƒçš„<strong>åˆå§‹åŒ–</strong>ï¼Œæˆ‘ä»¬ä¼šåœ¨<a href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” æ³¨å†Œä¸­å¿ƒã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
<h2 id="2-2-Liteä½œä¸šé…ç½®"><a href="#2-2-Liteä½œä¸šé…ç½®" class="headerlink" title="2.2 Liteä½œä¸šé…ç½®"></a>2.2 Liteä½œä¸šé…ç½®</h2><p><a href="https://github.com/dangdangdotcom/elastic-job/blob/6617853bf059df373e2cb6ce959038c583ae5064/elastic-job-lite/elastic-job-lite-core/src/main/java/com/dangdang/ddframe/job/lite/config/LiteJobConfiguration.java" rel="external nofollow noopener noreferrer" target="_blank">LiteJobConfiguration</a> ç»§æ‰¿è‡ªæ¥å£ <a href="https://github.com/dangdangdotcom/elastic-job/blob/6617853bf059df373e2cb6ce959038c583ae5064/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/config/JobRootConfiguration.java" rel="external nofollow noopener noreferrer" target="_blank">JobRootConfiguration</a>ï¼Œä½œä¸º Elastic-Job-Lite é‡Œçš„ä½œä¸š( LiteJob )é…ç½®ã€‚<em>Elastic-Job-Cloud çš„ä½œä¸š( CloudJob )å¯¹åº”å¦å¤–çš„é…ç½®ç±»ï¼Œä¹Ÿå®ç°äº†è¯¥æ¥å£ã€‚</em></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LiteJobConfiguration</span> <span class="keyword">implements</span> <span class="title">JobRootConfiguration</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobTypeConfiguration typeConfig;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> monitorExecution;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxTimeDiffSeconds;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> monitorPort;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobShardingStrategyClass;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> reconcileIntervalMinutes;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> disabled;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> overwrite;</div><div class="line">    </div><div class="line">    <span class="comment">// .... çœç•¥éƒ¨åˆ†getæ–¹æ³•</span></div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</div><div class="line">    </div><div class="line">        <span class="comment">// .... çœç•¥éƒ¨åˆ†å±æ€§</span></div><div class="line">    </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> LiteJobConfiguration <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> LiteJobConfiguration(jobConfig, monitorExecution, maxTimeDiffSeconds, monitorPort, jobShardingStrategyClass, reconcileIntervalMinutes, disabled, overwrite);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>typeConfig</code>ï¼šä½œä¸šç±»å‹é…ç½®ã€‚<strong>å¿…å¡«</strong>ã€‚</li>
<li><p><code>monitorExecution</code>ï¼šç›‘æ§ä½œä¸šè¿è¡Œæ—¶çŠ¶æ€ã€‚é»˜è®¤ä¸º <code>false</code>ã€‚é€‰å¡«ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
<blockquote>
<p>æ¯æ¬¡ä½œä¸šæ‰§è¡Œæ—¶é—´å’Œé—´éš”æ—¶é—´å‡<strong>éå¸¸çŸ­</strong>çš„æƒ…å†µï¼Œå»ºè®®ä¸ç›‘æ§ä½œä¸šè¿è¡Œæ—¶çŠ¶æ€ä»¥æå‡æ•ˆç‡ã€‚å› ä¸ºæ˜¯ç¬æ—¶çŠ¶æ€ï¼Œæ‰€ä»¥æ— å¿…è¦ç›‘æ§ã€‚è¯·ç”¨æˆ·è‡ªè¡Œå¢åŠ æ•°æ®å †ç§¯ç›‘æ§ã€‚å¹¶ä¸”ä¸èƒ½ä¿è¯æ•°æ®é‡å¤é€‰å–ï¼Œåº”åœ¨ä½œä¸šä¸­å®ç°å¹‚ç­‰æ€§ã€‚<br>  æ¯æ¬¡ä½œä¸šæ‰§è¡Œæ—¶é—´å’Œé—´éš”æ—¶é—´å‡<strong>è¾ƒé•¿çš„</strong>æƒ…å†µï¼Œå»ºè®®ç›‘æ§ä½œä¸šè¿è¡Œæ—¶çŠ¶æ€ï¼Œå¯ä¿è¯æ•°æ®ä¸ä¼šé‡å¤é€‰å–ã€‚</p>
</blockquote>
</li>
<li><p><code>monitorPort</code>ï¼šä½œä¸šç›‘æ§ç«¯å£ã€‚é»˜è®¤ä¸º <code>-1</code>ï¼Œä¸å¼€å¯ä½œä¸šç›‘æ§ç«¯å£ã€‚é€‰å¡«ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-monitor/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šç›‘æ§æœåŠ¡ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
<blockquote>
<p>å»ºè®®é…ç½®ä½œä¸šç›‘æ§ç«¯å£, æ–¹ä¾¿å¼€å‘è€…dumpä½œä¸šä¿¡æ¯ã€‚<br>  ä½¿ç”¨æ–¹æ³•: echo â€œdumpâ€ | nc 127.0.0.1 9888</p>
</blockquote>
</li>
<li><p><code>maxTimeDiffSeconds</code>ï¼šè®¾ç½®æœ€å¤§å®¹å¿çš„æœ¬æœºä¸æ³¨å†Œä¸­å¿ƒçš„æ—¶é—´è¯¯å·®ç§’æ•°ã€‚é»˜è®¤ä¸º <code>-1</code>ï¼Œä¸æ£€æŸ¥æ—¶é—´è¯¯å·®ã€‚é€‰å¡«ã€‚</p>
</li>
<li><code>jobShardingStrategyClass</code>ï¼šä½œä¸šåˆ†ç‰‡ç­–ç•¥å®ç°ç±»å…¨è·¯å¾„ã€‚é»˜è®¤ä¸ºä½¿ç”¨åˆ†é…ä¾§è·¯ã€‚é€‰å¡«ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-sharding-strategy/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šåˆ†ç‰‡ç­–ç•¥ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
<li><p><code>reconcileIntervalMinutes</code>ï¼šä¿®å¤ä½œä¸šæœåŠ¡å™¨ä¸ä¸€è‡´çŠ¶æ€æœåŠ¡è°ƒåº¦é—´éš”æ—¶é—´ï¼Œé…ç½®ä¸ºå°äº1çš„ä»»æ„å€¼è¡¨ç¤ºä¸æ‰§è¡Œä¿®å¤ã€‚é»˜è®¤ä¸º <code>10</code>ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/reconcile/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” è‡ªè¯Šæ–­ä¿®å¤ ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
</li>
<li><p><code>disabled</code>ï¼šä½œä¸šæ˜¯å¦ç¦ç”¨æ‰§è¡Œã€‚é»˜è®¤ä¸º <code>false</code>ã€‚é€‰å¡«ã€‚</p>
</li>
<li><code>overwrite</code>ï¼šè®¾ç½®ä½¿ç”¨æœ¬åœ°ä½œä¸šé…ç½®è¦†ç›–æ³¨å†Œä¸­å¿ƒçš„ä½œä¸šé…ç½®ã€‚é»˜è®¤ä¸º <code>false</code>ã€‚é€‰å¡«ã€‚å»ºè®®ä½¿ç”¨<strong>è¿ç»´å¹³å°( console )</strong>é…ç½®ä½œä¸šé…ç½®ï¼Œç»Ÿä¸€ç®¡ç†ã€‚</li>
<li>Builder ç±»ï¼šä½¿ç”¨è¯¥ç±»é…ç½® LiteJobConfiguration å±æ€§ï¼Œè°ƒç”¨ <code>#build()</code> æ–¹æ³•æœ€ç»ˆç”Ÿæˆä½œä¸šé…ç½®ã€‚å‚è§ï¼š<a href="http://blog.csdn.net/top_code/article/details/8469297" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJAVAè®¾è®¡æ¨¡å¼ â€” ç”Ÿæˆå™¨æ¨¡å¼(Builder)ã€‹</a>ã€‚</li>
</ul>
<h3 id="2-2-1-ä½œä¸šç±»å‹é…ç½®"><a href="#2-2-1-ä½œä¸šç±»å‹é…ç½®" class="headerlink" title="2.2.1 ä½œä¸šç±»å‹é…ç½®"></a>2.2.1 ä½œä¸šç±»å‹é…ç½®</h3><p>ä½œä¸šç±»å‹é…ç½®<strong>æ¥å£</strong>( <a href="https://github.com/dangdangdotcom/elastic-job/blob/6617853bf059df373e2cb6ce959038c583ae5064/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/config/JobTypeConfiguration.java" rel="external nofollow noopener noreferrer" target="_blank">JobTypeConfiguration</a> ) æœ‰ä¸‰ç§é…ç½®å®ç°ï¼Œé’ˆå¯¹ä¸‰ç§ä½œä¸šç±»å‹ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">é…ç½®å®ç°</th>
<th style="text-align:left">ä½œä¸š</th>
<th style="text-align:left">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><a href="https://github.com/dangdangdotcom/elastic-job/blob/6617853bf059df373e2cb6ce959038c583ae5064/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/config/simple/SimpleJobConfiguration.java" rel="external nofollow noopener noreferrer" target="_blank">SimpleJobConfiguration</a></td>
<td style="text-align:left">SimpleJob</td>
<td style="text-align:left">ç®€å•ä½œä¸šã€‚ä¾‹å¦‚ï¼šè®¢å•è¿‡æœŸä½œä¸š</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://github.com/dangdangdotcom/elastic-job/blob/6617853bf059df373e2cb6ce959038c583ae5064/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/config/dataflow/DataflowJobConfiguration.java" rel="external nofollow noopener noreferrer" target="_blank">DataflowJobConfiguration</a></td>
<td style="text-align:left">DataflowJob</td>
<td style="text-align:left">æ•°æ®æµä½œä¸šã€‚TODOï¼šç¬”è€…æš‚æ—¶æœªäº†è§£æµå¼å¤„ç†æ•°æ®ï¼Œä¸è¯¯äººå­å¼Ÿ</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://github.com/dangdangdotcom/elastic-job/blob/6617853bf059df373e2cb6ce959038c583ae5064/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/config/script/ScriptJobConfiguration.java" rel="external nofollow noopener noreferrer" target="_blank">ScriptJobConfiguration</a></td>
<td style="text-align:left">ScriptJob</td>
<td style="text-align:left">è„šæœ¬ä½œä¸šã€‚ä¾‹å¦‚ï¼šè°ƒç”¨ shell è„šæœ¬å¤‡ä»½æ•°æ®åº“ä½œä¸š</td>
</tr>
</tbody>
</table>
<p>ä¸‰ç§<strong>é…ç½®ç±»</strong>å±æ€§å¯¹æ¯”å¦‚ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">å±æ€§</th>
<th style="text-align:left">SimpleJob</th>
<th style="text-align:left">DataflowJob</th>
<th style="text-align:left">ScriptJob</th>
<th style="text-align:left">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>coreConfig</code></td>
<td style="text-align:left">âˆš</td>
<td style="text-align:left">âˆš</td>
<td style="text-align:left">âˆš</td>
<td style="text-align:left">ä½œä¸šæ ¸å¿ƒé…ç½®</td>
</tr>
<tr>
<td style="text-align:left"><code>jobType</code></td>
<td style="text-align:left">JobType.SIMPLE</td>
<td style="text-align:left">JobType.DATAFLOW</td>
<td style="text-align:left">JobType.SCRIPT</td>
<td style="text-align:left">ä½œä¸šç±»å‹</td>
</tr>
<tr>
<td style="text-align:left"><code>jobClass</code></td>
<td style="text-align:left">âˆš</td>
<td style="text-align:left">âˆš</td>
<td style="text-align:left">âˆš (é»˜è®¤ï¼šScriptJob.class)</td>
<td style="text-align:left">ä½œä¸šå®ç°ç±»å…¨è·¯å¾„</td>
</tr>
<tr>
<td style="text-align:left"><code>streamingProcess</code></td>
<td style="text-align:left"></td>
<td style="text-align:left">âˆš</td>
<td style="text-align:left"></td>
<td style="text-align:left">æ˜¯å¦æµå¼å¤„ç†æ•°æ®</td>
</tr>
<tr>
<td style="text-align:left"><code>scriptCommandLine</code></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">âˆš</td>
<td style="text-align:left">è„šæœ¬å‹ä½œä¸šæ‰§è¡Œå‘½ä»¤è¡Œ</td>
</tr>
</tbody>
</table>
<p><strong>ä½œä¸šç±»å‹é…ç½®ä¸ä»…ä»…é€‚ç”¨äº Elastic-Job-Liteï¼Œä¹Ÿé€‚ç”¨äº Elastic-Job-Cloudã€‚</strong></p>
<h3 id="2-2-2-ä½œä¸šæ ¸å¿ƒé…ç½®"><a href="#2-2-2-ä½œä¸šæ ¸å¿ƒé…ç½®" class="headerlink" title="2.2.2 ä½œä¸šæ ¸å¿ƒé…ç½®"></a>2.2.2 ä½œä¸šæ ¸å¿ƒé…ç½®</h3><p>ä½œä¸šæ ¸å¿ƒé…ç½®( JobCoreConfiguration )ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨æ¯ç§ä½œä¸šç±»å‹é…ç½®éƒ½æœ‰è¯¥å±æ€§( <code>coreConfig</code> )ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobCoreConfiguration</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String cron;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String shardingItemParameters;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobParameter;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> failover;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> misfire;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String description;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobProperties jobProperties;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</div><div class="line">    </div><div class="line">        <span class="comment">// .... çœç•¥éƒ¨åˆ†å±æ€§</span></div><div class="line">    </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> JobCoreConfiguration <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">            Preconditions.checkArgument(!Strings.isNullOrEmpty(jobName), <span class="string">"jobName can not be empty."</span>);</div><div class="line">            Preconditions.checkArgument(!Strings.isNullOrEmpty(cron), <span class="string">"cron can not be empty."</span>);</div><div class="line">            Preconditions.checkArgument(shardingTotalCount &gt; <span class="number">0</span>, <span class="string">"shardingTotalCount should larger than zero."</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JobCoreConfiguration(jobName, cron, shardingTotalCount, shardingItemParameters, jobParameter, failover, misfire, description, jobProperties);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>jobName</code>ï¼šä½œä¸šåç§°ã€‚<strong>å¿…å¡«ã€‚</strong></li>
<li><code>cron</code>ï¼šcronè¡¨è¾¾å¼ï¼Œç”¨äºæ§åˆ¶ä½œä¸šè§¦å‘æ—¶é—´ã€‚<strong>å¿…å¡«ã€‚</strong></li>
<li><code>shardingTotalCount</code>ï¼šä½œä¸šåˆ†ç‰‡æ€»æ•°ã€‚å¦‚æœä¸€ä¸ªä½œä¸šå¯åŠ¨è¶…è¿‡ä½œä¸šåˆ†ç‰‡æ€»æ•°çš„èŠ‚ç‚¹ï¼Œåªæœ‰ <code>shardingTotalCount</code> ä¼šæ‰§è¡Œä½œä¸šã€‚<strong>å¿…å¡«ã€‚</strong>åœ¨<a href="http://www.yunai.me/Elastic-Job/job-sharding-strategy/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šåˆ†ç‰‡ç­–ç•¥ ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
<li><p><code>shardingItemParameters</code>ï¼šåˆ†ç‰‡åºåˆ—å·å’Œå‚æ•°ã€‚é€‰å¡«ã€‚</p>
<blockquote>
<p>åˆ†ç‰‡åºåˆ—å·å’Œå‚æ•°ç”¨ç­‰å·åˆ†éš”ï¼Œå¤šä¸ªé”®å€¼å¯¹ç”¨é€—å·åˆ†éš”<br>  åˆ†ç‰‡åºåˆ—å·ä»0å¼€å§‹ï¼Œ<strong>ä¸å¯å¤§äºæˆ–ç­‰äº</strong>ä½œä¸šåˆ†ç‰‡æ€»æ•°<br>  å¦‚ï¼š<br>  0=a,1=b,2=c  </p>
</blockquote>
</li>
<li><p><code>jobParameter</code>ï¼šä½œä¸šè‡ªå®šä¹‰å‚æ•°ã€‚é€‰å¡«ã€‚</p>
<blockquote>
<p>ä½œä¸šè‡ªå®šä¹‰å‚æ•°ï¼Œå¯é€šè¿‡ä¼ é€’è¯¥å‚æ•°ä¸ºä½œä¸šè°ƒåº¦çš„ä¸šåŠ¡æ–¹æ³•ä¼ å‚ï¼Œç”¨äºå®ç°å¸¦å‚æ•°çš„ä½œä¸š<br>  ä¾‹ï¼šæ¯æ¬¡è·å–çš„æ•°æ®é‡ã€ä½œä¸šå®ä¾‹ä»æ•°æ®åº“è¯»å–çš„ä¸»é”®ç­‰</p>
</blockquote>
</li>
<li><p><code>failover</code>ï¼šæ˜¯å¦å¼€å¯ä½œä¸šæ‰§è¡Œå¤±æ•ˆè½¬ç§»ã€‚<strong>å¼€å¯è¡¨ç¤ºå¦‚æœä½œä¸šåœ¨ä¸€æ¬¡ä½œä¸šæ‰§è¡Œä¸­é€”å®•æœºï¼Œå…è®¸å°†è¯¥æ¬¡æœªå®Œæˆçš„ä½œä¸šåœ¨å¦ä¸€ä½œä¸šèŠ‚ç‚¹ä¸Šè¡¥å¿æ‰§è¡Œ</strong>ã€‚é»˜è®¤ä¸º <code>false</code>ã€‚é€‰å¡«ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-failover/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§» ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
</li>
<li><code>misfire</code>ï¼šæ˜¯å¦å¼€å¯é”™è¿‡ä½œä¸šé‡æ–°æ‰§è¡Œã€‚é»˜è®¤ä¸º <code>true</code>ã€‚é€‰å¡«ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ‰§è¡Œ ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
<li><code>description</code>ï¼šä½œä¸šæè¿°ã€‚é€‰å¡«ã€‚</li>
<li><p><code>jobProperties</code>ï¼šä½œä¸šå±æ€§é…ç½®ã€‚é€‰å¡«ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ‰§è¡Œ ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobProperties</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> EnumMap&lt;JobPropertiesEnum, String&gt; map = <span class="keyword">new</span> EnumMap&lt;&gt;(JobPropertiesEnum.class);</div><div class="line">    </div><div class="line">   <span class="keyword">public</span> <span class="keyword">enum</span> JobPropertiesEnum &#123;</div><div class="line">        </div><div class="line">        <span class="comment">/**</span></div><div class="line">         * ä½œä¸šå¼‚å¸¸å¤„ç†å™¨.</div><div class="line">         */</div><div class="line">        JOB_EXCEPTION_HANDLER(<span class="string">"job_exception_handler"</span>, JobExceptionHandler.class, DefaultJobExceptionHandler.class.getCanonicalName()),</div><div class="line">        </div><div class="line">        <span class="comment">/**</span></div><div class="line">         * çº¿ç¨‹æ± æœåŠ¡å¤„ç†å™¨.</div><div class="line">         */</div><div class="line">        EXECUTOR_SERVICE_HANDLER(<span class="string">"executor_service_handler"</span>, ExecutorServiceHandler.class, DefaultExecutorServiceHandler.class.getCanonicalName());</div><div class="line">        </div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String key;</div><div class="line">    </div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; classType;</div><div class="line">        </div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String defaultValue;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>JOB_EXCEPTION_HANDLER</code>ï¼šç”¨äºæ‰©å±•<strong>å¼‚å¸¸å¤„ç†</strong>ç±»ã€‚</li>
<li><code>EXECUTOR_SERVICE_HANDLER</code>ï¼šç”¨äºæ‰©å±•<strong>ä½œä¸šå¤„ç†çº¿ç¨‹æ± </strong>ç±»ã€‚</li>
<li>é€šè¿‡è¿™ä¸ªå±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰<strong>æ¯ä¸ªä½œä¸š</strong>çš„å¼‚å¸¸å¤„ç†å’Œçº¿ç¨‹æ± æœåŠ¡ã€‚    </li>
</ul>
</li>
</ul>
<h2 id="2-3-ä½œä¸šäº‹ä»¶é…ç½®"><a href="#2-3-ä½œä¸šäº‹ä»¶é…ç½®" class="headerlink" title="2.3 ä½œä¸šäº‹ä»¶é…ç½®"></a>2.3 ä½œä¸šäº‹ä»¶é…ç½®</h2><p>é€šè¿‡ä½œä¸šäº‹ä»¶é…ç½®( JobEventConfiguration )ï¼Œå®ç°å¯¹ä½œä¸šäº‹ä»¶çš„<strong>å¼‚æ­¥</strong>ç›‘å¬ã€å¤„ç†ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-event-trace/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šäº‹ä»¶è¿½è¸ªã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
<h2 id="2-4-ä½œä¸šç›‘å¬å™¨"><a href="#2-4-ä½œä¸šç›‘å¬å™¨" class="headerlink" title="2.4 ä½œä¸šç›‘å¬å™¨"></a>2.4 ä½œä¸šç›‘å¬å™¨</h2><p>é€šè¿‡é…ç½®ä½œä¸šç›‘å¬å™¨( ElasticJobListener )ï¼Œå®ç°å¯¹ä½œä¸šæ‰§è¡Œçš„<strong>åŒæ­¥</strong>ç›‘å¬ã€å¤„ç†ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-listener/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šç›‘å¬å™¨ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
<h1 id="3-ä½œä¸šé…ç½®æœåŠ¡"><a href="#3-ä½œä¸šé…ç½®æœåŠ¡" class="headerlink" title="3. ä½œä¸šé…ç½®æœåŠ¡"></a>3. ä½œä¸šé…ç½®æœåŠ¡</h1><p>å¤šä¸ª Elastic-Job-Lite ä½¿ç”¨ç›¸åŒ<strong>æ³¨å†Œä¸­å¿ƒ</strong>å’Œç›¸åŒ <strong><code>namespace</code></strong> ç»„æˆé›†ç¾¤ï¼Œå®ç°é«˜å¯ç”¨ã€‚é›†ç¾¤ä¸­ï¼Œä½¿ç”¨ä½œä¸šé…ç½®æœåŠ¡( ConfigurationService ) å…±äº«ä½œä¸šé…ç½®ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigurationService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ—¶é—´æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TimeService timeService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šèŠ‚ç‚¹æ•°æ®è®¿é—®ç±»</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobNodeStorage jobNodeStorage;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConfigurationService</span><span class="params">(<span class="keyword">final</span> CoordinatorRegistryCenter regCenter, <span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">        jobNodeStorage = <span class="keyword">new</span> JobNodeStorage(regCenter, jobName);</div><div class="line">        timeService = <span class="keyword">new</span> TimeService();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>JobNodeStorageï¼Œå°è£…æ³¨å†Œä¸­å¿ƒï¼Œæä¾›å­˜å‚¨æœåŠ¡ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-storage/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ•°æ®å­˜å‚¨ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
<li><p>TimeServiceï¼Œæ—¶é—´æœåŠ¡ï¼Œæä¾›å½“å‰æ—¶é—´æŸ¥è¯¢ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–å½“å‰æ—¶é—´çš„æ¯«ç§’æ•°.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span> å½“å‰æ—¶é—´çš„æ¯«ç§’æ•°</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getCurrentMillis</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> System.currentTimeMillis();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="3-1-è¯»å–ä½œä¸šé…ç½®"><a href="#3-1-è¯»å–ä½œä¸šé…ç½®" class="headerlink" title="3.1 è¯»å–ä½œä¸šé…ç½®"></a>3.1 è¯»å–ä½œä¸šé…ç½®</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* è¯»å–ä½œä¸šé…ç½®.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> fromCache æ˜¯å¦ä»ç¼“å­˜ä¸­è¯»å–</div><div class="line">* <span class="doctag">@return</span> ä½œä¸šé…ç½®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> LiteJobConfiguration <span class="title">load</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> fromCache)</span> </span>&#123;</div><div class="line">   String result;</div><div class="line">   <span class="keyword">if</span> (fromCache) &#123; <span class="comment">// ç¼“å­˜</span></div><div class="line">       result = jobNodeStorage.getJobNodeData(ConfigurationNode.ROOT);</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> == result) &#123;</div><div class="line">           result = jobNodeStorage.getJobNodeDataDirectly(ConfigurationNode.ROOT);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       result = jobNodeStorage.getJobNodeDataDirectly(ConfigurationNode.ROOT);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> LiteJobConfigurationGsonFactory.fromJson(result);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-2-æŒä¹…åŒ–ä½œä¸šé…ç½®"><a href="#3-2-æŒä¹…åŒ–ä½œä¸šé…ç½®" class="headerlink" title="3.2 æŒä¹…åŒ–ä½œä¸šé…ç½®"></a>3.2 æŒä¹…åŒ–ä½œä¸šé…ç½®</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* æŒä¹…åŒ–åˆ†å¸ƒå¼ä½œä¸šé…ç½®ä¿¡æ¯.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> liteJobConfig ä½œä¸šé…ç½®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">persist</span><span class="params">(<span class="keyword">final</span> LiteJobConfiguration liteJobConfig)</span> </span>&#123;</div><div class="line">   checkConflictJob(liteJobConfig);</div><div class="line">   <span class="keyword">if</span> (!jobNodeStorage.isJobNodeExisted(ConfigurationNode.ROOT) || liteJobConfig.isOverwrite()) &#123;</div><div class="line">       jobNodeStorage.replaceJobNode(ConfigurationNode.ROOT, LiteJobConfigurationGsonFactory.toJson(liteJobConfig));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>#checkConflictJob(...)</code> æ–¹æ³•<strong>æ ¡éªŒ</strong>æ³¨å†Œä¸­å¿ƒå­˜å‚¨çš„ä½œä¸šé…ç½®çš„ä½œä¸šå®ç°ç±»å…¨è·¯å¾„( <code>jobClass</code> )å’Œå½“å‰çš„æ˜¯å¦ç›¸åŒï¼Œå¦‚æœä¸åŒï¼Œåˆ™è®¤ä¸ºæ˜¯<strong>å†²çª</strong>ï¼Œä¸å…è®¸å­˜å‚¨ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkConflictJob</span><span class="params">(<span class="keyword">final</span> LiteJobConfiguration liteJobConfig)</span> </span>&#123;</div><div class="line">   Optional&lt;LiteJobConfiguration&gt; liteJobConfigFromZk = find();</div><div class="line">   <span class="keyword">if</span> (liteJobConfigFromZk.isPresent()</div><div class="line">           &amp;&amp; !liteJobConfigFromZk.get().getTypeConfig().getJobClass().equals(liteJobConfig.getTypeConfig().getJobClass())) &#123; <span class="comment">// jobClass æ˜¯å¦ç›¸åŒ</span></div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Job conflict with register center. The job '%s' in register center's class is '%s', your job class is '%s'"</span>, </div><div class="line">               liteJobConfig.getJobName(), liteJobConfigFromZk.get().getTypeConfig().getJobClass(), liteJobConfig.getTypeConfig().getJobClass());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>å½“æ³¨å†Œä¸­å¿ƒ<strong>æœªå­˜å‚¨</strong>è¯¥ä½œä¸šé…ç½® æˆ–è€… å½“å‰ä½œä¸šé…ç½®å…è®¸æ›¿æ¢æ³¨å†Œä¸­å¿ƒä½œä¸šé…ç½®( <code>overwrite = true</code> )æ—¶ï¼ŒæŒä¹…åŒ–ä½œä¸šé…ç½®ã€‚</li>
</ul>
<h2 id="3-3-æ ¡éªŒæœ¬æœºæ—¶é—´æ˜¯å¦åˆæ³•"><a href="#3-3-æ ¡éªŒæœ¬æœºæ—¶é—´æ˜¯å¦åˆæ³•" class="headerlink" title="3.3 æ ¡éªŒæœ¬æœºæ—¶é—´æ˜¯å¦åˆæ³•"></a>3.3 æ ¡éªŒæœ¬æœºæ—¶é—´æ˜¯å¦åˆæ³•</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* æ£€æŸ¥æœ¬æœºä¸æ³¨å†Œä¸­å¿ƒçš„æ—¶é—´è¯¯å·®ç§’æ•°æ˜¯å¦åœ¨å…è®¸èŒƒå›´.</div><div class="line">* </div><div class="line">* <span class="doctag">@throws</span> JobExecutionEnvironmentException æœ¬æœºä¸æ³¨å†Œä¸­å¿ƒçš„æ—¶é—´è¯¯å·®ç§’æ•°ä¸åœ¨å…è®¸èŒƒå›´æ‰€æŠ›å‡ºçš„å¼‚å¸¸</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkMaxTimeDiffSecondsTolerable</span><span class="params">()</span> <span class="keyword">throws</span> JobExecutionEnvironmentException </span>&#123;</div><div class="line">   <span class="keyword">int</span> maxTimeDiffSeconds =  load(<span class="keyword">true</span>).getMaxTimeDiffSeconds();</div><div class="line">   <span class="keyword">if</span> (-<span class="number">1</span>  == maxTimeDiffSeconds) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">long</span> timeDiff = Math.abs(timeService.getCurrentMillis() - jobNodeStorage.getRegistryCenterTime());</div><div class="line">   <span class="keyword">if</span> (timeDiff &gt; maxTimeDiffSeconds * <span class="number">1000L</span>) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobExecutionEnvironmentException(</div><div class="line">               <span class="string">"Time different between job server and register center exceed '%s' seconds, max time different is '%s' seconds."</span>, timeDiff / <span class="number">1000</span>, maxTimeDiffSeconds);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Elastic-Job-Lite ä½œä¸šè§¦å‘æ˜¯<strong>ä¾èµ–æœ¬æœºæ—¶é—´</strong>ï¼Œç›¸åŒé›†ç¾¤ä½¿ç”¨æ³¨å†Œä¸­å¿ƒæ—¶é—´ä¸ºåŸºå‡†ï¼Œæ ¡éªŒæœ¬æœºä¸æ³¨å†Œä¸­å¿ƒçš„æ—¶é—´è¯¯å·®æ˜¯å¦åœ¨å…è®¸èŒƒå›´å†…( <code>LiteJobConfiguration.maxTimeDiffSeconds</code> )ã€‚</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>Elastic-Job-Lite æºç è§£æç³»åˆ—ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œå¸Œæœ›å¤§å®¶å¤šå¤šæ”¯æŒï¼Œé¢„è®¡å…¨éƒ¨æ›´æ–°å®Œä¼šæœ‰ 15+ ç¯‡ã€‚Elastic-Job-Cloud æºç ç³»åˆ—åç»­ä¹Ÿä¼šæ›´æ–°ã€‚</p>
<p>é“å‹ï¼Œåˆ†äº«ä¸€æ³¢<strong>å¾®ä¿¡æœ‹å‹åœˆ</strong>æ”¯æŒæ”¯æŒæ”¯æŒï¼Œå¯å¥½ï¼Ÿ</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ä½œä¸šé…ç½®&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2.1
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.yunai.me/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job æºç åˆ†æ â€”â€” ä¸ºä»€ä¹ˆé˜…è¯» Elastic-Job æºç ï¼Ÿ</title>
    <link href="http://www.yunai.me/Elastic-Job/why-read-Elastic-Job-source-code/"/>
    <id>http://www.yunai.me/Elastic-Job/why-read-Elastic-Job-source-code/</id>
    <published>2017-08-31T16:00:00.000Z</published>
    <updated>2017-09-02T09:54:50.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h2 id="ä¸ºä»€ä¹ˆé˜…è¯»-Elastic-Job-æºç ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆé˜…è¯»-Elastic-Job-æºç ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆé˜…è¯» Elastic-Job æºç ï¼Ÿ"></a>ä¸ºä»€ä¹ˆé˜…è¯» Elastic-Job æºç ï¼Ÿ</h2><ol>
<li>ä¹‹å‰æ–­æ–­ç»­ç»­è¯»è¿‡ Quartz æºç ï¼Œå›¢é˜Ÿé‡Œä¹Ÿå¯¹ Quartz åšè¿‡ä¸€äº›å°è£…ç®¡ç†ï¼Œå¾ˆå¤š Quartz äºŒæ¬¡å°è£…å¼€æºé¡¹ç›®ï¼Œæƒ³äº†è§£ Elastic-Job åšäº†å“ªäº›åŠŸèƒ½ï¼Œæ˜¯æ€ä¹ˆå®ç°çš„</li>
<li>Quartz å¤šèŠ‚ç‚¹é€šè¿‡æ•°æ®åº“é”å®ç°ä»»åŠ¡æŠ¢å ï¼ŒElastic-Job åŸºäºä»€ä¹ˆç­–ç•¥å®ç°ä»»åŠ¡è°ƒåº¦ä¸åˆ†é…</li>
<li>ä»»åŠ¡åˆ†ç‰‡å¦‚ä½•å®ç°</li>
<li>Elastic-Job-Cloud å¦‚ä½•å®ç°ä»»åŠ¡åŠ¨æ€æ‰©å®¹å’Œç¼©å®¹</li>
<li>ä»»åŠ¡è¶…æ—¶å¦‚ä½•å¤„ç†ï¼Ÿä»»åŠ¡å‡æ­»æ€ä¹ˆåˆ¤æ–­ï¼Ÿ</li>
</ol>
<h2 id="ä½¿ç”¨å…¬å¸"><a href="#ä½¿ç”¨å…¬å¸" class="headerlink" title="ä½¿ç”¨å…¬å¸"></a>ä½¿ç”¨å…¬å¸</h2><h2 id="æ­¥éª¤-åŠŸèƒ½"><a href="#æ­¥éª¤-åŠŸèƒ½" class="headerlink" title="æ­¥éª¤/åŠŸèƒ½"></a>æ­¥éª¤/åŠŸèƒ½</h2><ul>
<li>[x] åˆ†å¸ƒå¼è°ƒåº¦åè°ƒ</li>
<li>[ ] å¼¹æ€§æ‰©å®¹ç¼©å®¹</li>
<li>[x] å¤±æ•ˆè½¬ç§»</li>
<li>[x] é”™è¿‡æ‰§è¡Œä½œä¸šé‡è§¦å‘</li>
<li>[x] ä½œä¸šåˆ†ç‰‡ç­–ç•¥</li>
<li>[x] ä½œä¸šå”¯ä¸€èŠ‚ç‚¹æ‰§è¡Œ</li>
<li>[ ] è‡ªè¯Šæ–­å¹¶ä¿®å¤åˆ†å¸ƒå¼ä¸ç¨³å®šé€ æˆçš„é—®é¢˜</li>
<li>[x] æ”¯æŒå¹¶è¡Œè°ƒåº¦</li>
<li>[x] æ”¯æŒä½œä¸šç”Ÿå‘½å‘¨æœŸæ“ä½œ</li>
<li>[x] ä¸°å¯Œçš„ä½œä¸šç±»å‹</li>
<li>[ ] Springæ•´åˆä»¥åŠå‘½åç©ºé—´æä¾›</li>
<li>[x] è¿ç»´å¹³å°</li>
<li>[x] äº‹ä»¶è¿½è¸ª</li>
<li>[x] DUMP ä½œä¸šè¿è¡Œä¿¡æ¯</li>
<li>[x] ä½œä¸šç›‘å¬å™¨</li>
<li>[ ] åŸºäº Docker çš„è¿›ç¨‹éš”ç¦»ï¼ˆTBDï¼‰</li>
<li>[x] é«˜å¯ç”¨</li>
</ul>
<h2 id="XXL-JOB"><a href="#XXL-JOB" class="headerlink" title="XXL-JOB"></a>XXL-JOB</h2><p>åŸºäº V1.8ï¼Œä¼šé€æ¸å’Œ Elastic-Job åŠŸèƒ½åšå¯¹æ¯”</p>
<ul>
<li>[ ] 1ã€ç®€å•ï¼šæ”¯æŒé€šè¿‡Webé¡µé¢å¯¹ä»»åŠ¡è¿›è¡ŒCRUDæ“ä½œï¼Œæ“ä½œç®€å•ï¼Œä¸€åˆ†é’Ÿä¸Šæ‰‹ï¼›</li>
<li>[ ] 2ã€åŠ¨æ€ï¼šæ”¯æŒåŠ¨æ€ä¿®æ”¹ä»»åŠ¡çŠ¶æ€ã€æš‚åœ/æ¢å¤ä»»åŠ¡ï¼Œä»¥åŠç»ˆæ­¢è¿è¡Œä¸­ä»»åŠ¡ï¼Œå³æ—¶ç”Ÿæ•ˆï¼›</li>
<li>[ ] 3ã€è°ƒåº¦ä¸­å¿ƒHAï¼ˆä¸­å¿ƒå¼ï¼‰ï¼šè°ƒåº¦é‡‡ç”¨ä¸­å¿ƒå¼è®¾è®¡ï¼Œâ€œè°ƒåº¦ä¸­å¿ƒâ€åŸºäºé›†ç¾¤Quartzå®ç°ï¼Œå¯ä¿è¯è°ƒåº¦ä¸­å¿ƒHAï¼›</li>
<li>[ ] 4ã€æ‰§è¡Œå™¨HAï¼ˆåˆ†å¸ƒå¼ï¼‰ï¼šä»»åŠ¡åˆ†å¸ƒå¼æ‰§è¡Œï¼Œä»»åŠ¡â€æ‰§è¡Œå™¨â€æ”¯æŒé›†ç¾¤éƒ¨ç½²ï¼Œå¯ä¿è¯ä»»åŠ¡æ‰§è¡ŒHAï¼›</li>
<li>[ ] 5ã€ä»»åŠ¡Failoverï¼šæ‰§è¡Œå™¨é›†ç¾¤éƒ¨ç½²æ—¶ï¼Œä»»åŠ¡è·¯ç”±ç­–ç•¥é€‰æ‹©â€æ•…éšœè½¬ç§»â€æƒ…å†µä¸‹è°ƒåº¦å¤±è´¥æ—¶å°†ä¼šå¹³æ»‘åˆ‡æ¢æ‰§è¡Œå™¨è¿›è¡ŒFailoverï¼›</li>
<li>[ ] 6ã€ä¸€è‡´æ€§ï¼šâ€œè°ƒåº¦ä¸­å¿ƒâ€é€šè¿‡DBé”ä¿è¯é›†ç¾¤åˆ†å¸ƒå¼è°ƒåº¦çš„ä¸€è‡´æ€§, ä¸€æ¬¡ä»»åŠ¡è°ƒåº¦åªä¼šè§¦å‘ä¸€æ¬¡æ‰§è¡Œï¼›</li>
<li>[ ] 7ã€è‡ªå®šä¹‰ä»»åŠ¡å‚æ•°ï¼šæ”¯æŒåœ¨çº¿é…ç½®è°ƒåº¦ä»»åŠ¡å…¥å‚ï¼Œå³æ—¶ç”Ÿæ•ˆï¼›</li>
<li>[ ] 8ã€è°ƒåº¦çº¿ç¨‹æ± ï¼šè°ƒåº¦ç³»ç»Ÿå¤šçº¿ç¨‹è§¦å‘è°ƒåº¦è¿è¡Œï¼Œç¡®ä¿è°ƒåº¦ç²¾ç¡®æ‰§è¡Œï¼Œä¸è¢«å µå¡ï¼›</li>
<li>[ ] 9ã€å¼¹æ€§æ‰©å®¹ç¼©å®¹ï¼šä¸€æ—¦æœ‰æ–°æ‰§è¡Œå™¨æœºå™¨ä¸Šçº¿æˆ–è€…ä¸‹çº¿ï¼Œä¸‹æ¬¡è°ƒåº¦æ—¶å°†ä¼šé‡æ–°åˆ†é…ä»»åŠ¡ï¼›</li>
<li>[ ] 10ã€é‚®ä»¶æŠ¥è­¦ï¼šä»»åŠ¡å¤±è´¥æ—¶æ”¯æŒé‚®ä»¶æŠ¥è­¦ï¼Œæ”¯æŒé…ç½®å¤šé‚®ä»¶åœ°å€ç¾¤å‘æŠ¥è­¦é‚®ä»¶ï¼›</li>
<li>[ ] 11ã€çŠ¶æ€ç›‘æ§ï¼šæ”¯æŒå®æ—¶ç›‘æ§ä»»åŠ¡è¿›åº¦ï¼›</li>
<li>[ ] 12ã€Rollingæ‰§è¡Œæ—¥å¿—ï¼šæ”¯æŒåœ¨çº¿æŸ¥çœ‹è°ƒåº¦ç»“æœï¼Œå¹¶ä¸”æ”¯æŒä»¥Rollingæ–¹å¼å®æ—¶æŸ¥çœ‹æ‰§è¡Œå™¨è¾“å‡ºçš„å®Œæ•´çš„æ‰§è¡Œæ—¥å¿—ï¼›</li>
<li>[ ] 13ã€GLUEï¼šæä¾›Web IDEï¼Œæ”¯æŒåœ¨çº¿å¼€å‘ä»»åŠ¡é€»è¾‘ä»£ç ï¼ŒåŠ¨æ€å‘å¸ƒï¼Œå®æ—¶ç¼–è¯‘ç”Ÿæ•ˆï¼Œçœç•¥éƒ¨ç½²ä¸Šçº¿çš„è¿‡ç¨‹ã€‚æ”¯æŒ30ä¸ªç‰ˆæœ¬çš„å†å²ç‰ˆæœ¬å›æº¯ã€‚</li>
<li>[ ] 14ã€æ•°æ®åŠ å¯†ï¼šè°ƒåº¦ä¸­å¿ƒå’Œæ‰§è¡Œå™¨ä¹‹é—´çš„é€šè®¯è¿›è¡Œæ•°æ®åŠ å¯†ï¼Œæå‡è°ƒåº¦ä¿¡æ¯å®‰å…¨æ€§ï¼›</li>
<li>[ ] 15ã€ä»»åŠ¡ä¾èµ–ï¼šæ”¯æŒé…ç½®å­ä»»åŠ¡ä¾èµ–ï¼Œå½“çˆ¶ä»»åŠ¡æ‰§è¡Œç»“æŸä¸”æ‰§è¡ŒæˆåŠŸåå°†ä¼šä¸»åŠ¨è§¦å‘ä¸€æ¬¡å­ä»»åŠ¡çš„æ‰§è¡Œ, å¤šä¸ªå­ä»»åŠ¡ç”¨é€—å·åˆ†éš”ï¼›</li>
<li>[ ] 16ã€æ¨é€mavenä¸­å¤®ä»“åº“: å°†ä¼šæŠŠæœ€æ–°ç¨³å®šç‰ˆæ¨é€åˆ°mavenä¸­å¤®ä»“åº“, æ–¹ä¾¿ç”¨æˆ·æ¥å…¥å’Œä½¿ç”¨;</li>
<li>[ ] 17ã€ä»»åŠ¡æ³¨å†Œ: æ‰§è¡Œå™¨ä¼šå‘¨æœŸæ€§è‡ªåŠ¨æ³¨å†Œä»»åŠ¡, è°ƒåº¦ä¸­å¿ƒå°†ä¼šè‡ªåŠ¨å‘ç°æ³¨å†Œçš„ä»»åŠ¡å¹¶è§¦å‘æ‰§è¡Œã€‚åŒæ—¶ï¼Œä¹Ÿæ”¯æŒæ‰‹åŠ¨å½•å…¥æ‰§è¡Œå™¨åœ°å€ï¼›</li>
<li>[ ] 18ã€è·¯ç”±ç­–ç•¥ï¼šæ‰§è¡Œå™¨é›†ç¾¤éƒ¨ç½²æ—¶æä¾›ä¸°å¯Œçš„è·¯ç”±ç­–ç•¥ï¼ŒåŒ…æ‹¬ï¼šç¬¬ä¸€ä¸ªã€æœ€åä¸€ä¸ªã€è½®è¯¢ã€éšæœºã€ä¸€è‡´æ€§HASHã€æœ€ä¸ç»å¸¸ä½¿ç”¨ã€æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨ã€æ•…éšœè½¬ç§»ã€å¿™ç¢Œè½¬ç§»ç­‰ï¼›</li>
<li>[ ] 19ã€è¿è¡ŒæŠ¥è¡¨ï¼šæ”¯æŒå®æ—¶æŸ¥çœ‹è¿è¡Œæ•°æ®ï¼Œå¦‚ä»»åŠ¡æ•°é‡ã€è°ƒåº¦æ¬¡æ•°ã€æ‰§è¡Œå™¨æ•°é‡ç­‰ï¼›ä»¥åŠè°ƒåº¦æŠ¥è¡¨ï¼Œå¦‚è°ƒåº¦æ—¥æœŸåˆ†å¸ƒå›¾ï¼Œè°ƒåº¦æˆåŠŸåˆ†å¸ƒå›¾ç­‰ï¼›</li>
<li>[ ] 20ã€è„šæœ¬ä»»åŠ¡ï¼šæ”¯æŒä»¥GLUEæ¨¡å¼å¼€å‘å’Œè¿è¡Œè„šæœ¬ä»»åŠ¡ï¼ŒåŒ…æ‹¬Shellã€Pythonç­‰ç±»å‹è„šæœ¬;</li>
<li>[ ] 21ã€é˜»å¡å¤„ç†ç­–ç•¥ï¼šè°ƒåº¦è¿‡äºå¯†é›†æ‰§è¡Œå™¨æ¥ä¸åŠå¤„ç†æ—¶çš„å¤„ç†ç­–ç•¥ï¼Œç­–ç•¥åŒ…æ‹¬ï¼šå•æœºä¸²è¡Œï¼ˆé»˜è®¤ï¼‰ã€ä¸¢å¼ƒåç»­è°ƒåº¦ã€è¦†ç›–ä¹‹å‰è°ƒåº¦ï¼›</li>
<li>[ ] 22ã€å¤±è´¥å¤„ç†ç­–ç•¥ï¼›è°ƒåº¦å¤±è´¥æ—¶çš„å¤„ç†ç­–ç•¥ï¼Œç­–ç•¥åŒ…æ‹¬ï¼šå¤±è´¥å‘Šè­¦ï¼ˆé»˜è®¤ï¼‰ã€å¤±è´¥é‡è¯•ï¼›</li>
<li>[ ] 23ã€åˆ†ç‰‡å¹¿æ’­ä»»åŠ¡ï¼šæ‰§è¡Œå™¨é›†ç¾¤éƒ¨ç½²æ—¶ï¼Œä»»åŠ¡è·¯ç”±ç­–ç•¥é€‰æ‹©â€åˆ†ç‰‡å¹¿æ’­â€æƒ…å†µä¸‹ï¼Œä¸€æ¬¡ä»»åŠ¡è°ƒåº¦å°†ä¼šå¹¿æ’­è§¦å‘å¯¹åº”é›†ç¾¤ä¸­æ‰€æœ‰æ‰§è¡Œå™¨æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡ï¼ŒåŒæ—¶ä¼ é€’åˆ†ç‰‡å‚æ•°ï¼›å¯æ ¹æ®åˆ†ç‰‡å‚æ•°å¼€å‘åˆ†ç‰‡ä»»åŠ¡ï¼›</li>
<li>[ ] 24ã€åŠ¨æ€åˆ†ç‰‡ï¼šåˆ†ç‰‡å¹¿æ’­ä»»åŠ¡ä»¥æ‰§è¡Œå™¨ä¸ºç»´åº¦è¿›è¡Œåˆ†ç‰‡ï¼Œæ”¯æŒåŠ¨æ€æ‰©å®¹æ‰§è¡Œå™¨é›†ç¾¤ä»è€ŒåŠ¨æ€å¢åŠ åˆ†ç‰‡æ•°é‡ï¼ŒååŒè¿›è¡Œä¸šåŠ¡å¤„ç†ï¼›åœ¨è¿›è¡Œå¤§æ•°æ®é‡ä¸šåŠ¡æ“ä½œæ—¶å¯æ˜¾è‘—æå‡ä»»åŠ¡å¤„ç†èƒ½åŠ›å’Œé€Ÿåº¦ã€‚</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘&lt;/strong&gt;æœ‰ç¦
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.yunai.me/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
</feed>
