<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>èŠ‹è‰¿Vçš„åšå®¢</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.yunai.me/"/>
  <updated>2017-07-28T11:59:25.000Z</updated>
  <id>http://www.yunai.me/</id>
  
  <author>
    <name>ç‹æ–‡æ–Œ</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ã€æ¨èé˜…è¯»ã€‘Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æ</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-parse-2/</id>
    <published>2017-07-25T16:00:00.000Z</published>
    <updated>2017-07-28T11:59:25.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼š<a href="http://www.yunai.me/images/common/wechat_mp.jpeg">ã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</a></strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. SQLParsingEngine</a></li>
<li><a href="#">3. SQLParser SQLè§£æå™¨</a><ul>
<li><a href="#">3.1 AbstractParser</a></li>
<li><a href="#">3.2 SQLParser</a><ul>
<li><a href="#">3.2.1 #parseExpression() å’Œ SQLExpression</a></li>
<li><a href="#">3.2.2 #parseAlias()</a></li>
<li><a href="#">3.2.3 #parseSingleTable()</a></li>
<li><a href="#">3.2.4 #skipJoin()</a></li>
<li><a href="#">3.2.5 #parseWhere()</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#">4. StatementParser SQLè¯­å¥è§£æå™¨</a><ul>
<li><a href="#">4.1 StatementParser</a></li>
<li><a href="#">4.2 Statement</a></li>
</ul>
</li>
<li><a href="#">5. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>ä¸Šç¯‡æ–‡ç« <a href="http://www.yunai.me/Sharding-JDBC/sql-parse-1/">ã€Šè¯æ³•è§£æã€‹</a>åˆ†äº«äº†<strong>è¯æ³•è§£æå™¨Lexer</strong>æ˜¯å¦‚ä½•è§£æ SQL é‡Œçš„è¯æ³•ã€‚æœ¬æ–‡åˆ†äº«<strong>SQLè§£æå¼•æ“</strong>æ˜¯å¦‚ä½•è§£æä¸ç†è§£ SQLçš„ã€‚å› ä¸ºæœ¬æ–‡å»ºç«‹åœ¨<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-1/">ã€Šè¯æ³•è§£æã€‹</a>ä¹‹ä¸Šï¼Œä½ éœ€è¦é˜…è¯»å®ƒååœ¨å¼€å§‹è¿™æ®µæ—…ç¨‹ã€‚ğŸ™‚å¦‚æœå¯¹è¯æ³•è§£æä¸å®Œå…¨ç†è§£ï¼Œè¯·ç»™æˆ‘çš„å…¬ä¼—å·<strong>ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp.jpeg">èŠ‹è‰¿çš„åç«¯å°å±‹</a>ï¼‰</strong>ç•™è¨€ï¼Œæˆ‘ä¼š<strong>é€æ¡è®¤çœŸè€å¿ƒ</strong>å›å¤ã€‚</p>
<p>åŒºåˆ«äº Lexerï¼ŒParser <strong>ç†è§£SQL</strong>ï¼š</p>
<ul>
<li><strong>æç‚¼åˆ†ç‰‡ä¸Šä¸‹æ–‡</strong></li>
<li><strong>æ ‡è®°éœ€è¦SQLæ”¹å†™çš„éƒ¨åˆ†</strong></li>
</ul>
<p>Parser æœ‰ä¸‰ä¸ªç»„ä»¶ï¼š</p>
<ul>
<li>SQLParsingEngine ï¼šSQL è§£æå¼•æ“</li>
<li>SQLParser ï¼šSQL è§£æå™¨</li>
<li>StatementParser ï¼šSQLè¯­å¥è§£æå™¨</li>
</ul>
<p>SQLParsingEngine è°ƒç”¨ StatementParser è§£æ SQLã€‚<br>StatementParser è°ƒç”¨ SQLParser è§£æ SQL è¡¨è¾¾å¼ã€‚<br>SQLParser è°ƒç”¨ Lexer è§£æ SQL è¯æ³•ã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/01.png" alt=""></p>
<p>ğŸ˜œ æ˜¯ä¸æ˜¯è§‰å¾— SQLParser å’Œ StatementParser çœ‹èµ·æ¥å¾ˆæ¥è¿‘ï¼Ÿä¸‹æ–‡ä¸ºä½ æ­å¼€è¿™ä¸ªç­”æ¡ˆã€‚</p>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1 id="2-SQLParsingEngine"><a href="#2-SQLParsingEngine" class="headerlink" title="2. SQLParsingEngine"></a>2. SQLParsingEngine</h1><p>SQLParsingEngineï¼ŒSQL è§£æå¼•æ“ã€‚å…¶ <code>#parse()</code> æ–¹æ³•ä½œä¸º SQL è§£æå…¥å£ï¼Œæœ¬èº«ä¸å¸¦å¤æ‚é€»è¾‘ï¼Œé€šè¿‡è°ƒç”¨ SQL å¯¹åº”çš„ StatementParser è¿›è¡Œ SQL è§£æã€‚</p>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParsingEngine.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLStatement <span class="title">parse</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å– SQLè§£æå™¨</span></div><div class="line">   SQLParser sqlParser = getSQLParser();</div><div class="line">   <span class="comment">//</span></div><div class="line">   sqlParser.skipIfEqual(Symbol.SEMI); <span class="comment">// è·³è¿‡ ";"</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.WITH)) &#123; <span class="comment">// WITH Syntax</span></div><div class="line">       skipWith(sqlParser);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è·å–å¯¹åº” SQLè¯­å¥è§£æå™¨ è§£æSQL</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.SELECT)) &#123;</div><div class="line">       <span class="keyword">return</span> SelectParserFactory.newInstance(sqlParser).parse();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.INSERT)) &#123;</div><div class="line">       <span class="keyword">return</span> InsertParserFactory.newInstance(shardingRule, sqlParser).parse();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.UPDATE)) &#123;</div><div class="line">       <span class="keyword">return</span> UpdateParserFactory.newInstance(sqlParser).parse();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.DELETE)) &#123;</div><div class="line">       <span class="keyword">return</span> DeleteParserFactory.newInstance(sqlParser).parse();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(sqlParser.getLexer().getCurrentToken().getType());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="3-SQLParser-SQLè§£æå™¨"><a href="#3-SQLParser-SQLè§£æå™¨" class="headerlink" title="3. SQLParser SQLè§£æå™¨"></a>3. SQLParser SQLè§£æå™¨</h1><p>SQLParserï¼ŒSQL è§£æå™¨ã€‚å’Œè¯æ³•è§£æå™¨ Lexer ä¸€æ ·ï¼Œä¸åŒæ•°æ®åº“æœ‰ä¸åŒçš„å®ç°ã€‚</p>
<p>ç±»å›¾å¦‚ä¸‹ï¼ˆ<strong>åŒ…å«æ‰€æœ‰å±æ€§å’Œæ–¹æ³•</strong>ï¼‰ï¼ˆ<strong><a href="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/02.png">æ”¾å¤§å›¾ç‰‡</a></strong>ï¼‰ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/02.png" alt=""></p>
<h2 id="3-1-AbstractParser"><a href="#3-1-AbstractParser" class="headerlink" title="3.1 AbstractParser"></a>3.1 AbstractParser</h2><p>AbstractParserï¼ŒSQLParser çš„æŠ½è±¡çˆ¶ç±»ï¼Œå¯¹ Lexer ç®€å•å°è£…ã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li><code>#skipIfEqual()</code>ï¼šåˆ¤æ–­å½“å‰è¯æ³•æ ‡è®°ç±»å‹æ˜¯å¦ä¸å…¶ä¸­ä¸€ä¸ªä¼ å…¥å€¼ç›¸ç­‰</li>
<li><code>#equalAny()</code>ï¼šåˆ¤æ–­å½“å‰è¯æ³•æ ‡è®°ç±»å‹æ˜¯å¦ä¸å…¶ä¸­ä¸€ä¸ªä¼ å…¥å€¼ç›¸ç­‰</li>
</ul>
<p><em><strong>è¿™é‡Œæœ‰ä¸€ç‚¹æˆ‘ä»¬éœ€è¦æ³¨æ„ï¼ŒSQLParser å¹¶ä¸æ˜¯ç­‰ Lexer è§£æå®Œè¯æ³•( Token )ï¼Œå†æ ¹æ®è¯æ³•å»ç†è§£ SQLã€‚è€Œæ˜¯ï¼Œåœ¨ç†è§£ SQL çš„è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨ Lexer è¿›è¡Œåˆ†è¯ã€‚</strong></em></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParsingEngine.java#parse()ç‰‡æ®µ</span></div><div class="line"><span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.SELECT)) &#123;</div><div class="line">    <span class="keyword">return</span> SelectParserFactory.newInstance(sqlParser).parse();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// AbstractParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equalAny</span><span class="params">(<span class="keyword">final</span> TokenType... tokenTypes)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (TokenType each : tokenTypes) &#123;</div><div class="line">       <span class="keyword">if</span> (each == lexer.getCurrentToken().getType()) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>â†‘â†‘â†‘ åˆ¤æ–­å½“å‰<strong>è¯æ³•</strong>æ˜¯å¦ä¸º SELECTã€‚å®é™… AbstractParser åªçŸ¥é“å½“å‰è¯æ³•ï¼Œå¹¶<strong>ä¸çŸ¥é“</strong>åé¢è¿˜æœ‰å“ªäº›è¯æ³•ï¼Œä¹Ÿ<strong>ä¸çŸ¥é“</strong>ä¹‹å‰æœ‰å“ªäº›è¯æ³•ã€‚</li>
</ul>
<p>æˆ‘ä»¬æ¥çœ‹ AbstractParser é‡Œæ¯”è¾ƒå¤æ‚çš„æ–¹æ³• <code>#skipParentheses()</code> å¸®åŠ©å¤§å®¶å†ç†è§£ä¸‹ã€‚è¯·è®¤çœŸçœ‹ä»£ç æ³¨é‡Šå™¢ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·³è¿‡å°æ‹¬å·å†…æ‰€æœ‰çš„è¯æ³•æ ‡è®°.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> å°æ‹¬å·å†…æ‰€æœ‰çš„è¯æ³•æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">skipParentheses</span><span class="params">()</span> </span>&#123;</div><div class="line">   StringBuilder result = <span class="keyword">new</span> StringBuilder(<span class="string">""</span>);</div><div class="line">   <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">   <span class="keyword">if</span> (Symbol.LEFT_PAREN == getLexer().getCurrentToken().getType()) &#123;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> beginPosition = getLexer().getCurrentToken().getEndPosition();</div><div class="line">       result.append(Symbol.LEFT_PAREN.getLiterals());</div><div class="line">       getLexer().nextToken();</div><div class="line">       <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">           <span class="keyword">if</span> (equalAny(Symbol.QUESTION)) &#123;</div><div class="line">               increaseParametersIndex();</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// åˆ°è¾¾ç»“å°¾ æˆ–è€… åŒ¹é…åˆé€‚æ•°çš„)å³æ‹¬å·</span></div><div class="line">           <span class="keyword">if</span> (Assist.END == getLexer().getCurrentToken().getType() || (Symbol.RIGHT_PAREN == getLexer().getCurrentToken().getType() &amp;&amp; <span class="number">0</span> == count)) &#123;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// å¤„ç†é‡Œé¢æœ‰å¤šä¸ªæ‹¬å·çš„æƒ…å†µï¼Œä¾‹å¦‚ï¼šSELECT COUNT(DISTINCT(order_id) FROM t_order</span></div><div class="line">           <span class="keyword">if</span> (Symbol.LEFT_PAREN == getLexer().getCurrentToken().getType()) &#123;</div><div class="line">               count++;</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Symbol.RIGHT_PAREN == getLexer().getCurrentToken().getType()) &#123;</div><div class="line">               count--;</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// ä¸‹ä¸€ä¸ªè¯æ³•</span></div><div class="line">           getLexer().nextToken();</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// è·å¾—æ‹¬å·å†…çš„å†…å®¹</span></div><div class="line">       result.append(getLexer().getInput().substring(beginPosition, getLexer().getCurrentToken().getEndPosition()));</div><div class="line">       <span class="comment">// ä¸‹ä¸€ä¸ªè¯æ³•</span></div><div class="line">       getLexer().nextToken();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªç±»å…¶å®ƒæ–¹æ³•å¾ˆé‡è¦ï¼Œé€»è¾‘ç›¸å¯¹ç®€å•ï¼Œæˆ‘ä»¬å°±ä¸å ç”¨ç¯‡å¹…äº†ã€‚å¤§å®¶ä¸€å®šè¦çœ‹å“Ÿï¼Œåé¢è°ƒç”¨éå¸¸éå¸¸å¤šã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/master/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/parsing/parser/AbstractParser.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractParser.java ä¼ é€é—¨</a>ã€‚ğŸ‘¼ä¹Ÿå¯ä»¥å…³æ³¨æˆ‘çš„å…¬ä¼—å·<strong>ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp.jpeg">èŠ‹è‰¿çš„åç«¯å°å±‹</a>ï¼‰</strong>å‘é€å…³é”®å­—ã€sjdbcã€‘è·å–<strong>å¢åŠ æ–¹æ³•å†…æ³¨é‡Šçš„é¡¹ç›®åœ°å€</strong>ã€‚</p>
<h2 id="3-2-SQLParser"><a href="#3-2-SQLParser" class="headerlink" title="3.2 SQLParser"></a>3.2 SQLParser</h2><p>SQLParserï¼ŒSQL è§£æå™¨ï¼Œ<strong>ä¸»è¦æä¾›åªè€ƒè™‘ SQL å—çš„è§£ææ–¹æ³•ï¼Œ<em>ä¸è€ƒè™‘ SQL ä¸Šä¸‹æ–‡</em></strong>ã€‚ä¸‹æ–‡å³å°†æåˆ°çš„ StatementParser å°† SQL æ‹†æˆå¯¹åº”çš„<strong>å—</strong>ï¼Œè°ƒç”¨ SQLParser è¿›è¡Œè§£æã€‚ğŸ¤“ è¿™ä¹ˆè¯´ï¼Œå¯èƒ½ä¼šæœ‰äº›æŠ½è±¡ï¼Œæˆ‘ä»¬ä¸‹é¢æ¥ä¸€èµ·çœ‹ã€‚</p>
<p>SQLParser çœ‹èµ·æ¥æ–¹æ³•ç‰¹åˆ«å¤šï¼Œåˆå¹¶ä¸‹ä¸€å…± 5 ç§ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">æ–¹æ³•</th>
<th style="text-align:left">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">#parseExpression()</td>
<td style="text-align:left">è§£æè¡¨è¾¾å¼</td>
</tr>
<tr>
<td style="text-align:left">#parseAlias()</td>
<td style="text-align:left">è§£æåˆ«å</td>
</tr>
<tr>
<td style="text-align:left">#parseSingleTable()</td>
<td style="text-align:left">è§£æå•è¡¨</td>
</tr>
<tr>
<td style="text-align:left">#skipJoin()</td>
<td style="text-align:left">è·³è¿‡è¡¨å…³è”è¯æ³•</td>
</tr>
<tr>
<td style="text-align:left">#parseWhere()</td>
<td style="text-align:left">è§£ææŸ¥è¯¢æ¡ä»¶</td>
</tr>
</tbody>
</table>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/03.png" alt=""></p>
<p>çœ‹äº†è¿™ 5 ä¸ªæ–¹æ³•æ˜¯å¦æœ‰ç‚¹ç†è§£äº†ï¼ŸSQLParser ä¸è€ƒè™‘ SQL æ˜¯ SELECT / INSERT / UPDATE / DELETE ï¼Œå®ƒè€ƒè™‘çš„æ˜¯ï¼Œ<strong>ç»™æˆ‘çš„æ˜¯ WHERE å¤„è§£ææŸ¥è¯¢æ¡ä»¶ï¼Œæˆ–æ˜¯ INSERT INTO è§£æå•è¡¨ ç­‰</strong>ï¼Œæä¾› SELECT / INSERT / UPDATE / DELETE éœ€è¦çš„ SQL å—å…¬ç”¨è§£æã€‚</p>
<h3 id="3-2-1-parseExpression-å’Œ-SQLExpression"><a href="#3-2-1-parseExpression-å’Œ-SQLExpression" class="headerlink" title="3.2.1 #parseExpression() å’Œ SQLExpression"></a>3.2.1 #parseExpression() å’Œ SQLExpression</h3><p>SQLExpressionï¼ŒSQLè¡¨è¾¾å¼æ¥å£ã€‚ç›®å‰ 6 ç§å®ç°ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">ç±»</th>
<th style="text-align:left">è¯´æ˜</th>
<th style="text-align:left">å¯¹åº”Token</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">SQLIdentifierExpression</td>
<td style="text-align:left">æ ‡è¯†è¡¨è¾¾å¼</td>
<td style="text-align:left">Literals.IDENTIFIER</td>
</tr>
<tr>
<td style="text-align:left">SQLPropertyExpression</td>
<td style="text-align:left">å±æ€§è¡¨è¾¾å¼</td>
<td style="text-align:left">æ— </td>
</tr>
<tr>
<td style="text-align:left">SQLNumberExpression</td>
<td style="text-align:left">æ•°å­—è¡¨è¾¾å¼</td>
<td style="text-align:left">Literals.INT, Literals.HEX</td>
</tr>
<tr>
<td style="text-align:left">SQLPlaceholderExpression</td>
<td style="text-align:left">å ä½ç¬¦è¡¨è¾¾å¼</td>
<td style="text-align:left">Symbol.QUESTION</td>
</tr>
<tr>
<td style="text-align:left">SQLTextExpression</td>
<td style="text-align:left">å­—ç¬¦è¡¨è¾¾å¼</td>
<td style="text-align:left">Literals.CHARS</td>
</tr>
<tr>
<td style="text-align:left">SQLIgnoreExpression</td>
<td style="text-align:left">åˆ†ç‰‡ä¸­æ— éœ€å…³æ³¨çš„SQLè¡¨è¾¾å¼</td>
<td style="text-align:left">æ— </td>
</tr>
</tbody>
</table>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/04.png" alt=""></p>
<ul>
<li>SQLPropertyExpression ä¾‹å¦‚ï¼š<code>SELECT * FROM t_order o ORDER BY o.order_id</code> ä¸­çš„ <code>o.order_id</code>ã€‚<strong>SQLPropertyExpression ä» SQLIdentifierExpression è¿›ä¸€æ­¥åˆ¤æ–­è§£æè€Œæ¥ã€‚</strong><br> <img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/05.png" alt=""> </li>
<li>SQLIgnoreExpression ä¾‹å¦‚ï¼š<code>SELECT * FROM t_order o ORDER BY o.order_id % 2</code> ä¸­çš„<code>o.order_id % 2</code>ã€‚<strong>å¤åˆè¡¨è¾¾å¼éƒ½ä¼šè§£ææˆ SQLIgnoreExpressionã€‚</strong></li>
</ul>
<p>è§£æ SQLExpression æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æè¡¨è¾¾å¼.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> è¡¨è¾¾å¼</div><div class="line">*/</div><div class="line"><span class="comment">// TODO å®Œå–„Expressionè§£æçš„å„ç§åœºæ™¯</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> SQLExpression <span class="title">parseExpression</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è§£æè¡¨è¾¾å¼</span></div><div class="line">   String literals = getLexer().getCurrentToken().getLiterals();</div><div class="line">   <span class="keyword">final</span> SQLExpression expression = getExpression(literals);</div><div class="line">   <span class="comment">// SQLIdentifierExpression éœ€è¦ç‰¹æ®Šå¤„ç†ã€‚è€ƒè™‘è‡ªå®šä¹‰å‡½æ•°ï¼Œè¡¨å.å±æ€§æƒ…å†µã€‚</span></div><div class="line">   <span class="keyword">if</span> (skipIfEqual(Literals.IDENTIFIER)) &#123;</div><div class="line">       <span class="keyword">if</span> (skipIfEqual(Symbol.DOT)) &#123; <span class="comment">// ä¾‹å¦‚ï¼ŒORDER BY o.uid ä¸­çš„ "o.uid"</span></div><div class="line">           String property = getLexer().getCurrentToken().getLiterals();</div><div class="line">           getLexer().nextToken();</div><div class="line">           <span class="keyword">return</span> skipIfCompositeExpression() ? <span class="keyword">new</span> SQLIgnoreExpression() : <span class="keyword">new</span> SQLPropertyExpression(<span class="keyword">new</span> SQLIdentifierExpression(literals), property);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (equalAny(Symbol.LEFT_PAREN)) &#123; <span class="comment">// ä¾‹å¦‚ï¼ŒGROUP BY DATE(create_time) ä¸­çš„ "DATE(create_time)"</span></div><div class="line">           skipParentheses();</div><div class="line">           skipRestCompositeExpression();</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> SQLIgnoreExpression();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> skipIfCompositeExpression() ? <span class="keyword">new</span> SQLIgnoreExpression() : expression;</div><div class="line">   &#125;</div><div class="line">   getLexer().nextToken();</div><div class="line">   <span class="keyword">return</span> skipIfCompositeExpression() ? <span class="keyword">new</span> SQLIgnoreExpression() : expression;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾— è¯æ³•Token å¯¹åº”çš„ SQLExpression</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> literals è¯æ³•å­—é¢é‡æ ‡è®°</div><div class="line">* <span class="doctag">@return</span> SQLExpression</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> SQLExpression <span class="title">getExpression</span><span class="params">(<span class="keyword">final</span> String literals)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (equalAny(Symbol.QUESTION)) &#123;</div><div class="line">       increaseParametersIndex();</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLPlaceholderExpression(getParametersIndex() - <span class="number">1</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.CHARS)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLTextExpression(literals);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// TODO è€ƒè™‘longçš„æƒ…å†µ</span></div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.INT)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLNumberExpression(Integer.parseInt(literals));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.FLOAT)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLNumberExpression(Double.parseDouble(literals));</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// TODO è€ƒè™‘longçš„æƒ…å†µ</span></div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.HEX)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLNumberExpression(Integer.parseInt(literals, <span class="number">16</span>));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.IDENTIFIER)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLIdentifierExpression(SQLUtil.getExactlyValue(literals));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> SQLIgnoreExpression();</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* å¦‚æœæ˜¯ å¤åˆè¡¨è¾¾å¼ï¼Œè·³è¿‡ã€‚</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦è·³è¿‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">skipIfCompositeExpression</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (equalAny(Symbol.PLUS, Symbol.SUB, Symbol.STAR, Symbol.SLASH, Symbol.PERCENT, Symbol.AMP, Symbol.BAR, Symbol.DOUBLE_AMP, Symbol.DOUBLE_BAR, Symbol.CARET, Symbol.DOT, Symbol.LEFT_PAREN)) &#123;</div><div class="line">       skipParentheses();</div><div class="line">       skipRestCompositeExpression();</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·³è¿‡å‰©ä½™å¤åˆè¡¨è¾¾å¼</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">skipRestCompositeExpression</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">while</span> (skipIfEqual(Symbol.PLUS, Symbol.SUB, Symbol.STAR, Symbol.SLASH, Symbol.PERCENT, Symbol.AMP, Symbol.BAR, Symbol.DOUBLE_AMP, Symbol.DOUBLE_BAR, Symbol.CARET, Symbol.DOT)) &#123;</div><div class="line">       <span class="keyword">if</span> (equalAny(Symbol.QUESTION)) &#123;</div><div class="line">           increaseParametersIndex();</div><div class="line">       &#125;</div><div class="line">       getLexer().nextToken();</div><div class="line">       skipParentheses();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è§£æäº† SQLExpression æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿæˆ‘ä»¬ä¼šåœ¨<a href="http://www.yunai.me/images/common/wechat_mp.jpeg">ã€ŠæŸ¥è¯¢SQLè§£æã€‹</a>ã€<a href="http://www.yunai.me/images/common/wechat_mp.jpeg">ã€Šæ’å…¥SQLè§£æã€‹</a>ã€<a href="http://www.yunai.me/images/common/wechat_mp.jpeg">ã€Šæ›´æ–°SQLè§£æã€‹</a>ã€<a href="http://www.yunai.me/images/common/wechat_mp.jpeg">ã€Šåˆ é™¤SQLè§£æã€‹</a>ã€‚ç•™ä¸ªæ‚¬å¿µğŸ˜ˆï¼Œå…³æ³¨æˆ‘çš„å…¬ä¼—å·<strong>ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp.jpeg">èŠ‹è‰¿çš„åç«¯å°å±‹</a>ï¼‰</strong>ï¼Œ<strong>å®æ—¶æ”¶åˆ°æ–°æ–‡æ›´æ–°é€šçŸ¥</strong>ã€‚</p>
<h3 id="3-2-2-parseAlias"><a href="#3-2-2-parseAlias" class="headerlink" title="3.2.2 #parseAlias()"></a>3.2.2 #parseAlias()</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æåˆ«å.ä¸ä»…ä»…æ˜¯å­—æ®µçš„åˆ«åï¼Œä¹Ÿå¯ä»¥æ˜¯è¡¨çš„åˆ«åã€‚</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> åˆ«å</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Optional&lt;String&gt; <span class="title">parseAlias</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è§£æå¸¦ AS æƒ…å†µ</span></div><div class="line">   <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.AS)) &#123;</div><div class="line">       <span class="keyword">if</span> (equalAny(Symbol.values())) &#123;</div><div class="line">           <span class="keyword">return</span> Optional.absent();</div><div class="line">       &#125;</div><div class="line">       String result = SQLUtil.getExactlyValue(getLexer().getCurrentToken().getLiterals());</div><div class="line">       getLexer().nextToken();</div><div class="line">       <span class="keyword">return</span> Optional.of(result);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è§£æåˆ«å</span></div><div class="line">   <span class="comment">// TODO å¢åŠ å“ªäº›æ•°æ®åº“è¯†åˆ«å“ªäº›å…³é”®å­—ä½œä¸ºåˆ«åçš„é…ç½®</span></div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.IDENTIFIER, Literals.CHARS, DefaultKeyword.USER, DefaultKeyword.END, DefaultKeyword.CASE, DefaultKeyword.KEY, DefaultKeyword.INTERVAL, DefaultKeyword.CONSTRAINT)) &#123;</div><div class="line">       String result = SQLUtil.getExactlyValue(getLexer().getCurrentToken().getLiterals());</div><div class="line">       getLexer().nextToken();</div><div class="line">       <span class="keyword">return</span> Optional.of(result);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> Optional.absent();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-3-parseSingleTable"><a href="#3-2-3-parseSingleTable" class="headerlink" title="3.2.3 #parseSingleTable()"></a>3.2.3 #parseSingleTable()</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æå•è¡¨.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlStatement SQLè¯­å¥å¯¹è±¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseSingleTable</span><span class="params">(<span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   <span class="keyword">boolean</span> hasParentheses = <span class="keyword">false</span>;</div><div class="line">   <span class="keyword">if</span> (skipIfEqual(Symbol.LEFT_PAREN)) &#123;</div><div class="line">       <span class="keyword">if</span> (equalAny(DefaultKeyword.SELECT)) &#123; <span class="comment">// multiple-update æˆ–è€… multiple-delete</span></div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support subquery"</span>);</div><div class="line">       &#125;</div><div class="line">       hasParentheses = <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   Table table;</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> beginPosition = getLexer().getCurrentToken().getEndPosition() - getLexer().getCurrentToken().getLiterals().length();</div><div class="line">   String literals = getLexer().getCurrentToken().getLiterals();</div><div class="line">   getLexer().nextToken();</div><div class="line">   <span class="keyword">if</span> (skipIfEqual(Symbol.DOT)) &#123;</div><div class="line">       getLexer().nextToken();</div><div class="line">       <span class="keyword">if</span> (hasParentheses) &#123;</div><div class="line">           accept(Symbol.RIGHT_PAREN);</div><div class="line">       &#125;</div><div class="line">       table = <span class="keyword">new</span> Table(SQLUtil.getExactlyValue(literals), parseAlias());</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">if</span> (hasParentheses) &#123;</div><div class="line">           accept(Symbol.RIGHT_PAREN);</div><div class="line">       &#125;</div><div class="line">       table = <span class="keyword">new</span> Table(SQLUtil.getExactlyValue(literals), parseAlias());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (skipJoin()) &#123; <span class="comment">// multiple-update æˆ–è€… multiple-delete</span></div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support Multiple-Table."</span>);</div><div class="line">   &#125;</div><div class="line">   sqlStatement.getSqlTokens().add(<span class="keyword">new</span> TableToken(beginPosition, literals));</div><div class="line">   sqlStatement.getTables().add(table);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-4-skipJoin"><a href="#3-2-4-skipJoin" class="headerlink" title="3.2.4 #skipJoin()"></a>3.2.4 #skipJoin()</h3><p>è·³è¿‡è¡¨å…³è”è¯æ³•ï¼Œæ”¯æŒ <code>SELECT * FROM t_user, t_order WHERE ...</code>, <code>SELECT * FROM t_user JOIN t_order ON ...</code>ã€‚ä¸‹ç¯‡<a href="http://www.yunai.me/images/common/wechat_mp.jpeg">ã€ŠæŸ¥è¯¢SQLè§£æã€‹</a><strong>è§£æè¡¨</strong>ä¼šç”¨åˆ°è¿™ä¸ªæ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·³è¿‡è¡¨å…³è”è¯æ³•.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦è¡¨å…³è”.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">skipJoin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.LEFT, DefaultKeyword.RIGHT, DefaultKeyword.FULL)) &#123;</div><div class="line">       skipIfEqual(DefaultKeyword.OUTER);</div><div class="line">       accept(DefaultKeyword.JOIN);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.INNER)) &#123;</div><div class="line">       accept(DefaultKeyword.JOIN);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.JOIN, Symbol.COMMA, DefaultKeyword.STRAIGHT_JOIN)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.CROSS)) &#123;</div><div class="line">       <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.JOIN, DefaultKeyword.APPLY)) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.OUTER)) &#123;</div><div class="line">       <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.APPLY)) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-5-parseWhere"><a href="#3-2-5-parseWhere" class="headerlink" title="3.2.5 #parseWhere()"></a>3.2.5 #parseWhere()</h3><p>è§£æ WHERE æŸ¥è¯¢æ¡ä»¶ã€‚ç›®å‰æ”¯æŒ AND æ¡ä»¶ï¼Œä¸æ”¯æŒ OR æ¡ä»¶ã€‚è¿‘æœŸ OR æ¡ä»¶æ”¯æŒçš„å¯èƒ½æ€§æ¯”è¾ƒä½ã€‚å¦å¤–æ¡ä»¶è¿™å—å¯¹æ‹¬å·è§£æéœ€è¦ç»§ç»­ä¼˜åŒ–ï¼Œå®é™…ä½¿ç”¨è¯·å‹¿å†™å†—ä½™çš„æ‹¬å·ã€‚ä¾‹å¦‚ï¼š<code>SELECT * FROM tbl_name1 WHERE ((val1=?) AND (val2=?)) AND val3 =?</code>ã€‚</p>
<p>æ ¹æ®ä¸åŒçš„è¿ç®—æ“ä½œç¬¦ï¼Œåˆ†æˆå¦‚ä¸‹æƒ…å†µï¼š</p>
<table>
<thead>
<tr>
<th>è¿ç®—ç¬¦</th>
<th>é™„åŠ æ¡ä»¶</th>
<th>æ–¹æ³•</th>
</tr>
</thead>
<tbody>
<tr>
<td>=</td>
<td></td>
<td>#parseEqualCondition()</td>
</tr>
<tr>
<td>IN</td>
<td></td>
<td>#parseInCondition()</td>
</tr>
<tr>
<td>BETWEEN</td>
<td></td>
<td>#parseBetweenCondition()</td>
</tr>
<tr>
<td>&lt;, &lt;=, &gt;, &gt;=</td>
<td>Oracle æˆ– SQLServer åˆ†é¡µ</td>
<td>#parseRowNumberCondition()</td>
</tr>
<tr>
<td>&lt;, &lt;=, &gt;, &gt;=</td>
<td></td>
<td>#parseOtherCondition()</td>
</tr>
<tr>
<td>LIKE</td>
<td></td>
<td>parseOtherCondition</td>
</tr>
</tbody>
</table>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£ææ‰€æœ‰æŸ¥è¯¢æ¡ä»¶ã€‚</div><div class="line">* ç›®å‰ä¸æ”¯æŒ OR æ¡ä»¶ã€‚</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlStatement SQL</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseConditions</span><span class="params">(<span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   <span class="comment">// AND æŸ¥è¯¢</span></div><div class="line">   <span class="keyword">do</span> &#123;</div><div class="line">       parseComparisonCondition(sqlStatement);</div><div class="line">   &#125; <span class="keyword">while</span> (skipIfEqual(DefaultKeyword.AND));</div><div class="line">   <span class="comment">// ç›®å‰ä¸æ”¯æŒ OR æ¡ä»¶</span></div><div class="line">   <span class="keyword">if</span> (equalAny(DefaultKeyword.OR)) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(getLexer().getCurrentToken().getType());</div><div class="line">   &#125;</div><div class="line">&#125; </div><div class="line"><span class="comment">// TODO è§£æç»„åˆexpr</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æå•ä¸ªæŸ¥è¯¢æ¡ä»¶</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlStatement SQL</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseComparisonCondition</span><span class="params">(<span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   skipIfEqual(Symbol.LEFT_PAREN);</div><div class="line">   SQLExpression left = parseExpression(sqlStatement);</div><div class="line">   <span class="keyword">if</span> (equalAny(Symbol.EQ)) &#123;</div><div class="line">       parseEqualCondition(sqlStatement, left);</div><div class="line">       skipIfEqual(Symbol.RIGHT_PAREN);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(DefaultKeyword.IN)) &#123;</div><div class="line">       parseInCondition(sqlStatement, left);</div><div class="line">       skipIfEqual(Symbol.RIGHT_PAREN);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(DefaultKeyword.BETWEEN)) &#123;</div><div class="line">       parseBetweenCondition(sqlStatement, left);</div><div class="line">       skipIfEqual(Symbol.RIGHT_PAREN);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(Symbol.LT, Symbol.GT, Symbol.LT_EQ, Symbol.GT_EQ)) &#123;</div><div class="line">       <span class="keyword">if</span> (left <span class="keyword">instanceof</span> SQLIdentifierExpression &amp;&amp; sqlStatement <span class="keyword">instanceof</span> SelectStatement</div><div class="line">               &amp;&amp; isRowNumberCondition((SelectStatement) sqlStatement, ((SQLIdentifierExpression) left).getName())) &#123;</div><div class="line">           parseRowNumberCondition((SelectStatement) sqlStatement);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (left <span class="keyword">instanceof</span> SQLPropertyExpression &amp;&amp; sqlStatement <span class="keyword">instanceof</span> SelectStatement</div><div class="line">               &amp;&amp; isRowNumberCondition((SelectStatement) sqlStatement, ((SQLPropertyExpression) left).getName())) &#123;</div><div class="line">           parseRowNumberCondition((SelectStatement) sqlStatement);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           parseOtherCondition(sqlStatement);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (equalAny(DefaultKeyword.LIKE)) &#123;</div><div class="line">       parseOtherCondition(sqlStatement);</div><div class="line">   &#125;</div><div class="line">   skipIfEqual(Symbol.RIGHT_PAREN);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>#parseComparisonCondition()</code> è§£æåˆ° <code>å·¦SQLè¡¨è¾¾å¼(left)</code> å’Œ è¿ç®—ç¬¦ï¼Œè°ƒç”¨ç›¸åº”æ–¹æ³•è¿›ä¸€æ­¥å¤„ç†ã€‚æˆ‘ä»¬é€‰æ‹© <code>#parseEqualCondition()</code> çœ‹ä¸‹ï¼Œå…¶ä»–æ–¹æ³•æœ‰å…´è¶£è·³è½¬ <a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/master/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/parsing/parser/SQLParser.java" rel="external nofollow noopener noreferrer" target="_blank">SQLParser</a> æŸ¥çœ‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æ = æ¡ä»¶</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlStatement SQL</div><div class="line">* <span class="doctag">@param</span> left å·¦SQLExpression</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseEqualCondition</span><span class="params">(<span class="keyword">final</span> SQLStatement sqlStatement, <span class="keyword">final</span> SQLExpression left)</span> </span>&#123;</div><div class="line">   getLexer().nextToken();</div><div class="line">   SQLExpression right = parseExpression(sqlStatement);</div><div class="line">   <span class="comment">// æ·»åŠ åˆ—</span></div><div class="line">   <span class="comment">// TODO å¦‚æœæœ‰å¤šè¡¨,ä¸”æ‰¾ä¸åˆ°columnæ˜¯å“ªä¸ªè¡¨çš„,åˆ™ä¸åŠ å…¥condition,ä»¥åéœ€è¦è§£æbinding table</span></div><div class="line">   <span class="keyword">if</span> ((sqlStatement.getTables().isSingleTable() || left <span class="keyword">instanceof</span> SQLPropertyExpression)</div><div class="line">           <span class="comment">// åªæœ‰å¯¹è·¯ç”±ç»“æœæœ‰å½±å“çš„æ‰ä¼šæ·»åŠ åˆ° conditionsã€‚SQLPropertyExpression å’Œ SQLIdentifierExpression æ— æ³•åˆ¤æ–­ï¼Œæ‰€ä»¥æœªåŠ å…¥ conditions</span></div><div class="line">           &amp;&amp; (right <span class="keyword">instanceof</span> SQLNumberExpression || right <span class="keyword">instanceof</span> SQLTextExpression || right <span class="keyword">instanceof</span> SQLPlaceholderExpression)) &#123;</div><div class="line">       Optional&lt;Column&gt; column = find(sqlStatement.getTables(), left);</div><div class="line">       <span class="keyword">if</span> (column.isPresent()) &#123;</div><div class="line">           sqlStatement.getConditions().add(<span class="keyword">new</span> Condition(column.get(), right), shardingRule);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>#parseEqualCondition()</code> è§£æåˆ° <code>å³SQLè¡¨è¾¾å¼(right)</code>ï¼Œå¹¶åˆ¤æ–­ <code>å·¦å³SQLè¡¨è¾¾å¼</code> ä¸è·¯ç”±é€»è¾‘æ˜¯å¦æœ‰å½±å“ï¼Œå¦‚æœæœ‰ï¼Œåˆ™åŠ å…¥åˆ° Conditionã€‚<strong>è¿™ä¸ªå°±æ˜¯ <code>#parseWhere()</code> çš„ç›®çš„ï¼šè§£æ WHERE æŸ¥è¯¢æ¡ä»¶å¯¹è·¯ç”±æœ‰å½±å“çš„æ¡ä»¶ã€‚</strong><a href="http://www.yunai.me/images/common/wechat_mp.jpeg">ã€Šè·¯ç”±ã€‹</a>ç›¸å…³çš„é€»è¾‘ï¼Œä¼šå•ç‹¬å¼€æ–‡ç« ä»‹ç»ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆç•™æœ‰æ˜ åƒã€‚</p>
<h1 id="4-StatementParser-SQLè¯­å¥è§£æå™¨"><a href="#4-StatementParser-SQLè¯­å¥è§£æå™¨" class="headerlink" title="4. StatementParser SQLè¯­å¥è§£æå™¨"></a>4. StatementParser SQLè¯­å¥è§£æå™¨</h1><h2 id="4-1-StatementParser"><a href="#4-1-StatementParser" class="headerlink" title="4.1 StatementParser"></a>4.1 StatementParser</h2><p>StatementParserï¼ŒSQLè¯­å¥è§£æå™¨ã€‚æ¯ç§ SQLï¼Œéƒ½æœ‰ç›¸åº”çš„ SQLè¯­å¥è§£æå™¨å®ç°ã€‚ä¸åŒæ•°æ®åº“ï¼Œç»§æ‰¿è¿™äº› SQLè¯­å¥è§£æå™¨ï¼Œå®ç°å„è‡ª SQL ä¸Šçš„å·®å¼‚ã€‚å¤§ä½“ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/06.png" alt=""></p>
<p>SQLParsingEngine æ ¹æ®ä¸åŒ SQL è°ƒç”¨å¯¹åº”å·¥å‚åˆ›å»º StatementParserã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectParserFactory</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ›å»ºSelectè¯­å¥è§£æå™¨.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> sqlParser SQLè§£æå™¨</div><div class="line">     * <span class="doctag">@return</span> Selectè¯­å¥è§£æå™¨</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AbstractSelectParser <span class="title">newInstance</span><span class="params">(<span class="keyword">final</span> SQLParser sqlParser)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (sqlParser <span class="keyword">instanceof</span> MySQLParser) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> MySQLSelectParser(sqlParser);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (sqlParser <span class="keyword">instanceof</span> OracleParser) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> OracleSelectParser(sqlParser);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (sqlParser <span class="keyword">instanceof</span> SQLServerParser) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SQLServerSelectParser(sqlParser);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (sqlParser <span class="keyword">instanceof</span> PostgreSQLParser) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PostgreSQLSelectParser(sqlParser);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(String.format(<span class="string">"Cannot support sqlParser class [%s]."</span>, sqlParser.getClass()));</div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è°ƒç”¨ <code>StatementParser#parse()</code> å®ç°æ–¹æ³•ï¼Œå¯¹ SQL è¿›è¡Œè§£æã€‚å…·ä½“è§£æè¿‡ç¨‹ï¼Œå¦å¼€æ–‡ç« åˆ†äº«ã€‚</p>
<h2 id="4-2-Statement"><a href="#4-2-Statement" class="headerlink" title="4.2 Statement"></a>4.2 Statement</h2><p>ä¸åŒ SQL è§£æåï¼Œè¿”å›å¯¹åº”çš„ SQL ç»“æœ,å³ Statementã€‚å¤§ä½“ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/07.png" alt=""></p>
<p>Statement åŒ…å«ä¸¤éƒ¨åˆ†ä¿¡æ¯ï¼š</p>
<ul>
<li><p>åˆ†ç‰‡ä¸Šä¸‹æ–‡ï¼šç”¨äº SQL è·¯ç”±ã€‚</p>
<p>  <img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/08.png" alt=""></p>
</li>
<li><p>SQL æ ‡è®°å¯¹è±¡ï¼šç”¨äº SQL æ”¹å†™ã€‚</p>
<p> <img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/09.png" alt=""></p>
</li>
</ul>
<p>æˆ‘ä»¬ä¼šåœ¨åæ–‡å¢åˆ æ”¹æŸ¥SQLè§£æçš„è¿‡ç¨‹ä¸­åˆ†äº«åˆ°å®ƒä»¬ã€‚</p>
<h2 id="4-3-é¢„å‘Š"><a href="#4-3-é¢„å‘Š" class="headerlink" title="4.3 é¢„å‘Š"></a>4.3 é¢„å‘Š</h2><table>
<thead>
<tr>
<th>Parser</th>
<th>Statement</th>
<th>åˆ†äº«æ–‡ç« </th>
</tr>
</thead>
<tbody>
<tr>
<td>SelectStatementParser</td>
<td>SelectStatement + AbstractSQLStatement</td>
<td><a href="http://www.yunai.me/images/common/wechat_mp.jpeg">ã€ŠæŸ¥è¯¢SQLè§£æã€‹</a></td>
</tr>
<tr>
<td>InsertStatementParser</td>
<td>InsertStatement</td>
<td><a href="http://www.yunai.me/images/common/wechat_mp.jpeg">ã€Šæ’å…¥SQLè§£æã€‹</a></td>
</tr>
<tr>
<td>UpdateStatementParser</td>
<td>UpdateStatement</td>
<td><a href="http://www.yunai.me/images/common/wechat_mp.jpeg">ã€Šæ›´æ–°SQLè§£æã€‹</a></td>
</tr>
<tr>
<td>DeleteStatementParser</td>
<td>DeleteStatement</td>
<td><a href="http://www.yunai.me/images/common/wechat_mp.jpeg">ã€Šåˆ é™¤SQLè§£æã€‹</a></td>
</tr>
</tbody>
</table>
<h1 id="5-å½©è›‹"><a href="#5-å½©è›‹" class="headerlink" title="5. å½©è›‹"></a>5. å½©è›‹</h1><p>è€é“ï¼Œæ˜¯ä¸æ˜¯æœ‰ä¸¢ä¸¢é•¿ï¼Ÿ<br>å¦‚æœæœ‰åœ°æ–¹é”™è¯¯ï¼Œçƒ¦è¯·æŒ‡å‡ºğŸ™‚ã€‚<br>å¦‚æœæœ‰åœ°æ–¹ä¸æ˜¯å¾ˆç†è§£ï¼Œå¯ä»¥åŠ æˆ‘çš„å…¬ä¼—å·<strong>ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp.jpeg">èŠ‹è‰¿çš„åç«¯å°å±‹</a>ï¼‰</strong>ç•™è¨€ï¼Œæˆ‘ä¼š<strong>é€æ¡è®¤çœŸè€å¿ƒ</strong>å›å¤ã€‚<br>å¦‚æœè§‰å¾—è¿˜å‡‘åˆï¼ŒåŠ³é©¾åˆ†äº«æœ‹å‹åœˆæˆ–è€…åŸºä½¬ã€‚</p>
<p><a href="http://www.yunai.me/images/common/wechat_mp.jpeg">ã€ŠæŸ¥è¯¢SQLè§£æã€‹</a>å·²ç»å†™äº†ä¸€åŠï¼Œé¢„è®¡å¾ˆå¿«â€¦</p>
<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼š&lt;a href=&quot;http://www.yunai.m
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆä¸€ï¼‰ä¹‹è¯æ³•è§£æ</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-parse-1/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-parse-1/</id>
    <published>2017-07-22T16:00:00.000Z</published>
    <updated>2017-07-27T16:58:03.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. Lexer è¯æ³•è§£æå™¨</a></li>
<li><a href="#">3. Token è¯æ³•æ ‡è®°</a>
<ul>
<li><a href="#">3.1 DefaultKeyword è¯æ³•å…³é”®è¯</a></li>
<li><a href="#">3.2 Literals è¯æ³•å­—é¢é‡æ ‡è®°</a>
<ul>
<li><a href="#">3.2.1 Literals.IDENTIFIER è¯æ³•å…³é”®è¯</a></li>
<li><a href="#">3.2.2 Literals.VARIABLE å˜é‡</a></li>
<li><a href="#">3.2.3 Literals.CHARS å­—ç¬¦ä¸²</a></li>
<li><a href="#">3.2.4 Literals.HEX åå…­è¿›åˆ¶</a></li>
<li><a href="#">3.2.5 Literals.INT æ•´æ•°</a></li>
<li><a href="#">3.2.6 Literals.FLOAT æµ®ç‚¹æ•°</a></li>
</ul>
</li>
<li><a href="#">3.3 Symbol è¯æ³•ç¬¦å·æ ‡è®°</a></li>
<li><a href="#">3.4 Assist è¯æ³•è¾…åŠ©æ ‡è®°</a></li>
</ul>
</li>
<li><a href="#">4. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p><strong>SQL è§£æå¼•æ“</strong>ï¼Œæ•°æ®åº“ä¸­é—´ä»¶å¿…å¤‡çš„åŠŸèƒ½å’Œæµç¨‹ã€‚Sharding-JDBC åœ¨ <code>1.5.0.M1</code> æ­£å¼å‘å¸ƒæ—¶ï¼Œå°† SQL è§£æå¼•æ“ä» Druid æ›¿æ¢æˆäº†è‡ªç ”çš„ã€‚<strong>æ–°å¼•æ“ä»…è§£æåˆ†ç‰‡ä¸Šä¸‹æ–‡ï¼Œå¯¹äº SQL é‡‡ç”¨&quot;åŠç†è§£&quot;ç†å¿µï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½å’Œå…¼å®¹æ€§ï¼ŒåŒæ—¶é™ä½äº†ä»£ç å¤æ‚åº¦</strong>ï¼ˆä¸ç†è§£æ²¡å…³ç³»ï¼Œæˆ‘ä»¬åç»­ä¼šæ›´æ–°æ–‡ç« è§£é‡Šè¯¥ä¼˜ç‚¹ï¼‰ã€‚ å›½å†…å¦ä¸€æ¬¾æ•°æ®åº“ä¸­é—´ä»¶ MyCAT SQL è§£æå¼•æ“ä¹Ÿæ˜¯ Druidï¼Œç›®å‰ä¹Ÿåœ¨å¼€å‘å±äºè‡ªå·±çš„ SQL è§£æå¼•æ“ã€‚</p>
<p>å¯èƒ½æœ‰åŒå­¦çœ‹åˆ°<strong>SQL è§£æ</strong>ä¼šè¢«å“åˆ°ï¼Œè¯·æ·¡å®šï¼Œè€å¿ƒå¾€ä¸‹çœ‹ã€‚ã€ŠSQL è§£æã€‹å†…å®¹æˆ‘ä»¬ä¼šåˆ†æˆ 5 ç¯‡ç›¸å¯¹ç®€çŸ­çš„æ–‡ç« ï¼Œè®©å¤§å®¶èƒ½å¤Ÿç›¸å¯¹è½»æ¾æ„‰å¿«çš„å»ç†è§£ï¼š</p>
<ol>
<li>è¯æ³•è§£æ</li>
<li>æ’å…¥ SQL è§£æ</li>
<li>æŸ¥è¯¢ SQL è§£æ</li>
<li>æ›´æ–° SQL è§£æ</li>
<li>åˆ é™¤ SQL è§£æ</li>
</ol>
<hr>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_23/01.png" alt=""></p>
<p><strong>SQL è§£æå¼•æ“</strong>åœ¨ <code>parsing</code> åŒ…ä¸‹ï¼Œå¦‚ä¸Šå›¾æ‰€è§åŒ…å«ä¸¤å¤§ç»„ä»¶ï¼š</p>
<ol>
<li>Lexerï¼š<strong>è¯æ³•</strong>è§£æå™¨ã€‚</li>
<li>Parserï¼š<strong>SQL</strong>è§£æå™¨ã€‚</li>
</ol>
<p>ä¸¤è€…éƒ½æ˜¯è§£æå™¨ï¼ŒåŒºåˆ«åœ¨äº Lexer åªåšè¯æ³•çš„è§£æï¼Œä¸å…³æ³¨ä¸Šä¸‹æ–‡ï¼Œå°†å­—ç¬¦ä¸²æ‹†è§£æˆ N ä¸ªè¯æ³•ã€‚è€Œ Parser åœ¨ Lexer çš„åŸºç¡€ä¸Šï¼Œè¿˜éœ€è¦ç†è§£ SQL ã€‚æ‰“ä¸ªæ¯”æ–¹ï¼š</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">SQL ï¼š<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_user  </div><div class="line">Lexer ï¼š[<span class="keyword">SELECT</span>] [ * ] [<span class="keyword">FROM</span>] [t_user]  </div><div class="line">Parser ï¼šè¿™æ˜¯ä¸€æ¡ [<span class="keyword">SELECT</span>] æŸ¥è¯¢è¡¨ä¸º [t_user] ï¼Œå¹¶ä¸”è¿”å› [ * ] æ‰€æœ‰å­—æ®µçš„ <span class="keyword">SQL</span>ã€‚</div></pre></td></tr></table></figure></p>
<p>ğŸ™‚ä¸å®Œå…¨æ‡‚ï¼Ÿæ²¡å…³ç³»ï¼Œæœ¬æ–‡çš„ä¸»è§’æ˜¯ Lexerï¼Œæˆ‘ä»¬é€šè¿‡æºç ä¸€ç‚¹ä¸€ç‚¹ç†è§£ã€‚ä¸€å…± 1400 è¡Œå·¦å³ä»£ç å·¦å³ï¼Œè¿˜åŒ…å«æ³¨é‡Šç­‰ç­‰ï¼Œå®é™…æ›´å°‘å™¢ã€‚</p>
<h1>2. Lexer è¯æ³•è§£æå™¨</h1>
<p><strong>Lexer åŸç†</strong>ï¼š<strong>é¡ºåºé¡ºåºé¡ºåº</strong> è§£æ SQLï¼Œå°†å­—ç¬¦ä¸²æ‹†è§£æˆ N ä¸ªè¯æ³•ã€‚</p>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Lexer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¾“å‡ºå­—ç¬¦ä¸²</div><div class="line">     * æ¯”å¦‚ï¼šSQL</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String input;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¯æ³•æ ‡è®°å­—å…¸</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Dictionary dictionary;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è§£æåˆ° SQL çš„ offset</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> offset;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å½“å‰ è¯æ³•æ ‡è®°</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> Token currentToken;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ†æä¸‹ä¸€ä¸ªè¯æ³•æ ‡è®°.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #currentToken</div><div class="line">     * <span class="doctag">@see</span> #offset</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">nextToken</span><span class="params">()</span> </span>&#123;</div><div class="line">        skipIgnoredToken();</div><div class="line">        <span class="keyword">if</span> (isVariableBegin()) &#123; <span class="comment">// å˜é‡</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanVariable();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isNCharBegin()) &#123; <span class="comment">// N\</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, ++offset).scanChars();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isIdentifierBegin()) &#123; <span class="comment">// Keyword + Literals.IDENTIFIER</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanIdentifier();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isHexDecimalBegin()) &#123; <span class="comment">// åå…­è¿›åˆ¶</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanHexDecimal();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isNumberBegin()) &#123; <span class="comment">// æ•°å­—ï¼ˆæ•´æ•°+æµ®ç‚¹æ•°ï¼‰</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanNumber();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isSymbolBegin()) &#123; <span class="comment">// ç¬¦å·</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanSymbol();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isCharsBegin()) &#123; <span class="comment">// å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼š"abc"</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanChars();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isEnd()) &#123; <span class="comment">// ç»“æŸ</span></div><div class="line">            currentToken = <span class="keyword">new</span> Token(Assist.END, <span class="string">""</span>, offset);</div><div class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// åˆ†æé”™è¯¯ï¼Œæ— ç¬¦åˆæ¡ä»¶çš„è¯æ³•æ ‡è®°</span></div><div class="line">            currentToken = <span class="keyword">new</span> Token(Assist.ERROR, <span class="string">""</span>, offset);</div><div class="line">        &#125;</div><div class="line">        offset = currentToken.getEndPosition();</div><div class="line">        <span class="comment">// System.out.println("| " + currentToken.getLiterals() + " | " + currentToken.getType() + " | " + currentToken.getEndPosition() + " |");</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·³è¿‡å¿½ç•¥çš„è¯æ³•æ ‡è®°</div><div class="line">     * 1. ç©ºæ ¼</div><div class="line">     * 2. SQL Hint</div><div class="line">     * 3. SQL æ³¨é‡Š</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">skipIgnoredToken</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// ç©ºæ ¼</span></div><div class="line">        offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipWhitespace();</div><div class="line">        <span class="comment">// SQL Hint</span></div><div class="line">        <span class="keyword">while</span> (isHintBegin()) &#123;</div><div class="line">            offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipHint();</div><div class="line">            offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipWhitespace();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// SQL æ³¨é‡Š</span></div><div class="line">        <span class="keyword">while</span> (isCommentBegin()) &#123;</div><div class="line">            offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipComment();</div><div class="line">            offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipWhitespace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>é€šè¿‡ <code>#nextToken()</code> æ–¹æ³•ï¼Œä¸æ–­è§£æå‡º Token(<em>è¯æ³•æ ‡è®°</em>)ã€‚æˆ‘ä»¬æ¥æ‰§è¡Œä¸€æ¬¡ï¼Œçœ‹çœ‹ SQL ä¼šè¢«æ‹†è§£æˆå“ªäº› Tokenã€‚</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">SQL ï¼š<span class="keyword">SELECT</span> i.* <span class="keyword">FROM</span> t_order o <span class="keyword">JOIN</span> t_order_item i <span class="keyword">ON</span> o.order_id=i.order_id <span class="keyword">WHERE</span> o.user_id=? <span class="keyword">AND</span> o.order_id=?</div></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th>literals</th>
<th>TokenTypeç±»</th>
<th>TokenTypeå€¼</th>
<th>endPosition</th>
</tr>
</thead>
<tbody>
<tr>
<td>SELECT</td>
<td>DefaultKeyword</td>
<td>SELECT</td>
<td>6</td>
</tr>
<tr>
<td>i</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>8</td>
</tr>
<tr>
<td>.</td>
<td>Symbol</td>
<td>DOT</td>
<td>9</td>
</tr>
<tr>
<td>*</td>
<td>Symbol</td>
<td>STAR</td>
<td>10</td>
</tr>
<tr>
<td>FROM</td>
<td>DefaultKeyword</td>
<td>FROM</td>
<td>15</td>
</tr>
<tr>
<td>t_order</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>23</td>
</tr>
<tr>
<td>o</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>25</td>
</tr>
<tr>
<td>JOIN</td>
<td>DefaultKeyword</td>
<td>JOIN</td>
<td>30</td>
</tr>
<tr>
<td>t_order_item</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>43</td>
</tr>
<tr>
<td>i</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>45</td>
</tr>
<tr>
<td>ON</td>
<td>DefaultKeyword</td>
<td>ON</td>
<td>48</td>
</tr>
<tr>
<td>o</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>50</td>
</tr>
<tr>
<td>.</td>
<td>Symbol</td>
<td>DOT</td>
<td>51</td>
</tr>
<tr>
<td>order_id</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>59</td>
</tr>
<tr>
<td>=</td>
<td>Symbol</td>
<td>EQ</td>
<td>60</td>
</tr>
<tr>
<td>i</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>61</td>
</tr>
<tr>
<td>.</td>
<td>Symbol</td>
<td>DOT</td>
<td>62</td>
</tr>
<tr>
<td>order_id</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>70</td>
</tr>
<tr>
<td>WHERE</td>
<td>DefaultKeyword</td>
<td>WHERE</td>
<td>76</td>
</tr>
<tr>
<td>o</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>78</td>
</tr>
<tr>
<td>.</td>
<td>Symbol</td>
<td>DOT</td>
<td>79</td>
</tr>
<tr>
<td>user_id</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>86</td>
</tr>
<tr>
<td>=</td>
<td>Symbol</td>
<td>EQ</td>
<td>87</td>
</tr>
<tr>
<td>?</td>
<td>Symbol</td>
<td>QUESTION</td>
<td>88</td>
</tr>
<tr>
<td>AND</td>
<td>DefaultKeyword</td>
<td>AND</td>
<td>92</td>
</tr>
<tr>
<td>o</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>94</td>
</tr>
<tr>
<td>.</td>
<td>Symbol</td>
<td>DOT</td>
<td>95</td>
</tr>
<tr>
<td>order_id</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>103</td>
</tr>
<tr>
<td>=</td>
<td>Symbol</td>
<td>EQ</td>
<td>104</td>
</tr>
<tr>
<td>?</td>
<td>Symbol</td>
<td>QUESTION</td>
<td>105</td>
</tr>
<tr>
<td></td>
<td>Assist</td>
<td>END</td>
<td>105</td>
</tr>
</tbody>
</table>
<p>çœ¼å°–çš„åŒå­¦å¯èƒ½çœ‹åˆ°äº† Tokenizerã€‚å¯¹çš„ï¼Œå®ƒæ˜¯ Lexer çš„å¥½åŸºä½¬ï¼Œè´Ÿè´£<strong>åˆ†è¯</strong>ã€‚</p>
<p><em>æˆ‘ä»¬æ¥æ€»ç»“ä¸‹ï¼Œ<code>Lexer#nextToken()</code> æ–¹æ³•é‡Œï¼Œä½¿ç”¨ <code>#skipIgnoredToken()</code> æ–¹æ³•è·³è¿‡å¿½ç•¥çš„ Tokenï¼Œé€šè¿‡ <code>#isXXXX()</code> æ–¹æ³•åˆ¤æ–­å¥½ä¸‹ä¸€ä¸ª Token çš„ç±»å‹åï¼Œ<strong>äº¤ç»™ Tokenizer è¿›è¡Œåˆ†è¯è¿”å› Token</strong>ã€‚â€¼ï¸æ­¤å¤„å¯ä»¥è€ƒè™‘åšä¸ªä¼˜åŒ–ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½ <code>new Tokenizer(...)</code> å‡ºæ¥ï¼Œä¸€ä¸ª Lexer æ­é…ä¸€ä¸ª Tokenizerã€‚</em></p>
<hr>
<p>ç”±äºä¸åŒæ•°æ®åº“éµå®ˆ SQL è§„èŒƒç•¥æœ‰ä¸åŒï¼Œæ‰€ä»¥ä¸åŒçš„æ•°æ®åº“å¯¹åº”ä¸åŒçš„ Lexerã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_23/02.png" alt=""></p>
<p>å­ Lexer é€šè¿‡é‡å†™æ–¹æ³•å®ç°è‡ªå·±ç‹¬æœ‰çš„ SQL è¯­æ³•ã€‚</p>
<h1>3. Token è¯æ³•æ ‡è®°</h1>
<p>ä¸Šæ–‡æˆ‘ä»¬å·²ç»çœ‹è¿‡ Token çš„ä¾‹å­ï¼Œä¸€å…±æœ‰ 3 ä¸ªå±æ€§ï¼š</p>
<ul>
<li>TokenType type ï¼šè¯æ³•æ ‡è®°ç±»å‹</li>
<li>String literals ï¼šè¯æ³•å­—é¢é‡æ ‡è®°</li>
<li>int endPosition ï¼š<code>literals</code> åœ¨ SQL é‡Œçš„ç»“æŸä½ç½®</li>
</ul>
<p>TokenType è¯æ³•æ ‡è®°ç±»å‹ï¼Œä¸€å…±åˆ†æˆ 4 ä¸ªå¤§ç±»ï¼š</p>
<ul>
<li>DefaultKeyword ï¼šè¯æ³•å…³é”®è¯</li>
<li>Literals ï¼šè¯æ³•å­—é¢é‡æ ‡è®°</li>
<li>Symbol ï¼šè¯æ³•ç¬¦å·æ ‡è®°</li>
<li>Assist ï¼šè¯æ³•è¾…åŠ©æ ‡è®°</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_23/03.png" alt=""></p>
<h2>3.1 DefaultKeyword è¯æ³•å…³é”®è¯</h2>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_23/04.png" alt=""></p>
<p><strong>ä¸åŒæ•°æ®åº“æœ‰è‡ªå·±ç‹¬æœ‰çš„_è¯æ³•å…³é”®è¯_ï¼Œä¾‹å¦‚ MySQL ç†ŸçŸ¥çš„åˆ†é¡µ Limitã€‚</strong></p>
<p>æˆ‘ä»¬ä»¥ MySQL ä¸¾ä¸ªä¾‹å­ï¼Œå½“åˆ›å»º MySQLLexer æ—¶ï¼Œä¼šåŠ è½½ DefaultKeyword å’Œ MySQLKeywordï¼ˆ <em>OracleLexerã€PostgreSQLLexerã€SQLServerLexer åŒ MySQLLexer</em> ï¼‰ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MySQLLexer.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MySQLLexer</span> <span class="keyword">extends</span> <span class="title">Lexer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å­—å…¸</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Dictionary dictionary = <span class="keyword">new</span> Dictionary(MySQLKeyword.values());</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MySQLLexer</span><span class="params">(<span class="keyword">final</span> String input)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(input, dictionary);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Dictionary.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Dictionary</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¯æ³•å…³é”®è¯Map</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Keyword&gt; tokens = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1024</span>);</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Dictionary</span><span class="params">(<span class="keyword">final</span> Keyword... dialectKeywords)</span> </span>&#123;</div><div class="line">        fill(dialectKeywords);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è£…ä¸Šé»˜è®¤è¯æ³•å…³é”®è¯ + æ–¹è¨€è¯æ³•å…³é”®è¯</div><div class="line">     * ä¸åŒçš„æ•°æ®åº“æœ‰ç›¸åŒçš„é»˜è®¤è¯æ³•å…³é”®è¯ï¼Œæœ‰æœ‰ä¸åŒçš„æ–¹è¨€å…³é”®è¯</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> dialectKeywords æ–¹è¨€è¯æ³•å…³é”®è¯</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fill</span><span class="params">(<span class="keyword">final</span> Keyword... dialectKeywords)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (DefaultKeyword each : DefaultKeyword.values()) &#123;</div><div class="line">            tokens.put(each.name(), each);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (Keyword each : dialectKeywords) &#123;</div><div class="line">            tokens.put(each.toString(), each);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Keyword ä¸ Literals.IDENTIFIER æ˜¯ä¸€èµ·è§£æçš„ï¼Œæˆ‘ä»¬æ”¾åœ¨ Literals.IDENTIFIER å¤„ä¸€èµ·åˆ†æã€‚</p>
<h2>3.2 Literals è¯æ³•å­—é¢é‡æ ‡è®°</h2>
<p>Literals è¯æ³•å­—é¢é‡æ ‡è®°ï¼Œä¸€å…±åˆ†æˆ 6 ç§ï¼š</p>
<ul>
<li>IDENTIFIER ï¼šè¯æ³•å…³é”®è¯</li>
<li>VARIABLE ï¼šå˜é‡</li>
<li>CHARS ï¼šå­—ç¬¦ä¸²</li>
<li>HEX ï¼šåå…­è¿›åˆ¶</li>
<li>INT ï¼šæ•´æ•°</li>
<li>FLOAT ï¼šæµ®ç‚¹æ•°</li>
</ul>
<h3>3.2.1 Literals.IDENTIFIER è¯æ³•å…³é”®è¯</h3>
<p>è¯æ³•å…³é”®è¯ã€‚ä¾‹å¦‚ï¼šè¡¨åï¼ŒæŸ¥è¯¢å­—æ®µ ç­‰ç­‰ã€‚</p>
<p>è§£æ Literals.IDENTIFIER ä¸ Keyword æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isIdentifierBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> isIdentifierBegin(getCurrentChar(<span class="number">0</span>));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isIdentifierBegin</span><span class="params">(<span class="keyword">final</span> <span class="keyword">char</span> ch)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> CharType.isAlphabet(ch) || <span class="string">'`'</span> == ch || <span class="string">'_'</span> == ch || <span class="string">'$'</span> == ch;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Tokenizer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰«ææ ‡è¯†ç¬¦.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> æ ‡è¯†ç¬¦æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Token <span class="title">scanIdentifier</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// `å­—æ®µ`ï¼Œä¾‹å¦‚ï¼šSELECT `id` FROM t_user ä¸­çš„ `id`</span></div><div class="line">   <span class="keyword">if</span> (<span class="string">'`'</span> == charAt(offset)) &#123;</div><div class="line">       <span class="keyword">int</span> length = getLengthUntilTerminatedChar(<span class="string">'`'</span>);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Token(Literals.IDENTIFIER, input.substring(offset, offset + length), offset + length);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">int</span> length = <span class="number">0</span>;</div><div class="line">   <span class="keyword">while</span> (isIdentifierChar(charAt(offset + length))) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   String literals = input.substring(offset, offset + length);</div><div class="line">   <span class="comment">// å¤„ç† order / group ä½œä¸ºè¡¨å</span></div><div class="line">   <span class="keyword">if</span> (isAmbiguousIdentifier(literals)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Token(processAmbiguousIdentifier(offset + length, literals), literals, offset + length);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ä» è¯æ³•å…³é”®è¯ æŸ¥æ‰¾æ˜¯å¦æ˜¯ Keywordï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› Keywordï¼Œå¦åˆ™è¿”å› Literals.IDENTIFIER</span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Token(dictionary.findTokenType(literals, Literals.IDENTIFIER), literals, offset + length);</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¡ç®—åˆ°ç»“æŸå­—ç¬¦çš„é•¿åº¦</div><div class="line">*</div><div class="line">* <span class="doctag">@see</span> #hasEscapeChar(char, int) å¤„ç†ç±»ä¼¼ SELECT a AS `b``c` FROM tableã€‚æ­¤å¤„è¿ç»­çš„ "``" ä¸æ˜¯ç»“å°¾ï¼Œå¦‚æœä¼ é€’çš„æ˜¯ "`" ä¼šäº§ç”Ÿè¯¯åˆ¤ï¼Œæ‰€ä»¥åŠ äº†è¿™ä¸ªåˆ¤æ–­</div><div class="line">* <span class="doctag">@param</span> terminatedChar ç»“æŸå­—ç¬¦</div><div class="line">* <span class="doctag">@return</span> é•¿åº¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getLengthUntilTerminatedChar</span><span class="params">(<span class="keyword">final</span> <span class="keyword">char</span> terminatedChar)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> length = <span class="number">1</span>;</div><div class="line">   <span class="keyword">while</span> (terminatedChar != charAt(offset + length) || hasEscapeChar(terminatedChar, offset + length)) &#123;</div><div class="line">       <span class="keyword">if</span> (offset + length &gt;= input.length()) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnterminatedCharException(terminatedChar);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (hasEscapeChar(terminatedChar, offset + length)) &#123;</div><div class="line">           length++;</div><div class="line">       &#125;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> length + <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦æ˜¯ Escape å­—ç¬¦</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> charIdentifier å­—ç¬¦</div><div class="line">* <span class="doctag">@param</span> offset ä½ç½®</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasEscapeChar</span><span class="params">(<span class="keyword">final</span> <span class="keyword">char</span> charIdentifier, <span class="keyword">final</span> <span class="keyword">int</span> offset)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> charIdentifier == charAt(offset) &amp;&amp; charIdentifier == charAt(offset + <span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isIdentifierChar</span><span class="params">(<span class="keyword">final</span> <span class="keyword">char</span> ch)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> CharType.isAlphabet(ch) || CharType.isDigital(ch) || <span class="string">'_'</span> == ch || <span class="string">'$'</span> == ch || <span class="string">'#'</span> == ch;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦æ˜¯å¼•èµ·æ­§ä¹‰çš„æ ‡è¯†ç¬¦</div><div class="line">* ä¾‹å¦‚ "SELECT * FROM group"ï¼Œæ­¤æ—¶ "group" ä»£è¡¨çš„æ˜¯è¡¨åï¼Œè€Œéè¯æ³•å…³é”®è¯</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> literals æ ‡è¯†ç¬¦</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isAmbiguousIdentifier</span><span class="params">(<span class="keyword">final</span> String literals)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> DefaultKeyword.ORDER.name().equalsIgnoreCase(literals) || DefaultKeyword.GROUP.name().equalsIgnoreCase(literals);</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–å¼•èµ·æ­§ä¹‰çš„æ ‡è¯†ç¬¦å¯¹åº”çš„è¯æ³•æ ‡è®°ç±»å‹</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> offset ä½ç½®</div><div class="line">* <span class="doctag">@param</span> literals æ ‡è¯†ç¬¦</div><div class="line">* <span class="doctag">@return</span> è¯æ³•æ ‡è®°ç±»å‹</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> TokenType <span class="title">processAmbiguousIdentifier</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> offset, <span class="keyword">final</span> String literals)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">   <span class="keyword">while</span> (CharType.isWhitespace(charAt(offset + i))) &#123;</div><div class="line">       i++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (DefaultKeyword.BY.name().equalsIgnoreCase(String.valueOf(<span class="keyword">new</span> <span class="keyword">char</span>[] &#123;charAt(offset + i), charAt(offset + i + <span class="number">1</span>)&#125;))) &#123;</div><div class="line">       <span class="keyword">return</span> dictionary.findTokenType(literals);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> Literals.IDENTIFIER;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>3.2.2 Literals.VARIABLE å˜é‡</h3>
<p>å˜é‡ã€‚ä¾‹å¦‚ï¼š<code>SELECT @@VERSION</code> ã€‚</p>
<p>è§£ææ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦æ˜¯ å˜é‡</div><div class="line">* MySQL ä¸ SQL Server æ”¯æŒ</div><div class="line">* </div><div class="line">* <span class="doctag">@see</span> Tokenizer#scanVariable()</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isVariableBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Tokenizer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰«æå˜é‡.</div><div class="line">* åœ¨ MySQL é‡Œï¼Œ@ä»£è¡¨ç”¨æˆ·å˜é‡ï¼›@@ä»£è¡¨ç³»ç»Ÿå˜é‡ã€‚</div><div class="line">* åœ¨ SQLServer é‡Œï¼Œæœ‰ @@ã€‚</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> å˜é‡æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Token <span class="title">scanVariable</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> length = <span class="number">1</span>;</div><div class="line">   <span class="keyword">if</span> (<span class="string">'@'</span> == charAt(offset + <span class="number">1</span>)) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">while</span> (isVariableChar(charAt(offset + length))) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Token(Literals.VARIABLE, input.substring(offset, offset + length), offset + length);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>3.2.3 Literals.CHARS å­—ç¬¦ä¸²</h3>
<p>å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚ï¼š<code>SELECT &quot;123&quot;</code> ã€‚</p>
<p>è§£ææ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦ N\</div><div class="line">* ç›®å‰ SQLServer ç‹¬æœ‰ï¼šåœ¨ SQL Server ä¸­è™•ç† Unicode å­—ä¸²å¸¸æ•¸æ™‚ï¼Œå¿…éœ€ç‚ºæ‰€æœ‰çš„ Unicode å­—ä¸²åŠ ä¸Šå‰ç½®è© N</div><div class="line">*</div><div class="line">* <span class="doctag">@see</span> Tokenizer#scanChars()</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isNCharBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> isSupportNChars() &amp;&amp; <span class="string">'N'</span> == getCurrentChar(<span class="number">0</span>) &amp;&amp; <span class="string">'\''</span> == getCurrentChar(<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isCharsBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="string">'\''</span> == getCurrentChar(<span class="number">0</span>) || <span class="string">'\"'</span> == getCurrentChar(<span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Tokenizer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰«æå­—ç¬¦ä¸².</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> å­—ç¬¦ä¸²æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Token <span class="title">scanChars</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> scanChars(charAt(offset));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> Token <span class="title">scanChars</span><span class="params">(<span class="keyword">final</span> <span class="keyword">char</span> terminatedChar)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> length = getLengthUntilTerminatedChar(terminatedChar);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Token(Literals.CHARS, input.substring(offset + <span class="number">1</span>, offset + length - <span class="number">1</span>), offset + length);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>3.2.4 Literals.HEX åå…­è¿›åˆ¶</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦æ˜¯ åå…­è¿›åˆ¶</div><div class="line">*</div><div class="line">* <span class="doctag">@see</span> Tokenizer#scanHexDecimal()</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isHexDecimalBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="string">'0'</span> == getCurrentChar(<span class="number">0</span>) &amp;&amp; <span class="string">'x'</span> == getCurrentChar(<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Tokenizer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰«æåå…­è¿›åˆ¶æ•°.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> åå…­è¿›åˆ¶æ•°æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Token <span class="title">scanHexDecimal</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> length = HEX_BEGIN_SYMBOL_LENGTH;</div><div class="line">   <span class="comment">// è´Ÿæ•°</span></div><div class="line">   <span class="keyword">if</span> (<span class="string">'-'</span> == charAt(offset + length)) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">while</span> (isHex(charAt(offset + length))) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Token(Literals.HEX, input.substring(offset, offset + length), offset + length);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>3.2.5 Literals.INT æ•´æ•°</h3>
<p>æ•´æ•°ã€‚ä¾‹å¦‚ï¼š<code>SELECT * FROM t_user WHERE id = 1</code>ã€‚</p>
<p>Literals.INT ä¸ Literals.FLOAT æ˜¯ä¸€èµ·è§£æçš„ï¼Œæˆ‘ä»¬æ”¾åœ¨ Literals.FLOAT å¤„ä¸€èµ·åˆ†æã€‚</p>
<h3>3.2.6 Literals.FLOAT æµ®ç‚¹æ•°</h3>
<p>æµ®ç‚¹æ•°ã€‚ä¾‹å¦‚ï¼š<code>SELECT * FROM t_user WHERE id = 1.0</code>ã€‚
æµ®ç‚¹æ•°åŒ…å«å‡ ç§ï¼š&quot;1.0&quot;ï¼Œ&quot;1.0F&quot;ï¼Œ&quot;7.823E5&quot;ï¼ˆç§‘å­¦è®¡æ•°æ³•ï¼‰ã€‚</p>
<p>è§£ææ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦æ˜¯ æ•°å­—</div><div class="line">* '-' éœ€è¦ç‰¹æ®Šå¤„ç†ã€‚".2" è¢«å¤„ç†æˆçœç•¥0çš„å°æ•°ï¼Œ"-.2" ä¸èƒ½è¢«å¤„ç†æˆçœç•¥çš„å°æ•°ï¼Œå¦åˆ™ä¼šå‡ºé—®é¢˜ã€‚</div><div class="line">* ä¾‹å¦‚è¯´ï¼Œ"SELECT a-.2" å¤„ç†çš„ç»“æœæ˜¯ "SELECT" / "a" / "-" / ".2"</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isNumberBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> CharType.isDigital(getCurrentChar(<span class="number">0</span>)) <span class="comment">// æ•°å­—</span></div><div class="line">           || (<span class="string">'.'</span> == getCurrentChar(<span class="number">0</span>) &amp;&amp; CharType.isDigital(getCurrentChar(<span class="number">1</span>)) &amp;&amp; !isIdentifierBegin(getCurrentChar(-<span class="number">1</span>)) <span class="comment">// æµ®ç‚¹æ•°</span></div><div class="line">           || (<span class="string">'-'</span> == getCurrentChar(<span class="number">0</span>) &amp;&amp; (<span class="string">'.'</span> == getCurrentChar(<span class="number">0</span>) || CharType.isDigital(getCurrentChar(<span class="number">1</span>))))); <span class="comment">// è´Ÿæ•°</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Tokenizer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰«ææ•°å­—.</div><div class="line">* è§£ææ•°å­—çš„ç»“æœä¼šæœ‰ä¸¤ç§ï¼šæ•´æ•° å’Œ æµ®ç‚¹æ•°.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> æ•°å­—æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Token <span class="title">scanNumber</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> length = <span class="number">0</span>;</div><div class="line">   <span class="comment">// è´Ÿæ•°</span></div><div class="line">   <span class="keyword">if</span> (<span class="string">'-'</span> == charAt(offset + length)) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æµ®ç‚¹æ•°</span></div><div class="line">   length += getDigitalLength(offset + length);</div><div class="line">   <span class="keyword">boolean</span> isFloat = <span class="keyword">false</span>;</div><div class="line">   <span class="keyword">if</span> (<span class="string">'.'</span> == charAt(offset + length)) &#123;</div><div class="line">       isFloat = <span class="keyword">true</span>;</div><div class="line">       length++;</div><div class="line">       length += getDigitalLength(offset + length);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç§‘å­¦è®¡æ•°è¡¨ç¤ºï¼Œä¾‹å¦‚ï¼šSELECT 7.823E5</span></div><div class="line">   <span class="keyword">if</span> (isScientificNotation(offset + length)) &#123;</div><div class="line">       isFloat = <span class="keyword">true</span>;</div><div class="line">       length++;</div><div class="line">       <span class="keyword">if</span> (<span class="string">'+'</span> == charAt(offset + length) || <span class="string">'-'</span> == charAt(offset + length)) &#123;</div><div class="line">           length++;</div><div class="line">       &#125;</div><div class="line">       length += getDigitalLength(offset + length);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æµ®ç‚¹æ•°ï¼Œä¾‹å¦‚ï¼šSELECT 1.333F</span></div><div class="line">   <span class="keyword">if</span> (isBinaryNumber(offset + length)) &#123;</div><div class="line">       isFloat = <span class="keyword">true</span>;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Token(isFloat ? Literals.FLOAT : Literals.INT, input.substring(offset, offset + length), offset + length);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œè¦ç‰¹åˆ«æ³¨æ„ä¸‹ï¼š<strong>&quot;-&quot;</strong>ã€‚åœ¨æ•°å­—è¡¨è¾¾å®ä¾‹ï¼Œå¯ä»¥åˆ¤å®šä¸º è´Ÿå· å’Œ å‡å·ï¼ˆä¸è€ƒè™‘ç§‘å­¦è®¡æ•°æ³•ï¼‰ã€‚</p>
<ul>
<li>&quot;.2&quot;  è§£æç»“æœæ˜¯ &quot;.2&quot;</li>
<li>&quot;-.2&quot; è§£æç»“æœä¸èƒ½æ˜¯ &quot;-.2&quot;ï¼Œè€Œæ˜¯ &quot;-&quot; å’Œ &quot;.2&quot;ã€‚</li>
</ul>
<h2>3.3 Symbol è¯æ³•ç¬¦å·æ ‡è®°</h2>
<p>è¯æ³•ç¬¦å·æ ‡è®°ã€‚ä¾‹å¦‚ï¼š&quot;{&quot;, &quot;}&quot;, &quot;&gt;=&quot; ç­‰ç­‰ã€‚</p>
<p>è§£ææ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦æ˜¯ ç¬¦å·</div><div class="line">*</div><div class="line">* <span class="doctag">@see</span> Tokenizer#scanSymbol()</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSymbolBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> CharType.isSymbol(getCurrentChar(<span class="number">0</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CharType.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ¤æ–­æ˜¯å¦ä¸ºç¬¦å·.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> ch å¾…åˆ¤æ–­çš„å­—ç¬¦</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦ä¸ºç¬¦å·</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isSymbol</span><span class="params">(<span class="keyword">final</span> <span class="keyword">char</span> ch)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="string">'('</span> == ch || <span class="string">')'</span> == ch || <span class="string">'['</span> == ch || <span class="string">']'</span> == ch || <span class="string">'&#123;'</span> == ch || <span class="string">'&#125;'</span> == ch || <span class="string">'+'</span> == ch || <span class="string">'-'</span> == ch || <span class="string">'*'</span> == ch || <span class="string">'/'</span> == ch || <span class="string">'%'</span> == ch || <span class="string">'^'</span> == ch || <span class="string">'='</span> == ch</div><div class="line">           || <span class="string">'&gt;'</span> == ch || <span class="string">'&lt;'</span> == ch || <span class="string">'~'</span> == ch || <span class="string">'!'</span> == ch || <span class="string">'?'</span> == ch || <span class="string">'&amp;'</span> == ch || <span class="string">'|'</span> == ch || <span class="string">'.'</span> == ch || <span class="string">':'</span> == ch || <span class="string">'#'</span> == ch || <span class="string">','</span> == ch || <span class="string">';'</span> == ch;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Tokenizer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰«æç¬¦å·.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> ç¬¦å·æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Token <span class="title">scanSymbol</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> length = <span class="number">0</span>;</div><div class="line">   <span class="keyword">while</span> (CharType.isSymbol(charAt(offset + length))) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   String literals = input.substring(offset, offset + length);</div><div class="line">   <span class="comment">// å€’åºéå†ï¼ŒæŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„ ç¬¦å·ã€‚ä¾‹å¦‚ literals = ";;"ï¼Œä¼šæ˜¯æ‹†åˆ†æˆä¸¤ä¸ª ";"ã€‚å¦‚æœåŸºäºæ­£åºï¼Œliterals = "&lt;="ï¼Œä¼šè¢«è§£ææˆ "&lt;" + "="ã€‚</span></div><div class="line">   Symbol symbol;</div><div class="line">   <span class="keyword">while</span> (<span class="keyword">null</span> == (symbol = Symbol.literalsOf(literals))) &#123;</div><div class="line">       literals = input.substring(offset, offset + --length);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Token(symbol, literals, offset + length);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.4 Assist è¯æ³•è¾…åŠ©æ ‡è®°</h2>
<p>Assist è¯æ³•è¾…åŠ©æ ‡è®°ï¼Œä¸€å…±åˆ†æˆ 2 ç§ï¼š</p>
<ul>
<li>END ï¼šåˆ†æç»“æŸ</li>
<li>ERROR ï¼šåˆ†æé”™è¯¯ã€‚</li>
</ul>
<h1>4. å½©è›‹</h1>
<p>è€é“ï¼Œæ˜¯ä¸æ˜¯æ¯”æƒ³è±¡ä¸­ç®€å•ä¸€äº›ï¼Ÿï¼ç»§ç»­åŠ æ²¹å†™ Parser ç›¸å…³çš„æ–‡ç« ï¼æ¥ä¸€æ³¢å¾®ä¿¡å…¬ä¼—å·å…³æ³¨å§ã€‚</p>
<hr>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" target="_blank" rel="external">ä¼ é€é—¨</a>ã€‚ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¹¿çš„åœºæ™¯ã€‚ç™»è®°å§ï¼Œå°‘å¹´ï¼</strong></p>
<hr>
<p><strong>æˆ‘åˆ›å»ºäº†ä¸€ä¸ªå¾®ä¿¡ç¾¤ã€æºç åœˆã€‘ï¼Œå¸Œæœ›å’Œå¤§å®¶åˆ†äº«äº¤æµè¯»æºç çš„ç»éªŒã€‚<br>
è¯»æºç å…ˆéš¾åæ˜“ï¼ŒæŒæ¡æ–¹æ³•åï¼Œå¯ä»¥åšæ›´æœ‰æ·±åº¦çš„å­¦ä¹ ã€‚<br>
è€Œä¸”æŒæ¡æ–¹æ³•å¹¶ä¸éš¾å™¢ã€‚<br>
åŠ ç¾¤æ–¹å¼ï¼šå¾®ä¿¡å…¬ä¼—å·å‘é€å…³é”®å­—ã€qunã€‘ã€‚</strong></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rock
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>MyCAT æºç åˆ†æ  â€”â€” SQL ON MongoDB</title>
    <link href="http://www.yunai.me/MyCAT/connect-mongodb/"/>
    <id>http://www.yunai.me/MyCAT/connect-mongodb/</id>
    <published>2017-07-18T16:00:00.000Z</published>
    <updated>2017-07-27T16:54:57.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ä¸»æµç¨‹</a></li>
<li><a href="#">3. æŸ¥è¯¢æ“ä½œ</a></li>
<li><a href="#">4. æ’å…¥æ“ä½œ</a></li>
<li><a href="#">5. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>å¯èƒ½ä½ åœ¨çœ‹åˆ°è¿™ä¸ªæ ‡é¢˜ä¼šå°å°çš„åƒæƒŠï¼ŒMyCAT èƒ½ä½¿ç”¨ MongoDB åšæ•°æ®èŠ‚ç‚¹ã€‚æ˜¯çš„ï¼Œæ²¡é”™ï¼Œç¡®å®å¯ä»¥ã€‚<br>
å¼å¼å¼ï¼Œè®©æˆ‘ä»¬å¼€å¯è¿™æ®µç¥å¥‡çš„â€œæ—…é€”â€ã€‚</p>
<p>æœ¬æ–‡ä¸»è¦åˆ†æˆå››éƒ¨åˆ†ï¼š</p>
<ol>
<li>æ€»ä½“æµç¨‹ï¼Œè®©ä½ æœ‰ä¸ªæ•´ä½“çš„è®¤è¯†</li>
<li>æŸ¥è¯¢æ“ä½œ</li>
<li>æ’å…¥æ“ä½œ</li>
<li>å½©è›‹ï¼ŒğŸ˜ˆå½©è›‹ï¼ŒğŸ™‚å½©è›‹</li>
</ol>
<p>å»ºè®®ä½ çœ‹è¿‡è¿™ä¸¤ç¯‡æ–‡ç« ï¼ˆ<em>éå¿…é¡»</em>ï¼‰ï¼š</p>
<ol>
<li><a href="http://www.yunai.me/MyCAT/single-db-single-table-insert/?self">ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹</a></li>
<li><a href="http://www.yunai.me/MyCAT/single-db-single-table-select/?self">ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹</a></li>
</ol>
<h1>2. ä¸»æµç¨‹</h1>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_19/01.png" alt=""></p>
<ol>
<li><code>MyCAT Server</code> æ¥æ”¶ <code>MySQL Client</code> åŸºäº <strong>MySQLåè®®</strong> çš„è¯·æ±‚ï¼Œç¿»è¯‘ <strong>SQL</strong> æˆ <strong>MongoDBæ“ä½œ</strong> å‘é€ç»™ <code>MongoDB Server</code>ã€‚</li>
<li><code>MyCAT Server</code> æ¥æ”¶ <code>MongoDB Server</code> è¿”å›çš„ <strong>MongoDBæ•°æ®</strong>ï¼Œç¿»è¯‘æˆ <code>MySQLæ•°æ®ç»“æœ</code> è¿”å›ç»™ <code>MySQL Client</code>ã€‚</li>
</ol>
<p>è¿™æ ·ä¸€çœ‹ï¼ŒMyCAT è¿æ¥ MongoDB æ˜¯ä¸æ˜¯å°‘ç¥å¥‡ä¸€ç‚¹åˆ—ã€‚</p>
<hr>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_19/02.png" alt=""></p>
<blockquote>
<p>Javaæ•°æ®åº“è¿æ¥ï¼Œï¼ˆJava Database Connectivityï¼Œç®€ç§°JDBCï¼‰æ˜¯Javaè¯­è¨€ä¸­ç”¨æ¥è§„èŒƒå®¢æˆ·ç«¯ç¨‹åºå¦‚ä½•æ¥è®¿é—®æ•°æ®åº“çš„åº”ç”¨ç¨‹åºæ¥å£ï¼Œæä¾›äº†è¯¸å¦‚æŸ¥è¯¢å’Œæ›´æ–°æ•°æ®åº“ä¸­æ•°æ®çš„æ–¹æ³•ã€‚JDBCä¹Ÿæ˜¯Sun Microsystemsçš„å•†æ ‡ã€‚JDBCæ˜¯é¢å‘å…³ç³»å‹æ•°æ®åº“çš„ã€‚</p>
</blockquote>
<p>MyCAT ä½¿ç”¨ JDBC è§„èŒƒï¼ŒæŠ½è±¡äº†å¯¹ MongoDB çš„è®¿é—®ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼ŒMyCAT ä¹ŸæŠ½è±¡äº† SequoiaDB çš„è®¿é—®ã€‚å¯èƒ½è¿™æ ·è¯´æ³•æœ‰äº›æŠ½è±¡ï¼Œçœ‹ä¸ªç±»å›¾å‹å‹æƒŠã€‚</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_19/03.png" alt=""></p>
<p>æ˜¯ä¸æ˜¯ç†Ÿæ‚‰çš„å‘³é“ã€‚<strong>ä¸å¾—ä¸è¯´ JDBC è§„èŒƒçš„ç²¾å¦™ã€‚</strong></p>
<h1>3. æŸ¥è¯¢æ“ä½œ</h1>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">id</span>, <span class="keyword">name</span> <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> <span class="keyword">name</span> &gt; <span class="string">''</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> _id <span class="keyword">DESC</span>;</div></pre></td></tr></table></figure></p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_19/04.png" alt=""></p>
<p>çœ‹é¡ºåºå›¾å·²ç»å¾ˆæ–¹ä¾¿çš„ç†è§£æ•´ä½“é€»è¾‘ï¼Œæˆ‘å°±ä¸å¤šåºŸè¯å•¦ã€‚æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªæ ¸å¿ƒçš„ä»£ç é€»è¾‘ã€‚</p>
<p><strong>1ã€æŸ¥è¯¢ MongoDB</strong></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MongoSQLParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> MongoData <span class="title">query</span><span class="params">()</span> <span class="keyword">throws</span> MongoSQLException </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!(statement <span class="keyword">instanceof</span> SQLSelectStatement)) &#123;</div><div class="line">       <span class="comment">//return null;</span></div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"not a query sql statement"</span>);</div><div class="line">   &#125;</div><div class="line">   MongoData mongo = <span class="keyword">new</span> MongoData();</div><div class="line">   DBCursor c = <span class="keyword">null</span>;</div><div class="line">   SQLSelectStatement selectStmt = (SQLSelectStatement) statement;</div><div class="line">   SQLSelectQuery sqlSelectQuery = selectStmt.getSelect().getQuery();</div><div class="line">   <span class="keyword">int</span> icount = <span class="number">0</span>;</div><div class="line">   <span class="keyword">if</span> (sqlSelectQuery <span class="keyword">instanceof</span> MySqlSelectQueryBlock) &#123;</div><div class="line">       MySqlSelectQueryBlock mysqlSelectQuery = (MySqlSelectQueryBlock) selectStmt.getSelect().getQuery();</div><div class="line"></div><div class="line">       BasicDBObject fields = <span class="keyword">new</span> BasicDBObject();</div><div class="line"></div><div class="line">       <span class="comment">// æ˜¾ç¤ºï¼ˆè¿”å›ï¼‰çš„å­—æ®µ</span></div><div class="line">       <span class="keyword">for</span> (SQLSelectItem item : mysqlSelectQuery.getSelectList()) &#123;</div><div class="line">           <span class="comment">//System.out.println(item.toString());</span></div><div class="line">           <span class="keyword">if</span> (!(item.getExpr() <span class="keyword">instanceof</span> SQLAllColumnExpr)) &#123;</div><div class="line">               <span class="keyword">if</span> (item.getExpr() <span class="keyword">instanceof</span> SQLAggregateExpr) &#123;</div><div class="line">                   SQLAggregateExpr expr = (SQLAggregateExpr) item.getExpr();</div><div class="line">                   <span class="keyword">if</span> (expr.getMethodName().equals(<span class="string">"COUNT"</span>)) &#123; <span class="comment">// TODO å¾…è¯»ï¼šcountï¼ˆ*ï¼‰</span></div><div class="line">                       icount = <span class="number">1</span>;</div><div class="line">                       mongo.setField(getExprFieldName(expr), Types.BIGINT);</div><div class="line">                   &#125;</div><div class="line">                   fields.put(getExprFieldName(expr), <span class="number">1</span>);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   fields.put(getFieldName(item), <span class="number">1</span>);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// è¡¨å</span></div><div class="line">       SQLTableSource table = mysqlSelectQuery.getFrom();</div><div class="line">       DBCollection coll = <span class="keyword">this</span>._db.getCollection(table.toString());</div><div class="line">       mongo.setTable(table.toString());</div><div class="line"></div><div class="line">       <span class="comment">// WHERE</span></div><div class="line">       SQLExpr expr = mysqlSelectQuery.getWhere();</div><div class="line">       DBObject query = parserWhere(expr);</div><div class="line"></div><div class="line">       <span class="comment">// GROUP BY</span></div><div class="line">       SQLSelectGroupByClause groupby = mysqlSelectQuery.getGroupBy();</div><div class="line">       BasicDBObject gbkey = <span class="keyword">new</span> BasicDBObject();</div><div class="line">       <span class="keyword">if</span> (groupby != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">for</span> (SQLExpr gbexpr : groupby.getItems()) &#123;</div><div class="line">               <span class="keyword">if</span> (gbexpr <span class="keyword">instanceof</span> SQLIdentifierExpr) &#123;</div><div class="line">                   String name = ((SQLIdentifierExpr) gbexpr).getName();</div><div class="line">                   gbkey.put(name, Integer.valueOf(<span class="number">1</span>));</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           icount = <span class="number">2</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// SKIP / LIMIT</span></div><div class="line">       <span class="keyword">int</span> limitoff = <span class="number">0</span>;</div><div class="line">       <span class="keyword">int</span> limitnum = <span class="number">0</span>;</div><div class="line">       <span class="keyword">if</span> (mysqlSelectQuery.getLimit() != <span class="keyword">null</span>) &#123;</div><div class="line">           limitoff = getSQLExprToInt(mysqlSelectQuery.getLimit().getOffset());</div><div class="line">           limitnum = getSQLExprToInt(mysqlSelectQuery.getLimit().getRowCount());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (icount == <span class="number">1</span>) &#123; <span class="comment">// COUNTï¼ˆ*ï¼‰</span></div><div class="line">           mongo.setCount(coll.count(query));</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (icount == <span class="number">2</span>) &#123; <span class="comment">// MapReduce</span></div><div class="line">           BasicDBObject initial = <span class="keyword">new</span> BasicDBObject();</div><div class="line">           initial.put(<span class="string">"num"</span>, <span class="number">0</span>);</div><div class="line">           String reduce = <span class="string">"function (obj, prev) &#123; "</span> + <span class="string">"  prev.num++&#125;"</span>;</div><div class="line">           mongo.setGrouyBy(coll.group(gbkey, query, initial, reduce));</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">if</span> ((limitoff &gt; <span class="number">0</span>) || (limitnum &gt; <span class="number">0</span>)) &#123;</div><div class="line">               c = coll.find(query, fields).skip(limitoff).limit(limitnum);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               c = coll.find(query, fields);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="comment">// order by</span></div><div class="line">           SQLOrderBy orderby = mysqlSelectQuery.getOrderBy();</div><div class="line">           <span class="keyword">if</span> (orderby != <span class="keyword">null</span>) &#123;</div><div class="line">               BasicDBObject order = <span class="keyword">new</span> BasicDBObject();</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; orderby.getItems().size(); i++) &#123;</div><div class="line">                   SQLSelectOrderByItem orderitem = orderby.getItems().get(i);</div><div class="line">                   order.put(orderitem.getExpr().toString(), getSQLExprToAsc(orderitem.getType()));</div><div class="line">               &#125;</div><div class="line">               c.sort(order);</div><div class="line">               <span class="comment">// System.out.println(order);</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       mongo.setCursor(c);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> mongo;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>2ã€æŸ¥è¯¢æ¡ä»¶</strong></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MongoSQLParser.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parserWhere</span><span class="params">(SQLExpr aexpr, BasicDBObject o)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (aexpr <span class="keyword">instanceof</span> SQLBinaryOpExpr) &#123;</div><div class="line">       SQLBinaryOpExpr expr = (SQLBinaryOpExpr) aexpr;</div><div class="line">       SQLExpr exprL = expr.getLeft();</div><div class="line">       <span class="keyword">if</span> (!(exprL <span class="keyword">instanceof</span> SQLBinaryOpExpr)) &#123;</div><div class="line">           <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"="</span>)) &#123;</div><div class="line">               o.put(exprL.toString(), getExpValue(expr.getRight()));</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               String op = <span class="string">""</span>;</div><div class="line">               <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"&lt;"</span>)) &#123;</div><div class="line">                   op = <span class="string">"$lt"</span>;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"&lt;="</span>)) &#123;</div><div class="line">                   op = <span class="string">"$lte"</span>;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"&gt;"</span>)) &#123;</div><div class="line">                   op = <span class="string">"$gt"</span>;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"&gt;="</span>)) &#123;</div><div class="line">                   op = <span class="string">"$gte"</span>;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"!="</span>)) &#123;</div><div class="line">                   op = <span class="string">"$ne"</span>;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"&lt;&gt;"</span>)) &#123;</div><div class="line">                   op = <span class="string">"$ne"</span>;</div><div class="line">               &#125;</div><div class="line">               parserDBObject(o, exprL.toString(), op, getExpValue(expr.getRight()));</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"AND"</span>)) &#123;</div><div class="line">               parserWhere(exprL, o);</div><div class="line">               parserWhere(expr.getRight(), o);</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"OR"</span>)) &#123;</div><div class="line">               orWhere(exprL, expr.getRight(), o);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Can't identify the operation of  of where"</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">orWhere</span><span class="params">(SQLExpr exprL, SQLExpr exprR, BasicDBObject ob)</span> </span>&#123;</div><div class="line">   BasicDBObject xo = <span class="keyword">new</span> BasicDBObject();</div><div class="line">   BasicDBObject yo = <span class="keyword">new</span> BasicDBObject();</div><div class="line">   parserWhere(exprL, xo);</div><div class="line">   parserWhere(exprR, yo);</div><div class="line">   ob.put(<span class="string">"$or"</span>, <span class="keyword">new</span> Object[]&#123;xo, yo&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>3ã€è§£æ MongoDB æ•°æ®</strong></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MongoResultSet.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">MongoResultSet</span><span class="params">(MongoData mongo, String schema)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">this</span>._cursor = mongo.getCursor();</div><div class="line">   <span class="keyword">this</span>._schema = schema;</div><div class="line">   <span class="keyword">this</span>._table = mongo.getTable();</div><div class="line">   <span class="keyword">this</span>.isSum = mongo.getCount() &gt; <span class="number">0</span>;</div><div class="line">   <span class="keyword">this</span>._sum = mongo.getCount();</div><div class="line">   <span class="keyword">this</span>.isGroupBy = mongo.getType();</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.isGroupBy) &#123;</div><div class="line">       dblist = mongo.getGrouyBys();</div><div class="line">       <span class="keyword">this</span>.isSum = <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>._cursor != <span class="keyword">null</span>) &#123;</div><div class="line">       select = _cursor.getKeysWanted().keySet().toArray(<span class="keyword">new</span> String[<span class="number">0</span>]);</div><div class="line">       <span class="comment">// è§£æ fields</span></div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>._cursor.hasNext()) &#123;</div><div class="line">           _cur = _cursor.next();</div><div class="line">           <span class="keyword">if</span> (_cur != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">if</span> (select.length == <span class="number">0</span>) &#123;</div><div class="line">                   SetFields(_cur.keySet());</div><div class="line">               &#125;</div><div class="line">               _row = <span class="number">1</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// è®¾ç½® fields ç±»å‹</span></div><div class="line">       <span class="keyword">if</span> (select.length == <span class="number">0</span>) &#123;</div><div class="line">           select = <span class="keyword">new</span> String[]&#123;<span class="string">"_id"</span>&#125;;</div><div class="line">           SetFieldType(<span class="keyword">true</span>);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           SetFieldType(<span class="keyword">false</span>);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       SetFields(mongo.getFields().keySet());<span class="comment">//new String[]&#123;"COUNT(*)"&#125;;</span></div><div class="line">       SetFieldType(mongo.getFields());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å½“ä½¿ç”¨ <code>SELECT *</code> æŸ¥è¯¢å­—æ®µæ—¶ï¼Œfields ä½¿ç”¨ç¬¬ä¸€æ¡æ•°æ®è¿”å›çš„ fieldsã€‚å³ä½¿ï¼Œåé¢çš„æ•°æ®æœ‰å…¶ä»– fieldsï¼Œä¹Ÿä¸è¿”å›ã€‚</li>
</ul>
<p><strong>4ã€è¿”å›æ•°æ®ç»™ MySQL Client</strong></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JDBCConnection.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ouputResultSet</span><span class="params">(ServerConnection sc, String sql)</span></span></div><div class="line">       <span class="keyword">throws</span> SQLException &#123;</div><div class="line">   ResultSet rs = <span class="keyword">null</span>;</div><div class="line">   Statement stmt = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       stmt = con.createStatement();</div><div class="line">       rs = stmt.executeQuery(sql);</div><div class="line"></div><div class="line">       <span class="comment">// header</span></div><div class="line">       List&lt;FieldPacket&gt; fieldPks = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">       ResultSetUtil.resultSetToFieldPacket(sc.getCharset(), fieldPks, rs, <span class="keyword">this</span>.isSpark);</div><div class="line">       <span class="keyword">int</span> colunmCount = fieldPks.size();</div><div class="line">       ByteBuffer byteBuf = sc.allocate();</div><div class="line">       ResultSetHeaderPacket headerPkg = <span class="keyword">new</span> ResultSetHeaderPacket();</div><div class="line">       headerPkg.fieldCount = fieldPks.size();</div><div class="line">       headerPkg.packetId = ++packetId;</div><div class="line">       byteBuf = headerPkg.write(byteBuf, sc, <span class="keyword">true</span>);</div><div class="line">       byteBuf.flip();</div><div class="line">       <span class="keyword">byte</span>[] header = <span class="keyword">new</span> <span class="keyword">byte</span>[byteBuf.limit()];</div><div class="line">       byteBuf.get(header);</div><div class="line">       byteBuf.clear();</div><div class="line">       List&lt;<span class="keyword">byte</span>[]&gt; fields = <span class="keyword">new</span> ArrayList&lt;<span class="keyword">byte</span>[]&gt;(fieldPks.size());</div><div class="line">       <span class="keyword">for</span> (FieldPacket curField : fieldPks) &#123;</div><div class="line">           curField.packetId = ++packetId;</div><div class="line">           byteBuf = curField.write(byteBuf, sc, <span class="keyword">false</span>);</div><div class="line">           byteBuf.flip();</div><div class="line">           <span class="keyword">byte</span>[] field = <span class="keyword">new</span> <span class="keyword">byte</span>[byteBuf.limit()];</div><div class="line">           byteBuf.get(field);</div><div class="line">           byteBuf.clear();</div><div class="line">           fields.add(field);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// header eof</span></div><div class="line">       EOFPacket eofPckg = <span class="keyword">new</span> EOFPacket();</div><div class="line">       eofPckg.packetId = ++packetId;</div><div class="line">       byteBuf = eofPckg.write(byteBuf, sc, <span class="keyword">false</span>);</div><div class="line">       byteBuf.flip();</div><div class="line">       <span class="keyword">byte</span>[] eof = <span class="keyword">new</span> <span class="keyword">byte</span>[byteBuf.limit()];</div><div class="line">       byteBuf.get(eof);</div><div class="line">       byteBuf.clear();</div><div class="line">       <span class="keyword">this</span>.respHandler.fieldEofResponse(header, fields, eof, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">       <span class="comment">// row</span></div><div class="line">       <span class="keyword">while</span> (rs.next()) &#123;</div><div class="line">           RowDataPacket curRow = <span class="keyword">new</span> RowDataPacket(colunmCount);</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; colunmCount; i++) &#123;</div><div class="line">               <span class="keyword">int</span> j = i + <span class="number">1</span>;</div><div class="line">               <span class="keyword">if</span> (MysqlDefs.isBianry((<span class="keyword">byte</span>) fieldPks.get(i).type)) &#123;</div><div class="line">                   curRow.add(rs.getBytes(j));</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fieldPks.get(i).type == MysqlDefs.FIELD_TYPE_DECIMAL ||</div><div class="line">                       fieldPks.get(i).type == (MysqlDefs.FIELD_TYPE_NEW_DECIMAL - <span class="number">256</span>)) &#123; <span class="comment">// field type is unsigned byte</span></div><div class="line">                   <span class="comment">// ensure that do not use scientific notation format</span></div><div class="line">                   BigDecimal val = rs.getBigDecimal(j);</div><div class="line">                   curRow.add(StringUtil.encode(val != <span class="keyword">null</span> ? val.toPlainString() : <span class="keyword">null</span>, sc.getCharset()));</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   curRow.add(StringUtil.encode(rs.getString(j), sc.getCharset()));</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           curRow.packetId = ++packetId;</div><div class="line">           byteBuf = curRow.write(byteBuf, sc, <span class="keyword">false</span>);</div><div class="line">           byteBuf.flip();</div><div class="line">           <span class="keyword">byte</span>[] row = <span class="keyword">new</span> <span class="keyword">byte</span>[byteBuf.limit()];</div><div class="line">           byteBuf.get(row);</div><div class="line">           byteBuf.clear();</div><div class="line">           <span class="keyword">this</span>.respHandler.rowResponse(row, <span class="keyword">this</span>);</div><div class="line">       &#125;</div><div class="line">       fieldPks.clear();</div><div class="line">       <span class="comment">// row eof</span></div><div class="line">       eofPckg = <span class="keyword">new</span> EOFPacket();</div><div class="line">       eofPckg.packetId = ++packetId;</div><div class="line">       byteBuf = eofPckg.write(byteBuf, sc, <span class="keyword">false</span>);</div><div class="line">       byteBuf.flip();</div><div class="line">       eof = <span class="keyword">new</span> <span class="keyword">byte</span>[byteBuf.limit()];</div><div class="line">       byteBuf.get(eof);</div><div class="line">       sc.recycle(byteBuf);</div><div class="line">       <span class="keyword">this</span>.respHandler.rowEofResponse(eof, <span class="keyword">this</span>);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="keyword">if</span> (rs != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               rs.close();</div><div class="line">           &#125; <span class="keyword">catch</span> (SQLException e) &#123;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (stmt != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               stmt.close();</div><div class="line">           &#125; <span class="keyword">catch</span> (SQLException e) &#123;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// MongoResultSet.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(String columnLabel)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   Object x = getObject(columnLabel);</div><div class="line">   <span class="keyword">if</span> (x == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> x.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å½“è¿”å›å­—æ®µå€¼æ˜¯ Object æ—¶ï¼Œè¿”å›è¯¥å¯¹è±¡.toString()ã€‚ä¾‹å¦‚ï¼š</li>
</ul>
<p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">mysql&gt; select * from user order by _id asc;</div><div class="line">+--------------------------+------+-------------------------------+</div><div class="line">| _id                      | name | profile                       |</div><div class="line">+--------------------------+------+-------------------------------+</div><div class="line">| 1                        | 123  | &#123; "age" : 1 , "height" : 100&#125; |</div></pre></td></tr></table></figure></p>
<h1>4. æ’å…¥æ“ä½œ</h1>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_19/05.png" alt=""></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MongoSQLParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">()</span> <span class="keyword">throws</span> MongoSQLException </span>&#123;</div><div class="line">   <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> SQLInsertStatement) &#123;</div><div class="line">       <span class="keyword">return</span> InsertData((SQLInsertStatement) statement);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> SQLUpdateStatement) &#123;</div><div class="line">       <span class="keyword">return</span> UpData((SQLUpdateStatement) statement);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> SQLDropTableStatement) &#123;</div><div class="line">       <span class="keyword">return</span> dropTable((SQLDropTableStatement) statement);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> SQLDeleteStatement) &#123;</div><div class="line">       <span class="keyword">return</span> DeleteDate((SQLDeleteStatement) statement);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> SQLCreateTableStatement) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">InsertData</span><span class="params">(SQLInsertStatement state)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (state.getValues().getValues().size() == <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"number of  columns error"</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (state.getValues().getValues().size() != state.getColumns().size()) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"number of values and columns have to match"</span>);</div><div class="line">   &#125;</div><div class="line">   SQLTableSource table = state.getTableSource();</div><div class="line">   BasicDBObject o = <span class="keyword">new</span> BasicDBObject();</div><div class="line">   <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (SQLExpr col : state.getColumns()) &#123;</div><div class="line">       o.put(getFieldName2(col), getExpValue(state.getValues().getValues().get(i)));</div><div class="line">       i++;</div><div class="line">   &#125;</div><div class="line">   DBCollection coll = <span class="keyword">this</span>._db.getCollection(table.toString());</div><div class="line">   coll.insert(o);</div><div class="line">   <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>5. å½©è›‹</h1>
<p>è€é“ï¼Œçœ‹åˆ°è¿™é‡Œï¼Œæ¥ä¸€æ³¢å¾®ä¿¡å…¬ä¼—å·å…³æ³¨å§ï¼Ÿï¼</p>
<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt="wechat_mp"></p>
<p><strong>1ã€æ”¯æŒå¤š MongoDB ï¼Œå¹¶ä½¿ç”¨ MyCAT è¿›è¡Œåˆ†ç‰‡ã€‚</strong></p>
<p>MyCAT é…ç½®ï¼š<a href="https://github.com/YunaiV/Mycat-Server/tree/1.6/src/test/resources/multi_mongodb" target="_blank" rel="external">multi_mongodb</a></p>
<p><strong>2ã€æ”¯æŒ MongoDB + MySQL ä½œä¸ºåŒä¸€ä¸ª MyCAT Table çš„æ•°æ®èŠ‚ç‚¹ã€‚æŸ¥è¯¢æ—¶ï¼Œå¯ä»¥åˆå¹¶æ•°æ®ç»“æœã€‚</strong></p>
<p>æŸ¥è¯¢æ—¶ï¼Œè¿”å› MySQL æ•°æ®è®°å½•å­—æ®µè¦æ¯” MongoDB æ•°æ®è®°å½•å­—æ®µå…¨ï¼Œå¦åˆ™ï¼Œåˆå¹¶ç»“æœæ—¶ä¼šæŠ¥é”™ã€‚</p>
<p>MyCAT é…ç½®ï¼š<a href="https://github.com/YunaiV/Mycat-Server/tree/1.6/src/test/resources/single_mongodb_mysql" target="_blank" rel="external">single_mongodb_mysql</a></p>
<p><strong>3ã€MongoDB ä½œä¸ºæ•°æ®èŠ‚ç‚¹æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ MyCAT æä¾›çš„æ•°æ®åº“ä¸»é”®å­—æ®µåŠŸèƒ½ã€‚</strong></p>
<p>MyCAT é…ç½®ï¼š<a href="https://github.com/YunaiV/Mycat-Server/tree/1.6/src/test/resources/single_mongodb" target="_blank" rel="external">single_mongodb</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rock
    
    </summary>
    
      <category term="MyCAT" scheme="http://www.yunai.me/categories/MyCAT/"/>
    
    
  </entry>
  
  <entry>
    <title>MyCAT æºç åˆ†æ  â€”â€” PreparedStatement é‡æ–°å…¥é—¨</title>
    <link href="http://www.yunai.me/MyCAT/what-is-PreparedStatement/"/>
    <id>http://www.yunai.me/MyCAT/what-is-PreparedStatement/</id>
    <published>2017-07-16T16:00:00.000Z</published>
    <updated>2017-07-27T16:54:49.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. JDBC Client å®ç°</a></li>
<li><a href="#">3. MyCAT Server å®ç°</a>
<ul>
<li><a href="#">3.1 åˆ›å»º PreparedStatement</a></li>
<li><a href="#">3.2 æ‰§è¡Œ SQL</a></li>
</ul>
</li>
<li><a href="#">4. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>ç›¸ä¿¡å¾ˆå¤šåŒå­¦åœ¨å­¦ä¹  JDBC æ—¶ï¼Œéƒ½ç¢°åˆ° <code>PreparedStatement</code> å’Œ <code>Statement</code>ã€‚ç©¶ç«Ÿè¯¥ä½¿ç”¨å“ªä¸ªå‘¢ï¼Ÿæœ€ç»ˆå¾ˆå¯èƒ½æ˜¯<strong>æ‡µé‡Œæ‡µæ‡‚</strong>çš„çœ‹äº†å„ç§æ€»ç»“ï¼Œä½¿ç”¨ <code>PreparedStatement</code>ã€‚é‚£ä¹ˆæœ¬æ–‡ï¼Œé€šè¿‡ MyCAT å¯¹ <code>PreparedStatement</code> çš„å®ç°å¯¹å¤§å®¶èƒ½å¤Ÿé‡æ–°ç†è§£ä¸‹ã€‚</p>
<p>æœ¬æ–‡ä¸»è¦åˆ†æˆä¸¤éƒ¨åˆ†ï¼š</p>
<ol>
<li>JDBC Client å¦‚ä½•å®ç° <code>PreparedStatement</code>ã€‚</li>
<li>MyCAT Server å¦‚ä½•å¤„ç† <code>PreparedStatement</code>ã€‚</li>
</ol>
<p>ğŸ˜ˆ Let's Goã€‚</p>
<h1>2. JDBC Client å®ç°</h1>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€æ®µå¤§å®¶æœ€å–œæ¬¢å¤åˆ¶ç²˜è´´ä¹‹ä¸€çš„ä»£ç ï¼ŒJDBC PreparedStatement æŸ¥è¯¢ MySQL æ•°æ®åº“ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PreparedStatementDemo</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException </span>&#123;</div><div class="line">        <span class="comment">// 1. è·å¾—æ•°æ®åº“è¿æ¥</span></div><div class="line">        Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</div><div class="line">        Connection conn = DriverManager.getConnection(<span class="string">"jdbc:mysql://127.0.0.1:8066/dbtest?useServerPrepStmts=true"</span>, <span class="string">"root"</span>, <span class="string">"123456"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// PreparedStatement</span></div><div class="line">        PreparedStatement ps = conn.prepareStatement(<span class="string">"SELECT id, username, password FROM t_user WHERE id = ?"</span>);</div><div class="line">        ps.setLong(<span class="number">1</span>, Math.abs(<span class="keyword">new</span> Random().nextLong()));</div><div class="line"></div><div class="line">        <span class="comment">// execute</span></div><div class="line">        ps.executeQuery();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è·å– MySQL è¿æ¥æ—¶ï¼Œ<code>useServerPrepStmts=true</code>  æ˜¯<strong>éå¸¸éå¸¸éå¸¸é‡è¦</strong>çš„å‚æ•°ã€‚å¦‚æœä¸é…ç½®ï¼Œ<code>PreparedStatement</code> å®é™…æ˜¯ä¸ª<strong>å‡</strong>çš„ <code>PreparedStatement</code>ï¼ˆæ–°ç‰ˆæœ¬é»˜è®¤ä¸º FALSEï¼Œæ®è¯´éƒ¨åˆ†è€ç‰ˆæœ¬é»˜è®¤ä¸º TRUEï¼‰ï¼Œæœªå¼€å¯æœåŠ¡ç«¯çº§åˆ«çš„ SQL é¢„ç¼–è¯‘ã€‚</p>
<p>WHY ï¼Ÿæ¥çœ‹ä¸‹ JDBC é‡Œé¢æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// com.mysql.jdbc.ConnectionImpl.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> PreparedStatement <span class="title">prepareStatement</span><span class="params">(String sql, <span class="keyword">int</span> resultSetType, <span class="keyword">int</span> resultSetConcurrency)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">synchronized</span> (getConnectionMutex()) &#123;</div><div class="line">       checkClosed();</div><div class="line">       </div><div class="line">       PreparedStatement pStmt = <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">boolean</span> canServerPrepare = <span class="keyword">true</span>;</div><div class="line">       String nativeSql = getProcessEscapeCodesForPrepStmts() ? nativeSQL(sql) : sql;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.useServerPreparedStmts &amp;&amp; getEmulateUnsupportedPstmts()) &#123;</div><div class="line">           canServerPrepare = canHandleAsServerPreparedStatement(nativeSql);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.useServerPreparedStmts &amp;&amp; canServerPrepare) &#123;</div><div class="line">           <span class="keyword">if</span> (<span class="keyword">this</span>.getCachePreparedStatements()) &#123; <span class="comment">// ä»ç¼“å­˜ä¸­è·å– pStmt</span></div><div class="line">               <span class="keyword">synchronized</span> (<span class="keyword">this</span>.serverSideStatementCache) &#123;</div><div class="line">                   pStmt = (com.mysql.jdbc.ServerPreparedStatement) <span class="keyword">this</span>.serverSideStatementCache</div><div class="line">                           .remove(makePreparedStatementCacheKey(<span class="keyword">this</span>.database, sql));</div><div class="line"></div><div class="line">                   <span class="keyword">if</span> (pStmt != <span class="keyword">null</span>) &#123;</div><div class="line">                       ((com.mysql.jdbc.ServerPreparedStatement) pStmt).setClosed(<span class="keyword">false</span>);</div><div class="line">                       pStmt.clearParameters(); <span class="comment">// æ¸…ç†ä¸Šæ¬¡ç•™ä¸‹çš„å‚æ•°</span></div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   <span class="keyword">if</span> (pStmt == <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="comment">// .... çœç•¥ä»£ç  ï¼šå‘ Server æäº¤ SQL é¢„ç¼–è¯‘ã€‚</span></div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">// å‘ Server æäº¤ SQL é¢„ç¼–è¯‘ã€‚</span></div><div class="line">                   pStmt = ServerPreparedStatement.getInstance(getMultiHostSafeProxy(), nativeSql, <span class="keyword">this</span>.database, resultSetType, resultSetConcurrency);</div><div class="line"></div><div class="line">                   pStmt.setResultSetType(resultSetType);</div><div class="line">                   pStmt.setResultSetConcurrency(resultSetConcurrency);</div><div class="line">               &#125; <span class="keyword">catch</span> (SQLException sqlEx) &#123;</div><div class="line">                   <span class="comment">// Punt, if necessary</span></div><div class="line">                   <span class="keyword">if</span> (getEmulateUnsupportedPstmts()) &#123;</div><div class="line">                       pStmt = (PreparedStatement) clientPrepareStatement(nativeSql, resultSetType, resultSetConcurrency, <span class="keyword">false</span>);</div><div class="line">                   &#125; <span class="keyword">else</span> &#123;</div><div class="line">                       <span class="keyword">throw</span> sqlEx;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           pStmt = (PreparedStatement) clientPrepareStatement(nativeSql, resultSetType, resultSetConcurrency, <span class="keyword">false</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> pStmt;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ã€å‰è€…ã€‘å½“ Client å¼€å¯ <code>useServerPreparedStmts</code> å¹¶ä¸” Server æ”¯æŒ <code>ServerPrepare</code>ï¼Œ<strong>Client ä¼šå‘ Server æäº¤ SQL é¢„ç¼–è¯‘è¯·æ±‚</strong>ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.useServerPreparedStmts &amp;&amp; canServerPrepare) &#123;</div><div class="line">    pStmt = ServerPreparedStatement.getInstance(getMultiHostSafeProxy(), nativeSql, <span class="keyword">this</span>.database, resultSetType, resultSetConcurrency);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ã€åè€…ã€‘å½“ Client æœªå¼€å¯ <code>useServerPreparedStmts</code> æˆ–è€… Server ä¸æ”¯æŒ <code>ServerPrepare</code>ï¼ŒClient åˆ›å»º <code>PreparedStatement</code>ï¼Œ<strong>_ä¸ä¼š_å‘ Server æäº¤ SQL é¢„ç¼–è¯‘è¯·æ±‚</strong>ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">pStmt = (PreparedStatement) clientPrepareStatement(nativeSql, resultSetType, resultSetConcurrency, <span class="keyword">false</span>);</div></pre></td></tr></table></figure></p>
<p><strong>å³ä½¿è¿™æ ·ï¼Œç©¶ç«Ÿä¸ºä»€ä¹ˆæ€§èƒ½ä¼šæ›´å¥½å‘¢ï¼Ÿ</strong></p>
<ul>
<li>ã€å‰è€…ã€‘è¿”å›çš„ <code>PreparedStatement</code> å¯¹è±¡ç±»æ˜¯ <code>JDBC42ServerPreparedStatement.java</code>ï¼Œåç»­æ¯æ¬¡æ‰§è¡Œ SQL åªéœ€å°†å¯¹åº”å ä½ç¬¦?å¯¹åº”çš„å€¼æäº¤ç»™ Serverå³å¯ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“å’Œ SQL è§£æå¼€é”€ã€‚</li>
<li>ã€åè€…ã€‘è¿”å›çš„ <code>PreparedStatement</code> å¯¹è±¡ç±»æ˜¯ <code>JDBC42PreparedStatement.java</code>ï¼Œåç»­æ¯æ¬¡æ‰§è¡Œ SQL éœ€è¦å°†<strong>å®Œæ•´</strong>çš„ SQL æäº¤ç»™ Serverï¼Œå¢åŠ äº†ç½‘ç»œä¼ è¾“å’Œ SQL è§£æå¼€é”€ã€‚</li>
</ul>
<p><em>ğŸŒšï¼šã€å‰è€…ã€‘æ€§èƒ½ä¸€å®šæ¯”ã€åè€…ã€‘å¥½å—ï¼Ÿç›¸ä¿¡ä½ å·²ç»æœ‰äº†æ­£ç¡®çš„ç­”æ¡ˆã€‚</em></p>
<h1>3. MyCAT Server å®ç°</h1>
<h2>3.1 åˆ›å»º PreparedStatement</h2>
<p>è¯¥æ“ä½œå¯¹åº” Client <code>conn.prepareStatement(....)</code>ã€‚</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_17/01.png" alt=""></p>
<p>MyCAT æ¥æ”¶åˆ°è¯·æ±‚åï¼Œåˆ›å»º <code>PreparedStatement</code>ï¼Œå¹¶è¿”å› <code>statementId</code> ç­‰ä¿¡æ¯ã€‚Client å‘èµ· SQL æ‰§è¡Œæ—¶ï¼Œéœ€è¦å°† <code>statementId</code> å¸¦ç»™ MyCATã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ServerPrepareHandler.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(String sql)</span> </span>&#123;</div><div class="line">LOGGER.debug(<span class="string">"use server prepare, sql: "</span> + sql);</div><div class="line"></div><div class="line">   PreparedStatement pstmt = pstmtForSql.get(sql);</div><div class="line">   <span class="keyword">if</span> (pstmt == <span class="keyword">null</span>) &#123; <span class="comment">// ç¼“å­˜ä¸­è·å–</span></div><div class="line">   	<span class="comment">// è§£æè·å–å­—æ®µä¸ªæ•°å’Œå‚æ•°ä¸ªæ•°</span></div><div class="line">   	<span class="keyword">int</span> columnCount = getColumnCount(sql);</div><div class="line">   	<span class="keyword">int</span> paramCount = getParamCount(sql);</div><div class="line">       pstmt = <span class="keyword">new</span> PreparedStatement(++pstmtId, sql, columnCount, paramCount);</div><div class="line">       pstmtForSql.put(pstmt.getStatement(), pstmt);</div><div class="line">       pstmtForId.put(pstmt.getId(), pstmt);</div><div class="line">   &#125;</div><div class="line">   PreparedStmtResponse.response(pstmt, source);</div><div class="line">&#125;</div><div class="line"><span class="comment">// PreparedStmtResponse.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">response</span><span class="params">(PreparedStatement pstmt, FrontendConnection c)</span> </span>&#123;</div><div class="line">   <span class="keyword">byte</span> packetId = <span class="number">0</span>;</div><div class="line"></div><div class="line">   <span class="comment">// write preparedOk packet</span></div><div class="line">   PreparedOkPacket preparedOk = <span class="keyword">new</span> PreparedOkPacket();</div><div class="line">   preparedOk.packetId = ++packetId;</div><div class="line">   preparedOk.statementId = pstmt.getId();</div><div class="line">   preparedOk.columnsNumber = pstmt.getColumnsNumber();</div><div class="line">   preparedOk.parametersNumber = pstmt.getParametersNumber();</div><div class="line">   ByteBuffer buffer = preparedOk.write(c.allocate(), c,<span class="keyword">true</span>);</div><div class="line"></div><div class="line">   <span class="comment">// write parameter field packet</span></div><div class="line">   <span class="keyword">int</span> parametersNumber = preparedOk.parametersNumber;</div><div class="line">   <span class="keyword">if</span> (parametersNumber &gt; <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parametersNumber; i++) &#123;</div><div class="line">           FieldPacket field = <span class="keyword">new</span> FieldPacket();</div><div class="line">           field.packetId = ++packetId;</div><div class="line">           buffer = field.write(buffer, c,<span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">       EOFPacket eof = <span class="keyword">new</span> EOFPacket();</div><div class="line">       eof.packetId = ++packetId;</div><div class="line">       buffer = eof.write(buffer, c,<span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// write column field packet</span></div><div class="line">   <span class="keyword">int</span> columnsNumber = preparedOk.columnsNumber;</div><div class="line">   <span class="keyword">if</span> (columnsNumber &gt; <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; columnsNumber; i++) &#123;</div><div class="line">           FieldPacket field = <span class="keyword">new</span> FieldPacket();</div><div class="line">           field.packetId = ++packetId;</div><div class="line">           buffer = field.write(buffer, c,<span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">       EOFPacket eof = <span class="keyword">new</span> EOFPacket();</div><div class="line">       eof.packetId = ++packetId;</div><div class="line">       buffer = eof.write(buffer, c,<span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// send buffer</span></div><div class="line">   c.write(buffer);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>æ¯ä¸ªè¿æ¥ä¹‹é—´ï¼ŒPreparedStatement ä¸å…±äº«ï¼Œå³ä¸åŒè¿æ¥ï¼Œå³ä½¿ SQLç›¸åŒï¼Œå¯¹åº”çš„ PreparedStatement ä¸åŒã€‚</strong></p>
<h2>3.2 æ‰§è¡Œ SQL</h2>
<p>è¯¥æ“ä½œå¯¹åº” Client <code>conn.execute(....)</code>ã€‚</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_17/02.png" alt=""></p>
<p>MyCAT æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå°† PreparedStatement ä½¿ç”¨è¯·æ±‚çš„å‚æ•°æ ¼å¼åŒ–æˆå¯æ‰§è¡Œçš„ SQL è¿›è¡Œæ‰§è¡Œã€‚ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">String sql = pstmt.sql.format(request.params);</div><div class="line">execute(sql);</div></pre></td></tr></table></figure></p>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ServerPrepareHandler.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</div><div class="line">   <span class="keyword">long</span> pstmtId = ByteUtil.readUB4(data, <span class="number">5</span>);</div><div class="line">   PreparedStatement pstmt = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">if</span> ((pstmt = pstmtForId.get(pstmtId)) == <span class="keyword">null</span>) &#123;</div><div class="line">       source.writeErrMessage(ErrorCode.ER_ERROR_WHEN_EXECUTING_COMMAND, <span class="string">"Unknown pstmtId when executing."</span>);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="comment">// å‚æ•°è¯»å–</span></div><div class="line">       ExecutePacket packet = <span class="keyword">new</span> ExecutePacket(pstmt);</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           packet.read(data, source.getCharset());</div><div class="line">       &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line">           source.writeErrMessage(ErrorCode.ER_ERROR_WHEN_EXECUTING_COMMAND, e.getMessage());</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">       BindValue[] bindValues = packet.values;</div><div class="line">       <span class="comment">// è¿˜åŸsqlä¸­çš„åŠ¨æ€å‚æ•°ä¸ºå®é™…å‚æ•°å€¼</span></div><div class="line">       String sql = prepareStmtBindValue(pstmt, bindValues);</div><div class="line">       <span class="comment">// æ‰§è¡Œsql</span></div><div class="line">       source.getSession2().setPrepared(<span class="keyword">true</span>);</div><div class="line">       source.query(sql);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">prepareStmtBindValue</span><span class="params">(PreparedStatement pstmt, BindValue[] bindValues)</span> </span>&#123;</div><div class="line">   String sql = pstmt.getStatement();</div><div class="line">   <span class="keyword">int</span>[] paramTypes = pstmt.getParametersType();</div><div class="line"></div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">   <span class="keyword">int</span> idx = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, len = sql.length(); i &lt; len; i++) &#123;</div><div class="line">       <span class="keyword">char</span> c = sql.charAt(i);</div><div class="line">       <span class="keyword">if</span> (c != <span class="string">'?'</span>) &#123;</div><div class="line">           sb.append(c);</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// å¤„ç†å ä½ç¬¦?</span></div><div class="line">       <span class="keyword">int</span> paramType = paramTypes[idx];</div><div class="line">       BindValue bindValue = bindValues[idx];</div><div class="line">       idx++;</div><div class="line">       <span class="comment">// å¤„ç†å­—æ®µä¸ºç©ºçš„æƒ…å†µ</span></div><div class="line">       <span class="keyword">if</span> (bindValue.isNull) &#123;</div><div class="line">           sb.append(<span class="string">"NULL"</span>);</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// éç©ºæƒ…å†µ, æ ¹æ®å­—æ®µç±»å‹è·å–å€¼</span></div><div class="line">       <span class="keyword">switch</span> (paramType &amp; <span class="number">0xff</span>) &#123;</div><div class="line">           <span class="keyword">case</span> Fields.FIELD_TYPE_TINY:</div><div class="line">               sb.append(String.valueOf(bindValue.byteBinding));</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> Fields.FIELD_TYPE_SHORT:</div><div class="line">               sb.append(String.valueOf(bindValue.shortBinding));</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> Fields.FIELD_TYPE_LONG:</div><div class="line">               sb.append(String.valueOf(bindValue.intBinding));</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="comment">// .... çœç•¥éæ ¸å¿ƒä»£ç </span></div><div class="line">        &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> sb.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>4. å½©è›‹</h1>
<p>ğŸ’¯ çœ‹åˆ°æ­¤å¤„æ˜¯ä¸æ˜¯çœŸçˆ±ï¼Ÿï¼åæ­£æˆ‘ä¿¡äº†ã€‚<br>
ç»™è€é“ä»¬é¢å¤–åŠ ä¸ªğŸ—ã€‚</p>
<p>ç»†å¿ƒçš„åŒå­¦ä»¬å¯èƒ½å·²ç»æ³¨æ„åˆ° JDBC Client æ˜¯æ”¯æŒç¼“å­˜ <code>PreparedStatement</code>ï¼Œæ— éœ€æ¯æ¬¡éƒ½è®© Server è¿›è¡Œåˆ›å»ºã€‚</p>
<p>å½“é…ç½® MySQL æ•°æ®è¿æ¥ <code>cachePrepStmts=true</code> æ—¶å¼€å¯ Client çº§åˆ«çš„ç¼“å­˜ã€‚Butï¼Œ<strong>æ­¤å¤„çš„ç¼“å­˜åˆå’Œä¸€èˆ¬çš„ç¼“å­˜ä¸ä¸€æ ·</strong>ï¼Œæ˜¯ä½¿ç”¨ <code>remove</code> çš„æ–¹å¼è·å¾—çš„ï¼Œå¹¶ä¸”åˆ›å»ºå¥½ <code>PreparedStatement</code> æ—¶ä¹Ÿä¸æ·»åŠ åˆ°ç¼“å­˜ã€‚é‚£ä»€ä¹ˆæ—¶å€™æ·»åŠ ç¼“å­˜å‘¢ï¼Ÿåœ¨ <code>pstmt.close()</code> æ—¶ï¼Œå¹¶ä¸”**<code>pstmt</code> æ˜¯é€šè¿‡ç¼“å­˜è·å–æ—¶**ï¼Œæ·»åŠ åˆ°ç¼“å­˜ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ServerPreparedStatement.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   MySQLConnection locallyScopedConn = <span class="keyword">this</span>.connection;</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (locallyScopedConn == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span>; <span class="comment">// already closed</span></div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">synchronized</span> (locallyScopedConn.getConnectionMutex()) &#123;</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.isCached &amp;&amp; isPoolable() &amp;&amp; !<span class="keyword">this</span>.isClosed) &#123;</div><div class="line">           clearParameters();</div><div class="line">           <span class="keyword">this</span>.isClosed = <span class="keyword">true</span>;</div><div class="line">           <span class="keyword">this</span>.connection.recachePreparedStatement(<span class="keyword">this</span>);</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       realClose(<span class="keyword">true</span>, <span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// ConnectionImpl.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recachePreparedStatement</span><span class="params">(ServerPreparedStatement pstmt)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">synchronized</span> (getConnectionMutex()) &#123;</div><div class="line">       <span class="keyword">if</span> (getCachePreparedStatements() &amp;&amp; pstmt.isPoolable()) &#123;</div><div class="line">           <span class="keyword">synchronized</span> (<span class="keyword">this</span>.serverSideStatementCache) &#123;</div><div class="line">               <span class="keyword">this</span>.serverSideStatementCache.put(makePreparedStatementCacheKey(pstmt.currentCatalog, pstmt.originalSql), pstmt);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå®ç°ï¼Ÿ<code>PreparedStatement</code> æ˜¯æœ‰çŠ¶æ€çš„å˜é‡ï¼Œæˆ‘ä»¬ä¼šå» <code>setXXX(pos, value)</code>ï¼Œä¸€æ—¦å¤šçº¿ç¨‹å…±äº«ï¼Œä¼šå¯¼è‡´é”™ä¹±ã€‚</p>
<p>ğŸ—¿ è¿™ä¸ªâ€œå½©è›‹â€è¿˜æ»¡æ„ä¹ˆï¼Ÿ<strong>è¯·å…³æ³¨æˆ‘çš„å…¬ä¼—å·ï¼šèŠ‹è‰¿çš„åç«¯å°å±‹</strong>ã€‚ä¸‹ä¸€ç¯‡æ›´æ–°ï¼šã€ŠMyCATæºç è§£æ â€”â€” MongoDBã€‹ï¼Œæå¤§å¯èƒ½å°±åœ¨æœ¬å‘¨å™¢ã€‚</p>
<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt="wechat_mp"></p>
<p>å¦å¤–æ¨èä¸€ç¯‡æ–‡ç« ï¼š<a href="https://www.zybuluo.com/stefanlu/note/254899" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJDBC PreparedStatementã€‹</a>ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rock
    
    </summary>
    
      <category term="MyCAT" scheme="http://www.yunai.me/categories/MyCAT/"/>
    
    
  </entry>
  
  <entry>
    <title>ä¸ºä»€ä¹ˆé˜…è¯» Sharding-JDBC æºç ï¼Ÿ</title>
    <link href="http://www.yunai.me/Sharding-JDBC/why-read-Sharding-JDBC-source-code/"/>
    <id>http://www.yunai.me/Sharding-JDBC/why-read-Sharding-JDBC-source-code/</id>
    <published>2017-07-15T16:00:00.000Z</published>
    <updated>2017-07-27T17:54:13.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h2 id="ä¸ºä»€ä¹ˆé˜…è¯»-Sharding-JDBC-æºç ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆé˜…è¯»-Sharding-JDBC-æºç ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆé˜…è¯» Sharding-JDBC æºç ï¼Ÿ"></a>ä¸ºä»€ä¹ˆé˜…è¯» Sharding-JDBC æºç ï¼Ÿ</h2><ol>
<li>çœ‹å®Œå¤§éƒ¨åˆ†çš„ MyCAT æºç ï¼Œæœ‰æƒŠå–œçš„åœ°æ–¹ï¼Œä¹Ÿæœ‰å¤±æœ›çš„åœ°æ–¹ï¼Œå› è€Œæƒ³çœ‹çœ‹ Sharding-JDBC è¿›è¡Œä¸‹å¯¹æ¯”ã€‚å°½ç®¡ï¼ŒSharding-JDBC æ˜¯ Client ç«¯çº§åˆ«ï¼ŒMyCAT æ˜¯ Server çº§åˆ«ã€‚</li>
<li>Sharding-JDBC ç»å†è¿‡å½“å½“æœ¬èº«ä¸šåŠ¡çš„è€ƒéªŒï¼Œä»å¯é æ€§ä¸Šæ¥è¯´ä¼šæ›´è®©äººæœ‰ä¿¡èµ–æ„Ÿã€‚</li>
<li>æ–‡æ¡£æ›´åŠ å®Œå–„ï¼Œå¼€å‘ä½“ç³»æ›´åŠ å¥å…¨ã€‚</li>
<li>Sharding-JDBC 1.5.0.M3 å‘å¸ƒã€‚</li>
<li><strong>æœ€å¤§åŠªåŠ›é€è¾¾å‹</strong>äº‹åŠ¡æ”¯æŒï¼Œæƒ³è¦è¿›ä¸€æ­¥äº†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆã€‚Last But Very Importmentã€‚</li>
</ol>
<h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><ul>
<li><p>FROM MyCAT</p>
<p>  <strong>ä» MyCAT é˜…è¯»è®¡åˆ’å¤åˆ¶ï¼Œç”¨äºå¯¹æ¯”ã€‚</strong></p>
</li>
<li><p>[ ] <del>NIO</del></p>
</li>
<li>[ ] <del>åˆ†å¸ƒå¼äº‹åŠ¡</del></li>
<li>[ ] <del>MyCAT ä¸»ä»</del></li>
<li>[ ] <del>æ”¯æŒprepareé¢„ç¼–è¯‘æŒ‡ä»¤</del></li>
<li>[ ] è‡ªå¢åºåˆ—</li>
<li>[ ] å•åº“ä»»æ„ Join</li>
<li>[ ] è·¨åº“2è¡¨ Join</li>
<li>[ ] <del>è·¨åº“å¤šè¡¨ Join</del></li>
<li>[ ] SQL è§£æ</li>
<li>[ ] è¯»å†™åˆ†ç¦»</li>
<li>[ ] MySQL ä¸»ä»</li>
<li>[ ] <del>è‡ªåŠ¨æ•…éšœåˆ‡æ¢</del></li>
<li>[ ] <del>Galera Cluster é›†ç¾¤</del></li>
<li>[ ] <del>MHA é›†ç¾¤</del></li>
<li>[ ] <del>Percona é›†ç¾¤</del></li>
<li>[ ] <del>æœåŠ¡é™çº§</del></li>
<li>[ ] <del>å¤šç§Ÿæˆ·</del></li>
<li>[ ] è·¯ç”±</li>
<li>[ ] <del>MyCAT é›†ç¾¤</del></li>
<li>[ ] æ³¨è§£</li>
<li>[ ] <del>ç¼“å­˜</del></li>
<li>[ ] ç›‘æ§</li>
<li>[ ] <del>Mongodb</del></li>
<li>[ ] å†…å­˜ç®¡ç†</li>
<li>[ ] æ•°æ®èšåˆ</li>
<li>[ ] æ•°æ®æ’åº</li>
<li>[ ] åˆ†è¡¨</li>
<li>[ ] åˆ†åº“</li>
<li>[ ] å…¨å±€è¡¨</li>
<li>[ ] <del>E/Rå…³ç³»</del></li>
<li>[ ] æœåŠ¡é™çº§</li>
<li>[ ] SQL æ³¨å…¥æ”»å‡»æ‹¦æˆª</li>
<li>[ ] <del>MySQL åè®®</del></li>
<li>[ ] <del>PostgreSQL åè®®</del></li>
<li><p>[ ] å­˜å‚¨è¿‡ç¨‹</p>
</li>
<li><p>FROM Sharding-JDBC</p>
<p>  <strong>ä» å®˜ç½‘ ä»‹ç»è·å–ã€‚</strong></p>
</li>
<li><p>[ ] åˆ†å¸ƒå¼äº‹åŠ¡ ï¼šæœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡</p>
</li>
<li>[ ] åˆ†å¸ƒå¼äº‹åŠ¡ ï¼šTCCå‹äº‹åŠ¡(TBD)</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/strong&gt;æœ‰ç¦åˆ©ï¼š  &lt;/p
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>MyCAT æºç åˆ†æ  â€”â€” XAåˆ†å¸ƒå¼äº‹åŠ¡</title>
    <link href="http://www.yunai.me/MyCAT/xa-distributed-transaction/"/>
    <id>http://www.yunai.me/MyCAT/xa-distributed-transaction/</id>
    <published>2017-07-14T16:00:00.000Z</published>
    <updated>2017-07-27T16:54:45.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. XA æ¦‚å¿µ</a></li>
<li><a href="#">3. MyCAT ä»£ç å®ç°</a>
<ul>
<li><a href="#">3.1 JDBC Demo ä»£ç </a></li>
<li><a href="#">3.2 MyCAT å¼€å¯ XA äº‹åŠ¡</a></li>
<li><a href="#">3.3 MyCAT æ¥æ”¶ SQL</a></li>
<li><a href="#">3.4 MySQL æ¥æ”¶ COMMIT</a>
<ul>
<li><a href="#">3.4.1 å•èŠ‚ç‚¹äº‹åŠ¡ or å¤šèŠ‚ç‚¹äº‹åŠ¡</a></li>
<li><a href="#">3.4.2 åè°ƒæ—¥å¿—</a></li>
<li><a href="#">3.4.3 MultiNodeCoordinator</a></li>
</ul>
</li>
<li><a href="#">3.5 MyCAT å¯åŠ¨å›æ»š XAäº‹åŠ¡</a></li>
</ul>
</li>
<li><a href="#">4. MyCAT å®ç°ç¼ºé™·</a>
<ul>
<li><a href="#">4.1 åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½</a></li>
<li><a href="#">4.2 æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨ PREPARE å°±è¿›è¡Œ COMMIT</a></li>
<li><a href="#">4.3 MyCAT å¯åŠ¨å›æ»š PREPARE çš„ XAäº‹åŠ¡</a></li>
<li><a href="#">4.4 å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—</a></li>
<li><a href="#">4.5 XA COMMIT éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†</a></li>
</ul>
</li>
<li><a href="#">5. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>æ•°æ®åº“æ‹†åˆ†åï¼Œä¸šåŠ¡ä¸Šä¼šç¢°åˆ°éœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡çš„åœºæ™¯ã€‚MyCAT åŸºäº XA å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚å›½å†…ç›®å‰å¦å¤–ä¸€æ¬¾å¾ˆç«çš„æ•°æ®åº“ä¸­é—´ä»¶ Sharding-JDBC å‡†å¤‡åŸºäº TCC å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚</p>
<p>æœ¬æ–‡å†…å®¹åˆ†æˆä¸‰éƒ¨åˆ†ï¼š</p>
<ol>
<li>XA æ¦‚å¿µç®€è¿°</li>
<li>MyCAT ä»£ç å¦‚ä½•å®ç° XA</li>
<li>MyCAT åœ¨å®ç° XA å­˜åœ¨çš„ä¸€äº›ç¼ºé™·</li>
</ol>
<h1>2. XA æ¦‚å¿µ</h1>
<blockquote></blockquote>
<p>X/Open ç»„ç»‡ï¼ˆå³ç°åœ¨çš„ Open Group ï¼‰å®šä¹‰äº†åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†æ¨¡å‹ã€‚ X/Open DTP æ¨¡å‹ï¼ˆ 1994 ï¼‰åŒ…æ‹¬ï¼š</p>
<ol>
<li>åº”ç”¨ç¨‹åºï¼ˆ <strong>AP</strong> ï¼‰</li>
<li>äº‹åŠ¡ç®¡ç†å™¨ï¼ˆ <strong>TM</strong> ï¼‰</li>
<li>èµ„æºç®¡ç†å™¨ï¼ˆ <strong>RM</strong> ï¼‰</li>
<li>é€šä¿¡èµ„æºç®¡ç†å™¨ï¼ˆ <strong>CRM</strong> ï¼‰<br>
ä¸€èˆ¬ï¼Œå¸¸è§çš„äº‹åŠ¡ç®¡ç†å™¨ï¼ˆ TM ï¼‰æ˜¯äº¤æ˜“ä¸­é—´ä»¶ï¼Œå¸¸è§çš„èµ„æºç®¡ç†å™¨ï¼ˆ <strong>RM</strong> ï¼‰æ˜¯æ•°æ®åº“ï¼Œå¸¸è§çš„é€šä¿¡èµ„æºç®¡ç†å™¨ï¼ˆ <strong>CRM</strong> ï¼‰æ˜¯æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œä¸‹å›¾æ˜¯X/Open DTPæ¨¡å‹ï¼š</li>
</ol>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_15/01.png" alt=""></p>
<blockquote>
<p>ä¸€èˆ¬çš„ç¼–ç¨‹æ–¹å¼æ˜¯è¿™æ ·çš„ï¼š</p>
</blockquote>
<ol>
<li>é…ç½® <strong>TM</strong> ï¼Œé€šè¿‡ <strong>TM</strong> æˆ–è€… <strong>RM</strong> æä¾›çš„æ–¹å¼ï¼ŒæŠŠ <strong>RM</strong> æ³¨å†Œåˆ° <strong>TM</strong>ã€‚å¯ä»¥ç†è§£ä¸ºç»™ <strong>TM</strong> æ³¨å†Œ <strong>RM</strong> ä½œä¸ºæ•°æ®æºã€‚ä¸€ä¸ª <strong>TM</strong> å¯ä»¥æ³¨å†Œå¤šä¸ª <strong>RM</strong>ã€‚</li>
<li><strong>AP</strong> ä» <strong>TM</strong> è·å–èµ„æºç®¡ç†å™¨çš„ä»£ç†ï¼ˆä¾‹å¦‚ï¼šä½¿ç”¨JTAæ¥å£ï¼Œä»TMç®¡ç†çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè·å–å‡ºè¿™ä¸ªTMæ‰€ç®¡ç†çš„RMçš„JDBCè¿æ¥æˆ–JMSè¿æ¥ï¼‰<br>
<strong>AP</strong> å‘ <strong>TM</strong> å‘èµ·ä¸€ä¸ªå…¨å±€äº‹åŠ¡ã€‚è¿™æ—¶ï¼Œ<strong>TM</strong> ä¼šé€šçŸ¥å„ä¸ª <strong>RM</strong>ã€‚<strong>XID</strong>ï¼ˆå…¨å±€äº‹åŠ¡IDï¼‰ä¼šé€šçŸ¥åˆ°å„ä¸ªRMã€‚</li>
<li><strong>AP</strong> é€šè¿‡ <strong>TM</strong> ä¸­è·å–çš„è¿æ¥ï¼Œ<strong>é—´æ¥</strong>æ“ä½œ <strong>RM</strong> è¿›è¡Œä¸šåŠ¡æ“ä½œã€‚è¿™æ—¶ï¼Œ<strong>TM</strong> åœ¨æ¯æ¬¡ <strong>AP</strong> æ“ä½œæ—¶æŠŠ <strong>XID</strong>(åŒ…æ‹¬æ‰€å±åˆ†æ”¯çš„ä¿¡æ¯)ä¼ é€’ç»™ <strong>RM</strong>ï¼Œ<strong>RM</strong> æ­£æ˜¯é€šè¿‡è¿™ä¸ª <strong>XID</strong> å…³è”æ¥æ“ä½œå’Œäº‹åŠ¡çš„å…³ç³»çš„ã€‚</li>
<li><strong>AP</strong> ç»“æŸå…¨å±€äº‹åŠ¡æ—¶ï¼Œ<strong>TM</strong> ä¼šé€šçŸ¥ <strong>RM</strong> å…¨å±€äº‹åŠ¡ç»“æŸã€‚å¼€å§‹äºŒæ®µæäº¤ï¼Œä¹Ÿå°±æ˜¯prepare - commitçš„è¿‡ç¨‹ã€‚</li>
</ol>
<hr>
<blockquote>
<p>XAåè®®æŒ‡çš„æ˜¯TMï¼ˆäº‹åŠ¡ç®¡ç†å™¨ï¼‰å’ŒRMï¼ˆèµ„æºç®¡ç†å™¨ï¼‰ä¹‹é—´çš„æ¥å£ã€‚ç›®å‰ä¸»æµçš„å…³ç³»å‹æ•°æ®åº“äº§å“éƒ½æ˜¯å®ç°äº†XAæ¥å£çš„ã€‚JTA(Java Transaction API)æ˜¯ç¬¦åˆX/Open DTPæ¨¡å‹çš„ï¼Œäº‹åŠ¡ç®¡ç†å™¨å’Œèµ„æºç®¡ç†å™¨ä¹‹é—´ä¹Ÿä½¿ç”¨äº†XAåè®®ã€‚ æœ¬è´¨ä¸Šä¹Ÿæ˜¯å€ŸåŠ©ä¸¤é˜¶æ®µæäº¤åè®®æ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡çš„ï¼Œä¸‹é¢åˆ†åˆ«æ¥çœ‹çœ‹XAäº‹åŠ¡æˆåŠŸå’Œå¤±è´¥çš„æ¨¡å‹å›¾ï¼š</p>
</blockquote>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_15/02.png" alt="æˆåŠŸ"></p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_15/03.png" alt="å¤±è´¥"></p>
<hr>
<p>ğŸ˜ˆ çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯æœ‰ç§é»‘äººé—®å·çš„æ„Ÿè§‰ï¼Ÿæ·¡å®šï¼æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ MyCAT ä»£ç å±‚é¢æ˜¯å¦‚ä½•å®ç° XA çš„ã€‚å¦å¤–ï¼Œæœ‰å…´è¶£å¯¹æ¦‚å¿µäº†è§£æ›´å¤šçš„ï¼Œå¯ä»¥å‚çœ‹å¦‚ä¸‹æ–‡ç« ï¼š</p>
<ol>
<li><a href="http://www.infoq.com/cn/articles/xa-transactions-handle" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠXAäº‹åŠ¡å¤„ç†ã€‹</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/xa-statements.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠXA Transaction SQL Syntaxã€‹</a></li>
<li><a href="http://www.voidcn.com/blog/gao1738/article/p-4554083.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMySQL XA äº‹åŠ¡æ”¯æŒè°ƒç ”ã€‹</a></li>
</ol>
<h1>3. MyCAT ä»£ç å®ç°</h1>
<ul>
<li>MyCAT ï¼šTMï¼Œåè°ƒè€…ã€‚</li>
<li>æ•°æ®èŠ‚ç‚¹ ï¼šRMï¼Œå‚ä¸è€…ã€‚</li>
</ul>
<h2>3.1 JDBC Demo ä»£ç </h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCATXAClientDemo</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException </span>&#123;</div><div class="line">        <span class="comment">// 1. è·å¾—æ•°æ®åº“è¿æ¥</span></div><div class="line">        Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</div><div class="line">        Connection conn = DriverManager.getConnection(<span class="string">"jdbc:mysql://127.0.0.1:8066/dbtest"</span>, <span class="string">"root"</span>, <span class="string">"123456"</span>);</div><div class="line">        conn.setAutoCommit(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 2. å¼€å¯ MyCAT XA äº‹åŠ¡</span></div><div class="line">        conn.prepareStatement(<span class="string">"set xa=on"</span>).execute();</div><div class="line"></div><div class="line">        <span class="comment">// 3. æ’å…¥ SQL</span></div><div class="line">        <span class="comment">// 3.1 SQL1 Aåº“</span></div><div class="line">        <span class="keyword">long</span> uid = Math.abs(<span class="keyword">new</span> Random().nextLong());</div><div class="line">        String username = UUID.randomUUID().toString();</div><div class="line">        String password = UUID.randomUUID().toString();</div><div class="line">        String sql1 = String.format(<span class="string">"insert into t_user(id, username, password) VALUES (%d, '%s', '%s')"</span>,</div><div class="line">                uid, username, password);</div><div class="line">        conn.prepareStatement(sql1).execute();</div><div class="line">        <span class="comment">// 3.2 SQL2 Båº“</span></div><div class="line">        <span class="keyword">long</span> orderId = Math.abs(<span class="keyword">new</span> Random().nextLong());</div><div class="line">        String nickname = UUID.randomUUID().toString();</div><div class="line">        String sql2 = String.format(<span class="string">"insert into t_order(id, uid, nickname) VALUES(%d, %s, '%s')"</span>, orderId, uid, nickname);</div><div class="line">        conn.prepareStatement(sql2).execute();</div><div class="line"></div><div class="line">        <span class="comment">// 4. æäº¤ XA äº‹åŠ¡</span></div><div class="line">        conn.commit();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>set xa=on</code> MyCAT å¼€å¯ XA äº‹åŠ¡ã€‚</li>
<li><code>conn.commit</code> æäº¤ XA äº‹åŠ¡ã€‚</li>
</ul>
<h2>3.2 MyCAT å¼€å¯ XA äº‹åŠ¡</h2>
<p>å½“ MyCAT æ¥æ”¶åˆ° <code>set xa = on</code> å‘½ä»¤æ—¶ï¼Œå¼€å¯ XA äº‹åŠ¡ï¼Œå¹¶ç”Ÿæˆ XA äº‹åŠ¡ç¼–å·ã€‚XA äº‹åŠ¡ç¼–å·ç”Ÿæˆç®—æ³•ä¸º UUIDã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SetHandler.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String stmt, ServerConnection c, <span class="keyword">int</span> offset)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> rs = ServerParseSet.parse(stmt, offset);</div><div class="line">		<span class="keyword">switch</span> (rs &amp; <span class="number">0xff</span>) &#123;</div><div class="line">		<span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line">		<span class="keyword">case</span> XA_FLAG_ON: &#123;</div><div class="line">			<span class="keyword">if</span> (c.isAutocommit()) &#123;</div><div class="line">				c.writeErrMessage(ErrorCode.ERR_WRONG_USED, <span class="string">"set xa cmd on can't used in autocommit connection "</span>);</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			c.getSession2().setXATXEnabled(<span class="keyword">true</span>);</div><div class="line">			c.write(c.writeToBuffer(OkPacket.OK, c.allocate()));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">case</span> XA_FLAG_OFF: &#123;</div><div class="line">			c.writeErrMessage(ErrorCode.ERR_WRONG_USED,</div><div class="line">					<span class="string">"set xa cmd off not for external use "</span>);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// NonBlockingSession.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setXATXEnabled</span><span class="params">(<span class="keyword">boolean</span> xaTXEnabled)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (xaTXEnabled) &#123;</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.xaTXID == <span class="keyword">null</span>) &#123;</div><div class="line">           xaTXID = genXATXID(); <span class="comment">// ğŸ˜ˆğŸ˜ˆğŸ˜ˆè·å¾— XA äº‹åŠ¡ç¼–å·</span></div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">this</span>.xaTXID = <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">genXATXID</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> MycatServer.getInstance().getXATXIDGLOBAL();</div><div class="line">&#125;</div><div class="line"><span class="comment">// MycatServer.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getXATXIDGLOBAL</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="string">"'"</span> + getUUID() + <span class="string">"'"</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUUID</span><span class="params">()</span> </span>&#123; <span class="comment">// ğŸ˜ˆğŸ˜ˆğŸ˜ˆ</span></div><div class="line">   String s = UUID.randomUUID().toString();</div><div class="line">   <span class="keyword">return</span> s.substring(<span class="number">0</span>, <span class="number">8</span>) + s.substring(<span class="number">9</span>, <span class="number">13</span>) + s.substring(<span class="number">14</span>, <span class="number">18</span>) + s.substring(<span class="number">19</span>, <span class="number">23</span>) + s.substring(<span class="number">24</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.3 MyCAT æ¥æ”¶ SQL</h2>
<p>æ­¤å¤„ SQL æŒ‡çš„æ˜¯ <code>insert</code>ã€<code>update</code>ã€<code>delete</code> æ“ä½œã€‚</p>
<p>å½“å‘æŸä¸ªæ•°æ®èŠ‚ç‚¹<strong>ç¬¬ä¸€æ¬¡</strong>å‘èµ· SQL æ—¶ï¼Œä¼šåœ¨ SQL å‰é¢é™„åŠ  <code>XA START 'xaTranId'</code>ï¼Œå¹¶è®¾ç½®è¯¥æ•°æ®èŠ‚ç‚¹<strong>è¿æ¥</strong>äº‹åŠ¡çŠ¶æ€ä¸º <code>TxState.TX_STARTED_STATE</code>ï¼ˆ<em>åˆ†å¸ƒå¼äº‹åŠ¡çŠ¶æ€ï¼Œä¸‹æ–‡ä¼šä¸“é—¨æ•´ç†</em>ï¼‰ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MySQLConnection.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">synAndDoExecute</span><span class="params">(String xaTxID, RouteResultsetNode rrn,</span></span></div><div class="line">                                 <span class="keyword">int</span> clientCharSetIndex, <span class="keyword">int</span> clientTxIsoLation,</div><div class="line">                                 <span class="keyword">boolean</span> clientAutoCommit) &#123;</div><div class="line">   String xaCmd = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">boolean</span> conAutoComit = <span class="keyword">this</span>.autocommit;</div><div class="line">   String conSchema = <span class="keyword">this</span>.schema;</div><div class="line">   <span class="comment">// never executed modify sql,so auto commit</span></div><div class="line">   <span class="keyword">boolean</span> expectAutocommit = !modifiedSQLExecuted || isFromSlaveDB() || clientAutoCommit;</div><div class="line">   <span class="keyword">if</span> (expectAutocommit == <span class="keyword">false</span> &amp;&amp; xaTxID != <span class="keyword">null</span> &amp;&amp; xaStatus == TxState.TX_INITIALIZE_STATE) &#123; <span class="comment">// ğŸ˜ˆğŸ˜ˆğŸ˜ˆ</span></div><div class="line">       xaCmd = <span class="string">"XA START "</span> + xaTxID + <span class="string">';'</span>;</div><div class="line">       <span class="keyword">this</span>.xaStatus = TxState.TX_STARTED_STATE;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">   <span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line">   <span class="keyword">if</span> (xaCmd != <span class="keyword">null</span>) &#123;</div><div class="line">       sb.append(xaCmd);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// and our query sql to multi command at last</span></div><div class="line">   sb.append(rrn.getStatement() + <span class="string">";"</span>);</div><div class="line">   <span class="comment">// syn and execute others</span></div><div class="line">   <span class="keyword">this</span>.sendQueryCmd(sb.toString());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸¾ä¸ª å˜é‡<code>sb</code> çš„ä¾‹å­ï¼š</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SET</span> <span class="keyword">names</span> utf8;<span class="keyword">SET</span> autocommit=<span class="number">0</span>;XA <span class="keyword">START</span> <span class="string">'1f2da7353e8846e5833b8d8dd041cfb1'</span>,<span class="string">'db2'</span>;<span class="keyword">insert</span> <span class="keyword">into</span> t_user(<span class="keyword">id</span>, username, <span class="keyword">password</span>) <span class="keyword">VALUES</span> (<span class="number">3400</span>, <span class="string">'b7c5ec1f-11cc-4599-851c-06ad617fec42'</span>, <span class="string">'d2694679-f6a2-4623-a339-48d4a868be90'</span>);</div></pre></td></tr></table></figure></p>
<h2>3.4 MySQL æ¥æ”¶ COMMIT</h2>
<h3>3.4.1 å•èŠ‚ç‚¹äº‹åŠ¡ or å¤šèŠ‚ç‚¹äº‹åŠ¡</h3>
<p><code>COMMIT</code> æ‰§è¡Œæ—¶ï¼ŒMyCAT ä¼šåˆ¤æ–­ XA äº‹åŠ¡é‡Œï¼Œæ¶‰åŠåˆ°çš„æ•°æ®åº“èŠ‚ç‚¹æ•°é‡ã€‚</p>
<ul>
<li>å¦‚æœèŠ‚ç‚¹æ•°é‡ä¸º 1ï¼Œå•èŠ‚ç‚¹äº‹åŠ¡ï¼Œä½¿ç”¨ <code>CommitNodeHandler</code> å¤„ç†ã€‚</li>
<li>å¦‚æœèŠ‚ç‚¹æ•°é‡ &gt; 1ï¼Œå¤šèŠ‚ç‚¹äº‹åŠ¡ï¼Œä½¿ç”¨ <code>MultiNodeCoordinator</code> å¤„ç†ã€‚</li>
</ul>
<p><code>CommitNodeHandler</code> ç›¸æ¯” <code>MultiNodeCoordinator</code> æ¥è¯´ï¼Œåªæœ‰ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ï¼Œä¸éœ€è¦è¿›è¡Œå¤šèŠ‚ç‚¹åè°ƒï¼Œé€»è¾‘ä¼šç›¸å¯¹ç®€å•ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å¦å¤–çœ‹ã€‚æˆ‘ä»¬ä¸»è¦åˆ†æ <code>MultiNodeCoordinator</code>ã€‚</p>
<h3>3.4.2 åè°ƒæ—¥å¿—</h3>
<p><strong>åè°ƒæ—¥å¿—</strong>ï¼Œè®°å½•åè°ƒè¿‡ç¨‹ä¸­å„æ•°æ®èŠ‚ç‚¹ XA äº‹åŠ¡çŠ¶æ€ï¼Œå¤„ç†<strong>MyCATå¼‚å¸¸å¥”æºƒ</strong>æˆ–è€…<strong>æ•°æ®èŠ‚ç‚¹éƒ¨åˆ†XA COMMITï¼Œå¦å¤–éƒ¨åˆ† XA PREPARE</strong>ä¸‹çš„çŠ¶æ€æ¢å¤ã€‚</p>
<p><strong>XA äº‹åŠ¡å…±æœ‰ç§</strong>ï¼š</p>
<ol>
<li>TX_INITIALIZE_STATE ï¼šäº‹åŠ¡åˆå§‹åŒ–</li>
<li>TX_STARTED_STATE ï¼šäº‹åŠ¡å¼€å§‹å®Œæˆ</li>
<li>TX_PREPARED_STATE ï¼šäº‹åŠ¡å‡†å¤‡å®Œæˆ</li>
<li>TX_COMMITED_STATE ï¼šäº‹åŠ¡æäº¤å®Œæˆ</li>
<li>TX_ROLLBACKED_STATE ï¼šäº‹åŠ¡å›æ»šå®Œæˆ</li>
</ol>
<p><strong>çŠ¶æ€å˜æ›´æµ</strong> ï¼šTX_INITIALIZE_STATE =&gt; TX_STARTED_STATE =&gt; TX_PREPARED_STATE =&gt; TX_COMMITED_STATE / TX_ROLLBACKED_STATE ã€‚</p>
<p><strong>åè°ƒæ—¥å¿—åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†</strong>ï¼š</p>
<ol>
<li>CoordinatorLogEntry ï¼šåè°ƒè€…æ—¥å¿—</li>
<li>ParticipantLogEntry ï¼šå‚ä¸è€…æ—¥å¿—ã€‚<strong>æ­¤å¤„ï¼Œæ•°æ®èŠ‚ç‚¹æ‰®æ¼”å‚ä¸è€…çš„è§’è‰²ã€‚ä¸‹æ–‡ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°å‚ä¸è€…ä¸æ•°æ®èŠ‚ç‚¹æ··ç”¨çš„æƒ…å†µï¼Œæœ›è§è°…ã€‚</strong></li>
</ol>
<p><em>ä¸€æ¬¡ XA äº‹åŠ¡ï¼Œå¯¹åº”ä¸€æ¡ <code>CoordinatorLogEntry</code>ã€‚ä¸€æ¡<code>CoordinatorLogEntry</code> åŒ…å« Næ¡<code>ParticipantLogEntry</code></em>ã€‚ æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CoordinatorLogEntry ï¼šåè°ƒè€…æ—¥å¿—</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CoordinatorLogEntry</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * XA äº‹åŠ¡ç¼–å·</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String id;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å‚ä¸è€…æ—¥å¿—æ•°ç»„</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ParticipantLogEntry[] participants;</div><div class="line">&#125;</div><div class="line"><span class="comment">// ParticipantLogEntry ï¼šå‚ä¸è€…æ—¥å¿—</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParticipantLogEntry</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * XA äº‹åŠ¡ç¼–å·</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> String coordinatorId;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•°æ®åº“ uri</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> String uri;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¿‡æœŸæè¿°</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">long</span> expires;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * XA äº‹åŠ¡çŠ¶æ€</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> txState;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å‚ä¸è€…åå­—</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> String resourceName;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>MyCAT è®°å½•åè°ƒæ—¥å¿—ä»¥ JSONæ ¼å¼ åˆ°æ–‡ä»¶</strong>ã€‚<strong>æ¯è¡Œ</strong>åŒ…å«ä¸€æ¡<code>CoordinatorLogEntry</code>ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p>
<p><figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;<span class="attr">"id"</span>:<span class="string">"'e827b3fe666c4d968961350d19adda31'"</span>,<span class="attr">"participants"</span>:[&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db3"</span>&#125;,&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db1"</span>&#125;]&#125;</div><div class="line">&#123;<span class="attr">"id"</span>:<span class="string">"'f00b61fa17cb4ec5b8264a6d82f847d0'"</span>,<span class="attr">"participants"</span>:[&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db2"</span>&#125;,&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db1"</span>&#125;]&#125;</div></pre></td></tr></table></figure></p>
<p>å®ç°ç±»ä¸ºï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// XA åè°ƒè€…æ—¥å¿— å­˜å‚¨æ¥å£ï¼šhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/Repository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Repository</span> </span>&#123;&#125;</div><div class="line"><span class="comment">// XA åè°ƒè€…æ—¥å¿— æ–‡ä»¶å­˜å‚¨ï¼šhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/impl/FileSystemRepository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileSystemRepository</span> <span class="keyword">implements</span> <span class="title">Repository</span> </span>&#123;&#125;</div><div class="line"><span class="comment">// XA åè°ƒè€…æ—¥å¿— æ–‡ä»¶å­˜å‚¨ï¼šhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/impl/InMemoryRepository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InMemoryRepository</span> <span class="keyword">implements</span> <span class="title">Repository</span> </span>&#123;&#125;</div></pre></td></tr></table></figure></p>
<p>ç›®å‰æ—¥å¿—æ–‡ä»¶å†™å…¥çš„æ–¹å¼æ€§èƒ½è¾ƒå·®ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸åšåˆ†æï¼Œåœ¨ã€4. MyCAT å®ç°ç¼ºé™·ã€‘é‡Œä¸€èµ·è®²ã€‚</p>
<h3>3.4.3 MultiNodeCoordinator</h3>
<p>æ•²æ•²æ•²ï¼Œè¿™é‡Œæ˜¯æœ¬æ–‡çš„é‡ç‚¹ä¹‹ä¸€å™¢ã€‚ğŸ˜ˆ</p>
<p><strong>ç¬¬ä¸€é˜¶æ®µï¼šå‘èµ· PREPAREã€‚</strong></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeBatchNodeCmd</span><span class="params">(SQLCtrlCommand cmdHandler)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.cmdHandler = cmdHandler;</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> initCount = session.getTargetCount();</div><div class="line">   runningCount.set(initCount);</div><div class="line">   nodeCount = initCount;</div><div class="line">   failed.set(<span class="keyword">false</span>);</div><div class="line">   faileCount.set(<span class="number">0</span>);</div><div class="line">   <span class="comment">//recovery nodes log</span></div><div class="line">   ParticipantLogEntry[] participantLogEntry = <span class="keyword">new</span> ParticipantLogEntry[initCount];</div><div class="line">   <span class="comment">// æ‰§è¡Œ</span></div><div class="line">   <span class="keyword">int</span> started = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (RouteResultsetNode rrn : session.getTargetKeys()) &#123;</div><div class="line">       <span class="keyword">if</span> (rrn == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">final</span> BackendConnection conn = session.getTarget(rrn);</div><div class="line">       <span class="keyword">if</span> (conn != <span class="keyword">null</span>) &#123;</div><div class="line">           conn.setResponseHandler(<span class="keyword">this</span>);</div><div class="line">           <span class="comment">//process the XA_END XA_PREPARE Command</span></div><div class="line">           MySQLConnection mysqlCon = (MySQLConnection) conn;</div><div class="line">           String xaTxId = <span class="keyword">null</span>;</div><div class="line">           <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) &#123;</div><div class="line">               xaTxId = session.getXaTXID() + <span class="string">",'"</span> + mysqlCon.getSchema() + <span class="string">"'"</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (mysqlCon.getXaStatus() == TxState.TX_STARTED_STATE) &#123; <span class="comment">// XA äº‹åŠ¡</span></div><div class="line">               <span class="comment">//recovery Log</span></div><div class="line">               participantLogEntry[started] = <span class="keyword">new</span> ParticipantLogEntry(xaTxId, conn.getHost(), <span class="number">0</span>, conn.getSchema(), ((MySQLConnection) conn).getXaStatus());</div><div class="line">               String[] cmds = <span class="keyword">new</span> String[]&#123;<span class="string">"XA END "</span> + xaTxId, <span class="comment">// XA END å‘½ä»¤</span></div><div class="line">                       <span class="string">"XA PREPARE "</span> + xaTxId&#125;; <span class="comment">// XA PREPARE å‘½ä»¤</span></div><div class="line">               mysqlCon.execBatchCmd(cmds);</div><div class="line">           &#125; <span class="keyword">else</span> &#123; <span class="comment">// é XA äº‹åŠ¡</span></div><div class="line">               <span class="comment">// recovery Log</span></div><div class="line">               participantLogEntry[started] = <span class="keyword">new</span> ParticipantLogEntry(xaTxId, conn.getHost(), <span class="number">0</span>, conn.getSchema(), ((MySQLConnection) conn).getXaStatus());</div><div class="line">               cmdHandler.sendCommand(session, conn);</div><div class="line">           &#125;</div><div class="line">           ++started;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// xa recovery log</span></div><div class="line">   <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) &#123;</div><div class="line">       CoordinatorLogEntry coordinatorLogEntry = <span class="keyword">new</span> CoordinatorLogEntry(session.getXaTXID(), <span class="keyword">false</span>, participantLogEntry);</div><div class="line">       inMemoryRepository.put(session.getXaTXID(), coordinatorLogEntry);</div><div class="line">       fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (started &lt; nodeCount) &#123; <span class="comment">// TODO ç–‘é—®ï¼šå¦‚ä½•è§¦å‘</span></div><div class="line">       runningCount.set(started);</div><div class="line">       LOGGER.warn(<span class="string">"some connection failed to execute "</span> + (nodeCount - started));</div><div class="line">       <span class="comment">/**</span></div><div class="line">        * assumption: only caused by front-end connection close. &lt;br/&gt;</div><div class="line">        * Otherwise, packet must be returned to front-end</div><div class="line">        */</div><div class="line">       failed.set(<span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å‘å„æ•°æ®èŠ‚ç‚¹å‘é€ <code>XA END</code> + <code>XA PREPARE</code> æŒ‡ä»¤ã€‚ä¸¾ä¸ª å˜é‡<code>cmds</code> ä¾‹å­ï¼š</li>
</ul>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">XA <span class="keyword">END</span> <span class="string">'4cbb18214d0b47adbdb0658598666677'</span>,<span class="string">'db3'</span>;XA <span class="keyword">PREPARE</span> <span class="string">'4cbb18214d0b47adbdb0658598666677'</span>,<span class="string">'db3'</span>;</div></pre></td></tr></table></figure></p>
<ul>
<li>è®°å½•åè°ƒæ—¥å¿—ã€‚æ¯æ¡å‚ä¸è€…æ—¥å¿—çŠ¶æ€ä¸º <code>TxState.TX_STARTED_STATE</code>ã€‚</li>
</ul>
<hr>
<p><strong>ç¬¬äºŒé˜¶æ®µï¼šå‘èµ· COMMITã€‚</strong></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">okResponse</span><span class="params">(<span class="keyword">byte</span>[] ok, BackendConnection conn)</span> </span>&#123;</div><div class="line">   <span class="comment">// process the XA Transatcion 2pc commit</span></div><div class="line">   <span class="keyword">if</span> (conn <span class="keyword">instanceof</span> MySQLConnection) &#123;</div><div class="line">       MySQLConnection mysqlCon = (MySQLConnection) conn;</div><div class="line">       <span class="keyword">switch</span> (mysqlCon.getXaStatus()) &#123;</div><div class="line">           <span class="keyword">case</span> TxState.TX_STARTED_STATE:</div><div class="line">               <span class="comment">//if there have many SQL execute wait the okResponse,will come to here one by one</span></div><div class="line">               <span class="comment">//should be wait all nodes ready ,then send xa commit to all nodes.</span></div><div class="line">               <span class="keyword">if</span> (mysqlCon.batchCmdFinished()) &#123;</div><div class="line">                   String xaTxId = session.getXaTXID();</div><div class="line">                   String cmd = <span class="string">"XA COMMIT "</span> + xaTxId + <span class="string">",'"</span> + mysqlCon.getSchema() + <span class="string">"'"</span>;</div><div class="line">                   <span class="keyword">if</span> (LOGGER.isDebugEnabled()) &#123;</div><div class="line">                       LOGGER.debug(<span class="string">"Start execute the cmd :"</span> + cmd + <span class="string">",current host:"</span> + mysqlCon.getHost() + <span class="string">":"</span> + mysqlCon.getPort());</div><div class="line">                   &#125;</div><div class="line">                   <span class="comment">// recovery log</span></div><div class="line">                   CoordinatorLogEntry coordinatorLogEntry = inMemoryRepository.get(xaTxId);</div><div class="line">                   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntry.participants.length; i++) &#123;</div><div class="line">                       LOGGER.debug(<span class="string">"[In Memory CoordinatorLogEntry]"</span> + coordinatorLogEntry.participants[i]);</div><div class="line">                       <span class="keyword">if</span> (coordinatorLogEntry.participants[i].resourceName.equals(conn.getSchema())) &#123;</div><div class="line">                           coordinatorLogEntry.participants[i].txState = TxState.TX_PREPARED_STATE;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">                   inMemoryRepository.put(xaTxId, coordinatorLogEntry);</div><div class="line">                   fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">                   <span class="comment">// send commit</span></div><div class="line">                   mysqlCon.setXaStatus(TxState.TX_PREPARED_STATE);</div><div class="line">                   mysqlCon.execCmd(cmd);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           <span class="keyword">case</span> TxState.TX_PREPARED_STATE: &#123;</div><div class="line">               <span class="comment">// recovery log</span></div><div class="line">               String xaTxId = session.getXaTXID();</div><div class="line">               CoordinatorLogEntry coordinatorLogEntry = inMemoryRepository.get(xaTxId);</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntry.participants.length; i++) &#123;</div><div class="line">                   <span class="keyword">if</span> (coordinatorLogEntry.participants[i].resourceName.equals(conn.getSchema())) &#123;</div><div class="line">                       coordinatorLogEntry.participants[i].txState = TxState.TX_COMMITED_STATE;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">               inMemoryRepository.put(xaTxId, coordinatorLogEntry);</div><div class="line">               fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">               <span class="comment">// XA reset status now</span></div><div class="line">               mysqlCon.setXaStatus(TxState.TX_INITIALIZE_STATE);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">default</span>:</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// é‡Šæ”¾è¿æ¥</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.cmdHandler.relaseConOnOK()) &#123;</div><div class="line">       session.releaseConnection(conn);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       session.releaseConnectionIfSafe(conn, LOGGER.isDebugEnabled(), <span class="keyword">false</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ˜¯å¦æ‰€æœ‰èŠ‚ç‚¹éƒ½å®Œæˆcommitï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å›Client æˆåŠŸ</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.finished()) &#123;</div><div class="line">       cmdHandler.okResponse(session, ok);</div><div class="line">       <span class="keyword">if</span> (cmdHandler.isAutoClearSessionCons()) &#123;</div><div class="line">           session.clearResources(<span class="keyword">false</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">/* 1.  äº‹åŠ¡æäº¤å,xa äº‹åŠ¡ç»“æŸ   */</span></div><div class="line">       <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) &#123;</div><div class="line">           session.setXATXEnabled(<span class="keyword">false</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">/* 2. preAcStates ä¸ºtrue,äº‹åŠ¡ç»“æŸå,éœ€è¦è®¾ç½®ä¸ºtrueã€‚preAcStates ä¸ºacä¸Šä¸€ä¸ªçŠ¶æ€    */</span></div><div class="line">       <span class="keyword">if</span> (session.getSource().isPreAcStates()) &#123;</div><div class="line">           session.getSource().setAutocommit(<span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>mysqlCon.batchCmdFinished()</code> æ¯ä¸ªæ•°æ®èŠ‚ç‚¹ï¼Œç¬¬ä¸€æ¬¡è¿”å›çš„æ˜¯ <code>XA END</code> æˆåŠŸï¼Œç¬¬äºŒæ¬¡è¿”å›çš„æ˜¯ <code>XA PREPARE</code>ã€‚åœ¨ <code>XA PREPARE</code> æˆåŠŸåï¼Œè®°å½•è¯¥æ•°æ®èŠ‚ç‚¹çš„<strong>å‚ä¸è€…æ—¥å¿—</strong>çŠ¶æ€ä¸º <code>TxState.TX_PREPARED_STATE</code>ã€‚ä¹‹åï¼Œå‘è¯¥æ•°æ®èŠ‚ç‚¹å‘èµ· <code>XA COMMIT</code> å‘½ä»¤ã€‚</li>
<li><code>XA COMMIT</code> è¿”å›æˆåŠŸåï¼Œè®°å½•è¯¥æ•°æ®èŠ‚ç‚¹çš„<strong>äº‹åŠ¡å‚ä¸è€…æ—¥å¿—</strong>çŠ¶æ€ä¸º <code>TxState.TX_COMMITED_STATE</code>ã€‚</li>
<li>å½“æ‰€æœ‰æ•°æ®èŠ‚ç‚¹ï¼ˆå‚ä¸è€…ï¼‰éƒ½æ‰§è¡Œå®Œæˆ <code>XA COMMIT</code> è¿”å›ï¼Œå³ <code>this.finished() == true</code>ï¼Œè¿”å› MySQL Client XA äº‹åŠ¡æäº¤æˆåŠŸã€‚</li>
</ul>
<p>[x] <code>XA PREPARE</code> å’Œ <code>XA COMMIT</code>ï¼Œæ•°æ®èŠ‚ç‚¹å¯èƒ½è¿”å›å¤±è´¥ï¼Œç›®å‰æš‚æ—¶æ²¡æ¨¡æ‹Ÿå‡ºæ¥ï¼Œå¯¹åº”æ–¹æ³•ä¸º <code>#errorResponse(....)</code>ã€‚</p>
<h2>3.5 MyCAT å¯åŠ¨å›æ»š XAäº‹åŠ¡</h2>
<p>MyCAT å¯åŠ¨æ—¶ï¼Œä¼š<strong>å›æ»šå¤„äºTxState.TX_PREPARED_STATE</strong>çš„ <code>ParticipantLogEntry</code> å¯¹åº”çš„æ•°æ®èŠ‚ç‚¹çš„ XA äº‹åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MycatServer.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performXARecoveryLog</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// fetch the recovery log</span></div><div class="line">   CoordinatorLogEntry[] coordinatorLogEntries = getCoordinatorLogEntries();</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntries.length; i++) &#123;</div><div class="line">       CoordinatorLogEntry coordinatorLogEntry = coordinatorLogEntries[i];</div><div class="line">       <span class="keyword">boolean</span> needRollback = <span class="keyword">false</span>;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; coordinatorLogEntry.participants.length; j++) &#123;</div><div class="line">           ParticipantLogEntry participantLogEntry = coordinatorLogEntry.participants[j];</div><div class="line">           <span class="keyword">if</span> (participantLogEntry.txState == TxState.TX_PREPARED_STATE) &#123;</div><div class="line">               needRollback = <span class="keyword">true</span>;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (needRollback) &#123;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; coordinatorLogEntry.participants.length; j++) &#123;</div><div class="line">               ParticipantLogEntry participantLogEntry = coordinatorLogEntry.participants[j];</div><div class="line">               <span class="comment">//XA rollback</span></div><div class="line">               String xacmd = <span class="string">"XA ROLLBACK "</span> + coordinatorLogEntry.id + <span class="string">';'</span>;</div><div class="line">               OneRawSQLQueryResultHandler resultHandler = <span class="keyword">new</span> OneRawSQLQueryResultHandler(<span class="keyword">new</span> String[<span class="number">0</span>], <span class="keyword">new</span> XARollbackCallback());</div><div class="line">               outloop:</div><div class="line">               <span class="keyword">for</span> (SchemaConfig schema : MycatServer.getInstance().getConfig().getSchemas().values()) &#123;</div><div class="line">                   <span class="keyword">for</span> (TableConfig table : schema.getTables().values()) &#123;</div><div class="line">                       <span class="keyword">for</span> (String dataNode : table.getDataNodes()) &#123;</div><div class="line">                           PhysicalDBNode dn = MycatServer.getInstance().getConfig().getDataNodes().get(dataNode);</div><div class="line">                           <span class="keyword">if</span> (dn.getDbPool().getSource().getConfig().getIp().equals(participantLogEntry.uri)</div><div class="line">                                   &amp;&amp; dn.getDatabase().equals(participantLogEntry.resourceName)) &#123;</div><div class="line">                               <span class="comment">//XA STATE ROLLBACK</span></div><div class="line">                               participantLogEntry.txState = TxState.TX_ROLLBACKED_STATE;</div><div class="line">                               SQLJob sqlJob = <span class="keyword">new</span> SQLJob(xacmd, dn.getDatabase(), resultHandler, dn.getDbPool().getSource());</div><div class="line">                               sqlJob.run();</div><div class="line">                               <span class="keyword">break</span> outloop;</div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// init into in memory cached</span></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntries.length; i++) &#123;</div><div class="line">  MultiNodeCoordinator.inMemoryRepository.put(coordinatorLogEntries[i].id, coordinatorLogEntries[i]);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// discard the recovery log</span></div><div class="line">    MultiNodeCoordinator.fileRepository.writeCheckpoint(MultiNodeCoordinator.inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>4. MyCAT å®ç°ç¼ºé™·</h1>
<p>MyCAT 1.6.5 ç‰ˆæœ¬å®ç°å¼±XAäº‹åŠ¡ï¼Œç›¸å¯¹æ¥è¯´ï¼Œç¬”è€…è®¤ä¸ºè·ç¦»å®é™…ç”Ÿäº§ä½¿ç”¨å­˜åœ¨ä¸€äº›å·®è·ã€‚ä¸‹é¢ç½—åˆ—å¯èƒ½å­˜åœ¨çš„ç¼ºé™·ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œéº»çƒ¦æŒ‡å‡ºã€‚ğŸ™‚å¸Œæœ› MyCAT åœ¨åˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°ä¸Šï¼Œèƒ½å¤Ÿè¶Šæ¥è¶Šç»™åŠ›ã€‚</p>
<h2>4.1 åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½</h2>
<p>1ã€<code>CoordinatorLogEntry</code>ã€<code>ParticipantLogEntry</code> åœ¨æ¯æ¬¡å†™å…¥æ–‡ä»¶æ—¶ï¼Œæ˜¯å°†å†…å­˜ä¸­æ‰€æœ‰çš„æ—¥å¿—<strong>å…¨éƒ¨é‡æ–°</strong>å†™å…¥ï¼Œå¯¼è‡´å†™å…¥æ€§èƒ½éšç€ XA äº‹åŠ¡æ¬¡æ•°çš„å¢åŠ ï¼Œæ€§èƒ½ä¼šè¶Šæ¥è¶Šç³Ÿç³•ï¼Œå¯¼è‡´ XA äº‹åŠ¡æ•´ä½“æ€§èƒ½ä¼šéå¸¸å·®ã€‚å¦å¤–ï¼Œè¯¥æ–¹æ³•æ˜¯<strong>åŒæ­¥</strong>çš„ï¼Œä¹ŸåŠ å¤§äº†å†™å…¥çš„å»¶è¿Ÿã€‚</p>
<p>å»ºè®®ï¼šå…ˆè·å¾—å¯å†™å…¥æ–‡ä»¶çš„ OFFSETï¼Œå†™å…¥åè°ƒæ—¥å¿—åˆ°æ–‡ä»¶ï¼Œå†…å­˜ç»´æŠ¤å¥½ XAäº‹åŠ¡ç¼–å· ä¸ OFFSET çš„æ˜ å°„å…³ç³»ï¼Œä»è€Œå®ç°<strong>é¡ºåºå†™å…¥</strong> + <strong>å¹¶è¡Œå†™å…¥</strong>ã€‚</p>
<p>2ã€å†…å­˜é‡Œç»´æŠ¤äº†æ‰€æœ‰çš„åè°ƒæ—¥å¿—ï¼Œå ç”¨å†…å­˜ä¼šè¶Šæ¥è¶Šå¤§ï¼Œå¹¶ä¸”æ— é‡Šæ”¾æœºåˆ¶ã€‚å³ä½¿é‡å¯ï¼Œåè°ƒæ—¥å¿—ä¹Ÿä¼šé‡æ–°åŠ è½½åˆ°å†…å­˜ã€‚</p>
<p>å»ºè®®ï¼šå·²å®Œå…¨å›æ»šæˆ–è€…æäº¤çš„åè°ƒæ—¥å¿—ä¸æ”¾å…¥å†…å­˜ã€‚å¦å¤–æœ‰æ–‡ä»¶å­˜å‚¨å¥½ XAäº‹åŠ¡ç¼–å· ä¸ OFFSET çš„æ˜ å°„å…³ç³»ã€‚</p>
<p>3ã€åè°ƒæ—¥å¿—åªå†™å…¥å•ä¸ªæ–‡ä»¶ã€‚</p>
<p>å»ºè®®ï¼šåˆ†æ‹†åè°ƒæ—¥å¿—æ–‡ä»¶ã€‚</p>
<p>PSï¼šæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹ <code>RocketMQ</code> å¯¹ <code>CommitLog</code> çš„å­˜å‚¨ï¼Œæ€§èƒ½ä¸Šå¾ˆèµï¼</p>
<h2>4.2 æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨ PREPARE å°±è¿›è¡Œ COMMIT</h2>
<p>XA äº‹åŠ¡å®šä¹‰ï¼Œéœ€è¦ç­‰å¾…æ‰€æœ‰å‚ä¸è€…<strong>å…¨éƒ¨</strong> <code>XA PREPARE</code> æˆåŠŸå®Œæˆåå‘èµ· <code>XA COMMIT</code>ã€‚ç›®å‰ MyCAT æ˜¯æŸä¸ªæ•°æ®èŠ‚ç‚¹ <code>XA PREPARE</code> å®Œæˆå<strong>ç«‹å³</strong>è¿›è¡Œ <code>XA COMMIT</code>ã€‚æ¯”å¦‚è¯´ï¼šç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹æäº¤äº† <code>XA END;XA PREPARE</code> æ—¶ï¼Œç¬¬äºŒä¸ªæ•°æ®èŠ‚åœ¨è¿›è¡Œ <code>XA END;XA PREAPRE;</code> å‰æŒ‚äº†ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¾ç„¶ä¼š <code>XA COMMIT</code> æˆåŠŸã€‚</p>
<p>å»ºè®®ï¼šæŒ‰ç…§ä¸¥æ ¼çš„ XA äº‹åŠ¡å®šä¹‰ã€‚</p>
<h2>4.3 MyCAT å¯åŠ¨å›æ»š PREPARE çš„ XAäº‹åŠ¡</h2>
<p>1ã€MyCAT å¯åŠ¨æ—¶ï¼Œå›æ»šæ‰€æœ‰çš„ <code>PREPARE</code> çš„ XA äº‹åŠ¡ï¼Œå¯èƒ½æŸä¸ª XA äº‹åŠ¡ï¼Œéƒ¨åˆ† <code>COMMIT</code>ï¼Œéƒ¨åˆ† <code>PREPARE</code>ã€‚æ­¤æ—¶ç›´æ¥å›æ»šï¼Œä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚</p>
<p>å»ºè®®ï¼šå½“åˆ¤æ–­åˆ°æŸä¸ª XA äº‹åŠ¡å­˜åœ¨ <code>PREPARE</code> çš„å‚ä¸è€…ï¼Œ<strong>åŒæ—¶åˆ¤æ–­è¯¥ XA äº‹åŠ¡é‡Œå…¶ä»–å‚ä¸è€…çš„äº‹åŠ¡çŠ¶æ€</strong>ä»¥åŠ<strong>æ•°æ®èŠ‚ç‚¹é‡Œ XA äº‹åŠ¡çŠ¶æ€</strong>ï¼Œæ¯”å¦‚å‚ä¸è€…ä¸º <code>MySQL</code>æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>XA RECOVER</code> æŸ¥è¯¢å¤„äº <code>PREPARE</code> æ‰€æœ‰çš„ XA äº‹åŠ¡ã€‚</p>
<p>2ã€å›æ»š <code>PREPARE</code> æ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œåœ¨æœªè¿›è¡Œå®Œæˆæ—¶å·²ç»è®¾ç½®æ–‡ä»¶é‡Œå›æ»šæˆåŠŸã€‚å¦‚æœå¼‚æ­¥è¿‡ç¨‹ä¸­å¤±è´¥ï¼Œä¼šå¯¼è‡´ XA äº‹åŠ¡çŠ¶æ€ä¸ä¸€è‡´ã€‚</p>
<p>å»ºè®®ï¼šå›è°ƒæˆåŠŸåï¼Œæ›´æ–°è¯¥ XA äº‹åŠ¡çŠ¶æ€ã€‚</p>
<h2>4.4 å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—</h2>
<p>è¯¥æƒ…å†µè¾ƒä¸ºæç«¯ã€‚å‘èµ· <code>XA PREPARE</code>å®Œåï¼ŒMyCAT æŒ‚äº†ã€‚é‡å¯åï¼Œè¯¥ XA äº‹åŠ¡åœ¨ MyCAT é‡Œå°±â€œæ¶ˆå¤±â€œäº†ï¼Œå‚ä¸è€…çš„è¯¥ XA äº‹åŠ¡ä¸€ç›´å¤„äº <code>PREPARE</code> çŠ¶æ€ã€‚ä»ç†è®ºä¸Šæ¥è¯´ï¼Œéœ€è¦å›æ»šè¯¥ XA äº‹åŠ¡ã€‚</p>
<p>å»ºè®®ï¼šè®°å½•åè°ƒæ—¥å¿—ã€‚</p>
<h2>4.5 XA COMMIT éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†</h2>
<p>å½“ä¸€éƒ¨åˆ†èŠ‚ç‚¹ <code>XA COMMIT</code> å®Œæˆï¼Œå¦å¤–ä¸€éƒ¨åˆ†æ­¤æ—¶æŒ‚äº†ã€‚åœ¨ç®¡ç†å‘˜é‡å¯æŒ‚æ‰çš„èŠ‚ç‚¹ï¼Œå…¶å¯¹åº”çš„ XA äº‹åŠ¡æœªè¿›ä¸€æ­¥å¤„ç†ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚</p>
<p>å»ºè®®ï¼šğŸ˜ˆæœ¨æœ‰å»ºè®®ã€‚ä¹Ÿå¾ˆå¥½å¥‡ï¼Œå¦‚æœæ˜¯è¿™æ ·çš„æƒ…å†µï¼Œå¦‚ä½•å¤„ç†è¾ƒä¸ºåˆé€‚ã€‚å¦‚æœ‰å¤§å¤§çŸ¥é“ï¼Œçƒ¦è¯·å‘ŠçŸ¥ä¸‹ã€‚</p>
<h1>5. å½©è›‹</h1>
<p>ä¾‹è¡Œâ€œå½©è›‹â€ï¼Ÿ</p>
<ul>
<li><a href="http://blog.csdn.net/d6619309/article/details/52330334" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMycatæºç ç¯‡ : MyCatäº‹åŠ¡ç®¡ç†æœºåˆ¶åˆ†æã€‹</a> æ¥è‡ª MyCAT Committer çš„æ–‡ç« </li>
<li><a href="http://mysql.taobao.org/monthly/2015/04/05/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMySQL Â· æ‰è™«åŠ¨æ€ Â· è¿æ¥æ–­å¼€å¯¼è‡´XAäº‹åŠ¡ä¸¢å¤±ã€‹</a></li>
<li><a href="http://www.infoq.com/cn/articles/solution-of-distributed-system-transaction-consistency" rel="external nofollow noopener noreferrer" target="_blank">ã€Šåˆ†å¸ƒå¼ç³»ç»Ÿäº‹åŠ¡ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆã€‹</a></li>
<li><a href="http://blog.csdn.net/fly2749/article/details/44998203" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMySQLæ•°æ®åº“åˆ†å¸ƒå¼äº‹åŠ¡XAä¼˜ç¼ºç‚¹ä¸æ”¹è¿›æ–¹æ¡ˆã€‹</a></li>
<li><a href="http://www.hollischuang.com/archives/1580" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥ç†è§£åˆ†å¸ƒå¼ç³»ç»Ÿçš„2PCå’Œ3PCã€‹</a></li>
<li><a href="https://github.com/YunaiV/yunaiv.github.io/blob/master/source/_drafts/MyCAT/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1.xmind" target="_blank" rel="external">ã€åˆ†å¸ƒå¼äº‹åŠ¡.xmindã€‘</a> ç¬”è€…æ‹™ä½œ</li>
<li><a href="http://www.yunai.me/RocketMQ/message-transaction/?self">ã€ŠRocketMQ æºç åˆ†æ â€”â€” äº‹åŠ¡æ¶ˆæ¯ã€‹</a> ç¬”è€…æ‹™ä½œ</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rock
    
    </summary>
    
      <category term="MyCAT" scheme="http://www.yunai.me/categories/MyCAT/"/>
    
    
  </entry>
  
  <entry>
    <title>MyCAT æºç åˆ†æ  â€”â€” è·¨åº“ä¸¤è¡¨Join</title>
    <link href="http://www.yunai.me/MyCAT/two-table-share-join/"/>
    <id>http://www.yunai.me/MyCAT/two-table-share-join/</id>
    <published>2017-07-11T16:00:00.000Z</published>
    <updated>2017-07-27T16:54:41.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ä¸»æµç¨‹</a></li>
<li><a href="#">3. ShareJoin</a>
<ul>
<li><a href="#">3.1 JoinParser</a></li>
<li><a href="#">3.2 ShareJoin.processSQL(...)</a></li>
<li><a href="#">3.3 BatchSQLJob</a></li>
<li><a href="#">3.4 ShareDBJoinHandler</a></li>
<li><a href="#">3.5 ShareRowOutPutDataHandler</a></li>
</ul>
</li>
<li><a href="#">4. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>MyCAT æ”¯æŒè·¨åº“è¡¨ Joinï¼Œç›®å‰ç‰ˆæœ¬ä»…æ”¯æŒè·¨åº“<strong>ä¸¤</strong>è¡¨ Joinã€‚è™½ç„¶å¦‚æ­¤ï¼Œå·²ç»èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬å¤§éƒ¨åˆ†çš„ä¸šåŠ¡åœºæ™¯ã€‚å†µä¸”ï¼ŒJoin è¿‡å¤šçš„è¡¨å¯èƒ½å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ä¹Ÿæ˜¯å¾ˆéº»çƒ¦çš„ã€‚</p>
<p>æœ¬æ–‡ä¸»è¦åˆ†äº«ï¼š</p>
<ol>
<li>æ•´ä½“æµç¨‹ã€è°ƒç”¨é¡ºåºå›¾</li>
<li>æ ¸å¿ƒä»£ç çš„åˆ†æ</li>
</ol>
<p>å‰ç½®é˜…è¯»ï¼š<a href="http://www.yunai.me/MyCAT/single-db-single-table-select/?yunai">ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹</a>ã€‚</p>
<p>OKï¼ŒLet's Goã€‚</p>
<h1>2. ä¸»æµç¨‹</h1>
<p>å½“æ‰§è¡Œè·¨åº“ä¸¤è¡¨ Join SQL æ—¶ï¼Œç»å†çš„å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_12/01.png" alt=""></p>
<p>SQL ä¸Šï¼Œéœ€è¦æ·»åŠ æ³¨è§£ <code>/*!mycat:catlet=io.mycat.catlets.ShareJoin */ ${SQL}</code> ã€‚<code>RouteService#route(...)</code> è§£ææ³¨è§£ <code>mycat:catlet</code> åï¼Œè·¯ç”±ç»™ <code>HintCatletHandler</code> ä½œè¿›ä¸€æ­¥å¤„ç†ã€‚</p>
<p><code>HintCatletHandler</code> è·å–æ³¨è§£å¯¹åº”çš„ <code>Catlet</code> å®ç°ç±»ï¼Œ<code>io.mycat.catlets.ShareJoin</code> å°±æ˜¯å…¶ä¸­ä¸€ç§å®ç°ï¼ˆç›®å‰ä¹Ÿåªæœ‰è¿™ä¸€ç§å®ç°ï¼‰ï¼Œæä¾›äº†è·¨åº“ä¸¤è¡¨ Join çš„åŠŸèƒ½ã€‚ä»ç±»å‘½åä¸Šçœ‹ï¼Œ<code>ShareJoin</code> å¾ˆå¤§å¯èƒ½æ€§åç»­ä¼šæä¾›<strong>å®Œæ•´</strong>çš„è·¨åº“å¤šè¡¨çš„ Join åŠŸèƒ½ã€‚</p>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// HintCatletHandler.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> RouteResultset <span class="title">route</span><span class="params">(SystemConfig sysConfig, SchemaConfig schema,</span></span></div><div class="line">                           <span class="keyword">int</span> sqlType, String realSQL, String charset, ServerConnection sc,</div><div class="line">                           LayerCachePool cachePool, String hintSQLValue, <span class="keyword">int</span> hintSqlType, Map hintMap)</div><div class="line">       <span class="keyword">throws</span> SQLNonTransientException &#123;</div><div class="line">   String cateletClass = hintSQLValue;</div><div class="line">   <span class="keyword">if</span> (LOGGER.isDebugEnabled()) &#123;</div><div class="line">       LOGGER.debug(<span class="string">"load catelet class:"</span> + hintSQLValue + <span class="string">" to run sql "</span> + realSQL);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Catlet catlet = (Catlet) MycatServer.getInstance().getCatletClassLoader().getInstanceofClass(cateletClass);</div><div class="line">       catlet.route(sysConfig, schema, sqlType, realSQL, charset, sc, cachePool);</div><div class="line">       catlet.processSQL(realSQL, <span class="keyword">new</span> EngineCtx(sc.getSession2()));</div><div class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">       LOGGER.warn(<span class="string">"catlet error "</span> + e);</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLNonTransientException(e);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>3. ShareJoin</h1>
<p>ç›®å‰æ”¯æŒè·¨åº“<strong>ä¸¤</strong>è¡¨ Joinã€‚<code>ShareJoin</code> å°† SQL æ‹†åˆ†æˆå·¦è¡¨ SQL å’Œ å³è¡¨ SQLï¼Œå‘é€ç»™å„æ•°æ®èŠ‚ç‚¹æ‰§è¡Œï¼Œæ±‡æ€»æ•°æ®ç»“æœè¿›è¡Œåˆåè¿”å›ã€‚</p>
<p>ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SELECT u.id, o.id FROM t_order o </span></div><div class="line"><span class="comment">// INNER JOIN t_user u ON o.uid = u.id</span></div><div class="line"><span class="comment">// ã€é¡ºåºã€‘æŸ¥è¯¢å·¦è¡¨</span></div><div class="line">String leftSQL = <span class="string">"SELECT o.id, u.id FROM t_order o"</span>;</div><div class="line">List leftList = dn[<span class="number">0</span>].select(leftSQL) + dn[<span class="number">1</span>].select(leftSQL) + ... + dn[n].select(leftsql);</div><div class="line"><span class="comment">// ã€å¹¶è¡Œã€‘æŸ¥è¯¢å³è¡¨</span></div><div class="line">String rightSQL = <span class="string">"SELECT u.id FROM t_user u WHERE u.id IN ($&#123;leftList.uid&#125;)"</span>;</div><div class="line"><span class="keyword">for</span> (dn : dns) &#123; <span class="comment">// æ­¤å¤„æ˜¯å¹¶è¡Œæ‰§è¡Œï¼Œä½¿ç”¨å›è°ƒé€»è¾‘</span></div><div class="line">    <span class="keyword">for</span> (rightRecord : dn.select(rightSQL)) &#123; <span class="comment">// æŸ¥è¯¢å³è¡¨</span></div><div class="line">        <span class="comment">// åˆå¹¶ç»“æœ</span></div><div class="line">        <span class="keyword">for</span> (leftRecord : leftList) &#123;</div><div class="line">            <span class="keyword">if</span> (leftRecord.uid == rightRecord.id) &#123;</div><div class="line">                write(leftRecord + leftRecord.uid æ‹¼æ¥ç»“æœ);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å®é™…æƒ…å†µä¼šæ›´åŠ å¤æ‚ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä¸€ç‚¹ç‚¹å¾€ä¸‹çœ‹ã€‚</p>
<h2>3.1 JoinParser</h2>
<p><code>JoinParser</code> è´Ÿè´£å¯¹ SQL è¿›è¡Œè§£æã€‚æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_12/02.png" alt=""></p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ<code>/*!mycat:catlet=io.mycat.catlets.ShareJoin */ SELECT o.id, u.username from t_order o join t_user u on o.uid = u.id;</code> è§£æåï¼Œ<code>TableFilter</code> ç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_12/03.png" alt=""></p>
<ul>
<li>tName ï¼šè¡¨å</li>
<li>tAlia ï¼šè¡¨è‡ªå®šä¹‰å‘½å</li>
<li>where ï¼šè¿‡æ»¤æ¡ä»¶</li>
<li>order ï¼šæ’åºæ¡ä»¶</li>
<li>parenTable ï¼šå·¦è¿æ¥çš„ Join çš„è¡¨åã€‚<code>t_user</code>è¡¨ åœ¨ <code>join</code>å±æ€§ çš„ <code>parenTable</code> ä¸º &quot;o&quot;ï¼Œå³ <code>t_order</code>ã€‚</li>
<li>joinParentkey ï¼šå·¦è¿æ¥çš„ Join å­—æ®µ</li>
<li>joinKey ï¼šjoin å­—æ®µã€‚<code>t_user</code>è¡¨ åœ¨ <code>join</code>å±æ€§ ä¸º <code>id</code>ã€‚</li>
<li>join ï¼šå­ tableFilterã€‚å³ï¼Œè¯¥è¡¨è¿æ¥çš„å³è¾¹çš„è¡¨ã€‚</li>
<li>parent ï¼šå’Œ <code>join</code>å±æ€§ ç›¸å¯¹ã€‚</li>
</ul>
<p>çœ‹åˆ°æ­¤å¤„ï¼Œå¤§å®¶å¯èƒ½æœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆè¦æŠŠ SQL è§£ææˆ <code>TableFilter</code>ã€‚<code>JoinParser</code> æ ¹æ® <code>TableFilter</code> ç”Ÿæˆæ•°æ®èŠ‚ç‚¹æ‰§è¡Œ SQLã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TableFilter.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getSQL</span><span class="params">()</span> </span>&#123;</div><div class="line">   String sql = <span class="string">""</span>;</div><div class="line">   <span class="comment">// fields</span></div><div class="line">   <span class="keyword">for</span> (Entry&lt;String, String&gt; entry : fieldAliasMap.entrySet()) &#123;</div><div class="line">       String key = entry.getKey();</div><div class="line">       String val = entry.getValue();</div><div class="line">       <span class="keyword">if</span> (val == <span class="keyword">null</span>) &#123;</div><div class="line">           sql = unionsql(sql, getFieldfrom(key), <span class="string">","</span>);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           sql = unionsql(sql, getFieldfrom(key) + <span class="string">" as "</span> + val, <span class="string">","</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// where</span></div><div class="line">   <span class="keyword">if</span> (parent == <span class="keyword">null</span>) &#123;    <span class="comment">// on/where ç­‰äºå·å·¦è¾¹çš„è¡¨</span></div><div class="line">       String parentJoinKey = getJoinKey(<span class="keyword">true</span>);</div><div class="line">       <span class="comment">// fix sharejoin bugï¼š</span></div><div class="line">       <span class="comment">// (AbstractConnection.java:458) -close connection,reason:program err:java.lang.IndexOutOfBoundsException:</span></div><div class="line">       <span class="comment">// åŸå› æ˜¯å·¦è¡¨çš„selectåˆ—æ²¡æœ‰åŒ…å« join åˆ—ï¼Œåœ¨è·å–ç»“æœæ—¶æŠ¥ä¸Šé¢çš„é”™è¯¯</span></div><div class="line">       <span class="keyword">if</span> (sql != <span class="keyword">null</span> &amp;&amp; parentJoinKey != <span class="keyword">null</span> &amp;&amp;</div><div class="line">               !sql.toUpperCase().contains(parentJoinKey.trim().toUpperCase())) &#123;</div><div class="line">           sql += <span class="string">", "</span> + parentJoinKey;</div><div class="line">       &#125;</div><div class="line">       sql = <span class="string">"select "</span> + sql + <span class="string">" from "</span> + tName;</div><div class="line">       <span class="keyword">if</span> (!(where.trim().equals(<span class="string">""</span>))) &#123;</div><div class="line">           sql += <span class="string">" where "</span> + where.trim();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;    <span class="comment">// on/where ç­‰äºå·å³è¾¹è¾¹çš„è¡¨</span></div><div class="line">       <span class="keyword">if</span> (allField) &#123;</div><div class="line">           sql = <span class="string">"select "</span> + sql + <span class="string">" from "</span> + tName;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           sql = unionField(<span class="string">"select "</span> + joinKey, sql, <span class="string">","</span>);</div><div class="line">           sql = sql + <span class="string">" from "</span> + tName;</div><div class="line">           <span class="comment">//sql="select "+joinKey+","+sql+" from "+tName;</span></div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!(where.trim().equals(<span class="string">""</span>))) &#123;</div><div class="line">           sql += <span class="string">" where "</span> + where.trim() + <span class="string">" and ("</span> + joinKey + <span class="string">" in %s )"</span>;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           sql += <span class="string">" where "</span> + joinKey + <span class="string">" in %s "</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// order</span></div><div class="line">   <span class="keyword">if</span> (!(order.trim().equals(<span class="string">""</span>))) &#123;</div><div class="line">       sql += <span class="string">" order by "</span> + order.trim();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// limit</span></div><div class="line">   <span class="keyword">if</span> (parent == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">if</span> ((rowCount &gt; <span class="number">0</span>) &amp;&amp; (offset &gt; <span class="number">0</span>)) &#123;</div><div class="line">           sql += <span class="string">" limit"</span> + offset + <span class="string">","</span> + rowCount;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">if</span> (rowCount &gt; <span class="number">0</span>) &#123;</div><div class="line">               sql += <span class="string">" limit "</span> + rowCount;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> sql;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å½“ <code>parent</code> ä¸ºç©ºæ—¶ï¼Œå³<strong>on/where ç­‰äºå·å·¦è¾¹çš„è¡¨</strong>ã€‚ä¾‹å¦‚ï¼š<code>select id, uid from t_order</code>ã€‚</li>
<li>å½“ <code>parent</code>  ä¸ä¸ºç©ºæ—¶ï¼Œå³<strong>on/where ç­‰äºå·å³è¾¹çš„è¡¨</strong>ã€‚ä¾‹å¦‚ï¼š<code>select id, username from t_user where id in (1, 2, 3)</code>ã€‚</li>
</ul>
<h2>3.2 ShareJoin.processSQL(...)</h2>
<p>å½“ SQL è§£æå®Œåï¼Œç”Ÿæˆ<strong>å·¦è¾¹çš„è¡¨</strong>æ‰§è¡Œçš„ SQLï¼Œå‘é€ç»™å¯¹åº”çš„æ•°æ®èŠ‚ç‚¹æŸ¥è¯¢æ•°æ®ã€‚å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_12/04.png" alt=""></p>
<p>å½“ SQL ä¸º <code>/*!mycat:catlet=io.mycat.catlets.ShareJoin */ SELECT o.id, u.username from t_order o join t_user u on o.uid = u.id;</code> æ—¶ï¼Œ
<code>sql = getSql()</code> çš„è¿”å›ç»“æœä¸º <code>select id, uid from t_order</code>ã€‚</p>
<p>ç”Ÿæˆ<strong>å·¦è¾¹çš„è¡¨</strong>æ‰§è¡Œçš„ SQL åï¼Œ<strong>é¡ºåºé¡ºåºé¡ºåº</strong>å‘é€ç»™å¯¹åº”çš„æ•°æ®èŠ‚ç‚¹æŸ¥è¯¢æ•°æ®ã€‚å…·ä½“é¡ºåºæŸ¥è¯¢æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ç«  <strong>BatchSQLJob</strong>ã€‚</p>
<h2>3.3 BatchSQLJob</h2>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_12/05.png" alt=""></p>
<p><code>EngineCtx</code> å¯¹ <code>BatchSQLJob</code> å°è£…ï¼Œæä¾›ä¸Šå±‚ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<ol>
<li>executeNativeSQLSequnceJob ï¼šé¡ºåºï¼ˆéå¹¶å‘ï¼‰åœ¨æ¯ä¸ªæ•°æ®èŠ‚ç‚¹æ‰§è¡ŒSQLä»»åŠ¡</li>
<li>executeNativeSQLParallJob ï¼šå¹¶å‘åœ¨æ¯ä¸ªæ•°æ®èŠ‚ç‚¹æ‰§è¡ŒSQLä»»åŠ¡</li>
</ol>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EngineCtx.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeNativeSQLSequnceJob</span><span class="params">(String[] dataNodes, String sql,</span></span></div><div class="line">		SQLJobHandler jobHandler) &#123;</div><div class="line">	<span class="keyword">for</span> (String dataNode : dataNodes) &#123;</div><div class="line">		SQLJob job = <span class="keyword">new</span> SQLJob(jobId.incrementAndGet(), sql, dataNode,</div><div class="line">				jobHandler, <span class="keyword">this</span>);</div><div class="line">		bachJob.addJob(job, <span class="keyword">false</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeNativeSQLParallJob</span><span class="params">(String[] dataNodes, String sql,</span></span></div><div class="line">		SQLJobHandler jobHandler) &#123;</div><div class="line">	<span class="keyword">for</span> (String dataNode : dataNodes) &#123;</div><div class="line">		SQLJob job = <span class="keyword">new</span> SQLJob(jobId.incrementAndGet(), sql, dataNode,</div><div class="line">				jobHandler, <span class="keyword">this</span>);</div><div class="line">		bachJob.addJob(job, <span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<p><code>BatchSQLJob</code> é€šè¿‡<strong>æ‰§è¡Œä¸­ä»»åŠ¡åˆ—è¡¨</strong>ã€<strong>å¾…æ‰§è¡Œä»»åŠ¡åˆ—è¡¨</strong>æ¥å®ç°<strong>é¡ºåº/å¹¶å‘</strong>æ‰§è¡Œä»»åŠ¡ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// BatchSQLJob.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œä¸­ä»»åŠ¡åˆ—è¡¨</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> ConcurrentHashMap&lt;Integer, SQLJob&gt; runningJobs = <span class="keyword">new</span> ConcurrentHashMap&lt;Integer, SQLJob&gt;();</div><div class="line"><span class="comment">/**</span></div><div class="line">* å¾…æ‰§è¡Œä»»åŠ¡åˆ—è¡¨</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> ConcurrentLinkedQueue&lt;SQLJob&gt; waitingJobs = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;SQLJob&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addJob</span><span class="params">(SQLJob newJob, <span class="keyword">boolean</span> parallExecute)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (parallExecute) &#123;</div><div class="line">       runJob(newJob);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       waitingJobs.offer(newJob);</div><div class="line">       <span class="keyword">if</span> (runningJobs.isEmpty()) &#123; <span class="comment">// è‹¥æ— æ­£åœ¨æ‰§è¡Œä¸­çš„ä»»åŠ¡ï¼Œåˆ™ä»ç­‰å¾…é˜Ÿåˆ—é‡Œè·å–ä»»åŠ¡è¿›è¡Œæ‰§è¡Œã€‚</span></div><div class="line">           SQLJob job = waitingJobs.poll();</div><div class="line">           <span class="keyword">if</span> (job != <span class="keyword">null</span>) &#123;</div><div class="line">               runJob(job);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">jobFinished</span><span class="params">(SQLJob sqlJob)</span> </span>&#123;</div><div class="line">	runningJobs.remove(sqlJob.getId());</div><div class="line">	SQLJob job = waitingJobs.poll();</div><div class="line">	<span class="keyword">if</span> (job != <span class="keyword">null</span>) &#123;</div><div class="line">		runJob(job);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">if</span> (noMoreJobInput) &#123;</div><div class="line">			<span class="keyword">return</span> runningJobs.isEmpty() &amp;&amp; waitingJobs.isEmpty();</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><strong>é¡ºåº</strong>æ‰§è¡Œæ—¶ï¼Œå½“ <code>runningJobs</code> å­˜åœ¨æ‰§è¡Œä¸­çš„ä»»åŠ¡æ—¶ï¼Œ<code>#addJob(...)</code> æ—¶ï¼Œä¸ç«‹å³æ‰§è¡Œï¼Œæ·»åŠ åˆ° <code>waitingJobs</code>ã€‚å½“ <code>SQLJob</code> å®Œæˆæ—¶ï¼Œé¡ºåºè°ƒç”¨ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚</li>
<li><strong>å¹¶å‘</strong>æ‰§è¡Œæ—¶ï¼Œ<code>#addJob(...)</code> æ—¶ï¼Œç«‹å³æ‰§è¡Œã€‚</li>
</ul>
<hr>
<p><code>SQLJob</code> SQL å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ã€‚å…¶ <code>jobHandler(SQLJobHandler)</code> å±æ€§ï¼Œåœ¨ SQL æ‰§è¡Œæœ‰è¿”å›ç»“æœæ—¶ï¼Œä¼šè¿›è¡Œå›è°ƒï¼Œä»è€Œå®ç°å¼‚æ­¥æ‰§è¡Œã€‚</p>
<p>åœ¨ <code>ShareJoin</code> é‡Œï¼Œ<code>SQLJobHandler</code> æœ‰ä¸¤ä¸ªå®ç°ï¼š<code>ShareDBJoinHandler</code>ã€<code>ShareRowOutPutDataHandler</code>ã€‚å‰è€…ï¼Œ<strong>å·¦è¾¹çš„è¡¨</strong>æ‰§è¡Œçš„ SQL å›è°ƒï¼›åè€…ï¼Œ<strong>å³è¾¹çš„è¡¨</strong>æ‰§è¡Œçš„ SQL å›è°ƒã€‚</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_12/06.png" alt=""></p>
<h2>3.4 ShareDBJoinHandler</h2>
<p><code>ShareDBJoinHandler</code>ï¼Œ<strong>å·¦è¾¹çš„è¡¨</strong>æ‰§è¡Œçš„ SQL å›è°ƒã€‚æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_12/07.png" alt=""></p>
<ul>
<li><code>#fieldEofResponse(...)</code> ï¼šæ¥æ”¶æ•°æ®èŠ‚ç‚¹è¿”å›çš„ fieldsï¼Œæ”¾å…¥å†…å­˜ã€‚</li>
<li><code>#rowResponse(...)</code> ï¼šæ¥æ”¶æ•°æ®èŠ‚ç‚¹è¿”å›çš„ rowï¼Œæ”¾å…¥å†…å­˜ã€‚</li>
<li><code>#rowEofResponse(...)</code> ï¼šæ¥æ”¶å®Œä¸€ä¸ªæ•°æ®èŠ‚ç‚¹è¿”å›æ‰€æœ‰çš„ rowã€‚å½“æ‰€æœ‰æ•°æ®èŠ‚ç‚¹éƒ½å®Œæˆ SQL æ‰§è¡Œæ—¶ï¼Œæäº¤<strong>å³è¾¹çš„è¡¨</strong>æ‰§è¡Œçš„ SQL ä»»åŠ¡ï¼Œ<strong>å¹¶è¡Œ</strong>æ‰§è¡Œï¼Œå³å›¾ä¸­**#createQryJob(...)**ã€‚</li>
</ul>
<p>å½“ SQL ä¸º <code>/*!mycat:catlet=io.mycat.catlets.ShareJoin */ SELECT o.id, u.username from t_order o join t_user u on o.uid = u.id;</code> æ—¶ï¼Œ
<code>sql = getChildSQL()</code> çš„è¿”å›ç»“æœä¸º <code>select id, username from t_user where id in (1, 2, 3)</code>ã€‚</p>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShareJoin.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createQryJob</span><span class="params">(<span class="keyword">int</span> batchSize)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">   Map&lt;String, <span class="keyword">byte</span>[]&gt; batchRows = <span class="keyword">new</span> ConcurrentHashMap&lt;String, <span class="keyword">byte</span>[]&gt;();</div><div class="line">   String theId = <span class="keyword">null</span>;</div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder().append(<span class="string">'('</span>);</div><div class="line">   String svalue = <span class="string">""</span>;</div><div class="line">   <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; e : ids.entrySet()) &#123;</div><div class="line">       theId = e.getKey();</div><div class="line">       <span class="keyword">byte</span>[] rowbyte = rows.remove(theId);</div><div class="line">       <span class="keyword">if</span> (rowbyte != <span class="keyword">null</span>) &#123;</div><div class="line">           batchRows.put(theId, rowbyte);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!svalue.equals(e.getValue())) &#123;</div><div class="line">           <span class="keyword">if</span> (joinKeyType == Fields.FIELD_TYPE_VAR_STRING</div><div class="line">                   || joinKeyType == Fields.FIELD_TYPE_STRING) &#123; <span class="comment">// joinkey ä¸ºvarchar</span></div><div class="line">               sb.append(<span class="string">"'"</span>).append(e.getValue()).append(<span class="string">"'"</span>).append(<span class="string">','</span>); <span class="comment">// ('digdeep','yuanfang')</span></div><div class="line">           &#125; <span class="keyword">else</span> &#123; <span class="comment">// é»˜è®¤joinkeyä¸ºint/long</span></div><div class="line">               sb.append(e.getValue()).append(<span class="string">','</span>); <span class="comment">// (1,2,3)</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       svalue = e.getValue();</div><div class="line">       <span class="keyword">if</span> (count++ &gt; batchSize) &#123;</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   jointTableIsData = <span class="keyword">true</span>;</div><div class="line">   sb.deleteCharAt(sb.length() - <span class="number">1</span>).append(<span class="string">')'</span>);</div><div class="line">   String sql = String.format(joinParser.getChildSQL(), sb);</div><div class="line">   getRoute(sql);</div><div class="line">   ctx.executeNativeSQLParallJob(getDataNodes(), sql, <span class="keyword">new</span> ShareRowOutPutDataHandler(<span class="keyword">this</span>, fields, joinindex, joinParser.getJoinRkey(), batchRows, ctx.getSession()));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.5 ShareRowOutPutDataHandler</h2>
<p><code>ShareRowOutPutDataHandler</code>ï¼Œ<strong>å³è¾¹çš„è¡¨</strong>æ‰§è¡Œçš„ SQL å›è°ƒã€‚æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_12/08.png" alt=""></p>
<ul>
<li><code>#fieldEofResponse(...)</code> ï¼šæ¥æ”¶æ•°æ®èŠ‚ç‚¹è¿”å›çš„ fieldsï¼Œè¿”å› header ç»™ MySQL Clientã€‚</li>
<li><code>#rowResponse(...)</code> ï¼šæ¥æ”¶æ•°æ®èŠ‚ç‚¹è¿”å›çš„ rowï¼ŒåŒ¹é…å·¦è¡¨çš„è®°å½•ï¼Œè¿”å›åˆå¹¶åè¿”å›çš„ row ç»™ MySQL Clientã€‚</li>
<li><code>#rowEofResponse(...)</code> ï¼šå½“æ‰€æœ‰ row éƒ½è¿”å›å®Œåï¼Œè¿”å› eof ç»™ MySQL Clientã€‚</li>
</ul>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShareRowOutPutDataHandler.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onRowData</span><span class="params">(String dataNode, <span class="keyword">byte</span>[] rowData)</span> </span>&#123;</div><div class="line">   RowDataPacket rowDataPkgold = ResultSetUtil.parseRowData(rowData, bfields);</div><div class="line">   <span class="comment">//æ‹·è´ä¸€ä»½batchRows</span></div><div class="line">   Map&lt;String, <span class="keyword">byte</span>[]&gt; batchRowsCopy = <span class="keyword">new</span> ConcurrentHashMap&lt;String, <span class="keyword">byte</span>[]&gt;();</div><div class="line">   batchRowsCopy.putAll(arows);</div><div class="line">   <span class="comment">// è·å–Idå­—æ®µï¼Œ</span></div><div class="line">   String id = ByteUtil.getString(rowDataPkgold.fieldValues.get(joinR));</div><div class="line">   <span class="comment">// æŸ¥æ‰¾IDå¯¹åº”çš„Aè¡¨çš„è®°å½•</span></div><div class="line">   <span class="keyword">byte</span>[] arow = getRow(batchRowsCopy, id, joinL);</div><div class="line">   <span class="keyword">while</span> (arow != <span class="keyword">null</span>) &#123;</div><div class="line">       RowDataPacket rowDataPkg = ResultSetUtil.parseRowData(arow, afields);<span class="comment">//ctx.getAllFields());</span></div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; rowDataPkgold.fieldCount; i++) &#123;</div><div class="line">           <span class="comment">// è®¾ç½®b.name å­—æ®µ</span></div><div class="line">           <span class="keyword">byte</span>[] bname = rowDataPkgold.fieldValues.get(i);</div><div class="line">           rowDataPkg.add(bname);</div><div class="line">           rowDataPkg.addFieldCount(<span class="number">1</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// huangyiming add</span></div><div class="line">       MiddlerResultHandler middlerResultHandler = session.getMiddlerResultHandler();</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> == middlerResultHandler) &#123;</div><div class="line">           ctx.writeRow(rowDataPkg);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">if</span> (middlerResultHandler <span class="keyword">instanceof</span> MiddlerQueryResultHandler) &#123;</div><div class="line">               <span class="keyword">byte</span>[] columnData = rowDataPkg.fieldValues.get(<span class="number">0</span>);</div><div class="line">               <span class="keyword">if</span> (columnData != <span class="keyword">null</span> &amp;&amp; columnData.length &gt; <span class="number">0</span>) &#123;</div><div class="line">                   String rowValue = <span class="keyword">new</span> String(columnData);</div><div class="line">                   middlerResultHandler.add(rowValue);</div><div class="line">               &#125;</div><div class="line">               <span class="comment">//&#125;</span></div><div class="line">           &#125;</div><div class="line"></div><div class="line">       &#125;</div><div class="line">       arow = getRow(batchRowsCopy, id, joinL);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>4. å½©è›‹</h1>
<p>å¦‚ä¸‹æ˜¯æœ¬æ–‡æ¶‰åŠåˆ°çš„æ ¸å¿ƒç±»ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ç¿»ä¸€ç¿»ã€‚</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_12/09.png" alt=""></p>
<p><code>ShareJoin</code> å¦å¤–ä¸æ”¯æŒçš„åŠŸèƒ½ï¼š</p>
<ol>
<li>åªæ”¯æŒ inner joinï¼Œä¸æ”¯æŒ left joinã€right join ç­‰ç­‰è¿æ¥ã€‚</li>
<li>ä¸æ”¯æŒ order byã€‚</li>
<li>ä¸æ”¯æŒ group by ä»¥åŠ ç›¸å…³èšåˆå‡½æ•°ã€‚</li>
<li>å³ä½¿ join å·¦è¡¨çš„å­—æ®µæœªå£°æ˜ä¸ºè¿”å› fields ä¹Ÿä¼šè¿”å›ã€‚</li>
</ol>
<p>æ©ï¼Œ<strong>MyCAT å¼±XA</strong> æºç ç»§ç»­èµ°èµ·ï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rock
    
    </summary>
    
      <category term="MyCAT" scheme="http://www.yunai.me/categories/MyCAT/"/>
    
    
  </entry>
  
  <entry>
    <title>MyCAT æºç è§£æ â€”â€” åˆ†ç‰‡ç»“æœåˆå¹¶ï¼ˆä¸€ï¼‰</title>
    <link href="http://www.yunai.me/MyCAT/sharding-result-merge-first/"/>
    <id>http://www.yunai.me/MyCAT/sharding-result-merge-first/</id>
    <published>2017-06-12T16:00:00.000Z</published>
    <updated>2017-07-27T16:54:37.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>ç›¸ä¿¡å¾ˆå¤šåŒå­¦çœ‹è¿‡ MySQL å„ç§ä¼˜åŒ–çš„æ–‡ç« ï¼Œé‡Œé¢ 99% ä¼šæåˆ°ï¼šå•è¡¨æ•°æ®é‡å¤§äº†ï¼Œéœ€è¦è¿›è¡Œåˆ†ç‰‡ï¼ˆæ°´å¹³æ‹†åˆ† or å‚ç›´æ‹†åˆ†ï¼‰ã€‚åˆ†ç‰‡ä¹‹åï¼Œä¸šåŠ¡ä¸Šå¿…ç„¶é¢ä¸´çš„åœºæ™¯ï¼šè·¨åˆ†ç‰‡çš„æ•°æ®åˆå¹¶ã€‚ä»Šå¤©æˆ‘ä»¬å°±ä¸€èµ·æ¥ç…ç… MyCAT æ˜¯å¦‚ä½•å®ç°<strong>åˆ†ç‰‡ç»“æœåˆå¹¶</strong>ã€‚</p>
<p>è·¨åˆ†ç‰‡æŸ¥è¯¢å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/flow.png" alt="flow"></p>
<p>å’Œ <a href="http://www.yunai.me/Mycat/single-db-single-table-select/">ã€Šã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹</a> ä¸åŒçš„ä¸¤ä¸ªè¿‡ç¨‹ï¼š</p>
<ul>
<li>ã€2ã€‘å¤šåˆ†ç‰‡æ‰§è¡Œ SQL</li>
<li>ã€4ã€‘åˆå¹¶å¤šåˆ†ç‰‡ç»“æœ</li>
</ul>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥é€æ¡è®²è§£è¿™ä¸¤ä¸ªè¿‡ç¨‹ã€‚</p>
<h1>2. å¤šåˆ†ç‰‡æ‰§è¡Œ SQL</h1>
<p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/execute_sql.png" alt="execute_sql"></p>
<p>ç»è¿‡ SQL è§£æåï¼Œè®¡ç®—å‡ºéœ€è¦æ‰§è¡Œ SQL çš„<strong>åˆ†ç‰‡èŠ‚ç‚¹</strong>ï¼Œéå†<strong>åˆ†ç‰‡èŠ‚ç‚¹</strong>å‘é€ SQL è¿›è¡Œæ‰§è¡Œã€‚</p>
<p><strong>æ ¸å¿ƒä»£ç </strong>ï¼š</p>
<ul>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/nio/handler/MultiNodeQueryHandler.java" target="_blank" rel="external">MultiNodeQueryHandler.java#execute(...)</a></li>
</ul>
<p><em><strong>SQL è§£æ</strong> è¯¦ç»†è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ï¼Œé¿å…å†…å®¹è¿‡å¤šï¼Œå½±å“å¤§å®¶å¯¹ <strong>åˆ†ç‰‡ç»“æœåˆå¹¶</strong> æµç¨‹å’Œé€»è¾‘çš„ç†è§£ã€‚</em></p>
<h1>3. åˆå¹¶å¤šåˆ†ç‰‡ç»“æœ</h1>
<p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/handle_response.png" alt="handle_response"></p>
<p>å’Œ <a href="http://www.yunai.me/Mycat/single-db-single-table-select/">ã€Šã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹</a> ä¸åŒï¼Œå¤šä¸ª<strong>åˆ†ç‰‡èŠ‚ç‚¹</strong>éƒ½ä¼š<strong>åˆ†åˆ«</strong>å“åº” <em>è®°å½•å¤´(header)</em> å’Œ <em>è®°å½•è¡Œ(row)</em> ã€‚åœ¨å¼€å§‹åˆ†æ MyCAT æ˜¯æ€ä¹ˆåˆå¹¶å¤šåˆ†ç‰‡ç»“æœä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥å›æƒ³ä¸‹ SQL çš„æ‰§è¡Œé¡ºåºã€‚</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">FROM       // [1] é€‰æ‹©è¡¨</div><div class="line">WHERE      // [2] è¿‡æ»¤è¡¨</div><div class="line">GROUP BY   // [3] åˆ†ç»„</div><div class="line"><span class="keyword">SELECT</span>     // [<span class="number">4</span>] æ™®é€šå­—æ®µï¼Œ<span class="keyword">max</span> / <span class="keyword">min</span> / <span class="keyword">avg</span> / <span class="keyword">sum</span> / <span class="keyword">count</span> ç­‰å‡½æ•°ï¼Œ<span class="keyword">distinct</span></div><div class="line"><span class="keyword">HAVING</span>     // [<span class="number">5</span>] å†è¿‡æ»¤è¡¨</div><div class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span>   // [<span class="number">6</span>] æ’åº</div><div class="line"><span class="keyword">LIMIT</span>      // [<span class="number">7</span>] åˆ†é¡µ</div></pre></td></tr></table></figure></p>
<h2>3.1 è®°å½•å¤´(header)</h2>
<p>å¤šä¸ª<strong>åˆ†ç‰‡èŠ‚ç‚¹</strong>å“åº”æ—¶ï¼Œä¼šå“åº”å¤šæ¬¡ <em>è®°å½•å¤´(header)</em> ã€‚MyCAT åœ¨å®é™…å¤„ç†æ—¶ï¼Œåªå¤„ç†ç¬¬ä¸€ä¸ªè¿”å›çš„ <em>è®°å½•å¤´(header)</em> ã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨æ—¶è¦ä¿è¯è¡¨çš„ Schema ç›¸åŒã€‚</p>
<p><strong>åˆ†ç‰‡èŠ‚ç‚¹</strong>å“åº”çš„ <em>è®°å½•å¤´(header)</em> å¯ä»¥ç›´æ¥è¿”å› MySQL Client å—ï¼Ÿç­”æ¡ˆæ˜¯ä¸å¯ä»¥ã€‚<code>AVG</code>å‡½æ•° æ˜¯ç‰¹æ®Šæƒ…å†µï¼ŒMyCAT éœ€è¦å°† <code>AVG</code> æ‹†æˆ <code>SUM</code> + <code>COUNT</code> è¿›è¡Œè®¡ç®—ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p>
<p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">// [1] MySQL Client =&gt; MyCAT ï¼š</div><div class="line">SELECT AVG(age) FROM student;</div><div class="line"></div><div class="line">// [2] MyCAT =&gt; MySQL Server ï¼š</div><div class="line">SELECT SUM(age) AS AVG0SUM, COUNT(age) AS AVG0COUNT FROM student;</div><div class="line"></div><div class="line">// [3] æœ€ç»ˆï¼šAVG(age) = SUM(age) AS AVG0SUM / COUNT(age)</div></pre></td></tr></table></figure></p>
<p><strong>æ ¸å¿ƒä»£ç </strong>ï¼š</p>
<ul>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/nio/handler/MultiNodeQueryHandler.java" target="_blank" rel="external">MultiNodeQueryHandler.java#fieldEofResponse(...)</a>ã€‚</li>
</ul>
<h2>3.2 è®°å½•è¡Œ(row)</h2>
<h3>3.1 AbstractDataNodeMerge</h3>
<p>MyCAT å¯¹åˆ†ç‰‡ç»“æœåˆå¹¶é€šè¿‡ <code>AbstractDataNodeMerge</code> å­ç±»æ¥å®Œæˆã€‚</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/merge_service.png" alt="merge_service"></p>
<p><code>AbstractDataNodeMerge</code> ï¼š</p>
<ul>
<li>-packs ï¼šå¾…åˆå¹¶è®°å½•è¡Œ(row)é˜Ÿåˆ—ã€‚é˜Ÿåˆ—å°¾éƒ¨æ’å…¥ <code>END_FLAG_PACK</code> è¡¨ç¤ºé˜Ÿåˆ—å·²ç»“æŸã€‚</li>
<li>-running ï¼šåˆå¹¶é€»è¾‘æ˜¯å¦æ­£åœ¨æ‰§è¡Œä¸­çš„æ ‡è®°ã€‚</li>
<li>~onRowMetaData(...) ï¼šæ ¹æ®**è®°å½•åˆ—ä¿¡æ¯(ColMeta)**æ„å»ºå¯¹åº”çš„æ’åºç»„ä»¶å’Œèšåˆç»„ä»¶ã€‚éœ€è¦å­ç±»è¿›è¡Œå®ç°ã€‚</li>
<li>~onNewRecord(...) ï¼šæ’å…¥è®°å½•è¡Œ(row) åˆ° <code>packs</code>ã€‚</li>
<li>~outputMergeResult(...) ï¼šæ’å…¥ <code>END_FLAG_PACK</code> åˆ° <code>packs</code>ã€‚</li>
<li>~run(...) ï¼šæ‰§è¡Œ<strong>åˆå¹¶</strong>åˆ†ç‰‡ç»“æœé€»è¾‘ï¼Œå¹¶å°†åˆå¹¶ç»“æœè¿”å›ç»™ MySQL Clientã€‚éœ€è¦å­ç±»è¿›è¡Œå®ç°ã€‚</li>
</ul>
<p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/AbstractDataNodeMerge_run.png" alt="AbstractDataNodeMerge_run.png"></p>
<p><em><em>é€šè¿‡ <code>running</code> æ ‡è®°ä¿è¯åŒä¸€æ¡ SQL åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œï¼Œå¹¶ä¸”ä¸éœ€è¦ç­‰åˆ°æ¯ä¸ªåˆ†ç‰‡ç»“æœéƒ½è¿”å›å°±å¯ä»¥æ‰§è¡Œ</em>èšåˆ</em>é€»è¾‘ã€‚å½“ç„¶ï¼Œ<em>æ’åº</em>é€»è¾‘éœ€è¦ç­‰åˆ°æ‰€æœ‰åˆ†ç‰‡ç»“æœéƒ½è¿”å›æ‰å¯ä»¥æ‰§è¡Œã€‚**</p>
<p><strong>æ ¸å¿ƒä»£ç </strong>ï¼š</p>
<ul>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/sqlengine/mpp/AbstractDataNodeMerge.java" target="_blank" rel="external">AbstractDataNodeMerge.java</a></li>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/sqlengine/mpp/DataNodeMergeManager.java" target="_blank" rel="external">DataNodeMergeManager.java#run(...)</a></li>
</ul>
<h3>3.2 DataNodeMergeManager</h3>
<p><code>AbstractDataNodeMerge</code> æœ‰ä¸¤ç§å­ç±»å®ç°ï¼š</p>
<ul>
<li><code>DataMergeService</code> ï¼šåŸºäº<strong>å †å†…å†…å­˜</strong>åˆå¹¶åˆ†ç‰‡ç»“æœã€‚</li>
<li><code>DataNodeMergeManager</code> ï¼šåŸºäº<strong>å †å¤–å†…å­˜</strong>åˆå¹¶åˆ†ç‰‡ç»“æœã€‚</li>
</ul>
<p>ç›®å‰å®˜æ–¹é»˜è®¤é…ç½®ä½¿ç”¨ <code>DataNodeMergeManager</code>ã€‚ä¸»è¦æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š</p>
<ol>
<li>å¯ä»¥ä½¿ç”¨æ›´å¤§çš„å†…å­˜ç©ºé—´ã€‚å½“å¹¶å‘é‡å¤§æˆ–è€…æ•°æ®é‡å¤§æ—¶ï¼Œæ›´å¤§çš„å†…å­˜ç©ºé—´æ„å‘³ç€æ›´å¥½çš„æ€§èƒ½ã€‚</li>
<li>å‡å°‘ GC æš‚åœæ—¶é—´ã€‚è®°å½•è¡Œ(row)å¯¹è±¡å°ä¸”é‡ç”¨æ€§å¾ˆä½ï¼Œéœ€è¦èƒ½å¤Ÿè¿›è¡Œç±»ä¼¼ C / C++ çš„è‡ªä¸»å†…å­˜é‡Šæ”¾ã€‚</li>
<li>æ›´å¿«çš„å†…å­˜å¤åˆ¶å’Œè¯»å–é€Ÿåº¦ï¼Œå¯¹æ’åºå’Œèšåˆå¸¦æ¥å¾ˆå¥½çš„æé€Ÿã€‚</li>
</ol>
<p>å¦‚æœå¯¹<strong>å †å¤–å†…å­˜</strong>ä¸å¤ªäº†è§£ï¼Œæ¨èé˜…è¯»å¦‚ä¸‹æ–‡ç« ï¼š</p>
<ol>
<li><a href="http://www.jianshu.com/p/50be08b54bee" rel="external nofollow noopener noreferrer" target="_blank">ã€Šä»0åˆ°1èµ·æ­¥-è·Ÿæˆ‘è¿›å…¥å †å¤–å†…å­˜çš„å¥‡å¦™ä¸–ç•Œã€‹</a></li>
<li><a href="http://www.infoq.com/cn/news/2014/12/external-memory-heap-memory" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå †å†…å†…å­˜è¿˜æ˜¯å †å¤–å†…å­˜ï¼Ÿã€‹</a></li>
<li><a href="http://www.cnblogs.com/moonandstar08/p/5107648.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJAVAå †å¤–å†…å­˜ã€‹</a></li>
<li><a href="https://yq.aliyun.com/articles/2948?spm=5176.100239.blogcont62539.11.a3HdFE" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJVMæºç åˆ†æä¹‹å †å¤–å†…å­˜å®Œå…¨è§£è¯»ã€‹</a></li>
</ol>
<p>æœ¬æ–‡ä¸»è¦åˆ†æ <code>DataNodeMergeManager</code> å®ç°ï¼Œ<code>DataMergeService</code> å¯ä»¥è‡ªå·±é˜…è¯»æˆ–è€…ç­‰å¾…åç»­æ–‡ç« ï¼ˆğŸ˜ˆ<strong>æ¬¢è¿è®¢é˜…æˆ‘çš„å…¬ä¼—å·å™¢</strong>ï¼‰ã€‚</p>
<p><code>DataNodeMergeManager</code> æœ‰ä¸‰ä¸ªç»„ä»¶ï¼š</p>
<ul>
<li><code>globalSorter</code> ï¼š<code>UnsafeExternalRowSorter</code> =&gt; å®ç°è®°å½•è¡Œ(row)<strong>åˆå¹¶å¹¶æ’åº</strong>é€»è¾‘ã€‚</li>
<li><code>globalMergeResult</code> ï¼š<code>UnsafeExternalRowSorter</code> =&gt; å®ç°è®°å½•è¡Œ(row)<strong>åˆå¹¶ä¸æ’åº</strong>é€»è¾‘ã€‚</li>
<li><code>unsafeRowGrouper</code> ï¼š <code>UnsafeRowGrouper</code> =&gt; å®ç°è®°å½•è¡Œ(row)<strong>èšåˆ</strong>é€»è¾‘ã€‚</li>
</ul>
<p><code>DataNodeMergeManager#run(...)</code> é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ul>
<li>[1] å†™å…¥è®°å½•è¡Œ(row)åˆ° <code>UnsafeRow</code>ã€‚</li>
<li>[2] æ ¹æ®æƒ…å†µå°† <code>UnsafeRow</code> æ’å…¥å¯¹åº”ç»„ä»¶ã€‚</li>
<li>[3] å½“æ‰€æœ‰ <code>UnsafeRow</code> æ’å…¥å®Œåï¼Œæ ¹æ®æƒ…å†µä½¿ç”¨ç»„ä»¶èšåˆã€æ’åºã€‚</li>
</ul>
<table>
<thead>
<tr>
<th>æ˜¯å¦æ’åº</th>
<th>æ˜¯å¦èšåˆ</th>
<th>ä¾èµ–ç»„ä»¶</th>
<th>[2]</th>
<th>[3]</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¦</td>
<td>å¦</td>
<td><code>globalSorter</code></td>
<td>æ’å…¥ <code>globalSorter</code></td>
<td>ä½¿ç”¨ <code>globalSorter</code> åˆå¹¶å¹¶æ’åº</td>
</tr>
<tr>
<td>æ˜¯</td>
<td>å¦</td>
<td><code>globalMergeResult</code></td>
<td>æ’å…¥ <code>globalMergeResult</code></td>
<td>ä½¿ç”¨ <code>globalMergeResult</code> åˆå¹¶ä¸æ’åº</td>
</tr>
<tr>
<td>å¦</td>
<td>æ˜¯</td>
<td><code>unsafeRowGrouper</code> +Â <code>globalSorter</code></td>
<td>æ’å…¥ <code>unsafeRowGrouper</code> è¿›è¡Œèšåˆ</td>
<td>ä½¿ç”¨ <code>globalSorter</code> åˆå¹¶å¹¶æ’åº</td>
</tr>
<tr>
<td>æ˜¯</td>
<td>æ˜¯</td>
<td><code>unsafeRowGrouper</code> +Â <code>globalMergeResult</code></td>
<td>æ’å…¥ <code>unsafeRowGrouper</code> è¿›è¡Œèšåˆ</td>
<td>ä½¿ç”¨ <code>globalMergeResult</code> åˆå¹¶ä¸æ’åº</td>
</tr>
</tbody>
</table>
<p><strong>æ ¸å¿ƒä»£ç </strong>ï¼š</p>
<ul>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/sqlengine/mpp/DataNodeMergeManager.java" target="_blank" rel="external">DataNodeMergeManager.java</a>ã€‚</li>
</ul>
<p>ğŸ™ƒçœ‹åˆ°è¿™é‡Œï¼Œå¯èƒ½å¾ˆå¤šåŒå­¦éƒ½æœ‰ç‚¹æ‡µé€¼ï¼Œé—®é¢˜ä¸å¤§ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹ç…ã€‚</p>
<h3>3.3 UnsafeRow</h3>
<p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/unsafe_row.png" alt="unsafe_row"></p>
<p>è®°å½•è¡Œ(row)å†™åˆ° <code>UnsafeRow</code> çš„ <code>baseObject</code> å±æ€§ï¼Œç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/unsafe_row_object.png" alt="unsafe_row_object">
<img src="http://www.yunai.me/images/MyCAT/2017_06_13/unsafe_row_2.png" alt="unsafe_row_2.png"></p>
<ul>
<li>æ‹†åˆ†æˆä¸‰ä¸ªåŒºåŸŸï¼Œ<strong>æ¯ä¸ªåŒºåŸŸæŒ‰ç…§æ ¼å­è®°å½•ä¿¡æ¯ï¼Œæ¯ä¸ªæ ¼å­ 64bits(8 Bytes)</strong>ã€‚</li>
<li>è®°å½•è¡Œ(row)æŒ‰ç…§å­—æ®µé¡ºåºä½ç½®è®°å½•åˆ° <code>baseObject</code>ã€‚</li>
<li>[1] ç©ºæ ‡è®°ä½åŒºåŸŸ ï¼šæ ‡è®°å­—æ®µå¯¹åº”çš„å€¼æ˜¯å¦ä¸º NULLã€‚
<ul>
<li>å½“å­—æ®µå¯¹åº”çš„å€¼ä¸º NULL æ—¶ï¼Œå…¶å¯¹åº”çš„å­—æ®µé¡ºåºå¯¹åº”çš„ bit è®¾ç½®ä¸º 1ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œç¬¬ 0 ä¸ªä½ç½®å­—æ®µä¸º NULLï¼Œåˆ™ç¬¬ä¸€ä¸ªæ ¼å­å¯¹åº”çš„ 64 bits ä»å³è¾¹ç¬¬ä¸€ä¸ª bit è®¾ç½®ä¸º 1ã€‚</li>
<li>å› ä¸ºæ¯ä¸ªæ ¼å­æ˜¯ 64 bitsï¼Œæ¯ 64 ä¸ªå­—æ®µå ç”¨ä¸€ä¸ªæ ¼å­ï¼Œä¸æ»¡ä¸€ä¸ªæ ¼å­ï¼ŒæŒ‰ç…§ä¸€ä¸ªæ ¼å­è®¡ç®—ã€‚å› æ­¤ï¼Œè¯¥åŒºåŸŸçš„é•¿åº¦(<code>bitSetWidthInBytes</code>) = å­—æ®µå ç”¨çš„æ ¼å­æ•° * 64 bitsã€‚</li>
</ul>
</li>
<li>[2] ä½ç½®é•¿åº¦åŒºåŸŸ ï¼šè®°å½•å­—æ®µå¯¹åº”çš„å€¼åœ¨<code>[3]åŒºåŸŸ</code>æ‰€åœ¨çš„ä½ç½®å’Œé•¿åº¦ã€‚
<ul>
<li>æ¯ä¸ªå­—æ®µè®°å½•<code>[2]åŒºåŸŸ</code>çš„ä½ç½® = <code>baseOffset</code> + <code>bitSetWidthInBytes</code> + 8 Bytes * å­—æ®µé¡ºåºã€‚</li>
<li>å ç”¨ä¸€ä¸ªæ ¼å­ï¼Œå‰ 32 bits ä¸º<code>[3]åŒºåŸŸ</code>çš„ä½ç½®ï¼Œå 32 bits ä¸ºå­—æ®µå¯¹åº”çš„å€¼é•¿åº¦ã€‚</li>
</ul>
</li>
<li>[3] å€¼åŒºåŸŸ ï¼šè®°å½•å­—æ®µå¯¹åº”çš„å€¼ã€‚
<ul>
<li>æ¯ä¸ªå­—æ®µå¯¹åº”çš„å€¼å ç”¨æ ¼å­æ•° = å­—æ®µå¯¹åº”çš„å€¼é•¿åº¦ / 8 Byteï¼Œå¦‚æœæ— æ³•æ•´é™¤å† + 1ã€‚</li>
<li>å› ä¸ºå­—æ®µå¯¹åº”çš„å€¼å¯èƒ½æ— æ³•åˆšå¥½å æ»¡æ¯ä¸ªæ ¼å­ï¼Œæœªä½¿ç”¨çš„ bit ç”¨ 0 å ä½ã€‚</li>
</ul>
</li>
</ul>
<p><strong>å†™å…¥ <code>UnsafeRow</code>ï¼ŒMyCAT å¯ä»¥é¡ºåºè®¿é—®æ¯ä¸ªå­—æ®µï¼Œè€Œä¸éœ€è¦åœ¨è®°å½•è¡Œ(row)è¿›è¡Œéå†ã€‚</strong></p>
<p>ğŸ™ƒæ—¥å¸¸å¼€å‘ä½¿ç”¨ä½æ“ä½œçš„æœºä¼šæ¯”è¾ƒå°‘ï¼Œå¯èƒ½è¾ƒä¸ºéš¾ç†è§£ï¼Œéœ€è¦åå¤ç†è§£ä¸‹ï¼Œç›¸ä¿¡ä¼šè·å¾—å¾ˆå¤§å¯å‘ã€‚æ©ï¼Œè¯¥éƒ¨åˆ†ä»£ç å¼•ç”¨è‡ªå¼€æºè¿ç®—æ¡†æ¶ <code>Spark</code>ï¼Œæ˜¯ä¸æ˜¯æ›´åŠ æœ‰åŠ¨åŠ›åˆ—ğŸ˜ˆã€‚</p>
<p><strong>æ ¸å¿ƒä»£ç </strong>ï¼š</p>
<ul>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/row/UnsafeRow.java" target="_blank" rel="external">UnsafeRow.java</a></li>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/row/BufferHolder.java" target="_blank" rel="external">BufferHolder.java</a></li>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/row/UnsafeRowWriter.java" target="_blank" rel="external">UnsafeRowWriter.java</a></li>
</ul>
<h3>3.4 UnsafeExternalRowSorter</h3>
<p>å¦‚æœä½¿ç”¨ Java å®ç° <code>SELECT * FROM student ORDER BY age desc, nickname asc</code>ï¼Œä¸è€ƒè™‘ç®—æ³•ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•å¦‚ä¸‹å®ç°ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">Collections.sort(students, <span class="keyword">new</span> Comparator&lt;Comparable&gt;() &#123;</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Student o1, Student o2)</span> </span>&#123;</div><div class="line">           <span class="keyword">int</span> cmp = compare(o2.age, o1.age);</div><div class="line">           <span class="keyword">return</span> cmp != <span class="number">0</span> ? cmp : compare(o1.nickname, o2.nickname);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>ä»åŠŸèƒ½ä¸Šï¼Œ<code>UnsafeExternalRowSorter</code> æ˜¯è¿™ä¹ˆå®ç°æ’åºé€»è¾‘ã€‚å½“ç„¶è‚¯å®šçš„æ˜¯ï¼Œä¸æ˜¯è¿™ä¹ˆâ€œç®€å•â€çš„å®ç°ã€‚</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/sorter_write.jpeg" alt="sorter_write"></p>
<p><code>UnsafeRow</code> ä¼šå†™å…¥åˆ°ä¸¤ä¸ªåœ°æ–¹ï¼š</p>
<ol>
<li><code>List&lt;MemoryBlock&gt;</code> ï¼šå†…å­˜å—æ•°ç»„ã€‚å½“å‰ <code>MemoryBlock</code> æ— æ³•å®¹çº³å†™å…¥çš„ <code>UnsafeRow</code> æ—¶ï¼Œç”Ÿæˆæ–°çš„ <code>MemoryBlock</code> æä¾›å†™å…¥ã€‚æ¯æ¡ <code>UnsafeRow</code> å­˜å‚¨åœ¨ <code>MemoryBlock</code> ç”± é•¿åº¦ + å­—èŠ‚å†…å®¹ ç»„æˆã€‚</li>
<li><code>LongArray</code> ï¼šæ¯æ¡ <code>UnsafeRow</code> å­˜å‚¨åœ¨ <code>LongArray</code> ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šaddress + prefixã€‚
<ul>
<li><code>address</code> ï¼š<code>UnsafeRow</code> å­˜å‚¨åœ¨ <code>List&lt;MemoryBlock&gt;</code> çš„ä½ç½®ã€‚å‰ 13 bits è®°å½•æ‰€åœ¨ <code>MemoryBlock</code> çš„ indexï¼Œå 51 bit è®°å½•åœ¨ <code>MemoryBlock</code> çš„ offsetã€‚</li>
<li><code>prefix</code> ï¼š<code>UnsafeRow</code> ç¬¬ä¸€ä¸ªæ’åºå­—æ®µ<strong>å€¼</strong>å‰ 64 bits è®¡ç®—çš„å€¼ã€‚</li>
</ul>
</li>
</ol>
<p><strong><code>UnsafeExternalRowSorter</code> æ’åºå®ç°æ–¹å¼</strong> ï¼šæä¾› <strong><a href="http://blog.csdn.net/yangzhongblog/article/details/8184707" rel="external nofollow noopener noreferrer" target="_blank">TimSort</a></strong> å’Œ <strong>RadixSort</strong> ä¸¤ç§æ’åºç®—æ³•ï¼Œå‰è€…ä¸ºé»˜è®¤å®ç°ã€‚<strong>TimSort</strong> æŠ˜åŠæŸ¥æ‰¾æ—¶ï¼Œä½¿ç”¨ <code>LongArray</code>ï¼Œå…ˆæ¯”è¾ƒ <code>prefix</code>ï¼Œè‹¥ç›¸ç­‰ï¼Œåˆ™é¡ºåºå¯¹æ¯”æ¯ä¸ªæ’åºå­—æ®µç›´åˆ°ä¸ç­‰ï¼Œæå‡è®¡ç®—æ•ˆç‡ã€‚æ’å…¥æ“ä½œåœ¨ <code>LongArray</code> æ“ä½œï¼Œ<code>List&lt;MemoryBlock&gt;</code> åªä½œä¸ºåŸå§‹æ•°æ®ã€‚</p>
<p>å¦å¤–ï¼Œå½“éœ€è¦æ’åºç‰¹åˆ«å¤§çš„æ•°æ®é‡æ—¶ï¼Œä¼šä½¿ç”¨å­˜å‚¨æ•°æ®åˆ°æ–‡ä»¶è¿›è¡Œæ’åºã€‚é™äºç¬”è€…æš‚æ—¶æœªé˜…è¯»è¯¥å¤„æºç ï¼Œåç»­ä¼šå¦å¼€æ–‡ç« åˆ†æã€‚ğŸ™‚</p>
<p>æ ¸å¿ƒæºç ï¼š</p>
<ul>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/utils/sort/UnsafeExternalRowSorter.java" target="_blank" rel="external">UnsafeExternalRowSorter.java</a></li>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/utils/sort/UnsafeExternalRowSorter.java" target="_blank" rel="external">UnsafeExternalRowSorter.java</a></li>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/utils/sort/TimSort.java" target="_blank" rel="external">TimSort.java</a></li>
</ul>
<h3>3.5 UnsafeRowGrouper</h3>
<p>å¦‚æœä½¿ç”¨ Java å®ç° <code>SELECT nickname, COUNT(*) FROM student group by nickname</code>ï¼Œä¸è€ƒè™‘ç®—æ³•ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•å¦‚ä¸‹å®ç°ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">Map&lt;String, List&lt;Object&gt;&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"><span class="comment">// èšåˆ</span></div><div class="line"><span class="keyword">for</span> (student : students) &#123;</div><div class="line">    <span class="keyword">if</span> (map.contains(student.nickname)) &#123;</div><div class="line">        map.put(student.nickname, map.get(student.nickname).get(<span class="number">1</span>) + <span class="number">1</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        List&lt;Object&gt; value = <span class="keyword">new</span> Array&lt;&gt;();</div><div class="line">        value.add(nickname);</div><div class="line">        value.add(<span class="number">1</span>);</div><div class="line">        map.put(student.nickname, value);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// è¾“å‡º</span></div><div class="line"><span class="keyword">for</span> (value : map.values) &#123;</div><div class="line">    System.out.println(value);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»åŠŸèƒ½ä¸Šï¼Œ<code>UnsafeRowGrouper</code> æ˜¯è¿™ä¹ˆå®ç°æ’åºé€»è¾‘ã€‚å½“ç„¶è‚¯å®šçš„æ˜¯ï¼Œä¹Ÿä¸æ˜¯è¿™ä¹ˆâ€œç®€å•â€çš„å®ç°ã€‚</p>
<p>ğŸ˜ˆå…·ä½“æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿæˆ‘ä»¬åœ¨ã€ŠMyCAT æºç è§£æ â€”â€” åˆ†ç‰‡ç»“æœåˆå¹¶ï¼ˆäºŒï¼‰ã€‹ç»§ç»­åˆ†æã€‚</p>
<h1>4. æ•‘æŠ¤ä¸­å¿ƒ</h1>
<p>çœ‹åˆ°æ­¤å¤„çš„åº”è¯¥æ˜¯çœŸçˆ±å§ï¼Ÿï¼å¦‚æœå†…å®¹ä¸Šæœ‰ä»€ä¹ˆé”™è¯¯æˆ–è€…éš¾æ‡‚çš„åœ°æ–¹ï¼Œå¯ä»¥å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ç»™æˆ‘ç•™è¨€ï¼Œæˆ‘ä¼šå¾ˆè®¤çœŸçš„é€æ¡è§£ç­”çš„ã€‚â€œä¸‡ä¸€â€è§‰å¾—æœ¬æ–‡è¿˜å¯ä»¥ï¼Œå¸Œæœ›è½¬å‘åˆ°æœ‹å‹åœˆè®©æ›´å¤šçš„äººçœ‹åˆ°ã€‚</p>
<p>æœ€åçš„æœ€åï¼Œæ„Ÿè°¢è€å¿ƒé˜…è¯»æœ¬æ–‡çš„åŒå­¦ã€‚</p>
<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt="wechat_mp"></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rock
    
    </summary>
    
      <category term="MyCAT" scheme="http://www.yunai.me/categories/MyCAT/"/>
    
    
  </entry>
  
  <entry>
    <title>MyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢</title>
    <link href="http://www.yunai.me/MyCAT/single-db-single-table-select/"/>
    <id>http://www.yunai.me/MyCAT/single-db-single-table-select/</id>
    <published>2017-05-29T16:00:00.000Z</published>
    <updated>2017-07-27T16:54:31.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL</a></li>
<li><a href="#">3. è·å¾—è·¯ç”±ç»“æœ</a></li>
<li><a href="#">4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL</a></li>
<li><a href="#">5. å“åº”æ‰§è¡Œ SQL ç»“æœ</a></li>
<li><a href="#">6. å…¶ä»– ï¼šæ›´æ–° / åˆ é™¤</a></li>
</ul>
<h1>1. æ¦‚è¿°</h1>
<blockquote>
<p>å†…å®¹å½¢æ€ä»¥ é¡ºåºå›¾ + æ ¸å¿ƒä»£ç  ä¸ºä¸»ã€‚<br>
å¦‚æœæœ‰åœ°æ–¹è¡¨è¿°ä¸é”™è¯¯æˆ–è€…ä¸æ¸…æ™°ï¼Œæ¬¢è¿ç•™è¨€ã€‚<br>
å¯¹äºå†…å®¹å½¢æ€ï¼Œéå¸¸çº ç»“ï¼Œå¦‚æœæœ‰å»ºè®®ï¼Œç‰¹åˆ«ç‰¹åˆ«ç‰¹åˆ«æ¬¢è¿æ‚¨æå‡ºã€‚<br>
å¾®ä¿¡å·ï¼šwangwenbin-serverã€‚</p>
</blockquote>
<p>æœ¬æ–‡è®²è§£ ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ æ‰€æ¶‰åŠåˆ°çš„ä»£ç ã€‚</p>
<p>ğŸ˜‚å†…å®¹å’Œ <a href="http://www.yunai.me/Mycat/single-db-single-table-insert/">ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹</a> è¶…çº§ç›¸ä¼¼ï¼Œä¸€æ–¹é¢æœ¬èº«æµç¨‹åŸºæœ¬ç›¸åŒï¼Œå¦å¤–ä¸€æ–¹é¢æ–‡ç« ç»“æ„æ²¡æ‹†åˆ†å¥½ã€‚æˆ‘ä»¬ä½¿ç”¨ ğŸš€ æ ‡è®°å·®å¼‚çš„é€»è¾‘ã€‚</p>
<p>äº¤äº’å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_05_30/01.png" alt="å•åº“å•è¡¨æŸ¥è¯¢ç®€å›¾"></p>
<p>æ•´ä¸ªè¿‡ç¨‹ï¼ŒMyCAT Server æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ¥æ”¶ MySQL Client è¯·æ±‚ï¼Œè§£æ SQLã€‚</li>
<li>è·å¾—è·¯ç”±ç»“æœï¼Œè¿›è¡Œè·¯ç”±ã€‚</li>
<li>è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQLã€‚</li>
<li>å“åº”æ‰§è¡Œç»“æœï¼Œå‘é€ç»“æœç»™ MySQL Clientã€‚</li>
</ol>
<p>æˆ‘ä»¬é€ä¸ªæ­¥éª¤åˆ†æï¼Œä¸€èµ·æ¥çœ‹çœ‹æºç ã€‚</p>
<h1>2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL</h1>
<p><img src="http://www.yunai.me/images/MyCAT/2017_05_30/02.png" alt="ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ01ä¸»æµç¨‹ï¼‰"></p>
<h2>ã€1 - 2ã€‘</h2>
<p>æ¥æ”¶<strong>ä¸€æ¡</strong> MySQL å‘½ä»¤ã€‚åœ¨ã€1ã€‘ä¹‹å‰ï¼Œè¿˜æœ‰è¯·æ±‚æ•°æ®è¯»å–ã€æ‹†æˆå•æ¡ MySQL SQLã€‚</p>
<h2>ã€3ã€‘</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendCommandHandler.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FrontendCommandHandler</span> <span class="keyword">implements</span> <span class="title">NIOHandler</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</div><div class="line"> <span class="number">6</span>:     </div><div class="line"> <span class="number">7</span>:         <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">switch</span> (data[<span class="number">4</span>]) <span class="comment">// </span></div><div class="line"> <span class="number">9</span>:         &#123;</div><div class="line"><span class="number">10</span>:             <span class="keyword">case</span> MySQLPacket.COM_INIT_DB:</div><div class="line"><span class="number">11</span>:                 commands.doInitDB();</div><div class="line"><span class="number">12</span>:                 source.initDB(data);</div><div class="line"><span class="number">13</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">14</span>:             <span class="keyword">case</span> MySQLPacket.COM_QUERY: <span class="comment">// æŸ¥è¯¢å‘½ä»¤</span></div><div class="line"><span class="number">15</span>:                 <span class="comment">// è®¡æ•°æŸ¥è¯¢å‘½ä»¤</span></div><div class="line"><span class="number">16</span>:                 commands.doQuery();</div><div class="line"><span class="number">17</span>:                 <span class="comment">// æ‰§è¡ŒæŸ¥è¯¢å‘½ä»¤</span></div><div class="line"><span class="number">18</span>:                 source.query(data);</div><div class="line"><span class="number">19</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">20</span>:             <span class="keyword">case</span> MySQLPacket.COM_PING:</div><div class="line"><span class="number">21</span>:                 commands.doPing();</div><div class="line"><span class="number">22</span>:                 source.ping();</div><div class="line"><span class="number">23</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">24</span>:             <span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>:     &#125;</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>: &#125;</div></pre></td></tr></table></figure></p>
<p><code>INSERT</code>/<code>SELECT</code>/<code>UPDATE</code>/<code>DELETE</code> ç­‰ SQL å½’å±äº <code>MySQLPacket.COM_QUERY</code>ï¼Œè¯¦ç»†å¯è§ï¼š<a href="http://hutaow.com/blog/2013/11/06/mysql-protocol-analysis/#42-" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMySQLåè®®åˆ†æ#4.2 å®¢æˆ·ç«¯å‘½ä»¤è¯·æ±‚æŠ¥æ–‡ï¼ˆå®¢æˆ·ç«¯ -&gt; æœåŠ¡å™¨ï¼‰ã€‹</a>ã€‚</p>
<h2>ã€4ã€‘</h2>
<p>å°† äºŒè¿›åˆ¶æ•°ç»„ è§£ææˆ SQLã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendConnection.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: 	<span class="comment">// å–å¾—è¯­å¥</span></div><div class="line"> <span class="number">4</span>: 	String sql = <span class="keyword">null</span>;		</div><div class="line"> <span class="number">5</span>: 	<span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>: 		MySQLMessage mm = <span class="keyword">new</span> MySQLMessage(data);</div><div class="line"> <span class="number">7</span>: 		mm.position(<span class="number">5</span>);</div><div class="line"> <span class="number">8</span>: 		sql = mm.readString(charset);</div><div class="line"> <span class="number">9</span>: 	&#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line"><span class="number">10</span>: 		writeErrMessage(ErrorCode.ER_UNKNOWN_CHARACTER_SET, <span class="string">"Unknown charset '"</span> + charset + <span class="string">"'"</span>);</div><div class="line"><span class="number">11</span>: 		<span class="keyword">return</span>;</div><div class="line"><span class="number">12</span>: 	&#125;		</div><div class="line"><span class="number">13</span>: 	<span class="comment">// æ‰§è¡Œè¯­å¥</span></div><div class="line"><span class="number">14</span>: 	<span class="keyword">this</span>.query( sql );</div><div class="line"><span class="number">15</span>: &#125;</div></pre></td></tr></table></figure></p>
<h2>ã€5ã€‘</h2>
<p>è§£æ SQL ç±»å‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerQueryHandler.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">3</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">(String sql)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>: 	<span class="comment">// è§£æ SQL ç±»å‹</span></div><div class="line"> <span class="number">5</span>: 	<span class="keyword">int</span> rs = ServerParse.parse(sql);</div><div class="line"> <span class="number">6</span>: 	<span class="keyword">int</span> sqlType = rs &amp; <span class="number">0xff</span>;</div><div class="line"> <span class="number">7</span>: 	</div><div class="line"> <span class="number">8</span>: 	<span class="keyword">switch</span> (sqlType) &#123;</div><div class="line"> <span class="number">9</span>: 	<span class="comment">//explain sql</span></div><div class="line"><span class="number">10</span>: 	<span class="keyword">case</span> ServerParse.EXPLAIN:</div><div class="line"><span class="number">11</span>: 		ExplainHandler.handle(sql, c, rs &gt;&gt;&gt; <span class="number">8</span>);</div><div class="line"><span class="number">12</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">13</span>: 	<span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">14</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">15</span>: 	<span class="keyword">case</span> ServerParse.SELECT:</div><div class="line"><span class="number">16</span>: 		SelectHandler.handle(sql, c, rs &gt;&gt;&gt; <span class="number">8</span>);</div><div class="line"><span class="number">17</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">18</span>: 	<span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">19</span>: 	<span class="keyword">default</span>:</div><div class="line"><span class="number">20</span>: 		<span class="keyword">if</span>(readOnly)&#123;</div><div class="line"><span class="number">21</span>: 			LOGGER.warn(<span class="keyword">new</span> StringBuilder().append(<span class="string">"User readonly:"</span>).append(sql).toString());</div><div class="line"><span class="number">22</span>: 			c.writeErrMessage(ErrorCode.ER_USER_READ_ONLY, <span class="string">"User readonly"</span>);</div><div class="line"><span class="number">23</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">24</span>: 		&#125;</div><div class="line"><span class="number">25</span>: 		c.execute(sql, rs &amp; <span class="number">0xff</span>);</div><div class="line"><span class="number">26</span>: 	&#125;</div><div class="line"><span class="number">27</span>: &#125;</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>:</div><div class="line"><span class="number">30</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerParse.javaã€‘</span></div><div class="line"><span class="number">31</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">parse</span><span class="params">(String stmt)</span> </span>&#123;</div><div class="line"><span class="number">32</span>: 	<span class="keyword">int</span> length = stmt.length();</div><div class="line"><span class="number">33</span>: 	<span class="comment">//FIX BUG FOR SQL SUCH AS /XXXX/SQL</span></div><div class="line"><span class="number">34</span>: 	<span class="keyword">int</span> rt = -<span class="number">1</span>;</div><div class="line"><span class="number">35</span>: 	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</div><div class="line"><span class="number">36</span>: 		<span class="keyword">switch</span> (stmt.charAt(i)) &#123;</div><div class="line"><span class="number">37</span>: 		<span class="comment">// .... çœç•¥éƒ¨åˆ†case			case 'I':</span></div><div class="line"><span class="number">38</span>: 		<span class="keyword">case</span> <span class="string">'i'</span>:</div><div class="line"><span class="number">39</span>: 			rt = insertCheck(stmt, i);</div><div class="line"><span class="number">40</span>: 			<span class="keyword">if</span> (rt != OTHER) &#123;</div><div class="line"><span class="number">41</span>: 				<span class="keyword">return</span> rt;</div><div class="line"><span class="number">42</span>: 			&#125;</div><div class="line"><span class="number">43</span>: 			<span class="keyword">continue</span>;</div><div class="line"><span class="number">44</span>: 			<span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">45</span>: 		<span class="keyword">case</span> <span class="string">'S'</span>:</div><div class="line"><span class="number">46</span>: 		<span class="keyword">case</span> <span class="string">'s'</span>:</div><div class="line"><span class="number">47</span>: 			rt = sCheck(stmt, i);</div><div class="line"><span class="number">48</span>: 			<span class="keyword">if</span> (rt != OTHER) &#123;</div><div class="line"><span class="number">49</span>: 				<span class="keyword">return</span> rt;</div><div class="line"><span class="number">50</span>: 			&#125;</div><div class="line"><span class="number">51</span>: 			<span class="keyword">continue</span>;</div><div class="line"><span class="number">52</span>: 			<span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">53</span>: 		<span class="keyword">default</span>:</div><div class="line"><span class="number">54</span>: 			<span class="keyword">continue</span>;</div><div class="line"><span class="number">55</span>: 		&#125;</div><div class="line"><span class="number">56</span>: 	&#125;</div><div class="line"><span class="number">57</span>: 	<span class="keyword">return</span> OTHER;</div><div class="line"><span class="number">58</span>: &#125;</div></pre></td></tr></table></figure></p>
<h2>ğŸš€ã€6ã€‘ã€7ã€‘</h2>
<p>è§£æ Select SQL ç±»å‹ï¼Œåˆ†å‘åˆ°å¯¹åº”çš„é€»è¾‘ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€SelectHandler.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String stmt, ServerConnection c, <span class="keyword">int</span> offs)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: 	<span class="keyword">int</span> offset = offs;</div><div class="line"> <span class="number">4</span>: 	<span class="keyword">switch</span> (ServerParseSelect.parse(stmt, offs)) &#123; <span class="comment">// è§£æ Select SQL ç±»å‹</span></div><div class="line"> <span class="number">5</span>: 	<span class="keyword">case</span> ServerParseSelect.VERSION_COMMENT: <span class="comment">// select @@VERSION_COMMENT;</span></div><div class="line"> <span class="number">6</span>: 		SelectVersionComment.response(c);</div><div class="line"> <span class="number">7</span>: 		<span class="keyword">break</span>;</div><div class="line"> <span class="number">8</span>: 	<span class="keyword">case</span> ServerParseSelect.DATABASE: <span class="comment">// select DATABASE();</span></div><div class="line"> <span class="number">9</span>: 		SelectDatabase.response(c);</div><div class="line"><span class="number">10</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">11</span>: 	<span class="keyword">case</span> ServerParseSelect.USER: <span class="comment">// select CURRENT_USER();</span></div><div class="line"><span class="number">12</span>:         SelectUser.response(c);</div><div class="line"><span class="number">13</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">14</span>: 	<span class="keyword">case</span> ServerParseSelect.VERSION: <span class="comment">// select VERSION();</span></div><div class="line"><span class="number">15</span>: 		SelectVersion.response(c);</div><div class="line"><span class="number">16</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">17</span>: 	<span class="keyword">case</span> ServerParseSelect.SESSION_INCREMENT: <span class="comment">// select @@session.auto_increment_increment;</span></div><div class="line"><span class="number">18</span>: 		SessionIncrement.response(c);</div><div class="line"><span class="number">19</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">20</span>: 	<span class="keyword">case</span> ServerParseSelect.SESSION_ISOLATION: <span class="comment">// select @@session.tx_isolation;</span></div><div class="line"><span class="number">21</span>: 		SessionIsolation.response(c);</div><div class="line"><span class="number">22</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">23</span>: 	<span class="keyword">case</span> ServerParseSelect.LAST_INSERT_ID: <span class="comment">// select LAST_INSERT_ID();</span></div><div class="line"><span class="number">24</span>: 		<span class="comment">// ....çœç•¥ä»£ç </span></div><div class="line"><span class="number">25</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">26</span>: 	<span class="keyword">case</span> ServerParseSelect.IDENTITY: <span class="comment">// select @@identity</span></div><div class="line"><span class="number">27</span>: 		<span class="comment">// ....çœç•¥ä»£ç </span></div><div class="line"><span class="number">28</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">29</span>:     <span class="keyword">case</span> ServerParseSelect.SELECT_VAR_ALL: <span class="comment">//</span></div><div class="line"><span class="number">30</span>:         SelectVariables.execute(c,stmt);</div><div class="line"><span class="number">31</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">32</span>:     <span class="keyword">case</span> ServerParseSelect.SESSION_TX_READ_ONLY: <span class="comment">//</span></div><div class="line"><span class="number">33</span>:         SelectTxReadOnly.response(c);</div><div class="line"><span class="number">34</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">35</span>: 	<span class="keyword">default</span>: <span class="comment">// å…¶ä»–ï¼Œä¾‹å¦‚ select * from table</span></div><div class="line"><span class="number">36</span>: 		c.execute(stmt, ServerParse.SELECT);</div><div class="line"><span class="number">37</span>: 	&#125;</div><div class="line"><span class="number">38</span>: &#125;</div><div class="line"><span class="number">39</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerParseSelect.javaã€‘</span></div><div class="line"><span class="number">40</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">parse</span><span class="params">(String stmt, <span class="keyword">int</span> offset)</span> </span>&#123;</div><div class="line"><span class="number">41</span>: 	<span class="keyword">int</span> i = offset;</div><div class="line"><span class="number">42</span>: 	<span class="keyword">for</span> (; i &lt; stmt.length(); ++i) &#123;</div><div class="line"><span class="number">43</span>: 		<span class="keyword">switch</span> (stmt.charAt(i)) &#123;</div><div class="line"><span class="number">44</span>: 		<span class="keyword">case</span> <span class="string">' '</span>:</div><div class="line"><span class="number">45</span>: 			<span class="keyword">continue</span>;</div><div class="line"><span class="number">46</span>: 		<span class="keyword">case</span> <span class="string">'/'</span>:</div><div class="line"><span class="number">47</span>: 		<span class="keyword">case</span> <span class="string">'#'</span>:</div><div class="line"><span class="number">48</span>: 			i = ParseUtil.comment(stmt, i);</div><div class="line"><span class="number">49</span>: 			<span class="keyword">continue</span>;</div><div class="line"><span class="number">50</span>: 		<span class="keyword">case</span> <span class="string">'@'</span>:</div><div class="line"><span class="number">51</span>: 			<span class="keyword">return</span> select2Check(stmt, i);</div><div class="line"><span class="number">52</span>: 		<span class="keyword">case</span> <span class="string">'D'</span>:</div><div class="line"><span class="number">53</span>: 		<span class="keyword">case</span> <span class="string">'d'</span>:</div><div class="line"><span class="number">54</span>: 			<span class="keyword">return</span> databaseCheck(stmt, i);</div><div class="line"><span class="number">55</span>: 		<span class="keyword">case</span> <span class="string">'L'</span>:</div><div class="line"><span class="number">56</span>: 		<span class="keyword">case</span> <span class="string">'l'</span>:</div><div class="line"><span class="number">57</span>: 			<span class="keyword">return</span> lastInsertCheck(stmt, i);</div><div class="line"><span class="number">58</span>: 		<span class="keyword">case</span> <span class="string">'U'</span>:</div><div class="line"><span class="number">59</span>: 		<span class="keyword">case</span> <span class="string">'u'</span>:</div><div class="line"><span class="number">60</span>: 			<span class="keyword">return</span> userCheck(stmt, i);</div><div class="line"><span class="number">61</span>: 		<span class="keyword">case</span> <span class="string">'C'</span>:</div><div class="line"><span class="number">62</span>: 		<span class="keyword">case</span> <span class="string">'c'</span>:</div><div class="line"><span class="number">63</span>: 			<span class="keyword">return</span> currentUserCheck(stmt, i);</div><div class="line"><span class="number">64</span>: 		<span class="keyword">case</span> <span class="string">'V'</span>:</div><div class="line"><span class="number">65</span>: 		<span class="keyword">case</span> <span class="string">'v'</span>:</div><div class="line"><span class="number">66</span>: 			<span class="keyword">return</span> versionCheck(stmt, i);</div><div class="line"><span class="number">67</span>: 		<span class="keyword">default</span>:</div><div class="line"><span class="number">68</span>: 			<span class="keyword">return</span> OTHER;</div><div class="line"><span class="number">69</span>: 		&#125;</div><div class="line"><span class="number">70</span>: 	&#125;</div><div class="line"><span class="number">71</span>: 	<span class="keyword">return</span> OTHER;</div><div class="line"><span class="number">72</span>: &#125;</div></pre></td></tr></table></figure></p>
<h2>ã€8ã€‘</h2>
<p>æ‰§è¡Œ SQLï¼Œè¯¦ç»†è§£æè§ä¸‹æ–‡ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerConnection.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerConnection</span> <span class="keyword">extends</span> <span class="title">FrontendConnection</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: 	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(String sql, <span class="keyword">int</span> type)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>: 		<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"> <span class="number">5</span>: 		SchemaConfig schema = MycatServer.getInstance().getConfig().getSchemas().get(db);</div><div class="line"> <span class="number">6</span>: 		<span class="keyword">if</span> (schema == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">7</span>: 			writeErrMessage(ErrorCode.ERR_BAD_LOGICDB,</div><div class="line"> <span class="number">8</span>: 					<span class="string">"Unknown MyCAT Database '"</span> + db + <span class="string">"'"</span>);</div><div class="line"> <span class="number">9</span>: 			<span class="keyword">return</span>;</div><div class="line"><span class="number">10</span>: 		&#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: 		<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>: 		<span class="comment">// è·¯ç”±åˆ°åç«¯æ•°æ®åº“ï¼Œæ‰§è¡Œ SQL</span></div><div class="line"><span class="number">15</span>: 		routeEndExecuteSQL(sql, type, schema);</div><div class="line"><span class="number">16</span>: 	&#125;</div><div class="line"><span class="number">17</span>: 	</div><div class="line"><span class="number">18</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">routeEndExecuteSQL</span><span class="params">(String sql, <span class="keyword">final</span> <span class="keyword">int</span> type, <span class="keyword">final</span> SchemaConfig schema)</span> </span>&#123;</div><div class="line"><span class="number">19</span>: 		<span class="comment">// è·¯ç”±è®¡ç®—</span></div><div class="line"><span class="number">20</span>: 		RouteResultset rrs = <span class="keyword">null</span>;</div><div class="line"><span class="number">21</span>: 		<span class="keyword">try</span> &#123;</div><div class="line"><span class="number">22</span>: 			rrs = MycatServer</div><div class="line"><span class="number">23</span>: 					.getInstance()</div><div class="line"><span class="number">24</span>: 					.getRouterservice()</div><div class="line"><span class="number">25</span>: 					.route(MycatServer.getInstance().getConfig().getSystem(),</div><div class="line"><span class="number">26</span>: 							schema, type, sql, <span class="keyword">this</span>.charset, <span class="keyword">this</span>);</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>: 		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">29</span>: 			StringBuilder s = <span class="keyword">new</span> StringBuilder();</div><div class="line"><span class="number">30</span>: 			LOGGER.warn(s.append(<span class="keyword">this</span>).append(sql).toString() + <span class="string">" err:"</span> + e.toString(),e);</div><div class="line"><span class="number">31</span>: 			String msg = e.getMessage();</div><div class="line"><span class="number">32</span>: 			writeErrMessage(ErrorCode.ER_PARSE_ERROR, msg == <span class="keyword">null</span> ? e.getClass().getSimpleName() : msg);</div><div class="line"><span class="number">33</span>: 			<span class="keyword">return</span>;</div><div class="line"><span class="number">34</span>: 		&#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>: 		<span class="comment">// æ‰§è¡Œ SQL</span></div><div class="line"><span class="number">37</span>: 		<span class="keyword">if</span> (rrs != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">38</span>: 			<span class="comment">// sessionæ‰§è¡Œ</span></div><div class="line"><span class="number">39</span>: 			session.execute(rrs, rrs.isSelectForUpdate() ? ServerParse.UPDATE : type);</div><div class="line"><span class="number">40</span>: 		&#125;</div><div class="line"><span class="number">41</span>: 		</div><div class="line"><span class="number">42</span>:  	&#125;</div><div class="line"><span class="number">43</span>: </div><div class="line"><span class="number">44</span>: &#125;</div></pre></td></tr></table></figure></p>
<h1>3. è·å¾—è·¯ç”±ç»“æœ</h1>
<p><img src="http://www.yunai.me/images/MyCAT/2017_05_30/03.png" alt="ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ02è·å–è·¯ç”±ï¼‰"></p>
<h2>ã€ 1 -  5 ã€‘</h2>
<p>è·å¾—è·¯ç”±ä¸»æµç¨‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€SelectHandler.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> RouteResultset <span class="title">route</span><span class="params">(SystemConfig sysconf, SchemaConfig schema,</span></span></div><div class="line"> <span class="number">3</span>: 		<span class="keyword">int</span> sqlType, String stmt, String charset, ServerConnection sc)</div><div class="line"> 4: 		<span class="keyword">throws</span> SQLNonTransientException &#123;</div><div class="line"> <span class="number">5</span>: 	RouteResultset rrs = <span class="keyword">null</span>;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>: 	<span class="comment">// SELECT ç±»å‹çš„SQL, æ£€æµ‹ç¼“å­˜æ˜¯å¦å­˜åœ¨</span></div><div class="line"> <span class="number">8</span>: 	<span class="keyword">if</span> (sqlType == ServerParse.SELECT) &#123;</div><div class="line"> <span class="number">9</span>: 		cacheKey = schema.getName() + stmt;			</div><div class="line"><span class="number">10</span>: 		rrs = (RouteResultset) sqlRouteCache.get(cacheKey);</div><div class="line"><span class="number">11</span>: 		<span class="keyword">if</span> (rrs != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">12</span>: 			checkMigrateRule(schema.getName(),rrs,sqlType);</div><div class="line"><span class="number">13</span>: 			<span class="keyword">return</span> rrs;</div><div class="line"><span class="number">14</span>: 			&#125;</div><div class="line"><span class="number">15</span>: 		&#125;</div><div class="line"><span class="number">16</span>: 	&#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>: 	<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"><span class="number">19</span>: 	<span class="keyword">int</span> hintLength = RouteService.isHintSql(stmt);</div><div class="line"><span class="number">20</span>: 	<span class="keyword">if</span>(hintLength != -<span class="number">1</span>)&#123; <span class="comment">// TODO å¾…è¯»ï¼šhint</span></div><div class="line"><span class="number">21</span>: 		<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"><span class="number">22</span>: 		&#125;</div><div class="line"><span class="number">23</span>: 	&#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">24</span>: 		stmt = stmt.trim();</div><div class="line"><span class="number">25</span>: 		rrs = RouteStrategyFactory.getRouteStrategy().route(sysconf, schema, sqlType, stmt,</div><div class="line"><span class="number">26</span>: 				charset, sc, tableId2DataNodeCache);</div><div class="line"><span class="number">27</span>: 	&#125;</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>: 	<span class="comment">// è®°å½•æŸ¥è¯¢å‘½ä»¤è·¯ç”±ç»“æœç¼“å­˜</span></div><div class="line"><span class="number">30</span>: 	<span class="keyword">if</span> (rrs != <span class="keyword">null</span> &amp;&amp; sqlType == ServerParse.SELECT &amp;&amp; rrs.isCacheAble()) &#123;</div><div class="line"><span class="number">31</span>: 		sqlRouteCache.putIfAbsent(cacheKey, rrs);</div><div class="line"><span class="number">32</span>: 	&#125;</div><div class="line"><span class="number">33</span>: 	<span class="comment">// .... çœç•¥ä»£ç 		return rrs;</span></div><div class="line"><span class="number">34</span>: &#125;</div><div class="line"><span class="number">35</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘</span></div><div class="line"><span class="number">36</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">37</span>: <span class="function"><span class="keyword">public</span> RouteResultset <span class="title">route</span><span class="params">(SystemConfig sysConfig, SchemaConfig schema, <span class="keyword">int</span> sqlType, String origSQL,</span></span></div><div class="line"><span class="number">38</span>: 		String charset, ServerConnection sc, LayerCachePool cachePool) <span class="keyword">throws</span> SQLNonTransientException &#123;</div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>: 	<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"><span class="number">41</span>: </div><div class="line"><span class="number">42</span>: 	<span class="comment">// å¤„ç†ä¸€äº›è·¯ç”±ä¹‹å‰çš„é€»è¾‘;å…¨å±€åºåˆ—å·ï¼Œçˆ¶å­è¡¨æ’å…¥</span></div><div class="line"><span class="number">43</span>: 	<span class="keyword">if</span> (beforeRouteProcess(schema, sqlType, origSQL, sc) ) &#123;</div><div class="line"><span class="number">44</span>: 		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">45</span>: 	&#125;</div><div class="line"><span class="number">46</span>: </div><div class="line"><span class="number">47</span>: 	<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"><span class="number">48</span>: </div><div class="line"><span class="number">49</span>: 	<span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰åˆ†ç‰‡</span></div><div class="line"><span class="number">50</span>: 	<span class="keyword">if</span> (schema.isNoSharding() &amp;&amp; ServerParse.SHOW != sqlType) &#123;</div><div class="line"><span class="number">51</span>: 		rrs = RouterUtil.routeToSingleNode(rrs, schema.getDataNode(), stmt);</div><div class="line"><span class="number">52</span>: 	&#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">53</span>: 		RouteResultset returnedSet = routeSystemInfo(schema, sqlType, stmt, rrs);</div><div class="line"><span class="number">54</span>: 		<span class="keyword">if</span> (returnedSet == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">55</span>: 			rrs = routeNormalSqlWithAST(schema, stmt, rrs, charset, cachePool,sqlType,sc);</div><div class="line"><span class="number">56</span>: 		&#125;</div><div class="line"><span class="number">57</span>: 	&#125;</div><div class="line"><span class="number">58</span>: </div><div class="line"><span class="number">59</span>: 	<span class="keyword">return</span> rrs;</div><div class="line"><span class="number">60</span>: &#125;</div></pre></td></tr></table></figure></p>
<p>ğŸš€ã€3ã€‘ç¬¬ 7 è‡³ 16 è¡Œ ï¼šå½“ Select SQL å­˜åœ¨è·¯ç”±ç»“æœç¼“å­˜æ—¶ï¼Œç›´æ¥è¿”å›ç¼“å­˜ã€‚
ğŸš€ã€6ã€‘ç¬¬ 29 è‡³ 32 è¡Œ ï¼šè®°å½• Select SQL è·¯ç”±ç»“æœåˆ°ç¼“å­˜ã€‚</p>
<p><em><strong>è·¯ç”±</strong> è¯¦ç»†è§£æï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ï¼Œé¿å…å†…å®¹è¿‡å¤šï¼Œå½±å“å¤§å®¶å¯¹ã€æ’å…¥ã€‘æµç¨‹å’Œé€»è¾‘çš„ç†è§£ã€‚</em></p>
<h1>4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL</h1>
<p><img src="http://www.yunai.me/images/MyCAT/2017_05_29/03.png" alt="ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ03æ‰§è¡Œ SQLï¼‰"></p>
<h2>ã€ 1 - 8 ã€‘</h2>
<p>è·å¾— MySQL è¿æ¥ã€‚</p>
<ul>
<li>PhysicalDBNode ï¼šç‰©ç†æ•°æ®åº“èŠ‚ç‚¹ã€‚</li>
<li>PhysicalDatasource ï¼šç‰©ç†æ•°æ®åº“æ•°æ®æºã€‚</li>
</ul>
<h2>ã€ 9 - 13 ã€‘</h2>
<p>å‘é€ SQL åˆ° MySQL Serverï¼Œæ‰§è¡Œ SQLã€‚</p>
<h1>ğŸš€ 5. å“åº”æ‰§è¡Œ SQL ç»“æœ</h1>
<p><img src="http://www.yunai.me/images/MyCAT/2017_05_30/04.png" alt="ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰"></p>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MySQLConnectionHandler.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">3</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">handleData</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>: 	<span class="keyword">switch</span> (resultStatus) &#123;</div><div class="line"> <span class="number">5</span>: 	<span class="keyword">case</span> RESULT_STATUS_INIT:</div><div class="line"> <span class="number">6</span>: 		<span class="keyword">switch</span> (data[<span class="number">4</span>]) &#123;</div><div class="line"> <span class="number">7</span>: 		<span class="keyword">case</span> OkPacket.FIELD_COUNT:</div><div class="line"> <span class="number">8</span>: 			handleOkPacket(data);</div><div class="line"> <span class="number">9</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">10</span>: 		<span class="keyword">case</span> ErrorPacket.FIELD_COUNT:</div><div class="line"><span class="number">11</span>: 			handleErrorPacket(data);</div><div class="line"><span class="number">12</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">13</span>: 		<span class="keyword">case</span> RequestFilePacket.FIELD_COUNT:</div><div class="line"><span class="number">14</span>: 			handleRequestPacket(data);</div><div class="line"><span class="number">15</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">16</span>: 		<span class="keyword">default</span>: <span class="comment">// åˆå§‹åŒ– header fields</span></div><div class="line"><span class="number">17</span>: 			resultStatus = RESULT_STATUS_HEADER;</div><div class="line"><span class="number">18</span>: 			header = data;</div><div class="line"><span class="number">19</span>: 			fields = <span class="keyword">new</span> ArrayList&lt;<span class="keyword">byte</span>[]&gt;((<span class="keyword">int</span>) ByteUtil.readLength(data,</div><div class="line"><span class="number">20</span>: 					<span class="number">4</span>));</div><div class="line"><span class="number">21</span>: 		&#125;</div><div class="line"><span class="number">22</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">23</span>: 	<span class="keyword">case</span> RESULT_STATUS_HEADER:</div><div class="line"><span class="number">24</span>: 		<span class="keyword">switch</span> (data[<span class="number">4</span>]) &#123;</div><div class="line"><span class="number">25</span>: 		<span class="keyword">case</span> ErrorPacket.FIELD_COUNT:</div><div class="line"><span class="number">26</span>: 			resultStatus = RESULT_STATUS_INIT;</div><div class="line"><span class="number">27</span>: 			handleErrorPacket(data);</div><div class="line"><span class="number">28</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">29</span>: 		<span class="keyword">case</span> EOFPacket.FIELD_COUNT: <span class="comment">// è§£æ fields ç»“æŸ</span></div><div class="line"><span class="number">30</span>: 			resultStatus = RESULT_STATUS_FIELD_EOF;</div><div class="line"><span class="number">31</span>: 			handleFieldEofPacket(data);</div><div class="line"><span class="number">32</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">33</span>: 		<span class="keyword">default</span>: <span class="comment">// è§£æ fields</span></div><div class="line"><span class="number">34</span>: 			fields.add(data);</div><div class="line"><span class="number">35</span>: 		&#125;</div><div class="line"><span class="number">36</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">37</span>: 	<span class="keyword">case</span> RESULT_STATUS_FIELD_EOF:</div><div class="line"><span class="number">38</span>: 		<span class="keyword">switch</span> (data[<span class="number">4</span>]) &#123;</div><div class="line"><span class="number">39</span>: 		<span class="keyword">case</span> ErrorPacket.FIELD_COUNT:</div><div class="line"><span class="number">40</span>: 			resultStatus = RESULT_STATUS_INIT;</div><div class="line"><span class="number">41</span>: 			handleErrorPacket(data);</div><div class="line"><span class="number">42</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">43</span>: 		<span class="keyword">case</span> EOFPacket.FIELD_COUNT: <span class="comment">// è§£æ æ¯è¡Œè®°å½• ç»“æŸ</span></div><div class="line"><span class="number">44</span>: 			resultStatus = RESULT_STATUS_INIT;</div><div class="line"><span class="number">45</span>: 			handleRowEofPacket(data);</div><div class="line"><span class="number">46</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">47</span>: 		<span class="keyword">default</span>: <span class="comment">// æ¯è¡Œè®°å½•</span></div><div class="line"><span class="number">48</span>: 			handleRowPacket(data);</div><div class="line"><span class="number">49</span>: 		&#125;</div><div class="line"><span class="number">50</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">51</span>: 	<span class="keyword">default</span>:</div><div class="line"><span class="number">52</span>: 		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"unknown status!"</span>);</div><div class="line"><span class="number">53</span>: 	&#125;</div><div class="line"><span class="number">54</span>: &#125;</div></pre></td></tr></table></figure></p>
<h1>6. å…¶ä»– ï¼šæ›´æ–° / åˆ é™¤</h1>
<p>æµç¨‹åŸºæœ¬å’Œ <a href="http://www.yunai.me/Mycat/single-db-single-table-insert/">ã€ŠMyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹</a> ç›¸åŒã€‚æˆ‘ä»¬å°±ä¸å¦å¤–æ–‡ç« è§£æã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rock
    
    </summary>
    
      <category term="MyCAT" scheme="http://www.yunai.me/categories/MyCAT/"/>
    
    
  </entry>
  
  <entry>
    <title>MyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æ’å…¥</title>
    <link href="http://www.yunai.me/MyCAT/single-db-single-table-insert/"/>
    <id>http://www.yunai.me/MyCAT/single-db-single-table-insert/</id>
    <published>2017-05-28T16:00:00.000Z</published>
    <updated>2017-07-27T16:54:27.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL</a></li>
<li><a href="#">3. è·å¾—è·¯ç”±ç»“æœ</a></li>
<li><a href="#">4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL</a></li>
<li><a href="#">5. å“åº”æ‰§è¡Œ SQL ç»“æœ</a></li>
</ul>
<h1>1. æ¦‚è¿°</h1>
<blockquote>
<p>å†…å®¹å½¢æ€ä»¥ é¡ºåºå›¾ + æ ¸å¿ƒä»£ç  ä¸ºä¸»ã€‚<br>
å¦‚æœæœ‰åœ°æ–¹è¡¨è¿°ä¸é”™è¯¯æˆ–è€…ä¸æ¸…æ™°ï¼Œæ¬¢è¿ç•™è¨€ã€‚<br>
å¯¹äºå†…å®¹å½¢æ€ï¼Œéå¸¸çº ç»“ï¼Œå¦‚æœæœ‰å»ºè®®ï¼Œç‰¹åˆ«ç‰¹åˆ«ç‰¹åˆ«æ¬¢è¿æ‚¨æå‡ºã€‚<br>
å¾®ä¿¡å·ï¼šwangwenbin-serverã€‚</p>
</blockquote>
<p>æœ¬æ–‡è®²è§£ ã€å•åº“å•è¡¨ã€‘æ’å…¥ æ‰€æ¶‰åŠåˆ°çš„ä»£ç ã€‚äº¤äº’å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_05_29/05.png" alt="å•åº“å•è¡¨æ’å…¥ç®€å›¾"></p>
<p>æ•´ä¸ªè¿‡ç¨‹ï¼ŒMyCAT Server æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ¥æ”¶ MySQL Client è¯·æ±‚ï¼Œè§£æ SQLã€‚</li>
<li>è·å¾—è·¯ç”±ç»“æœï¼Œè¿›è¡Œè·¯ç”±ã€‚</li>
<li>è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQLã€‚</li>
<li>å“åº”æ‰§è¡Œç»“æœï¼Œå‘é€ç»“æœç»™ MySQL Clientã€‚</li>
</ol>
<p>æˆ‘ä»¬é€ä¸ªæ­¥éª¤åˆ†æï¼Œä¸€èµ·æ¥çœ‹çœ‹æºç ã€‚</p>
<h1>2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL</h1>
<p><img src="http://www.yunai.me/images/MyCAT/2017_05_29/01.png" alt="ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ01ä¸»æµç¨‹ï¼‰"></p>
<h2>ã€ 1 - 2 ã€‘</h2>
<p>æ¥æ”¶<strong>ä¸€æ¡</strong> MySQL å‘½ä»¤ã€‚åœ¨ã€1ã€‘ä¹‹å‰ï¼Œè¿˜æœ‰è¯·æ±‚æ•°æ®è¯»å–ã€æ‹†æˆå•æ¡ MySQL SQLã€‚</p>
<h2>ã€ 3 ã€‘</h2>
<p>ä¸åŒ MySQL å‘½ä»¤ï¼Œåˆ†å‘åˆ°ä¸åŒçš„æ–¹æ³•æ‰§è¡Œã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendCommandHandler.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FrontendCommandHandler</span> <span class="keyword">implements</span> <span class="title">NIOHandler</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</div><div class="line"> <span class="number">6</span>:     </div><div class="line"> <span class="number">7</span>:         <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">switch</span> (data[<span class="number">4</span>]) <span class="comment">// </span></div><div class="line"> <span class="number">9</span>:         &#123;</div><div class="line"><span class="number">10</span>:             <span class="keyword">case</span> MySQLPacket.COM_INIT_DB:</div><div class="line"><span class="number">11</span>:                 commands.doInitDB();</div><div class="line"><span class="number">12</span>:                 source.initDB(data);</div><div class="line"><span class="number">13</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">14</span>:             <span class="keyword">case</span> MySQLPacket.COM_QUERY: <span class="comment">// æŸ¥è¯¢å‘½ä»¤</span></div><div class="line"><span class="number">15</span>:                 <span class="comment">// è®¡æ•°æŸ¥è¯¢å‘½ä»¤</span></div><div class="line"><span class="number">16</span>:                 commands.doQuery();</div><div class="line"><span class="number">17</span>:                 <span class="comment">// æ‰§è¡ŒæŸ¥è¯¢å‘½ä»¤</span></div><div class="line"><span class="number">18</span>:                 source.query(data);</div><div class="line"><span class="number">19</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">20</span>:             <span class="keyword">case</span> MySQLPacket.COM_PING:</div><div class="line"><span class="number">21</span>:                 commands.doPing();</div><div class="line"><span class="number">22</span>:                 source.ping();</div><div class="line"><span class="number">23</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">24</span>:             <span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>:     &#125;</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>: &#125;</div></pre></td></tr></table></figure></p>
<p><code>INSERT</code>/<code>SELECT</code>/<code>UPDATE</code>/<code>DELETE</code> ç­‰ SQL å½’å±äº <code>MySQLPacket.COM_QUERY</code>ï¼Œè¯¦ç»†å¯è§ï¼š<a href="http://hutaow.com/blog/2013/11/06/mysql-protocol-analysis/#42-" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMySQLåè®®åˆ†æ#4.2 å®¢æˆ·ç«¯å‘½ä»¤è¯·æ±‚æŠ¥æ–‡ï¼ˆå®¢æˆ·ç«¯ -&gt; æœåŠ¡å™¨ï¼‰ã€‹</a>ã€‚</p>
<p>##ã€ 4 ã€‘</p>
<p>å°† äºŒè¿›åˆ¶æ•°ç»„ è§£ææˆ SQLã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendConnection.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: 	<span class="comment">// å–å¾—è¯­å¥</span></div><div class="line"> <span class="number">4</span>: 	String sql = <span class="keyword">null</span>;		</div><div class="line"> <span class="number">5</span>: 	<span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>: 		MySQLMessage mm = <span class="keyword">new</span> MySQLMessage(data);</div><div class="line"> <span class="number">7</span>: 		mm.position(<span class="number">5</span>);</div><div class="line"> <span class="number">8</span>: 		sql = mm.readString(charset);</div><div class="line"> <span class="number">9</span>: 	&#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line"><span class="number">10</span>: 		writeErrMessage(ErrorCode.ER_UNKNOWN_CHARACTER_SET, <span class="string">"Unknown charset '"</span> + charset + <span class="string">"'"</span>);</div><div class="line"><span class="number">11</span>: 		<span class="keyword">return</span>;</div><div class="line"><span class="number">12</span>: 	&#125;		</div><div class="line"><span class="number">13</span>: 	<span class="comment">// æ‰§è¡Œè¯­å¥</span></div><div class="line"><span class="number">14</span>: 	<span class="keyword">this</span>.query( sql );</div><div class="line"><span class="number">15</span>: &#125;</div></pre></td></tr></table></figure></p>
<p>##ã€ 5 ã€‘</p>
<p>è§£æ SQL ç±»å‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerQueryHandler.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">3</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">(String sql)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>: 	<span class="comment">// è§£æ SQL ç±»å‹</span></div><div class="line"> <span class="number">5</span>: 	<span class="keyword">int</span> rs = ServerParse.parse(sql);</div><div class="line"> <span class="number">6</span>: 	<span class="keyword">int</span> sqlType = rs &amp; <span class="number">0xff</span>;</div><div class="line"> <span class="number">7</span>: 	</div><div class="line"> <span class="number">8</span>: 	<span class="keyword">switch</span> (sqlType) &#123;</div><div class="line"> <span class="number">9</span>: 	<span class="comment">//explain sql</span></div><div class="line"><span class="number">10</span>: 	<span class="keyword">case</span> ServerParse.EXPLAIN:</div><div class="line"><span class="number">11</span>: 		ExplainHandler.handle(sql, c, rs &gt;&gt;&gt; <span class="number">8</span>);</div><div class="line"><span class="number">12</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">13</span>: 	<span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">14</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">15</span>: 	<span class="keyword">case</span> ServerParse.SELECT:</div><div class="line"><span class="number">16</span>: 		SelectHandler.handle(sql, c, rs &gt;&gt;&gt; <span class="number">8</span>);</div><div class="line"><span class="number">17</span>: 		<span class="keyword">break</span>;</div><div class="line"><span class="number">18</span>: 	<span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">19</span>: 	<span class="keyword">default</span>:</div><div class="line"><span class="number">20</span>: 		<span class="keyword">if</span>(readOnly)&#123;</div><div class="line"><span class="number">21</span>: 			LOGGER.warn(<span class="keyword">new</span> StringBuilder().append(<span class="string">"User readonly:"</span>).append(sql).toString());</div><div class="line"><span class="number">22</span>: 			c.writeErrMessage(ErrorCode.ER_USER_READ_ONLY, <span class="string">"User readonly"</span>);</div><div class="line"><span class="number">23</span>: 			<span class="keyword">break</span>;</div><div class="line"><span class="number">24</span>: 		&#125;</div><div class="line"><span class="number">25</span>: 		c.execute(sql, rs &amp; <span class="number">0xff</span>);</div><div class="line"><span class="number">26</span>: 	&#125;</div><div class="line"><span class="number">27</span>: &#125;</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>:</div><div class="line"><span class="number">30</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerParse.javaã€‘</span></div><div class="line"><span class="number">31</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">parse</span><span class="params">(String stmt)</span> </span>&#123;</div><div class="line"><span class="number">32</span>: 	<span class="keyword">int</span> length = stmt.length();</div><div class="line"><span class="number">33</span>: 	<span class="comment">//FIX BUG FOR SQL SUCH AS /XXXX/SQL</span></div><div class="line"><span class="number">34</span>: 	<span class="keyword">int</span> rt = -<span class="number">1</span>;</div><div class="line"><span class="number">35</span>: 	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</div><div class="line"><span class="number">36</span>: 		<span class="keyword">switch</span> (stmt.charAt(i)) &#123;</div><div class="line"><span class="number">37</span>: 		<span class="comment">// .... çœç•¥éƒ¨åˆ†case			case 'I':</span></div><div class="line"><span class="number">38</span>: 		<span class="keyword">case</span> <span class="string">'i'</span>:</div><div class="line"><span class="number">39</span>: 			rt = insertCheck(stmt, i);</div><div class="line"><span class="number">40</span>: 			<span class="keyword">if</span> (rt != OTHER) &#123;</div><div class="line"><span class="number">41</span>: 				<span class="keyword">return</span> rt;</div><div class="line"><span class="number">42</span>: 			&#125;</div><div class="line"><span class="number">43</span>: 			<span class="keyword">continue</span>;</div><div class="line"><span class="number">44</span>: 			<span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">45</span>: 		<span class="keyword">case</span> <span class="string">'S'</span>:</div><div class="line"><span class="number">46</span>: 		<span class="keyword">case</span> <span class="string">'s'</span>:</div><div class="line"><span class="number">47</span>: 			rt = sCheck(stmt, i);</div><div class="line"><span class="number">48</span>: 			<span class="keyword">if</span> (rt != OTHER) &#123;</div><div class="line"><span class="number">49</span>: 				<span class="keyword">return</span> rt;</div><div class="line"><span class="number">50</span>: 			&#125;</div><div class="line"><span class="number">51</span>: 			<span class="keyword">continue</span>;</div><div class="line"><span class="number">52</span>: 			<span class="comment">// .... çœç•¥éƒ¨åˆ†case</span></div><div class="line"><span class="number">53</span>: 		<span class="keyword">default</span>:</div><div class="line"><span class="number">54</span>: 			<span class="keyword">continue</span>;</div><div class="line"><span class="number">55</span>: 		&#125;</div><div class="line"><span class="number">56</span>: 	&#125;</div><div class="line"><span class="number">57</span>: 	<span class="keyword">return</span> OTHER;</div><div class="line"><span class="number">58</span>: &#125;</div></pre></td></tr></table></figure></p>
<p>##ã€ 6 ã€‘</p>
<p>æ‰§è¡Œ SQLï¼Œè¯¦ç»†è§£æè§ä¸‹æ–‡ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerConnection.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerConnection</span> <span class="keyword">extends</span> <span class="title">FrontendConnection</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: 	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(String sql, <span class="keyword">int</span> type)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>: 		<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"> <span class="number">5</span>: 		SchemaConfig schema = MycatServer.getInstance().getConfig().getSchemas().get(db);</div><div class="line"> <span class="number">6</span>: 		<span class="keyword">if</span> (schema == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">7</span>: 			writeErrMessage(ErrorCode.ERR_BAD_LOGICDB,</div><div class="line"> <span class="number">8</span>: 					<span class="string">"Unknown MyCAT Database '"</span> + db + <span class="string">"'"</span>);</div><div class="line"> <span class="number">9</span>: 			<span class="keyword">return</span>;</div><div class="line"><span class="number">10</span>: 		&#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: 		<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>: 		<span class="comment">// è·¯ç”±åˆ°åç«¯æ•°æ®åº“ï¼Œæ‰§è¡Œ SQL</span></div><div class="line"><span class="number">15</span>: 		routeEndExecuteSQL(sql, type, schema);</div><div class="line"><span class="number">16</span>: 	&#125;</div><div class="line"><span class="number">17</span>: 	</div><div class="line"><span class="number">18</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">routeEndExecuteSQL</span><span class="params">(String sql, <span class="keyword">final</span> <span class="keyword">int</span> type, <span class="keyword">final</span> SchemaConfig schema)</span> </span>&#123;</div><div class="line"><span class="number">19</span>: 		<span class="comment">// è·¯ç”±è®¡ç®—</span></div><div class="line"><span class="number">20</span>: 		RouteResultset rrs = <span class="keyword">null</span>;</div><div class="line"><span class="number">21</span>: 		<span class="keyword">try</span> &#123;</div><div class="line"><span class="number">22</span>: 			rrs = MycatServer</div><div class="line"><span class="number">23</span>: 					.getInstance()</div><div class="line"><span class="number">24</span>: 					.getRouterservice()</div><div class="line"><span class="number">25</span>: 					.route(MycatServer.getInstance().getConfig().getSystem(),</div><div class="line"><span class="number">26</span>: 							schema, type, sql, <span class="keyword">this</span>.charset, <span class="keyword">this</span>);</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>: 		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">29</span>: 			StringBuilder s = <span class="keyword">new</span> StringBuilder();</div><div class="line"><span class="number">30</span>: 			LOGGER.warn(s.append(<span class="keyword">this</span>).append(sql).toString() + <span class="string">" err:"</span> + e.toString(),e);</div><div class="line"><span class="number">31</span>: 			String msg = e.getMessage();</div><div class="line"><span class="number">32</span>: 			writeErrMessage(ErrorCode.ER_PARSE_ERROR, msg == <span class="keyword">null</span> ? e.getClass().getSimpleName() : msg);</div><div class="line"><span class="number">33</span>: 			<span class="keyword">return</span>;</div><div class="line"><span class="number">34</span>: 		&#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>: 		<span class="comment">// æ‰§è¡Œ SQL</span></div><div class="line"><span class="number">37</span>: 		<span class="keyword">if</span> (rrs != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">38</span>: 			<span class="comment">// sessionæ‰§è¡Œ</span></div><div class="line"><span class="number">39</span>: 			session.execute(rrs, rrs.isSelectForUpdate() ? ServerParse.UPDATE : type);</div><div class="line"><span class="number">40</span>: 		&#125;</div><div class="line"><span class="number">41</span>: 		</div><div class="line"><span class="number">42</span>:  	&#125;</div><div class="line"><span class="number">43</span>: </div><div class="line"><span class="number">44</span>: &#125;</div></pre></td></tr></table></figure></p>
<h1>3. è·å¾—è·¯ç”±ç»“æœ</h1>
<p><img src="http://www.yunai.me/images/MyCAT/2017_05_29/02.png" alt="ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ02è·å–è·¯ç”±ï¼‰"></p>
<h2>ã€ 1 - 2 ã€‘ã€ 12 ã€‘</h2>
<p>è·å¾—è·¯ç”±ä¸»æµç¨‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RouteService.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> RouteResultset <span class="title">route</span><span class="params">(SystemConfig sysconf, SchemaConfig schema,</span></span></div><div class="line"> <span class="number">3</span>: 		<span class="keyword">int</span> sqlType, String stmt, String charset, ServerConnection sc)</div><div class="line"> 4: 		<span class="keyword">throws</span> SQLNonTransientException &#123;</div><div class="line"> <span class="number">5</span>: 	RouteResultset rrs = <span class="keyword">null</span>;</div><div class="line"> <span class="number">6</span>: 	<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"> <span class="number">7</span>: 	<span class="keyword">int</span> hintLength = RouteService.isHintSql(stmt);</div><div class="line"> <span class="number">8</span>: 	<span class="keyword">if</span>(hintLength != -<span class="number">1</span>)&#123; <span class="comment">// TODO å¾…è¯»ï¼šhint</span></div><div class="line"> <span class="number">9</span>: 		<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"><span class="number">10</span>: 		&#125;</div><div class="line"><span class="number">11</span>: 	&#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">12</span>: 		stmt = stmt.trim();</div><div class="line"><span class="number">13</span>: 		rrs = RouteStrategyFactory.getRouteStrategy().route(sysconf, schema, sqlType, stmt,</div><div class="line"><span class="number">14</span>: 				charset, sc, tableId2DataNodeCache);</div><div class="line"><span class="number">15</span>: 	&#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: 	<span class="comment">// .... çœç•¥ä»£ç 		return rrs;</span></div><div class="line"><span class="number">18</span>: &#125;</div><div class="line"><span class="number">19</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘</span></div><div class="line"><span class="number">20</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">21</span>: <span class="function"><span class="keyword">public</span> RouteResultset <span class="title">route</span><span class="params">(SystemConfig sysConfig, SchemaConfig schema, <span class="keyword">int</span> sqlType, String origSQL,</span></span></div><div class="line"><span class="number">22</span>: 		String charset, ServerConnection sc, LayerCachePool cachePool) <span class="keyword">throws</span> SQLNonTransientException &#123;</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>: 	<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>: 	<span class="comment">// å¤„ç†ä¸€äº›è·¯ç”±ä¹‹å‰çš„é€»è¾‘;å…¨å±€åºåˆ—å·ï¼Œçˆ¶å­è¡¨æ’å…¥</span></div><div class="line"><span class="number">27</span>: 	<span class="keyword">if</span> (beforeRouteProcess(schema, sqlType, origSQL, sc) ) &#123;</div><div class="line"><span class="number">28</span>: 		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">29</span>: 	&#125;</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>: 	<span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>: 	<span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰åˆ†ç‰‡</span></div><div class="line"><span class="number">34</span>: 	<span class="keyword">if</span> (schema.isNoSharding() &amp;&amp; ServerParse.SHOW != sqlType) &#123;</div><div class="line"><span class="number">35</span>: 		rrs = RouterUtil.routeToSingleNode(rrs, schema.getDataNode(), stmt);</div><div class="line"><span class="number">36</span>: 	&#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">37</span>: 		RouteResultset returnedSet = routeSystemInfo(schema, sqlType, stmt, rrs);</div><div class="line"><span class="number">38</span>: 		<span class="keyword">if</span> (returnedSet == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">39</span>: 			rrs = routeNormalSqlWithAST(schema, stmt, rrs, charset, cachePool,sqlType,sc);</div><div class="line"><span class="number">40</span>: 		&#125;</div><div class="line"><span class="number">41</span>: 	&#125;</div><div class="line"><span class="number">42</span>: </div><div class="line"><span class="number">43</span>: 	<span class="keyword">return</span> rrs;</div><div class="line"><span class="number">44</span>: &#125;</div></pre></td></tr></table></figure></p>
<p><em><strong>è·¯ç”±</strong> è¯¦ç»†è§£æï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ï¼Œé¿å…å†…å®¹è¿‡å¤šï¼Œå½±å“å¤§å®¶å¯¹ã€æ’å…¥ã€‘æµç¨‹å’Œé€»è¾‘çš„ç†è§£ã€‚</em></p>
<h2>ã€ 3 - 6 ã€‘</h2>
<p>è·¯ç”±<strong>å‰ç½®</strong>å¤„ç†ã€‚å½“ç¬¦åˆå¦‚ä¸‹ä¸‰ç§æƒ…å†µä¸‹ï¼Œè¿›è¡Œå¤„ç†ï¼š</p>
<p>{ 1 } ä½¿ç”¨<strong>å…¨å±€åºåˆ—å·</strong>ï¼š</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> (<span class="keyword">id</span>, <span class="keyword">name</span>) <span class="keyword">values</span> (<span class="keyword">NEXT</span> <span class="keyword">VALUE</span> <span class="keyword">FOR</span> MYCATSEQ_ID, <span class="string">'name'</span>)</div></pre></td></tr></table></figure></p>
<p>{ 2 } ER å­è¡¨æ’å…¥<br>
{ 3 } ä¸»é”®ä½¿ç”¨è‡ªå¢ ID æ’å…¥ï¼š</p>
<p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">insert into table (name) values ('name')</div><div class="line">===&gt;</div><div class="line">insert into table (id, name) values (NEXT VALUE FOR MYCATSEQ_ID, 'name')</div><div class="line">```  </div><div class="line"></div><div class="line">æƒ…å†µ &#123; 1 &#125; &#123; 3 &#125; æƒ…å†µç±»ä¼¼ï¼Œä½¿ç”¨å…¨å±€åºåˆ—å·ã€‚</div><div class="line"></div><div class="line">æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</div><div class="line"></div><div class="line">```Java</div><div class="line">  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘</div><div class="line">  2: private boolean beforeRouteProcess(SchemaConfig schema, int sqlType, String origSQL, ServerConnection sc)</div><div class="line">  3: 		throws SQLNonTransientException &#123;</div><div class="line">  4: 	return  // å¤„ç† id ä½¿ç”¨ å…¨å±€åºåˆ—å·</div><div class="line">  5:             RouterUtil.processWithMycatSeq(schema, sqlType, origSQL, sc)</div><div class="line">  6:             // å¤„ç† ER å­è¡¨</div><div class="line">  7: 			|| (sqlType == ServerParse.INSERT &amp;&amp; RouterUtil.processERChildTable(schema, origSQL, sc))</div><div class="line">  8:             // å¤„ç† id è‡ªå¢é•¿</div><div class="line">  9: 			|| (sqlType == ServerParse.INSERT &amp;&amp; RouterUtil.processInsert(schema, sqlType, origSQL, sc));</div><div class="line"> 10: &#125;</div></pre></td></tr></table></figure></p>
<p><code>RouterUtil.java</code> å¤„ç† SQL è€ƒè™‘æ€§èƒ½ï¼Œå®ç°ä¼šæ¯”è¾ƒ C-styleï¼Œä»£ç å’±å°±ä¸è´´äº†ï¼Œä¼ é€é—¨ï¼šhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/route/util/RouterUtil.javaã€‚ ï¼ˆğŸ˜ˆè¯¥ä»“åº“ä»å®˜æ–¹ Forkï¼Œé€æ­¥å®Œå–„ä¸­æ–‡æ³¨é‡Šï¼Œæ¬¢è¿ Starï¼‰</p>
<h2>ã€ 7 - 11 ã€‘</h2>
<p>å½“<strong>å‰ç½®</strong>è·¯ç”±å¤„ç†<strong>å…¨å±€åºåˆ—å·</strong>æ—¶ï¼Œæ·»åŠ åˆ°å…¨å±€åºåˆ—å¤„ç†å™¨ï¼ˆ<code>MyCATSequnceProcessor</code>ï¼‰ã€‚è¯¥å¤„ç†å™¨ä¼šå¼‚æ­¥ç”Ÿæˆ IDï¼Œæ›¿æ¢ SQL å†…çš„ <code>NEXT VALUE FOR MYCATSEQ_</code> æ­£åˆ™ã€‚ä¾‹å¦‚ï¼š</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> (<span class="keyword">id</span>, <span class="keyword">name</span>) <span class="keyword">values</span> (<span class="keyword">NEXT</span> <span class="keyword">VALUE</span> <span class="keyword">FOR</span> MYCATSEQ_ID, <span class="string">'name'</span>)</div><div class="line">===&gt;</div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> (<span class="keyword">id</span>, <span class="keyword">name</span>) <span class="keyword">values</span> (<span class="number">868348974560579584</span>, <span class="string">'name'</span>)</div></pre></td></tr></table></figure></p>
<p>å¼‚æ­¥å¤„ç†å®Œåï¼Œè°ƒç”¨ <code>ServerConnection#routeEndExecuteSQL(sql, type, schema)</code> æ–¹æ³•é‡æ–°æ‰§è¡Œ SQLã€‚</p>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RouterUtil.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">processSQL</span><span class="params">(ServerConnection sc,SchemaConfig schema,String sql,<span class="keyword">int</span> sqlType)</span></span>&#123;</div><div class="line"> <span class="number">3</span>: 	SessionSQLPair sessionSQLPair = <span class="keyword">new</span> SessionSQLPair(sc.getSession2(), schema, sql, sqlType);</div><div class="line"> <span class="number">4</span>: 	MycatServer.getInstance().getSequnceProcessor().addNewSql(sessionSQLPair);</div><div class="line"> <span class="number">5</span>: &#125;</div><div class="line"> <span class="number">6</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MyCATSequnceProcessor.javaã€‘</span></div><div class="line"> <span class="number">7</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCATSequnceProcessor</span> </span>&#123;</div><div class="line"> <span class="number">8</span>: 	<span class="keyword">private</span> LinkedBlockingQueue&lt;SessionSQLPair&gt; seqSQLQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;SessionSQLPair&gt;();</div><div class="line"> <span class="number">9</span>: 	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> running=<span class="keyword">true</span>;</div><div class="line"><span class="number">10</span>: 	</div><div class="line"><span class="number">11</span>: 	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addNewSql</span><span class="params">(SessionSQLPair pair)</span> </span>&#123;</div><div class="line"><span class="number">12</span>: 		seqSQLQueue.add(pair);</div><div class="line"><span class="number">13</span>: 	&#125;</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>: 	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeSeq</span><span class="params">(SessionSQLPair pair)</span> </span>&#123;</div><div class="line"><span class="number">16</span>: 		<span class="keyword">try</span> &#123;</div><div class="line"><span class="number">17</span>: 			</div><div class="line"><span class="number">18</span>: 			<span class="comment">// ä½¿ç”¨Druidè§£æå™¨å®ç°sequenceå¤„ç†  @å…µä¸´åŸä¸‹</span></div><div class="line"><span class="number">19</span>: 			DruidSequenceHandler sequenceHandler = <span class="keyword">new</span> DruidSequenceHandler(MycatServer</div><div class="line"><span class="number">20</span>: 					.getInstance().getConfig().getSystem().getSequnceHandlerType());</div><div class="line"><span class="number">21</span>: </div><div class="line"><span class="number">22</span>: 			<span class="comment">// ç”Ÿæˆå¯æ‰§è¡Œ SQL ï¼šç›®å‰ä¸»è¦æ˜¯ç”Ÿæˆ id</span></div><div class="line"><span class="number">23</span>: 			String charset = pair.session.getSource().getCharset();</div><div class="line"><span class="number">24</span>: 			String executeSql = sequenceHandler.getExecuteSql(pair.sql,charset == <span class="keyword">null</span> ? <span class="string">"utf-8"</span>:charset);</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>: 			<span class="comment">// æ‰§è¡Œ SQL</span></div><div class="line"><span class="number">27</span>: 			pair.session.getSource().routeEndExecuteSQL(executeSql, pair.type,pair.schema);</div><div class="line"><span class="number">28</span>: 		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">29</span>: 			LOGGER.error(<span class="string">"MyCATSequenceProcessor.executeSeq(SesionSQLPair)"</span>,e);</div><div class="line"><span class="number">30</span>: 			pair.session.getSource().writeErrMessage(ErrorCode.ER_YES,<span class="string">"mycat sequnce err."</span> + e);</div><div class="line"><span class="number">31</span>: 			<span class="keyword">return</span>;</div><div class="line"><span class="number">32</span>: 		&#125;</div><div class="line"><span class="number">33</span>: 	&#125;</div><div class="line"><span class="number">34</span>: 	</div><div class="line"><span class="number">35</span>: 	<span class="class"><span class="keyword">class</span> <span class="title">ExecuteThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line"><span class="number">36</span>: 		</div><div class="line"><span class="number">37</span>: 		<span class="function"><span class="keyword">public</span> <span class="title">ExecuteThread</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">38</span>: 			setDaemon(<span class="keyword">true</span>); <span class="comment">// è®¾ç½®ä¸ºåå°çº¿ç¨‹,é˜²æ­¢throw RuntimeExecptionè¿›ç¨‹ä»ç„¶å­˜åœ¨çš„é—®é¢˜</span></div><div class="line"><span class="number">39</span>: 		&#125;</div><div class="line"><span class="number">40</span>: 		</div><div class="line"><span class="number">41</span>: 		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">42</span>: 			<span class="keyword">while</span> (running) &#123;</div><div class="line"><span class="number">43</span>: 				<span class="keyword">try</span> &#123;</div><div class="line"><span class="number">44</span>: 					SessionSQLPair pair=seqSQLQueue.poll(<span class="number">100</span>,TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">45</span>: 					<span class="keyword">if</span>(pair!=<span class="keyword">null</span>)&#123;</div><div class="line"><span class="number">46</span>:                         executeSeq(pair);</div><div class="line"><span class="number">47</span>: 					&#125;</div><div class="line"><span class="number">48</span>: 				&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">49</span>: 					LOGGER.warn(<span class="string">"MyCATSequenceProcessor$ExecutorThread"</span>,e);</div><div class="line"><span class="number">50</span>: 				&#125;</div><div class="line"><span class="number">51</span>: 			&#125;</div><div class="line"><span class="number">52</span>: 		&#125;</div><div class="line"><span class="number">53</span>: 	&#125;</div><div class="line"><span class="number">54</span>: &#125;</div></pre></td></tr></table></figure></p>
<p>â“æ­¤å¤„æœ‰ä¸ªç–‘é—®ï¼š<code>MyCATSequnceProcessor</code> æ˜¯å•çº¿ç¨‹ï¼Œä¼šä¸ä¼šæ’å…¥æ€§èƒ½æœ‰ä¸€å®šçš„å½±å“ï¼Ÿåç»­å’±åšä¸‹æ€§èƒ½æµ‹è¯•ã€‚</p>
<h1>4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL</h1>
<p><img src="http://www.yunai.me/images/MyCAT/2017_05_29/03.png" alt="ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ03æ‰§è¡Œ SQLï¼‰"></p>
<h2>ã€ 1 - 8 ã€‘</h2>
<p>è·å¾— MySQL è¿æ¥ã€‚</p>
<ul>
<li>PhysicalDBNode ï¼šç‰©ç†æ•°æ®åº“èŠ‚ç‚¹ã€‚</li>
<li>PhysicalDatasource ï¼šç‰©ç†æ•°æ®åº“æ•°æ®æºã€‚</li>
</ul>
<h2>ã€ 9 - 13 ã€‘</h2>
<p>å‘é€ SQL åˆ° MySQL Serverï¼Œæ‰§è¡Œ SQLã€‚</p>
<h1>5. å“åº”æ‰§è¡Œ SQL ç»“æœ</h1>
<p><img src="http://www.yunai.me/images/MyCAT/2017_05_29/04.png" alt="ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰"></p>
<h2>ã€ 1 - 4 ã€‘</h2>
<p>å¤„ç† MySQL Server å“åº”æ•°æ®åŒ…ã€‚</p>
<h2>ã€ 5 - 8 ã€‘</h2>
<p>å‘é€æ’å…¥æˆåŠŸç»“æœç»™ MySQL Clientã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rock
    
    </summary>
    
      <category term="MyCAT" scheme="http://www.yunai.me/categories/MyCAT/"/>
    
    
  </entry>
  
  <entry>
    <title>MyCAT æºç åˆ†æ â€”â€” è°ƒè¯•ç¯å¢ƒæ­å»º</title>
    <link href="http://www.yunai.me/MyCAT/build-debugging-environment/"/>
    <id>http://www.yunai.me/MyCAT/build-debugging-environment/</id>
    <published>2017-05-22T16:00:00.000Z</published>
    <updated>2017-07-27T16:54:23.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. ä¾èµ–å·¥å…·</a></li>
<li><a href="#">2. æºç æ‹‰å–</a></li>
<li><a href="#">3. æ•°æ®åº“é…ç½®</a></li>
<li><a href="#">4. MyCat é…ç½®</a></li>
<li><a href="#">5. MyCAT å¯åŠ¨</a></li>
<li><a href="#">6. MyCAT æµ‹è¯•</a></li>
<li><a href="#">7. äº¤æµ</a></li>
</ul>
<h1>1. ä¾èµ–å·¥å…·</h1>
<ul>
<li>Maven</li>
<li>Git</li>
<li>JDK</li>
<li>MySQL</li>
<li>IntelliJ IDEA</li>
</ul>
<h1>2. æºç æ‹‰å–</h1>
<p>ä»å®˜æ–¹ä»“åº“ <a href="https://github.com/MyCATApache/Mycat-Server" target="_blank" rel="external">https://github.com/MyCATApache/Mycat-Server</a> <code>Fork</code> å‡ºå±äºè‡ªå·±çš„ä»“åº“ã€‚ä¸ºä»€ä¹ˆè¦ <code>Fork</code> ï¼Ÿæ—¢ç„¶å¼€å§‹é˜…è¯»ã€è°ƒè¯•æºç ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå†™ä¸€äº›æ³¨é‡Šï¼Œæœ‰äº†è‡ªå·±çš„ä»“åº“ï¼Œå¯ä»¥è¿›è¡Œè‡ªç”±çš„æäº¤ã€‚ğŸ˜ˆ</p>
<p>ä½¿ç”¨ <code>IntelliJ IDEA</code> ä» <code>Fork</code> å‡ºæ¥çš„ä»“åº“æ‹‰å–ä»£ç ã€‚æ‹‰å–å®Œæˆåï¼Œ<code>Maven</code> ä¼šä¸‹è½½ä¾èµ–åŒ…ï¼Œå¯èƒ½ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œè€å¿ƒç­‰å¾…ä¸‹ã€‚</p>
<h1>3. æ•°æ®åº“é…ç½®</h1>
<p>æˆ‘ä»¬è¦æ­å»ºçš„æ˜¯<strong>éåˆ†ç‰‡è¡¨</strong>çš„è°ƒè¯•ç¯å¢ƒï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ•°æ®åº“å’Œè¡¨ï¼š</p>
<ol>
<li>åˆ›å»ºæ•°æ®åº“ï¼š<code>db01</code> ã€‚</li>
<li>åˆ›å»ºæ•°æ®åº“è¡¨ï¼š<code>travelrecord</code> ã€‚</li>
</ol>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`travelrecord`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</div><div class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> latin1 <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COLLATE</span>=utf8_bin</div></pre></td></tr></table></figure></p>
<h1>4. MyCAT é…ç½®</h1>
<p>ä¸ºäº†é¿å…å¯¹å®ç°æºç äº§ç”Ÿå½±å“ï¼Œæˆ‘ä»¬é€‰æ‹©å¯¹ <code>test</code> ç›®å½•åšå˜æ›´ã€‚</p>
<p>1ã€åœ¨ <code>resources</code> ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶å¤¹ <code>backups</code> ï¼Œå°†åŸ <code>resources</code> ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ç§»åˆ° <code>backups</code> ä¸‹ï¼Œè¿™æ ·æˆ‘ä»¬çš„ç¯å¢ƒå°±å¹²å¹²å‡€äº†ã€‚<br>
2ã€åœ¨ <code>resources</code> ç›®å½•ä¸‹æ–°å»º <code>schema.xml</code> æ–‡ä»¶ï¼Œé…ç½® <code>MyCAT</code> çš„é€»è¾‘åº“ã€è¡¨ã€æ•°æ®èŠ‚ç‚¹ã€æ•°æ®æºã€‚</p>
<p><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">&lt;?xml version="1.0"?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE mycat:schema SYSTEM "schema.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">"http://io.mycat/"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">"dbtest"</span> <span class="attr">checkSQLschema</span>=<span class="string">"true"</span> <span class="attr">sqlMaxLimit</span>=<span class="string">"100"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"travelrecord"</span> <span class="attr">dataNode</span>=<span class="string">"dn1"</span> <span class="attr">autoIncrement</span>=<span class="string">"true"</span> <span class="attr">primaryKey</span>=<span class="string">"id"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">"dn1"</span> <span class="attr">dataHost</span>=<span class="string">"localhost1"</span> <span class="attr">database</span>=<span class="string">"db1"</span> /&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">"localhost1"</span> <span class="attr">maxCon</span>=<span class="string">"1000"</span> <span class="attr">minCon</span>=<span class="string">"10"</span> <span class="attr">balance</span>=<span class="string">"0"</span></span></div><div class="line">			  <span class="attr">writeType</span>=<span class="string">"0"</span> <span class="attr">dbType</span>=<span class="string">"mysql"</span> <span class="attr">dbDriver</span>=<span class="string">"native"</span> <span class="attr">switchType</span>=<span class="string">"1"</span> <span class="attr">slaveThreshold</span>=<span class="string">"100"</span>&gt;</div><div class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostM1"</span> <span class="attr">url</span>=<span class="string">"127.0.0.1:33061"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"123456"</span>&gt;</span> <span class="comment">&lt;!-- â€¼ï¸â€¼ï¸â€¼ï¸ urlã€userã€password è®¾ç½®æˆä½ çš„æ•°æ®åº“ --&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>3ã€åœ¨ <code>resources</code> ç›®å½•ä¸‹æ–°å»º <code>server.xml</code> æ–‡ä»¶ï¼Œé…ç½® <code>MyCAT</code> ç³»ç»Ÿé…ç½®ã€‚</p>
<p><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE mycat:server SYSTEM "server.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">mycat:server</span> <span class="attr">xmlns:mycat</span>=<span class="string">"http://io.mycat/"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">system</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"nonePasswordLogin"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span> <span class="comment">&lt;!-- 0ä¸ºéœ€è¦å¯†ç ç™»é™†ã€1ä¸ºä¸éœ€è¦å¯†ç ç™»é™† ,é»˜è®¤ä¸º0ï¼Œè®¾ç½®ä¸º1åˆ™éœ€è¦æŒ‡å®šé»˜è®¤è´¦æˆ·--&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useHandshakeV10"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useSqlStat"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span>  <span class="comment">&lt;!-- 1ä¸ºå¼€å¯å®æ—¶ç»Ÿè®¡ã€0ä¸ºå…³é—­ --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useGlobleTableCheck"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span>  <span class="comment">&lt;!-- 1ä¸ºå¼€å¯å…¨åŠ ç­ä¸€è‡´æ€§æ£€æµ‹ã€0ä¸ºå…³é—­ --&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sequnceHandlerType"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"processorBufferPoolType"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"handleDistributedTransactions"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useOffHeapForMerge"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"memoryPageSize"</span>&gt;</span>64k<span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"spillsFileBufferSize"</span>&gt;</span>1k<span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useStreamOutput"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"systemReserveMemorySize"</span>&gt;</span>384m<span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useZKSwitch"</span>&gt;</span>false<span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">system</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">"root"</span> <span class="attr">defaultAccount</span>=<span class="string">"true"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"schemas"</span>&gt;</span>dbtest<span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">user</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">mycat:server</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h1>5. MyCAT å¯åŠ¨</h1>
<p>1ã€åœ¨ <code>java</code> ç›®å½•ä¸‹æ–°å»º <code>debugger</code> åŒ…ï¼Œå’ŒåŸå…ˆå·²å­˜åœ¨çš„åŒ…åšåŒºåˆ†ã€‚<br>
2ã€åœ¨ <code>debbuger</code> åŒ…ä¸‹æ–°å»º <code>MycatStartupTest.java</code> ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> debugger;</div><div class="line"></div><div class="line"><span class="keyword">import</span> io.mycat.MycatStartup;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@link</span> io.mycat.MycatStartup&#125;æµ‹è¯•</div><div class="line"> *</div><div class="line"> * Created by yunai on 2017/5/22.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MycatStartupTest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        MycatStartup.main(args);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>3ã€è¿è¡Œ <code>MycatStartupTest.java</code> ï¼Œå½“çœ‹åˆ°è¾“å‡ºæ—¥å¿— <code>MyCAT Server startup successfully. see logs in logs/mycat.log</code> å³ä¸ºå¯åŠ¨æˆåŠŸã€‚</p>
<p>æˆªæ­¢ç›®å‰ï¼Œ<code>test</code> ç›®å½•å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_05_23/01.png" alt="testç›®å½•.png"></p>
<h1>6. MyCAT æµ‹è¯•</h1>
<p>è°ƒè¯•ç¯å¢ƒå·²ç»æ­å»ºå®Œæˆï¼Œæˆ‘ä»¬çœ‹çœ‹æ˜¯å¦æ­£ç¡®ã€‚</p>
<p>ä½¿ç”¨ <code>MySQL</code> å®¢æˆ·ç«¯è¿æ¥ <code>MyCAT</code> ï¼š</p>
<ul>
<li>HOST ï¼š127.0.0.1</li>
<li>PORT ï¼š8066</li>
<li>USERNAME ï¼šroot</li>
<li>PASSWORD ï¼š123456</li>
</ul>
<p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">mysql&gt; insert into travelrecord(name) values ('haha');</div><div class="line">Query OK, 1 rows affected (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt; select * from travelrecord;</div><div class="line">+--------------------+------+</div><div class="line">| id                 | name |</div><div class="line">+--------------------+------+</div><div class="line">| 866707181398003712 | haha |</div><div class="line">+--------------------+------+</div><div class="line">1 rows in set (0.05 sec)</div></pre></td></tr></table></figure></p>
<p>æˆåŠŸã€‚ğŸ˜ˆğŸ˜ˆğŸ˜ˆ</p>
<h1>7. äº¤æµ</h1>
<p>æ„Ÿè°¢é˜…è¯»ã€æ”¶è—ã€å…³æ³¨ã€‚<br>
<strong>çŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚å­¦ä¹  MyCAT ä¼šæ˜¯ä¸€æ®µå¾ˆæ„‰å¿«çš„æ—…ç¨‹ã€‚å¦‚æœæœ‰ä½ çš„äº¤æµï¼Œç›¸ä¿¡ä¼šæ›´åŠ æ„‰å¿«ã€‚æ¬¢è¿æ·»åŠ å¾®ä¿¡ï¼š<code>wangwenbin-server</code> è¿›è¡Œæ¢è®¨ã€‚</strong></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rock
    
    </summary>
    
      <category term="MyCAT" scheme="http://www.yunai.me/categories/MyCAT/"/>
    
    
  </entry>
  
  <entry>
    <title>ä¸ºä»€ä¹ˆé˜…è¯» MyCAT æºç ï¼Ÿ</title>
    <link href="http://www.yunai.me/MyCAT/why-read-MyCAT-source-code/"/>
    <id>http://www.yunai.me/MyCAT/why-read-MyCAT-source-code/</id>
    <published>2017-05-21T16:00:00.000Z</published>
    <updated>2017-07-27T16:54:14.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h2>ä¸ºä»€ä¹ˆé˜…è¯» MyCAT æºç ï¼Ÿ</h2>
<ul>
<li>æ·±å…¥äº†è§£<strong>æ•°æ®åº“ä¸­é—´ä»¶</strong> ï¼ŒçŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚</li>
<li>NIO çš„å®ç° ä¸ Netty æœ‰ä»€ä¹ˆç‰¹æ®Šçš„åœ°æ–¹ï¼Ÿ</li>
<li>åˆ†å¸ƒå¼äº‹åŠ¡å¦‚ä½•å®ç°çš„ï¼Ÿ</li>
<li>å†…å­˜ç®¡ç†</li>
<li>SQL è§£æ</li>
<li>ç­‰ç­‰</li>
</ul>
<h2>åŠŸèƒ½ç‚¹</h2>
<ul>
<li>[ ] NIO</li>
<li>[x] åˆ†å¸ƒå¼äº‹åŠ¡</li>
<li>[ ] MyCAT ä¸»ä»</li>
<li>[x] æ”¯æŒprepareé¢„ç¼–è¯‘æŒ‡ä»¤</li>
<li>[ ] è‡ªå¢åºåˆ— 30%</li>
<li>[ ] å•åº“ä»»æ„ Join Doing</li>
<li>[x] è·¨åº“2è¡¨ Join</li>
<li>[ ] è·¨åº“å¤šè¡¨ Join</li>
<li>[ ] SQL è§£æ</li>
<li>[ ] è¯»å†™åˆ†ç¦»</li>
<li>[ ] MySQL ä¸»ä»</li>
<li>[ ] è‡ªåŠ¨æ•…éšœåˆ‡æ¢</li>
<li>[ ] Galera Cluster é›†ç¾¤</li>
<li>[ ] MHA é›†ç¾¤</li>
<li>[ ] Percona é›†ç¾¤</li>
<li>[ ] æœåŠ¡é™çº§</li>
<li>[ ] å¤šç§Ÿæˆ·</li>
<li>[ ] è·¯ç”±</li>
<li>[ ] MyCAT é›†ç¾¤</li>
<li>[ ] æ³¨è§£</li>
<li>[ ] ç¼“å­˜</li>
<li>[ ] ç›‘æ§</li>
<li>[ ] Mongodb</li>
<li>[ ] å†…å­˜ç®¡ç† 20%</li>
<li>[ ] æ•°æ®èšåˆ 30%</li>
<li>[ ] æ•°æ®æ’åº 25%</li>
<li>[ ] åˆ†è¡¨</li>
<li>[ ] åˆ†åº“ 50%</li>
<li>[ ] å…¨å±€è¡¨</li>
<li>[ ] E/Rå…³ç³»</li>
<li>[ ] æœåŠ¡é™çº§</li>
<li>[ ] SQL æ³¨å…¥æ”»å‡»æ‹¦æˆª</li>
<li>[ ] MySQL åè®®</li>
<li>[ ] PostgreSQL åè®®</li>
<li>[ ] å­˜å‚¨è¿‡ç¨‹</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rock
    
    </summary>
    
      <category term="MyCAT" scheme="http://www.yunai.me/categories/MyCAT/"/>
    
    
  </entry>
  
  <entry>
    <title>RocketMQ æºç åˆ†æ â€”â€” äº‹åŠ¡æ¶ˆæ¯</title>
    <link href="http://www.yunai.me/RocketMQ/message-transaction/"/>
    <id>http://www.yunai.me/RocketMQ/message-transaction/</id>
    <published>2017-05-20T16:00:00.000Z</published>
    <updated>2017-07-27T16:57:54.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. äº‹åŠ¡æ¶ˆæ¯å‘é€</a>
<ul>
<li><a href="#">2.1 Producer å‘é€äº‹åŠ¡æ¶ˆæ¯</a></li>
<li><a href="#">2.2 Broker å¤„ç†ç»“æŸäº‹åŠ¡è¯·æ±‚</a></li>
<li><a href="#">2.3 Broker ç”Ÿæˆ ConsumeQueue</a></li>
</ul>
</li>
<li><a href="#">3. äº‹åŠ¡æ¶ˆæ¯å›æŸ¥</a>
<ul>
<li><a href="#">3.1 Broker å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘</a>
<ul>
<li><a href="#">3.1.1 å®˜æ–¹V3.1.4ï¼šåŸºäºæ–‡ä»¶ç³»ç»Ÿ</a>
<ul>
<li><a href="#">3.1.1.1 å­˜å‚¨æ¶ˆæ¯åˆ° CommitLog</a></li>
<li><a href="#">3.1.1.2 å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰</a></li>
<li><a href="#">3.1.1.3 ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥</a></li>
<li><a href="#">3.1.1.4 åˆå§‹åŒ–ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰</a></li>
<li><a href="#">3.1.1.5 è¡¥å……</a></li>
</ul>
</li>
<li><a href="#">3.1.2 å®˜æ–¹V4.0.0ï¼šåŸºäºæ•°æ®åº“</a></li>
</ul>
</li>
<li><a href="#">3.2 Producer æ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘</a></li>
</ul>
</li>
</ul>
<h1>1. æ¦‚è¿°</h1>
<p><strong>å¿…é¡»å¿…é¡»å¿…é¡»</strong> å‰ç½®é˜…è¯»å†…å®¹ï¼š</p>
<ul>
<li><a href="https://help.aliyun.com/document_detail/43348.html?spm=5176.doc43490.6.566.Zd5Bl7" rel="external nofollow noopener noreferrer" target="_blank">ã€Šäº‹åŠ¡æ¶ˆæ¯ï¼ˆé˜¿é‡Œäº‘ï¼‰ã€‹</a></li>
</ul>
<h1>2. äº‹åŠ¡æ¶ˆæ¯å‘é€</h1>
<h2>2.1 Producer å‘é€äº‹åŠ¡æ¶ˆæ¯</h2>
<ul>
<li>æ´»åŠ¨å›¾å¦‚ä¸‹ï¼ˆç»“åˆ <code>æ ¸å¿ƒä»£ç </code> ç†è§£ï¼‰ï¼š</li>
</ul>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_21/03.png" alt="Producerå‘é€äº‹åŠ¡æ¶ˆæ¯"></p>
<ul>
<li>å®ç°ä»£ç å¦‚ä¸‹ï¼š</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘</span></div><div class="line">  <span class="number">2</span>: <span class="comment">/**</span></div><div class="line">  3:  * å‘é€äº‹åŠ¡æ¶ˆæ¯</div><div class="line">  4:  *</div><div class="line">  5:  * <span class="doctag">@param</span> msg æ¶ˆæ¯</div><div class="line">  6:  * <span class="doctag">@param</span> tranExecuter ã€æœ¬åœ°äº‹åŠ¡ã€‘æ‰§è¡Œå™¨</div><div class="line">  7:  * <span class="doctag">@param</span> arg ã€æœ¬åœ°äº‹åŠ¡ã€‘æ‰§è¡Œå™¨å‚æ•°</div><div class="line">  8:  * <span class="doctag">@return</span> äº‹åŠ¡å‘é€ç»“æœ</div><div class="line">  9:  * <span class="doctag">@throws</span> MQClientException å½“ Client å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class="line"> 10:  */</div><div class="line"> <span class="number">11</span>: <span class="function"><span class="keyword">public</span> TransactionSendResult <span class="title">sendMessageInTransaction</span><span class="params">(<span class="keyword">final</span> Message msg, <span class="keyword">final</span> LocalTransactionExecuter tranExecuter, <span class="keyword">final</span> Object arg)</span></span></div><div class="line"> 12:     <span class="keyword">throws</span> MQClientException &#123;</div><div class="line"> <span class="number">13</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == tranExecuter) &#123;</div><div class="line"> <span class="number">14</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"tranExecutor is null"</span>, <span class="keyword">null</span>);</div><div class="line"> <span class="number">15</span>:     &#125;</div><div class="line"> <span class="number">16</span>:     Validators.checkMessage(msg, <span class="keyword">this</span>.defaultMQProducer);</div><div class="line"> <span class="number">17</span>: </div><div class="line"> <span class="number">18</span>:     <span class="comment">// å‘é€ã€Halfæ¶ˆæ¯ã€‘</span></div><div class="line"> <span class="number">19</span>:     SendResult sendResult;</div><div class="line"> <span class="number">20</span>:     MessageAccessor.putProperty(msg, MessageConst.PROPERTY_TRANSACTION_PREPARED, <span class="string">"true"</span>);</div><div class="line"> <span class="number">21</span>:     MessageAccessor.putProperty(msg, MessageConst.PROPERTY_PRODUCER_GROUP, <span class="keyword">this</span>.defaultMQProducer.getProducerGroup());</div><div class="line"> <span class="number">22</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">23</span>:         sendResult = <span class="keyword">this</span>.send(msg);</div><div class="line"> <span class="number">24</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">25</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"send message Exception"</span>, e);</div><div class="line"> <span class="number">26</span>:     &#125;</div><div class="line"> <span class="number">27</span>: </div><div class="line"> <span class="number">28</span>:     <span class="comment">// å¤„ç†å‘é€ã€Halfæ¶ˆæ¯ã€‘ç»“æœ</span></div><div class="line"> <span class="number">29</span>:     LocalTransactionState localTransactionState = LocalTransactionState.UNKNOW;</div><div class="line"> <span class="number">30</span>:     Throwable localException = <span class="keyword">null</span>;</div><div class="line"> <span class="number">31</span>:     <span class="keyword">switch</span> (sendResult.getSendStatus()) &#123;</div><div class="line"> <span class="number">32</span>:         <span class="comment">// å‘é€ã€Halfæ¶ˆæ¯ã€‘æˆåŠŸï¼Œæ‰§è¡Œã€æœ¬åœ°äº‹åŠ¡ã€‘é€»è¾‘</span></div><div class="line"> <span class="number">33</span>:         <span class="keyword">case</span> SEND_OK: &#123;</div><div class="line"> <span class="number">34</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">35</span>:                 <span class="keyword">if</span> (sendResult.getTransactionId() != <span class="keyword">null</span>) &#123; <span class="comment">// äº‹åŠ¡ç¼–å·ã€‚ç›®å‰å¼€æºç‰ˆæœ¬æš‚æ—¶æ²¡ç”¨åˆ°ï¼ŒçŒœæƒ³ONSåœ¨ä½¿ç”¨ã€‚</span></div><div class="line"> <span class="number">36</span>:                     msg.putUserProperty(<span class="string">"__transactionId__"</span>, sendResult.getTransactionId());</div><div class="line"> <span class="number">37</span>:                 &#125;</div><div class="line"> <span class="number">38</span>: </div><div class="line"> <span class="number">39</span>:                 <span class="comment">// æ‰§è¡Œã€æœ¬åœ°äº‹åŠ¡ã€‘é€»è¾‘</span></div><div class="line"> <span class="number">40</span>:                 localTransactionState = tranExecuter.executeLocalTransactionBranch(msg, arg);</div><div class="line"> <span class="number">41</span>:                 <span class="keyword">if</span> (<span class="keyword">null</span> == localTransactionState) &#123;</div><div class="line"> <span class="number">42</span>:                     localTransactionState = LocalTransactionState.UNKNOW;</div><div class="line"> <span class="number">43</span>:                 &#125;</div><div class="line"> <span class="number">44</span>: </div><div class="line"> <span class="number">45</span>:                 <span class="keyword">if</span> (localTransactionState != LocalTransactionState.COMMIT_MESSAGE) &#123;</div><div class="line"> <span class="number">46</span>:                     log.info(<span class="string">"executeLocalTransactionBranch return &#123;&#125;"</span>, localTransactionState);</div><div class="line"> <span class="number">47</span>:                     log.info(msg.toString());</div><div class="line"> <span class="number">48</span>:                 &#125;</div><div class="line"> <span class="number">49</span>:             &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">50</span>:                 log.info(<span class="string">"executeLocalTransactionBranch exception"</span>, e);</div><div class="line"> <span class="number">51</span>:                 log.info(msg.toString());</div><div class="line"> <span class="number">52</span>:                 localException = e;</div><div class="line"> <span class="number">53</span>:             &#125;</div><div class="line"> <span class="number">54</span>:         &#125;</div><div class="line"> <span class="number">55</span>:         <span class="keyword">break</span>;</div><div class="line"> <span class="number">56</span>:         <span class="comment">// å‘é€ã€Halfæ¶ˆæ¯ã€‘å¤±è´¥ï¼Œæ ‡è®°ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€ä¸ºå›æ»š</span></div><div class="line"> <span class="number">57</span>:         <span class="keyword">case</span> FLUSH_DISK_TIMEOUT:</div><div class="line"> <span class="number">58</span>:         <span class="keyword">case</span> FLUSH_SLAVE_TIMEOUT:</div><div class="line"> <span class="number">59</span>:         <span class="keyword">case</span> SLAVE_NOT_AVAILABLE:</div><div class="line"> <span class="number">60</span>:             localTransactionState = LocalTransactionState.ROLLBACK_MESSAGE;</div><div class="line"> <span class="number">61</span>:             <span class="keyword">break</span>;</div><div class="line"> <span class="number">62</span>:         <span class="keyword">default</span>:</div><div class="line"> <span class="number">63</span>:             <span class="keyword">break</span>;</div><div class="line"> <span class="number">64</span>:     &#125;</div><div class="line"> <span class="number">65</span>: </div><div class="line"> <span class="number">66</span>:     <span class="comment">// ç»“æŸäº‹åŠ¡ï¼šæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK</span></div><div class="line"> <span class="number">67</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">68</span>:         <span class="keyword">this</span>.endTransaction(sendResult, localTransactionState, localException);</div><div class="line"> <span class="number">69</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">70</span>:         log.warn(<span class="string">"local transaction execute "</span> + localTransactionState + <span class="string">", but end broker transaction failed"</span>, e);</div><div class="line"> <span class="number">71</span>:     &#125;</div><div class="line"> <span class="number">72</span>: </div><div class="line"> <span class="number">73</span>:     <span class="comment">// è¿”å›ã€äº‹åŠ¡å‘é€ç»“æœã€‘</span></div><div class="line"> <span class="number">74</span>:     TransactionSendResult transactionSendResult = <span class="keyword">new</span> TransactionSendResult();</div><div class="line"> <span class="number">75</span>:     transactionSendResult.setSendStatus(sendResult.getSendStatus());</div><div class="line"> <span class="number">76</span>:     transactionSendResult.setMessageQueue(sendResult.getMessageQueue());</div><div class="line"> <span class="number">77</span>:     transactionSendResult.setMsgId(sendResult.getMsgId());</div><div class="line"> <span class="number">78</span>:     transactionSendResult.setQueueOffset(sendResult.getQueueOffset());</div><div class="line"> <span class="number">79</span>:     transactionSendResult.setTransactionId(sendResult.getTransactionId());</div><div class="line"> <span class="number">80</span>:     transactionSendResult.setLocalTransactionState(localTransactionState);</div><div class="line"> <span class="number">81</span>:     <span class="keyword">return</span> transactionSendResult;</div><div class="line"> <span class="number">82</span>: &#125;</div><div class="line"> <span class="number">83</span>: </div><div class="line"> <span class="number">84</span>: <span class="comment">/**</span></div><div class="line"> 85:  * ç»“æŸäº‹åŠ¡ï¼šæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK</div><div class="line"> 86:  *</div><div class="line"> 87:  * <span class="doctag">@param</span> sendResult å‘é€ã€Halfæ¶ˆæ¯ã€‘ç»“æœ</div><div class="line"> 88:  * <span class="doctag">@param</span> localTransactionState ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€</div><div class="line"> 89:  * <span class="doctag">@param</span> localException æ‰§è¡Œã€æœ¬åœ°äº‹åŠ¡ã€‘é€»è¾‘äº§ç”Ÿçš„å¼‚å¸¸</div><div class="line"> 90:  * <span class="doctag">@throws</span> RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class="line"> 91:  * <span class="doctag">@throws</span> MQBrokerException å½“ Broker å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class="line"> 92:  * <span class="doctag">@throws</span> InterruptedException å½“çº¿ç¨‹ä¸­æ–­æ—¶</div><div class="line"> 93:  * <span class="doctag">@throws</span> UnknownHostException å½“è§£ç æ¶ˆæ¯ç¼–å·å¤±è´¥æ˜¯</div><div class="line"> 94:  */</div><div class="line"> <span class="number">95</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endTransaction</span><span class="params">(//</span></span></div><div class="line"> <span class="number">96</span>:     <span class="keyword">final</span> SendResult sendResult, //</div><div class="line"> <span class="number">97</span>:     <span class="keyword">final</span> LocalTransactionState localTransactionState, //</div><div class="line"> <span class="number">98</span>:     <span class="keyword">final</span> Throwable localException) <span class="keyword">throws</span> RemotingException, MQBrokerException, InterruptedException, UnknownHostException &#123;</div><div class="line"> <span class="number">99</span>:     <span class="comment">// è§£ç æ¶ˆæ¯ç¼–å·</span></div><div class="line"><span class="number">100</span>:     <span class="keyword">final</span> MessageId id;</div><div class="line"><span class="number">101</span>:     <span class="keyword">if</span> (sendResult.getOffsetMsgId() != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">102</span>:         id = MessageDecoder.decodeMessageId(sendResult.getOffsetMsgId());</div><div class="line"><span class="number">103</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">104</span>:         id = MessageDecoder.decodeMessageId(sendResult.getMsgId());</div><div class="line"><span class="number">105</span>:     &#125;</div><div class="line"><span class="number">106</span>: </div><div class="line"><span class="number">107</span>:     <span class="comment">// åˆ›å»ºè¯·æ±‚</span></div><div class="line"><span class="number">108</span>:     String transactionId = sendResult.getTransactionId();</div><div class="line"><span class="number">109</span>:     <span class="keyword">final</span> String brokerAddr = <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInPublish(sendResult.getMessageQueue().getBrokerName());</div><div class="line"><span class="number">110</span>:     EndTransactionRequestHeader requestHeader = <span class="keyword">new</span> EndTransactionRequestHeader();</div><div class="line"><span class="number">111</span>:     requestHeader.setTransactionId(transactionId);</div><div class="line"><span class="number">112</span>:     requestHeader.setCommitLogOffset(id.getOffset());</div><div class="line"><span class="number">113</span>:     <span class="keyword">switch</span> (localTransactionState) &#123;</div><div class="line"><span class="number">114</span>:         <span class="keyword">case</span> COMMIT_MESSAGE:</div><div class="line"><span class="number">115</span>:             requestHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_COMMIT_TYPE);</div><div class="line"><span class="number">116</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">117</span>:         <span class="keyword">case</span> ROLLBACK_MESSAGE:</div><div class="line"><span class="number">118</span>:             requestHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_ROLLBACK_TYPE);</div><div class="line"><span class="number">119</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">120</span>:         <span class="keyword">case</span> UNKNOW:</div><div class="line"><span class="number">121</span>:             requestHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_NOT_TYPE);</div><div class="line"><span class="number">122</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">123</span>:         <span class="keyword">default</span>:</div><div class="line"><span class="number">124</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">125</span>:     &#125;</div><div class="line"><span class="number">126</span>:     requestHeader.setProducerGroup(<span class="keyword">this</span>.defaultMQProducer.getProducerGroup());</div><div class="line"><span class="number">127</span>:     requestHeader.setTranStateTableOffset(sendResult.getQueueOffset());</div><div class="line"><span class="number">128</span>:     requestHeader.setMsgId(sendResult.getMsgId());</div><div class="line"><span class="number">129</span>:     String remark = localException != <span class="keyword">null</span> ? (<span class="string">"executeLocalTransactionBranch exception: "</span> + localException.toString()) : <span class="keyword">null</span>;</div><div class="line"><span class="number">130</span>: </div><div class="line"><span class="number">131</span>:     <span class="comment">// æäº¤æ¶ˆæ¯ COMMIT / ROLLBACKã€‚ï¼ï¼ï¼é€šä¿¡æ–¹å¼ä¸ºï¼šOnewayï¼ï¼ï¼</span></div><div class="line"><span class="number">132</span>:     <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().endTransactionOneway(brokerAddr, requestHeader, remark, <span class="keyword">this</span>.defaultMQProducer.getSendMsgTimeout());</div><div class="line"><span class="number">133</span>: &#125;</div></pre></td></tr></table></figure></p>
<h2>2.2 Broker å¤„ç†ç»“æŸäº‹åŠ¡è¯·æ±‚</h2>
<ul>
<li>ğŸ¦… æŸ¥è¯¢è¯·æ±‚çš„æ¶ˆæ¯ï¼Œè¿›è¡Œ<strong>æäº¤ / å›æ»š</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€EndTransactionProcessor.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> RemotingCommand <span class="title">processRequest</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand request)</span> <span class="keyword">throws</span> RemotingCommandException </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(<span class="keyword">null</span>);</div><div class="line"> <span class="number">4</span>:     <span class="keyword">final</span> EndTransactionRequestHeader requestHeader = (EndTransactionRequestHeader) request.decodeCommandCustomHeader(EndTransactionRequestHeader.class);</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:     <span class="comment">// çœç•¥ä»£ç  =ã€‹æ‰“å°æ—¥å¿—ï¼ˆåªå¤„ç† COMMIT / ROLLBACKï¼‰</span></div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:     <span class="comment">// æŸ¥è¯¢æäº¤çš„æ¶ˆæ¯</span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">final</span> MessageExt msgExt = <span class="keyword">this</span>.brokerController.getMessageStore().lookMessageByOffset(requestHeader.getCommitLogOffset());</div><div class="line"><span class="number">10</span>:     <span class="keyword">if</span> (msgExt != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">11</span>:         <span class="comment">// çœç•¥ä»£ç  =ã€‹æ ¡éªŒæ¶ˆæ¯</span></div><div class="line"><span class="number">12</span>: </div><div class="line"><span class="number">13</span>:         <span class="comment">// ç”Ÿæˆæ¶ˆæ¯</span></div><div class="line"><span class="number">14</span>:         MessageExtBrokerInner msgInner = <span class="keyword">this</span>.endMessageTransaction(msgExt);</div><div class="line"><span class="number">15</span>:         msgInner.setSysFlag(MessageSysFlag.resetTransactionValue(msgInner.getSysFlag(), requestHeader.getCommitOrRollback()));</div><div class="line"><span class="number">16</span>:         msgInner.setQueueOffset(requestHeader.getTranStateTableOffset());</div><div class="line"><span class="number">17</span>:         msgInner.setPreparedTransactionOffset(requestHeader.getCommitLogOffset());</div><div class="line"><span class="number">18</span>:         msgInner.setStoreTimestamp(msgExt.getStoreTimestamp());</div><div class="line"><span class="number">19</span>:         <span class="keyword">if</span> (MessageSysFlag.TRANSACTION_ROLLBACK_TYPE == requestHeader.getCommitOrRollback()) &#123;</div><div class="line"><span class="number">20</span>:             msgInner.setBody(<span class="keyword">null</span>);</div><div class="line"><span class="number">21</span>:         &#125;</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>:         <span class="comment">// å­˜å‚¨ç”Ÿæˆæ¶ˆæ¯</span></div><div class="line"><span class="number">24</span>:         <span class="keyword">final</span> MessageStore messageStore = <span class="keyword">this</span>.brokerController.getMessageStore();</div><div class="line"><span class="number">25</span>:         <span class="keyword">final</span> PutMessageResult putMessageResult = messageStore.putMessage(msgInner);</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:         <span class="comment">// å¤„ç†å­˜å‚¨ç»“æœ</span></div><div class="line"><span class="number">28</span>:         <span class="keyword">if</span> (putMessageResult != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">29</span>:             <span class="keyword">switch</span> (putMessageResult.getPutMessageStatus()) &#123;</div><div class="line"><span class="number">30</span>:                 <span class="comment">// Success</span></div><div class="line"><span class="number">31</span>:                 <span class="keyword">case</span> PUT_OK:</div><div class="line"><span class="number">32</span>:                 <span class="keyword">case</span> FLUSH_DISK_TIMEOUT:</div><div class="line"><span class="number">33</span>:                 <span class="keyword">case</span> FLUSH_SLAVE_TIMEOUT:</div><div class="line"><span class="number">34</span>:                 <span class="keyword">case</span> SLAVE_NOT_AVAILABLE:</div><div class="line"><span class="number">35</span>:                     response.setCode(ResponseCode.SUCCESS);</div><div class="line"><span class="number">36</span>:                     response.setRemark(<span class="keyword">null</span>);</div><div class="line"><span class="number">37</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">38</span>:                 <span class="comment">// Failed</span></div><div class="line"><span class="number">39</span>:                 <span class="keyword">case</span> CREATE_MAPEDFILE_FAILED:</div><div class="line"><span class="number">40</span>:                     response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">41</span>:                     response.setRemark(<span class="string">"create maped file failed."</span>);</div><div class="line"><span class="number">42</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">43</span>:                 <span class="keyword">case</span> MESSAGE_ILLEGAL:</div><div class="line"><span class="number">44</span>:                 <span class="keyword">case</span> PROPERTIES_SIZE_EXCEEDED:</div><div class="line"><span class="number">45</span>:                     response.setCode(ResponseCode.MESSAGE_ILLEGAL);</div><div class="line"><span class="number">46</span>:                     response.setRemark(<span class="string">"the message is illegal, maybe msg body or properties length not matched. msg body length limit 128k, msg properties length limit 32k."</span>);</div><div class="line"><span class="number">47</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">48</span>:                 <span class="keyword">case</span> SERVICE_NOT_AVAILABLE:</div><div class="line"><span class="number">49</span>:                     response.setCode(ResponseCode.SERVICE_NOT_AVAILABLE);</div><div class="line"><span class="number">50</span>:                     response.setRemark(<span class="string">"service not available now."</span>);</div><div class="line"><span class="number">51</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">52</span>:                 <span class="keyword">case</span> OS_PAGECACHE_BUSY:</div><div class="line"><span class="number">53</span>:                     response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">54</span>:                     response.setRemark(<span class="string">"OS page cache busy, please try another machine"</span>);</div><div class="line"><span class="number">55</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">56</span>:                 <span class="keyword">case</span> UNKNOWN_ERROR:</div><div class="line"><span class="number">57</span>:                     response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">58</span>:                     response.setRemark(<span class="string">"UNKNOWN_ERROR"</span>);</div><div class="line"><span class="number">59</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">60</span>:                 <span class="keyword">default</span>:</div><div class="line"><span class="number">61</span>:                     response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">62</span>:                     response.setRemark(<span class="string">"UNKNOWN_ERROR DEFAULT"</span>);</div><div class="line"><span class="number">63</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">64</span>:             &#125;</div><div class="line"><span class="number">65</span>: </div><div class="line"><span class="number">66</span>:             <span class="keyword">return</span> response;</div><div class="line"><span class="number">67</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">68</span>:             response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">69</span>:             response.setRemark(<span class="string">"store putMessage return null"</span>);</div><div class="line"><span class="number">70</span>:         &#125;</div><div class="line"><span class="number">71</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">72</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">73</span>:         response.setRemark(<span class="string">"find prepared transaction message failed"</span>);</div><div class="line"><span class="number">74</span>:         <span class="keyword">return</span> response;</div><div class="line"><span class="number">75</span>:     &#125;</div><div class="line"><span class="number">76</span>: </div><div class="line"><span class="number">77</span>:     <span class="keyword">return</span> response;</div><div class="line"><span class="number">78</span>: &#125;</div></pre></td></tr></table></figure></p>
<h2>2.3 Broker ç”Ÿæˆ ConsumeQueue</h2>
<ul>
<li>ğŸ¦… äº‹åŠ¡æ¶ˆæ¯ï¼Œæäº¤ï¼ˆ<code>COMMIT</code>ï¼‰åæ‰ç”Ÿæˆ <code>ConsumeQueue</code>ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMessageStore.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(DispatchRequest req)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// éäº‹åŠ¡æ¶ˆæ¯ æˆ– äº‹åŠ¡æäº¤æ¶ˆæ¯ å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue</span></div><div class="line"> <span class="number">4</span>:     <span class="keyword">final</span> <span class="keyword">int</span> tranType = MessageSysFlag.getTransactionValue(req.getSysFlag());</div><div class="line"> <span class="number">5</span>:     <span class="keyword">switch</span> (tranType) &#123;</div><div class="line"> <span class="number">6</span>:         <span class="keyword">case</span> MessageSysFlag.TRANSACTION_NOT_TYPE: <span class="comment">// éäº‹åŠ¡æ¶ˆæ¯</span></div><div class="line"> <span class="number">7</span>:         <span class="keyword">case</span> MessageSysFlag.TRANSACTION_COMMIT_TYPE: <span class="comment">// äº‹åŠ¡æ¶ˆæ¯COMMIT</span></div><div class="line"> <span class="number">8</span>:             DefaultMessageStore.<span class="keyword">this</span>.putMessagePositionInfo(req.getTopic(), req.getQueueId(), req.getCommitLogOffset(), req.getMsgSize(),</div><div class="line"> <span class="number">9</span>:                 req.getTagsCode(), req.getStoreTimestamp(), req.getConsumeQueueOffset());</div><div class="line"><span class="number">10</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">11</span>:         <span class="keyword">case</span> MessageSysFlag.TRANSACTION_PREPARED_TYPE: <span class="comment">// äº‹åŠ¡æ¶ˆæ¯PREPARED</span></div><div class="line"><span class="number">12</span>:         <span class="keyword">case</span> MessageSysFlag.TRANSACTION_ROLLBACK_TYPE: <span class="comment">// äº‹åŠ¡æ¶ˆæ¯ROLLBACK</span></div><div class="line"><span class="number">13</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">14</span>:     &#125;</div><div class="line"><span class="number">15</span>:     <span class="comment">// çœç•¥ä»£ç  =ã€‹ å»ºç«‹ ç´¢å¼•ä¿¡æ¯ åˆ° IndexFile</span></div><div class="line"><span class="number">16</span>: &#125;</div></pre></td></tr></table></figure></p>
<h1>3. äº‹åŠ¡æ¶ˆæ¯å›æŸ¥</h1>
<ul>
<li>ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘åŠŸèƒ½æ›¾ç»å¼€æºè¿‡ï¼Œç›®å‰ï¼ˆV4.0.0ï¼‰æš‚æœªå¼€æºã€‚å¦‚ä¸‹æ˜¯è¯¥åŠŸèƒ½çš„å¼€æºæƒ…å†µï¼š</li>
</ul>
<table>
<thead>
<tr>
<th>ç‰ˆæœ¬</th>
<th>ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>å®˜æ–¹V3.0.4 ~ V3.1.4</td>
<td>åŸºäº æ–‡ä»¶ç³»ç»Ÿ å®ç°</td>
<td>å·²å¼€æº</td>
</tr>
<tr>
<td>å®˜æ–¹V3.1.5 ~ V4.0.0</td>
<td>åŸºäº æ•°æ®åº“ å®ç°</td>
<td>æœªå®Œå…¨å¼€æº</td>
</tr>
</tbody>
</table>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹ä¸¤ç§æƒ…å†µä¸‹æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>
<h2>3.1 Broker å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘</h2>
<h3>3.1.1 å®˜æ–¹V3.1.4ï¼šåŸºäºæ–‡ä»¶ç³»ç»Ÿ</h3>
<blockquote>
<p>ä»“åº“åœ°å€ï¼šhttps://github.com/YunaiV/rocketmq-3.1.9/tree/release_3.1.4</p>
</blockquote>
<p>ç›¸è¾ƒäºæ™®é€šæ¶ˆæ¯ï¼Œã€äº‹åŠ¡æ¶ˆæ¯ã€‘å¤šä¾èµ–å¦‚ä¸‹ä¸‰ä¸ªç»„ä»¶ï¼š</p>
<ul>
<li><strong>TransactionStateService</strong> ï¼šäº‹åŠ¡çŠ¶æ€æœåŠ¡ï¼Œè´Ÿè´£å¯¹ã€äº‹åŠ¡æ¶ˆæ¯ã€‘è¿›è¡Œç®¡ç†ï¼ŒåŒ…æ‹¬å­˜å‚¨ä¸æ›´æ–°äº‹åŠ¡æ¶ˆæ¯çŠ¶æ€ã€å›æŸ¥äº‹åŠ¡æ¶ˆæ¯çŠ¶æ€ç­‰ç­‰ã€‚</li>
<li><strong>TranStateTable</strong> ï¼šã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ã€‚åŸºäº <code>MappedFileQueue</code> å®ç°ï¼Œé»˜è®¤å­˜å‚¨è·¯å¾„ä¸º <code>~/store/transaction/statetable</code>ï¼Œæ¯æ¡ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼š</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">ç¬¬å‡ ä½</th>
<th style="text-align:left">å­—æ®µ</th>
<th style="text-align:left">è¯´æ˜</th>
<th style="text-align:left">æ•°æ®ç±»å‹</th>
<th style="text-align:left">å­—èŠ‚æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">offset</td>
<td style="text-align:left">CommitLog ç‰©ç†å­˜å‚¨ä½ç½®</td>
<td style="text-align:left">Long</td>
<td style="text-align:left">8</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">size</td>
<td style="text-align:left">æ¶ˆæ¯é•¿åº¦</td>
<td style="text-align:left">Int</td>
<td style="text-align:left">4</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">timestamp</td>
<td style="text-align:left">æ¶ˆæ¯å­˜å‚¨æ—¶é—´ï¼Œå•ä½ï¼šç§’</td>
<td style="text-align:left">Int</td>
<td style="text-align:left">4</td>
</tr>
<tr>
<td style="text-align:left">4</td>
<td style="text-align:left">producerGroupHash</td>
<td style="text-align:left">producerGroup æ±‚ HashCode</td>
<td style="text-align:left">Int</td>
<td style="text-align:left">4</td>
</tr>
<tr>
<td style="text-align:left">5</td>
<td style="text-align:left">state</td>
<td style="text-align:left">äº‹åŠ¡çŠ¶æ€</td>
<td style="text-align:left">Int</td>
<td style="text-align:left">4</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>TranRedoLog</strong> ï¼š<code>TranStateTable</code> é‡æ”¾æ—¥å¿—ï¼Œæ¯æ¬¡<strong>å†™æ“ä½œ</strong> <code>TranStateTable</code> è®°å½•é‡æ”¾æ—¥å¿—ã€‚å½“ <code>Broker</code> å¼‚å¸¸å…³é—­æ—¶ï¼Œä½¿ç”¨ <code>TranRedoLog</code> æ¢å¤ <code>TranStateTable</code>ã€‚åŸºäº <code>ConsumeQueue</code> å®ç°ï¼Œ<code>Topic</code> ä¸º <code>TRANSACTION_REDOLOG_TOPIC_XXXX</code>ï¼Œé»˜è®¤å­˜å‚¨è·¯å¾„ä¸º <code>~/store/transaction/redolog</code>ã€‚</li>
</ul>
<hr>
<p>ç®€å•æ‰‹ç»˜é€»è¾‘å›¾å¦‚ä¸‹ğŸ˜ˆï¼š</p>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_21/01.jpeg" alt="Broker_V3.1.4_åŸºäºæ–‡ä»¶ç³»ç»Ÿ"></p>
<h4>3.1.1.1 å­˜å‚¨æ¶ˆæ¯åˆ° CommitLog</h4>
<ul>
<li>ğŸ¦…å­˜å‚¨ã€halfæ¶ˆæ¯ã€‘åˆ° <code>CommitLog</code> æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ<code>queueOffset</code>ï¼‰ä½¿ç”¨ <code>TranStateTable</code> æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ç‰©ç†ä½ç½®ï¼‰ã€‚è¿™æ ·ï¼Œæ¶ˆæ¯å¯ä»¥ç´¢å¼•åˆ°è‡ªå·±å¯¹åº”çš„ <code>TranStateTable</code> çš„ä½ç½®å’Œè®°å½•ã€‚</li>
</ul>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultAppendMessageCallback.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="class"><span class="keyword">class</span> <span class="title">DefaultAppendMessageCallback</span> <span class="keyword">implements</span> <span class="title">AppendMessageCallback</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="function"><span class="keyword">public</span> AppendMessageResult <span class="title">doAppend</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> fileFromOffset, <span class="keyword">final</span> ByteBuffer byteBuffer,  <span class="keyword">final</span> <span class="keyword">int</span> maxBlank, <span class="keyword">final</span> Object msg)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>:         <span class="comment">// ...çœç•¥ä»£ç </span></div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:         <span class="comment">// äº‹åŠ¡æ¶ˆæ¯éœ€è¦ç‰¹æ®Šå¤„ç† </span></div><div class="line"> <span class="number">7</span>:         <span class="keyword">final</span> <span class="keyword">int</span> tranType = MessageSysFlag.getTransactionValue(msgInner.getSysFlag());</div><div class="line"> <span class="number">8</span>:         <span class="keyword">switch</span> (tranType) &#123;</div><div class="line"> <span class="number">9</span>:         <span class="keyword">case</span> MessageSysFlag.TransactionPreparedType: <span class="comment">// æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆqueueOffsetï¼‰ä½¿ç”¨ TranStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ç‰©ç†ä½ç½®ï¼‰ </span></div><div class="line"><span class="number">10</span>:             queueOffset = CommitLog.<span class="keyword">this</span>.defaultMessageStore.getTransactionStateService().getTranStateTableOffset().get();</div><div class="line"><span class="number">11</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">12</span>:         <span class="keyword">case</span> MessageSysFlag.TransactionRollbackType:</div><div class="line"><span class="number">13</span>:             queueOffset = msgInner.getQueueOffset();</div><div class="line"><span class="number">14</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">15</span>:         <span class="keyword">case</span> MessageSysFlag.TransactionNotType:</div><div class="line"><span class="number">16</span>:         <span class="keyword">case</span> MessageSysFlag.TransactionCommitType:</div><div class="line"><span class="number">17</span>:         <span class="keyword">default</span>:</div><div class="line"><span class="number">18</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">19</span>:         &#125;</div><div class="line"><span class="number">20</span>: </div><div class="line"><span class="number">21</span>:         <span class="comment">// ...çœç•¥ä»£ç </span></div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>:         <span class="keyword">switch</span> (tranType) &#123;</div><div class="line"><span class="number">24</span>:         <span class="keyword">case</span> MessageSysFlag.TransactionPreparedType:</div><div class="line"><span class="number">25</span>:             <span class="comment">// æ›´æ–° TranStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ç‰©ç†ä½ç½®ï¼‰ </span></div><div class="line"><span class="number">26</span>:             CommitLog.<span class="keyword">this</span>.defaultMessageStore.getTransactionStateService().getTranStateTableOffset().incrementAndGet();</div><div class="line"><span class="number">27</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">28</span>:         <span class="keyword">case</span> MessageSysFlag.TransactionRollbackType:</div><div class="line"><span class="number">29</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">30</span>:         <span class="keyword">case</span> MessageSysFlag.TransactionNotType:</div><div class="line"><span class="number">31</span>:         <span class="keyword">case</span> MessageSysFlag.TransactionCommitType:</div><div class="line"><span class="number">32</span>:             <span class="comment">// æ›´æ–°ä¸‹ä¸€æ¬¡çš„ConsumeQueueä¿¡æ¯</span></div><div class="line"><span class="number">33</span>:             CommitLog.<span class="keyword">this</span>.topicQueueTable.put(key, ++queueOffset);</div><div class="line"><span class="number">34</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">35</span>:         <span class="keyword">default</span>:</div><div class="line"><span class="number">36</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">37</span>:         &#125;</div><div class="line"><span class="number">38</span>: </div><div class="line"><span class="number">39</span>:         <span class="comment">// è¿”å›ç»“æœ</span></div><div class="line"><span class="number">40</span>:         <span class="keyword">return</span> result;</div><div class="line"><span class="number">41</span>:     &#125;</div><div class="line"><span class="number">42</span>: &#125;</div></pre></td></tr></table></figure></p>
<h4>3.1.1.2 å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰</h4>
<ul>
<li>ğŸ¦…å¤„ç†ã€Halfæ¶ˆæ¯ã€‘æ—¶ï¼Œæ–°å¢ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆ<code>TranStateTable</code>ï¼‰ã€‚</li>
<li>ğŸ¦…å¤„ç†ã€Commit / Rollbackæ¶ˆæ¯ã€‘æ—¶ï¼Œæ›´æ–° ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆ<code>TranStateTable</code>ï¼‰ COMMIT / ROLLBACKã€‚</li>
<li>ğŸ¦…æ¯æ¬¡**å†™æ“ä½œã€**äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆ<code>TranStateTable</code>ï¼‰ï¼Œè®°å½•é‡æ”¾æ—¥å¿—ï¼ˆ<code>TranRedoLog</code>ï¼‰ã€‚</li>
</ul>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DispatchMessageService.javaã€‘</span></div><div class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="number">3</span>:     <span class="keyword">if</span> (!<span class="keyword">this</span>.requestsRead.isEmpty()) &#123;</div><div class="line">  <span class="number">4</span>:         <span class="keyword">for</span> (DispatchRequest req : <span class="keyword">this</span>.requestsRead) &#123;</div><div class="line">  <span class="number">5</span>: </div><div class="line">  <span class="number">6</span>:             <span class="comment">// ...çœç•¥ä»£ç </span></div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:             <span class="comment">// 2ã€å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰</span></div><div class="line">  <span class="number">9</span>:             <span class="keyword">if</span> (req.getProducerGroup() != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">10</span>:                 <span class="keyword">switch</span> (tranType) &#123;</div><div class="line"> <span class="number">11</span>:                 <span class="keyword">case</span> MessageSysFlag.TransactionNotType:</div><div class="line"> <span class="number">12</span>:                     <span class="keyword">break</span>;</div><div class="line"> <span class="number">13</span>:                 <span class="keyword">case</span> MessageSysFlag.TransactionPreparedType:</div><div class="line"> <span class="number">14</span>:                     <span class="comment">// æ–°å¢ ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰</span></div><div class="line"> <span class="number">15</span>:                     DefaultMessageStore.<span class="keyword">this</span>.getTransactionStateService().appendPreparedTransaction(</div><div class="line"> <span class="number">16</span>:                         req.getCommitLogOffset(), req.getMsgSize(), (<span class="keyword">int</span>) (req.getStoreTimestamp() / <span class="number">1000</span>), req.getProducerGroup().hashCode());</div><div class="line"> <span class="number">17</span>:                     <span class="keyword">break</span>;</div><div class="line"> <span class="number">18</span>:                 <span class="keyword">case</span> MessageSysFlag.TransactionCommitType:</div><div class="line"> <span class="number">19</span>:                 <span class="keyword">case</span> MessageSysFlag.TransactionRollbackType:</div><div class="line"> <span class="number">20</span>:                     <span class="comment">// æ›´æ–° ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰ COMMIT / ROLLBACK</span></div><div class="line"> <span class="number">21</span>:                     DefaultMessageStore.<span class="keyword">this</span>.getTransactionStateService().updateTransactionState(</div><div class="line"> <span class="number">22</span>:                         req.getTranStateTableOffset(), req.getPreparedTransactionOffset(), req.getProducerGroup().hashCode(), tranType);</div><div class="line"> <span class="number">23</span>:                     <span class="keyword">break</span>;</div><div class="line"> <span class="number">24</span>:                 &#125;</div><div class="line"> <span class="number">25</span>:             &#125;</div><div class="line"> <span class="number">26</span>:             <span class="comment">// 3ã€è®°å½• TranRedoLog</span></div><div class="line"> <span class="number">27</span>:             <span class="keyword">switch</span> (tranType) &#123;</div><div class="line"> <span class="number">28</span>:             <span class="keyword">case</span> MessageSysFlag.TransactionNotType:</div><div class="line"> <span class="number">29</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">30</span>:             <span class="keyword">case</span> MessageSysFlag.TransactionPreparedType:</div><div class="line"> <span class="number">31</span>:                 <span class="comment">// è®°å½• TranRedoLog</span></div><div class="line"> <span class="number">32</span>:                 DefaultMessageStore.<span class="keyword">this</span>.getTransactionStateService().getTranRedoLog().putMessagePostionInfoWrapper(</div><div class="line"> <span class="number">33</span>:                         req.getCommitLogOffset(), req.getMsgSize(), TransactionStateService.PreparedMessageTagsCode,</div><div class="line"> <span class="number">34</span>:                         req.getStoreTimestamp(), <span class="number">0L</span>);</div><div class="line"> <span class="number">35</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">36</span>:             <span class="keyword">case</span> MessageSysFlag.TransactionCommitType:</div><div class="line"> <span class="number">37</span>:             <span class="keyword">case</span> MessageSysFlag.TransactionRollbackType:</div><div class="line"> <span class="number">38</span>:                 <span class="comment">// è®°å½• TranRedoLog</span></div><div class="line"> <span class="number">39</span>:                 DefaultMessageStore.<span class="keyword">this</span>.getTransactionStateService().getTranRedoLog().putMessagePostionInfoWrapper(</div><div class="line"> <span class="number">40</span>:                         req.getCommitLogOffset(), req.getMsgSize(), req.getPreparedTransactionOffset(),</div><div class="line"> <span class="number">41</span>:                         req.getStoreTimestamp(), <span class="number">0L</span>);</div><div class="line"> <span class="number">42</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">43</span>:             &#125;</div><div class="line"> <span class="number">44</span>:         &#125;</div><div class="line"> <span class="number">45</span>: </div><div class="line"> <span class="number">46</span>:         <span class="comment">// ...çœç•¥ä»£ç </span></div><div class="line"> <span class="number">47</span>:     &#125;</div><div class="line"> <span class="number">48</span>: &#125;</div><div class="line"> <span class="number">49</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€TransactionStateService.javaã€‘</span></div><div class="line"> <span class="number">50</span>: <span class="comment">/**</span></div><div class="line"> 51:  * æ–°å¢äº‹åŠ¡çŠ¶æ€</div><div class="line"> 52:  *</div><div class="line"> 53:  * <span class="doctag">@param</span> clOffset commitLog ç‰©ç†ä½ç½®</div><div class="line"> 54:  * <span class="doctag">@param</span> size æ¶ˆæ¯é•¿åº¦</div><div class="line"> 55:  * <span class="doctag">@param</span> timestamp æ¶ˆæ¯å­˜å‚¨æ—¶é—´</div><div class="line"> 56:  * <span class="doctag">@param</span> groupHashCode groupHashCode</div><div class="line"> 57:  * <span class="doctag">@return</span> æ˜¯å¦æˆåŠŸ</div><div class="line"> 58:  */</div><div class="line"> <span class="number">59</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">appendPreparedTransaction</span><span class="params">(//</span></span></div><div class="line"> <span class="number">60</span>:         <span class="keyword">final</span> <span class="keyword">long</span> clOffset,//</div><div class="line"> <span class="number">61</span>:         <span class="keyword">final</span> <span class="keyword">int</span> size,//</div><div class="line"> <span class="number">62</span>:         <span class="keyword">final</span> <span class="keyword">int</span> timestamp,//</div><div class="line"> <span class="number">63</span>:         <span class="keyword">final</span> <span class="keyword">int</span> groupHashCode//</div><div class="line"> <span class="number">64</span>: ) &#123;</div><div class="line"> <span class="number">65</span>:     MapedFile mapedFile = <span class="keyword">this</span>.tranStateTable.getLastMapedFile();</div><div class="line"> <span class="number">66</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == mapedFile) &#123;</div><div class="line"> <span class="number">67</span>:         log.error(<span class="string">"appendPreparedTransaction: create mapedfile error."</span>);</div><div class="line"> <span class="number">68</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"> <span class="number">69</span>:     &#125;</div><div class="line"> <span class="number">70</span>: </div><div class="line"> <span class="number">71</span>:     <span class="comment">// é¦–æ¬¡åˆ›å»ºï¼ŒåŠ å…¥å®šæ—¶ä»»åŠ¡ä¸­</span></div><div class="line"> <span class="number">72</span>:     <span class="keyword">if</span> (<span class="number">0</span> == mapedFile.getWrotePostion()) &#123;</div><div class="line"> <span class="number">73</span>:         <span class="keyword">this</span>.addTimerTask(mapedFile);</div><div class="line"> <span class="number">74</span>:     &#125;</div><div class="line"> <span class="number">75</span>: </div><div class="line"> <span class="number">76</span>:     <span class="keyword">this</span>.byteBufferAppend.position(<span class="number">0</span>);</div><div class="line"> <span class="number">77</span>:     <span class="keyword">this</span>.byteBufferAppend.limit(TSStoreUnitSize);</div><div class="line"> <span class="number">78</span>: </div><div class="line"> <span class="number">79</span>:     <span class="comment">// Commit Log Offset</span></div><div class="line"> <span class="number">80</span>:     <span class="keyword">this</span>.byteBufferAppend.putLong(clOffset);</div><div class="line"> <span class="number">81</span>:     <span class="comment">// Message Size</span></div><div class="line"> <span class="number">82</span>:     <span class="keyword">this</span>.byteBufferAppend.putInt(size);</div><div class="line"> <span class="number">83</span>:     <span class="comment">// Timestamp</span></div><div class="line"> <span class="number">84</span>:     <span class="keyword">this</span>.byteBufferAppend.putInt(timestamp);</div><div class="line"> <span class="number">85</span>:     <span class="comment">// Producer Group Hashcode</span></div><div class="line"> <span class="number">86</span>:     <span class="keyword">this</span>.byteBufferAppend.putInt(groupHashCode);</div><div class="line"> <span class="number">87</span>:     <span class="comment">// Transaction State</span></div><div class="line"> <span class="number">88</span>:     <span class="keyword">this</span>.byteBufferAppend.putInt(MessageSysFlag.TransactionPreparedType);</div><div class="line"> <span class="number">89</span>: </div><div class="line"> <span class="number">90</span>:     <span class="keyword">return</span> mapedFile.appendMessage(<span class="keyword">this</span>.byteBufferAppend.array());</div><div class="line"> <span class="number">91</span>: &#125;</div><div class="line"> <span class="number">92</span>: </div><div class="line"> <span class="number">93</span>: <span class="comment">/**</span></div><div class="line"> 94:  * æ›´æ–°äº‹åŠ¡çŠ¶æ€</div><div class="line"> 95:  *</div><div class="line"> 96:  * <span class="doctag">@param</span> tsOffset tranStateTable ç‰©ç†ä½ç½®</div><div class="line"> 97:  * <span class="doctag">@param</span> clOffset commitLog ç‰©ç†ä½ç½®</div><div class="line"> 98:  * <span class="doctag">@param</span> groupHashCode groupHashCode</div><div class="line"> 99:  * <span class="doctag">@param</span> state äº‹åŠ¡çŠ¶æ€</div><div class="line">100:  * <span class="doctag">@return</span> æ˜¯å¦æˆåŠŸ</div><div class="line">101:  */</div><div class="line"><span class="number">102</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updateTransactionState</span><span class="params">(</span></span></div><div class="line"><span class="number">103</span>:         <span class="keyword">final</span> <span class="keyword">long</span> tsOffset,</div><div class="line"><span class="number">104</span>:         <span class="keyword">final</span> <span class="keyword">long</span> clOffset,</div><div class="line"><span class="number">105</span>:         <span class="keyword">final</span> <span class="keyword">int</span> groupHashCode,</div><div class="line"><span class="number">106</span>:         <span class="keyword">final</span> <span class="keyword">int</span> state) &#123;</div><div class="line"><span class="number">107</span>:     SelectMapedBufferResult selectMapedBufferResult = <span class="keyword">this</span>.findTransactionBuffer(tsOffset);</div><div class="line"><span class="number">108</span>:     <span class="keyword">if</span> (selectMapedBufferResult != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">109</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">110</span>: </div><div class="line"><span class="number">111</span>:             <span class="comment">// ....çœç•¥ä»£ç ï¼šæ ¡éªŒæ˜¯å¦èƒ½å¤Ÿæ›´æ–°</span></div><div class="line"><span class="number">112</span>: </div><div class="line"><span class="number">113</span>:             <span class="comment">// æ›´æ–°äº‹åŠ¡çŠ¶æ€</span></div><div class="line"><span class="number">114</span>:             selectMapedBufferResult.getByteBuffer().putInt(TS_STATE_POS, state);</div><div class="line"><span class="number">115</span>:         &#125;</div><div class="line"><span class="number">116</span>:         <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">117</span>:             log.error(<span class="string">"updateTransactionState exception"</span>, e);</div><div class="line"><span class="number">118</span>:         &#125;</div><div class="line"><span class="number">119</span>:         <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">120</span>:             selectMapedBufferResult.release();</div><div class="line"><span class="number">121</span>:         &#125;</div><div class="line"><span class="number">122</span>:     &#125;</div><div class="line"><span class="number">123</span>: </div><div class="line"><span class="number">124</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">125</span>: &#125;</div></pre></td></tr></table></figure></p>
<h4>3.1.1.3 ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥</h4>
<ul>
<li>ğŸ¦…<code>TranStateTable</code> æ¯ä¸ª <code>MappedFile</code> éƒ½å¯¹åº”ä¸€ä¸ª <code>Timer</code>ã€‚<code>Timer</code> å›ºå®šå‘¨æœŸï¼ˆé»˜è®¤ï¼š60sï¼‰éå† <code>MappedFile</code>ï¼ŒæŸ¥æ‰¾ã€halfæ¶ˆæ¯ã€‘ï¼Œå‘ <code>Producer</code> å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥è¯·æ±‚ã€‚ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥ç»“æœçš„é€»è¾‘ä¸åœ¨æ­¤å¤„è¿›è¡Œï¼Œåœ¨ <a href="#3112-%E5%86%99%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%E7%8A%B6%E6%80%81%E5%AD%98%E5%82%A8transtatetable">CommitLog dispatch</a>æ—¶æ‰§è¡Œã€‚</li>
</ul>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€TransactionStateService.javaã€‘</span></div><div class="line">  <span class="number">2</span>: <span class="comment">/**</span></div><div class="line">  3:  * åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡</div><div class="line">  4:  */</div><div class="line">  <span class="number">5</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initTimerTask</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="number">6</span>:     <span class="comment">//</span></div><div class="line">  <span class="number">7</span>:     <span class="keyword">final</span> List&lt;MapedFile&gt; mapedFiles = <span class="keyword">this</span>.tranStateTable.getMapedFiles();</div><div class="line">  <span class="number">8</span>:     <span class="keyword">for</span> (MapedFile mf : mapedFiles) &#123;</div><div class="line">  <span class="number">9</span>:         <span class="keyword">this</span>.addTimerTask(mf);</div><div class="line"> <span class="number">10</span>:     &#125;</div><div class="line"> <span class="number">11</span>: &#125;</div><div class="line"> <span class="number">12</span>: </div><div class="line"> <span class="number">13</span>: <span class="comment">/**</span></div><div class="line"> 14:  * æ¯ä¸ªæ–‡ä»¶åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡</div><div class="line"> 15:  * <span class="doctag">@param</span> mf æ–‡ä»¶</div><div class="line"> 16:  */</div><div class="line"> <span class="number">17</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addTimerTask</span><span class="params">(<span class="keyword">final</span> MapedFile mf)</span> </span>&#123;</div><div class="line"> <span class="number">18</span>:     <span class="keyword">this</span>.timer.scheduleAtFixedRate(<span class="keyword">new</span> TimerTask() &#123;</div><div class="line"> <span class="number">19</span>:         <span class="keyword">private</span> <span class="keyword">final</span> MapedFile mapedFile = mf;</div><div class="line"> <span class="number">20</span>:         <span class="keyword">private</span> <span class="keyword">final</span> TransactionCheckExecuter transactionCheckExecuter = TransactionStateService.<span class="keyword">this</span>.defaultMessageStore.getTransactionCheckExecuter();</div><div class="line"> <span class="number">21</span>:         <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> checkTransactionMessageAtleastInterval = TransactionStateService.<span class="keyword">this</span>.defaultMessageStore.getMessageStoreConfig()</div><div class="line"> <span class="number">22</span>:                     .getCheckTransactionMessageAtleastInterval();</div><div class="line"> <span class="number">23</span>:         <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> slave = TransactionStateService.<span class="keyword">this</span>.defaultMessageStore.getMessageStoreConfig().getBrokerRole() == BrokerRole.SLAVE;</div><div class="line"> <span class="number">24</span>: </div><div class="line"> <span class="number">25</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">26</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">27</span>:             <span class="comment">// Slaveä¸éœ€è¦å›æŸ¥äº‹åŠ¡çŠ¶æ€</span></div><div class="line"> <span class="number">28</span>:             <span class="keyword">if</span> (slave) &#123;</div><div class="line"> <span class="number">29</span>:                 <span class="keyword">return</span>;</div><div class="line"> <span class="number">30</span>:             &#125;</div><div class="line"> <span class="number">31</span>:             <span class="comment">// CheckåŠŸèƒ½æ˜¯å¦å¼€å¯</span></div><div class="line"> <span class="number">32</span>:             <span class="keyword">if</span> (!TransactionStateService.<span class="keyword">this</span>.defaultMessageStore.getMessageStoreConfig()</div><div class="line"> <span class="number">33</span>:                 .isCheckTransactionMessageEnable()) &#123;</div><div class="line"> <span class="number">34</span>:                 <span class="keyword">return</span>;</div><div class="line"> <span class="number">35</span>:             &#125;</div><div class="line"> <span class="number">36</span>: </div><div class="line"> <span class="number">37</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">38</span>:                 SelectMapedBufferResult selectMapedBufferResult = mapedFile.selectMapedBuffer(<span class="number">0</span>);</div><div class="line"> <span class="number">39</span>:                 <span class="keyword">if</span> (selectMapedBufferResult != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">40</span>:                     <span class="keyword">long</span> preparedMessageCountInThisMapedFile = <span class="number">0</span>; <span class="comment">// å›æŸ¥çš„ã€halfæ¶ˆæ¯ã€‘æ•°é‡</span></div><div class="line"> <span class="number">41</span>:                     <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line"> <span class="number">42</span>:                     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">43</span>:                         <span class="comment">// å¾ªç¯æ¯æ¡ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€ï¼Œå¯¹ã€halfæ¶ˆæ¯ã€‘è¿›è¡Œå›æŸ¥</span></div><div class="line"> <span class="number">44</span>:                         <span class="keyword">for</span> (; i &lt; selectMapedBufferResult.getSize(); i += TSStoreUnitSize) &#123;</div><div class="line"> <span class="number">45</span>:                             selectMapedBufferResult.getByteBuffer().position(i);</div><div class="line"> <span class="number">46</span>: </div><div class="line"> <span class="number">47</span>:                             <span class="comment">// Commit Log Offset</span></div><div class="line"> <span class="number">48</span>:                             <span class="keyword">long</span> clOffset = selectMapedBufferResult.getByteBuffer().getLong();</div><div class="line"> <span class="number">49</span>:                             <span class="comment">// Message Size</span></div><div class="line"> <span class="number">50</span>:                             <span class="keyword">int</span> msgSize = selectMapedBufferResult.getByteBuffer().getInt();</div><div class="line"> <span class="number">51</span>:                             <span class="comment">// Timestamp</span></div><div class="line"> <span class="number">52</span>:                             <span class="keyword">int</span> timestamp = selectMapedBufferResult.getByteBuffer().getInt();</div><div class="line"> <span class="number">53</span>:                             <span class="comment">// Producer Group Hashcode</span></div><div class="line"> <span class="number">54</span>:                             <span class="keyword">int</span> groupHashCode = selectMapedBufferResult.getByteBuffer().getInt();</div><div class="line"> <span class="number">55</span>:                             <span class="comment">// Transaction State</span></div><div class="line"> <span class="number">56</span>:                             <span class="keyword">int</span> tranType = selectMapedBufferResult.getByteBuffer().getInt();</div><div class="line"> <span class="number">57</span>: </div><div class="line"> <span class="number">58</span>:                             <span class="comment">// å·²ç»æäº¤æˆ–è€…å›æ»šçš„æ¶ˆæ¯è·³è¿‡</span></div><div class="line"> <span class="number">59</span>:                             <span class="keyword">if</span> (tranType != MessageSysFlag.TransactionPreparedType) &#123;</div><div class="line"> <span class="number">60</span>:                                 <span class="keyword">continue</span>;</div><div class="line"> <span class="number">61</span>:                             &#125;</div><div class="line"> <span class="number">62</span>: </div><div class="line"> <span class="number">63</span>:                             <span class="comment">// é‡åˆ°æ—¶é—´ä¸ç¬¦åˆæœ€å°è½®è¯¢é—´éš”ï¼Œç»ˆæ­¢</span></div><div class="line"> <span class="number">64</span>:                             <span class="keyword">long</span> timestampLong = timestamp * <span class="number">1000</span>;</div><div class="line"> <span class="number">65</span>:                             <span class="keyword">long</span> diff = System.currentTimeMillis() - timestampLong;</div><div class="line"> <span class="number">66</span>:                             <span class="keyword">if</span> (diff &lt; checkTransactionMessageAtleastInterval) &#123;</div><div class="line"> <span class="number">67</span>:                                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">68</span>:                             &#125;</div><div class="line"> <span class="number">69</span>: </div><div class="line"> <span class="number">70</span>:                             preparedMessageCountInThisMapedFile++;</div><div class="line"> <span class="number">71</span>: </div><div class="line"> <span class="number">72</span>:                             <span class="comment">// å›æŸ¥Producer</span></div><div class="line"> <span class="number">73</span>:                             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">74</span>:                                 <span class="keyword">this</span>.transactionCheckExecuter.gotoCheck(groupHashCode, getTranStateOffset(i), clOffset, msgSize);</div><div class="line"> <span class="number">75</span>:                             &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">76</span>:                                 tranlog.warn(<span class="string">"gotoCheck Exception"</span>, e);</div><div class="line"> <span class="number">77</span>:                             &#125;</div><div class="line"> <span class="number">78</span>:                         &#125;</div><div class="line"> <span class="number">79</span>: </div><div class="line"> <span class="number">80</span>:                         <span class="comment">// æ— å›æŸ¥çš„ã€halfæ¶ˆæ¯ã€‘æ•°é‡ï¼Œä¸”éå†å®Œï¼Œåˆ™ç»ˆæ­¢å®šæ—¶ä»»åŠ¡</span></div><div class="line"> <span class="number">81</span>:                         <span class="keyword">if</span> (<span class="number">0</span> == preparedMessageCountInThisMapedFile <span class="comment">//</span></div><div class="line"> <span class="number">82</span>:                                 &amp;&amp; i == mapedFile.getFileSize()) &#123;</div><div class="line"> <span class="number">83</span>:                             tranlog.info(<span class="string">"remove the transaction timer task, because no prepared message in this mapedfile[&#123;&#125;]"</span>, mapedFile.getFileName());</div><div class="line"> <span class="number">84</span>:                             <span class="keyword">this</span>.cancel();</div><div class="line"> <span class="number">85</span>:                         &#125;</div><div class="line"> <span class="number">86</span>:                     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"> <span class="number">87</span>:                         selectMapedBufferResult.release();</div><div class="line"> <span class="number">88</span>:                     &#125;</div><div class="line"> <span class="number">89</span>: </div><div class="line"> <span class="number">90</span>:                     tranlog.info(<span class="string">"the transaction timer task execute over in this period, &#123;&#125; Prepared Message: &#123;&#125; Check Progress: &#123;&#125;/&#123;&#125;"</span>, mapedFile.getFileName(),<span class="comment">//</span></div><div class="line"> <span class="number">91</span>:                             preparedMessageCountInThisMapedFile, i / TSStoreUnitSize, mapedFile.getFileSize() / TSStoreUnitSize);</div><div class="line"> <span class="number">92</span>:                 &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mapedFile.isFull()) &#123;</div><div class="line"> <span class="number">93</span>:                     tranlog.info(<span class="string">"the mapedfile[&#123;&#125;] maybe deleted, cancel check transaction timer task"</span>, mapedFile.getFileName());</div><div class="line"> <span class="number">94</span>:                     <span class="keyword">this</span>.cancel();</div><div class="line"> <span class="number">95</span>:                     <span class="keyword">return</span>;</div><div class="line"> <span class="number">96</span>:                 &#125;</div><div class="line"> <span class="number">97</span>:             &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">98</span>:                 log.error(<span class="string">"check transaction timer task Exception"</span>, e);</div><div class="line"> <span class="number">99</span>:             &#125;</div><div class="line"><span class="number">100</span>:         &#125;</div><div class="line"><span class="number">101</span>: </div><div class="line"><span class="number">102</span>: </div><div class="line"><span class="number">103</span>:         <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">getTranStateOffset</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> currentIndex)</span> </span>&#123;</div><div class="line"><span class="number">104</span>:             <span class="keyword">long</span> offset = (<span class="keyword">this</span>.mapedFile.getFileFromOffset() + currentIndex) / TransactionStateService.TSStoreUnitSize;</div><div class="line"><span class="number">105</span>:             <span class="keyword">return</span> offset;</div><div class="line"><span class="number">106</span>:         &#125;</div><div class="line"><span class="number">107</span>:     &#125;, <span class="number">1000</span> * <span class="number">60</span>, <span class="keyword">this</span>.defaultMessageStore.getMessageStoreConfig().getCheckTransactionMessageTimerInterval());</div><div class="line"><span class="number">108</span>: &#125;</div><div class="line"><span class="number">109</span>: </div><div class="line"><span class="number">110</span>: <span class="comment">// ã€DefaultTransactionCheckExecuter.javaã€‘</span></div><div class="line"><span class="number">111</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">112</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">gotoCheck</span><span class="params">(<span class="keyword">int</span> producerGroupHashCode, <span class="keyword">long</span> tranStateTableOffset, <span class="keyword">long</span> commitLogOffset,</span></span></div><div class="line"><span class="number">113</span>:         <span class="keyword">int</span> msgSize) &#123;</div><div class="line"><span class="number">114</span>:     <span class="comment">// ç¬¬ä¸€æ­¥ã€æŸ¥è¯¢Producer</span></div><div class="line"><span class="number">115</span>:     <span class="keyword">final</span> ClientChannelInfo clientChannelInfo = <span class="keyword">this</span>.brokerController.getProducerManager().pickProducerChannelRandomly(producerGroupHashCode);</div><div class="line"><span class="number">116</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == clientChannelInfo) &#123;</div><div class="line"><span class="number">117</span>:         log.warn(<span class="string">"check a producer transaction state, but not find any channel of this group[&#123;&#125;]"</span>, producerGroupHashCode);</div><div class="line"><span class="number">118</span>:         <span class="keyword">return</span>;</div><div class="line"><span class="number">119</span>:     &#125;</div><div class="line"><span class="number">120</span>: </div><div class="line"><span class="number">121</span>:     <span class="comment">// ç¬¬äºŒæ­¥ã€æŸ¥è¯¢æ¶ˆæ¯</span></div><div class="line"><span class="number">122</span>:     SelectMapedBufferResult selectMapedBufferResult = <span class="keyword">this</span>.brokerController.getMessageStore().selectOneMessageByOffset(commitLogOffset, msgSize);</div><div class="line"><span class="number">123</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == selectMapedBufferResult) &#123;</div><div class="line"><span class="number">124</span>:         log.warn(<span class="string">"check a producer transaction state, but not find message by commitLogOffset: &#123;&#125;, msgSize: "</span>, commitLogOffset, msgSize);</div><div class="line"><span class="number">125</span>:         <span class="keyword">return</span>;</div><div class="line"><span class="number">126</span>:     &#125;</div><div class="line"><span class="number">127</span>: </div><div class="line"><span class="number">128</span>:     <span class="comment">// ç¬¬ä¸‰æ­¥ã€å‘Producerå‘èµ·è¯·æ±‚</span></div><div class="line"><span class="number">129</span>:     <span class="keyword">final</span> CheckTransactionStateRequestHeader requestHeader = <span class="keyword">new</span> CheckTransactionStateRequestHeader();</div><div class="line"><span class="number">130</span>:     requestHeader.setCommitLogOffset(commitLogOffset);</div><div class="line"><span class="number">131</span>:     requestHeader.setTranStateTableOffset(tranStateTableOffset);</div><div class="line"><span class="number">132</span>:     <span class="keyword">this</span>.brokerController.getBroker2Client().checkProducerTransactionState(clientChannelInfo.getChannel(), requestHeader, selectMapedBufferResult);</div><div class="line"><span class="number">133</span>: &#125;</div></pre></td></tr></table></figure></p>
<h4>3.1.1.4 åˆå§‹åŒ–ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰</h4>
<ul>
<li>ğŸ¦…æ ¹æ®æœ€å Broker å…³é—­æ˜¯å¦æ­£å¸¸ï¼Œä¼šæœ‰ä¸åŒçš„åˆå§‹åŒ–æ–¹å¼ã€‚</li>
</ul>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€TransactionStateService.javaã€‘</span></div><div class="line">  <span class="number">2</span>: <span class="comment">/**</span></div><div class="line">  3:  * åˆå§‹åŒ– TranRedoLog</div><div class="line">  4:  * <span class="doctag">@param</span> lastExitOK æ˜¯å¦æ­£å¸¸é€€å‡º</div><div class="line">  5:  */</div><div class="line">  <span class="number">6</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recoverStateTable</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> lastExitOK)</span> </span>&#123;</div><div class="line">  <span class="number">7</span>:     <span class="keyword">if</span> (lastExitOK) &#123;</div><div class="line">  <span class="number">8</span>:         <span class="keyword">this</span>.recoverStateTableNormal();</div><div class="line">  <span class="number">9</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">10</span>:         <span class="comment">// ç¬¬ä¸€æ­¥ï¼Œåˆ é™¤State Table</span></div><div class="line"> <span class="number">11</span>:         <span class="keyword">this</span>.tranStateTable.destroy();</div><div class="line"> <span class="number">12</span>:         <span class="comment">// ç¬¬äºŒæ­¥ï¼Œé€šè¿‡RedoLogå…¨é‡æ¢å¤StateTable</span></div><div class="line"> <span class="number">13</span>:         <span class="keyword">this</span>.recreateStateTable();</div><div class="line"> <span class="number">14</span>:     &#125;</div><div class="line"> <span class="number">15</span>: &#125;</div><div class="line"> <span class="number">16</span>: </div><div class="line"> <span class="number">17</span>: <span class="comment">/**</span></div><div class="line"> 18:  * æ‰«æ TranRedoLog é‡å»º StateTable</div><div class="line"> 19:  */</div><div class="line"> <span class="number">20</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recreateStateTable</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">21</span>:     <span class="keyword">this</span>.tranStateTable = <span class="keyword">new</span> MapedFileQueue(StorePathConfigHelper.getTranStateTableStorePath(defaultMessageStore</div><div class="line"> <span class="number">22</span>:                 .getMessageStoreConfig().getStorePathRootDir()), defaultMessageStore</div><div class="line"> <span class="number">23</span>:                 .getMessageStoreConfig().getTranStateTableMapedFileSize(), <span class="keyword">null</span>);</div><div class="line"> <span class="number">24</span>: </div><div class="line"> <span class="number">25</span>:     <span class="keyword">final</span> TreeSet&lt;Long&gt; preparedItemSet = <span class="keyword">new</span> TreeSet&lt;Long&gt;();</div><div class="line"> <span class="number">26</span>: </div><div class="line"> <span class="number">27</span>:     <span class="comment">// ç¬¬ä¸€æ­¥ï¼Œä»å¤´æ‰«æRedoLog</span></div><div class="line"> <span class="number">28</span>:     <span class="keyword">final</span> <span class="keyword">long</span> minOffset = <span class="keyword">this</span>.tranRedoLog.getMinOffsetInQuque();</div><div class="line"> <span class="number">29</span>:     <span class="keyword">long</span> processOffset = minOffset;</div><div class="line"> <span class="number">30</span>:     <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line"> <span class="number">31</span>:         SelectMapedBufferResult bufferConsumeQueue = <span class="keyword">this</span>.tranRedoLog.getIndexBuffer(processOffset);</div><div class="line"> <span class="number">32</span>:         <span class="keyword">if</span> (bufferConsumeQueue != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">33</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">34</span>:                 <span class="keyword">long</span> i = <span class="number">0</span>;</div><div class="line"> <span class="number">35</span>:                 <span class="keyword">for</span> (; i &lt; bufferConsumeQueue.getSize(); i += ConsumeQueue.CQStoreUnitSize) &#123;</div><div class="line"> <span class="number">36</span>:                     <span class="keyword">long</span> offsetMsg = bufferConsumeQueue.getByteBuffer().getLong();</div><div class="line"> <span class="number">37</span>:                     <span class="keyword">int</span> sizeMsg = bufferConsumeQueue.getByteBuffer().getInt();</div><div class="line"> <span class="number">38</span>:                     <span class="keyword">long</span> tagsCode = bufferConsumeQueue.getByteBuffer().getLong();</div><div class="line"> <span class="number">39</span>: </div><div class="line"> <span class="number">40</span>:                     <span class="keyword">if</span> (TransactionStateService.PreparedMessageTagsCode == tagsCode) &#123; <span class="comment">// Prepared</span></div><div class="line"> <span class="number">41</span>:                         preparedItemSet.add(offsetMsg);</div><div class="line"> <span class="number">42</span>:                     &#125; <span class="keyword">else</span> &#123; <span class="comment">// Commit/Rollback</span></div><div class="line"> <span class="number">43</span>:                         preparedItemSet.remove(tagsCode);</div><div class="line"> <span class="number">44</span>:                     &#125;</div><div class="line"> <span class="number">45</span>:                 &#125;</div><div class="line"> <span class="number">46</span>: </div><div class="line"> <span class="number">47</span>:                 processOffset += i;</div><div class="line"> <span class="number">48</span>:             &#125; <span class="keyword">finally</span> &#123; <span class="comment">// å¿…é¡»é‡Šæ”¾èµ„æº</span></div><div class="line"> <span class="number">49</span>:                 bufferConsumeQueue.release();</div><div class="line"> <span class="number">50</span>:             &#125;</div><div class="line"> <span class="number">51</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">52</span>:             <span class="keyword">break</span>;</div><div class="line"> <span class="number">53</span>:         &#125;</div><div class="line"> <span class="number">54</span>:     &#125;</div><div class="line"> <span class="number">55</span>:     log.info(<span class="string">"scan transaction redolog over, End offset: &#123;&#125;,  Prepared Transaction Count: &#123;&#125;"</span>, processOffset, preparedItemSet.size());</div><div class="line"> <span class="number">56</span>: </div><div class="line"> <span class="number">57</span>:     <span class="comment">// ç¬¬äºŒæ­¥ï¼Œé‡å»ºStateTable</span></div><div class="line"> <span class="number">58</span>:     Iterator&lt;Long&gt; it = preparedItemSet.iterator();</div><div class="line"> <span class="number">59</span>:     <span class="keyword">while</span> (it.hasNext()) &#123;</div><div class="line"> <span class="number">60</span>:         Long offset = it.next();</div><div class="line"> <span class="number">61</span>:         MessageExt msgExt = <span class="keyword">this</span>.defaultMessageStore.lookMessageByOffset(offset);</div><div class="line"> <span class="number">62</span>:         <span class="keyword">if</span> (msgExt != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">63</span>:             <span class="keyword">this</span>.appendPreparedTransaction(msgExt.getCommitLogOffset(), msgExt.getStoreSize(),</div><div class="line"> <span class="number">64</span>:                 (<span class="keyword">int</span>) (msgExt.getStoreTimestamp() / <span class="number">1000</span>),</div><div class="line"> <span class="number">65</span>:                 msgExt.getProperty(MessageConst.PROPERTY_PRODUCER_GROUP).hashCode());</div><div class="line"> <span class="number">66</span>:             <span class="keyword">this</span>.tranStateTableOffset.incrementAndGet();</div><div class="line"> <span class="number">67</span>:         &#125;</div><div class="line"> <span class="number">68</span>:     &#125;</div><div class="line"> <span class="number">69</span>: &#125;</div><div class="line"> <span class="number">70</span>: </div><div class="line"> <span class="number">71</span>: <span class="comment">/**</span></div><div class="line"> 72:  * åŠ è½½ï¼ˆè§£æï¼‰TranStateTable çš„ MappedFile</div><div class="line"> 73:  * 1. æ¸…ç†å¤šä½™ MappedFileï¼Œè®¾ç½®æœ€åä¸€ä¸ª MappedFileçš„å†™å…¥ä½ç½®(position</div><div class="line"> 74:  * 2. è®¾ç½® TanStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ä½ç½®ï¼‰</div><div class="line"> 75:  */</div><div class="line"> <span class="number">76</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recoverStateTableNormal</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">77</span>:     <span class="keyword">final</span> List&lt;MapedFile&gt; mapedFiles = <span class="keyword">this</span>.tranStateTable.getMapedFiles();</div><div class="line"> <span class="number">78</span>:     <span class="keyword">if</span> (!mapedFiles.isEmpty()) &#123;</div><div class="line"> <span class="number">79</span>:         <span class="comment">// ä»å€’æ•°ç¬¬ä¸‰ä¸ªæ–‡ä»¶å¼€å§‹æ¢å¤</span></div><div class="line"> <span class="number">80</span>:         <span class="keyword">int</span> index = mapedFiles.size() - <span class="number">3</span>;</div><div class="line"> <span class="number">81</span>:         <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</div><div class="line"> <span class="number">82</span>:             index = <span class="number">0</span>;</div><div class="line"> <span class="number">83</span>:         &#125;</div><div class="line"> <span class="number">84</span>: </div><div class="line"> <span class="number">85</span>:         <span class="keyword">int</span> mapedFileSizeLogics = <span class="keyword">this</span>.tranStateTable.getMapedFileSize();</div><div class="line"> <span class="number">86</span>:         MapedFile mapedFile = mapedFiles.get(index);</div><div class="line"> <span class="number">87</span>:         ByteBuffer byteBuffer = mapedFile.sliceByteBuffer();</div><div class="line"> <span class="number">88</span>:         <span class="keyword">long</span> processOffset = mapedFile.getFileFromOffset();</div><div class="line"> <span class="number">89</span>:         <span class="keyword">long</span> mapedFileOffset = <span class="number">0</span>;</div><div class="line"> <span class="number">90</span>:         <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line"> <span class="number">91</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mapedFileSizeLogics; i += TSStoreUnitSize) &#123;</div><div class="line"> <span class="number">92</span>: </div><div class="line"> <span class="number">93</span>:                 <span class="keyword">final</span> <span class="keyword">long</span> clOffset_read = byteBuffer.getLong();</div><div class="line"> <span class="number">94</span>:                 <span class="keyword">final</span> <span class="keyword">int</span> size_read = byteBuffer.getInt();</div><div class="line"> <span class="number">95</span>:                 <span class="keyword">final</span> <span class="keyword">int</span> timestamp_read = byteBuffer.getInt();</div><div class="line"> <span class="number">96</span>:                 <span class="keyword">final</span> <span class="keyword">int</span> groupHashCode_read = byteBuffer.getInt();</div><div class="line"> <span class="number">97</span>:                 <span class="keyword">final</span> <span class="keyword">int</span> state_read = byteBuffer.getInt();</div><div class="line"> <span class="number">98</span>: </div><div class="line"> <span class="number">99</span>:                 <span class="keyword">boolean</span> stateOK = <span class="keyword">false</span>;</div><div class="line"><span class="number">100</span>:                 <span class="keyword">switch</span> (state_read) &#123;</div><div class="line"><span class="number">101</span>:                 <span class="keyword">case</span> MessageSysFlag.TransactionPreparedType:</div><div class="line"><span class="number">102</span>:                 <span class="keyword">case</span> MessageSysFlag.TransactionCommitType:</div><div class="line"><span class="number">103</span>:                 <span class="keyword">case</span> MessageSysFlag.TransactionRollbackType:</div><div class="line"><span class="number">104</span>:                     stateOK = <span class="keyword">true</span>;</div><div class="line"><span class="number">105</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">106</span>:                 <span class="keyword">default</span>:</div><div class="line"><span class="number">107</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">108</span>:                 &#125;</div><div class="line"><span class="number">109</span>: </div><div class="line"><span class="number">110</span>:                 <span class="comment">// è¯´æ˜å½“å‰å­˜å‚¨å•å…ƒæœ‰æ•ˆ</span></div><div class="line"><span class="number">111</span>:                 <span class="keyword">if</span> (clOffset_read &gt;= <span class="number">0</span> &amp;&amp; size_read &gt; <span class="number">0</span> &amp;&amp; stateOK) &#123;</div><div class="line"><span class="number">112</span>:                     mapedFileOffset = i + TSStoreUnitSize;</div><div class="line"><span class="number">113</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">114</span>:                     log.info(<span class="string">"recover current transaction state table file over,  "</span> + mapedFile.getFileName() + <span class="string">" "</span></div><div class="line"><span class="number">115</span>:                             + clOffset_read + <span class="string">" "</span> + size_read + <span class="string">" "</span> + timestamp_read);</div><div class="line"><span class="number">116</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">117</span>:                 &#125;</div><div class="line"><span class="number">118</span>:             &#125;</div><div class="line"><span class="number">119</span>: </div><div class="line"><span class="number">120</span>:             <span class="comment">// èµ°åˆ°æ–‡ä»¶æœ«å°¾ï¼Œåˆ‡æ¢è‡³ä¸‹ä¸€ä¸ªæ–‡ä»¶</span></div><div class="line"><span class="number">121</span>:             <span class="keyword">if</span> (mapedFileOffset == mapedFileSizeLogics) &#123;</div><div class="line"><span class="number">122</span>:                 index++;</div><div class="line"><span class="number">123</span>:                 <span class="keyword">if</span> (index &gt;= mapedFiles.size()) &#123; <span class="comment">// å¾ªç¯whileç»“æŸ</span></div><div class="line"><span class="number">124</span>:                     log.info(<span class="string">"recover last transaction state table file over, last maped file "</span> + mapedFile.getFileName());</div><div class="line"><span class="number">125</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">126</span>:                 &#125; <span class="keyword">else</span> &#123; <span class="comment">// åˆ‡æ¢ä¸‹ä¸€ä¸ªæ–‡ä»¶</span></div><div class="line"><span class="number">127</span>:                     mapedFile = mapedFiles.get(index);</div><div class="line"><span class="number">128</span>:                     byteBuffer = mapedFile.sliceByteBuffer();</div><div class="line"><span class="number">129</span>:                     processOffset = mapedFile.getFileFromOffset();</div><div class="line"><span class="number">130</span>:                     mapedFileOffset = <span class="number">0</span>;</div><div class="line"><span class="number">131</span>:                     log.info(<span class="string">"recover next transaction state table file, "</span> + mapedFile.getFileName());</div><div class="line"><span class="number">132</span>:                 &#125;</div><div class="line"><span class="number">133</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">134</span>:                 log.info(<span class="string">"recover current transaction state table queue over "</span> + mapedFile.getFileName() + <span class="string">" "</span> + (processOffset + mapedFileOffset));</div><div class="line"><span class="number">135</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">136</span>:             &#125;</div><div class="line"><span class="number">137</span>:         &#125;</div><div class="line"><span class="number">138</span>: </div><div class="line"><span class="number">139</span>:         <span class="comment">// æ¸…ç†å¤šä½™ MappedFileï¼Œè®¾ç½®æœ€åä¸€ä¸ª MappedFileçš„å†™å…¥ä½ç½®(position</span></div><div class="line"><span class="number">140</span>:         processOffset += mapedFileOffset;</div><div class="line"><span class="number">141</span>:         <span class="keyword">this</span>.tranStateTable.truncateDirtyFiles(processOffset);</div><div class="line"><span class="number">142</span>: </div><div class="line"><span class="number">143</span>:         <span class="comment">// è®¾ç½® TanStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ä½ç½®ï¼‰</span></div><div class="line"><span class="number">144</span>:         <span class="keyword">this</span>.tranStateTableOffset.set(<span class="keyword">this</span>.tranStateTable.getMaxOffset() / TSStoreUnitSize);</div><div class="line"><span class="number">145</span>:         log.info(<span class="string">"recover normal over, transaction state table max offset: &#123;&#125;"</span>, <span class="keyword">this</span>.tranStateTableOffset.get());</div><div class="line"><span class="number">146</span>:     &#125;</div><div class="line"><span class="number">147</span>: &#125;</div></pre></td></tr></table></figure></p>
<h4>3.1.1.5 è¡¥å……</h4>
<ul>
<li>ä¸ºä»€ä¹ˆ V3.1.5 å¼€å§‹ï¼Œä½¿ç”¨ æ•°æ®åº“ å®ç°ã€äº‹åŠ¡çŠ¶æ€ã€‘çš„å­˜å‚¨ï¼Ÿå¦‚ä¸‹æ˜¯æ¥è‡ªå®˜æ–¹æ–‡æ¡£çš„è¯´æ˜ï¼Œå¯èƒ½æ˜¯ä¸€éƒ¨åˆ†åŸå› ï¼š</li>
</ul>
<blockquote>
<p>RocketMQ è¿™ç§å®ç°äº‹åŠ¡æ–¹å¼ï¼Œæ²¡æœ‰é€šè¿‡ KV å­˜å‚¨åšï¼Œè€Œæ˜¯é€šè¿‡ Offset æ–¹å¼ï¼Œå­˜åœ¨ä¸€ä¸ªæ˜¾è‘—ç¼ºé™·ï¼Œå³é€šè¿‡ Offset æ›´æ”¹æ•°æ®ï¼Œä¼šä»¤ç³»ç»Ÿçš„è„é¡µè¿‡å¤šï¼Œéœ€è¦ç‰¹åˆ«å…³æ³¨ã€‚</p>
</blockquote>
<h3>3.1.2 å®˜æ–¹V4.0.0ï¼šåŸºäºæ•°æ®åº“</h3>
<blockquote>
<p>ä»“åº“åœ°å€ï¼šhttps://github.com/apache/incubator-rocketmq</p>
</blockquote>
<p>å®˜æ–¹V4.0.0 æš‚æ—¶æœª<strong>å®Œå…¨</strong>å¼€æºã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘åŠŸèƒ½ï¼Œ<strong>So æˆ‘ä»¬éœ€è¦è¿›è¡Œä¸€äº›çŒœæƒ³ï¼Œå¯èƒ½ä¸ä¸€å®šæ­£ç¡®ğŸ˜ˆ</strong>ã€‚</p>
<p>ğŸ˜†æˆ‘ä»¬æ¥å¯¹æ¯”ã€å®˜æ–¹V3.1.4ï¼šåŸºäºæ–‡ä»¶ã€‘çš„å®ç°ã€‚</p>
<ul>
<li>TransactionRecord ï¼šè®°å½•æ¯æ¡ã€äº‹åŠ¡æ¶ˆæ¯ã€‘ã€‚ç±»ä¼¼ <code>TranStateTable</code>ã€‚</li>
</ul>
<table>
<thead>
<tr>
<th>TranStateTable</th>
<th>TransactionRecord</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>offset</td>
<td>offset</td>
<td></td>
</tr>
<tr>
<td>producerGroupHash</td>
<td>producerGroup</td>
<td></td>
</tr>
<tr>
<td>size</td>
<td>æ— </td>
<td>éå¿…é¡»å­—æ®µï¼šã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥æ—¶ï¼Œä½¿ç”¨ offset è¯»å– CommitLog è·å¾—ã€‚</td>
</tr>
<tr>
<td>timestamp</td>
<td>æ— </td>
<td>éå¿…é¡»å­—æ®µï¼šã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥æ—¶ï¼Œä½¿ç”¨ offset è¯»å– CommitLog è·å¾—ã€‚</td>
</tr>
<tr>
<td>state</td>
<td>æ— </td>
<td>éå¿…é¡»å­—æ®µï¼š äº‹åŠ¡å¼€å§‹ï¼Œå¢åŠ è®°å½•ï¼›äº‹åŠ¡ç»“æŸï¼Œåˆ é™¤è®°å½•ã€‚</td>
</tr>
</tbody>
</table>
<p>å¦å¤–ï¼Œæ•°æ®åº“æœ¬èº«ä¿è¯äº†æ•°æ®å­˜å‚¨çš„å¯é æ€§ï¼Œæ— éœ€ <code>TranRedoLog</code>ã€‚</p>
<hr>
<p>ç®€å•æ‰‹ç»˜é€»è¾‘å›¾å¦‚ä¸‹ğŸ˜ˆï¼š</p>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_21/02.jpeg" alt="Broker_V4.0.0_åŸºäºæ•°æ®åº“"></p>
<h2>3.2 Producer æ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘</h2>
<ul>
<li>é¡ºåºå›¾å¦‚ä¸‹ï¼š</li>
</ul>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_21/04.png" alt="Produceræ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘"></p>
<ul>
<li>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘</span></div><div class="line">  <span class="number">2</span>: <span class="comment">/**</span></div><div class="line">  3:  * æ£€æŸ¥ã€äº‹åŠ¡çŠ¶æ€ã€‘çŠ¶æ€</div><div class="line">  4:  *</div><div class="line">  5:  * <span class="doctag">@param</span> addr brokeråœ°å€</div><div class="line">  6:  * <span class="doctag">@param</span> msg æ¶ˆæ¯</div><div class="line">  7:  * <span class="doctag">@param</span> header è¯·æ±‚</div><div class="line">  8:  */</div><div class="line">  <span class="number">9</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">10</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkTransactionState</span><span class="params">(<span class="keyword">final</span> String addr, <span class="keyword">final</span> MessageExt msg, <span class="keyword">final</span> CheckTransactionStateRequestHeader header)</span> </span>&#123;</div><div class="line"> <span class="number">11</span>:     Runnable request = <span class="keyword">new</span> Runnable() &#123;</div><div class="line"> <span class="number">12</span>:         <span class="keyword">private</span> <span class="keyword">final</span> String brokerAddr = addr;</div><div class="line"> <span class="number">13</span>:         <span class="keyword">private</span> <span class="keyword">final</span> MessageExt message = msg;</div><div class="line"> <span class="number">14</span>:         <span class="keyword">private</span> <span class="keyword">final</span> CheckTransactionStateRequestHeader checkRequestHeader = header;</div><div class="line"> <span class="number">15</span>:         <span class="keyword">private</span> <span class="keyword">final</span> String group = DefaultMQProducerImpl.<span class="keyword">this</span>.defaultMQProducer.getProducerGroup();</div><div class="line"> <span class="number">16</span>: </div><div class="line"> <span class="number">17</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">18</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">19</span>:             TransactionCheckListener transactionCheckListener = DefaultMQProducerImpl.<span class="keyword">this</span>.checkListener();</div><div class="line"> <span class="number">20</span>:             <span class="keyword">if</span> (transactionCheckListener != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">21</span>:                 <span class="comment">// è·å–äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€</span></div><div class="line"> <span class="number">22</span>:                 LocalTransactionState localTransactionState = LocalTransactionState.UNKNOW;</div><div class="line"> <span class="number">23</span>:                 Throwable exception = <span class="keyword">null</span>;</div><div class="line"> <span class="number">24</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">25</span>:                     localTransactionState = transactionCheckListener.checkLocalTransactionState(message);</div><div class="line"> <span class="number">26</span>:                 &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">27</span>:                     log.error(<span class="string">"Broker call checkTransactionState, but checkLocalTransactionState exception"</span>, e);</div><div class="line"> <span class="number">28</span>:                     exception = e;</div><div class="line"> <span class="number">29</span>:                 &#125;</div><div class="line"> <span class="number">30</span>: </div><div class="line"> <span class="number">31</span>:                 <span class="comment">// å¤„ç†äº‹åŠ¡ç»“æœï¼Œæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK</span></div><div class="line"> <span class="number">32</span>:                 <span class="keyword">this</span>.processTransactionState(<span class="comment">//</span></div><div class="line"> <span class="number">33</span>:                     localTransactionState, <span class="comment">//</span></div><div class="line"> <span class="number">34</span>:                     group, <span class="comment">//</span></div><div class="line"> <span class="number">35</span>:                     exception);</div><div class="line"> <span class="number">36</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">37</span>:                 log.warn(<span class="string">"checkTransactionState, pick transactionCheckListener by group[&#123;&#125;] failed"</span>, group);</div><div class="line"> <span class="number">38</span>:             &#125;</div><div class="line"> <span class="number">39</span>:         &#125;</div><div class="line"> <span class="number">40</span>: </div><div class="line"> <span class="number">41</span>:         <span class="comment">/**</span></div><div class="line"> 42:          * å¤„ç†äº‹åŠ¡ç»“æœï¼Œæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK</div><div class="line"> 43:          *</div><div class="line"> 44:          * <span class="doctag">@param</span> localTransactionState ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€</div><div class="line"> 45:          * <span class="doctag">@param</span> producerGroup producerGroup</div><div class="line"> 46:          * <span class="doctag">@param</span> exception æ£€æŸ¥ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€å‘ç”Ÿçš„å¼‚å¸¸</div><div class="line"> 47:          */</div><div class="line"> <span class="number">48</span>:         <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processTransactionState</span><span class="params">(//</span></span></div><div class="line"> <span class="number">49</span>:             <span class="keyword">final</span> LocalTransactionState localTransactionState, //</div><div class="line"> <span class="number">50</span>:             <span class="keyword">final</span> String producerGroup, //</div><div class="line"> <span class="number">51</span>:             <span class="keyword">final</span> Throwable exception) &#123;</div><div class="line"> <span class="number">52</span>:             <span class="keyword">final</span> EndTransactionRequestHeader thisHeader = <span class="keyword">new</span> EndTransactionRequestHeader();</div><div class="line"> <span class="number">53</span>:             thisHeader.setCommitLogOffset(checkRequestHeader.getCommitLogOffset());</div><div class="line"> <span class="number">54</span>:             thisHeader.setProducerGroup(producerGroup);</div><div class="line"> <span class="number">55</span>:             thisHeader.setTranStateTableOffset(checkRequestHeader.getTranStateTableOffset());</div><div class="line"> <span class="number">56</span>:             thisHeader.setFromTransactionCheck(<span class="keyword">true</span>);</div><div class="line"> <span class="number">57</span>: </div><div class="line"> <span class="number">58</span>:             <span class="comment">// è®¾ç½®æ¶ˆæ¯ç¼–å·</span></div><div class="line"> <span class="number">59</span>:             String uniqueKey = message.getProperties().get(MessageConst.PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX);</div><div class="line"> <span class="number">60</span>:             <span class="keyword">if</span> (uniqueKey == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">61</span>:                 uniqueKey = message.getMsgId();</div><div class="line"> <span class="number">62</span>:             &#125;</div><div class="line"> <span class="number">63</span>:             thisHeader.setMsgId(uniqueKey);</div><div class="line"> <span class="number">64</span>: </div><div class="line"> <span class="number">65</span>:             thisHeader.setTransactionId(checkRequestHeader.getTransactionId());</div><div class="line"> <span class="number">66</span>:             <span class="keyword">switch</span> (localTransactionState) &#123;</div><div class="line"> <span class="number">67</span>:                 <span class="keyword">case</span> COMMIT_MESSAGE:</div><div class="line"> <span class="number">68</span>:                     thisHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_COMMIT_TYPE);</div><div class="line"> <span class="number">69</span>:                     <span class="keyword">break</span>;</div><div class="line"> <span class="number">70</span>:                 <span class="keyword">case</span> ROLLBACK_MESSAGE:</div><div class="line"> <span class="number">71</span>:                     thisHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_ROLLBACK_TYPE);</div><div class="line"> <span class="number">72</span>:                     log.warn(<span class="string">"when broker check, client rollback this transaction, &#123;&#125;"</span>, thisHeader);</div><div class="line"> <span class="number">73</span>:                     <span class="keyword">break</span>;</div><div class="line"> <span class="number">74</span>:                 <span class="keyword">case</span> UNKNOW:</div><div class="line"> <span class="number">75</span>:                     thisHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_NOT_TYPE);</div><div class="line"> <span class="number">76</span>:                     log.warn(<span class="string">"when broker check, client does not know this transaction state, &#123;&#125;"</span>, thisHeader);</div><div class="line"> <span class="number">77</span>:                     <span class="keyword">break</span>;</div><div class="line"> <span class="number">78</span>:                 <span class="keyword">default</span>:</div><div class="line"> <span class="number">79</span>:                     <span class="keyword">break</span>;</div><div class="line"> <span class="number">80</span>:             &#125;</div><div class="line"> <span class="number">81</span>: </div><div class="line"> <span class="number">82</span>:             String remark = <span class="keyword">null</span>;</div><div class="line"> <span class="number">83</span>:             <span class="keyword">if</span> (exception != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">84</span>:                 remark = <span class="string">"checkLocalTransactionState Exception: "</span> + RemotingHelper.exceptionSimpleDesc(exception);</div><div class="line"> <span class="number">85</span>:             &#125;</div><div class="line"> <span class="number">86</span>: </div><div class="line"> <span class="number">87</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">88</span>:                 <span class="comment">// æäº¤æ¶ˆæ¯ COMMIT / ROLLBACK</span></div><div class="line"> <span class="number">89</span>:                 DefaultMQProducerImpl.<span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().endTransactionOneway(brokerAddr, thisHeader, remark,</div><div class="line"> <span class="number">90</span>:                     <span class="number">3000</span>);</div><div class="line"> <span class="number">91</span>:             &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">92</span>:                 log.error(<span class="string">"endTransactionOneway exception"</span>, e);</div><div class="line"> <span class="number">93</span>:             &#125;</div><div class="line"> <span class="number">94</span>:         &#125;</div><div class="line"> <span class="number">95</span>:     &#125;;</div><div class="line"> <span class="number">96</span>: </div><div class="line"> <span class="number">97</span>:     <span class="comment">// æäº¤æ‰§è¡Œ</span></div><div class="line"> <span class="number">98</span>:     <span class="keyword">this</span>.checkExecutor.submit(request);</div><div class="line"> <span class="number">99</span>: &#125;</div><div class="line"><span class="number">100</span>: </div><div class="line"><span class="number">101</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘</span></div><div class="line"><span class="number">102</span>: <span class="comment">/**</span></div><div class="line">103:  * ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘æ£€æŸ¥ç›‘å¬å™¨</div><div class="line">104:  */</div><div class="line"><span class="number">105</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionCheckListener</span> </span>&#123;</div><div class="line"><span class="number">106</span>: </div><div class="line"><span class="number">107</span>:     <span class="comment">/**</span></div><div class="line">108:      * è·å–ï¼ˆæ£€æŸ¥ï¼‰ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€</div><div class="line">109:      *</div><div class="line">110:      * <span class="doctag">@param</span> msg æ¶ˆæ¯</div><div class="line">111:      * <span class="doctag">@return</span> äº‹åŠ¡çŠ¶æ€</div><div class="line">112:      */</div><div class="line"><span class="number">113</span>:     <span class="function">LocalTransactionState <span class="title">checkLocalTransactionState</span><span class="params">(<span class="keyword">final</span> MessageExt msg)</span></span>;</div><div class="line"><span class="number">114</span>: </div><div class="line"><span class="number">115</span>: &#125;</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rock
    
    </summary>
    
      <category term="RocketMQ" scheme="http://www.yunai.me/categories/RocketMQ/"/>
    
    
  </entry>
  
  <entry>
    <title>RocketMQ æºç åˆ†æ â€”â€” Filtersrv</title>
    <link href="http://www.yunai.me/RocketMQ/filtersrv/"/>
    <id>http://www.yunai.me/RocketMQ/filtersrv/</id>
    <published>2017-05-16T16:00:00.000Z</published>
    <updated>2017-07-27T16:57:29.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. Filtersrv æ³¨å†Œåˆ° Broker</a></li>
<li><a href="#">3. è¿‡æ»¤ç±»</a>
<ul>
<li><a href="#">3.1 Consumer è®¢é˜…æ—¶è®¾ç½® è¿‡æ»¤ç±»ä»£ç </a></li>
<li><a href="#">3.2 Consumer ä¸Šä¼  è¿‡æ»¤ç±»ä»£ç </a></li>
<li><a href="#">3.3 Filter ç¼–è¯‘ è¿‡æ»¤ç±»ä»£ç </a></li>
</ul>
</li>
<li><a href="#">4. è¿‡æ»¤æ¶ˆæ¯</a>
<ul>
<li><a href="#">4.1 Consumer ä» Filtersrv æ‹‰å–æ¶ˆæ¯</a></li>
<li><a href="#">4.2 Filtersrv ä» Broker æ‹‰å–æ¶ˆæ¯</a></li>
</ul>
</li>
<li><a href="#">5. Filtersrv é«˜å¯ç”¨</a></li>
</ul>
<h1>1. æ¦‚è¿°</h1>
<p><code>Filtersrv</code> ï¼Œè´Ÿè´£<strong>è‡ªå®šä¹‰è§„åˆ™</strong>è¿‡æ»¤ <code>Consumer</code> ä» <code>Broker</code> æ‹‰å–çš„æ¶ˆæ¯ã€‚</p>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_17/Filtersrv.png" alt="Filtersrv.png"></p>
<p>ä¸ºä»€ä¹ˆ <code>Broker</code> ä¸æä¾›è¿‡æ»¤æ¶ˆæ¯çš„åŠŸèƒ½å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹å®˜æ–¹çš„è¯´æ³•ï¼š</p>
<blockquote>
<ul>
<li>Broker ç«¯æ¶ˆæ¯è¿‡æ»¤<br>
åœ¨ Broker ä¸­ï¼ŒæŒ‰ç…§ Consumer çš„è¦æ±‚åšè¿‡æ»¤ï¼Œä¼˜ç‚¹æ˜¯å‡å°‘äº†å¯¹äº Consumer æ— ç”¨æ¶ˆæ¯çš„ç½‘ç»œä¼ è¾“ã€‚ ç¼ºç‚¹æ˜¯å¢åŠ äº† Broker çš„è´Ÿæ‹…ï¼Œå®ç°ç›¸å¯¹å¤æ‚ã€‚<br>
(1). æ·˜å® Notify æ”¯æŒå¤šç§è¿‡æ»¤æ–¹å¼ï¼ŒåŒ…å«ç›´æ¥æŒ‰ç…§æ¶ˆæ¯ç±»å‹è¿‡æ»¤ï¼Œçµæ´»çš„è¯­æ³•è¡¨è¾¾å¼è¿‡æ»¤ï¼Œå‡ ä¹å¯ä»¥æ»¡è¶³æœ€è‹›åˆ»çš„è¿‡æ»¤éœ€æ±‚ã€‚<br>
(2). æ·˜å® RocketMQ æ”¯æŒæŒ‰ç…§ç®€å•çš„ Message Tag è¿‡æ»¤ï¼Œä¹Ÿæ”¯æŒæŒ‰ç…§ Message Headerã€body è¿›è¡Œè¿‡æ»¤ã€‚<br>
(3). CORBA Notification è§„èŒƒä¸­ä¹Ÿæ”¯æŒçµæ´»çš„è¯­æ³•è¡¨è¾¾å¼è¿‡æ»¤ã€‚</li>
<li>Consumer ç«¯æ¶ˆæ¯è¿‡æ»¤<br>
è¿™ç§è¿‡æ»¤æ–¹å¼å¯ç”±åº”ç”¨å®Œå…¨è‡ªå®šä¹‰å®ç°ï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯å¾ˆå¤šæ— ç”¨çš„æ¶ˆæ¯è¦ä¼ è¾“åˆ° Consumer ç«¯ã€‚</li>
</ul>
</blockquote>
<p><strong>å°±æ˜¯åœ¨è¿™ç§è€ƒè™‘ä¸‹ï¼Œ<code>Filtersrv</code> å‡ºç°äº†ã€‚å‡å°‘äº† <code>Broker</code> çš„è´Ÿæ‹…ï¼Œåˆå‡å°‘äº† <code>Consumer</code> æ¥æ”¶æ— ç”¨çš„æ¶ˆæ¯ã€‚å½“ç„¶ç¼ºç‚¹ä¹Ÿæ˜¯æœ‰çš„ï¼Œå¤šäº†ä¸€å±‚ <code>Filtersrv</code> ç½‘ç»œå¼€é”€ã€‚</strong></p>
<h1>2. Filtersrv æ³¨å†Œåˆ° Broker</h1>
<ul>
<li>ğŸ¦… ä¸€ä¸ª <code>Filtersrv</code> <strong>åª</strong>å¯¹åº”ä¸€ä¸ª <code>Broker</code>ã€‚</li>
<li>ğŸ¦… ä¸€ä¸ª <code>Broker</code> å¯ä»¥å¯¹åº”<strong>å¤šä¸ª</strong> <code>Filtersrv</code>ã€‚<strong><code>Filtersrv</code> çš„é«˜å¯ç”¨é€šè¿‡å¯åŠ¨å¤šä¸ª <code>Filtersrv</code> å®ç°</strong>ã€‚</li>
<li>ğŸ¦… <code>Filtersrv</code> æ³¨å†Œå¤±è´¥æ—¶ï¼Œä¸»åŠ¨<strong>é€€å‡ºå…³é—­</strong>ã€‚</li>
</ul>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FiltersrvController.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// ....(çœç•¥ä»£ç )</span></div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     <span class="comment">// å›ºå®šé—´éš”æ³¨å†Œåˆ°Broker</span></div><div class="line"> <span class="number">6</span>:     <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">9</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">10</span>:             FiltersrvController.<span class="keyword">this</span>.registerFilterServerToBroker();</div><div class="line"><span class="number">11</span>:         &#125;</div><div class="line"><span class="number">12</span>:     &#125;, <span class="number">15</span>, <span class="number">10</span>, TimeUnit.SECONDS); <span class="comment">// TODO edit by èŠ‹è‰¿ï¼šinitialDelayæ—¶é—´å¤ªçŸ­ï¼Œå¯èƒ½å¯¼è‡´åˆå§‹åŒ–å¤±è´¥ã€‚ä»3=ã€‹15</span></div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>:     <span class="comment">// ....(çœç•¥ä»£ç )</span></div><div class="line"><span class="number">15</span>: &#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="comment">/**</span></div><div class="line">18:  * æ³¨å†ŒFiltersrv åˆ° Broker</div><div class="line">19:  * ï¼ï¼ï¼å¦‚æœæ³¨å†Œå¤±è´¥ï¼Œå…³é—­Filtersrv</div><div class="line">20:  */</div><div class="line"><span class="number">21</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerFilterServerToBroker</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">22</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">23</span>:         RegisterFilterServerResponseHeader responseHeader =</div><div class="line"><span class="number">24</span>:             <span class="keyword">this</span>.filterServerOuterAPI.registerFilterServerToBroker(</div><div class="line"><span class="number">25</span>:                 <span class="keyword">this</span>.filtersrvConfig.getConnectWhichBroker(), <span class="keyword">this</span>.localAddr());</div><div class="line"><span class="number">26</span>:         <span class="keyword">this</span>.defaultMQPullConsumer.getDefaultMQPullConsumerImpl().getPullAPIWrapper()</div><div class="line"><span class="number">27</span>:             .setDefaultBrokerId(responseHeader.getBrokerId());</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == <span class="keyword">this</span>.brokerName) &#123;</div><div class="line"><span class="number">30</span>:             <span class="keyword">this</span>.brokerName = responseHeader.getBrokerName();</div><div class="line"><span class="number">31</span>:         &#125;</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>:         log.info(<span class="string">"register filter server&lt;&#123;&#125;&gt; to broker&lt;&#123;&#125;&gt; OK, Return: &#123;&#125; &#123;&#125;"</span>,</div><div class="line"><span class="number">34</span>:             <span class="keyword">this</span>.localAddr(),</div><div class="line"><span class="number">35</span>:             <span class="keyword">this</span>.filtersrvConfig.getConnectWhichBroker(),</div><div class="line"><span class="number">36</span>:             responseHeader.getBrokerName(),</div><div class="line"><span class="number">37</span>:             responseHeader.getBrokerId());</div><div class="line"><span class="number">38</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">39</span>:         log.warn(<span class="string">"register filter server Exception"</span>, e);</div><div class="line"><span class="number">40</span>: </div><div class="line"><span class="number">41</span>:         log.warn(<span class="string">"access broker failed, kill oneself"</span>);</div><div class="line"><span class="number">42</span>:         System.exit(-<span class="number">1</span>); <span class="comment">// å¼‚å¸¸é€€å‡º</span></div><div class="line"><span class="number">43</span>:     &#125;</div><div class="line"><span class="number">44</span>: &#125;</div></pre></td></tr></table></figure></p>
<h1>3. è¿‡æ»¤ç±»</h1>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_17/03.png" alt="Filtersrvè¿‡æ»¤ç±»"></p>
<h2>3.1 Consumer è®¢é˜…æ—¶è®¾ç½® è¿‡æ»¤ç±»ä»£ç </h2>
<ul>
<li>ğŸ¦… <code>Consumer</code> é’ˆå¯¹æ¯ä¸ª <code>Topic</code> å¯ä»¥è®¢é˜…ä¸åŒçš„ <code>è¿‡æ»¤ç±»ä»£ç </code>ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQPushConsumer.javaã€‘</span></div><div class="line"><span class="number">2</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">3</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(String topic, String fullClassName, String filterClassSource)</span> <span class="keyword">throws</span> MQClientException </span>&#123;</div><div class="line"><span class="number">4</span>:     <span class="keyword">this</span>.defaultMQPushConsumerImpl.subscribe(topic, fullClassName, filterClassSource);</div><div class="line"><span class="number">5</span>: &#125;</div></pre></td></tr></table></figure></p>
<h2>3.2 Consumer ä¸Šä¼  è¿‡æ»¤ç±»ä»£ç </h2>
<ul>
<li>ğŸ¦… <code>Consumer</code> å¿ƒè·³æ³¨å†Œåˆ° <code>Broker</code> çš„åŒæ—¶ï¼Œä¸Šä¼  <code>è¿‡æ»¤ç±»ä»£ç </code> åˆ° <code>Broker</code> å¯¹åº”çš„<strong>æ‰€æœ‰</strong> <code>Filtersrv</code>ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MQClientInstance.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="comment">/**</span></div><div class="line"> 3:  * å‘é€å¿ƒè·³åˆ°Brokerï¼Œä¸Šä¼ è¿‡æ»¤ç±»æºç åˆ°Filtersrv</div><div class="line"> 4:  */</div><div class="line"> <span class="number">5</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendHeartbeatToAllBrokerWithLock</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.lockHeartbeat.tryLock()) &#123;</div><div class="line"> <span class="number">7</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">8</span>:             <span class="keyword">this</span>.sendHeartbeatToAllBroker();</div><div class="line"> <span class="number">9</span>:             <span class="keyword">this</span>.uploadFilterClassSource();</div><div class="line"><span class="number">10</span>:         &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</div><div class="line"><span class="number">11</span>:             log.error(<span class="string">"sendHeartbeatToAllBroker exception"</span>, e);</div><div class="line"><span class="number">12</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">13</span>:             <span class="keyword">this</span>.lockHeartbeat.unlock();</div><div class="line"><span class="number">14</span>:         &#125;</div><div class="line"><span class="number">15</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">16</span>:         log.warn(<span class="string">"lock heartBeat, but failed."</span>);</div><div class="line"><span class="number">17</span>:     &#125;</div><div class="line"><span class="number">18</span>: &#125;</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>: <span class="comment">/**</span></div><div class="line">21:  * ä¸Šä¼ è¿‡æ»¤ç±»åˆ°Filtersrv</div><div class="line">22:  */</div><div class="line"><span class="number">23</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">uploadFilterClassSource</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">24</span>:     Iterator&lt;Entry&lt;String, MQConsumerInner&gt;&gt; it = <span class="keyword">this</span>.consumerTable.entrySet().iterator();</div><div class="line"><span class="number">25</span>:     <span class="keyword">while</span> (it.hasNext()) &#123;</div><div class="line"><span class="number">26</span>:         Entry&lt;String, MQConsumerInner&gt; next = it.next();</div><div class="line"><span class="number">27</span>:         MQConsumerInner consumer = next.getValue();</div><div class="line"><span class="number">28</span>:         <span class="keyword">if</span> (ConsumeType.CONSUME_PASSIVELY == consumer.consumeType()) &#123;</div><div class="line"><span class="number">29</span>:             Set&lt;SubscriptionData&gt; subscriptions = consumer.subscriptions();</div><div class="line"><span class="number">30</span>:             <span class="keyword">for</span> (SubscriptionData sub : subscriptions) &#123;</div><div class="line"><span class="number">31</span>:                 <span class="keyword">if</span> (sub.isClassFilterMode() &amp;&amp; sub.getFilterClassSource() != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">32</span>:                     <span class="keyword">final</span> String consumerGroup = consumer.groupName();</div><div class="line"><span class="number">33</span>:                     <span class="keyword">final</span> String className = sub.getSubString();</div><div class="line"><span class="number">34</span>:                     <span class="keyword">final</span> String topic = sub.getTopic();</div><div class="line"><span class="number">35</span>:                     <span class="keyword">final</span> String filterClassSource = sub.getFilterClassSource();</div><div class="line"><span class="number">36</span>:                     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">37</span>:                         <span class="keyword">this</span>.uploadFilterClassToAllFilterServer(consumerGroup, className, topic, filterClassSource);</div><div class="line"><span class="number">38</span>:                     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">39</span>:                         log.error(<span class="string">"uploadFilterClassToAllFilterServer Exception"</span>, e);</div><div class="line"><span class="number">40</span>:                     &#125;</div><div class="line"><span class="number">41</span>:                 &#125;</div><div class="line"><span class="number">42</span>:             &#125;</div><div class="line"><span class="number">43</span>:         &#125;</div><div class="line"><span class="number">44</span>:     &#125;</div><div class="line"><span class="number">45</span>: &#125;</div></pre></td></tr></table></figure></p>
<h2>3.3 Filter ç¼–è¯‘ è¿‡æ»¤ç±»ä»£ç </h2>
<ul>
<li>ğŸ¦… <code>Filtersrv</code> å¤„ç† <code>Consumer</code> ä¸Šä¼ çš„ <code>è¿‡æ»¤ç±»ä»£ç </code>ï¼Œå¹¶è¿›è¡Œ<strong>ç¼–è¯‘</strong>ä½¿ç”¨ã€‚</li>
</ul>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FilterClassManager.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="comment">/**</span></div><div class="line"> 3:  * æ³¨å†Œè¿‡æ»¤ç±»</div><div class="line"> 4:  *</div><div class="line"> 5:  * <span class="doctag">@param</span> consumerGroup æ¶ˆè´¹åˆ†ç»„</div><div class="line"> 6:  * <span class="doctag">@param</span> topic Topic</div><div class="line"> 7:  * <span class="doctag">@param</span> className è¿‡æ»¤ç±»å</div><div class="line"> 8:  * <span class="doctag">@param</span> classCRC è¿‡æ»¤ç±»æºç CRC</div><div class="line"> 9:  * <span class="doctag">@param</span> filterSourceBinary è¿‡æ»¤ç±»æºç </div><div class="line">10:  * <span class="doctag">@return</span> æ˜¯å¦æ³¨å†ŒæˆåŠŸ</div><div class="line">11:  */</div><div class="line"><span class="number">12</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">registerFilterClass</span><span class="params">(<span class="keyword">final</span> String consumerGroup, <span class="keyword">final</span> String topic,</span></span></div><div class="line"><span class="number">13</span>:     <span class="keyword">final</span> String className, <span class="keyword">final</span> <span class="keyword">int</span> classCRC, <span class="keyword">final</span> <span class="keyword">byte</span>[] filterSourceBinary) &#123;</div><div class="line"><span class="number">14</span>:     <span class="keyword">final</span> String key = buildKey(consumerGroup, topic);</div><div class="line"><span class="number">15</span>:     <span class="comment">// åˆ¤æ–­æ˜¯å¦è¦æ³¨å†Œæ–°çš„è¿‡æ»¤ç±»</span></div><div class="line"><span class="number">16</span>:     <span class="keyword">boolean</span> registerNew = <span class="keyword">false</span>;</div><div class="line"><span class="number">17</span>:     FilterClassInfo filterClassInfoPrev = <span class="keyword">this</span>.filterClassTable.get(key);</div><div class="line"><span class="number">18</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == filterClassInfoPrev) &#123;</div><div class="line"><span class="number">19</span>:         registerNew = <span class="keyword">true</span>;</div><div class="line"><span class="number">20</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">21</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.filtersrvController.getFiltersrvConfig().isClientUploadFilterClassEnable()) &#123;</div><div class="line"><span class="number">22</span>:             <span class="keyword">if</span> (filterClassInfoPrev.getClassCRC() != classCRC &amp;&amp; classCRC != <span class="number">0</span>) &#123; <span class="comment">// ç±»æœ‰å˜åŒ–</span></div><div class="line"><span class="number">23</span>:                 registerNew = <span class="keyword">true</span>;</div><div class="line"><span class="number">24</span>:             &#125;</div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>:     &#125;</div><div class="line"><span class="number">27</span>:     <span class="comment">// æ³¨å†Œæ–°çš„è¿‡æ»¤ç±»</span></div><div class="line"><span class="number">28</span>:     <span class="keyword">if</span> (registerNew) &#123;</div><div class="line"><span class="number">29</span>:         <span class="keyword">synchronized</span> (<span class="keyword">this</span>.compileLock) &#123;</div><div class="line"><span class="number">30</span>:             filterClassInfoPrev = <span class="keyword">this</span>.filterClassTable.get(key);</div><div class="line"><span class="number">31</span>:             <span class="keyword">if</span> (<span class="keyword">null</span> != filterClassInfoPrev &amp;&amp; filterClassInfoPrev.getClassCRC() == classCRC) &#123;</div><div class="line"><span class="number">32</span>:                 <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">33</span>:             &#125;</div><div class="line"><span class="number">34</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">35</span>:                 FilterClassInfo filterClassInfoNew = <span class="keyword">new</span> FilterClassInfo();</div><div class="line"><span class="number">36</span>:                 filterClassInfoNew.setClassName(className);</div><div class="line"><span class="number">37</span>:                 filterClassInfoNew.setClassCRC(<span class="number">0</span>);</div><div class="line"><span class="number">38</span>:                 filterClassInfoNew.setMessageFilter(<span class="keyword">null</span>);</div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.filtersrvController.getFiltersrvConfig().isClientUploadFilterClassEnable()) &#123;</div><div class="line"><span class="number">41</span>:                     String javaSource = <span class="keyword">new</span> String(filterSourceBinary, MixAll.DEFAULT_CHARSET);</div><div class="line"><span class="number">42</span>:                     <span class="comment">// ç¼–è¯‘æ–°çš„è¿‡æ»¤ç±»</span></div><div class="line"><span class="number">43</span>:                     Class&lt;?&gt; newClass = DynaCode.compileAndLoadClass(className, javaSource);</div><div class="line"><span class="number">44</span>:                     <span class="comment">// åˆ›å»ºæ–°çš„è¿‡æ»¤ç±»å¯¹è±¡</span></div><div class="line"><span class="number">45</span>:                     Object newInstance = newClass.newInstance();</div><div class="line"><span class="number">46</span>:                     filterClassInfoNew.setMessageFilter((MessageFilter) newInstance);</div><div class="line"><span class="number">47</span>:                     filterClassInfoNew.setClassCRC(classCRC);</div><div class="line"><span class="number">48</span>:                 &#125;</div><div class="line"><span class="number">49</span>: </div><div class="line"><span class="number">50</span>:                 <span class="keyword">this</span>.filterClassTable.put(key, filterClassInfoNew);</div><div class="line"><span class="number">51</span>:             &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">52</span>:                 String info = String.format(<span class="string">"FilterServer, registerFilterClass Exception, consumerGroup: %s topic: %s className: %s"</span>,</div><div class="line"><span class="number">53</span>:                             consumerGroup, topic, className);</div><div class="line"><span class="number">54</span>:                 log.error(info, e);</div><div class="line"><span class="number">55</span>:                 <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">56</span>:             &#125;</div><div class="line"><span class="number">57</span>:         &#125;</div><div class="line"><span class="number">58</span>:     &#125;</div><div class="line"><span class="number">59</span>: </div><div class="line"><span class="number">60</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">61</span>: &#125;</div></pre></td></tr></table></figure></p>
<hr>
<h1>4. è¿‡æ»¤æ¶ˆæ¯</h1>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_17/Filtersrv.png" alt="Filtersrv.png"></p>
<h2>4.1 Consumer ä» Filtersrv æ‹‰å–æ¶ˆæ¯</h2>
<ul>
<li>ğŸ¦… <code>Consumer</code> æ‹‰å– <strong>ä½¿ç”¨è¿‡æ»¤ç±»æ–¹å¼è®¢é˜…</strong> çš„æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œä» <code>Broker</code> å¯¹åº”çš„ <code>Filtersrv</code> åˆ—è¡¨<strong>éšæœº</strong>é€‰æ‹©ä¸€ä¸ªæ‹‰å–æ¶ˆæ¯ã€‚<strong>å¦‚æœé€‰æ‹©ä¸åˆ° <code>Filtersrv</code>ï¼Œåˆ™æ— æ³•æ‹‰å–æ¶ˆæ¯ã€‚å› æ­¤ï¼Œ<code>Filtersrv</code> ä¸€å®šè¦åšé«˜å¯ç”¨</strong>ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€PullAPIWrapper.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="comment">/**</span></div><div class="line"> 3:  * æ‹‰å–æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•</div><div class="line"> 4:  *</div><div class="line"> 5:  * <span class="doctag">@param</span> mq æ¶ˆæ¯å˜Ÿåˆ—</div><div class="line"> 6:  * <span class="doctag">@param</span> subExpression è®¢é˜…è¡¨è¾¾å¼</div><div class="line"> 7:  * <span class="doctag">@param</span> subVersion è®¢é˜…ç‰ˆæœ¬å·</div><div class="line"> 8:  * <span class="doctag">@param</span> offset æ‹‰å–é˜Ÿåˆ—å¼€å§‹ä½ç½®</div><div class="line"> 9:  * <span class="doctag">@param</span> maxNums æ‰¹é‡æ‹‰ å–æ¶ˆæ¯æ•°é‡</div><div class="line">10:  * <span class="doctag">@param</span> sysFlag æ‹‰å–ç³»ç»Ÿæ ‡è¯†</div><div class="line">11:  * <span class="doctag">@param</span> commitOffset æäº¤æ¶ˆè´¹è¿›åº¦</div><div class="line">12:  * <span class="doctag">@param</span> brokerSuspendMaxTimeMillis brokeræŒ‚èµ·è¯·æ±‚æœ€å¤§æ—¶é—´</div><div class="line">13:  * <span class="doctag">@param</span> timeoutMillis è¯·æ±‚brokerè¶…æ—¶æ—¶é—´</div><div class="line">14:  * <span class="doctag">@param</span> communicationMode é€šè®¯æ¨¡å¼</div><div class="line">15:  * <span class="doctag">@param</span> pullCallback æ‹‰å–å›è°ƒ</div><div class="line">16:  * <span class="doctag">@return</span> æ‹‰å–æ¶ˆæ¯ç»“æœã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶ï¼Œæ‰è¿”å›ç»“æœï¼Œå¦åˆ™è¿”å›nullã€‚</div><div class="line">17:  * <span class="doctag">@throws</span> MQClientException å½“å¯»æ‰¾ä¸åˆ° broker æ—¶ï¼Œæˆ–å‘ç”Ÿå…¶ä»–clientå¼‚å¸¸</div><div class="line">18:  * <span class="doctag">@throws</span> RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class="line">19:  * <span class="doctag">@throws</span> MQBrokerException å½“ broker å‘ç”Ÿå¼‚å¸¸æ—¶ã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶æ‰ä¼šå‘ç”Ÿè¯¥å¼‚å¸¸ã€‚</div><div class="line">20:  * <span class="doctag">@throws</span> InterruptedException å½“å‘ç”Ÿä¸­æ–­å¼‚å¸¸æ—¶</div><div class="line">21:  */</div><div class="line"><span class="number">22</span>: <span class="function"><span class="keyword">protected</span> PullResult <span class="title">pullKernelImpl</span><span class="params">(</span></span></div><div class="line"><span class="number">23</span>:     <span class="keyword">final</span> MessageQueue mq,</div><div class="line"><span class="number">24</span>:     <span class="keyword">final</span> String subExpression,</div><div class="line"><span class="number">25</span>:     <span class="keyword">final</span> <span class="keyword">long</span> subVersion,</div><div class="line"><span class="number">26</span>:     <span class="keyword">final</span> <span class="keyword">long</span> offset,</div><div class="line"><span class="number">27</span>:     <span class="keyword">final</span> <span class="keyword">int</span> maxNums,</div><div class="line"><span class="number">28</span>:     <span class="keyword">final</span> <span class="keyword">int</span> sysFlag,</div><div class="line"><span class="number">29</span>:     <span class="keyword">final</span> <span class="keyword">long</span> commitOffset,</div><div class="line"><span class="number">30</span>:     <span class="keyword">final</span> <span class="keyword">long</span> brokerSuspendMaxTimeMillis,</div><div class="line"><span class="number">31</span>:     <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis,</div><div class="line"><span class="number">32</span>:     <span class="keyword">final</span> CommunicationMode communicationMode,</div><div class="line"><span class="number">33</span>:     <span class="keyword">final</span> PullCallback pullCallback</div><div class="line"><span class="number">34</span>: ) <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</div><div class="line"><span class="number">35</span>:     <span class="comment">// // ....(çœç•¥ä»£ç )</span></div><div class="line"><span class="number">36</span>:     <span class="comment">// è¯·æ±‚æ‹‰å–æ¶ˆæ¯</span></div><div class="line"><span class="number">37</span>:     <span class="keyword">if</span> (findBrokerResult != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">38</span>:         <span class="comment">// ....(çœç•¥ä»£ç )</span></div><div class="line"><span class="number">39</span>:         <span class="comment">// è‹¥è®¢é˜…topicä½¿ç”¨è¿‡æ»¤ç±»ï¼Œä½¿ç”¨filtersrvè·å–æ¶ˆæ¯</span></div><div class="line"><span class="number">40</span>:         String brokerAddr = findBrokerResult.getBrokerAddr();</div><div class="line"><span class="number">41</span>:         <span class="keyword">if</span> (PullSysFlag.hasClassFilterFlag(sysFlagInner)) &#123;</div><div class="line"><span class="number">42</span>:             brokerAddr = computPullFromWhichFilterServer(mq.getTopic(), brokerAddr);</div><div class="line"><span class="number">43</span>:         &#125;</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:         PullResult pullResult = <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().pullMessage(</div><div class="line"><span class="number">46</span>:             brokerAddr,</div><div class="line"><span class="number">47</span>:             requestHeader,</div><div class="line"><span class="number">48</span>:             timeoutMillis,</div><div class="line"><span class="number">49</span>:             communicationMode,</div><div class="line"><span class="number">50</span>:             pullCallback);</div><div class="line"><span class="number">51</span>: </div><div class="line"><span class="number">52</span>:         <span class="keyword">return</span> pullResult;</div><div class="line"><span class="number">53</span>:     &#125;</div><div class="line"><span class="number">54</span>: </div><div class="line"><span class="number">55</span>:     <span class="comment">// Brokerä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></div><div class="line"><span class="number">56</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"The broker["</span> + mq.getBrokerName() + <span class="string">"] not exist"</span>, <span class="keyword">null</span>);</div><div class="line"><span class="number">57</span>: &#125;</div><div class="line"><span class="number">58</span>: </div><div class="line"><span class="number">59</span>: <span class="comment">/**</span></div><div class="line">60:  * è®¡ç®—filtersrvåœ°å€ã€‚å¦‚æœæœ‰å¤šä¸ªfiltersrvï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªã€‚</div><div class="line">61:  *</div><div class="line">62:  * <span class="doctag">@param</span> topic Topic</div><div class="line">63:  * <span class="doctag">@param</span> brokerAddr brokeråœ°å€</div><div class="line">64:  * <span class="doctag">@return</span> filtersrvåœ°å€</div><div class="line">65:  * <span class="doctag">@throws</span> MQClientException å½“filtersrvä¸å­˜åœ¨æ—¶</div><div class="line">66:  */</div><div class="line"><span class="number">67</span>: <span class="function"><span class="keyword">private</span> String <span class="title">computPullFromWhichFilterServer</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> String brokerAddr)</span></span></div><div class="line">68:     <span class="keyword">throws</span> MQClientException &#123;</div><div class="line"><span class="number">69</span>:     ConcurrentHashMap&lt;String, TopicRouteData&gt; topicRouteTable = <span class="keyword">this</span>.mQClientFactory.getTopicRouteTable();</div><div class="line"><span class="number">70</span>:     <span class="keyword">if</span> (topicRouteTable != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">71</span>:         TopicRouteData topicRouteData = topicRouteTable.get(topic);</div><div class="line"><span class="number">72</span>:         List&lt;String&gt; list = topicRouteData.getFilterServerTable().get(brokerAddr);</div><div class="line"><span class="number">73</span>:         <span class="keyword">if</span> (list != <span class="keyword">null</span> &amp;&amp; !list.isEmpty()) &#123;</div><div class="line"><span class="number">74</span>:             <span class="keyword">return</span> list.get(randomNum() % list.size());</div><div class="line"><span class="number">75</span>:         &#125;</div><div class="line"><span class="number">76</span>:     &#125;</div><div class="line"><span class="number">77</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"Find Filter Server Failed, Broker Addr: "</span> + brokerAddr + <span class="string">" topic: "</span></div><div class="line"><span class="number">78</span>:         + topic, <span class="keyword">null</span>);</div><div class="line"><span class="number">79</span>: &#125;</div></pre></td></tr></table></figure></p>
<h2>4.2 Filtersrv ä» Broker æ‹‰å–æ¶ˆæ¯</h2>
<ul>
<li>ğŸ¦… <code>Filtersrv</code> æ‹‰å–æ¶ˆæ¯åï¼Œä¼šå»ºè®® <code>Consumer</code> å‘ <code>Brokerä¸»èŠ‚ç‚¹</code> æ‹‰å–æ¶ˆæ¯ã€‚</li>
<li>ğŸ¦… <code>Filtersrv</code> å¯ä»¥ç†è§£æˆä¸€ä¸ª <code>Consumer</code>ï¼Œå‘ <code>Broker</code> æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œå®é™…ä½¿ç”¨çš„ <code>DefaultMQPullConsumer.java</code> çš„æ–¹æ³•å’Œé€»è¾‘ã€‚</li>
</ul>
<pre><code class="language-Java">  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultRequestProcessor.javaã€‘
  2: /**
  3:  * æ‹‰å–æ¶ˆæ¯
  4:  *
  5:  * @param ctx æ‹‰å–æ¶ˆæ¯context
  6:  * @param request æ‹‰å–æ¶ˆæ¯è¯·æ±‚
  7:  * @return å“åº”
  8:  * @throws Exception å½“å‘ç”Ÿå¼‚å¸¸æ—¶
  9:  */
 10: private RemotingCommand pullMessageForward(final ChannelHandlerContext ctx, final RemotingCommand request) throws Exception {
 11:     final RemotingCommand response = RemotingCommand.createResponseCommand(PullMessageResponseHeader.class);
 12:     final PullMessageResponseHeader responseHeader = (PullMessageResponseHeader) response.readCustomHeader();
 13:     final PullMessageRequestHeader requestHeader =
 14:         (PullMessageRequestHeader) request.decodeCommandCustomHeader(PullMessageRequestHeader.class);
 15: 
 16:     final FilterContext filterContext = new FilterContext();
 17:     filterContext.setConsumerGroup(requestHeader.getConsumerGroup());
 18: 
 19:     response.setOpaque(request.getOpaque());
 20: 
 21:     DefaultMQPullConsumer pullConsumer = this.filtersrvController.getDefaultMQPullConsumer();
 22: 
 23:     // æ ¡éªŒTopicè¿‡æ»¤ç±»æ˜¯å¦å®Œæ•´
 24:     final FilterClassInfo findFilterClass = this.filtersrvController.getFilterClassManager().findFilterClass(requestHeader.getConsumerGroup(), requestHeader.getTopic());
 25:     if (null == findFilterClass) {
 26:         response.setCode(ResponseCode.SYSTEM_ERROR);
 27:         response.setRemark(&quot;Find Filter class failed, not registered&quot;);
 28:         return response;
 29:     }
 30:     if (null == findFilterClass.getMessageFilter()) {
 31:         response.setCode(ResponseCode.SYSTEM_ERROR);
 32:         response.setRemark(&quot;Find Filter class failed, registered but no class&quot;);
 33:         return response;
 34:     }
 35: 
 36:     // è®¾ç½®ä¸‹æ¬¡è¯·æ±‚ä» Brokerä¸»èŠ‚ç‚¹ã€‚
 37:     responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);
 38: 
 39:     MessageQueue mq = new MessageQueue();
 40:     mq.setTopic(requestHeader.getTopic());
 41:     mq.setQueueId(requestHeader.getQueueId());
 42:     mq.setBrokerName(this.filtersrvController.getBrokerName());
 43:     long offset = requestHeader.getQueueOffset();
 44:     int maxNums = requestHeader.getMaxMsgNums();
 45: 
 46:     final PullCallback pullCallback = new PullCallback() {
 47: 
 48:         @Override
 49:         public void onSuccess(PullResult pullResult) {
 50:             responseHeader.setMaxOffset(pullResult.getMaxOffset());
 51:             responseHeader.setMinOffset(pullResult.getMinOffset());
 52:             responseHeader.setNextBeginOffset(pullResult.getNextBeginOffset());
 53:             response.setRemark(null);
 54: 
 55:             switch (pullResult.getPullStatus()) {
 56:                 case FOUND:
 57:                     response.setCode(ResponseCode.SUCCESS);
 58: 
 59:                     List&lt;MessageExt&gt; msgListOK = new ArrayList&lt;MessageExt&gt;();
 60:                     try {
 61:                         for (MessageExt msg : pullResult.getMsgFoundList()) {
 62:                             // ä½¿ç”¨è¿‡æ»¤ç±»è¿‡æ»¤æ¶ˆæ¯
 63:                             boolean match = findFilterClass.getMessageFilter().match(msg, filterContext);
 64:                             if (match) {
 65:                                 msgListOK.add(msg);
 66:                             }
 67:                         }
 68: 
 69:                         if (!msgListOK.isEmpty()) {
 70:                             returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, msgListOK);
 71:                             return;
 72:                         } else {
 73:                             response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);
 74:                         }
 75:                     } catch (Throwable e) {
 76:                         final String error =
 77:                             String.format(&quot;do Message Filter Exception, ConsumerGroup: %s Topic: %s &quot;,
 78:                                 requestHeader.getConsumerGroup(), requestHeader.getTopic());
 79:                         log.error(error, e);
 80: 
 81:                         response.setCode(ResponseCode.SYSTEM_ERROR);
 82:                         response.setRemark(error + RemotingHelper.exceptionSimpleDesc(e));
 83:                         returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, null);
 84:                         return;
 85:                     }
 86: 
 87:                     break;
 88:                 case NO_MATCHED_MSG:
 89:                     response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);
 90:                     break;
 91:                 case NO_NEW_MSG:
 92:                     response.setCode(ResponseCode.PULL_NOT_FOUND);
 93:                     break;
 94:                 case OFFSET_ILLEGAL:
 95:                     response.setCode(ResponseCode.PULL_OFFSET_MOVED);
 96:                     break;
 97:                 default:
 98:                     break;
 99:             }
100: 
101:             returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, null);
102:         }
103: 
104:         @Override
105:         public void onException(Throwable e) {
106:             response.setCode(ResponseCode.SYSTEM_ERROR);
107:             response.setRemark(&quot;Pull Callback Exception, &quot; + RemotingHelper.exceptionSimpleDesc(e));
108:             returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, null);
109:             return;
110:         }
111:     };
112: 
113:     // æ‹‰å–æ¶ˆæ¯
114:     pullConsumer.pullBlockIfNotFound(mq, null, offset, maxNums, pullCallback);
115:     return null;
116: }
</code></pre>
<h1>5. Filtersrv é«˜å¯ç”¨</h1>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_17/02.png" alt="Filtersrvè¿‡å¯ç”¨"></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rock
    
    </summary>
    
      <category term="RocketMQ" scheme="http://www.yunai.me/categories/RocketMQ/"/>
    
    
  </entry>
  
  <entry>
    <title>RocketMQ æºç åˆ†æ â€”â€” å®šæ—¶æ¶ˆæ¯ä¸æ¶ˆæ¯é‡è¯•</title>
    <link href="http://www.yunai.me/RocketMQ/message-schedule-and-retry/"/>
    <id>http://www.yunai.me/RocketMQ/message-schedule-and-retry/</id>
    <published>2017-05-14T16:00:00.000Z</published>
    <updated>2017-07-27T16:57:09.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. å®šæ—¶æ¶ˆæ¯</a>
<ul>
<li><a href="#">2.1 å»¶è¿Ÿçº§åˆ«</a></li>
<li><a href="#">2.2 Producer å‘é€å®šæ—¶æ¶ˆæ¯</a></li>
<li><a href="#">2.3 Broker å­˜å‚¨å®šæ—¶æ¶ˆæ¯</a></li>
<li><a href="#">2.4 Broker å‘é€å®šæ—¶æ¶ˆæ¯</a></li>
<li><a href="#">2.5 Broker æŒä¹…åŒ–å®šæ—¶å‘é€è¿›åº¦</a></li>
</ul>
</li>
<li><a href="#">3. æ¶ˆæ¯é‡è¯•</a></li>
</ul>
<h1>1. æ¦‚è¿°</h1>
<p><strong>å»ºè®®</strong>å‰ç½®é˜…è¯»å†…å®¹ï¼š</p>
<ul>
<li><a href="http://www.yunai.me/RocketMQ/message-send-and-receive/">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message å‘é€ä¸æ¥æ”¶ã€‹</a></li>
<li><a href="http://www.yunai.me/RocketMQ/message-pull-and-consume-second/">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸‹ï¼‰ã€‹</a></li>
</ul>
<p>ğŸ˜ˆ ä¸ºä»€ä¹ˆæŠŠ<strong>å®šæ—¶æ¶ˆæ¯</strong>ä¸<strong>æ¶ˆæ¯é‡è¯•</strong>æ”¾åœ¨ä¸€èµ·ï¼Ÿä½ çŒœã€‚<br>
ğŸ‘» ä½ çŒœæˆ‘çŒœä¸çŒœã€‚</p>
<h1>2. å®šæ—¶æ¶ˆæ¯</h1>
<blockquote>
<p><strong>å®šæ—¶æ¶ˆæ¯</strong>æ˜¯æŒ‡æ¶ˆæ¯å‘åˆ° Broker åï¼Œä¸èƒ½ç«‹åˆ»è¢« Consumer æ¶ˆè´¹ï¼Œè¦åˆ°ç‰¹å®šçš„æ—¶é—´ç‚¹æˆ–è€…ç­‰å¾…ç‰¹å®šçš„æ—¶é—´åæ‰èƒ½è¢«æ¶ˆè´¹ã€‚</p>
</blockquote>
<p>ä¸‹å›¾æ˜¯<strong>å®šæ—¶æ¶ˆæ¯</strong>çš„å¤„ç†é€»è¾‘å›¾ï¼š</p>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_15/02.png" alt="å®šæ—¶æ¶ˆæ¯é€»è¾‘å›¾.png"></p>
<h2>2.1 å»¶è¿Ÿçº§åˆ«</h2>
<p><code>RocketMQ</code> ç›®å‰åªæ”¯æŒ<strong>å›ºå®šç²¾åº¦</strong>çš„å®šæ—¶æ¶ˆæ¯ã€‚å®˜æ–¹è¯´æ³•å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å¦‚æœè¦æ”¯æŒä»»æ„çš„æ—¶é—´ç²¾åº¦ï¼Œåœ¨ Broker å±‚é¢ï¼Œå¿…é¡»è¦åšæ¶ˆæ¯æ’åºï¼Œå¦‚æœå†æ¶‰åŠåˆ°æŒä¹…åŒ–ï¼Œé‚£ä¹ˆæ¶ˆæ¯æ’åºè¦ä¸å¯é¿å…çš„äº§ç”Ÿå·¨å¤§æ€§èƒ½å¼€é”€ã€‚</p>
</blockquote>
<ul>
<li>å»¶è¿Ÿçº§åˆ«ï¼š</li>
</ul>
<table>
<thead>
<tr>
<th>å»¶è¿Ÿçº§åˆ«</th>
<th>æ—¶é—´</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1s</td>
</tr>
<tr>
<td>2</td>
<td>5s</td>
</tr>
<tr>
<td>3</td>
<td>10s</td>
</tr>
<tr>
<td>4</td>
<td>30s</td>
</tr>
<tr>
<td>5</td>
<td>1m</td>
</tr>
<tr>
<td>6</td>
<td>2m</td>
</tr>
<tr>
<td>7</td>
<td>3m</td>
</tr>
<tr>
<td>8</td>
<td>4m</td>
</tr>
<tr>
<td>9</td>
<td>5m</td>
</tr>
<tr>
<td>10</td>
<td>6m</td>
</tr>
<tr>
<td>11</td>
<td>7m</td>
</tr>
<tr>
<td>12</td>
<td>8m</td>
</tr>
<tr>
<td>13</td>
<td>9m</td>
</tr>
<tr>
<td>14</td>
<td>10m</td>
</tr>
<tr>
<td>15</td>
<td>20m</td>
</tr>
<tr>
<td>16</td>
<td>30m</td>
</tr>
<tr>
<td>17</td>
<td>1h</td>
</tr>
<tr>
<td>18</td>
<td>2h</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>æ ¸å¿ƒæºç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MessageStoreConfig.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="comment">/**</span></div><div class="line"> 3:  * æ¶ˆæ¯å»¶è¿Ÿçº§åˆ«å­—ç¬¦ä¸²é…ç½®</div><div class="line"> 4:  */</div><div class="line"> <span class="number">5</span>: <span class="keyword">private</span> String messageDelayLevel = <span class="string">"1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h"</span>;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘</span></div><div class="line"> <span class="number">8</span>: <span class="comment">/**</span></div><div class="line"> 9:  * è§£æå»¶è¿Ÿçº§åˆ«</div><div class="line">10:  *</div><div class="line">11:  * <span class="doctag">@return</span> æ˜¯å¦è§£ææˆåŠŸ</div><div class="line">12:  */</div><div class="line"><span class="number">13</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">parseDelayLevel</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">14</span>:     HashMap&lt;String, Long&gt; timeUnitTable = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"><span class="number">15</span>:     timeUnitTable.put(<span class="string">"s"</span>, <span class="number">1000L</span>);</div><div class="line"><span class="number">16</span>:     timeUnitTable.put(<span class="string">"m"</span>, <span class="number">1000L</span> * <span class="number">60</span>);</div><div class="line"><span class="number">17</span>:     timeUnitTable.put(<span class="string">"h"</span>, <span class="number">1000L</span> * <span class="number">60</span> * <span class="number">60</span>);</div><div class="line"><span class="number">18</span>:     timeUnitTable.put(<span class="string">"d"</span>, <span class="number">1000L</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>);</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>:     String levelString = <span class="keyword">this</span>.defaultMessageStore.getMessageStoreConfig().getMessageDelayLevel();</div><div class="line"><span class="number">21</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">22</span>:         String[] levelArray = levelString.split(<span class="string">" "</span>);</div><div class="line"><span class="number">23</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; levelArray.length; i++) &#123;</div><div class="line"><span class="number">24</span>:             String value = levelArray[i];</div><div class="line"><span class="number">25</span>:             String ch = value.substring(value.length() - <span class="number">1</span>);</div><div class="line"><span class="number">26</span>:             Long tu = timeUnitTable.get(ch);</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>:             <span class="keyword">int</span> level = i + <span class="number">1</span>;</div><div class="line"><span class="number">29</span>:             <span class="keyword">if</span> (level &gt; <span class="keyword">this</span>.maxDelayLevel) &#123;</div><div class="line"><span class="number">30</span>:                 <span class="keyword">this</span>.maxDelayLevel = level;</div><div class="line"><span class="number">31</span>:             &#125;</div><div class="line"><span class="number">32</span>:             <span class="keyword">long</span> num = Long.parseLong(value.substring(<span class="number">0</span>, value.length() - <span class="number">1</span>));</div><div class="line"><span class="number">33</span>:             <span class="keyword">long</span> delayTimeMillis = tu * num;</div><div class="line"><span class="number">34</span>:             <span class="keyword">this</span>.delayLevelTable.put(level, delayTimeMillis);</div><div class="line"><span class="number">35</span>:         &#125;</div><div class="line"><span class="number">36</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">37</span>:         log.error(<span class="string">"parseDelayLevel exception"</span>, e);</div><div class="line"><span class="number">38</span>:         log.info(<span class="string">"levelString String = &#123;&#125;"</span>, levelString);</div><div class="line"><span class="number">39</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">40</span>:     &#125;</div><div class="line"><span class="number">41</span>: </div><div class="line"><span class="number">42</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">43</span>: &#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<h2>2.2 Producer å‘é€å®šæ—¶æ¶ˆæ¯</h2>
<ul>
<li>ğŸ¦…å‘é€æ—¶ï¼Œè®¾ç½®æ¶ˆæ¯çš„<strong>å»¶è¿Ÿçº§åˆ«</strong>ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">Message msg = <span class="keyword">new</span> Message(...);</div><div class="line">msg.setDelayTimeLevel(level);</div></pre></td></tr></table></figure></p>
<h2>2.3 Broker å­˜å‚¨å®šæ—¶æ¶ˆæ¯</h2>
<ul>
<li>ğŸ¦… å­˜å‚¨æ¶ˆæ¯æ—¶ï¼Œå»¶è¿Ÿæ¶ˆæ¯è¿›å…¥ <code>Topic</code> ä¸º <code>SCHEDULE_TOPIC_XXXX</code>ã€‚</li>
<li>ğŸ¦… å»¶è¿Ÿçº§åˆ« ä¸ æ¶ˆæ¯é˜Ÿåˆ—ç¼–å· åš<strong>å›ºå®šæ˜ å°„ï¼šQueueId = DelayLevel - 1</strong>ã€‚</li>
</ul>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€CommitLog.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="comment">/**</span></div><div class="line"> 3:  * æ·»åŠ æ¶ˆæ¯ï¼Œè¿”å›æ¶ˆæ¯ç»“æœ</div><div class="line"> 4:  *</div><div class="line"> 5:  * <span class="doctag">@param</span> msg æ¶ˆæ¯</div><div class="line"> 6:  * <span class="doctag">@return</span> ç»“æœ</div><div class="line"> 7:  */</div><div class="line"> <span class="number">8</span>: <span class="function"><span class="keyword">public</span> PutMessageResult <span class="title">putMessage</span><span class="params">(<span class="keyword">final</span> MessageExtBrokerInner msg)</span> </span>&#123;</div><div class="line"> <span class="number">9</span>:     <span class="comment">// ....(çœç•¥ä»£ç ) </span></div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>:     <span class="comment">// å®šæ—¶æ¶ˆæ¯å¤„ç†</span></div><div class="line"><span class="number">12</span>:     <span class="keyword">final</span> <span class="keyword">int</span> tranType = MessageSysFlag.getTransactionValue(msg.getSysFlag());</div><div class="line"><span class="number">13</span>:     <span class="keyword">if</span> (tranType == MessageSysFlag.TRANSACTION_NOT_TYPE<span class="comment">//</span></div><div class="line"><span class="number">14</span>:         || tranType == MessageSysFlag.TRANSACTION_COMMIT_TYPE) &#123;</div><div class="line"><span class="number">15</span>:         <span class="comment">// Delay Delivery</span></div><div class="line"><span class="number">16</span>:         <span class="keyword">if</span> (msg.getDelayTimeLevel() &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">17</span>:             <span class="keyword">if</span> (msg.getDelayTimeLevel() &gt; <span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) &#123;</div><div class="line"><span class="number">18</span>:                 msg.setDelayTimeLevel(<span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel());</div><div class="line"><span class="number">19</span>:             &#125;</div><div class="line"><span class="number">20</span>: </div><div class="line"><span class="number">21</span>:             <span class="comment">// å­˜å‚¨æ¶ˆæ¯æ—¶ï¼Œå»¶è¿Ÿæ¶ˆæ¯è¿›å…¥ `Topic` ä¸º `SCHEDULE_TOPIC_XXXX` ã€‚</span></div><div class="line"><span class="number">22</span>:             topic = ScheduleMessageService.SCHEDULE_TOPIC;</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:             <span class="comment">// å»¶è¿Ÿçº§åˆ« ä¸ æ¶ˆæ¯é˜Ÿåˆ—ç¼–å· åšå›ºå®šæ˜ å°„</span></div><div class="line"><span class="number">25</span>:             queueId = ScheduleMessageService.delayLevel2QueueId(msg.getDelayTimeLevel());</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:             <span class="comment">// Backup real topic, queueId</span></div><div class="line"><span class="number">28</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_TOPIC, msg.getTopic());</div><div class="line"><span class="number">29</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msg.getQueueId()));</div><div class="line"><span class="number">30</span>:             msg.setPropertiesString(MessageDecoder.messageProperties2String(msg.getProperties()));</div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>:             msg.setTopic(topic);</div><div class="line"><span class="number">33</span>:             msg.setQueueId(queueId);</div><div class="line"><span class="number">34</span>:         &#125;</div><div class="line"><span class="number">35</span>:     &#125;</div><div class="line"><span class="number">36</span>: </div><div class="line"><span class="number">37</span>:     <span class="comment">// ....(çœç•¥ä»£ç ) </span></div><div class="line"><span class="number">38</span>: &#125;</div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘</span></div><div class="line"><span class="number">41</span>: <span class="comment">/**</span></div><div class="line">42:  * æ ¹æ® å»¶è¿Ÿçº§åˆ« è®¡ç®— æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·</div><div class="line">43:  * QueueId = DelayLevel - 1</div><div class="line">44:  *</div><div class="line">45:  * <span class="doctag">@param</span> delayLevel å»¶è¿Ÿçº§åˆ«</div><div class="line">46:  * <span class="doctag">@return</span> æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·</div><div class="line">47:  */</div><div class="line"><span class="number">48</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">delayLevel2QueueId</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> delayLevel)</span> </span>&#123;</div><div class="line"><span class="number">49</span>:     <span class="keyword">return</span> delayLevel - <span class="number">1</span>;</div><div class="line"><span class="number">50</span>: &#125;</div></pre></td></tr></table></figure></p>
<hr>
<ul>
<li>ğŸ¦… ç”Ÿæˆ <code>ConsumeQueue</code> æ—¶ï¼Œæ¯æ¡æ¶ˆæ¯çš„ <code>tagsCode</code> ä½¿ç”¨ã€æ¶ˆæ¯è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘ã€‚è¿™æ ·ï¼Œ<code>ScheduleMessageService</code> åœ¨è½®è¯¢ <code>ConsumeQueue</code> æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>tagsCode</code> è¿›è¡Œè¿‡æ»¤ã€‚</li>
</ul>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€CommitLog.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="comment">/**</span></div><div class="line"> 3:  * check the message and returns the message size</div><div class="line"> 4:  *</div><div class="line"> 5:  * <span class="doctag">@return</span> 0 Come the end of the file // &gt;0 Normal messages // -1 Message checksum failure</div><div class="line"> 6:  */</div><div class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">public</span> DispatchRequest <span class="title">checkMessageAndReturnSize</span><span class="params">(ByteBuffer byteBuffer, <span class="keyword">final</span> <span class="keyword">boolean</span> checkCRC, <span class="keyword">final</span> <span class="keyword">boolean</span> readBody)</span> </span>&#123;</div><div class="line"> <span class="number">8</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">9</span>:         <span class="comment">// // ....(çœç•¥ä»£ç )</span></div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>:         <span class="comment">// 17 properties</span></div><div class="line"><span class="number">12</span>:         <span class="keyword">short</span> propertiesLength = byteBuffer.getShort();</div><div class="line"><span class="number">13</span>:         <span class="keyword">if</span> (propertiesLength &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">14</span>:             <span class="comment">// ....(çœç•¥ä»£ç )</span></div><div class="line"><span class="number">15</span>:             String tags = propertiesMap.get(MessageConst.PROPERTY_TAGS);</div><div class="line"><span class="number">16</span>:             <span class="keyword">if</span> (tags != <span class="keyword">null</span> &amp;&amp; tags.length() &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">17</span>:                 tagsCode = MessageExtBrokerInner.tagsString2tagsCode(MessageExt.parseTopicFilterType(sysFlag), tags);</div><div class="line"><span class="number">18</span>:             &#125;</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>:             <span class="comment">// Timing message processing</span></div><div class="line"><span class="number">21</span>:             &#123;</div><div class="line"><span class="number">22</span>:                 String t = propertiesMap.get(MessageConst.PROPERTY_DELAY_TIME_LEVEL);</div><div class="line"><span class="number">23</span>:                 <span class="keyword">if</span> (ScheduleMessageService.SCHEDULE_TOPIC.equals(topic) &amp;&amp; t != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">24</span>:                     <span class="keyword">int</span> delayLevel = Integer.parseInt(t);</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:                     <span class="keyword">if</span> (delayLevel &gt; <span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) &#123;</div><div class="line"><span class="number">27</span>:                         delayLevel = <span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel();</div><div class="line"><span class="number">28</span>:                     &#125;</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>:                     <span class="keyword">if</span> (delayLevel &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">31</span>:                         tagsCode = <span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().computeDeliverTimestamp(delayLevel,</div><div class="line"><span class="number">32</span>:                             storeTimestamp);</div><div class="line"><span class="number">33</span>:                     &#125;</div><div class="line"><span class="number">34</span>:                 &#125;</div><div class="line"><span class="number">35</span>:             &#125;</div><div class="line"><span class="number">36</span>:         &#125;</div><div class="line"><span class="number">37</span>: </div><div class="line"><span class="number">38</span>:         <span class="comment">// ....(çœç•¥ä»£ç )</span></div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>:         <span class="keyword">return</span> <span class="keyword">new</span> DispatchRequest(<span class="comment">//</span></div><div class="line"><span class="number">41</span>:             topic, <span class="comment">// 1</span></div><div class="line"><span class="number">42</span>:             queueId, <span class="comment">// 2</span></div><div class="line"><span class="number">43</span>:             physicOffset, <span class="comment">// 3</span></div><div class="line"><span class="number">44</span>:             totalSize, <span class="comment">// 4</span></div><div class="line"><span class="number">45</span>:             tagsCode, <span class="comment">// 5</span></div><div class="line"><span class="number">46</span>:             storeTimestamp, <span class="comment">// 6</span></div><div class="line"><span class="number">47</span>:             queueOffset, <span class="comment">// 7</span></div><div class="line"><span class="number">48</span>:             keys, <span class="comment">// 8</span></div><div class="line"><span class="number">49</span>:             uniqKey, <span class="comment">//9</span></div><div class="line"><span class="number">50</span>:             sysFlag, <span class="comment">// 9</span></div><div class="line"><span class="number">51</span>:             preparedTransactionOffset<span class="comment">// 10</span></div><div class="line"><span class="number">52</span>:         );</div><div class="line"><span class="number">53</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">54</span>:     &#125;</div><div class="line"><span class="number">55</span>: </div><div class="line"><span class="number">56</span>:     <span class="keyword">return</span> <span class="keyword">new</span> DispatchRequest(-<span class="number">1</span>, <span class="keyword">false</span> <span class="comment">/* success */</span>);</div><div class="line"><span class="number">57</span>: &#125;</div><div class="line"><span class="number">58</span>: </div><div class="line"><span class="number">59</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘</span></div><div class="line"><span class="number">60</span>: <span class="comment">/**</span></div><div class="line">61:  * è®¡ç®— æŠ•é€’æ—¶é—´ã€è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘</div><div class="line">62:  *</div><div class="line">63:  * <span class="doctag">@param</span> delayLevel å»¶è¿Ÿçº§åˆ«</div><div class="line">64:  * <span class="doctag">@param</span> storeTimestamp å­˜å‚¨æ—¶é—´</div><div class="line">65:  * <span class="doctag">@return</span> æŠ•é€’æ—¶é—´ã€è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘</div><div class="line">66:  */</div><div class="line"><span class="number">67</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">computeDeliverTimestamp</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> delayLevel, <span class="keyword">final</span> <span class="keyword">long</span> storeTimestamp)</span> </span>&#123;</div><div class="line"><span class="number">68</span>:     Long time = <span class="keyword">this</span>.delayLevelTable.get(delayLevel);</div><div class="line"><span class="number">69</span>:     <span class="keyword">if</span> (time != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">70</span>:         <span class="keyword">return</span> time + storeTimestamp;</div><div class="line"><span class="number">71</span>:     &#125;</div><div class="line"><span class="number">72</span>: </div><div class="line"><span class="number">73</span>:     <span class="keyword">return</span> storeTimestamp + <span class="number">1000</span>;</div><div class="line"><span class="number">74</span>: &#125;</div></pre></td></tr></table></figure></p>
<h2>2.4 Broker å‘é€å®šæ—¶æ¶ˆæ¯</h2>
<ul>
<li>ğŸ¦… å¯¹ <code>SCHEDULE_TOPIC_XXXX</code> æ¯æ¡æ¶ˆè´¹é˜Ÿåˆ—å¯¹åº”<strong>å•ç‹¬ä¸€ä¸ª</strong>å®šæ—¶ä»»åŠ¡è¿›è¡Œè½®è¯¢ï¼Œå‘é€ <strong>åˆ°è¾¾æŠ•é€’æ—¶é—´ã€è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘</strong> çš„æ¶ˆæ¯ã€‚</li>
</ul>
<p>ä¸‹å›¾æ˜¯å‘é€å®šæ—¶æ¶ˆæ¯çš„å¤„ç†é€»è¾‘å›¾ï¼š</p>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_15/01.png" alt="å®šæ—¶æ¶ˆæ¯å®šæ—¶é€»è¾‘"></p>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">/**</span></div><div class="line">  2:  * â¬‡ï¸â¬‡ï¸â¬‡ï¸ å‘é€ï¼ˆæŠ•é€’ï¼‰å»¶è¿Ÿæ¶ˆæ¯å®šæ—¶ä»»åŠ¡</div><div class="line">  3:  */</div><div class="line">  <span class="number">4</span>: <span class="class"><span class="keyword">class</span> <span class="title">DeliverDelayedMessageTimerTask</span> <span class="keyword">extends</span> <span class="title">TimerTask</span> </span>&#123;</div><div class="line">  <span class="number">5</span>:     <span class="comment">/**</span></div><div class="line">  6:      * å»¶è¿Ÿçº§åˆ«</div><div class="line">  7:      */</div><div class="line">  <span class="number">8</span>:     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> delayLevel;</div><div class="line">  <span class="number">9</span>:     <span class="comment">/**</span></div><div class="line"> 10:      * ä½ç½®</div><div class="line"> 11:      */</div><div class="line"> <span class="number">12</span>:     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> offset;</div><div class="line"> <span class="number">13</span>: </div><div class="line"> <span class="number">14</span>:     <span class="function"><span class="keyword">public</span> <span class="title">DeliverDelayedMessageTimerTask</span><span class="params">(<span class="keyword">int</span> delayLevel, <span class="keyword">long</span> offset)</span> </span>&#123;</div><div class="line"> <span class="number">15</span>:         <span class="keyword">this</span>.delayLevel = delayLevel;</div><div class="line"> <span class="number">16</span>:         <span class="keyword">this</span>.offset = offset;</div><div class="line"> <span class="number">17</span>:     &#125;</div><div class="line"> <span class="number">18</span>: </div><div class="line"> <span class="number">19</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">20</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">21</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">22</span>:             <span class="keyword">this</span>.executeOnTimeup();</div><div class="line"> <span class="number">23</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">24</span>:             <span class="comment">// <span class="doctag">XXX:</span> warn and notify me</span></div><div class="line"> <span class="number">25</span>:             log.error(<span class="string">"ScheduleMessageService, executeOnTimeup exception"</span>, e);</div><div class="line"> <span class="number">26</span>:             ScheduleMessageService.<span class="keyword">this</span>.timer.schedule(<span class="keyword">new</span> DeliverDelayedMessageTimerTask(</div><div class="line"> <span class="number">27</span>:                 <span class="keyword">this</span>.delayLevel, <span class="keyword">this</span>.offset), DELAY_FOR_A_PERIOD);</div><div class="line"> <span class="number">28</span>:         &#125;</div><div class="line"> <span class="number">29</span>:     &#125;</div><div class="line"> <span class="number">30</span>: </div><div class="line"> <span class="number">31</span>:     <span class="comment">/**</span></div><div class="line"> 32:      * çº æ­£å¯æŠ•é€’æ—¶é—´ã€‚</div><div class="line"> 33:      * å› ä¸ºå‘é€çº§åˆ«å¯¹åº”çš„å‘é€é—´éš”å¯ä»¥è°ƒæ•´ï¼Œå¦‚æœè¶…è¿‡å½“å‰é—´éš”ï¼Œåˆ™ä¿®æ­£æˆå½“å‰é…ç½®ï¼Œé¿å…åé¢çš„æ¶ˆæ¯æ— æ³•å‘é€ã€‚</div><div class="line"> 34:      *</div><div class="line"> 35:      * <span class="doctag">@param</span> now å½“å‰æ—¶é—´</div><div class="line"> 36:      * <span class="doctag">@param</span> deliverTimestamp æŠ•é€’æ—¶é—´</div><div class="line"> 37:      * <span class="doctag">@return</span> çº æ­£ç»“æœ</div><div class="line"> 38:      */</div><div class="line"> <span class="number">39</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">correctDeliverTimestamp</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> now, <span class="keyword">final</span> <span class="keyword">long</span> deliverTimestamp)</span> </span>&#123;</div><div class="line"> <span class="number">40</span>:         <span class="keyword">long</span> result = deliverTimestamp;</div><div class="line"> <span class="number">41</span>: </div><div class="line"> <span class="number">42</span>:         <span class="keyword">long</span> maxTimestamp = now + ScheduleMessageService.<span class="keyword">this</span>.delayLevelTable.get(<span class="keyword">this</span>.delayLevel);</div><div class="line"> <span class="number">43</span>:         <span class="keyword">if</span> (deliverTimestamp &gt; maxTimestamp) &#123;</div><div class="line"> <span class="number">44</span>:             result = now;</div><div class="line"> <span class="number">45</span>:         &#125;</div><div class="line"> <span class="number">46</span>: </div><div class="line"> <span class="number">47</span>:         <span class="keyword">return</span> result;</div><div class="line"> <span class="number">48</span>:     &#125;</div><div class="line"> <span class="number">49</span>: </div><div class="line"> <span class="number">50</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeOnTimeup</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">51</span>:         ConsumeQueue cq = ScheduleMessageService.<span class="keyword">this</span>.defaultMessageStore.findConsumeQueue(SCHEDULE_TOPIC,  delayLevel2QueueId(delayLevel));</div><div class="line"> <span class="number">52</span>: </div><div class="line"> <span class="number">53</span>:         <span class="keyword">long</span> failScheduleOffset = offset;</div><div class="line"> <span class="number">54</span>: </div><div class="line"> <span class="number">55</span>:         <span class="keyword">if</span> (cq != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">56</span>:             SelectMappedBufferResult bufferCQ = cq.getIndexBuffer(<span class="keyword">this</span>.offset);</div><div class="line"> <span class="number">57</span>:             <span class="keyword">if</span> (bufferCQ != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">58</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">59</span>:                     <span class="keyword">long</span> nextOffset = offset;</div><div class="line"> <span class="number">60</span>:                     <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line"> <span class="number">61</span>:                     <span class="keyword">for</span> (; i &lt; bufferCQ.getSize(); i += ConsumeQueue.CQ_STORE_UNIT_SIZE) &#123;</div><div class="line"> <span class="number">62</span>:                         <span class="keyword">long</span> offsetPy = bufferCQ.getByteBuffer().getLong();</div><div class="line"> <span class="number">63</span>:                         <span class="keyword">int</span> sizePy = bufferCQ.getByteBuffer().getInt();</div><div class="line"> <span class="number">64</span>:                         <span class="keyword">long</span> tagsCode = bufferCQ.getByteBuffer().getLong();</div><div class="line"> <span class="number">65</span>: </div><div class="line"> <span class="number">66</span>:                         <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"> <span class="number">67</span>:                         <span class="keyword">long</span> deliverTimestamp = <span class="keyword">this</span>.correctDeliverTimestamp(now, tagsCode);</div><div class="line"> <span class="number">68</span>: </div><div class="line"> <span class="number">69</span>:                         nextOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);</div><div class="line"> <span class="number">70</span>: </div><div class="line"> <span class="number">71</span>:                         <span class="keyword">long</span> countdown = deliverTimestamp - now;</div><div class="line"> <span class="number">72</span>: </div><div class="line"> <span class="number">73</span>:                         <span class="keyword">if</span> (countdown &lt;= <span class="number">0</span>) &#123; <span class="comment">// æ¶ˆæ¯åˆ°è¾¾å¯å‘é€æ—¶é—´</span></div><div class="line"> <span class="number">74</span>:                             MessageExt msgExt = ScheduleMessageService.<span class="keyword">this</span>.defaultMessageStore.lookMessageByOffset(offsetPy, sizePy);</div><div class="line"> <span class="number">75</span>:                             <span class="keyword">if</span> (msgExt != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">76</span>:                                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">77</span>:                                     <span class="comment">// å‘é€æ¶ˆæ¯</span></div><div class="line"> <span class="number">78</span>:                                     MessageExtBrokerInner msgInner = <span class="keyword">this</span>.messageTimeup(msgExt);</div><div class="line"> <span class="number">79</span>:                                     PutMessageResult putMessageResult = ScheduleMessageService.<span class="keyword">this</span>.defaultMessageStore.putMessage(msgInner);</div><div class="line"> <span class="number">80</span>:                                     <span class="keyword">if</span> (putMessageResult != <span class="keyword">null</span> &amp;&amp; putMessageResult.getPutMessageStatus() == PutMessageStatus.PUT_OK) &#123; <span class="comment">// å‘é€æˆåŠŸ</span></div><div class="line"> <span class="number">81</span>:                                         <span class="keyword">continue</span>;</div><div class="line"> <span class="number">82</span>:                                     &#125; <span class="keyword">else</span> &#123; <span class="comment">// å‘é€å¤±è´¥</span></div><div class="line"> <span class="number">83</span>:                                         <span class="comment">// <span class="doctag">XXX:</span> warn and notify me</span></div><div class="line"> <span class="number">84</span>:                                         log.error(<span class="string">"ScheduleMessageService, a message time up, but reput it failed, topic: &#123;&#125; msgId &#123;&#125;"</span>, msgExt.getTopic(), msgExt.getMsgId());</div><div class="line"> <span class="number">85</span>: </div><div class="line"> <span class="number">86</span>:                                         <span class="comment">// å®‰æ’ä¸‹ä¸€æ¬¡ä»»åŠ¡</span></div><div class="line"> <span class="number">87</span>:                                         ScheduleMessageService.<span class="keyword">this</span>.timer.schedule(<span class="keyword">new</span> DeliverDelayedMessageTimerTask(<span class="keyword">this</span>.delayLevel, nextOffset), DELAY_FOR_A_PERIOD);</div><div class="line"> <span class="number">88</span>: </div><div class="line"> <span class="number">89</span>:                                         <span class="comment">// æ›´æ–°è¿›åº¦</span></div><div class="line"> <span class="number">90</span>:                                         ScheduleMessageService.<span class="keyword">this</span>.updateOffset(<span class="keyword">this</span>.delayLevel, nextOffset);</div><div class="line"> <span class="number">91</span>:                                         <span class="keyword">return</span>;</div><div class="line"> <span class="number">92</span>:                                     &#125;</div><div class="line"> <span class="number">93</span>:                                 &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">94</span>:                                     <span class="comment">// <span class="doctag">XXX:</span> warn and notify me</span></div><div class="line"> <span class="number">95</span>:                                     log.error(<span class="string">"ScheduleMessageService, messageTimeup execute error, drop it. msgExt="</span></div><div class="line"> <span class="number">96</span>:                                             + msgExt + <span class="string">", nextOffset="</span> + nextOffset + <span class="string">",offsetPy="</span> + offsetPy + <span class="string">",sizePy="</span> + sizePy, e);</div><div class="line"> <span class="number">97</span>:                                 &#125;</div><div class="line"> <span class="number">98</span>:                             &#125;</div><div class="line"> <span class="number">99</span>:                         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">100</span>:                             <span class="comment">// å®‰æ’ä¸‹ä¸€æ¬¡ä»»åŠ¡</span></div><div class="line"><span class="number">101</span>:                             ScheduleMessageService.<span class="keyword">this</span>.timer.schedule(<span class="keyword">new</span> DeliverDelayedMessageTimerTask(<span class="keyword">this</span>.delayLevel, nextOffset), countdown);</div><div class="line"><span class="number">102</span>: </div><div class="line"><span class="number">103</span>:                             <span class="comment">// æ›´æ–°è¿›åº¦</span></div><div class="line"><span class="number">104</span>:                             ScheduleMessageService.<span class="keyword">this</span>.updateOffset(<span class="keyword">this</span>.delayLevel, nextOffset);</div><div class="line"><span class="number">105</span>:                             <span class="keyword">return</span>;</div><div class="line"><span class="number">106</span>:                         &#125;</div><div class="line"><span class="number">107</span>:                     &#125; <span class="comment">// end of for</span></div><div class="line"><span class="number">108</span>: </div><div class="line"><span class="number">109</span>:                     nextOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);</div><div class="line"><span class="number">110</span>: </div><div class="line"><span class="number">111</span>:                     <span class="comment">// å®‰æ’ä¸‹ä¸€æ¬¡ä»»åŠ¡</span></div><div class="line"><span class="number">112</span>:                     ScheduleMessageService.<span class="keyword">this</span>.timer.schedule(<span class="keyword">new</span> DeliverDelayedMessageTimerTask(<span class="keyword">this</span>.delayLevel, nextOffset), DELAY_FOR_A_WHILE);</div><div class="line"><span class="number">113</span>: </div><div class="line"><span class="number">114</span>:                     <span class="comment">// æ›´æ–°è¿›åº¦</span></div><div class="line"><span class="number">115</span>:                     ScheduleMessageService.<span class="keyword">this</span>.updateOffset(<span class="keyword">this</span>.delayLevel, nextOffset);</div><div class="line"><span class="number">116</span>:                     <span class="keyword">return</span>;</div><div class="line"><span class="number">117</span>:                 &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">118</span>:                     bufferCQ.release();</div><div class="line"><span class="number">119</span>:                 &#125;</div><div class="line"><span class="number">120</span>:             &#125; <span class="comment">// end of if (bufferCQ != null)</span></div><div class="line"><span class="number">121</span>:             <span class="keyword">else</span> &#123; <span class="comment">// æ¶ˆè´¹é˜Ÿåˆ—å·²ç»è¢«åˆ é™¤éƒ¨åˆ†ï¼Œè·³è½¬åˆ°æœ€å°çš„æ¶ˆè´¹è¿›åº¦</span></div><div class="line"><span class="number">122</span>:                 <span class="keyword">long</span> cqMinOffset = cq.getMinOffsetInQueue();</div><div class="line"><span class="number">123</span>:                 <span class="keyword">if</span> (offset &lt; cqMinOffset) &#123;</div><div class="line"><span class="number">124</span>:                     failScheduleOffset = cqMinOffset;</div><div class="line"><span class="number">125</span>:                     log.error(<span class="string">"schedule CQ offset invalid. offset="</span> + offset + <span class="string">", cqMinOffset="</span></div><div class="line"><span class="number">126</span>:                         + cqMinOffset + <span class="string">", queueId="</span> + cq.getQueueId());</div><div class="line"><span class="number">127</span>:                 &#125;</div><div class="line"><span class="number">128</span>:             &#125;</div><div class="line"><span class="number">129</span>:         &#125; <span class="comment">// end of if (cq != null)</span></div><div class="line"><span class="number">130</span>: </div><div class="line"><span class="number">131</span>:         ScheduleMessageService.<span class="keyword">this</span>.timer.schedule(<span class="keyword">new</span> DeliverDelayedMessageTimerTask(<span class="keyword">this</span>.delayLevel, failScheduleOffset), DELAY_FOR_A_WHILE);</div><div class="line"><span class="number">132</span>:     &#125;</div><div class="line"><span class="number">133</span>: </div><div class="line"><span class="number">134</span>:     <span class="comment">/**</span></div><div class="line">135:      * è®¾ç½®æ¶ˆæ¯å†…å®¹</div><div class="line">136:      *</div><div class="line">137:      * <span class="doctag">@param</span> msgExt æ¶ˆæ¯</div><div class="line">138:      * <span class="doctag">@return</span> æ¶ˆæ¯</div><div class="line">139:      */</div><div class="line"><span class="number">140</span>:     <span class="function"><span class="keyword">private</span> MessageExtBrokerInner <span class="title">messageTimeup</span><span class="params">(MessageExt msgExt)</span> </span>&#123;</div><div class="line"><span class="number">141</span>:         MessageExtBrokerInner msgInner = <span class="keyword">new</span> MessageExtBrokerInner();</div><div class="line"><span class="number">142</span>:         msgInner.setBody(msgExt.getBody());</div><div class="line"><span class="number">143</span>:         msgInner.setFlag(msgExt.getFlag());</div><div class="line"><span class="number">144</span>:         MessageAccessor.setProperties(msgInner, msgExt.getProperties());</div><div class="line"><span class="number">145</span>: </div><div class="line"><span class="number">146</span>:         TopicFilterType topicFilterType = MessageExt.parseTopicFilterType(msgInner.getSysFlag());</div><div class="line"><span class="number">147</span>:         <span class="keyword">long</span> tagsCodeValue =</div><div class="line"><span class="number">148</span>:             MessageExtBrokerInner.tagsString2tagsCode(topicFilterType, msgInner.getTags());</div><div class="line"><span class="number">149</span>:         msgInner.setTagsCode(tagsCodeValue);</div><div class="line"><span class="number">150</span>:         msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgExt.getProperties()));</div><div class="line"><span class="number">151</span>: </div><div class="line"><span class="number">152</span>:         msgInner.setSysFlag(msgExt.getSysFlag());</div><div class="line"><span class="number">153</span>:         msgInner.setBornTimestamp(msgExt.getBornTimestamp());</div><div class="line"><span class="number">154</span>:         msgInner.setBornHost(msgExt.getBornHost());</div><div class="line"><span class="number">155</span>:         msgInner.setStoreHost(msgExt.getStoreHost());</div><div class="line"><span class="number">156</span>:         msgInner.setReconsumeTimes(msgExt.getReconsumeTimes());</div><div class="line"><span class="number">157</span>: </div><div class="line"><span class="number">158</span>:         msgInner.setWaitStoreMsgOK(<span class="keyword">false</span>);</div><div class="line"><span class="number">159</span>:         MessageAccessor.clearProperty(msgInner, MessageConst.PROPERTY_DELAY_TIME_LEVEL);</div><div class="line"><span class="number">160</span>: </div><div class="line"><span class="number">161</span>:         msgInner.setTopic(msgInner.getProperty(MessageConst.PROPERTY_REAL_TOPIC));</div><div class="line"><span class="number">162</span>: </div><div class="line"><span class="number">163</span>:         String queueIdStr = msgInner.getProperty(MessageConst.PROPERTY_REAL_QUEUE_ID);</div><div class="line"><span class="number">164</span>:         <span class="keyword">int</span> queueId = Integer.parseInt(queueIdStr);</div><div class="line"><span class="number">165</span>:         msgInner.setQueueId(queueId);</div><div class="line"><span class="number">166</span>: </div><div class="line"><span class="number">167</span>:         <span class="keyword">return</span> msgInner;</div><div class="line"><span class="number">168</span>:     &#125;</div><div class="line"><span class="number">169</span>: &#125;</div></pre></td></tr></table></figure></p>
<h2>2.5 Broker æŒä¹…åŒ–å®šæ—¶å‘é€è¿›åº¦</h2>
<ul>
<li>ğŸ¦… å®šæ—¶æ¶ˆæ¯å‘é€è¿›åº¦å­˜å‚¨åœ¨æ–‡ä»¶(<code>../config/delayOffset.json</code>)é‡Œ</li>
<li>ğŸ¦… æ¯ 10s å®šæ—¶æŒä¹…åŒ–å‘é€è¿›åº¦ã€‚</li>
</ul>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="comment">/**</span></div><div class="line"> 3: public void start() &#123;</div><div class="line"> 4:     // å®šæ—¶å‘é€æ¶ˆæ¯</div><div class="line"> 5:     for (Map.Entry&lt;Integer, Long&gt; entry : this.delayLevelTable.entrySet()) &#123;</div><div class="line"> 6:         Integer level = entry.getKey();</div><div class="line"> 7:         Long timeDelay = entry.getValue();</div><div class="line"> 8:         Long offset = this.offsetTable.get(level);</div><div class="line"> 9:         if (null == offset) &#123;</div><div class="line">10:             offset = 0L;</div><div class="line">11:         &#125;</div><div class="line">12: </div><div class="line">13:         if (timeDelay != null) &#123;</div><div class="line">14:             this.timer.schedule(new DeliverDelayedMessageTimerTask(level, offset), FIRST_DELAY_TIME);</div><div class="line">15:         &#125;</div><div class="line">16:     &#125;</div><div class="line">17: </div><div class="line">18:     // å®šæ—¶æŒä¹…åŒ–å‘é€è¿›åº¦</div><div class="line">19:     this.timer.scheduleAtFixedRate(new TimerTask() &#123;</div><div class="line">20: </div><div class="line">21:         <span class="doctag">@Override</span></div><div class="line">22:         public void run() &#123;</div><div class="line">23:             try &#123;</div><div class="line">24:                 ScheduleMessageService.this.persist();</div><div class="line">25:             &#125; catch (Exception e) &#123;</div><div class="line">26:                 log.error("scheduleAtFixedRate flush exception", e);</div><div class="line">27:             &#125;</div><div class="line">28:         &#125;</div><div class="line">29:     &#125;, 10000, this.defaultMessageStore.getMessageStoreConfig().getFlushDelayOffsetInterval());</div><div class="line">30: &#125;</div></pre></td></tr></table></figure></p>
<h1>3. æ¶ˆæ¯é‡è¯•</h1>
<blockquote>
<p>Consumer æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥åï¼Œè¦æä¾›ä¸€ç§é‡è¯•æœºåˆ¶ï¼Œä»¤æ¶ˆæ¯å†æ¶ˆè´¹ä¸€æ¬¡ã€‚</p>
</blockquote>
<ul>
<li>ğŸ¦… <code>Consumer</code> å°†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯å‘å› <code>Broker</code>ï¼Œè¿›å…¥<strong>å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—</strong>ã€‚å³ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ï¼Œä¸ä¼šç«‹å³æ¶ˆè´¹ã€‚</li>
</ul>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€SendMessageProcessor.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="comment">/**</span></div><div class="line"> 3:  * æ¶ˆè´¹è€…å‘å›æ¶ˆæ¯</div><div class="line"> 4:  *</div><div class="line"> 5:  * <span class="doctag">@param</span> ctx ctx</div><div class="line"> 6:  * <span class="doctag">@param</span> request è¯·æ±‚</div><div class="line"> 7:  * <span class="doctag">@return</span> å“åº”</div><div class="line"> 8:  * <span class="doctag">@throws</span> RemotingCommandException å½“è¿œç¨‹è°ƒç”¨å¼‚å¸¸</div><div class="line"> 9:  */</div><div class="line"><span class="number">10</span>: <span class="function"><span class="keyword">private</span> RemotingCommand <span class="title">consumerSendMsgBack</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx, <span class="keyword">final</span> RemotingCommand request)</span></span></div><div class="line">11:     <span class="keyword">throws</span> RemotingCommandException &#123;</div><div class="line"><span class="number">12</span>:     <span class="comment">// ....(çœç•¥ä»£ç )</span></div><div class="line"><span class="number">13</span>:     <span class="comment">// å¤„ç† delayLevelï¼ˆç‹¬æœ‰ï¼‰ã€‚</span></div><div class="line"><span class="number">14</span>:     <span class="keyword">int</span> delayLevel = requestHeader.getDelayLevel();</div><div class="line"><span class="number">15</span>:     <span class="keyword">int</span> maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();</div><div class="line"><span class="number">16</span>:     <span class="keyword">if</span> (request.getVersion() &gt;= MQVersion.Version.V3_4_9.ordinal()) &#123;</div><div class="line"><span class="number">17</span>:         maxReconsumeTimes = requestHeader.getMaxReconsumeTimes();</div><div class="line"><span class="number">18</span>:     &#125;</div><div class="line"><span class="number">19</span>:     <span class="keyword">if</span> (msgExt.getReconsumeTimes() &gt;= maxReconsumeTimes<span class="comment">//</span></div><div class="line"><span class="number">20</span>:     <span class="comment">// ....(çœç•¥ä»£ç )</span></div><div class="line"><span class="number">21</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">22</span>:         <span class="keyword">if</span> (<span class="number">0</span> == delayLevel) &#123;</div><div class="line"><span class="number">23</span>:             delayLevel = <span class="number">3</span> + msgExt.getReconsumeTimes();</div><div class="line"><span class="number">24</span>:         &#125;</div><div class="line"><span class="number">25</span>:         msgExt.setDelayTimeLevel(delayLevel);</div><div class="line"><span class="number">26</span>:     &#125;</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>:     <span class="comment">// ....(çœç•¥ä»£ç )</span></div><div class="line"><span class="number">29</span>:     <span class="keyword">return</span> response;</div><div class="line"><span class="number">30</span>: &#125;</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rock
    
    </summary>
    
      <category term="RocketMQ" scheme="http://www.yunai.me/categories/RocketMQ/"/>
    
    
  </entry>
  
  <entry>
    <title>RocketMQ æºç åˆ†æ â€”â€” é«˜å¯ç”¨</title>
    <link href="http://www.yunai.me/RocketMQ/high-availability/"/>
    <id>http://www.yunai.me/RocketMQ/high-availability/</id>
    <published>2017-05-13T16:00:00.000Z</published>
    <updated>2017-07-27T16:57:05.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. Namesrv é«˜å¯ç”¨</a>
<ul>
<li><a href="#">2.1 Broker æ³¨å†Œåˆ° Namesrv</a></li>
<li><a href="#">2.2 Producerã€Consumer è®¿é—® Namesrv</a></li>
</ul>
</li>
<li><a href="#">3. Broker é«˜å¯ç”¨</a>
<ul>
<li><a href="#">3.2 Broker ä¸»ä»</a>
<ul>
<li><a href="#">3.1.1 é…ç½®</a></li>
<li><a href="#">3.1.2 ç»„ä»¶</a></li>
<li><a href="#">3.1.3 é€šä¿¡åè®®</a></li>
<li><a href="#">3.1.4 Slave</a></li>
<li><a href="#">3.1.5 Master</a></li>
<li><a href="#">3.1.6 Master_SYNC</a></li>
</ul>
</li>
<li><a href="#">3.2 Producer å‘é€æ¶ˆæ¯</a></li>
<li><a href="#">3.3 Consumer æ¶ˆè´¹æ¶ˆæ¯</a></li>
</ul>
</li>
<li><a href="#">4. æ€»ç»“</a></li>
</ul>
<h1>1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡ä¸»è¦è§£æ <code>Namesrv</code>ã€<code>Broker</code> å¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Œ<code>Producer</code>ã€<code>Consumer</code> æ€ä¹ˆä¸å®ƒä»¬é€šä¿¡ä¿è¯é«˜å¯ç”¨ã€‚</p>
<h1>2. Namesrv é«˜å¯ç”¨</h1>
<p><strong>å¯åŠ¨å¤šä¸ª <code>Namesrv</code> å®ç°é«˜å¯ç”¨ã€‚</strong><br>
ç›¸è¾ƒäº <code>Zookeeper</code>ã€<code>Consul</code>ã€<code>Etcd</code> ç­‰ï¼Œ<code>Namesrv</code> æ˜¯ä¸€ä¸ª<strong>è¶…è½»é‡çº§</strong>çš„æ³¨å†Œä¸­å¿ƒï¼Œæä¾›<strong>å‘½åæœåŠ¡</strong>ã€‚</p>
<h2>2.1 Broker æ³¨å†Œåˆ° Namesrv</h2>
<ul>
<li>ğŸ“Œ <strong>å¤šä¸ª <code>Namesrv</code> ä¹‹é—´ï¼Œæ²¡æœ‰ä»»ä½•å…³ç³»ï¼ˆä¸å­˜åœ¨ç±»ä¼¼ <code>Zookeeper</code> çš„ <code>Leader</code>/<code>Follower</code> ç­‰è§’è‰²ï¼‰ï¼Œä¸è¿›è¡Œé€šä¿¡ä¸æ•°æ®åŒæ­¥ã€‚é€šè¿‡ <code>Broker</code> å¾ªç¯æ³¨å†Œå¤šä¸ª <code>Namesrv</code>ã€‚</strong></li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€BrokerOuterAPI.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> RegisterBrokerResult <span class="title">registerBrokerAll</span><span class="params">(</span></span></div><div class="line"> <span class="number">3</span>:     <span class="keyword">final</span> String clusterName,</div><div class="line"> <span class="number">4</span>:     <span class="keyword">final</span> String brokerAddr,</div><div class="line"> <span class="number">5</span>:     <span class="keyword">final</span> String brokerName,</div><div class="line"> <span class="number">6</span>:     <span class="keyword">final</span> <span class="keyword">long</span> brokerId,</div><div class="line"> <span class="number">7</span>:     <span class="keyword">final</span> String haServerAddr,</div><div class="line"> <span class="number">8</span>:     <span class="keyword">final</span> TopicConfigSerializeWrapper topicConfigWrapper,</div><div class="line"> <span class="number">9</span>:     <span class="keyword">final</span> List&lt;String&gt; filterServerList,</div><div class="line"><span class="number">10</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> oneway,</div><div class="line"><span class="number">11</span>:     <span class="keyword">final</span> <span class="keyword">int</span> timeoutMills) &#123;</div><div class="line"><span class="number">12</span>:     RegisterBrokerResult registerBrokerResult = <span class="keyword">null</span>;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>:     List&lt;String&gt; nameServerAddressList = <span class="keyword">this</span>.remotingClient.getNameServerAddressList();</div><div class="line"><span class="number">15</span>:     <span class="keyword">if</span> (nameServerAddressList != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">16</span>:         <span class="keyword">for</span> (String namesrvAddr : nameServerAddressList) &#123; <span class="comment">// å¾ªç¯å¤šä¸ª Namesrv</span></div><div class="line"><span class="number">17</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">18</span>:                 RegisterBrokerResult result = <span class="keyword">this</span>.registerBroker(namesrvAddr, clusterName, brokerAddr, brokerName, brokerId,</div><div class="line"><span class="number">19</span>:                     haServerAddr, topicConfigWrapper, filterServerList, oneway, timeoutMills);</div><div class="line"><span class="number">20</span>:                 <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">21</span>:                     registerBrokerResult = result;</div><div class="line"><span class="number">22</span>:                 &#125;</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:                 log.info(<span class="string">"register broker to name server &#123;&#125; OK"</span>, namesrvAddr);</div><div class="line"><span class="number">25</span>:             &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">26</span>:                 log.warn(<span class="string">"registerBroker Exception, &#123;&#125;"</span>, namesrvAddr, e);</div><div class="line"><span class="number">27</span>:             &#125;</div><div class="line"><span class="number">28</span>:         &#125;</div><div class="line"><span class="number">29</span>:     &#125;</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:     <span class="keyword">return</span> registerBrokerResult;</div><div class="line"><span class="number">32</span>: &#125;</div></pre></td></tr></table></figure></p>
<h2>2.2 Producerã€Consumer è®¿é—® Namesrv</h2>
<ul>
<li>ğŸ“Œ <strong><code>Producer</code>ã€<code>Consumer</code> ä» <code>Namesrv</code>åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªå¯è¿æ¥çš„è¿›è¡Œé€šä¿¡ã€‚</strong></li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€NettyRemotingClient.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">private</span> Channel <span class="title">getAndCreateNameserverChannel</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// è¿”å›å·²é€‰æ‹©ã€å¯è¿æ¥Namesrv</span></div><div class="line"> <span class="number">4</span>:     String addr = <span class="keyword">this</span>.namesrvAddrChoosed.get();</div><div class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (addr != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">6</span>:         ChannelWrapper cw = <span class="keyword">this</span>.channelTables.get(addr);</div><div class="line"> <span class="number">7</span>:         <span class="keyword">if</span> (cw != <span class="keyword">null</span> &amp;&amp; cw.isOK()) &#123;</div><div class="line"> <span class="number">8</span>:             <span class="keyword">return</span> cw.getChannel();</div><div class="line"> <span class="number">9</span>:         &#125;</div><div class="line"><span class="number">10</span>:     &#125;</div><div class="line"><span class="number">11</span>:     <span class="comment">//</span></div><div class="line"><span class="number">12</span>:     <span class="keyword">final</span> List&lt;String&gt; addrList = <span class="keyword">this</span>.namesrvAddrList.get();</div><div class="line"><span class="number">13</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.lockNamesrvChannel.tryLock(LOCK_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS)) &#123;</div><div class="line"><span class="number">14</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">15</span>:             <span class="comment">// è¿”å›å·²é€‰æ‹©ã€å¯è¿æ¥çš„Namesrv</span></div><div class="line"><span class="number">16</span>:             addr = <span class="keyword">this</span>.namesrvAddrChoosed.get();</div><div class="line"><span class="number">17</span>:             <span class="keyword">if</span> (addr != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">18</span>:                 ChannelWrapper cw = <span class="keyword">this</span>.channelTables.get(addr);</div><div class="line"><span class="number">19</span>:                 <span class="keyword">if</span> (cw != <span class="keyword">null</span> &amp;&amp; cw.isOK()) &#123;</div><div class="line"><span class="number">20</span>:                     <span class="keyword">return</span> cw.getChannel();</div><div class="line"><span class="number">21</span>:                 &#125;</div><div class="line"><span class="number">22</span>:             &#125;</div><div class="line"><span class="number">23</span>:             <span class="comment">// ä»ã€Namesrvåˆ—è¡¨ã€‘ä¸­é€‰æ‹©ä¸€ä¸ªè¿æ¥çš„è¿”å›</span></div><div class="line"><span class="number">24</span>:             <span class="keyword">if</span> (addrList != <span class="keyword">null</span> &amp;&amp; !addrList.isEmpty()) &#123;</div><div class="line"><span class="number">25</span>:                 <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; addrList.size(); i++) &#123;</div><div class="line"><span class="number">26</span>:                     <span class="keyword">int</span> index = <span class="keyword">this</span>.namesrvIndex.incrementAndGet();</div><div class="line"><span class="number">27</span>:                     index = Math.abs(index);</div><div class="line"><span class="number">28</span>:                     index = index % addrList.size();</div><div class="line"><span class="number">29</span>:                     String newAddr = addrList.get(index);</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:                     <span class="keyword">this</span>.namesrvAddrChoosed.set(newAddr);</div><div class="line"><span class="number">32</span>:                     Channel channelNew = <span class="keyword">this</span>.createChannel(newAddr);</div><div class="line"><span class="number">33</span>:                     <span class="keyword">if</span> (channelNew != <span class="keyword">null</span>)</div><div class="line"><span class="number">34</span>:                         <span class="keyword">return</span> channelNew;</div><div class="line"><span class="number">35</span>:                 &#125;</div><div class="line"><span class="number">36</span>:             &#125;</div><div class="line"><span class="number">37</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">38</span>:             log.error(<span class="string">"getAndCreateNameserverChannel: create name server channel exception"</span>, e);</div><div class="line"><span class="number">39</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">40</span>:             <span class="keyword">this</span>.lockNamesrvChannel.unlock();</div><div class="line"><span class="number">41</span>:         &#125;</div><div class="line"><span class="number">42</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">43</span>:         log.warn(<span class="string">"getAndCreateNameserverChannel: try to lock name server, but timeout, &#123;&#125;ms"</span>, LOCK_TIMEOUT_MILLIS);</div><div class="line"><span class="number">44</span>:     &#125;</div><div class="line"><span class="number">45</span>: </div><div class="line"><span class="number">46</span>:     <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">47</span>: &#125;</div></pre></td></tr></table></figure></p>
<h1>3. Broker é«˜å¯ç”¨</h1>
<p><strong>å¯åŠ¨å¤šä¸ª <code>Brokeråˆ†ç»„</code> å½¢æˆ <code>é›†ç¾¤</code> å®ç°é«˜å¯ç”¨ã€‚</strong><br>
<strong><code>Brokeråˆ†ç»„</code> = <code>MasterèŠ‚ç‚¹</code>x1 + <code>SlaveèŠ‚ç‚¹</code>xNã€‚</strong><br>
ç±»ä¼¼ <code>MySQL</code>ï¼Œ<code>MasterèŠ‚ç‚¹</code> æä¾›<strong>è¯»å†™</strong>æœåŠ¡ï¼Œ<code>SlaveèŠ‚ç‚¹</code> åªæä¾›<strong>è¯»</strong>æœåŠ¡ã€‚</p>
<h2>3.2 Broker ä¸»ä»</h2>
<ul>
<li><strong>æ¯ä¸ªåˆ†ç»„ï¼Œ<code>Master</code>èŠ‚ç‚¹ ä¸æ–­å‘é€æ–°çš„ <code>CommitLog</code> ç»™ <code>Slave</code>èŠ‚ç‚¹ã€‚ <code>Slave</code>èŠ‚ç‚¹ ä¸æ–­ä¸ŠæŠ¥æœ¬åœ°çš„ <code>CommitLog</code> å·²ç»åŒæ­¥åˆ°çš„ä½ç½®ç»™ <code>Master</code>èŠ‚ç‚¹ã€‚</strong></li>
<li><strong><code>Brokeråˆ†ç»„</code> ä¸ <code>Brokeråˆ†ç»„</code> ä¹‹é—´æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œä¸è¿›è¡Œé€šä¿¡ä¸æ•°æ®åŒæ­¥ã€‚</strong></li>
<li><strong>æ¶ˆè´¹è¿›åº¦ ç›®å‰ä¸æ”¯æŒ <code>Master</code>/<code>Slave</code> åŒæ­¥ã€‚</strong></li>
</ul>
<p>é›†ç¾¤å†…ï¼Œ<code>Master</code>èŠ‚ç‚¹ æœ‰<strong>ä¸¤ç§</strong>ç±»å‹ï¼š<code>Master_SYNC</code>ã€<code>Master_ASYNC</code>ï¼šå‰è€…åœ¨ <code>Producer</code> å‘é€æ¶ˆæ¯æ—¶ï¼Œç­‰å¾… <code>Slave</code>èŠ‚ç‚¹ å­˜å‚¨å®Œæ¯•åå†è¿”å›å‘é€ç»“æœï¼Œè€Œåè€…ä¸éœ€è¦ç­‰å¾…ã€‚</p>
<h3>3.1.1 é…ç½®</h3>
<p>ç›®å‰å®˜æ–¹æä¾›ä¸‰å¥—é…ç½®ï¼š</p>
<ul>
<li><strong>2m-2s-async</strong></li>
</ul>
<table>
<thead>
<tr>
<th>brokerClusterName</th>
<th>brokerName</th>
<th>brokerRole</th>
<th>brokerId</th>
</tr>
</thead>
<tbody>
<tr>
<td>DefaultCluster</td>
<td>broker-a</td>
<td>ASYNC_MASTER</td>
<td>0</td>
</tr>
<tr>
<td>DefaultCluster</td>
<td>broker-a</td>
<td>SLAVE</td>
<td>1</td>
</tr>
<tr>
<td>DefaultCluster</td>
<td>broker-b</td>
<td>ASYNC_MASTER</td>
<td>0</td>
</tr>
<tr>
<td>DefaultCluster</td>
<td>broker-b</td>
<td>SLAVE</td>
<td>1</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>2m-2s-sync</strong></li>
</ul>
<table>
<thead>
<tr>
<th>brokerClusterName</th>
<th>brokerName</th>
<th>brokerRole</th>
<th>brokerId</th>
</tr>
</thead>
<tbody>
<tr>
<td>DefaultCluster</td>
<td>broker-a</td>
<td>SYNC_MASTER</td>
<td>0</td>
</tr>
<tr>
<td>DefaultCluster</td>
<td>broker-a</td>
<td>SLAVE</td>
<td>1</td>
</tr>
<tr>
<td>DefaultCluster</td>
<td>broker-b</td>
<td>SYNC_MASTER</td>
<td>0</td>
</tr>
<tr>
<td>DefaultCluster</td>
<td>broker-b</td>
<td>SLAVE</td>
<td>1</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>2m-noslave</strong></li>
</ul>
<table>
<thead>
<tr>
<th>brokerClusterName</th>
<th>brokerName</th>
<th>brokerRole</th>
<th>brokerId</th>
</tr>
</thead>
<tbody>
<tr>
<td>DefaultCluster</td>
<td>broker-a</td>
<td>ASYNC_MASTER</td>
<td>0</td>
</tr>
<tr>
<td>DefaultCluster</td>
<td>broker-b</td>
<td>ASYNC_MASTER</td>
<td>0</td>
</tr>
</tbody>
</table>
<h3>3.1.2 ç»„ä»¶</h3>
<p>å†çœ‹å…·ä½“å®ç°ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ <code>Master</code>/<code>Slave</code>èŠ‚ç‚¹ åŒ…å«çš„ç»„ä»¶ï¼š<br>
<img src="http://www.yunai.me/images/RocketMQ/2017_05_14/04.png" alt="HAç»„ä»¶å›¾.png"></p>
<ul>
<li><code>Master</code>èŠ‚ç‚¹
<ul>
<li><code>AcceptSocketService</code> ï¼šæ¥æ”¶ <code>Slave</code>èŠ‚ç‚¹ è¿æ¥ã€‚</li>
<li><code>HAConnection</code>
<ul>
<li><code>ReadSocketService</code> ï¼š<strong>è¯»</strong>æ¥è‡ª <code>Slave</code>èŠ‚ç‚¹ çš„æ•°æ®ã€‚</li>
<li><code>WriteSocketService</code> ï¼š<strong>å†™</strong>åˆ°å¾€ <code>Slave</code>èŠ‚ç‚¹ çš„æ•°æ®ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><code>Slave</code>èŠ‚ç‚¹
<ul>
<li><code>HAClient</code> ï¼šå¯¹ <code>Master</code>èŠ‚ç‚¹ è¿æ¥ã€è¯»å†™æ•°æ®ã€‚</li>
</ul>
</li>
</ul>
<h3>3.1.3 é€šä¿¡åè®®</h3>
<p><code>Master</code>èŠ‚ç‚¹ ä¸ <code>Slave</code>èŠ‚ç‚¹ <strong>é€šä¿¡åè®®</strong>å¾ˆç®€å•ï¼Œåªæœ‰å¦‚ä¸‹ä¸¤æ¡ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">å¯¹è±¡</th>
<th style="text-align:left">ç”¨é€”</th>
<th style="text-align:left">ç¬¬å‡ ä½</th>
<th style="text-align:left">å­—æ®µ</th>
<th style="text-align:left">æ•°æ®ç±»å‹</th>
<th style="text-align:left">å­—èŠ‚æ•°</th>
<th style="text-align:left">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Slave=&gt;Master</td>
<td style="text-align:left">ä¸ŠæŠ¥CommitLog<strong>å·²ç»</strong>åŒæ­¥åˆ°çš„<strong>ç‰©ç†</strong>ä½ç½®</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">0</td>
<td style="text-align:left">maxPhyOffset</td>
<td style="text-align:left">Long</td>
<td style="text-align:left">8</td>
<td style="text-align:left">CommitLogæœ€å¤§ç‰©ç†ä½ç½®</td>
</tr>
<tr>
<td style="text-align:left">Master=&gt;Slave</td>
<td style="text-align:left">ä¼ è¾“æ–°çš„ <code>CommitLog</code> æ•°æ®</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">0</td>
<td style="text-align:left">fromPhyOffset</td>
<td style="text-align:left">Long</td>
<td style="text-align:left">8</td>
<td style="text-align:left">CommitLogå¼€å§‹ç‰©ç†ä½ç½®</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">1</td>
<td style="text-align:left">size</td>
<td style="text-align:left">Int</td>
<td style="text-align:left">4</td>
<td style="text-align:left">ä¼ è¾“CommitLogæ•°æ®é•¿åº¦</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">2</td>
<td style="text-align:left">body</td>
<td style="text-align:left">Bytes</td>
<td style="text-align:left">size</td>
<td style="text-align:left">ä¼ è¾“CommitLogæ•°æ®</td>
</tr>
</tbody>
</table>
<h3>3.1.4 Slave</h3>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_14/02.png" alt="HAClienté¡ºåºå›¾"></p>
<hr>
<ul>
<li><strong><code>Slave</code> ä¸»å¾ªç¯ï¼Œå®ç°äº†</strong>ä¸æ–­ä¸æ–­ä¸æ–­<strong>ä» <code>Master</code> ä¼ è¾“ <code>CommitLog</code> æ•°æ®ï¼Œä¸Šä¼  <code>Master</code> è‡ªå·±æœ¬åœ°çš„ <code>CommitLog</code> å·²ç»åŒæ­¥ç‰©ç†ä½ç½®ã€‚</strong></li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€HAClient.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service started"</span>);</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</div><div class="line"> <span class="number">6</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">7</span>:             <span class="keyword">if</span> (<span class="keyword">this</span>.connectMaster()) &#123;</div><div class="line"> <span class="number">8</span>:                 <span class="comment">// è‹¥åˆ°æ»¡è¶³ä¸ŠæŠ¥é—´éš”ï¼Œä¸ŠæŠ¥åˆ°Masterè¿›åº¦</span></div><div class="line"> <span class="number">9</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.isTimeToReportOffset()) &#123;</div><div class="line"><span class="number">10</span>:                     <span class="keyword">boolean</span> result = <span class="keyword">this</span>.reportSlaveMaxOffset(<span class="keyword">this</span>.currentReportedOffset);</div><div class="line"><span class="number">11</span>:                     <span class="keyword">if</span> (!result) &#123;</div><div class="line"><span class="number">12</span>:                         <span class="keyword">this</span>.closeMaster();</div><div class="line"><span class="number">13</span>:                     &#125;</div><div class="line"><span class="number">14</span>:                 &#125;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>:                 <span class="keyword">this</span>.selector.select(<span class="number">1000</span>);</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:                 <span class="comment">// å¤„ç†è¯»å–äº‹ä»¶</span></div><div class="line"><span class="number">19</span>:                 <span class="keyword">boolean</span> ok = <span class="keyword">this</span>.processReadEvent();</div><div class="line"><span class="number">20</span>:                 <span class="keyword">if</span> (!ok) &#123;</div><div class="line"><span class="number">21</span>:                     <span class="keyword">this</span>.closeMaster();</div><div class="line"><span class="number">22</span>:                 &#125;</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:                 <span class="comment">// è‹¥è¿›åº¦æœ‰å˜åŒ–ï¼Œä¸ŠæŠ¥åˆ°Masterè¿›åº¦</span></div><div class="line"><span class="number">25</span>:                 <span class="keyword">if</span> (!reportSlaveMaxOffsetPlus()) &#123;</div><div class="line"><span class="number">26</span>:                     <span class="keyword">continue</span>;</div><div class="line"><span class="number">27</span>:                 &#125;</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>:                 <span class="comment">// Masterè¿‡ä¹…æœªè¿”å›æ•°æ®ï¼Œå…³é—­è¿æ¥</span></div><div class="line"><span class="number">30</span>:                 <span class="keyword">long</span> interval = HAService.<span class="keyword">this</span>.getDefaultMessageStore().getSystemClock().now() - <span class="keyword">this</span>.lastWriteTimestamp;</div><div class="line"><span class="number">31</span>:                 <span class="keyword">if</span> (interval &gt; HAService.<span class="keyword">this</span>.getDefaultMessageStore().getMessageStoreConfig()</div><div class="line"><span class="number">32</span>:                     .getHaHousekeepingInterval()) &#123;</div><div class="line"><span class="number">33</span>:                     log.warn(<span class="string">"HAClient, housekeeping, found this connection["</span> + <span class="keyword">this</span>.masterAddress</div><div class="line"><span class="number">34</span>:                         + <span class="string">"] expired, "</span> + interval);</div><div class="line"><span class="number">35</span>:                     <span class="keyword">this</span>.closeMaster();</div><div class="line"><span class="number">36</span>:                     log.warn(<span class="string">"HAClient, master not response some time, so close connection"</span>);</div><div class="line"><span class="number">37</span>:                 &#125;</div><div class="line"><span class="number">38</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">39</span>:                 <span class="keyword">this</span>.waitForRunning(<span class="number">1000</span> * <span class="number">5</span>);</div><div class="line"><span class="number">40</span>:             &#125;</div><div class="line"><span class="number">41</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">42</span>:             log.warn(<span class="keyword">this</span>.getServiceName() + <span class="string">" service has exception. "</span>, e);</div><div class="line"><span class="number">43</span>:             <span class="keyword">this</span>.waitForRunning(<span class="number">1000</span> * <span class="number">5</span>);</div><div class="line"><span class="number">44</span>:         &#125;</div><div class="line"><span class="number">45</span>:     &#125;</div><div class="line"><span class="number">46</span>: </div><div class="line"><span class="number">47</span>:     log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service end"</span>);</div><div class="line"><span class="number">48</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬ 8 è‡³ 14 è¡Œ ï¼š<strong>å›ºå®šé—´éš”ï¼ˆé»˜è®¤5sï¼‰<strong>å‘ <code>Master</code> ä¸ŠæŠ¥ <code>Slave</code> æœ¬åœ° <code>CommitLog</code> å·²ç»åŒæ­¥åˆ°çš„ç‰©ç†ä½ç½®ã€‚è¯¥æ“ä½œè¿˜æœ‰</strong>å¿ƒè·³</strong>çš„ä½œç”¨ã€‚</li>
<li>ç¬¬ 16 è‡³ 22 è¡Œ ï¼šå¤„ç† <code>Master</code> ä¼ è¾“ <code>Slave</code> çš„ <code>CommitLog</code> æ•°æ®ã€‚</li>
</ul>
<hr>
<ul>
<li><strong>æˆ‘ä»¬æ¥çœ‹çœ‹ <code>#dispatchReadRequest(...)</code> ä¸ <code>#reportSlaveMaxOffset(...)</code> æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</strong></li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// ã€HAClient.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="comment">/**</span></div><div class="line"> 3:  * è¯»å–Masterä¼ è¾“çš„CommitLogæ•°æ®ï¼Œå¹¶è¿”å›æ˜¯å¼‚å¸¸</div><div class="line"> 4:  * å¦‚æœè¯»å–åˆ°æ•°æ®ï¼Œå†™å…¥CommitLog</div><div class="line"> 5:  * å¼‚å¸¸åŸå› ï¼š</div><div class="line"> 6:  *   1. Masterä¼ è¾“æ¥çš„æ•°æ®offset ä¸ç­‰äº Slaveçš„CommitLogæ•°æ®æœ€å¤§offset</div><div class="line"> 7:  *   2. ä¸ŠæŠ¥åˆ°Masterè¿›åº¦å¤±è´¥</div><div class="line"> 8:  *</div><div class="line"> 9:  * <span class="doctag">@return</span> æ˜¯å¦å¼‚å¸¸</div><div class="line">10:  */</div><div class="line"><span class="number">11</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">dispatchReadRequest</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">12</span>:     <span class="keyword">final</span> <span class="keyword">int</span> msgHeaderSize = <span class="number">8</span> + <span class="number">4</span>; <span class="comment">// phyoffset + size</span></div><div class="line"><span class="number">13</span>:     <span class="keyword">int</span> readSocketPos = <span class="keyword">this</span>.byteBufferRead.position();</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:     <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line"><span class="number">16</span>:         <span class="comment">// è¯»å–åˆ°è¯·æ±‚</span></div><div class="line"><span class="number">17</span>:         <span class="keyword">int</span> diff = <span class="keyword">this</span>.byteBufferRead.position() - <span class="keyword">this</span>.dispatchPostion;</div><div class="line"><span class="number">18</span>:         <span class="keyword">if</span> (diff &gt;= msgHeaderSize) &#123;</div><div class="line"><span class="number">19</span>:             <span class="comment">// è¯»å–masterPhyOffsetã€bodySizeã€‚ä½¿ç”¨dispatchPostionçš„åŸå› æ˜¯ï¼šå¤„ç†æ•°æ®â€œç²˜åŒ…â€å¯¼è‡´æ•°æ®è¯»å–ä¸å®Œæ•´ã€‚</span></div><div class="line"><span class="number">20</span>:             <span class="keyword">long</span> masterPhyOffset = <span class="keyword">this</span>.byteBufferRead.getLong(<span class="keyword">this</span>.dispatchPostion);</div><div class="line"><span class="number">21</span>:             <span class="keyword">int</span> bodySize = <span class="keyword">this</span>.byteBufferRead.getInt(<span class="keyword">this</span>.dispatchPostion + <span class="number">8</span>);</div><div class="line"><span class="number">22</span>:             <span class="comment">// æ ¡éªŒ Masterä¼ è¾“æ¥çš„æ•°æ®offset æ˜¯å¦å’Œ Slaveçš„CommitLogæ•°æ®æœ€å¤§offset æ˜¯å¦ç›¸åŒã€‚</span></div><div class="line"><span class="number">23</span>:             <span class="keyword">long</span> slavePhyOffset = HAService.<span class="keyword">this</span>.defaultMessageStore.getMaxPhyOffset();</div><div class="line"><span class="number">24</span>:             <span class="keyword">if</span> (slavePhyOffset != <span class="number">0</span>) &#123;</div><div class="line"><span class="number">25</span>:                 <span class="keyword">if</span> (slavePhyOffset != masterPhyOffset) &#123;</div><div class="line"><span class="number">26</span>:                     log.error(<span class="string">"master pushed offset not equal the max phy offset in slave, SLAVE: "</span></div><div class="line"><span class="number">27</span>:                         + slavePhyOffset + <span class="string">" MASTER: "</span> + masterPhyOffset);</div><div class="line"><span class="number">28</span>:                     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">29</span>:                 &#125;</div><div class="line"><span class="number">30</span>:             &#125;</div><div class="line"><span class="number">31</span>:             <span class="comment">// è¯»å–åˆ°æ¶ˆæ¯</span></div><div class="line"><span class="number">32</span>:             <span class="keyword">if</span> (diff &gt;= (msgHeaderSize + bodySize)) &#123;</div><div class="line"><span class="number">33</span>:                 <span class="comment">// å†™å…¥CommitLog</span></div><div class="line"><span class="number">34</span>:                 <span class="keyword">byte</span>[] bodyData = <span class="keyword">new</span> <span class="keyword">byte</span>[bodySize];</div><div class="line"><span class="number">35</span>:                 <span class="keyword">this</span>.byteBufferRead.position(<span class="keyword">this</span>.dispatchPostion + msgHeaderSize);</div><div class="line"><span class="number">36</span>:                 <span class="keyword">this</span>.byteBufferRead.get(bodyData);</div><div class="line"><span class="number">37</span>:                 HAService.<span class="keyword">this</span>.defaultMessageStore.appendToCommitLog(masterPhyOffset, bodyData);</div><div class="line"><span class="number">38</span>:                 <span class="comment">// è®¾ç½®å¤„ç†åˆ°çš„ä½ç½®</span></div><div class="line"><span class="number">39</span>:                 <span class="keyword">this</span>.byteBufferRead.position(readSocketPos);</div><div class="line"><span class="number">40</span>:                 <span class="keyword">this</span>.dispatchPostion += msgHeaderSize + bodySize;</div><div class="line"><span class="number">41</span>:                 <span class="comment">// ä¸ŠæŠ¥åˆ°Masterè¿›åº¦</span></div><div class="line"><span class="number">42</span>:                 <span class="keyword">if</span> (!reportSlaveMaxOffsetPlus()) &#123;</div><div class="line"><span class="number">43</span>:                     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">44</span>:                 &#125;</div><div class="line"><span class="number">45</span>:                 <span class="comment">// ç»§ç»­å¾ªç¯</span></div><div class="line"><span class="number">46</span>:                 <span class="keyword">continue</span>;</div><div class="line"><span class="number">47</span>:             &#125;</div><div class="line"><span class="number">48</span>:         &#125;</div><div class="line"><span class="number">49</span>: </div><div class="line"><span class="number">50</span>:         <span class="comment">// ç©ºé—´å†™æ»¡ï¼Œé‡æ–°åˆ†é…ç©ºé—´</span></div><div class="line"><span class="number">51</span>:         <span class="keyword">if</span> (!<span class="keyword">this</span>.byteBufferRead.hasRemaining()) &#123;</div><div class="line"><span class="number">52</span>:             <span class="keyword">this</span>.reallocateByteBuffer();</div><div class="line"><span class="number">53</span>:         &#125;</div><div class="line"><span class="number">54</span>: </div><div class="line"><span class="number">55</span>:         <span class="keyword">break</span>;</div><div class="line"><span class="number">56</span>:     &#125;</div><div class="line"><span class="number">57</span>: </div><div class="line"><span class="number">58</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">59</span>: &#125;</div><div class="line"><span class="number">60</span>: </div><div class="line"><span class="number">61</span>: <span class="comment">/**</span></div><div class="line">62:  * ä¸ŠæŠ¥è¿›åº¦</div><div class="line">63:  *</div><div class="line">64:  * <span class="doctag">@param</span> maxOffset è¿›åº¦</div><div class="line">65:  * <span class="doctag">@return</span> æ˜¯å¦ä¸ŠæŠ¥æˆåŠŸ</div><div class="line">66:  */</div><div class="line"><span class="number">67</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">reportSlaveMaxOffset</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> maxOffset)</span> </span>&#123;</div><div class="line"><span class="number">68</span>:     <span class="keyword">this</span>.reportOffset.position(<span class="number">0</span>);</div><div class="line"><span class="number">69</span>:     <span class="keyword">this</span>.reportOffset.limit(<span class="number">8</span>);</div><div class="line"><span class="number">70</span>:     <span class="keyword">this</span>.reportOffset.putLong(maxOffset);</div><div class="line"><span class="number">71</span>:     <span class="keyword">this</span>.reportOffset.position(<span class="number">0</span>);</div><div class="line"><span class="number">72</span>:     <span class="keyword">this</span>.reportOffset.limit(<span class="number">8</span>);</div><div class="line"><span class="number">73</span>: </div><div class="line"><span class="number">74</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span> &amp;&amp; <span class="keyword">this</span>.reportOffset.hasRemaining(); i++) &#123;</div><div class="line"><span class="number">75</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">76</span>:             <span class="keyword">this</span>.socketChannel.write(<span class="keyword">this</span>.reportOffset);</div><div class="line"><span class="number">77</span>:         &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line"><span class="number">78</span>:             log.error(<span class="keyword">this</span>.getServiceName()</div><div class="line"><span class="number">79</span>:                 + <span class="string">"reportSlaveMaxOffset this.socketChannel.write exception"</span>, e);</div><div class="line"><span class="number">80</span>:             <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">81</span>:         &#125;</div><div class="line"><span class="number">82</span>:     &#125;</div><div class="line"><span class="number">83</span>: </div><div class="line"><span class="number">84</span>:     <span class="keyword">return</span> !<span class="keyword">this</span>.reportOffset.hasRemaining();</div><div class="line"><span class="number">85</span>: &#125;</div></pre></td></tr></table></figure></p>
<h3>3.1.5 Master</h3>
<ul>
<li><strong><code>ReadSocketService</code> é€»è¾‘åŒ <code>HAClient#processReadEvent(...)</code> åŸºæœ¬ç›¸åŒï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ä»£ç ã€‚</strong></li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ReadSocketService.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">processReadEvent</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">int</span> readSizeZeroTimes = <span class="number">0</span>;</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     <span class="comment">// æ¸…ç©ºbyteBufferRead</span></div><div class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (!<span class="keyword">this</span>.byteBufferRead.hasRemaining()) &#123;</div><div class="line"> <span class="number">7</span>:         <span class="keyword">this</span>.byteBufferRead.flip();</div><div class="line"> <span class="number">8</span>:         <span class="keyword">this</span>.processPostion = <span class="number">0</span>;</div><div class="line"> <span class="number">9</span>:     &#125;</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>:     <span class="keyword">while</span> (<span class="keyword">this</span>.byteBufferRead.hasRemaining()) &#123;</div><div class="line"><span class="number">12</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">13</span>:             <span class="keyword">int</span> readSize = <span class="keyword">this</span>.socketChannel.read(<span class="keyword">this</span>.byteBufferRead);</div><div class="line"><span class="number">14</span>:             <span class="keyword">if</span> (readSize &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">15</span>:                 readSizeZeroTimes = <span class="number">0</span>;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:                 <span class="comment">// è®¾ç½®æœ€åè¯»å–æ—¶é—´</span></div><div class="line"><span class="number">18</span>:                 <span class="keyword">this</span>.lastReadTimestamp = HAConnection.<span class="keyword">this</span>.haService.getDefaultMessageStore().getSystemClock().now();</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>:                 <span class="keyword">if</span> ((<span class="keyword">this</span>.byteBufferRead.position() - <span class="keyword">this</span>.processPostion) &gt;= <span class="number">8</span>) &#123;</div><div class="line"><span class="number">21</span>:                     <span class="comment">// è¯»å–Slave è¯·æ±‚æ¥çš„CommitLogçš„æœ€å¤§ä½ç½®</span></div><div class="line"><span class="number">22</span>:                     <span class="keyword">int</span> pos = <span class="keyword">this</span>.byteBufferRead.position() - (<span class="keyword">this</span>.byteBufferRead.position() % <span class="number">8</span>);</div><div class="line"><span class="number">23</span>:                     <span class="keyword">long</span> readOffset = <span class="keyword">this</span>.byteBufferRead.getLong(pos - <span class="number">8</span>);</div><div class="line"><span class="number">24</span>:                     <span class="keyword">this</span>.processPostion = pos;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:                     <span class="comment">// è®¾ç½®Slave CommitLogçš„æœ€å¤§ä½ç½®</span></div><div class="line"><span class="number">27</span>:                     HAConnection.<span class="keyword">this</span>.slaveAckOffset = readOffset;</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>:                     <span class="comment">// è®¾ç½®Slave ç¬¬ä¸€æ¬¡è¯·æ±‚çš„ä½ç½®</span></div><div class="line"><span class="number">30</span>:                     <span class="keyword">if</span> (HAConnection.<span class="keyword">this</span>.slaveRequestOffset &lt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">31</span>:                         HAConnection.<span class="keyword">this</span>.slaveRequestOffset = readOffset;</div><div class="line"><span class="number">32</span>:                         log.info(<span class="string">"slave["</span> + HAConnection.<span class="keyword">this</span>.clientAddr + <span class="string">"] request offset "</span> + readOffset);</div><div class="line"><span class="number">33</span>:                     &#125;</div><div class="line"><span class="number">34</span>: </div><div class="line"><span class="number">35</span>:                     <span class="comment">// é€šçŸ¥ç›®å‰Slaveè¿›åº¦ã€‚ä¸»è¦ç”¨äºMasterèŠ‚ç‚¹ä¸ºåŒæ­¥ç±»å‹çš„ã€‚</span></div><div class="line"><span class="number">36</span>:                     HAConnection.<span class="keyword">this</span>.haService.notifyTransferSome(HAConnection.<span class="keyword">this</span>.slaveAckOffset);</div><div class="line"><span class="number">37</span>:                 &#125;</div><div class="line"><span class="number">38</span>:             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (readSize == <span class="number">0</span>) &#123;</div><div class="line"><span class="number">39</span>:                 <span class="keyword">if</span> (++readSizeZeroTimes &gt;= <span class="number">3</span>) &#123;</div><div class="line"><span class="number">40</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">41</span>:                 &#125;</div><div class="line"><span class="number">42</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">43</span>:                 log.error(<span class="string">"read socket["</span> + HAConnection.<span class="keyword">this</span>.clientAddr + <span class="string">"] &lt; 0"</span>);</div><div class="line"><span class="number">44</span>:                 <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">45</span>:             &#125;</div><div class="line"><span class="number">46</span>:         &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line"><span class="number">47</span>:             log.error(<span class="string">"processReadEvent exception"</span>, e);</div><div class="line"><span class="number">48</span>:             <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">49</span>:         &#125;</div><div class="line"><span class="number">50</span>:     &#125;</div><div class="line"><span class="number">51</span>: </div><div class="line"><span class="number">52</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">53</span>: &#125;</div></pre></td></tr></table></figure></p>
<hr>
<ul>
<li><strong><code>WriteSocketService</code> è®¡ç®— <code>Slave</code>å¼€å§‹åŒæ­¥çš„ä½ç½®åï¼Œä¸æ–­å‘ <code>Slave</code> ä¼ è¾“æ–°çš„ <code>CommitLog</code>æ•°æ®ã€‚</strong></li>
</ul>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_14/01.png" alt="HA.WriteSocketServiceæµç¨‹å›¾"></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€WriteSocketService.javaã€‘</span></div><div class="line">  <span class="number">2</span>: <span class="meta">@Override</span></div><div class="line">  <span class="number">3</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="number">4</span>:     HAConnection.log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service started"</span>);</div><div class="line">  <span class="number">5</span>: </div><div class="line">  <span class="number">6</span>:     <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</div><div class="line">  <span class="number">7</span>:         <span class="keyword">try</span> &#123;</div><div class="line">  <span class="number">8</span>:             <span class="keyword">this</span>.selector.select(<span class="number">1000</span>);</div><div class="line">  <span class="number">9</span>: </div><div class="line"> <span class="number">10</span>:             <span class="comment">// æœªè·å¾—Slaveè¯»å–è¿›åº¦è¯·æ±‚ï¼Œsleepç­‰å¾…ã€‚</span></div><div class="line"> <span class="number">11</span>:             <span class="keyword">if</span> (-<span class="number">1</span> == HAConnection.<span class="keyword">this</span>.slaveRequestOffset) &#123;</div><div class="line"> <span class="number">12</span>:                 Thread.sleep(<span class="number">10</span>);</div><div class="line"> <span class="number">13</span>:                 <span class="keyword">continue</span>;</div><div class="line"> <span class="number">14</span>:             &#125;</div><div class="line"> <span class="number">15</span>: </div><div class="line"> <span class="number">16</span>:             <span class="comment">// è®¡ç®—åˆå§‹åŒ–nextTransferFromWhere</span></div><div class="line"> <span class="number">17</span>:             <span class="keyword">if</span> (-<span class="number">1</span> == <span class="keyword">this</span>.nextTransferFromWhere) &#123;</div><div class="line"> <span class="number">18</span>:                 <span class="keyword">if</span> (<span class="number">0</span> == HAConnection.<span class="keyword">this</span>.slaveRequestOffset) &#123;</div><div class="line"> <span class="number">19</span>:                     <span class="keyword">long</span> masterOffset = HAConnection.<span class="keyword">this</span>.haService.getDefaultMessageStore().getCommitLog().getMaxOffset();</div><div class="line"> <span class="number">20</span>:                     masterOffset = masterOffset - (masterOffset % HAConnection.<span class="keyword">this</span>.haService.getDefaultMessageStore().getMessageStoreConfig().getMapedFileSizeCommitLog());</div><div class="line"> <span class="number">21</span>:                     <span class="keyword">if</span> (masterOffset &lt; <span class="number">0</span>) &#123;</div><div class="line"> <span class="number">22</span>:                         masterOffset = <span class="number">0</span>;</div><div class="line"> <span class="number">23</span>:                     &#125;</div><div class="line"> <span class="number">24</span>: </div><div class="line"> <span class="number">25</span>:                     <span class="keyword">this</span>.nextTransferFromWhere = masterOffset;</div><div class="line"> <span class="number">26</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">27</span>:                     <span class="keyword">this</span>.nextTransferFromWhere = HAConnection.<span class="keyword">this</span>.slaveRequestOffset;</div><div class="line"> <span class="number">28</span>:                 &#125;</div><div class="line"> <span class="number">29</span>: </div><div class="line"> <span class="number">30</span>:                 log.info(<span class="string">"master transfer data from "</span> + <span class="keyword">this</span>.nextTransferFromWhere + <span class="string">" to slave["</span> + HAConnection.<span class="keyword">this</span>.clientAddr</div><div class="line"> <span class="number">31</span>:                     + <span class="string">"], and slave request "</span> + HAConnection.<span class="keyword">this</span>.slaveRequestOffset);</div><div class="line"> <span class="number">32</span>:             &#125;</div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:             <span class="keyword">if</span> (<span class="keyword">this</span>.lastWriteOver) &#123;</div><div class="line"> <span class="number">35</span>:                 <span class="keyword">long</span> interval = HAConnection.<span class="keyword">this</span>.haService.getDefaultMessageStore().getSystemClock().now() - <span class="keyword">this</span>.lastWriteTimestamp;</div><div class="line"> <span class="number">36</span>:                 <span class="keyword">if</span> (interval &gt; HAConnection.<span class="keyword">this</span>.haService.getDefaultMessageStore().getMessageStoreConfig().getHaSendHeartbeatInterval()) &#123; <span class="comment">// å¿ƒè·³</span></div><div class="line"> <span class="number">37</span>: </div><div class="line"> <span class="number">38</span>:                     <span class="comment">// Build Header</span></div><div class="line"> <span class="number">39</span>:                     <span class="keyword">this</span>.byteBufferHeader.position(<span class="number">0</span>);</div><div class="line"> <span class="number">40</span>:                     <span class="keyword">this</span>.byteBufferHeader.limit(headerSize);</div><div class="line"> <span class="number">41</span>:                     <span class="keyword">this</span>.byteBufferHeader.putLong(<span class="keyword">this</span>.nextTransferFromWhere);</div><div class="line"> <span class="number">42</span>:                     <span class="keyword">this</span>.byteBufferHeader.putInt(<span class="number">0</span>);</div><div class="line"> <span class="number">43</span>:                     <span class="keyword">this</span>.byteBufferHeader.flip();</div><div class="line"> <span class="number">44</span>: </div><div class="line"> <span class="number">45</span>:                     <span class="keyword">this</span>.lastWriteOver = <span class="keyword">this</span>.transferData();</div><div class="line"> <span class="number">46</span>:                     <span class="keyword">if</span> (!<span class="keyword">this</span>.lastWriteOver)</div><div class="line"> <span class="number">47</span>:                         <span class="keyword">continue</span>;</div><div class="line"> <span class="number">48</span>:                 &#125;</div><div class="line"> <span class="number">49</span>:             &#125; <span class="keyword">else</span> &#123; <span class="comment">// æœªä¼ è¾“å®Œæˆï¼Œç»§ç»­ä¼ è¾“</span></div><div class="line"> <span class="number">50</span>:                 <span class="keyword">this</span>.lastWriteOver = <span class="keyword">this</span>.transferData();</div><div class="line"> <span class="number">51</span>:                 <span class="keyword">if</span> (!<span class="keyword">this</span>.lastWriteOver)</div><div class="line"> <span class="number">52</span>:                     <span class="keyword">continue</span>;</div><div class="line"> <span class="number">53</span>:             &#125;</div><div class="line"> <span class="number">54</span>: </div><div class="line"> <span class="number">55</span>:             <span class="comment">// é€‰æ‹©æ–°çš„CommitLogæ•°æ®è¿›è¡Œä¼ è¾“</span></div><div class="line"> <span class="number">56</span>:             SelectMappedBufferResult selectResult =</div><div class="line"> <span class="number">57</span>:                 HAConnection.<span class="keyword">this</span>.haService.getDefaultMessageStore().getCommitLogData(<span class="keyword">this</span>.nextTransferFromWhere);</div><div class="line"> <span class="number">58</span>:             <span class="keyword">if</span> (selectResult != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">59</span>:                 <span class="keyword">int</span> size = selectResult.getSize();</div><div class="line"> <span class="number">60</span>:                 <span class="keyword">if</span> (size &gt; HAConnection.<span class="keyword">this</span>.haService.getDefaultMessageStore().getMessageStoreConfig().getHaTransferBatchSize()) &#123;</div><div class="line"> <span class="number">61</span>:                     size = HAConnection.<span class="keyword">this</span>.haService.getDefaultMessageStore().getMessageStoreConfig().getHaTransferBatchSize();</div><div class="line"> <span class="number">62</span>:                 &#125;</div><div class="line"> <span class="number">63</span>: </div><div class="line"> <span class="number">64</span>:                 <span class="keyword">long</span> thisOffset = <span class="keyword">this</span>.nextTransferFromWhere;</div><div class="line"> <span class="number">65</span>:                 <span class="keyword">this</span>.nextTransferFromWhere += size;</div><div class="line"> <span class="number">66</span>: </div><div class="line"> <span class="number">67</span>:                 selectResult.getByteBuffer().limit(size);</div><div class="line"> <span class="number">68</span>:                 <span class="keyword">this</span>.selectMappedBufferResult = selectResult;</div><div class="line"> <span class="number">69</span>: </div><div class="line"> <span class="number">70</span>:                 <span class="comment">// Build Header</span></div><div class="line"> <span class="number">71</span>:                 <span class="keyword">this</span>.byteBufferHeader.position(<span class="number">0</span>);</div><div class="line"> <span class="number">72</span>:                 <span class="keyword">this</span>.byteBufferHeader.limit(headerSize);</div><div class="line"> <span class="number">73</span>:                 <span class="keyword">this</span>.byteBufferHeader.putLong(thisOffset);</div><div class="line"> <span class="number">74</span>:                 <span class="keyword">this</span>.byteBufferHeader.putInt(size);</div><div class="line"> <span class="number">75</span>:                 <span class="keyword">this</span>.byteBufferHeader.flip();</div><div class="line"> <span class="number">76</span>: </div><div class="line"> <span class="number">77</span>:                 <span class="keyword">this</span>.lastWriteOver = <span class="keyword">this</span>.transferData();</div><div class="line"> <span class="number">78</span>:             &#125; <span class="keyword">else</span> &#123; <span class="comment">// æ²¡æ–°çš„æ¶ˆæ¯ï¼ŒæŒ‚èµ·ç­‰å¾…</span></div><div class="line"> <span class="number">79</span>:                 HAConnection.<span class="keyword">this</span>.haService.getWaitNotifyObject().allWaitForRunning(<span class="number">100</span>);</div><div class="line"> <span class="number">80</span>:             &#125;</div><div class="line"> <span class="number">81</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">82</span>: </div><div class="line"> <span class="number">83</span>:             HAConnection.log.error(<span class="keyword">this</span>.getServiceName() + <span class="string">" service has exception."</span>, e);</div><div class="line"> <span class="number">84</span>:             <span class="keyword">break</span>;</div><div class="line"> <span class="number">85</span>:         &#125;</div><div class="line"> <span class="number">86</span>:     &#125;</div><div class="line"> <span class="number">87</span>: </div><div class="line"> <span class="number">88</span>:     <span class="comment">// æ–­å¼€è¿æ¥ &amp; æš‚åœå†™çº¿ç¨‹ &amp; æš‚åœè¯»çº¿ç¨‹ &amp; é‡Šæ”¾CommitLog</span></div><div class="line"> <span class="number">89</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.selectMappedBufferResult != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">90</span>:         <span class="keyword">this</span>.selectMappedBufferResult.release();</div><div class="line"> <span class="number">91</span>:     &#125;</div><div class="line"> <span class="number">92</span>: </div><div class="line"> <span class="number">93</span>:     <span class="keyword">this</span>.makeStop();</div><div class="line"> <span class="number">94</span>: </div><div class="line"> <span class="number">95</span>:     readSocketService.makeStop();</div><div class="line"> <span class="number">96</span>: </div><div class="line"> <span class="number">97</span>:     haService.removeConnection(HAConnection.<span class="keyword">this</span>);</div><div class="line"> <span class="number">98</span>: </div><div class="line"> <span class="number">99</span>:     SelectionKey sk = <span class="keyword">this</span>.socketChannel.keyFor(<span class="keyword">this</span>.selector);</div><div class="line"><span class="number">100</span>:     <span class="keyword">if</span> (sk != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">101</span>:         sk.cancel();</div><div class="line"><span class="number">102</span>:     &#125;</div><div class="line"><span class="number">103</span>: </div><div class="line"><span class="number">104</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">105</span>:         <span class="keyword">this</span>.selector.close();</div><div class="line"><span class="number">106</span>:         <span class="keyword">this</span>.socketChannel.close();</div><div class="line"><span class="number">107</span>:     &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line"><span class="number">108</span>:         HAConnection.log.error(<span class="string">""</span>, e);</div><div class="line"><span class="number">109</span>:     &#125;</div><div class="line"><span class="number">110</span>: </div><div class="line"><span class="number">111</span>:     HAConnection.log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service end"</span>);</div><div class="line"><span class="number">112</span>: &#125;</div><div class="line"><span class="number">113</span>: </div><div class="line"><span class="number">114</span>: <span class="comment">/**</span></div><div class="line">115:  * ä¼ è¾“æ•°æ®</div><div class="line">116:  */</div><div class="line"><span class="number">117</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">transferData</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"><span class="number">118</span>:     <span class="keyword">int</span> writeSizeZeroTimes = <span class="number">0</span>;</div><div class="line"><span class="number">119</span>:     <span class="comment">// Write Header</span></div><div class="line"><span class="number">120</span>:     <span class="keyword">while</span> (<span class="keyword">this</span>.byteBufferHeader.hasRemaining()) &#123;</div><div class="line"><span class="number">121</span>:         <span class="keyword">int</span> writeSize = <span class="keyword">this</span>.socketChannel.write(<span class="keyword">this</span>.byteBufferHeader);</div><div class="line"><span class="number">122</span>:         <span class="keyword">if</span> (writeSize &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">123</span>:             writeSizeZeroTimes = <span class="number">0</span>;</div><div class="line"><span class="number">124</span>:             <span class="keyword">this</span>.lastWriteTimestamp = HAConnection.<span class="keyword">this</span>.haService.getDefaultMessageStore().getSystemClock().now();</div><div class="line"><span class="number">125</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (writeSize == <span class="number">0</span>) &#123;</div><div class="line"><span class="number">126</span>:             <span class="keyword">if</span> (++writeSizeZeroTimes &gt;= <span class="number">3</span>) &#123;</div><div class="line"><span class="number">127</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">128</span>:             &#125;</div><div class="line"><span class="number">129</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">130</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"ha master write header error &lt; 0"</span>);</div><div class="line"><span class="number">131</span>:         &#125;</div><div class="line"><span class="number">132</span>:     &#125;</div><div class="line"><span class="number">133</span>: </div><div class="line"><span class="number">134</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == <span class="keyword">this</span>.selectMappedBufferResult) &#123;</div><div class="line"><span class="number">135</span>:         <span class="keyword">return</span> !<span class="keyword">this</span>.byteBufferHeader.hasRemaining();</div><div class="line"><span class="number">136</span>:     &#125;</div><div class="line"><span class="number">137</span>: </div><div class="line"><span class="number">138</span>:     writeSizeZeroTimes = <span class="number">0</span>;</div><div class="line"><span class="number">139</span>: </div><div class="line"><span class="number">140</span>:     <span class="comment">// Write Body</span></div><div class="line"><span class="number">141</span>:     <span class="keyword">if</span> (!<span class="keyword">this</span>.byteBufferHeader.hasRemaining()) &#123;</div><div class="line"><span class="number">142</span>:         <span class="keyword">while</span> (<span class="keyword">this</span>.selectMappedBufferResult.getByteBuffer().hasRemaining()) &#123;</div><div class="line"><span class="number">143</span>:             <span class="keyword">int</span> writeSize = <span class="keyword">this</span>.socketChannel.write(<span class="keyword">this</span>.selectMappedBufferResult.getByteBuffer());</div><div class="line"><span class="number">144</span>:             <span class="keyword">if</span> (writeSize &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">145</span>:                 writeSizeZeroTimes = <span class="number">0</span>;</div><div class="line"><span class="number">146</span>:                 <span class="keyword">this</span>.lastWriteTimestamp = HAConnection.<span class="keyword">this</span>.haService.getDefaultMessageStore().getSystemClock().now();</div><div class="line"><span class="number">147</span>:             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (writeSize == <span class="number">0</span>) &#123;</div><div class="line"><span class="number">148</span>:                 <span class="keyword">if</span> (++writeSizeZeroTimes &gt;= <span class="number">3</span>) &#123;</div><div class="line"><span class="number">149</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">150</span>:                 &#125;</div><div class="line"><span class="number">151</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">152</span>:                 <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"ha master write body error &lt; 0"</span>);</div><div class="line"><span class="number">153</span>:             &#125;</div><div class="line"><span class="number">154</span>:         &#125;</div><div class="line"><span class="number">155</span>:     &#125;</div><div class="line"><span class="number">156</span>: </div><div class="line"><span class="number">157</span>:     <span class="keyword">boolean</span> result = !<span class="keyword">this</span>.byteBufferHeader.hasRemaining() &amp;&amp; !<span class="keyword">this</span>.selectMappedBufferResult.getByteBuffer().hasRemaining();</div><div class="line"><span class="number">158</span>: </div><div class="line"><span class="number">159</span>:     <span class="keyword">if</span> (!<span class="keyword">this</span>.selectMappedBufferResult.getByteBuffer().hasRemaining()) &#123;</div><div class="line"><span class="number">160</span>:         <span class="keyword">this</span>.selectMappedBufferResult.release();</div><div class="line"><span class="number">161</span>:         <span class="keyword">this</span>.selectMappedBufferResult = <span class="keyword">null</span>;</div><div class="line"><span class="number">162</span>:     &#125;</div><div class="line"><span class="number">163</span>: </div><div class="line"><span class="number">164</span>:     <span class="keyword">return</span> result;</div><div class="line"><span class="number">165</span>: &#125;</div></pre></td></tr></table></figure></p>
<h3>3.1.6 Master_SYNC</h3>
<ul>
<li><strong><code>Producer</code> å‘é€æ¶ˆæ¯æ—¶ï¼Œ<code>Master_SYNC</code>èŠ‚ç‚¹ ä¼šç­‰å¾… <code>Slave</code>èŠ‚ç‚¹ å­˜å‚¨å®Œæ¯•åå†è¿”å›å‘é€ç»“æœã€‚</strong></li>
</ul>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€CommitLog.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> PutMessageResult <span class="title">putMessage</span><span class="params">(<span class="keyword">final</span> MessageExtBrokerInner msg)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// ....çœç•¥å¤„ç†å‘é€ä»£ç  </span></div><div class="line"> <span class="number">4</span>:     <span class="comment">// Synchronous write double å¦‚æœæ˜¯åŒæ­¥Masterï¼ŒåŒæ­¥åˆ°ä»èŠ‚ç‚¹</span></div><div class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (BrokerRole.SYNC_MASTER == <span class="keyword">this</span>.defaultMessageStore.getMessageStoreConfig().getBrokerRole()) &#123;</div><div class="line"> <span class="number">6</span>:         HAService service = <span class="keyword">this</span>.defaultMessageStore.getHaService();</div><div class="line"> <span class="number">7</span>:         <span class="keyword">if</span> (msg.isWaitStoreMsgOK()) &#123;</div><div class="line"> <span class="number">8</span>:             <span class="comment">// Determine whether to wait</span></div><div class="line"> <span class="number">9</span>:             <span class="keyword">if</span> (service.isSlaveOK(result.getWroteOffset() + result.getWroteBytes())) &#123;</div><div class="line"><span class="number">10</span>:                 <span class="keyword">if</span> (<span class="keyword">null</span> == request) &#123;</div><div class="line"><span class="number">11</span>:                     request = <span class="keyword">new</span> GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());</div><div class="line"><span class="number">12</span>:                 &#125;</div><div class="line"><span class="number">13</span>:                 service.putRequest(request);</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:                 <span class="comment">// å”¤é†’WriteSocketService</span></div><div class="line"><span class="number">16</span>:                 service.getWaitNotifyObject().wakeupAll();</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:                 <span class="keyword">boolean</span> flushOK = request.waitForFlush(<span class="keyword">this</span>.defaultMessageStore.getMessageStoreConfig().getSyncFlushTimeout());</div><div class="line"><span class="number">19</span>:                 <span class="keyword">if</span> (!flushOK) &#123;</div><div class="line"><span class="number">20</span>:                     log.error(<span class="string">"do sync transfer other node, wait return, but failed, topic: "</span> + msg.getTopic() + <span class="string">" tags: "</span></div><div class="line"><span class="number">21</span>:                         + msg.getTags() + <span class="string">" client address: "</span> + msg.getBornHostString());</div><div class="line"><span class="number">22</span>:                     putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_SLAVE_TIMEOUT);</div><div class="line"><span class="number">23</span>:                 &#125;</div><div class="line"><span class="number">24</span>:             &#125;</div><div class="line"><span class="number">25</span>:             <span class="comment">// Slave problem</span></div><div class="line"><span class="number">26</span>:             <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">27</span>:                 <span class="comment">// Tell the producer, slave not available</span></div><div class="line"><span class="number">28</span>:                 putMessageResult.setPutMessageStatus(PutMessageStatus.SLAVE_NOT_AVAILABLE);</div><div class="line"><span class="number">29</span>:             &#125;</div><div class="line"><span class="number">30</span>:         &#125;</div><div class="line"><span class="number">31</span>:     &#125;</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>:     <span class="keyword">return</span> putMessageResult;</div><div class="line"><span class="number">34</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬ 16 è¡Œ ï¼šå”¤é†’ <code>WriteSocketService</code>ã€‚
<ul>
<li>å”¤é†’åï¼Œ<code>WriteSocketService</code> æŒ‚èµ·ç­‰å¾…æ–°æ¶ˆæ¯ç»“æŸï¼Œ<code>Master</code> ä¼ è¾“ <code>Slave</code> æ–°çš„ <code>CommitLog</code> æ•°æ®ã€‚</li>
<li><code>Slave</code> æ”¶åˆ°æ•°æ®åï¼Œ<strong>ç«‹å³</strong>ä¸ŠæŠ¥æœ€æ–°çš„ <code>CommitLog</code> åŒæ­¥è¿›åº¦åˆ° <code>Master</code>ã€‚<code>ReadSocketService</code> å”¤é†’<strong>ç¬¬ 18 è¡Œ</strong>ï¼š<code>request#waitForFlush(...)</code>ã€‚</li>
</ul>
</li>
</ul>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>GroupTransferService</code> çš„æ ¸å¿ƒé€»è¾‘ä»£ç ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€GroupTransferService.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doWaitTransfer</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">synchronized</span> (<span class="keyword">this</span>.requestsRead) &#123;</div><div class="line"> <span class="number">4</span>:         <span class="keyword">if</span> (!<span class="keyword">this</span>.requestsRead.isEmpty()) &#123;</div><div class="line"> <span class="number">5</span>:             <span class="keyword">for</span> (CommitLog.GroupCommitRequest req : <span class="keyword">this</span>.requestsRead) &#123;</div><div class="line"> <span class="number">6</span>:                 <span class="comment">// ç­‰å¾…Slaveä¸Šä¼ è¿›åº¦</span></div><div class="line"> <span class="number">7</span>:                 <span class="keyword">boolean</span> transferOK = HAService.<span class="keyword">this</span>.push2SlaveMaxOffset.get() &gt;= req.getNextOffset();</div><div class="line"> <span class="number">8</span>:                 <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; !transferOK &amp;&amp; i &lt; <span class="number">5</span>; i++) &#123;</div><div class="line"> <span class="number">9</span>:                     <span class="keyword">this</span>.notifyTransferObject.waitForRunning(<span class="number">1000</span>); <span class="comment">// å”¤é†’</span></div><div class="line"><span class="number">10</span>:                     transferOK = HAService.<span class="keyword">this</span>.push2SlaveMaxOffset.get() &gt;= req.getNextOffset();</div><div class="line"><span class="number">11</span>:                 &#125;</div><div class="line"><span class="number">12</span>: </div><div class="line"><span class="number">13</span>:                 <span class="keyword">if</span> (!transferOK) &#123;</div><div class="line"><span class="number">14</span>:                     log.warn(<span class="string">"transfer messsage to slave timeout, "</span> + req.getNextOffset());</div><div class="line"><span class="number">15</span>:                 &#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:                 <span class="comment">// å”¤é†’è¯·æ±‚ï¼Œå¹¶è®¾ç½®æ˜¯å¦SlaveåŒæ­¥æˆåŠŸ</span></div><div class="line"><span class="number">18</span>:                 req.wakeupCustomer(transferOK);</div><div class="line"><span class="number">19</span>:             &#125;</div><div class="line"><span class="number">20</span>: </div><div class="line"><span class="number">21</span>:             <span class="keyword">this</span>.requestsRead.clear();</div><div class="line"><span class="number">22</span>:         &#125;</div><div class="line"><span class="number">23</span>:     &#125;</div><div class="line"><span class="number">24</span>: &#125;</div></pre></td></tr></table></figure></p>
<h2>3.2 Producer å‘é€æ¶ˆæ¯</h2>
<ul>
<li><strong><code>Producer</code> å‘é€æ¶ˆæ¯æ—¶ï¼Œä¼šå¯¹ <code>Broker</code>é›†ç¾¤ çš„æ‰€æœ‰é˜Ÿåˆ—è¿›è¡Œé€‰æ‹©ã€‚</strong></li>
</ul>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">private</span> SendResult <span class="title">sendDefaultImpl</span><span class="params">(//</span></span></div><div class="line"> <span class="number">3</span>:     Message msg, //</div><div class="line"> <span class="number">4</span>:     <span class="keyword">final</span> CommunicationMode communicationMode, //</div><div class="line"> <span class="number">5</span>:     <span class="keyword">final</span> SendCallback sendCallback, //</div><div class="line"> <span class="number">6</span>:     <span class="keyword">final</span> <span class="keyword">long</span> timeout//</div><div class="line"> <span class="number">7</span>: ) <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</div><div class="line"> <span class="number">8</span>:     <span class="comment">// .... çœç•¥ï¼šå¤„ç†ã€æ ¡éªŒé€»è¾‘ã€‘</span></div><div class="line"> <span class="number">9</span>:     <span class="comment">// è·å– Topicè·¯ç”±ä¿¡æ¯</span></div><div class="line"><span class="number">10</span>:     TopicPublishInfo topicPublishInfo = <span class="keyword">this</span>.tryToFindTopicPublishInfo(msg.getTopic());</div><div class="line"><span class="number">11</span>:     <span class="keyword">if</span> (topicPublishInfo != <span class="keyword">null</span> &amp;&amp; topicPublishInfo.ok()) &#123;</div><div class="line"><span class="number">12</span>:         MessageQueue mq = <span class="keyword">null</span>; <span class="comment">// æœ€åé€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—</span></div><div class="line"><span class="number">13</span>:         Exception exception = <span class="keyword">null</span>;</div><div class="line"><span class="number">14</span>:         SendResult sendResult = <span class="keyword">null</span>; <span class="comment">// æœ€åä¸€æ¬¡å‘é€ç»“æœ</span></div><div class="line"><span class="number">15</span>:         <span class="keyword">int</span> timesTotal = communicationMode == CommunicationMode.SYNC ? <span class="number">1</span> + <span class="keyword">this</span>.defaultMQProducer.getRetryTimesWhenSendFailed() : <span class="number">1</span>; <span class="comment">// åŒæ­¥å¤šæ¬¡è°ƒç”¨</span></div><div class="line"><span class="number">16</span>:         <span class="keyword">int</span> times = <span class="number">0</span>; <span class="comment">// ç¬¬å‡ æ¬¡å‘é€</span></div><div class="line"><span class="number">17</span>:         String[] brokersSent = <span class="keyword">new</span> String[timesTotal]; <span class="comment">// å­˜å‚¨æ¯æ¬¡å‘é€æ¶ˆæ¯é€‰æ‹©çš„brokerå</span></div><div class="line"><span class="number">18</span>:         <span class="comment">// å¾ªç¯è°ƒç”¨å‘é€æ¶ˆæ¯ï¼Œç›´åˆ°æˆåŠŸ</span></div><div class="line"><span class="number">19</span>:         <span class="keyword">for</span> (; times &lt; timesTotal; times++) &#123;</div><div class="line"><span class="number">20</span>:             String lastBrokerName = <span class="keyword">null</span> == mq ? <span class="keyword">null</span> : mq.getBrokerName();</div><div class="line"><span class="number">21</span>:             MessageQueue tmpmq = <span class="keyword">this</span>.selectOneMessageQueue(topicPublishInfo, lastBrokerName); <span class="comment">// é€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—</span></div><div class="line"><span class="number">22</span>:             <span class="keyword">if</span> (tmpmq != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">23</span>:                 mq = tmpmq;</div><div class="line"><span class="number">24</span>:                 brokersSent[times] = mq.getBrokerName();</div><div class="line"><span class="number">25</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">26</span>:                     beginTimestampPrev = System.currentTimeMillis();</div><div class="line"><span class="number">27</span>:                     <span class="comment">// è°ƒç”¨å‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•</span></div><div class="line"><span class="number">28</span>:                     sendResult = <span class="keyword">this</span>.sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout);</div><div class="line"><span class="number">29</span>:                     endTimestamp = System.currentTimeMillis();</div><div class="line"><span class="number">30</span>:                     <span class="comment">// æ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯</span></div><div class="line"><span class="number">31</span>:                     <span class="keyword">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class="keyword">false</span>);</div><div class="line"><span class="number">32</span>:                     <span class="comment">// .... çœç•¥ï¼šå¤„ç†ã€å‘é€è¿”å›ç»“æœã€‘</span></div><div class="line"><span class="number">33</span>:                     &#125;</div><div class="line"><span class="number">34</span>:                 &#125; <span class="keyword">catch</span> (e) &#123; <span class="comment">// .... çœç•¥ï¼šå¤„ç†ã€å¼‚å¸¸ã€‘</span></div><div class="line"><span class="number">35</span>:                     </div><div class="line"><span class="number">36</span>:                 &#125;</div><div class="line"><span class="number">37</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">38</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">39</span>:             &#125;</div><div class="line"><span class="number">40</span>:         &#125;</div><div class="line"><span class="number">41</span>:         <span class="comment">// .... çœç•¥ï¼šå¤„ç†ã€å‘é€è¿”å›ç»“æœã€‘</span></div><div class="line"><span class="number">42</span>:     &#125;</div><div class="line"><span class="number">43</span>:     <span class="comment">// .... çœç•¥ï¼šå¤„ç†ã€æ‰¾ä¸åˆ°æ¶ˆæ¯è·¯ç”±ã€‘</span></div><div class="line"><span class="number">44</span>: &#125;</div></pre></td></tr></table></figure></p>
<p>å¦‚ä¸‹æ˜¯è°ƒè¯• <code>#sendDefaultImpl(...)</code> æ—¶ <code>TopicPublishInfo</code> çš„ç»“æœï¼Œ<code>Producer</code> è·å¾—åˆ°äº† <code>broker-a</code>,<code>broker-b</code> ä¸¤ä¸ª <code>Broker</code>åˆ†ç»„ çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼š
<img src="http://www.yunai.me/images/RocketMQ/2017_05_14/05.png" alt="Producer.TopicPublishInfo.è°ƒè¯•.png"></p>
<h2>3.3 Consumer æ¶ˆè´¹æ¶ˆæ¯</h2>
<ul>
<li><strong><code>Consumer</code> æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œä¼šå¯¹ <code>Broker</code>é›†ç¾¤ çš„æ‰€æœ‰é˜Ÿåˆ—è¿›è¡Œé€‰æ‹©ã€‚</strong></li>
</ul>
<h1>4. æ€»ç»“</h1>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_14/03.jpeg" alt="HAæ€»ç»“.jpeg"></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rock
    
    </summary>
    
      <category term="RocketMQ" scheme="http://www.yunai.me/categories/RocketMQ/"/>
    
    
  </entry>
  
  <entry>
    <title>RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹</title>
    <link href="http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/"/>
    <id>http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/</id>
    <published>2017-05-12T16:00:00.000Z</published>
    <updated>2017-07-27T16:56:48.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. Producer é¡ºåºå‘é€</a></li>
<li><a href="#">3. Consumer é¡ºåºæ¶ˆè´¹</a>
<ul>
<li><a href="#">3.1 è·å¾—(é”å®š)æ¶ˆæ¯é˜Ÿåˆ—</a></li>
<li><a href="#">3.2 ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—</a></li>
<li><a href="#">3.3 æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—</a>
<ul>
<li><a href="#">3.1.1 æ¶ˆè´¹æ¶ˆæ¯</a></li>
<li><a href="#">3.1.2 å¤„ç†æ¶ˆè´¹ç»“æœ</a></li>
<li><a href="#">3.13 æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1>1. æ¦‚è¿°</h1>
<p><strong>å»ºè®®</strong>å‰ç½®é˜…è¯»å†…å®¹ï¼š</p>
<ul>
<li><a href="http://www.yunai.me/RocketMQ/message-send-and-receive/">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message å‘é€ä¸æ¥æ”¶ã€‹</a></li>
<li><a href="http://www.yunai.me/RocketMQ/message-pull-and-consume-second/">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸‹ï¼‰ã€‹</a></li>
</ul>
<p>å½“ç„¶å¯¹ <code>Message</code> å‘é€ä¸æ¶ˆè´¹å·²ç»æœ‰ä¸€å®šäº†è§£çš„åŒå­¦ï¼Œå¯ä»¥é€‰æ‹©è·³è¿‡ã€‚</p>
<hr>
<p><code>RocketMQ</code> æä¾›äº†ä¸¤ç§é¡ºåºçº§åˆ«ï¼š</p>
<ul>
<li>æ™®é€šé¡ºåºæ¶ˆæ¯ ï¼š<code>Producer</code> å°†ç›¸å…³è”çš„æ¶ˆæ¯å‘é€åˆ°ç›¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
<li>å®Œå…¨ä¸¥æ ¼é¡ºåº ï¼šåœ¨ <code>æ™®é€šé¡ºåºæ¶ˆæ¯</code> çš„åŸºç¡€ä¸Šï¼Œ<code>Consumer</code> ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚</li>
</ul>
<p>ç»å¤§éƒ¨åˆ†åœºæ™¯ä¸‹åªéœ€è¦ç”¨åˆ°<strong>æ™®é€šé¡ºåºæ¶ˆæ¯</strong>ã€‚<br>
ä¾‹å¦‚è¯´ï¼šç»™ç”¨æˆ·å‘é€çŸ­ä¿¡æ¶ˆæ¯ + å‘é€æ¨é€æ¶ˆæ¯ï¼Œå°†ä¸¤æ¡æ¶ˆæ¯å‘é€åˆ°ä¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè‹¥å…¶ä¸­ä¸€æ¡æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è¾ƒæ…¢é€ æˆå µå¡ï¼Œç”¨æˆ·å¯èƒ½ä¼šæ”¶åˆ°ä¸¤æ¡æ¶ˆæ¯ä¼šå­˜åœ¨ä¸€å®šçš„æ—¶é—´å·®ï¼Œå¸¦æ¥çš„ä½“éªŒä¼šç›¸å¯¹è¾ƒå·®ã€‚å½“ç„¶ç±»ä¼¼è¿™ç§åœºæ™¯ï¼Œå³ä½¿æœ‰ä¸€å®šçš„æ—¶é—´å·®ï¼Œ<strong>ä¸ä¼šäº§ç”Ÿç³»ç»Ÿé€»è¾‘ä¸ŠBUG</strong>ã€‚å¦å¤–ï¼Œ<code>æ™®é€šé¡ºåºæ¶ˆæ¯</code>æ€§èƒ½èƒ½æ›´åŠ å¥½ã€‚<br>
é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä½¿ç”¨ä½¿ç”¨<strong>å®Œå…¨ä¸¥æ ¼é¡ºåº</strong>ï¼Ÿå¦‚ä¸‹æ˜¯æ¥è‡ªå®˜æ–¹æ–‡æ¡£çš„è¯´æ˜ï¼š</p>
<blockquote>
<p>ç›®å‰å·²çŸ¥çš„åº”ç”¨åªæœ‰æ•°æ®åº“ <code>binlog</code> åŒæ­¥å¼ºä¾èµ–ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ï¼Œå…¶ä»–åº”ç”¨ç»å¤§éƒ¨åˆ†éƒ½å¯ä»¥å®¹å¿çŸ­æš‚ä¹±åºï¼Œæ¨èä½¿ç”¨æ™®é€šçš„é¡ºåºæ¶ˆæ¯</p>
</blockquote>
<hr>
<p>ğŸ˜ˆä¸Šä»£ç ï¼ï¼ï¼</p>
<h1>2. <code>Producer</code> é¡ºåºå‘é€</h1>
<p>å®˜æ–¹å‘é€é¡ºåºæ¶ˆæ¯çš„<strong>ä¾‹å­</strong>ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">package</span> org.apache.rocketmq.example.ordermessage;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">import</span> java.io.UnsupportedEncodingException;</div><div class="line"> <span class="number">4</span>: <span class="keyword">import</span> java.util.List;</div><div class="line"> <span class="number">5</span>: <span class="keyword">import</span> org.apache.rocketmq.client.exception.MQBrokerException;</div><div class="line"> <span class="number">6</span>: <span class="keyword">import</span> org.apache.rocketmq.client.exception.MQClientException;</div><div class="line"> <span class="number">7</span>: <span class="keyword">import</span> org.apache.rocketmq.client.producer.DefaultMQProducer;</div><div class="line"> <span class="number">8</span>: <span class="keyword">import</span> org.apache.rocketmq.client.producer.MQProducer;</div><div class="line"> <span class="number">9</span>: <span class="keyword">import</span> org.apache.rocketmq.client.producer.MessageQueueSelector;</div><div class="line"><span class="number">10</span>: <span class="keyword">import</span> org.apache.rocketmq.client.producer.SendResult;</div><div class="line"><span class="number">11</span>: <span class="keyword">import</span> org.apache.rocketmq.common.message.Message;</div><div class="line"><span class="number">12</span>: <span class="keyword">import</span> org.apache.rocketmq.common.message.MessageQueue;</div><div class="line"><span class="number">13</span>: <span class="keyword">import</span> org.apache.rocketmq.remoting.common.RemotingHelper;</div><div class="line"><span class="number">14</span>: <span class="keyword">import</span> org.apache.rocketmq.remoting.exception.RemotingException;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</div><div class="line"><span class="number">17</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> UnsupportedEncodingException </span>&#123;</div><div class="line"><span class="number">18</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">19</span>:             MQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"please_rename_unique_group_name"</span>);</div><div class="line"><span class="number">20</span>:             producer.start();</div><div class="line"><span class="number">21</span>: </div><div class="line"><span class="number">22</span>:             String[] tags = <span class="keyword">new</span> String[] &#123;<span class="string">"TagA"</span>, <span class="string">"TagB"</span>, <span class="string">"TagC"</span>, <span class="string">"TagD"</span>, <span class="string">"TagE"</span>&#125;;</div><div class="line"><span class="number">23</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</div><div class="line"><span class="number">24</span>:                 <span class="keyword">int</span> orderId = i % <span class="number">10</span>;</div><div class="line"><span class="number">25</span>:                 Message msg =</div><div class="line"><span class="number">26</span>:                     <span class="keyword">new</span> Message(<span class="string">"TopicTestjjj"</span>, tags[i % tags.length], <span class="string">"KEY"</span> + i,</div><div class="line"><span class="number">27</span>:                         (<span class="string">"Hello RocketMQ "</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));</div><div class="line"><span class="number">28</span>:                 SendResult sendResult = producer.send(msg, <span class="keyword">new</span> MessageQueueSelector() &#123;</div><div class="line"><span class="number">29</span>:                     <span class="meta">@Override</span></div><div class="line"><span class="number">30</span>:                     <span class="function"><span class="keyword">public</span> MessageQueue <span class="title">select</span><span class="params">(List&lt;MessageQueue&gt; mqs, Message msg, Object arg)</span> </span>&#123;</div><div class="line"><span class="number">31</span>:                         Integer id = (Integer) arg;</div><div class="line"><span class="number">32</span>:                         <span class="keyword">int</span> index = id % mqs.size();</div><div class="line"><span class="number">33</span>:                         <span class="keyword">return</span> mqs.get(index);</div><div class="line"><span class="number">34</span>:                     &#125;</div><div class="line"><span class="number">35</span>:                 &#125;, orderId);</div><div class="line"><span class="number">36</span>: </div><div class="line"><span class="number">37</span>:                 System.out.printf(<span class="string">"%s%n"</span>, sendResult);</div><div class="line"><span class="number">38</span>:             &#125;</div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>:             producer.shutdown();</div><div class="line"><span class="number">41</span>:         &#125; <span class="keyword">catch</span> (MQClientException | RemotingException | MQBrokerException | InterruptedException e) &#123;</div><div class="line"><span class="number">42</span>:             e.printStackTrace();</div><div class="line"><span class="number">43</span>:         &#125;</div><div class="line"><span class="number">44</span>:     &#125;</div><div class="line"><span class="number">45</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬ 28 è‡³ 35 è¡Œ ï¼šå®ç°äº†æ ¹æ® <code>id % mqs.size()</code> æ¥è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—çš„é€‰æ‹©ã€‚å½“å‰ä¾‹å­ï¼Œ<strong>æˆ‘ä»¬ä¼ é€’ <code>orderId</code> ä½œä¸ºå‚æ•°ï¼Œé‚£ä¹ˆç›¸åŒçš„ <code>orderId</code> èƒ½å¤Ÿè¿›å…¥ç›¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—</strong>ã€‚</li>
</ul>
<hr>
<p><code>MessageQueueSelector</code> æ¥å£çš„<strong>æºç </strong>ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MessageQueueSelector</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"> 4:      * é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 5:      *</div><div class="line"> 6:      * <span class="doctag">@param</span> mqs æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 7:      * <span class="doctag">@param</span> msg æ¶ˆæ¯</div><div class="line"> 8:      * <span class="doctag">@param</span> arg å‚æ•°</div><div class="line"> 9:      * <span class="doctag">@return</span> æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line">10:      */</div><div class="line"><span class="number">11</span>:     <span class="function">MessageQueue <span class="title">select</span><span class="params">(<span class="keyword">final</span> List&lt;MessageQueue&gt; mqs, <span class="keyword">final</span> Message msg, <span class="keyword">final</span> Object arg)</span></span>;</div><div class="line"><span class="number">12</span>: &#125;</div></pre></td></tr></table></figure></p>
<hr>
<p><code>Producer</code> é€‰æ‹©é˜Ÿåˆ—å‘é€æ¶ˆæ¯æ–¹æ³•çš„<strong>æºç </strong>ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">16</span>: <span class="function"><span class="keyword">private</span> SendResult <span class="title">sendSelectImpl</span><span class="params">(//</span></span></div><div class="line"><span class="number">17</span>:     Message msg, //</div><div class="line"><span class="number">18</span>:     MessageQueueSelector selector, //</div><div class="line"><span class="number">19</span>:     Object arg, //</div><div class="line"><span class="number">20</span>:     <span class="keyword">final</span> CommunicationMode communicationMode, //</div><div class="line"><span class="number">21</span>:     <span class="keyword">final</span> SendCallback sendCallback, <span class="keyword">final</span> <span class="keyword">long</span> timeout//</div><div class="line"><span class="number">22</span>: ) <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</div><div class="line"><span class="number">23</span>:     <span class="keyword">this</span>.makeSureStateOK();</div><div class="line"><span class="number">24</span>:     Validators.checkMessage(msg, <span class="keyword">this</span>.defaultMQProducer);</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:     TopicPublishInfo topicPublishInfo = <span class="keyword">this</span>.tryToFindTopicPublishInfo(msg.getTopic());</div><div class="line"><span class="number">27</span>:     <span class="keyword">if</span> (topicPublishInfo != <span class="keyword">null</span> &amp;&amp; topicPublishInfo.ok()) &#123;</div><div class="line"><span class="number">28</span>:         MessageQueue mq = <span class="keyword">null</span>;</div><div class="line"><span class="number">29</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">30</span>:             mq = selector.select(topicPublishInfo.getMessageQueueList(), msg, arg);</div><div class="line"><span class="number">31</span>:         &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">32</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"select message queue throwed exception."</span>, e);</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>: </div><div class="line"><span class="number">35</span>:         <span class="keyword">if</span> (mq != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">36</span>:             <span class="keyword">return</span> <span class="keyword">this</span>.sendKernelImpl(msg, mq, communicationMode, sendCallback, <span class="keyword">null</span>, timeout);</div><div class="line"><span class="number">37</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">38</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"select message queue return null."</span>, <span class="keyword">null</span>);</div><div class="line"><span class="number">39</span>:         &#125;</div><div class="line"><span class="number">40</span>:     &#125;</div><div class="line"><span class="number">41</span>: </div><div class="line"><span class="number">42</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"No route info for this topic, "</span> + msg.getTopic(), <span class="keyword">null</span>);</div><div class="line"><span class="number">43</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬ 30 è¡Œ ï¼šé€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
<li>ç¬¬ 36 è¡Œ ï¼šå‘é€æ¶ˆæ¯ã€‚</li>
</ul>
<h1>3. <code>Consumer</code> ä¸¥æ ¼é¡ºåºæ¶ˆè´¹</h1>
<p><code>Consumer</code> åœ¨ä¸¥æ ¼é¡ºåºæ¶ˆè´¹æ—¶ï¼Œé€šè¿‡ <strong>ä¸‰</strong> æŠŠé”ä¿è¯ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚</p>
<ul>
<li><code>Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ï¼ˆ<strong>åˆ†å¸ƒå¼é”</strong>ï¼‰ ï¼š
<ul>
<li>é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œ<code>Consumer</code> ä» <code>Broker</code> è·å¾—è¯¥é”åï¼Œæ‰èƒ½è¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€æ¶ˆè´¹ã€‚</li>
<li>å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œ<code>Consumer</code> æ— éœ€è¯¥é”ã€‚</li>
</ul>
</li>
<li><code>Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—é”ï¼ˆ<strong>æœ¬åœ°é”</strong>ï¼‰ ï¼š<code>Consumer</code> è·å¾—è¯¥é”æ‰èƒ½æ“ä½œæ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
<li><code>Consumer</code> æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ¶ˆè´¹é”ï¼ˆ<strong>æœ¬åœ°é”</strong>ï¼‰ ï¼š<code>Consumer</code> è·å¾—è¯¥é”æ‰èƒ½æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
</ul>
<p><strong>å¯èƒ½åŒå­¦æœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆæœ‰ <code>Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—é”è¿˜éœ€è¦æœ‰ <code>Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”å‘¢</strong>ï¼ŸğŸ˜ˆè®©æˆ‘ä»¬å¸¦ç€ç–‘é—®ç»§ç»­å¾€ä¸‹çœ‹ã€‚</p>
<hr>
<h2>3.1 è·å¾—(é”å®š)æ¶ˆæ¯é˜Ÿåˆ—</h2>
<p><strong>é›†ç¾¤æ¨¡å¼</strong>ä¸‹ï¼Œ<code>Consumer</code> æ›´æ–°å±äºè‡ªå·±çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‘ <code>Broker</code> é”å®šè¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆ<em>å¹¿æ’­æ¨¡å¼ä¸‹ä¸éœ€è¦</em>ï¼‰ã€‚å¦‚æœé”å®šå¤±è´¥ï¼Œåˆ™æ›´æ–°å¤±è´¥ï¼Œå³è¯¥æ¶ˆæ¯é˜Ÿåˆ—ä¸å±äºè‡ªå·±ï¼Œä¸èƒ½è¿›è¡Œæ¶ˆè´¹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalanceImpl.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateProcessQueueTableInRebalance</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> Set&lt;MessageQueue&gt; mqSet, <span class="keyword">final</span> <span class="keyword">boolean</span> isOrder)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: <span class="comment">// ..... æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç  </span></div><div class="line"> <span class="number">4</span>:     <span class="comment">// å¢åŠ  ä¸åœ¨processQueueTable &amp;&amp; å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</span></div><div class="line"> <span class="number">5</span>:     List&lt;PullRequest&gt; pullRequestList = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// æ‹‰æ¶ˆæ¯è¯·æ±‚æ•°ç»„</span></div><div class="line"> <span class="number">6</span>:     <span class="keyword">for</span> (MessageQueue mq : mqSet) &#123;</div><div class="line"> <span class="number">7</span>:         <span class="keyword">if</span> (!<span class="keyword">this</span>.processQueueTable.containsKey(mq)) &#123;</div><div class="line"> <span class="number">8</span>:             <span class="keyword">if</span> (isOrder &amp;&amp; !<span class="keyword">this</span>.lock(mq)) &#123; <span class="comment">// é¡ºåºæ¶ˆæ¯é”å®šæ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"> <span class="number">9</span>:                 log.warn(<span class="string">"doRebalance, &#123;&#125;, add a new mq failed, &#123;&#125;, because lock failed"</span>, consumerGroup, mq);</div><div class="line"><span class="number">10</span>:                 <span class="keyword">continue</span>;</div><div class="line"><span class="number">11</span>:             &#125;</div><div class="line"><span class="number">12</span>: </div><div class="line"><span class="number">13</span>:             <span class="keyword">this</span>.removeDirtyOffset(mq);</div><div class="line"><span class="number">14</span>:             ProcessQueue pq = <span class="keyword">new</span> ProcessQueue();</div><div class="line"><span class="number">15</span>:             <span class="keyword">long</span> nextOffset = <span class="keyword">this</span>.computePullFromWhere(mq);</div><div class="line"><span class="number">16</span>:             <span class="keyword">if</span> (nextOffset &gt;= <span class="number">0</span>) &#123;</div><div class="line"><span class="number">17</span>:                 ProcessQueue pre = <span class="keyword">this</span>.processQueueTable.putIfAbsent(mq, pq);</div><div class="line"><span class="number">18</span>:                 <span class="keyword">if</span> (pre != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">19</span>:                     log.info(<span class="string">"doRebalance, &#123;&#125;, mq already exists, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">20</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">21</span>:                     log.info(<span class="string">"doRebalance, &#123;&#125;, add a new mq, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">22</span>:                     PullRequest pullRequest = <span class="keyword">new</span> PullRequest();</div><div class="line"><span class="number">23</span>:                     pullRequest.setConsumerGroup(consumerGroup);</div><div class="line"><span class="number">24</span>:                     pullRequest.setNextOffset(nextOffset);</div><div class="line"><span class="number">25</span>:                     pullRequest.setMessageQueue(mq);</div><div class="line"><span class="number">26</span>:                     pullRequest.setProcessQueue(pq);</div><div class="line"><span class="number">27</span>:                     pullRequestList.add(pullRequest);</div><div class="line"><span class="number">28</span>:                     changed = <span class="keyword">true</span>;</div><div class="line"><span class="number">29</span>:                 &#125;</div><div class="line"><span class="number">30</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">31</span>:                 log.warn(<span class="string">"doRebalance, &#123;&#125;, add new mq failed, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">32</span>:             &#125;</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:     &#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>: <span class="comment">// ..... æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç  </span></div><div class="line"><span class="number">37</span>: &#125;</div><div class="line"><span class="number">38</span>: </div><div class="line"><span class="number">39</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalanceImpl.javaã€‘</span></div><div class="line"><span class="number">40</span>: <span class="comment">/**</span></div><div class="line">41:  * è¯·æ±‚Brokerè·å¾—æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—çš„åˆ†å¸ƒå¼é”</div><div class="line">42:  *</div><div class="line">43:  * <span class="doctag">@param</span> mq é˜Ÿåˆ—</div><div class="line">44:  * <span class="doctag">@return</span> æ˜¯å¦æˆåŠŸ</div><div class="line">45:  */</div><div class="line"><span class="number">46</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(<span class="keyword">final</span> MessageQueue mq)</span> </span>&#123;</div><div class="line"><span class="number">47</span>:     FindBrokerResult findBrokerResult = <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(), MixAll.MASTER_ID, <span class="keyword">true</span>);</div><div class="line"><span class="number">48</span>:     <span class="keyword">if</span> (findBrokerResult != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">49</span>:         LockBatchRequestBody requestBody = <span class="keyword">new</span> LockBatchRequestBody();</div><div class="line"><span class="number">50</span>:         requestBody.setConsumerGroup(<span class="keyword">this</span>.consumerGroup);</div><div class="line"><span class="number">51</span>:         requestBody.setClientId(<span class="keyword">this</span>.mQClientFactory.getClientId());</div><div class="line"><span class="number">52</span>:         requestBody.getMqSet().add(mq);</div><div class="line"><span class="number">53</span>: </div><div class="line"><span class="number">54</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">55</span>:             <span class="comment">// è¯·æ±‚Brokerè·å¾—æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—çš„åˆ†å¸ƒå¼é”</span></div><div class="line"><span class="number">56</span>:             Set&lt;MessageQueue&gt; lockedMq =</div><div class="line"><span class="number">57</span>:                 <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().lockBatchMQ(findBrokerResult.getBrokerAddr(), requestBody, <span class="number">1000</span>);</div><div class="line"><span class="number">58</span>: </div><div class="line"><span class="number">59</span>:             <span class="comment">// è®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—é”å®šæˆåŠŸã€‚é”å®šæ¶ˆæ¯é˜Ÿåˆ—æˆåŠŸï¼Œå¯èƒ½æœ¬åœ°æ²¡æœ‰æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ï¼Œè®¾ç½®é”å®šæˆåŠŸä¼šåœ¨lockAll()æ–¹æ³•ã€‚</span></div><div class="line"><span class="number">60</span>:             <span class="keyword">for</span> (MessageQueue mmqq : lockedMq) &#123;</div><div class="line"><span class="number">61</span>:                 ProcessQueue processQueue = <span class="keyword">this</span>.processQueueTable.get(mmqq);</div><div class="line"><span class="number">62</span>:                 <span class="keyword">if</span> (processQueue != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">63</span>:                     processQueue.setLocked(<span class="keyword">true</span>);</div><div class="line"><span class="number">64</span>:                     processQueue.setLastLockTimestamp(System.currentTimeMillis());</div><div class="line"><span class="number">65</span>:                 &#125;</div><div class="line"><span class="number">66</span>:             &#125;</div><div class="line"><span class="number">67</span>: </div><div class="line"><span class="number">68</span>:             <span class="keyword">boolean</span> lockOK = lockedMq.contains(mq);</div><div class="line"><span class="number">69</span>:             log.info(<span class="string">"the message queue lock &#123;&#125;, &#123;&#125; &#123;&#125;"</span>,</div><div class="line"><span class="number">70</span>:                 lockOK ? <span class="string">"OK"</span> : <span class="string">"Failed"</span>,</div><div class="line"><span class="number">71</span>:                 <span class="keyword">this</span>.consumerGroup,</div><div class="line"><span class="number">72</span>:                 mq);</div><div class="line"><span class="number">73</span>:             <span class="keyword">return</span> lockOK;</div><div class="line"><span class="number">74</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">75</span>:             log.error(<span class="string">"lockBatchMQ exception, "</span> + mq, e);</div><div class="line"><span class="number">76</span>:         &#125;</div><div class="line"><span class="number">77</span>:     &#125;</div><div class="line"><span class="number">78</span>: </div><div class="line"><span class="number">79</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">80</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>â¬†ï¸â¬†ï¸â¬†ï¸</li>
<li>ç¬¬ 8 è‡³ 11 è¡Œ ï¼šé¡ºåºæ¶ˆè´¹æ—¶ï¼Œé”å®šæ¶ˆæ¯é˜Ÿåˆ—ã€‚å¦‚æœé”å®šå¤±è´¥ï¼Œæ–°å¢æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å¤±è´¥ã€‚</li>
</ul>
<hr>
<p><code>Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ä¼šè¿‡æœŸï¼Œé»˜è®¤é…ç½® 30sã€‚å› æ­¤ï¼Œ<code>Consumer</code> éœ€è¦ä¸æ–­å‘ <code>Broker</code> åˆ·æ–°è¯¥é”è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤é…ç½® 20s åˆ·æ–°ä¸€æ¬¡ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.messageModel())) &#123;</div><div class="line"> <span class="number">4</span>:         <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"> <span class="number">5</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">6</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">7</span>:                 ConsumeMessageOrderlyService.<span class="keyword">this</span>.lockMQPeriodically();</div><div class="line"> <span class="number">8</span>:             &#125;</div><div class="line"> <span class="number">9</span>:         &#125;, <span class="number">1000</span> * <span class="number">1</span>, ProcessQueue.REBALANCE_LOCK_INTERVAL, TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">10</span>:     &#125;</div><div class="line"><span class="number">11</span>: &#125;</div></pre></td></tr></table></figure></p>
<h2>3.2 ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—</h2>
<p>é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œ<code>Consumer</code> ç§»é™¤è‡ªå·±çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‘ <code>Broker</code> è§£é”è¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¹¿æ’­æ¨¡å¼ä¸‹ä¸éœ€è¦ï¼‰ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalancePushImpl.javaã€‘</span></div><div class="line"> <span class="number">2</span>: <span class="comment">/**</span></div><div class="line"> 3:  * ç§»é™¤ä¸éœ€è¦çš„é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯</div><div class="line"> 4:  * 1. æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹</div><div class="line"> 5:  * 2. é¡ºåºæ¶ˆè´¹&amp;é›†ç¾¤æ¨¡å¼ï¼Œè§£é”å¯¹è¯¥é˜Ÿåˆ—çš„é”å®š</div><div class="line"> 6:  *</div><div class="line"> 7:  * <span class="doctag">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 8:  * <span class="doctag">@param</span> pq æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class="line"> 9:  * <span class="doctag">@return</span> æ˜¯å¦ç§»é™¤æˆåŠŸ</div><div class="line">10:  */</div><div class="line"><span class="number">11</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">12</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeUnnecessaryMessageQueue</span><span class="params">(MessageQueue mq, ProcessQueue pq)</span> </span>&#123;</div><div class="line"><span class="number">13</span>:     <span class="comment">// åŒæ­¥é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚</span></div><div class="line"><span class="number">14</span>:     <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().persist(mq);</div><div class="line"><span class="number">15</span>:     <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().removeOffset(mq);</div><div class="line"><span class="number">16</span>:     <span class="comment">// é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œé¡ºåºæ¶ˆè´¹ç§»é™¤æ—¶ï¼Œè§£é”å¯¹é˜Ÿåˆ—çš„é”å®š</span></div><div class="line"><span class="number">17</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.defaultMQPushConsumerImpl.isConsumeOrderly()</div><div class="line"><span class="number">18</span>:         &amp;&amp; MessageModel.CLUSTERING.equals(<span class="keyword">this</span>.defaultMQPushConsumerImpl.messageModel())) &#123;</div><div class="line"><span class="number">19</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">20</span>:             <span class="keyword">if</span> (pq.getLockConsume().tryLock(<span class="number">1000</span>, TimeUnit.MILLISECONDS)) &#123;</div><div class="line"><span class="number">21</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">22</span>:                     <span class="keyword">return</span> <span class="keyword">this</span>.unlockDelay(mq, pq);</div><div class="line"><span class="number">23</span>:                 &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">24</span>:                     pq.getLockConsume().unlock();</div><div class="line"><span class="number">25</span>:                 &#125;</div><div class="line"><span class="number">26</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">27</span>:                 log.warn(<span class="string">"[WRONG]mq is consuming, so can not unlock it, &#123;&#125;. maybe hanged for a while, &#123;&#125;"</span>, <span class="comment">//</span></div><div class="line"><span class="number">28</span>:                     mq, <span class="comment">//</span></div><div class="line"><span class="number">29</span>:                     pq.getTryUnlockTimes());</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:                 pq.incTryUnlockTimes();</div><div class="line"><span class="number">32</span>:             &#125;</div><div class="line"><span class="number">33</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">34</span>:             log.error(<span class="string">"removeUnnecessaryMessageQueue Exception"</span>, e);</div><div class="line"><span class="number">35</span>:         &#125;</div><div class="line"><span class="number">36</span>: </div><div class="line"><span class="number">37</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">38</span>:     &#125;</div><div class="line"><span class="number">39</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">40</span>: &#125;</div><div class="line"><span class="number">41</span>: </div><div class="line"><span class="number">42</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalancePushImpl.javaã€‘</span></div><div class="line"><span class="number">43</span>: <span class="comment">/**</span></div><div class="line">44:  * å»¶è¿Ÿè§£é” Broker æ¶ˆæ¯é˜Ÿåˆ—é”</div><div class="line">45:  * å½“æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸å­˜åœ¨æ¶ˆæ¯ï¼Œåˆ™ç›´æ¥è§£é”</div><div class="line">46:  *</div><div class="line">47:  * <span class="doctag">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line">48:  * <span class="doctag">@param</span> pq æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class="line">49:  * <span class="doctag">@return</span> æ˜¯å¦è§£é”æˆåŠŸ</div><div class="line">50:  */</div><div class="line"><span class="number">51</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">unlockDelay</span><span class="params">(<span class="keyword">final</span> MessageQueue mq, <span class="keyword">final</span> ProcessQueue pq)</span> </span>&#123;</div><div class="line"><span class="number">52</span>:     <span class="keyword">if</span> (pq.hasTempMessage()) &#123; <span class="comment">// TODO ç–‘é—®ï¼šä¸ºä»€ä¹ˆè¦å»¶è¿Ÿç§»é™¤</span></div><div class="line"><span class="number">53</span>:         log.info(<span class="string">"[&#123;&#125;]unlockDelay, begin &#123;&#125; "</span>, mq.hashCode(), mq);</div><div class="line"><span class="number">54</span>:         <span class="keyword">this</span>.defaultMQPushConsumerImpl.getmQClientFactory().getScheduledExecutorService().schedule(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"><span class="number">55</span>:             <span class="meta">@Override</span></div><div class="line"><span class="number">56</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">57</span>:                 log.info(<span class="string">"[&#123;&#125;]unlockDelay, execute at once &#123;&#125;"</span>, mq.hashCode(), mq);</div><div class="line"><span class="number">58</span>:                 RebalancePushImpl.<span class="keyword">this</span>.unlock(mq, <span class="keyword">true</span>);</div><div class="line"><span class="number">59</span>:             &#125;</div><div class="line"><span class="number">60</span>:         &#125;, UNLOCK_DELAY_TIME_MILLS, TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">61</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">62</span>:         <span class="keyword">this</span>.unlock(mq, <span class="keyword">true</span>);</div><div class="line"><span class="number">63</span>:     &#125;</div><div class="line"><span class="number">64</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">65</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>â¬†ï¸â¬†ï¸â¬†ï¸</li>
<li>ç¬¬ 20 è‡³ 32 è¡Œ ï¼šè·å–<strong>æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”</strong>ï¼Œé¿å…å’Œæ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹å†²çªã€‚å¦‚æœè·å–é”å¤±è´¥ï¼Œåˆ™ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—å¤±è´¥ï¼Œç­‰å¾…ä¸‹æ¬¡é‡æ–°åˆ†é…æ¶ˆè´¹é˜Ÿåˆ—æ—¶ï¼Œå†è¿›è¡Œç§»é™¤ã€‚å¦‚æœæœªè·å¾—é”è€Œè¿›è¡Œç§»é™¤ï¼Œåˆ™å¯èƒ½å‡ºç°å¦å¤–çš„  <code>Consumer</code> å’Œå½“å‰ <code>Consumer</code> åŒæ—¶æ¶ˆè´¹è¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯¼è‡´æ¶ˆæ¯æ— æ³•ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚</li>
<li>ç¬¬ 51 è‡³ 64 è¡Œ ï¼šè§£é” <code>Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚å¦‚æœæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å­˜åœ¨å‰©ä½™æ¶ˆæ¯ï¼Œåˆ™å»¶è¿Ÿè§£é” <code>Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚â“ä¸ºä»€ä¹ˆæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å­˜åœ¨å‰©ä½™æ¶ˆæ¯ä¸èƒ½ç›´æ¥è§£é”å‘¢ï¼ŸğŸ˜ˆæˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œç™¾æ€ä¸å¾—å…¶è§£ã€‚å¦‚æœæœ‰çŸ¥é“çš„åŒå­¦éº»çƒ¦æ•™è‚²ä¸‹ä¿ºã€‚</li>
</ul>
<h2>3.3 æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—</h2>
<p>ğŸ˜æœ¬èŠ‚ä¼šç±»æ¯”<strong>å¹¶å‘æ¶ˆè´¹æ¶ˆè´¹é˜Ÿåˆ—</strong>ï¼Œå»ºè®®å¯¹ç…§ <a href="http://www.yunai.me/RocketMQ/message-pull-and-consume-second/#6%E3%80%81PushConsumer-%E6%B6%88%E8%B4%B9%E6%B6%88%E6%81%AF">PushConsumerå¹¶å‘æ¶ˆè´¹æ¶ˆæ¯</a> ä¸€èµ·ç†è§£ã€‚</p>
<h3>3.1.1 æ¶ˆè´¹æ¶ˆæ¯</h3>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_13/01.png" alt="é¡ºåºæ¶ˆè´¹æ´»åŠ¨å›¾-æ¶ˆè´¹æ¶ˆæ¯"></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘</span></div><div class="line">  <span class="number">2</span>: <span class="class"><span class="keyword">class</span> <span class="title">ConsumeRequest</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">  <span class="number">3</span>: </div><div class="line">  <span class="number">4</span>:     <span class="comment">/**</span></div><div class="line">  5:      * æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class="line">  6:      */</div><div class="line">  <span class="number">7</span>:     <span class="keyword">private</span> <span class="keyword">final</span> ProcessQueue processQueue;</div><div class="line">  <span class="number">8</span>:     <span class="comment">/**</span></div><div class="line">  9:      * æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 10:      */</div><div class="line"> <span class="number">11</span>:     <span class="keyword">private</span> <span class="keyword">final</span> MessageQueue messageQueue;</div><div class="line"> <span class="number">12</span>: </div><div class="line"> <span class="number">13</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">14</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">15</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.processQueue.isDropped()) &#123;</div><div class="line"> <span class="number">16</span>:             log.warn(<span class="string">"run, the message queue not be able to consume, because it's dropped. &#123;&#125;"</span>, <span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">17</span>:             <span class="keyword">return</span>;</div><div class="line"> <span class="number">18</span>:         &#125;</div><div class="line"> <span class="number">19</span>: </div><div class="line"> <span class="number">20</span>:         <span class="comment">// è·å¾— Consumer æ¶ˆæ¯é˜Ÿåˆ—é”</span></div><div class="line"> <span class="number">21</span>:         <span class="keyword">final</span> Object objLock = messageQueueLock.fetchLockObject(<span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">22</span>:         <span class="keyword">synchronized</span> (objLock) &#123;</div><div class="line"> <span class="number">23</span>:             <span class="comment">// (å¹¿æ’­æ¨¡å¼) æˆ–è€… (é›†ç¾¤æ¨¡å¼ &amp;&amp; Brokeræ¶ˆæ¯é˜Ÿåˆ—é”æœ‰æ•ˆ)</span></div><div class="line"> <span class="number">24</span>:             <span class="keyword">if</span> (MessageModel.BROADCASTING.equals(ConsumeMessageOrderlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.messageModel())</div><div class="line"> <span class="number">25</span>:                 || (<span class="keyword">this</span>.processQueue.isLocked() &amp;&amp; !<span class="keyword">this</span>.processQueue.isLockExpired())) &#123;</div><div class="line"> <span class="number">26</span>:                 <span class="keyword">final</span> <span class="keyword">long</span> beginTime = System.currentTimeMillis();</div><div class="line"> <span class="number">27</span>:                 <span class="comment">// å¾ªç¯</span></div><div class="line"> <span class="number">28</span>:                 <span class="keyword">for</span> (<span class="keyword">boolean</span> continueConsume = <span class="keyword">true</span>; continueConsume; ) &#123;</div><div class="line"> <span class="number">29</span>:                     <span class="keyword">if</span> (<span class="keyword">this</span>.processQueue.isDropped()) &#123;</div><div class="line"> <span class="number">30</span>:                         log.warn(<span class="string">"the message queue not be able to consume, because it's dropped. &#123;&#125;"</span>, <span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">31</span>:                         <span class="keyword">break</span>;</div><div class="line"> <span class="number">32</span>:                     &#125;</div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:                     <span class="comment">// æ¶ˆæ¯é˜Ÿåˆ—åˆ†å¸ƒå¼é”æœªé”å®šï¼Œæäº¤å»¶è¿Ÿè·å¾—é”å¹¶æ¶ˆè´¹è¯·æ±‚</span></div><div class="line"> <span class="number">35</span>:                     <span class="keyword">if</span> (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.messageModel())</div><div class="line"> <span class="number">36</span>:                         &amp;&amp; !<span class="keyword">this</span>.processQueue.isLocked()) &#123;</div><div class="line"> <span class="number">37</span>:                         log.warn(<span class="string">"the message queue not locked, so consume later, &#123;&#125;"</span>, <span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">38</span>:                         ConsumeMessageOrderlyService.<span class="keyword">this</span>.tryLockLaterAndReconsume(<span class="keyword">this</span>.messageQueue, <span class="keyword">this</span>.processQueue, <span class="number">10</span>);</div><div class="line"> <span class="number">39</span>:                         <span class="keyword">break</span>;</div><div class="line"> <span class="number">40</span>:                     &#125;</div><div class="line"> <span class="number">41</span>:                     <span class="comment">// æ¶ˆæ¯é˜Ÿåˆ—åˆ†å¸ƒå¼é”å·²ç»è¿‡æœŸï¼Œæäº¤å»¶è¿Ÿè·å¾—é”å¹¶æ¶ˆè´¹è¯·æ±‚</span></div><div class="line"> <span class="number">42</span>:                     <span class="keyword">if</span> (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.messageModel())</div><div class="line"> <span class="number">43</span>:                         &amp;&amp; <span class="keyword">this</span>.processQueue.isLockExpired()) &#123;</div><div class="line"> <span class="number">44</span>:                         log.warn(<span class="string">"the message queue lock expired, so consume later, &#123;&#125;"</span>, <span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">45</span>:                         ConsumeMessageOrderlyService.<span class="keyword">this</span>.tryLockLaterAndReconsume(<span class="keyword">this</span>.messageQueue, <span class="keyword">this</span>.processQueue, <span class="number">10</span>);</div><div class="line"> <span class="number">46</span>:                         <span class="keyword">break</span>;</div><div class="line"> <span class="number">47</span>:                     &#125;</div><div class="line"> <span class="number">48</span>: </div><div class="line"> <span class="number">49</span>:                     <span class="comment">// å½“å‰å‘¨æœŸæ¶ˆè´¹æ—¶é—´è¶…è¿‡è¿ç»­æ—¶é•¿ï¼Œé»˜è®¤ï¼š60sï¼Œæäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯æ¶ˆè´¹1åˆ†é’Ÿä¼‘æ¯10msã€‚</span></div><div class="line"> <span class="number">50</span>:                     <span class="keyword">long</span> interval = System.currentTimeMillis() - beginTime;</div><div class="line"> <span class="number">51</span>:                     <span class="keyword">if</span> (interval &gt; MAX_TIME_CONSUME_CONTINUOUSLY) &#123;</div><div class="line"> <span class="number">52</span>:                         ConsumeMessageOrderlyService.<span class="keyword">this</span>.submitConsumeRequestLater(processQueue, messageQueue, <span class="number">10</span>);</div><div class="line"> <span class="number">53</span>:                         <span class="keyword">break</span>;</div><div class="line"> <span class="number">54</span>:                     &#125;</div><div class="line"> <span class="number">55</span>: </div><div class="line"> <span class="number">56</span>:                     <span class="comment">// è·å–æ¶ˆè´¹æ¶ˆæ¯ã€‚æ­¤å¤„å’Œå¹¶å‘æ¶ˆæ¯è¯·æ±‚ä¸åŒï¼Œå¹¶å‘æ¶ˆæ¯è¯·æ±‚å·²ç»å¸¦äº†æ¶ˆè´¹å“ªäº›æ¶ˆæ¯ã€‚</span></div><div class="line"> <span class="number">57</span>:                     <span class="keyword">final</span> <span class="keyword">int</span> consumeBatchSize = ConsumeMessageOrderlyService.<span class="keyword">this</span>.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();</div><div class="line"> <span class="number">58</span>:                     List&lt;MessageExt&gt; msgs = <span class="keyword">this</span>.processQueue.takeMessags(consumeBatchSize);</div><div class="line"> <span class="number">59</span>:                     <span class="keyword">if</span> (!msgs.isEmpty()) &#123;</div><div class="line"> <span class="number">60</span>:                         <span class="keyword">final</span> ConsumeOrderlyContext context = <span class="keyword">new</span> ConsumeOrderlyContext(<span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">61</span>: </div><div class="line"> <span class="number">62</span>:                         ConsumeOrderlyStatus status = <span class="keyword">null</span>;</div><div class="line"> <span class="number">63</span>: </div><div class="line"> <span class="number">64</span>:                         <span class="comment">// ....çœç•¥ä»£ç ï¼šHookï¼šbefore</span></div><div class="line"> <span class="number">65</span>: </div><div class="line"> <span class="number">66</span>:                         <span class="comment">// æ‰§è¡Œæ¶ˆè´¹</span></div><div class="line"> <span class="number">67</span>:                         <span class="keyword">long</span> beginTimestamp = System.currentTimeMillis();</div><div class="line"> <span class="number">68</span>:                         ConsumeReturnType returnType = ConsumeReturnType.SUCCESS;</div><div class="line"> <span class="number">69</span>:                         <span class="keyword">boolean</span> hasException = <span class="keyword">false</span>;</div><div class="line"> <span class="number">70</span>:                         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">71</span>:                             <span class="keyword">this</span>.processQueue.getLockConsume().lock(); <span class="comment">// é”å®šé˜Ÿåˆ—æ¶ˆè´¹é”</span></div><div class="line"> <span class="number">72</span>: </div><div class="line"> <span class="number">73</span>:                             <span class="keyword">if</span> (<span class="keyword">this</span>.processQueue.isDropped()) &#123;</div><div class="line"> <span class="number">74</span>:                                 log.warn(<span class="string">"consumeMessage, the message queue not be able to consume, because it's dropped. &#123;&#125;"</span>,</div><div class="line"> <span class="number">75</span>:                                     <span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">76</span>:                                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">77</span>:                             &#125;</div><div class="line"> <span class="number">78</span>: </div><div class="line"> <span class="number">79</span>:                             status = messageListener.consumeMessage(Collections.unmodifiableList(msgs), context);</div><div class="line"> <span class="number">80</span>:                         &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">81</span>:                             log.warn(<span class="string">"consumeMessage exception: &#123;&#125; Group: &#123;&#125; Msgs: &#123;&#125; MQ: &#123;&#125;"</span>, <span class="comment">//</span></div><div class="line"> <span class="number">82</span>:                                 RemotingHelper.exceptionSimpleDesc(e), <span class="comment">//</span></div><div class="line"> <span class="number">83</span>:                                 ConsumeMessageOrderlyService.<span class="keyword">this</span>.consumerGroup, <span class="comment">//</span></div><div class="line"> <span class="number">84</span>:                                 msgs, <span class="comment">//</span></div><div class="line"> <span class="number">85</span>:                                 messageQueue);</div><div class="line"> <span class="number">86</span>:                             hasException = <span class="keyword">true</span>;</div><div class="line"> <span class="number">87</span>:                         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"> <span class="number">88</span>:                             <span class="keyword">this</span>.processQueue.getLockConsume().unlock(); <span class="comment">// é”å®šé˜Ÿåˆ—æ¶ˆè´¹é”</span></div><div class="line"> <span class="number">89</span>:                         &#125;</div><div class="line"> <span class="number">90</span>: </div><div class="line"> <span class="number">91</span>:                         <span class="comment">// ....çœç•¥ä»£ç ï¼šè§£ææ¶ˆè´¹ç»“æœçŠ¶æ€</span></div><div class="line"> <span class="number">92</span>: </div><div class="line"> <span class="number">93</span>:                         <span class="comment">// ....çœç•¥ä»£ç ï¼šHookï¼šafter</span></div><div class="line"> <span class="number">94</span>: </div><div class="line"> <span class="number">95</span>:                         ConsumeMessageOrderlyService.<span class="keyword">this</span>.getConsumerStatsManager()</div><div class="line"> <span class="number">96</span>:                             .incConsumeRT(ConsumeMessageOrderlyService.<span class="keyword">this</span>.consumerGroup, messageQueue.getTopic(), consumeRT);</div><div class="line"> <span class="number">97</span>: </div><div class="line"> <span class="number">98</span>:                         <span class="comment">// å¤„ç†æ¶ˆè´¹ç»“æœ</span></div><div class="line"> <span class="number">99</span>:                         continueConsume = ConsumeMessageOrderlyService.<span class="keyword">this</span>.processConsumeResult(msgs, status, context, <span class="keyword">this</span>);</div><div class="line"><span class="number">100</span>:                     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">101</span>:                         continueConsume = <span class="keyword">false</span>;</div><div class="line"><span class="number">102</span>:                     &#125;</div><div class="line"><span class="number">103</span>:                 &#125;</div><div class="line"><span class="number">104</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">105</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.processQueue.isDropped()) &#123;</div><div class="line"><span class="number">106</span>:                     log.warn(<span class="string">"the message queue not be able to consume, because it's dropped. &#123;&#125;"</span>, <span class="keyword">this</span>.messageQueue);</div><div class="line"><span class="number">107</span>:                     <span class="keyword">return</span>;</div><div class="line"><span class="number">108</span>:                 &#125;</div><div class="line"><span class="number">109</span>: </div><div class="line"><span class="number">110</span>:                 ConsumeMessageOrderlyService.<span class="keyword">this</span>.tryLockLaterAndReconsume(<span class="keyword">this</span>.messageQueue, <span class="keyword">this</span>.processQueue, <span class="number">100</span>);</div><div class="line"><span class="number">111</span>:             &#125;</div><div class="line"><span class="number">112</span>:         &#125;</div><div class="line"><span class="number">113</span>:     &#125;</div><div class="line"><span class="number">114</span>: </div><div class="line"><span class="number">115</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>â¬†ï¸â¬†ï¸â¬†ï¸</li>
<li>ç¬¬ 20 è¡Œ ï¼šè·å¾— <code>Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚</li>
<li>ç¬¬ 58 è¡Œ ï¼šä»æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—é¡ºåºè·å¾—æ¶ˆæ¯ã€‚<strong>å’Œå¹¶å‘æ¶ˆè´¹è·å¾—æ¶ˆæ¯ä¸åŒã€‚å¹¶å‘æ¶ˆè´¹è¯·æ±‚åœ¨è¯·æ±‚åˆ›å»ºæ—¶ï¼Œå·²ç»è®¾ç½®å¥½æ¶ˆè´¹å“ªäº›æ¶ˆæ¯ã€‚</strong></li>
<li>ç¬¬ 71 è¡Œ ï¼šè·å¾— <code>Consumer</code> æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ¶ˆè´¹é”ã€‚ç›¸æ¯”ã€<code>Consumer</code>æ¶ˆæ¯é˜Ÿåˆ—é”ã€‘ï¼Œå…¶ç²’åº¦è¾ƒå°ã€‚è¿™å°±æ˜¯ä¸Šæ–‡æåˆ°çš„â“<strong>ä¸ºä»€ä¹ˆæœ‰<code>Consumer</code>æ¶ˆæ¯é˜Ÿåˆ—é”è¿˜éœ€è¦æœ‰ Consumer æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”å‘¢</strong>çš„åŸå› ã€‚</li>
<li>ç¬¬ 79 è¡Œ ï¼š<strong>æ‰§è¡Œæ¶ˆè´¹</strong>ã€‚</li>
<li>ç¬¬ 99 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚</li>
</ul>
<h3>3.1.2 å¤„ç†æ¶ˆè´¹ç»“æœ</h3>
<p>é¡ºåºæ¶ˆè´¹æ¶ˆæ¯ç»“æœ (<code>ConsumeOrderlyStatus</code>) æœ‰å››ç§æƒ…å†µï¼š</p>
<ul>
<li><code>SUCCESS</code> ï¼šæ¶ˆè´¹æˆåŠŸ<strong>ä½†ä¸æäº¤</strong>ã€‚</li>
<li><code>ROLLBACK</code> ï¼šæ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆè´¹å›æ»šã€‚</li>
<li><code>COMMIT</code> ï¼šæ¶ˆè´¹æˆåŠŸæäº¤å¹¶ä¸”æäº¤ã€‚</li>
<li><code>SUSPEND_CURRENT_QUEUE_A_MOMENT</code> ï¼šæ¶ˆè´¹å¤±è´¥ï¼ŒæŒ‚èµ·æ¶ˆè´¹é˜Ÿåˆ—ä¸€ä¼šä¼šï¼Œç¨åç»§ç»­æ¶ˆè´¹ã€‚</li>
</ul>
<p>è€ƒè™‘åˆ° <code>ROLLBACK</code> ã€<code>COMMIT</code> æš‚æ—¶åªä½¿ç”¨åœ¨ <code>MySQL binlog</code> åœºæ™¯ï¼Œå®˜æ–¹å°†è¿™ä¸¤çŠ¶æ€æ ‡è®°ä¸º <code>@Deprecated</code>ã€‚å½“ç„¶ï¼Œç›¸åº”çš„å®ç°é€»è¾‘ä¾ç„¶ä¿ç•™ã€‚</p>
<p>åœ¨<strong>å¹¶å‘æ¶ˆè´¹</strong>åœºæ™¯æ—¶ï¼Œå¦‚æœæ¶ˆè´¹å¤±è´¥ï¼Œ<code>Consumer</code> ä¼šå°†æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯å‘å›åˆ° <code>Broker</code> é‡è¯•é˜Ÿåˆ—ï¼Œè·³è¿‡å½“å‰æ¶ˆæ¯ï¼Œç­‰å¾…ä¸‹æ¬¡æ‹‰å–è¯¥æ¶ˆæ¯å†è¿›è¡Œæ¶ˆè´¹ã€‚</p>
<p>ä½†æ˜¯åœ¨<strong>å®Œå…¨ä¸¥æ ¼é¡ºåºæ¶ˆè´¹</strong>æ¶ˆè´¹æ—¶ï¼Œè¿™æ ·åšæ˜¾ç„¶ä¸è¡Œã€‚ä¹Ÿå› æ­¤ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ï¼Œä¼šæŒ‚èµ·é˜Ÿåˆ—ä¸€ä¼šä¼šï¼Œç¨åç»§ç»­æ¶ˆè´¹ã€‚</p>
<p>ä¸è¿‡æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ä¸€ç›´å¤±è´¥ï¼Œä¹Ÿä¸å¯èƒ½ä¸€ç›´æ¶ˆè´¹ã€‚å½“è¶…è¿‡æ¶ˆè´¹é‡è¯•ä¸Šé™æ—¶ï¼Œ<code>Consumer</code> ä¼šå°†æ¶ˆè´¹å¤±è´¥è¶…è¿‡ä¸Šé™çš„æ¶ˆæ¯å‘å›åˆ° <code>Broker</code> æ­»ä¿¡é˜Ÿåˆ—ã€‚</p>
<p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹ä»£ç ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘</span></div><div class="line">  <span class="number">2</span>: <span class="comment">/**</span></div><div class="line">  3:  * å¤„ç†æ¶ˆè´¹ç»“æœï¼Œå¹¶è¿”å›æ˜¯å¦ç»§ç»­æ¶ˆè´¹</div><div class="line">  4:  *</div><div class="line">  5:  * <span class="doctag">@param</span> msgs æ¶ˆæ¯</div><div class="line">  6:  * <span class="doctag">@param</span> status æ¶ˆè´¹ç»“æœçŠ¶æ€</div><div class="line">  7:  * <span class="doctag">@param</span> context æ¶ˆè´¹Context</div><div class="line">  8:  * <span class="doctag">@param</span> consumeRequest æ¶ˆè´¹è¯·æ±‚</div><div class="line">  9:  * <span class="doctag">@return</span> æ˜¯å¦ç»§ç»­æ¶ˆè´¹</div><div class="line"> 10:  */</div><div class="line"> <span class="number">11</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">processConsumeResult</span><span class="params">(//</span></span></div><div class="line"> <span class="number">12</span>:     <span class="keyword">final</span> List&lt;MessageExt&gt; msgs, //</div><div class="line"> <span class="number">13</span>:     <span class="keyword">final</span> ConsumeOrderlyStatus status, //</div><div class="line"> <span class="number">14</span>:     <span class="keyword">final</span> ConsumeOrderlyContext context, //</div><div class="line"> <span class="number">15</span>:     <span class="keyword">final</span> ConsumeRequest consumeRequest//</div><div class="line"> <span class="number">16</span>: ) &#123;</div><div class="line"> <span class="number">17</span>:     <span class="keyword">boolean</span> continueConsume = <span class="keyword">true</span>;</div><div class="line"> <span class="number">18</span>:     <span class="keyword">long</span> commitOffset = -<span class="number">1L</span>;</div><div class="line"> <span class="number">19</span>:     <span class="keyword">if</span> (context.isAutoCommit()) &#123;</div><div class="line"> <span class="number">20</span>:         <span class="keyword">switch</span> (status) &#123;</div><div class="line"> <span class="number">21</span>:             <span class="keyword">case</span> COMMIT:</div><div class="line"> <span class="number">22</span>:             <span class="keyword">case</span> ROLLBACK:</div><div class="line"> <span class="number">23</span>:                 log.warn(<span class="string">"the message queue consume result is illegal, we think you want to ack these message &#123;&#125;"</span>, consumeRequest.getMessageQueue());</div><div class="line"> <span class="number">24</span>:             <span class="keyword">case</span> SUCCESS:</div><div class="line"> <span class="number">25</span>:                 <span class="comment">// æäº¤æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸåˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</span></div><div class="line"> <span class="number">26</span>:                 commitOffset = consumeRequest.getProcessQueue().commit();</div><div class="line"> <span class="number">27</span>:                 <span class="comment">// ç»Ÿè®¡</span></div><div class="line"> <span class="number">28</span>:                 <span class="keyword">this</span>.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class="line"> <span class="number">29</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">30</span>:             <span class="keyword">case</span> SUSPEND_CURRENT_QUEUE_A_MOMENT:</div><div class="line"> <span class="number">31</span>:                 <span class="comment">// ç»Ÿè®¡</span></div><div class="line"> <span class="number">32</span>:                 <span class="keyword">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class="line"> <span class="number">33</span>:                 <span class="keyword">if</span> (checkReconsumeTimes(msgs)) &#123; <span class="comment">// è®¡ç®—æ˜¯å¦æš‚æ—¶æŒ‚èµ·ï¼ˆæš‚åœï¼‰æ¶ˆè´¹Næ¯«ç§’ï¼Œé»˜è®¤ï¼š10ms</span></div><div class="line"> <span class="number">34</span>:                     <span class="comment">// è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹</span></div><div class="line"> <span class="number">35</span>:                     consumeRequest.getProcessQueue().makeMessageToCosumeAgain(msgs);</div><div class="line"> <span class="number">36</span>:                     <span class="comment">// æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚</span></div><div class="line"> <span class="number">37</span>:                     <span class="keyword">this</span>.submitConsumeRequestLater(<span class="comment">//</span></div><div class="line"> <span class="number">38</span>:                         consumeRequest.getProcessQueue(), <span class="comment">//</span></div><div class="line"> <span class="number">39</span>:                         consumeRequest.getMessageQueue(), <span class="comment">//</span></div><div class="line"> <span class="number">40</span>:                         context.getSuspendCurrentQueueTimeMillis());</div><div class="line"> <span class="number">41</span>:                     continueConsume = <span class="keyword">false</span>;</div><div class="line"> <span class="number">42</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">43</span>:                     commitOffset = consumeRequest.getProcessQueue().commit();</div><div class="line"> <span class="number">44</span>:                 &#125;</div><div class="line"> <span class="number">45</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">46</span>:             <span class="keyword">default</span>:</div><div class="line"> <span class="number">47</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">48</span>:         &#125;</div><div class="line"> <span class="number">49</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">50</span>:         <span class="keyword">switch</span> (status) &#123;</div><div class="line"> <span class="number">51</span>:             <span class="keyword">case</span> SUCCESS:</div><div class="line"> <span class="number">52</span>:                 <span class="keyword">this</span>.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class="line"> <span class="number">53</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">54</span>:             <span class="keyword">case</span> COMMIT:</div><div class="line"> <span class="number">55</span>:                 <span class="comment">// æäº¤æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸåˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</span></div><div class="line"> <span class="number">56</span>:                 commitOffset = consumeRequest.getProcessQueue().commit();</div><div class="line"> <span class="number">57</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">58</span>:             <span class="keyword">case</span> ROLLBACK:</div><div class="line"> <span class="number">59</span>:                 <span class="comment">// è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹</span></div><div class="line"> <span class="number">60</span>:                 consumeRequest.getProcessQueue().rollback();</div><div class="line"> <span class="number">61</span>:                 <span class="keyword">this</span>.submitConsumeRequestLater(<span class="comment">//</span></div><div class="line"> <span class="number">62</span>:                     consumeRequest.getProcessQueue(), <span class="comment">//</span></div><div class="line"> <span class="number">63</span>:                     consumeRequest.getMessageQueue(), <span class="comment">//</span></div><div class="line"> <span class="number">64</span>:                     context.getSuspendCurrentQueueTimeMillis());</div><div class="line"> <span class="number">65</span>:                 continueConsume = <span class="keyword">false</span>;</div><div class="line"> <span class="number">66</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">67</span>:             <span class="keyword">case</span> SUSPEND_CURRENT_QUEUE_A_MOMENT: <span class="comment">// è®¡ç®—æ˜¯å¦æš‚æ—¶æŒ‚èµ·ï¼ˆæš‚åœï¼‰æ¶ˆè´¹Næ¯«ç§’ï¼Œé»˜è®¤ï¼š10ms</span></div><div class="line"> <span class="number">68</span>:                 <span class="keyword">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class="line"> <span class="number">69</span>:                 <span class="keyword">if</span> (checkReconsumeTimes(msgs)) &#123;</div><div class="line"> <span class="number">70</span>:                     <span class="comment">// è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹</span></div><div class="line"> <span class="number">71</span>:                     consumeRequest.getProcessQueue().makeMessageToCosumeAgain(msgs);</div><div class="line"> <span class="number">72</span>:                     <span class="comment">// æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚</span></div><div class="line"> <span class="number">73</span>:                     <span class="keyword">this</span>.submitConsumeRequestLater(<span class="comment">//</span></div><div class="line"> <span class="number">74</span>:                         consumeRequest.getProcessQueue(), <span class="comment">//</span></div><div class="line"> <span class="number">75</span>:                         consumeRequest.getMessageQueue(), <span class="comment">//</span></div><div class="line"> <span class="number">76</span>:                         context.getSuspendCurrentQueueTimeMillis());</div><div class="line"> <span class="number">77</span>:                     continueConsume = <span class="keyword">false</span>;</div><div class="line"> <span class="number">78</span>:                 &#125;</div><div class="line"> <span class="number">79</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">80</span>:             <span class="keyword">default</span>:</div><div class="line"> <span class="number">81</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">82</span>:         &#125;</div><div class="line"> <span class="number">83</span>:     &#125;</div><div class="line"> <span class="number">84</span>: </div><div class="line"> <span class="number">85</span>:     <span class="comment">// æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æœªdroppedï¼Œæäº¤æœ‰æ•ˆæ¶ˆè´¹è¿›åº¦</span></div><div class="line"> <span class="number">86</span>:     <span class="keyword">if</span> (commitOffset &gt;= <span class="number">0</span> &amp;&amp; !consumeRequest.getProcessQueue().isDropped()) &#123;</div><div class="line"> <span class="number">87</span>:         <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(consumeRequest.getMessageQueue(), commitOffset, <span class="keyword">false</span>);</div><div class="line"> <span class="number">88</span>:     &#125;</div><div class="line"> <span class="number">89</span>: </div><div class="line"> <span class="number">90</span>:     <span class="keyword">return</span> continueConsume;</div><div class="line"> <span class="number">91</span>: &#125;</div><div class="line"> <span class="number">92</span>: </div><div class="line"> <span class="number">93</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getMaxReconsumeTimes</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">94</span>:     <span class="comment">// default reconsume times: Integer.MAX_VALUE</span></div><div class="line"> <span class="number">95</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.defaultMQPushConsumer.getMaxReconsumeTimes() == -<span class="number">1</span>) &#123;</div><div class="line"> <span class="number">96</span>:         <span class="keyword">return</span> Integer.MAX_VALUE;</div><div class="line"> <span class="number">97</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">98</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.defaultMQPushConsumer.getMaxReconsumeTimes();</div><div class="line"> <span class="number">99</span>:     &#125;</div><div class="line"><span class="number">100</span>: &#125;</div><div class="line"><span class="number">101</span>: </div><div class="line"><span class="number">102</span>: <span class="comment">/**</span></div><div class="line">103:  * è®¡ç®—æ˜¯å¦è¦æš‚åœæ¶ˆè´¹</div><div class="line">104:  * ä¸æš‚åœæ¡ä»¶ï¼šå­˜åœ¨æ¶ˆæ¯éƒ½è¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°å¹¶ä¸”éƒ½å‘å›brokeræˆåŠŸ</div><div class="line">105:  *</div><div class="line">106:  * <span class="doctag">@param</span> msgs æ¶ˆæ¯</div><div class="line">107:  * <span class="doctag">@return</span> æ˜¯å¦è¦æš‚åœ</div><div class="line">108:  */</div><div class="line"><span class="number">109</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkReconsumeTimes</span><span class="params">(List&lt;MessageExt&gt; msgs)</span> </span>&#123;</div><div class="line"><span class="number">110</span>:     <span class="keyword">boolean</span> suspend = <span class="keyword">false</span>;</div><div class="line"><span class="number">111</span>:     <span class="keyword">if</span> (msgs != <span class="keyword">null</span> &amp;&amp; !msgs.isEmpty()) &#123;</div><div class="line"><span class="number">112</span>:         <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</div><div class="line"><span class="number">113</span>:             <span class="keyword">if</span> (msg.getReconsumeTimes() &gt;= getMaxReconsumeTimes()) &#123;</div><div class="line"><span class="number">114</span>:                 MessageAccessor.setReconsumeTime(msg, String.valueOf(msg.getReconsumeTimes()));</div><div class="line"><span class="number">115</span>:                 <span class="keyword">if</span> (!sendMessageBack(msg)) &#123; <span class="comment">// å‘å›å¤±è´¥ï¼Œä¸­æ–­</span></div><div class="line"><span class="number">116</span>:                     suspend = <span class="keyword">true</span>;</div><div class="line"><span class="number">117</span>:                     msg.setReconsumeTimes(msg.getReconsumeTimes() + <span class="number">1</span>);</div><div class="line"><span class="number">118</span>:                 &#125;</div><div class="line"><span class="number">119</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">120</span>:                 suspend = <span class="keyword">true</span>;</div><div class="line"><span class="number">121</span>:                 msg.setReconsumeTimes(msg.getReconsumeTimes() + <span class="number">1</span>);</div><div class="line"><span class="number">122</span>:             &#125;</div><div class="line"><span class="number">123</span>:         &#125;</div><div class="line"><span class="number">124</span>:     &#125;</div><div class="line"><span class="number">125</span>:     <span class="keyword">return</span> suspend;</div><div class="line"><span class="number">126</span>: &#125;</div><div class="line"><span class="number">127</span>: </div><div class="line"><span class="number">128</span>: <span class="comment">/**</span></div><div class="line">129:  * å‘å›æ¶ˆæ¯ã€‚</div><div class="line">130:  * æ¶ˆæ¯å‘å›brokeråï¼Œå¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ­»ä¿¡é˜Ÿåˆ—ã€‚</div><div class="line">131:  *</div><div class="line">132:  * <span class="doctag">@param</span> msg æ¶ˆæ¯</div><div class="line">133:  * <span class="doctag">@return</span> æ˜¯å¦å‘é€æˆåŠŸ</div><div class="line">134:  */</div><div class="line"><span class="number">135</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sendMessageBack</span><span class="params">(<span class="keyword">final</span> MessageExt msg)</span> </span>&#123;</div><div class="line"><span class="number">136</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">137</span>:         <span class="comment">// max reconsume times exceeded then send to dead letter queue.</span></div><div class="line"><span class="number">138</span>:         Message newMsg = <span class="keyword">new</span> Message(MixAll.getRetryTopic(<span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup()), msg.getBody());</div><div class="line"><span class="number">139</span>:         String originMsgId = MessageAccessor.getOriginMessageId(msg);</div><div class="line"><span class="number">140</span>:         MessageAccessor.setOriginMessageId(newMsg, UtilAll.isBlank(originMsgId) ? msg.getMsgId() : originMsgId);</div><div class="line"><span class="number">141</span>:         newMsg.setFlag(msg.getFlag());</div><div class="line"><span class="number">142</span>:         MessageAccessor.setProperties(newMsg, msg.getProperties());</div><div class="line"><span class="number">143</span>:         MessageAccessor.putProperty(newMsg, MessageConst.PROPERTY_RETRY_TOPIC, msg.getTopic());</div><div class="line"><span class="number">144</span>:         MessageAccessor.setReconsumeTime(newMsg, String.valueOf(msg.getReconsumeTimes()));</div><div class="line"><span class="number">145</span>:         MessageAccessor.setMaxReconsumeTimes(newMsg, String.valueOf(getMaxReconsumeTimes()));</div><div class="line"><span class="number">146</span>:         newMsg.setDelayTimeLevel(<span class="number">3</span> + msg.getReconsumeTimes());</div><div class="line"><span class="number">147</span>: </div><div class="line"><span class="number">148</span>:         <span class="keyword">this</span>.defaultMQPushConsumer.getDefaultMQPushConsumerImpl().getmQClientFactory().getDefaultMQProducer().send(newMsg);</div><div class="line"><span class="number">149</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">150</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">151</span>:         log.error(<span class="string">"sendMessageBack exception, group: "</span> + <span class="keyword">this</span>.consumerGroup + <span class="string">" msg: "</span> + msg.toString(), e);</div><div class="line"><span class="number">152</span>:     &#125;</div><div class="line"><span class="number">153</span>: </div><div class="line"><span class="number">154</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">155</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>â¬†ï¸â¬†ï¸â¬†ï¸</li>
<li>ç¬¬ 21 è‡³ 29 è¡Œ ï¼šæ¶ˆè´¹æˆåŠŸã€‚åœ¨è‡ªåŠ¨æäº¤è¿›åº¦( <code>AutoCommit</code> )çš„æƒ…å†µä¸‹ï¼Œ<code>COMMIT</code>ã€<code>ROLLBACK</code>ã€<code>SUCCESS</code> é€»è¾‘<strong>å·²ç»ç»Ÿä¸€</strong>ã€‚</li>
<li>ç¬¬ 30 è‡³ 45 è¡Œ ï¼šæ¶ˆè´¹å¤±è´¥ã€‚å½“æ¶ˆæ¯é‡è¯•æ¬¡æ•°è¶…è¿‡ä¸Šé™ï¼ˆé»˜è®¤ ï¼š16æ¬¡ï¼‰æ—¶ï¼Œå°†æ¶ˆæ¯å‘é€åˆ° <code>Broker</code> æ­»ä¿¡é˜Ÿåˆ—ï¼Œè·³è¿‡è¿™äº›æ¶ˆæ¯ã€‚æ­¤æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—æ— éœ€æŒ‚èµ·ï¼Œç»§ç»­æ¶ˆè´¹åé¢çš„æ¶ˆæ¯ã€‚</li>
<li>ç¬¬ 85 è‡³ 88 è¡Œ ï¼šæäº¤æ¶ˆè´¹è¿›åº¦ã€‚</li>
</ul>
<h3>3.13 æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•</h3>
<p>ğŸ˜ˆæ¶‰åŠåˆ°çš„å››ä¸ªæ ¸å¿ƒæ–¹æ³•çš„æºç ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ProcessQueue.javaã€‘</span></div><div class="line">  <span class="number">2</span>: <span class="comment">/**</span></div><div class="line">  3:  * æ¶ˆæ¯æ˜ å°„</div><div class="line">  4:  * keyï¼šæ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</div><div class="line">  5:  */</div><div class="line">  <span class="number">6</span>: <span class="keyword">private</span> <span class="keyword">final</span> TreeMap&lt;Long, MessageExt&gt; msgTreeMap = <span class="keyword">new</span> TreeMap&lt;&gt;();    <span class="comment">/**</span></div><div class="line">  7:  * æ¶ˆæ¯æ˜ å°„ä¸´æ—¶å­˜å‚¨ï¼ˆæ¶ˆè´¹ä¸­çš„æ¶ˆæ¯ï¼‰</div><div class="line">  8:  */</div><div class="line">  <span class="number">9</span>: <span class="keyword">private</span> <span class="keyword">final</span> TreeMap&lt;Long, MessageExt&gt; msgTreeMapTemp = <span class="keyword">new</span> TreeMap&lt;&gt;();</div><div class="line"> <span class="number">10</span>: </div><div class="line"> <span class="number">11</span>: <span class="comment">/**</span></div><div class="line"> 12:  * å›æ»šæ¶ˆè´¹ä¸­çš„æ¶ˆæ¯</div><div class="line"> 13:  * é€»è¾‘ç±»ä¼¼äº&#123;<span class="doctag">@link</span> #makeMessageToCosumeAgain(List)&#125;</div><div class="line"> 14:  */</div><div class="line"> <span class="number">15</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">16</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">17</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"> <span class="number">18</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">19</span>:             <span class="keyword">this</span>.msgTreeMap.putAll(<span class="keyword">this</span>.msgTreeMapTemp);</div><div class="line"> <span class="number">20</span>:             <span class="keyword">this</span>.msgTreeMapTemp.clear();</div><div class="line"> <span class="number">21</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"> <span class="number">22</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"> <span class="number">23</span>:         &#125;</div><div class="line"> <span class="number">24</span>:     &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"> <span class="number">25</span>:         log.error(<span class="string">"rollback exception"</span>, e);</div><div class="line"> <span class="number">26</span>:     &#125;</div><div class="line"> <span class="number">27</span>: &#125;</div><div class="line"> <span class="number">28</span>: </div><div class="line"> <span class="number">29</span>: <span class="comment">/**</span></div><div class="line"> 30:  * æäº¤æ¶ˆè´¹ä¸­çš„æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸï¼Œè¿”å›æ¶ˆè´¹è¿›åº¦</div><div class="line"> 31:  *</div><div class="line"> 32:  * <span class="doctag">@return</span> æ¶ˆè´¹è¿›åº¦</div><div class="line"> 33:  */</div><div class="line"> <span class="number">34</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">commit</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">35</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">36</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"> <span class="number">37</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">38</span>:             <span class="comment">// æ¶ˆè´¹è¿›åº¦</span></div><div class="line"> <span class="number">39</span>:             Long offset = <span class="keyword">this</span>.msgTreeMapTemp.lastKey();</div><div class="line"> <span class="number">40</span>: </div><div class="line"> <span class="number">41</span>:             <span class="comment">//</span></div><div class="line"> <span class="number">42</span>:             msgCount.addAndGet(<span class="keyword">this</span>.msgTreeMapTemp.size() * (-<span class="number">1</span>));</div><div class="line"> <span class="number">43</span>: </div><div class="line"> <span class="number">44</span>:             <span class="comment">//</span></div><div class="line"> <span class="number">45</span>:             <span class="keyword">this</span>.msgTreeMapTemp.clear();</div><div class="line"> <span class="number">46</span>: </div><div class="line"> <span class="number">47</span>:             <span class="comment">// è¿”å›æ¶ˆè´¹è¿›åº¦</span></div><div class="line"> <span class="number">48</span>:             <span class="keyword">if</span> (offset != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">49</span>:                 <span class="keyword">return</span> offset + <span class="number">1</span>;</div><div class="line"> <span class="number">50</span>:             &#125;</div><div class="line"> <span class="number">51</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"> <span class="number">52</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"> <span class="number">53</span>:         &#125;</div><div class="line"> <span class="number">54</span>:     &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"> <span class="number">55</span>:         log.error(<span class="string">"commit exception"</span>, e);</div><div class="line"> <span class="number">56</span>:     &#125;</div><div class="line"> <span class="number">57</span>: </div><div class="line"> <span class="number">58</span>:     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"> <span class="number">59</span>: &#125;</div><div class="line"> <span class="number">60</span>: </div><div class="line"> <span class="number">61</span>: <span class="comment">/**</span></div><div class="line"> 62:  * æŒ‡å®šæ¶ˆæ¯é‡æ–°æ¶ˆè´¹</div><div class="line"> 63:  * é€»è¾‘ç±»ä¼¼äº&#123;<span class="doctag">@link</span> #rollback()&#125;</div><div class="line"> 64:  *</div><div class="line"> 65:  * <span class="doctag">@param</span> msgs æ¶ˆæ¯</div><div class="line"> 66:  */</div><div class="line"> <span class="number">67</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makeMessageToCosumeAgain</span><span class="params">(List&lt;MessageExt&gt; msgs)</span> </span>&#123;</div><div class="line"> <span class="number">68</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">69</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"> <span class="number">70</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">71</span>:             <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</div><div class="line"> <span class="number">72</span>:                 <span class="keyword">this</span>.msgTreeMapTemp.remove(msg.getQueueOffset());</div><div class="line"> <span class="number">73</span>:                 <span class="keyword">this</span>.msgTreeMap.put(msg.getQueueOffset(), msg);</div><div class="line"> <span class="number">74</span>:             &#125;</div><div class="line"> <span class="number">75</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"> <span class="number">76</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"> <span class="number">77</span>:         &#125;</div><div class="line"> <span class="number">78</span>:     &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"> <span class="number">79</span>:         log.error(<span class="string">"makeMessageToCosumeAgain exception"</span>, e);</div><div class="line"> <span class="number">80</span>:     &#125;</div><div class="line"> <span class="number">81</span>: &#125;</div><div class="line"> <span class="number">82</span>: </div><div class="line"> <span class="number">83</span>: <span class="comment">/**</span></div><div class="line"> 84:  * è·å¾—æŒæœ‰æ¶ˆæ¯å‰Næ¡</div><div class="line"> 85:  *</div><div class="line"> 86:  * <span class="doctag">@param</span> batchSize æ¡æ•°</div><div class="line"> 87:  * <span class="doctag">@return</span> æ¶ˆæ¯</div><div class="line"> 88:  */</div><div class="line"> <span class="number">89</span>: <span class="function"><span class="keyword">public</span> List&lt;MessageExt&gt; <span class="title">takeMessags</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> batchSize)</span> </span>&#123;</div><div class="line"> <span class="number">90</span>:     List&lt;MessageExt&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(batchSize);</div><div class="line"> <span class="number">91</span>:     <span class="keyword">final</span> <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"> <span class="number">92</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">93</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"> <span class="number">94</span>:         <span class="keyword">this</span>.lastConsumeTimestamp = now;</div><div class="line"> <span class="number">95</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">96</span>:             <span class="keyword">if</span> (!<span class="keyword">this</span>.msgTreeMap.isEmpty()) &#123;</div><div class="line"> <span class="number">97</span>:                 <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; batchSize; i++) &#123;</div><div class="line"> <span class="number">98</span>:                     Map.Entry&lt;Long, MessageExt&gt; entry = <span class="keyword">this</span>.msgTreeMap.pollFirstEntry();</div><div class="line"> <span class="number">99</span>:                     <span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">100</span>:                         result.add(entry.getValue());</div><div class="line"><span class="number">101</span>:                         msgTreeMapTemp.put(entry.getKey(), entry.getValue());</div><div class="line"><span class="number">102</span>:                     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">103</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">104</span>:                     &#125;</div><div class="line"><span class="number">105</span>:                 &#125;</div><div class="line"><span class="number">106</span>:             &#125;</div><div class="line"><span class="number">107</span>: </div><div class="line"><span class="number">108</span>:             <span class="keyword">if</span> (result.isEmpty()) &#123;</div><div class="line"><span class="number">109</span>:                 consuming = <span class="keyword">false</span>;</div><div class="line"><span class="number">110</span>:             &#125;</div><div class="line"><span class="number">111</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">112</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"><span class="number">113</span>:         &#125;</div><div class="line"><span class="number">114</span>:     &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"><span class="number">115</span>:         log.error(<span class="string">"take Messages exception"</span>, e);</div><div class="line"><span class="number">116</span>:     &#125;</div><div class="line"><span class="number">117</span>: </div><div class="line"><span class="number">118</span>:     <span class="keyword">return</span> result;</div><div class="line"><span class="number">119</span>: &#125;</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rock
    
    </summary>
    
      <category term="RocketMQ" scheme="http://www.yunai.me/categories/RocketMQ/"/>
    
    
  </entry>
  
  <entry>
    <title>RocketMQ æºç åˆ†æ â€”â€” Store åˆå§‹åŒ–ä¸å…³é—­</title>
    <link href="http://www.yunai.me/RocketMQ/store-init-and-shutdown/"/>
    <id>http://www.yunai.me/RocketMQ/store-init-and-shutdown/</id>
    <published>2017-05-11T16:00:00.000Z</published>
    <updated>2017-07-27T16:56:37.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rock
    
    </summary>
    
      <category term="RocketMQ" scheme="http://www.yunai.me/categories/RocketMQ/"/>
    
    
  </entry>
  
  <entry>
    <title>RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸‹ï¼‰</title>
    <link href="http://www.yunai.me/RocketMQ/message-pull-and-consume-second/"/>
    <id>http://www.yunai.me/RocketMQ/message-pull-and-consume-second/</id>
    <published>2017-05-10T16:00:00.000Z</published>
    <updated>2017-07-27T16:56:27.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1ã€æ¦‚è¿°</a></li>
<li><a href="#">2ã€Consumer</a></li>
<li><a href="#">3ã€PushConsumer ä¸€è§ˆ</a></li>
<li><a href="#">4ã€PushConsumer è®¢é˜…</a>
<ul>
<li><a href="#">DefaultMQPushConsumerImpl#subscribe(...)</a>
<ul>
<li><a href="#">FilterAPI.buildSubscriptionData(...)</a></li>
</ul>
</li>
<li><a href="#">DefaultMQPushConsumer#registerMessageListener(...)</a></li>
</ul>
</li>
<li><a href="#">5ã€PushConsumer æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…</a>
<ul>
<li><a href="#">RebalanceService</a></li>
<li><a href="#">MQClientInstance#doRebalance(...)</a></li>
<li><a href="#">DefaultMQPushConsumerImpl#doRebalance(...)</a></li>
<li><a href="#">RebalanceImpl#doRebalance(...)</a>
<ul>
<li><a href="#">RebalanceImpl#rebalanceByTopic(...)</a></li>
<li><a href="#">RebalanceImpl#removeUnnecessaryMessageQueue(...)</a>
<ul>
<li><a href="#">RebalancePushImpl#removeUnnecessaryMessageQueue(...)</a></li>
<li><a href="#">[PullConsumer] RebalancePullImpl#removeUnnecessaryMessageQueue(...)</a></li>
</ul>
</li>
<li><a href="#">RebalancePushImpl#dispatchPullRequest(...)</a>
<ul>
<li><a href="#">DefaultMQPushConsumerImpl#executePullRequestImmediately(...)</a></li>
</ul>
</li>
<li><a href="#">AllocateMessageQueueStrategy</a>
<ul>
<li><a href="#">AllocateMessageQueueAveragely</a></li>
<li><a href="#">AllocateMessageQueueByMachineRoom</a></li>
<li><a href="#">AllocateMessageQueueAveragelyByCircle</a></li>
<li><a href="#">AllocateMessageQueueByConfig</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#">5ã€PushConsumer æ¶ˆè´¹è¿›åº¦è¯»å–</a>
<ul>
<li><a href="#">RebalancePushImpl#computePullFromWhere(...)</a></li>
<li><a href="#">[PullConsumer] RebalancePullImpl#computePullFromWhere(...)</a></li>
</ul>
</li>
<li><a href="#">6ã€PushConsumer æ‹‰å–æ¶ˆæ¯</a>
<ul>
<li><a href="#">PullMessageService</a></li>
<li><a href="#">DefaultMQPushConsumerImpl#pullMessage(...)</a>
<ul>
<li><a href="#">PullAPIWrapper#pullKernelImpl(...)</a>
<ul>
<li><a href="#">PullAPIWrapper#recalculatePullFromWhichNode(...)</a></li>
<li><a href="#">MQClientInstance#findBrokerAddressInSubscribe(...)</a></li>
</ul>
</li>
<li><a href="#">PullAPIWrapper#processPullResult(...)</a></li>
<li><a href="#">ProcessQueue#putMessage(...)</a></li>
</ul>
</li>
<li><a href="#">æ€»ç»“</a></li>
</ul>
</li>
<li><a href="#">6ã€PushConsumer æ¶ˆè´¹æ¶ˆæ¯</a>
<ul>
<li><a href="#">ConsumeMessageConcurrentlyService æäº¤æ¶ˆè´¹è¯·æ±‚</a>
<ul>
<li><a href="#">ConsumeMessageConcurrentlyService#submitConsumeRequest(...)</a></li>
<li><a href="#">ConsumeMessageConcurrentlyService#submitConsumeRequestLater</a></li>
</ul>
</li>
<li><a href="#">ConsumeRequest</a></li>
<li><a href="#">ConsumeMessageConcurrentlyService#processConsumeResult(...)</a>
<ul>
<li><a href="#">ProcessQueue#removeMessage(...)</a></li>
</ul>
</li>
<li><a href="#">ConsumeMessageConcurrentlyService#cleanExpireMsg(...)</a>
<ul>
<li><a href="#">ProcessQueue#cleanExpiredMsg(...)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#">7ã€PushConsumer å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯</a>
<ul>
<li><a href="#">DefaultMQPushConsumerImpl#sendMessageBack(...)</a>
<ul>
<li><a href="#">MQClientAPIImpl#consumerSendMessageBack(...)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#">8ã€Consumer æ¶ˆè´¹è¿›åº¦</a>
<ul>
<li><a href="#">OffsetStore</a>
<ul>
<li><a href="#">OffsetStore#load(...)</a>
<ul>
<li><a href="#">LocalFileOffsetStore#load(...)</a>
<ul>
<li><a href="#">OffsetSerializeWrapper</a></li>
</ul>
</li>
<li><a href="#">RemoteBrokerOffsetStore#load(...)</a></li>
</ul>
</li>
<li><a href="#">OffsetStore#readOffset(...)</a>
<ul>
<li><a href="#">LocalFileOffsetStore#readOffset(...)</a></li>
<li><a href="#">RemoteBrokerOffsetStore#readOffset(...)</a></li>
</ul>
</li>
<li><a href="#">OffsetStore#updateOffset(...)</a></li>
<li><a href="#">OffsetStore#persistAll(...)</a>
<ul>
<li><a href="#">LocalFileOffsetStore#persistAll(...)</a></li>
<li><a href="#">RemoteBrokerOffsetStore#persistAll(...)</a></li>
<li><a href="#">MQClientInstance#persistAllConsumerOffset(...)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#">9ã€ç»“å°¾</a></li>
</ul>
<hr>
<h1>1ã€æ¦‚è¿°</h1>
<p>æœ¬æ–‡æ¥ï¼š<a href="http://www.yunai.me/RocketMQ/message-pull-and-consume-first/">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰ã€‹</a>ã€‚</p>
<p>ä¸»è¦è§£æ <code>Consumer</code> åœ¨ <strong>æ¶ˆè´¹</strong> é€»è¾‘æ¶‰åŠåˆ°çš„æºç ã€‚</p>
<h1>2ã€Consumer</h1>
<p>MQ æä¾›äº†ä¸¤ç±»æ¶ˆè´¹è€…ï¼š</p>
<ul>
<li>PushConsumerï¼š
<ul>
<li>åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹ä½¿ç”¨ã€‚</li>
<li>åå­—è™½ç„¶æ˜¯ <code>Push</code> å¼€å¤´ï¼Œå®é™…åœ¨å®ç°æ—¶ï¼Œä½¿ç”¨ <code>Pull</code> æ–¹å¼å®ç°ã€‚é€šè¿‡ <code>Pull</code> <strong>ä¸æ–­ä¸æ–­ä¸æ–­</strong>è½®è¯¢ <code>Broker</code> è·å–æ¶ˆæ¯ã€‚å½“ä¸å­˜åœ¨æ–°æ¶ˆæ¯æ—¶ï¼Œ<code>Broker</code> ä¼š<strong>æŒ‚èµ·è¯·æ±‚</strong>ï¼Œç›´åˆ°æœ‰æ–°æ¶ˆæ¯äº§ç”Ÿï¼Œå–æ¶ˆæŒ‚èµ·ï¼Œè¿”å›æ–°æ¶ˆæ¯ã€‚è¿™æ ·ï¼ŒåŸºæœ¬å’Œ <code>Broker</code> ä¸»åŠ¨ <code>Push</code> åšåˆ°<strong>æ¥è¿‘</strong>çš„å®æ—¶æ€§ï¼ˆå½“ç„¶ï¼Œè¿˜æ˜¯æœ‰ç›¸åº”çš„å®æ—¶æ€§æŸå¤±ï¼‰ã€‚åŸç†ç±»ä¼¼ <strong><a href="https://www.ibm.com/developerworks/cn/web/wa-lo-comet/" rel="external nofollow noopener noreferrer" target="_blank">é•¿è½®è¯¢( <code>Long-Polling</code> )</a></strong>ã€‚</li>
</ul>
</li>
<li>PullConsumer</li>
</ul>
<p><strong>æœ¬æ–‡ä¸»è¦è®²è§£<code>PushConsumer</code>ï¼Œéƒ¨åˆ†è®²è§£<code>PullConsumer</code>ï¼Œè·³è¿‡<code>é¡ºåºæ¶ˆè´¹</code>ã€‚</strong><br>
<strong>æœ¬æ–‡ä¸»è¦è®²è§£<code>PushConsumer</code>ï¼Œéƒ¨åˆ†è®²è§£<code>PullConsumer</code>ï¼Œè·³è¿‡<code>é¡ºåºæ¶ˆè´¹</code>ã€‚</strong><br>
<strong>æœ¬æ–‡ä¸»è¦è®²è§£<code>PushConsumer</code>ï¼Œéƒ¨åˆ†è®²è§£<code>PullConsumer</code>ï¼Œè·³è¿‡<code>é¡ºåºæ¶ˆè´¹</code>ã€‚</strong></p>
<h1>3ã€PushConsumer ä¸€è§ˆ</h1>
<p>å…ˆçœ‹ä¸€å¼  <code>PushConsumer</code> åŒ…å«çš„ç»„ä»¶ä»¥åŠç»„ä»¶ä¹‹é—´çš„äº¤äº’å›¾ï¼š</p>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/09.png" alt="PushConsumeræ‰‹ç»˜å›¾.png"></p>
<ul>
<li><code>RebalanceService</code>ï¼šå‡è¡¡æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œè´Ÿè´£åˆ†é…å½“å‰ <code>Consumer</code> å¯æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>MessageQueue</code> )ã€‚å½“æœ‰æ–°çš„ <code>Consumer</code> çš„åŠ å…¥æˆ–ç§»é™¤ï¼Œéƒ½ä¼šé‡æ–°åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
<li><code>PullMessageService</code>ï¼šæ‹‰å–æ¶ˆæ¯æœåŠ¡ï¼Œ<strong>ä¸æ–­ä¸æ–­ä¸æ–­</strong>ä» <code>Broker</code> æ‹‰å–æ¶ˆæ¯ï¼Œå¹¶æäº¤æ¶ˆè´¹ä»»åŠ¡åˆ° <code>ConsumeMessageService</code>ã€‚</li>
<li><code>ConsumeMessageService</code>ï¼šæ¶ˆè´¹æ¶ˆæ¯æœåŠ¡ï¼Œ<strong>ä¸æ–­ä¸æ–­ä¸æ–­</strong>æ¶ˆè´¹æ¶ˆæ¯ï¼Œå¹¶å¤„ç†æ¶ˆè´¹ç»“æœã€‚</li>
<li><code>RemoteBrokerOffsetStore</code>ï¼š<code>Consumer</code> æ¶ˆè´¹è¿›åº¦ç®¡ç†ï¼Œè´Ÿè´£ä» <code>Broker</code> è·å–æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ° <code>Broker</code>ã€‚</li>
<li><code>ProcessQueue</code> ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ã€‚</li>
<li><code>MQClientInstance</code> ï¼šå°è£…å¯¹ <code>Namesrv</code>ï¼Œ<code>Broker</code> çš„ APIè°ƒç”¨ï¼Œæä¾›ç»™ <code>Producer</code>ã€<code>Consumer</code> ä½¿ç”¨ã€‚</li>
</ul>
<h1>4ã€PushConsumer è®¢é˜…</h1>
<h2>DefaultMQPushConsumerImpl#subscribe(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(String topic, String subExpression)</span> <span class="keyword">throws</span> MQClientException </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">3</span>:         <span class="comment">// åˆ›å»ºè®¢é˜…æ•°æ®</span></div><div class="line"> <span class="number">4</span>:         SubscriptionData subscriptionData = FilterAPI.buildSubscriptionData(<span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup(), <span class="comment">//</span></div><div class="line"> <span class="number">5</span>:             topic, subExpression);</div><div class="line"> <span class="number">6</span>:         <span class="keyword">this</span>.rebalanceImpl.getSubscriptionInner().put(topic, subscriptionData);</div><div class="line"> <span class="number">7</span>:         <span class="comment">// é€šè¿‡å¿ƒè·³åŒæ­¥Consumerä¿¡æ¯åˆ°Broker</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.mQClientFactory != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">9</span>:             <span class="keyword">this</span>.mQClientFactory.sendHeartbeatToAllBrokerWithLock();</div><div class="line"><span class="number">10</span>:         &#125;</div><div class="line"><span class="number">11</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">12</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"subscription exception"</span>, e);</div><div class="line"><span class="number">13</span>:     &#125;</div><div class="line"><span class="number">14</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šè®¢é˜… <code>Topic</code> ã€‚</li>
<li>ç¬¬ 3 è‡³ 6 è¡Œ ï¼šåˆ›å»ºè®¢é˜…æ•°æ®ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#filterapibuildsubscriptiondata">FilterAPI.buildSubscriptionData(...)</a>ã€‚</li>
<li>ç¬¬ 7 è‡³ 10 è¡Œ ï¼šé€šè¿‡å¿ƒè·³åŒæ­¥ <code>Consumer</code> ä¿¡æ¯åˆ° <code>Broker</code>ã€‚</li>
</ul>
<h3>FilterAPI.buildSubscriptionData(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SubscriptionData <span class="title">buildSubscriptionData</span><span class="params">(<span class="keyword">final</span> String consumerGroup, String topic,</span></span></div><div class="line"> <span class="number">2</span>:     String subString) <span class="keyword">throws</span> Exception &#123;</div><div class="line"> <span class="number">3</span>:     SubscriptionData subscriptionData = <span class="keyword">new</span> SubscriptionData();</div><div class="line"> <span class="number">4</span>:     subscriptionData.setTopic(topic);</div><div class="line"> <span class="number">5</span>:     subscriptionData.setSubString(subString);</div><div class="line"> <span class="number">6</span>:     <span class="comment">// å¤„ç†è®¢é˜…è¡¨è¾¾å¼</span></div><div class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == subString || subString.equals(SubscriptionData.SUB_ALL) || subString.length() == <span class="number">0</span>) &#123;</div><div class="line"> <span class="number">8</span>:         subscriptionData.setSubString(SubscriptionData.SUB_ALL);</div><div class="line"> <span class="number">9</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">10</span>:         String[] tags = subString.split(<span class="string">"\\|\\|"</span>);</div><div class="line"><span class="number">11</span>:         <span class="keyword">if</span> (tags.length &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">12</span>:             <span class="keyword">for</span> (String tag : tags) &#123;</div><div class="line"><span class="number">13</span>:                 <span class="keyword">if</span> (tag.length() &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">14</span>:                     String trimString = tag.trim();</div><div class="line"><span class="number">15</span>:                     <span class="keyword">if</span> (trimString.length() &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">16</span>:                         subscriptionData.getTagsSet().add(trimString);</div><div class="line"><span class="number">17</span>:                         subscriptionData.getCodeSet().add(trimString.hashCode());</div><div class="line"><span class="number">18</span>:                     &#125;</div><div class="line"><span class="number">19</span>:                 &#125;</div><div class="line"><span class="number">20</span>:             &#125;</div><div class="line"><span class="number">21</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">22</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"subString split error"</span>);</div><div class="line"><span class="number">23</span>:         &#125;</div><div class="line"><span class="number">24</span>:     &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:     <span class="keyword">return</span> subscriptionData;</div><div class="line"><span class="number">27</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šæ ¹æ® <code>Topic</code> å’Œ è®¢é˜…è¡¨è¾¾å¼ åˆ›å»ºè®¢é˜…æ•°æ®</li>
<li>subscriptionData.subVersion = System.currentTimeMillis()ã€‚</li>
</ul>
<h2>DefaultMQPushConsumer#registerMessageListener(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerMessageListener</span><span class="params">(MessageListenerConcurrently messageListener)</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     <span class="keyword">this</span>.messageListener = messageListener;</div><div class="line"><span class="number">3</span>:     <span class="keyword">this</span>.defaultMQPushConsumerImpl.registerMessageListener(messageListener);</div><div class="line"><span class="number">4</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šæ³¨å†Œæ¶ˆæ¯ç›‘å¬å™¨ã€‚</li>
</ul>
<h1>5ã€PushConsumer æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…</h1>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/10.png" alt="RebalanceService&amp;amp;PushConsumeråˆ†é…é˜Ÿåˆ—"></p>
<h2>RebalanceService</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RebalanceService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"> 4:      * ç­‰å¾…é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’</div><div class="line"> 5:      */</div><div class="line"> <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> waitInterval =</div><div class="line"> <span class="number">7</span>:         Long.parseLong(System.getProperty(</div><div class="line"> <span class="number">8</span>:             <span class="string">"rocketmq.client.rebalance.waitInterval"</span>, <span class="string">"20000"</span>));</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Logger log = ClientLogger.getLog();</div><div class="line"><span class="number">11</span>:     <span class="comment">/**</span></div><div class="line">12:      * MQClientå¯¹è±¡</div><div class="line">13:      */</div><div class="line"><span class="number">14</span>:     <span class="keyword">private</span> <span class="keyword">final</span> MQClientInstance mqClientFactory;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>:     <span class="function"><span class="keyword">public</span> <span class="title">RebalanceService</span><span class="params">(MQClientInstance mqClientFactory)</span> </span>&#123;</div><div class="line"><span class="number">17</span>:         <span class="keyword">this</span>.mqClientFactory = mqClientFactory;</div><div class="line"><span class="number">18</span>:     &#125;</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">21</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">22</span>:         log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service started"</span>);</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:         <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</div><div class="line"><span class="number">25</span>:             <span class="keyword">this</span>.waitForRunning(waitInterval);</div><div class="line"><span class="number">26</span>:             <span class="keyword">this</span>.mqClientFactory.doRebalance();</div><div class="line"><span class="number">27</span>:         &#125;</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>:         log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service end"</span>);</div><div class="line"><span class="number">30</span>:     &#125;</div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">33</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getServiceName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">34</span>:         <span class="keyword">return</span> RebalanceService.class.getSimpleName();</div><div class="line"><span class="number">35</span>:     &#125;</div><div class="line"><span class="number">36</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šå‡è¡¡æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œè´Ÿè´£åˆ†é…å½“å‰ <code>Consumer</code> å¯æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>MessageQueue</code> )ã€‚</li>
<li>ç¬¬ 26 è¡Œ ï¼šè°ƒç”¨ <code>MQClientInstance#doRebalance(...)</code> åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚ç›®å‰æœ‰ä¸‰ç§æƒ…å†µæƒ…å†µä¸‹è§¦å‘ï¼š
<ul>
<li>å¦‚ <code>ç¬¬ 25 è¡Œ</code> ç­‰å¾…è¶…æ—¶ï¼Œæ¯ 20s è°ƒç”¨ä¸€æ¬¡ã€‚</li>
<li><code>PushConsumer</code> å¯åŠ¨æ—¶ï¼Œè°ƒç”¨ <code>rebalanceService#wakeup(...)</code> è§¦å‘ã€‚</li>
<li><code>Broker</code> é€šçŸ¥ <code>Consumer</code> åŠ å…¥ æˆ– ç§»é™¤æ—¶ï¼Œ<code>Consumer</code> å“åº”é€šçŸ¥ï¼Œè°ƒç”¨ <code>rebalanceService#wakeup(...)</code> è§¦å‘ã€‚</li>
</ul>
</li>
</ul>
<p>è¯¦ç»†è§£æè§ï¼š<a href="#mqclientinstancedorebalance">MQClientInstance#doRebalance(...)</a>ã€‚</p>
<h2>MQClientInstance#doRebalance(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRebalance</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">for</span> (Map.Entry&lt;String, MQConsumerInner&gt; entry : <span class="keyword">this</span>.consumerTable.entrySet()) &#123;</div><div class="line"> <span class="number">3</span>:         MQConsumerInner impl = entry.getValue();</div><div class="line"> <span class="number">4</span>:         <span class="keyword">if</span> (impl != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">5</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>:                 impl.doRebalance();</div><div class="line"> <span class="number">7</span>:             &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">8</span>:                 log.error(<span class="string">"doRebalance exception"</span>, e);</div><div class="line"> <span class="number">9</span>:             &#125;</div><div class="line"><span class="number">10</span>:         &#125;</div><div class="line"><span class="number">11</span>:     &#125;</div><div class="line"><span class="number">12</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šéå†å½“å‰ <code>Client</code> åŒ…å«çš„ <code>consumerTable</code>( <code>Consumer</code>é›†åˆ )ï¼Œæ‰§è¡Œæ¶ˆæ¯é˜Ÿåˆ—åˆ†é…ã€‚</li>
<li><strong>ç–‘é—®</strong>ï¼šç›®å‰ä»£ç è°ƒè¯•ä¸‹æ¥ï¼Œ<code>consumerTable</code> åªåŒ…å« <code>Consumer</code> è‡ªå·±ã€‚ğŸ˜ˆæœ‰å¤§å¤§å¯¹è¿™ä¸ªç–‘é—®æœ‰è§£ç­”çš„ï¼Œçƒ¦è¯·è§£ç­”ä¸‹ã€‚</li>
<li>ç¬¬ 6 è¡Œ ï¼šè°ƒç”¨ <code>MQConsumerInner#doRebalance(...)</code> è¿›è¡Œé˜Ÿåˆ—åˆ†é…ã€‚<code>DefaultMQPushConsumerImpl</code>ã€<code>DefaultMQPullConsumerImpl</code> åˆ†åˆ«å¯¹è¯¥æ¥å£æ–¹æ³•è¿›è¡Œäº†å®ç°ã€‚<code>DefaultMQPushConsumerImpl#doRebalance(...)</code> è¯¦ç»†è§£æè§ï¼š<a href="defaultmqpushconsumerimpldorebalance">DefaultMQPushConsumerImpl#doRebalance(...)</a>ã€‚</li>
</ul>
<h2>DefaultMQPushConsumerImpl#doRebalance(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRebalance</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     <span class="keyword">if</span> (!<span class="keyword">this</span>.pause) &#123;</div><div class="line"><span class="number">3</span>:         <span class="keyword">this</span>.rebalanceImpl.doRebalance(<span class="keyword">this</span>.isConsumeOrderly());</div><div class="line"><span class="number">4</span>:     &#125;</div><div class="line"><span class="number">5</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ï¼šæ‰§è¡Œæ¶ˆæ¯é˜Ÿåˆ—åˆ†é…ã€‚</li>
<li>ç¬¬ 3 è¡Œ ï¼šè°ƒç”¨ <code>RebalanceImpl#doRebalance(...)</code> è¿›è¡Œé˜Ÿåˆ—åˆ†é…ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#rebalancepushimpldorebalance">RebalancePushImpl#doRebalance(...)</a>ã€‚</li>
</ul>
<h2>RebalanceImpl#doRebalance(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * æ‰§è¡Œåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 3:  *</div><div class="line"> 4:  * <span class="doctag">@param</span> isOrder æ˜¯å¦é¡ºåºæ¶ˆæ¯</div><div class="line"> 5:  */</div><div class="line"> <span class="number">6</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRebalance</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> isOrder)</span> </span>&#123;</div><div class="line"> <span class="number">7</span>:     <span class="comment">// åˆ†é…æ¯ä¸ª topic çš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"> <span class="number">8</span>:     Map&lt;String, SubscriptionData&gt; subTable = <span class="keyword">this</span>.getSubscriptionInner();</div><div class="line"> <span class="number">9</span>:     <span class="keyword">if</span> (subTable != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">10</span>:         <span class="keyword">for</span> (<span class="keyword">final</span> Map.Entry&lt;String, SubscriptionData&gt; entry : subTable.entrySet()) &#123;</div><div class="line"><span class="number">11</span>:             <span class="keyword">final</span> String topic = entry.getKey();</div><div class="line"><span class="number">12</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">13</span>:                 <span class="keyword">this</span>.rebalanceByTopic(topic, isOrder);</div><div class="line"><span class="number">14</span>:             &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">15</span>:                 <span class="keyword">if</span> (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class="line"><span class="number">16</span>:                     log.warn(<span class="string">"rebalanceByTopic Exception"</span>, e);</div><div class="line"><span class="number">17</span>:                 &#125;</div><div class="line"><span class="number">18</span>:             &#125;</div><div class="line"><span class="number">19</span>:         &#125;</div><div class="line"><span class="number">20</span>:     &#125;</div><div class="line"><span class="number">21</span>:     <span class="comment">// ç§»é™¤æœªè®¢é˜…çš„topicå¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"><span class="number">22</span>:     <span class="keyword">this</span>.truncateMessageQueueNotMyTopic();</div><div class="line"><span class="number">23</span>: &#125;</div><div class="line"><span class="number">24</span>: </div><div class="line"><span class="number">25</span>: <span class="comment">/**</span></div><div class="line">26:  * ç§»é™¤æœªè®¢é˜…çš„æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line">27:  */</div><div class="line"><span class="number">28</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">truncateMessageQueueNotMyTopic</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">29</span>:     Map&lt;String, SubscriptionData&gt; subTable = <span class="keyword">this</span>.getSubscriptionInner();</div><div class="line"><span class="number">30</span>:     <span class="keyword">for</span> (MessageQueue mq : <span class="keyword">this</span>.processQueueTable.keySet()) &#123;</div><div class="line"><span class="number">31</span>:         <span class="keyword">if</span> (!subTable.containsKey(mq.getTopic())) &#123;</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>:             ProcessQueue pq = <span class="keyword">this</span>.processQueueTable.remove(mq);</div><div class="line"><span class="number">34</span>:             <span class="keyword">if</span> (pq != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">35</span>:                 pq.setDropped(<span class="keyword">true</span>);</div><div class="line"><span class="number">36</span>:                 log.info(<span class="string">"doRebalance, &#123;&#125;, truncateMessageQueueNotMyTopic remove unnecessary mq, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">37</span>:             &#125;</div><div class="line"><span class="number">38</span>:         &#125;</div><div class="line"><span class="number">39</span>:     &#125;</div><div class="line"><span class="number">40</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#doRebalance(...)</code> è¯´æ˜ ï¼šæ‰§è¡Œåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚
<ul>
<li>ç¬¬ 7 è‡³ 20 è¡Œ ï¼šå¾ªç¯è®¢é˜…ä¸»é¢˜é›†åˆ( <code>subscriptionInner</code> )ï¼Œåˆ†é…æ¯ä¸€ä¸ª <code>Topic</code> çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
<li>ç¬¬ 22 è¡Œ ï¼šç§»é™¤æœªè®¢é˜…çš„ <code>Topic</code> çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
</ul>
</li>
<li><code>#truncateMessageQueueNotMyTopic(...)</code> è¯´æ˜ ï¼šç§»é™¤æœªè®¢é˜…çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚<strong>å½“è°ƒç”¨ <code>DefaultMQPushConsumer#unsubscribe(topic)</code> æ—¶ï¼Œåªç§»é™¤è®¢é˜…ä¸»é¢˜é›†åˆ( <code>subscriptionInner</code> )ï¼Œå¯¹åº”æ¶ˆæ¯é˜Ÿåˆ—ç§»é™¤åœ¨è¯¥æ–¹æ³•ã€‚</strong></li>
</ul>
<h3>RebalanceImpl#rebalanceByTopic(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rebalanceByTopic</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">boolean</span> isOrder)</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="keyword">switch</span> (messageModel) &#123;</div><div class="line">  <span class="number">3</span>:         <span class="keyword">case</span> BROADCASTING: &#123;</div><div class="line">  <span class="number">4</span>:             Set&lt;MessageQueue&gt; mqSet = <span class="keyword">this</span>.topicSubscribeInfoTable.get(topic);</div><div class="line">  <span class="number">5</span>:             <span class="keyword">if</span> (mqSet != <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="number">6</span>:                 <span class="keyword">boolean</span> changed = <span class="keyword">this</span>.updateProcessQueueTableInRebalance(topic, mqSet, isOrder);</div><div class="line">  <span class="number">7</span>:                 <span class="keyword">if</span> (changed) &#123;</div><div class="line">  <span class="number">8</span>:                     <span class="keyword">this</span>.messageQueueChanged(topic, mqSet, mqSet);</div><div class="line">  <span class="number">9</span>:                     log.info(<span class="string">"messageQueueChanged &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;"</span>, <span class="comment">//</span></div><div class="line"> <span class="number">10</span>:                         consumerGroup, <span class="comment">//</span></div><div class="line"> <span class="number">11</span>:                         topic, <span class="comment">//</span></div><div class="line"> <span class="number">12</span>:                         mqSet, <span class="comment">//</span></div><div class="line"> <span class="number">13</span>:                         mqSet);</div><div class="line"> <span class="number">14</span>:                 &#125;</div><div class="line"> <span class="number">15</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">16</span>:                 log.warn(<span class="string">"doRebalance, &#123;&#125;, but the topic[&#123;&#125;] not exist."</span>, consumerGroup, topic);</div><div class="line"> <span class="number">17</span>:             &#125;</div><div class="line"> <span class="number">18</span>:             <span class="keyword">break</span>;</div><div class="line"> <span class="number">19</span>:         &#125;</div><div class="line"> <span class="number">20</span>:         <span class="keyword">case</span> CLUSTERING: &#123;</div><div class="line"> <span class="number">21</span>:             <span class="comment">// è·å– topic å¯¹åº”çš„ é˜Ÿåˆ— å’Œ consumerä¿¡æ¯</span></div><div class="line"> <span class="number">22</span>:             Set&lt;MessageQueue&gt; mqSet = <span class="keyword">this</span>.topicSubscribeInfoTable.get(topic);</div><div class="line"> <span class="number">23</span>:             List&lt;String&gt; cidAll = <span class="keyword">this</span>.mQClientFactory.findConsumerIdList(topic, consumerGroup);</div><div class="line"> <span class="number">24</span>:             <span class="keyword">if</span> (<span class="keyword">null</span> == mqSet) &#123;</div><div class="line"> <span class="number">25</span>:                 <span class="keyword">if</span> (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class="line"> <span class="number">26</span>:                     log.warn(<span class="string">"doRebalance, &#123;&#125;, but the topic[&#123;&#125;] not exist."</span>, consumerGroup, topic);</div><div class="line"> <span class="number">27</span>:                 &#125;</div><div class="line"> <span class="number">28</span>:             &#125;</div><div class="line"> <span class="number">29</span>: </div><div class="line"> <span class="number">30</span>:             <span class="keyword">if</span> (<span class="keyword">null</span> == cidAll) &#123;</div><div class="line"> <span class="number">31</span>:                 log.warn(<span class="string">"doRebalance, &#123;&#125; &#123;&#125;, get consumer id list failed"</span>, consumerGroup, topic);</div><div class="line"> <span class="number">32</span>:             &#125;</div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:             <span class="keyword">if</span> (mqSet != <span class="keyword">null</span> &amp;&amp; cidAll != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">35</span>:                 <span class="comment">// æ’åº æ¶ˆæ¯é˜Ÿåˆ— å’Œ æ¶ˆè´¹è€…æ•°ç»„ã€‚å› ä¸ºæ˜¯åœ¨Clientè¿›è¡Œåˆ†é…é˜Ÿåˆ—ï¼Œæ’åºåï¼Œå„Clientçš„é¡ºåºæ‰èƒ½ä¿æŒä¸€è‡´ã€‚</span></div><div class="line"> <span class="number">36</span>:                 List&lt;MessageQueue&gt; mqAll = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"> <span class="number">37</span>:                 mqAll.addAll(mqSet);</div><div class="line"> <span class="number">38</span>: </div><div class="line"> <span class="number">39</span>:                 Collections.sort(mqAll);</div><div class="line"> <span class="number">40</span>:                 Collections.sort(cidAll);</div><div class="line"> <span class="number">41</span>: </div><div class="line"> <span class="number">42</span>:                 AllocateMessageQueueStrategy strategy = <span class="keyword">this</span>.allocateMessageQueueStrategy;</div><div class="line"> <span class="number">43</span>: </div><div class="line"> <span class="number">44</span>:                 <span class="comment">// æ ¹æ® é˜Ÿåˆ—åˆ†é…ç­–ç•¥ åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"> <span class="number">45</span>:                 List&lt;MessageQueue&gt; allocateResult;</div><div class="line"> <span class="number">46</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">47</span>:                     allocateResult = strategy.allocate(<span class="comment">//</span></div><div class="line"> <span class="number">48</span>:                         <span class="keyword">this</span>.consumerGroup, <span class="comment">//</span></div><div class="line"> <span class="number">49</span>:                         <span class="keyword">this</span>.mQClientFactory.getClientId(), <span class="comment">//</span></div><div class="line"> <span class="number">50</span>:                         mqAll, <span class="comment">//</span></div><div class="line"> <span class="number">51</span>:                         cidAll);</div><div class="line"> <span class="number">52</span>:                 &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">53</span>:                     log.error(<span class="string">"AllocateMessageQueueStrategy.allocate Exception. allocateMessageQueueStrategyName=&#123;&#125;"</span>, strategy.getName(),</div><div class="line"> <span class="number">54</span>:                         e);</div><div class="line"> <span class="number">55</span>:                     <span class="keyword">return</span>;</div><div class="line"> <span class="number">56</span>:                 &#125;</div><div class="line"> <span class="number">57</span>: </div><div class="line"> <span class="number">58</span>:                 Set&lt;MessageQueue&gt; allocateResultSet = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"> <span class="number">59</span>:                 <span class="keyword">if</span> (allocateResult != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">60</span>:                     allocateResultSet.addAll(allocateResult);</div><div class="line"> <span class="number">61</span>:                 &#125;</div><div class="line"> <span class="number">62</span>: </div><div class="line"> <span class="number">63</span>:                 <span class="comment">// æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"> <span class="number">64</span>:                 <span class="keyword">boolean</span> changed = <span class="keyword">this</span>.updateProcessQueueTableInRebalance(topic, allocateResultSet, isOrder);</div><div class="line"> <span class="number">65</span>:                 <span class="keyword">if</span> (changed) &#123;</div><div class="line"> <span class="number">66</span>:                     log.info(</div><div class="line"> <span class="number">67</span>:                         <span class="string">"rebalanced result changed. allocateMessageQueueStrategyName=&#123;&#125;, group=&#123;&#125;, topic=&#123;&#125;, clientId=&#123;&#125;, mqAllSize=&#123;&#125;, cidAllSize=&#123;&#125;, rebalanceResultSize=&#123;&#125;, rebalanceResultSet=&#123;&#125;"</span>,</div><div class="line"> <span class="number">68</span>:                         strategy.getName(), consumerGroup, topic, <span class="keyword">this</span>.mQClientFactory.getClientId(), mqSet.size(), cidAll.size(),</div><div class="line"> <span class="number">69</span>:                         allocateResultSet.size(), allocateResultSet);</div><div class="line"> <span class="number">70</span>:                     <span class="keyword">this</span>.messageQueueChanged(topic, mqSet, allocateResultSet);</div><div class="line"> <span class="number">71</span>:                 &#125;</div><div class="line"> <span class="number">72</span>:             &#125;</div><div class="line"> <span class="number">73</span>:             <span class="keyword">break</span>;</div><div class="line"> <span class="number">74</span>:         &#125;</div><div class="line"> <span class="number">75</span>:         <span class="keyword">default</span>:</div><div class="line"> <span class="number">76</span>:             <span class="keyword">break</span>;</div><div class="line"> <span class="number">77</span>:     &#125;</div><div class="line"> <span class="number">78</span>: &#125;</div><div class="line"> <span class="number">79</span>: </div><div class="line"> <span class="number">80</span>: <span class="comment">/**</span></div><div class="line"> 81:  * å½“è´Ÿè½½å‡è¡¡æ—¶ï¼Œæ›´æ–° æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class="line"> 82:  * - ç§»é™¤ åœ¨processQueueTable &amp;&amp; ä¸å­˜åœ¨äº mqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 83:  * - å¢åŠ  ä¸åœ¨processQueueTable &amp;&amp; å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 84:  *</div><div class="line"> 85:  * <span class="doctag">@param</span> topic Topic</div><div class="line"> 86:  * <span class="doctag">@param</span> mqSet è´Ÿè½½å‡è¡¡ç»“æœåçš„æ¶ˆæ¯é˜Ÿåˆ—æ•°ç»„</div><div class="line"> 87:  * <span class="doctag">@param</span> isOrder æ˜¯å¦é¡ºåº</div><div class="line"> 88:  * <span class="doctag">@return</span> æ˜¯å¦å˜æ›´</div><div class="line"> 89:  */</div><div class="line"> <span class="number">90</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateProcessQueueTableInRebalance</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> Set&lt;MessageQueue&gt; mqSet, <span class="keyword">final</span> <span class="keyword">boolean</span> isOrder)</span> </span>&#123;</div><div class="line"> <span class="number">91</span>:     <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</div><div class="line"> <span class="number">92</span>: </div><div class="line"> <span class="number">93</span>:     <span class="comment">// ç§»é™¤ åœ¨processQueueTable &amp;&amp; ä¸å­˜åœ¨äº mqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"> <span class="number">94</span>:     Iterator&lt;Entry&lt;MessageQueue, ProcessQueue&gt;&gt; it = <span class="keyword">this</span>.processQueueTable.entrySet().iterator();</div><div class="line"> <span class="number">95</span>:     <span class="keyword">while</span> (it.hasNext()) &#123; <span class="comment">// TODO å¾…è¯»ï¼š</span></div><div class="line"> <span class="number">96</span>:         Entry&lt;MessageQueue, ProcessQueue&gt; next = it.next();</div><div class="line"> <span class="number">97</span>:         MessageQueue mq = next.getKey();</div><div class="line"> <span class="number">98</span>:         ProcessQueue pq = next.getValue();</div><div class="line"> <span class="number">99</span>: </div><div class="line"><span class="number">100</span>:         <span class="keyword">if</span> (mq.getTopic().equals(topic)) &#123;</div><div class="line"><span class="number">101</span>:             <span class="keyword">if</span> (!mqSet.contains(mq)) &#123; <span class="comment">// ä¸åŒ…å«çš„é˜Ÿåˆ—</span></div><div class="line"><span class="number">102</span>:                 pq.setDropped(<span class="keyword">true</span>);</div><div class="line"><span class="number">103</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.removeUnnecessaryMessageQueue(mq, pq)) &#123;</div><div class="line"><span class="number">104</span>:                     it.remove();</div><div class="line"><span class="number">105</span>:                     changed = <span class="keyword">true</span>;</div><div class="line"><span class="number">106</span>:                     log.info(<span class="string">"doRebalance, &#123;&#125;, remove unnecessary mq, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">107</span>:                 &#125;</div><div class="line"><span class="number">108</span>:             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pq.isPullExpired()) &#123; <span class="comment">// é˜Ÿåˆ—æ‹‰å–è¶…æ—¶ï¼Œè¿›è¡Œæ¸…ç†</span></div><div class="line"><span class="number">109</span>:                 <span class="keyword">switch</span> (<span class="keyword">this</span>.consumeType()) &#123;</div><div class="line"><span class="number">110</span>:                     <span class="keyword">case</span> CONSUME_ACTIVELY:</div><div class="line"><span class="number">111</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">112</span>:                     <span class="keyword">case</span> CONSUME_PASSIVELY:</div><div class="line"><span class="number">113</span>:                         pq.setDropped(<span class="keyword">true</span>);</div><div class="line"><span class="number">114</span>:                         <span class="keyword">if</span> (<span class="keyword">this</span>.removeUnnecessaryMessageQueue(mq, pq)) &#123;</div><div class="line"><span class="number">115</span>:                             it.remove();</div><div class="line"><span class="number">116</span>:                             changed = <span class="keyword">true</span>;</div><div class="line"><span class="number">117</span>:                             log.error(<span class="string">"[BUG]doRebalance, &#123;&#125;, remove unnecessary mq, &#123;&#125;, because pull is pause, so try to fixed it"</span>,</div><div class="line"><span class="number">118</span>:                                 consumerGroup, mq);</div><div class="line"><span class="number">119</span>:                         &#125;</div><div class="line"><span class="number">120</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">121</span>:                     <span class="keyword">default</span>:</div><div class="line"><span class="number">122</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">123</span>:                 &#125;</div><div class="line"><span class="number">124</span>:             &#125;</div><div class="line"><span class="number">125</span>:         &#125;</div><div class="line"><span class="number">126</span>:     &#125;</div><div class="line"><span class="number">127</span>: </div><div class="line"><span class="number">128</span>:     <span class="comment">// å¢åŠ  ä¸åœ¨processQueueTable &amp;&amp; å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</span></div><div class="line"><span class="number">129</span>:     List&lt;PullRequest&gt; pullRequestList = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// æ‹‰æ¶ˆæ¯è¯·æ±‚æ•°ç»„</span></div><div class="line"><span class="number">130</span>:     <span class="keyword">for</span> (MessageQueue mq : mqSet) &#123;</div><div class="line"><span class="number">131</span>:         <span class="keyword">if</span> (!<span class="keyword">this</span>.processQueueTable.containsKey(mq)) &#123;</div><div class="line"><span class="number">132</span>:             <span class="keyword">if</span> (isOrder &amp;&amp; !<span class="keyword">this</span>.lock(mq)) &#123;</div><div class="line"><span class="number">133</span>:                 log.warn(<span class="string">"doRebalance, &#123;&#125;, add a new mq failed, &#123;&#125;, because lock failed"</span>, consumerGroup, mq);</div><div class="line"><span class="number">134</span>:                 <span class="keyword">continue</span>;</div><div class="line"><span class="number">135</span>:             &#125;</div><div class="line"><span class="number">136</span>: </div><div class="line"><span class="number">137</span>:             <span class="keyword">this</span>.removeDirtyOffset(mq);</div><div class="line"><span class="number">138</span>:             ProcessQueue pq = <span class="keyword">new</span> ProcessQueue();</div><div class="line"><span class="number">139</span>:             <span class="keyword">long</span> nextOffset = <span class="keyword">this</span>.computePullFromWhere(mq);</div><div class="line"><span class="number">140</span>:             <span class="keyword">if</span> (nextOffset &gt;= <span class="number">0</span>) &#123;</div><div class="line"><span class="number">141</span>:                 ProcessQueue pre = <span class="keyword">this</span>.processQueueTable.putIfAbsent(mq, pq);</div><div class="line"><span class="number">142</span>:                 <span class="keyword">if</span> (pre != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">143</span>:                     log.info(<span class="string">"doRebalance, &#123;&#125;, mq already exists, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">144</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">145</span>:                     log.info(<span class="string">"doRebalance, &#123;&#125;, add a new mq, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">146</span>:                     PullRequest pullRequest = <span class="keyword">new</span> PullRequest();</div><div class="line"><span class="number">147</span>:                     pullRequest.setConsumerGroup(consumerGroup);</div><div class="line"><span class="number">148</span>:                     pullRequest.setNextOffset(nextOffset);</div><div class="line"><span class="number">149</span>:                     pullRequest.setMessageQueue(mq);</div><div class="line"><span class="number">150</span>:                     pullRequest.setProcessQueue(pq);</div><div class="line"><span class="number">151</span>:                     pullRequestList.add(pullRequest);</div><div class="line"><span class="number">152</span>:                     changed = <span class="keyword">true</span>;</div><div class="line"><span class="number">153</span>:                 &#125;</div><div class="line"><span class="number">154</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">155</span>:                 log.warn(<span class="string">"doRebalance, &#123;&#125;, add new mq failed, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">156</span>:             &#125;</div><div class="line"><span class="number">157</span>:         &#125;</div><div class="line"><span class="number">158</span>:     &#125;</div><div class="line"><span class="number">159</span>: </div><div class="line"><span class="number">160</span>:     <span class="comment">// å‘èµ·æ¶ˆæ¯æ‹‰å–è¯·æ±‚</span></div><div class="line"><span class="number">161</span>:     <span class="keyword">this</span>.dispatchPullRequest(pullRequestList);</div><div class="line"><span class="number">162</span>: </div><div class="line"><span class="number">163</span>:     <span class="keyword">return</span> changed;</div><div class="line"><span class="number">164</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#rebalanceByTopic(...)</code> è¯´æ˜ ï¼šåˆ†é… <code>Topic</code> çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚
<ul>
<li>ç¬¬ 3 è‡³ 19 è¡Œ ï¼šå¹¿æ’­æ¨¡å¼( <code>BROADCASTING</code> ) ä¸‹ï¼Œåˆ†é… <code>Topic</code> å¯¹åº”çš„<strong>æ‰€æœ‰</strong>æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
<li>ç¬¬ 20 è‡³ 74 è¡Œ ï¼šé›†ç¾¤æ¨¡å¼( <code>CLUSTERING</code> ) ä¸‹ï¼Œåˆ†é… <code>Topic</code> å¯¹åº”çš„<strong>éƒ¨åˆ†</strong>æ¶ˆæ¯é˜Ÿåˆ—ã€‚
<ul>
<li>ç¬¬ 21 è‡³ 40 è¡Œ ï¼šè·å– <code>Topic</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—å’Œæ¶ˆè´¹è€…ä»¬ï¼Œå¹¶å¯¹å…¶è¿›è¡Œæ’åºã€‚å› ä¸ºå„ <code>Consumer</code> æ˜¯åœ¨æœ¬åœ°åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ’åºåæ‰èƒ½ä¿è¯å„ <code>Consumer</code> é¡ºåºä¸€è‡´ã€‚</li>
<li>ç¬¬ 42 è‡³ 61 è¡Œ ï¼šæ ¹æ® é˜Ÿåˆ—åˆ†é…ç­–ç•¥( <code>AllocateMessageQueueStrategy</code> ) åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#allocatemessagequeuestrategy">AllocateMessageQueueStrategy</a>ã€‚</li>
<li>ç¬¬ 63 è‡³ 72 è¡Œ ï¼šæ›´æ–° <code>Topic</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><code>#updateProcessQueueTableInRebalance(...)</code> è¯´æ˜ ï¼šå½“åˆ†é…é˜Ÿåˆ—æ—¶ï¼Œæ›´æ–° <code>Topic</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶è¿”å›æ˜¯å¦æœ‰å˜æ›´ã€‚
<ul>
<li>ç¬¬ 93 è‡³ 126 è¡Œ ï¼šç§»é™¤ä¸å­˜åœ¨äºåˆ†é…çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>mqSet</code> ) çš„ æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—( <code>processQueueTable</code> )ã€‚
<ul>
<li>ç¬¬ 103 è¡Œ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#rebalancepushimplremoveunnecessarymessagequeue">RebalancePushImpl#removeUnnecessaryMessageQueue(...)</a>ã€‚</li>
<li>ç¬¬ 108 è‡³ 120 è¡Œ ï¼šé˜Ÿåˆ—æ‹‰å–è¶…æ—¶ï¼Œå³ <code>å½“å‰æ—¶é—´ - æœ€åä¸€æ¬¡æ‹‰å–æ¶ˆæ¯æ—¶é—´ &gt; 120s</code> ( 120s å¯é…ç½®)ï¼Œåˆ¤å®šå‘ç”Ÿ <strong>BUG</strong>ï¼Œè¿‡ä¹…æœªè¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—ã€‚ç§»é™¤åï¼Œä¸‹é¢**#æ–°å¢é˜Ÿåˆ—é€»è¾‘#**å¯ä»¥é‡æ–°åŠ å…¥æ–°çš„è¯¥æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
</ul>
</li>
<li>ç¬¬ 128 è‡³ 158 è¡Œ ï¼šå¢åŠ  åˆ†é…çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>mqSet</code> ) æ–°å¢çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚
<ul>
<li>ç¬¬ 132 è‡³ 135 è¡Œ ï¼š<code>é¡ºåºæ¶ˆè´¹</code> ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š<a href="http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹</a>ã€‚</li>
<li>ç¬¬ 137 è¡Œ ï¼šç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ã€‚</li>
<li>ç¬¬ 139 è¡Œ ï¼šè·å–é˜Ÿåˆ—æ¶ˆè´¹è¿›åº¦ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#rebalancepushimplcomputepullfromwhere">RebalancePushImpl#computePullFromWhere(...)</a>ã€‚</li>
<li>ç¬¬ 140 è‡³ 156 è¡Œ ï¼š<strong>æ·»åŠ æ–°æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ï¼Œæ·»åŠ æ¶ˆè´¹æ‹‰å–æ¶ˆæ¯è¯·æ±‚</strong>ã€‚</li>
</ul>
</li>
<li>ç¬¬ 161 è¡Œ ï¼š<strong>å‘èµ·æ–°å¢çš„æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆæ¯æ‹‰å–è¯·æ±‚</strong>ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#rebalancepushimpldispatchpullrequest">RebalancePushImpl#dispatchPullRequest(...)</a>ã€‚</li>
</ul>
</li>
</ul>
<h3>RebalanceImpl#removeUnnecessaryMessageQueue(...)</h3>
<h4>RebalancePushImpl#removeUnnecessaryMessageQueue(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeUnnecessaryMessageQueue</span><span class="params">(MessageQueue mq, ProcessQueue pq)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// åŒæ­¥é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚</span></div><div class="line"> <span class="number">3</span>:     <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().persist(mq);</div><div class="line"> <span class="number">4</span>:     <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().removeOffset(mq);</div><div class="line"> <span class="number">5</span>:     <span class="comment">// TODO é¡ºåºæ¶ˆè´¹</span></div><div class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.defaultMQPushConsumerImpl.isConsumeOrderly()</div><div class="line"> <span class="number">7</span>:         &amp;&amp; MessageModel.CLUSTERING.equals(<span class="keyword">this</span>.defaultMQPushConsumerImpl.messageModel())) &#123;</div><div class="line"> <span class="number">8</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">9</span>:             <span class="keyword">if</span> (pq.getLockConsume().tryLock(<span class="number">1000</span>, TimeUnit.MILLISECONDS)) &#123;</div><div class="line"><span class="number">10</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">11</span>:                     <span class="keyword">return</span> <span class="keyword">this</span>.unlockDelay(mq, pq);</div><div class="line"><span class="number">12</span>:                 &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">13</span>:                     pq.getLockConsume().unlock();</div><div class="line"><span class="number">14</span>:                 &#125;</div><div class="line"><span class="number">15</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">16</span>:                 log.warn(<span class="string">"[WRONG]mq is consuming, so can not unlock it, &#123;&#125;. maybe hanged for a while, &#123;&#125;"</span>, <span class="comment">//</span></div><div class="line"><span class="number">17</span>:                     mq, <span class="comment">//</span></div><div class="line"><span class="number">18</span>:                     pq.getTryUnlockTimes());</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>:                 pq.incTryUnlockTimes();</div><div class="line"><span class="number">21</span>:             &#125;</div><div class="line"><span class="number">22</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">23</span>:             log.error(<span class="string">"removeUnnecessaryMessageQueue Exception"</span>, e);</div><div class="line"><span class="number">24</span>:         &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">27</span>:     &#125;</div><div class="line"><span class="number">28</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">29</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯ï¼Œå¹¶è¿”å›æ˜¯å¦ç§»é™¤æˆåŠŸã€‚</li>
<li>ç¬¬ 2 è‡³ 4 è¡Œ ï¼š<strong>åŒæ­¥</strong>é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚</li>
<li>ç¬¬ 5 è‡³ 27 è¡Œ ï¼š<code>é¡ºåºæ¶ˆè´¹</code> ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š<a href="http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹</a>ã€‚</li>
</ul>
<h4><code>[PullConsumer]</code> RebalancePullImpl#removeUnnecessaryMessageQueue(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeUnnecessaryMessageQueue</span><span class="params">(MessageQueue mq, ProcessQueue pq)</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     <span class="keyword">this</span>.defaultMQPullConsumerImpl.getOffsetStore().persist(mq);</div><div class="line"><span class="number">3</span>:     <span class="keyword">this</span>.defaultMQPullConsumerImpl.getOffsetStore().removeOffset(mq);</div><div class="line"><span class="number">4</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">5</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯ï¼Œå¹¶è¿”å›ç§»é™¤æˆåŠŸã€‚<strong>å’Œ<code>RebalancePushImpl#removeUnnecessaryMessageQueue(...)</code>åŸºæœ¬ä¸€è‡´ã€‚</strong></li>
</ul>
<h3>RebalancePushImpl#dispatchPullRequest(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchPullRequest</span><span class="params">(List&lt;PullRequest&gt; pullRequestList)</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     <span class="keyword">for</span> (PullRequest pullRequest : pullRequestList) &#123;</div><div class="line"><span class="number">3</span>:         <span class="keyword">this</span>.defaultMQPushConsumerImpl.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">4</span>:         log.info(<span class="string">"doRebalance, &#123;&#125;, add a new pull request &#123;&#125;"</span>, consumerGroup, pullRequest);</div><div class="line"><span class="number">5</span>:     &#125;</div><div class="line"><span class="number">6</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šå‘èµ·æ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚<strong>è¯¥è°ƒç”¨æ˜¯<code>PushConsumer</code>ä¸æ–­ä¸æ–­ä¸æ–­æ‹‰å–æ¶ˆæ¯çš„èµ·ç‚¹</strong>ã€‚</li>
</ul>
<h4>DefaultMQPushConsumerImpl#executePullRequestImmediately(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executePullRequestImmediately</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     <span class="keyword">this</span>.mQClientFactory.getPullMessageService().executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">3</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šæäº¤æ‹‰å–è¯·æ±‚ã€‚æäº¤åï¼Œ<code>PullMessageService</code> <strong>å¼‚æ­¥æ‰§è¡Œ</strong>ï¼Œ<strong>éé˜»å¡</strong>ã€‚è¯¦ç»†è§£æè§ï¼š<a href="pullmessageservice">PullMessageService</a>ã€‚</li>
</ul>
<h3>AllocateMessageQueueStrategy</h3>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/01.png" alt="AllocateMessageQueueStrategyç±»å›¾"></p>
<h4>AllocateMessageQueueAveragely</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllocateMessageQueueAveragely</span> <span class="keyword">implements</span> <span class="title">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Logger log = ClientLogger.getLog();</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">allocate</span><span class="params">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class="line"> <span class="number">6</span>:         List&lt;String&gt; cidAll) &#123;</div><div class="line"> <span class="number">7</span>:         <span class="comment">// æ ¡éªŒå‚æ•°æ˜¯å¦æ­£ç¡®</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (currentCID == <span class="keyword">null</span> || currentCID.length() &lt; <span class="number">1</span>) &#123;</div><div class="line"> <span class="number">9</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"currentCID is empty"</span>);</div><div class="line"><span class="number">10</span>:         &#125;</div><div class="line"><span class="number">11</span>:         <span class="keyword">if</span> (mqAll == <span class="keyword">null</span> || mqAll.isEmpty()) &#123;</div><div class="line"><span class="number">12</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"mqAll is null or mqAll empty"</span>);</div><div class="line"><span class="number">13</span>:         &#125;</div><div class="line"><span class="number">14</span>:         <span class="keyword">if</span> (cidAll == <span class="keyword">null</span> || cidAll.isEmpty()) &#123;</div><div class="line"><span class="number">15</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"cidAll is null or cidAll empty"</span>);</div><div class="line"><span class="number">16</span>:         &#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:         List&lt;MessageQueue&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="number">19</span>:         <span class="keyword">if</span> (!cidAll.contains(currentCID)) &#123;</div><div class="line"><span class="number">20</span>:             log.info(<span class="string">"[BUG] ConsumerGroup: &#123;&#125; The consumerId: &#123;&#125; not in cidAll: &#123;&#125;"</span>,</div><div class="line"><span class="number">21</span>:                 consumerGroup,</div><div class="line"><span class="number">22</span>:                 currentCID,</div><div class="line"><span class="number">23</span>:                 cidAll);</div><div class="line"><span class="number">24</span>:             <span class="keyword">return</span> result;</div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>:         <span class="comment">// å¹³å‡åˆ†é…</span></div><div class="line"><span class="number">27</span>:         <span class="keyword">int</span> index = cidAll.indexOf(currentCID); <span class="comment">// ç¬¬å‡ ä¸ªconsumerã€‚</span></div><div class="line"><span class="number">28</span>:         <span class="keyword">int</span> mod = mqAll.size() % cidAll.size(); <span class="comment">// ä½™æ•°ï¼Œå³å¤šå°‘æ¶ˆæ¯é˜Ÿåˆ—æ— æ³•å¹³å‡åˆ†é…ã€‚</span></div><div class="line"><span class="number">29</span>:         <span class="keyword">int</span> averageSize =</div><div class="line"><span class="number">30</span>:             mqAll.size() &lt;= cidAll.size() ? <span class="number">1</span> : (mod &gt; <span class="number">0</span> &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size()</div><div class="line"><span class="number">31</span>:                 + <span class="number">1</span> : mqAll.size() / cidAll.size());</div><div class="line"><span class="number">32</span>:         <span class="keyword">int</span> startIndex = (mod &gt; <span class="number">0</span> &amp;&amp; index &lt; mod) ? index * averageSize : index * averageSize + mod; <span class="comment">// æœ‰ä½™æ•°çš„æƒ…å†µä¸‹ï¼Œ[0, mod) å¹³åˆ†ä½™æ•°ï¼Œå³æ¯consumerå¤šåˆ†é…ä¸€ä¸ªèŠ‚ç‚¹ï¼›ç¬¬indexå¼€å§‹ï¼Œè·³è¿‡å‰modä½™æ•°ã€‚</span></div><div class="line"><span class="number">33</span>:         <span class="keyword">int</span> range = Math.min(averageSize, mqAll.size() - startIndex); <span class="comment">// åˆ†é…é˜Ÿåˆ—æ•°é‡ã€‚ä¹‹æ‰€ä»¥è¦Math.min()çš„åŸå› æ˜¯ï¼ŒmqAll.size() &lt;= cidAll.size()ï¼Œéƒ¨åˆ†consumeråˆ†é…ä¸åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚</span></div><div class="line"><span class="number">34</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; range; i++) &#123;</div><div class="line"><span class="number">35</span>:             result.add(mqAll.get((startIndex + i) % mqAll.size()));</div><div class="line"><span class="number">36</span>:         &#125;</div><div class="line"><span class="number">37</span>:         <span class="keyword">return</span> result;</div><div class="line"><span class="number">38</span>:     &#125;</div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">41</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">42</span>:         <span class="keyword">return</span> <span class="string">"AVG"</span>;</div><div class="line"><span class="number">43</span>:     &#125;</div><div class="line"><span class="number">44</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼š<strong>å¹³å‡</strong>åˆ†é…é˜Ÿåˆ—ç­–ç•¥ã€‚</li>
<li>ç¬¬ 7 è‡³ 25 è¡Œ ï¼šå‚æ•°æ ¡éªŒã€‚</li>
<li>ç¬¬ 26 è‡³ 36 è¡Œ ï¼šå¹³å‡åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚
<ul>
<li>ç¬¬ 27 è¡Œ ï¼š<code>index</code> ï¼šå½“å‰ <code>Consumer</code> åœ¨æ¶ˆè´¹é›†ç¾¤é‡Œæ˜¯ç¬¬å‡ ä¸ªã€‚è¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦å¯¹ä¼ å…¥çš„ <code>cidAll</code> å‚æ•°å¿…é¡»è¿›è¡Œæ’åºçš„åŸå› ã€‚å¦‚æœä¸æ’åºï¼Œ<code>Consumer</code> åœ¨æœ¬åœ°è®¡ç®—å‡ºæ¥çš„ <code>index</code> æ— æ³•ä¸€è‡´ï¼Œå½±å“è®¡ç®—ç»“æœã€‚</li>
<li>ç¬¬ 28 è¡Œ ï¼š<code>mod</code> ï¼šä½™æ•°ï¼Œå³å¤šå°‘æ¶ˆæ¯é˜Ÿåˆ—æ— æ³•å¹³å‡åˆ†é…ã€‚</li>
<li>ç¬¬ 29 è‡³ 31 è¡Œ ï¼š<code>averageSize</code> ï¼šä»£ç å¯ä»¥ç®€åŒ–æˆ <code>(mod &gt; 0 &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size() + 1 : mqAll.size() / cidAll.size())</code>ã€‚
<ul>
<li><code>[ 0, mod )</code> ï¼š<code>mqAll.size() / cidAll.size() + 1</code>ã€‚å‰é¢ <code>mod</code> ä¸ª <code>Consumer</code> å¹³åˆ†ä½™æ•°ï¼Œå¤šè·å¾— 1 ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
<li><code>[ mod, cidAll.size() )</code> ï¼š<code>mqAll.size() / cidAll.size()</code>ã€‚</li>
</ul>
</li>
<li>ç¬¬ 32 è¡Œ ï¼š<code>startIndex</code> ï¼š<code>Consumer</code> åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—å¼€å§‹ä½ç½®ã€‚</li>
<li>ç¬¬ 33 è¡Œ ï¼š<code>range</code> ï¼šåˆ†é…é˜Ÿåˆ—æ•°é‡ã€‚ä¹‹æ‰€ä»¥è¦ <code>Math#min(...)</code> çš„åŸå› ï¼šå½“ <code>mqAll.size() &lt;= cidAll.size()</code> æ—¶ï¼Œæœ€åå‡ ä¸ª <code>Consumer</code> åˆ†é…ä¸åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
<li>ç¬¬ 34 è‡³ 36 è¡Œ ï¼šç”Ÿæˆåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç»“æœã€‚</li>
</ul>
</li>
<li>ä¸¾ä¸ªä¾‹å­ï¼š</li>
</ul>
<p>å›ºå®šæ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦ä¸º<strong>4</strong>ã€‚</p>
<table>
<thead>
<tr>
<th></th>
<th>Consumer * 2 <em>å¯ä»¥æ•´é™¤</em></th>
<th>Consumer * 3 <em>ä¸å¯æ•´é™¤</em></th>
<th>Consumer * 5 <em>æ— æ³•éƒ½åˆ†é…</em></th>
</tr>
</thead>
<tbody>
<tr>
<td>æ¶ˆæ¯é˜Ÿåˆ—[0]</td>
<td>Consumer[0]</td>
<td>Consumer[0]</td>
<td>Consumer[0]</td>
</tr>
<tr>
<td>æ¶ˆæ¯é˜Ÿåˆ—[1]</td>
<td>Consumer[0]</td>
<td>Consumer[0]</td>
<td>Consumer[1]</td>
</tr>
<tr>
<td>æ¶ˆæ¯é˜Ÿåˆ—[2]</td>
<td>Consumer[1]</td>
<td>Consumer[1]</td>
<td>Consumer[2]</td>
</tr>
<tr>
<td>æ¶ˆæ¯é˜Ÿåˆ—[3]</td>
<td>Consumer[1]</td>
<td>Consumer[2]</td>
<td>Consumer[3]</td>
</tr>
</tbody>
</table>
<h4>AllocateMessageQueueByMachineRoom</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllocateMessageQueueByMachineRoom</span> <span class="keyword">implements</span> <span class="title">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">/**</span></div><div class="line"> 3:      * æ¶ˆè´¹è€…æ¶ˆè´¹brokerNameé›†åˆ</div><div class="line"> 4:      */</div><div class="line"> <span class="number">5</span>:     <span class="keyword">private</span> Set&lt;String&gt; consumeridcs;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">8</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">allocate</span><span class="params">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class="line"> <span class="number">9</span>:         List&lt;String&gt; cidAll) &#123;</div><div class="line"><span class="number">10</span>:         <span class="comment">// å‚æ•°æ ¡éªŒ</span></div><div class="line"><span class="number">11</span>:         List&lt;MessageQueue&gt; result = <span class="keyword">new</span> ArrayList&lt;MessageQueue&gt;();</div><div class="line"><span class="number">12</span>:         <span class="keyword">int</span> currentIndex = cidAll.indexOf(currentCID);</div><div class="line"><span class="number">13</span>:         <span class="keyword">if</span> (currentIndex &lt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">14</span>:             <span class="keyword">return</span> result;</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>:         <span class="comment">// è®¡ç®—ç¬¦åˆå½“å‰é…ç½®çš„æ¶ˆè´¹è€…æ•°ç»„('consumeridcs')å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"><span class="number">17</span>:         List&lt;MessageQueue&gt; premqAll = <span class="keyword">new</span> ArrayList&lt;MessageQueue&gt;();</div><div class="line"><span class="number">18</span>:         <span class="keyword">for</span> (MessageQueue mq : mqAll) &#123;</div><div class="line"><span class="number">19</span>:             String[] temp = mq.getBrokerName().split(<span class="string">"@"</span>);</div><div class="line"><span class="number">20</span>:             <span class="keyword">if</span> (temp.length == <span class="number">2</span> &amp;&amp; consumeridcs.contains(temp[<span class="number">0</span>])) &#123;</div><div class="line"><span class="number">21</span>:                 premqAll.add(mq);</div><div class="line"><span class="number">22</span>:             &#125;</div><div class="line"><span class="number">23</span>:         &#125;</div><div class="line"><span class="number">24</span>:         <span class="comment">// å¹³å‡åˆ†é…</span></div><div class="line"><span class="number">25</span>:         <span class="keyword">int</span> mod = premqAll.size() / cidAll.size();</div><div class="line"><span class="number">26</span>:         <span class="keyword">int</span> rem = premqAll.size() % cidAll.size();</div><div class="line"><span class="number">27</span>:         <span class="keyword">int</span> startIndex = mod * currentIndex;</div><div class="line"><span class="number">28</span>:         <span class="keyword">int</span> endIndex = startIndex + mod;</div><div class="line"><span class="number">29</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; endIndex; i++) &#123;</div><div class="line"><span class="number">30</span>:             result.add(mqAll.get(i));</div><div class="line"><span class="number">31</span>:         &#125;</div><div class="line"><span class="number">32</span>:         <span class="keyword">if</span> (rem &gt; currentIndex) &#123;</div><div class="line"><span class="number">33</span>:             result.add(premqAll.get(currentIndex + mod * cidAll.size()));</div><div class="line"><span class="number">34</span>:         &#125;</div><div class="line"><span class="number">35</span>:         <span class="keyword">return</span> result;</div><div class="line"><span class="number">36</span>:     &#125;</div><div class="line"><span class="number">37</span>: </div><div class="line"><span class="number">38</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">39</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">40</span>:         <span class="keyword">return</span> <span class="string">"MACHINE_ROOM"</span>;</div><div class="line"><span class="number">41</span>:     &#125;</div><div class="line"><span class="number">42</span>: </div><div class="line"><span class="number">43</span>:     <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getConsumeridcs</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">44</span>:         <span class="keyword">return</span> consumeridcs;</div><div class="line"><span class="number">45</span>:     &#125;</div><div class="line"><span class="number">46</span>: </div><div class="line"><span class="number">47</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConsumeridcs</span><span class="params">(Set&lt;String&gt; consumeridcs)</span> </span>&#123;</div><div class="line"><span class="number">48</span>:         <span class="keyword">this</span>.consumeridcs = consumeridcs;</div><div class="line"><span class="number">49</span>:     &#125;</div><div class="line"><span class="number">50</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼š<strong>å¹³å‡</strong>åˆ†é…<strong>å¯æ¶ˆè´¹çš„</strong> <code>Broker</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
<li>ç¬¬ 7 è‡³ 15 è¡Œ ï¼šå‚æ•°æ ¡éªŒã€‚</li>
<li>ç¬¬ 16 è‡³ 23 è¡Œ ï¼šè®¡ç®—<strong>å¯æ¶ˆè´¹çš„</strong> <code>Broker</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
<li>ç¬¬ 25 è‡³ 34 è¡Œ ï¼šå¹³å‡åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¥<strong>å¹³å‡åˆ†é…</strong>æ–¹å¼å’Œ <code>AllocateMessageQueueAveragely</code> ç•¥æœ‰ä¸åŒï¼Œå…¶æ˜¯å°†å¤šä½™çš„ç»“å°¾éƒ¨åˆ†åˆ†é…ç»™å‰ <code>rem</code> ä¸ª <code>Consumer</code>ã€‚</li>
<li>ç–‘é—®ï¼š<em>ä½¿ç”¨è¯¥åˆ†é…ç­–ç•¥æ—¶ï¼Œ<code>Consumer</code> å’Œ <code>Broker</code> åˆ†é…éœ€è¦æ€ä¹ˆé…ç½®</em>ã€‚ğŸ˜ˆç­‰ç ”ç©¶<strong>ä¸»ä»</strong>ç›¸å…³æºç æ—¶ï¼Œä»”ç»†è€ƒè™‘ä¸‹ã€‚</li>
</ul>
<h4>AllocateMessageQueueAveragelyByCircle</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllocateMessageQueueAveragelyByCircle</span> <span class="keyword">implements</span> <span class="title">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Logger log = ClientLogger.getLog();</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">allocate</span><span class="params">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class="line"> <span class="number">6</span>:         List&lt;String&gt; cidAll) &#123;</div><div class="line"> <span class="number">7</span>:         <span class="comment">// æ ¡éªŒå‚æ•°æ˜¯å¦æ­£ç¡®</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (currentCID == <span class="keyword">null</span> || currentCID.length() &lt; <span class="number">1</span>) &#123;</div><div class="line"> <span class="number">9</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"currentCID is empty"</span>);</div><div class="line"><span class="number">10</span>:         &#125;</div><div class="line"><span class="number">11</span>:         <span class="keyword">if</span> (mqAll == <span class="keyword">null</span> || mqAll.isEmpty()) &#123;</div><div class="line"><span class="number">12</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"mqAll is null or mqAll empty"</span>);</div><div class="line"><span class="number">13</span>:         &#125;</div><div class="line"><span class="number">14</span>:         <span class="keyword">if</span> (cidAll == <span class="keyword">null</span> || cidAll.isEmpty()) &#123;</div><div class="line"><span class="number">15</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"cidAll is null or cidAll empty"</span>);</div><div class="line"><span class="number">16</span>:         &#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:         List&lt;MessageQueue&gt; result = <span class="keyword">new</span> ArrayList&lt;MessageQueue&gt;();</div><div class="line"><span class="number">19</span>:         <span class="keyword">if</span> (!cidAll.contains(currentCID)) &#123;</div><div class="line"><span class="number">20</span>:             log.info(<span class="string">"[BUG] ConsumerGroup: &#123;&#125; The consumerId: &#123;&#125; not in cidAll: &#123;&#125;"</span>,</div><div class="line"><span class="number">21</span>:                 consumerGroup,</div><div class="line"><span class="number">22</span>:                 currentCID,</div><div class="line"><span class="number">23</span>:                 cidAll);</div><div class="line"><span class="number">24</span>:             <span class="keyword">return</span> result;</div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:         <span class="comment">// ç¯çŠ¶åˆ†é…</span></div><div class="line"><span class="number">28</span>:         <span class="keyword">int</span> index = cidAll.indexOf(currentCID);</div><div class="line"><span class="number">29</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = index; i &lt; mqAll.size(); i++) &#123;</div><div class="line"><span class="number">30</span>:             <span class="keyword">if</span> (i % cidAll.size() == index) &#123;</div><div class="line"><span class="number">31</span>:                 result.add(mqAll.get(i));</div><div class="line"><span class="number">32</span>:             &#125;</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:         <span class="keyword">return</span> result;</div><div class="line"><span class="number">35</span>:     &#125;</div><div class="line"><span class="number">36</span>: </div><div class="line"><span class="number">37</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">38</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">39</span>:         <span class="keyword">return</span> <span class="string">"AVG_BY_CIRCLE"</span>;</div><div class="line"><span class="number">40</span>:     &#125;</div><div class="line"><span class="number">41</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šç¯çŠ¶åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
</ul>
<h4>AllocateMessageQueueByConfig</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllocateMessageQueueByConfig</span> <span class="keyword">implements</span> <span class="title">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> List&lt;MessageQueue&gt; messageQueueList;</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">allocate</span><span class="params">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class="line"> <span class="number">6</span>:         List&lt;String&gt; cidAll) &#123;</div><div class="line"> <span class="number">7</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.messageQueueList;</div><div class="line"> <span class="number">8</span>:     &#125;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">11</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">12</span>:         <span class="keyword">return</span> <span class="string">"CONFIG"</span>;</div><div class="line"><span class="number">13</span>:     &#125;</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">getMessageQueueList</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">16</span>:         <span class="keyword">return</span> messageQueueList;</div><div class="line"><span class="number">17</span>:     &#125;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMessageQueueList</span><span class="params">(List&lt;MessageQueue&gt; messageQueueList)</span> </span>&#123;</div><div class="line"><span class="number">20</span>:         <span class="keyword">this</span>.messageQueueList = messageQueueList;</div><div class="line"><span class="number">21</span>:     &#125;</div><div class="line"><span class="number">22</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šåˆ†é…<strong>é…ç½®çš„</strong>æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
<li>ç–‘é—® ï¼š<em>è¯¥åˆ†é…ç­–ç•¥çš„ä½¿ç”¨åœºæ™¯ã€‚</em></li>
</ul>
<h1>5ã€PushConsumer æ¶ˆè´¹è¿›åº¦è¯»å–</h1>
<h2>RebalancePushImpl#computePullFromWhere(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">computePullFromWhere</span><span class="params">(MessageQueue mq)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">long</span> result = -<span class="number">1</span>;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">final</span> ConsumeFromWhere consumeFromWhere = <span class="keyword">this</span>.defaultMQPushConsumerImpl.getDefaultMQPushConsumer().getConsumeFromWhere();</div><div class="line"> <span class="number">4</span>:     <span class="keyword">final</span> OffsetStore offsetStore = <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore();</div><div class="line"> <span class="number">5</span>:     <span class="keyword">switch</span> (consumeFromWhere) &#123;</div><div class="line"> <span class="number">6</span>:         <span class="keyword">case</span> CONSUME_FROM_LAST_OFFSET_AND_FROM_MIN_WHEN_BOOT_FIRST: <span class="comment">// åºŸå¼ƒ</span></div><div class="line"> <span class="number">7</span>:         <span class="keyword">case</span> CONSUME_FROM_MIN_OFFSET: <span class="comment">// åºŸå¼ƒ</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">case</span> CONSUME_FROM_MAX_OFFSET: <span class="comment">// åºŸå¼ƒ</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">case</span> CONSUME_FROM_LAST_OFFSET: &#123;</div><div class="line"><span class="number">10</span>:             <span class="keyword">long</span> lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);</div><div class="line"><span class="number">11</span>:             <span class="keyword">if</span> (lastOffset &gt;= <span class="number">0</span>) &#123;</div><div class="line"><span class="number">12</span>:                 result = lastOffset;</div><div class="line"><span class="number">13</span>:             &#125;</div><div class="line"><span class="number">14</span>:             <span class="comment">// First start,no offset</span></div><div class="line"><span class="number">15</span>:             <span class="keyword">else</span> <span class="keyword">if</span> (-<span class="number">1</span> == lastOffset) &#123;</div><div class="line"><span class="number">16</span>:                 <span class="keyword">if</span> (mq.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class="line"><span class="number">17</span>:                     result = <span class="number">0L</span>;</div><div class="line"><span class="number">18</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">19</span>:                     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">20</span>:                         result = <span class="keyword">this</span>.mQClientFactory.getMQAdminImpl().maxOffset(mq);</div><div class="line"><span class="number">21</span>:                     &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</div><div class="line"><span class="number">22</span>:                         result = -<span class="number">1</span>;</div><div class="line"><span class="number">23</span>:                     &#125;</div><div class="line"><span class="number">24</span>:                 &#125;</div><div class="line"><span class="number">25</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">26</span>:                 result = -<span class="number">1</span>;</div><div class="line"><span class="number">27</span>:             &#125;</div><div class="line"><span class="number">28</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">29</span>:         &#125;</div><div class="line"><span class="number">30</span>:         <span class="keyword">case</span> CONSUME_FROM_FIRST_OFFSET: &#123;</div><div class="line"><span class="number">31</span>:             <span class="keyword">long</span> lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);</div><div class="line"><span class="number">32</span>:             <span class="keyword">if</span> (lastOffset &gt;= <span class="number">0</span>) &#123;</div><div class="line"><span class="number">33</span>:                 result = lastOffset;</div><div class="line"><span class="number">34</span>:             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (-<span class="number">1</span> == lastOffset) &#123;</div><div class="line"><span class="number">35</span>:                 result = <span class="number">0L</span>;</div><div class="line"><span class="number">36</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">37</span>:                 result = -<span class="number">1</span>;</div><div class="line"><span class="number">38</span>:             &#125;</div><div class="line"><span class="number">39</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">40</span>:         &#125;</div><div class="line"><span class="number">41</span>:         <span class="keyword">case</span> CONSUME_FROM_TIMESTAMP: &#123;</div><div class="line"><span class="number">42</span>:             <span class="keyword">long</span> lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);</div><div class="line"><span class="number">43</span>:             <span class="keyword">if</span> (lastOffset &gt;= <span class="number">0</span>) &#123;</div><div class="line"><span class="number">44</span>:                 result = lastOffset;</div><div class="line"><span class="number">45</span>:             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (-<span class="number">1</span> == lastOffset) &#123;</div><div class="line"><span class="number">46</span>:                 <span class="keyword">if</span> (mq.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class="line"><span class="number">47</span>:                     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">48</span>:                         result = <span class="keyword">this</span>.mQClientFactory.getMQAdminImpl().maxOffset(mq);</div><div class="line"><span class="number">49</span>:                     &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</div><div class="line"><span class="number">50</span>:                         result = -<span class="number">1</span>;</div><div class="line"><span class="number">51</span>:                     &#125;</div><div class="line"><span class="number">52</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">53</span>:                     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">54</span>:                         <span class="keyword">long</span> timestamp = UtilAll.parseDate(<span class="keyword">this</span>.defaultMQPushConsumerImpl.getDefaultMQPushConsumer().getConsumeTimestamp(),</div><div class="line"><span class="number">55</span>:                             UtilAll.YYYY_MMDD_HHMMSS).getTime();</div><div class="line"><span class="number">56</span>:                         result = <span class="keyword">this</span>.mQClientFactory.getMQAdminImpl().searchOffset(mq, timestamp);</div><div class="line"><span class="number">57</span>:                     &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</div><div class="line"><span class="number">58</span>:                         result = -<span class="number">1</span>;</div><div class="line"><span class="number">59</span>:                     &#125;</div><div class="line"><span class="number">60</span>:                 &#125;</div><div class="line"><span class="number">61</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">62</span>:                 result = -<span class="number">1</span>;</div><div class="line"><span class="number">63</span>:             &#125;</div><div class="line"><span class="number">64</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">65</span>:         &#125;</div><div class="line"><span class="number">66</span>: </div><div class="line"><span class="number">67</span>:         <span class="keyword">default</span>:</div><div class="line"><span class="number">68</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">69</span>:     &#125;</div><div class="line"><span class="number">70</span>: </div><div class="line"><span class="number">71</span>:     <span class="keyword">return</span> result;</div><div class="line"><span class="number">72</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šè®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—å¼€å§‹æ¶ˆè´¹ä½ç½®ã€‚</li>
<li><code>PushConsumer</code> è¯»å–æ¶ˆè´¹è¿›åº¦æœ‰ä¸‰ç§é€‰é¡¹ï¼š
<ul>
<li><code>CONSUME_FROM_LAST_OFFSET</code> ï¼šç¬¬ 6 è‡³ 29 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»<strong>é˜Ÿåˆ—çš„æœ€åä½ç½®</strong>å¼€å§‹æ¶ˆè´¹ã€‚<strong>åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹</strong>ã€‚</li>
<li><code>CONSUME_FROM_FIRST_OFFSET</code> ï¼šç¬¬ 30 è‡³ 40 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»é˜Ÿåˆ—çš„<strong>æœ€å‰ä½ç½®</strong>å¼€å§‹æ¶ˆè´¹ã€‚<strong>åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹</strong>ã€‚</li>
<li><code>CONSUME_FROM_TIMESTAMP</code> ï¼šç¬¬ 41 è‡³ 65 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»<strong>æŒ‡å®šæ—¶é—´ç‚¹</strong>å¼€å§‹æ¶ˆè´¹ã€‚<strong>åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹</strong>ã€‚</li>
</ul>
</li>
</ul>
<h2><code>[PullConsumer]</code> RebalancePullImpl#computePullFromWhere(...)</h2>
<p>æš‚æ—¶è·³è¿‡ã€‚ğŸ˜ˆ</p>
<h1>6ã€PushConsumer æ‹‰å–æ¶ˆæ¯</h1>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/05.png" alt="DefaultMQPushConsumerImplæ‹‰å–æ¶ˆæ¯"></p>
<h2>PullMessageService</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PullMessageService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Logger log = ClientLogger.getLog();</div><div class="line">  <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line">  4:      * æ‹‰å–æ¶ˆæ¯è¯·æ±‚é˜Ÿåˆ—</div><div class="line">  5:      */</div><div class="line">  <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">final</span> LinkedBlockingQueue&lt;PullRequest&gt; pullRequestQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line">  <span class="number">7</span>:     <span class="comment">/**</span></div><div class="line">  8:      * MQClientå¯¹è±¡</div><div class="line">  9:      */</div><div class="line"> <span class="number">10</span>:     <span class="keyword">private</span> <span class="keyword">final</span> MQClientInstance mQClientFactory;</div><div class="line"> <span class="number">11</span>:     <span class="comment">/**</span></div><div class="line"> 12:      * å®šæ—¶å™¨ã€‚ç”¨äºå»¶è¿Ÿæäº¤æ‹‰å–è¯·æ±‚</div><div class="line"> 13:      */</div><div class="line"> <span class="number">14</span>:     <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduledExecutorService = Executors</div><div class="line"> <span class="number">15</span>:         .newSingleThreadScheduledExecutor(<span class="keyword">new</span> ThreadFactory() &#123;</div><div class="line"> <span class="number">16</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">17</span>:             <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line"> <span class="number">18</span>:                 <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">"PullMessageServiceScheduledThread"</span>);</div><div class="line"> <span class="number">19</span>:             &#125;</div><div class="line"> <span class="number">20</span>:         &#125;);</div><div class="line"> <span class="number">21</span>: </div><div class="line"> <span class="number">22</span>:     <span class="function"><span class="keyword">public</span> <span class="title">PullMessageService</span><span class="params">(MQClientInstance mQClientFactory)</span> </span>&#123;</div><div class="line"> <span class="number">23</span>:         <span class="keyword">this</span>.mQClientFactory = mQClientFactory;</div><div class="line"> <span class="number">24</span>:     &#125;</div><div class="line"> <span class="number">25</span>: </div><div class="line"> <span class="number">26</span>:     <span class="comment">/**</span></div><div class="line"> 27:      * æ‰§è¡Œå»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class="line"> 28:      *</div><div class="line"> 29:      * <span class="doctag">@param</span> pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class="line"> 30:      * <span class="doctag">@param</span> timeDelay å»¶è¿Ÿæ—¶é•¿</div><div class="line"> 31:      */</div><div class="line"> <span class="number">32</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executePullRequestLater</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest, <span class="keyword">final</span> <span class="keyword">long</span> timeDelay)</span> </span>&#123;</div><div class="line"> <span class="number">33</span>:         <span class="keyword">this</span>.scheduledExecutorService.schedule(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"> <span class="number">34</span>: </div><div class="line"> <span class="number">35</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">36</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">37</span>:                 PullMessageService.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"> <span class="number">38</span>:             &#125;</div><div class="line"> <span class="number">39</span>:         &#125;, timeDelay, TimeUnit.MILLISECONDS);</div><div class="line"> <span class="number">40</span>:     &#125;</div><div class="line"> <span class="number">41</span>: </div><div class="line"> <span class="number">42</span>:     <span class="comment">/**</span></div><div class="line"> 43:      * æ‰§è¡Œç«‹å³æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class="line"> 44:      *</div><div class="line"> 45:      * <span class="doctag">@param</span> pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class="line"> 46:      */</div><div class="line"> <span class="number">47</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executePullRequestImmediately</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class="line"> <span class="number">48</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">49</span>:             <span class="keyword">this</span>.pullRequestQueue.put(pullRequest);</div><div class="line"> <span class="number">50</span>:         &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"> <span class="number">51</span>:             log.error(<span class="string">"executePullRequestImmediately pullRequestQueue.put"</span>, e);</div><div class="line"> <span class="number">52</span>:         &#125;</div><div class="line"> <span class="number">53</span>:     &#125;</div><div class="line"> <span class="number">54</span>: </div><div class="line"> <span class="number">55</span>:     <span class="comment">/**</span></div><div class="line"> 56:      * æ‰§è¡Œå»¶è¿Ÿä»»åŠ¡</div><div class="line"> 57:      *</div><div class="line"> 58:      * <span class="doctag">@param</span> r ä»»åŠ¡</div><div class="line"> 59:      * <span class="doctag">@param</span> timeDelay å»¶è¿Ÿæ—¶é•¿</div><div class="line"> 60:      */</div><div class="line"> <span class="number">61</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeTaskLater</span><span class="params">(<span class="keyword">final</span> Runnable r, <span class="keyword">final</span> <span class="keyword">long</span> timeDelay)</span> </span>&#123;</div><div class="line"> <span class="number">62</span>:         <span class="keyword">this</span>.scheduledExecutorService.schedule(r, timeDelay, TimeUnit.MILLISECONDS);</div><div class="line"> <span class="number">63</span>:     &#125;</div><div class="line"> <span class="number">64</span>: </div><div class="line"> <span class="number">65</span>:     <span class="function"><span class="keyword">public</span> ScheduledExecutorService <span class="title">getScheduledExecutorService</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">66</span>:         <span class="keyword">return</span> scheduledExecutorService;</div><div class="line"> <span class="number">67</span>:     &#125;</div><div class="line"> <span class="number">68</span>: </div><div class="line"> <span class="number">69</span>:     <span class="comment">/**</span></div><div class="line"> 70:      * æ‹‰å–æ¶ˆæ¯</div><div class="line"> 71:      *</div><div class="line"> 72:      * <span class="doctag">@param</span> pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class="line"> 73:      */</div><div class="line"> <span class="number">74</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pullMessage</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class="line"> <span class="number">75</span>:         <span class="keyword">final</span> MQConsumerInner consumer = <span class="keyword">this</span>.mQClientFactory.selectConsumer(pullRequest.getConsumerGroup());</div><div class="line"> <span class="number">76</span>:         <span class="keyword">if</span> (consumer != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">77</span>:             DefaultMQPushConsumerImpl impl = (DefaultMQPushConsumerImpl) consumer;</div><div class="line"> <span class="number">78</span>:             impl.pullMessage(pullRequest);</div><div class="line"> <span class="number">79</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">80</span>:             log.warn(<span class="string">"No matched consumer for the PullRequest &#123;&#125;, drop it"</span>, pullRequest);</div><div class="line"> <span class="number">81</span>:         &#125;</div><div class="line"> <span class="number">82</span>:     &#125;</div><div class="line"> <span class="number">83</span>: </div><div class="line"> <span class="number">84</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">85</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">86</span>:         log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service started"</span>);</div><div class="line"> <span class="number">87</span>: </div><div class="line"> <span class="number">88</span>:         <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</div><div class="line"> <span class="number">89</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">90</span>:                 PullRequest pullRequest = <span class="keyword">this</span>.pullRequestQueue.take();</div><div class="line"> <span class="number">91</span>:                 <span class="keyword">if</span> (pullRequest != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">92</span>:                     <span class="keyword">this</span>.pullMessage(pullRequest);</div><div class="line"> <span class="number">93</span>:                 &#125;</div><div class="line"> <span class="number">94</span>:             &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"> <span class="number">95</span>:             &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">96</span>:                 log.error(<span class="string">"Pull Message Service Run Method exception"</span>, e);</div><div class="line"> <span class="number">97</span>:             &#125;</div><div class="line"> <span class="number">98</span>:         &#125;</div><div class="line"> <span class="number">99</span>: </div><div class="line"><span class="number">100</span>:         log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service end"</span>);</div><div class="line"><span class="number">101</span>:     &#125;</div><div class="line"><span class="number">102</span>: </div><div class="line"><span class="number">103</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">104</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getServiceName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">105</span>:         <span class="keyword">return</span> PullMessageService.class.getSimpleName();</div><div class="line"><span class="number">106</span>:     &#125;</div><div class="line"><span class="number">107</span>: </div><div class="line"><span class="number">108</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯æœåŠ¡ï¼Œä¸æ–­ä¸æ–­ä¸æ–­ä» <code>Broker</code> æ‹‰å–æ¶ˆæ¯ï¼Œå¹¶æäº¤æ¶ˆè´¹ä»»åŠ¡åˆ° <code>ConsumeMessageService</code>ã€‚</li>
<li><code>#executePullRequestLater(...)</code> ï¼šç¬¬ 26 è‡³ 40 è¡Œ ï¼š æäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>
<li><code>#executePullRequestImmediately(...)</code> ï¼šç¬¬ 42 è‡³ 53 è¡Œ ï¼šæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>
<li><code>#executeTaskLater(...)</code> ï¼šç¬¬ 55 è‡³ 63 è¡Œ ï¼šæäº¤<strong>å»¶è¿Ÿä»»åŠ¡</strong>ã€‚</li>
<li><code>#pullMessage(...)</code> ï¼šç¬¬ 69 è‡³ 82 è¡Œ ï¼šæ‰§è¡Œæ‹‰å–æ¶ˆæ¯é€»è¾‘ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#defaultmqpushconsumerimplpullmessage">DefaultMQPushConsumerImpl#pullMessage(...)</a>ã€‚</li>
<li><code>#run(...)</code> ï¼šç¬¬ 84 è‡³ 101 è¡Œ ï¼šå¾ªç¯æ‹‰å–æ¶ˆæ¯è¯·æ±‚é˜Ÿåˆ—( <code>pullRequestQueue</code> )ï¼Œè¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€‚</li>
</ul>
<h2>DefaultMQPushConsumerImpl#pullMessage(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pullMessage</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="keyword">final</span> ProcessQueue processQueue = pullRequest.getProcessQueue();</div><div class="line">  <span class="number">3</span>:     <span class="keyword">if</span> (processQueue.isDropped()) &#123;</div><div class="line">  <span class="number">4</span>:         log.info(<span class="string">"the pull request[&#123;&#125;] is dropped."</span>, pullRequest.toString());</div><div class="line">  <span class="number">5</span>:         <span class="keyword">return</span>;</div><div class="line">  <span class="number">6</span>:     &#125;</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:     <span class="comment">// è®¾ç½®é˜Ÿåˆ—æœ€åæ‹‰å–æ¶ˆæ¯æ—¶é—´</span></div><div class="line">  <span class="number">9</span>:     pullRequest.getProcessQueue().setLastPullTimestamp(System.currentTimeMillis());</div><div class="line"> <span class="number">10</span>: </div><div class="line"> <span class="number">11</span>:     <span class="comment">// åˆ¤æ–­consumerçŠ¶æ€æ˜¯å¦è¿è¡Œä¸­ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯ã€‚</span></div><div class="line"> <span class="number">12</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">13</span>:         <span class="keyword">this</span>.makeSureStateOK();</div><div class="line"> <span class="number">14</span>:     &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</div><div class="line"> <span class="number">15</span>:         log.warn(<span class="string">"pullMessage exception, consumer state not ok"</span>, e);</div><div class="line"> <span class="number">16</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"> <span class="number">17</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">18</span>:     &#125;</div><div class="line"> <span class="number">19</span>: </div><div class="line"> <span class="number">20</span>:     <span class="comment">// åˆ¤æ–­æ˜¯å¦æš‚åœä¸­ã€‚</span></div><div class="line"> <span class="number">21</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.isPause()) &#123;</div><div class="line"> <span class="number">22</span>:         log.warn(<span class="string">"consumer was paused, execute pull request later. instanceName=&#123;&#125;, group=&#123;&#125;"</span>, <span class="keyword">this</span>.defaultMQPushConsumer.getInstanceName(), <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup());</div><div class="line"> <span class="number">23</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_SUSPEND);</div><div class="line"> <span class="number">24</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">25</span>:     &#125;</div><div class="line"> <span class="number">26</span>: </div><div class="line"> <span class="number">27</span>:     <span class="comment">// åˆ¤æ–­æ˜¯å¦è¶…è¿‡æœ€å¤§æŒæœ‰æ¶ˆæ¯æ•°é‡ã€‚é»˜è®¤æœ€å¤§å€¼ä¸º1000ã€‚</span></div><div class="line"> <span class="number">28</span>:     <span class="keyword">long</span> size = processQueue.getMsgCount().get();</div><div class="line"> <span class="number">29</span>:     <span class="keyword">if</span> (size &gt; <span class="keyword">this</span>.defaultMQPushConsumer.getPullThresholdForQueue()) &#123;</div><div class="line"> <span class="number">30</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL); <span class="comment">// æäº¤å»¶è¿Ÿæ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚50msã€‚</span></div><div class="line"> <span class="number">31</span>:         <span class="keyword">if</span> ((flowControlTimes1++ % <span class="number">1000</span>) == <span class="number">0</span>) &#123;</div><div class="line"> <span class="number">32</span>:             log.warn(</div><div class="line"> <span class="number">33</span>:                 <span class="string">"the consumer message buffer is full, so do flow control, minOffset=&#123;&#125;, maxOffset=&#123;&#125;, size=&#123;&#125;, pullRequest=&#123;&#125;, flowControlTimes=&#123;&#125;"</span>,</div><div class="line"> <span class="number">34</span>:                 processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), size, pullRequest, flowControlTimes1);</div><div class="line"> <span class="number">35</span>:         &#125;</div><div class="line"> <span class="number">36</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">37</span>:     &#125;</div><div class="line"> <span class="number">38</span>: </div><div class="line"> <span class="number">39</span>:     <span class="keyword">if</span> (!<span class="keyword">this</span>.consumeOrderly) &#123; <span class="comment">// åˆ¤æ–­æ¶ˆæ¯è·¨åº¦æ˜¯å¦è¿‡å¤§ã€‚</span></div><div class="line"> <span class="number">40</span>:         <span class="keyword">if</span> (processQueue.getMaxSpan() &gt; <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeConcurrentlyMaxSpan()) &#123;</div><div class="line"> <span class="number">41</span>:             <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL); <span class="comment">// æäº¤å»¶è¿Ÿæ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚50msã€‚</span></div><div class="line"> <span class="number">42</span>:             <span class="keyword">if</span> ((flowControlTimes2++ % <span class="number">1000</span>) == <span class="number">0</span>) &#123;</div><div class="line"> <span class="number">43</span>:                 log.warn(</div><div class="line"> <span class="number">44</span>:                     <span class="string">"the queue's messages, span too long, so do flow control, minOffset=&#123;&#125;, maxOffset=&#123;&#125;, maxSpan=&#123;&#125;, pullRequest=&#123;&#125;, flowControlTimes=&#123;&#125;"</span>,</div><div class="line"> <span class="number">45</span>:                     processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), processQueue.getMaxSpan(),</div><div class="line"> <span class="number">46</span>:                     pullRequest, flowControlTimes2);</div><div class="line"> <span class="number">47</span>:             &#125;</div><div class="line"> <span class="number">48</span>:             <span class="keyword">return</span>;</div><div class="line"> <span class="number">49</span>:         &#125;</div><div class="line"> <span class="number">50</span>:     &#125; <span class="keyword">else</span> &#123; <span class="comment">// TODO é¡ºåºæ¶ˆè´¹</span></div><div class="line"> <span class="number">51</span>:         <span class="keyword">if</span> (processQueue.isLocked()) &#123;</div><div class="line"> <span class="number">52</span>:             <span class="keyword">if</span> (!pullRequest.isLockedFirst()) &#123;</div><div class="line"> <span class="number">53</span>:                 <span class="keyword">final</span> <span class="keyword">long</span> offset = <span class="keyword">this</span>.rebalanceImpl.computePullFromWhere(pullRequest.getMessageQueue());</div><div class="line"> <span class="number">54</span>:                 <span class="keyword">boolean</span> brokerBusy = offset &lt; pullRequest.getNextOffset();</div><div class="line"> <span class="number">55</span>:                 log.info(<span class="string">"the first time to pull message, so fix offset from broker. pullRequest: &#123;&#125; NewOffset: &#123;&#125; brokerBusy: &#123;&#125;"</span>,</div><div class="line"> <span class="number">56</span>:                     pullRequest, offset, brokerBusy);</div><div class="line"> <span class="number">57</span>:                 <span class="keyword">if</span> (brokerBusy) &#123;</div><div class="line"> <span class="number">58</span>:                     log.info(<span class="string">"[NOTIFYME]the first time to pull message, but pull request offset larger than broker consume offset. pullRequest: &#123;&#125; NewOffset: &#123;&#125;"</span>,</div><div class="line"> <span class="number">59</span>:                         pullRequest, offset);</div><div class="line"> <span class="number">60</span>:                 &#125;</div><div class="line"> <span class="number">61</span>: </div><div class="line"> <span class="number">62</span>:                 pullRequest.setLockedFirst(<span class="keyword">true</span>);</div><div class="line"> <span class="number">63</span>:                 pullRequest.setNextOffset(offset);</div><div class="line"> <span class="number">64</span>:             &#125;</div><div class="line"> <span class="number">65</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">66</span>:             <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"> <span class="number">67</span>:             log.info(<span class="string">"pull message later because not locked in broker, &#123;&#125;"</span>, pullRequest);</div><div class="line"> <span class="number">68</span>:             <span class="keyword">return</span>;</div><div class="line"> <span class="number">69</span>:         &#125;</div><div class="line"> <span class="number">70</span>:     &#125;</div><div class="line"> <span class="number">71</span>: </div><div class="line"> <span class="number">72</span>:     <span class="comment">// è·å–Topic å¯¹åº”çš„è®¢é˜…ä¿¡æ¯ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯</span></div><div class="line"> <span class="number">73</span>:     <span class="keyword">final</span> SubscriptionData subscriptionData = <span class="keyword">this</span>.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());</div><div class="line"> <span class="number">74</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == subscriptionData) &#123;</div><div class="line"> <span class="number">75</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"> <span class="number">76</span>:         log.warn(<span class="string">"find the consumer's subscription failed, &#123;&#125;"</span>, pullRequest);</div><div class="line"> <span class="number">77</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">78</span>:     &#125;</div><div class="line"> <span class="number">79</span>: </div><div class="line"> <span class="number">80</span>:     <span class="keyword">final</span> <span class="keyword">long</span> beginTimestamp = System.currentTimeMillis();</div><div class="line"> <span class="number">81</span>: </div><div class="line"> <span class="number">82</span>:     PullCallback pullCallback = <span class="keyword">new</span> PullCallback() &#123;</div><div class="line"> <span class="number">83</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">84</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(PullResult pullResult)</span> </span>&#123;</div><div class="line"> <span class="number">85</span>:             <span class="keyword">if</span> (pullResult != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">86</span>:                 pullResult = DefaultMQPushConsumerImpl.<span class="keyword">this</span>.pullAPIWrapper.processPullResult(pullRequest.getMessageQueue(), pullResult,</div><div class="line"> <span class="number">87</span>:                     subscriptionData);</div><div class="line"> <span class="number">88</span>: </div><div class="line"> <span class="number">89</span>:                 <span class="keyword">switch</span> (pullResult.getPullStatus()) &#123;</div><div class="line"> <span class="number">90</span>:                     <span class="keyword">case</span> FOUND:</div><div class="line"> <span class="number">91</span>:                         <span class="comment">// è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</span></div><div class="line"> <span class="number">92</span>:                         <span class="keyword">long</span> prevRequestOffset = pullRequest.getNextOffset();</div><div class="line"> <span class="number">93</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class="line"> <span class="number">94</span>: </div><div class="line"> <span class="number">95</span>:                         <span class="comment">// ç»Ÿè®¡</span></div><div class="line"> <span class="number">96</span>:                         <span class="keyword">long</span> pullRT = System.currentTimeMillis() - beginTimestamp;</div><div class="line"> <span class="number">97</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.getConsumerStatsManager().incPullRT(pullRequest.getConsumerGroup(),</div><div class="line"> <span class="number">98</span>:                             pullRequest.getMessageQueue().getTopic(), pullRT);</div><div class="line"> <span class="number">99</span>: </div><div class="line"><span class="number">100</span>:                         <span class="keyword">long</span> firstMsgOffset = Long.MAX_VALUE;</div><div class="line"><span class="number">101</span>:                         <span class="keyword">if</span> (pullResult.getMsgFoundList() == <span class="keyword">null</span> || pullResult.getMsgFoundList().isEmpty()) &#123;</div><div class="line"><span class="number">102</span>:                             DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">103</span>:                         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">104</span>:                             firstMsgOffset = pullResult.getMsgFoundList().get(<span class="number">0</span>).getQueueOffset();</div><div class="line"><span class="number">105</span>: </div><div class="line"><span class="number">106</span>:                             <span class="comment">// ç»Ÿè®¡</span></div><div class="line"><span class="number">107</span>:                             DefaultMQPushConsumerImpl.<span class="keyword">this</span>.getConsumerStatsManager().incPullTPS(pullRequest.getConsumerGroup(),</div><div class="line"><span class="number">108</span>:                                 pullRequest.getMessageQueue().getTopic(), pullResult.getMsgFoundList().size());</div><div class="line"><span class="number">109</span>: </div><div class="line"><span class="number">110</span>:                             <span class="comment">// æäº¤æ‹‰å–åˆ°çš„æ¶ˆæ¯åˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</span></div><div class="line"><span class="number">111</span>:                             <span class="keyword">boolean</span> dispathToConsume = processQueue.putMessage(pullResult.getMsgFoundList());</div><div class="line"><span class="number">112</span>: </div><div class="line"><span class="number">113</span>:                             <span class="comment">// æäº¤æ¶ˆè´¹è¯·æ±‚</span></div><div class="line"><span class="number">114</span>:                             DefaultMQPushConsumerImpl.<span class="keyword">this</span>.consumeMessageService.submitConsumeRequest(<span class="comment">//</span></div><div class="line"><span class="number">115</span>:                                 pullResult.getMsgFoundList(), <span class="comment">//</span></div><div class="line"><span class="number">116</span>:                                 processQueue, <span class="comment">//</span></div><div class="line"><span class="number">117</span>:                                 pullRequest.getMessageQueue(), <span class="comment">//</span></div><div class="line"><span class="number">118</span>:                                 dispathToConsume);</div><div class="line"><span class="number">119</span>: </div><div class="line"><span class="number">120</span>:                             <span class="comment">// æäº¤ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯è¯·æ±‚</span></div><div class="line"><span class="number">121</span>:                             <span class="keyword">if</span> (DefaultMQPushConsumerImpl.<span class="keyword">this</span>.defaultMQPushConsumer.getPullInterval() &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">122</span>:                                 DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestLater(pullRequest,</div><div class="line"><span class="number">123</span>:                                     DefaultMQPushConsumerImpl.<span class="keyword">this</span>.defaultMQPushConsumer.getPullInterval());</div><div class="line"><span class="number">124</span>:                             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">125</span>:                                 DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">126</span>:                             &#125;</div><div class="line"><span class="number">127</span>:                         &#125;</div><div class="line"><span class="number">128</span>: </div><div class="line"><span class="number">129</span>:                         <span class="comment">// ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½® æˆ–è€… ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼Œåˆ™åˆ¤å®šä¸ºBUGï¼Œè¾“å‡ºlog</span></div><div class="line"><span class="number">130</span>:                         <span class="keyword">if</span> (pullResult.getNextBeginOffset() &lt; prevRequestOffset<span class="comment">//</span></div><div class="line"><span class="number">131</span>:                             || firstMsgOffset &lt; prevRequestOffset) &#123;</div><div class="line"><span class="number">132</span>:                             log.warn(</div><div class="line"><span class="number">133</span>:                                 <span class="string">"[BUG] pull message result maybe data wrong, nextBeginOffset: &#123;&#125; firstMsgOffset: &#123;&#125; prevRequestOffset: &#123;&#125;"</span>, <span class="comment">//</span></div><div class="line"><span class="number">134</span>:                                 pullResult.getNextBeginOffset(), <span class="comment">//</span></div><div class="line"><span class="number">135</span>:                                 firstMsgOffset, <span class="comment">//</span></div><div class="line"><span class="number">136</span>:                                 prevRequestOffset);</div><div class="line"><span class="number">137</span>:                         &#125;</div><div class="line"><span class="number">138</span>: </div><div class="line"><span class="number">139</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">140</span>:                     <span class="keyword">case</span> NO_NEW_MSG:</div><div class="line"><span class="number">141</span>:                         <span class="comment">// è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</span></div><div class="line"><span class="number">142</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class="line"><span class="number">143</span>: </div><div class="line"><span class="number">144</span>:                         <span class="comment">// æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦</span></div><div class="line"><span class="number">145</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.correctTagsOffset(pullRequest);</div><div class="line"><span class="number">146</span>: </div><div class="line"><span class="number">147</span>:                         <span class="comment">// ç«‹å³æäº¤æ‹‰å–æ¶ˆæ¯è¯·æ±‚</span></div><div class="line"><span class="number">148</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">149</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">150</span>:                     <span class="keyword">case</span> NO_MATCHED_MSG:</div><div class="line"><span class="number">151</span>:                         <span class="comment">// è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</span></div><div class="line"><span class="number">152</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class="line"><span class="number">153</span>: </div><div class="line"><span class="number">154</span>:                         <span class="comment">// æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦</span></div><div class="line"><span class="number">155</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.correctTagsOffset(pullRequest);</div><div class="line"><span class="number">156</span>: </div><div class="line"><span class="number">157</span>:                         <span class="comment">// æäº¤ç«‹å³æ‹‰å–æ¶ˆæ¯è¯·æ±‚</span></div><div class="line"><span class="number">158</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">159</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">160</span>:                     <span class="keyword">case</span> OFFSET_ILLEGAL:</div><div class="line"><span class="number">161</span>:                         log.warn(<span class="string">"the pull request offset illegal, &#123;&#125; &#123;&#125;"</span>, <span class="comment">//</span></div><div class="line"><span class="number">162</span>:                             pullRequest.toString(), pullResult.toString());</div><div class="line"><span class="number">163</span>:                         <span class="comment">// è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</span></div><div class="line"><span class="number">164</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class="line"><span class="number">165</span>: </div><div class="line"><span class="number">166</span>:                         <span class="comment">// è®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸ºdropped</span></div><div class="line"><span class="number">167</span>:                         pullRequest.getProcessQueue().setDropped(<span class="keyword">true</span>);</div><div class="line"><span class="number">168</span>: </div><div class="line"><span class="number">169</span>:                         <span class="comment">// æäº¤å»¶è¿Ÿä»»åŠ¡ï¼Œè¿›è¡Œæ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ç§»é™¤ã€‚ä¸ç«‹å³ç§»é™¤çš„åŸå› ï¼šå¯èƒ½æœ‰åœ°æ–¹æ­£åœ¨ä½¿ç”¨ï¼Œé¿å…å—åˆ°å½±å“ã€‚</span></div><div class="line"><span class="number">170</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executeTaskLater(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"><span class="number">171</span>: </div><div class="line"><span class="number">172</span>:                             <span class="meta">@Override</span></div><div class="line"><span class="number">173</span>:                             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">174</span>:                                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">175</span>:                                     <span class="comment">// æ›´æ–°æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ°Broker</span></div><div class="line"><span class="number">176</span>:                                     DefaultMQPushConsumerImpl.<span class="keyword">this</span>.offsetStore.updateOffset(pullRequest.getMessageQueue(),</div><div class="line"><span class="number">177</span>:                                         pullRequest.getNextOffset(), <span class="keyword">false</span>);</div><div class="line"><span class="number">178</span>:                                     DefaultMQPushConsumerImpl.<span class="keyword">this</span>.offsetStore.persist(pullRequest.getMessageQueue());</div><div class="line"><span class="number">179</span>: </div><div class="line"><span class="number">180</span>:                                     <span class="comment">// ç§»é™¤æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—</span></div><div class="line"><span class="number">181</span>:                                     DefaultMQPushConsumerImpl.<span class="keyword">this</span>.rebalanceImpl.removeProcessQueue(pullRequest.getMessageQueue());</div><div class="line"><span class="number">182</span>: </div><div class="line"><span class="number">183</span>:                                     log.warn(<span class="string">"fix the pull request offset, &#123;&#125;"</span>, pullRequest);</div><div class="line"><span class="number">184</span>:                                 &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">185</span>:                                     log.error(<span class="string">"executeTaskLater Exception"</span>, e);</div><div class="line"><span class="number">186</span>:                                 &#125;</div><div class="line"><span class="number">187</span>:                             &#125;</div><div class="line"><span class="number">188</span>:                         &#125;, <span class="number">10000</span>);</div><div class="line"><span class="number">189</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">190</span>:                     <span class="keyword">default</span>:</div><div class="line"><span class="number">191</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">192</span>:                 &#125;</div><div class="line"><span class="number">193</span>:             &#125;</div><div class="line"><span class="number">194</span>:         &#125;</div><div class="line"><span class="number">195</span>: </div><div class="line"><span class="number">196</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">197</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onException</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line"><span class="number">198</span>:             <span class="keyword">if</span> (!pullRequest.getMessageQueue().getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class="line"><span class="number">199</span>:                 log.warn(<span class="string">"execute the pull request exception"</span>, e);</div><div class="line"><span class="number">200</span>:             &#125;</div><div class="line"><span class="number">201</span>: </div><div class="line"><span class="number">202</span>:             <span class="comment">// æäº¤å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚</span></div><div class="line"><span class="number">203</span>:             DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"><span class="number">204</span>:         &#125;</div><div class="line"><span class="number">205</span>:     &#125;;</div><div class="line"><span class="number">206</span>: </div><div class="line"><span class="number">207</span>:     <span class="comment">// é›†ç¾¤æ¶ˆæ¯æ¨¡å‹ä¸‹ï¼Œè®¡ç®—æäº¤çš„æ¶ˆè´¹è¿›åº¦ã€‚</span></div><div class="line"><span class="number">208</span>:     <span class="keyword">boolean</span> commitOffsetEnable = <span class="keyword">false</span>;</div><div class="line"><span class="number">209</span>:     <span class="keyword">long</span> commitOffsetValue = <span class="number">0L</span>;</div><div class="line"><span class="number">210</span>:     <span class="keyword">if</span> (MessageModel.CLUSTERING == <span class="keyword">this</span>.defaultMQPushConsumer.getMessageModel()) &#123;</div><div class="line"><span class="number">211</span>:         commitOffsetValue = <span class="keyword">this</span>.offsetStore.readOffset(pullRequest.getMessageQueue(), ReadOffsetType.READ_FROM_MEMORY);</div><div class="line"><span class="number">212</span>:         <span class="keyword">if</span> (commitOffsetValue &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">213</span>:             commitOffsetEnable = <span class="keyword">true</span>;</div><div class="line"><span class="number">214</span>:         &#125;</div><div class="line"><span class="number">215</span>:     &#125;</div><div class="line"><span class="number">216</span>: </div><div class="line"><span class="number">217</span>:     <span class="comment">// è®¡ç®—è¯·æ±‚çš„ è®¢é˜…è¡¨è¾¾å¼ å’Œ æ˜¯å¦è¿›è¡Œfiltersrvè¿‡æ»¤æ¶ˆæ¯</span></div><div class="line"><span class="number">218</span>:     String subExpression = <span class="keyword">null</span>;</div><div class="line"><span class="number">219</span>:     <span class="keyword">boolean</span> classFilter = <span class="keyword">false</span>;</div><div class="line"><span class="number">220</span>:     SubscriptionData sd = <span class="keyword">this</span>.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());</div><div class="line"><span class="number">221</span>:     <span class="keyword">if</span> (sd != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">222</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.defaultMQPushConsumer.isPostSubscriptionWhenPull() &amp;&amp; !sd.isClassFilterMode()) &#123;</div><div class="line"><span class="number">223</span>:             subExpression = sd.getSubString();</div><div class="line"><span class="number">224</span>:         &#125;</div><div class="line"><span class="number">225</span>: </div><div class="line"><span class="number">226</span>:         classFilter = sd.isClassFilterMode();</div><div class="line"><span class="number">227</span>:     &#125;</div><div class="line"><span class="number">228</span>: </div><div class="line"><span class="number">229</span>:     <span class="comment">// è®¡ç®—æ‹‰å–æ¶ˆæ¯ç³»ç»Ÿæ ‡è¯†</span></div><div class="line"><span class="number">230</span>:     <span class="keyword">int</span> sysFlag = PullSysFlag.buildSysFlag(<span class="comment">//</span></div><div class="line"><span class="number">231</span>:         commitOffsetEnable, <span class="comment">// commitOffset</span></div><div class="line"><span class="number">232</span>:         <span class="keyword">true</span>, <span class="comment">// suspend</span></div><div class="line"><span class="number">233</span>:         subExpression != <span class="keyword">null</span>, <span class="comment">// subscription</span></div><div class="line"><span class="number">234</span>:         classFilter <span class="comment">// class filter</span></div><div class="line"><span class="number">235</span>:     );</div><div class="line"><span class="number">236</span>: </div><div class="line"><span class="number">237</span>:     <span class="comment">// æ‰§è¡Œæ‹‰å–ã€‚å¦‚æœæ‹‰å–è¯·æ±‚å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæäº¤å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</span></div><div class="line"><span class="number">238</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">239</span>:         <span class="keyword">this</span>.pullAPIWrapper.pullKernelImpl(<span class="comment">//</span></div><div class="line"><span class="number">240</span>:             pullRequest.getMessageQueue(), <span class="comment">// 1</span></div><div class="line"><span class="number">241</span>:             subExpression, <span class="comment">// 2</span></div><div class="line"><span class="number">242</span>:             subscriptionData.getSubVersion(), <span class="comment">// 3</span></div><div class="line"><span class="number">243</span>:             pullRequest.getNextOffset(), <span class="comment">// 4</span></div><div class="line"><span class="number">244</span>:             <span class="keyword">this</span>.defaultMQPushConsumer.getPullBatchSize(), <span class="comment">// 5</span></div><div class="line"><span class="number">245</span>:             sysFlag, <span class="comment">// 6</span></div><div class="line"><span class="number">246</span>:             commitOffsetValue, <span class="comment">// 7</span></div><div class="line"><span class="number">247</span>:             BROKER_SUSPEND_MAX_TIME_MILLIS, <span class="comment">// 8</span></div><div class="line"><span class="number">248</span>:             CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND, <span class="comment">// 9</span></div><div class="line"><span class="number">249</span>:             CommunicationMode.ASYNC, <span class="comment">// 10</span></div><div class="line"><span class="number">250</span>:             pullCallback<span class="comment">// 11</span></div><div class="line"><span class="number">251</span>:         );</div><div class="line"><span class="number">252</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">253</span>:         log.error(<span class="string">"pullKernelImpl exception"</span>, e);</div><div class="line"><span class="number">254</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"><span class="number">255</span>:     &#125;</div><div class="line"><span class="number">256</span>: &#125;</div><div class="line"><span class="number">257</span>: </div><div class="line"><span class="number">258</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">correctTagsOffset</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class="line"><span class="number">259</span>:     <span class="keyword">if</span> (<span class="number">0L</span> == pullRequest.getProcessQueue().getMsgCount().get()) &#123;</div><div class="line"><span class="number">260</span>:         <span class="keyword">this</span>.offsetStore.updateOffset(pullRequest.getMessageQueue(), pullRequest.getNextOffset(), <span class="keyword">true</span>);</div><div class="line"><span class="number">261</span>:     &#125;</div><div class="line"><span class="number">262</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#pullMessage(...)</code> è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯ã€‚
<ul>
<li>ç¬¬ 3 è‡³ 6 è¡Œ ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å·²ç»ç»ˆæ­¢ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€‚</li>
<li>ç¬¬ 9 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æœ€åæ‹‰å–æ¶ˆæ¯æ—¶é—´ã€‚</li>
<li>ç¬¬ 11 è‡³ 18 è¡Œ ï¼š<code>Consumer</code> æœªå¤„äºè¿è¡Œä¸­çŠ¶æ€ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>
<li>ç¬¬ 20 è‡³ 25 è¡Œ ï¼š <code>Consumer</code> å¤„äºæš‚åœä¸­ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>
<li>ç¬¬ 27 è‡³ 37 è¡Œ ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯è¶…è¿‡æœ€å¤§å…è®¸å€¼ï¼ˆé»˜è®¤ï¼š1000æ¡ï¼‰ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>
<li>ç¬¬ 39 è‡³ 49 è¡Œ ï¼š<code>Consumer</code> ä¸º<strong>å¹¶å‘æ¶ˆè´¹</strong> å¹¶ä¸” æ¶ˆæ¯é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯è·¨åº¦è¿‡å¤§ï¼ˆæ¶ˆæ¯è·¨åº¦ = æŒæœ‰æ¶ˆæ¯æœ€åä¸€æ¡å’Œç¬¬ä¸€æ¡çš„æ¶ˆæ¯ä½ç½®å·®ï¼Œé»˜è®¤ï¼š2000ï¼‰ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>
<li>ç¬¬ 50 è‡³ 70 è¡Œ ï¼š<code>é¡ºåºæ¶ˆè´¹</code> ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š<a href="http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹</a>ã€‚</li>
<li>ç¬¬ 72 è‡³ 78 è¡Œ ï¼š<code>Topic</code> å¯¹åº”çš„è®¢é˜…ä¿¡æ¯ä¸å­˜åœ¨ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>
<li>ç¬¬ 222 è‡³ 224 è¡Œ ï¼šåˆ¤æ–­è¯·æ±‚æ˜¯å¦ä½¿ç”¨ <code>Consumer</code> <strong>æœ¬åœ°</strong>çš„è®¢é˜…ä¿¡æ¯( <code>SubscriptionData</code> )ï¼Œè€Œä¸ä½¿ç”¨ <code>Broker</code> é‡Œçš„è®¢é˜…ä¿¡æ¯ã€‚è¯¦ç»†è§£æè§ï¼š<a href="http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageProcessor-processRequest-%E2%80%A6">PullMessageProcessor#processRequest(...) ç¬¬ 64 è‡³ 110 è¡Œä»£ç </a>ã€‚</li>
<li>ç¬¬ 226 è¡Œ ï¼šæ˜¯å¦å¼€å¯è¿‡æ»¤ç±»è¿‡æ»¤æ¨¡å¼ã€‚è¯¦ç»†è§£æè§ï¼š<a href="http://www.yunai.me/RocketMQ/filtersrv/">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Filtersrvã€‹</a>ã€‚</li>
<li>ç¬¬ 229 è‡³ 235 è¡Œ ï¼šè®¡ç®—æ‹‰å–æ¶ˆæ¯è¯·æ±‚ç³»ç»Ÿæ ‡è¯†ã€‚è¯¦ç»†è§£æè§ï¼š<a href="http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageRequestHeader">PullMessageRequestHeader.sysFlag</a>ã€‚</li>
<li>ç¬¬ 237 è‡³ 255 è¡Œ ï¼š
<ul>
<li>æ‰§è¡Œæ¶ˆæ¯æ‹‰å–<strong>å¼‚æ­¥</strong>è¯·æ±‚ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#pullapiwrapperpullkernelimpl">PullAPIWrapper#pullKernelImpl(...)</a>ã€‚</li>
<li>å½“å‘èµ·è¯·æ±‚äº§ç”Ÿå¼‚å¸¸æ—¶ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚å¯¹åº” <code>Broker</code> å¤„ç†æ‹‰å–æ¶ˆæ¯é€»è¾‘è§ï¼š<a href="http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageProcessor-processRequest-%E2%80%A6">PullMessageProcessor#processRequest(...)</a>ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><code>PullCallback</code> ï¼šæ‹‰å–æ¶ˆæ¯å›è°ƒï¼š
<ul>
<li>ç¬¬ 86 è¡Œ ï¼šå¤„ç†æ‹‰å–ç»“æœã€‚è¯¦ç»†é€»è¾‘è§ï¼š<a href="#pullapiwrapperprocesspullresult">PullAPIWrapper#processPullResult(...)</a>ã€‚</li>
<li>ç¬¬ 89 è‡³ 192 è¡Œ ï¼šå¤„ç†æ‹‰å–çŠ¶æ€ç»“æœï¼š
<ul>
<li>ç¬¬ 90 è‡³ 139 è¡Œ ï¼šæ‹‰å–åˆ°æ¶ˆæ¯( <code>FOUND</code> ) ï¼š
<ul>
<li>ç¬¬ 91 è‡³ 93 è¡Œ ï¼šè®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li>
<li>ç¬¬ 95 è‡³ 97 è¡Œ ï¼šç»Ÿè®¡ã€‚</li>
<li>ç¬¬ 101 è‡³ 102 è¡Œ ï¼šæ‹‰å–åˆ°æ¶ˆæ¯çš„æ¶ˆæ¯åˆ—è¡¨ä¸ºç©ºï¼Œæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚ä¸ºä»€ä¹ˆä¼šå­˜åœ¨æ‹‰å–åˆ°æ¶ˆæ¯ï¼Œä½†æ˜¯æ¶ˆæ¯ç»“æœæœªç©ºå‘¢ï¼ŸåŸå› è§ï¼š<a href="#pullapiwrapperprocesspullresult">PullAPIWrapper#processPullResult(...)</a>ã€‚</li>
<li>ç¬¬ 106 è‡³ 108 è¡Œ ï¼šç»Ÿè®¡ã€‚</li>
<li>ç¬¬ 111 è¡Œ ï¼šæäº¤æ‹‰å–åˆ°çš„æ¶ˆæ¯åˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#processqueueputmessage">ProcessQueue#putMessage(...)</a>ã€‚</li>
<li>ç¬¬ 113 è‡³ 118 è¡Œ ï¼šæäº¤æ¶ˆè´¹è¯·æ±‚åˆ° <code>ConsumeMessageService</code>ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#consumemessageconcurrentlyservice">ConsumeMessageConcurrentlyService</a>ã€‚</li>
<li>ç¬¬ 120 è‡³ 126 è¡Œ ï¼šæ ¹æ®æ‹‰å–é¢‘ç‡( <code>pullInterval</code> )ï¼Œæäº¤<strong>ç«‹å³æˆ–è€…å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚é»˜è®¤æ‹‰å–é¢‘ç‡ä¸º 0ms ï¼Œæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>
<li>ç¬¬ 129 è‡³ 137 è¡Œ ï¼šä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½® æˆ–è€… ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼Œåˆ™åˆ¤å®šä¸º<strong>BUG</strong>ï¼Œè¾“å‡ºè­¦å‘Šæ—¥å¿—ã€‚</li>
</ul>
</li>
<li>ç¬¬ 140 è‡³ 149 è¡Œ ï¼šæ²¡æœ‰æ–°æ¶ˆæ¯( <code>NO_NEW_MSG</code> ) ï¼š
<ul>
<li>ç¬¬ 142 è¡Œ ï¼š è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li>
<li>ç¬¬ 145 è¡Œ ï¼šæ›´æ­£æ¶ˆè´¹è¿›åº¦ã€‚è¯¦ç»†è§£æè§ï¼š<code>#correctTagsOffset(...)</code>ã€‚</li>
<li>ç¬¬ 148 è¡Œ ï¼šæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>
</ul>
</li>
<li>ç¬¬ 150 è‡³ 159 è¡Œ ï¼šæœ‰æ–°æ¶ˆæ¯ä½†æ˜¯ä¸åŒ¹é…( <code>NO_MATCHED_MSG</code> )ã€‚é€»è¾‘åŒ <code>NO_NEW_MSG</code> ã€‚</li>
<li>ç¬¬ 160 è‡³ 189 è¡Œ ï¼šæ‹‰å–è¯·æ±‚çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ä¸åˆæ³• (<code>OFFSET_ILLEGAL</code>)ã€‚
<ul>
<li>ç¬¬ 164 è¡Œ ï¼šè®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li>
<li>ç¬¬ 167 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸º <code>dropped</code>ã€‚</li>
<li>ç¬¬ 169 è‡³ 188 è¡Œ ï¼šæäº¤å»¶è¿Ÿä»»åŠ¡ï¼Œè¿›è¡Œé˜Ÿåˆ—ç§»é™¤ã€‚
<ul>
<li>ç¬¬ 175 è‡³ 178 è¡Œ ï¼šæ›´æ–°æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ° <code>Broker</code>ã€‚</li>
<li>ç¬¬ 181 è¡Œ ï¼šç§»é™¤æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ã€‚
<ul>
<li>ç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸ç«‹å³ç§»é™¤ï¼Ÿï¼Ÿï¼Ÿ</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 196 è‡³ 204 è¡Œ ï¼šå‘ç”Ÿå¼‚å¸¸ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>
</ul>
</li>
<li><code>#correctTagsOffset(...)</code> ï¼šæ›´æ­£æ¶ˆè´¹è¿›åº¦ã€‚
<ul>
<li>ç¬¬ 258 è‡³ 261 è¡Œ ï¼š å½“æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯æ•°é‡ä¸º <strong>0</strong> æ—¶ï¼Œæ›´æ–°æ¶ˆè´¹è¿›åº¦ä¸ºæ‹‰å–è¯·æ±‚çš„æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li>
</ul>
</li>
</ul>
<h3>PullAPIWrapper#pullKernelImpl(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * æ‹‰å–æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•</div><div class="line"> 3:  *</div><div class="line"> 4:  * <span class="doctag">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 5:  * <span class="doctag">@param</span> subExpression è®¢é˜…è¡¨è¾¾å¼</div><div class="line"> 6:  * <span class="doctag">@param</span> subVersion è®¢é˜…ç‰ˆæœ¬å·</div><div class="line"> 7:  * <span class="doctag">@param</span> offset æ‹‰å–é˜Ÿåˆ—å¼€å§‹ä½ç½®</div><div class="line"> 8:  * <span class="doctag">@param</span> maxNums æ‹‰å–æ¶ˆæ¯æ•°é‡</div><div class="line"> 9:  * <span class="doctag">@param</span> sysFlag æ‹‰å–è¯·æ±‚ç³»ç»Ÿæ ‡è¯†</div><div class="line">10:  * <span class="doctag">@param</span> commitOffset æäº¤æ¶ˆè´¹è¿›åº¦</div><div class="line">11:  * <span class="doctag">@param</span> brokerSuspendMaxTimeMillis brokeræŒ‚èµ·è¯·æ±‚æœ€å¤§æ—¶é—´</div><div class="line">12:  * <span class="doctag">@param</span> timeoutMillis è¯·æ±‚brokerè¶…æ—¶æ—¶é•¿</div><div class="line">13:  * <span class="doctag">@param</span> communicationMode é€šè®¯æ¨¡å¼</div><div class="line">14:  * <span class="doctag">@param</span> pullCallback æ‹‰å–å›è°ƒ</div><div class="line">15:  * <span class="doctag">@return</span> æ‹‰å–æ¶ˆæ¯ç»“æœã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶ï¼Œæ‰è¿”å›ç»“æœï¼Œå¦åˆ™è¿”å›nullã€‚</div><div class="line">16:  * <span class="doctag">@throws</span> MQClientException å½“å¯»æ‰¾ä¸åˆ° broker æ—¶ï¼Œæˆ–å‘ç”Ÿå…¶ä»–clientå¼‚å¸¸</div><div class="line">17:  * <span class="doctag">@throws</span> RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class="line">18:  * <span class="doctag">@throws</span> MQBrokerException å½“ broker å‘ç”Ÿå¼‚å¸¸æ—¶ã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶æ‰ä¼šå‘ç”Ÿè¯¥å¼‚å¸¸ã€‚</div><div class="line">19:  * <span class="doctag">@throws</span> InterruptedException å½“å‘ç”Ÿä¸­æ–­å¼‚å¸¸æ—¶</div><div class="line">20:  */</div><div class="line"><span class="number">21</span>: <span class="function"><span class="keyword">protected</span> PullResult <span class="title">pullKernelImpl</span><span class="params">(</span></span></div><div class="line"><span class="number">22</span>:     <span class="keyword">final</span> MessageQueue mq,</div><div class="line"><span class="number">23</span>:     <span class="keyword">final</span> String subExpression,</div><div class="line"><span class="number">24</span>:     <span class="keyword">final</span> <span class="keyword">long</span> subVersion,</div><div class="line"><span class="number">25</span>:     <span class="keyword">final</span> <span class="keyword">long</span> offset,</div><div class="line"><span class="number">26</span>:     <span class="keyword">final</span> <span class="keyword">int</span> maxNums,</div><div class="line"><span class="number">27</span>:     <span class="keyword">final</span> <span class="keyword">int</span> sysFlag,</div><div class="line"><span class="number">28</span>:     <span class="keyword">final</span> <span class="keyword">long</span> commitOffset,</div><div class="line"><span class="number">29</span>:     <span class="keyword">final</span> <span class="keyword">long</span> brokerSuspendMaxTimeMillis,</div><div class="line"><span class="number">30</span>:     <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis,</div><div class="line"><span class="number">31</span>:     <span class="keyword">final</span> CommunicationMode communicationMode,</div><div class="line"><span class="number">32</span>:     <span class="keyword">final</span> PullCallback pullCallback</div><div class="line"><span class="number">33</span>: ) <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</div><div class="line"><span class="number">34</span>:     <span class="comment">// è·å–Brokerä¿¡æ¯</span></div><div class="line"><span class="number">35</span>:     FindBrokerResult findBrokerResult =</div><div class="line"><span class="number">36</span>:         <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),</div><div class="line"><span class="number">37</span>:             <span class="keyword">this</span>.recalculatePullFromWhichNode(mq), <span class="keyword">false</span>);</div><div class="line"><span class="number">38</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == findBrokerResult) &#123;</div><div class="line"><span class="number">39</span>:         <span class="keyword">this</span>.mQClientFactory.updateTopicRouteInfoFromNameServer(mq.getTopic());</div><div class="line"><span class="number">40</span>:         findBrokerResult =</div><div class="line"><span class="number">41</span>:             <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),</div><div class="line"><span class="number">42</span>:                 <span class="keyword">this</span>.recalculatePullFromWhichNode(mq), <span class="keyword">false</span>);</div><div class="line"><span class="number">43</span>:     &#125;</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:     <span class="comment">// è¯·æ±‚æ‹‰å–æ¶ˆæ¯</span></div><div class="line"><span class="number">46</span>:     <span class="keyword">if</span> (findBrokerResult != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">47</span>:         <span class="keyword">int</span> sysFlagInner = sysFlag;</div><div class="line"><span class="number">48</span>: </div><div class="line"><span class="number">49</span>:         <span class="keyword">if</span> (findBrokerResult.isSlave()) &#123;</div><div class="line"><span class="number">50</span>:             sysFlagInner = PullSysFlag.clearCommitOffsetFlag(sysFlagInner);</div><div class="line"><span class="number">51</span>:         &#125;</div><div class="line"><span class="number">52</span>: </div><div class="line"><span class="number">53</span>:         PullMessageRequestHeader requestHeader = <span class="keyword">new</span> PullMessageRequestHeader();</div><div class="line"><span class="number">54</span>:         requestHeader.setConsumerGroup(<span class="keyword">this</span>.consumerGroup);</div><div class="line"><span class="number">55</span>:         requestHeader.setTopic(mq.getTopic());</div><div class="line"><span class="number">56</span>:         requestHeader.setQueueId(mq.getQueueId());</div><div class="line"><span class="number">57</span>:         requestHeader.setQueueOffset(offset);</div><div class="line"><span class="number">58</span>:         requestHeader.setMaxMsgNums(maxNums);</div><div class="line"><span class="number">59</span>:         requestHeader.setSysFlag(sysFlagInner);</div><div class="line"><span class="number">60</span>:         requestHeader.setCommitOffset(commitOffset);</div><div class="line"><span class="number">61</span>:         requestHeader.setSuspendTimeoutMillis(brokerSuspendMaxTimeMillis);</div><div class="line"><span class="number">62</span>:         requestHeader.setSubscription(subExpression);</div><div class="line"><span class="number">63</span>:         requestHeader.setSubVersion(subVersion);</div><div class="line"><span class="number">64</span>: </div><div class="line"><span class="number">65</span>:         String brokerAddr = findBrokerResult.getBrokerAddr();</div><div class="line"><span class="number">66</span>:         <span class="keyword">if</span> (PullSysFlag.hasClassFilterFlag(sysFlagInner)) &#123; <span class="comment">// TODO filtersrv</span></div><div class="line"><span class="number">67</span>:             brokerAddr = computPullFromWhichFilterServer(mq.getTopic(), brokerAddr);</div><div class="line"><span class="number">68</span>:         &#125;</div><div class="line"><span class="number">69</span>: </div><div class="line"><span class="number">70</span>:         PullResult pullResult = <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().pullMessage(</div><div class="line"><span class="number">71</span>:             brokerAddr,</div><div class="line"><span class="number">72</span>:             requestHeader,</div><div class="line"><span class="number">73</span>:             timeoutMillis,</div><div class="line"><span class="number">74</span>:             communicationMode,</div><div class="line"><span class="number">75</span>:             pullCallback);</div><div class="line"><span class="number">76</span>: </div><div class="line"><span class="number">77</span>:         <span class="keyword">return</span> pullResult;</div><div class="line"><span class="number">78</span>:     &#125;</div><div class="line"><span class="number">79</span>: </div><div class="line"><span class="number">80</span>:     <span class="comment">// Brokerä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></div><div class="line"><span class="number">81</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"The broker["</span> + mq.getBrokerName() + <span class="string">"] not exist"</span>, <span class="keyword">null</span>);</div><div class="line"><span class="number">82</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•ã€‚<strong>è¯¥æ–¹æ³•å‚æ•°è¾ƒå¤šï¼Œå¯ä»¥çœ‹ä¸‹ä»£ç æ³¨é‡Šä¸Šæ¯ä¸ªå‚æ•°çš„è¯´æ˜</strong>ğŸ˜ˆã€‚</li>
<li>ç¬¬ 34 è‡³ 43 è¡Œ ï¼šè·å– <code>Broker</code> ä¿¡æ¯(<code>Broker</code> åœ°å€ã€æ˜¯å¦ä¸ºä»èŠ‚ç‚¹)ã€‚
<ul>
<li><a href="#pullapiwrapperrecalculatepullfromwhichnode">#recalculatePullFromWhichNode(...)</a></li>
<li><a href="#mqclientinstancefindbrokeraddressinsubscribe">#MQClientInstance#findBrokerAddressInSubscribe(...)</a></li>
</ul>
</li>
<li>ç¬¬ 45 è‡³ 78 è¡Œ ï¼š<strong>è¯·æ±‚æ‹‰å–æ¶ˆæ¯</strong>ã€‚</li>
<li>ç¬¬ 81 è¡Œ ï¼šå½“ <code>Broker</code> ä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</li>
</ul>
<h4>PullAPIWrapper#recalculatePullFromWhichNode(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * æ¶ˆæ¯é˜Ÿåˆ— ä¸ æ‹‰å–Broker çš„æ˜ å°„</div><div class="line"> 3:  * å½“æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œä¼šé€šè¿‡è¯¥æ˜ å°„è·å–æ‹‰å–è¯·æ±‚å¯¹åº”çš„Broker</div><div class="line"> 4:  */</div><div class="line"> <span class="number">5</span>: <span class="keyword">private</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong<span class="comment">/* brokerId */</span>&gt; pullFromWhichNodeTable =</div><div class="line"> <span class="number">6</span>:     <span class="keyword">new</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt;(<span class="number">32</span>);</div><div class="line"> <span class="number">7</span>: <span class="comment">/**</span></div><div class="line"> 8:  * æ˜¯å¦ä½¿ç”¨é»˜è®¤Broker</div><div class="line"> 9:  */</div><div class="line"><span class="number">10</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> connectBrokerByUser = <span class="keyword">false</span>;</div><div class="line"><span class="number">11</span>: <span class="comment">/**</span></div><div class="line">12:  * é»˜è®¤Brokerç¼–å·</div><div class="line">13:  */</div><div class="line"><span class="number">14</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> defaultBrokerId = MixAll.MASTER_ID;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>: <span class="comment">/**</span></div><div class="line">17:  * è®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯å¯¹åº”çš„Brokerç¼–å·</div><div class="line">18:  *</div><div class="line">19:  * <span class="doctag">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line">20:  * <span class="doctag">@return</span> Brokerç¼–å·</div><div class="line">21:  */</div><div class="line"><span class="number">22</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">recalculatePullFromWhichNode</span><span class="params">(<span class="keyword">final</span> MessageQueue mq)</span> </span>&#123;</div><div class="line"><span class="number">23</span>:     <span class="comment">// è‹¥å¼€å¯é»˜è®¤Brokerå¼€å…³ï¼Œåˆ™è¿”å›é»˜è®¤Brokerç¼–å·</span></div><div class="line"><span class="number">24</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.isConnectBrokerByUser()) &#123;</div><div class="line"><span class="number">25</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.defaultBrokerId;</div><div class="line"><span class="number">26</span>:     &#125;</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>:     <span class="comment">// è‹¥æ¶ˆæ¯é˜Ÿåˆ—æ˜ å°„æ‹‰å–Brokerå­˜åœ¨ï¼Œåˆ™è¿”å›æ˜ å°„Brokerç¼–å·</span></div><div class="line"><span class="number">29</span>:     AtomicLong suggest = <span class="keyword">this</span>.pullFromWhichNodeTable.get(mq);</div><div class="line"><span class="number">30</span>:     <span class="keyword">if</span> (suggest != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">31</span>:         <span class="keyword">return</span> suggest.get();</div><div class="line"><span class="number">32</span>:     &#125;</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>:     <span class="comment">// è¿”å›Brokerä¸»èŠ‚ç‚¹ç¼–å·</span></div><div class="line"><span class="number">35</span>:     <span class="keyword">return</span> MixAll.MASTER_ID;</div><div class="line"><span class="number">36</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šè®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯å¯¹åº”çš„ <code>Broker</code> ç¼–å·ã€‚</li>
</ul>
<h4>MQClientInstance#findBrokerAddressInSubscribe(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * Brokeråå­— å’Œ Brokeråœ°å€ç›¸å…³ Map</div><div class="line"> 3:  */</div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String<span class="comment">/* Broker Name */</span>, HashMap&lt;Long<span class="comment">/* brokerId */</span>, String<span class="comment">/* address */</span>&gt;&gt; brokerAddrTable =</div><div class="line"> <span class="number">5</span>:         <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>: <span class="comment">/**</span></div><div class="line"> 8:  * è·å¾—Brokerä¿¡æ¯</div><div class="line"> 9:  *</div><div class="line">10:  * <span class="doctag">@param</span> brokerName brokeråå­—</div><div class="line">11:  * <span class="doctag">@param</span> brokerId brokerç¼–å·</div><div class="line">12:  * <span class="doctag">@param</span> onlyThisBroker æ˜¯å¦å¿…é¡»æ˜¯è¯¥broker</div><div class="line">13:  * <span class="doctag">@return</span> Brokerä¿¡æ¯</div><div class="line">14:  */</div><div class="line"><span class="number">15</span>: <span class="function"><span class="keyword">public</span> FindBrokerResult <span class="title">findBrokerAddressInSubscribe</span><span class="params">(//</span></span></div><div class="line"><span class="number">16</span>:     <span class="keyword">final</span> String brokerName, //</div><div class="line"><span class="number">17</span>:     <span class="keyword">final</span> <span class="keyword">long</span> brokerId, //</div><div class="line"><span class="number">18</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> onlyThisBroker//</div><div class="line"><span class="number">19</span>: ) &#123;</div><div class="line"><span class="number">20</span>:     String brokerAddr = <span class="keyword">null</span>; <span class="comment">// brokeråœ°å€</span></div><div class="line"><span class="number">21</span>:     <span class="keyword">boolean</span> slave = <span class="keyword">false</span>; <span class="comment">// æ˜¯å¦ä¸ºä»èŠ‚ç‚¹</span></div><div class="line"><span class="number">22</span>:     <span class="keyword">boolean</span> found = <span class="keyword">false</span>; <span class="comment">// æ˜¯å¦æ‰¾åˆ°</span></div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:     <span class="comment">// è·å¾—Brokerä¿¡æ¯</span></div><div class="line"><span class="number">25</span>:     HashMap&lt;Long<span class="comment">/* brokerId */</span>, String<span class="comment">/* address */</span>&gt; map = <span class="keyword">this</span>.brokerAddrTable.get(brokerName);</div><div class="line"><span class="number">26</span>:     <span class="keyword">if</span> (map != <span class="keyword">null</span> &amp;&amp; !map.isEmpty()) &#123;</div><div class="line"><span class="number">27</span>:         brokerAddr = map.get(brokerId);</div><div class="line"><span class="number">28</span>:         slave = brokerId != MixAll.MASTER_ID;</div><div class="line"><span class="number">29</span>:         found = brokerAddr != <span class="keyword">null</span>;</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:         <span class="comment">// å¦‚æœä¸å¼ºåˆ¶è·å¾—ï¼Œé€‰æ‹©ä¸€ä¸ªBroker</span></div><div class="line"><span class="number">32</span>:         <span class="keyword">if</span> (!found &amp;&amp; !onlyThisBroker) &#123;</div><div class="line"><span class="number">33</span>:             Entry&lt;Long, String&gt; entry = map.entrySet().iterator().next();</div><div class="line"><span class="number">34</span>:             brokerAddr = entry.getValue();</div><div class="line"><span class="number">35</span>:             slave = entry.getKey() != MixAll.MASTER_ID;</div><div class="line"><span class="number">36</span>:             found = <span class="keyword">true</span>;</div><div class="line"><span class="number">37</span>:         &#125;</div><div class="line"><span class="number">38</span>:     &#125;</div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>:     <span class="comment">// æ‰¾åˆ°brokerï¼Œåˆ™è¿”å›ä¿¡æ¯</span></div><div class="line"><span class="number">41</span>:     <span class="keyword">if</span> (found) &#123;</div><div class="line"><span class="number">42</span>:         <span class="keyword">return</span> <span class="keyword">new</span> FindBrokerResult(brokerAddr, slave);</div><div class="line"><span class="number">43</span>:     &#125;</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:     <span class="comment">// æ‰¾ä¸åˆ°ï¼Œåˆ™è¿”å›ç©º</span></div><div class="line"><span class="number">46</span>:     <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">47</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šè·å– <code>Broker</code> ä¿¡æ¯(<code>Broker</code> åœ°å€ã€æ˜¯å¦ä¸ºä»èŠ‚ç‚¹)ã€‚</li>
</ul>
<h3>PullAPIWrapper#processPullResult(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * å¤„ç†æ‹‰å–ç»“æœ</div><div class="line"> 3:  * 1. æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯Brokerç¼–å·çš„æ˜ å°„</div><div class="line"> 4:  * 2. è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯</div><div class="line"> 5:  *</div><div class="line"> 6:  * <span class="doctag">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 7:  * <span class="doctag">@param</span> pullResult æ‹‰å–ç»“æœ</div><div class="line"> 8:  * <span class="doctag">@param</span> subscriptionData è®¢é˜…ä¿¡æ¯</div><div class="line"> 9:  * <span class="doctag">@return</span> æ‹‰å–ç»“æœ</div><div class="line">10:  */</div><div class="line"><span class="number">11</span>: <span class="function"><span class="keyword">public</span> PullResult <span class="title">processPullResult</span><span class="params">(<span class="keyword">final</span> MessageQueue mq, <span class="keyword">final</span> PullResult pullResult,</span></span></div><div class="line"><span class="number">12</span>:     <span class="keyword">final</span> SubscriptionData subscriptionData) &#123;</div><div class="line"><span class="number">13</span>:     PullResultExt pullResultExt = (PullResultExt) pullResult;</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:     <span class="comment">// æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯Brokerç¼–å·çš„æ˜ å°„</span></div><div class="line"><span class="number">16</span>:     <span class="keyword">this</span>.updatePullFromWhichNode(mq, pullResultExt.getSuggestWhichBrokerId());</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:     <span class="comment">// è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯</span></div><div class="line"><span class="number">19</span>:     <span class="keyword">if</span> (PullStatus.FOUND == pullResult.getPullStatus()) &#123;</div><div class="line"><span class="number">20</span>:         <span class="comment">// è§£ææ¶ˆæ¯</span></div><div class="line"><span class="number">21</span>:         ByteBuffer byteBuffer = ByteBuffer.wrap(pullResultExt.getMessageBinary());</div><div class="line"><span class="number">22</span>:         List&lt;MessageExt&gt; msgList = MessageDecoder.decodes(byteBuffer);</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:         <span class="comment">// æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯</span></div><div class="line"><span class="number">25</span>:         List&lt;MessageExt&gt; msgListFilterAgain = msgList;</div><div class="line"><span class="number">26</span>:         <span class="keyword">if</span> (!subscriptionData.getTagsSet().isEmpty() &amp;&amp; !subscriptionData.isClassFilterMode()) &#123;</div><div class="line"><span class="number">27</span>:             msgListFilterAgain = <span class="keyword">new</span> ArrayList&lt;&gt;(msgList.size());</div><div class="line"><span class="number">28</span>:             <span class="keyword">for</span> (MessageExt msg : msgList) &#123;</div><div class="line"><span class="number">29</span>:                 <span class="keyword">if</span> (msg.getTags() != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">30</span>:                     <span class="keyword">if</span> (subscriptionData.getTagsSet().contains(msg.getTags())) &#123;</div><div class="line"><span class="number">31</span>:                         msgListFilterAgain.add(msg);</div><div class="line"><span class="number">32</span>:                     &#125;</div><div class="line"><span class="number">33</span>:                 &#125;</div><div class="line"><span class="number">34</span>:             &#125;</div><div class="line"><span class="number">35</span>:         &#125;</div><div class="line"><span class="number">36</span>: </div><div class="line"><span class="number">37</span>:         <span class="comment">// Hook</span></div><div class="line"><span class="number">38</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.hasHook()) &#123;</div><div class="line"><span class="number">39</span>:             FilterMessageContext filterMessageContext = <span class="keyword">new</span> FilterMessageContext();</div><div class="line"><span class="number">40</span>:             filterMessageContext.setUnitMode(unitMode);</div><div class="line"><span class="number">41</span>:             filterMessageContext.setMsgList(msgListFilterAgain);</div><div class="line"><span class="number">42</span>:             <span class="keyword">this</span>.executeHook(filterMessageContext);</div><div class="line"><span class="number">43</span>:         &#125;</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:         <span class="comment">// è®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—å½“å‰æœ€å°/æœ€å¤§ä½ç½®åˆ°æ¶ˆæ¯æ‹“å±•å­—æ®µ</span></div><div class="line"><span class="number">46</span>:         <span class="keyword">for</span> (MessageExt msg : msgListFilterAgain) &#123;</div><div class="line"><span class="number">47</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MIN_OFFSET,</div><div class="line"><span class="number">48</span>:                 Long.toString(pullResult.getMinOffset()));</div><div class="line"><span class="number">49</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MAX_OFFSET,</div><div class="line"><span class="number">50</span>:                 Long.toString(pullResult.getMaxOffset()));</div><div class="line"><span class="number">51</span>:         &#125;</div><div class="line"><span class="number">52</span>: </div><div class="line"><span class="number">53</span>:         <span class="comment">// è®¾ç½®æ¶ˆæ¯åˆ—è¡¨</span></div><div class="line"><span class="number">54</span>:         pullResultExt.setMsgFoundList(msgListFilterAgain);</div><div class="line"><span class="number">55</span>:     &#125;</div><div class="line"><span class="number">56</span>: </div><div class="line"><span class="number">57</span>:     <span class="comment">// æ¸…ç©ºæ¶ˆæ¯äºŒè¿›åˆ¶æ•°ç»„</span></div><div class="line"><span class="number">58</span>:     pullResultExt.setMessageBinary(<span class="keyword">null</span>);</div><div class="line"><span class="number">59</span>: </div><div class="line"><span class="number">60</span>:     <span class="keyword">return</span> pullResult;</div><div class="line"><span class="number">61</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šå¤„ç†æ‹‰å–ç»“æœã€‚
<ul>
<li>æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯ <code>Broker</code> ç¼–å·çš„æ˜ å°„ã€‚</li>
<li>è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯ <code>tagCode</code>åŒ¹é…åˆé€‚æ¶ˆæ¯ã€‚</li>
</ul>
</li>
<li>ç¬¬ 16 è¡Œ ï¼šæ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯ <code>Broker</code> ç¼–å·çš„æ˜ å°„ã€‚ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œå¦‚æœæœªè®¾ç½®é»˜è®¤æ‹‰å–çš„ <code>Broker</code> ç¼–å·ï¼Œä¼šä½¿ç”¨æ›´æ–°åçš„ <code>Broker</code> ç¼–å·ã€‚</li>
<li>ç¬¬ 18 è‡³ 55 è¡Œ ï¼šè§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯ <code>tagCode</code> åŒ¹é…åˆé€‚æ¶ˆæ¯ã€‚
<ul>
<li>ç¬¬ 20 è‡³ 22 è¡Œ ï¼šè§£ææ¶ˆæ¯ã€‚è¯¦ç»†è§£æè§ï¼š<a href="http://www.yunai.me/RocketMQ/message/">ã€ŠRocketMQ æºç åˆ†æ â€”â€” MessageåŸºç¡€ã€‹</a> ã€‚</li>
<li>ç¬¬ 24 è‡³ 35 è¡Œ ï¼šæ ¹æ®è®¢é˜…ä¿¡æ¯<code>tagCode</code> åŒ¹é…æ¶ˆæ¯ã€‚</li>
<li>ç¬¬ 37 è‡³ 43 è¡Œ ï¼š<code>Hook</code>ã€‚</li>
<li>ç¬¬ 45 è‡³ 51 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—å½“å‰æœ€å°/æœ€å¤§ä½ç½®åˆ°æ¶ˆæ¯æ‹“å±•å­—æ®µã€‚</li>
<li>ç¬¬ 54 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
</ul>
</li>
<li>ç¬¬ 58 è¡Œ ï¼šæ¸…ç©ºæ¶ˆæ¯äºŒè¿›åˆ¶æ•°ç»„ã€‚</li>
</ul>
<h3>ProcessQueue#putMessage(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>:  <span class="comment">/**</span></div><div class="line"> 2:  * æ¶ˆæ¯æ˜ å°„è¯»å†™é”</div><div class="line"> 3:  */</div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock lockTreeMap = <span class="keyword">new</span> ReentrantReadWriteLock();</div><div class="line"> <span class="number">5</span>: <span class="comment">/**</span></div><div class="line"> 6:  * æ¶ˆæ¯æ˜ å°„</div><div class="line"> 7:  * keyï¼šæ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</div><div class="line"> 8:  */</div><div class="line"> <span class="number">9</span>: <span class="keyword">private</span> <span class="keyword">final</span> TreeMap&lt;Long, MessageExt&gt; msgTreeMap = <span class="keyword">new</span> TreeMap&lt;&gt;();</div><div class="line"><span class="number">10</span>: <span class="comment">/**</span></div><div class="line">11:  * æ¶ˆæ¯æ•°</div><div class="line">12:  */</div><div class="line"><span class="number">13</span>: <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong msgCount = <span class="keyword">new</span> AtomicLong();</div><div class="line"><span class="number">14</span>: <span class="comment">/**</span></div><div class="line">15:  * æ·»åŠ æ¶ˆæ¯æœ€å¤§é˜Ÿåˆ—ä½ç½®</div><div class="line">16:  */</div><div class="line"><span class="number">17</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> queueOffsetMax = <span class="number">0L</span>;</div><div class="line"><span class="number">18</span>: <span class="comment">/**</span></div><div class="line">19:  * æ˜¯å¦æ­£åœ¨æ¶ˆè´¹</div><div class="line">20:  */</div><div class="line"><span class="number">21</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> consuming = <span class="keyword">false</span>;</div><div class="line"><span class="number">22</span>: <span class="comment">/**</span></div><div class="line">23:  * Brokerç´¯è®¡æ¶ˆæ¯æ•°é‡</div><div class="line">24:  * è®¡ç®—å…¬å¼ = queueMaxOffset - æ–°æ·»åŠ æ¶ˆæ¯æ•°ç»„[n - 1].queueOffset</div><div class="line">25:  * Acc = Accumulation</div><div class="line">26:  * cnt = ï¼ˆçŒœæµ‹ï¼‰å¯¹æ¯”åº¦</div><div class="line">27:  */</div><div class="line"><span class="number">28</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> msgAccCnt = <span class="number">0</span>;</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>: <span class="comment">/**</span></div><div class="line">31:  * æ·»åŠ æ¶ˆæ¯ï¼Œå¹¶è¿”å›æ˜¯å¦æäº¤ç»™æ¶ˆè´¹è€…</div><div class="line">32:  * è¿”å›trueï¼Œå½“æœ‰æ–°æ¶ˆæ¯æ·»åŠ æˆåŠŸæ—¶ï¼Œ</div><div class="line">33:  *</div><div class="line">34:  * <span class="doctag">@param</span> msgs æ¶ˆæ¯</div><div class="line">35:  * <span class="doctag">@return</span> æ˜¯å¦æäº¤ç»™æ¶ˆè´¹è€…</div><div class="line">36:  */</div><div class="line"><span class="number">37</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">putMessage</span><span class="params">(<span class="keyword">final</span> List&lt;MessageExt&gt; msgs)</span> </span>&#123;</div><div class="line"><span class="number">38</span>:     <span class="keyword">boolean</span> dispatchToConsume = <span class="keyword">false</span>;</div><div class="line"><span class="number">39</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">40</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"><span class="number">41</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">42</span>:             <span class="comment">// æ·»åŠ æ¶ˆæ¯</span></div><div class="line"><span class="number">43</span>:             <span class="keyword">int</span> validMsgCnt = <span class="number">0</span>;</div><div class="line"><span class="number">44</span>:             <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</div><div class="line"><span class="number">45</span>:                 MessageExt old = msgTreeMap.put(msg.getQueueOffset(), msg);</div><div class="line"><span class="number">46</span>:                 <span class="keyword">if</span> (<span class="keyword">null</span> == old) &#123;</div><div class="line"><span class="number">47</span>:                     validMsgCnt++;</div><div class="line"><span class="number">48</span>:                     <span class="keyword">this</span>.queueOffsetMax = msg.getQueueOffset();</div><div class="line"><span class="number">49</span>:                 &#125;</div><div class="line"><span class="number">50</span>:             &#125;</div><div class="line"><span class="number">51</span>:             msgCount.addAndGet(validMsgCnt);</div><div class="line"><span class="number">52</span>: </div><div class="line"><span class="number">53</span>:             <span class="comment">// è®¡ç®—æ˜¯å¦æ­£åœ¨æ¶ˆè´¹</span></div><div class="line"><span class="number">54</span>:             <span class="keyword">if</span> (!msgTreeMap.isEmpty() &amp;&amp; !<span class="keyword">this</span>.consuming) &#123;</div><div class="line"><span class="number">55</span>:                 dispatchToConsume = <span class="keyword">true</span>;</div><div class="line"><span class="number">56</span>:                 <span class="keyword">this</span>.consuming = <span class="keyword">true</span>;</div><div class="line"><span class="number">57</span>:             &#125;</div><div class="line"><span class="number">58</span>: </div><div class="line"><span class="number">59</span>:             <span class="comment">// Brokerç´¯è®¡æ¶ˆæ¯æ•°é‡</span></div><div class="line"><span class="number">60</span>:             <span class="keyword">if</span> (!msgs.isEmpty()) &#123;</div><div class="line"><span class="number">61</span>:                 MessageExt messageExt = msgs.get(msgs.size() - <span class="number">1</span>);</div><div class="line"><span class="number">62</span>:                 String property = messageExt.getProperty(MessageConst.PROPERTY_MAX_OFFSET);</div><div class="line"><span class="number">63</span>:                 <span class="keyword">if</span> (property != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">64</span>:                     <span class="keyword">long</span> accTotal = Long.parseLong(property) - messageExt.getQueueOffset();</div><div class="line"><span class="number">65</span>:                     <span class="keyword">if</span> (accTotal &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">66</span>:                         <span class="keyword">this</span>.msgAccCnt = accTotal;</div><div class="line"><span class="number">67</span>:                     &#125;</div><div class="line"><span class="number">68</span>:                 &#125;</div><div class="line"><span class="number">69</span>:             &#125;</div><div class="line"><span class="number">70</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">71</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"><span class="number">72</span>:         &#125;</div><div class="line"><span class="number">73</span>:     &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"><span class="number">74</span>:         log.error(<span class="string">"putMessage exception"</span>, e);</div><div class="line"><span class="number">75</span>:     &#125;</div><div class="line"><span class="number">76</span>: </div><div class="line"><span class="number">77</span>:     <span class="keyword">return</span> dispatchToConsume;</div><div class="line"><span class="number">78</span>: &#125;</div></pre></td></tr></table></figure></p>
<h2>æ€»ç»“</h2>
<p>å¦‚æœç”¨æœ€ç®€å•ç²—æš´çš„æ–¹å¼æè¿° <code>PullConsumer</code> æ‹‰å–æ¶ˆæ¯çš„è¿‡ç¨‹ï¼Œé‚£å°±æ˜¯å¦‚ä¸‹çš„ä»£ç ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (ä¸æ»¡è¶³æ‹‰å–æ¶ˆæ¯) &#123;</div><div class="line">        Thread.sleep(é—´éš”);</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line">    ä¸»åŠ¨æ‹‰å–æ¶ˆæ¯();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>6ã€PushConsumer æ¶ˆè´¹æ¶ˆæ¯</h1>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/06.png" alt="DefaultMQPushConsumerImplæ¶ˆè´¹æ¶ˆæ¯"></p>
<h2>ConsumeMessageConcurrentlyService æäº¤æ¶ˆè´¹è¯·æ±‚</h2>
<h3>ConsumeMessageConcurrentlyService#submitConsumeRequest(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * æ¶ˆè´¹çº¿ç¨‹æ± é˜Ÿåˆ—</div><div class="line"> 3:  */</div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; consumeRequestQueue;</div><div class="line"> <span class="number">5</span>: <span class="comment">/**</span></div><div class="line"> 6:  * æ¶ˆè´¹çº¿ç¨‹æ± </div><div class="line"> 7:  */</div><div class="line"> <span class="number">8</span>: <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor consumeExecutor;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submitConsumeRequest</span><span class="params">(//</span></span></div><div class="line"><span class="number">11</span>:     <span class="keyword">final</span> List&lt;MessageExt&gt; msgs, //</div><div class="line"><span class="number">12</span>:     <span class="keyword">final</span> ProcessQueue processQueue, //</div><div class="line"><span class="number">13</span>:     <span class="keyword">final</span> MessageQueue messageQueue, //</div><div class="line"><span class="number">14</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> dispatchToConsume) &#123;</div><div class="line"><span class="number">15</span>:     <span class="keyword">final</span> <span class="keyword">int</span> consumeBatchSize = <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();</div><div class="line"><span class="number">16</span>:     <span class="keyword">if</span> (msgs.size() &lt;= consumeBatchSize) &#123; <span class="comment">// æäº¤æ¶ˆæ¯å°äºæ‰¹é‡æ¶ˆæ¯æ•°ï¼Œç›´æ¥æäº¤æ¶ˆè´¹è¯·æ±‚</span></div><div class="line"><span class="number">17</span>:         ConsumeRequest consumeRequest = <span class="keyword">new</span> ConsumeRequest(msgs, processQueue, messageQueue);</div><div class="line"><span class="number">18</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">19</span>:             <span class="keyword">this</span>.consumeExecutor.submit(consumeRequest);</div><div class="line"><span class="number">20</span>:         &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</div><div class="line"><span class="number">21</span>:             <span class="keyword">this</span>.submitConsumeRequestLater(consumeRequest);</div><div class="line"><span class="number">22</span>:         &#125;</div><div class="line"><span class="number">23</span>:     &#125; <span class="keyword">else</span> &#123; <span class="comment">// æäº¤æ¶ˆæ¯å¤§äºæ‰¹é‡æ¶ˆæ¯æ•°ï¼Œè¿›è¡Œåˆ†æ‹†æˆå¤šä¸ªæ¶ˆè´¹è¯·æ±‚</span></div><div class="line"><span class="number">24</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> total = <span class="number">0</span>; total &lt; msgs.size(); ) &#123;</div><div class="line"><span class="number">25</span>:             <span class="comment">// è®¡ç®—å½“å‰æ‹†åˆ†è¯·æ±‚åŒ…å«çš„æ¶ˆæ¯</span></div><div class="line"><span class="number">26</span>:             List&lt;MessageExt&gt; msgThis = <span class="keyword">new</span> ArrayList&lt;&gt;(consumeBatchSize);</div><div class="line"><span class="number">27</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; consumeBatchSize; i++, total++) &#123;</div><div class="line"><span class="number">28</span>:                 <span class="keyword">if</span> (total &lt; msgs.size()) &#123;</div><div class="line"><span class="number">29</span>:                     msgThis.add(msgs.get(total));</div><div class="line"><span class="number">30</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">31</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">32</span>:                 &#125;</div><div class="line"><span class="number">33</span>:             &#125;</div><div class="line"><span class="number">34</span>: </div><div class="line"><span class="number">35</span>:             <span class="comment">// æäº¤æ‹†åˆ†æ¶ˆè´¹è¯·æ±‚</span></div><div class="line"><span class="number">36</span>:             ConsumeRequest consumeRequest = <span class="keyword">new</span> ConsumeRequest(msgThis, processQueue, messageQueue);</div><div class="line"><span class="number">37</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">38</span>:                 <span class="keyword">this</span>.consumeExecutor.submit(consumeRequest);</div><div class="line"><span class="number">39</span>:             &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</div><div class="line"><span class="number">40</span>:                 <span class="comment">// å¦‚æœè¢«æ‹’ç»ï¼Œåˆ™å°†å½“å‰æ‹†åˆ†æ¶ˆæ¯+å‰©ä½™æ¶ˆæ¯æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚</span></div><div class="line"><span class="number">41</span>:                 <span class="keyword">for</span> (; total &lt; msgs.size(); total++) &#123;</div><div class="line"><span class="number">42</span>:                     msgThis.add(msgs.get(total));</div><div class="line"><span class="number">43</span>:                 &#125;</div><div class="line"><span class="number">44</span>:                 <span class="keyword">this</span>.submitConsumeRequestLater(consumeRequest);</div><div class="line"><span class="number">45</span>:             &#125;</div><div class="line"><span class="number">46</span>:         &#125;</div><div class="line"><span class="number">47</span>:     &#125;</div><div class="line"><span class="number">48</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šæäº¤<strong>ç«‹å³</strong>æ¶ˆè´¹è¯·æ±‚ã€‚</li>
<li>ç¬¬ 16 è‡³ 22 è¡Œ ï¼šæäº¤æ¶ˆæ¯å°äºç­‰äºæ‰¹é‡æ¶ˆè´¹æ•°ï¼Œç›´æ¥æäº¤æ¶ˆè´¹è¯·æ±‚ã€‚</li>
<li>ç¬¬ 23 è‡³ 47 è¡Œ ï¼šå½“æäº¤æ¶ˆæ¯å¤§äºæ‰¹é‡æ¶ˆè´¹æ•°ï¼Œè¿›è¡Œåˆ†æ‹†æˆå¤šä¸ªè¯·æ±‚ã€‚
<ul>
<li>ç¬¬ 25 è‡³ 33 è¡Œ ï¼šè®¡ç®—å½“å‰æ‹†åˆ†è¯·æ±‚åŒ…å«çš„æ¶ˆæ¯ã€‚</li>
<li>ç¬¬ 35 è‡³ 38 è¡Œ ï¼šæäº¤æ‹†åˆ†æ¶ˆè´¹è¯·æ±‚ã€‚</li>
<li>ç¬¬ 39 è‡³ 44 è¡Œ ï¼šæäº¤è¯·æ±‚è¢«æ‹’ç»ï¼Œåˆ™å°†å½“å‰æ‹†åˆ†æ¶ˆæ¯ + å‰©ä½™æ¶ˆæ¯æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ï¼Œç»“æŸæ‹†åˆ†å¾ªç¯ã€‚</li>
</ul>
</li>
</ul>
<h3>ConsumeMessageConcurrentlyService#submitConsumeRequestLater</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚</div><div class="line"> 3:  *</div><div class="line"> 4:  * <span class="doctag">@param</span> msgs æ¶ˆæ¯åˆ—è¡¨</div><div class="line"> 5:  * <span class="doctag">@param</span> processQueue æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class="line"> 6:  * <span class="doctag">@param</span> messageQueue æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 7:  */</div><div class="line"> <span class="number">8</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">submitConsumeRequestLater</span><span class="params">(//</span></span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">final</span> List&lt;MessageExt&gt; msgs, //</div><div class="line"><span class="number">10</span>:     <span class="keyword">final</span> ProcessQueue processQueue, //</div><div class="line"><span class="number">11</span>:     <span class="keyword">final</span> MessageQueue messageQueue//</div><div class="line"><span class="number">12</span>: ) &#123;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>:     <span class="keyword">this</span>.scheduledExecutorService.schedule(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">17</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">18</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.submitConsumeRequest(msgs, processQueue, messageQueue, <span class="keyword">true</span>);</div><div class="line"><span class="number">19</span>:         &#125;</div><div class="line"><span class="number">20</span>:     &#125;, <span class="number">5000</span>, TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">21</span>: &#125;</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>: <span class="comment">/**</span></div><div class="line">24:  * æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚</div><div class="line">25:  * <span class="doctag">@param</span> consumeRequest æ¶ˆè´¹è¯·æ±‚</div><div class="line">26:  */</div><div class="line"><span class="number">27</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">submitConsumeRequestLater</span><span class="params">(<span class="keyword">final</span> ConsumeRequest consumeRequest//</span></span></div><div class="line"><span class="number">28</span>: ) &#123;</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>:     <span class="keyword">this</span>.scheduledExecutorService.schedule(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">33</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">34</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumeExecutor.submit(consumeRequest); <span class="comment">// TODO BUG ?</span></div><div class="line"><span class="number">35</span>:         &#125;</div><div class="line"><span class="number">36</span>:     &#125;, <span class="number">5000</span>, TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">37</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šæäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚</li>
<li>ç¬¬ 34 è¡Œ ï¼šç›´æ¥è°ƒç”¨ <code>ConsumeMessageConcurrentlyService.this.consumeExecutor.submit(consumeRequest);</code>ã€‚å¦‚æœæ¶ˆæ¯æ•°è¶…è¿‡æ‰¹é‡æ¶ˆè´¹ä¸Šé™ï¼Œä¼šä¸ä¼šæ˜¯<strong>BUG</strong>ã€‚</li>
</ul>
<h2>ConsumeRequest</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="class"><span class="keyword">class</span> <span class="title">ConsumeRequest</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">  <span class="number">2</span>: </div><div class="line">  <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line">  4:      * æ¶ˆè´¹æ¶ˆæ¯åˆ—è¡¨</div><div class="line">  5:      */</div><div class="line">  <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">final</span> List&lt;MessageExt&gt; msgs;</div><div class="line">  <span class="number">7</span>:     <span class="comment">/**</span></div><div class="line">  8:      * æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class="line">  9:      */</div><div class="line"> <span class="number">10</span>:     <span class="keyword">private</span> <span class="keyword">final</span> ProcessQueue processQueue;</div><div class="line"> <span class="number">11</span>:     <span class="comment">/**</span></div><div class="line"> 12:      * æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"> 13:      */</div><div class="line"> <span class="number">14</span>:     <span class="keyword">private</span> <span class="keyword">final</span> MessageQueue messageQueue;</div><div class="line"> <span class="number">15</span>: </div><div class="line"> <span class="number">16</span>:     <span class="function"><span class="keyword">public</span> <span class="title">ConsumeRequest</span><span class="params">(List&lt;MessageExt&gt; msgs, ProcessQueue processQueue, MessageQueue messageQueue)</span> </span>&#123;</div><div class="line"> <span class="number">17</span>:         <span class="keyword">this</span>.msgs = msgs;</div><div class="line"> <span class="number">18</span>:         <span class="keyword">this</span>.processQueue = processQueue;</div><div class="line"> <span class="number">19</span>:         <span class="keyword">this</span>.messageQueue = messageQueue;</div><div class="line"> <span class="number">20</span>:     &#125;</div><div class="line"> <span class="number">21</span>: </div><div class="line"> <span class="number">22</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">23</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">24</span>:         <span class="comment">// åºŸå¼ƒé˜Ÿåˆ—ä¸è¿›è¡Œæ¶ˆè´¹</span></div><div class="line"> <span class="number">25</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.processQueue.isDropped()) &#123;</div><div class="line"> <span class="number">26</span>:             log.info(<span class="string">"the message queue not be able to consume, because it's dropped. group=&#123;&#125; &#123;&#125;"</span>, ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumerGroup, <span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">27</span>:             <span class="keyword">return</span>;</div><div class="line"> <span class="number">28</span>:         &#125;</div><div class="line"> <span class="number">29</span>: </div><div class="line"> <span class="number">30</span>:         MessageListenerConcurrently listener = ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.messageListener; <span class="comment">// ç›‘å¬å™¨</span></div><div class="line"> <span class="number">31</span>:         ConsumeConcurrentlyContext context = <span class="keyword">new</span> ConsumeConcurrentlyContext(messageQueue); <span class="comment">// æ¶ˆè´¹Context</span></div><div class="line"> <span class="number">32</span>:         ConsumeConcurrentlyStatus status = <span class="keyword">null</span>; <span class="comment">// æ¶ˆè´¹ç»“æœçŠ¶æ€</span></div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:         <span class="comment">// Hook</span></div><div class="line"> <span class="number">35</span>:         ConsumeMessageContext consumeMessageContext = <span class="keyword">null</span>;</div><div class="line"> <span class="number">36</span>:         <span class="keyword">if</span> (ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.hasHook()) &#123;</div><div class="line"> <span class="number">37</span>:             consumeMessageContext = <span class="keyword">new</span> ConsumeMessageContext();</div><div class="line"> <span class="number">38</span>:             consumeMessageContext.setConsumerGroup(defaultMQPushConsumer.getConsumerGroup());</div><div class="line"> <span class="number">39</span>:             consumeMessageContext.setProps(<span class="keyword">new</span> HashMap&lt;String, String&gt;());</div><div class="line"> <span class="number">40</span>:             consumeMessageContext.setMq(messageQueue);</div><div class="line"> <span class="number">41</span>:             consumeMessageContext.setMsgList(msgs);</div><div class="line"> <span class="number">42</span>:             consumeMessageContext.setSuccess(<span class="keyword">false</span>);</div><div class="line"> <span class="number">43</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.executeHookBefore(consumeMessageContext);</div><div class="line"> <span class="number">44</span>:         &#125;</div><div class="line"> <span class="number">45</span>: </div><div class="line"> <span class="number">46</span>:         <span class="keyword">long</span> beginTimestamp = System.currentTimeMillis();</div><div class="line"> <span class="number">47</span>:         <span class="keyword">boolean</span> hasException = <span class="keyword">false</span>;</div><div class="line"> <span class="number">48</span>:         ConsumeReturnType returnType = ConsumeReturnType.SUCCESS; <span class="comment">// æ¶ˆè´¹è¿”å›ç»“æœç±»å‹</span></div><div class="line"> <span class="number">49</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">50</span>:             <span class="comment">// å½“æ¶ˆæ¯ä¸ºé‡è¯•æ¶ˆæ¯ï¼Œè®¾ç½®Topicä¸ºåŸå§‹Topic</span></div><div class="line"> <span class="number">51</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.resetRetryTopic(msgs);</div><div class="line"> <span class="number">52</span>: </div><div class="line"> <span class="number">53</span>:             <span class="comment">// è®¾ç½®å¼€å§‹æ¶ˆè´¹æ—¶é—´</span></div><div class="line"> <span class="number">54</span>:             <span class="keyword">if</span> (msgs != <span class="keyword">null</span> &amp;&amp; !msgs.isEmpty()) &#123;</div><div class="line"> <span class="number">55</span>:                 <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</div><div class="line"> <span class="number">56</span>:                     MessageAccessor.setConsumeStartTimeStamp(msg, String.valueOf(System.currentTimeMillis()));</div><div class="line"> <span class="number">57</span>:                 &#125;</div><div class="line"> <span class="number">58</span>:             &#125;</div><div class="line"> <span class="number">59</span>: </div><div class="line"> <span class="number">60</span>:             <span class="comment">// è¿›è¡Œæ¶ˆè´¹</span></div><div class="line"> <span class="number">61</span>:             status = listener.consumeMessage(Collections.unmodifiableList(msgs), context);</div><div class="line"> <span class="number">62</span>:         &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">63</span>:             log.warn(<span class="string">"consumeMessage exception: &#123;&#125; Group: &#123;&#125; Msgs: &#123;&#125; MQ: &#123;&#125;"</span>,</div><div class="line"> <span class="number">64</span>:                 RemotingHelper.exceptionSimpleDesc(e), <span class="comment">//</span></div><div class="line"> <span class="number">65</span>:                 ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumerGroup,</div><div class="line"> <span class="number">66</span>:                 msgs,</div><div class="line"> <span class="number">67</span>:                 messageQueue);</div><div class="line"> <span class="number">68</span>:             hasException = <span class="keyword">true</span>;</div><div class="line"> <span class="number">69</span>:         &#125;</div><div class="line"> <span class="number">70</span>: </div><div class="line"> <span class="number">71</span>:         <span class="comment">// è§£ææ¶ˆè´¹è¿”å›ç»“æœç±»å‹</span></div><div class="line"> <span class="number">72</span>:         <span class="keyword">long</span> consumeRT = System.currentTimeMillis() - beginTimestamp;</div><div class="line"> <span class="number">73</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == status) &#123;</div><div class="line"> <span class="number">74</span>:             <span class="keyword">if</span> (hasException) &#123;</div><div class="line"> <span class="number">75</span>:                 returnType = ConsumeReturnType.EXCEPTION;</div><div class="line"> <span class="number">76</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">77</span>:                 returnType = ConsumeReturnType.RETURNNULL;</div><div class="line"> <span class="number">78</span>:             &#125;</div><div class="line"> <span class="number">79</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (consumeRT &gt;= defaultMQPushConsumer.getConsumeTimeout() * <span class="number">60</span> * <span class="number">1000</span>) &#123;</div><div class="line"> <span class="number">80</span>:             returnType = ConsumeReturnType.TIME_OUT;</div><div class="line"> <span class="number">81</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ConsumeConcurrentlyStatus.RECONSUME_LATER == status) &#123;</div><div class="line"> <span class="number">82</span>:             returnType = ConsumeReturnType.FAILED;</div><div class="line"> <span class="number">83</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status) &#123;</div><div class="line"> <span class="number">84</span>:             returnType = ConsumeReturnType.SUCCESS;</div><div class="line"> <span class="number">85</span>:         &#125;</div><div class="line"> <span class="number">86</span>: </div><div class="line"> <span class="number">87</span>:         <span class="comment">// Hook</span></div><div class="line"> <span class="number">88</span>:         <span class="keyword">if</span> (ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.hasHook()) &#123;</div><div class="line"> <span class="number">89</span>:             consumeMessageContext.getProps().put(MixAll.CONSUME_CONTEXT_TYPE, returnType.name());</div><div class="line"> <span class="number">90</span>:         &#125;</div><div class="line"> <span class="number">91</span>: </div><div class="line"> <span class="number">92</span>:         <span class="comment">// æ¶ˆè´¹ç»“æœçŠ¶æ€ä¸ºç©ºæ—¶ï¼Œåˆ™è®¾ç½®ä¸ºç¨åé‡æ–°æ¶ˆè´¹</span></div><div class="line"> <span class="number">93</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == status) &#123;</div><div class="line"> <span class="number">94</span>:             log.warn(<span class="string">"consumeMessage return null, Group: &#123;&#125; Msgs: &#123;&#125; MQ: &#123;&#125;"</span>,</div><div class="line"> <span class="number">95</span>:                 ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumerGroup,</div><div class="line"> <span class="number">96</span>:                 msgs,</div><div class="line"> <span class="number">97</span>:                 messageQueue);</div><div class="line"> <span class="number">98</span>:             status = ConsumeConcurrentlyStatus.RECONSUME_LATER;</div><div class="line"> <span class="number">99</span>:         &#125;</div><div class="line"><span class="number">100</span>: </div><div class="line"><span class="number">101</span>:         <span class="comment">// Hook</span></div><div class="line"><span class="number">102</span>:         <span class="keyword">if</span> (ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.hasHook()) &#123;</div><div class="line"><span class="number">103</span>:             consumeMessageContext.setStatus(status.toString());</div><div class="line"><span class="number">104</span>:             consumeMessageContext.setSuccess(ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status);</div><div class="line"><span class="number">105</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.executeHookAfter(consumeMessageContext);</div><div class="line"><span class="number">106</span>:         &#125;</div><div class="line"><span class="number">107</span>: </div><div class="line"><span class="number">108</span>:         <span class="comment">// ç»Ÿè®¡</span></div><div class="line"><span class="number">109</span>:         ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.getConsumerStatsManager()</div><div class="line"><span class="number">110</span>:             .incConsumeRT(ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumerGroup, messageQueue.getTopic(), consumeRT);</div><div class="line"><span class="number">111</span>: </div><div class="line"><span class="number">112</span>:         <span class="comment">// å¤„ç†æ¶ˆè´¹ç»“æœ</span></div><div class="line"><span class="number">113</span>:         <span class="keyword">if</span> (!processQueue.isDropped()) &#123;</div><div class="line"><span class="number">114</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.processConsumeResult(status, context, <span class="keyword">this</span>);</div><div class="line"><span class="number">115</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">116</span>:             log.warn(<span class="string">"processQueue is dropped without process consume result. messageQueue=&#123;&#125;, msgs=&#123;&#125;"</span>, messageQueue, msgs);</div><div class="line"><span class="number">117</span>:         &#125;</div><div class="line"><span class="number">118</span>:     &#125;</div><div class="line"><span class="number">119</span>: </div><div class="line"><span class="number">120</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šæ¶ˆè´¹è¯·æ±‚ã€‚æäº¤è¯·æ±‚æ‰§è¡Œæ¶ˆè´¹ã€‚</li>
<li>ç¬¬ 24 è‡³ 28 è¡Œ ï¼šåºŸå¼ƒå¤„ç†é˜Ÿåˆ—ä¸è¿›è¡Œæ¶ˆè´¹ã€‚</li>
<li>ç¬¬ 34 è‡³ 44 è¡Œ ï¼šHookã€‚</li>
<li>ç¬¬ 51 è¡Œ ï¼šå½“æ¶ˆæ¯ä¸ºé‡è¯•æ¶ˆæ¯ï¼Œè®¾ç½® <code>Topic</code>ä¸ºåŸå§‹ <code>Topic</code>ã€‚ä¾‹å¦‚ï¼šåŸå§‹ <code>Topic</code> ä¸º <code>TopicTest</code>ï¼Œé‡è¯•æ—¶ <code>Topic</code> ä¸º <code>%RETRY%please_rename_unique_group_name_4</code>ï¼Œç»è¿‡è¯¥æ–¹æ³•ï¼Œ<code>Topic</code> è®¾ç½®å› <code>TopicTest</code>ã€‚</li>
<li>ç¬¬ 53 è‡³ 58 è¡Œ ï¼šè®¾ç½®å¼€å§‹æ¶ˆè´¹æ—¶é—´ã€‚</li>
<li>ç¬¬ 61 è¡Œ ï¼š<strong>è¿›è¡Œæ¶ˆè´¹</strong>ã€‚</li>
<li>ç¬¬ 71 è‡³ 85 è¡Œ ï¼šè§£ææ¶ˆè´¹è¿”å›ç»“æœç±»å‹</li>
<li>ç¬¬ 87 è‡³ 90 è¡Œ ï¼š<code>Hook</code>ã€‚</li>
<li>ç¬¬ 92 è‡³ 99 è¡Œ ï¼šæ¶ˆè´¹ç»“æœçŠ¶æ€æœªç©ºæ—¶ï¼Œåˆ™è®¾ç½®æ¶ˆè´¹ç»“æœçŠ¶æ€ä¸ºç¨åæ¶ˆè´¹ã€‚</li>
<li>ç¬¬ 101 è‡³ 106 è¡Œ ï¼š<code>Hook</code>ã€‚</li>
<li>ç¬¬ 108 è‡³ 110 è¡Œ ï¼šç»Ÿè®¡ã€‚</li>
<li>ç¬¬ 112 è‡³ 117 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚<strong>å¦‚æœæ¶ˆè´¹å¤„ç†é˜Ÿåˆ—è¢«ç§»é™¤ï¼Œæ°å¥½æ¶ˆæ¯è¢«æ¶ˆè´¹ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼Œå› æ­¤ï¼Œæ¶ˆæ¯æ¶ˆè´¹è¦å°½æœ€å¤§å¯èƒ½æ€§å®ç°å¹‚ç­‰æ€§</strong>ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#consumemessageconcurrentlyserviceprocessconsumeresult">ConsumeMessageConcurrentlyService#processConsumeResult(...)</a>ã€‚</li>
</ul>
<h2>ConsumeMessageConcurrentlyService#processConsumeResult(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processConsumeResult</span><span class="params">(//</span></span></div><div class="line"> <span class="number">2</span>:     <span class="keyword">final</span> ConsumeConcurrentlyStatus status, //</div><div class="line"> <span class="number">3</span>:     <span class="keyword">final</span> ConsumeConcurrentlyContext context, //</div><div class="line"> <span class="number">4</span>:     <span class="keyword">final</span> ConsumeRequest consumeRequest//</div><div class="line"> <span class="number">5</span>: ) &#123;</div><div class="line"> <span class="number">6</span>:     <span class="keyword">int</span> ackIndex = context.getAckIndex();</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:     <span class="comment">// æ¶ˆæ¯ä¸ºç©ºï¼Œç›´æ¥è¿”å›</span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">if</span> (consumeRequest.getMsgs().isEmpty())</div><div class="line"><span class="number">10</span>:         <span class="keyword">return</span>;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:     <span class="comment">// è®¡ç®—ä»consumeRequest.msgs[0]åˆ°consumeRequest.msgs[ackIndex]çš„æ¶ˆæ¯æ¶ˆè´¹æˆåŠŸ</span></div><div class="line"><span class="number">13</span>:     <span class="keyword">switch</span> (status) &#123;</div><div class="line"><span class="number">14</span>:         <span class="keyword">case</span> CONSUME_SUCCESS:</div><div class="line"><span class="number">15</span>:             <span class="keyword">if</span> (ackIndex &gt;= consumeRequest.getMsgs().size()) &#123;</div><div class="line"><span class="number">16</span>:                 ackIndex = consumeRequest.getMsgs().size() - <span class="number">1</span>;</div><div class="line"><span class="number">17</span>:             &#125;</div><div class="line"><span class="number">18</span>:             <span class="comment">// ç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ•°é‡</span></div><div class="line"><span class="number">19</span>:             <span class="keyword">int</span> ok = ackIndex + <span class="number">1</span>;</div><div class="line"><span class="number">20</span>:             <span class="keyword">int</span> failed = consumeRequest.getMsgs().size() - ok;</div><div class="line"><span class="number">21</span>:             <span class="keyword">this</span>.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), ok);</div><div class="line"><span class="number">22</span>:             <span class="keyword">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), failed);</div><div class="line"><span class="number">23</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">24</span>:         <span class="keyword">case</span> RECONSUME_LATER:</div><div class="line"><span class="number">25</span>:             ackIndex = -<span class="number">1</span>;</div><div class="line"><span class="number">26</span>:             <span class="comment">// ç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ•°é‡</span></div><div class="line"><span class="number">27</span>:             <span class="keyword">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(),</div><div class="line"><span class="number">28</span>:                 consumeRequest.getMsgs().size());</div><div class="line"><span class="number">29</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">30</span>:         <span class="keyword">default</span>:</div><div class="line"><span class="number">31</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">32</span>:     &#125;</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>:     <span class="comment">// å¤„ç†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯</span></div><div class="line"><span class="number">35</span>:     <span class="keyword">switch</span> (<span class="keyword">this</span>.defaultMQPushConsumer.getMessageModel()) &#123;</div><div class="line"><span class="number">36</span>:         <span class="keyword">case</span> BROADCASTING: <span class="comment">// å¹¿æ’­æ¨¡å¼ï¼Œæ— è®ºæ˜¯å¦æ¶ˆè´¹å¤±è´¥ï¼Œä¸å‘å›æ¶ˆæ¯åˆ°Brokerï¼Œåªæ‰“å°Log</span></div><div class="line"><span class="number">37</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = ackIndex + <span class="number">1</span>; i &lt; consumeRequest.getMsgs().size(); i++) &#123;</div><div class="line"><span class="number">38</span>:                 MessageExt msg = consumeRequest.getMsgs().get(i);</div><div class="line"><span class="number">39</span>:                 log.warn(<span class="string">"BROADCASTING, the message consume failed, drop it, &#123;&#125;"</span>, msg.toString());</div><div class="line"><span class="number">40</span>:             &#125;</div><div class="line"><span class="number">41</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">42</span>:         <span class="keyword">case</span> CLUSTERING:</div><div class="line"><span class="number">43</span>:             <span class="comment">// å‘å›æ¶ˆæ¯å¤±è´¥åˆ°Brokerã€‚</span></div><div class="line"><span class="number">44</span>:             List&lt;MessageExt&gt; msgBackFailed = <span class="keyword">new</span> ArrayList&lt;&gt;(consumeRequest.getMsgs().size());</div><div class="line"><span class="number">45</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = ackIndex + <span class="number">1</span>; i &lt; consumeRequest.getMsgs().size(); i++) &#123;</div><div class="line"><span class="number">46</span>:                 MessageExt msg = consumeRequest.getMsgs().get(i);</div><div class="line"><span class="number">47</span>:                 <span class="keyword">boolean</span> result = <span class="keyword">this</span>.sendMessageBack(msg, context);</div><div class="line"><span class="number">48</span>:                 <span class="keyword">if</span> (!result) &#123;</div><div class="line"><span class="number">49</span>:                     msg.setReconsumeTimes(msg.getReconsumeTimes() + <span class="number">1</span>);</div><div class="line"><span class="number">50</span>:                     msgBackFailed.add(msg);</div><div class="line"><span class="number">51</span>:                 &#125;</div><div class="line"><span class="number">52</span>:             &#125;</div><div class="line"><span class="number">53</span>: </div><div class="line"><span class="number">54</span>:             <span class="comment">// å‘å›Brokerå¤±è´¥çš„æ¶ˆæ¯ï¼Œç›´æ¥æäº¤å»¶è¿Ÿé‡æ–°æ¶ˆè´¹</span></div><div class="line"><span class="number">55</span>:             <span class="keyword">if</span> (!msgBackFailed.isEmpty()) &#123;</div><div class="line"><span class="number">56</span>:                 consumeRequest.getMsgs().removeAll(msgBackFailed);</div><div class="line"><span class="number">57</span>: </div><div class="line"><span class="number">58</span>:                 <span class="keyword">this</span>.submitConsumeRequestLater(msgBackFailed, consumeRequest.getProcessQueue(), consumeRequest.getMessageQueue());</div><div class="line"><span class="number">59</span>:             &#125;</div><div class="line"><span class="number">60</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">61</span>:         <span class="keyword">default</span>:</div><div class="line"><span class="number">62</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">63</span>:     &#125;</div><div class="line"><span class="number">64</span>: </div><div class="line"><span class="number">65</span>:     <span class="comment">// ç§»é™¤æ¶ˆè´¹æˆåŠŸæ¶ˆæ¯ï¼Œå¹¶æ›´æ–°æœ€æ–°æ¶ˆè´¹è¿›åº¦</span></div><div class="line"><span class="number">66</span>:     <span class="keyword">long</span> offset = consumeRequest.getProcessQueue().removeMessage(consumeRequest.getMsgs());</div><div class="line"><span class="number">67</span>:     <span class="keyword">if</span> (offset &gt;= <span class="number">0</span> &amp;&amp; !consumeRequest.getProcessQueue().isDropped()) &#123;</div><div class="line"><span class="number">68</span>:         <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(consumeRequest.getMessageQueue(), offset, <span class="keyword">true</span>);</div><div class="line"><span class="number">69</span>:     &#125;</div><div class="line"><span class="number">70</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚</li>
<li>ç¬¬ 8 è‡³ 10 è¡Œ ï¼šæ¶ˆè´¹è¯·æ±‚æ¶ˆæ¯æœªç©ºæ—¶ï¼Œç›´æ¥è¿”å›ã€‚</li>
<li>ç¬¬ 12 è‡³ 32 è¡Œ ï¼šè®¡ç®— <code>ackIndex</code> å€¼ã€‚<code>consumeRequest.msgs[0 - ackIndex]</code>ä¸ºæ¶ˆè´¹æˆåŠŸï¼Œéœ€è¦è¿›è¡Œ <code>ack</code> ç¡®è®¤ã€‚
<ul>
<li>ç¬¬ 14 è‡³ 23 è¡Œ ï¼š<code>CONSUME_SUCCESS</code> ï¼š<code>ackIndex = context.getAckIndex()</code>ã€‚</li>
<li>ç¬¬ 24 è‡³ 29 è¡Œ ï¼š<code>RECONSUME_LATER</code> ï¼š<code>ackIndex = -1</code>ã€‚</li>
</ul>
</li>
<li>ç¬¬34 è‡³ 63 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ã€‚
<ul>
<li>ç¬¬ 36 è‡³ 41 è¡Œ ï¼š<code>BROADCASTING</code> ï¼šå¹¿æ’­æ¨¡å¼ï¼Œæ— è®ºæ˜¯å¦æ¶ˆè´¹å¤±è´¥ï¼Œä¸å‘å›æ¶ˆæ¯åˆ° <code>Broker</code>ï¼Œåªæ‰“å°æ—¥å¿—ã€‚</li>
<li>ç¬¬ 42 è‡³ 60 è¡Œ ï¼š<code>CLUSTERING</code> ï¼šé›†ç¾¤æ¨¡å¼ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯å‘å›åˆ° <code>Broker</code>ã€‚
<ul>
<li>ç¬¬ 43 è‡³ 52 è¡Œ ï¼šå‘å›æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯åˆ° <code>Broker</code>ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#defaultmqpushconsumerimplsendmessageback">DefaultMQPushConsumerImpl#sendMessageBack(...)</a>ã€‚</li>
<li>ç¬¬ 54 è‡³ 59 è¡Œ ï¼šå‘å› <code>Broker</code> å¤±è´¥çš„æ¶ˆæ¯ï¼Œç›´æ¥æäº¤å»¶è¿Ÿé‡æ–°æ¶ˆè´¹ã€‚</li>
<li><strong>å¦‚æœå‘å› <code>Broker</code> æˆåŠŸï¼Œç»“æœå› ä¸ºä¾‹å¦‚ç½‘ç»œå¼‚å¸¸ï¼Œå¯¼è‡´ <code>Consumer</code>ä»¥ä¸ºå‘å›å¤±è´¥ï¼Œåˆ¤å®šæ¶ˆè´¹å‘å›å¤±è´¥ï¼Œä¼šå¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼Œå› æ­¤ï¼Œæ¶ˆæ¯æ¶ˆè´¹è¦å°½æœ€å¤§å¯èƒ½æ€§å®ç°å¹‚ç­‰æ€§ã€‚</strong></li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 65 è‡³ 69 è¡Œ ï¼šç§»é™¤**ã€æ¶ˆè´¹æˆåŠŸã€‘<strong>å’Œ</strong>ã€æ¶ˆè´¹å¤±è´¥ä½†å‘å›<code>Broker</code>æˆåŠŸã€‘**çš„æ¶ˆæ¯ï¼Œå¹¶æ›´æ–°æœ€æ–°æ¶ˆè´¹è¿›åº¦ã€‚
<ul>
<li>ä¸ºä»€ä¹ˆä¼šæœ‰**ã€æ¶ˆè´¹å¤±è´¥ä½†å‘å›<code>Broker</code>æˆåŠŸã€‘<strong>çš„æ¶ˆæ¯ï¼Ÿè§</strong>ç¬¬ 56 è¡Œ**ã€‚</li>
<li><a href="#processqueueremovemessage">ProcessQueue#removeMessage(...)</a></li>
</ul>
</li>
</ul>
<h3>ProcessQueue#removeMessage(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * ç§»é™¤æ¶ˆæ¯ï¼Œå¹¶è¿”å›ç¬¬ä¸€æ¡æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</div><div class="line"> 3:  *</div><div class="line"> 4:  * <span class="doctag">@param</span> msgs æ¶ˆæ¯</div><div class="line"> 5:  * <span class="doctag">@return</span> æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</div><div class="line"> 6:  */</div><div class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">removeMessage</span><span class="params">(<span class="keyword">final</span> List&lt;MessageExt&gt; msgs)</span> </span>&#123;</div><div class="line"> <span class="number">8</span>:     <span class="keyword">long</span> result = -<span class="number">1</span>;</div><div class="line"> <span class="number">9</span>:     <span class="keyword">final</span> <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"><span class="number">10</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">11</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"><span class="number">12</span>:         <span class="keyword">this</span>.lastConsumeTimestamp = now;</div><div class="line"><span class="number">13</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">14</span>:             <span class="keyword">if</span> (!msgTreeMap.isEmpty()) &#123;</div><div class="line"><span class="number">15</span>:                 result = <span class="keyword">this</span>.queueOffsetMax + <span class="number">1</span>; <span class="comment">// è¿™é‡Œ+1çš„åŸå› æ˜¯ï¼šå¦‚æœmsgTreeMapä¸ºç©ºæ—¶ï¼Œä¸‹ä¸€æ¡è·å¾—çš„æ¶ˆæ¯ä½ç½®ä¸ºqueueOffsetMax+1</span></div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:                 <span class="comment">// ç§»é™¤æ¶ˆæ¯</span></div><div class="line"><span class="number">18</span>:                 <span class="keyword">int</span> removedCnt = <span class="number">0</span>;</div><div class="line"><span class="number">19</span>:                 <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</div><div class="line"><span class="number">20</span>:                     MessageExt prev = msgTreeMap.remove(msg.getQueueOffset());</div><div class="line"><span class="number">21</span>:                     <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">22</span>:                         removedCnt--;</div><div class="line"><span class="number">23</span>:                     &#125;</div><div class="line"><span class="number">24</span>:                 &#125;</div><div class="line"><span class="number">25</span>:                 msgCount.addAndGet(removedCnt);</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:                 <span class="keyword">if</span> (!msgTreeMap.isEmpty()) &#123;</div><div class="line"><span class="number">28</span>:                     result = msgTreeMap.firstKey();</div><div class="line"><span class="number">29</span>:                 &#125;</div><div class="line"><span class="number">30</span>:             &#125;</div><div class="line"><span class="number">31</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">32</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:     &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line"><span class="number">35</span>:         log.error(<span class="string">"removeMessage exception"</span>, t);</div><div class="line"><span class="number">36</span>:     &#125;</div><div class="line"><span class="number">37</span>: </div><div class="line"><span class="number">38</span>:     <span class="keyword">return</span> result;</div><div class="line"><span class="number">39</span>: &#125;</div></pre></td></tr></table></figure></p>
<h2>ConsumeMessageConcurrentlyService#cleanExpireMsg(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">this</span>.cleanExpireMsgExecutors.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">6</span>:             cleanExpireMsg();</div><div class="line"> <span class="number">7</span>:         &#125;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:     &#125;, <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeTimeout(), <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeTimeout(), TimeUnit.MINUTES);</div><div class="line"><span class="number">10</span>: &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: <span class="comment">/**</span></div><div class="line">13:  * æ¸…ç†è¿‡æœŸæ¶ˆæ¯</div><div class="line">14:  */</div><div class="line"><span class="number">15</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cleanExpireMsg</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">16</span>:     Iterator&lt;Map.Entry&lt;MessageQueue, ProcessQueue&gt;&gt; it =</div><div class="line"><span class="number">17</span>:         <span class="keyword">this</span>.defaultMQPushConsumerImpl.getRebalanceImpl().getProcessQueueTable().entrySet().iterator();</div><div class="line"><span class="number">18</span>:     <span class="keyword">while</span> (it.hasNext()) &#123;</div><div class="line"><span class="number">19</span>:         Map.Entry&lt;MessageQueue, ProcessQueue&gt; next = it.next();</div><div class="line"><span class="number">20</span>:         ProcessQueue pq = next.getValue();</div><div class="line"><span class="number">21</span>:         pq.cleanExpiredMsg(<span class="keyword">this</span>.defaultMQPushConsumer);</div><div class="line"><span class="number">22</span>:     &#125;</div><div class="line"><span class="number">23</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šå®šæ—¶æ¸…ç†è¿‡æœŸæ¶ˆæ¯ï¼Œé»˜è®¤å‘¨æœŸï¼š15minã€‚</li>
</ul>
<h3>ProcessQueue#cleanExpiredMsg(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanExpiredMsg</span><span class="params">(DefaultMQPushConsumer pushConsumer)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// é¡ºåºæ¶ˆè´¹æ—¶ï¼Œç›´æ¥è¿”å›</span></div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (pushConsumer.getDefaultMQPushConsumerImpl().isConsumeOrderly()) &#123;</div><div class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">5</span>:     &#125;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="comment">// å¾ªç¯ç§»é™¤æ¶ˆæ¯</span></div><div class="line"> <span class="number">8</span>:     <span class="keyword">int</span> loop = msgTreeMap.size() &lt; <span class="number">16</span> ? msgTreeMap.size() : <span class="number">16</span>; <span class="comment">// æ¯æ¬¡å¾ªç¯æœ€å¤šç§»é™¤16æ¡</span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loop; i++) &#123;</div><div class="line"><span class="number">10</span>:         <span class="comment">// è·å–ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œè‹¥ä¸è¶…æ—¶ï¼Œåˆ™ç»“æŸå¾ªç¯</span></div><div class="line"><span class="number">11</span>:         MessageExt msg = <span class="keyword">null</span>;</div><div class="line"><span class="number">12</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">13</span>:             <span class="keyword">this</span>.lockTreeMap.readLock().lockInterruptibly();</div><div class="line"><span class="number">14</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">15</span>:                 <span class="keyword">if</span> (!msgTreeMap.isEmpty() &amp;&amp; System.currentTimeMillis() - Long.parseLong(MessageAccessor.getConsumeStartTimeStamp(msgTreeMap.firstEntry().getValue())) &gt; pushConsumer.getConsumeTimeout() * <span class="number">60</span> * <span class="number">1000</span>) &#123;</div><div class="line"><span class="number">16</span>:                     msg = msgTreeMap.firstEntry().getValue();</div><div class="line"><span class="number">17</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">18</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">19</span>:                 &#125;</div><div class="line"><span class="number">20</span>:             &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">21</span>:                 <span class="keyword">this</span>.lockTreeMap.readLock().unlock();</div><div class="line"><span class="number">22</span>:             &#125;</div><div class="line"><span class="number">23</span>:         &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"><span class="number">24</span>:             log.error(<span class="string">"getExpiredMsg exception"</span>, e);</div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">28</span>:             <span class="comment">// å‘å›è¶…æ—¶æ¶ˆæ¯</span></div><div class="line"><span class="number">29</span>:             pushConsumer.sendMessageBack(msg, <span class="number">3</span>);</div><div class="line"><span class="number">30</span>:             log.info(<span class="string">"send expire msg back. topic=&#123;&#125;, msgId=&#123;&#125;, storeHost=&#123;&#125;, queueId=&#123;&#125;, queueOffset=&#123;&#125;"</span>, msg.getTopic(), msg.getMsgId(), msg.getStoreHost(), msg.getQueueId(), msg.getQueueOffset());</div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>:             <span class="comment">// åˆ¤æ–­æ­¤æ—¶æ¶ˆæ¯æ˜¯å¦ä¾ç„¶æ˜¯ç¬¬ä¸€æ¡ï¼Œè‹¥æ˜¯ï¼Œåˆ™è¿›è¡Œç§»é™¤</span></div><div class="line"><span class="number">33</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">34</span>:                 <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"><span class="number">35</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">36</span>:                     <span class="keyword">if</span> (!msgTreeMap.isEmpty() &amp;&amp; msg.getQueueOffset() == msgTreeMap.firstKey()) &#123;</div><div class="line"><span class="number">37</span>:                         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">38</span>:                             msgTreeMap.remove(msgTreeMap.firstKey());</div><div class="line"><span class="number">39</span>:                         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">40</span>:                             log.error(<span class="string">"send expired msg exception"</span>, e);</div><div class="line"><span class="number">41</span>:                         &#125;</div><div class="line"><span class="number">42</span>:                     &#125;</div><div class="line"><span class="number">43</span>:                 &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">44</span>:                     <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"><span class="number">45</span>:                 &#125;</div><div class="line"><span class="number">46</span>:             &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"><span class="number">47</span>:                 log.error(<span class="string">"getExpiredMsg exception"</span>, e);</div><div class="line"><span class="number">48</span>:             &#125;</div><div class="line"><span class="number">49</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">50</span>:             log.error(<span class="string">"send expired msg exception"</span>, e);</div><div class="line"><span class="number">51</span>:         &#125;</div><div class="line"><span class="number">52</span>:     &#125;</div><div class="line"><span class="number">53</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šç§»é™¤è¿‡æœŸæ¶ˆæ¯ã€‚</li>
<li>ç¬¬ 2 è‡³ 5 è¡Œ ï¼šé¡ºåºæ¶ˆè´¹æ—¶ï¼Œç›´æ¥è¿”å›ã€‚</li>
<li>ç¬¬ 7 è‡³ 9 è¡Œ ï¼šå¾ªç¯ç§»é™¤æ¶ˆæ¯ã€‚é»˜è®¤æœ€å¤§å¾ªç¯æ¬¡æ•°ï¼š16æ¬¡ã€‚</li>
<li>ç¬¬ 10 è‡³ 25 è¡Œ ï¼šè·å–ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œè‹¥ä¸è¶…æ—¶ï¼Œåˆ™ç»“æŸå¾ªç¯ã€‚</li>
<li>ç¬¬ 29 è¡Œ ï¼š<strong>å‘å›è¶…æ—¶æ¶ˆæ¯åˆ°<code>Broker</code></strong>ã€‚</li>
<li>ç¬¬ 32 è‡³ 48 è¡Œ ï¼šåˆ¤æ–­æ­¤æ—¶æ¶ˆæ¯æ˜¯å¦ä¾ç„¶æ˜¯ç¬¬ä¸€æ¡ï¼Œè‹¥æ˜¯ï¼Œåˆ™è¿›è¡Œç§»é™¤ã€‚</li>
</ul>
<h1>7ã€PushConsumer å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯</h1>
<h2>DefaultMQPushConsumerImpl#sendMessageBack(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessageBack</span><span class="params">(MessageExt msg, <span class="keyword">int</span> delayLevel, <span class="keyword">final</span> String brokerName)</span></span></div><div class="line"> 2:     <span class="keyword">throws</span> RemotingException, MQBrokerException, InterruptedException, MQClientException &#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">4</span>:         <span class="comment">// Consumerå‘å›æ¶ˆæ¯</span></div><div class="line"> <span class="number">5</span>:         String brokerAddr = (<span class="keyword">null</span> != brokerName) ? <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInPublish(brokerName)</div><div class="line"> <span class="number">6</span>:             : RemotingHelper.parseSocketAddressAddr(msg.getStoreHost());</div><div class="line"> <span class="number">7</span>:         <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().consumerSendMessageBack(brokerAddr, msg,</div><div class="line"> <span class="number">8</span>:             <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup(), delayLevel, <span class="number">5000</span>, getMaxReconsumeTimes());</div><div class="line"> <span class="number">9</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123; <span class="comment">// TODO ç–‘é—®ï¼šä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”Ÿå¼‚å¸¸</span></div><div class="line"><span class="number">10</span>:         <span class="comment">// å¼‚å¸¸æ—¶ï¼Œä½¿ç”¨Clientå†…ç½®Producerå‘å›æ¶ˆæ¯</span></div><div class="line"><span class="number">11</span>:         log.error(<span class="string">"sendMessageBack Exception, "</span> + <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup(), e);</div><div class="line"><span class="number">12</span>: </div><div class="line"><span class="number">13</span>:         Message newMsg = <span class="keyword">new</span> Message(MixAll.getRetryTopic(<span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup()), msg.getBody());</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:         String originMsgId = MessageAccessor.getOriginMessageId(msg);</div><div class="line"><span class="number">16</span>:         MessageAccessor.setOriginMessageId(newMsg, UtilAll.isBlank(originMsgId) ? msg.getMsgId() : originMsgId);</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:         newMsg.setFlag(msg.getFlag());</div><div class="line"><span class="number">19</span>:         MessageAccessor.setProperties(newMsg, msg.getProperties());</div><div class="line"><span class="number">20</span>:         MessageAccessor.putProperty(newMsg, MessageConst.PROPERTY_RETRY_TOPIC, msg.getTopic());</div><div class="line"><span class="number">21</span>:         MessageAccessor.setReconsumeTime(newMsg, String.valueOf(msg.getReconsumeTimes() + <span class="number">1</span>));</div><div class="line"><span class="number">22</span>:         MessageAccessor.setMaxReconsumeTimes(newMsg, String.valueOf(getMaxReconsumeTimes()));</div><div class="line"><span class="number">23</span>:         newMsg.setDelayTimeLevel(<span class="number">3</span> + msg.getReconsumeTimes());</div><div class="line"><span class="number">24</span>: </div><div class="line"><span class="number">25</span>:         <span class="keyword">this</span>.mQClientFactory.getDefaultMQProducer().send(newMsg);</div><div class="line"><span class="number">26</span>:     &#125;</div><div class="line"><span class="number">27</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šå‘å›æ¶ˆæ¯ã€‚</li>
<li>ç¬¬ 4 è‡³ 8 è¡Œ ï¼š<code>Consumer</code> å‘å›æ¶ˆæ¯ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#mqclientapiimplconsumersendmessageback">MQClientAPIImpl#consumerSendMessageBack(...)</a>ã€‚</li>
<li>ç¬¬ 10 è‡³ 25 è¡Œ ï¼šå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œ<code>Consumer</code> å†…ç½®é»˜è®¤ <code>Producer</code> å‘é€æ¶ˆæ¯ã€‚
<ul>
<li>ğŸ˜ˆç–‘é—®ï¼šä»€ä¹ˆæ ·çš„æƒ…å†µä¸‹ä¼šå‘ç”Ÿå¼‚å¸¸å‘¢ï¼Ÿ</li>
</ul>
</li>
</ul>
<h3>MQClientAPIImpl#consumerSendMessageBack(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * Consumerå‘å›æ¶ˆæ¯</div><div class="line"> 3:  * <span class="doctag">@param</span> addr Brokeråœ°å€</div><div class="line"> 4:  * <span class="doctag">@param</span> msg æ¶ˆæ¯</div><div class="line"> 5:  * <span class="doctag">@param</span> consumerGroup æ¶ˆè´¹åˆ†ç»„</div><div class="line"> 6:  * <span class="doctag">@param</span> delayLevel å»¶è¿Ÿçº§åˆ«</div><div class="line"> 7:  * <span class="doctag">@param</span> timeoutMillis è¶…æ—¶</div><div class="line"> 8:  * <span class="doctag">@param</span> maxConsumeRetryTimes æ¶ˆè´¹æœ€å¤§é‡è¯•æ¬¡æ•°</div><div class="line"> 9:  * <span class="doctag">@throws</span> RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class="line">10:  * <span class="doctag">@throws</span> MQBrokerException å½“Brokerå‘ç”Ÿå¼‚å¸¸æ—¶</div><div class="line">11:  * <span class="doctag">@throws</span> InterruptedException å½“çº¿ç¨‹ä¸­æ–­æ—¶</div><div class="line">12:  */</div><div class="line"><span class="number">13</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumerSendMessageBack</span><span class="params">(</span></span></div><div class="line"><span class="number">14</span>:     <span class="keyword">final</span> String addr,</div><div class="line"><span class="number">15</span>:     <span class="keyword">final</span> MessageExt msg,</div><div class="line"><span class="number">16</span>:     <span class="keyword">final</span> String consumerGroup,</div><div class="line"><span class="number">17</span>:     <span class="keyword">final</span> <span class="keyword">int</span> delayLevel,</div><div class="line"><span class="number">18</span>:     <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis,</div><div class="line"><span class="number">19</span>:     <span class="keyword">final</span> <span class="keyword">int</span> maxConsumeRetryTimes</div><div class="line"><span class="number">20</span>: ) <span class="keyword">throws</span> RemotingException, MQBrokerException, InterruptedException &#123;</div><div class="line"><span class="number">21</span>:     ConsumerSendMsgBackRequestHeader requestHeader = <span class="keyword">new</span> ConsumerSendMsgBackRequestHeader();</div><div class="line"><span class="number">22</span>:     RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CONSUMER_SEND_MSG_BACK, requestHeader);</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:     requestHeader.setGroup(consumerGroup);</div><div class="line"><span class="number">25</span>:     requestHeader.setOriginTopic(msg.getTopic());</div><div class="line"><span class="number">26</span>:     requestHeader.setOffset(msg.getCommitLogOffset());</div><div class="line"><span class="number">27</span>:     requestHeader.setDelayLevel(delayLevel);</div><div class="line"><span class="number">28</span>:     requestHeader.setOriginMsgId(msg.getMsgId());</div><div class="line"><span class="number">29</span>:     requestHeader.setMaxReconsumeTimes(maxConsumeRetryTimes);</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:     RemotingCommand response = <span class="keyword">this</span>.remotingClient.invokeSync(MixAll.brokerVIPChannel(<span class="keyword">this</span>.clientConfig.isVipChannelEnabled(), addr),</div><div class="line"><span class="number">32</span>:         request, timeoutMillis);</div><div class="line"><span class="number">33</span>:     <span class="keyword">assert</span> response != <span class="keyword">null</span>;</div><div class="line"><span class="number">34</span>:     <span class="keyword">switch</span> (response.getCode()) &#123;</div><div class="line"><span class="number">35</span>:         <span class="keyword">case</span> ResponseCode.SUCCESS: &#123;</div><div class="line"><span class="number">36</span>:             <span class="keyword">return</span>;</div><div class="line"><span class="number">37</span>:         &#125;</div><div class="line"><span class="number">38</span>:         <span class="keyword">default</span>:</div><div class="line"><span class="number">39</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">40</span>:     &#125;</div><div class="line"><span class="number">41</span>: </div><div class="line"><span class="number">42</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> MQBrokerException(response.getCode(), response.getRemark());</div><div class="line"><span class="number">43</span>: &#125;</div></pre></td></tr></table></figure></p>
<h1>8ã€Consumer æ¶ˆè´¹è¿›åº¦</h1>
<h2>OffsetStore</h2>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/07.png" alt="OffsetStoreç±»å›¾.png"></p>
<ul>
<li><code>RemoteBrokerOffsetStore</code> ï¼š<code>Consumer</code> <strong>é›†ç¾¤æ¨¡å¼</strong> ä¸‹ï¼Œä½¿ç”¨è¿œç¨‹ <code>Broker</code> æ¶ˆè´¹è¿›åº¦ã€‚</li>
<li><code>LocalFileOffsetStore</code> ï¼š<code>Consumer</code> <strong>å¹¿æ’­æ¨¡å¼</strong>ä¸‹ï¼Œä½¿ç”¨æœ¬åœ° <code>æ–‡ä»¶</code> æ¶ˆè´¹è¿›åº¦ã€‚</li>
</ul>
<h3>OffsetStore#load(...)</h3>
<h4>LocalFileOffsetStore#load(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> <span class="keyword">throws</span> MQClientException </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// ä»æœ¬åœ°ç¡¬ç›˜è¯»å–æ¶ˆè´¹è¿›åº¦</span></div><div class="line"> <span class="number">4</span>:     OffsetSerializeWrapper offsetSerializeWrapper = <span class="keyword">this</span>.readLocalOffset();</div><div class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (offsetSerializeWrapper != <span class="keyword">null</span> &amp;&amp; offsetSerializeWrapper.getOffsetTable() != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">6</span>:         offsetTable.putAll(offsetSerializeWrapper.getOffsetTable());</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:         <span class="comment">// æ‰“å°æ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">for</span> (MessageQueue mq : offsetSerializeWrapper.getOffsetTable().keySet()) &#123;</div><div class="line"><span class="number">10</span>:             AtomicLong offset = offsetSerializeWrapper.getOffsetTable().get(mq);</div><div class="line"><span class="number">11</span>:             log.info(<span class="string">"load consumer's offset, &#123;&#125; &#123;&#125; &#123;&#125;"</span>,</div><div class="line"><span class="number">12</span>:                 <span class="keyword">this</span>.groupName,</div><div class="line"><span class="number">13</span>:                 mq,</div><div class="line"><span class="number">14</span>:                 offset.get());</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>:     &#125;</div><div class="line"><span class="number">17</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šä»æœ¬åœ°æ–‡ä»¶åŠ è½½æ¶ˆè´¹è¿›åº¦åˆ°å†…å­˜ã€‚</li>
</ul>
<h5>OffsetSerializeWrapper</h5>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OffsetSerializeWrapper</span> <span class="keyword">extends</span> <span class="title">RemotingSerializable</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; offsetTable =</div><div class="line"> <span class="number">3</span>:             <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; <span class="title">getOffsetTable</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">6</span>:         <span class="keyword">return</span> offsetTable;</div><div class="line"> <span class="number">7</span>:     &#125;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOffsetTable</span><span class="params">(ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; offsetTable)</span> </span>&#123;</div><div class="line"><span class="number">10</span>:         <span class="keyword">this</span>.offsetTable = offsetTable;</div><div class="line"><span class="number">11</span>:     &#125;</div><div class="line"><span class="number">12</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šæœ¬åœ° <code>Offset</code> å­˜å‚¨åºåˆ—åŒ–ã€‚</li>
</ul>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">Yunai-MacdeMacBook-Pro-2:config yunai$ cat /Users/yunai/.rocketmq_offsets/192.168.17.0@DEFAULT/please_rename_unique_group_name_1/offsets.json</div><div class="line">&#123;</div><div class="line">	<span class="string">"offsetTable"</span>:&#123;&#123;</div><div class="line">			<span class="string">"brokerName"</span>:<span class="string">"broker-a"</span>,</div><div class="line">			<span class="string">"queueId"</span>:3,</div><div class="line">			<span class="string">"topic"</span>:<span class="string">"TopicTest"</span></div><div class="line">		&#125;:1470,&#123;</div><div class="line">			<span class="string">"brokerName"</span>:<span class="string">"broker-a"</span>,</div><div class="line">			<span class="string">"queueId"</span>:2,</div><div class="line">			<span class="string">"topic"</span>:<span class="string">"TopicTest"</span></div><div class="line">		&#125;:1471,&#123;</div><div class="line">			<span class="string">"brokerName"</span>:<span class="string">"broker-a"</span>,</div><div class="line">			<span class="string">"queueId"</span>:1,</div><div class="line">			<span class="string">"topic"</span>:<span class="string">"TopicTest"</span></div><div class="line">		&#125;:1470,&#123;</div><div class="line">			<span class="string">"brokerName"</span>:<span class="string">"broker-a"</span>,</div><div class="line">			<span class="string">"queueId"</span>:0,</div><div class="line">			<span class="string">"topic"</span>:<span class="string">"TopicTest"</span></div><div class="line">		&#125;:1470</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4>RemoteBrokerOffsetStore#load(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">3</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šä¸è¿›è¡ŒåŠ è½½ï¼Œå®é™…è¯»å–æ¶ˆè´¹è¿›åº¦æ—¶ï¼Œä» <code>Broker</code> è·å–ã€‚</li>
</ul>
<h3>OffsetStore#readOffset(...)</h3>
<p>è¯»å–æ¶ˆè´¹è¿›åº¦ç±»å‹ï¼š</p>
<ul>
<li><code>READ_FROM_MEMORY</code> ï¼šä»å†…å­˜è¯»å–ã€‚</li>
<li><code>READ_FROM_STORE</code> ï¼šä»å­˜å‚¨( <code>Broker</code> æˆ– <code>æ–‡ä»¶</code> )è¯»å–ã€‚</li>
<li><code>MEMORY_FIRST_THEN_STORE</code> ï¼šä¼˜å…ˆä»å†…å­˜è¯»å–ï¼Œè¯»å–ä¸åˆ°ï¼Œä»å­˜å‚¨è¯»å–ã€‚</li>
</ul>
<h4>LocalFileOffsetStore#readOffset(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">readOffset</span><span class="params">(<span class="keyword">final</span> MessageQueue mq, <span class="keyword">final</span> ReadOffsetType type)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (mq != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">4</span>:         <span class="keyword">switch</span> (type) &#123;</div><div class="line"> <span class="number">5</span>:             <span class="keyword">case</span> MEMORY_FIRST_THEN_STORE:</div><div class="line"> <span class="number">6</span>:             <span class="keyword">case</span> READ_FROM_MEMORY: &#123;</div><div class="line"> <span class="number">7</span>:                 AtomicLong offset = <span class="keyword">this</span>.offsetTable.get(mq);</div><div class="line"> <span class="number">8</span>:                 <span class="keyword">if</span> (offset != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">9</span>:                     <span class="keyword">return</span> offset.get();</div><div class="line"><span class="number">10</span>:                 &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ReadOffsetType.READ_FROM_MEMORY == type) &#123;</div><div class="line"><span class="number">11</span>:                     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">12</span>:                 &#125;</div><div class="line"><span class="number">13</span>:             &#125;</div><div class="line"><span class="number">14</span>:             <span class="keyword">case</span> READ_FROM_STORE: &#123;</div><div class="line"><span class="number">15</span>:                 OffsetSerializeWrapper offsetSerializeWrapper;</div><div class="line"><span class="number">16</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">17</span>:                     offsetSerializeWrapper = <span class="keyword">this</span>.readLocalOffset();</div><div class="line"><span class="number">18</span>:                 &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</div><div class="line"><span class="number">19</span>:                     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">20</span>:                 &#125;</div><div class="line"><span class="number">21</span>:                 <span class="keyword">if</span> (offsetSerializeWrapper != <span class="keyword">null</span> &amp;&amp; offsetSerializeWrapper.getOffsetTable() != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">22</span>:                     AtomicLong offset = offsetSerializeWrapper.getOffsetTable().get(mq);</div><div class="line"><span class="number">23</span>:                     <span class="keyword">if</span> (offset != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">24</span>:                         <span class="keyword">this</span>.updateOffset(mq, offset.get(), <span class="keyword">false</span>);</div><div class="line"><span class="number">25</span>:                         <span class="keyword">return</span> offset.get();</div><div class="line"><span class="number">26</span>:                     &#125;</div><div class="line"><span class="number">27</span>:                 &#125;</div><div class="line"><span class="number">28</span>:             &#125;</div><div class="line"><span class="number">29</span>:             <span class="keyword">default</span>:</div><div class="line"><span class="number">30</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">31</span>:         &#125;</div><div class="line"><span class="number">32</span>:     &#125;</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>:     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">35</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬ 16 è¡Œ ï¼šä» <code>æ–‡ä»¶</code> è¯»å–æ¶ˆè´¹è¿›åº¦ã€‚</li>
</ul>
<h4>RemoteBrokerOffsetStore#readOffset(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">readOffset</span><span class="params">(<span class="keyword">final</span> MessageQueue mq, <span class="keyword">final</span> ReadOffsetType type)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (mq != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">4</span>:         <span class="keyword">switch</span> (type) &#123;</div><div class="line"> <span class="number">5</span>:             <span class="keyword">case</span> MEMORY_FIRST_THEN_STORE:</div><div class="line"> <span class="number">6</span>:             <span class="keyword">case</span> READ_FROM_MEMORY: &#123;</div><div class="line"> <span class="number">7</span>:                 AtomicLong offset = <span class="keyword">this</span>.offsetTable.get(mq);</div><div class="line"> <span class="number">8</span>:                 <span class="keyword">if</span> (offset != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">9</span>:                     <span class="keyword">return</span> offset.get();</div><div class="line"><span class="number">10</span>:                 &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ReadOffsetType.READ_FROM_MEMORY == type) &#123;</div><div class="line"><span class="number">11</span>:                     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">12</span>:                 &#125;</div><div class="line"><span class="number">13</span>:             &#125;</div><div class="line"><span class="number">14</span>:             <span class="keyword">case</span> READ_FROM_STORE: &#123;</div><div class="line"><span class="number">15</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">16</span>:                     <span class="keyword">long</span> brokerOffset = <span class="keyword">this</span>.fetchConsumeOffsetFromBroker(mq);</div><div class="line"><span class="number">17</span>:                     AtomicLong offset = <span class="keyword">new</span> AtomicLong(brokerOffset);</div><div class="line"><span class="number">18</span>:                     <span class="keyword">this</span>.updateOffset(mq, offset.get(), <span class="keyword">false</span>);</div><div class="line"><span class="number">19</span>:                     <span class="keyword">return</span> brokerOffset;</div><div class="line"><span class="number">20</span>:                 &#125;</div><div class="line"><span class="number">21</span>:                 <span class="comment">// No offset in broker</span></div><div class="line"><span class="number">22</span>:                 <span class="keyword">catch</span> (MQBrokerException e) &#123;</div><div class="line"><span class="number">23</span>:                     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">24</span>:                 &#125;</div><div class="line"><span class="number">25</span>:                 <span class="comment">//Other exceptions</span></div><div class="line"><span class="number">26</span>:                 <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">27</span>:                     log.warn(<span class="string">"fetchConsumeOffsetFromBroker exception, "</span> + mq, e);</div><div class="line"><span class="number">28</span>:                     <span class="keyword">return</span> -<span class="number">2</span>;</div><div class="line"><span class="number">29</span>:                 &#125;</div><div class="line"><span class="number">30</span>:             &#125;</div><div class="line"><span class="number">31</span>:             <span class="keyword">default</span>:</div><div class="line"><span class="number">32</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:     &#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>:     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">37</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬ 16 è¡Œ ï¼šä» <code>Broker</code> è¯»å–æ¶ˆè´¹è¿›åº¦ã€‚</li>
</ul>
<h3>OffsetStore#updateOffset(...)</h3>
<p>è¯¥æ–¹æ³• <code>RemoteBrokerOffsetStore</code> ä¸ <code>LocalFileOffsetStore</code> å®ç°ç›¸åŒã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateOffset</span><span class="params">(MessageQueue mq, <span class="keyword">long</span> offset, <span class="keyword">boolean</span> increaseOnly)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (mq != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">4</span>:         AtomicLong offsetOld = <span class="keyword">this</span>.offsetTable.get(mq);</div><div class="line"> <span class="number">5</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == offsetOld) &#123;</div><div class="line"> <span class="number">6</span>:             offsetOld = <span class="keyword">this</span>.offsetTable.putIfAbsent(mq, <span class="keyword">new</span> AtomicLong(offset));</div><div class="line"> <span class="number">7</span>:         &#125;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> != offsetOld) &#123;</div><div class="line"><span class="number">10</span>:             <span class="keyword">if</span> (increaseOnly) &#123;</div><div class="line"><span class="number">11</span>:                 MixAll.compareAndIncreaseOnly(offsetOld, offset);</div><div class="line"><span class="number">12</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">13</span>:                 offsetOld.set(offset);</div><div class="line"><span class="number">14</span>:             &#125;</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>:     &#125;</div><div class="line"><span class="number">17</span>: &#125;</div></pre></td></tr></table></figure></p>
<h3>OffsetStore#persistAll(...)</h3>
<h4>LocalFileOffsetStore#persistAll(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">persistAll</span><span class="params">(Set&lt;MessageQueue&gt; mqs)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == mqs || mqs.isEmpty())</div><div class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:     OffsetSerializeWrapper offsetSerializeWrapper = <span class="keyword">new</span> OffsetSerializeWrapper();</div><div class="line"> <span class="number">7</span>:     <span class="keyword">for</span> (Map.Entry&lt;MessageQueue, AtomicLong&gt; entry : <span class="keyword">this</span>.offsetTable.entrySet()) &#123;</div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (mqs.contains(entry.getKey())) &#123;</div><div class="line"> <span class="number">9</span>:             AtomicLong offset = entry.getValue();</div><div class="line"><span class="number">10</span>:             offsetSerializeWrapper.getOffsetTable().put(entry.getKey(), offset);</div><div class="line"><span class="number">11</span>:         &#125;</div><div class="line"><span class="number">12</span>:     &#125;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>:     String jsonString = offsetSerializeWrapper.toJson(<span class="keyword">true</span>);</div><div class="line"><span class="number">15</span>:     <span class="keyword">if</span> (jsonString != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">16</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">17</span>:             MixAll.string2File(jsonString, <span class="keyword">this</span>.storePath);</div><div class="line"><span class="number">18</span>:         &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line"><span class="number">19</span>:             log.error(<span class="string">"persistAll consumer offset Exception, "</span> + <span class="keyword">this</span>.storePath, e);</div><div class="line"><span class="number">20</span>:         &#125;</div><div class="line"><span class="number">21</span>:     &#125;</div><div class="line"><span class="number">22</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šæŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ã€‚<strong>å°†æ¶ˆè´¹è¿›åº¦å†™å…¥æ–‡ä»¶</strong>ã€‚</li>
</ul>
<h4>RemoteBrokerOffsetStore#persistAll(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">persistAll</span><span class="params">(Set&lt;MessageQueue&gt; mqs)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == mqs || mqs.isEmpty())</div><div class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:     <span class="comment">// æŒä¹…åŒ–æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"> <span class="number">7</span>:     <span class="keyword">final</span> HashSet&lt;MessageQueue&gt; unusedMQ = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (!mqs.isEmpty()) &#123;</div><div class="line"> <span class="number">9</span>:         <span class="keyword">for</span> (Map.Entry&lt;MessageQueue, AtomicLong&gt; entry : <span class="keyword">this</span>.offsetTable.entrySet()) &#123;</div><div class="line"><span class="number">10</span>:             MessageQueue mq = entry.getKey();</div><div class="line"><span class="number">11</span>:             AtomicLong offset = entry.getValue();</div><div class="line"><span class="number">12</span>:             <span class="keyword">if</span> (offset != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">13</span>:                 <span class="keyword">if</span> (mqs.contains(mq)) &#123;</div><div class="line"><span class="number">14</span>:                     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">15</span>:                         <span class="keyword">this</span>.updateConsumeOffsetToBroker(mq, offset.get());</div><div class="line"><span class="number">16</span>:                         log.info(<span class="string">"[persistAll] Group: &#123;&#125; ClientId: &#123;&#125; updateConsumeOffsetToBroker &#123;&#125; &#123;&#125;"</span>,</div><div class="line"><span class="number">17</span>:                             <span class="keyword">this</span>.groupName,</div><div class="line"><span class="number">18</span>:                             <span class="keyword">this</span>.mQClientFactory.getClientId(),</div><div class="line"><span class="number">19</span>:                             mq,</div><div class="line"><span class="number">20</span>:                             offset.get());</div><div class="line"><span class="number">21</span>:                     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">22</span>:                         log.error(<span class="string">"updateConsumeOffsetToBroker exception, "</span> + mq.toString(), e);</div><div class="line"><span class="number">23</span>:                     &#125;</div><div class="line"><span class="number">24</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">25</span>:                     unusedMQ.add(mq);</div><div class="line"><span class="number">26</span>:                 &#125;</div><div class="line"><span class="number">27</span>:             &#125;</div><div class="line"><span class="number">28</span>:         &#125;</div><div class="line"><span class="number">29</span>:     &#125;</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:     <span class="comment">// ç§»é™¤ä¸é€‚ç”¨çš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"><span class="number">32</span>:     <span class="keyword">if</span> (!unusedMQ.isEmpty()) &#123;</div><div class="line"><span class="number">33</span>:         <span class="keyword">for</span> (MessageQueue mq : unusedMQ) &#123;</div><div class="line"><span class="number">34</span>:             <span class="keyword">this</span>.offsetTable.remove(mq);</div><div class="line"><span class="number">35</span>:             log.info(<span class="string">"remove unused mq, &#123;&#125;, &#123;&#125;"</span>, mq, <span class="keyword">this</span>.groupName);</div><div class="line"><span class="number">36</span>:         &#125;</div><div class="line"><span class="number">37</span>:     &#125;</div><div class="line"><span class="number">38</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šæŒä¹…åŒ–æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—æ•°ç»„çš„æ¶ˆè´¹è¿›åº¦åˆ° <code>Broker</code>ï¼Œå¹¶ç§»é™¤éæŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
</ul>
<h4>MQClientInstance#persistAllConsumerOffset(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startScheduledTask</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// å®šæ—¶åŒæ­¥æ¶ˆè´¹è¿›åº¦</span></div><div class="line"> <span class="number">3</span>:     <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">6</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">7</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">8</span>:                 MQClientInstance.<span class="keyword">this</span>.cleanOfflineBroker();</div><div class="line"> <span class="number">9</span>:                 MQClientInstance.<span class="keyword">this</span>.sendHeartbeatToAllBrokerWithLock();</div><div class="line"><span class="number">10</span>:             &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">11</span>:                 log.error(<span class="string">"ScheduledTask sendHeartbeatToAllBroker exception"</span>, e);</div><div class="line"><span class="number">12</span>:             &#125;</div><div class="line"><span class="number">13</span>:         &#125;</div><div class="line"><span class="number">14</span>:     &#125;, <span class="number">1000</span>, <span class="keyword">this</span>.clientConfig.getHeartbeatBrokerInterval(), TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">15</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šå®šæ—¶è¿›è¡ŒæŒä¹…åŒ–ï¼Œé»˜è®¤å‘¨æœŸï¼š5000msã€‚</li>
<li><strong>é‡è¦è¯´æ˜ ï¼š</strong>
<ul>
<li><strong>æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚</strong></li>
<li><strong>æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚</strong></li>
<li><strong>æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚</strong></li>
</ul>
</li>
</ul>
<h1>9ã€ç»“å°¾</h1>
<p>ğŸ˜ˆå¯èƒ½æ˜¯æœ¬ç³»åˆ—æœ€é•¿çš„ä¸€ç¯‡æ–‡ç« ï¼Œå¦‚æœ‰è¡¨è¾¾é”™è¯¯å’Œä¸æ¸…æ™°ï¼Œè¯·å¤šå¤šè§è°…ã€‚<br>
æ„Ÿè°¢å¯¹æœ¬ç³»åˆ—çš„é˜…è¯»ã€æ”¶è—ã€ç‚¹èµã€åˆ†äº«ï¼Œç‰¹åˆ«æ˜¯ç¿»åˆ°ç»“å°¾ã€‚ğŸ˜œçœŸçš„æœ‰ä¸¢ä¸¢é•¿ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rock
    
    </summary>
    
      <category term="RocketMQ" scheme="http://www.yunai.me/categories/RocketMQ/"/>
    
    
  </entry>
  
  <entry>
    <title>RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰</title>
    <link href="http://www.yunai.me/RocketMQ/message-pull-and-consume-first/"/>
    <id>http://www.yunai.me/RocketMQ/message-pull-and-consume-first/</id>
    <published>2017-05-03T16:00:00.000Z</published>
    <updated>2017-07-27T16:55:46.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1ã€æ¦‚è¿°</a></li>
<li><a href="#">2ã€ConsumeQueue ç»“æ„</a></li>
<li><a href="#">3ã€ConsumeQueue å­˜å‚¨</a>
<ul>
<li><a href="#">ReputMessageService</a>
<ul>
<li><a href="#">DefaultMessageStore#doDispatch(...)</a></li>
<li><a href="#">ConsumeQueue#putMessagePositionInfoWrapper(...)</a></li>
</ul>
</li>
<li><a href="#">FlushConsumeQueueService</a></li>
</ul>
</li>
<li><a href="#">4ã€Broker æä¾›[æ‹‰å–æ¶ˆæ¯]æ¥å£</a>
<ul>
<li><a href="#">PullMessageRequestHeader</a></li>
<li><a href="#">PullMessageProcessor#processRequest(...)</a></li>
<li><a href="#">MessageStore#getMessage(...)</a></li>
<li><a href="#">DefaultMessageFilter#isMessageMatched(...)</a></li>
<li><a href="#">PullRequestHoldService</a></li>
<li><a href="#">PullMessageProcessor#executeRequestWhenWakeup(...)</a></li>
</ul>
</li>
<li><a href="#">5ã€Broker æä¾›[æ›´æ–°æ¶ˆè´¹è¿›åº¦]æ¥å£</a>
<ul>
<li><a href="#">BrokerController#initialize(...)</a></li>
<li><a href="#">ConfigManager</a>
<ul>
<li><a href="#">MixAll#string2File(...)</a></li>
</ul>
</li>
<li><a href="#">ConsumerOffsetManager</a></li>
</ul>
</li>
<li><a href="#">6ã€Broker æä¾›[å‘å›æ¶ˆæ¯]æ¥å£</a>
<ul>
<li><a href="#">SendMessageProcessor#consumerSendMsgBack(...)</a></li>
</ul>
</li>
<li><a href="#">7ã€ç»“å°¾</a></li>
</ul>
<h1>1ã€æ¦‚è¿°</h1>
<p>æœ¬ç« ä¸»è¦è§£æ <strong>æ¶ˆè´¹</strong> é€»è¾‘æ¶‰åŠåˆ°çš„æºç ã€‚
å› ä¸ºç¯‡å¹…è¾ƒé•¿ï¼Œåˆ†æˆä¸Šä¸‹ä¸¤ç¯‡ï¼š</p>
<ol>
<li>ä¸Šç¯‡ï¼š<code>Broker</code> ç›¸å…³æºç ã€‚</li>
<li>ä¸‹ç¯‡ï¼š<code>Consumer</code> ç›¸å…³æºç ã€‚</li>
</ol>
<p><em>æœ¬æ–‡å³æ˜¯ä¸Šç¯‡ã€‚</em></p>
<hr>
<p>okï¼Œå…ˆçœ‹ç¬¬ä¸€å¼ å…³äºæ¶ˆè´¹é€»è¾‘çš„å›¾ï¼š</p>
<blockquote>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/13.png" alt="æ¶ˆè´¹é€»è¾‘å›¾"></p>
</blockquote>
<p>å†çœ‹æ¶ˆè´¹é€»è¾‘ç²¾ç®€çš„é¡ºåºå›¾ï¼ˆå®é™…æƒ…å†µä¼šç•¥æœ‰å·®åˆ«ï¼‰ï¼š</p>
<blockquote>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/04.png" alt="Consumer&amp;amp;Brokeræ¶ˆè´¹ç²¾ç®€å›¾.png"></p>
</blockquote>
<h1>2ã€ConsumeQueue ç»“æ„</h1>
<p><code>ConsumeQueue</code>ã€<code>MappedFileQueue</code>ã€<code>MappedFile</code> çš„å…³ç³»å¦‚ä¸‹ï¼š</p>
<blockquote>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/03.png" alt="ConsumeQueueã€MappedFileQueueã€MappedFileçš„å…³ç³»">
<code>ConsumeQueue</code> : <code>MappedFileQueue</code> : <code>MappedFile</code> = 1 : 1 : Nã€‚</p>
</blockquote>
<p>ååº”åˆ°ç³»ç»Ÿæ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">Yunai-MacdeMacBook-Pro-2:consumequeue yunai$ <span class="built_in">pwd</span></div><div class="line">/Users/yunai/store/consumequeue</div><div class="line">Yunai-MacdeMacBook-Pro-2:consumequeue yunai$ <span class="built_in">cd</span> TopicRead3/</div><div class="line">Yunai-MacdeMacBook-Pro-2:TopicRead3 yunai$ ls -ls</div><div class="line">total 0</div><div class="line">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:52 0</div><div class="line">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 1</div><div class="line">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 2</div><div class="line">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 3</div><div class="line">Yunai-MacdeMacBook-Pro-2:TopicRead3 yunai$ <span class="built_in">cd</span> 0/</div><div class="line">Yunai-MacdeMacBook-Pro-2:0 yunai$ ls -ls</div><div class="line">total 11720</div><div class="line">11720 -rw-r--r--  1 yunai  staff  6000000  4 27 21:55 00000000000000000000</div></pre></td></tr></table></figure></p>
<hr>
<p><code>ConsumeQueue</code>ã€<code>MappedFileQueue</code>ã€<code>MappedFile</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>MappedFile</code> ï¼š00000000000000000000ç­‰æ–‡ä»¶ã€‚</li>
<li><code>MappedFileQueue</code> ï¼š<code>MappedFile</code> æ‰€åœ¨çš„æ–‡ä»¶å¤¹ï¼Œå¯¹ <code>MappedFile</code> è¿›è¡Œå°è£…æˆæ–‡ä»¶é˜Ÿåˆ—ï¼Œå¯¹ä¸Šå±‚æä¾›å¯æ— é™ä½¿ç”¨çš„æ–‡ä»¶å®¹é‡ã€‚
<ul>
<li>æ¯ä¸ª <code>MappedFile</code> ç»Ÿä¸€æ–‡ä»¶å¤§å°ã€‚</li>
<li>æ–‡ä»¶å‘½åæ–¹å¼ï¼šfileName[n] = fileName[n - 1] + mappedFileSizeã€‚åœ¨ <code>ConsumeQueue</code> é‡Œé»˜è®¤ä¸º 6000000Bã€‚</li>
</ul>
</li>
<li><code>ConsumeQueue</code> ï¼šé’ˆå¯¹ <code>MappedFileQueue</code> çš„å°è£…ä½¿ç”¨ã€‚
<ul>
<li><code>Store : ConsumeQueue = ConcurrentHashMap&lt;String/* topic */, ConcurrentHashMap&lt;Integer/* queueId */, ConsumeQueue&gt;&gt;</code>ã€‚</li>
</ul>
</li>
</ul>
<p><code>ConsumeQueue</code> å­˜å‚¨åœ¨ <code>MappedFile</code> çš„å†…å®¹<strong>å¿…é¡»</strong>å¤§å°æ˜¯ 20B( <code>ConsumeQueue.CQ_STORE_UNIT_SIZE</code> )ï¼Œæœ‰ä¸¤ç§å†…å®¹ç±»å‹ï¼š</p>
<ol>
<li><code>MESSAGE_POSITION_INFO</code> ï¼šæ¶ˆæ¯ä½ç½®ä¿¡æ¯ã€‚</li>
<li><code>BLANK</code> : æ–‡ä»¶å‰ç½®ç©ºç™½å ä½ã€‚å½“å†å² <code>Message</code> è¢«åˆ é™¤æ—¶ï¼Œéœ€è¦ç”¨ <code>BLANK</code>å ä½è¢«åˆ é™¤çš„æ¶ˆæ¯ã€‚</li>
</ol>
<p><code>MESSAGE_POSITION_INFO</code> åœ¨ <code>ConsumeQueue</code> å­˜å‚¨ç»“æ„ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">ç¬¬å‡ ä½</th>
<th style="text-align:left">å­—æ®µ</th>
<th style="text-align:left">è¯´æ˜</th>
<th style="text-align:left">æ•°æ®ç±»å‹</th>
<th style="text-align:left">å­—èŠ‚æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">offset</td>
<td style="text-align:left">æ¶ˆæ¯ <code>CommitLog</code> å­˜å‚¨ä½ç½®</td>
<td style="text-align:left">Long</td>
<td style="text-align:left">8</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">size</td>
<td style="text-align:left">æ¶ˆæ¯é•¿åº¦</td>
<td style="text-align:left">Int</td>
<td style="text-align:left">4</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">tagsCode</td>
<td style="text-align:left">æ¶ˆæ¯tagsCode</td>
<td style="text-align:left">Long</td>
<td style="text-align:left">8</td>
</tr>
</tbody>
</table>
<p><code>BLANK</code> åœ¨ <code>ConsumeQueue</code> å­˜å‚¨ç»“æ„ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">ç¬¬å‡ ä½</th>
<th style="text-align:left">å­—æ®µ</th>
<th style="text-align:left">è¯´æ˜</th>
<th style="text-align:left">æ•°æ®ç±»å‹</th>
<th style="text-align:left">å­—èŠ‚æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left"></td>
<td style="text-align:left">0</td>
<td style="text-align:left">Long</td>
<td style="text-align:left">8</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left"></td>
<td style="text-align:left">Integer.MAX_VALUE</td>
<td style="text-align:left">Int</td>
<td style="text-align:left">4</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left"></td>
<td style="text-align:left">0</td>
<td style="text-align:left">Long</td>
<td style="text-align:left">8</td>
</tr>
</tbody>
</table>
<h1>3ã€ConsumeQueue å­˜å‚¨</h1>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/02.png" alt="CommitLogé‡æ”¾ConsumeQueueå›¾"></p>
<p>ä¸»è¦æœ‰ä¸¤ä¸ªç»„ä»¶ï¼š</p>
<ul>
<li><code>ReputMessageService</code> ï¼šwrite ConsumeQueueã€‚</li>
<li><code>FlushConsumeQueueService</code> ï¼šflush ConsumeQueueã€‚</li>
</ul>
<h2>ReputMessageService</h2>
<p><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/12.png" alt="ReputMessageServiceé¡ºåºå›¾"></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="class"><span class="keyword">class</span> <span class="title">ReputMessageService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>&#123;</div><div class="line">  <span class="number">2</span>: </div><div class="line">  <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line">  4:      * å¼€å§‹é‡æ”¾æ¶ˆæ¯çš„CommitLogç‰©ç†ä½ç½®</div><div class="line">  5:      */</div><div class="line">  <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> reputFromOffset = <span class="number">0</span>;</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getReputFromOffset</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="number">9</span>:         <span class="keyword">return</span> reputFromOffset;</div><div class="line"> <span class="number">10</span>:     &#125;</div><div class="line"> <span class="number">11</span>: </div><div class="line"> <span class="number">12</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReputFromOffset</span><span class="params">(<span class="keyword">long</span> reputFromOffset)</span> </span>&#123;</div><div class="line"> <span class="number">13</span>:         <span class="keyword">this</span>.reputFromOffset = reputFromOffset;</div><div class="line"> <span class="number">14</span>:     &#125;</div><div class="line"> <span class="number">15</span>: </div><div class="line"> <span class="number">16</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">17</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">18</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span> &amp;&amp; <span class="keyword">this</span>.isCommitLogAvailable(); i++) &#123;</div><div class="line"> <span class="number">19</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">20</span>:                 Thread.sleep(<span class="number">100</span>);</div><div class="line"> <span class="number">21</span>:             &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</div><div class="line"> <span class="number">22</span>:             &#125;</div><div class="line"> <span class="number">23</span>:         &#125;</div><div class="line"> <span class="number">24</span>: </div><div class="line"> <span class="number">25</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.isCommitLogAvailable()) &#123;</div><div class="line"> <span class="number">26</span>:             log.warn(<span class="string">"shutdown ReputMessageService, but commitlog have not finish to be dispatched, CL: &#123;&#125; reputFromOffset: &#123;&#125;"</span>,</div><div class="line"> <span class="number">27</span>:                 DefaultMessageStore.<span class="keyword">this</span>.commitLog.getMaxOffset(), <span class="keyword">this</span>.reputFromOffset);</div><div class="line"> <span class="number">28</span>:         &#125;</div><div class="line"> <span class="number">29</span>: </div><div class="line"> <span class="number">30</span>:         <span class="keyword">super</span>.shutdown();</div><div class="line"> <span class="number">31</span>:     &#125;</div><div class="line"> <span class="number">32</span>: </div><div class="line"> <span class="number">33</span>:     <span class="comment">/**</span></div><div class="line"> 34:      * å‰©ä½™éœ€è¦é‡æ”¾æ¶ˆæ¯å­—èŠ‚æ•°</div><div class="line"> 35:      *</div><div class="line"> 36:      * <span class="doctag">@return</span> å­—èŠ‚æ•°</div><div class="line"> 37:      */</div><div class="line"> <span class="number">38</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">behind</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">39</span>:         <span class="keyword">return</span> DefaultMessageStore.<span class="keyword">this</span>.commitLog.getMaxOffset() - <span class="keyword">this</span>.reputFromOffset;</div><div class="line"> <span class="number">40</span>:     &#125;</div><div class="line"> <span class="number">41</span>: </div><div class="line"> <span class="number">42</span>:     <span class="comment">/**</span></div><div class="line"> 43:      * æ˜¯å¦commitLogéœ€è¦é‡æ”¾æ¶ˆæ¯</div><div class="line"> 44:      *</div><div class="line"> 45:      * <span class="doctag">@return</span> æ˜¯å¦</div><div class="line"> 46:      */</div><div class="line"> <span class="number">47</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isCommitLogAvailable</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">48</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.reputFromOffset &lt; DefaultMessageStore.<span class="keyword">this</span>.commitLog.getMaxOffset();</div><div class="line"> <span class="number">49</span>:     &#125;</div><div class="line"> <span class="number">50</span>: </div><div class="line"> <span class="number">51</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doReput</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">52</span>:         <span class="keyword">for</span> (<span class="keyword">boolean</span> doNext = <span class="keyword">true</span>; <span class="keyword">this</span>.isCommitLogAvailable() &amp;&amp; doNext; ) &#123;</div><div class="line"> <span class="number">53</span>: </div><div class="line"> <span class="number">54</span>:             <span class="comment">// TODO ç–‘é—®ï¼šè¿™ä¸ªæ˜¯å•¥</span></div><div class="line"> <span class="number">55</span>:             <span class="keyword">if</span> (DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().isDuplicationEnable() <span class="comment">//</span></div><div class="line"> <span class="number">56</span>:                 &amp;&amp; <span class="keyword">this</span>.reputFromOffset &gt;= DefaultMessageStore.<span class="keyword">this</span>.getConfirmOffset()) &#123;</div><div class="line"> <span class="number">57</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">58</span>:             &#125;</div><div class="line"> <span class="number">59</span>: </div><div class="line"> <span class="number">60</span>:             <span class="comment">// è·å–ä»reputFromOffsetå¼€å§‹çš„commitLogå¯¹åº”çš„MappeFileå¯¹åº”çš„MappedByteBuffer</span></div><div class="line"> <span class="number">61</span>:             SelectMappedBufferResult result = DefaultMessageStore.<span class="keyword">this</span>.commitLog.getData(reputFromOffset);</div><div class="line"> <span class="number">62</span>:             <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">63</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">64</span>:                     <span class="keyword">this</span>.reputFromOffset = result.getStartOffset();</div><div class="line"> <span class="number">65</span>: </div><div class="line"> <span class="number">66</span>:                     <span class="comment">// éå†MappedByteBuffer</span></div><div class="line"> <span class="number">67</span>:                     <span class="keyword">for</span> (<span class="keyword">int</span> readSize = <span class="number">0</span>; readSize &lt; result.getSize() &amp;&amp; doNext; ) &#123;</div><div class="line"> <span class="number">68</span>:                         <span class="comment">// ç”Ÿæˆé‡æ”¾æ¶ˆæ¯é‡æ”¾è°ƒåº¦è¯·æ±‚</span></div><div class="line"> <span class="number">69</span>:                         DispatchRequest dispatchRequest = DefaultMessageStore.<span class="keyword">this</span>.commitLog.checkMessageAndReturnSize(result.getByteBuffer(), <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line"> <span class="number">70</span>:                         <span class="keyword">int</span> size = dispatchRequest.getMsgSize(); <span class="comment">// æ¶ˆæ¯é•¿åº¦</span></div><div class="line"> <span class="number">71</span>:                         <span class="comment">// æ ¹æ®è¯·æ±‚çš„ç»“æœå¤„ç†</span></div><div class="line"> <span class="number">72</span>:                         <span class="keyword">if</span> (dispatchRequest.isSuccess()) &#123; <span class="comment">// è¯»å–æˆåŠŸ</span></div><div class="line"> <span class="number">73</span>:                             <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123; <span class="comment">// è¯»å–Message</span></div><div class="line"> <span class="number">74</span>:                                 DefaultMessageStore.<span class="keyword">this</span>.doDispatch(dispatchRequest);</div><div class="line"> <span class="number">75</span>:                                 <span class="comment">// é€šçŸ¥æœ‰æ–°æ¶ˆæ¯</span></div><div class="line"> <span class="number">76</span>:                                 <span class="keyword">if</span> (BrokerRole.SLAVE != DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getBrokerRole()</div><div class="line"> <span class="number">77</span>:                                     &amp;&amp; DefaultMessageStore.<span class="keyword">this</span>.brokerConfig.isLongPollingEnable()) &#123;</div><div class="line"> <span class="number">78</span>:                                     DefaultMessageStore.<span class="keyword">this</span>.messageArrivingListener.arriving(dispatchRequest.getTopic(),</div><div class="line"> <span class="number">79</span>:                                         dispatchRequest.getQueueId(), dispatchRequest.getConsumeQueueOffset() + <span class="number">1</span>,</div><div class="line"> <span class="number">80</span>:                                         dispatchRequest.getTagsCode());</div><div class="line"> <span class="number">81</span>:                                 &#125;</div><div class="line"> <span class="number">82</span>:                                 <span class="comment">// FIXED BUG By shijia</span></div><div class="line"> <span class="number">83</span>:                                 <span class="keyword">this</span>.reputFromOffset += size;</div><div class="line"> <span class="number">84</span>:                                 readSize += size;</div><div class="line"> <span class="number">85</span>:                                 <span class="comment">// ç»Ÿè®¡</span></div><div class="line"> <span class="number">86</span>:                                 <span class="keyword">if</span> (DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getBrokerRole() == BrokerRole.SLAVE) &#123;</div><div class="line"> <span class="number">87</span>:                                     DefaultMessageStore.<span class="keyword">this</span>.storeStatsService</div><div class="line"> <span class="number">88</span>:                                         .getSinglePutMessageTopicTimesTotal(dispatchRequest.getTopic()).incrementAndGet();</div><div class="line"> <span class="number">89</span>:                                     DefaultMessageStore.<span class="keyword">this</span>.storeStatsService</div><div class="line"> <span class="number">90</span>:                                         .getSinglePutMessageTopicSizeTotal(dispatchRequest.getTopic())</div><div class="line"> <span class="number">91</span>:                                         .addAndGet(dispatchRequest.getMsgSize());</div><div class="line"> <span class="number">92</span>:                                 &#125;</div><div class="line"> <span class="number">93</span>:                             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (size == <span class="number">0</span>) &#123; <span class="comment">// è¯»å–åˆ°MappedFileæ–‡ä»¶å°¾</span></div><div class="line"> <span class="number">94</span>:                                 <span class="keyword">this</span>.reputFromOffset = DefaultMessageStore.<span class="keyword">this</span>.commitLog.rollNextFile(<span class="keyword">this</span>.reputFromOffset);</div><div class="line"> <span class="number">95</span>:                                 readSize = result.getSize();</div><div class="line"> <span class="number">96</span>:                             &#125;</div><div class="line"> <span class="number">97</span>:                         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!dispatchRequest.isSuccess()) &#123; <span class="comment">// è¯»å–å¤±è´¥</span></div><div class="line"> <span class="number">98</span>:                             <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123; <span class="comment">// è¯»å–åˆ°Messageå´ä¸æ˜¯Message</span></div><div class="line"> <span class="number">99</span>:                                 log.error(<span class="string">"[BUG]read total count not equals msg total size. reputFromOffset=&#123;&#125;"</span>, reputFromOffset);</div><div class="line"><span class="number">100</span>:                                 <span class="keyword">this</span>.reputFromOffset += size;</div><div class="line"><span class="number">101</span>:                             &#125; <span class="keyword">else</span> &#123; <span class="comment">// è¯»å–åˆ°Blankå´ä¸æ˜¯Blank</span></div><div class="line"><span class="number">102</span>:                                 doNext = <span class="keyword">false</span>;</div><div class="line"><span class="number">103</span>:                                 <span class="keyword">if</span> (DefaultMessageStore.<span class="keyword">this</span>.brokerConfig.getBrokerId() == MixAll.MASTER_ID) &#123;</div><div class="line"><span class="number">104</span>:                                     log.error(<span class="string">"[BUG]the master dispatch message to consume queue error, COMMITLOG OFFSET: &#123;&#125;"</span>,</div><div class="line"><span class="number">105</span>:                                         <span class="keyword">this</span>.reputFromOffset);</div><div class="line"><span class="number">106</span>: </div><div class="line"><span class="number">107</span>:                                     <span class="keyword">this</span>.reputFromOffset += result.getSize() - readSize;</div><div class="line"><span class="number">108</span>:                                 &#125;</div><div class="line"><span class="number">109</span>:                             &#125;</div><div class="line"><span class="number">110</span>:                         &#125;</div><div class="line"><span class="number">111</span>:                     &#125;</div><div class="line"><span class="number">112</span>:                 &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">113</span>:                     result.release();</div><div class="line"><span class="number">114</span>:                 &#125;</div><div class="line"><span class="number">115</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">116</span>:                 doNext = <span class="keyword">false</span>;</div><div class="line"><span class="number">117</span>:             &#125;</div><div class="line"><span class="number">118</span>:         &#125;</div><div class="line"><span class="number">119</span>:     &#125;</div><div class="line"><span class="number">120</span>: </div><div class="line"><span class="number">121</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">122</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">123</span>:         DefaultMessageStore.log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service started"</span>);</div><div class="line"><span class="number">124</span>: </div><div class="line"><span class="number">125</span>:         <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</div><div class="line"><span class="number">126</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">127</span>:                 Thread.sleep(<span class="number">1</span>);</div><div class="line"><span class="number">128</span>:                 <span class="keyword">this</span>.doReput();</div><div class="line"><span class="number">129</span>:             &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">130</span>:                 DefaultMessageStore.log.warn(<span class="keyword">this</span>.getServiceName() + <span class="string">" service has exception. "</span>, e);</div><div class="line"><span class="number">131</span>:             &#125;</div><div class="line"><span class="number">132</span>:         &#125;</div><div class="line"><span class="number">133</span>: </div><div class="line"><span class="number">134</span>:         DefaultMessageStore.log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service end"</span>);</div><div class="line"><span class="number">135</span>:     &#125;</div><div class="line"><span class="number">136</span>: </div><div class="line"><span class="number">137</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">138</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getServiceName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">139</span>:         <span class="keyword">return</span> ReputMessageService.class.getSimpleName();</div><div class="line"><span class="number">140</span>:     &#125;</div><div class="line"><span class="number">141</span>: </div><div class="line"><span class="number">142</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ï¼šé‡æ”¾æ¶ˆæ¯çº¿ç¨‹æœåŠ¡ã€‚
<ul>
<li>è¯¥æœåŠ¡ä¸æ–­ç”Ÿæˆ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° æ¶ˆè´¹é˜Ÿåˆ—(ConsumeQueue)</li>
<li>è¯¥æœåŠ¡ä¸æ–­ç”Ÿæˆ æ¶ˆæ¯ç´¢å¼• åˆ° ç´¢å¼•æ–‡ä»¶(IndexFile)</li>
</ul>
</li>
<li><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/11.png" alt="ReputMessageServiceç”¨ä¾‹å›¾">
<ul>
<li>ç¬¬ 61 è¡Œ ï¼šè·å– <code>reputFromOffset</code> å¼€å§‹çš„ <code>CommitLog</code> å¯¹åº”çš„ <code>MappedFile</code> å¯¹åº”çš„ <code>MappedByteBuffer</code>ã€‚</li>
<li>ç¬¬ 67 è¡Œ ï¼šéå† <code>MappedByteBuffer</code>ã€‚</li>
<li>ç¬¬ 69 è¡Œ ï¼šç”Ÿæˆé‡æ”¾æ¶ˆæ¯é‡æ”¾è°ƒåº¦è¯·æ±‚ (<code>DispatchRequest</code>) ã€‚è¯·æ±‚é‡Œä¸»è¦åŒ…å«ä¸€æ¡æ¶ˆæ¯ (<code>Message</code>) æˆ–è€… æ–‡ä»¶å°¾ (<code>BLANK</code>) çš„åŸºæœ¬ä¿¡æ¯ã€‚</li>
<li>ç¬¬ 72 è‡³ 96 è¡Œ ï¼šè¯·æ±‚æ˜¯æœ‰æ•ˆè¯·æ±‚ï¼Œè¿›è¡Œé€»è¾‘å¤„ç†ã€‚
<ul>
<li>ç¬¬ 75 è‡³ 81 è¡Œ ï¼šå½“ <code>Broker</code> æ˜¯ä¸»èŠ‚ç‚¹ &amp;&amp; <code>Broker</code> å¼€å¯çš„æ˜¯é•¿è½®è¯¢ï¼Œé€šçŸ¥æ¶ˆè´¹é˜Ÿåˆ—æœ‰æ–°çš„æ¶ˆæ¯ã€‚<code>NotifyMessageArrivingListener</code> ä¼š è°ƒç”¨ <code>PullRequestHoldService#notifyMessageArriving(...)</code> æ–¹æ³•ï¼Œè¯¦ç»†è§£æè§ï¼š<a href="#pullrequestholdservice">PullRequestHoldService</a></li>
</ul>
</li>
<li>ç¬¬ 73 è‡³ 92 è¡Œ ï¼šè¯·æ±‚å¯¹åº”çš„æ˜¯ <code>Message</code>ï¼Œè¿›è¡Œè°ƒåº¦ï¼Œç”Ÿæˆ <code>ConsumeQueue</code> å’Œ <code>IndexFile</code> å¯¹åº”çš„å†…å®¹ã€‚è¯¦ç»†è§£æè§ï¼š</li>
<li>ç¬¬ 93 è‡³ 96 è¡Œ ï¼šè¯·æ±‚å¯¹åº”çš„æ˜¯ <code>Blank</code>ï¼Œå³æ–‡ä»¶å°¾ï¼Œè·³è½¬æŒ‡å‘ä¸‹ä¸€ä¸ª <code>MappedFile</code>ã€‚</li>
<li>ç¬¬ 97 è‡³ 110 è¡Œ ï¼šè¯·æ±‚æ˜¯æ— æ•ˆè¯·æ±‚ã€‚å‡ºç°è¯¥æƒ…å†µï¼ŒåŸºæœ¬æ˜¯ä¸€ä¸ª<strong>BUG</strong>ã€‚</li>
</ul>
</li>
<li>ç¬¬ 127 è‡³ 128 è¡Œ ï¼šæ¯ 1ms å¾ªç¯æ‰§è¡Œé‡æ”¾é€»è¾‘ã€‚</li>
<li>ç¬¬ 18 è‡³ 30 è¡Œ ï¼š<code>shutdown</code>æ—¶ï¼Œå¤šæ¬¡ <code>sleep(100)</code> ç›´åˆ° <code>CommitLog</code> å›æ”¾åˆ°æœ€æ–°ä½ç½®ã€‚æ©ï¼Œå¦‚æœæœªå›æ”¾å®Œï¼Œä¼šè¾“å‡ºè­¦å‘Šæ—¥å¿—ã€‚</li>
</ul>
<h3>DefaultMessageStore#doDispatch(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * æ‰§è¡Œè°ƒåº¦è¯·æ±‚</div><div class="line"> 3:  * 1. éäº‹åŠ¡æ¶ˆæ¯ æˆ– äº‹åŠ¡æäº¤æ¶ˆæ¯ å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue</div><div class="line"> 4:  * 2. å»ºç«‹ ç´¢å¼•ä¿¡æ¯ åˆ° IndexFile</div><div class="line"> 5:  *</div><div class="line"> 6:  * <span class="doctag">@param</span> req è°ƒåº¦è¯·æ±‚</div><div class="line"> 7:  */</div><div class="line"> <span class="number">8</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(DispatchRequest req)</span> </span>&#123;</div><div class="line"> <span class="number">9</span>:     <span class="comment">// éäº‹åŠ¡æ¶ˆæ¯ æˆ– äº‹åŠ¡æäº¤æ¶ˆæ¯ å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue</span></div><div class="line"><span class="number">10</span>:     <span class="keyword">final</span> <span class="keyword">int</span> tranType = MessageSysFlag.getTransactionValue(req.getSysFlag());</div><div class="line"><span class="number">11</span>:     <span class="keyword">switch</span> (tranType) &#123;</div><div class="line"><span class="number">12</span>:         <span class="keyword">case</span> MessageSysFlag.TRANSACTION_NOT_TYPE:</div><div class="line"><span class="number">13</span>:         <span class="keyword">case</span> MessageSysFlag.TRANSACTION_COMMIT_TYPE:</div><div class="line"><span class="number">14</span>:             DefaultMessageStore.<span class="keyword">this</span>.putMessagePositionInfo(req.getTopic(), req.getQueueId(), req.getCommitLogOffset(), req.getMsgSize(),</div><div class="line"><span class="number">15</span>:                 req.getTagsCode(), req.getStoreTimestamp(), req.getConsumeQueueOffset());</div><div class="line"><span class="number">16</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">17</span>:         <span class="keyword">case</span> MessageSysFlag.TRANSACTION_PREPARED_TYPE:</div><div class="line"><span class="number">18</span>:         <span class="keyword">case</span> MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:</div><div class="line"><span class="number">19</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">20</span>:     &#125;</div><div class="line"><span class="number">21</span>:     <span class="comment">// å»ºç«‹ ç´¢å¼•ä¿¡æ¯ åˆ° IndexFile</span></div><div class="line"><span class="number">22</span>:     <span class="keyword">if</span> (DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().isMessageIndexEnable()) &#123;</div><div class="line"><span class="number">23</span>:         DefaultMessageStore.<span class="keyword">this</span>.indexService.buildIndex(req);</div><div class="line"><span class="number">24</span>:     &#125;</div><div class="line"><span class="number">25</span>: &#125;</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>: <span class="comment">/**</span></div><div class="line">28:  * å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue</div><div class="line">29:  *</div><div class="line">30:  * <span class="doctag">@param</span> topic ä¸»é¢˜</div><div class="line">31:  * <span class="doctag">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class="line">32:  * <span class="doctag">@param</span> offset commitLogå­˜å‚¨ä½ç½®</div><div class="line">33:  * <span class="doctag">@param</span> size æ¶ˆæ¯é•¿åº¦</div><div class="line">34:  * <span class="doctag">@param</span> tagsCode æ¶ˆæ¯tagsCode</div><div class="line">35:  * <span class="doctag">@param</span> storeTimestamp å­˜å‚¨æ—¶é—´</div><div class="line">36:  * <span class="doctag">@param</span> logicOffset é˜Ÿåˆ—ä½ç½®</div><div class="line">37:  */</div><div class="line"><span class="number">38</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putMessagePositionInfo</span><span class="params">(String topic, <span class="keyword">int</span> queueId, <span class="keyword">long</span> offset, <span class="keyword">int</span> size, <span class="keyword">long</span> tagsCode, <span class="keyword">long</span> storeTimestamp,</span></span></div><div class="line"><span class="number">39</span>:     <span class="keyword">long</span> logicOffset) &#123;</div><div class="line"><span class="number">40</span>:     ConsumeQueue cq = <span class="keyword">this</span>.findConsumeQueue(topic, queueId);</div><div class="line"><span class="number">41</span>:     cq.putMessagePositionInfoWrapper(offset, size, tagsCode, storeTimestamp, logicOffset);</div><div class="line"><span class="number">42</span>: &#125;</div></pre></td></tr></table></figure></p>
<h3>ConsumeQueue#putMessagePositionInfoWrapper(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">/**</span></div><div class="line">  2:  * æ·»åŠ ä½ç½®ä¿¡æ¯å°è£…</div><div class="line">  3:  *</div><div class="line">  4:  * <span class="doctag">@param</span> offset commitLogå­˜å‚¨ä½ç½®</div><div class="line">  5:  * <span class="doctag">@param</span> size æ¶ˆæ¯é•¿åº¦</div><div class="line">  6:  * <span class="doctag">@param</span> tagsCode æ¶ˆæ¯tagsCode</div><div class="line">  7:  * <span class="doctag">@param</span> storeTimestamp æ¶ˆæ¯å­˜å‚¨æ—¶é—´</div><div class="line">  8:  * <span class="doctag">@param</span> logicOffset é˜Ÿåˆ—ä½ç½®</div><div class="line">  9:  */</div><div class="line"> <span class="number">10</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putMessagePositionInfoWrapper</span><span class="params">(<span class="keyword">long</span> offset, <span class="keyword">int</span> size, <span class="keyword">long</span> tagsCode, <span class="keyword">long</span> storeTimestamp,</span></span></div><div class="line"> <span class="number">11</span>:     <span class="keyword">long</span> logicOffset) &#123;</div><div class="line"> <span class="number">12</span>:     <span class="keyword">final</span> <span class="keyword">int</span> maxRetries = <span class="number">30</span>;</div><div class="line"> <span class="number">13</span>:     <span class="keyword">boolean</span> canWrite = <span class="keyword">this</span>.defaultMessageStore.getRunningFlags().isWriteable();</div><div class="line"> <span class="number">14</span>:     <span class="comment">// å¤šæ¬¡å¾ªç¯å†™ï¼Œç›´åˆ°æˆåŠŸ</span></div><div class="line"> <span class="number">15</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; maxRetries &amp;&amp; canWrite; i++) &#123;</div><div class="line"> <span class="number">16</span>:         <span class="comment">// è°ƒç”¨æ·»åŠ ä½ç½®ä¿¡æ¯</span></div><div class="line"> <span class="number">17</span>:         <span class="keyword">boolean</span> result = <span class="keyword">this</span>.putMessagePositionInfo(offset, size, tagsCode, logicOffset);</div><div class="line"> <span class="number">18</span>:         <span class="keyword">if</span> (result) &#123;</div><div class="line"> <span class="number">19</span>:             <span class="comment">// æ·»åŠ æˆåŠŸï¼Œä½¿ç”¨æ¶ˆæ¯å­˜å‚¨æ—¶é—´ ä½œä¸º å­˜å‚¨check pointã€‚</span></div><div class="line"> <span class="number">20</span>:             <span class="keyword">this</span>.defaultMessageStore.getStoreCheckpoint().setLogicsMsgTimestamp(storeTimestamp);</div><div class="line"> <span class="number">21</span>:             <span class="keyword">return</span>;</div><div class="line"> <span class="number">22</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">23</span>:             <span class="comment">// <span class="doctag">XXX:</span> warn and notify me</span></div><div class="line"> <span class="number">24</span>:             log.warn(<span class="string">"[BUG]put commit log position info to "</span> + topic + <span class="string">":"</span> + queueId + <span class="string">" "</span> + offset</div><div class="line"> <span class="number">25</span>:                 + <span class="string">" failed, retry "</span> + i + <span class="string">" times"</span>);</div><div class="line"> <span class="number">26</span>: </div><div class="line"> <span class="number">27</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">28</span>:                 Thread.sleep(<span class="number">1000</span>);</div><div class="line"> <span class="number">29</span>:             &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"> <span class="number">30</span>:                 log.warn(<span class="string">""</span>, e);</div><div class="line"> <span class="number">31</span>:             &#125;</div><div class="line"> <span class="number">32</span>:         &#125;</div><div class="line"> <span class="number">33</span>:     &#125;</div><div class="line"> <span class="number">34</span>: </div><div class="line"> <span class="number">35</span>:     <span class="comment">// <span class="doctag">XXX:</span> warn and notify me è®¾ç½®å¼‚å¸¸ä¸å¯å†™å…¥</span></div><div class="line"> <span class="number">36</span>:     log.error(<span class="string">"[BUG]consume queue can not write, &#123;&#125; &#123;&#125;"</span>, <span class="keyword">this</span>.topic, <span class="keyword">this</span>.queueId);</div><div class="line"> <span class="number">37</span>:     <span class="keyword">this</span>.defaultMessageStore.getRunningFlags().makeLogicsQueueError();</div><div class="line"> <span class="number">38</span>: &#125;</div><div class="line"> <span class="number">39</span>: </div><div class="line"> <span class="number">40</span>: <span class="comment">/**</span></div><div class="line"> 41:  * æ·»åŠ ä½ç½®ä¿¡æ¯ï¼Œå¹¶è¿”å›æ·»åŠ æ˜¯å¦æˆåŠŸ</div><div class="line"> 42:  *</div><div class="line"> 43:  * <span class="doctag">@param</span> offset commitLogå­˜å‚¨ä½ç½®</div><div class="line"> 44:  * <span class="doctag">@param</span> size æ¶ˆæ¯é•¿åº¦</div><div class="line"> 45:  * <span class="doctag">@param</span> tagsCode æ¶ˆæ¯tagsCode</div><div class="line"> 46:  * <span class="doctag">@param</span> cqOffset é˜Ÿåˆ—ä½ç½®</div><div class="line"> 47:  * <span class="doctag">@return</span> æ˜¯å¦æˆåŠŸ</div><div class="line"> 48:  */</div><div class="line"> <span class="number">49</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">putMessagePositionInfo</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> offset, <span class="keyword">final</span> <span class="keyword">int</span> size, <span class="keyword">final</span> <span class="keyword">long</span> tagsCode,</span></span></div><div class="line"> <span class="number">50</span>:     <span class="keyword">final</span> <span class="keyword">long</span> cqOffset) &#123;</div><div class="line"> <span class="number">51</span>:     <span class="comment">// å¦‚æœå·²ç»é‡æ”¾è¿‡ï¼Œç›´æ¥è¿”å›æˆåŠŸ</span></div><div class="line"> <span class="number">52</span>:     <span class="keyword">if</span> (offset &lt;= <span class="keyword">this</span>.maxPhysicOffset) &#123;</div><div class="line"> <span class="number">53</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"> <span class="number">54</span>:     &#125;</div><div class="line"> <span class="number">55</span>:     <span class="comment">// å†™å…¥ä½ç½®ä¿¡æ¯åˆ°byteBuffer</span></div><div class="line"> <span class="number">56</span>:     <span class="keyword">this</span>.byteBufferIndex.flip();</div><div class="line"> <span class="number">57</span>:     <span class="keyword">this</span>.byteBufferIndex.limit(CQ_STORE_UNIT_SIZE);</div><div class="line"> <span class="number">58</span>:     <span class="keyword">this</span>.byteBufferIndex.putLong(offset);</div><div class="line"> <span class="number">59</span>:     <span class="keyword">this</span>.byteBufferIndex.putInt(size);</div><div class="line"> <span class="number">60</span>:     <span class="keyword">this</span>.byteBufferIndex.putLong(tagsCode);</div><div class="line"> <span class="number">61</span>:     <span class="comment">// è®¡ç®—consumeQueueå­˜å‚¨ä½ç½®ï¼Œå¹¶è·å¾—å¯¹åº”çš„MappedFile</span></div><div class="line"> <span class="number">62</span>:     <span class="keyword">final</span> <span class="keyword">long</span> expectLogicOffset = cqOffset * CQ_STORE_UNIT_SIZE;</div><div class="line"> <span class="number">63</span>:     MappedFile mappedFile = <span class="keyword">this</span>.mappedFileQueue.getLastMappedFile(expectLogicOffset);</div><div class="line"> <span class="number">64</span>:     <span class="keyword">if</span> (mappedFile != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">65</span>:         <span class="comment">// å½“æ˜¯ConsumeQueueç¬¬ä¸€ä¸ªMappedFile &amp;&amp; é˜Ÿåˆ—ä½ç½®éç¬¬ä¸€ä¸ª &amp;&amp; MappedFileæœªå†™å…¥å†…å®¹ï¼Œåˆ™å¡«å……å‰ç½®ç©ºç™½å ä½</span></div><div class="line"> <span class="number">66</span>:         <span class="keyword">if</span> (mappedFile.isFirstCreateInQueue() &amp;&amp; cqOffset != <span class="number">0</span> &amp;&amp; mappedFile.getWrotePosition() == <span class="number">0</span>) &#123; <span class="comment">// TODO ç–‘é—®ï¼šä¸ºå•¥è¿™ä¸ªæ“ä½œã€‚ç›®å‰èƒ½å¤Ÿæƒ³è±¡åˆ°çš„æ˜¯ï¼Œä¸€äº›è€çš„æ¶ˆæ¯å¾ˆä¹…æ²¡å‘é€ï¼Œçªç„¶å‘é€ï¼Œè¿™ä¸ªæ—¶å€™åˆšå¥½æ»¡è¶³ã€‚</span></div><div class="line"> <span class="number">67</span>:             <span class="keyword">this</span>.minLogicOffset = expectLogicOffset;</div><div class="line"> <span class="number">68</span>:             <span class="keyword">this</span>.mappedFileQueue.setFlushedWhere(expectLogicOffset);</div><div class="line"> <span class="number">69</span>:             <span class="keyword">this</span>.mappedFileQueue.setCommittedWhere(expectLogicOffset);</div><div class="line"> <span class="number">70</span>:             <span class="keyword">this</span>.fillPreBlank(mappedFile, expectLogicOffset);</div><div class="line"> <span class="number">71</span>:             log.info(<span class="string">"fill pre blank space "</span> + mappedFile.getFileName() + <span class="string">" "</span> + expectLogicOffset + <span class="string">" "</span></div><div class="line"> <span class="number">72</span>:                 + mappedFile.getWrotePosition());</div><div class="line"> <span class="number">73</span>:         &#125;</div><div class="line"> <span class="number">74</span>:         <span class="comment">// æ ¡éªŒconsumeQueueå­˜å‚¨ä½ç½®æ˜¯å¦åˆæ³•ã€‚TODO å¦‚æœä¸åˆæ³•ï¼Œç»§ç»­å†™å…¥ä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿ</span></div><div class="line"> <span class="number">75</span>:         <span class="keyword">if</span> (cqOffset != <span class="number">0</span>) &#123;</div><div class="line"> <span class="number">76</span>:             <span class="keyword">long</span> currentLogicOffset = mappedFile.getWrotePosition() + mappedFile.getFileFromOffset();</div><div class="line"> <span class="number">77</span>:             <span class="keyword">if</span> (expectLogicOffset != currentLogicOffset) &#123;</div><div class="line"> <span class="number">78</span>:                 LOG_ERROR.warn(</div><div class="line"> <span class="number">79</span>:                     <span class="string">"[BUG]logic queue order maybe wrong, expectLogicOffset: &#123;&#125; currentLogicOffset: &#123;&#125; Topic: &#123;&#125; QID: &#123;&#125; Diff: &#123;&#125;"</span>,</div><div class="line"> <span class="number">80</span>:                     expectLogicOffset,</div><div class="line"> <span class="number">81</span>:                     currentLogicOffset,</div><div class="line"> <span class="number">82</span>:                     <span class="keyword">this</span>.topic,</div><div class="line"> <span class="number">83</span>:                     <span class="keyword">this</span>.queueId,</div><div class="line"> <span class="number">84</span>:                     expectLogicOffset - currentLogicOffset</div><div class="line"> <span class="number">85</span>:                 );</div><div class="line"> <span class="number">86</span>:             &#125;</div><div class="line"> <span class="number">87</span>:         &#125;</div><div class="line"> <span class="number">88</span>:         <span class="comment">// è®¾ç½®commitLogé‡æ”¾æ¶ˆæ¯åˆ°ConsumeQueueä½ç½®ã€‚</span></div><div class="line"> <span class="number">89</span>:         <span class="keyword">this</span>.maxPhysicOffset = offset;</div><div class="line"> <span class="number">90</span>:         <span class="comment">// æ’å…¥mappedFile</span></div><div class="line"> <span class="number">91</span>:         <span class="keyword">return</span> mappedFile.appendMessage(<span class="keyword">this</span>.byteBufferIndex.array());</div><div class="line"> <span class="number">92</span>:     &#125;</div><div class="line"> <span class="number">93</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"> <span class="number">94</span>: &#125;</div><div class="line"> <span class="number">95</span>: </div><div class="line"> <span class="number">96</span>: <span class="comment">/**</span></div><div class="line"> 97:  * å¡«å……å‰ç½®ç©ºç™½å ä½</div><div class="line"> 98:  *</div><div class="line"> 99:  * <span class="doctag">@param</span> mappedFile MappedFile</div><div class="line">100:  * <span class="doctag">@param</span> untilWhere consumeQueueå­˜å‚¨ä½ç½®</div><div class="line">101:  */</div><div class="line"><span class="number">102</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fillPreBlank</span><span class="params">(<span class="keyword">final</span> MappedFile mappedFile, <span class="keyword">final</span> <span class="keyword">long</span> untilWhere)</span> </span>&#123;</div><div class="line"><span class="number">103</span>:     <span class="comment">// å†™å…¥å‰ç½®ç©ºç™½å ä½åˆ°byteBuffer</span></div><div class="line"><span class="number">104</span>:     ByteBuffer byteBuffer = ByteBuffer.allocate(CQ_STORE_UNIT_SIZE);</div><div class="line"><span class="number">105</span>:     byteBuffer.putLong(<span class="number">0L</span>);</div><div class="line"><span class="number">106</span>:     byteBuffer.putInt(Integer.MAX_VALUE);</div><div class="line"><span class="number">107</span>:     byteBuffer.putLong(<span class="number">0L</span>);</div><div class="line"><span class="number">108</span>:     <span class="comment">// å¾ªç¯å¡«ç©º</span></div><div class="line"><span class="number">109</span>:     <span class="keyword">int</span> until = (<span class="keyword">int</span>) (untilWhere % <span class="keyword">this</span>.mappedFileQueue.getMappedFileSize());</div><div class="line"><span class="number">110</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; until; i += CQ_STORE_UNIT_SIZE) &#123;</div><div class="line"><span class="number">111</span>:         mappedFile.appendMessage(byteBuffer.array());</div><div class="line"><span class="number">112</span>:     &#125;</div><div class="line"><span class="number">113</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#putMessagePositionInfoWrapper(...)</code> è¯´æ˜ ï¼šæ·»åŠ ä½ç½®ä¿¡æ¯åˆ° <code>ConsumeQueue</code> çš„å°è£…ï¼Œå®é™…éœ€è¦è°ƒç”¨ <code>#putMessagePositionInfo(...)</code> æ–¹æ³•ã€‚
<ul>
<li>ç¬¬ 13 è¡Œ ï¼šåˆ¤æ–­ <code>ConsumeQueue</code> æ˜¯å¦å…è®¸å†™å…¥ã€‚å½“å‘ç”ŸBugæ—¶ï¼Œä¸å…è®¸å†™å…¥ã€‚</li>
<li>ç¬¬ 17 è¡Œ ï¼šè°ƒç”¨ <code>#putMessagePositionInfo(...)</code> æ–¹æ³•ï¼Œæ·»åŠ ä½ç½®ä¿¡æ¯ã€‚</li>
<li>ç¬¬ 18 è‡³ 21 è¡Œ ï¼šæ·»åŠ æˆåŠŸï¼Œä½¿ç”¨æ¶ˆæ¯å­˜å‚¨æ—¶é—´ ä½œä¸º å­˜å‚¨æ£€æŸ¥ç‚¹ã€‚<code>StoreCheckpoint</code> çš„è¯¦ç»†è§£æè§ï¼š<a href="http://www.yunai.me/RocketMQ/store-init-and-shutdown/">Storeåˆå§‹åŒ–ä¸å…³é—­</a>ã€‚</li>
<li>ç¬¬ 22 è‡³ 32 è¡Œ ï¼šæ·»åŠ å¤±è´¥ï¼Œç›®å‰åŸºæœ¬å¯ä»¥è®¤ä¸ºæ˜¯BUGã€‚</li>
<li>ç¬¬ 35 è‡³ 37 è¡Œ ï¼šå†™å…¥å¤±è´¥æ—¶ï¼Œæ ‡è®° <code>ConsumeQueue</code> å†™å…¥å¼‚å¸¸ï¼Œä¸å…è®¸ç»§ç»­å†™å…¥ã€‚</li>
</ul>
</li>
<li><code>#putMessagePositionInfo(...)</code> è¯´æ˜ ï¼šæ·»åŠ ä½ç½®ä¿¡æ¯åˆ° <code>ConsumeQueue</code>ï¼Œå¹¶è¿”å›æ·»åŠ æ˜¯å¦æˆåŠŸã€‚
<ul>
<li>ç¬¬ 51 è‡³ 54 è¡Œ ï¼šå¦‚æœ <code>offset</code>(å­˜å‚¨ä½ç½®) å°äºç­‰äº  <code>maxPhysicOffset</code>(<code>CommitLog</code> æ¶ˆæ¯é‡æ”¾åˆ° <code>ConsumeQueue</code> æœ€å¤§çš„ <code>CommitLog</code> å­˜å‚¨ä½ç½®)ï¼Œè¡¨ç¤ºå·²ç»é‡æ”¾è¿‡ï¼Œæ­¤æ—¶ï¼Œä¸å†é‡å¤å†™å…¥ï¼Œç›´æ¥è¿”å›å†™å…¥æˆåŠŸã€‚</li>
<li>ç¬¬ 55 è‡³ 60 è¡Œ ï¼šå†™ ä½ç½®ä¿¡æ¯åˆ°byteBufferã€‚</li>
<li>ç¬¬ 62 è‡³ 63 è¡Œ ï¼šè®¡ç®— <code>ConsumeQueue</code>å­˜å‚¨ä½ç½®ï¼Œå¹¶è·å¾—å¯¹åº”çš„MappedFileã€‚</li>
<li>ç¬¬ 65 è‡³ 73 è¡Œ ï¼šå½“ <code>MappedFile</code> æ˜¯ <code>ConsumeQueue</code> å½“å‰ç¬¬ä¸€ä¸ªæ–‡ä»¶ &amp;&amp; <code>MappedFile</code> æœªå†™å…¥å†…å®¹ &amp;&amp; é‡æ”¾æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å¤§äº0ï¼Œåˆ™éœ€è¦è¿›è¡Œ <code>MappedFile</code> å¡«å……å‰ç½®  <code>BLANK</code>ã€‚
<ul>
<li><em>è¿™å—æ¯”è¾ƒæœ‰ç–‘é—®ï¼Œä»€ä¹ˆåœºæ™¯ä¸‹ä¼šéœ€è¦ã€‚çŒœæµ‹äº§ç”Ÿçš„åŸå› ï¼šä¸€ä¸ª <code>Topic</code> é•¿æœŸæ— æ¶ˆæ¯äº§ç”Ÿï¼Œçªç„¶Nå¤©åè¿›è¡Œå‘é€ï¼Œ<code>Topic</code> å¯¹åº”çš„å†å²æ¶ˆæ¯ä»¥åŠå’Œæ¶ˆè´¹é˜Ÿåˆ—æ•°æ®å·²ç»è¢«æ¸…ç†ï¼Œæ–°ç”Ÿæˆçš„<code>MappedFile</code>éœ€è¦å‰ç½®å ä½ã€‚</em></li>
</ul>
</li>
<li>ç¬¬ 74 è‡³ 87 è¡Œ ï¼šæ ¡éªŒ <code>ConsumeQueue</code> å­˜å‚¨ä½ç½®æ˜¯å¦åˆæ³•ï¼Œä¸åˆæ³•åˆ™è¾“å‡ºæ—¥å¿—ã€‚
<ul>
<li><em>è¿™å—æ¯”è¾ƒæœ‰ç–‘é—®ï¼Œå¦‚æœè®¡ç®—å‡ºæ¥çš„å­˜å‚¨ä½ç½®ä¸åˆæ³•ï¼Œä¸è¿”å›æ·»åŠ å¤±è´¥ï¼Œç»§ç»­è¿›è¡Œæ·»åŠ ä½ç½®ä¿¡æ¯ï¼Œä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿï¼Ÿï¼Ÿ</em></li>
</ul>
</li>
<li>ç¬¬ 89 è¡Œ ï¼šè®¾ç½® <code>CommitLog</code> é‡æ”¾æ¶ˆæ¯åˆ° <code>ConsumeQueue</code> çš„æœ€å¤§ä½ç½®ã€‚</li>
<li>ç¬¬ 91 è¡Œ ï¼šæ’å…¥æ¶ˆæ¯ä½ç½®åˆ° <code>MappedFile</code>ã€‚</li>
</ul>
</li>
</ul>
<h2>FlushConsumeQueueService</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="class"><span class="keyword">class</span> <span class="title">FlushConsumeQueueService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RETRY_TIMES_OVER = <span class="number">3</span>;</div><div class="line"> <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"> 4:      * æœ€åflushæ—¶é—´æˆ³</div><div class="line"> 5:      */</div><div class="line"> <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">long</span> lastFlushTimestamp = <span class="number">0</span>;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doFlush</span><span class="params">(<span class="keyword">int</span> retryTimes)</span> </span>&#123;</div><div class="line"> <span class="number">9</span>:         <span class="keyword">int</span> flushConsumeQueueLeastPages = DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getFlushConsumeQueueLeastPages();</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>:         <span class="comment">// retryTimes == RETRY_TIMES_OVERæ—¶ï¼Œè¿›è¡Œå¼ºåˆ¶flushã€‚ä¸»è¦ç”¨äºshutdownæ—¶ã€‚</span></div><div class="line"><span class="number">12</span>:         <span class="keyword">if</span> (retryTimes == RETRY_TIMES_OVER) &#123;</div><div class="line"><span class="number">13</span>:             flushConsumeQueueLeastPages = <span class="number">0</span>;</div><div class="line"><span class="number">14</span>:         &#125;</div><div class="line"><span class="number">15</span>:         <span class="comment">// å½“æ—¶é—´æ»¡è¶³flushConsumeQueueThoroughIntervalæ—¶ï¼Œå³ä½¿å†™å…¥çš„æ•°é‡ä¸è¶³flushConsumeQueueLeastPagesï¼Œä¹Ÿè¿›è¡Œflush</span></div><div class="line"><span class="number">16</span>:         <span class="keyword">long</span> logicsMsgTimestamp = <span class="number">0</span>;</div><div class="line"><span class="number">17</span>:         <span class="keyword">int</span> flushConsumeQueueThoroughInterval = DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getFlushConsumeQueueThoroughInterval();</div><div class="line"><span class="number">18</span>:         <span class="keyword">long</span> currentTimeMillis = System.currentTimeMillis();</div><div class="line"><span class="number">19</span>:         <span class="keyword">if</span> (currentTimeMillis &gt;= (<span class="keyword">this</span>.lastFlushTimestamp + flushConsumeQueueThoroughInterval)) &#123;</div><div class="line"><span class="number">20</span>:             <span class="keyword">this</span>.lastFlushTimestamp = currentTimeMillis;</div><div class="line"><span class="number">21</span>:             flushConsumeQueueLeastPages = <span class="number">0</span>;</div><div class="line"><span class="number">22</span>:             logicsMsgTimestamp = DefaultMessageStore.<span class="keyword">this</span>.getStoreCheckpoint().getLogicsMsgTimestamp();</div><div class="line"><span class="number">23</span>:         &#125;</div><div class="line"><span class="number">24</span>:         <span class="comment">// flushæ¶ˆè´¹é˜Ÿåˆ—</span></div><div class="line"><span class="number">25</span>:         ConcurrentHashMap&lt;String, ConcurrentHashMap&lt;Integer, ConsumeQueue&gt;&gt; tables = DefaultMessageStore.<span class="keyword">this</span>.consumeQueueTable;</div><div class="line"><span class="number">26</span>:         <span class="keyword">for</span> (ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; maps : tables.values()) &#123;</div><div class="line"><span class="number">27</span>:             <span class="keyword">for</span> (ConsumeQueue cq : maps.values()) &#123;</div><div class="line"><span class="number">28</span>:                 <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line"><span class="number">29</span>:                 <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; retryTimes &amp;&amp; !result; i++) &#123;</div><div class="line"><span class="number">30</span>:                     result = cq.flush(flushConsumeQueueLeastPages);</div><div class="line"><span class="number">31</span>:                 &#125;</div><div class="line"><span class="number">32</span>:             &#125;</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:         <span class="comment">// flush å­˜å‚¨ check point</span></div><div class="line"><span class="number">35</span>:         <span class="keyword">if</span> (<span class="number">0</span> == flushConsumeQueueLeastPages) &#123;</div><div class="line"><span class="number">36</span>:             <span class="keyword">if</span> (logicsMsgTimestamp &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">37</span>:                 DefaultMessageStore.<span class="keyword">this</span>.getStoreCheckpoint().setLogicsMsgTimestamp(logicsMsgTimestamp);</div><div class="line"><span class="number">38</span>:             &#125;</div><div class="line"><span class="number">39</span>:             DefaultMessageStore.<span class="keyword">this</span>.getStoreCheckpoint().flush();</div><div class="line"><span class="number">40</span>:         &#125;</div><div class="line"><span class="number">41</span>:     &#125;</div><div class="line"><span class="number">42</span>: </div><div class="line"><span class="number">43</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">44</span>:         DefaultMessageStore.log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service started"</span>);</div><div class="line"><span class="number">45</span>: </div><div class="line"><span class="number">46</span>:         <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</div><div class="line"><span class="number">47</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">48</span>:                 <span class="keyword">int</span> interval = DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getFlushIntervalConsumeQueue();</div><div class="line"><span class="number">49</span>:                 <span class="keyword">this</span>.waitForRunning(interval);</div><div class="line"><span class="number">50</span>:                 <span class="keyword">this</span>.doFlush(<span class="number">1</span>);</div><div class="line"><span class="number">51</span>:             &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">52</span>:                 DefaultMessageStore.log.warn(<span class="keyword">this</span>.getServiceName() + <span class="string">" service has exception. "</span>, e);</div><div class="line"><span class="number">53</span>:             &#125;</div><div class="line"><span class="number">54</span>:         &#125;</div><div class="line"><span class="number">55</span>: </div><div class="line"><span class="number">56</span>:         <span class="keyword">this</span>.doFlush(RETRY_TIMES_OVER);</div><div class="line"><span class="number">57</span>: </div><div class="line"><span class="number">58</span>:         DefaultMessageStore.log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service end"</span>);</div><div class="line"><span class="number">59</span>:     &#125;</div><div class="line"><span class="number">60</span>: </div><div class="line"><span class="number">61</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">62</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getServiceName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">63</span>:         <span class="keyword">return</span> FlushConsumeQueueService.class.getSimpleName();</div><div class="line"><span class="number">64</span>:     &#125;</div><div class="line"><span class="number">65</span>: </div><div class="line"><span class="number">66</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">67</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getJointime</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">68</span>:         <span class="keyword">return</span> <span class="number">1000</span> * <span class="number">60</span>;</div><div class="line"><span class="number">69</span>:     &#125;</div><div class="line"><span class="number">70</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šflush <code>ConsumeQueue</code>(æ¶ˆè´¹é˜Ÿåˆ—) çº¿ç¨‹æœåŠ¡ã€‚</li>
<li>ç¬¬ 11 è‡³ 14 è¡Œ ï¼šå½“ <code>retryTimes == RETRY_TIMES_OVER</code> æ—¶ï¼Œè¿›è¡Œå¼ºåˆ¶flushã€‚ç”¨äº <code>shutdown</code> æ—¶ã€‚</li>
<li>ç¬¬ 15 è‡³ 23 è¡Œ ï¼šæ¯ flushConsumeQueueThoroughInterval å‘¨æœŸï¼Œæ‰§è¡Œä¸€æ¬¡ flush ã€‚å› ä¸ºä¸æ˜¯æ¯æ¬¡å¾ªç¯åˆ°éƒ½èƒ½æ»¡è¶³ flushConsumeQueueLeastPages å¤§å°ï¼Œå› æ­¤ï¼Œéœ€è¦ä¸€å®šå‘¨æœŸè¿›è¡Œä¸€æ¬¡å¼ºåˆ¶ flush ã€‚å½“ç„¶ï¼Œä¸èƒ½æ¯æ¬¡å¾ªç¯éƒ½å»æ‰§è¡Œå¼ºåˆ¶ flushï¼Œè¿™æ ·æ€§èƒ½è¾ƒå·®ã€‚</li>
<li>ç¬¬ 24 è‡³ 33 è¡Œ ï¼šflush <code>ConsumeQueue</code>(æ¶ˆè´¹é˜Ÿåˆ—)ã€‚
<ul>
<li>flush é€»è¾‘ï¼š<a href="http://www.yunai.me/RocketMQ/message-store/#MappedFile-%E8%90%BD%E7%9B%98">MappedFile#è½ç›˜</a>ã€‚</li>
</ul>
</li>
<li>ç¬¬ 34 è‡³ 40 è¡Œ ï¼šflush <code>StoreCheckpoint</code>ã€‚<code>StoreCheckpoint</code> çš„è¯¦ç»†è§£æè§ï¼š<a href="http://www.yunai.me/RocketMQ/store-init-and-shutdown/">Storeåˆå§‹åŒ–ä¸å…³é—­</a>ã€‚</li>
<li>ç¬¬ 43 è‡³ 59 è¡Œ ï¼šæ¯ 1000ms æ‰§è¡Œä¸€æ¬¡ <code>flush</code>ã€‚å¦‚æœ wakeup() æ—¶ï¼Œåˆ™ä¼šç«‹å³è¿›è¡Œä¸€æ¬¡ <code>flush</code>ã€‚ç›®å‰ï¼Œæš‚æ—¶ä¸å­˜åœ¨ wakeup() çš„è°ƒç”¨ã€‚</li>
</ul>
<h1>4ã€Broker æä¾›[æ‹‰å–æ¶ˆæ¯]æ¥å£</h1>
<h2>PullMessageRequestHeader</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PullMessageRequestHeader</span> <span class="keyword">implements</span> <span class="title">CommandCustomHeader</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">/**</span></div><div class="line"> 3:      * æ¶ˆè´¹è€…åˆ†ç»„</div><div class="line"> 4:      */</div><div class="line"> <span class="number">5</span>:     <span class="meta">@CFNotNull</span></div><div class="line"> <span class="number">6</span>:     <span class="keyword">private</span> String consumerGroup;</div><div class="line"> <span class="number">7</span>:     <span class="comment">/**</span></div><div class="line"> 8:      * Topic</div><div class="line"> 9:      */</div><div class="line"><span class="number">10</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">11</span>:     <span class="keyword">private</span> String topic;</div><div class="line"><span class="number">12</span>:     <span class="comment">/**</span></div><div class="line">13:      * é˜Ÿåˆ—ç¼–å·</div><div class="line">14:      */</div><div class="line"><span class="number">15</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">16</span>:     <span class="keyword">private</span> Integer queueId;</div><div class="line"><span class="number">17</span>:     <span class="comment">/**</span></div><div class="line">18:      * é˜Ÿåˆ—å¼€å§‹ä½ç½®</div><div class="line">19:      */</div><div class="line"><span class="number">20</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">21</span>:     <span class="keyword">private</span> Long queueOffset;</div><div class="line"><span class="number">22</span>:     <span class="comment">/**</span></div><div class="line">23:      * æ¶ˆæ¯æ•°é‡</div><div class="line">24:      */</div><div class="line"><span class="number">25</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">26</span>:     <span class="keyword">private</span> Integer maxMsgNums;</div><div class="line"><span class="number">27</span>:     <span class="comment">/**</span></div><div class="line">28:      * ç³»ç»Ÿæ ‡è¯†</div><div class="line">29:      */</div><div class="line"><span class="number">30</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">31</span>:     <span class="keyword">private</span> Integer sysFlag;</div><div class="line"><span class="number">32</span>:     <span class="comment">/**</span></div><div class="line">33:      * æäº¤æ¶ˆè´¹è¿›åº¦ä½ç½®</div><div class="line">34:      */</div><div class="line"><span class="number">35</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">36</span>:     <span class="keyword">private</span> Long commitOffset;</div><div class="line"><span class="number">37</span>:     <span class="comment">/**</span></div><div class="line">38:      * æŒ‚èµ·è¶…æ—¶æ—¶é—´</div><div class="line">39:      */</div><div class="line"><span class="number">40</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">41</span>:     <span class="keyword">private</span> Long suspendTimeoutMillis;</div><div class="line"><span class="number">42</span>:     <span class="comment">/**</span></div><div class="line">43:      * è®¢é˜…è¡¨è¾¾å¼</div><div class="line">44:      */</div><div class="line"><span class="number">45</span>:     <span class="meta">@CFNullable</span></div><div class="line"><span class="number">46</span>:     <span class="keyword">private</span> String subscription;</div><div class="line"><span class="number">47</span>:     <span class="comment">/**</span></div><div class="line">48:      * è®¢é˜…ç‰ˆæœ¬å·</div><div class="line">49:      */</div><div class="line"><span class="number">50</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">51</span>:     <span class="keyword">private</span> Long subVersion;</div><div class="line"><span class="number">52</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ï¼šæ‹‰å–æ¶ˆæ¯è¯·æ±‚Header</li>
<li>topic +  queueId + queueOffset + maxMsgNums</li>
<li>sysFlag ï¼šç³»ç»Ÿæ ‡è¯†ã€‚
<ul>
<li>ç¬¬ 0 ä½ <code>FLAG_COMMIT_OFFSET</code> ï¼šæ ‡è®°è¯·æ±‚æäº¤æ¶ˆè´¹è¿›åº¦ä½ç½®ï¼Œå’Œ <code>commitOffset</code> é…åˆã€‚</li>
<li>ç¬¬ 1 ä½ <code>FLAG_SUSPEND</code> ï¼šæ ‡è®°è¯·æ±‚æ˜¯å¦æŒ‚èµ·è¯·æ±‚ï¼Œå’Œ <code>suspendTimeoutMillis</code> é…åˆã€‚å½“æ‹‰å–ä¸åˆ°æ¶ˆæ¯æ—¶ï¼Œ <code>Broker</code> ä¼šæŒ‚èµ·è¯·æ±‚ï¼Œç›´åˆ°æœ‰æ¶ˆæ¯ã€‚æœ€å¤§æŒ‚èµ·æ—¶é—´ï¼š<code>suspendTimeoutMillis</code> æ¯«ç§’ã€‚</li>
<li>ç¬¬ 2 ä½ <code>FLAG_SUBSCRIPTION</code> ï¼šæ˜¯å¦è¿‡æ»¤è®¢é˜…è¡¨è¾¾å¼ï¼Œå’Œ <code>subscription</code> é…ç½®ã€‚</li>
</ul>
</li>
<li>subVersion ï¼šè®¢é˜…ç‰ˆæœ¬å·ã€‚è¯·æ±‚æ—¶ï¼Œå¦‚æœç‰ˆæœ¬å·ä¸å¯¹ï¼Œåˆ™æ— æ³•æ‹‰å–åˆ°æ¶ˆæ¯ï¼Œéœ€è¦é‡æ–°è·å–è®¢é˜…ä¿¡æ¯ï¼Œä½¿ç”¨æœ€æ–°çš„è®¢é˜…ç‰ˆæœ¬å·ã€‚</li>
</ul>
<h2>PullMessageProcessor#processRequest(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> RemotingCommand <span class="title">processRequest</span><span class="params">(<span class="keyword">final</span> Channel channel, RemotingCommand request, <span class="keyword">boolean</span> brokerAllowSuspend)</span></span></div><div class="line">  2:     <span class="keyword">throws</span> RemotingCommandException &#123;</div><div class="line">  <span class="number">3</span>:     RemotingCommand response = RemotingCommand.createResponseCommand(PullMessageResponseHeader.class);</div><div class="line">  <span class="number">4</span>:     <span class="keyword">final</span> PullMessageResponseHeader responseHeader = (PullMessageResponseHeader) response.readCustomHeader();</div><div class="line">  <span class="number">5</span>:     <span class="keyword">final</span> PullMessageRequestHeader requestHeader =</div><div class="line">  <span class="number">6</span>:         (PullMessageRequestHeader) request.decodeCommandCustomHeader(PullMessageRequestHeader.class);</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:     response.setOpaque(request.getOpaque());</div><div class="line">  <span class="number">9</span>: </div><div class="line"> <span class="number">10</span>:     <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</div><div class="line"> <span class="number">11</span>:         LOG.debug(<span class="string">"receive PullMessage request command, &#123;&#125;"</span>, request);</div><div class="line"> <span class="number">12</span>:     &#125;</div><div class="line"> <span class="number">13</span>: </div><div class="line"> <span class="number">14</span>:     <span class="comment">// æ ¡éªŒ broker æ˜¯å¦å¯è¯»</span></div><div class="line"> <span class="number">15</span>:     <span class="keyword">if</span> (!PermName.isReadable(<span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerPermission())) &#123;</div><div class="line"> <span class="number">16</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"> <span class="number">17</span>:         response.setRemark(String.format(<span class="string">"the broker[%s] pulling message is forbidden"</span>, <span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerIP1()));</div><div class="line"> <span class="number">18</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">19</span>:     &#125;</div><div class="line"> <span class="number">20</span>: </div><div class="line"> <span class="number">21</span>:     <span class="comment">// æ ¡éªŒ consumeråˆ†ç»„é…ç½® æ˜¯å¦å­˜åœ¨</span></div><div class="line"> <span class="number">22</span>:     SubscriptionGroupConfig subscriptionGroupConfig = <span class="keyword">this</span>.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(requestHeader.getConsumerGroup());</div><div class="line"> <span class="number">23</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == subscriptionGroupConfig) &#123;</div><div class="line"> <span class="number">24</span>:         response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);</div><div class="line"> <span class="number">25</span>:         response.setRemark(String.format(<span class="string">"subscription group [%s] does not exist, %s"</span>, requestHeader.getConsumerGroup(), FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST)));</div><div class="line"> <span class="number">26</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">27</span>:     &#125;</div><div class="line"> <span class="number">28</span>:     <span class="comment">// æ ¡éªŒ consumeråˆ†ç»„é…ç½® æ˜¯å¦å¯æ¶ˆè´¹</span></div><div class="line"> <span class="number">29</span>:     <span class="keyword">if</span> (!subscriptionGroupConfig.isConsumeEnable()) &#123;</div><div class="line"> <span class="number">30</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"> <span class="number">31</span>:         response.setRemark(<span class="string">"subscription group no permission, "</span> + requestHeader.getConsumerGroup());</div><div class="line"> <span class="number">32</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">33</span>:     &#125;</div><div class="line"> <span class="number">34</span>: </div><div class="line"> <span class="number">35</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> hasSuspendFlag = PullSysFlag.hasSuspendFlag(requestHeader.getSysFlag()); <span class="comment">// æ˜¯å¦æŒ‚èµ·è¯·æ±‚ï¼Œå½“æ²¡æœ‰æ¶ˆæ¯æ—¶</span></div><div class="line"> <span class="number">36</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> hasCommitOffsetFlag = PullSysFlag.hasCommitOffsetFlag(requestHeader.getSysFlag()); <span class="comment">// æ˜¯å¦æäº¤æ¶ˆè´¹è¿›åº¦</span></div><div class="line"> <span class="number">37</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> hasSubscriptionFlag = PullSysFlag.hasSubscriptionFlag(requestHeader.getSysFlag()); <span class="comment">// æ˜¯å¦è¿‡æ»¤è®¢é˜…è¡¨è¾¾å¼(subscription)</span></div><div class="line"> <span class="number">38</span>:     <span class="keyword">final</span> <span class="keyword">long</span> suspendTimeoutMillisLong = hasSuspendFlag ? requestHeader.getSuspendTimeoutMillis() : <span class="number">0</span>; <span class="comment">// æŒ‚èµ·è¯·æ±‚è¶…æ—¶æ—¶é•¿</span></div><div class="line"> <span class="number">39</span>: </div><div class="line"> <span class="number">40</span>:     <span class="comment">// æ ¡éªŒ topicé…ç½® å­˜åœ¨</span></div><div class="line"> <span class="number">41</span>:     TopicConfig topicConfig = <span class="keyword">this</span>.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());</div><div class="line"> <span class="number">42</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == topicConfig) &#123;</div><div class="line"> <span class="number">43</span>:         LOG.error(<span class="string">"The topic &#123;&#125; not exist, consumer: &#123;&#125; "</span>, requestHeader.getTopic(), RemotingHelper.parseChannelRemoteAddr(channel));</div><div class="line"> <span class="number">44</span>:         response.setCode(ResponseCode.TOPIC_NOT_EXIST);</div><div class="line"> <span class="number">45</span>:         response.setRemark(String.format(<span class="string">"topic[%s] not exist, apply first please! %s"</span>, requestHeader.getTopic(), FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL)));</div><div class="line"> <span class="number">46</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">47</span>:     &#125;</div><div class="line"> <span class="number">48</span>:     <span class="comment">// æ ¡éªŒ topicé…ç½® æƒé™å¯è¯»</span></div><div class="line"> <span class="number">49</span>:     <span class="keyword">if</span> (!PermName.isReadable(topicConfig.getPerm())) &#123;</div><div class="line"> <span class="number">50</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"> <span class="number">51</span>:         response.setRemark(<span class="string">"the topic["</span> + requestHeader.getTopic() + <span class="string">"] pulling message is forbidden"</span>);</div><div class="line"> <span class="number">52</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">53</span>:     &#125;</div><div class="line"> <span class="number">54</span>:     <span class="comment">// æ ¡éªŒ è¯»å–é˜Ÿåˆ— åœ¨ topicé…ç½® é˜Ÿåˆ—èŒƒå›´å†…</span></div><div class="line"> <span class="number">55</span>:     <span class="keyword">if</span> (requestHeader.getQueueId() &lt; <span class="number">0</span> || requestHeader.getQueueId() &gt;= topicConfig.getReadQueueNums()) &#123;</div><div class="line"> <span class="number">56</span>:         String errorInfo = String.format(<span class="string">"queueId[%d] is illegal, topic:[%s] topicConfig.readQueueNums:[%d] consumer:[%s]"</span>,</div><div class="line"> <span class="number">57</span>:                 requestHeader.getQueueId(), requestHeader.getTopic(), topicConfig.getReadQueueNums(), channel.remoteAddress());</div><div class="line"> <span class="number">58</span>:         LOG.warn(errorInfo);</div><div class="line"> <span class="number">59</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"> <span class="number">60</span>:         response.setRemark(errorInfo);</div><div class="line"> <span class="number">61</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">62</span>:     &#125;</div><div class="line"> <span class="number">63</span>: </div><div class="line"> <span class="number">64</span>:     <span class="comment">// æ ¡éªŒ è®¢é˜…å…³ç³»</span></div><div class="line"> <span class="number">65</span>:     SubscriptionData subscriptionData;</div><div class="line"> <span class="number">66</span>:     <span class="keyword">if</span> (hasSubscriptionFlag) &#123;</div><div class="line"> <span class="number">67</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">68</span>:             subscriptionData = FilterAPI.buildSubscriptionData(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class="line"> <span class="number">69</span>:                 requestHeader.getSubscription());</div><div class="line"> <span class="number">70</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">71</span>:             LOG.warn(<span class="string">"Parse the consumer's subscription[&#123;&#125;] failed, group: &#123;&#125;"</span>, requestHeader.getSubscription(), <span class="comment">//</span></div><div class="line"> <span class="number">72</span>:                     requestHeader.getConsumerGroup());</div><div class="line"> <span class="number">73</span>:             response.setCode(ResponseCode.SUBSCRIPTION_PARSE_FAILED);</div><div class="line"> <span class="number">74</span>:             response.setRemark(<span class="string">"parse the consumer's subscription failed"</span>);</div><div class="line"> <span class="number">75</span>:             <span class="keyword">return</span> response;</div><div class="line"> <span class="number">76</span>:         &#125;</div><div class="line"> <span class="number">77</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">78</span>:         <span class="comment">// æ ¡éªŒ æ¶ˆè´¹åˆ†ç»„ä¿¡æ¯ æ˜¯å¦å­˜åœ¨</span></div><div class="line"> <span class="number">79</span>:         ConsumerGroupInfo consumerGroupInfo = <span class="keyword">this</span>.brokerController.getConsumerManager().getConsumerGroupInfo(requestHeader.getConsumerGroup());</div><div class="line"> <span class="number">80</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == consumerGroupInfo) &#123;</div><div class="line"> <span class="number">81</span>:             LOG.warn(<span class="string">"The consumer's group info not exist, group: &#123;&#125;"</span>, requestHeader.getConsumerGroup());</div><div class="line"> <span class="number">82</span>:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_EXIST);</div><div class="line"> <span class="number">83</span>:             response.setRemark(<span class="string">"the consumer's group info not exist"</span> + FAQUrl.suggestTodo(FAQUrl.SAME_GROUP_DIFFERENT_TOPIC));</div><div class="line"> <span class="number">84</span>:             <span class="keyword">return</span> response;</div><div class="line"> <span class="number">85</span>:         &#125;</div><div class="line"> <span class="number">86</span>:         <span class="comment">// æ ¡éªŒ æ¶ˆè´¹åˆ†ç»„ä¿¡æ¯ æ¶ˆæ¯æ¨¡å‹æ˜¯å¦åŒ¹é…</span></div><div class="line"> <span class="number">87</span>:         <span class="keyword">if</span> (!subscriptionGroupConfig.isConsumeBroadcastEnable() <span class="comment">//</span></div><div class="line"> <span class="number">88</span>:             &amp;&amp; consumerGroupInfo.getMessageModel() == MessageModel.BROADCASTING) &#123;</div><div class="line"> <span class="number">89</span>:             response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"> <span class="number">90</span>:             response.setRemark(<span class="string">"the consumer group["</span> + requestHeader.getConsumerGroup() + <span class="string">"] can not consume by broadcast way"</span>);</div><div class="line"> <span class="number">91</span>:             <span class="keyword">return</span> response;</div><div class="line"> <span class="number">92</span>:         &#125;</div><div class="line"> <span class="number">93</span>: </div><div class="line"> <span class="number">94</span>:         <span class="comment">// æ ¡éªŒ è®¢é˜…ä¿¡æ¯ æ˜¯å¦å­˜åœ¨</span></div><div class="line"> <span class="number">95</span>:         subscriptionData = consumerGroupInfo.findSubscriptionData(requestHeader.getTopic());</div><div class="line"> <span class="number">96</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == subscriptionData) &#123;</div><div class="line"> <span class="number">97</span>:             LOG.warn(<span class="string">"The consumer's subscription not exist, group: &#123;&#125;, topic:&#123;&#125;"</span>, requestHeader.getConsumerGroup(), requestHeader.getTopic());</div><div class="line"> <span class="number">98</span>:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_EXIST);</div><div class="line"> <span class="number">99</span>:             response.setRemark(<span class="string">"the consumer's subscription not exist"</span> + FAQUrl.suggestTodo(FAQUrl.SAME_GROUP_DIFFERENT_TOPIC));</div><div class="line"><span class="number">100</span>:             <span class="keyword">return</span> response;</div><div class="line"><span class="number">101</span>:         &#125;</div><div class="line"><span class="number">102</span>:         <span class="comment">// æ ¡éªŒ è®¢é˜…ä¿¡æ¯ç‰ˆæœ¬ æ˜¯å¦åˆæ³•</span></div><div class="line"><span class="number">103</span>:         <span class="keyword">if</span> (subscriptionData.getSubVersion() &lt; requestHeader.getSubVersion()) &#123;</div><div class="line"><span class="number">104</span>:             LOG.warn(<span class="string">"The broker's subscription is not latest, group: &#123;&#125; &#123;&#125;"</span>, requestHeader.getConsumerGroup(),</div><div class="line"><span class="number">105</span>:                     subscriptionData.getSubString());</div><div class="line"><span class="number">106</span>:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_LATEST);</div><div class="line"><span class="number">107</span>:             response.setRemark(<span class="string">"the consumer's subscription not latest"</span>);</div><div class="line"><span class="number">108</span>:             <span class="keyword">return</span> response;</div><div class="line"><span class="number">109</span>:         &#125;</div><div class="line"><span class="number">110</span>:     &#125;</div><div class="line"><span class="number">111</span>: </div><div class="line"><span class="number">112</span>:     <span class="comment">// è·å–æ¶ˆæ¯</span></div><div class="line"><span class="number">113</span>:     <span class="keyword">final</span> GetMessageResult getMessageResult = <span class="keyword">this</span>.brokerController.getMessageStore().getMessage(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class="line"><span class="number">114</span>:             requestHeader.getQueueId(), requestHeader.getQueueOffset(), requestHeader.getMaxMsgNums(), subscriptionData);</div><div class="line"><span class="number">115</span>:     <span class="keyword">if</span> (getMessageResult != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">116</span>:         response.setRemark(getMessageResult.getStatus().name());</div><div class="line"><span class="number">117</span>:         responseHeader.setNextBeginOffset(getMessageResult.getNextBeginOffset());</div><div class="line"><span class="number">118</span>:         responseHeader.setMinOffset(getMessageResult.getMinOffset());</div><div class="line"><span class="number">119</span>:         responseHeader.setMaxOffset(getMessageResult.getMaxOffset());</div><div class="line"><span class="number">120</span>: </div><div class="line"><span class="number">121</span>:         <span class="comment">// TODO å¾…è¯»</span></div><div class="line"><span class="number">122</span>:         <span class="comment">// è®¡ç®—å»ºè®®è¯»å–brokerId</span></div><div class="line"><span class="number">123</span>:         <span class="keyword">if</span> (getMessageResult.isSuggestPullingFromSlave()) &#123;</div><div class="line"><span class="number">124</span>:             responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getWhichBrokerWhenConsumeSlowly());</div><div class="line"><span class="number">125</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">126</span>:             responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</div><div class="line"><span class="number">127</span>:         &#125;</div><div class="line"><span class="number">128</span>: </div><div class="line"><span class="number">129</span>:         <span class="keyword">switch</span> (<span class="keyword">this</span>.brokerController.getMessageStoreConfig().getBrokerRole()) &#123;</div><div class="line"><span class="number">130</span>:             <span class="keyword">case</span> ASYNC_MASTER:</div><div class="line"><span class="number">131</span>:             <span class="keyword">case</span> SYNC_MASTER:</div><div class="line"><span class="number">132</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">133</span>:             <span class="keyword">case</span> SLAVE:</div><div class="line"><span class="number">134</span>:                 <span class="keyword">if</span> (!<span class="keyword">this</span>.brokerController.getBrokerConfig().isSlaveReadEnable()) &#123; <span class="comment">// ä»èŠ‚ç‚¹ä¸å…è®¸è¯»å–ï¼Œå‘Šè¯‰consumerè¯»å–ä¸»èŠ‚ç‚¹ã€‚</span></div><div class="line"><span class="number">135</span>:                     response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class="line"><span class="number">136</span>:                     responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</div><div class="line"><span class="number">137</span>:                 &#125;</div><div class="line"><span class="number">138</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">139</span>:         &#125;</div><div class="line"><span class="number">140</span>: </div><div class="line"><span class="number">141</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getBrokerConfig().isSlaveReadEnable()) &#123;</div><div class="line"><span class="number">142</span>:             <span class="comment">// consume too slow ,redirect to another machine</span></div><div class="line"><span class="number">143</span>:             <span class="keyword">if</span> (getMessageResult.isSuggestPullingFromSlave()) &#123;</div><div class="line"><span class="number">144</span>:                 responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getWhichBrokerWhenConsumeSlowly());</div><div class="line"><span class="number">145</span>:             &#125;</div><div class="line"><span class="number">146</span>:             <span class="comment">// consume ok</span></div><div class="line"><span class="number">147</span>:             <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">148</span>:                 responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getBrokerId());</div><div class="line"><span class="number">149</span>:             &#125;</div><div class="line"><span class="number">150</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">151</span>:             responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</div><div class="line"><span class="number">152</span>:         &#125;</div><div class="line"><span class="number">153</span>: </div><div class="line"><span class="number">154</span>:         <span class="keyword">switch</span> (getMessageResult.getStatus()) &#123;</div><div class="line"><span class="number">155</span>:             <span class="keyword">case</span> FOUND:</div><div class="line"><span class="number">156</span>:                 response.setCode(ResponseCode.SUCCESS);</div><div class="line"><span class="number">157</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">158</span>:             <span class="keyword">case</span> MESSAGE_WAS_REMOVING:</div><div class="line"><span class="number">159</span>:                 response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class="line"><span class="number">160</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">161</span>:             <span class="keyword">case</span> NO_MATCHED_LOGIC_QUEUE:</div><div class="line"><span class="number">162</span>:             <span class="keyword">case</span> NO_MESSAGE_IN_QUEUE:</div><div class="line"><span class="number">163</span>:                 <span class="keyword">if</span> (<span class="number">0</span> != requestHeader.getQueueOffset()) &#123;</div><div class="line"><span class="number">164</span>:                     response.setCode(ResponseCode.PULL_OFFSET_MOVED);</div><div class="line"><span class="number">165</span>: </div><div class="line"><span class="number">166</span>:                     <span class="comment">// <span class="doctag">XXX:</span> warn and notify me</span></div><div class="line"><span class="number">167</span>:                     LOG.info(<span class="string">"the broker store no queue data, fix the request offset &#123;&#125; to &#123;&#125;, Topic: &#123;&#125; QueueId: &#123;&#125; Consumer Group: &#123;&#125;"</span>, <span class="comment">//</span></div><div class="line"><span class="number">168</span>:                         requestHeader.getQueueOffset(), <span class="comment">//</span></div><div class="line"><span class="number">169</span>:                         getMessageResult.getNextBeginOffset(), <span class="comment">//</span></div><div class="line"><span class="number">170</span>:                         requestHeader.getTopic(), <span class="comment">//</span></div><div class="line"><span class="number">171</span>:                         requestHeader.getQueueId(), <span class="comment">//</span></div><div class="line"><span class="number">172</span>:                         requestHeader.getConsumerGroup()<span class="comment">//</span></div><div class="line"><span class="number">173</span>:                     );</div><div class="line"><span class="number">174</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">175</span>:                     response.setCode(ResponseCode.PULL_NOT_FOUND);</div><div class="line"><span class="number">176</span>:                 &#125;</div><div class="line"><span class="number">177</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">178</span>:             <span class="keyword">case</span> NO_MATCHED_MESSAGE:</div><div class="line"><span class="number">179</span>:                 response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class="line"><span class="number">180</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">181</span>:             <span class="keyword">case</span> OFFSET_FOUND_NULL:</div><div class="line"><span class="number">182</span>:                 response.setCode(ResponseCode.PULL_NOT_FOUND);</div><div class="line"><span class="number">183</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">184</span>:             <span class="keyword">case</span> OFFSET_OVERFLOW_BADLY:</div><div class="line"><span class="number">185</span>:                 response.setCode(ResponseCode.PULL_OFFSET_MOVED);</div><div class="line"><span class="number">186</span>:                 <span class="comment">// <span class="doctag">XXX:</span> warn and notify me</span></div><div class="line"><span class="number">187</span>:                 LOG.info(<span class="string">"The request offset:&#123;&#125; over flow badly, broker max offset:&#123;&#125; , consumer: &#123;&#125;"</span>, requestHeader.getQueueOffset(), getMessageResult.getMaxOffset(), channel.remoteAddress());</div><div class="line"><span class="number">188</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">189</span>:             <span class="keyword">case</span> OFFSET_OVERFLOW_ONE:</div><div class="line"><span class="number">190</span>:                 response.setCode(ResponseCode.PULL_NOT_FOUND);</div><div class="line"><span class="number">191</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">192</span>:             <span class="keyword">case</span> OFFSET_TOO_SMALL:</div><div class="line"><span class="number">193</span>:                 response.setCode(ResponseCode.PULL_OFFSET_MOVED);</div><div class="line"><span class="number">194</span>:                 LOG.info(<span class="string">"The request offset is too small. group=&#123;&#125;, topic=&#123;&#125;, requestOffset=&#123;&#125;, brokerMinOffset=&#123;&#125;, clientIp=&#123;&#125;"</span>,</div><div class="line"><span class="number">195</span>:                     requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueOffset(),</div><div class="line"><span class="number">196</span>:                     getMessageResult.getMinOffset(), channel.remoteAddress());</div><div class="line"><span class="number">197</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">198</span>:             <span class="keyword">default</span>:</div><div class="line"><span class="number">199</span>:                 <span class="keyword">assert</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">200</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">201</span>:         &#125;</div><div class="line"><span class="number">202</span>: </div><div class="line"><span class="number">203</span>:         <span class="comment">// hookï¼šbefore</span></div><div class="line"><span class="number">204</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.hasConsumeMessageHook()) &#123;</div><div class="line"><span class="number">205</span>:             ConsumeMessageContext context = <span class="keyword">new</span> ConsumeMessageContext();</div><div class="line"><span class="number">206</span>:             context.setConsumerGroup(requestHeader.getConsumerGroup());</div><div class="line"><span class="number">207</span>:             context.setTopic(requestHeader.getTopic());</div><div class="line"><span class="number">208</span>:             context.setQueueId(requestHeader.getQueueId());</div><div class="line"><span class="number">209</span>: </div><div class="line"><span class="number">210</span>:             String owner = request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER);</div><div class="line"><span class="number">211</span>: </div><div class="line"><span class="number">212</span>:             <span class="keyword">switch</span> (response.getCode()) &#123;</div><div class="line"><span class="number">213</span>:                 <span class="keyword">case</span> ResponseCode.SUCCESS:</div><div class="line"><span class="number">214</span>:                     <span class="keyword">int</span> commercialBaseCount = brokerController.getBrokerConfig().getCommercialBaseCount();</div><div class="line"><span class="number">215</span>:                     <span class="keyword">int</span> incValue = getMessageResult.getMsgCount4Commercial() * commercialBaseCount;</div><div class="line"><span class="number">216</span>: </div><div class="line"><span class="number">217</span>:                     context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_SUCCESS);</div><div class="line"><span class="number">218</span>:                     context.setCommercialRcvTimes(incValue);</div><div class="line"><span class="number">219</span>:                     context.setCommercialRcvSize(getMessageResult.getBufferTotalSize());</div><div class="line"><span class="number">220</span>:                     context.setCommercialOwner(owner);</div><div class="line"><span class="number">221</span>: </div><div class="line"><span class="number">222</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">223</span>:                 <span class="keyword">case</span> ResponseCode.PULL_NOT_FOUND:</div><div class="line"><span class="number">224</span>:                     <span class="keyword">if</span> (!brokerAllowSuspend) &#123;</div><div class="line"><span class="number">225</span>: </div><div class="line"><span class="number">226</span>:                         context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_EPOLLS);</div><div class="line"><span class="number">227</span>:                         context.setCommercialRcvTimes(<span class="number">1</span>);</div><div class="line"><span class="number">228</span>:                         context.setCommercialOwner(owner);</div><div class="line"><span class="number">229</span>: </div><div class="line"><span class="number">230</span>:                     &#125;</div><div class="line"><span class="number">231</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">232</span>:                 <span class="keyword">case</span> ResponseCode.PULL_RETRY_IMMEDIATELY:</div><div class="line"><span class="number">233</span>:                 <span class="keyword">case</span> ResponseCode.PULL_OFFSET_MOVED:</div><div class="line"><span class="number">234</span>:                     context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_EPOLLS);</div><div class="line"><span class="number">235</span>:                     context.setCommercialRcvTimes(<span class="number">1</span>);</div><div class="line"><span class="number">236</span>:                     context.setCommercialOwner(owner);</div><div class="line"><span class="number">237</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">238</span>:                 <span class="keyword">default</span>:</div><div class="line"><span class="number">239</span>:                     <span class="keyword">assert</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">240</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">241</span>:             &#125;</div><div class="line"><span class="number">242</span>: </div><div class="line"><span class="number">243</span>:             <span class="keyword">this</span>.executeConsumeMessageHookBefore(context);</div><div class="line"><span class="number">244</span>:         &#125;</div><div class="line"><span class="number">245</span>: </div><div class="line"><span class="number">246</span>:         <span class="keyword">switch</span> (response.getCode()) &#123;</div><div class="line"><span class="number">247</span>:             <span class="keyword">case</span> ResponseCode.SUCCESS:</div><div class="line"><span class="number">248</span>: </div><div class="line"><span class="number">249</span>:                 <span class="keyword">this</span>.brokerController.getBrokerStatsManager().incGroupGetNums(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class="line"><span class="number">250</span>:                     getMessageResult.getMessageCount());</div><div class="line"><span class="number">251</span>:                 <span class="keyword">this</span>.brokerController.getBrokerStatsManager().incGroupGetSize(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class="line"><span class="number">252</span>:                     getMessageResult.getBufferTotalSize());</div><div class="line"><span class="number">253</span>:                 <span class="keyword">this</span>.brokerController.getBrokerStatsManager().incBrokerGetNums(getMessageResult.getMessageCount());</div><div class="line"><span class="number">254</span>:                 <span class="comment">// è¯»å–æ¶ˆæ¯</span></div><div class="line"><span class="number">255</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getBrokerConfig().isTransferMsgByHeap()) &#123; <span class="comment">// å†…å­˜ä¸­</span></div><div class="line"><span class="number">256</span>:                     <span class="keyword">final</span> <span class="keyword">long</span> beginTimeMills = <span class="keyword">this</span>.brokerController.getMessageStore().now();</div><div class="line"><span class="number">257</span>: </div><div class="line"><span class="number">258</span>:                     <span class="keyword">final</span> <span class="keyword">byte</span>[] r = <span class="keyword">this</span>.readGetMessageResult(getMessageResult, requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueId());</div><div class="line"><span class="number">259</span>: </div><div class="line"><span class="number">260</span>:                     <span class="keyword">this</span>.brokerController.getBrokerStatsManager().incGroupGetLatency(requestHeader.getConsumerGroup(),</div><div class="line"><span class="number">261</span>:                         requestHeader.getTopic(), requestHeader.getQueueId(),</div><div class="line"><span class="number">262</span>:                         (<span class="keyword">int</span>) (<span class="keyword">this</span>.brokerController.getMessageStore().now() - beginTimeMills));</div><div class="line"><span class="number">263</span>:                     response.setBody(r);</div><div class="line"><span class="number">264</span>:                 &#125; <span class="keyword">else</span> &#123; <span class="comment">// zero-copy</span></div><div class="line"><span class="number">265</span>:                     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">266</span>:                         FileRegion fileRegion = <span class="keyword">new</span> ManyMessageTransfer(response.encodeHeader(getMessageResult.getBufferTotalSize()), getMessageResult);</div><div class="line"><span class="number">267</span>:                         channel.writeAndFlush(fileRegion).addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</div><div class="line"><span class="number">268</span>:                             <span class="meta">@Override</span></div><div class="line"><span class="number">269</span>:                             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"><span class="number">270</span>:                                 getMessageResult.release();</div><div class="line"><span class="number">271</span>:                                 <span class="keyword">if</span> (!future.isSuccess()) &#123;</div><div class="line"><span class="number">272</span>:                                     LOG.error(<span class="string">"Fail to transfer messages from page cache to &#123;&#125;"</span>, channel.remoteAddress(), future.cause());</div><div class="line"><span class="number">273</span>:                                 &#125;</div><div class="line"><span class="number">274</span>:                             &#125;</div><div class="line"><span class="number">275</span>:                         &#125;);</div><div class="line"><span class="number">276</span>:                     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">277</span>:                         LOG.error(<span class="string">"Error occurred when transferring messages from page cache"</span>, e);</div><div class="line"><span class="number">278</span>:                         getMessageResult.release();</div><div class="line"><span class="number">279</span>:                     &#125;</div><div class="line"><span class="number">280</span>: </div><div class="line"><span class="number">281</span>:                     response = <span class="keyword">null</span>;</div><div class="line"><span class="number">282</span>:                 &#125;</div><div class="line"><span class="number">283</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">284</span>:             <span class="keyword">case</span> ResponseCode.PULL_NOT_FOUND:</div><div class="line"><span class="number">285</span>:                 <span class="comment">// æ¶ˆæ¯æœªæŸ¥è¯¢åˆ° &amp;&amp; brokerå…è®¸æŒ‚èµ·è¯·æ±‚ &amp;&amp; è¯·æ±‚å…è®¸æŒ‚èµ·</span></div><div class="line"><span class="number">286</span>:                 <span class="keyword">if</span> (brokerAllowSuspend &amp;&amp; hasSuspendFlag) &#123;</div><div class="line"><span class="number">287</span>:                     <span class="keyword">long</span> pollingTimeMills = suspendTimeoutMillisLong;</div><div class="line"><span class="number">288</span>:                     <span class="keyword">if</span> (!<span class="keyword">this</span>.brokerController.getBrokerConfig().isLongPollingEnable()) &#123;</div><div class="line"><span class="number">289</span>:                         pollingTimeMills = <span class="keyword">this</span>.brokerController.getBrokerConfig().getShortPollingTimeMills();</div><div class="line"><span class="number">290</span>:                     &#125;</div><div class="line"><span class="number">291</span>: </div><div class="line"><span class="number">292</span>:                     String topic = requestHeader.getTopic();</div><div class="line"><span class="number">293</span>:                     <span class="keyword">long</span> offset = requestHeader.getQueueOffset();</div><div class="line"><span class="number">294</span>:                     <span class="keyword">int</span> queueId = requestHeader.getQueueId();</div><div class="line"><span class="number">295</span>:                     PullRequest pullRequest = <span class="keyword">new</span> PullRequest(request, channel, pollingTimeMills,</div><div class="line"><span class="number">296</span>:                         <span class="keyword">this</span>.brokerController.getMessageStore().now(), offset, subscriptionData);</div><div class="line"><span class="number">297</span>:                     <span class="keyword">this</span>.brokerController.getPullRequestHoldService().suspendPullRequest(topic, queueId, pullRequest);</div><div class="line"><span class="number">298</span>:                     response = <span class="keyword">null</span>;</div><div class="line"><span class="number">299</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">300</span>:                 &#125;</div><div class="line"><span class="number">301</span>: </div><div class="line"><span class="number">302</span>:             <span class="keyword">case</span> ResponseCode.PULL_RETRY_IMMEDIATELY:</div><div class="line"><span class="number">303</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">304</span>:             <span class="keyword">case</span> ResponseCode.PULL_OFFSET_MOVED:</div><div class="line"><span class="number">305</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE</div><div class="line"><span class="number">306</span>:                     || <span class="keyword">this</span>.brokerController.getMessageStoreConfig().isOffsetCheckInSlave()) &#123; <span class="comment">// TODO å¾…åšå®¢è¡¥å……</span></div><div class="line"><span class="number">307</span>:                     MessageQueue mq = <span class="keyword">new</span> MessageQueue();</div><div class="line"><span class="number">308</span>:                     mq.setTopic(requestHeader.getTopic());</div><div class="line"><span class="number">309</span>:                     mq.setQueueId(requestHeader.getQueueId());</div><div class="line"><span class="number">310</span>:                     mq.setBrokerName(<span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerName());</div><div class="line"><span class="number">311</span>: </div><div class="line"><span class="number">312</span>:                     OffsetMovedEvent event = <span class="keyword">new</span> OffsetMovedEvent();</div><div class="line"><span class="number">313</span>:                     event.setConsumerGroup(requestHeader.getConsumerGroup());</div><div class="line"><span class="number">314</span>:                     event.setMessageQueue(mq);</div><div class="line"><span class="number">315</span>:                     event.setOffsetRequest(requestHeader.getQueueOffset());</div><div class="line"><span class="number">316</span>:                     event.setOffsetNew(getMessageResult.getNextBeginOffset());</div><div class="line"><span class="number">317</span>:                     <span class="keyword">this</span>.generateOffsetMovedEvent(event);</div><div class="line"><span class="number">318</span>:                     LOG.warn(</div><div class="line"><span class="number">319</span>:                         <span class="string">"PULL_OFFSET_MOVED:correction offset. topic=&#123;&#125;, groupId=&#123;&#125;, requestOffset=&#123;&#125;, newOffset=&#123;&#125;, suggestBrokerId=&#123;&#125;"</span>,</div><div class="line"><span class="number">320</span>:                         requestHeader.getTopic(), requestHeader.getConsumerGroup(), event.getOffsetRequest(), event.getOffsetNew(),</div><div class="line"><span class="number">321</span>:                         responseHeader.getSuggestWhichBrokerId());</div><div class="line"><span class="number">322</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">323</span>:                     responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getBrokerId());</div><div class="line"><span class="number">324</span>:                     response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class="line"><span class="number">325</span>:                     LOG.warn(<span class="string">"PULL_OFFSET_MOVED:none correction. topic=&#123;&#125;, groupId=&#123;&#125;, requestOffset=&#123;&#125;, suggestBrokerId=&#123;&#125;"</span>,</div><div class="line"><span class="number">326</span>:                         requestHeader.getTopic(), requestHeader.getConsumerGroup(), requestHeader.getQueueOffset(),</div><div class="line"><span class="number">327</span>:                         responseHeader.getSuggestWhichBrokerId());</div><div class="line"><span class="number">328</span>:                 &#125;</div><div class="line"><span class="number">329</span>: </div><div class="line"><span class="number">330</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">331</span>:             <span class="keyword">default</span>:</div><div class="line"><span class="number">332</span>:                 <span class="keyword">assert</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">333</span>:         &#125;</div><div class="line"><span class="number">334</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">335</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">336</span>:         response.setRemark(<span class="string">"store getMessage return null"</span>);</div><div class="line"><span class="number">337</span>:     &#125;</div><div class="line"><span class="number">338</span>: </div><div class="line"><span class="number">339</span>:     <span class="comment">// è¯·æ±‚è¦æ±‚æŒä¹…åŒ–è¿›åº¦ &amp;&amp; brokeréä¸»ï¼Œè¿›è¡ŒæŒä¹…åŒ–è¿›åº¦ã€‚</span></div><div class="line"><span class="number">340</span>:     <span class="keyword">boolean</span> storeOffsetEnable = brokerAllowSuspend;</div><div class="line"><span class="number">341</span>:     storeOffsetEnable = storeOffsetEnable &amp;&amp; hasCommitOffsetFlag;</div><div class="line"><span class="number">342</span>:     storeOffsetEnable = storeOffsetEnable &amp;&amp; <span class="keyword">this</span>.brokerController.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE;</div><div class="line"><span class="number">343</span>:     <span class="keyword">if</span> (storeOffsetEnable) &#123;</div><div class="line"><span class="number">344</span>:         <span class="keyword">this</span>.brokerController.getConsumerOffsetManager().commitOffset(RemotingHelper.parseChannelRemoteAddr(channel),</div><div class="line"><span class="number">345</span>:             requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueId(), requestHeader.getCommitOffset());</div><div class="line"><span class="number">346</span>:     &#125;</div><div class="line"><span class="number">347</span>:     <span class="keyword">return</span> response;</div><div class="line"><span class="number">348</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ï¼šå¤„ç†æ‹‰å–æ¶ˆæ¯è¯·æ±‚ï¼Œè¿”å›å“åº”ã€‚</li>
<li>ç¬¬ 14 è‡³ 19 è¡Œ ï¼šæ ¡éªŒ <code>Broker</code> æ˜¯å¦å¯è¯»ã€‚</li>
<li>ç¬¬ 21 è‡³ 33 è¡Œ ï¼šæ ¡éªŒ <code>SubscriptionGroupConfig</code>(è®¢é˜…åˆ†ç»„é…ç½®) æ˜¯å¦å­˜åœ¨ &amp;&amp; å¯ä»¥æ¶ˆè´¹ã€‚</li>
<li>ç¬¬ 35 è‡³ 38 è¡Œ ï¼šå¤„ç† <code>PullMessageRequestHeader.sysFlag</code> å¯¹åº”çš„æ ‡å¿—ä½ã€‚</li>
<li>ç¬¬ 40 è‡³ 62 è¡Œ ï¼šæ ¡éªŒ <code>TopicConfig</code>(ä¸»é¢˜é…ç½®) æ˜¯å¦å­˜åœ¨ &amp;&amp; å¯è¯» &amp;&amp; é˜Ÿåˆ—ç¼–å·æ­£ç¡®ã€‚</li>
<li>ç¬¬ 64 è‡³ 110 è¡Œ ï¼šæ ¡éªŒ <code>SubscriptionData</code>(è®¢é˜…ä¿¡æ¯) æ˜¯å¦æ­£ç¡®ã€‚</li>
<li>ç¬¬ 113 è¡Œ ï¼šè°ƒç”¨ <code>MessageStore#getMessage(...)</code> è·å– <code>GetMessageResult</code>(æ¶ˆæ¯)ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#messagestoregetmessage">MessageStore#getMessage(...)</a>ã€‚</li>
<li>ç¬¬ 122 è‡³ 152 è¡Œ ï¼šè®¡ç®—å»ºè®®æ‹‰å–æ¶ˆæ¯ <code>brokerId</code> ã€‚</li>
<li>ç¬¬ 154 è‡³ 201 è¡Œ ï¼š<img src="http://www.yunai.me/images/RocketMQ/2017_05_04/08.png" alt="PullMessageProcessoræ‹‰å–æ¶ˆæ¯çŠ¶æ€å›¾"></li>
<li>ç¬¬ 204 è‡³ 244 è¡Œ ï¼š<code>Hook</code> é€»è¾‘ï¼Œ<code>#executeConsumeMessageHookBefore(...)</code> ã€‚</li>
<li>ç¬¬ 247 è‡³ 283 è¡Œ ï¼šæ‹‰å–æ¶ˆæ¯æˆåŠŸï¼Œå³æ‹‰å–åˆ°æ¶ˆæ¯ã€‚
<ul>
<li>ç¬¬ 255 è‡³ 263 è¡Œ ï¼šæ–¹å¼ä¸€ ï¼šè°ƒç”¨ <code>readGetMessageResult(...)</code> è·å–æ¶ˆæ¯å†…å®¹åˆ°å †å†…å†…å­˜ï¼Œè®¾ç½®åˆ° å“åº”<code>body</code>ã€‚</li>
<li>ç¬¬ 265 è‡³ 281 è¡Œ ï¼šæ–¹å¼äºŒ ï¼šåŸºäº <code>zero-copy</code> å®ç°ï¼Œç›´æ¥å“åº”ï¼Œæ— éœ€å †å†…å†…å­˜ï¼Œæ€§èƒ½æ›´ä¼˜ã€‚<em>TODO ï¼šæ­¤å¤„ç­‰å¯¹zero-copyæœ‰ç ”ç©¶ï¼Œå†è¡¥å……ä¸€äº›</em>ã€‚</li>
</ul>
</li>
<li>ç¬¬ 284 è‡³ 300 è¡Œ ï¼šæ‹‰å–ä¸åˆ°æ¶ˆæ¯ï¼Œå½“æ»¡è¶³æ¡ä»¶ (<code>Broker</code> å…è®¸æŒ‚èµ· &amp;&amp; è¯·æ±‚è¦æ±‚æŒ‚èµ·)ï¼Œæ‰§è¡ŒæŒ‚èµ·è¯·æ±‚ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#pullrequestholdservice">PullRequestHoldService</a>ã€‚</li>
<li>ç¬¬ 304 è‡³ 328 è¡Œ ï¼š<em>TODO ï¼šæ­¤å¤„ç­‰å¯¹<code>tools</code>æ¨¡å—ç ”ç©¶åå†è¡¥å……</em>ã€‚</li>
<li>ç¬¬ 339 è‡³ 346 ï¼šæŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ï¼Œå½“æ»¡è¶³ (<code>Broker</code> éä¸» &amp;&amp; è¯·æ±‚è¦æ±‚æŒä¹…åŒ–è¿›åº¦)ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#3broker-%E6%8F%90%E4%BE%9B%E6%9B%B4%E6%96%B0%E6%B6%88%E8%B4%B9%E8%BF%9B%E5%BA%A6%E6%8E%A5%E5%8F%A3">æ›´æ–°æ¶ˆè´¹è¿›åº¦</a>ã€‚</li>
</ul>
<h2>MessageStore#getMessage(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">/**</span></div><div class="line">  2:  * è·å–æ¶ˆæ¯ç»“æœ</div><div class="line">  3:  *</div><div class="line">  4:  * <span class="doctag">@param</span> group æ¶ˆè´¹åˆ†ç»„</div><div class="line">  5:  * <span class="doctag">@param</span> topic ä¸»é¢˜</div><div class="line">  6:  * <span class="doctag">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class="line">  7:  * <span class="doctag">@param</span> offset é˜Ÿåˆ—ä½ç½®</div><div class="line">  8:  * <span class="doctag">@param</span> maxMsgNums æ¶ˆæ¯æ•°é‡</div><div class="line">  9:  * <span class="doctag">@param</span> subscriptionData è®¢é˜…ä¿¡æ¯</div><div class="line"> 10:  * <span class="doctag">@return</span> æ¶ˆæ¯ç»“æœ</div><div class="line"> 11:  */</div><div class="line"> <span class="number">12</span>: <span class="function"><span class="keyword">public</span> GetMessageResult <span class="title">getMessage</span><span class="params">(<span class="keyword">final</span> String group, <span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> offset, <span class="keyword">final</span> <span class="keyword">int</span> maxMsgNums,</span></span></div><div class="line"> <span class="number">13</span>:     <span class="keyword">final</span> SubscriptionData subscriptionData) &#123;</div><div class="line"> <span class="number">14</span>:     <span class="comment">// æ˜¯å¦å…³é—­</span></div><div class="line"> <span class="number">15</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.shutdown) &#123;</div><div class="line"> <span class="number">16</span>:         log.warn(<span class="string">"message store has shutdown, so getMessage is forbidden"</span>);</div><div class="line"> <span class="number">17</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"> <span class="number">18</span>:     &#125;</div><div class="line"> <span class="number">19</span>:     <span class="comment">// æ˜¯å¦å¯è¯»</span></div><div class="line"> <span class="number">20</span>:     <span class="keyword">if</span> (!<span class="keyword">this</span>.runningFlags.isReadable()) &#123;</div><div class="line"> <span class="number">21</span>:         log.warn(<span class="string">"message store is not readable, so getMessage is forbidden "</span> + <span class="keyword">this</span>.runningFlags.getFlagBits());</div><div class="line"> <span class="number">22</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"> <span class="number">23</span>:     &#125;</div><div class="line"> <span class="number">24</span>: </div><div class="line"> <span class="number">25</span>:     <span class="keyword">long</span> beginTime = <span class="keyword">this</span>.getSystemClock().now();</div><div class="line"> <span class="number">26</span>: </div><div class="line"> <span class="number">27</span>:     GetMessageStatus status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;</div><div class="line"> <span class="number">28</span>:     <span class="keyword">long</span> nextBeginOffset = offset;</div><div class="line"> <span class="number">29</span>:     <span class="keyword">long</span> minOffset = <span class="number">0</span>;</div><div class="line"> <span class="number">30</span>:     <span class="keyword">long</span> maxOffset = <span class="number">0</span>;</div><div class="line"> <span class="number">31</span>: </div><div class="line"> <span class="number">32</span>:     GetMessageResult getResult = <span class="keyword">new</span> GetMessageResult();</div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:     <span class="keyword">final</span> <span class="keyword">long</span> maxOffsetPy = <span class="keyword">this</span>.commitLog.getMaxOffset();</div><div class="line"> <span class="number">35</span>: </div><div class="line"> <span class="number">36</span>:     <span class="comment">// è·å–æ¶ˆè´¹é˜Ÿåˆ—</span></div><div class="line"> <span class="number">37</span>:     ConsumeQueue consumeQueue = findConsumeQueue(topic, queueId);</div><div class="line"> <span class="number">38</span>:     <span class="keyword">if</span> (consumeQueue != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">39</span>:         minOffset = consumeQueue.getMinOffsetInQueue(); <span class="comment">// æ¶ˆè´¹é˜Ÿåˆ— æœ€å°é˜Ÿåˆ—ç¼–å·</span></div><div class="line"> <span class="number">40</span>:         maxOffset = consumeQueue.getMaxOffsetInQueue(); <span class="comment">// æ¶ˆè´¹é˜Ÿåˆ— æœ€å¤§é˜Ÿåˆ—ç¼–å·</span></div><div class="line"> <span class="number">41</span>: </div><div class="line"> <span class="number">42</span>:         <span class="comment">// åˆ¤æ–­ é˜Ÿåˆ—ä½ç½®(offset)</span></div><div class="line"> <span class="number">43</span>:         <span class="keyword">if</span> (maxOffset == <span class="number">0</span>) &#123; <span class="comment">// æ¶ˆè´¹é˜Ÿåˆ—æ— æ¶ˆæ¯</span></div><div class="line"> <span class="number">44</span>:             status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;</div><div class="line"> <span class="number">45</span>:             nextBeginOffset = nextOffsetCorrection(offset, <span class="number">0</span>);</div><div class="line"> <span class="number">46</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (offset &lt; minOffset) &#123; <span class="comment">// æŸ¥è¯¢offset å¤ªå°</span></div><div class="line"> <span class="number">47</span>:             status = GetMessageStatus.OFFSET_TOO_SMALL;</div><div class="line"> <span class="number">48</span>:             nextBeginOffset = nextOffsetCorrection(offset, minOffset);</div><div class="line"> <span class="number">49</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (offset == maxOffset) &#123; <span class="comment">// æŸ¥è¯¢offset è¶…è¿‡ æ¶ˆè´¹é˜Ÿåˆ— ä¸€ä¸ªä½ç½®</span></div><div class="line"> <span class="number">50</span>:             status = GetMessageStatus.OFFSET_OVERFLOW_ONE;</div><div class="line"> <span class="number">51</span>:             nextBeginOffset = nextOffsetCorrection(offset, offset);</div><div class="line"> <span class="number">52</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (offset &gt; maxOffset) &#123; <span class="comment">// æŸ¥è¯¢offset è¶…è¿‡ æ¶ˆè´¹é˜Ÿåˆ— å¤ªå¤š(å¤§äºä¸€ä¸ªä½ç½®)</span></div><div class="line"> <span class="number">53</span>:             status = GetMessageStatus.OFFSET_OVERFLOW_BADLY;</div><div class="line"> <span class="number">54</span>:             <span class="keyword">if</span> (<span class="number">0</span> == minOffset) &#123; <span class="comment">// TODO blog è¿™é‡Œæ˜¯ï¼Ÿï¼Ÿä¸ºå•¥0 == minOffsetåšäº†ç‰¹æ®Šåˆ¤æ–­</span></div><div class="line"> <span class="number">55</span>:                 nextBeginOffset = nextOffsetCorrection(offset, minOffset);</div><div class="line"> <span class="number">56</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">57</span>:                 nextBeginOffset = nextOffsetCorrection(offset, maxOffset);</div><div class="line"> <span class="number">58</span>:             &#125;</div><div class="line"> <span class="number">59</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">60</span>:             <span class="comment">// è·å¾— æ˜ å°„Bufferç»“æœ(MappedFile)</span></div><div class="line"> <span class="number">61</span>:             SelectMappedBufferResult bufferConsumeQueue = consumeQueue.getIndexBuffer(offset);</div><div class="line"> <span class="number">62</span>:             <span class="keyword">if</span> (bufferConsumeQueue != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">63</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">64</span>:                     status = GetMessageStatus.NO_MATCHED_MESSAGE;</div><div class="line"> <span class="number">65</span>: </div><div class="line"> <span class="number">66</span>:                     <span class="keyword">long</span> nextPhyFileStartOffset = Long.MIN_VALUE; <span class="comment">// commitLogä¸‹ä¸€ä¸ªæ–‡ä»¶(MappedFile)å¯¹åº”çš„å¼€å§‹offsetã€‚</span></div><div class="line"> <span class="number">67</span>:                     <span class="keyword">long</span> maxPhyOffsetPulling = <span class="number">0</span>; <span class="comment">// æ¶ˆæ¯ç‰©ç†ä½ç½®æ‹‰å–åˆ°çš„æœ€å¤§offset</span></div><div class="line"> <span class="number">68</span>: </div><div class="line"> <span class="number">69</span>:                     <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line"> <span class="number">70</span>:                     <span class="keyword">final</span> <span class="keyword">int</span> maxFilterMessageCount = <span class="number">16000</span>;</div><div class="line"> <span class="number">71</span>:                     <span class="keyword">final</span> <span class="keyword">boolean</span> diskFallRecorded = <span class="keyword">this</span>.messageStoreConfig.isDiskFallRecorded();</div><div class="line"> <span class="number">72</span>:                     <span class="comment">// å¾ªç¯è·å– æ¶ˆæ¯ä½ç½®ä¿¡æ¯</span></div><div class="line"> <span class="number">73</span>:                     <span class="keyword">for</span> (; i &lt; bufferConsumeQueue.getSize() &amp;&amp; i &lt; maxFilterMessageCount; i += ConsumeQueue.CQ_STORE_UNIT_SIZE) &#123;</div><div class="line"> <span class="number">74</span>:                         <span class="keyword">long</span> offsetPy = bufferConsumeQueue.getByteBuffer().getLong(); <span class="comment">// æ¶ˆæ¯ç‰©ç†ä½ç½®offset</span></div><div class="line"> <span class="number">75</span>:                         <span class="keyword">int</span> sizePy = bufferConsumeQueue.getByteBuffer().getInt(); <span class="comment">// æ¶ˆæ¯é•¿åº¦</span></div><div class="line"> <span class="number">76</span>:                         <span class="keyword">long</span> tagsCode = bufferConsumeQueue.getByteBuffer().getLong(); <span class="comment">// æ¶ˆæ¯tagsCode</span></div><div class="line"> <span class="number">77</span>:                         <span class="comment">// è®¾ç½®æ¶ˆæ¯ç‰©ç†ä½ç½®æ‹‰å–åˆ°çš„æœ€å¤§offset</span></div><div class="line"> <span class="number">78</span>:                         maxPhyOffsetPulling = offsetPy;</div><div class="line"> <span class="number">79</span>:                         <span class="comment">// å½“ offsetPy å°äº nextPhyFileStartOffset æ—¶ï¼Œæ„å‘³ç€å¯¹åº”çš„ Message å·²ç»ç§»é™¤ï¼Œæ‰€ä»¥ç›´æ¥continueï¼Œç›´åˆ°å¯è¯»å–çš„Messageã€‚</span></div><div class="line"> <span class="number">80</span>:                         <span class="keyword">if</span> (nextPhyFileStartOffset != Long.MIN_VALUE) &#123;</div><div class="line"> <span class="number">81</span>:                             <span class="keyword">if</span> (offsetPy &lt; nextPhyFileStartOffset)</div><div class="line"> <span class="number">82</span>:                                 <span class="keyword">continue</span>;</div><div class="line"> <span class="number">83</span>:                         &#125;</div><div class="line"> <span class="number">84</span>:                         <span class="comment">// æ ¡éªŒ commitLog æ˜¯å¦éœ€è¦ç¡¬ç›˜ï¼Œæ— æ³•å…¨éƒ¨æ”¾åœ¨å†…å­˜</span></div><div class="line"> <span class="number">85</span>:                         <span class="keyword">boolean</span> isInDisk = checkInDiskByCommitOffset(offsetPy, maxOffsetPy);</div><div class="line"> <span class="number">86</span>:                         <span class="comment">// æ˜¯å¦å·²ç»è·å¾—è¶³å¤Ÿæ¶ˆæ¯</span></div><div class="line"> <span class="number">87</span>:                         <span class="keyword">if</span> (<span class="keyword">this</span>.isTheBatchFull(sizePy, maxMsgNums, getResult.getBufferTotalSize(), getResult.getMessageCount(),</div><div class="line"> <span class="number">88</span>:                             isInDisk)) &#123;</div><div class="line"> <span class="number">89</span>:                             <span class="keyword">break</span>;</div><div class="line"> <span class="number">90</span>:                         &#125;</div><div class="line"> <span class="number">91</span>:                         <span class="comment">// åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦ç¬¦åˆæ¡ä»¶</span></div><div class="line"> <span class="number">92</span>:                         <span class="keyword">if</span> (<span class="keyword">this</span>.messageFilter.isMessageMatched(subscriptionData, tagsCode)) &#123;</div><div class="line"> <span class="number">93</span>:                             <span class="comment">// ä»commitLogè·å–å¯¹åº”æ¶ˆæ¯ByteBuffer</span></div><div class="line"> <span class="number">94</span>:                             SelectMappedBufferResult selectResult = <span class="keyword">this</span>.commitLog.getMessage(offsetPy, sizePy);</div><div class="line"> <span class="number">95</span>:                             <span class="keyword">if</span> (selectResult != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">96</span>:                                 <span class="keyword">this</span>.storeStatsService.getGetMessageTransferedMsgCount().incrementAndGet();</div><div class="line"> <span class="number">97</span>:                                 getResult.addMessage(selectResult);</div><div class="line"> <span class="number">98</span>:                                 status = GetMessageStatus.FOUND;</div><div class="line"> <span class="number">99</span>:                                 nextPhyFileStartOffset = Long.MIN_VALUE;</div><div class="line"><span class="number">100</span>:                             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">101</span>:                                 <span class="comment">// ä»commitLogæ— æ³•è¯»å–åˆ°æ¶ˆæ¯ï¼Œè¯´æ˜è¯¥æ¶ˆæ¯å¯¹åº”çš„æ–‡ä»¶ï¼ˆMappedFileï¼‰å·²ç»åˆ é™¤ï¼Œè®¡ç®—ä¸‹ä¸€ä¸ªMappedFileçš„èµ·å§‹ä½ç½®</span></div><div class="line"><span class="number">102</span>:                                 <span class="keyword">if</span> (getResult.getBufferTotalSize() == <span class="number">0</span>) &#123;</div><div class="line"><span class="number">103</span>:                                     status = GetMessageStatus.MESSAGE_WAS_REMOVING;</div><div class="line"><span class="number">104</span>:                                 &#125;</div><div class="line"><span class="number">105</span>:                                 nextPhyFileStartOffset = <span class="keyword">this</span>.commitLog.rollNextFile(offsetPy);</div><div class="line"><span class="number">106</span>:                             &#125;</div><div class="line"><span class="number">107</span>:                         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">108</span>:                             <span class="keyword">if</span> (getResult.getBufferTotalSize() == <span class="number">0</span>) &#123;</div><div class="line"><span class="number">109</span>:                                 status = GetMessageStatus.NO_MATCHED_MESSAGE;</div><div class="line"><span class="number">110</span>:                             &#125;</div><div class="line"><span class="number">111</span>: </div><div class="line"><span class="number">112</span>:                             <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line"><span class="number">113</span>:                                 log.debug(<span class="string">"message type not matched, client: "</span> + subscriptionData + <span class="string">" server: "</span> + tagsCode);</div><div class="line"><span class="number">114</span>:                             &#125;</div><div class="line"><span class="number">115</span>:                         &#125;</div><div class="line"><span class="number">116</span>:                     &#125;</div><div class="line"><span class="number">117</span>:                     <span class="comment">// ç»Ÿè®¡å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°</span></div><div class="line"><span class="number">118</span>:                     <span class="keyword">if</span> (diskFallRecorded) &#123;</div><div class="line"><span class="number">119</span>:                         <span class="keyword">long</span> fallBehind = maxOffsetPy - maxPhyOffsetPulling;</div><div class="line"><span class="number">120</span>:                         brokerStatsManager.recordDiskFallBehindSize(group, topic, queueId, fallBehind);</div><div class="line"><span class="number">121</span>:                     &#125;</div><div class="line"><span class="number">122</span>:                     <span class="comment">// è®¡ç®—ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·</span></div><div class="line"><span class="number">123</span>:                     nextBeginOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);</div><div class="line"><span class="number">124</span>:                     <span class="comment">// æ ¹æ®å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°ä¸å†…å­˜åˆ¤æ–­æ˜¯å¦å»ºè®®è¯»å–ä»èŠ‚ç‚¹</span></div><div class="line"><span class="number">125</span>:                     <span class="keyword">long</span> diff = maxOffsetPy - maxPhyOffsetPulling;</div><div class="line"><span class="number">126</span>:                     <span class="keyword">long</span> memory = (<span class="keyword">long</span>) (StoreUtil.TOTAL_PHYSICAL_MEMORY_SIZE</div><div class="line"><span class="number">127</span>:                             * (<span class="keyword">this</span>.messageStoreConfig.getAccessMessageInMemoryMaxRatio() / <span class="number">100.0</span>));</div><div class="line"><span class="number">128</span>:                     getResult.setSuggestPullingFromSlave(diff &gt; memory);</div><div class="line"><span class="number">129</span>:                 &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">130</span>:                     bufferConsumeQueue.release();</div><div class="line"><span class="number">131</span>:                 &#125;</div><div class="line"><span class="number">132</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">133</span>:                 status = GetMessageStatus.OFFSET_FOUND_NULL;</div><div class="line"><span class="number">134</span>:                 nextBeginOffset = nextOffsetCorrection(offset, consumeQueue.rollNextFile(offset));</div><div class="line"><span class="number">135</span>:                 log.warn(<span class="string">"consumer request topic: "</span> + topic + <span class="string">"offset: "</span> + offset + <span class="string">" minOffset: "</span> + minOffset + <span class="string">" maxOffset: "</span></div><div class="line"><span class="number">136</span>:                     + maxOffset + <span class="string">", but access logic queue failed."</span>);</div><div class="line"><span class="number">137</span>:             &#125;</div><div class="line"><span class="number">138</span>:         &#125;</div><div class="line"><span class="number">139</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">140</span>:         status = GetMessageStatus.NO_MATCHED_LOGIC_QUEUE;</div><div class="line"><span class="number">141</span>:         nextBeginOffset = nextOffsetCorrection(offset, <span class="number">0</span>);</div><div class="line"><span class="number">142</span>:     &#125;</div><div class="line"><span class="number">143</span>:     <span class="comment">// ç»Ÿè®¡</span></div><div class="line"><span class="number">144</span>:     <span class="keyword">if</span> (GetMessageStatus.FOUND == status) &#123;</div><div class="line"><span class="number">145</span>:         <span class="keyword">this</span>.storeStatsService.getGetMessageTimesTotalFound().incrementAndGet();</div><div class="line"><span class="number">146</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">147</span>:         <span class="keyword">this</span>.storeStatsService.getGetMessageTimesTotalMiss().incrementAndGet();</div><div class="line"><span class="number">148</span>:     &#125;</div><div class="line"><span class="number">149</span>:     <span class="keyword">long</span> eclipseTime = <span class="keyword">this</span>.getSystemClock().now() - beginTime;</div><div class="line"><span class="number">150</span>:     <span class="keyword">this</span>.storeStatsService.setGetMessageEntireTimeMax(eclipseTime);</div><div class="line"><span class="number">151</span>:     <span class="comment">// è®¾ç½®è¿”å›ç»“æœ</span></div><div class="line"><span class="number">152</span>:     getResult.setStatus(status);</div><div class="line"><span class="number">153</span>:     getResult.setNextBeginOffset(nextBeginOffset);</div><div class="line"><span class="number">154</span>:     getResult.setMaxOffset(maxOffset);</div><div class="line"><span class="number">155</span>:     getResult.setMinOffset(minOffset);</div><div class="line"><span class="number">156</span>:     <span class="keyword">return</span> getResult;</div><div class="line"><span class="number">157</span>: &#125;</div><div class="line"><span class="number">158</span>: </div><div class="line"><span class="number">159</span>: <span class="comment">/**</span></div><div class="line">160:  * æ ¹æ® ä¸»é¢˜ + é˜Ÿåˆ—ç¼–å· è·å– æ¶ˆè´¹é˜Ÿåˆ—</div><div class="line">161:  *</div><div class="line">162:  * <span class="doctag">@param</span> topic ä¸»é¢˜</div><div class="line">163:  * <span class="doctag">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class="line">164:  * <span class="doctag">@return</span> æ¶ˆè´¹é˜Ÿåˆ—</div><div class="line">165:  */</div><div class="line"><span class="number">166</span>: <span class="function"><span class="keyword">public</span> ConsumeQueue <span class="title">findConsumeQueue</span><span class="params">(String topic, <span class="keyword">int</span> queueId)</span> </span>&#123;</div><div class="line"><span class="number">167</span>:     <span class="comment">// è·å– topic å¯¹åº”çš„ æ‰€æœ‰æ¶ˆè´¹é˜Ÿåˆ—</span></div><div class="line"><span class="number">168</span>:     ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; map = consumeQueueTable.get(topic);</div><div class="line"><span class="number">169</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == map) &#123;</div><div class="line"><span class="number">170</span>:         ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; newMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">128</span>);</div><div class="line"><span class="number">171</span>:         ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; oldMap = consumeQueueTable.putIfAbsent(topic, newMap);</div><div class="line"><span class="number">172</span>:         <span class="keyword">if</span> (oldMap != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">173</span>:             map = oldMap;</div><div class="line"><span class="number">174</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">175</span>:             map = newMap;</div><div class="line"><span class="number">176</span>:         &#125;</div><div class="line"><span class="number">177</span>:     &#125;</div><div class="line"><span class="number">178</span>:     <span class="comment">// è·å– queueId å¯¹åº”çš„ æ¶ˆè´¹é˜Ÿåˆ—</span></div><div class="line"><span class="number">179</span>:     ConsumeQueue logic = map.get(queueId);</div><div class="line"><span class="number">180</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == logic) &#123;</div><div class="line"><span class="number">181</span>:         ConsumeQueue newLogic = <span class="keyword">new</span> ConsumeQueue(<span class="comment">//</span></div><div class="line"><span class="number">182</span>:             topic, <span class="comment">//</span></div><div class="line"><span class="number">183</span>:             queueId, <span class="comment">//</span></div><div class="line"><span class="number">184</span>:             StorePathConfigHelper.getStorePathConsumeQueue(<span class="keyword">this</span>.messageStoreConfig.getStorePathRootDir()), <span class="comment">//</span></div><div class="line"><span class="number">185</span>:             <span class="keyword">this</span>.getMessageStoreConfig().getMapedFileSizeConsumeQueue(), <span class="comment">//</span></div><div class="line"><span class="number">186</span>:             <span class="keyword">this</span>);</div><div class="line"><span class="number">187</span>:         ConsumeQueue oldLogic = map.putIfAbsent(queueId, newLogic);</div><div class="line"><span class="number">188</span>:         <span class="keyword">if</span> (oldLogic != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">189</span>:             logic = oldLogic;</div><div class="line"><span class="number">190</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">191</span>:             logic = newLogic;</div><div class="line"><span class="number">192</span>:         &#125;</div><div class="line"><span class="number">193</span>:     &#125;</div><div class="line"><span class="number">194</span>: </div><div class="line"><span class="number">195</span>:     <span class="keyword">return</span> logic;</div><div class="line"><span class="number">196</span>: &#125;</div><div class="line"><span class="number">197</span>: </div><div class="line"><span class="number">198</span>: <span class="comment">/**</span></div><div class="line">199:  * ä¸‹ä¸€ä¸ªè·å–é˜Ÿåˆ—offsetä¿®æ­£</div><div class="line">200:  * ä¿®æ­£æ¡ä»¶ï¼šä¸»èŠ‚ç‚¹ æˆ–è€… ä»èŠ‚ç‚¹å¼€å¯æ ¡éªŒoffsetå¼€å…³</div><div class="line">201:  *</div><div class="line">202:  * <span class="doctag">@param</span> oldOffset è€é˜Ÿåˆ—offset</div><div class="line">203:  * <span class="doctag">@param</span> newOffset æ–°é˜Ÿåˆ—offset</div><div class="line">204:  * <span class="doctag">@return</span> ä¿®æ­£åçš„é˜Ÿåˆ—offset</div><div class="line">205:  */</div><div class="line"><span class="number">206</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">nextOffsetCorrection</span><span class="params">(<span class="keyword">long</span> oldOffset, <span class="keyword">long</span> newOffset)</span> </span>&#123;</div><div class="line"><span class="number">207</span>:     <span class="keyword">long</span> nextOffset = oldOffset;</div><div class="line"><span class="number">208</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE || <span class="keyword">this</span>.getMessageStoreConfig().isOffsetCheckInSlave()) &#123;</div><div class="line"><span class="number">209</span>:         nextOffset = newOffset;</div><div class="line"><span class="number">210</span>:     &#125;</div><div class="line"><span class="number">211</span>:     <span class="keyword">return</span> nextOffset;</div><div class="line"><span class="number">212</span>: &#125;</div><div class="line"><span class="number">213</span>: </div><div class="line"><span class="number">214</span>: <span class="comment">/**</span></div><div class="line">215:  * æ ¡éªŒ commitLog æ˜¯å¦éœ€è¦ç¡¬ç›˜ï¼Œæ— æ³•å…¨éƒ¨æ”¾åœ¨å†…å­˜</div><div class="line">216:  *</div><div class="line">217:  * <span class="doctag">@param</span> offsetPy commitLog æŒ‡å®šoffset</div><div class="line">218:  * <span class="doctag">@param</span> maxOffsetPy commitLog æœ€å¤§offset</div><div class="line">219:  * <span class="doctag">@return</span> æ˜¯å¦éœ€è¦ç¡¬ç›˜</div><div class="line">220:  */</div><div class="line"><span class="number">221</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkInDiskByCommitOffset</span><span class="params">(<span class="keyword">long</span> offsetPy, <span class="keyword">long</span> maxOffsetPy)</span> </span>&#123;</div><div class="line"><span class="number">222</span>:     <span class="keyword">long</span> memory = (<span class="keyword">long</span>) (StoreUtil.TOTAL_PHYSICAL_MEMORY_SIZE * (<span class="keyword">this</span>.messageStoreConfig.getAccessMessageInMemoryMaxRatio() / <span class="number">100.0</span>));</div><div class="line"><span class="number">223</span>:     <span class="keyword">return</span> (maxOffsetPy - offsetPy) &gt; memory;</div><div class="line"><span class="number">224</span>: &#125;</div><div class="line"><span class="number">225</span>: </div><div class="line"><span class="number">226</span>: <span class="comment">/**</span></div><div class="line">227:  * åˆ¤æ–­è·å–æ¶ˆæ¯æ˜¯å¦å·²ç»æ»¡</div><div class="line">228:  *</div><div class="line">229:  * <span class="doctag">@param</span> sizePy å­—èŠ‚æ•°</div><div class="line">230:  * <span class="doctag">@param</span> maxMsgNums æœ€å¤§æ¶ˆæ¯æ•°</div><div class="line">231:  * <span class="doctag">@param</span> bufferTotal ç›®å‰å·²ç»è®¡ç®—å­—èŠ‚æ•°</div><div class="line">232:  * <span class="doctag">@param</span> messageTotal ç›®å‰å·²ç»è®¡ç®—æ¶ˆæ¯æ•°</div><div class="line">233:  * <span class="doctag">@param</span> isInDisk æ˜¯å¦åœ¨ç¡¬ç›˜ä¸­</div><div class="line">234:  * <span class="doctag">@return</span> æ˜¯å¦å·²æ»¡</div><div class="line">235:  */</div><div class="line"><span class="number">236</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isTheBatchFull</span><span class="params">(<span class="keyword">int</span> sizePy, <span class="keyword">int</span> maxMsgNums, <span class="keyword">int</span> bufferTotal, <span class="keyword">int</span> messageTotal, <span class="keyword">boolean</span> isInDisk)</span> </span>&#123;</div><div class="line"><span class="number">237</span>:     <span class="keyword">if</span> (<span class="number">0</span> == bufferTotal || <span class="number">0</span> == messageTotal) &#123;</div><div class="line"><span class="number">238</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">239</span>:     &#125;</div><div class="line"><span class="number">240</span>:     <span class="comment">// æ¶ˆæ¯æ•°é‡å·²ç»æ»¡è¶³è¯·æ±‚æ•°é‡(maxMsgNums)</span></div><div class="line"><span class="number">241</span>:     <span class="keyword">if</span> ((messageTotal + <span class="number">1</span>) &gt;= maxMsgNums) &#123;</div><div class="line"><span class="number">242</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">243</span>:     &#125;</div><div class="line"><span class="number">244</span>:     <span class="comment">// æ ¹æ®æ¶ˆæ¯å­˜å‚¨é…ç½®çš„æœ€å¤§ä¼ è¾“å­—èŠ‚æ•°ã€æœ€å¤§ä¼ è¾“æ¶ˆæ¯æ•°æ˜¯å¦å·²æ»¡</span></div><div class="line"><span class="number">245</span>:     <span class="keyword">if</span> (isInDisk) &#123;</div><div class="line"><span class="number">246</span>:         <span class="keyword">if</span> ((bufferTotal + sizePy) &gt; <span class="keyword">this</span>.messageStoreConfig.getMaxTransferBytesOnMessageInDisk()) &#123;</div><div class="line"><span class="number">247</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">248</span>:         &#125;</div><div class="line"><span class="number">249</span>: </div><div class="line"><span class="number">250</span>:         <span class="keyword">if</span> ((messageTotal + <span class="number">1</span>) &gt; <span class="keyword">this</span>.messageStoreConfig.getMaxTransferCountOnMessageInDisk()) &#123;</div><div class="line"><span class="number">251</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">252</span>:         &#125;</div><div class="line"><span class="number">253</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">254</span>:         <span class="keyword">if</span> ((bufferTotal + sizePy) &gt; <span class="keyword">this</span>.messageStoreConfig.getMaxTransferBytesOnMessageInMemory()) &#123;</div><div class="line"><span class="number">255</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">256</span>:         &#125;</div><div class="line"><span class="number">257</span>: </div><div class="line"><span class="number">258</span>:         <span class="keyword">if</span> ((messageTotal + <span class="number">1</span>) &gt; <span class="keyword">this</span>.messageStoreConfig.getMaxTransferCountOnMessageInMemory()) &#123;</div><div class="line"><span class="number">259</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">260</span>:         &#125;</div><div class="line"><span class="number">261</span>:     &#125;</div><div class="line"><span class="number">262</span>: </div><div class="line"><span class="number">263</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">264</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šæ ¹æ® æ¶ˆæ¯åˆ†ç»„(<code>group</code>) + ä¸»é¢˜(<code>Topic</code>) + é˜Ÿåˆ—ç¼–å·(<code>queueId</code>) + é˜Ÿåˆ—ä½ç½®(<code>offset</code>) + è®¢é˜…ä¿¡æ¯(<code>subscriptionData</code>) è·å– æŒ‡å®šæ¡æ•°(<code>maxMsgNums</code>) æ¶ˆæ¯(<code>Message</code>)ã€‚</li>
<li>ç¬¬ 14 è‡³ 18 è¡Œ ï¼šåˆ¤æ–­ <code>Store</code> æ˜¯å¦å¤„äºå…³é—­çŠ¶æ€ï¼Œè‹¥å…³é—­ï¼Œåˆ™æ— æ³•è·å–æ¶ˆæ¯ã€‚</li>
<li>ç¬¬ 19 è‡³ 23 è¡Œ ï¼šåˆ¤æ–­å½“å‰è¿è¡ŒçŠ¶æ€æ˜¯å¦å¯è¯»ï¼Œè‹¥ä¸å¯è¯»ï¼Œåˆ™æ— æ³•è·å–æ¶ˆæ¯ã€‚</li>
<li>ç¬¬ 37 è¡Œ ï¼šæ ¹æ® ä¸»é¢˜(<code>Topic</code>) + é˜Ÿåˆ—ç¼–å·(<code>queueId</code>) è·å– æ¶ˆæ¯é˜Ÿåˆ—(<code>ConsumeQueue</code>)ã€‚
<ul>
<li><code>#findConsumeQueue(...)</code> ï¼šç¬¬ 159 è‡³ 196 è¡Œã€‚</li>
</ul>
</li>
<li>ç¬¬ 43 è‡³ 58 è¡Œ ï¼šå„ç§é˜Ÿåˆ—ä½ç½®(<code>offset</code>) æ— æ³•è¯»å–æ¶ˆæ¯ï¼Œå¹¶é’ˆå¯¹å¯¹åº”çš„æƒ…å†µï¼Œè®¡ç®—ä¸‹ä¸€æ¬¡ <code>Client</code> é˜Ÿåˆ—æ‹‰å–ä½ç½®ã€‚
<ul>
<li>ç¬¬ 43 è‡³ 45 è¡Œ ï¼šæ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯ã€‚</li>
<li>ç¬¬ 46 è‡³ 48 è¡Œ ï¼šæŸ¥è¯¢çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ<code>offset</code>ï¼‰ å¤ªå°ã€‚</li>
<li>ç¬¬ 49 è‡³ 51 è¡Œ ï¼šæŸ¥è¯¢çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ<code>offset</code>ï¼‰ æ°å¥½ç­‰äº æ¶ˆæ¯é˜Ÿåˆ—æœ€å¤§çš„é˜Ÿåˆ—ä½ç½®ã€‚è¯¥æƒ…å†µæ˜¯æ­£å¸¸ç°è±¡ï¼Œç›¸å½“äºæŸ¥è¯¢æœ€æ–°çš„æ¶ˆæ¯ã€‚</li>
<li>ç¬¬ 52 è‡³ 58 è¡Œ ï¼šæŸ¥è¯¢çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ<code>offset</code>ï¼‰ è¶…è¿‡è¿‡å¤šã€‚</li>
<li><code>#nextOffsetCorrection(...)</code> ï¼šç¬¬ 198 è‡³ 212 è¡Œã€‚</li>
</ul>
</li>
<li>ç¬¬ 61 è¡Œ ï¼šæ ¹æ® æ¶ˆè´¹é˜Ÿåˆ—ä½ç½®(<code>offset</code>) è·å– å¯¹åº”çš„<code>MappedFile</code>ã€‚</li>
<li>ç¬¬ 72 è‡³ 128 è¡Œ ï¼š<strong>å¾ªç¯</strong>è·å– <code>æ¶ˆæ¯ä½ç½®ä¿¡æ¯</code>ã€‚
<ul>
<li>ç¬¬ 74 è‡³ 76 è¡Œ ï¼šè¯»å–æ¯ä¸€ä¸ª <code>æ¶ˆæ¯ä½ç½®ä¿¡æ¯</code>ã€‚</li>
<li>ç¬¬ 79 è‡³ 83 è¡Œ ï¼šå½“ <code>offsetPy</code> å°äº <code>nextPhyFileStartOffset</code> æ—¶ï¼Œæ„å‘³ç€å¯¹
åº”çš„ <code>Message</code> å·²ç»ç§»é™¤ï¼Œæ‰€ä»¥ç›´æ¥continueï¼Œç›´åˆ°å¯è¯»å–çš„ <code>Message</code>ã€‚</li>
<li>ç¬¬ 84 è‡³ 90 è¡Œ ï¼šåˆ¤æ–­æ˜¯å¦å·²ç»è·å¾—è¶³å¤Ÿçš„æ¶ˆæ¯ã€‚
<ul>
<li><code>#checkInDiskByCommitOffset(...)</code> ï¼šç¬¬ 214 è‡³ 224 è¡Œã€‚</li>
<li><code>#isTheBatchFull(...)</code> ï¼šç¬¬ 226 è‡³ 264 è¡Œã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 92 è¡Œ ï¼šåˆ¤æ–­æ¶ˆæ¯æ˜¯å¦ç¬¦åˆæ¡ä»¶ã€‚è¯¦ç»†è§£æè§ï¼š<a href="defaultmessagefilterismessagematched">DefaultMessageFilter#isMessageMatched(...)</a>ã€‚</li>
<li>ç¬¬ 94 è¡Œ ï¼šä» <code>CommitLog</code> è·å–å¯¹åº” æ¶ˆæ¯çš„<code>MappedByteBuffer</code>ã€‚</li>
<li>ç¬¬ 95 è‡³ 99 è¡Œ ï¼šè·å– <code>æ¶ˆæ¯MappedByteBuffer</code> æˆåŠŸã€‚</li>
<li>ç¬¬ 100 è‡³ 106 è¡Œ ï¼šè·å– <code>æ¶ˆæ¯MappedByteBuffer</code> å¤±è´¥ã€‚ä» <code>CommitLog</code> æ— æ³•è¯»å–åˆ°æ¶ˆæ¯ï¼Œè¯´æ˜ è¯¥æ¶ˆæ¯å¯¹åº”çš„æ–‡ä»¶(<code>MappedFile</code>) å·²ç»åˆ é™¤ï¼Œæ­¤æ—¶è®¡ç®—ä¸‹ä¸€ä¸ª<code>MappedFile</code>çš„èµ·å§‹ä½ç½®ã€‚<strong>è¯¥é€»è¾‘éœ€è¦é…åˆï¼ˆç¬¬ 79 è‡³ 83 è¡Œï¼‰ä¸€èµ·ç†è§£ã€‚</strong></li>
<li>ç¬¬ 117 è‡³ 120 è¡Œ ï¼šç»Ÿè®¡å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°ã€‚</li>
<li>ç¬¬ 123 è¡Œ ï¼šè®¡ç®—ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·ã€‚</li>
<li>ç¬¬ 124 è‡³ 128 è¡Œ ï¼šæ ¹æ®å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°ä¸å†…å­˜åˆ¤æ–­æ˜¯å¦å»ºè®®è¯»å–ä»èŠ‚ç‚¹ã€‚</li>
<li>ç¬¬ 130 è¡Œ ï¼šé‡Šæ”¾ <code>bufferConsumeQueue</code> å¯¹ <code>MappedFile</code> çš„æŒ‡å‘ã€‚æ­¤å¤„ <code>MappedFile</code> æ˜¯ <code>ConsumeQueue</code> é‡Œçš„æ–‡ä»¶ï¼Œä¸æ˜¯ <code>CommitLog</code> ä¸‹çš„æ–‡ä»¶ã€‚</li>
<li>ç¬¬ 133 è‡³ 136 è¡Œ ï¼šè·å¾—æ¶ˆè´¹é˜Ÿåˆ—ä½ç½®(<code>offset</code>) è·å– å¯¹åº”çš„<code>MappedFile</code> ä¸º<strong>ç©º</strong>ï¼Œè®¡ç®—<code>ConsumeQueue</code> ä» <code>offset</code> å¼€å§‹çš„ä¸‹ä¸€ä¸ª <code>MappedFile</code> å¯¹åº”çš„ä½ç½®ã€‚</li>
<li>ç¬¬ 143 è‡³ 150 è¡Œ ï¼šè®°å½•ç»Ÿè®¡ä¿¡æ¯ï¼šæ¶ˆè€—æ—¶é—´ã€æ‹‰å–åˆ°æ¶ˆæ¯/æœªæ‹‰å–åˆ°æ¶ˆæ¯æ¬¡æ•°ã€‚</li>
<li>ç¬¬ 151 è‡³ 156 è¡Œ ï¼šè®¾ç½®è¿”å›ç»“æœå¹¶è¿”å›ã€‚</li>
</ul>
<h2>DefaultMessageFilter#isMessageMatched(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultMessageFilter</span> <span class="keyword">implements</span> <span class="title">MessageFilter</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">4</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isMessageMatched</span><span class="params">(SubscriptionData subscriptionData, Long tagsCode)</span> </span>&#123;</div><div class="line"> <span class="number">5</span>:         <span class="comment">// æ¶ˆæ¯tagsCode ç©º</span></div><div class="line"> <span class="number">6</span>:         <span class="keyword">if</span> (tagsCode == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">7</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"> <span class="number">8</span>:         &#125;</div><div class="line"> <span class="number">9</span>:         <span class="comment">// è®¢é˜…æ•°æ® ç©º</span></div><div class="line"><span class="number">10</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == subscriptionData) &#123;</div><div class="line"><span class="number">11</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">12</span>:         &#125;</div><div class="line"><span class="number">13</span>:         <span class="comment">// classFilter</span></div><div class="line"><span class="number">14</span>:         <span class="keyword">if</span> (subscriptionData.isClassFilterMode())</div><div class="line"><span class="number">15</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">16</span>:         <span class="comment">// è®¢é˜…è¡¨è¾¾å¼ å…¨åŒ¹é…</span></div><div class="line"><span class="number">17</span>:         <span class="keyword">if</span> (subscriptionData.getSubString().equals(SubscriptionData.SUB_ALL)) &#123;</div><div class="line"><span class="number">18</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">19</span>:         &#125;</div><div class="line"><span class="number">20</span>:         <span class="comment">// è®¢é˜…æ•°æ®codeæ•°ç»„ æ˜¯å¦åŒ…å« æ¶ˆæ¯tagsCode</span></div><div class="line"><span class="number">21</span>:         <span class="keyword">return</span> subscriptionData.getCodeSet().contains(tagsCode.intValue());</div><div class="line"><span class="number">22</span>:     &#125;</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šæ¶ˆæ¯è¿‡æ»¤å™¨é»˜è®¤å®ç°ã€‚</li>
</ul>
<h2>PullRequestHoldService</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PullRequestHoldService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>&#123;</div><div class="line">  <span class="number">2</span>: </div><div class="line">  <span class="number">3</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);</div><div class="line">  <span class="number">4</span>: </div><div class="line">  <span class="number">5</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOPIC_QUEUEID_SEPARATOR = <span class="string">"@"</span>;</div><div class="line">  <span class="number">6</span>: </div><div class="line">  <span class="number">7</span>:     <span class="keyword">private</span> <span class="keyword">final</span> BrokerController brokerController;</div><div class="line">  <span class="number">8</span>: </div><div class="line">  <span class="number">9</span>:     <span class="keyword">private</span> <span class="keyword">final</span> SystemClock systemClock = <span class="keyword">new</span> SystemClock();</div><div class="line"> <span class="number">10</span>:     <span class="comment">/**</span></div><div class="line"> 11:      * æ¶ˆæ¯è¿‡æ»¤å™¨</div><div class="line"> 12:      */</div><div class="line"> <span class="number">13</span>:     <span class="keyword">private</span> <span class="keyword">final</span> MessageFilter messageFilter = <span class="keyword">new</span> DefaultMessageFilter();</div><div class="line"> <span class="number">14</span>:     <span class="comment">/**</span></div><div class="line"> 15:      * æ‹‰å–æ¶ˆæ¯è¯·æ±‚é›†åˆ</div><div class="line"> 16:      */</div><div class="line"> <span class="number">17</span>:     <span class="keyword">private</span> ConcurrentHashMap&lt;String<span class="comment">/* topic@queueId */</span>, ManyPullRequest&gt; pullRequestTable =</div><div class="line"> <span class="number">18</span>:             <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">1024</span>);</div><div class="line"> <span class="number">19</span>: </div><div class="line"> <span class="number">20</span>:     <span class="function"><span class="keyword">public</span> <span class="title">PullRequestHoldService</span><span class="params">(<span class="keyword">final</span> BrokerController brokerController)</span> </span>&#123;</div><div class="line"> <span class="number">21</span>:         <span class="keyword">this</span>.brokerController = brokerController;</div><div class="line"> <span class="number">22</span>:     &#125;</div><div class="line"> <span class="number">23</span>: </div><div class="line"> <span class="number">24</span>:     <span class="comment">/**</span></div><div class="line"> 25:      * æ·»åŠ æ‹‰å–æ¶ˆæ¯æŒ‚èµ·è¯·æ±‚</div><div class="line"> 26:      *</div><div class="line"> 27:      * <span class="doctag">@param</span> topic ä¸»é¢˜</div><div class="line"> 28:      * <span class="doctag">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class="line"> 29:      * <span class="doctag">@param</span> pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class="line"> 30:      */</div><div class="line"> <span class="number">31</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">suspendPullRequest</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class="line"> <span class="number">32</span>:         String key = <span class="keyword">this</span>.buildKey(topic, queueId);</div><div class="line"> <span class="number">33</span>:         ManyPullRequest mpr = <span class="keyword">this</span>.pullRequestTable.get(key);</div><div class="line"> <span class="number">34</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == mpr) &#123;</div><div class="line"> <span class="number">35</span>:             mpr = <span class="keyword">new</span> ManyPullRequest();</div><div class="line"> <span class="number">36</span>:             ManyPullRequest prev = <span class="keyword">this</span>.pullRequestTable.putIfAbsent(key, mpr);</div><div class="line"> <span class="number">37</span>:             <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">38</span>:                 mpr = prev;</div><div class="line"> <span class="number">39</span>:             &#125;</div><div class="line"> <span class="number">40</span>:         &#125;</div><div class="line"> <span class="number">41</span>: </div><div class="line"> <span class="number">42</span>:         mpr.addPullRequest(pullRequest);</div><div class="line"> <span class="number">43</span>:     &#125;</div><div class="line"> <span class="number">44</span>: </div><div class="line"> <span class="number">45</span>:     <span class="comment">/**</span></div><div class="line"> 46:      * æ ¹æ® ä¸»é¢˜ + é˜Ÿåˆ—ç¼–å· åˆ›å»ºå”¯ä¸€æ ‡è¯†</div><div class="line"> 47:      *</div><div class="line"> 48:      * <span class="doctag">@param</span> topic ä¸»é¢˜</div><div class="line"> 49:      * <span class="doctag">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class="line"> 50:      * <span class="doctag">@return</span> key</div><div class="line"> 51:      */</div><div class="line"> <span class="number">52</span>:     <span class="function"><span class="keyword">private</span> String <span class="title">buildKey</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId)</span> </span>&#123;</div><div class="line"> <span class="number">53</span>:         StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line"> <span class="number">54</span>:         sb.append(topic);</div><div class="line"> <span class="number">55</span>:         sb.append(TOPIC_QUEUEID_SEPARATOR);</div><div class="line"> <span class="number">56</span>:         sb.append(queueId);</div><div class="line"> <span class="number">57</span>:         <span class="keyword">return</span> sb.toString();</div><div class="line"> <span class="number">58</span>:     &#125;</div><div class="line"> <span class="number">59</span>: </div><div class="line"> <span class="number">60</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">61</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">62</span>:         log.info(<span class="string">"&#123;&#125; service started"</span>, <span class="keyword">this</span>.getServiceName());</div><div class="line"> <span class="number">63</span>:         <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</div><div class="line"> <span class="number">64</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">65</span>:                 <span class="comment">// æ ¹æ® é•¿è½®è®­ è¿˜æ˜¯ çŸ­è½®è®­ è®¾ç½®ä¸åŒçš„ç­‰å¾…æ—¶é—´</span></div><div class="line"> <span class="number">66</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getBrokerConfig().isLongPollingEnable()) &#123;</div><div class="line"> <span class="number">67</span>:                     <span class="keyword">this</span>.waitForRunning(<span class="number">5</span> * <span class="number">1000</span>);</div><div class="line"> <span class="number">68</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">69</span>:                     <span class="keyword">this</span>.waitForRunning(<span class="keyword">this</span>.brokerController.getBrokerConfig().getShortPollingTimeMills());</div><div class="line"> <span class="number">70</span>:                 &#125;</div><div class="line"> <span class="number">71</span>:                 <span class="comment">// æ£€æŸ¥æŒ‚èµ·è¯·æ±‚æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„</span></div><div class="line"> <span class="number">72</span>:                 <span class="keyword">long</span> beginLockTimestamp = <span class="keyword">this</span>.systemClock.now();</div><div class="line"> <span class="number">73</span>:                 <span class="keyword">this</span>.checkHoldRequest();</div><div class="line"> <span class="number">74</span>:                 <span class="keyword">long</span> costTime = <span class="keyword">this</span>.systemClock.now() - beginLockTimestamp;</div><div class="line"> <span class="number">75</span>:                 <span class="keyword">if</span> (costTime &gt; <span class="number">5</span> * <span class="number">1000</span>) &#123;</div><div class="line"> <span class="number">76</span>:                     log.info(<span class="string">"[NOTIFYME] check hold request cost &#123;&#125; ms."</span>, costTime);</div><div class="line"> <span class="number">77</span>:                 &#125;</div><div class="line"> <span class="number">78</span>:             &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">79</span>:                 log.warn(<span class="keyword">this</span>.getServiceName() + <span class="string">" service has exception. "</span>, e);</div><div class="line"> <span class="number">80</span>:             &#125;</div><div class="line"> <span class="number">81</span>:         &#125;</div><div class="line"> <span class="number">82</span>: </div><div class="line"> <span class="number">83</span>:         log.info(<span class="string">"&#123;&#125; service end"</span>, <span class="keyword">this</span>.getServiceName());</div><div class="line"> <span class="number">84</span>:     &#125;</div><div class="line"> <span class="number">85</span>: </div><div class="line"> <span class="number">86</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">87</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getServiceName</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">88</span>:         <span class="keyword">return</span> PullRequestHoldService.class.getSimpleName();</div><div class="line"> <span class="number">89</span>:     &#125;</div><div class="line"> <span class="number">90</span>: </div><div class="line"> <span class="number">91</span>:     <span class="comment">/**</span></div><div class="line"> 92:      * éå†æŒ‚èµ·è¯·æ±‚ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚ã€‚</div><div class="line"> 93:      */</div><div class="line"> <span class="number">94</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkHoldRequest</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">95</span>:         <span class="keyword">for</span> (String key : <span class="keyword">this</span>.pullRequestTable.keySet()) &#123;</div><div class="line"> <span class="number">96</span>:             String[] kArray = key.split(TOPIC_QUEUEID_SEPARATOR);</div><div class="line"> <span class="number">97</span>:             <span class="keyword">if</span> (<span class="number">2</span> == kArray.length) &#123;</div><div class="line"> <span class="number">98</span>:                 String topic = kArray[<span class="number">0</span>];</div><div class="line"> <span class="number">99</span>:                 <span class="keyword">int</span> queueId = Integer.parseInt(kArray[<span class="number">1</span>]);</div><div class="line"><span class="number">100</span>:                 <span class="keyword">final</span> <span class="keyword">long</span> offset = <span class="keyword">this</span>.brokerController.getMessageStore().getMaxOffsetInQuque(topic, queueId);</div><div class="line"><span class="number">101</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">102</span>:                     <span class="keyword">this</span>.notifyMessageArriving(topic, queueId, offset);</div><div class="line"><span class="number">103</span>:                 &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">104</span>:                     log.error(<span class="string">"check hold request failed. topic=&#123;&#125;, queueId=&#123;&#125;"</span>, topic, queueId, e);</div><div class="line"><span class="number">105</span>:                 &#125;</div><div class="line"><span class="number">106</span>:             &#125;</div><div class="line"><span class="number">107</span>:         &#125;</div><div class="line"><span class="number">108</span>:     &#125;</div><div class="line"><span class="number">109</span>: </div><div class="line"><span class="number">110</span>:     <span class="comment">/**</span></div><div class="line">111:      * æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚</div><div class="line">112:      *</div><div class="line">113:      * <span class="doctag">@param</span> topic ä¸»é¢˜</div><div class="line">114:      * <span class="doctag">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class="line">115:      * <span class="doctag">@param</span> maxOffset æ¶ˆè´¹é˜Ÿåˆ—æœ€å¤§offset</div><div class="line">116:      */</div><div class="line"><span class="number">117</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyMessageArriving</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> maxOffset)</span> </span>&#123;</div><div class="line"><span class="number">118</span>:         notifyMessageArriving(topic, queueId, maxOffset, <span class="keyword">null</span>);</div><div class="line"><span class="number">119</span>:     &#125;</div><div class="line"><span class="number">120</span>: </div><div class="line"><span class="number">121</span>:     <span class="comment">/**</span></div><div class="line">122:      * æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚</div><div class="line">123:      *</div><div class="line">124:      * <span class="doctag">@param</span> topic ä¸»é¢˜</div><div class="line">125:      * <span class="doctag">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class="line">126:      * <span class="doctag">@param</span> maxOffset æ¶ˆè´¹é˜Ÿåˆ—æœ€å¤§offset</div><div class="line">127:      * <span class="doctag">@param</span> tagsCode è¿‡æ»¤tagsCode</div><div class="line">128:      */</div><div class="line"><span class="number">129</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyMessageArriving</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> maxOffset, <span class="keyword">final</span> Long tagsCode)</span> </span>&#123;</div><div class="line"><span class="number">130</span>:         String key = <span class="keyword">this</span>.buildKey(topic, queueId);</div><div class="line"><span class="number">131</span>:         ManyPullRequest mpr = <span class="keyword">this</span>.pullRequestTable.get(key);</div><div class="line"><span class="number">132</span>:         <span class="keyword">if</span> (mpr != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">133</span>:             <span class="comment">//</span></div><div class="line"><span class="number">134</span>:             List&lt;PullRequest&gt; requestList = mpr.cloneListAndClear();</div><div class="line"><span class="number">135</span>:             <span class="keyword">if</span> (requestList != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">136</span>:                 List&lt;PullRequest&gt; replayList = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// ä¸ç¬¦åˆå”¤é†’çš„è¯·æ±‚æ•°ç»„</span></div><div class="line"><span class="number">137</span>: </div><div class="line"><span class="number">138</span>:                 <span class="keyword">for</span> (PullRequest request : requestList) &#123;</div><div class="line"><span class="number">139</span>:                     <span class="comment">// å¦‚æœ maxOffset è¿‡å°ï¼Œåˆ™é‡æ–°è¯»å–ä¸€æ¬¡ã€‚</span></div><div class="line"><span class="number">140</span>:                     <span class="keyword">long</span> newestOffset = maxOffset;</div><div class="line"><span class="number">141</span>:                     <span class="keyword">if</span> (newestOffset &lt;= request.getPullFromThisOffset()) &#123;</div><div class="line"><span class="number">142</span>:                         newestOffset = <span class="keyword">this</span>.brokerController.getMessageStore().getMaxOffsetInQuque(topic, queueId);</div><div class="line"><span class="number">143</span>:                     &#125;</div><div class="line"><span class="number">144</span>:                     <span class="comment">// æœ‰æ–°çš„åŒ¹é…æ¶ˆæ¯ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚</span></div><div class="line"><span class="number">145</span>:                     <span class="keyword">if</span> (newestOffset &gt; request.getPullFromThisOffset()) &#123;</div><div class="line"><span class="number">146</span>:                         <span class="keyword">if</span> (<span class="keyword">this</span>.messageFilter.isMessageMatched(request.getSubscriptionData(), tagsCode)) &#123;</div><div class="line"><span class="number">147</span>:                             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">148</span>:                                 <span class="keyword">this</span>.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(),</div><div class="line"><span class="number">149</span>:                                     request.getRequestCommand());</div><div class="line"><span class="number">150</span>:                             &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">151</span>:                                 log.error(<span class="string">"execute request when wakeup failed."</span>, e);</div><div class="line"><span class="number">152</span>:                             &#125;</div><div class="line"><span class="number">153</span>:                             <span class="keyword">continue</span>;</div><div class="line"><span class="number">154</span>:                         &#125;</div><div class="line"><span class="number">155</span>:                     &#125;</div><div class="line"><span class="number">156</span>:                     <span class="comment">// è¶…è¿‡æŒ‚èµ·æ—¶é—´ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚</span></div><div class="line"><span class="number">157</span>:                     <span class="keyword">if</span> (System.currentTimeMillis() &gt;= (request.getSuspendTimestamp() + request.getTimeoutMillis())) &#123;</div><div class="line"><span class="number">158</span>:                         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">159</span>:                             <span class="keyword">this</span>.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(),</div><div class="line"><span class="number">160</span>:                                 request.getRequestCommand());</div><div class="line"><span class="number">161</span>:                         &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">162</span>:                             log.error(<span class="string">"execute request when wakeup failed."</span>, e);</div><div class="line"><span class="number">163</span>:                         &#125;</div><div class="line"><span class="number">164</span>:                         <span class="keyword">continue</span>;</div><div class="line"><span class="number">165</span>:                     &#125;</div><div class="line"><span class="number">166</span>:                     <span class="comment">// ä¸ç¬¦åˆå†æ¬¡æ‹‰å–çš„è¯·æ±‚ï¼Œå†æ¬¡æ·»åŠ å›å»</span></div><div class="line"><span class="number">167</span>:                     replayList.add(request);</div><div class="line"><span class="number">168</span>:                 &#125;</div><div class="line"><span class="number">169</span>:                 <span class="comment">// æ·»åŠ å›å»</span></div><div class="line"><span class="number">170</span>:                 <span class="keyword">if</span> (!replayList.isEmpty()) &#123;</div><div class="line"><span class="number">171</span>:                     mpr.addPullRequest(replayList);</div><div class="line"><span class="number">172</span>:                 &#125;</div><div class="line"><span class="number">173</span>:             &#125;</div><div class="line"><span class="number">174</span>:         &#125;</div><div class="line"><span class="number">175</span>:     &#125;</div><div class="line"><span class="number">176</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>PullRequestHoldService</code> è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯è¯·æ±‚æŒ‚èµ·ç»´æŠ¤çº¿ç¨‹æœåŠ¡ã€‚
<ul>
<li>å½“æ‹‰å–æ¶ˆæ¯è¯·æ±‚è·å¾—ä¸äº†æ¶ˆæ¯æ—¶ï¼Œåˆ™ä¼šå°†è¯·æ±‚è¿›è¡ŒæŒ‚èµ·ï¼Œæ·»åŠ åˆ°è¯¥æœåŠ¡ã€‚</li>
<li>å½“æœ‰ç¬¦åˆæ¡ä»¶ä¿¡æ¯æ—¶ æˆ– æŒ‚èµ·è¶…æ—¶æ—¶ï¼Œé‡æ–°æ‰§è¡Œè·å–æ¶ˆæ¯é€»è¾‘ã€‚</li>
</ul>
</li>
<li><code>#suspendPullRequest(...)</code> è¯´æ˜ ï¼šæ·»åŠ æ‹‰å–æ¶ˆæ¯æŒ‚èµ·è¯·æ±‚åˆ°é›†åˆ( <code>pullRequestTable</code> )ã€‚</li>
<li><code>#run(...)</code> è¯´æ˜ ï¼š<strong>å®šæ—¶</strong>æ£€æŸ¥æŒ‚èµ·è¯·æ±‚æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥é‡æ–°æ‹‰å–æ¶ˆæ¯å¹¶è¿›è¡Œé€šçŸ¥ã€‚
<ul>
<li>ç¬¬ 65 è‡³ 70 è¡Œ ï¼šæ ¹æ®<code>é•¿è½®è®­</code>or<code>çŸ­è½®è®­</code>è®¾ç½®ä¸åŒçš„ç­‰å¾…æ—¶é—´ã€‚</li>
<li>ç¬¬ 71 è‡³ 77 è¡Œ ï¼šæ£€æŸ¥æŒ‚èµ·è¯·æ±‚æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„ã€‚</li>
</ul>
</li>
<li><code>#checkHoldRequest(...)</code> è¯´æ˜ ï¼šéå†æŒ‚èµ·è¯·æ±‚ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„ã€‚</li>
<li><code>#notifyMessageArriving(...)</code> è¯´æ˜ ï¼šæ£€æŸ¥<strong>æŒ‡å®šé˜Ÿåˆ—</strong>æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚ã€‚
<ul>
<li>ç¬¬ 139 è‡³ 143 è¡Œ ï¼šå¦‚æœ <code>maxOffset</code> è¿‡å°ï¼Œé‡æ–°è·å–ä¸€æ¬¡æœ€æ–°çš„ã€‚</li>
<li>ç¬¬ 144 è‡³ 155 è¡Œ ï¼šæœ‰æ–°çš„åŒ¹é…æ¶ˆæ¯ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚</li>
<li>ç¬¬ 156 è‡³ 165 è¡Œ ï¼šè¶…è¿‡æŒ‚èµ·æ—¶é—´ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚</li>
<li>ç¬¬ 148 || 159 è¡Œ ï¼šå”¤é†’è¯·æ±‚ï¼Œå†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚åŸå…ˆæ‹…å¿ƒæ‹‰å–æ¶ˆæ¯æ—¶é—´è¿‡é•¿ï¼Œå¯¼è‡´å½±å“æ•´ä¸ªæŒ‚èµ·è¯·æ±‚çš„éå†ï¼Œåé¢æŸ¥çœ‹<code>#executeRequestWhenWakeup(...)</code>ï¼Œå®é™…æ˜¯ä¸¢åˆ°çº¿ç¨‹æ± è¿›è¡Œä¸€æ­¥çš„æ¶ˆæ¯æ‹‰å–ï¼Œä¸ä¼šæœ‰æ€§èƒ½ä¸Šçš„é—®é¢˜ã€‚è¯¦ç»†è§£æè§ï¼š<a href="pullmessageprocessorexecuterequestwhenwakeup">PullMessageProcessor#executeRequestWhenWakeup(...)</a>ã€‚</li>
<li>ç¬¬ 166 è‡³ 172 è¡Œ ï¼šä¸ç¬¦åˆå”¤é†’çš„è¯·æ±‚é‡æ–°æ·»åŠ åˆ°é›†åˆ(<code>pullRequestTable</code>)ã€‚</li>
</ul>
</li>
</ul>
<h2>PullMessageProcessor#executeRequestWhenWakeup(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeRequestWhenWakeup</span><span class="params">(<span class="keyword">final</span> Channel channel, <span class="keyword">final</span> RemotingCommand request)</span> <span class="keyword">throws</span> RemotingCommandException </span>&#123;</div><div class="line"> <span class="number">2</span>:     Runnable run = <span class="keyword">new</span> Runnable() &#123;</div><div class="line"> <span class="number">3</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">4</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">5</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>:                 <span class="comment">// è°ƒç”¨æ‹‰å–è¯·æ±‚ã€‚æœ¬æ¬¡è°ƒç”¨ï¼Œè®¾ç½®ä¸æŒ‚èµ·è¯·æ±‚ã€‚</span></div><div class="line"> <span class="number">7</span>:                 <span class="keyword">final</span> RemotingCommand response = PullMessageProcessor.<span class="keyword">this</span>.processRequest(channel, request, <span class="keyword">false</span>);</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:                 <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">10</span>:                     response.setOpaque(request.getOpaque());</div><div class="line"><span class="number">11</span>:                     response.markResponseType();</div><div class="line"><span class="number">12</span>:                     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">13</span>:                         channel.writeAndFlush(response).addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</div><div class="line"><span class="number">14</span>:                             <span class="meta">@Override</span></div><div class="line"><span class="number">15</span>:                             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"><span class="number">16</span>:                                 <span class="keyword">if</span> (!future.isSuccess()) &#123;</div><div class="line"><span class="number">17</span>:                                     LOG.error(<span class="string">"ProcessRequestWrapper response to &#123;&#125; failed"</span>, future.channel().remoteAddress(), future.cause());</div><div class="line"><span class="number">18</span>:                                     LOG.error(request.toString());</div><div class="line"><span class="number">19</span>:                                     LOG.error(response.toString());</div><div class="line"><span class="number">20</span>:                                 &#125;</div><div class="line"><span class="number">21</span>:                             &#125;</div><div class="line"><span class="number">22</span>:                         &#125;);</div><div class="line"><span class="number">23</span>:                     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">24</span>:                         LOG.error(<span class="string">"ProcessRequestWrapper process request over, but response failed"</span>, e);</div><div class="line"><span class="number">25</span>:                         LOG.error(request.toString());</div><div class="line"><span class="number">26</span>:                         LOG.error(response.toString());</div><div class="line"><span class="number">27</span>:                     &#125;</div><div class="line"><span class="number">28</span>:                 &#125;</div><div class="line"><span class="number">29</span>:             &#125; <span class="keyword">catch</span> (RemotingCommandException e1) &#123;</div><div class="line"><span class="number">30</span>:                 LOG.error(<span class="string">"ExecuteRequestWhenWakeup run"</span>, e1);</div><div class="line"><span class="number">31</span>:             &#125;</div><div class="line"><span class="number">32</span>:         &#125;</div><div class="line"><span class="number">33</span>:     &#125;;</div><div class="line"><span class="number">34</span>:     <span class="comment">// æäº¤æ‹‰å–è¯·æ±‚åˆ°çº¿ç¨‹æ± </span></div><div class="line"><span class="number">35</span>:     <span class="keyword">this</span>.brokerController.getPullMessageExecutor().submit(<span class="keyword">new</span> RequestTask(run, channel, request));</div><div class="line"><span class="number">36</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šæ‰§è¡Œè¯·æ±‚å”¤é†’ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚è¯¥æ–¹æ³•è°ƒç”¨çº¿ç¨‹æ± ï¼Œå› æ­¤ï¼Œä¸ä¼šé˜»å¡ã€‚</li>
<li>ç¬¬ 7 è¡Œ ï¼šè°ƒç”¨æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚æœ¬æ¬¡è°ƒç”¨ï¼Œè®¾ç½®å³ä½¿è¯·æ±‚ä¸åˆ°æ¶ˆæ¯ï¼Œä¹Ÿä¸æŒ‚èµ·è¯·æ±‚ã€‚å¦‚æœä¸è®¾ç½®ï¼Œè¯·æ±‚å¯èƒ½è¢«æ— é™æŒ‚èµ·ï¼Œè¢« <code>Broker</code> æ— é™å¾ªç¯ã€‚</li>
<li>ç¬¬ 35 è¡Œ ï¼š<strong>æäº¤æ‹‰å–æ¶ˆæ¯è¯·æ±‚åˆ°çº¿ç¨‹æ± </strong>ã€‚</li>
</ul>
<h1>5ã€Broker æä¾›[æ›´æ–°æ¶ˆè´¹è¿›åº¦]æ¥å£</h1>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">Yunai-MacdeMacBook-Pro-2:config yunai$ <span class="built_in">pwd</span></div><div class="line">/Users/yunai/store/config</div><div class="line">Yunai-MacdeMacBook-Pro-2:config yunai$ ls -ls</div><div class="line">total 40</div><div class="line">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 consumerOffset.json</div><div class="line">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 consumerOffset.json.bak</div><div class="line">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 delayOffset.json</div><div class="line">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 delayOffset.json.bak</div><div class="line">8 -rw-r--r--  1 yunai  staff  1401  4 27 21:51 topics.json</div><div class="line">Yunai-MacdeMacBook-Pro-2:config yunai$ cat consumerOffset.json</div><div class="line">&#123;</div><div class="line">	<span class="string">"offsetTable"</span>:&#123;</div><div class="line">		<span class="string">"%RETRY%please_rename_unique_group_name_4@please_rename_unique_group_name_4"</span>:&#123;0:0</div><div class="line">		&#125;,</div><div class="line">		<span class="string">"TopicRead3@please_rename_unique_group_name_4"</span>:&#123;1:5</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>consumerOffset.json</code> ï¼šæ¶ˆè´¹è¿›åº¦å­˜å‚¨æ–‡ä»¶ã€‚</li>
<li><code>consumerOffset.json.bak</code> ï¼šæ¶ˆè´¹è¿›åº¦å­˜å‚¨æ–‡ä»¶å¤‡ä»½ã€‚</li>
<li>æ¯æ¬¡å†™å…¥ <code>consumerOffset.json</code>ï¼Œå°†åŸå†…å®¹å¤‡ä»½åˆ° <code>consumerOffset.json.bak</code>ã€‚å®ç°è§ï¼š<a href="mixallstring2file">MixAll#string2File(...)</a>ã€‚</li>
</ul>
<h2>BrokerController#initialize(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>:<span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"> <span class="number">2</span>:    <span class="meta">@Override</span></div><div class="line"> <span class="number">3</span>:    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">4</span>:        <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">5</span>:            BrokerController.<span class="keyword">this</span>.consumerOffsetManager.persist();</div><div class="line"> <span class="number">6</span>:        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">7</span>:            log.error(<span class="string">"schedule persist consumerOffset error."</span>, e);</div><div class="line"> <span class="number">8</span>:        &#125;</div><div class="line"> <span class="number">9</span>:    &#125;</div><div class="line"><span class="number">10</span>:&#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="keyword">this</span>.brokerConfig.getFlushConsumerOffsetInterval(), TimeUnit.MILLISECONDS);</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šæ¯ 5s æ‰§è¡Œä¸€æ¬¡æŒä¹…åŒ–é€»è¾‘ã€‚</li>
</ul>
<h2>ConfigManager</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigManager</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger PLOG = LoggerFactory.getLogger(LoggerName.COMMON_LOGGER_NAME);</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>: <span class="comment">/**</span></div><div class="line"> 5:  * ç¼–ç å†…å®¹</div><div class="line"> 6:  * <span class="doctag">@return</span> ç¼–ç åçš„å†…å®¹</div><div class="line"> 7:  */</div><div class="line"> <span class="number">8</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">encode</span><span class="params">()</span></span>;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>: <span class="comment">/**</span></div><div class="line">11:  * åŠ è½½æ–‡ä»¶</div><div class="line">12:  *</div><div class="line">13:  * <span class="doctag">@return</span> åŠ è½½æ˜¯å¦æˆåŠŸ</div><div class="line">14:  */</div><div class="line"><span class="number">15</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">16</span>:     String fileName = <span class="keyword">null</span>;</div><div class="line"><span class="number">17</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">18</span>:         fileName = <span class="keyword">this</span>.configFilePath();</div><div class="line"><span class="number">19</span>:         String jsonString = MixAll.file2String(fileName);</div><div class="line"><span class="number">20</span>:         <span class="comment">// å¦‚æœå†…å®¹ä¸å­˜åœ¨ï¼Œåˆ™åŠ è½½å¤‡ä»½æ–‡ä»¶</span></div><div class="line"><span class="number">21</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == jsonString || jsonString.length() == <span class="number">0</span>) &#123;</div><div class="line"><span class="number">22</span>:             <span class="keyword">return</span> <span class="keyword">this</span>.loadBak();</div><div class="line"><span class="number">23</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">24</span>:             <span class="keyword">this</span>.decode(jsonString);</div><div class="line"><span class="number">25</span>:             PLOG.info(<span class="string">"load &#123;&#125; OK"</span>, fileName);</div><div class="line"><span class="number">26</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">27</span>:         &#125;</div><div class="line"><span class="number">28</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">29</span>:         PLOG.error(<span class="string">"load "</span> + fileName + <span class="string">" Failed, and try to load backup file"</span>, e);</div><div class="line"><span class="number">30</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.loadBak();</div><div class="line"><span class="number">31</span>:     &#125;</div><div class="line"><span class="number">32</span>: &#125;</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>: <span class="comment">/**</span></div><div class="line">35:  * é…ç½®æ–‡ä»¶åœ°å€</div><div class="line">36:  *</div><div class="line">37:  * <span class="doctag">@return</span> é…ç½®æ–‡ä»¶åœ°å€</div><div class="line">38:  */</div><div class="line"><span class="number">39</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">configFilePath</span><span class="params">()</span></span>;</div><div class="line"><span class="number">40</span>: </div><div class="line"><span class="number">41</span>: <span class="comment">/**</span></div><div class="line">42:  * åŠ è½½å¤‡ä»½æ–‡ä»¶</div><div class="line">43:  *</div><div class="line">44:  * <span class="doctag">@return</span> æ˜¯å¦æˆåŠŸ</div><div class="line">45:  */</div><div class="line"><span class="number">46</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">loadBak</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">47</span>:     String fileName = <span class="keyword">null</span>;</div><div class="line"><span class="number">48</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">49</span>:         fileName = <span class="keyword">this</span>.configFilePath();</div><div class="line"><span class="number">50</span>:         String jsonString = MixAll.file2String(fileName + <span class="string">".bak"</span>);</div><div class="line"><span class="number">51</span>:         <span class="keyword">if</span> (jsonString != <span class="keyword">null</span> &amp;&amp; jsonString.length() &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">52</span>:             <span class="keyword">this</span>.decode(jsonString);</div><div class="line"><span class="number">53</span>:             PLOG.info(<span class="string">"load "</span> + fileName + <span class="string">" OK"</span>);</div><div class="line"><span class="number">54</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">55</span>:         &#125;</div><div class="line"><span class="number">56</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">57</span>:         PLOG.error(<span class="string">"load "</span> + fileName + <span class="string">" Failed"</span>, e);</div><div class="line"><span class="number">58</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">59</span>:     &#125;</div><div class="line"><span class="number">60</span>: </div><div class="line"><span class="number">61</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">62</span>: &#125;</div><div class="line"><span class="number">63</span>: </div><div class="line"><span class="number">64</span>: <span class="comment">/**</span></div><div class="line">65:  * è§£ç å†…å®¹</div><div class="line">66:  *</div><div class="line">67:  * <span class="doctag">@param</span> jsonString å†…å®¹</div><div class="line">68:  */</div><div class="line"><span class="number">69</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(<span class="keyword">final</span> String jsonString)</span></span>;</div><div class="line"><span class="number">70</span>: </div><div class="line"><span class="number">71</span>: <span class="comment">/**</span></div><div class="line">72:  * æŒä¹…åŒ–</div><div class="line">73:  */</div><div class="line"><span class="number">74</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">persist</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">75</span>:     String jsonString = <span class="keyword">this</span>.encode(<span class="keyword">true</span>);</div><div class="line"><span class="number">76</span>:     <span class="keyword">if</span> (jsonString != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">77</span>:         String fileName = <span class="keyword">this</span>.configFilePath();</div><div class="line"><span class="number">78</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">79</span>:             MixAll.string2File(jsonString, fileName);</div><div class="line"><span class="number">80</span>:         &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line"><span class="number">81</span>:             PLOG.error(<span class="string">"persist file Exception, "</span> + fileName, e);</div><div class="line"><span class="number">82</span>:         &#125;</div><div class="line"><span class="number">83</span>:     &#125;</div><div class="line"><span class="number">84</span>: &#125;</div><div class="line"><span class="number">85</span>: </div><div class="line"><span class="number">86</span>: <span class="comment">/**</span></div><div class="line">87:  * ç¼–ç å­˜å‚¨å†…å®¹</div><div class="line">88:  *</div><div class="line">89:  * <span class="doctag">@param</span> prettyFormat æ˜¯å¦æ ¼å¼åŒ–</div><div class="line">90:  * <span class="doctag">@return</span> å†…å®¹</div><div class="line">91:  */</div><div class="line"><span class="number">92</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">encode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> prettyFormat)</span></span>;</div><div class="line"><span class="number">93</span>: &#125;</div></pre></td></tr></table></figure></p>
<h3>MixAll#string2File(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * å°†å†…å®¹å†™åˆ°æ–‡ä»¶</div><div class="line"> 3:  * å®‰å…¨å†™</div><div class="line"> 4:  * 1. å†™åˆ°.tmpæ–‡ä»¶</div><div class="line"> 5:  * 2. å¤‡ä»½å‡†å¤‡å†™å…¥æ–‡ä»¶åˆ°.bakæ–‡ä»¶</div><div class="line"> 6:  * 3. åˆ é™¤åŸæ–‡ä»¶ï¼Œå°†.tmpä¿®æ”¹æˆæ–‡ä»¶</div><div class="line"> 7:  *</div><div class="line"> 8:  * <span class="doctag">@param</span> str å†…å®¹</div><div class="line"> 9:  * <span class="doctag">@param</span> fileName æ–‡ä»¶å</div><div class="line">10:  * <span class="doctag">@throws</span> IOException å½“IOå‘ç”Ÿå¼‚å¸¸æ—¶</div><div class="line">11:  */</div><div class="line"><span class="number">12</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">string2File</span><span class="params">(<span class="keyword">final</span> String str, <span class="keyword">final</span> String fileName)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"><span class="number">13</span>:     <span class="comment">// å†™åˆ° tmpæ–‡ä»¶</span></div><div class="line"><span class="number">14</span>:     String tmpFile = fileName + <span class="string">".tmp"</span>;</div><div class="line"><span class="number">15</span>:     string2FileNotSafe(str, tmpFile);</div><div class="line"><span class="number">16</span>:     <span class="comment">//</span></div><div class="line"><span class="number">17</span>:     String bakFile = fileName + <span class="string">".bak"</span>;</div><div class="line"><span class="number">18</span>:     String prevContent = file2String(fileName);</div><div class="line"><span class="number">19</span>:     <span class="keyword">if</span> (prevContent != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">20</span>:         string2FileNotSafe(prevContent, bakFile);</div><div class="line"><span class="number">21</span>:     &#125;</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>:     File file = <span class="keyword">new</span> File(fileName);</div><div class="line"><span class="number">24</span>:     file.delete();</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:     file = <span class="keyword">new</span> File(tmpFile);</div><div class="line"><span class="number">27</span>:     file.renameTo(<span class="keyword">new</span> File(fileName));</div><div class="line"><span class="number">28</span>: &#125;</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>: <span class="comment">/**</span></div><div class="line">31:  * å°†å†…å®¹å†™åˆ°æ–‡ä»¶</div><div class="line">32:  * éå®‰å…¨å†™</div><div class="line">33:  *</div><div class="line">34:  * <span class="doctag">@param</span> str å†…å®¹</div><div class="line">35:  * <span class="doctag">@param</span> fileName æ–‡ä»¶å†…å®¹</div><div class="line">36:  * <span class="doctag">@throws</span> IOException å½“IOå‘ç”Ÿå¼‚å¸¸æ—¶</div><div class="line">37:  */</div><div class="line"><span class="number">38</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">string2FileNotSafe</span><span class="params">(<span class="keyword">final</span> String str, <span class="keyword">final</span> String fileName)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"><span class="number">39</span>:     File file = <span class="keyword">new</span> File(fileName);</div><div class="line"><span class="number">40</span>:     <span class="comment">// åˆ›å»ºä¸Šçº§ç›®å½•</span></div><div class="line"><span class="number">41</span>:     File fileParent = file.getParentFile();</div><div class="line"><span class="number">42</span>:     <span class="keyword">if</span> (fileParent != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">43</span>:         fileParent.mkdirs();</div><div class="line"><span class="number">44</span>:     &#125;</div><div class="line"><span class="number">45</span>:     <span class="comment">// å†™å†…å®¹</span></div><div class="line"><span class="number">46</span>:     FileWriter fileWriter = <span class="keyword">null</span>;</div><div class="line"><span class="number">47</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">48</span>:         fileWriter = <span class="keyword">new</span> FileWriter(file);</div><div class="line"><span class="number">49</span>:         fileWriter.write(str);</div><div class="line"><span class="number">50</span>:     &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line"><span class="number">51</span>:         <span class="keyword">throw</span> e;</div><div class="line"><span class="number">52</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">53</span>:         <span class="keyword">if</span> (fileWriter != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">54</span>:             fileWriter.close();</div><div class="line"><span class="number">55</span>:         &#125;</div><div class="line"><span class="number">56</span>:     &#125;</div><div class="line"><span class="number">57</span>: &#125;</div></pre></td></tr></table></figure></p>
<h2>ConsumerOffsetManager</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerOffsetManager</span> <span class="keyword">extends</span> <span class="title">ConfigManager</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);</div><div class="line"> <span class="number">3</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOPIC_GROUP_SEPARATOR = <span class="string">"@"</span>;</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     <span class="comment">/**</span></div><div class="line"> 6:      * æ¶ˆè´¹è¿›åº¦é›†åˆ</div><div class="line"> 7:      */</div><div class="line"> <span class="number">8</span>:     <span class="keyword">private</span> ConcurrentHashMap&lt;String<span class="comment">/* topic@group */</span>, ConcurrentHashMap&lt;Integer, Long&gt;&gt; offsetTable = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">512</span>);</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>:     <span class="keyword">private</span> <span class="keyword">transient</span> BrokerController brokerController;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:     <span class="function"><span class="keyword">public</span> <span class="title">ConsumerOffsetManager</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">13</span>:     &#125;</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:     <span class="function"><span class="keyword">public</span> <span class="title">ConsumerOffsetManager</span><span class="params">(BrokerController brokerController)</span> </span>&#123;</div><div class="line"><span class="number">16</span>:         <span class="keyword">this</span>.brokerController = brokerController;</div><div class="line"><span class="number">17</span>:     &#125;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="comment">/**</span></div><div class="line">20:      * æäº¤æ¶ˆè´¹è¿›åº¦</div><div class="line">21:      *</div><div class="line">22:      * <span class="doctag">@param</span> clientHost æäº¤clientåœ°å€</div><div class="line">23:      * <span class="doctag">@param</span> group æ¶ˆè´¹åˆ†ç»„</div><div class="line">24:      * <span class="doctag">@param</span> topic ä¸»é¢˜</div><div class="line">25:      * <span class="doctag">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class="line">26:      * <span class="doctag">@param</span> offset è¿›åº¦ï¼ˆé˜Ÿåˆ—ä½ç½®ï¼‰</div><div class="line">27:      */</div><div class="line"><span class="number">28</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commitOffset</span><span class="params">(<span class="keyword">final</span> String clientHost, <span class="keyword">final</span> String group, <span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> offset)</span> </span>&#123;</div><div class="line"><span class="number">29</span>:         <span class="comment">// topic@group</span></div><div class="line"><span class="number">30</span>:         String key = topic + TOPIC_GROUP_SEPARATOR + group;</div><div class="line"><span class="number">31</span>:         <span class="keyword">this</span>.commitOffset(clientHost, key, queueId, offset);</div><div class="line"><span class="number">32</span>:     &#125;</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>:     <span class="comment">/**</span></div><div class="line">35:      * æäº¤æ¶ˆè´¹è¿›åº¦</div><div class="line">36:      *</div><div class="line">37:      * <span class="doctag">@param</span> clientHost æäº¤clientåœ°å€</div><div class="line">38:      * <span class="doctag">@param</span> key ä¸»é¢˜@æ¶ˆè´¹åˆ†ç»„</div><div class="line">39:      * <span class="doctag">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class="line">40:      * <span class="doctag">@param</span> offset è¿›åº¦ï¼ˆé˜Ÿåˆ—ä½ç½®ï¼‰</div><div class="line">41:      */</div><div class="line"><span class="number">42</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">commitOffset</span><span class="params">(<span class="keyword">final</span> String clientHost, <span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> offset)</span> </span>&#123;</div><div class="line"><span class="number">43</span>:         ConcurrentHashMap&lt;Integer, Long&gt; map = <span class="keyword">this</span>.offsetTable.get(key);</div><div class="line"><span class="number">44</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == map) &#123;</div><div class="line"><span class="number">45</span>:             map = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">32</span>);</div><div class="line"><span class="number">46</span>:             map.put(queueId, offset);</div><div class="line"><span class="number">47</span>:             <span class="keyword">this</span>.offsetTable.put(key, map);</div><div class="line"><span class="number">48</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">49</span>:             Long storeOffset = map.put(queueId, offset);</div><div class="line"><span class="number">50</span>:             <span class="keyword">if</span> (storeOffset != <span class="keyword">null</span> &amp;&amp; offset &lt; storeOffset) &#123;</div><div class="line"><span class="number">51</span>:                 log.warn(<span class="string">"[NOTIFYME]update consumer offset less than store. clientHost=&#123;&#125;, key=&#123;&#125;, queueId=&#123;&#125;, requestOffset=&#123;&#125;, storeOffset=&#123;&#125;"</span>, clientHost, key, queueId, offset, storeOffset);</div><div class="line"><span class="number">52</span>:             &#125;</div><div class="line"><span class="number">53</span>:         &#125;</div><div class="line"><span class="number">54</span>:     &#125;</div><div class="line"><span class="number">55</span>: </div><div class="line"><span class="number">56</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">57</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.encode(<span class="keyword">false</span>);</div><div class="line"><span class="number">58</span>:     &#125;</div><div class="line"><span class="number">59</span>: </div><div class="line"><span class="number">60</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">61</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">configFilePath</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">62</span>:         <span class="keyword">return</span> BrokerPathConfigHelper.getConsumerOffsetPath(<span class="keyword">this</span>.brokerController.getMessageStoreConfig().getStorePathRootDir());</div><div class="line"><span class="number">63</span>:     &#125;</div><div class="line"><span class="number">64</span>: </div><div class="line"><span class="number">65</span>:     <span class="comment">/**</span></div><div class="line">66:      * è§£ç å†…å®¹</div><div class="line">67:      * æ ¼å¼:JSON</div><div class="line">68:      *</div><div class="line">69:      * <span class="doctag">@param</span> jsonString å†…å®¹</div><div class="line">70:      */</div><div class="line"><span class="number">71</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">72</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(String jsonString)</span> </span>&#123;</div><div class="line"><span class="number">73</span>:         <span class="keyword">if</span> (jsonString != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">74</span>:             ConsumerOffsetManager obj = RemotingSerializable.fromJson(jsonString, ConsumerOffsetManager.class);</div><div class="line"><span class="number">75</span>:             <span class="keyword">if</span> (obj != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">76</span>:                 <span class="keyword">this</span>.offsetTable = obj.offsetTable;</div><div class="line"><span class="number">77</span>:             &#125;</div><div class="line"><span class="number">78</span>:         &#125;</div><div class="line"><span class="number">79</span>:     &#125;</div><div class="line"><span class="number">80</span>: </div><div class="line"><span class="number">81</span>:     <span class="comment">/**</span></div><div class="line">82:      * ç¼–ç å†…å®¹</div><div class="line">83:      * æ ¼å¼ä¸ºJSON</div><div class="line">84:      *</div><div class="line">85:      * <span class="doctag">@param</span> prettyFormat æ˜¯å¦æ ¼å¼åŒ–</div><div class="line">86:      * <span class="doctag">@return</span> ç¼–ç åçš„å†…å®¹</div><div class="line">87:      */</div><div class="line"><span class="number">88</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> prettyFormat)</span> </span>&#123;</div><div class="line"><span class="number">89</span>:         <span class="keyword">return</span> RemotingSerializable.toJson(<span class="keyword">this</span>, prettyFormat);</div><div class="line"><span class="number">90</span>:     &#125;</div><div class="line"><span class="number">91</span>: </div><div class="line"><span class="number">92</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šæ¶ˆè´¹è¿›åº¦ç®¡ç†å™¨ã€‚</li>
</ul>
<h1>6ã€Broker æä¾›[å‘å›æ¶ˆæ¯]æ¥å£</h1>
<p>å¤§éƒ¨åˆ†é€»è¾‘å’Œ <a href="http://www.yunai.me/RocketMQ/message-send-and-receive/#3%E3%80%81Broker-%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF"><code>Broker</code> æä¾›[æ¥æ”¶æ¶ˆæ¯]æ¥å£</a> ç±»ä¼¼ï¼Œå¯ä»¥å…ˆçœ‹ä¸‹ç›¸å…³å†…å®¹ã€‚</p>
<h2>SendMessageProcessor#consumerSendMsgBack(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> RemotingCommand <span class="title">consumerSendMsgBack</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx, <span class="keyword">final</span> RemotingCommand request)</span></span></div><div class="line">  2:     <span class="keyword">throws</span> RemotingCommandException &#123;</div><div class="line">  <span class="number">3</span>: </div><div class="line">  <span class="number">4</span>:     <span class="comment">// åˆå§‹åŒ–å“åº”</span></div><div class="line">  <span class="number">5</span>:     <span class="keyword">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(<span class="keyword">null</span>);</div><div class="line">  <span class="number">6</span>:     <span class="keyword">final</span> ConsumerSendMsgBackRequestHeader requestHeader =</div><div class="line">  <span class="number">7</span>:         (ConsumerSendMsgBackRequestHeader) request.decodeCommandCustomHeader(ConsumerSendMsgBackRequestHeader.class);</div><div class="line">  <span class="number">8</span>: </div><div class="line">  <span class="number">9</span>:     <span class="comment">// hookï¼ˆç‹¬æœ‰ï¼‰</span></div><div class="line"> <span class="number">10</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.hasConsumeMessageHook() &amp;&amp; !UtilAll.isBlank(requestHeader.getOriginMsgId())) &#123;</div><div class="line"> <span class="number">11</span>: </div><div class="line"> <span class="number">12</span>:         ConsumeMessageContext context = <span class="keyword">new</span> ConsumeMessageContext();</div><div class="line"> <span class="number">13</span>:         context.setConsumerGroup(requestHeader.getGroup());</div><div class="line"> <span class="number">14</span>:         context.setTopic(requestHeader.getOriginTopic());</div><div class="line"> <span class="number">15</span>:         context.setCommercialRcvStats(BrokerStatsManager.StatsType.SEND_BACK);</div><div class="line"> <span class="number">16</span>:         context.setCommercialRcvTimes(<span class="number">1</span>);</div><div class="line"> <span class="number">17</span>:         context.setCommercialOwner(request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER));</div><div class="line"> <span class="number">18</span>: </div><div class="line"> <span class="number">19</span>:         <span class="keyword">this</span>.executeConsumeMessageHookAfter(context);</div><div class="line"> <span class="number">20</span>:     &#125;</div><div class="line"> <span class="number">21</span>: </div><div class="line"> <span class="number">22</span>:     <span class="comment">// åˆ¤æ–­æ¶ˆè´¹åˆ†ç»„æ˜¯å¦å­˜åœ¨ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class="line"> <span class="number">23</span>:     SubscriptionGroupConfig subscriptionGroupConfig =</div><div class="line"> <span class="number">24</span>:         <span class="keyword">this</span>.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(requestHeader.getGroup());</div><div class="line"> <span class="number">25</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == subscriptionGroupConfig) &#123;</div><div class="line"> <span class="number">26</span>:         response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);</div><div class="line"> <span class="number">27</span>:         response.setRemark(<span class="string">"subscription group not exist, "</span> + requestHeader.getGroup() + <span class="string">" "</span></div><div class="line"> <span class="number">28</span>:             + FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST));</div><div class="line"> <span class="number">29</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">30</span>:     &#125;</div><div class="line"> <span class="number">31</span>: </div><div class="line"> <span class="number">32</span>:     <span class="comment">// æ£€æŸ¥ broker æ˜¯å¦æœ‰å†™å…¥æƒé™</span></div><div class="line"> <span class="number">33</span>:     <span class="keyword">if</span> (!PermName.isWriteable(<span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerPermission())) &#123;</div><div class="line"> <span class="number">34</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"> <span class="number">35</span>:         response.setRemark(<span class="string">"the broker["</span> + <span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerIP1() + <span class="string">"] sending message is forbidden"</span>);</div><div class="line"> <span class="number">36</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">37</span>:     &#125;</div><div class="line"> <span class="number">38</span>: </div><div class="line"> <span class="number">39</span>:     <span class="comment">// æ£€æŸ¥ é‡è¯•é˜Ÿåˆ—æ•° æ˜¯å¦å¤§äº0ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class="line"> <span class="number">40</span>:     <span class="keyword">if</span> (subscriptionGroupConfig.getRetryQueueNums() &lt;= <span class="number">0</span>) &#123;</div><div class="line"> <span class="number">41</span>:         response.setCode(ResponseCode.SUCCESS);</div><div class="line"> <span class="number">42</span>:         response.setRemark(<span class="keyword">null</span>);</div><div class="line"> <span class="number">43</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">44</span>:     &#125;</div><div class="line"> <span class="number">45</span>: </div><div class="line"> <span class="number">46</span>:     <span class="comment">// è®¡ç®—retry Topic</span></div><div class="line"> <span class="number">47</span>:     String newTopic = MixAll.getRetryTopic(requestHeader.getGroup());</div><div class="line"> <span class="number">48</span>: </div><div class="line"> <span class="number">49</span>:     <span class="comment">// è®¡ç®—é˜Ÿåˆ—ç¼–å·ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class="line"> <span class="number">50</span>:     <span class="keyword">int</span> queueIdInt = Math.abs(<span class="keyword">this</span>.random.nextInt() % <span class="number">99999999</span>) % subscriptionGroupConfig.getRetryQueueNums();</div><div class="line"> <span class="number">51</span>: </div><div class="line"> <span class="number">52</span>:     <span class="comment">// è®¡ç®—sysFlagï¼ˆç‹¬æœ‰ï¼‰</span></div><div class="line"> <span class="number">53</span>:     <span class="keyword">int</span> topicSysFlag = <span class="number">0</span>;</div><div class="line"> <span class="number">54</span>:     <span class="keyword">if</span> (requestHeader.isUnitMode()) &#123;</div><div class="line"> <span class="number">55</span>:         topicSysFlag = TopicSysFlag.buildSysFlag(<span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line"> <span class="number">56</span>:     &#125;</div><div class="line"> <span class="number">57</span>: </div><div class="line"> <span class="number">58</span>:     <span class="comment">// è·å–topicConfigã€‚å¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™è¿›è¡Œåˆ›å»º</span></div><div class="line"> <span class="number">59</span>:     TopicConfig topicConfig = <span class="keyword">this</span>.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(<span class="comment">//</span></div><div class="line"> <span class="number">60</span>:         newTopic, <span class="comment">//</span></div><div class="line"> <span class="number">61</span>:         subscriptionGroupConfig.getRetryQueueNums(), <span class="comment">//</span></div><div class="line"> <span class="number">62</span>:         PermName.PERM_WRITE | PermName.PERM_READ, topicSysFlag);</div><div class="line"> <span class="number">63</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == topicConfig) &#123; <span class="comment">// æ²¡æœ‰é…ç½®</span></div><div class="line"> <span class="number">64</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"> <span class="number">65</span>:         response.setRemark(<span class="string">"topic["</span> + newTopic + <span class="string">"] not exist"</span>);</div><div class="line"> <span class="number">66</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">67</span>:     &#125;</div><div class="line"> <span class="number">68</span>:     <span class="keyword">if</span> (!PermName.isWriteable(topicConfig.getPerm())) &#123; <span class="comment">// ä¸å…è®¸å†™å…¥</span></div><div class="line"> <span class="number">69</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"> <span class="number">70</span>:         response.setRemark(String.format(<span class="string">"the topic[%s] sending message is forbidden"</span>, newTopic));</div><div class="line"> <span class="number">71</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">72</span>:     &#125;</div><div class="line"> <span class="number">73</span>: </div><div class="line"> <span class="number">74</span>:     <span class="comment">// æŸ¥è¯¢æ¶ˆæ¯ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿”å›å¼‚å¸¸é”™è¯¯ã€‚ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class="line"> <span class="number">75</span>:     MessageExt msgExt = <span class="keyword">this</span>.brokerController.getMessageStore().lookMessageByOffset(requestHeader.getOffset());</div><div class="line"> <span class="number">76</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == msgExt) &#123;</div><div class="line"> <span class="number">77</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"> <span class="number">78</span>:         response.setRemark(<span class="string">"look message by offset failed, "</span> + requestHeader.getOffset());</div><div class="line"> <span class="number">79</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">80</span>:     &#125;</div><div class="line"> <span class="number">81</span>: </div><div class="line"> <span class="number">82</span>:     <span class="comment">// è®¾ç½®retryTopicåˆ°æ‹“å±•å±æ€§ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class="line"> <span class="number">83</span>:     <span class="keyword">final</span> String retryTopic = msgExt.getProperty(MessageConst.PROPERTY_RETRY_TOPIC);</div><div class="line"> <span class="number">84</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == retryTopic) &#123;</div><div class="line"> <span class="number">85</span>:         MessageAccessor.putProperty(msgExt, MessageConst.PROPERTY_RETRY_TOPIC, msgExt.getTopic());</div><div class="line"> <span class="number">86</span>:     &#125;</div><div class="line"> <span class="number">87</span>: </div><div class="line"> <span class="number">88</span>:     <span class="comment">// è®¾ç½®æ¶ˆæ¯ä¸ç­‰å¾…å­˜å‚¨å®Œæˆï¼ˆç‹¬æœ‰ï¼‰ TODO ç–‘é—®ï¼šå¦‚æœè®¾ç½®æˆä¸ç­‰å¾…å­˜å‚¨ï¼Œbrokerè®¾ç½®æˆåŒæ­¥è½ç›˜ï¼Œå²‚ä¸æ˜¯ä¸èƒ½æ‰¹é‡æäº¤äº†ï¼Ÿ</span></div><div class="line"> <span class="number">89</span>:     msgExt.setWaitStoreMsgOK(<span class="keyword">false</span>);</div><div class="line"> <span class="number">90</span>: </div><div class="line"> <span class="number">91</span>:     <span class="comment">// å¤„ç† delayLevelï¼ˆç‹¬æœ‰ï¼‰ã€‚</span></div><div class="line"> <span class="number">92</span>:     <span class="keyword">int</span> delayLevel = requestHeader.getDelayLevel();</div><div class="line"> <span class="number">93</span>:     <span class="keyword">int</span> maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();</div><div class="line"> <span class="number">94</span>:     <span class="keyword">if</span> (request.getVersion() &gt;= MQVersion.Version.V3_4_9.ordinal()) &#123;</div><div class="line"> <span class="number">95</span>:         maxReconsumeTimes = requestHeader.getMaxReconsumeTimes();</div><div class="line"> <span class="number">96</span>:     &#125;</div><div class="line"> <span class="number">97</span>:     <span class="keyword">if</span> (msgExt.getReconsumeTimes() &gt;= maxReconsumeTimes<span class="comment">//</span></div><div class="line"> <span class="number">98</span>:         || delayLevel &lt; <span class="number">0</span>) &#123; <span class="comment">// å¦‚æœè¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°ï¼Œåˆ™topicä¿®æ”¹æˆ"%DLQ%" + åˆ†ç»„åï¼Œå³åŠ å…¥ æ­»ä¿¡é˜Ÿåˆ—(Dead Letter Queue)</span></div><div class="line"> <span class="number">99</span>:         newTopic = MixAll.getDLQTopic(requestHeader.getGroup());</div><div class="line"><span class="number">100</span>:         queueIdInt = Math.abs(<span class="keyword">this</span>.random.nextInt() % <span class="number">99999999</span>) % DLQ_NUMS_PER_GROUP;</div><div class="line"><span class="number">101</span>: </div><div class="line"><span class="number">102</span>:         topicConfig = <span class="keyword">this</span>.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(newTopic, <span class="comment">//</span></div><div class="line"><span class="number">103</span>:             DLQ_NUMS_PER_GROUP, <span class="comment">//</span></div><div class="line"><span class="number">104</span>:             PermName.PERM_WRITE, <span class="number">0</span></div><div class="line"><span class="number">105</span>:         );</div><div class="line"><span class="number">106</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == topicConfig) &#123;</div><div class="line"><span class="number">107</span>:             response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">108</span>:             response.setRemark(<span class="string">"topic["</span> + newTopic + <span class="string">"] not exist"</span>);</div><div class="line"><span class="number">109</span>:             <span class="keyword">return</span> response;</div><div class="line"><span class="number">110</span>:         &#125;</div><div class="line"><span class="number">111</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">112</span>:         <span class="keyword">if</span> (<span class="number">0</span> == delayLevel) &#123;</div><div class="line"><span class="number">113</span>:             delayLevel = <span class="number">3</span> + msgExt.getReconsumeTimes();</div><div class="line"><span class="number">114</span>:         &#125;</div><div class="line"><span class="number">115</span>:         msgExt.setDelayTimeLevel(delayLevel);</div><div class="line"><span class="number">116</span>:     &#125;</div><div class="line"><span class="number">117</span>: </div><div class="line"><span class="number">118</span>:     <span class="comment">// åˆ›å»ºMessageExtBrokerInner</span></div><div class="line"><span class="number">119</span>:     MessageExtBrokerInner msgInner = <span class="keyword">new</span> MessageExtBrokerInner();</div><div class="line"><span class="number">120</span>:     msgInner.setTopic(newTopic);</div><div class="line"><span class="number">121</span>:     msgInner.setBody(msgExt.getBody());</div><div class="line"><span class="number">122</span>:     msgInner.setFlag(msgExt.getFlag());</div><div class="line"><span class="number">123</span>:     MessageAccessor.setProperties(msgInner, msgExt.getProperties());</div><div class="line"><span class="number">124</span>:     msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgExt.getProperties()));</div><div class="line"><span class="number">125</span>:     msgInner.setTagsCode(MessageExtBrokerInner.tagsString2tagsCode(<span class="keyword">null</span>, msgExt.getTags()));</div><div class="line"><span class="number">126</span>:     msgInner.setQueueId(queueIdInt);</div><div class="line"><span class="number">127</span>:     msgInner.setSysFlag(msgExt.getSysFlag());</div><div class="line"><span class="number">128</span>:     msgInner.setBornTimestamp(msgExt.getBornTimestamp());</div><div class="line"><span class="number">129</span>:     msgInner.setBornHost(msgExt.getBornHost());</div><div class="line"><span class="number">130</span>:     msgInner.setStoreHost(<span class="keyword">this</span>.getStoreHost());</div><div class="line"><span class="number">131</span>:     msgInner.setReconsumeTimes(msgExt.getReconsumeTimes() + <span class="number">1</span>);</div><div class="line"><span class="number">132</span>: </div><div class="line"><span class="number">133</span>:     <span class="comment">// è®¾ç½®åŸå§‹æ¶ˆæ¯ç¼–å·åˆ°æ‹“å±•å­—æ®µï¼ˆç‹¬æœ‰ï¼‰</span></div><div class="line"><span class="number">134</span>:     String originMsgId = MessageAccessor.getOriginMessageId(msgExt);</div><div class="line"><span class="number">135</span>:     MessageAccessor.setOriginMessageId(msgInner, UtilAll.isBlank(originMsgId) ? msgExt.getMsgId() : originMsgId);</div><div class="line"><span class="number">136</span>: </div><div class="line"><span class="number">137</span>:     <span class="comment">// æ·»åŠ æ¶ˆæ¯</span></div><div class="line"><span class="number">138</span>:     PutMessageResult putMessageResult = <span class="keyword">this</span>.brokerController.getMessageStore().putMessage(msgInner);</div><div class="line"><span class="number">139</span>:     <span class="keyword">if</span> (putMessageResult != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">140</span>:         <span class="keyword">switch</span> (putMessageResult.getPutMessageStatus()) &#123;</div><div class="line"><span class="number">141</span>:             <span class="keyword">case</span> PUT_OK:</div><div class="line"><span class="number">142</span>:                 String backTopic = msgExt.getTopic();</div><div class="line"><span class="number">143</span>:                 String correctTopic = msgExt.getProperty(MessageConst.PROPERTY_RETRY_TOPIC);</div><div class="line"><span class="number">144</span>:                 <span class="keyword">if</span> (correctTopic != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">145</span>:                     backTopic = correctTopic;</div><div class="line"><span class="number">146</span>:                 &#125;</div><div class="line"><span class="number">147</span>: </div><div class="line"><span class="number">148</span>:                 <span class="keyword">this</span>.brokerController.getBrokerStatsManager().incSendBackNums(requestHeader.getGroup(), backTopic);</div><div class="line"><span class="number">149</span>: </div><div class="line"><span class="number">150</span>:                 response.setCode(ResponseCode.SUCCESS);</div><div class="line"><span class="number">151</span>:                 response.setRemark(<span class="keyword">null</span>);</div><div class="line"><span class="number">152</span>: </div><div class="line"><span class="number">153</span>:                 <span class="keyword">return</span> response;</div><div class="line"><span class="number">154</span>:             <span class="keyword">default</span>:</div><div class="line"><span class="number">155</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">156</span>:         &#125;</div><div class="line"><span class="number">157</span>: </div><div class="line"><span class="number">158</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">159</span>:         response.setRemark(putMessageResult.getPutMessageStatus().name());</div><div class="line"><span class="number">160</span>:         <span class="keyword">return</span> response;</div><div class="line"><span class="number">161</span>:     &#125;</div><div class="line"><span class="number">162</span>: </div><div class="line"><span class="number">163</span>:     response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">164</span>:     response.setRemark(<span class="string">"putMessageResult is null"</span>);</div><div class="line"><span class="number">165</span>:     <span class="keyword">return</span> response;</div><div class="line"><span class="number">166</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¯´æ˜ ï¼šå½“ <code>Consumer</code> æ¶ˆè´¹æŸæ¡æ¶ˆæ¯å¤±è´¥æ—¶ï¼Œä¼šè°ƒç”¨è¯¥æ¥å£å‘å›æ¶ˆæ¯ã€‚<code>Broker</code> ä¼šå­˜å‚¨å‘å›çš„æ¶ˆæ¯ã€‚è¿™æ ·ï¼Œä¸‹æ¬¡ <code>Consumer</code> æ‹‰å–è¯¥æ¶ˆæ¯ï¼Œèƒ½å¤Ÿä» <code>CommitLog</code> å’Œ <code>ConsumeQueue</code> é¡ºåºè¯»å–ã€‚</li>
<li>[x] å› ä¸ºå¤§å¤šæ•°é€»è¾‘å’Œ <strong><code>Broker</code> æ¥æ”¶æ™®é€šæ¶ˆæ¯</strong> å¾ˆç›¸ä¼¼ï¼Œæ—¶å€™ <code>TODO</code> æ ‡è®°æˆç‹¬æœ‰çš„é€»è¾‘ã€‚</li>
<li>ç¬¬ 4 è‡³ 7 è¡Œ ï¼šåˆå§‹åŒ–å“åº”ã€‚</li>
<li>[x] ç¬¬ 9 è‡³ 20 è¡Œ ï¼šHooké€»è¾‘ã€‚</li>
<li>[x] ç¬¬22 è‡³ 30 è¡Œ ï¼šåˆ¤æ–­æ¶ˆè´¹åˆ†ç»„æ˜¯å¦å­˜åœ¨ã€‚</li>
<li>ç¬¬ 32 è‡³ 37 è¡Œ ï¼šæ£€æŸ¥ <code>Broker</code> æ˜¯å¦æœ‰å†™å…¥æƒé™ã€‚</li>
<li>[x] ç¬¬ 39 è‡³ 44 è¡Œ ï¼šæ£€æŸ¥é‡è¯•é˜Ÿåˆ—æ•°æ˜¯å¦å¤§äº0ã€‚</li>
<li>ç¬¬ 47 è¡Œ ï¼šè®¡ç®— retry topicã€‚</li>
<li>[x] ç¬¬ 50 è¡Œ ï¼šéšæœºåˆ†é…é˜Ÿåˆ—ç¼–å·ï¼Œä¾èµ– <code>retryQueueNums</code>ã€‚</li>
<li>[x] ç¬¬ 52 è‡³ 56 è¡Œ ï¼šè®¡ç®— <code>sysFlag</code>ã€‚</li>
<li>ç¬¬ 58 è‡³ 72 è¡Œ ï¼šè·å– <code>TopicConfig</code>ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºã€‚</li>
<li>[x] ç¬¬ 74 è‡³ 80 è¡Œ ï¼šæŸ¥è¯¢æ¶ˆæ¯ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿”å›å¼‚å¸¸é”™è¯¯ã€‚</li>
<li>[x] ç¬¬ 82 è‡³ 86 è¡Œ ï¼šè®¾ç½® <code>retryTopic</code> åˆ°æ¶ˆæ¯æ‹“å±•å±æ€§ã€‚</li>
<li>[x] ç¬¬ 89 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯ä¸ç­‰å¾…å­˜å‚¨å®Œæˆã€‚
<ul>
<li>å½“ <code>Broker</code> åˆ·ç›˜æ–¹å¼ä¸ºåŒæ­¥ï¼Œä¼šå¯¼è‡´åŒæ­¥è½ç›˜ä¸èƒ½æ‰¹é‡æäº¤ï¼Œè¿™æ ·ä¼šä¸ä¼šå­˜åœ¨é—®é¢˜ï¼Ÿæœ‰çŸ¥é“çš„åŒå­¦éº»çƒ¦å‘ŠçŸ¥ä¸‹ã€‚ğŸ˜ˆã€‚</li>
</ul>
</li>
<li>[x] ç¬¬ 91 è‡³ 116 è¡Œ ï¼šå¤„ç† <code>delayLevel</code> ã€‚</li>
<li>ç¬¬ 118 è‡³ 131 è¡Œ ï¼šåˆ›å»º <code>MessageExtBrokerInner</code> ã€‚</li>
<li>[x] ç¬¬ 133 è‡³ 135 è¡Œ ï¼šè®¾ç½®åŸå§‹æ¶ˆæ¯ç¼–å·åˆ°æ‹“å±•å±æ€§ã€‚</li>
<li>ç¬¬ 137 è‡³ 161 è¡Œ ï¼šæ·»åŠ æ¶ˆæ¯ã€‚</li>
</ul>
<h1>7ã€ç»“å°¾</h1>
<p>æ„Ÿè°¢åŒå­¦ä»¬å¯¹æœ¬æ–‡çš„é˜…è¯»ã€æ”¶è—ã€ç‚¹èµã€‚</p>
<p>ğŸ˜ˆå¦‚æœè§£æå­˜åœ¨é—®é¢˜æˆ–è€…è¡¨è¾¾è¯¯è§£çš„ï¼Œè¡¨ç¤ºæŠ±æ­‰ã€‚å¦‚æœæ–¹ä¾¿çš„è¯ï¼Œå¯ä»¥åŠ ä¸‹ <strong>QQï¼š7685413</strong>ã€‚è®©æˆ‘ä»¬æ¥ä¸€åœº 1 ï¼š1 äº¤æµï¼ˆæåŸºï¼‰ã€‚</p>
<p>å†æ¬¡è¡¨ç¤ºååˆ†æ„Ÿè°¢ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rock
    
    </summary>
    
      <category term="RocketMQ" scheme="http://www.yunai.me/categories/RocketMQ/"/>
    
    
  </entry>
  
</feed>
