<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>èŠ‹è‰¿Vçš„åšå®¢</title>
  <subtitle>æ„¿ç¼–ç åŠç”Ÿï¼Œå¦‚è€å‹ç›¸ä¼´ï¼</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.yunai.me/"/>
  <updated>2017-08-05T20:58:04.000Z</updated>
  <id>http://www.yunai.me/</id>
  
  <author>
    <name>ç‹æ–‡æ–Œ</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆäºŒï¼‰ä¹‹äº‹åŠ¡è¡¥å¿å‹</title>
    <link href="http://www.yunai.me/Sharding-JDBC/transaction-tcc/"/>
    <id>http://www.yunai.me/Sharding-JDBC/transaction-tcc/</id>
    <published>2017-08-21T16:00:00.000Z</published>
    <updated>2017-08-05T20:58:04.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<p>å å‘æ–‡ã€‚å…³æ³¨å…¬ä¼—å·ï¼Œç¬¬ä¸€æ—¶é—´è·å¾—æ›´æ–°é€šçŸ¥ã€‚
psï¼štcc æš‚æ—¶æœªå®ç°ï¼Œç›®å‰åœ¨ RoadMap ä¸­</p>
<hr>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>
ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;o
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆä¸€ï¼‰ä¹‹æœ€å¤§åŠªåŠ›å‹</title>
    <link href="http://www.yunai.me/Sharding-JDBC/transaction-bed/"/>
    <id>http://www.yunai.me/Sharding-JDBC/transaction-bed/</id>
    <published>2017-08-19T16:00:00.000Z</published>
    <updated>2017-08-11T10:39:17.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<p>TODO ç›®å½•</p>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æ•°æ®åº“è¡¨<strong>åˆ†åº“</strong>åï¼Œä¸šåŠ¡åœºæ™¯ä¸‹çš„<strong>å•åº“æœ¬åœ°äº‹åŠ¡</strong>å¯èƒ½å˜æˆ<strong>è·¨åº“åˆ†å¸ƒå¼äº‹åŠ¡</strong>ã€‚è™½ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆé€‚çš„<strong>åˆ†åº“è§„åˆ™</strong>è®©æ“ä½œçš„æ•°æ®åœ¨åŒåº“ä¸‹ï¼Œç»§ç»­ä¿è¯<strong>å•åº“æœ¬åœ°äº‹åŠ¡</strong>ï¼Œè¿™ä¹Ÿæ˜¯éå¸¸æ¨å´‡çš„ï¼Œä½†ä¸æ˜¯æ‰€æœ‰åœºæ™¯ä¸‹éƒ½èƒ½é€‚ç”¨ã€‚å¦‚æœè¿™äº›åœºæ™¯å¯¹äº‹åŠ¡çš„ä¸€è‡´æ€§æœ‰è¦æ±‚ï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡çš„â€œéº»çƒ¦â€ã€‚</p>
<p><strong>åˆ†å¸ƒå¼äº‹åŠ¡</strong>æ˜¯ä¸ªå¾ˆå¤§çš„è¯é¢˜ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ Sharding-JDBC å¯¹å¥¹çš„è§£ç­”ï¼š</p>
<blockquote>
<p>Sharding-JDBCç”±äºæ€§èƒ½æ–¹é¢çš„è€ƒé‡ï¼Œå†³å®šä¸æ”¯æŒå¼ºä¸€è‡´æ€§åˆ†å¸ƒå¼äº‹åŠ¡ã€‚æˆ‘ä»¬å·²æ˜ç¡®è§„åˆ’çº¿è·¯å›¾ï¼Œæœªæ¥ä¼šæ”¯æŒæœ€ç»ˆä¸€è‡´æ€§çš„æŸ”æ€§äº‹åŠ¡ã€‚</p>
</blockquote>
<p>Sharding-JDBC æä¾›äº†ä¸¤ç§ <strong>æŸ”æ€§äº‹åŠ¡</strong>ï¼š</p>
<ul>
<li>æœ€å¤§åŠªåŠ›é€è¾¾å‹ BED ï¼šå·²ç»å®ç°</li>
<li>äº‹åŠ¡è¡¥å¿å‹ TCC ï¼šè®¡åˆ’ä¸­</li>
</ul>
<p><strong>æœ¬æ–‡åˆ†äº« æœ€å¤§åŠªåŠ›é€è¾¾å‹ çš„å®ç°</strong>ã€‚å»ºè®®å‰ç½®é˜…è¯»ï¼š<a href="http://www.yunai.me/Sharding-JDBC/sql-execute/?self">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œã€‹</a>ã€‚</p>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1 id="2-æœ€å¤§åŠªåŠ›é€è¾¾å‹"><a href="#2-æœ€å¤§åŠªåŠ›é€è¾¾å‹" class="headerlink" title="2. æœ€å¤§åŠªåŠ›é€è¾¾å‹"></a>2. æœ€å¤§åŠªåŠ›é€è¾¾å‹</h1><p><strong>æ¦‚å¿µ</strong></p>
<blockquote>
<p>åœ¨åˆ†å¸ƒå¼æ•°æ®åº“çš„åœºæ™¯ä¸‹ï¼Œç›¸ä¿¡å¯¹äºè¯¥æ•°æ®åº“çš„æ“ä½œæœ€ç»ˆä¸€å®šå¯ä»¥æˆåŠŸï¼Œæ‰€ä»¥é€šè¿‡æœ€å¤§åŠªåŠ›åå¤å°è¯•é€è¾¾æ“ä½œã€‚</p>
</blockquote>
<p>ä»æ¦‚å¿µçœ‹ï¼Œå¯èƒ½ä¸æ˜¯å¾ˆç›´ç™½çš„ç†è§£æ˜¯ä»€ä¹ˆæ„æ€ï¼Œæœ¬æ–‡ä¼š<strong>æœ€å¤§åŠªåŠ›</strong>è®©ä½ å¹²å‡€ç†è§£ã€‚</p>
<p><strong>æ¶æ„å›¾</strong></p>
<blockquote>
<p><img src="../../../images/Sharding-JDBC/2017_08_20/01.jpeg" alt=""></p>
</blockquote>
<p>æ‰§è¡Œè¿‡ç¨‹æœ‰ <strong>å››ç§</strong> æƒ…å†µï¼š</p>
<ol>
<li>ã€çº¢çº¿ã€‘æ‰§è¡ŒæˆåŠŸ</li>
<li>ã€æ£•çº¿ã€‘æ‰§è¡Œå¤±è´¥ï¼ŒåŒæ­¥é‡è¯•æˆåŠŸ</li>
<li>ã€ç²‰çº¿ã€‘æ‰§è¡Œå¤±è´¥ï¼ŒåŒæ­¥é‡è¯•å¤±è´¥ï¼Œå¼‚æ­¥é‡è¯•æˆåŠŸ</li>
<li>ã€ç»¿çº¿ã€‘æ‰§è¡Œå¤±è´¥ï¼ŒåŒæ­¥é‡è¯•å¤±è´¥ï¼Œå¼‚æ­¥é‡è¯•å¤±è´¥ï¼Œäº‹åŠ¡æ—¥å¿—ä¿ç•™</li>
</ol>
<p>æ•´ä½“æˆæ¼æ–—å€’ä¸‰è§’ï¼Œä¸Šä¸€ä¸ªé˜¶æ®µå¤±è´¥ï¼Œäº¤ç»™ä¸‹ä¸€ä¸ªé˜¶æ®µé‡è¯•ï¼š</p>
<p><img src="../../../images/Sharding-JDBC/2017_08_20/02.png" alt=""></p>
<p>æ•´ä¸ªè¿‡ç¨‹é€šè¿‡å¦‚ä¸‹ <strong>ç»„ä»¶</strong> å®Œæˆï¼š</p>
<ul>
<li>æŸ”æ€§äº‹åŠ¡ç®¡ç†å™¨</li>
<li>æœ€å¤§åŠªåŠ›é€è¾¾å‹æŸ”æ€§äº‹åŠ¡</li>
<li>æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨</li>
<li>äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨</li>
<li>æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š</li>
</ul>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬é€èŠ‚åˆ†äº«æ¯ä¸ªç»„ä»¶ã€‚</p>
<h1 id="3-æŸ”æ€§äº‹åŠ¡ç®¡ç†å™¨"><a href="#3-æŸ”æ€§äº‹åŠ¡ç®¡ç†å™¨" class="headerlink" title="3. æŸ”æ€§äº‹åŠ¡ç®¡ç†å™¨"></a>3. æŸ”æ€§äº‹åŠ¡ç®¡ç†å™¨</h1><h2 id="3-1-æ¦‚å¿µ"><a href="#3-1-æ¦‚å¿µ" class="headerlink" title="3.1 æ¦‚å¿µ"></a>3.1 æ¦‚å¿µ</h2><p>æŸ”æ€§äº‹åŠ¡ç®¡ç†å™¨ï¼ŒSoftTransactionManager å®ç°ï¼Œè´Ÿè´£å¯¹æŸ”æ€§äº‹åŠ¡é…ç½®( SoftTransactionConfiguration ) ã€æŸ”æ€§äº‹åŠ¡( AbstractSoftTransaction )çš„ç®¡ç†ã€‚</p>
<h2 id="3-2-æŸ”æ€§äº‹åŠ¡é…ç½®"><a href="#3-2-æŸ”æ€§äº‹åŠ¡é…ç½®" class="headerlink" title="3.2 æŸ”æ€§äº‹åŠ¡é…ç½®"></a>3.2 æŸ”æ€§äº‹åŠ¡é…ç½®</h2><p>è°ƒç”¨ <code>#init()</code> åˆå§‹åŒ–æŸ”æ€§ç®¡ç†å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SoftTransactionManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æŸ”æ€§äº‹åŠ¡é…ç½®å¯¹è±¡</div><div class="line">*/</div><div class="line"><span class="meta">@Getter</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> SoftTransactionConfiguration transactionConfig;</div><div class="line"></div><div class="line"><span class="comment">// SoftTransactionManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆå§‹åŒ–äº‹åŠ¡ç®¡ç†å™¨.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="comment">// åˆå§‹åŒ– æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨</span></div><div class="line">   EventBusInstance.getInstance().register(<span class="keyword">new</span> BestEffortsDeliveryListener());</div><div class="line">   <span class="comment">// åˆå§‹åŒ– äº‹åŠ¡æ—¥å¿—æ•°æ®åº“å­˜å‚¨è¡¨</span></div><div class="line">   <span class="keyword">if</span> (TransactionLogDataSourceType.RDB == transactionConfig.getStorageType()) &#123;</div><div class="line">       Preconditions.checkNotNull(transactionConfig.getTransactionLogDataSource());</div><div class="line">       createTable();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// åˆå§‹åŒ– å†…åµŒçš„æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š</span></div><div class="line">   <span class="keyword">if</span> (transactionConfig.getBestEffortsDeliveryJobConfiguration().isPresent()) &#123;</div><div class="line">       <span class="keyword">new</span> NestedBestEffortsDeliveryJobFactory(transactionConfig).init();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å°†æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨( BestEffortsDeliveryListener )æ³¨å†Œåˆ°äº‹åŠ¡æ€»çº¿ ( EventBus )ã€‚åœ¨ã€æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨ã€å°èŠ‚ä¼šè¯¦ç»†åˆ†äº«</li>
<li>å½“ä½¿ç”¨<strong>æ•°æ®åº“</strong>å­˜å‚¨äº‹åŠ¡æ—¥å¿—( TransactionLog ) æ—¶ï¼Œè‹¥<strong>äº‹åŠ¡æ—¥å¿—è¡¨( <code>transaction_log</code> )</strong>ä¸å­˜åœ¨åˆ™è¿›è¡Œåˆ›å»ºã€‚åœ¨ã€äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨ã€å°èŠ‚ä¼šè¯¦ç»†åˆ†äº«</li>
<li>å½“é…ç½®ä½¿ç”¨<strong>å†…åµŒçš„</strong>æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š( NestedBestEffortsDeliveryJob ) æ—¶ï¼Œè¿›è¡Œåˆå§‹åŒ–ã€‚åœ¨ã€æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸šã€å°èŠ‚ä¼šè¯¦ç»†åˆ†äº«</li>
</ul>
<p><strong>SoftTransactionConfiguration</strong></p>
<p>SoftTransactionConfigurationï¼ŒæŸ”æ€§äº‹åŠ¡é…ç½®å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SoftTransactionConfiguration</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * äº‹åŠ¡ç®¡ç†å™¨ç®¡ç†çš„æ•°æ®æº.</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span>(AccessLevel.NONE)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource targetDataSource;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åŒæ­¥çš„äº‹åŠ¡é€è¾¾çš„æœ€å¤§å°è¯•æ¬¡æ•°.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> syncMaxDeliveryTryTimes = <span class="number">3</span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * äº‹åŠ¡æ—¥å¿—å­˜å‚¨ç±»å‹.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> TransactionLogDataSourceType storageType = RDB;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å­˜å‚¨äº‹åŠ¡æ—¥å¿—çš„æ•°æ®æº.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> DataSource transactionLogDataSource;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å†…åµŒçš„æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸šé…ç½®å¯¹è±¡.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Optional&lt;NestedBestEffortsDeliveryJobConfiguration&gt; bestEffortsDeliveryJobConfiguration = Optional.absent();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-3-æŸ”æ€§äº‹åŠ¡"><a href="#3-3-æŸ”æ€§äº‹åŠ¡" class="headerlink" title="3.3 æŸ”æ€§äº‹åŠ¡"></a>3.3 æŸ”æ€§äº‹åŠ¡</h2><p>åœ¨ Sharding-JDBC é‡Œï¼Œç›®å‰æŸ”æ€§äº‹åŠ¡åˆ†æˆä¸¤ç§ï¼š</p>
<ul>
<li>BEDSoftTransaction ï¼šæœ€å¤§åŠªåŠ›é€è¾¾å‹æŸ”æ€§äº‹åŠ¡</li>
<li>TCCSoftTransaction ï¼šTCCå‹æŸ”æ€§äº‹åŠ¡</li>
</ul>
<p><strong>ç»§æ‰¿ AbstractSoftTransaction</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractSoftTransaction</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ†ç‰‡è¿æ¥åŸè‡ªåŠ¨æäº¤çŠ¶æ€</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> previousAutoCommit;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ†ç‰‡è¿æ¥</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> ShardingConnection connection;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * äº‹åŠ¡ç±»å‹</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> SoftTransactionType transactionType;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * äº‹åŠ¡ç¼–å·</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> String transactionId;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AbstractSoftTransaction å®ç°äº†å¼€å¯æŸ”æ€§äº‹åŠ¡ã€å…³é—­æŸ”æ€§äº‹åŠ¡ä¸¤ä¸ªæ–¹æ³•æä¾›ç»™å­ç±»è°ƒç”¨ï¼š</p>
<ul>
<li><p><code>#beginInternal()</code></p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* å¼€å¯æŸ”æ€§</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> conn åˆ†ç‰‡è¿æ¥</div><div class="line">* <span class="doctag">@param</span> type äº‹åŠ¡ç±»å‹</div><div class="line">* <span class="doctag">@throws</span> SQLException</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">beginInternal</span><span class="params">(<span class="keyword">final</span> Connection conn, <span class="keyword">final</span> SoftTransactionType type)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="comment">// TODO åˆ¤æ–­å¦‚æœåœ¨ä¼ ç»Ÿäº‹åŠ¡ä¸­ï¼Œåˆ™æŠ›å¼‚å¸¸</span></div><div class="line">   Preconditions.checkArgument(conn <span class="keyword">instanceof</span> ShardingConnection, <span class="string">"Only ShardingConnection can support eventual consistency transaction."</span>);</div><div class="line">   <span class="comment">// è®¾ç½®æ‰§è¡Œé”™è¯¯ï¼Œä¸æŠ›å‡ºå¼‚å¸¸</span></div><div class="line">   ExecutorExceptionHandler.setExceptionThrown(<span class="keyword">false</span>);</div><div class="line">   connection = (ShardingConnection) conn;</div><div class="line">   transactionType = type;</div><div class="line">   <span class="comment">// è®¾ç½®è‡ªåŠ¨æäº¤çŠ¶æ€</span></div><div class="line">   previousAutoCommit = connection.getAutoCommit();</div><div class="line">   connection.setAutoCommit(<span class="keyword">true</span>);</div><div class="line">   <span class="comment">// ç”Ÿæˆäº‹åŠ¡ç¼–å·</span></div><div class="line">   <span class="comment">// TODO æ›¿æ¢UUIDä¸ºæ›´æœ‰æ•ˆç‡çš„idç”Ÿæˆå™¨</span></div><div class="line">   transactionId = UUID.randomUUID().toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>* è°ƒç”¨ `ExecutorExceptionHandler.setExceptionThrown(false)` è®¾ç½®æ‰§è¡Œ SQL é”™è¯¯æ—¶ï¼Œä¹Ÿä¸æŠ›å‡ºå¼‚å¸¸ã€‚
    * å¯¹å¼‚å¸¸å¤„ç†çš„ä»£ç ï¼š[ExecutorExceptionHandler#setExceptionThrown()](https://github.com/dangdangdotcom/sharding-jdbc/blob/884b38f4c2402e31464d15b444f4b405e07fe211/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/executor/threadlocal/ExecutorExceptionHandler.java#L59) 
    * å¯¹äºå…¶ä»– SQLï¼Œä¸ä¼šå› ä¸º SQL é”™è¯¯ä¸æ‰§è¡Œï¼Œä¼šç»§ç»­æ‰§è¡Œ
    * å¯¹äºä¸Šå±‚ä¸šåŠ¡ï¼Œä¸ä¼šå› ä¸º SQL é”™è¯¯ç»ˆæ­¢é€»è¾‘ï¼Œä¼šç»§ç»­æ‰§è¡Œã€‚è¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ä¸‹ï¼Œä¸Šå±‚ä¸šåŠ¡ä¸èƒ½å¯¹è¯¥ SQL æ‰§è¡Œç»“æœæœ‰å¼ºä¾èµ–ï¼Œå› ä¸º SQL é”™è¯¯éœ€è¦é‡è¯•è¾¾åˆ°æ•°æ®æœ€ç»ˆä¸€è‡´æ€§
    * å¯¹äº**æœ€å¤§åŠªåŠ›å‹äº‹åŠ¡**( TCCæš‚æœªå®ç° )ï¼Œä¼šå¯¹æ‰§è¡Œé”™è¯¯çš„ SQL è¿›è¡Œé‡è¯•
</code></pre><ul>
<li><p>è°ƒç”¨ <code>connection.setAutoCommit(true);</code>ï¼Œè®¾ç½®æ‰§è¡Œè‡ªåŠ¨æäº¤ã€‚<strong>ä½¿ç”¨æœ€å¤§åŠªåŠ›å‹äº‹åŠ¡æ—¶ï¼Œä¸Šå±‚ä¸šåŠ¡æ‰§è¡Œ SQL ä¼šé©¬ä¸Šæäº¤ï¼Œå³ä½¿è°ƒç”¨  <code>Connection#rollback()</code> ä¹Ÿæ˜¯æ— æ³•å›æ»šçš„ï¼Œè¿™ç‚¹ä¸€å®šè¦æ³¨æ„ã€‚</strong></p>
<ul>
<li><code>#end()</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* ç»“æŸæŸ”æ€§äº‹åŠ¡.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</div><div class="line">       ExecutorExceptionHandler.setExceptionThrown(<span class="keyword">true</span>);</div><div class="line">       connection.setAutoCommit(previousAutoCommit);</div><div class="line">       SoftTransactionManager.closeCurrentTransactionManager();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SoftTransactionManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * å…³é—­å½“å‰çš„æŸ”æ€§äº‹åŠ¡ç®¡ç†å™¨.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">closeCurrentTransactionManager</span><span class="params">()</span> </span>&#123;</div><div class="line">    ExecutorDataMap.getDataMap().put(TRANSACTION, <span class="keyword">null</span>);</div><div class="line">    ExecutorDataMap.getDataMap().put(TRANSACTION_CONFIG, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>* äº‹åŠ¡ç»“æŸåï¼Œä¸€å®šè¦è®°å¾—è°ƒç”¨ `#end()` æ¸…ç†çº¿ç¨‹å˜é‡ã€‚å¦åˆ™ï¼Œä¸‹æ¬¡è¯·æ±‚ä½¿ç”¨åˆ°è¯¥çº¿ç¨‹ï¼Œä¼šç»§ç»­åœ¨è¿™ä¸ªæŸ”æ€§äº‹åŠ¡å†…ã€‚
</code></pre><p><strong>BEDSoftTransaction</strong>    </p>
<p>BEDSoftTransactionï¼Œæœ€å¤§åŠªåŠ›é€è¾¾å‹æŸ”æ€§äº‹åŠ¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BEDSoftTransaction</span> <span class="keyword">extends</span> <span class="title">AbstractSoftTransaction</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¼€å¯æŸ”æ€§äº‹åŠ¡.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> connection æ•°æ®åº“è¿æ¥å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">(<span class="keyword">final</span> Connection connection)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        beginInternal(connection, SoftTransactionType.BestEffortsDelivery);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>TCCSoftTransaction</strong></p>
<p>TCCSoftTransactionï¼ŒTCC å‹æŸ”æ€§äº‹åŠ¡ï¼Œæš‚æœªå®ç°ã€‚å®ç°åï¼Œä¼šæ›´æ–°åˆ° <a href="http://www.yunai.me/Sharding-JDBC/transaction-tcc/?self">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆäºŒï¼‰ä¹‹äº‹åŠ¡è¡¥å¿å‹ã€‹</a>ã€‚</p>
<hr>
<h3 id="3-3-1-åˆ›å»ºæŸ”æ€§äº‹åŠ¡"><a href="#3-3-1-åˆ›å»ºæŸ”æ€§äº‹åŠ¡" class="headerlink" title="3.3.1 åˆ›å»ºæŸ”æ€§äº‹åŠ¡"></a>3.3.1 åˆ›å»ºæŸ”æ€§äº‹åŠ¡</h3><p>é€šè¿‡è°ƒç”¨ <code>SoftTransactionManager#getTransaction()</code> åˆ›å»ºæŸ”æ€§äº‹åŠ¡å¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* &#123;<span class="doctag">@link</span> ExecutorDataMap#dataMap&#125; æŸ”æ€§äº‹åŠ¡å¯¹è±¡ key</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRANSACTION = <span class="string">"transaction"</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line">* &#123;<span class="doctag">@link</span> ExecutorDataMap#dataMap&#125; æŸ”æ€§äº‹åŠ¡é…ç½® key</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRANSACTION_CONFIG = <span class="string">"transactionConfig"</span>;</div><div class="line"></div><div class="line"><span class="comment">// SoftTransactionManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ›å»ºæŸ”æ€§äº‹åŠ¡.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> type æŸ”æ€§äº‹åŠ¡ç±»å‹</div><div class="line">* <span class="doctag">@return</span> æŸ”æ€§äº‹åŠ¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> AbstractSoftTransaction <span class="title">getTransaction</span><span class="params">(<span class="keyword">final</span> SoftTransactionType type)</span> </span>&#123;</div><div class="line">   AbstractSoftTransaction result;</div><div class="line">   <span class="keyword">switch</span> (type) &#123;</div><div class="line">       <span class="keyword">case</span> BestEffortsDelivery: </div><div class="line">           result = <span class="keyword">new</span> BEDSoftTransaction();</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> TryConfirmCancel:</div><div class="line">           result = <span class="keyword">new</span> TCCSoftTransaction();</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">default</span>: </div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(type.toString());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// TODO ç›®å‰ä½¿ç”¨ä¸æ”¯æŒåµŒå¥—äº‹åŠ¡ï¼Œä»¥åè¿™é‡Œéœ€è¦å¯é…ç½®</span></div><div class="line">   <span class="keyword">if</span> (getCurrentTransaction().isPresent()) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support nested transaction."</span>);</div><div class="line">   &#125;</div><div class="line">   ExecutorDataMap.getDataMap().put(TRANSACTION, result);</div><div class="line">   ExecutorDataMap.getDataMap().put(TRANSACTION_CONFIG, transactionConfig);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>åç»­å¯ä»¥ä» <a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/884b38f4c2402e31464d15b444f4b405e07fe211/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/executor/threadlocal/ExecutorDataMap.java" rel="external nofollow noopener noreferrer" target="_blank">ExecutorDataMap</a> ä¸­è·å–å½“å‰çº¿ç¨‹çš„æŸ”æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡é…ç½®ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SoftTransactionManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–å½“å‰çº¿ç¨‹çš„æŸ”æ€§äº‹åŠ¡é…ç½®.</div><div class="line">* </div><div class="line">* <span class="doctag">@return</span> å½“å‰çº¿ç¨‹çš„æŸ”æ€§äº‹åŠ¡é…ç½®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Optional&lt;SoftTransactionConfiguration&gt; <span class="title">getCurrentTransactionConfiguration</span><span class="params">()</span> </span>&#123;</div><div class="line">   Object transactionConfig = ExecutorDataMap.getDataMap().get(TRANSACTION_CONFIG);</div><div class="line">   <span class="keyword">return</span> (<span class="keyword">null</span> == transactionConfig)</div><div class="line">           ? Optional.&lt;SoftTransactionConfiguration&gt;absent()</div><div class="line">           : Optional.of((SoftTransactionConfiguration) transactionConfig);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–å½“å‰çš„æŸ”æ€§äº‹åŠ¡.</div><div class="line">* </div><div class="line">* <span class="doctag">@return</span> å½“å‰çš„æŸ”æ€§äº‹åŠ¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Optional&lt;AbstractSoftTransaction&gt; <span class="title">getCurrentTransaction</span><span class="params">()</span> </span>&#123;</div><div class="line">   Object transaction = ExecutorDataMap.getDataMap().get(TRANSACTION);</div><div class="line">   <span class="keyword">return</span> (<span class="keyword">null</span> == transaction)</div><div class="line">           ? Optional.&lt;AbstractSoftTransaction&gt;absent()</div><div class="line">           : Optional.of((AbstractSoftTransaction) transaction);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="4-äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨"><a href="#4-äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨" class="headerlink" title="4. äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨"></a>4. äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨</h1><p>æŸ”æ€§äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šé€šè¿‡äº‹åŠ¡æ—¥å¿—( TransactionLog ) è®°å½•æ¯æ¡ SQL æ‰§è¡ŒçŠ¶æ€ï¼š</p>
<ul>
<li>SQL æ‰§è¡Œå‰ï¼Œè®°å½•ä¸€æ¡äº‹åŠ¡æ—¥å¿—</li>
<li>SQL æ‰§è¡ŒæˆåŠŸï¼Œç§»é™¤å¯¹åº”çš„äº‹åŠ¡æ—¥å¿— </li>
</ul>
<p>é€šè¿‡å®ç°äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨æ¥å£( TransactionLogStorage )ï¼Œæä¾›å­˜å‚¨åŠŸèƒ½ã€‚ç›®å‰æœ‰ä¸¤ç§å®ç°ï¼š</p>
<ul>
<li>MemoryTransactionLogStorage ï¼šåŸºäº<strong>å†…å­˜</strong>çš„äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨ã€‚ä¸»è¦ç”¨äºå¼€å‘æµ‹è¯•ï¼Œ<strong>ç”Ÿäº§ç¯å¢ƒä¸‹ä¸è¦ä½¿ç”¨</strong>ã€‚</li>
<li>RdbTransactionLogStorage ï¼šåŸºäº<strong>æ•°æ®åº“</strong>çš„äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨ã€‚</li>
</ul>
<p>æœ¬èŠ‚åªåˆ†æ RdbTransactionLogStorageã€‚å¯¹ <a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/884b38f4c2402e31464d15b444f4b405e07fe211/sharding-jdbc-transaction-parent/sharding-jdbc-transaction-storage/src/main/java/com/dangdang/ddframe/rdb/transaction/soft/storage/impl/RdbTransactionLogStorage.java" rel="external nofollow noopener noreferrer" target="_blank">MemoryTransactionLogStorage</a> æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç‚¹å‡»é“¾æ¥ä¼ é€åˆ°è¾¾ã€‚</p>
<p><strong>TransactionLogStorage æœ‰äº”ä¸ªæ¥å£æ–¹æ³•ï¼Œä¸‹æ–‡æ¯ä¸ªå°æ ‡é¢˜éƒ½æ˜¯ä¸€ä¸ªæ–¹æ³•ã€‚</strong></p>
<h2 id="4-1-add"><a href="#4-1-add" class="headerlink" title="4.1 #add()"></a>4.1 #add()</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionLogStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å­˜å‚¨äº‹åŠ¡æ—¥å¿—.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> transactionLog äº‹åŠ¡æ—¥å¿—</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(TransactionLog transactionLog)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">// RdbTransactionLogStorage.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> TransactionLog transactionLog)</span> </span>&#123;</div><div class="line">   String sql = <span class="string">"INSERT INTO `transaction_log` (`id`, `transaction_type`, `data_source`, `sql`, `parameters`, `creation_time`) VALUES (?, ?, ?, ?, ?, ?);"</span>;</div><div class="line">   <span class="keyword">try</span> (</div><div class="line">    <span class="comment">// ... çœç•¥ä½ ç†Ÿæ‚‰çš„ä»£ç </span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> TransactionLogStorageException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>TransactionLog (transaction_log) æ•°æ®åº“è¡¨ç»“æ„å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>åå­—</th>
<th>æ•°æ®åº“ç±»å‹</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>äº‹ä»¶ç¼–å·</td>
<td>VARCHAR(40)</td>
<td>EventBus äº‹ä»¶ç¼–å·ï¼Œ<strong>éäº‹åŠ¡ç¼–å·</strong></td>
</tr>
<tr>
<td>transaction_type</td>
<td>æŸ”æ€§äº‹åŠ¡ç±»å‹</td>
<td>VARCHAR(30)</td>
</tr>
<tr>
<td>data_source</td>
<td>æ•°æ®æºå</td>
<td>VARCHAR(255)</td>
<td></td>
</tr>
<tr>
<td>sql</td>
<td>SQL</td>
<td>TEXT</td>
</tr>
<tr>
<td>parameters</td>
<td>å ä½ç¬¦å‚æ•°</td>
<td>TEXT</td>
<td>JSON å­—ç¬¦ä¸²å­˜å‚¨</td>
</tr>
<tr>
<td>creation_time</td>
<td>è®°å½•æ—¶é—´</td>
<td>LONG</td>
</tr>
<tr>
<td>async_delivery_try_times</td>
<td>å·²å¼‚æ­¥é‡è¯•æ¬¡æ•°</td>
<td>INT</td>
</tr>
</tbody>
</table>
<p>// TODO æ’å…¥å¤±è´¥ï¼Œæ˜¯ä¸æ˜¯æ­»å¾ªç¯äº†ã€‚</p>
<h2 id="4-2-remove"><a href="#4-2-remove" class="headerlink" title="4.2 #remove()"></a>4.2 #remove()</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionLogStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">*Â æ ¹æ®ä¸»é”®åˆ é™¤äº‹åŠ¡æ—¥å¿—.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> id äº‹åŠ¡æ—¥å¿—ä¸»é”®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(String id)</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">// RdbTransactionLogStorage.java    </span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> String id)</span> </span>&#123;</div><div class="line">   String sql = <span class="string">"DELETE FROM `transaction_log` WHERE `id`=?;"</span>;</div><div class="line">   <span class="keyword">try</span> (</div><div class="line">          <span class="comment">// ... çœç•¥ä½ ç†Ÿæ‚‰çš„ä»£ç </span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> TransactionLogStorageException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-3-findEligibleTransactionLogs"><a href="#4-3-findEligibleTransactionLogs" class="headerlink" title="4.3 #findEligibleTransactionLogs()"></a>4.3 #findEligibleTransactionLogs()</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionLogStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è¯»å–éœ€è¦å¤„ç†çš„äº‹åŠ¡æ—¥å¿—.</div><div class="line">* </div><div class="line">* &lt;p&gt;éœ€è¦å¤„ç†çš„äº‹åŠ¡æ—¥å¿—ä¸º: &lt;/p&gt;</div><div class="line">* &lt;p&gt;1. å¼‚æ­¥å¤„ç†æ¬¡æ•°å°äºæœ€å¤§å¤„ç†æ¬¡æ•°.&lt;/p&gt;</div><div class="line">* &lt;p&gt;2. å¼‚æ­¥å¤„ç†çš„äº‹åŠ¡æ—¥å¿—æ—©äºå¼‚æ­¥å¤„ç†çš„é—´éš”æ—¶é—´.&lt;/p&gt;</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> size è·å–æ—¥å¿—çš„æ•°é‡</div><div class="line">* <span class="doctag">@param</span> maxDeliveryTryTimes äº‹åŠ¡é€è¾¾çš„æœ€å¤§å°è¯•æ¬¡æ•°</div><div class="line">* <span class="doctag">@param</span> maxDeliveryTryDelayMillis æ‰§è¡Œé€è¾¾äº‹åŠ¡çš„å»¶è¿Ÿæ¯«ç§’æ•°.</div><div class="line">*/</div><div class="line"><span class="function">List&lt;TransactionLog&gt; <span class="title">findEligibleTransactionLogs</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> maxDeliveryTryTimes, <span class="keyword">long</span> maxDeliveryTryDelayMillis)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">// RdbTransactionLogStorage.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;TransactionLog&gt; <span class="title">findEligibleTransactionLogs</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> size, <span class="keyword">final</span> <span class="keyword">int</span> maxDeliveryTryTimes, <span class="keyword">final</span> <span class="keyword">long</span> maxDeliveryTryDelayMillis)</span> </span>&#123;</div><div class="line">   List&lt;TransactionLog&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(size);</div><div class="line">   String sql = <span class="string">"SELECT `id`, `transaction_type`, `data_source`, `sql`, `parameters`, `creation_time`, `async_delivery_try_times` "</span></div><div class="line">       + <span class="string">"FROM `transaction_log` WHERE `async_delivery_try_times`&lt;? AND `transaction_type`=? AND `creation_time`&lt;? LIMIT ?;"</span>;</div><div class="line">   <span class="keyword">try</span> (Connection conn = dataSource.getConnection()) &#123;</div><div class="line">       <span class="comment">// ... çœç•¥ä½ ç†Ÿæ‚‰çš„ä»£ç </span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> TransactionLogStorageException(ex);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-4-increaseAsyncDeliveryTryTimes"><a href="#4-4-increaseAsyncDeliveryTryTimes" class="headerlink" title="4.4 #increaseAsyncDeliveryTryTimes()"></a>4.4 #increaseAsyncDeliveryTryTimes()</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionLogStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å¢åŠ äº‹åŠ¡æ—¥å¿—å¼‚æ­¥é‡è¯•æ¬¡æ•°.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> id äº‹åŠ¡ä¸»é”®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">increaseAsyncDeliveryTryTimes</span><span class="params">(String id)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">// RdbTransactionLogStorage.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increaseAsyncDeliveryTryTimes</span><span class="params">(<span class="keyword">final</span> String id)</span> </span>&#123;</div><div class="line">   String sql = <span class="string">"UPDATE `transaction_log` SET `async_delivery_try_times`=`async_delivery_try_times`+1 WHERE `id`=?;"</span>;</div><div class="line">   <span class="keyword">try</span> (</div><div class="line">       <span class="comment">// ... çœç•¥ä½ ç†Ÿæ‚‰çš„ä»£ç </span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> TransactionLogStorageException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-5-processData"><a href="#4-5-processData" class="headerlink" title="4.5 #processData()"></a>4.5 #processData()</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionLogStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å¤„ç†äº‹åŠ¡æ•°æ®.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> connection ä¸šåŠ¡æ•°æ®åº“è¿æ¥</div><div class="line">* <span class="doctag">@param</span> transactionLog äº‹åŠ¡æ—¥å¿—</div><div class="line">* <span class="doctag">@param</span> maxDeliveryTryTimes äº‹åŠ¡é€è¾¾çš„æœ€å¤§å°è¯•æ¬¡æ•°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">processData</span><span class="params">(Connection connection, TransactionLog transactionLog, <span class="keyword">int</span> maxDeliveryTryTimes)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">// RdbTransactionLogStorage.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">processData</span><span class="params">(<span class="keyword">final</span> Connection connection, <span class="keyword">final</span> TransactionLog transactionLog, <span class="keyword">final</span> <span class="keyword">int</span> maxDeliveryTryTimes)</span> </span>&#123;</div><div class="line">   <span class="comment">// é‡è¯•æ‰§è¡Œå¤±è´¥ SQL</span></div><div class="line">   <span class="keyword">try</span> (</div><div class="line">       Connection conn = connection;</div><div class="line">       PreparedStatement preparedStatement = conn.prepareStatement(transactionLog.getSql())) &#123;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> parameterIndex = <span class="number">0</span>; parameterIndex &lt; transactionLog.getParameters().size(); parameterIndex++) &#123;</div><div class="line">           preparedStatement.setObject(parameterIndex + <span class="number">1</span>, transactionLog.getParameters().get(parameterIndex));</div><div class="line">       &#125;</div><div class="line">       preparedStatement.executeUpdate();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">       <span class="comment">// é‡è¯•å¤±è´¥ï¼Œæ›´æ–°äº‹åŠ¡æ—¥å¿—ï¼Œå¢åŠ å·²å¼‚æ­¥é‡è¯•æ¬¡æ•°</span></div><div class="line">       increaseAsyncDeliveryTryTimes(transactionLog.getId());</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> TransactionCompensationException(ex);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç§»é™¤é‡è¯•æ‰§è¡ŒæˆåŠŸ SQL å¯¹åº”çš„äº‹åŠ¡æ—¥å¿—</span></div><div class="line">   remove(transactionLog.getId());</div><div class="line">   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä¸åŒäºå‰å››ä¸ª<strong>å¢åˆ æ”¹æŸ¥</strong>æ¥å£æ–¹æ³•çš„å®ç°ï¼Œ<code>#processData()</code> æ˜¯å¸¦æœ‰ä¸€äº›é€»è¾‘çš„ã€‚æ ¹æ®äº‹åŠ¡æ—¥å¿—( TransactionLog )é‡è¯•æ‰§è¡Œå¤±è´¥çš„ SQLï¼Œè‹¥æˆåŠŸï¼Œç§»é™¤äº‹åŠ¡æ—¥å¿—ï¼›è‹¥å¤±è´¥ï¼Œæ›´æ–°äº‹åŠ¡æ—¥å¿—ï¼Œå¢åŠ å·²å¼‚æ­¥é‡è¯•æ¬¡æ•°</li>
<li>è¯¥æ–¹æ³•ä¼šè¢«<strong>æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š</strong>è°ƒç”¨åˆ°</li>
</ul>
<h1 id="5-æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨"><a href="#5-æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨" class="headerlink" title="5. æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨"></a>5. æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨</h1><h1 id="6-æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š"><a href="#6-æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š" class="headerlink" title="6. æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š"></a>6. æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š</h1><h1 id="7-é€‚ç”¨åœºæ™¯"><a href="#7-é€‚ç”¨åœºæ™¯" class="headerlink" title="7. é€‚ç”¨åœºæ™¯"></a>7. é€‚ç”¨åœºæ™¯</h1><h1 id="8-å¼€å‘æŒ‡å—-amp-å¼€å‘ç¤ºä¾‹"><a href="#8-å¼€å‘æŒ‡å—-amp-å¼€å‘ç¤ºä¾‹" class="headerlink" title="8. å¼€å‘æŒ‡å— &amp; å¼€å‘ç¤ºä¾‹"></a>8. å¼€å‘æŒ‡å— &amp; å¼€å‘ç¤ºä¾‹</h1><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘&lt;/stron
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” JDBCå®ç°ä¸è¯»å†™åˆ†ç¦»</title>
    <link href="http://www.yunai.me/Sharding-JDBC/jdbc-implement-and-read-write-splitting/"/>
    <id>http://www.yunai.me/Sharding-JDBC/jdbc-implement-and-read-write-splitting/</id>
    <published>2017-08-17T16:00:00.000Z</published>
    <updated>2017-08-10T17:26:17.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Sharding-JDBC 1.5.0 æ­£å¼ç‰ˆ</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. unspported åŒ…</a></li>
<li><a href="#">3. adapter åŒ…</a>
<ul>
<li><a href="#">3.1 WrapperAdapter</a></li>
<li><a href="#">3.2 AbstractDataSourceAdapter</a></li>
<li><a href="#">3.3 AbstractConnectionAdapter</a></li>
<li><a href="#">3.4 AbstractStatementAdapter</a></li>
<li><a href="#">3.5 AbstractPreparedStatementAdapter</a></li>
<li><a href="#">3.6 AbstractResultSetAdapter</a></li>
</ul>
</li>
<li><a href="#">4. æ’å…¥æµç¨‹</a></li>
<li><a href="#">5. æŸ¥è¯¢æµç¨‹</a></li>
<li><a href="#">6. è¯»å†™åˆ†ç¦»</a></li>
<li><a href="#">666. <s>å½©è›‹</s></a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>JDBC</strong> ä¸ <strong>è¯»å†™åˆ†ç¦»</strong> çš„å®ç°ã€‚ä¸ºä»€ä¹ˆä¼šæŠŠè¿™ä¸¤ä¸ªä¸œè¥¿æ”¾åœ¨ä¸€èµ·è®²å‘¢ï¼Ÿå®¢æˆ·ç«¯ç›´è¿æ•°æ®åº“çš„è¯»å†™åˆ†ç¦»ä¸»è¦é€šè¿‡è·å–è¯»åº“å’Œå†™åº“çš„ä¸åŒè¿æ¥æ¥å®ç°ï¼Œå’Œ JDBC Connection åˆšå¥½æ”¾åœ¨ä¸€å—ã€‚</p>
<p>OKï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€æ®µ Sharding-JDBC å®˜æ–¹å¯¹è‡ªå·±çš„å®šä¹‰å’Œå®šä½</p>
<blockquote>
<p>Sharding-JDBCå®šä½ä¸ºè½»é‡çº§javaæ¡†æ¶ï¼Œä½¿ç”¨å®¢æˆ·ç«¯ç›´è¿æ•°æ®åº“ï¼Œä»¥jaråŒ…å½¢å¼æä¾›æœåŠ¡ï¼Œæœªä½¿ç”¨ä¸­é—´å±‚ï¼Œæ— éœ€é¢å¤–éƒ¨ç½²ï¼Œæ— å…¶ä»–ä¾èµ–ï¼ŒDBAä¹Ÿæ— éœ€æ”¹å˜åŸæœ‰çš„è¿ç»´æ–¹å¼ï¼Œå¯ç†è§£ä¸º<strong>å¢å¼ºç‰ˆçš„JDBCé©±åŠ¨</strong>ï¼Œæ—§ä»£ç è¿ç§»æˆæœ¬å‡ ä¹ä¸ºé›¶ã€‚</p>
</blockquote>
<p>å¯ä»¥çœ‹å‡ºï¼ŒSharding-JDBC é€šè¿‡å®ç° <strong>JDBCè§„èŒƒ</strong>ï¼Œå¯¹ä¸Šå±‚æä¾›é€æ˜åŒ–æ•°æ®åº“åˆ†åº“åˆ†è¡¨çš„è®¿é—®ã€‚ğŸ˜ˆ é»‘ç§‘æŠ€ï¼Ÿå®é™…æˆ‘ä»¬ä½¿ç”¨çš„<strong>æ•°æ®åº“è¿æ¥æ± </strong>ä¹Ÿæ˜¯é€šè¿‡è¿™ç§æ–¹å¼å®ç°å¯¹ä¸Šå±‚æ— æ„ŸçŸ¥çš„æä¾›è¿æ¥æ± ã€‚ç”šè‡³è¿˜å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼å®ç°å¯¹ Luceneã€<a href="http://www.yunai.me/MyCAT/connect-mongodb/?self">MongoDB</a> ç­‰ç­‰çš„è®¿é—®ã€‚</p>
<p>æ‰¯è¿œäº†ï¼Œä¸‹é¢æ¥çœ‹çœ‹ Sharding-JDBC <code>jdbc</code> åŒ…çš„ç»“æ„ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_18/01.png" alt=""></p>
<ul>
<li><code>unsupported</code>ï¼šå£°æ˜<strong>ä¸æ”¯æŒ</strong>çš„æ•°æ®æ“ä½œæ–¹æ³•</li>
<li><code>adapter</code>ï¼šé€‚é…ç±»ï¼Œå®ç°å’Œåˆ†åº“åˆ†è¡¨<strong>æ— å…³</strong>çš„æ–¹æ³•</li>
<li><code>core</code>ï¼šæ ¸å¿ƒç±»ï¼Œå®ç°å’Œåˆ†åº“åˆ†è¡¨<strong>ç›¸å…³</strong>çš„æ–¹æ³•</li>
</ul>
<p>æ ¹æ® <code>core</code> åŒ…ï¼Œå¯ä»¥çœ‹å‡ºåˆ†åˆ°å››ç§æˆ‘ä»¬<strong>è¶…çº§ç†Ÿæ‚‰</strong>çš„å¯¹è±¡</p>
<ul>
<li>
<p>Datasource</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_18/02.png" alt="-w640"></p>
</li>
<li>
<p>Connection</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_18/03.png" alt="-w640"></p>
</li>
<li>
<p>Statement</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_18/04.png" alt="-w640"></p>
</li>
<li>
<p>ResultSet</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_18/05.png" alt="-w640"></p>
</li>
</ul>
<p><strong>å®ç°</strong>å±‚çº§å¦‚ä¸‹ï¼š<strong>JDBC æ¥å£</strong> &lt;=(ç»§æ‰¿)== <strong><code>unsupported</code>æŠ½è±¡ç±»</strong> &lt;=(ç»§æ‰¿)== <strong><code>unsupported</code>æŠ½è±¡ç±»</strong> &lt;=(ç»§æ‰¿)== <strong><code>core</code>ç±»</strong>ã€‚</p>
<hr>
<p><strong>æœ¬æ–‡å†…å®¹é¡ºåº</strong></p>
<ol>
<li><code>unspported</code> åŒ…</li>
<li><code>adapter</code> åŒ…</li>
<li>æ’å…¥æµç¨‹ï¼Œåˆ†æçš„ç±»ï¼š
<ul>
<li>ShardingDataSource</li>
<li>ShardingConnection</li>
<li>ShardingPreparedStatementï¼ˆShardingStatement ç±»ä¼¼ï¼Œä¸é‡å¤åˆ†æï¼‰</li>
<li>GeneratedKeysResultSetã€GeneratedKeysResultSetMetaData</li>
</ul>
</li>
<li>æŸ¥è¯¢æµç¨‹ï¼Œåˆ†æçš„ç±»ï¼š
<ul>
<li>ShardingPreparedStatement</li>
<li>ShardingResultSet</li>
</ul>
</li>
<li>è¯»å†™åˆ†ç¦»ï¼Œåˆ†æçš„ç±»ï¼š
<ul>
<li>MasterSlaveDataSource</li>
</ul>
</li>
</ol>
<hr>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>
ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1>2. unspported åŒ…</h1>
<p><code>unspported</code> åŒ…å†…çš„<strong>æŠ½è±¡</strong>ç±»ï¼Œå£°æ˜ä¸æ”¯æŒæ“ä½œçš„æ•°æ®å¯¹è±¡ï¼Œæ‰€æœ‰æ–¹æ³•éƒ½æ˜¯ <code>throw new SQLFeatureNotSupportedException()</code> æ–¹å¼ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractUnsupportedGeneratedKeysResultSet</span> <span class="keyword">extends</span> <span class="title">AbstractUnsupportedOperationResultSet</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SQLFeatureNotSupportedException(<span class="string">"getBoolean"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// .... çœç•¥å…¶å®ƒç±»ä¼¼æ–¹æ³•</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractUnsupportedOperationConnection</span> <span class="keyword">extends</span> <span class="title">WrapperAdapter</span> <span class="keyword">implements</span> <span class="title">Connection</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> CallableStatement <span class="title">prepareCall</span><span class="params">(<span class="keyword">final</span> String sql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SQLFeatureNotSupportedException(<span class="string">"prepareCall"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">   <span class="comment">// .... çœç•¥å…¶å®ƒç±»ä¼¼æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>3. adapter åŒ…</h1>
<p><code>adapter</code> åŒ…å†…çš„<strong>æŠ½è±¡</strong>ç±»ï¼Œå®ç°å’Œåˆ†åº“åˆ†è¡¨<strong>æ— å…³</strong>çš„æ–¹æ³•ã€‚</p>
<p><strong>è€ƒè™‘åˆ°ç¬¬4ã€5ä¸¤å°èŠ‚æ›´å®¹æ˜“ç†è§£ï¼Œæœ¬å°èŠ‚è´´çš„ä»£ç ä¼šç›¸å¯¹å¤š</strong></p>
<h2>3.1 WrapperAdapter</h2>
<p><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/jdbc/adapter/WrapperAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">WrapperAdapter</a>ï¼ŒJDBC Wrapper é€‚é…ç±»ã€‚</p>
<p><strong>å¯¹ Wrapper æ¥å£å®ç°å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•</strong>ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> &lt;T&gt; <span class="function">T <span class="title">unwrap</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; iface)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">if</span> (isWrapperFor(iface)) &#123;</div><div class="line">       <span class="keyword">return</span> (T) <span class="keyword">this</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(String.format(<span class="string">"[%s] cannot be unwrapped as [%s]"</span>, getClass().getName(), iface.getName()));</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isWrapperFor</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; iface)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">return</span> iface.isInstance(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>æä¾›å­ç±» <code>#recordMethodInvocation()</code> è®°å½•æ–¹æ³•è°ƒç”¨ï¼Œ<code>#replayMethodsInvocation()</code> å›æ”¾è®°å½•çš„æ–¹æ³•è°ƒç”¨</strong>ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®°å½•çš„æ–¹æ³•æ•°ç»„</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Collection&lt;JdbcMethodInvocation&gt; jdbcMethodInvocations = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®°å½•æ–¹æ³•è°ƒç”¨.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> targetClass ç›®æ ‡ç±»</div><div class="line">* <span class="doctag">@param</span> methodName æ–¹æ³•åç§°</div><div class="line">* <span class="doctag">@param</span> argumentTypes å‚æ•°ç±»å‹</div><div class="line">* <span class="doctag">@param</span> arguments å‚æ•°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">recordMethodInvocation</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; targetClass, <span class="keyword">final</span> String methodName, <span class="keyword">final</span> Class&lt;?&gt;[] argumentTypes, <span class="keyword">final</span> Object[] arguments)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       jdbcMethodInvocations.add(<span class="keyword">new</span> JdbcMethodInvocation(targetClass.getMethod(methodName, argumentTypes), arguments));</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> NoSuchMethodException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ShardingJdbcException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line">* å›æ”¾è®°å½•çš„æ–¹æ³•è°ƒç”¨.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> target ç›®æ ‡å¯¹è±¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">replayMethodsInvocation</span><span class="params">(<span class="keyword">final</span> Object target)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (JdbcMethodInvocation each : jdbcMethodInvocations) &#123;</div><div class="line">       each.invoke(target);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>è¿™ä¸¤ä¸ªæ–¹æ³•æœ‰ä»€ä¹ˆç”¨é€”å‘¢ï¼Ÿä¾‹å¦‚ä¸‹æ–‡ä¼šæåˆ°çš„ AbstractConnectionAdapter çš„ <code>#setAutoCommit()</code>ï¼Œå½“å®ƒæ— æ•°æ®åº“è¿æ¥æ—¶ï¼Œå…ˆè®°å½•ï¼›ç­‰è·å¾—åˆ°æ•°æ®è¿æ¥åï¼Œå†å›æ”¾ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractConnectionAdapter.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setAutoCommit</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> autoCommit)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">this</span>.autoCommit = autoCommit;</div><div class="line">   <span class="keyword">if</span> (getConnections().isEmpty()) &#123; <span class="comment">// æ— æ•°æ®è¿æ¥æ—¶ï¼Œè®°å½•æ–¹æ³•è°ƒç”¨</span></div><div class="line">       recordMethodInvocation(Connection.class, <span class="string">"setAutoCommit"</span>, <span class="keyword">new</span> Class[] &#123;<span class="keyword">boolean</span>.class&#125;, <span class="keyword">new</span> Object[] &#123;autoCommit&#125;);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       each.setAutoCommit(autoCommit);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<ul>
<li>
<p>JdbcMethodInvocationï¼Œåå°„è°ƒç”¨JDBCç›¸å…³æ–¹æ³•çš„å·¥å…·ç±»ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcMethodInvocation</span> </span>&#123;</div><div class="line">    </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * æ–¹æ³•</div><div class="line">    */</div><div class="line">   <span class="meta">@Getter</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Method method;</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * æ–¹æ³•å‚æ•°</div><div class="line">    */</div><div class="line">   <span class="meta">@Getter</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Object[] arguments;</div><div class="line">   </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Â è°ƒç”¨æ–¹æ³•.</div><div class="line">    * </div><div class="line">    * <span class="doctag">@param</span> target ç›®æ ‡å¯¹è±¡</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(<span class="keyword">final</span> Object target)</span> </span>&#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           method.invoke(target, arguments); <span class="comment">// åå°„è°ƒç”¨</span></div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IllegalAccessException | InvocationTargetException ex) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> ShardingJdbcException(<span class="string">"Invoke jdbc method exception"</span>, ex);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<p><strong>æä¾›å­ç±» <code>#throwSQLExceptionIfNecessary()</code> æŠ›å‡ºå¼‚å¸¸é“¾</strong>ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">throwSQLExceptionIfNecessary</span><span class="params">(<span class="keyword">final</span> Collection&lt;SQLException&gt; exceptions)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">if</span> (exceptions.isEmpty()) &#123; <span class="comment">// ä¸ºç©ºä¸æŠ›å‡ºå¼‚å¸¸</span></div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   SQLException ex = <span class="keyword">new</span> SQLException();</div><div class="line">   <span class="keyword">for</span> (SQLException each : exceptions) &#123;</div><div class="line">       ex.setNextException(each); <span class="comment">// å¼‚å¸¸é“¾</span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> ex;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.2 AbstractDataSourceAdapter</h2>
<p><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/jdbc/adapter/AbstractDataSourceAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractDataSourceAdapter</a>ï¼Œæ•°æ®æºé€‚é…ç±»ã€‚</p>
<p>ç›´æ¥ç‚¹å‡»é“¾æ¥æŸ¥çœ‹æºç ã€‚</p>
<h2>3.3 AbstractConnectionAdapter</h2>
<p><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/jdbc/adapter/AbstractConnectionAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractConnectionAdapter</a>ï¼Œæ•°æ®åº“è¿æ¥é€‚é…ç±»ã€‚</p>
<p>æˆ‘ä»¬æ¥ç…ç…å¤§å®¶æœ€å…³å¿ƒçš„<strong>äº‹åŠ¡</strong>ç›¸å…³æ–¹æ³•çš„å®ç°ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦è‡ªåŠ¨æäº¤</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> autoCommit = <span class="keyword">true</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—é“¾æ¥</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> é“¾æ¥</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Collection&lt;Connection&gt; <span class="title">getConnections</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">getAutoCommit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">return</span> autoCommit;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setAutoCommit</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> autoCommit)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">this</span>.autoCommit = autoCommit;</div><div class="line">   <span class="keyword">if</span> (getConnections().isEmpty()) &#123; <span class="comment">// æ— æ•°æ®è¿æ¥æ—¶ï¼Œè®°å½•æ–¹æ³•è°ƒç”¨</span></div><div class="line">       recordMethodInvocation(Connection.class, <span class="string">"setAutoCommit"</span>, <span class="keyword">new</span> Class[] &#123;<span class="keyword">boolean</span>.class&#125;, <span class="keyword">new</span> Object[] &#123;autoCommit&#125;);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       each.setAutoCommit(autoCommit);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#setAutoCommit()</code> è°ƒç”¨æ—¶ï¼Œå®é™…ä¼šè®¾ç½®å…¶æ‰€æŒæœ‰çš„ Connection çš„ <code>autoCommit</code> å±æ€§</li>
<li><code>#getConnections()</code> å’Œåˆ†åº“åˆ†è¡¨ç›¸å…³ï¼Œå› è€Œä»…æŠ½è±¡è¯¥æ–¹æ³•ï¼Œç•™ç»™å­ç±»å®ç°</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       each.commit();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   Collection&lt;SQLException&gt; exceptions = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           each.rollback();</div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">           exceptions.add(ex);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   throwSQLExceptionIfNecessary(exceptions);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#commit()</code>ã€<code>#rollback()</code> è°ƒç”¨æ—¶ï¼Œå®é™…è°ƒç”¨å…¶æ‰€æŒæœ‰çš„ Connection çš„æ–¹æ³•</li>
<li>å¼‚å¸¸æƒ…å†µä¸‹ï¼Œ<code>#commit()</code> å’Œ <code>#rollback()</code> å¤„ç†æ–¹å¼ä¸åŒï¼Œç¬”è€…æš‚æ—¶ä¸çŸ¥é“ç­”æ¡ˆï¼Œæ±‚è¯åä¼šè¿›è¡Œæ›´æ–°</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* åªè¯»</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> readOnly = <span class="keyword">true</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line">* äº‹åŠ¡çº§åˆ«</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> transactionIsolation = TRANSACTION_READ_UNCOMMITTED;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setReadOnly</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> readOnly)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">this</span>.readOnly = readOnly;</div><div class="line">   <span class="keyword">if</span> (getConnections().isEmpty()) &#123;</div><div class="line">       recordMethodInvocation(Connection.class, <span class="string">"setReadOnly"</span>, <span class="keyword">new</span> Class[] &#123;<span class="keyword">boolean</span>.class&#125;, <span class="keyword">new</span> Object[] &#123;readOnly&#125;);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       each.setReadOnly(readOnly);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setTransactionIsolation</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> level)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   transactionIsolation = level;</div><div class="line">   <span class="keyword">if</span> (getConnections().isEmpty()) &#123;</div><div class="line">       recordMethodInvocation(Connection.class, <span class="string">"setTransactionIsolation"</span>, <span class="keyword">new</span> Class[] &#123;<span class="keyword">int</span>.class&#125;, <span class="keyword">new</span> Object[] &#123;level&#125;);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       each.setTransactionIsolation(level);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.4 AbstractStatementAdapter</h2>
<p><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/jdbc/adapter/AbstractStatementAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractStatementAdapter</a>ï¼Œé™æ€è¯­å¥å¯¹è±¡é€‚é…ç±»ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getUpdateCount</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">long</span> result = <span class="number">0</span>;</div><div class="line">   <span class="keyword">boolean</span> hasResult = <span class="keyword">false</span>;</div><div class="line">   <span class="keyword">for</span> (Statement each : getRoutedStatements()) &#123;</div><div class="line">       <span class="keyword">if</span> (each.getUpdateCount() &gt; -<span class="number">1</span>) &#123;</div><div class="line">           hasResult = <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       result += each.getUpdateCount();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (result &gt; Integer.MAX_VALUE) &#123;</div><div class="line">       result = Integer.MAX_VALUE;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> hasResult ? Long.valueOf(result).intValue() : -<span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–è·¯ç”±çš„é™æ€è¯­å¥å¯¹è±¡é›†åˆ.</div><div class="line">* </div><div class="line">* <span class="doctag">@return</span> è·¯ç”±çš„é™æ€è¯­å¥å¯¹è±¡é›†åˆ</div><div class="line">*/</div><div class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> Collection&lt;? extends Statement&gt; getRoutedStatements();</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#getUpdateCount()</code> è°ƒç”¨æŒæœ‰çš„ Statement è®¡ç®—æ›´æ–°æ•°é‡</li>
<li><code>#getRoutedStatements()</code> å’Œåˆ†åº“åˆ†è¡¨ç›¸å…³ï¼Œå› è€Œä»…æŠ½è±¡è¯¥æ–¹æ³•ï¼Œç•™ç»™å­ç±»å®ç°</li>
</ul>
<h2>3.5 AbstractPreparedStatementAdapter</h2>
<p><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/jdbc/adapter/AbstractPreparedStatementAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractPreparedStatementAdapter</a>ï¼Œé¢„ç¼–è¯‘è¯­å¥å¯¹è±¡çš„é€‚é…ç±»ã€‚</p>
<p><strong><code>#recordSetParameter()</code>å®ç°å¯¹å ä½ç¬¦å‚æ•°çš„è®¾ç½®</strong>ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* è®°å½•çš„è®¾ç½®å‚æ•°æ–¹æ³•æ•°ç»„</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;SetParameterMethodInvocation&gt; setParameterMethodInvocations = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line"><span class="comment">/**</span></div><div class="line">* å‚æ•°</div><div class="line">*/</div><div class="line"><span class="meta">@Getter</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; parameters = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setInt</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> parameterIndex, <span class="keyword">final</span> <span class="keyword">int</span> x)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   setParameter(parameterIndex, x);</div><div class="line">   recordSetParameter(<span class="string">"setInt"</span>, <span class="keyword">new</span> Class[]&#123;<span class="keyword">int</span>.class, <span class="keyword">int</span>.class&#125;, parameterIndex, x);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®°å½•å ä½ç¬¦å‚æ•°</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> parameterIndex å ä½ç¬¦å‚æ•°ä½ç½®</div><div class="line">* <span class="doctag">@param</span> value å‚æ•°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setParameter</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> parameterIndex, <span class="keyword">final</span> Object value)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (parameters.size() == parameterIndex - <span class="number">1</span>) &#123;</div><div class="line">       parameters.add(value);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = parameters.size(); i &lt;= parameterIndex - <span class="number">1</span>; i++) &#123; <span class="comment">// ç”¨ null å¡«å……å‰é¢æœªè®¾ç½®çš„ä½ç½®</span></div><div class="line">       parameters.add(<span class="keyword">null</span>);</div><div class="line">   &#125;</div><div class="line">   parameters.set(parameterIndex - <span class="number">1</span>, value);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®°å½•è®¾ç½®å‚æ•°æ–¹æ³•è°ƒç”¨</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> methodName æ–¹æ³•åï¼Œä¾‹å¦‚ setIntã€setLong ç­‰</div><div class="line">* <span class="doctag">@param</span> argumentTypes å‚æ•°ç±»å‹</div><div class="line">* <span class="doctag">@param</span> arguments å‚æ•°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recordSetParameter</span><span class="params">(<span class="keyword">final</span> String methodName, <span class="keyword">final</span> Class[] argumentTypes, <span class="keyword">final</span> Object... arguments)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       setParameterMethodInvocations.add(<span class="keyword">new</span> SetParameterMethodInvocation(PreparedStatement.class.getMethod(methodName, argumentTypes), arguments, arguments[<span class="number">1</span>]));</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> NoSuchMethodException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ShardingJdbcException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* å›æ”¾è®°å½•çš„è®¾ç½®å‚æ•°æ–¹æ³•è°ƒç”¨</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> preparedStatement é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">replaySetParameter</span><span class="params">(<span class="keyword">final</span> PreparedStatement preparedStatement)</span> </span>&#123;</div><div class="line">   addParameters();</div><div class="line">   <span class="keyword">for</span> (SetParameterMethodInvocation each : setParameterMethodInvocations) &#123;</div><div class="line">       updateParameterValues(each, parameters.get(each.getIndex() - <span class="number">1</span>)); <span class="comment">// åŒä¸€ä¸ªä½ç½®å¤šæ¬¡è®¾ç½®ï¼Œå€¼å¯èƒ½ä¸ä¸€æ ·ï¼Œéœ€è¦æ›´æ–°ä¸‹</span></div><div class="line">       each.invoke(preparedStatement);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* å½“ä½¿ç”¨åˆ†å¸ƒå¼ä¸»é”®æ—¶ï¼Œç”Ÿæˆåä¼šæ·»åŠ åˆ° parametersï¼Œæ­¤æ—¶ parameters æ•°é‡å¤šäº setParameterMethodInvocationsï¼Œéœ€è¦ç”Ÿæˆè¯¥åˆ†å¸ƒå¼ä¸»é”®çš„ SetParameterMethodInvocation</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addParameters</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = setParameterMethodInvocations.size(); i &lt; parameters.size(); i++) &#123;</div><div class="line">       recordSetParameter(<span class="string">"setObject"</span>, <span class="keyword">new</span> Class[]&#123;<span class="keyword">int</span>.class, Object.class&#125;, i + <span class="number">1</span>, parameters.get(i));</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateParameterValues</span><span class="params">(<span class="keyword">final</span> SetParameterMethodInvocation setParameterMethodInvocation, <span class="keyword">final</span> Object value)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!Objects.equals(setParameterMethodInvocation.getValue(), value)) &#123;</div><div class="line">       setParameterMethodInvocation.changeValueArgument(value); <span class="comment">// ä¿®æ”¹å ä½ç¬¦å‚æ•°</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>é€»è¾‘ç±»ä¼¼ <code>WrapperAdapter</code> çš„ <code>#recordMethodInvocation()</code>ï¼Œ<code>#replayMethodsInvocation()</code>ï¼Œè¯·<strong>è®¤çœŸ</strong>é˜…è¯»ä»£ç æ³¨é‡Š</p>
</li>
<li>
<p>SetParameterMethodInvocationï¼Œç»§æ‰¿ JdbcMethodInvocationï¼Œåå°„è°ƒç”¨å‚æ•°è®¾ç½®æ–¹æ³•çš„å·¥å…·ç±»ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SetParameterMethodInvocation</span> <span class="keyword">extends</span> <span class="title">JdbcMethodInvocation</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å‚æ•°å€¼</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object value;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è®¾ç½®å‚æ•°å€¼.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> value å‚æ•°å€¼</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changeValueArgument</span><span class="params">(<span class="keyword">final</span> Object value)</span> </span>&#123;</div><div class="line">        getArguments()[<span class="number">1</span>] = value;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<h2>3.6 AbstractResultSetAdapter</h2>
<p><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/jdbc/adapter/AbstractResultSetAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractResultSetAdapter</a>ï¼Œä»£ç†ç»“æœé›†é€‚é…å™¨ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractResultSetAdapter</span> <span class="keyword">extends</span> <span class="title">AbstractUnsupportedOperationResultSet</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç»“æœé›†é›†åˆ</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ResultSet&gt; resultSets;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="comment">// TODO should return sharding statement in future</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Statement <span class="title">getStatement</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">return</span> getResultSets().get(<span class="number">0</span>).getStatement();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ResultSetMetaData <span class="title">getMetaData</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">return</span> getResultSets().get(<span class="number">0</span>).getMetaData();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findColumn</span><span class="params">(<span class="keyword">final</span> String columnLabel)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">return</span> getResultSets().get(<span class="number">0</span>).findColumn(columnLabel);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// .... çœç•¥å…¶å®ƒæ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>4. æ’å…¥æµç¨‹</h1>
<p>æ’å…¥ä½¿ç”¨<strong>åˆ†å¸ƒå¼ä¸»é”®</strong>ä¾‹å­ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ä»£ç ä»…ä»…æ˜¯ä¾‹å­ï¼Œç”Ÿäº§ç¯å¢ƒä¸‹è¯·æ³¨æ„å¼‚å¸¸å¤„ç†å’Œèµ„æºå…³é—­</span></div><div class="line">String sql = <span class="string">"INSERT INTO t_order(uid, nickname, pid) VALUES (1, '2', ?)"</span>;</div><div class="line">DataSource dataSource = <span class="keyword">new</span> ShardingDataSource(shardingRule);</div><div class="line">Connection conn = dataSource.getConnection();</div><div class="line">PreparedStatement ps = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS); <span class="comment">// è¿”å›ä¸»é”®éœ€è¦  Statement.RETURN_GENERATED_KEYS</span></div><div class="line">ps.setLong(<span class="number">1</span>, <span class="number">100</span>);</div><div class="line">ps.executeUpdate();</div><div class="line">ResultSet rs = ps.getGeneratedKeys();</div><div class="line"><span class="keyword">if</span> (rs.next()) &#123;</div><div class="line">    System.out.println(<span class="string">"id:"</span> + rs.getLong(<span class="number">1</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>è°ƒç”¨ <code>#executeUpdate()</code> æ–¹æ³•ï¼Œå†…éƒ¨è¿‡ç¨‹å¦‚ä¸‹</strong>ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_18/06.png" alt=""></p>
<p>æ˜¯ä¸æ˜¯å¯¹ä¸Šå±‚<strong>å®Œå…¨é€æ˜</strong>ï¼Ÿï¼æˆ‘ä»¬æ¥çœ‹çœ‹å†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingPreparedStatement.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Collection&lt;PreparedStatementUnit&gt; preparedStatementUnits = route();</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> PreparedStatementExecutor(</div><div class="line">               getShardingConnection().getShardingContext().getExecutorEngine(), getRouteResult().getSqlStatement().getType(), preparedStatementUnits, getParameters()).executeUpdate();</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       clearBatch();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p><code>#route()</code> åˆ†åº“åˆ†è¡¨è·¯ç”±ï¼Œè·å¾—é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒ( PreparedStatementUnit )é›†åˆã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PreparedStatementUnit</span> <span class="keyword">implements</span> <span class="title">BaseStatementUnit</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL æ‰§è¡Œå•å…ƒ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SQLExecutionUnit sqlExecutionUnit;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PreparedStatement statement;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
<li>
<p><code>#executeUpdate()</code> è°ƒç”¨<a href="http://www.yunai.me/Sharding-JDBC/sql-execute/?self">æ‰§è¡Œå¼•æ“</a><strong>å¹¶è¡Œ</strong>æ‰§è¡Œ<strong>å¤šä¸ª</strong>é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡ã€‚æ‰§è¡Œæ—¶ï¼Œæœ€ç»ˆè°ƒç”¨é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡( PreparedStatement )ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PreparedStatementExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">()</span> </span>&#123;</div><div class="line">   Context context = MetricsContext.start(<span class="string">"ShardingPreparedStatement-executeUpdate"</span>);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       List&lt;Integer&gt; results = executorEngine.executePreparedStatement(sqlType, preparedStatementUnits, parameters, <span class="keyword">new</span> ExecuteCallback&lt;Integer&gt;() &#123;</div><div class="line">           </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> Integer <span class="title">execute</span><span class="params">(<span class="keyword">final</span> BaseStatementUnit baseStatementUnit)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">               <span class="comment">// è°ƒç”¨ PreparedStatement#executeUpdate()</span></div><div class="line">               <span class="keyword">return</span> ((PreparedStatement) baseStatementUnit.getStatement()).executeUpdate();</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       <span class="keyword">return</span> accumulate(results);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       MetricsContext.stop(context);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<hr>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingPreparedStatement.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;PreparedStatementUnit&gt; <span class="title">route</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   Collection&lt;PreparedStatementUnit&gt; result = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">   <span class="comment">// è·¯ç”±</span></div><div class="line">   setRouteResult(routingEngine.route(getParameters()));</div><div class="line">   <span class="comment">// éå† SQL æ‰§è¡Œå•å…ƒ</span></div><div class="line">   <span class="keyword">for</span> (SQLExecutionUnit each : getRouteResult().getExecutionUnits()) &#123;</div><div class="line">       SQLType sqlType = getRouteResult().getSqlStatement().getType();</div><div class="line">       Collection&lt;PreparedStatement&gt; preparedStatements;</div><div class="line">       <span class="comment">// åˆ›å»ºå®é™…çš„ PreparedStatement</span></div><div class="line">       <span class="keyword">if</span> (SQLType.DDL == sqlType) &#123;</div><div class="line">           preparedStatements = generatePreparedStatementForDDL(each);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           preparedStatements = Collections.singletonList(generatePreparedStatement(each));</div><div class="line">       &#125;</div><div class="line">       getRoutedStatements().addAll(preparedStatements);</div><div class="line">       <span class="comment">// å›æ”¾è®¾ç½®å ä½ç¬¦å‚æ•°åˆ° PreparedStatement</span></div><div class="line">       <span class="keyword">for</span> (PreparedStatement preparedStatement : preparedStatements) &#123;</div><div class="line">           replaySetParameter(preparedStatement);</div><div class="line">           result.add(<span class="keyword">new</span> PreparedStatementUnit(each, preparedStatement));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ›å»º PreparedStatement</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlExecutionUnit SQL æ‰§è¡Œå•å…ƒ</div><div class="line">* <span class="doctag">@return</span> PreparedStatement</div><div class="line">* <span class="doctag">@throws</span> SQLException å½“ JDBC æ“ä½œå‘ç”Ÿå¼‚å¸¸æ—¶</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> PreparedStatement <span class="title">generatePreparedStatement</span><span class="params">(<span class="keyword">final</span> SQLExecutionUnit sqlExecutionUnit)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   Optional&lt;GeneratedKey&gt; generatedKey = getGeneratedKey();</div><div class="line">   <span class="comment">// è·å¾—è¿æ¥</span></div><div class="line">   Connection connection = getShardingConnection().getConnection(sqlExecutionUnit.getDataSource(), getRouteResult().getSqlStatement().getType());</div><div class="line">   <span class="comment">// å£°æ˜è¿”å›ä¸»é”®</span></div><div class="line">   <span class="keyword">if</span> (isReturnGeneratedKeys() || isReturnGeneratedKeys() &amp;&amp; generatedKey.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span> connection.prepareStatement(sqlExecutionUnit.getSql(), RETURN_GENERATED_KEYS);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> connection.prepareStatement(sqlExecutionUnit.getSql(), getResultSetType(), getResultSetConcurrency(), getResultSetHoldability());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>è°ƒç”¨ <code>#generatePreparedStatement()</code> åˆ›å»º PreparedStatementï¼Œåè°ƒç”¨ <code>#replaySetParameter()</code> å›æ”¾è®¾ç½®å ä½ç¬¦å‚æ•°åˆ° PreparedStatement</p>
</li>
<li>
<p>å½“ <strong>å£°æ˜è¿”å›ä¸»é”®</strong> æ—¶ï¼Œå³ <code>#isReturnGeneratedKeys()</code> è¿”å› <code>true</code> æ—¶ï¼Œè°ƒç”¨ <code>connection.prepareStatement(sqlExecutionUnit.getSql(), RETURN_GENERATED_KEYS)</code>ã€‚ä¸ºä»€ä¹ˆè¯¥æ–¹æ³•ä¼šè¿”å› <code>true</code>ï¼Ÿä¸Šæ–‡ä¾‹å­ <code>conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)</code></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingConnection.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> PreparedStatement <span class="title">prepareStatement</span><span class="params">(<span class="keyword">final</span> String sql, <span class="keyword">final</span> String[] columnNames)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line"> <span class="keyword">return</span> <span class="keyword">new</span> ShardingPreparedStatement(<span class="keyword">this</span>, sql, Statement.RETURN_GENERATED_KEYS);</div><div class="line">&#125;</div><div class="line">   </div><div class="line"><span class="comment">// ShardingPreparedStatement.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ShardingPreparedStatement</span><span class="params">(<span class="keyword">final</span> ShardingConnection shardingConnection, <span class="keyword">final</span> String sql, <span class="keyword">final</span> <span class="keyword">int</span> autoGeneratedKeys)</span> </span>&#123;</div><div class="line"> <span class="keyword">this</span>(shardingConnection, sql);</div><div class="line"> <span class="keyword">if</span> (RETURN_GENERATED_KEYS == autoGeneratedKeys) &#123;</div><div class="line">     markReturnGeneratedKeys();</div><div class="line"> &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">markReturnGeneratedKeys</span><span class="params">()</span> </span>&#123;</div><div class="line"> returnGeneratedKeys = <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>å£°æ˜è¿”å›ä¸»é”®</strong>åï¼Œæ’å…¥æ‰§è¡Œå®Œæˆï¼Œæˆ‘ä»¬è°ƒç”¨ <code>#getGeneratedKeys()</code> å¯ä»¥è·å¾—ä¸»é”® ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingStatement.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ResultSet <span class="title">getGeneratedKeys</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    Optional&lt;GeneratedKey&gt; generatedKey = getGeneratedKey();</div><div class="line">    <span class="comment">// åˆ†å¸ƒå¼ä¸»é”®</span></div><div class="line">    <span class="keyword">if</span> (generatedKey.isPresent() &amp;&amp; returnGeneratedKeys) &#123;</div><div class="line">         <span class="keyword">return</span> <span class="keyword">new</span> GeneratedKeysResultSet(routeResult.getGeneratedKeys().iterator(), generatedKey.get().getColumn(), <span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// æ•°æ®åº“è‡ªå¢</span></div><div class="line">    <span class="keyword">if</span> (<span class="number">1</span> == getRoutedStatements().size()) &#123;</div><div class="line">        <span class="keyword">return</span> getRoutedStatements().iterator().next().getGeneratedKeys();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> GeneratedKeysResultSet();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
<li>
<p>è°ƒç”¨ <code>ShardingConnection#getConnection()</code> æ–¹æ³•è·å¾—è¯¥ PreparedStatement å¯¹åº”çš„<strong>çœŸå®</strong>æ•°æ®åº“è¿æ¥( Connection )ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingConnection.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * æ ¹æ®æ•°æ®æºåç§°è·å–ç›¸åº”çš„æ•°æ®åº“è¿æ¥.</div><div class="line"> * </div><div class="line"> * <span class="doctag">@param</span> dataSourceName æ•°æ®æºåç§°</div><div class="line"> * <span class="doctag">@param</span> sqlType SQLè¯­å¥ç±»å‹</div><div class="line"> * <span class="doctag">@return</span> æ•°æ®åº“è¿æ¥</div><div class="line"> * <span class="doctag">@throws</span> SQLException SQLå¼‚å¸¸</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">(<span class="keyword">final</span> String dataSourceName, <span class="keyword">final</span> SQLType sqlType)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    <span class="comment">// ä»è¿æ¥ç¼“å­˜ä¸­è·å–è¿æ¥</span></div><div class="line">    Optional&lt;Connection&gt; connection = getCachedConnection(dataSourceName, sqlType);</div><div class="line">    <span class="keyword">if</span> (connection.isPresent()) &#123;</div><div class="line">        <span class="keyword">return</span> connection.get();</div><div class="line">    &#125;</div><div class="line">    Context metricsContext = MetricsContext.start(Joiner.on(<span class="string">"-"</span>).join(<span class="string">"ShardingConnection-getConnection"</span>, dataSourceName));</div><div class="line">    <span class="comment">//</span></div><div class="line">    DataSource dataSource = shardingContext.getShardingRule().getDataSourceRule().getDataSource(dataSourceName);</div><div class="line">    Preconditions.checkState(<span class="keyword">null</span> != dataSource, <span class="string">"Missing the rule of %s in DataSourceRule"</span>, dataSourceName);</div><div class="line">    String realDataSourceName;</div><div class="line">    <span class="keyword">if</span> (dataSource <span class="keyword">instanceof</span> MasterSlaveDataSource) &#123;</div><div class="line">        dataSource = ((MasterSlaveDataSource) dataSource).getDataSource(sqlType);</div><div class="line">        realDataSourceName = MasterSlaveDataSource.getDataSourceName(dataSourceName, sqlType);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        realDataSourceName = dataSourceName;</div><div class="line">    &#125;</div><div class="line">    Connection result = dataSource.getConnection();</div><div class="line">    MetricsContext.stop(metricsContext);</div><div class="line">    <span class="comment">// æ·»åŠ åˆ°è¿æ¥ç¼“å­˜</span></div><div class="line">    connectionMap.put(realDataSourceName, result);</div><div class="line">    <span class="comment">// å›æ”¾ Connection æ–¹æ³•</span></div><div class="line">    replayMethodsInvocation(result);</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Optional&lt;Connection&gt; <span class="title">getCachedConnection</span><span class="params">(<span class="keyword">final</span> String dataSourceName, <span class="keyword">final</span> SQLType sqlType)</span> </span>&#123;</div><div class="line">    String key = connectionMap.containsKey(dataSourceName) ? dataSourceName : MasterSlaveDataSource.getDataSourceName(dataSourceName, sqlType);</div><div class="line">    <span class="keyword">return</span> Optional.fromNullable(connectionMap.get(key));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è°ƒç”¨ <code>#getCachedConnection()</code> å°è¯•è·å¾—<strong>å·²ç¼“å­˜</strong>çš„æ•°æ®åº“è¿æ¥ï¼›å¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œè·å–åˆ°è¿æ¥åä¼šè¿›è¡Œ<strong>ç¼“å­˜</strong></li>
<li>ä» ShardingRule é…ç½®çš„ DataSourceRule è·å–<strong>çœŸå®</strong>çš„æ•°æ®æº( DataSource )</li>
<li>MasterSlaveDataSource å®ç°<strong>ä¸»ä»</strong>æ•°æ®æºå°è£…ï¼Œæˆ‘ä»¬åœ¨<em>ä¸‹å°èŠ‚</em>åˆ†äº«</li>
<li>è°ƒç”¨ <code>#replayMethodsInvocation()</code> å›æ”¾è®°å½•çš„ Connection æ–¹æ³•</li>
</ul>
</li>
</ul>
<p><em>æ’å…¥å®ç°çš„ä»£ç åŸºæœ¬åˆ†äº«å®Œäº†ï¼Œå› ä¸ºæ˜¯ä¸æ–­ä»£ç ä¸‹é’»çš„æ–¹å¼åˆ†æï¼Œå¯ä»¥åå‘å‘ä¸Šåœ¨ç†ç†ï¼Œä¼šæ›´åŠ æ¸…æ™°</em>ã€‚</p>
<h1>5. æŸ¥è¯¢æµç¨‹</h1>
<p>å•çº¯ä» <code>core</code> åŒ…é‡Œçš„ JDBC å®ç°ï¼ŒæŸ¥è¯¢æµç¨‹ <code>#executeQuery()</code> å’Œ <code>#execute()</code> åŸºæœ¬ä¸€è‡´ï¼Œå·®åˆ«åœ¨äº<strong>æ‰§è¡Œ</strong>å’Œ<strong>å¤šç»“æœé›†å½’å¹¶</strong>ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ResultSet <span class="title">executeQuery</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   ResultSet result;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// è·¯ç”±</span></div><div class="line">       Collection&lt;PreparedStatementUnit&gt; preparedStatementUnits = route();</div><div class="line">       <span class="comment">// æ‰§è¡Œ</span></div><div class="line">       List&lt;ResultSet&gt; resultSets = <span class="keyword">new</span> PreparedStatementExecutor(</div><div class="line">               getShardingConnection().getShardingContext().getExecutorEngine(), getRouteResult().getSqlStatement().getType(), preparedStatementUnits, getParameters()).executeQuery();</div><div class="line">       <span class="comment">// ç»“æœå½’å¹¶</span></div><div class="line">       result = <span class="keyword">new</span> ShardingResultSet(resultSets, <span class="keyword">new</span> MergeEngine(</div><div class="line">               getShardingConnection().getShardingContext().getDatabaseType(), resultSets, (SelectStatement) getRouteResult().getSqlStatement()).merge());</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       clearBatch();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è®¾ç½®ç»“æœé›†</span></div><div class="line">   setCurrentResultSet(result);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p><strong>SQLæ‰§è¡Œ</strong> æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ï¼š<a href="http://www.yunai.me/Sharding-JDBC/sql-execute/?self">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œã€‹</a></p>
</li>
<li>
<p><strong>ç»“æœå½’å¹¶</strong> æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ï¼š<a href="http://www.yunai.me/Sharding-JDBC/result-merger/?self">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” ç»“æœå½’å¹¶ã€‹</a></p>
</li>
<li>
<p>ç»“æœå½’å¹¶ <code>#merge()</code> å®Œåï¼Œåˆ›å»ºåˆ†ç‰‡ç»“æœé›†( ShardingResultSet )</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ShardingResultSet</span> <span class="keyword">extends</span> <span class="title">AbstractResultSetAdapter</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å½’å¹¶ç»“æœé›†</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResultSetMerger mergeResultSet;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        Object result = mergeResultSet.getValue(columnIndex, <span class="keyword">int</span>.class);</div><div class="line">        wasNull = <span class="keyword">null</span> == result;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) ResultSetUtil.convertValue(result, <span class="keyword">int</span>.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">final</span> String columnLabel)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        Object result = mergeResultSet.getValue(columnLabel, <span class="keyword">int</span>.class);</div><div class="line">        wasNull = <span class="keyword">null</span> == result;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) ResultSetUtil.convertValue(result, <span class="keyword">int</span>.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// .... éšè—å…¶ä»–ç±»ä¼¼ getXXXX() æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<h1>6. è¯»å†™åˆ†ç¦»</h1>
<p>å»ºè®®å‰ç½®é˜…è¯»ï¼š<a href="http://dangdangdotcom.github.io/sharding-jdbc/02-guide/master-slave/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” è¯»å†™åˆ†ç¦»ã€‹</a></p>
<p>å½“ä½ æœ‰è¯»å†™åˆ†ç¦»çš„éœ€æ±‚æ—¶ï¼Œå°† ShardingRule é…ç½®<strong>å¯¹åº”çš„æ•°æ®æº</strong> ä» ShardingDataSource æ›¿æ¢æˆ MasterSlaveDataSourceã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ MasterSlaveDataSource çš„åŠŸèƒ½å’Œå®ç°ã€‚</p>
<p><strong>æ”¯æŒä¸€ä¸»å¤šä»çš„è¯»å†™åˆ†ç¦»é…ç½®ï¼Œå¯é…åˆåˆ†åº“åˆ†è¡¨ä½¿ç”¨</strong></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MasterSlaveDataSourceFactory.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MasterSlaveDataSourceFactory</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ›å»ºè¯»å†™åˆ†ç¦»æ•°æ®æº.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> name è¯»å†™åˆ†ç¦»æ•°æ®æºåç§°</div><div class="line">     * <span class="doctag">@param</span> masterDataSource ä¸»èŠ‚ç‚¹æ•°æ®æº</div><div class="line">     * <span class="doctag">@param</span> slaveDataSource ä»èŠ‚ç‚¹æ•°æ®æº</div><div class="line">     * <span class="doctag">@param</span> otherSlaveDataSources å…¶ä»–ä»èŠ‚ç‚¹æ•°æ®æº</div><div class="line">     * <span class="doctag">@return</span> è¯»å†™åˆ†ç¦»æ•°æ®æº</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DataSource <span class="title">createDataSource</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> DataSource masterDataSource, <span class="keyword">final</span> DataSource slaveDataSource, <span class="keyword">final</span> DataSource... otherSlaveDataSources)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MasterSlaveDataSource(name, masterDataSource, Lists.asList(slaveDataSource, otherSlaveDataSources));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// MasterSlaveDataSource.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MasterSlaveDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractDataSourceAdapter</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•°æ®æºå</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸»æ•°æ®æº</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource masterDataSource;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä»æ•°æ®æºé›†åˆ</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;DataSource&gt; slaveDataSources;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>åŒä¸€çº¿ç¨‹ä¸”åŒä¸€æ•°æ®åº“è¿æ¥å†…ï¼Œå¦‚æœ‰å†™å…¥æ“ä½œï¼Œä»¥åçš„è¯»æ“ä½œå‡ä»ä¸»åº“è¯»å–ï¼Œç”¨äºä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚</strong></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingConnection.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">(<span class="keyword">final</span> String dataSourceName, <span class="keyword">final</span> SQLType sqlType)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">   String realDataSourceName;</div><div class="line">   <span class="keyword">if</span> (dataSource <span class="keyword">instanceof</span> MasterSlaveDataSource) &#123; <span class="comment">// è¯»å†™åˆ†ç¦»</span></div><div class="line">       dataSource = ((MasterSlaveDataSource) dataSource).getDataSource(sqlType);</div><div class="line">       realDataSourceName = MasterSlaveDataSource.getDataSourceName(dataSourceName, sqlType);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       realDataSourceName = dataSourceName;</div><div class="line">   &#125;</div><div class="line">   Connection result = dataSource.getConnection();</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// MasterSlaveDataSource.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ DML æ“ä½œæ ‡è¯†</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Boolean&gt; DML_FLAG = <span class="keyword">new</span> ThreadLocal&lt;Boolean&gt;() &#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> Boolean <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">/**</span></div><div class="line">* ä»åº“è´Ÿè½½å‡è¡¡ç­–ç•¥</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> SlaveLoadBalanceStrategy slaveLoadBalanceStrategy = <span class="keyword">new</span> RoundRobinSlaveLoadBalanceStrategy();</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–ä¸»æˆ–ä»èŠ‚ç‚¹çš„æ•°æ®æº.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlType SQLç±»å‹</div><div class="line">* <span class="doctag">@return</span> ä¸»æˆ–ä»èŠ‚ç‚¹çš„æ•°æ®æº</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">(<span class="keyword">final</span> SQLType sqlType)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (isMasterRoute(sqlType)) &#123;</div><div class="line">       DML_FLAG.set(<span class="keyword">true</span>);</div><div class="line">       <span class="keyword">return</span> masterDataSource;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> slaveLoadBalanceStrategy.getDataSource(name, slaveDataSources);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isMasterRoute</span><span class="params">(<span class="keyword">final</span> SQLType sqlType)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> SQLType.DQL != sqlType || DML_FLAG.get() || HintManagerHolder.isMasterRouteOnly();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>ShardingConnection è·å–åˆ°çš„æ•°æ®æºæ˜¯ MasterSlaveDataSource æ—¶ï¼Œè°ƒç”¨ <code>MasterSlaveDataSource#getConnection()</code> æ–¹æ³•è·å–<strong>çœŸå®</strong>çš„æ•°æ®æº</p>
</li>
<li>
<p>é€šè¿‡ <code>#isMasterRoute()</code> åˆ¤æ–­æ˜¯å¦è¯»å–<strong>ä¸»åº“</strong>ï¼Œä»¥ä¸‹ä¸‰ç§æƒ…å†µä¼šè®¿é—®ä¸»åº“ï¼š</p>
<ul>
<li>éæŸ¥è¯¢è¯­å¥ (DQL)</li>
<li><strong>è¯¥</strong>æ•°æ®æºåœ¨<strong>å½“å‰</strong>çº¿ç¨‹è®¿é—®è¿‡ä¸»åº“ï¼šé€šè¿‡çº¿ç¨‹å˜é‡ <code>DML_FLAG</code> å®ç°</li>
<li>å¼ºåˆ¶ä¸»åº“ï¼šç¨‹åºé‡Œè°ƒç”¨ <code>HintManager.getInstance().setMasterRouteOnly()</code> å®ç°</li>
</ul>
</li>
<li>
<p>è®¿é—®ä»åº“æ—¶ï¼Œä¼šé€šè¿‡è´Ÿè½½å‡è¡¡ç­–ç•¥( SlaveLoadBalanceStrategy ) é€‰æ‹©ä¸€ä¸ªä»åº“</p>
<pre><code class="language-Java">// SlaveLoadBalanceStrategy.java
public interface SlaveLoadBalanceStrategy {
    
    /**
     * æ ¹æ®è´Ÿè½½å‡è¡¡ç­–ç•¥è·å–ä»åº“æ•°æ®æº.
     * 
     * @param name è¯»å†™åˆ†ç¦»æ•°æ®æºåç§°
     * @param slaveDataSources ä»åº“æ•°æ®æºåˆ—è¡¨
     * @return é€‰ä¸­çš„ä»åº“æ•°æ®æº
     */
    DataSource getDataSource(String name, List&lt;DataSource&gt; slaveDataSources);
}

// RoundRobinSlaveLoadBalanceStrategy.java
public final class RoundRobinSlaveLoadBalanceStrategy implements SlaveLoadBalanceStrategy {
    
    private static final ConcurrentHashMap&lt;String, AtomicInteger&gt; COUNT_MAP = new ConcurrentHashMap&lt;&gt;();
    
    @Override
    public DataSource getDataSource(final String name, final List&lt;DataSource&gt; slaveDataSources) {
        AtomicInteger count = COUNT_MAP.containsKey(name) ? COUNT_MAP.get(name) : new AtomicInteger(0);
        COUNT_MAP.putIfAbsent(name, count);
        count.compareAndSet(slaveDataSources.size(), 0);
        return slaveDataSources.get(count.getAndIncrement() % slaveDataSources.size());
    }
}
</code></pre>
<ul>
<li>MasterSlaveDataSource é»˜è®¤ä½¿ç”¨ RoundRobinSlaveLoadBalanceStrategyï¼Œæš‚æ—¶ä¸æ”¯æŒé…ç½®</li>
<li>RoundRobinSlaveLoadBalanceStrategyï¼Œè½®è¯¢è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œ<strong>æ¯ä¸ªä»èŠ‚ç‚¹è®¿é—®æ¬¡æ•°å‡è¡¡ï¼Œæš‚ä¸æ”¯æŒæ•°æ®æºæ•…éšœç§»é™¤</strong></li>
</ul>
</li>
</ul>
<h1>666. å½©è›‹</h1>
<p>æ²¡æœ‰å½©è›‹<br>
æ²¡æœ‰å½©<br>
æ²¡æœ‰<br>
æ²¡</p>
<p>ä¸‹ä¸€ç¯‡ï¼Œ<a href="http://www.yunai.me/Sharding-JDBC/transaction-bed/?self">ã€Šåˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆä¸€ï¼‰ä¹‹æœ€å¤§åŠªåŠ›å‹ã€‹</a>èµ°èµ·ã€‚è€å¸æœºï¼Œèµ¶ç´§ä¸Šè½¦ã€‚</p>
<p>é“å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿä¸ç„¶äº¤ä¸ªé“å§‘é‚£<s>æ•æ„Ÿè¯</s>ä½ ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;o
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” ç»“æœå½’å¹¶</title>
    <link href="http://www.yunai.me/Sharding-JDBC/result-merger/"/>
    <id>http://www.yunai.me/Sharding-JDBC/result-merger/</id>
    <published>2017-08-15T16:00:00.000Z</published>
    <updated>2017-08-10T17:26:13.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Sharding-JDBC 1.5.0 æ­£å¼ç‰ˆ</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. MergeEngine</a>
<ul>
<li><a href="#">2.1 SelectStatement#setIndexForItems()</a></li>
<li><a href="#">2.2 ResultSetMerger</a>
<ul>
<li><a href="#">2.2.1 AbstractStreamResultSetMerger</a></li>
<li><a href="#">2.2.2 AbstractMemoryResultSetMerger</a></li>
<li><a href="#">2.2.3 AbstractDecoratorResultSetMerger</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#">3. OrderByStreamResultSetMerger</a>
<ul>
<li><a href="#">3.1 å½’å¹¶ç®—æ³•</a></li>
<li><a href="#">3.2 #next()</a></li>
</ul>
</li>
<li><a href="#">4. GroupByStreamResultSetMerger</a>
<ul>
<li><a href="#">4.1 AggregationUnit</a></li>
<li><a href="#">4.2 #next()</a></li>
</ul>
</li>
<li><a href="#">5. GroupByMemoryResultSetMerger</a>
<ul>
<li><a href="#">5.1 #next()</a></li>
</ul>
</li>
<li><a href="#">6. IteratorStreamResultSetMerger</a></li>
<li><a href="#">7. LimitDecoratorResultSetMerger</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡åˆ†äº«<strong>æŸ¥è¯¢ç»“æœå½’å¹¶</strong>çš„æºç å®ç°ã€‚</p>
<p>æ­£å¦‚å‰æ–‡<a href="http://www.yunai.me/Sharding-JDBC/sql-execute/?self">ã€ŠSQL æ‰§è¡Œã€‹</a>æåˆ°çš„**â€œåˆ†è¡¨åˆ†åº“ï¼Œéœ€è¦æ‰§è¡Œçš„ SQL æ•°é‡ä»å•æ¡å˜æˆäº†å¤šæ¡â€<strong>ï¼Œå¤šä¸ª</strong>SQLæ‰§è¡Œ**ç»“æœå¿…ç„¶éœ€è¦è¿›è¡Œåˆå¹¶ï¼Œä¾‹å¦‚ï¼š</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order <span class="keyword">ORDER</span> <span class="keyword">BY</span> create_time</div></pre></td></tr></table></figure></p>
<p>åœ¨å„åˆ†ç‰‡æ’åºå®Œåï¼ŒSharding-JDBC è·å–åˆ°ç»“æœåï¼Œä»ç„¶éœ€è¦å†è¿›ä¸€æ­¥æ’åºã€‚ç›®å‰æœ‰ <strong>åˆ†é¡µ</strong>ã€<strong>åˆ†ç»„</strong>ã€<strong>æ’åº</strong>ã€<strong>èšåˆåˆ—</strong>ã€<strong>è¿­ä»£</strong> äº”ç§åœºæ™¯éœ€è¦åšè¿›ä¸€æ­¥å¤„ç†ã€‚å½“ç„¶ï¼Œå¦‚æœå•åˆ†ç‰‡<strong>SQLæ‰§è¡Œ</strong>ç»“æœæ˜¯æ— éœ€åˆå¹¶çš„ã€‚åœ¨<a href="http://www.yunai.me/Sharding-JDBC/sql-execute/?self">ã€ŠSQL æ‰§è¡Œã€‹</a>ä¸çŸ¥ä¸è§‰å·²ç»åˆ†äº«äº†æ’å…¥ã€æ›´æ–°ã€åˆ é™¤æ“ä½œçš„ç»“æœåˆå¹¶ï¼Œæ‰€ä»¥ä¸‹é¢æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹<strong>æŸ¥è¯¢ç»“æœå½’å¹¶</strong>çš„å®ç°ã€‚</p>
<hr>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>
ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1>2. MergeEngine</h1>
<p>MergeEngineï¼Œåˆ†ç‰‡ç»“æœé›†å½’å¹¶å¼•æ“ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MergeEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ•°æ®åº“ç±»å‹</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> DatabaseType databaseType;</div><div class="line"><span class="comment">/**</span></div><div class="line">* ç»“æœé›†é›†åˆ</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;ResultSet&gt; resultSets;</div><div class="line"><span class="comment">/**</span></div><div class="line">* Select SQLè¯­å¥å¯¹è±¡</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> SelectStatement selectStatement;</div><div class="line"><span class="comment">/**</span></div><div class="line">* æŸ¥è¯¢åˆ—åä¸ä½ç½®æ˜ å°„</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Integer&gt; columnLabelIndexMap;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">MergeEngine</span><span class="params">(<span class="keyword">final</span> DatabaseType databaseType, <span class="keyword">final</span> List&lt;ResultSet&gt; resultSets, <span class="keyword">final</span> SelectStatement selectStatement)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">this</span>.databaseType = databaseType;</div><div class="line">   <span class="keyword">this</span>.resultSets = resultSets;</div><div class="line">   <span class="keyword">this</span>.selectStatement = selectStatement;</div><div class="line">   <span class="comment">// è·å¾— æŸ¥è¯¢åˆ—åä¸ä½ç½®æ˜ å°„</span></div><div class="line">   columnLabelIndexMap = getColumnLabelIndexMap(resultSets.get(<span class="number">0</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾— æŸ¥è¯¢åˆ—åä¸ä½ç½®æ˜ å°„</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> resultSet ç»“æœé›†</div><div class="line">* <span class="doctag">@return</span> æŸ¥è¯¢åˆ—åä¸ä½ç½®æ˜ å°„</div><div class="line">* <span class="doctag">@throws</span> SQLException å½“ç»“æœé›†å·²ç»å…³é—­</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, Integer&gt; <span class="title">getColumnLabelIndexMap</span><span class="params">(<span class="keyword">final</span> ResultSet resultSet)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   ResultSetMetaData resultSetMetaData = resultSet.getMetaData(); <span class="comment">// å…ƒæ•°æ®ï¼ˆåŒ…å«æŸ¥è¯¢åˆ—ä¿¡æ¯ï¼‰</span></div><div class="line">   Map&lt;String, Integer&gt; result = <span class="keyword">new</span> TreeMap&lt;&gt;(String.CASE_INSENSITIVE_ORDER);</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= resultSetMetaData.getColumnCount(); i++) &#123;</div><div class="line">       result.put(SQLUtil.getExactlyValue(resultSetMetaData.getColumnLabel(i)), i);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å½“ MergeEngine è¢«åˆ›å»ºæ—¶ï¼Œä¼šä¼ å…¥ <code>resultSets</code> ç»“æœé›†é›†åˆï¼Œå¹¶æ ¹æ®å…¶è·å¾— <code>columnLabelIndexMap</code> æŸ¥è¯¢åˆ—åä¸ä½ç½®æ˜ å°„ã€‚é€šè¿‡ <code>columnLabelIndexMap</code>ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨æŸ¥è¯¢åˆ—åè·å¾—åœ¨è¿”å›ç»“æœè®°å½•åˆ—( header )çš„ç¬¬å‡ åˆ—ã€‚</li>
</ul>
<hr>
<p>MergeEngine çš„ <code>#merge()</code> æ–¹æ³•ä½œä¸ºå…¥å£æä¾›<strong>æŸ¥è¯¢ç»“æœå½’å¹¶</strong>åŠŸèƒ½ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* åˆå¹¶ç»“æœé›†.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> å½’å¹¶å®Œæ¯•åçš„ç»“æœé›†</div><div class="line">* <span class="doctag">@throws</span> SQLException SQLå¼‚å¸¸</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> ResultSetMerger <span class="title">merge</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   selectStatement.setIndexForItems(columnLabelIndexMap);</div><div class="line">   <span class="keyword">return</span> decorate(build());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#merge()</code> ä¸»ä½“é€»è¾‘å°±ä¸¤è¡Œä»£ç ï¼Œè®¾ç½®æŸ¥è¯¢åˆ—ä½ç½®ä¿¡æ¯ï¼Œå¹¶è¿”å›<strong>åˆé€‚</strong>çš„å½’å¹¶ç»“æœé›†æ¥å£( ResultSetMerger ) å®ç°ã€‚</li>
</ul>
<h2>2.1 SelectStatement#setIndexForItems()</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SelectStatement.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ä¸ºé€‰æ‹©é¡¹è®¾ç½®ç´¢å¼•.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> columnLabelIndexMap åˆ—æ ‡ç­¾ç´¢å¼•å­—å…¸</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIndexForItems</span><span class="params">(<span class="keyword">final</span> Map&lt;String, Integer&gt; columnLabelIndexMap)</span> </span>&#123;</div><div class="line">   setIndexForAggregationItem(columnLabelIndexMap);</div><div class="line">   setIndexForOrderItem(columnLabelIndexMap, orderByItems);</div><div class="line">   setIndexForOrderItem(columnLabelIndexMap, groupByItems);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>éƒ¨åˆ†<strong>æŸ¥è¯¢åˆ—</strong>æ˜¯ç»è¿‡<strong>æ¨åˆ°</strong>å‡ºæ¥ï¼Œåœ¨ <strong>SQLè§£æ</strong> è¿‡ç¨‹ä¸­ï¼Œæœªè·å¾—åˆ°æŸ¥è¯¢åˆ—ä½ç½®ï¼Œéœ€è¦é€šè¿‡è¯¥æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ã€‚å¯¹è¿™å—ä¸äº†è§£çš„åŒå­¦ï¼Œå›å¤´å¯ä»¥çœ‹ä¸‹<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-3/?self">ã€ŠSQL è§£æï¼ˆä¸‰ï¼‰ä¹‹æŸ¥è¯¢SQLã€‹</a>ã€‚ğŸ™‚ ç°åœ¨ä¸ç”¨å›å¤´ï¼Œçš‡å† ä¼šæ‰ã€‚</p>
</li>
<li>
<p><code>#setIndexForAggregationItem()</code> å¤„ç† <strong>AVGèšåˆè®¡ç®—åˆ—</strong> æ¨å¯¼å‡ºå…¶å¯¹åº”çš„ <strong>SUM/COUNT èšåˆè®¡ç®—åˆ—</strong>çš„ä½ç½®ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setIndexForAggregationItem</span><span class="params">(<span class="keyword">final</span> Map&lt;String, Integer&gt; columnLabelIndexMap)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (AggregationSelectItem each : getAggregationSelectItems()) &#123;</div><div class="line">       Preconditions.checkState(columnLabelIndexMap.containsKey(each.getColumnLabel()), String.format(<span class="string">"Can't find index: %s, please add alias for aggregate selections"</span>, each));</div><div class="line">       each.setIndex(columnLabelIndexMap.get(each.getColumnLabel()));</div><div class="line">       <span class="keyword">for</span> (AggregationSelectItem derived : each.getDerivedAggregationSelectItems()) &#123;</div><div class="line">           Preconditions.checkState(columnLabelIndexMap.containsKey(derived.getColumnLabel()), String.format(<span class="string">"Can't find index: %s"</span>, derived));</div><div class="line">           derived.setIndex(columnLabelIndexMap.get(derived.getColumnLabel()));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
<li>
<p><code>#setIndexForOrderItem()</code> å¤„ç† <strong>ORDER BY / GROUP BY åˆ—ä¸åœ¨æŸ¥è¯¢åˆ—</strong> æ¨å¯¼å‡ºçš„<strong>æŸ¥è¯¢åˆ—</strong>çš„ä½ç½®ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setIndexForOrderItem</span><span class="params">(<span class="keyword">final</span> Map&lt;String, Integer&gt; columnLabelIndexMap, <span class="keyword">final</span> List&lt;OrderItem&gt; orderItems)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (OrderItem each : orderItems) &#123;</div><div class="line">      <span class="keyword">if</span> (-<span class="number">1</span> != each.getIndex()) &#123;</div><div class="line">          <span class="keyword">continue</span>;</div><div class="line">      &#125;</div><div class="line">      Preconditions.checkState(columnLabelIndexMap.containsKey(each.getColumnLabel()), String.format(<span class="string">"Can't find index: %s"</span>, each));</div><div class="line">      <span class="keyword">if</span> (columnLabelIndexMap.containsKey(each.getColumnLabel())) &#123;</div><div class="line">          each.setIndex(columnLabelIndexMap.get(each.getColumnLabel()));</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<h2>2.2 ResultSetMerger</h2>
<p>ResultSetMergerï¼Œå½’å¹¶ç»“æœé›†æ¥å£ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ•´ä½“çš„ç±»ç»“æ„å…³ç³»ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_16/04.png" alt=""></p>
<p>ä» <strong>åŠŸèƒ½</strong> ä¸Šåˆ†æˆå››ç§ï¼š</p>
<ul>
<li>åˆ†ç»„ï¼šGroupByMemoryResultSetMergerã€GroupByStreamResultSetMergerï¼›åŒ…å«<strong>èšåˆåˆ—</strong></li>
<li>æ’åºï¼šOrderByStreamResultSetMerger</li>
<li>è¿­ä»£ï¼šIteratorStreamResultSetMerger</li>
<li>åˆ†é¡µï¼šLimitDecoratorResultSetMerger</li>
</ul>
<p>ä» <strong>å®ç°æ–¹å¼</strong> ä¸Šåˆ†æˆä¸‰ç§ï¼š</p>
<ul>
<li>Stream æµå¼ï¼šAbstractStreamResultSetMerger</li>
<li>Memory å†…å­˜ï¼šAbstractMemoryResultSetMerger</li>
<li>Decorator è£…é¥°è€…ï¼šAbstractDecoratorResultSetMerger</li>
</ul>
<p><strong>ä»€ä¹ˆæ—¶å€™è¯¥ç”¨ä»€ä¹ˆå®ç°æ–¹å¼ï¼Ÿ</strong></p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_16/06.png" alt=""></p>
<ul>
<li>Stream æµå¼ï¼šå°†æ•°æ®æ¸¸æ ‡ä¸ç»“æœé›†çš„æ¸¸æ ‡ä¿æŒä¸€è‡´ï¼Œé¡ºåºçš„ä»ç»“æœé›†ä¸­ä¸€æ¡æ¡çš„è·å–æ­£ç¡®çš„æ•°æ®ã€‚çœ‹å®Œä¸‹æ–‡<em>ç¬¬ä¸‰èŠ‚</em> OrderByStreamResultSetMerger å¯ä»¥å½¢è±¡çš„ç†è§£ã€‚</li>
<li>Memory å†…å­˜ï¼šéœ€è¦å°†ç»“æœé›†çš„æ‰€æœ‰æ•°æ®éƒ½éå†å¹¶å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå†é€šè¿‡å†…å­˜å½’å¹¶åï¼Œå°†å†…å­˜ä¸­çš„æ•°æ®ä¼ªè£…æˆç»“æœé›†è¿”å›ã€‚çœ‹å®Œä¸‹æ–‡<em>ç¬¬äº”èŠ‚</em> GroupByMemoryResultSetMerger å¯ä»¥å½¢è±¡çš„ç†è§£ã€‚</li>
<li>Decorator è£…é¥°è€…ï¼šå¯ä»¥å’Œå‰äºŒè€…ä»»æ„ç»„åˆ</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MergeEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆå¹¶ç»“æœé›†.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> å½’å¹¶å®Œæ¯•åçš„ç»“æœé›†</div><div class="line">* <span class="doctag">@throws</span> SQLException SQLå¼‚å¸¸</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> ResultSetMerger <span class="title">merge</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   selectStatement.setIndexForItems(columnLabelIndexMap);</div><div class="line">   <span class="keyword">return</span> decorate(build());</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> ResultSetMerger <span class="title">build</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!selectStatement.getGroupByItems().isEmpty() || !selectStatement.getAggregationSelectItems().isEmpty()) &#123; <span class="comment">// åˆ†ç»„ æˆ– èšåˆåˆ—</span></div><div class="line">       <span class="keyword">if</span> (selectStatement.isSameGroupByAndOrderByItems()) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> GroupByStreamResultSetMerger(columnLabelIndexMap, resultSets, selectStatement, getNullOrderType());</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> GroupByMemoryResultSetMerger(columnLabelIndexMap, resultSets, selectStatement, getNullOrderType());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (!selectStatement.getOrderByItems().isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> OrderByStreamResultSetMerger(resultSets, selectStatement.getOrderByItems(), getNullOrderType());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> IteratorStreamResultSetMerger(resultSets);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> ResultSetMerger <span class="title">decorate</span><span class="params">(<span class="keyword">final</span> ResultSetMerger resultSetMerger)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   ResultSetMerger result = resultSetMerger;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != selectStatement.getLimit()) &#123;</div><div class="line">       result = <span class="keyword">new</span> LimitDecoratorResultSetMerger(result, selectStatement.getLimit());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>2.2.1 AbstractStreamResultSetMerger</h3>
<p>AbstractStreamResultSetMergerï¼Œ<strong>æµå¼</strong>å½’å¹¶ç»“æœé›†æŠ½è±¡ç±»ï¼Œæä¾›ä»<strong>å½“å‰ç»“æœé›†</strong>è·å¾—è¡Œæ•°æ®ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractStreamResultSetMerger</span> <span class="keyword">implements</span> <span class="title">ResultSetMerger</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å½“å‰ç»“æœé›†</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> ResultSet currentResultSet;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">protected</span> ResultSet <span class="title">getCurrentResultSet</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == currentResultSet) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">"Current ResultSet is null, ResultSet perhaps end of next."</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> currentResultSet;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> columnIndex, <span class="keyword">final</span> Class&lt;?&gt; type)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (Object.class == type) &#123;</div><div class="line">            <span class="keyword">return</span> getCurrentResultSet().getObject(columnIndex);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">int</span>.class == type) &#123;</div><div class="line">            <span class="keyword">return</span> getCurrentResultSet().getInt(columnIndex);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (String.class == type) &#123;</div><div class="line">            <span class="keyword">return</span> getCurrentResultSet().getString(columnIndex);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// .... çœç•¥å…¶ä»–æ•°æ®ç±»å‹è¯»å–ç±»ä¼¼ä»£ç </span></div><div class="line">        <span class="keyword">return</span> getCurrentResultSet().getObject(columnIndex);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>2.2.2 AbstractMemoryResultSetMerger</h3>
<p>AbstractMemoryResultSetMergerï¼Œ<strong>å†…å­˜</strong>å½’å¹¶ç»“æœé›†æŠ½è±¡ç±»ï¼Œæä¾›ä»<strong>å†…å­˜æ•°æ®è¡Œå¯¹è±¡( MemoryResultSetRow )</strong> è·å¾—è¡Œæ•°æ®ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractMemoryResultSetMerger</span> <span class="keyword">implements</span> <span class="title">ResultSetMerger</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Integer&gt; labelAndIndexMap;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å†…å­˜æ•°æ®è¡Œå¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> MemoryResultSetRow currentResultSetRow;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> columnIndex, <span class="keyword">final</span> Class&lt;?&gt; type)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (Blob.class == type || Clob.class == type || Reader.class == type || InputStream.class == type || SQLXML.class == type) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SQLFeatureNotSupportedException();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> currentResultSetRow.getCell(columnIndex);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å’Œ AbstractStreamResultSetMerger å¯¹æ¯”ï¼Œè²Œä¼¼åŒºåˆ«ä¸å¤§ï¼Ÿï¼ç¡®å®ï¼Œä»æŠ½è±¡çˆ¶ç±»ä¸Šçœ‹ï¼Œä¸¤ç§å®ç°æ–¹å¼å·®ä¸å¤šã€‚æŠ½è±¡çˆ¶ç±»æä¾›ç»™å®ç°å­ç±»çš„æ˜¯<strong>æ•°æ®è¯»å–</strong>çš„åŠŸèƒ½ï¼ŒçœŸæ­£çš„æµå¼å½’å¹¶ã€å†…å­˜å½’å¹¶æ˜¯åœ¨å­ç±»å®ç°ä¸Šä½“ç°ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoryResultSetRow</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¡Œæ•°æ®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] data;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MemoryResultSetRow</span><span class="params">(<span class="keyword">final</span> ResultSet resultSet)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        data = load(resultSet);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åŠ è½½ ResultSet å½“å‰è¡Œæ•°æ®åˆ°å†…å­˜</div><div class="line">     * <span class="doctag">@param</span> resultSet ç»“æœé›†</div><div class="line">     * <span class="doctag">@return</span> è¡Œæ•°æ®</div><div class="line">     * <span class="doctag">@throws</span> SQLException å½“ç»“æœé›†å…³é—­</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Object[] load(<span class="keyword">final</span> ResultSet resultSet) <span class="keyword">throws</span> SQLException &#123;</div><div class="line">        <span class="keyword">int</span> columnCount = resultSet.getMetaData().getColumnCount();</div><div class="line">        Object[] result = <span class="keyword">new</span> Object[columnCount];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; columnCount; i++) &#123;</div><div class="line">            result[i] = resultSet.getObject(i + <span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–æ•°æ®.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> columnIndex åˆ—ç´¢å¼•</div><div class="line">     * <span class="doctag">@return</span> æ•°æ®</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getCell</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> columnIndex)</span> </span>&#123;</div><div class="line">        Preconditions.checkArgument(columnIndex &gt; <span class="number">0</span> &amp;&amp; columnIndex &lt; data.length + <span class="number">1</span>);</div><div class="line">        <span class="keyword">return</span> data[columnIndex - <span class="number">1</span>];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è®¾ç½®æ•°æ®.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> columnIndex åˆ—ç´¢å¼•</div><div class="line">     * <span class="doctag">@param</span> value å€¼</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCell</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> columnIndex, <span class="keyword">final</span> Object value)</span> </span>&#123;</div><div class="line">        Preconditions.checkArgument(columnIndex &gt; <span class="number">0</span> &amp;&amp; columnIndex &lt; data.length + <span class="number">1</span>);</div><div class="line">        data[columnIndex - <span class="number">1</span>] = value;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è°ƒç”¨ <code>#load()</code> æ–¹æ³•ï¼Œå°†å½“å‰ç»“æœé›†çš„ä¸€æ¡è¡Œæ•°æ®åŠ è½½åˆ°å†…å­˜ã€‚</li>
</ul>
<h3>2.2.3 AbstractDecoratorResultSetMerger</h3>
<p>AbstractDecoratorResultSetMergerï¼Œè£…é¥°ç»“æœé›†å½’å¹¶æŠ½è±¡ç±»ï¼Œé€šè¿‡è°ƒç”¨<strong>å…¶è£…é¥°çš„å½’å¹¶å¯¹è±¡</strong> <code>#getValue()</code> æ–¹æ³•è·å¾—è¡Œæ•°æ®ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDecoratorResultSetMerger</span> <span class="keyword">implements</span> <span class="title">ResultSetMerger</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è£…é¥°çš„å½’å¹¶å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResultSetMerger resultSetMerger;</div><div class="line">        </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> columnIndex, <span class="keyword">final</span> Class&lt;?&gt; type)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">return</span> resultSetMerger.getValue(columnIndex, type);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>3. OrderByStreamResultSetMerger</h1>
<p>OrderByStreamResultSetMergerï¼ŒåŸºäº <strong>Stream</strong> æ–¹å¼æ’åºå½’å¹¶ç»“æœé›†å®ç°ã€‚</p>
<h2>3.1 å½’å¹¶ç®—æ³•</h2>
<p>å› ä¸º<strong>å„ä¸ªåˆ†ç‰‡ç»“æœé›†å·²ç»æ’åºå®Œæˆ</strong>ï¼Œä½¿ç”¨**<a href="https://zh.wikipedia.org/wiki/%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå½’å¹¶ç®—æ³•ã€‹</a>**èƒ½å¤Ÿå……åˆ†åˆ©ç”¨è¿™ä¸ªä¼˜åŠ¿ã€‚</p>
<blockquote>
<p>å½’å¹¶æ“ä½œï¼ˆmergeï¼‰ï¼Œä¹Ÿå«å½’å¹¶ç®—æ³•ï¼ŒæŒ‡çš„æ˜¯å°†ä¸¤ä¸ªå·²ç»æ’åºçš„åºåˆ—åˆå¹¶æˆä¸€ä¸ªåºåˆ—çš„æ“ä½œã€‚å½’å¹¶æ’åºç®—æ³•ä¾èµ–å½’å¹¶æ“ä½œã€‚</p>
<p>ã€è¿­ä»£æ³•ã€‘</p>
<ol>
<li>ç”³è¯·ç©ºé—´ï¼Œä½¿å…¶å¤§å°ä¸ºä¸¤ä¸ªå·²ç»æ’åºåºåˆ—ä¹‹å’Œï¼Œè¯¥ç©ºé—´ç”¨æ¥å­˜æ”¾åˆå¹¶åçš„åºåˆ—</li>
<li>è®¾å®šä¸¤ä¸ªæŒ‡é’ˆï¼Œæœ€åˆä½ç½®åˆ†åˆ«ä¸ºä¸¤ä¸ªå·²ç»æ’åºåºåˆ—çš„èµ·å§‹ä½ç½®</li>
<li>æ¯”è¾ƒä¸¤ä¸ªæŒ‡é’ˆæ‰€æŒ‡å‘çš„å…ƒç´ ï¼Œé€‰æ‹©ç›¸å¯¹å°çš„å…ƒç´ æ”¾å…¥åˆ°åˆå¹¶ç©ºé—´ï¼Œå¹¶ç§»åŠ¨æŒ‡é’ˆåˆ°ä¸‹ä¸€ä½ç½®</li>
<li>é‡å¤æ­¥éª¤3ç›´åˆ°æŸä¸€æŒ‡é’ˆåˆ°è¾¾åºåˆ—å°¾</li>
<li>å°†å¦ä¸€åºåˆ—å‰©ä¸‹çš„æ‰€æœ‰å…ƒç´ ç›´æ¥å¤åˆ¶åˆ°åˆå¹¶åºåˆ—å°¾</li>
</ol>
</blockquote>
<p>ä»å®šä¹‰ä¸Šçœ‹ï¼Œæ˜¯ä¸æ˜¯è¶…çº§ç¬¦åˆæˆ‘ä»¬è¿™ä¸ªåœºæ™¯ã€‚ğŸ˜ˆ æ­¤æ—¶æ­¤åˆ»ï¼Œä½ æ˜¯ä¸æ˜¯æ‚ç€èƒ¸å£ï¼Œæ„Ÿå¹ï¼šâ€œå¤§å­¦æ€ä¹ˆæ²¡å¥½å¥½å­¦æ•°æ®ç»“æ„ä¸ç®—æ³•å‘¢â€ï¼Ÿåæ­£æˆ‘æ˜¯æ‚ç€äº†ï¼Œéƒ½æ˜¯çœ¼æ³ªã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_16/01.jpg" alt=""></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderByStreamResultSetMerger</span> <span class="keyword">extends</span> <span class="title">AbstractStreamResultSetMerger</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ’åºåˆ—</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span>(AccessLevel.NONE)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;OrderItem&gt; orderByItems;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ’åºå€¼å¯¹è±¡é˜Ÿåˆ—</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;OrderByValue&gt; orderByValuesQueue;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * é»˜è®¤æ’åºç±»å‹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderType nullOrderType;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ˜¯å¦ç¬¬ä¸€ä¸ª ResultSet å·²ç»è°ƒç”¨ #next()</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isFirstNext;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderByStreamResultSetMerger</span><span class="params">(<span class="keyword">final</span> List&lt;ResultSet&gt; resultSets, <span class="keyword">final</span> List&lt;OrderItem&gt; orderByItems, <span class="keyword">final</span> OrderType nullOrderType)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">this</span>.orderByItems = orderByItems;</div><div class="line">        <span class="keyword">this</span>.orderByValuesQueue = <span class="keyword">new</span> PriorityQueue&lt;&gt;(resultSets.size());</div><div class="line">        <span class="keyword">this</span>.nullOrderType = nullOrderType;</div><div class="line">        orderResultSetsToQueue(resultSets);</div><div class="line">        isFirstNext = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">orderResultSetsToQueue</span><span class="params">(<span class="keyword">final</span> List&lt;ResultSet&gt; resultSets)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">for</span> (ResultSet each : resultSets) &#123;</div><div class="line">            OrderByValue orderByValue = <span class="keyword">new</span> OrderByValue(each, orderByItems, nullOrderType);</div><div class="line">            <span class="keyword">if</span> (orderByValue.next()) &#123;</div><div class="line">                orderByValuesQueue.offer(orderByValue);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// è®¾ç½®å½“å‰ ResultSetï¼Œè¿™æ · #getValue() èƒ½æ‹¿åˆ°è®°å½•</span></div><div class="line">        setCurrentResultSet(orderByValuesQueue.isEmpty() ? resultSets.get(<span class="number">0</span>) : orderByValuesQueue.peek().getResultSet());</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p>å±æ€§ <code>orderByValuesQueue</code> ä½¿ç”¨çš„é˜Ÿåˆ—å®ç°æ˜¯<strong>ä¼˜å…ˆçº§</strong>é˜Ÿåˆ—( PriorityQueue )ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹çœ‹<a href="http://wlh0706-163-com.iteye.com/blog/1850125" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJDKæºç ç ”ç©¶PriorityQueueã€‹</a>ï¼Œæœ¬æ–‡ä¸å±•å¼€è®²ï¼Œä¸æ˜¯ä¸»è§’æˆä»½ä¸å¤šã€‚æˆ‘ä»¬è®°ä½å‡ ä¸ªæ–¹æ³•çš„ç”¨é€”ï¼š</p>
<ul>
<li><code>#offer()</code>ï¼šå¢åŠ å…ƒç´ ã€‚å¢åŠ æ—¶ï¼Œä¼šå°†è¯¥å…ƒç´ å’Œå·²æœ‰å…ƒç´ ä»¬æŒ‰ç…§<strong>ä¼˜å…ˆçº§</strong>è¿›è¡Œæ’åº</li>
<li><code>#peek()</code>ï¼šè·å¾—ä¼˜å…ˆçº§ç¬¬ä¸€çš„å…ƒç´ </li>
<li><code>#pool()</code>ï¼šè·å¾—ä¼˜å…ˆçº§ç¬¬ä¸€çš„å…ƒç´ <strong>å¹¶ç§»é™¤</strong></li>
</ul>
</li>
<li>
<p>ä¸€ä¸ª ResultSet æ„å»ºä¸€ä¸ª OrderByValue ç”¨äºæ’åºï¼Œå³ä¸Šæ–‡<strong>å½’å¹¶ç®—æ³•</strong>æåˆ°çš„**â€œç©ºé—´â€**ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderByValue</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">OrderByValue</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å·²æ’åºç»“æœé›†</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResultSet resultSet;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ’åºåˆ—</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;OrderItem&gt; orderByItems;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * é»˜è®¤æ’åºç±»å‹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderType nullOrderType;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ’åºåˆ—å¯¹åº”çš„å€¼æ•°ç»„</div><div class="line">     * å› ä¸ºä¸€æ¡è®°å½•å¯èƒ½æœ‰å¤šä¸ªæ’åºåˆ—ï¼Œæ‰€ä»¥æ˜¯æ•°ç»„</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> List&lt;Comparable&lt;?&gt;&gt; orderValues;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * éå†ä¸‹ä¸€ä¸ªç»“æœé›†æ¸¸æ ‡.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span> æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªç»“æœé›†</div><div class="line">     * <span class="doctag">@throws</span> SQLException SQLå¼‚å¸¸</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">next</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> result = resultSet.next();</div><div class="line">        orderValues = result ? getOrderValues() : Collections.&lt;Comparable&lt;?&gt;&gt;emptyList();</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å¾— æ’åºåˆ—å¯¹åº”çš„å€¼æ•°ç»„</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> æ’åºåˆ—å¯¹åº”çš„å€¼æ•°ç»„</div><div class="line">     * <span class="doctag">@throws</span> SQLException å½“ç»“æœé›†å…³é—­æ—¶</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> List&lt;Comparable&lt;?&gt;&gt; getOrderValues() <span class="keyword">throws</span> SQLException &#123;</div><div class="line">        List&lt;Comparable&lt;?&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(orderByItems.size());</div><div class="line">        <span class="keyword">for</span> (OrderItem each : orderByItems) &#123;</div><div class="line">            Object value = resultSet.getObject(each.getIndex());</div><div class="line">            Preconditions.checkState(<span class="keyword">null</span> == value || value <span class="keyword">instanceof</span> Comparable, <span class="string">"Order by value must implements Comparable"</span>);</div><div class="line">            result.add((Comparable&lt;?&gt;) value);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¯¹æ¯” &#123;<span class="doctag">@link</span> #orderValues&#125;ï¼Œå³ä¸¤è€…çš„ç¬¬ä¸€æ¡è®°å½•</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> o å¯¹æ¯” OrderByValue</div><div class="line">     * <span class="doctag">@return</span> -1 0 1</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(<span class="keyword">final</span> OrderByValue o)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; orderByItems.size(); i++) &#123;</div><div class="line">            OrderItem thisOrderBy = orderByItems.get(i);</div><div class="line">            <span class="keyword">int</span> result = ResultSetUtil.compareTo(orderValues.get(i), o.orderValues.get(i), thisOrderBy.getType(), nullOrderType);</div><div class="line">            <span class="keyword">if</span> (<span class="number">0</span> != result) &#123;</div><div class="line">                <span class="keyword">return</span> result;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è°ƒç”¨ <code>OrderByValue#next()</code> æ–¹æ³•æ—¶ï¼Œè·å¾—å…¶å¯¹åº”ç»“æœé›†<strong>æ’åœ¨ç¬¬ä¸€æ¡</strong>çš„è®°å½•ï¼Œé€šè¿‡ <code>#getOrderValues()</code> è®¡ç®—è¯¥è®°å½•çš„æ’åºå­—æ®µå€¼ã€‚è¿™æ ·<strong>ä¸¤ä¸ªOrderByValue</strong> é€šè¿‡ <code>#compareTo()</code> æ–¹æ³•å¯ä»¥æ¯”è¾ƒ<strong>ä¸¤ä¸ªç»“æœé›†</strong>çš„ç¬¬ä¸€æ¡è®°å½•ã€‚</li>
</ul>
</li>
<li>
<p><code>if (orderByValue.next()) {</code> å¤„ï¼Œè°ƒç”¨ <code>OrderByValue#next()</code> åï¼Œæ·»åŠ åˆ° PriorityQueueã€‚å› æ­¤ï¼Œ<code>orderByValuesQueue.peek().getResultSet()</code> èƒ½å¤Ÿè·å¾—å¤šä¸ª ResultSet ä¸­æ’åœ¨ç¬¬ä¸€çš„ã€‚</p>
</li>
</ul>
<h2>3.2 #next()</h2>
<p>é€šè¿‡è°ƒç”¨ <code>OrderByStreamResultSetMerger#next()</code> ä¸æ–­è·å¾—å½“å‰æ’åœ¨ç¬¬ä¸€çš„è®°å½•ã€‚<code>#next()</code> æ¯æ¬¡è°ƒç”¨åï¼Œå®é™…åšçš„æ˜¯å½“å‰ ResultSet çš„æ›¿æ¢ï¼Œä»¥åŠå½“å‰çš„ ResultSet çš„è®°å½•æŒ‡å‘ä¸‹ä¸€æ¡ã€‚è¿™æ ·è¯´èµ·æ¥å¯èƒ½æ¯”è¾ƒç»•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€å¼ å›¾ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_16/02.png" alt=""></p>
<ul>
<li>ç™½è‰²å‘ä¸‹ç®­å¤´ï¼šOrderByStreamResultSetMerger å¯¹ ResultSet çš„æŒ‡å‘ã€‚</li>
<li>é»‘è‰²ç®­å¤´ï¼šResultSet å¯¹å½“å‰è®°å½•çš„æŒ‡å‘ã€‚</li>
<li>psï¼šè¿™å—å¦‚æœåˆ†äº«çš„ä¸æ¸…æ™°è®©æ‚¨è´¹åŠ²ï¼Œååˆ†æŠ±æ­‰ã€‚æ¬¢è¿åŠ æˆ‘å¾®ä¿¡ï¼ˆwangwenbin-serverï¼‰äº¤æµä¸‹ï¼Œè¿™æ ·æˆ‘ä¹Ÿå¯ä»¥ä¼˜åŒ–è¡¨è¿°ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// OrderByStreamResultSetMerger.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">next</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">if</span> (orderByValuesQueue.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (isFirstNext) &#123;</div><div class="line">       isFirstNext = <span class="keyword">false</span>;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç§»é™¤ä¸Šä¸€æ¬¡è·å¾—çš„ ResultSet</span></div><div class="line">   OrderByValue firstOrderByValue = orderByValuesQueue.poll();</div><div class="line">   <span class="comment">// å¦‚æœä¸Šä¸€æ¬¡è·å¾—çš„ ResultSetè¿˜æœ‰ä¸‹ä¸€æ¡è®°å½•ï¼Œç»§ç»­æ·»åŠ åˆ° æ’åºå€¼å¯¹è±¡é˜Ÿåˆ—</span></div><div class="line">   <span class="keyword">if</span> (firstOrderByValue.next()) &#123;</div><div class="line">       orderByValuesQueue.offer(firstOrderByValue);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (orderByValuesQueue.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è®¾ç½®å½“å‰ ResultSet</span></div><div class="line">   setCurrentResultSet(orderByValuesQueue.peek().getResultSet());</div><div class="line">   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p><code>orderByValuesQueue.poll()</code> ç§»é™¤ä¸Šä¸€æ¬¡è·å¾—çš„ ResultSetã€‚ä¸ºä»€ä¹ˆä¸èƒ½ <code>#setCurrentResultSet()</code> å°±ç§»é™¤å‘¢ï¼Ÿå¦‚æœè¯¥ ResultSet é‡Œé¢è¿˜å­˜åœ¨ä¸‹ä¸€æ¡è®°å½•ï¼Œéœ€è¦ç»§ç»­å‚åŠ <strong>æ’åº</strong>ã€‚è€Œåˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸€æ¡ï¼Œéœ€è¦è°ƒç”¨ <code>ResultSet#next()</code> æ–¹æ³•ï¼Œè¿™ä¼šå¯¼è‡´ ResultSet æŒ‡å‘äº†ä¸‹ä¸€æ¡è®°å½•ã€‚å› è€Œ <code>orderByValuesQueue.poll()</code> è°ƒç”¨æ˜¯<strong>åç½®</strong>çš„ã€‚</p>
</li>
<li>
<p><code>isFirstNext</code> å˜é‡é‚£çš„åˆ¤æ–­çœ‹ç€æ˜¯ä¸æ˜¯å¾ˆâ€œçµå¼‚â€ï¼Ÿå› ä¸º <code>#orderResultSetsToQueue()</code> å¤„è®¾ç½®äº†ç¬¬ä¸€æ¬¡çš„ ResultSetã€‚å¦‚æœä¸åŠ è¿™ä¸ªæ ‡è®°ï¼Œä¼šå¯¼è‡´ç¬¬ä¸€æ¡è®°å½•â€œä¸è§â€äº†ã€‚</p>
</li>
<li>
<p>é€šè¿‡ä¸æ–­çš„ <code>Queue#poll()</code>ã€<code>Queue#offset()</code> å®ç°æ’åºã€‚å·§å¦™ï¼ä»¿ä½› Get æ–°æŠ€èƒ½äº†ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ç§»é™¤ä¸Šä¸€æ¬¡è·å¾—çš„ ResultSet</span></div><div class="line">OrderByValue firstOrderByValue = orderByValuesQueue.poll();</div><div class="line"><span class="comment">// å¦‚æœä¸Šä¸€æ¬¡è·å¾—çš„ ResultSetè¿˜æœ‰ä¸‹ä¸€æ¡è®°å½•ï¼Œç»§ç»­æ·»åŠ åˆ° æ’åºå€¼å¯¹è±¡é˜Ÿåˆ—</span></div><div class="line"><span class="keyword">if</span> (firstOrderByValue.next()) &#123;</div><div class="line">  orderByValuesQueue.offer(firstOrderByValue);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<hr>
<p>åœ¨çœ‹ä¸‹ï¼Œæˆ‘ä»¬ä¸Šæ–‡ Stream æ–¹å¼å½’å¹¶çš„å®šä¹‰ï¼š**å°†æ•°æ®æ¸¸æ ‡ä¸ç»“æœé›†çš„æ¸¸æ ‡ä¿æŒä¸€è‡´ï¼Œé¡ºåºçš„ä»ç»“æœé›†ä¸­ä¸€æ¡æ¡çš„è·å–æ­£ç¡®çš„æ•°æ®ã€‚**æ˜¯ä¸æ˜¯èƒ½å¤Ÿæ¸…æ™°çš„å¯¹ä¸Šäº†ï¼Ÿï¼ğŸ™‚</p>
<h1>4. GroupByStreamResultSetMerger</h1>
<p>GroupByStreamResultSetMergerï¼ŒåŸºäº <strong>Stream</strong> æ–¹å¼åˆ†ç»„å½’å¹¶ç»“æœé›†å®ç°ã€‚ å®ƒç»§æ‰¿è‡ª OrderByStreamResultSetMergerï¼Œåœ¨<strong>æ’åº</strong>çš„é€»è¾‘ä¸Šï¼Œå®ç°åˆ†ç»„åŠŸèƒ½ã€‚å®ç°åŸç†ä¹Ÿè¾ƒä¸ºç®€å•ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_16/03.png" alt=""></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupByStreamResultSetMerger</span> <span class="keyword">extends</span> <span class="title">OrderByStreamResultSetMerger</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æŸ¥è¯¢åˆ—åä¸ä½ç½®æ˜ å°„</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Integer&gt; labelAndIndexMap;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Select SQLè¯­å¥å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SelectStatement selectStatement;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å½“å‰ç»“æœè®°å½•</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; currentRow;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸‹ä¸€æ¡ç»“æœè®°å½• GROUP BY æ¡ä»¶</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> List&lt;?&gt; currentGroupByValues;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GroupByStreamResultSetMerger</span><span class="params">(</span></span></div><div class="line">            <span class="keyword">final</span> Map&lt;String, Integer&gt; labelAndIndexMap, <span class="keyword">final</span> List&lt;ResultSet&gt; resultSets, <span class="keyword">final</span> SelectStatement selectStatement, <span class="keyword">final</span> OrderType nullOrderType) <span class="keyword">throws</span> SQLException &#123;</div><div class="line">        <span class="keyword">super</span>(resultSets, selectStatement.getOrderByItems(), nullOrderType);</div><div class="line">        <span class="keyword">this</span>.labelAndIndexMap = labelAndIndexMap;</div><div class="line">        <span class="keyword">this</span>.selectStatement = selectStatement;</div><div class="line">        currentRow = <span class="keyword">new</span> ArrayList&lt;&gt;(labelAndIndexMap.size());</div><div class="line">        <span class="comment">// åˆå§‹åŒ–ä¸‹ä¸€æ¡ç»“æœè®°å½• GROUP BY æ¡ä»¶</span></div><div class="line">        currentGroupByValues = getOrderByValuesQueue().isEmpty() ? Collections.emptyList() : <span class="keyword">new</span> GroupByValue(getCurrentResultSet(), selectStatement.getGroupByItems()).getGroupValues();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> columnIndex, <span class="keyword">final</span> Class&lt;?&gt; type)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">return</span> currentRow.get(columnIndex - <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">(<span class="keyword">final</span> String columnLabel, <span class="keyword">final</span> Class&lt;?&gt; type)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        Preconditions.checkState(labelAndIndexMap.containsKey(columnLabel), String.format(<span class="string">"Can't find columnLabel: %s"</span>, columnLabel));</div><div class="line">        <span class="keyword">return</span> currentRow.get(labelAndIndexMap.get(columnLabel) - <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p><code>currentRow</code> ä¸ºå½“å‰ç»“æœè®°å½•ï¼Œä½¿ç”¨ <code>#getValue()</code>ã€<code>#getCalendarValue()</code> æ–¹æ³•è·å¾—å½“å‰ç»“æœè®°å½•çš„æŸ¥è¯¢åˆ—å€¼ã€‚</p>
</li>
<li>
<p><code>currentGroupByValues</code> ä¸º<strong>ä¸‹ä¸€æ¡</strong>ç»“æœè®°å½• GROUP BY æ¡ä»¶ï¼Œé€šè¿‡ GroupByValue ç”Ÿæˆï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupByValue</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ†ç»„æ¡ä»¶å€¼æ•°ç»„</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;?&gt; groupValues;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GroupByValue</span><span class="params">(<span class="keyword">final</span> ResultSet resultSet, <span class="keyword">final</span> List&lt;OrderItem&gt; groupByItems)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        groupValues = getGroupByValues(resultSet, groupByItems);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å¾—åˆ†ç»„æ¡ä»¶å€¼æ•°ç»„</div><div class="line">     * ä¾‹å¦‚ï¼Œ`GROUP BY user_id, order_status` è¿”å›çš„æŸæ¡è®°å½•ç»“æœä¸º `userId = 1, order_status = 3`ï¼Œå¯¹åº”çš„ `groupValues = [1, 3]`</div><div class="line">     * <span class="doctag">@param</span> resultSet ç»“æœé›†ï¼ˆå•åˆ†ç‰‡ï¼‰</div><div class="line">     * <span class="doctag">@param</span> groupByItems åˆ†ç»„åˆ—</div><div class="line">     * <span class="doctag">@return</span> åˆ†ç»„æ¡ä»¶å€¼æ•°ç»„</div><div class="line">     * <span class="doctag">@throws</span> SQLException å½“ç»“æœé›†å…³é—­</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> List&lt;?&gt; getGroupByValues(<span class="keyword">final</span> ResultSet resultSet, <span class="keyword">final</span> List&lt;OrderItem&gt; groupByItems) <span class="keyword">throws</span> SQLException &#123;</div><div class="line">        List&lt;Object&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(groupByItems.size());</div><div class="line">        <span class="keyword">for</span> (OrderItem each : groupByItems) &#123;</div><div class="line">            result.add(resultSet.getObject(each.getIndex())); <span class="comment">// ä»ç»“æœé›†è·å¾—æ¯ä¸ªåˆ†ç»„æ¡ä»¶çš„å€¼</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</li>
<li>
<p>GroupByStreamResultSetMerger åœ¨åˆ›å»ºæ—¶ï¼Œå½“å‰ç»“æœè®°å½•<strong>å®é™…æœªåˆå¹¶</strong>ï¼Œéœ€è¦å…ˆè°ƒç”¨ <code>#next()</code>ï¼Œåœ¨ä½¿ç”¨ <code>#getValue()</code> ç­‰æ–¹æ³•è·å–å€¼ï¼Œè¿™ä¸ªå’Œ OrderByStreamResultSetMerger ä¸åŒï¼Œå¯èƒ½æ˜¯ä¸ª BUGã€‚</p>
</li>
</ul>
<h2>4.1 AggregationUnit</h2>
<p>AggregationUnitï¼Œå½’å¹¶è®¡ç®—å•å…ƒæ¥å£ï¼Œæœ‰ä¸¤ä¸ªæ¥å£æ–¹æ³•ï¼š</p>
<ul>
<li><code>#merge()</code>ï¼šå½’å¹¶èšåˆå€¼</li>
<li><code>#getResult()</code>ï¼šè·å–è®¡ç®—ç»“æœ</li>
</ul>
<p>ä¸€å…±æœ‰ä¸‰ä¸ªå®ç°ç±»ï¼š</p>
<ul>
<li><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/merger/groupby/aggregation/AccumulationAggregationUnit.java" rel="external nofollow noopener noreferrer" target="_blank">AccumulationAggregationUnit</a>ï¼šç´¯åŠ èšåˆå•å…ƒï¼Œè§£å†³ COUNTã€SUM èšåˆåˆ—</li>
<li><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/merger/groupby/aggregation/ComparableAggregationUnit.java" rel="external nofollow noopener noreferrer" target="_blank">ComparableAggregationUnit</a>ï¼šæ¯”è¾ƒèšåˆå•å…ƒï¼Œè§£å†³ MAXã€MIN èšåˆåˆ—</li>
<li><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/merger/groupby/aggregation/AverageAggregationUnit.java" rel="external nofollow noopener noreferrer" target="_blank">AverageAggregationUnit</a>ï¼šå¹³å‡å€¼èšåˆå•å…ƒï¼Œè§£å†³ AVG èšåˆåˆ—</li>
</ul>
<p>å®ç°éƒ½æ¯”è¾ƒæ˜“æ‡‚ï¼Œç›´æ¥ç‚¹å‡»é“¾æ¥æŸ¥çœ‹æºç ï¼Œæˆ‘ä»¬å°±ä¸æµªè´¹ç¯‡å¹…è´´ä»£ç å•¦ã€‚</p>
<h2>4.2 #next()</h2>
<p>æˆ‘ä»¬å…ˆçœ‹çœ‹å¤§ä½“çš„è°ƒç”¨æµç¨‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_16/05.png" alt=""></p>
<p>ğŸ˜ˆ çœ‹èµ·æ¥ä»£ç æ¯”è¾ƒå¤šï¼Œé€»è¾‘å…¶å®æ¯”è¾ƒæ¸…æ™°ï¼Œå¯¹ç…§ç€é¡ºåºå›¾é¡ºåºå¾€ä¸‹è¯»å³å¯ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// GroupByStreamResultSetMerger.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">next</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="comment">// æ¸…é™¤å½“å‰ç»“æœè®°å½•</span></div><div class="line">   currentRow.clear();</div><div class="line">   <span class="keyword">if</span> (getOrderByValuesQueue().isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">//</span></div><div class="line">   <span class="keyword">if</span> (isFirstNext()) &#123;</div><div class="line">       <span class="keyword">super</span>.next();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// é¡ºåºåˆå¹¶ä¸‹é¢ç›¸åŒåˆ†ç»„æ¡ä»¶çš„è®°å½•</span></div><div class="line">   <span class="keyword">if</span> (aggregateCurrentGroupByRowAndNext()) &#123;</div><div class="line">       <span class="comment">// ç”Ÿæˆä¸‹ä¸€æ¡ç»“æœè®°å½• GROUP BY æ¡ä»¶</span></div><div class="line">       currentGroupByValues = <span class="keyword">new</span> GroupByValue(getCurrentResultSet(), selectStatement.getGroupByItems()).getGroupValues();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">aggregateCurrentGroupByRowAndNext</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line">   <span class="comment">// ç”Ÿæˆè®¡ç®—å•å…ƒ</span></div><div class="line">   Map&lt;AggregationSelectItem, AggregationUnit&gt; aggregationUnitMap = Maps.toMap(selectStatement.getAggregationSelectItems(), <span class="keyword">new</span> Function&lt;AggregationSelectItem, AggregationUnit&gt;() &#123;</div><div class="line">       </div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> AggregationUnit <span class="title">apply</span><span class="params">(<span class="keyword">final</span> AggregationSelectItem input)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> AggregationUnitFactory.create(input.getType());</div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line">   <span class="comment">// å¾ªç¯é¡ºåºåˆå¹¶ä¸‹é¢ç›¸åŒåˆ†ç»„æ¡ä»¶çš„è®°å½•</span></div><div class="line">   <span class="keyword">while</span> (currentGroupByValues.equals(<span class="keyword">new</span> GroupByValue(getCurrentResultSet(), selectStatement.getGroupByItems()).getGroupValues())) &#123;</div><div class="line">       <span class="comment">// å½’å¹¶èšåˆå€¼</span></div><div class="line">       aggregate(aggregationUnitMap);</div><div class="line">       <span class="comment">// ç¼“å­˜å½“å‰è®°å½•åˆ°ç»“æœè®°å½•</span></div><div class="line">       cacheCurrentRow();</div><div class="line">       <span class="comment">// è·å–ä¸‹ä¸€æ¡è®°å½•</span></div><div class="line">       result = <span class="keyword">super</span>.next();</div><div class="line">       <span class="keyword">if</span> (!result) &#123;</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è®¾ç½®å½“å‰è®°å½•çš„èšåˆå­—æ®µç»“æœ</span></div><div class="line">   setAggregationValueToCurrentRow(aggregationUnitMap);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">aggregate</span><span class="params">(<span class="keyword">final</span> Map&lt;AggregationSelectItem, AggregationUnit&gt; aggregationUnitMap)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Entry&lt;AggregationSelectItem, AggregationUnit&gt; entry : aggregationUnitMap.entrySet()) &#123;</div><div class="line">       List&lt;Comparable&lt;?&gt;&gt; values = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">2</span>);</div><div class="line">       <span class="keyword">if</span> (entry.getKey().getDerivedAggregationSelectItems().isEmpty()) &#123; <span class="comment">// SUM/COUNT/MAX/MIN èšåˆåˆ—</span></div><div class="line">           values.add(getAggregationValue(entry.getKey()));</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">for</span> (AggregationSelectItem each : entry.getKey().getDerivedAggregationSelectItems()) &#123; <span class="comment">// AVG èšåˆåˆ—</span></div><div class="line">               values.add(getAggregationValue(each));</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       entry.getValue().merge(values);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cacheCurrentRow</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; getCurrentResultSet().getMetaData().getColumnCount(); i++) &#123;</div><div class="line">       currentRow.add(getCurrentResultSet().getObject(i + <span class="number">1</span>));</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="keyword">private</span> Comparable&lt;?&gt; getAggregationValue(<span class="keyword">final</span> AggregationSelectItem aggregationSelectItem) <span class="keyword">throws</span> SQLException &#123;</div><div class="line">   Object result = getCurrentResultSet().getObject(aggregationSelectItem.getIndex());</div><div class="line">   Preconditions.checkState(<span class="keyword">null</span> == result || result <span class="keyword">instanceof</span> Comparable, <span class="string">"Aggregation value must implements Comparable"</span>);</div><div class="line">   <span class="keyword">return</span> (Comparable&lt;?&gt;) result;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setAggregationValueToCurrentRow</span><span class="params">(<span class="keyword">final</span> Map&lt;AggregationSelectItem, AggregationUnit&gt; aggregationUnitMap)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Entry&lt;AggregationSelectItem, AggregationUnit&gt; entry : aggregationUnitMap.entrySet()) &#123;</div><div class="line">       currentRow.set(entry.getKey().getIndex() - <span class="number">1</span>, entry.getValue().getResult()); <span class="comment">// è·å–è®¡ç®—ç»“æœ</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>5. GroupByMemoryResultSetMerger</h1>
<p>GroupByMemoryResultSetMergerï¼ŒåŸºäº <strong>å†…å­˜</strong> åˆ†ç»„å½’å¹¶ç»“æœé›†å®ç°ã€‚</p>
<p>åŒºåˆ«äº GroupByStreamResultSetMergerï¼Œå…¶æ— æ³•ä½¿ç”¨æ¯ä¸ªåˆ†ç‰‡ç»“æœé›†çš„<strong>æœ‰åº</strong>çš„ç‰¹ç‚¹ï¼Œåªèƒ½åœ¨å†…å­˜ä¸­åˆå¹¶åï¼Œè¿›è¡Œ<strong>æ•´ä¸ª</strong>é‡æ–°æ’åºã€‚å› è€Œï¼Œæ€§èƒ½å’Œå†…å­˜éƒ½è¾ƒ GroupByStreamResultSetMerger ä¼šå·®ã€‚</p>
<p>ä¸»æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_16/07.png" alt=""></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupByMemoryResultSetMerger</span> <span class="keyword">extends</span> <span class="title">AbstractMemoryResultSetMerger</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Select SQLè¯­å¥å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SelectStatement selectStatement;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * é»˜è®¤æ’åºç±»å‹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderType nullOrderType;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å†…å­˜ç»“æœé›†</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Iterator&lt;MemoryResultSetRow&gt; memoryResultSetRows;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GroupByMemoryResultSetMerger</span><span class="params">(</span></span></div><div class="line">            <span class="keyword">final</span> Map&lt;String, Integer&gt; labelAndIndexMap, <span class="keyword">final</span> List&lt;ResultSet&gt; resultSets, <span class="keyword">final</span> SelectStatement selectStatement, <span class="keyword">final</span> OrderType nullOrderType) <span class="keyword">throws</span> SQLException &#123;</div><div class="line">        <span class="keyword">super</span>(labelAndIndexMap);</div><div class="line">        <span class="keyword">this</span>.selectStatement = selectStatement;</div><div class="line">        <span class="keyword">this</span>.nullOrderType = nullOrderType;</div><div class="line">        memoryResultSetRows = init(resultSets);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> Iterator&lt;MemoryResultSetRow&gt; <span class="title">init</span><span class="params">(<span class="keyword">final</span> List&lt;ResultSet&gt; resultSets)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        Map&lt;GroupByValue, MemoryResultSetRow&gt; dataMap = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1024</span>); <span class="comment">// åˆ†ç»„æ¡ä»¶å€¼ä¸å†…å­˜è®°å½•æ˜ å°„</span></div><div class="line">        Map&lt;GroupByValue, Map&lt;AggregationSelectItem, AggregationUnit&gt;&gt; aggregationMap = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1024</span>); <span class="comment">// åˆ†ç»„æ¡ä»¶å€¼ä¸èšåˆåˆ—æ˜ å°„</span></div><div class="line">        <span class="comment">// éå†ç»“æœé›†</span></div><div class="line">        <span class="keyword">for</span> (ResultSet each : resultSets) &#123;</div><div class="line">            <span class="keyword">while</span> (each.next()) &#123;</div><div class="line">                <span class="comment">// ç”Ÿæˆåˆ†ç»„æ¡ä»¶</span></div><div class="line">                GroupByValue groupByValue = <span class="keyword">new</span> GroupByValue(each, selectStatement.getGroupByItems());</div><div class="line">                <span class="comment">// åˆå§‹åŒ–åˆ†ç»„æ¡ä»¶åˆ° dataMapã€aggregationMap æ˜ å°„</span></div><div class="line">                initForFirstGroupByValue(each, groupByValue, dataMap, aggregationMap);</div><div class="line">                <span class="comment">// å½’å¹¶èšåˆå€¼</span></div><div class="line">                aggregate(each, groupByValue, aggregationMap);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// è®¾ç½®èšåˆåˆ—ç»“æœåˆ°å†…å­˜è®°å½•</span></div><div class="line">        setAggregationValueToMemoryRow(dataMap, aggregationMap);</div><div class="line">        <span class="comment">// å†…å­˜æ’åº</span></div><div class="line">        List&lt;MemoryResultSetRow&gt; result = getMemoryResultSetRows(dataMap);</div><div class="line">        <span class="comment">// è®¾ç½®å½“å‰ ResultSetï¼Œè¿™æ · #getValue() èƒ½æ‹¿åˆ°è®°å½•</span></div><div class="line">        <span class="keyword">if</span> (!result.isEmpty()) &#123;</div><div class="line">            setCurrentResultSetRow(result.get(<span class="number">0</span>));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result.iterator();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p><code>#initForFirstGroupByValue()</code> åˆå§‹åŒ–<strong>åˆ†ç»„æ¡ä»¶</strong>åˆ° <code>dataMap</code>ï¼Œ<code>aggregationMap</code> æ˜ å°„ä¸­ï¼Œè¿™æ ·å¯ä»¥è°ƒç”¨ <code>#aggregate()</code> å°†èšåˆå€¼å½’å¹¶åˆ° <code>aggregationMap</code> é‡Œçš„è¯¥åˆ†ç»„æ¡ä»¶ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initForFirstGroupByValue</span><span class="params">(<span class="keyword">final</span> ResultSet resultSet, <span class="keyword">final</span> GroupByValue groupByValue, <span class="keyword">final</span> Map&lt;GroupByValue, MemoryResultSetRow&gt; dataMap, </span></span></div><div class="line">                                          <span class="keyword">final</span> Map&lt;GroupByValue, Map&lt;AggregationSelectItem, AggregationUnit&gt;&gt; aggregationMap) <span class="keyword">throws</span> SQLException &#123;</div><div class="line">        <span class="comment">// åˆå§‹åŒ–åˆ†ç»„æ¡ä»¶åˆ° dataMap</span></div><div class="line">        <span class="keyword">if</span> (!dataMap.containsKey(groupByValue)) &#123;</div><div class="line">            dataMap.put(groupByValue, <span class="keyword">new</span> MemoryResultSetRow(resultSet));</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// åˆå§‹åŒ–åˆ†ç»„æ¡ä»¶åˆ° aggregationMap</span></div><div class="line">        <span class="keyword">if</span> (!aggregationMap.containsKey(groupByValue)) &#123;</div><div class="line">            Map&lt;AggregationSelectItem, AggregationUnit&gt; map = Maps.toMap(selectStatement.getAggregationSelectItems(), <span class="keyword">new</span> Function&lt;AggregationSelectItem, AggregationUnit&gt;() &#123;</div><div class="line">                </div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> AggregationUnit <span class="title">apply</span><span class="params">(<span class="keyword">final</span> AggregationSelectItem input)</span> </span>&#123;</div><div class="line">                    <span class="keyword">return</span> AggregationUnitFactory.create(input.getType());</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            aggregationMap.put(groupByValue, map);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ``` </div><div class="line">* èšåˆå®Œæ¯ä¸ªåˆ†ç»„æ¡ä»¶åï¼Œå°†èšåˆåˆ—ç»“æœ `aggregationMap` åˆå¹¶åˆ° `dataMap`ã€‚</div><div class="line"></div><div class="line">    ```<span class="function">Java</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setAggregationValueToMemoryRow</span><span class="params">(<span class="keyword">final</span> Map&lt;GroupByValue, MemoryResultSetRow&gt; dataMap, <span class="keyword">final</span> Map&lt;GroupByValue, Map&lt;AggregationSelectItem, AggregationUnit&gt;&gt; aggregationMap)</span> &#123;</div><div class="line">       <span class="keyword">for</span> (Entry&lt;GroupByValue, MemoryResultSetRow&gt; entry : dataMap.entrySet()) &#123; <span class="comment">// é å†å†…å­˜è®°å½•</span></div><div class="line">           <span class="keyword">for</span> (AggregationSelectItem each : selectStatement.getAggregationSelectItems()) &#123; <span class="comment">// éå† æ¯ä¸ªèšåˆåˆ—</span></div><div class="line">               entry.getValue().setCell(each.getIndex(), aggregationMap.get(entry.getKey()).get(each).getResult());</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
</li>
<li>
<p>è°ƒç”¨ <code>#getMemoryResultSetRows()</code> æ–¹æ³•å¯¹å†…å­˜è®°å½•è¿›è¡Œ<strong>å†…å­˜æ’åº</strong>ã€‚</p>
</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// GroupByMemoryResultSetMerger.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> List&lt;MemoryResultSetRow&gt; <span class="title">getMemoryResultSetRows</span><span class="params">(<span class="keyword">final</span> Map&lt;GroupByValue, MemoryResultSetRow&gt; dataMap)</span> </span>&#123;</div><div class="line">   List&lt;MemoryResultSetRow&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(dataMap.values());</div><div class="line">   Collections.sort(result, <span class="keyword">new</span> GroupByRowComparator(selectStatement, nullOrderType)); <span class="comment">// å†…å­˜æ’åº</span></div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// GroupByRowComparator.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(<span class="keyword">final</span> MemoryResultSetRow o1, <span class="keyword">final</span> MemoryResultSetRow o2, <span class="keyword">final</span> List&lt;OrderItem&gt; orderItems)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (OrderItem each : orderItems) &#123;</div><div class="line">       Object orderValue1 = o1.getCell(each.getIndex());</div><div class="line">       Preconditions.checkState(<span class="keyword">null</span> == orderValue1 || orderValue1 <span class="keyword">instanceof</span> Comparable, <span class="string">"Order by value must implements Comparable"</span>);</div><div class="line">       Object orderValue2 = o2.getCell(each.getIndex());</div><div class="line">       Preconditions.checkState(<span class="keyword">null</span> == orderValue2 || orderValue2 <span class="keyword">instanceof</span> Comparable, <span class="string">"Order by value must implements Comparable"</span>);</div><div class="line">       <span class="keyword">int</span> result = ResultSetUtil.compareTo((Comparable) orderValue1, (Comparable) orderValue2, each.getType(), nullOrderType);</div><div class="line">       <span class="keyword">if</span> (<span class="number">0</span> != result) &#123;</div><div class="line">           <span class="keyword">return</span> result;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>æ€»çš„æ¥è¯´ï¼ŒGROUP BY å†…å­˜å½’å¹¶å’Œæˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨ Map è®¡ç®—ç”¨æˆ·è®¢å•æ•°æ˜¯æ¯”è¾ƒç›¸ä¼¼çš„ã€‚</li>
</ul>
<h2>5.1 #next()</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">next</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">if</span> (memoryResultSetRows.hasNext()) &#123;</div><div class="line">       setCurrentResultSetRow(memoryResultSetRows.next());</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å†…å­˜å½’å¹¶å®Œæˆåï¼Œä½¿ç”¨ <code>memoryResultSetRows</code> ä¸æ–­è·å¾—ä¸‹ä¸€æ¡è®°å½•ã€‚</li>
</ul>
<h1>6. IteratorStreamResultSetMerger</h1>
<p>IteratorStreamResultSetMergerï¼ŒåŸºäº <strong>Stream</strong> è¿­ä»£å½’å¹¶ç»“æœé›†å®ç°ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">IteratorStreamResultSetMerger</span> <span class="keyword">extends</span> <span class="title">AbstractStreamResultSetMerger</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ResultSet æ•°ç»„è¿­ä»£å™¨</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Iterator&lt;ResultSet&gt; resultSets;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IteratorStreamResultSetMerger</span><span class="params">(<span class="keyword">final</span> List&lt;ResultSet&gt; resultSets)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.resultSets = resultSets.iterator();</div><div class="line">        <span class="comment">// è®¾ç½®å½“å‰ ResultSetï¼Œè¿™æ · #getValue() èƒ½æ‹¿åˆ°è®°å½•</span></div><div class="line">        setCurrentResultSet(<span class="keyword">this</span>.resultSets.next());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">next</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="comment">// å½“å‰ ResultSet è¿­ä»£ä¸‹ä¸€æ¡è®°å½•</span></div><div class="line">        <span class="keyword">if</span> (getCurrentResultSet().next()) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!resultSets.hasNext()) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// è·å¾—ä¸‹ä¸€ä¸ªResultSetï¼Œ è®¾ç½®å½“å‰ ResultSet</span></div><div class="line">        setCurrentResultSet(resultSets.next());</div><div class="line">        <span class="keyword">boolean</span> hasNext = getCurrentResultSet().next();</div><div class="line">        <span class="keyword">if</span> (hasNext) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">while</span> (!hasNext &amp;&amp; resultSets.hasNext()) &#123;</div><div class="line">            setCurrentResultSet(resultSets.next());</div><div class="line">            hasNext = getCurrentResultSet().next();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> hasNext;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>7. LimitDecoratorResultSetMerger</h1>
<p>LimitDecoratorResultSetMergerï¼ŒåŸºäº <strong>Decorator</strong> åˆ†é¡µç»“æœé›†å½’å¹¶å®ç°ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LimitDecoratorResultSetMerger</span> <span class="keyword">extends</span> <span class="title">AbstractDecoratorResultSetMerger</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ†é¡µæ¡ä»¶</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Limit limit;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ˜¯å¦å…¨éƒ¨è®°å½•éƒ½è·³è¿‡äº†ï¼Œå³æ— ç¬¦åˆæ¡ä»¶è®°å½•</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> skipAll;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å½“å‰å·²è¿”å›è¡Œæ•°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> rowNumber;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LimitDecoratorResultSetMerger</span><span class="params">(<span class="keyword">final</span> ResultSetMerger resultSetMerger, <span class="keyword">final</span> Limit limit)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">super</span>(resultSetMerger);</div><div class="line">        <span class="keyword">this</span>.limit = limit;</div><div class="line">        skipAll = skipOffset();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">skipOffset</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="comment">// è·³è¿‡ skip è®°å½•</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; limit.getOffsetValue(); i++) &#123;</div><div class="line">            <span class="keyword">if</span> (!getResultSetMerger().next()) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// è¡Œæ•°</span></div><div class="line">        rowNumber = limit.isRowCountRewriteFlag() ? <span class="number">0</span> : limit.getOffsetValue();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">next</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (skipAll) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// è·å¾—ä¸‹ä¸€æ¡è®°å½•</span></div><div class="line">        <span class="keyword">if</span> (limit.getRowCountValue() &gt; -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">return</span> ++rowNumber &lt;= limit.getRowCountValue() &amp;&amp; getResultSetMerger().next();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// éƒ¨åˆ†db å¯ä»¥ç›´ offsetï¼Œä¸å†™ limit è¡Œæ•°ï¼Œä¾‹å¦‚ oracle</span></div><div class="line">        <span class="keyword">return</span> getResultSetMerger().next();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>LimitDecoratorResultSetMerger å¯ä»¥å¯¹å…¶ä»– ResultSetMerger è¿›è¡Œè£…é¥°ï¼Œè°ƒç”¨å…¶ä»– ResultSetMerger çš„ <code>#next()</code> ä¸æ–­è·å¾—ä¸‹ä¸€æ¡è®°å½•ã€‚</li>
</ul>
<h1>666. å½©è›‹</h1>
<p>è¯¶ï¼Ÿåº”è¯¥æ˜¯æœ‰è›®å¤šåœ°æ–¹è§£é‡Šçš„ä¸æ˜¯å¾ˆæ¸…æ™°ï¼Œå¦‚æœè®©æ‚¨é˜…è¯»è¯¯è§£æˆ–æ˜¯é˜»å¡ï¼Œéå¸¸æŠ±æ­‰ã€‚ä»£ç è¯»èµ·æ¥æ¯”è¾ƒæ˜“æ‡‚ï¼Œä½¿ç”¨æ–‡å­—æ¥è§£é‡Šï¼Œå¯¹è¡¨è¿°èƒ½åŠ›è¾ƒå·®çš„è‡ªå·±ï¼Œå¯èƒ½å°±ç»å°½è„‘æ±ï¼Œä¸€è„¸æ‡µé€¼ã€‚</p>
<p>æ©ï¼Œå¦‚æœå¯ä»¥ï¼Œè¿˜çƒ¦è¯·æŠŠè¯»èµ·æ¥ä¸å¤ªçˆ½çš„åœ°æ–¹å‘Šè¯‰æˆ‘ï¼Œè°¢è°¢ã€‚</p>
<p>åšç€è„¸çš®ï¼Œé“å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>
<p>å¦‚ä¸‹æ˜¯å°ç¤¼åŒ…ï¼Œå˜¿å˜¿</p>
<table>
<thead>
<tr>
<th>å½’å¹¶ç»“æœé›†æ¥å£</th>
<th>SQL</th>
</tr>
</thead>
<tbody>
<tr>
<td>OrderByStreamResultSetMerger</td>
<td><code>SELECT * FROM t_order ORDER BY id</code></td>
</tr>
<tr>
<td>GroupByStreamResultSetMerger</td>
<td><code>SELECT uid, AVG(id) FROM t_order GROUP BY uid</code></td>
</tr>
<tr>
<td>GroupByMemoryResultSetMerger</td>
<td><code>SELECT uid FROM t_order GROUP BY id ORDER BY id DESC</code></td>
</tr>
<tr>
<td>IteratorStreamResultSetMerger</td>
<td><code>SELECT * FROM t_order</code></td>
</tr>
<tr>
<td>LimitDecoratorResultSetMerger</td>
<td><code>SELECT * FROM t_order ORDER BY id LIMIT 10</code></td>
</tr>
</tbody>
</table>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;o
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-execute/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-execute/</id>
    <published>2017-08-13T16:00:00.000Z</published>
    <updated>2017-08-10T17:26:08.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Sharding-JDBC 1.5.0 æ­£å¼ç‰ˆ</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ExecutorEngine</a>
<ul>
<li><a href="#">2.1 ListeningExecutorService</a></li>
<li><a href="#">2.2 å…³é—­</a></li>
<li><a href="#">2.3 æ‰§è¡Œ SQL ä»»åŠ¡</a></li>
</ul>
</li>
<li><a href="#">3. Executor</a>
<ul>
<li><a href="#">3.1 StatementExecutor</a></li>
<li><a href="#">3.2 PreparedStatementExecutor</a></li>
<li><a href="#">3.3 BatchPreparedStatementExecutor</a></li>
</ul>
</li>
<li><a href="#">4. ExecutionEvent</a>
<ul>
<li><a href="#">4.1 EventBus</a></li>
<li><a href="#">4.2 BestEffortsDeliveryListener</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>è¶Šè¿‡åƒå±±ä¸‡æ°´ï¼ˆSQL è§£æã€SQL è·¯ç”±ã€SQL æ”¹å†™ï¼‰ï¼Œæˆ‘ä»¬ç»ˆäºæ¥åˆ°äº† <strong>SQL æ‰§è¡Œ</strong>ã€‚å¼€æ£®ä¸å¼€æ£®ï¼Ÿï¼</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/01.png" alt=""></p>
<p>æœ¬æ–‡ä¸»è¦åˆ†äº«<strong>SQL æ‰§è¡Œ</strong>çš„è¿‡ç¨‹ï¼Œä¸åŒ…æ‹¬<strong>ç»“æœèšåˆ</strong>ã€‚<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šç»“æœèšåˆã€‹</a> <strong>ä¸œåŠçƒç¬¬äºŒè‰¯å¿ƒç¬”è€…</strong>ä¼šæ›´æ–°ï¼Œå…³æ³¨å¾®ä¿¡å…¬ä¼—å·<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</a>å®Œç¨¿å<strong>ç¬¬ä¸€æ—¶é—´</strong>é€šçŸ¥æ‚¨å“Ÿã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/06.png" alt=""></p>
<p><strong>ç»¿æ¡†éƒ¨åˆ†</strong> SQL æ‰§è¡Œä¸»æµç¨‹ã€‚</p>
<hr>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>
ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1>2. ExecutorEngine</h1>
<p>ExecutorEngineï¼ŒSQLæ‰§è¡Œå¼•æ“ã€‚</p>
<p>åˆ†è¡¨åˆ†åº“ï¼Œéœ€è¦æ‰§è¡Œçš„ SQL æ•°é‡ä»å•æ¡å˜æˆäº†å¤šæ¡ï¼Œæ­¤æ—¶æœ‰ä¸¤ç§æ–¹å¼æ‰§è¡Œï¼š</p>
<ul>
<li><strong>ä¸²è¡Œ</strong>æ‰§è¡Œ SQL</li>
<li><strong>å¹¶è¡Œ</strong>æ‰§è¡Œ SQL</li>
</ul>
<p>å‰è€…ï¼Œç¼–ç å®¹æ˜“ï¼Œæ€§èƒ½è¾ƒå·®ï¼Œæ€»è€—æ—¶æ˜¯å¤šæ¡ SQL æ‰§è¡Œæ—¶é—´ç´¯åŠ ã€‚<br>
åè€…ï¼Œç¼–ç å¤æ‚ï¼Œæ€§èƒ½è¾ƒå¥½ï¼Œæ€»è€—æ—¶çº¦ç­‰äºæ‰§è¡Œæ—¶é—´æœ€é•¿çš„ SQLã€‚</p>
<p>ğŸ‘¼ ExecutorEngine å½“ç„¶é‡‡ç”¨çš„æ˜¯<strong>åè€…</strong>ï¼Œå¹¶è¡Œæ‰§è¡Œ SQLã€‚</p>
<h2>2.1 ListeningExecutorService</h2>
<p><a href="http://www.yiibai.com/guava/" rel="external nofollow noopener noreferrer" target="_blank">Guava( Java å·¥å…·åº“ )</a> æä¾›çš„ç»§æ‰¿è‡ª  ExecutorService çš„<strong>çº¿ç¨‹æœåŠ¡æ¥å£</strong>ï¼Œæä¾›åˆ›å»º ListenableFuture åŠŸèƒ½ã€‚ListenableFuture æ¥å£ï¼Œç»§æ‰¿ Future æ¥å£ï¼Œæœ‰å¦‚ä¸‹å¥½å¤„ï¼š</p>
<blockquote>
<p>æˆ‘ä»¬å¼ºçƒˆåœ°å»ºè®®ä½ åœ¨ä»£ç ä¸­å¤šä½¿ç”¨ListenableFutureæ¥ä»£æ›¿JDKçš„ Future, å› ä¸ºï¼š</p>
</blockquote>
<ul>
<li>å¤§å¤šæ•°Futures æ–¹æ³•ä¸­éœ€è¦å®ƒã€‚</li>
<li>è½¬åˆ°ListenableFuture ç¼–ç¨‹æ¯”è¾ƒå®¹æ˜“ã€‚</li>
<li>Guavaæä¾›çš„é€šç”¨å…¬å…±ç±»å°è£…äº†å…¬å…±çš„æ“ä½œæ–¹æ–¹æ³•ï¼Œä¸éœ€è¦æä¾›Futureå’ŒListenableFutureçš„æ‰©å±•æ–¹æ³•ã€‚</li>
</ul>
<blockquote>
<p>ä¼ ç»ŸJDKä¸­çš„Futureé€šè¿‡å¼‚æ­¥çš„æ–¹å¼è®¡ç®—è¿”å›ç»“æœ:åœ¨å¤šçº¿ç¨‹è¿ç®—ä¸­å¯èƒ½æˆ–è€…å¯èƒ½åœ¨æ²¡æœ‰ç»“æŸè¿”å›ç»“æœï¼ŒFutureæ˜¯è¿è¡Œä¸­çš„å¤šçº¿ç¨‹çš„ä¸€ä¸ªå¼•ç”¨å¥æŸ„ï¼Œç¡®ä¿åœ¨æœåŠ¡æ‰§è¡Œè¿”å›ä¸€ä¸ªResultã€‚</p>
</blockquote>
<blockquote>
<p>ListenableFutureå¯ä»¥å…è®¸ä½ æ³¨å†Œå›è°ƒæ–¹æ³•(callbacks)ï¼Œåœ¨è¿ç®—ï¼ˆå¤šçº¿ç¨‹æ‰§è¡Œï¼‰å®Œæˆçš„æ—¶å€™è¿›è¡Œè°ƒç”¨,  æˆ–è€…åœ¨è¿ç®—ï¼ˆå¤šçº¿ç¨‹æ‰§è¡Œï¼‰å®Œæˆåç«‹å³æ‰§è¡Œã€‚è¿™æ ·ç®€å•çš„æ”¹è¿›ï¼Œä½¿å¾—å¯ä»¥æ˜æ˜¾çš„æ”¯æŒæ›´å¤šçš„æ“ä½œï¼Œè¿™æ ·çš„åŠŸèƒ½åœ¨JDK concurrentä¸­çš„Futureæ˜¯ä¸æ”¯æŒçš„ã€‚</p>
</blockquote>
<p>å¦‚ä¸Šå†…å®¹æ¥è‡ª<a href="http://ifeve.com/google-guava-listenablefuture/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠGoogle GuavaåŒ…çš„ListenableFutureè§£æ
ã€‹</a>ï¼Œæ–‡ç« å†™çš„å¾ˆæ£’ã€‚ä¸‹æ–‡ä½ ä¼šçœ‹åˆ° Sharding-JDBC æ˜¯<strong>å¦‚ä½•é€šè¿‡ ListenableFuture ç®€åŒ–å¹¶å‘ç¼–ç¨‹çš„</strong>ã€‚</p>
<p>ä¸‹é¢çœ‹çœ‹ ExecutorEngine å¦‚ä½•<strong>åˆå§‹åŒ–</strong> ListeningExecutorService</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingDataSource.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ShardingDataSource</span><span class="params">(<span class="keyword">final</span> ShardingRule shardingRule, <span class="keyword">final</span> Properties props)</span> </span>&#123;</div><div class="line">    <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">   shardingProperties = <span class="keyword">new</span> ShardingProperties(props);</div><div class="line">   <span class="keyword">int</span> executorSize = shardingProperties.getValue(ShardingPropertiesConstant.EXECUTOR_SIZE);</div><div class="line">   executorEngine = <span class="keyword">new</span> ExecutorEngine(executorSize);</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ExecutorEngine</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ExecutorEngine</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> executorSize)</span> </span>&#123;</div><div class="line">   executorService = MoreExecutors.listeningDecorator(<span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">           executorSize, executorSize, <span class="number">0</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(),</div><div class="line">           <span class="keyword">new</span> ThreadFactoryBuilder().setDaemon(<span class="keyword">true</span>).setNameFormat(<span class="string">"ShardingJDBC-%d"</span>).build()));</div><div class="line">   MoreExecutors.addDelayedShutdownHook(executorService, <span class="number">60</span>, TimeUnit.SECONDS);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ä¸€ä¸ªåˆ†ç‰‡æ•°æ®æº( ShardingDataSource ) <strong>ç‹¬å </strong> ä¸€ä¸ª SQLæ‰§è¡Œå¼•æ“( ExecutorEngine )ã€‚</li>
<li><code>MoreExecutors#listeningDecorator()</code> åˆ›å»º ListeningExecutorServiceï¼Œè¿™æ · <code>#submit()</code>ï¼Œ<code>#invokeAll()</code> å¯ä»¥è¿”å› ListenableFutureã€‚</li>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ± å¤§å°ä¸º <strong>8</strong>ã€‚å¯ä»¥æ ¹æ®å®é™…ä¸šåŠ¡éœ€è¦ï¼Œè®¾ç½® ShardingProperties è¿›è¡Œè°ƒæ•´ã€‚</li>
<li><code>#setNameFormat()</code> å¹¶å‘ç¼–ç¨‹æ—¶ï¼Œä¸€å®šè¦å¯¹çº¿ç¨‹åå­—åšä¸‹å®šä¹‰ï¼Œè¿™æ ·æ’æŸ¥é—®é¢˜ä¼šæ–¹ä¾¿å¾ˆå¤šã€‚</li>
<li><code>MoreExecutors#addDelayedShutdownHook()</code>ï¼Œ<strong>åº”ç”¨å…³é—­</strong>æ—¶ï¼Œç­‰å¾…<strong>æ‰€æœ‰ä»»åŠ¡å…¨éƒ¨å®Œæˆ</strong>å†å…³é—­ã€‚é»˜è®¤é…ç½®ç­‰å¾…æ—¶é—´ä¸º 60 ç§’ï¼Œ<strong>å»ºè®®</strong>å°†ç­‰å¾…æ—¶é—´åšæˆå¯é…çš„ã€‚</li>
</ul>
<h2>2.2 å…³é—­</h2>
<p>æ•°æ®æºå…³é—­æ—¶ï¼Œä¼šè°ƒç”¨ ExecutorEngine ä¹Ÿè¿›è¡Œå…³é—­ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingDataSource.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</div><div class="line">   executorEngine.close();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ExecutorEngine</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</div><div class="line">   executorService.shutdownNow();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       executorService.awaitTermination(<span class="number">5</span>, TimeUnit.SECONDS);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException ignored) &#123;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (!executorService.isTerminated()) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ShardingJdbcException(<span class="string">"ExecutorEngine can not been terminated"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#shutdownNow()</code> å°è¯•ä½¿ç”¨ <code>Thread.interrupt()</code> æ‰“æ–­æ­£åœ¨æ‰§è¡Œä¸­çš„ä»»åŠ¡ï¼Œæœªæ‰§è¡Œçš„ä»»åŠ¡ä¸å†æ‰§è¡Œã€‚<strong>å»ºè®®</strong>æ‰“å°ä¸‹å“ªäº›ä»»åŠ¡æœªæ‰§è¡Œï¼Œå› ä¸º SQL æœªæ‰§è¡Œï¼Œå¯èƒ½æ•°æ®æœªèƒ½æŒä¹…åŒ–ã€‚</li>
<li><code>#awaitTermination()</code> å› ä¸º <code>#shutdownNow()</code> æ‰“æ–­ä¸æ˜¯<strong>ç«‹å³</strong>ç»“æŸï¼Œéœ€è¦ä¸€ä¸ªè¿‡ç¨‹ï¼Œå› æ­¤è¿™é‡Œ<strong>ç­‰å¾…</strong>äº† 5 ç§’ã€‚</li>
<li><strong>ç­‰å¾…</strong> 5 ç§’åï¼Œçº¿ç¨‹æ± ä¸ä¸€å®šå·²ç»å…³é—­ï¼Œæ­¤æ—¶æŠ›å‡ºå¼‚å¸¸ç»™ä¸Šå±‚ã€‚<strong>å»ºè®®</strong>æ‰“å°ä¸‹æ—¥å¿—ï¼Œè®°å½•å‡ºç°è¿™ä¸ªæƒ…å†µã€‚</li>
</ul>
<h2>2.3 æ‰§è¡Œ SQL ä»»åŠ¡</h2>
<p>ExecutorEngine å¯¹å¤–æš´éœ² <code>#executeStatement()</code>ï¼Œ<code>#executePreparedStatement()</code>ï¼Œ<code>#executeBatch()</code></p>
<p>ä¸‰ä¸ªæ–¹æ³•åˆ†åˆ«æä¾›ç»™ StatementExecutorã€PreparedStatementExecutorã€BatchPreparedStatementExecutor è°ƒç”¨ã€‚è€Œè¿™ä¸‰ä¸ªæ–¹æ³•ï¼Œå†…éƒ¨è°ƒç”¨çš„éƒ½æ˜¯ <code>#execute()</code> ç§æœ‰æ–¹æ³•ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ExecutorEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡ŒStatement.</div><div class="line">* <span class="doctag">@param</span> sqlType SQLç±»å‹</div><div class="line">* <span class="doctag">@param</span> statementUnits è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒé›†åˆ</div><div class="line">* <span class="doctag">@param</span> executeCallback æ‰§è¡Œå›è°ƒå‡½æ•°</div><div class="line">* <span class="doctag">@param</span> &lt;T&gt; è¿”å›å€¼ç±»å‹</div><div class="line">* <span class="doctag">@return</span> æ‰§è¡Œç»“æœ</div><div class="line">*/</div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">executeStatement</span><span class="params">(<span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;StatementUnit&gt; statementUnits, <span class="keyword">final</span> ExecuteCallback&lt;T&gt; executeCallback)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> execute(sqlType, statementUnits, Collections.&lt;List&lt;Object&gt;&gt;emptyList(), executeCallback);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡ŒPreparedStatement.</div><div class="line">* <span class="doctag">@param</span> sqlType SQLç±»å‹</div><div class="line">* <span class="doctag">@param</span> preparedStatementUnits è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒé›†åˆ</div><div class="line">* <span class="doctag">@param</span> parameters å‚æ•°åˆ—è¡¨</div><div class="line">* <span class="doctag">@param</span> executeCallback æ‰§è¡Œå›è°ƒå‡½æ•°</div><div class="line">* <span class="doctag">@param</span> &lt;T&gt; è¿”å›å€¼ç±»å‹</div><div class="line">* <span class="doctag">@return</span> æ‰§è¡Œç»“æœ</div><div class="line">*/</div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">executePreparedStatement</span><span class="params">(</span></span></div><div class="line">       <span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;PreparedStatementUnit&gt; preparedStatementUnits, <span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> ExecuteCallback&lt;T&gt; executeCallback) &#123;</div><div class="line">   <span class="keyword">return</span> execute(sqlType, preparedStatementUnits, Collections.singletonList(parameters), executeCallback);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡ŒBatch.</div><div class="line">* <span class="doctag">@param</span> sqlType SQLç±»å‹</div><div class="line">* <span class="doctag">@param</span> batchPreparedStatementUnits è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒé›†åˆ</div><div class="line">* <span class="doctag">@param</span> parameterSets å‚æ•°åˆ—è¡¨é›†</div><div class="line">* <span class="doctag">@param</span> executeCallback æ‰§è¡Œå›è°ƒå‡½æ•°</div><div class="line">* <span class="doctag">@return</span> æ‰§è¡Œç»“æœ</div><div class="line">*/</div><div class="line"><span class="keyword">public</span> List&lt;<span class="keyword">int</span>[]&gt; executeBatch(</div><div class="line">       <span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;BatchPreparedStatementUnit&gt; batchPreparedStatementUnits, <span class="keyword">final</span> List&lt;List&lt;Object&gt;&gt; parameterSets, <span class="keyword">final</span> ExecuteCallback&lt;<span class="keyword">int</span>[]&gt; executeCallback) &#123;</div><div class="line">   <span class="keyword">return</span> execute(sqlType, batchPreparedStatementUnits, parameterSets, executeCallback);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>#execute()</code> æ‰§è¡Œè¿‡ç¨‹å¤§ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/02.png" alt=""></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œ</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlType SQL ç±»å‹</div><div class="line">* <span class="doctag">@param</span> baseStatementUnits è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒé›†åˆ</div><div class="line">* <span class="doctag">@param</span> parameterSets å‚æ•°åˆ—è¡¨é›†</div><div class="line">* <span class="doctag">@param</span> executeCallback æ‰§è¡Œå›è°ƒå‡½æ•°</div><div class="line">* <span class="doctag">@param</span> &lt;T&gt; è¿”å›å€¼ç±»å‹</div><div class="line">* <span class="doctag">@return</span> æ‰§è¡Œç»“æœ</div><div class="line">*/</div><div class="line"><span class="keyword">private</span>  &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">execute</span><span class="params">(</span></span></div><div class="line">       <span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;? extends BaseStatementUnit&gt; baseStatementUnits, <span class="keyword">final</span> List&lt;List&lt;Object&gt;&gt; parameterSets, <span class="keyword">final</span> ExecuteCallback&lt;T&gt; executeCallback) &#123;</div><div class="line">   <span class="keyword">if</span> (baseStatementUnits.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   Iterator&lt;? extends BaseStatementUnit&gt; iterator = baseStatementUnits.iterator();</div><div class="line">   BaseStatementUnit firstInput = iterator.next();</div><div class="line">   <span class="comment">// ç¬¬äºŒä¸ªä»»åŠ¡å¼€å§‹æ‰€æœ‰ SQLä»»åŠ¡ æäº¤çº¿ç¨‹æ± ã€å¼‚æ­¥ã€‘æ‰§è¡Œä»»åŠ¡</span></div><div class="line">   ListenableFuture&lt;List&lt;T&gt;&gt; restFutures = asyncExecute(sqlType, Lists.newArrayList(iterator), parameterSets, executeCallback);</div><div class="line">   T firstOutput;</div><div class="line">   List&lt;T&gt; restOutputs;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// ç¬¬ä¸€ä¸ªä»»åŠ¡ã€åŒæ­¥ã€‘æ‰§è¡Œä»»åŠ¡</span></div><div class="line">       firstOutput = syncExecute(sqlType, firstInput, parameterSets, executeCallback);</div><div class="line">       <span class="comment">// ç­‰å¾…ç¬¬äºŒä¸ªä»»åŠ¡å¼€å§‹æ‰€æœ‰ SQLä»»åŠ¡å®Œæˆ</span></div><div class="line">       restOutputs = restFutures.get();</div><div class="line">       <span class="comment">//CHECKSTYLE:OFF</span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       <span class="comment">//CHECKSTYLE:ON</span></div><div class="line">       ExecutorExceptionHandler.handleException(ex);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è¿”å›ç»“æœ</span></div><div class="line">   List&lt;T&gt; result = Lists.newLinkedList(restOutputs);</div><div class="line">   result.add(<span class="number">0</span>, firstOutput);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬ä¸€ä¸ªä»»åŠ¡**ã€åŒæ­¥ã€‘**è°ƒç”¨ <code>#executeInternal()</code> æ‰§è¡Œä»»åŠ¡ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">syncExecute</span><span class="params">(<span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> BaseStatementUnit baseStatementUnit, <span class="keyword">final</span> List&lt;List&lt;Object&gt;&gt; parameterSets, <span class="keyword">final</span> ExecuteCallback&lt;T&gt; executeCallback)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">   <span class="comment">// ã€åŒæ­¥ã€‘æ‰§è¡Œä»»åŠ¡</span></div><div class="line">   <span class="keyword">return</span> executeInternal(sqlType, baseStatementUnit, parameterSets, executeCallback, ExecutorExceptionHandler.isExceptionThrown(), ExecutorDataMap.getDataMap());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬äºŒä¸ªå¼€å§‹çš„ä»»åŠ¡<strong>æäº¤çº¿ç¨‹æ± å¼‚æ­¥</strong>è°ƒç”¨ <code>#executeInternal()</code> æ‰§è¡Œä»»åŠ¡ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> &lt;T&gt; ListenableFuture&lt;List&lt;T&gt;&gt; asyncExecute(</div><div class="line">       <span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;BaseStatementUnit&gt; baseStatementUnits, <span class="keyword">final</span> List&lt;List&lt;Object&gt;&gt; parameterSets, <span class="keyword">final</span> ExecuteCallback&lt;T&gt; executeCallback) &#123;</div><div class="line">   List&lt;ListenableFuture&lt;T&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(baseStatementUnits.size());</div><div class="line">   <span class="keyword">final</span> <span class="keyword">boolean</span> isExceptionThrown = ExecutorExceptionHandler.isExceptionThrown();</div><div class="line">   <span class="keyword">final</span> Map&lt;String, Object&gt; dataMap = ExecutorDataMap.getDataMap();</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">final</span> BaseStatementUnit each : baseStatementUnits) &#123;</div><div class="line">       <span class="comment">// æäº¤çº¿ç¨‹æ± ã€å¼‚æ­¥ã€‘æ‰§è¡Œä»»åŠ¡</span></div><div class="line">       result.add(executorService.submit(<span class="keyword">new</span> Callable&lt;T&gt;() &#123;</div><div class="line">           </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> T <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">               <span class="keyword">return</span> executeInternal(sqlType, each, parameterSets, executeCallback, isExceptionThrown, dataMap);</div><div class="line">           &#125;</div><div class="line">       &#125;));</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è¿”å› ListenableFuture</span></div><div class="line">   <span class="keyword">return</span> Futures.allAsList(result);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>æˆ‘ä»¬æ³¨æ„ä¸‹ <code>Futures.allAsList(result);</code> å’Œ <code>restOutputs = restFutures.get();</code>ã€‚ç¥å™¨ Guava <strong>ç®€åŒ–å¹¶å‘ç¼–ç¨‹</strong> çš„å¥½å¤„å°±æç°å‡ºæ¥äº†ã€‚<code>ListenableFuture#get()</code> å½“<strong>æ‰€æœ‰ä»»åŠ¡éƒ½æˆåŠŸ</strong>æ—¶ï¼Œè¿”å›æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œç»“æœï¼›å½“<strong>ä»»ä½•ä¸€ä¸ªä»»åŠ¡å¤±è´¥</strong>æ—¶ï¼Œ<strong>é©¬ä¸Š</strong>æŠ›å‡ºå¼‚å¸¸ï¼Œæ— éœ€ç­‰å¾…å…¶ä»–ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/03.gif" alt=""></p>
<p><em>ğŸ˜® Guava çœŸå¥¹å–µç¥å™¨ï¼Œå…¬ä¼—å·ï¼š<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</a>ä¼šæ›´æ–° Guava æºç åˆ†äº«çš„ä¸€ä¸ªç³»åˆ—å“Ÿï¼è€å¸æœºè¿˜ä¸èµ¶ç´§ä¸Šè½¦ï¼Ÿ</em></p>
<ul>
<li>ä¸ºä»€ä¹ˆä¼šåˆ†åŒæ­¥æ‰§è¡Œå’Œå¼‚æ­¥æ‰§è¡Œå‘¢ï¼ŸçŒœæµ‹ï¼Œå½“<strong>SQL æ‰§è¡Œæ˜¯å•è¡¨æ—¶</strong>ï¼Œåªè¦è¿›è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡çš„åŒæ­¥è°ƒç”¨ï¼Œæ€§èƒ½æ›´åŠ ä¼˜ç§€ã€‚ç­‰è·Ÿå¼ äº®å¤§ç¥è¯·æ•™ç¡®è®¤åŸå› åï¼Œå’±ä¼šè¿›è¡Œæ›´æ–°ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ExecutorEngine.java</span></div><div class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">executeInternal</span><span class="params">(<span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> BaseStatementUnit baseStatementUnit, <span class="keyword">final</span> List&lt;List&lt;Object&gt;&gt; parameterSets, <span class="keyword">final</span> ExecuteCallback&lt;T&gt; executeCallback, </span></span></div><div class="line">                     <span class="keyword">final</span> <span class="keyword">boolean</span> isExceptionThrown, <span class="keyword">final</span> Map&lt;String, Object&gt; dataMap) <span class="keyword">throws</span> Exception &#123;</div><div class="line">   <span class="keyword">synchronized</span> (baseStatementUnit.getStatement().getConnection()) &#123;</div><div class="line">       T result;</div><div class="line">       ExecutorExceptionHandler.setExceptionThrown(isExceptionThrown);</div><div class="line">       ExecutorDataMap.setDataMap(dataMap);</div><div class="line">       List&lt;AbstractExecutionEvent&gt; events = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">       <span class="comment">// ç”Ÿæˆ Event</span></div><div class="line">       <span class="keyword">if</span> (parameterSets.isEmpty()) &#123;</div><div class="line">           events.add(getExecutionEvent(sqlType, baseStatementUnit, Collections.emptyList()));</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">for</span> (List&lt;Object&gt; each : parameterSets) &#123;</div><div class="line">               events.add(getExecutionEvent(sqlType, baseStatementUnit, each));</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// EventBus å‘å¸ƒ EventExecutionType.BEFORE_EXECUTE</span></div><div class="line">       <span class="keyword">for</span> (AbstractExecutionEvent event : events) &#123;</div><div class="line">           EventBusInstance.getInstance().post(event);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// æ‰§è¡Œå›è°ƒå‡½æ•°</span></div><div class="line">           result = executeCallback.execute(baseStatementUnit);</div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">           <span class="comment">// EventBus å‘å¸ƒ EventExecutionType.EXECUTE_FAILURE</span></div><div class="line">           <span class="keyword">for</span> (AbstractExecutionEvent each : events) &#123;</div><div class="line">               each.setEventExecutionType(EventExecutionType.EXECUTE_FAILURE);</div><div class="line">               each.setException(Optional.of(ex));</div><div class="line">               EventBusInstance.getInstance().post(each);</div><div class="line">               ExecutorExceptionHandler.handleException(ex);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// EventBus å‘å¸ƒ EventExecutionType.EXECUTE_SUCCESS</span></div><div class="line">       <span class="keyword">for</span> (AbstractExecutionEvent each : events) &#123;</div><div class="line">           each.setEventExecutionType(EventExecutionType.EXECUTE_SUCCESS);</div><div class="line">           EventBusInstance.getInstance().post(each);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>result = executeCallback.execute(baseStatementUnit);</code> æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚StatementExecutorï¼ŒPreparedStatementExecutorï¼ŒBatchPreparedStatementExecutor é€šè¿‡ä¼ é€’<strong>æ‰§è¡Œå›è°ƒå‡½æ•°</strong>( ExecuteCallback )å®ç°ç»™ ExecutorEngine å®ç°å¹¶è¡Œæ‰§è¡Œã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExecuteCallback</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰§è¡Œä»»åŠ¡.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> baseStatementUnit è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒ</div><div class="line">     * <span class="doctag">@return</span> å¤„ç†ç»“æœ</div><div class="line">     * <span class="doctag">@throws</span> Exception æ‰§è¡ŒæœŸå¼‚å¸¸</div><div class="line">     */</div><div class="line">    <span class="function">T <span class="title">execute</span><span class="params">(BaseStatementUnit baseStatementUnit)</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>synchronized (baseStatementUnit.getStatement().getConnection())</code> åŸä»¥ä¸º Connection éçº¿ç¨‹å®‰å…¨ï¼Œå› æ­¤éœ€è¦ç”¨<strong>åŒæ­¥</strong>ï¼Œåç¿»æŸ¥èµ„æ–™<a href="http://blog.csdn.net/goldenfish1919/article/details/9089667" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ•°æ®åº“è¿æ¥æ± ä¸ºä»€ä¹ˆè¦å»ºç«‹å¤šä¸ªè¿æ¥ã€‹</a>ï¼ŒConnection æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ç­‰è·Ÿå¼ äº®å¤§ç¥è¯·æ•™ç¡®è®¤åŸå› åï¼Œå’±ä¼šè¿›è¡Œæ›´æ–°ã€‚</li>
<li>ExecutionEvent è¿™é‡Œå…ˆä¸è§£é‡Šï¼Œåœ¨æœ¬æ–‡ç¬¬å››èŠ‚ã€EventBusã€‘åˆ†äº«ã€‚</li>
<li>ExecutorExceptionHandlerã€ExecutorDataMap å’Œ æŸ”æ€§äº‹åŠ¡ ( AbstractSoftTransaction )ï¼Œæ”¾åœ¨<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠæŸ”æ€§äº‹åŠ¡ã€‹</a>åˆ†äº«ã€‚</li>
</ul>
<h1>3. Executor</h1>
<p>Executorï¼Œæ‰§è¡Œå™¨ï¼Œç›®å‰ä¸€å…±æœ‰ä¸‰ä¸ªæ‰§è¡Œå™¨ã€‚ä¸åŒçš„æ‰§è¡Œå™¨å¯¹åº”ä¸åŒçš„æ‰§è¡Œå•å…ƒ (BaseStatementUnit)ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">æ‰§è¡Œå™¨ç±»</th>
<th style="text-align:left">æ‰§è¡Œå™¨å</th>
<th style="text-align:left">æ‰§è¡Œå•å…ƒ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">StatementExecutor</td>
<td style="text-align:left">é™æ€è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒ</td>
<td style="text-align:left">StatementUnit</td>
</tr>
<tr>
<td style="text-align:left">PreparedStatementExecutor</td>
<td style="text-align:left">é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡è¯·æ±‚çš„æ‰§è¡Œå™¨</td>
<td style="text-align:left">PreparedStatementUnit</td>
</tr>
<tr>
<td style="text-align:left">BatchPreparedStatementExecutor</td>
<td style="text-align:left">æ‰¹é‡é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡è¯·æ±‚çš„æ‰§è¡Œå™¨</td>
<td style="text-align:left">BatchPreparedStatementUnit</td>
</tr>
</tbody>
</table>
<ul>
<li>æ‰§è¡Œå™¨æä¾›çš„æ–¹æ³•ä¸åŒï¼Œå› æ­¤ä¸å­˜åœ¨å…¬ç”¨æ¥å£æˆ–è€…æŠ½è±¡ç±»ã€‚</li>
<li>æ‰§è¡Œå•å…ƒç»§æ‰¿è‡ª BaseStatementUnit</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/04.png" alt=""></p>
<h2>3.1 StatementExecutor</h2>
<p>StatementExecutorï¼Œ<strong>å¤šçº¿ç¨‹</strong>æ‰§è¡Œé™æ€è¯­å¥å¯¹è±¡è¯·æ±‚çš„æ‰§è¡Œå™¨ï¼Œä¸€å…±æœ‰ä¸‰ç±»æ–¹æ³•ï¼š</p>
<ul>
<li><code>#executeQuery()</code></li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// StatementExecutor.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡ŒSQLæŸ¥è¯¢.</div><div class="line">* <span class="doctag">@return</span> ç»“æœé›†åˆ—è¡¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;ResultSet&gt; <span class="title">executeQuery</span><span class="params">()</span> </span>&#123;</div><div class="line">   Context context = MetricsContext.start(<span class="string">"ShardingStatement-executeQuery"</span>);</div><div class="line">   List&lt;ResultSet&gt; result;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       result = executorEngine.executeStatement(sqlType, statementUnits, <span class="keyword">new</span> ExecuteCallback&lt;ResultSet&gt;() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> ResultSet <span class="title">execute</span><span class="params">(<span class="keyword">final</span> BaseStatementUnit baseStatementUnit)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">               <span class="keyword">return</span> baseStatementUnit.getStatement().executeQuery(baseStatementUnit.getSqlExecutionUnit().getSql());</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       MetricsContext.stop(context);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#executeUpdate()</code> å› ä¸ºæœ‰å››ä¸ªä¸åŒæƒ…å†µçš„<code>#executeUpdate()</code>ï¼Œæ‰€ä»¥æŠ½è±¡äº† Updater æ¥å£ï¼Œä»è€Œè¾¾åˆ°é€»è¾‘é‡ç”¨ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// StatementExecutor.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡ŒSQLæ›´æ–°.</div><div class="line">* <span class="doctag">@return</span> æ›´æ–°æ•°é‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> executeUpdate(<span class="keyword">new</span> Updater() &#123;</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">(<span class="keyword">final</span> Statement statement, <span class="keyword">final</span> String sql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">           <span class="keyword">return</span> statement.executeUpdate(sql);</div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">(<span class="keyword">final</span> Updater updater)</span> </span>&#123;</div><div class="line">   Context context = MetricsContext.start(<span class="string">"ShardingStatement-executeUpdate"</span>);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       List&lt;Integer&gt; results = executorEngine.executeStatement(sqlType, statementUnits, <span class="keyword">new</span> ExecuteCallback&lt;Integer&gt;() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> Integer <span class="title">execute</span><span class="params">(<span class="keyword">final</span> BaseStatementUnit baseStatementUnit)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">               <span class="keyword">return</span> updater.executeUpdate(baseStatementUnit.getStatement(), baseStatementUnit.getSqlExecutionUnit().getSql());</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       <span class="keyword">return</span> accumulate(results);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       MetricsContext.stop(context);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¡ç®—æ€»çš„æ›´æ–°æ•°é‡</div><div class="line">* <span class="doctag">@param</span> results æ›´æ–°æ•°é‡æ•°ç»„</div><div class="line">* <span class="doctag">@return</span> æ›´æ–°æ•°é‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">accumulate</span><span class="params">(<span class="keyword">final</span> List&lt;Integer&gt; results)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> result = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (Integer each : results) &#123;</div><div class="line">       result += <span class="keyword">null</span> == each ? <span class="number">0</span> : each;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#execute()</code> å› ä¸ºæœ‰å››ä¸ªä¸åŒæƒ…å†µçš„<code>#execute()</code>ï¼Œæ‰€ä»¥æŠ½è±¡äº† Executor æ¥å£ï¼Œä»è€Œè¾¾åˆ°é€»è¾‘é‡ç”¨ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡ŒSQLè¯·æ±‚.</div><div class="line">* <span class="doctag">@return</span> trueè¡¨ç¤ºæ‰§è¡ŒDQLè¯­å¥, falseè¡¨ç¤ºæ‰§è¡Œçš„DMLè¯­å¥</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> execute(<span class="keyword">new</span> Executor() &#123;</div><div class="line">       </div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Statement statement, <span class="keyword">final</span> String sql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">           <span class="keyword">return</span> statement.execute(sql);</div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Executor executor)</span> </span>&#123;</div><div class="line">   Context context = MetricsContext.start(<span class="string">"ShardingStatement-execute"</span>);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       List&lt;Boolean&gt; result = executorEngine.executeStatement(sqlType, statementUnits, <span class="keyword">new</span> ExecuteCallback&lt;Boolean&gt;() &#123; </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> Boolean <span class="title">execute</span><span class="params">(<span class="keyword">final</span> BaseStatementUnit baseStatementUnit)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">               <span class="keyword">return</span> executor.execute(baseStatementUnit.getStatement(), baseStatementUnit.getSqlExecutionUnit().getSql());</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> == result || result.isEmpty() || <span class="keyword">null</span> == result.get(<span class="number">0</span>)) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> result.get(<span class="number">0</span>);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       MetricsContext.stop(context);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.2 PreparedStatementExecutor</h2>
<p>PreparedStatementExecutorï¼Œ<strong>å¤šçº¿ç¨‹</strong>æ‰§è¡Œé¢„ç¼–è¯‘è¯­å¥å¯¹è±¡è¯·æ±‚çš„æ‰§è¡Œå™¨ã€‚æ¯” StatementExecutor å¤šäº† <code>parameters</code> å‚æ•°ï¼Œæ–¹æ³•é€»è¾‘ä¸ŠåŸºæœ¬ä¸€è‡´ï¼Œå°±ä¸é‡å¤åˆ†äº«å•¦ã€‚</p>
<h2>3.3 BatchPreparedStatementExecutor</h2>
<p>BatchPreparedStatementExecutorï¼Œ<strong>å¤šçº¿ç¨‹</strong>æ‰§è¡Œæ‰¹é‡é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡è¯·æ±‚çš„æ‰§è¡Œå™¨ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// BatchPreparedStatementExecutor.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œæ‰¹é‡SQL.</div><div class="line">* </div><div class="line">* <span class="doctag">@return</span> æ‰§è¡Œç»“æœ</div><div class="line">*/</div><div class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] executeBatch() &#123;</div><div class="line">   Context context = MetricsContext.start(<span class="string">"ShardingPreparedStatement-executeBatch"</span>);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">return</span> accumulate(executorEngine.executeBatch(sqlType, batchPreparedStatementUnits, parameterSets, <span class="keyword">new</span> ExecuteCallback&lt;<span class="keyword">int</span>[]&gt;() &#123;</div><div class="line">           </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="keyword">public</span> <span class="keyword">int</span>[] execute(<span class="keyword">final</span> BaseStatementUnit baseStatementUnit) <span class="keyword">throws</span> Exception &#123;</div><div class="line">               <span class="keyword">return</span> baseStatementUnit.getStatement().executeBatch();</div><div class="line">           &#125;</div><div class="line">       &#125;));</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       MetricsContext.stop(context);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¡ç®—æ¯ä¸ªè¯­å¥çš„æ›´æ–°æ•°é‡</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> results æ¯æ¡ SQL æ›´æ–°æ•°é‡</div><div class="line">* <span class="doctag">@return</span> æ¯ä¸ªè¯­å¥çš„æ›´æ–°æ•°é‡</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span>[] accumulate(<span class="keyword">final</span> List&lt;<span class="keyword">int</span>[]&gt; results) &#123;</div><div class="line">   <span class="keyword">int</span>[] result = <span class="keyword">new</span> <span class="keyword">int</span>[parameterSets.size()];</div><div class="line">   <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">   <span class="comment">// æ¯ä¸ªè¯­å¥æŒ‰ç…§é¡ºåºï¼Œè¯»å–åˆ°å…¶å¯¹åº”çš„æ¯ä¸ªåˆ†ç‰‡SQLå½±å“çš„è¡Œæ•°è¿›è¡Œç´¯åŠ </span></div><div class="line">   <span class="keyword">for</span> (BatchPreparedStatementUnit each : batchPreparedStatementUnits) &#123;</div><div class="line">       <span class="keyword">for</span> (Map.Entry&lt;Integer, Integer&gt; entry : each.getJdbcAndActualAddBatchCallTimesMap().entrySet()) &#123;</div><div class="line">           result[entry.getKey()] += <span class="keyword">null</span> == results.get(count) ? <span class="number">0</span> : results.get(count)[entry.getValue()];</div><div class="line">       &#125;</div><div class="line">       count++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>çœ¼å°–</strong>çš„åŒå­¦ä¼šå‘ç°ï¼Œä¸ºä»€ä¹ˆæœ‰ BatchPreparedStatementExecutorï¼Œè€Œæ²¡æœ‰ BatchStatementExecutor å‘¢ï¼Ÿç›®å‰ Sharding-JDBC ä¸æ”¯æŒ Statement æ‰¹é‡æ“ä½œï¼Œåªèƒ½è¿›è¡Œ PreparedStatement çš„æ‰¹æ“ä½œã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PreparedStatement æ‰¹é‡æ“ä½œï¼Œä¸ä¼šæŠ¥é”™</span></div><div class="line">PreparedStatement ps = conn.prepareStatement(sql)</div><div class="line">ps.addBatch();</div><div class="line">ps.addBatch();</div><div class="line"></div><div class="line"><span class="comment">// Statement æ‰¹é‡æ“ä½œï¼Œä¼šæŠ¥é”™</span></div><div class="line">ps.addBatch(sql); <span class="comment">// æŠ¥é”™ï¼šat com.dangdang.ddframe.rdb.sharding.jdbc.unsupported.AbstractUnsupportedOperationStatement.addBatch</span></div></pre></td></tr></table></figure></p>
<h1>4. ExecutionEvent</h1>
<p>AbstractExecutionEventï¼ŒSQL æ‰§è¡Œäº‹ä»¶æŠ½è±¡æ¥å£ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractExecutionEvent</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * äº‹ä»¶ç¼–å·</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String id;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•°æ®æº</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String dataSource;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String sql;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å‚æ•°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; parameters;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * äº‹ä»¶ç±»å‹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> EventExecutionType eventExecutionType;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¼‚å¸¸</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Optional&lt;SQLException&gt; exception;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>AbstractExecutionEvent æœ‰ä¸¤ä¸ªå®ç°å­ç±»ï¼š</p>
<ul>
<li>DMLExecutionEventï¼šDMLç±»SQLæ‰§è¡Œæ—¶äº‹ä»¶</li>
<li>DQLExecutionEventï¼šDQLç±»SQLæ‰§è¡Œæ—¶äº‹ä»¶</li>
</ul>
<p>EventExecutionTypeï¼Œäº‹ä»¶è§¦å‘ç±»å‹ã€‚</p>
<ul>
<li>BEFORE_EXECUTEï¼šæ‰§è¡Œå‰</li>
<li>EXECUTE_SUCCESSï¼šæ‰§è¡ŒæˆåŠŸ</li>
<li>EXECUTE_FAILUREï¼šæ‰§è¡Œå¤±è´¥</li>
</ul>
<h2>4.1 EventBus</h2>
<p><strong>é‚£ç©¶ç«Ÿæœ‰ä»€ä¹ˆç”¨é€”å‘¢ï¼Ÿ</strong> Sharding-JDBC ä½¿ç”¨ Guavaï¼ˆ<strong>æ²¡é”™ï¼Œåˆæ˜¯å®ƒ</strong>ï¼‰çš„ <strong>EventBus</strong> å®ç°äº†<strong>äº‹ä»¶çš„å‘å¸ƒå’Œè®¢é˜…</strong>ã€‚ä»ä¸Šæ–‡ <code>ExecutorEngine#executeInternal()</code> æˆ‘ä»¬å¯ä»¥çœ‹åˆ°<strong>æ¯ä¸ªåˆ†ç‰‡</strong> SQL æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¼šå‘å¸ƒç›¸åº”äº‹ä»¶ï¼š</p>
<ul>
<li>æ‰§è¡Œ SQL å‰ï¼šå‘å¸ƒç±»å‹ç±»å‹ä¸º BEFORE_EXECUTE çš„äº‹ä»¶</li>
<li>æ‰§è¡Œ SQL æˆåŠŸï¼šå‘å¸ƒç±»å‹ç±»å‹ä¸º EXECUTE_SUCCESS çš„äº‹ä»¶</li>
<li>æ‰§è¡Œ SQL å¤±è´¥ï¼šå‘å¸ƒç±»å‹ç±»å‹ä¸º EXECUTE_FAILURE çš„äº‹ä»¶</li>
</ul>
<p>**æ€ä¹ˆè®¢é˜…äº‹ä»¶å‘¢ï¼Ÿ**éå¸¸ç®€å•ï¼Œä¾‹å­å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">EventBusInstance.getInstance().register(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Subscribe</span> <span class="comment">// è®¢é˜…</span></div><div class="line">  <span class="meta">@AllowConcurrentEvents</span> <span class="comment">// æ˜¯å¦å…è®¸å¹¶å‘æ‰§è¡Œï¼Œå³çº¿ç¨‹å®‰å…¨</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(<span class="keyword">final</span> DMLExecutionEvent event)</span> </span>&#123; <span class="comment">// DMLExecutionEvent</span></div><div class="line">      System.out.println(<span class="string">"DMLExecutionEventï¼š"</span> + event.getSql() + <span class="string">"\t"</span> + event.getEventExecutionType());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Subscribe</span> <span class="comment">// è®¢é˜…</span></div><div class="line">  <span class="meta">@AllowConcurrentEvents</span> <span class="comment">// æ˜¯å¦å…è®¸å¹¶å‘æ‰§è¡Œï¼Œå³çº¿ç¨‹å®‰å…¨</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen2</span><span class="params">(<span class="keyword">final</span> DQLExecutionEvent event)</span> </span>&#123; <span class="comment">//DQLExecutionEvent</span></div><div class="line">      System.out.println(<span class="string">"DQLExecutionEventï¼š"</span> + event.getSql() + <span class="string">"\t"</span> + event.getEventExecutionType());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#register()</code> ä»»ä½•ç±»éƒ½å¯ä»¥ï¼Œå¹¶éä¸€å®šéœ€è¦ä½¿ç”¨ Runnable ç±»ã€‚æ­¤å¤„ä¾‹å­å•çº¯å› ä¸ºæ–¹ä¾¿</li>
<li><code>@Subscribe</code> æ³¨è§£åœ¨æ–¹æ³•ä¸Šï¼Œå®ç°å¯¹äº‹ä»¶çš„è®¢é˜…</li>
<li><code>@AllowConcurrentEvents</code> æ³¨è§£åœ¨æ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºçº¿ç¨‹å®‰å…¨ï¼Œå…è®¸å¹¶å‘æ‰§è¡Œ</li>
<li>æ–¹æ³•ä¸Šçš„<strong>å‚æ•°å¯¹åº”çš„ç±»</strong>å³æ˜¯è®¢é˜…çš„äº‹ä»¶ã€‚ä¾‹å¦‚ï¼Œ<code>#listen()</code> è®¢é˜…äº† DMLExecutionEvent äº‹ä»¶</li>
<li><code>EventBus#post()</code> å‘å¸ƒäº‹ä»¶ï¼Œ<strong>åŒæ­¥</strong>è°ƒç”¨è®¢é˜…é€»è¾‘</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/05.png" alt=""></p>
<ul>
<li>æ¨èé˜…è¯»æ–‡ç« ï¼š<a href="http://www.cnblogs.com/peida/p/EventBus.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠGuavaå­¦ä¹ ç¬”è®°ï¼šEventBusã€‹</a></li>
</ul>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>
ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h2>4.2 BestEffortsDeliveryListener</h2>
<p>BestEffortsDeliveryListenerï¼Œæœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨ã€‚</p>
<p>æœ¬æ–‡æš‚æ—¶æš‚æ—¶ä¸åˆ†æå…¶å®ç°ï¼Œä»…ä»…ä½œä¸ºå¦å¤–ä¸€ä¸ª<strong>è®¢é˜…è€…</strong>çš„ä¾‹å­ã€‚æˆ‘ä»¬ä¼šåœ¨<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠæŸ”æ€§äº‹åŠ¡ã€‹</a>è¿›è¡Œåˆ†äº«ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BestEffortsDeliveryListener</span> </span>&#123;</div><div class="line">    <span class="meta">@Subscribe</span></div><div class="line">    <span class="meta">@AllowConcurrentEvents</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(<span class="keyword">final</span> DMLExecutionEvent event)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!isProcessContinuously()) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        SoftTransactionConfiguration transactionConfig = SoftTransactionManager.getCurrentTransactionConfiguration().get();</div><div class="line">        TransactionLogStorage transactionLogStorage = TransactionLogStorageFactory.createTransactionLogStorage(transactionConfig.buildTransactionLogDataSource());</div><div class="line">        BEDSoftTransaction bedSoftTransaction = (BEDSoftTransaction) SoftTransactionManager.getCurrentTransaction().get();</div><div class="line">        <span class="keyword">switch</span> (event.getEventExecutionType()) &#123;</div><div class="line">            <span class="keyword">case</span> BEFORE_EXECUTE:</div><div class="line">                <span class="comment">//TODO å¯¹äºæ‰¹é‡æ‰§è¡Œçš„SQLéœ€è¦è§£ææˆä¸¤å±‚åˆ—è¡¨</span></div><div class="line">                transactionLogStorage.add(<span class="keyword">new</span> TransactionLog(event.getId(), bedSoftTransaction.getTransactionId(), bedSoftTransaction.getTransactionType(), </div><div class="line">                        event.getDataSource(), event.getSql(), event.getParameters(), System.currentTimeMillis(), <span class="number">0</span>));</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            <span class="keyword">case</span> EXECUTE_SUCCESS: </div><div class="line">                transactionLogStorage.remove(event.getId());</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            <span class="keyword">case</span> EXECUTE_FAILURE: </div><div class="line">                <span class="keyword">boolean</span> deliverySuccess = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; transactionConfig.getSyncMaxDeliveryTryTimes(); i++) &#123;</div><div class="line">                    <span class="keyword">if</span> (deliverySuccess) &#123;</div><div class="line">                        <span class="keyword">return</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">boolean</span> isNewConnection = <span class="keyword">false</span>;</div><div class="line">                    Connection conn = <span class="keyword">null</span>;</div><div class="line">                    PreparedStatement preparedStatement = <span class="keyword">null</span>;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        conn = bedSoftTransaction.getConnection().getConnection(event.getDataSource(), SQLType.UPDATE);</div><div class="line">                        <span class="keyword">if</span> (!isValidConnection(conn)) &#123;</div><div class="line">                            bedSoftTransaction.getConnection().release(conn);</div><div class="line">                            conn = bedSoftTransaction.getConnection().getConnection(event.getDataSource(), SQLType.UPDATE);</div><div class="line">                            isNewConnection = <span class="keyword">true</span>;</div><div class="line">                        &#125;</div><div class="line">                        preparedStatement = conn.prepareStatement(event.getSql());</div><div class="line">                        <span class="comment">//TODO å¯¹äºæ‰¹é‡äº‹ä»¶éœ€è¦è§£ææˆä¸¤å±‚åˆ—è¡¨</span></div><div class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> parameterIndex = <span class="number">0</span>; parameterIndex &lt; event.getParameters().size(); parameterIndex++) &#123;</div><div class="line">                            preparedStatement.setObject(parameterIndex + <span class="number">1</span>, event.getParameters().get(parameterIndex));</div><div class="line">                        &#125;</div><div class="line">                        preparedStatement.executeUpdate();</div><div class="line">                        deliverySuccess = <span class="keyword">true</span>;</div><div class="line">                        transactionLogStorage.remove(event.getId());</div><div class="line">                    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">                        log.error(String.format(<span class="string">"Delivery times %s error, max try times is %s"</span>, i + <span class="number">1</span>, transactionConfig.getSyncMaxDeliveryTryTimes()), ex);</div><div class="line">                    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                        close(isNewConnection, conn, preparedStatement);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            <span class="keyword">default</span>: </div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(event.getEventExecutionType().toString());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>666. å½©è›‹</h1>
<p>æœ¬æ–‡å®Œï¼Œä½†ä¹Ÿæœªå®Œã€‚</p>
<p><strong>è·¨åˆ†ç‰‡äº‹åŠ¡é—®é¢˜</strong>ã€‚ä¾‹å¦‚ï¼š</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">UPDATE</span> t_order <span class="keyword">SET</span> nickname = ? <span class="keyword">WHERE</span> user_id = ?</div></pre></td></tr></table></figure></p>
<p>A èŠ‚ç‚¹ <code>connection.commit()</code> æ—¶ï¼Œåº”ç”¨çªç„¶æŒ‚äº†ï¼BèŠ‚ç‚¹ <code>connection.commit()</code> è¿˜æ¥ä¸åŠæ‰§è¡Œã€‚<br>
æˆ‘ä»¬ä¸€èµ·å»<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠæŸ”æ€§äº‹åŠ¡ã€‹</a>å¯»æ‰¾ç­”æ¡ˆã€‚</p>
<p><strong>é“å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼Ÿ</strong></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;o
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” åˆ†å¸ƒå¼ä¸»é”®</title>
    <link href="http://www.yunai.me/Sharding-JDBC/distributed-id/"/>
    <id>http://www.yunai.me/Sharding-JDBC/distributed-id/</id>
    <published>2017-08-11T16:00:00.000Z</published>
    <updated>2017-08-10T17:26:04.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Sharding-JDBC 1.5.0 æ­£å¼ç‰ˆ</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2.KeyGenerator</a>
<ul>
<li><a href="#">2.1 DefaultKeyGenerator</a></li>
<li><a href="#">2.2 HostNameKeyGenerator</a></li>
<li><a href="#">2.3 IPKeyGenerator</a></li>
<li><a href="#">2.4 IPSectionKeyGenerator</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡åˆ†äº« Sharding-JDBC <strong>åˆ†å¸ƒå¼ä¸»é”®</strong>å®ç°ã€‚</p>
<p>å®˜æ–¹æ–‡æ¡£<a href="http://dangdangdotcom.github.io/sharding-jdbc/02-guide/key-generator/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šåˆ†å¸ƒå¼ä¸»é”®ã€‹</a>å¯¹å…¶ä»‹ç»åŠä½¿ç”¨æ–¹å¼ä»‹ç»å¾ˆå®Œæ•´ï¼Œå¼ºçƒˆå…ˆé˜…è¯»ã€‚ä¸‹é¢å…ˆå¼•ç”¨ä¸‹åˆ†å¸ƒå¼ä¸»é”®çš„<strong>å®ç°åŠ¨æœº</strong>ï¼š</p>
<blockquote>
<p>ä¼ ç»Ÿæ•°æ®åº“è½¯ä»¶å¼€å‘ä¸­ï¼Œä¸»é”®è‡ªåŠ¨ç”ŸæˆæŠ€æœ¯æ˜¯åŸºæœ¬éœ€æ±‚ã€‚è€Œå„å¤§æ•°æ®åº“å¯¹äºè¯¥éœ€æ±‚ä¹Ÿæä¾›äº†ç›¸åº”çš„æ”¯æŒï¼Œæ¯”å¦‚MySQLçš„è‡ªå¢é”®ã€‚å¯¹äºMySQLè€Œè¨€ï¼Œåˆ†åº“åˆ†è¡¨ä¹‹åï¼Œä¸åŒè¡¨ç”Ÿæˆå…¨å±€å”¯ä¸€çš„Idæ˜¯éå¸¸æ£˜æ‰‹çš„é—®é¢˜ã€‚å› ä¸ºåŒä¸€ä¸ªé€»è¾‘è¡¨å†…çš„ä¸åŒå®é™…è¡¨ä¹‹é—´çš„è‡ªå¢é”®æ˜¯æ— æ³•äº’ç›¸æ„ŸçŸ¥çš„ï¼Œè¿™æ ·ä¼šé€ æˆé‡å¤Idçš„ç”Ÿæˆã€‚æˆ‘ä»¬å½“ç„¶å¯ä»¥é€šè¿‡çº¦æŸè¡¨ç”Ÿæˆé”®çš„è§„åˆ™æ¥è¾¾åˆ°æ•°æ®çš„ä¸é‡å¤ï¼Œä½†æ˜¯è¿™éœ€è¦å¼•å…¥é¢å¤–çš„è¿ç»´åŠ›é‡æ¥è§£å†³é‡å¤æ€§é—®é¢˜ï¼Œå¹¶ä½¿æ¡†æ¶ç¼ºä¹æ‰©å±•æ€§ã€‚</p>
</blockquote>
<blockquote>
<p>ç›®å‰æœ‰è®¸å¤šç¬¬ä¸‰æ–¹è§£å†³æ–¹æ¡ˆå¯ä»¥å®Œç¾è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚UUIDç­‰ä¾é ç‰¹å®šç®—æ³•è‡ªç”Ÿæˆä¸é‡å¤é”®ï¼Œæˆ–è€…é€šè¿‡å¼•å…¥Idç”ŸæˆæœåŠ¡ç­‰ã€‚ ä½†ä¹Ÿæ­£å› ä¸ºè¿™ç§å¤šæ ·æ€§å¯¼è‡´äº†Sharding-JDBCå¦‚æœå¼ºä¾èµ–äºä»»ä½•ä¸€ç§æ–¹æ¡ˆå°±ä¼šé™åˆ¶å…¶è‡ªèº«çš„å‘å±•ã€‚</p>
</blockquote>
<blockquote>
<p>åŸºäºä»¥ä¸Šçš„åŸå› ï¼Œæœ€ç»ˆé‡‡ç”¨äº†ä»¥JDBCæ¥å£æ¥å®ç°å¯¹äºç”ŸæˆIdçš„è®¿é—®ï¼Œè€Œå°†åº•å±‚å…·ä½“çš„Idç”Ÿæˆå®ç°åˆ†ç¦»å‡ºæ¥ã€‚</p>
</blockquote>
<hr>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>
ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1>2. KeyGenerator</h1>
<p>KeyGeneratorï¼Œä¸»é”®ç”Ÿæˆå™¨æ¥å£ã€‚å®ç°ç±»é€šè¿‡å®ç° <code>#generateKey()</code> æ–¹æ³•å¯¹å¤–æä¾›<strong>ç”Ÿæˆä¸»é”®</strong>çš„åŠŸèƒ½ã€‚</p>
<h2>2.1 DefaultKeyGenerator</h2>
<p>DefaultKeyGeneratorï¼Œé»˜è®¤çš„ä¸»é”®ç”Ÿæˆå™¨ã€‚è¯¥ç”Ÿæˆå™¨é‡‡ç”¨ Twitter Snowflake ç®—æ³•å®ç°ï¼Œç”Ÿæˆ <strong>64 Bits</strong> çš„ <strong>Long</strong> å‹ç¼–å·ã€‚å›½å†…å¦å¤–ä¸€æ¬¾æ•°æ®åº“ä¸­é—´ä»¶ MyCAT åˆ†å¸ƒå¼ä¸»é”®ä¹Ÿæ˜¯åŸºäºè¯¥ç®—æ³•å®ç°ã€‚å›½å†…å¾ˆå¤šå¤§å‹äº’è”ç½‘å…¬å¸<strong>å‘å·å™¨</strong>æœåŠ¡åŸºäºè¯¥ç®—æ³•åŠ éƒ¨åˆ†æ”¹é€ å®ç°ã€‚æ‰€ä»¥ DefaultKeyGenerator å¿…é¡»æ˜¯<strong>æ ¹æ­£è‹—çº¢</strong>ã€‚å¦‚æœä½ å¯¹<strong>åˆ†å¸ƒå¼ä¸»é”®</strong>æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹çœ‹é€—æ¯”ç¬”è€…æ•´ç†çš„<a href="http://www.yunai.me/Architecture/talk-about-global-id/?self">ã€Šè°ˆè°ˆ IDã€‹</a>ã€‚</p>
<p>å’³å’³å’³ï¼Œæœ‰ç‚¹è·‘é¢˜äº†ã€‚<strong>ç¼–å·</strong>ç”±å››éƒ¨åˆ†ç»„æˆï¼Œä»é«˜ä½åˆ°ä½ä½ï¼ˆä»å·¦åˆ°å³ï¼‰åˆ†åˆ«æ˜¯ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_12/01.png" alt=""></p>
<table>
<thead>
<tr>
<th style="text-align:left">Bits</th>
<th style="text-align:left">åå­—</th>
<th style="text-align:left">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">ç¬¦å·ä½</td>
<td style="text-align:left">ç­‰äº 0</td>
</tr>
<tr>
<td style="text-align:left">41</td>
<td style="text-align:left">æ—¶é—´æˆ³</td>
<td style="text-align:left">ä» 2016/11/01 é›¶ç‚¹å¼€å§‹çš„æ¯«ç§’æ•°ï¼Œæ”¯æŒ 2 ^41 /365/24/60/60/1000=69.7å¹´</td>
</tr>
<tr>
<td style="text-align:left">10</td>
<td style="text-align:left">å·¥ä½œè¿›ç¨‹ç¼–å·</td>
<td style="text-align:left">æ”¯æŒ 1024 ä¸ªè¿›ç¨‹</td>
</tr>
<tr>
<td style="text-align:left">12</td>
<td style="text-align:left">åºåˆ—å·</td>
<td style="text-align:left">æ¯æ¯«ç§’ä» 0 å¼€å§‹è‡ªå¢ï¼Œæ”¯æŒ 4096 ä¸ªç¼–å·</td>
</tr>
</tbody>
</table>
<ul>
<li>æ¯ä¸ªå·¥ä½œè¿›ç¨‹æ¯ç§’å¯ä»¥äº§ç”Ÿ 4096000 ä¸ªç¼–å·ã€‚æ˜¯ä¸æ˜¯ç°å¸¸ç‰›æ¯” ğŸ’¯</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// </span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultKeyGenerator</span> <span class="keyword">implements</span> <span class="title">KeyGenerator</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ—¶é—´åç§»é‡ï¼Œä»2016å¹´11æœˆ1æ—¥é›¶ç‚¹å¼€å§‹</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> EPOCH;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è‡ªå¢é‡å ç”¨æ¯”ç‰¹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SEQUENCE_BITS = <span class="number">12L</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å·¥ä½œè¿›ç¨‹IDæ¯”ç‰¹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> WORKER_ID_BITS = <span class="number">10L</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è‡ªå¢é‡æ©ç ï¼ˆæœ€å¤§å€¼ï¼‰</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SEQUENCE_MASK = (<span class="number">1</span> &lt;&lt; SEQUENCE_BITS) - <span class="number">1</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å·¥ä½œè¿›ç¨‹IDå·¦ç§»æ¯”ç‰¹æ•°ï¼ˆä½æ•°ï¼‰</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> WORKER_ID_LEFT_SHIFT_BITS = SEQUENCE_BITS;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ—¶é—´æˆ³å·¦ç§»æ¯”ç‰¹æ•°ï¼ˆä½æ•°ï¼‰</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> TIMESTAMP_LEFT_SHIFT_BITS = WORKER_ID_LEFT_SHIFT_BITS + WORKER_ID_BITS;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å·¥ä½œè¿›ç¨‹IDæœ€å¤§å€¼</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> WORKER_ID_MAX_VALUE = <span class="number">1L</span> &lt;&lt; WORKER_ID_BITS;</div><div class="line">    </div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> TimeService timeService = <span class="keyword">new</span> TimeService();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å·¥ä½œè¿›ç¨‹ID</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> workerId;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        Calendar calendar = Calendar.getInstance();</div><div class="line">        calendar.set(<span class="number">2016</span>, Calendar.NOVEMBER, <span class="number">1</span>);</div><div class="line">        calendar.set(Calendar.HOUR_OF_DAY, <span class="number">0</span>);</div><div class="line">        calendar.set(Calendar.MINUTE, <span class="number">0</span>);</div><div class="line">        calendar.set(Calendar.SECOND, <span class="number">0</span>);</div><div class="line">        calendar.set(Calendar.MILLISECOND, <span class="number">0</span>);</div><div class="line">        EPOCH = calendar.getTimeInMillis();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æœ€åè‡ªå¢é‡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> sequence;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æœ€åç”Ÿæˆç¼–å·æ—¶é—´æˆ³ï¼Œå•ä½ï¼šæ¯«ç§’</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> lastTime;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è®¾ç½®å·¥ä½œè¿›ç¨‹Id.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> workerId å·¥ä½œè¿›ç¨‹Id</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setWorkerId</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> workerId)</span> </span>&#123;</div><div class="line">        Preconditions.checkArgument(workerId &gt;= <span class="number">0L</span> &amp;&amp; workerId &lt; WORKER_ID_MAX_VALUE);</div><div class="line">        DefaultKeyGenerator.workerId = workerId;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç”ŸæˆId.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span> è¿”å›@&#123;<span class="doctag">@link</span> Long&#125;ç±»å‹çš„Id</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Number <span class="title">generateKey</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// ä¿è¯å½“å‰æ—¶é—´å¤§äºæœ€åæ—¶é—´ã€‚æ—¶é—´å›é€€ä¼šå¯¼è‡´äº§ç”Ÿé‡å¤id</span></div><div class="line">        <span class="keyword">long</span> currentMillis = timeService.getCurrentMillis();</div><div class="line">        Preconditions.checkState(lastTime &lt;= currentMillis, <span class="string">"Clock is moving backwards, last time is %d milliseconds, current time is %d milliseconds"</span>, lastTime, currentMillis);</div><div class="line">        <span class="comment">// è·å–åºåˆ—å·</span></div><div class="line">        <span class="keyword">if</span> (lastTime == currentMillis) &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="number">0L</span> == (sequence = ++sequence &amp; SEQUENCE_MASK)) &#123; <span class="comment">// å½“è·å¾—åºå·è¶…è¿‡æœ€å¤§å€¼æ—¶ï¼Œå½’0ï¼Œå¹¶å»è·å¾—æ–°çš„æ—¶é—´</span></div><div class="line">                currentMillis = waitUntilNextTime(currentMillis);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            sequence = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// è®¾ç½®æœ€åæ—¶é—´æˆ³</span></div><div class="line">        lastTime = currentMillis;</div><div class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">            log.debug(<span class="string">"&#123;&#125;-&#123;&#125;-&#123;&#125;"</span>, <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss.SSS"</span>).format(<span class="keyword">new</span> Date(lastTime)), workerId, sequence);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// ç”Ÿæˆç¼–å·</span></div><div class="line">        <span class="keyword">return</span> ((currentMillis - EPOCH) &lt;&lt; TIMESTAMP_LEFT_SHIFT_BITS) | (workerId &lt;&lt; WORKER_ID_LEFT_SHIFT_BITS) | sequence;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸åœè·å¾—æ—¶é—´ï¼Œç›´åˆ°å¤§äºæœ€åæ—¶é—´</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> lastTime æœ€åæ—¶é—´</div><div class="line">     * <span class="doctag">@return</span> æ—¶é—´</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">waitUntilNextTime</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> lastTime)</span> </span>&#123;</div><div class="line">        <span class="keyword">long</span> time = timeService.getCurrentMillis();</div><div class="line">        <span class="keyword">while</span> (time &lt;= lastTime) &#123;</div><div class="line">            time = timeService.getCurrentMillis();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> time;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>EPOCH = calendar.getTimeInMillis();</code> è®¡ç®— 2016/11/01 é›¶ç‚¹å¼€å§‹çš„æ¯«ç§’æ•°ã€‚</li>
<li><code>#generateKey()</code> å®ç°é€»è¾‘
<ol>
<li>æ ¡éªŒå½“å‰æ—¶é—´<strong>å°äºç­‰äº</strong>æœ€åç”Ÿæˆç¼–å·æ—¶é—´æˆ³ï¼Œé¿å…æœåŠ¡å™¨æ—¶é’ŸåŒæ­¥ï¼Œå¯èƒ½äº§ç”Ÿæ—¶é—´å›é€€ï¼Œå¯¼è‡´äº§ç”Ÿ<strong>é‡å¤</strong>ç¼–å·</li>
</ol>
<ul>
<li>è·å¾—åºåˆ—å·ã€‚å½“å‰æ—¶é—´æˆ³å¯è·å¾—è‡ªå¢é‡åˆ°è¾¾æœ€å¤§å€¼æ—¶ï¼Œè°ƒç”¨ <code>#waitUntilNextTime()</code> è·å¾—ä¸‹ä¸€æ¯«ç§’</li>
<li>è®¾ç½®æœ€åç”Ÿæˆç¼–å·æ—¶é—´æˆ³ï¼Œç”¨äºæ ¡éªŒæ—¶é—´å›é€€æƒ…å†µ</li>
<li>ä½æ“ä½œç”Ÿæˆ<strong>ç¼–å·</strong></li>
</ul>
</li>
</ul>
<p>æ€»çš„æ¥è¯´ï¼ŒTwitter Snowflake ç®—æ³•å®ç°ä¸Šæ˜¯ç›¸å¯¹ç®€å•æ˜“æ‡‚çš„ï¼Œè¾ƒä¸ºéº»çƒ¦çš„æ˜¯<strong>æ€ä¹ˆè§£å†³å·¥ä½œè¿›ç¨‹ç¼–å·çš„åˆ†é…</strong>ï¼Ÿ</p>
<ol>
<li>è¶…è¿‡ 1024 ä¸ªæ€ä¹ˆåŠï¼Ÿ</li>
<li>æ€ä¹ˆä¿è¯å…¨å±€å”¯ä¸€ï¼Ÿ</li>
</ol>
<p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå°†åˆ†å¸ƒå¼ä¸»é”®ç”Ÿæˆç‹¬ç«‹æˆä¸€ä¸ª<strong>å‘å·å™¨</strong>æœåŠ¡ï¼Œæä¾›ç”Ÿæˆåˆ†å¸ƒå¼ç¼–å·çš„åŠŸèƒ½ã€‚è¿™ä¸ªä¸åœ¨æœ¬æ–‡çš„èŒƒå›´å†…ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ Google ä¸‹ã€‚</p>
<p>ç¬¬äºŒä¸ªé—®é¢˜ï¼Œé€šè¿‡ Zookeeperã€Consulã€Etcd ç­‰æä¾›åˆ†å¸ƒå¼é…ç½®åŠŸèƒ½çš„ä¸­é—´ä»¶ã€‚å½“ç„¶ Sharding-JDBC ä¹Ÿæä¾›äº†ä¸ä¾èµ–è¿™äº›æœåŠ¡çš„æ–¹å¼ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªå¾€ä¸‹çœ‹ã€‚</p>
<h2>2.2 HostNameKeyGenerator</h2>
<blockquote>
<p>æ ¹æ®<strong>æœºå™¨åæœ€åçš„æ•°å­—ç¼–å·</strong>è·å–å·¥ä½œè¿›ç¨‹ç¼–å·ã€‚<br>
å¦‚æœçº¿ä¸Šæœºå™¨å‘½åæœ‰ç»Ÿä¸€è§„èŒƒ,å»ºè®®ä½¿ç”¨æ­¤ç§æ–¹å¼ã€‚<br>
ä¾‹å¦‚ï¼Œæœºå™¨çš„ HostName ä¸º: <code>dangdang-db-sharding-dev-01</code>(å…¬å¸å-éƒ¨é—¨å-æœåŠ¡å-ç¯å¢ƒå-ç¼–å·)ï¼Œä¼šæˆªå– HostName æœ€åçš„ç¼–å· 01 ä½œä¸ºå·¥ä½œè¿›ç¨‹ç¼–å·( workId )ã€‚</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// HostNameKeyGenerator.java</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initWorkerId</span><span class="params">()</span> </span>&#123;</div><div class="line">   InetAddress address;</div><div class="line">   Long workerId;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       address = InetAddress.getLocalHost();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> UnknownHostException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot get LocalHost InetAddress, please check your network!"</span>);</div><div class="line">   &#125;</div><div class="line">   String hostName = address.getHostName();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       workerId = Long.valueOf(hostName.replace(hostName.replaceAll(<span class="string">"\\d+$"</span>, <span class="string">""</span>), <span class="string">""</span>));</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> NumberFormatException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(<span class="string">"Wrong hostname:%s, hostname must be end with number!"</span>, hostName));</div><div class="line">   &#125;</div><div class="line">   DefaultKeyGenerator.setWorkerId(workerId);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>2.3 IPKeyGenerator</h2>
<blockquote>
<p>æ ¹æ®<strong>æœºå™¨IP</strong>è·å–å·¥ä½œè¿›ç¨‹ç¼–å·ã€‚<br>
å¦‚æœçº¿ä¸Šæœºå™¨çš„IPäºŒè¿›åˆ¶è¡¨ç¤ºçš„æœ€å10ä½ä¸é‡å¤,å»ºè®®ä½¿ç”¨æ­¤ç§æ–¹å¼ã€‚<br>
ä¾‹å¦‚ï¼Œæœºå™¨çš„IPä¸º192.168.1.108ï¼ŒäºŒè¿›åˆ¶è¡¨ç¤º:<code>11000000 10101000 00000001 01101100</code>ï¼Œæˆªå–æœ€å 10 ä½ <code>01 01101100</code>ï¼Œè½¬ä¸ºåè¿›åˆ¶ 364ï¼Œè®¾ç½®å·¥ä½œè¿›ç¨‹ç¼–å·ä¸º 364ã€‚</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// IPKeyGenerator.java</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initWorkerId</span><span class="params">()</span> </span>&#123;</div><div class="line">   InetAddress address;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       address = InetAddress.getLocalHost();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> UnknownHostException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot get LocalHost InetAddress, please check your network!"</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">byte</span>[] ipAddressByteArray = address.getAddress();</div><div class="line">   DefaultKeyGenerator.setWorkerId((<span class="keyword">long</span>) (((ipAddressByteArray[ipAddressByteArray.length - <span class="number">2</span>] &amp; <span class="number">0B11</span>) &lt;&lt; Byte.SIZE)</div><div class="line">           + (ipAddressByteArray[ipAddressByteArray.length - <span class="number">1</span>] &amp; <span class="number">0xFF</span>)));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>2.4 IPSectionKeyGenerator</h2>
<p>æ¥è‡ª <strong>DogFc</strong> è´¡çŒ®ï¼Œå¯¹ IPKeyGenerator è¿›è¡Œæ”¹é€ ã€‚</p>
<blockquote>
<p>æµè§ˆ IPKeyGenerator å·¥ä½œè¿›ç¨‹ç¼–å·ç”Ÿæˆçš„è§„åˆ™åï¼Œæ„Ÿè§‰å¯¹æœåŠ¡å™¨IPå10ä½ï¼ˆç‰¹åˆ«æ˜¯IPV6ï¼‰æ•°å€¼æ¯”è¾ƒçº¦æŸã€‚<br>
æœ‰ä»¥ä¸‹ä¼˜åŒ–æ€è·¯ï¼š<br>
å› ä¸ºå·¥ä½œè¿›ç¨‹ç¼–å·æœ€å¤§é™åˆ¶æ˜¯ 2^10ï¼Œæˆ‘ä»¬ç”Ÿæˆçš„å·¥ç¨‹è¿›ç¨‹ç¼–å·åªè¦æ»¡è¶³å°äº 1024 å³å¯ã€‚<br>
1.é’ˆå¯¹IPV4:<br>
....IPæœ€å¤§ 255.255.255.255ã€‚è€Œï¼ˆ255+255+255+255) &lt; 1024ã€‚<br>
....å› æ­¤é‡‡ç”¨IPæ®µæ•°å€¼ç›¸åŠ å³å¯ç”Ÿæˆå”¯ä¸€çš„workerIdï¼Œä¸å—IPä½é™åˆ¶ã€‚</p>
</blockquote>
<ol start="2">
<li>é’ˆå¯¹IPV6:<br>
....IPæœ€å¤§ ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff<br>
....ä¸ºäº†ä¿è¯ç›¸åŠ ç”Ÿæˆå‡ºçš„å·¥ç¨‹è¿›ç¨‹ç¼–å· &lt; 1024,æ€è·¯æ˜¯å°†æ¯ä¸ª Bit ä½çš„å6ä½ç›¸åŠ ã€‚è¿™æ ·åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¹Ÿå¯ä»¥æ»¡è¶³workerIdä¸é‡å¤çš„é—®é¢˜ã€‚<br>
ä½¿ç”¨è¿™ç§ IP ç”Ÿæˆå·¥ä½œè¿›ç¨‹ç¼–å·çš„æ–¹æ³•,å¿…é¡»ä¿è¯IPæ®µç›¸åŠ ä¸èƒ½é‡å¤</li>
</ol>
<p>å¯¹äº IPV6 ï¼š2^ 6 = 64ã€‚64 * 8 = 512 &lt; 1024ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// IPSectionKeyGenerator.java</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initWorkerId</span><span class="params">()</span> </span>&#123;</div><div class="line">   InetAddress address;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       address = InetAddress.getLocalHost();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> UnknownHostException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot get LocalHost InetAddress, please check your network!"</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">byte</span>[] ipAddressByteArray = address.getAddress();</div><div class="line">   <span class="keyword">long</span> workerId = <span class="number">0L</span>;</div><div class="line">   <span class="comment">// IPV4</span></div><div class="line">   <span class="keyword">if</span> (ipAddressByteArray.length == <span class="number">4</span>) &#123;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">byte</span> byteNum : ipAddressByteArray) &#123;</div><div class="line">           workerId += byteNum &amp; <span class="number">0xFF</span>;</div><div class="line">       &#125;</div><div class="line">   <span class="comment">// IPV6</span></div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ipAddressByteArray.length == <span class="number">16</span>) &#123;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">byte</span> byteNum : ipAddressByteArray) &#123;</div><div class="line">           workerId += byteNum &amp; <span class="number">0B111111</span>;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Bad LocalHost InetAddress, please check your network!"</span>);</div><div class="line">   &#125;</div><div class="line">   DefaultKeyGenerator.setWorkerId(workerId);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>666. å½©è›‹</h1>
<p>æ²¡æœ‰å½©è›‹ã€‚HOHOHO</p>
<p>é“å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ã€‚</p>
<p>æ„Ÿè°¢ä½ ï¼ŒæŠ€æœ¯å¦‚æ­¤åªå¥½ï¼Œè¿˜å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€‚</p>
<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;o
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±æ”¹å†™</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-rewrite/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-rewrite/</id>
    <published>2017-08-09T16:00:00.000Z</published>
    <updated>2017-08-10T17:26:00.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Sharding-JDBC 1.5.0 æ­£å¼ç‰ˆ</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. SQLToken</a></li>
<li><a href="#">3.SQL æ”¹å†™</a>
<ul>
<li><a href="#">3.1 TableToken</a></li>
<li><a href="#">3.2 ItemsToken</a></li>
<li><a href="#">3.3 OffsetToken</a></li>
<li><a href="#">3.4 RowCountToken</a>
<ul>
<li><a href="#">3.4.1 åˆ†é¡µè¡¥å……</a></li>
</ul>
</li>
<li><a href="#">3.5 OrderByToken</a></li>
<li><a href="#">3.6 GeneratedKeyToken</a></li>
</ul>
</li>
<li><a href="#">4. SQL ç”Ÿæˆ</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>å‰ç½®é˜…è¯»ï¼š<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-3/?mp">ã€ŠSQL è§£æï¼ˆä¸‰ï¼‰ä¹‹æŸ¥è¯¢SQLã€‹</a></p>
<p>æœ¬æ–‡åˆ†äº«<strong>SQL æ”¹å†™</strong>çš„æºç å®ç°ã€‚ä¸»è¦æ¶‰åŠä¸¤æ–¹é¢ï¼š</p>
<ol>
<li>SQL æ”¹å†™ï¼šæ”¹å†™ SQLï¼Œè§£å†³åˆ†åº“åˆ†è¡¨åï¼ŒæŸ¥è¯¢ç»“æœéœ€è¦èšåˆï¼Œéœ€è¦å¯¹ SQL è¿›è¡Œè°ƒæ•´ï¼Œä¾‹å¦‚åˆ†é¡µ</li>
<li>SQL ç”Ÿæˆï¼šç”Ÿæˆåˆ†è¡¨åˆ†åº“çš„æ‰§è¡Œ SQL</li>
</ol>
<p>SQLRewriteEngineï¼ŒSQLé‡å†™å¼•æ“ï¼Œå®ç° SQL æ”¹å†™ã€ç”ŸæˆåŠŸèƒ½ã€‚ä» Sharding-JDBC 1.5.0 ç‰ˆæœ¬ï¼ŒSQL æ”¹å†™è¿›è¡Œäº†è°ƒæ•´å’Œå¤§é‡ä¼˜åŒ–ã€‚</p>
<blockquote>
<p>1.4.xåŠä¹‹å‰ç‰ˆæœ¬ï¼ŒSQLæ”¹å†™æ˜¯åœ¨SQLè·¯ç”±ä¹‹å‰å®Œæˆçš„ï¼Œåœ¨1.5.xä¸­è°ƒæ•´ä¸ºSQLè·¯ç”±ä¹‹åï¼Œå› ä¸ºSQLæ”¹å†™å¯ä»¥æ ¹æ®è·¯ç”±è‡³å•åº“è¡¨è¿˜æ˜¯å¤šåº“è¡¨è€Œè¿›è¡Œè¿›ä¸€æ­¥ä¼˜åŒ–ã€‚</p>
</blockquote>
<p>ğŸ˜† å¾ˆå¤šåŒå­¦çœ‹å®Œ<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL è§£æ-ç³»åˆ—ã€‹</a> å¯èƒ½æ˜¯ä¸€è„¸æ‡µé€¼ï¼Œç‰¹åˆ«å¯¹**â€œSQL åŠç†è§£â€**ã€‚<img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/01.png" alt="">å¸Œæœ›æœ¬æ–‡èƒ½ç»™ä½ ä¸€äº›å¯å‘ã€‚</p>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>
ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1>2. SQLToken</h1>
<p>ğŸ˜ SQLToken åœ¨æœ¬æ–‡ä¸­å¾ˆé‡è¦ï¼Œæ‰€ä»¥å³ä½¿åœ¨<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL è§£æ-ç³»åˆ—ã€‹</a>å·²ç»åˆ†äº«è¿‡ï¼Œæˆ‘ä»¬ä¹Ÿæ¢ä¸ªå§¿åŠ¿ï¼Œå†æ¥ä¸€æ¬¡ã€‚</p>
<p>SQLTokenï¼ŒSQLæ ‡è®°å¯¹è±¡<strong>æ¥å£</strong>ã€‚SQLRewriteEngine åŸºäº SQLToken å®ç° <strong>SQLæ”¹å†™</strong>ã€‚SQLè§£æå™¨åœ¨ SQLè§£æè¿‡ç¨‹ä¸­ï¼Œå¾ˆé‡è¦çš„ä¸€ä¸ªç›®çš„æ˜¯<strong>æ ‡è®°éœ€è¦SQLæ”¹å†™çš„éƒ¨åˆ†</strong>ï¼Œä¹Ÿå°±æ˜¯ SQLTokenã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/02.png" alt=""></p>
<p><strong>å„ SQLToken ç”Ÿæˆæ¡ä»¶å¦‚ä¸‹</strong>(<em>æ‚²ä¼¤ï¼Œåšæˆè¡¨æ ¼å½¢å¼æ’ç‰ˆæ˜¯ä¹±çš„</em>)ï¼š</p>
<ol>
<li>GeneratedKeyToken è‡ªå¢ä¸»é”®æ ‡è®°å¯¹è±¡
<ul>
<li>æ’å…¥SQLè‡ªå¢åˆ—ä¸å­˜åœ¨ï¼š<code>INSERT INTO t_order(nickname) VALUES ...</code> ä¸­æ²¡æœ‰è‡ªå¢åˆ— <code>order_id</code></li>
</ul>
</li>
<li>TableToken è¡¨æ ‡è®°å¯¹è±¡
<ul>
<li>æŸ¥è¯¢åˆ—çš„è¡¨åˆ«åï¼š<code>SELECT o.order_id</code> çš„ <code>o</code></li>
<li>æŸ¥è¯¢çš„è¡¨åï¼š<code>SELECT * FROM t_order</code> çš„ <code>t_order</code></li>
</ul>
</li>
<li>ItemsToken é€‰æ‹©é¡¹æ ‡è®°å¯¹è±¡
<ul>
<li>AVGæŸ¥è¯¢åˆ—ï¼š<code>SELECT AVG(price) FROM t_order</code> çš„ <code>AVG(price)</code></li>
<li>ORDER BY å­—æ®µä¸åœ¨æŸ¥è¯¢åˆ—ï¼š<code>SELECT order_id FROM t_order ORDER BY create_time</code> çš„ <code>create_time</code></li>
<li>GROUP BY å­—æ®µä¸åœ¨æŸ¥è¯¢åˆ—ï¼š<code>SELECT COUNT(order_id) FROM t_order GROUP BY user_id</code> çš„ <code>user_id</code></li>
<li>è‡ªå¢ä¸»é”®æœªåœ¨æ’å…¥åˆ—ä¸­ï¼š<code>INSERT INTO t_order(nickname) VALUES ...</code> ä¸­æ²¡æœ‰è‡ªå¢åˆ— <code>order_id</code></li>
</ul>
</li>
<li>OffsetToken åˆ†é¡µåç§»é‡æ ‡è®°å¯¹è±¡
<ul>
<li>åˆ†é¡µæœ‰åç§»é‡ï¼Œä½†<strong>ä¸æ˜¯</strong>å ä½ç¬¦ <code>?</code></li>
</ul>
</li>
<li>RowCountToken åˆ†é¡µé•¿åº¦æ ‡è®°å¯¹è±¡
<ul>
<li>åˆ†é¡µæœ‰é•¿åº¦ï¼Œä½†<strong>ä¸æ˜¯</strong>å ä½ç¬¦ <code>?</code></li>
</ul>
</li>
<li>OrderByToken æ’åºæ ‡è®°å¯¹è±¡
<ul>
<li>æœ‰ GROUP BY æ¡ä»¶ï¼Œæ—  ORDER BY æ¡ä»¶ï¼š<code>SELECT COUNT(*) FROM t_order GROUP BY order_id</code> çš„ <code>order_id</code></li>
</ul>
</li>
</ol>
<h1>3.SQL æ”¹å†™</h1>
<p><code>SQLRewriteEngine#rewrite()</code> å®ç°äº† <strong>SQLæ”¹å†™</strong> åŠŸèƒ½ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* SQLæ”¹å†™.</div><div class="line">* <span class="doctag">@param</span> isRewriteLimit æ˜¯å¦é‡å†™Limit</div><div class="line">* <span class="doctag">@return</span> SQLæ„å»ºå™¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> SQLBuilder <span class="title">rewrite</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> isRewriteLimit)</span> </span>&#123;</div><div class="line">   SQLBuilder result = <span class="keyword">new</span> SQLBuilder();</div><div class="line">   <span class="keyword">if</span> (sqlTokens.isEmpty()) &#123;</div><div class="line">       result.appendLiterals(originalSQL);</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">   <span class="comment">// æ’åºSQLTokenï¼ŒæŒ‰ç…§ beginPosition é€’å¢</span></div><div class="line">   sortByBeginPosition();</div><div class="line">   <span class="keyword">for</span> (SQLToken each : sqlTokens) &#123;</div><div class="line">       <span class="keyword">if</span> (<span class="number">0</span> == count) &#123; <span class="comment">// æ‹¼æ¥ç¬¬ä¸€ä¸ª SQLToken å‰çš„å­—ç¬¦ä¸²</span></div><div class="line">           result.appendLiterals(originalSQL.substring(<span class="number">0</span>, each.getBeginPosition()));</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// æ‹¼æ¥æ¯ä¸ªSQLToken</span></div><div class="line">       <span class="keyword">if</span> (each <span class="keyword">instanceof</span> TableToken) &#123;</div><div class="line">           appendTableToken(result, (TableToken) each, count, sqlTokens);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (each <span class="keyword">instanceof</span> ItemsToken) &#123;</div><div class="line">           appendItemsToken(result, (ItemsToken) each, count, sqlTokens);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (each <span class="keyword">instanceof</span> RowCountToken) &#123;</div><div class="line">           appendLimitRowCount(result, (RowCountToken) each, count, sqlTokens, isRewriteLimit);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (each <span class="keyword">instanceof</span> OffsetToken) &#123;</div><div class="line">           appendLimitOffsetToken(result, (OffsetToken) each, count, sqlTokens, isRewriteLimit);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (each <span class="keyword">instanceof</span> OrderByToken) &#123;</div><div class="line">           appendOrderByToken(result);</div><div class="line">       &#125;</div><div class="line">       count++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>SQLæ”¹å†™ä»¥ SQLToken ä¸º<strong>é—´éš”</strong>ï¼Œ<strong>é¡ºåº</strong>æ”¹å†™ã€‚
<ul>
<li>é¡ºåºï¼šè°ƒç”¨ <code>#sortByBeginPosition()</code> å°† SQLToken æŒ‰ç…§ <code>beginPosition</code> <strong>å‡åº</strong>ã€‚</li>
<li>é—´éš”ï¼šéå† SQLTokenï¼Œé€ä¸ªæ‹¼æ¥ã€‚</li>
</ul>
</li>
</ul>
<p>ä¾‹å¦‚ï¼š
<img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/03.png" alt=""></p>
<hr>
<p>SQLBuilderï¼ŒSQLæ„å»ºå™¨ã€‚ä¸‹æ–‡ä¼šå¤§é‡ç”¨åˆ°ï¼Œæˆ‘ä»¬çœ‹ä¸‹å®ç°ä»£ç ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SQLBuilder</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ®µé›†åˆ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; segments;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å½“å‰æ®µ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> StringBuilder currentSegment;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SQLBuilder</span><span class="params">()</span> </span>&#123;</div><div class="line">        segments = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">        currentSegment = <span class="keyword">new</span> StringBuilder();</div><div class="line">        segments.add(currentSegment);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¿½åŠ å­—é¢é‡.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> literals å­—é¢é‡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendLiterals</span><span class="params">(<span class="keyword">final</span> String literals)</span> </span>&#123;</div><div class="line">        currentSegment.append(literals);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¿½åŠ è¡¨å ä½ç¬¦.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> tableName è¡¨åç§°</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendTable</span><span class="params">(<span class="keyword">final</span> String tableName)</span> </span>&#123;</div><div class="line">        <span class="comment">// æ·»åŠ  TableToken</span></div><div class="line">        segments.add(<span class="keyword">new</span> TableToken(tableName));</div><div class="line">        <span class="comment">// æ–°å»ºå½“å‰æ®µ</span></div><div class="line">        currentSegment = <span class="keyword">new</span> StringBuilder();</div><div class="line">        segments.add(currentSegment);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toSQL</span><span class="params">(<span class="keyword">final</span> Map&lt;String, String&gt; tableTokens)</span> </span>&#123;</div><div class="line">        <span class="comment">// ... çœç•¥ä»£ç ï¼Œã€SQLç”Ÿæˆã€‘å¤„åˆ†äº«</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@RequiredArgsConstructor</span></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">TableToken</span> </span>&#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * è¡¨å</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String tableName;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<p>ç°åœ¨æˆ‘ä»¬æ¥é€ä¸ªåˆ†ææ¯ç§ SQLToken çš„<strong>æ‹¼æ¥</strong>å®ç°ã€‚</p>
<h2>3.1 TableToken</h2>
<p>è°ƒç”¨ <code>#appendTableToken()</code> æ–¹æ³•æ‹¼æ¥ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‹¼æ¥ TableToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLæ„å»ºå™¨</div><div class="line">* <span class="doctag">@param</span> tableToken tableToken</div><div class="line">* <span class="doctag">@param</span> count tableToken åœ¨ sqlTokens çš„é¡ºåº</div><div class="line">* <span class="doctag">@param</span> sqlTokens sqlTokens</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendTableToken</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder, <span class="keyword">final</span> TableToken tableToken, <span class="keyword">final</span> <span class="keyword">int</span> count, <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ‹¼æ¥ TableToken</span></div><div class="line">   String tableName = sqlStatement.getTables().getTableNames().contains(tableToken.getTableName()) ? tableToken.getTableName() : tableToken.getOriginalLiterals();</div><div class="line">   sqlBuilder.appendTable(tableName);</div><div class="line">   <span class="comment">// æ‹¼æ¥ SQLToken åé¢çš„å­—ç¬¦ä¸²</span></div><div class="line">   <span class="keyword">int</span> beginPosition = tableToken.getBeginPosition() + tableToken.getOriginalLiterals().length();</div><div class="line">   <span class="keyword">int</span> endPosition = sqlTokens.size() - <span class="number">1</span> == count ? originalSQL.length() : sqlTokens.get(count + <span class="number">1</span>).getBeginPosition();</div><div class="line">   sqlBuilder.appendLiterals(originalSQL.substring(beginPosition, endPosition));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è°ƒç”¨ <code>SQLBuilder#appendTable()</code> æ‹¼æ¥ TableTokenã€‚</li>
<li><code>sqlStatement.getTables().getTableNames().contains(tableToken.getTableName())</code> ç›®çš„æ˜¯å¤„ç†æ‰<strong>è¡¨åå‰åæœ‰çš„ç‰¹æ®Šå­—ç¬¦</strong>ï¼Œä¾‹å¦‚<code>SELECT * FROM 't_order'</code> ä¸­ <code>t_order</code> å‰åæœ‰ <code>'</code> ç¬¦å·ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TableToken.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–è¡¨åç§°.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getTableName</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> SQLUtil.getExactlyValue(originalLiterals);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SQLUtil.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getExactlyValue</span><span class="params">(<span class="keyword">final</span> String value)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span> == value ? <span class="keyword">null</span> : CharMatcher.anyOf(<span class="string">"[]`'\""</span>).removeFrom(value);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å½“ SQL ä¸º <code>SELECT o.* FROM t_order o</code>
<ul>
<li>TableToken ä¸ºæŸ¥è¯¢åˆ—å‰çš„è¡¨åˆ«å <code>o</code> æ—¶è¿”å›ç»“æœï¼š
<img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/04.png" alt=""></li>
<li>TableToken ä¸ºè¡¨å <code>t_order</code> æ—¶è¿”å›ç»“æœï¼š
<img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/05.png" alt=""></li>
</ul>
</li>
</ul>
<h2>3.2 ItemsToken</h2>
<p>è°ƒç”¨ <code>#appendItemsToken()</code> æ–¹æ³•æ‹¼æ¥ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‹¼æ¥ TableToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLæ„å»ºå™¨</div><div class="line">* <span class="doctag">@param</span> itemsToken itemsToken</div><div class="line">* <span class="doctag">@param</span> count itemsToken åœ¨ sqlTokens çš„é¡ºåº</div><div class="line">* <span class="doctag">@param</span> sqlTokens sqlTokens</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendItemsToken</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder, <span class="keyword">final</span> ItemsToken itemsToken, <span class="keyword">final</span> <span class="keyword">int</span> count, <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ‹¼æ¥ ItemsToken</span></div><div class="line">   <span class="keyword">for</span> (String item : itemsToken.getItems()) &#123;</div><div class="line">       sqlBuilder.appendLiterals(<span class="string">", "</span>);</div><div class="line">       sqlBuilder.appendLiterals(item);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// SQLToken åé¢çš„å­—ç¬¦ä¸²</span></div><div class="line">   <span class="keyword">int</span> beginPosition = itemsToken.getBeginPosition();</div><div class="line">   <span class="keyword">int</span> endPosition = sqlTokens.size() - <span class="number">1</span> == count ? originalSQL.length() : sqlTokens.get(count + <span class="number">1</span>).getBeginPosition();</div><div class="line">   sqlBuilder.appendLiterals(originalSQL.substring(beginPosition, endPosition));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬ä¸€ç§æƒ…å†µï¼Œ<strong>AVGæŸ¥è¯¢åˆ—</strong>ï¼ŒSQL ä¸º <code>SELECT AVG(order_id) FROM t_order o</code> æ—¶è¿”å›ç»“æœï¼š
<img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/06.png" alt=""></li>
<li>ç¬¬äºŒç§æƒ…å†µï¼Œ<strong>ORDER BY å­—æ®µä¸åœ¨æŸ¥è¯¢åˆ—</strong>ï¼ŒSQL ä¸º <code>SELECT userId FROM t_order o ORDER BY order_id</code> æ—¶è¿”å›ç»“æœï¼š
<img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/07.png" alt=""></li>
<li>ç¬¬ä¸‰ç§æƒ…å†µï¼Œ<strong>GROUP BY å­—æ®µä¸åœ¨æŸ¥è¯¢åˆ—</strong>ï¼Œç±»ä¼¼ç¬¬äºŒç§æƒ…å†µï¼Œå°±ä¸ä¸¾ä¾‹å­åˆ—ã€‚</li>
</ul>
<h2>3.3 OffsetToken</h2>
<p>è°ƒç”¨ <code>#appendLimitOffsetToken()</code> æ–¹æ³•æ‹¼æ¥ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‹¼æ¥ OffsetToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLæ„å»ºå™¨</div><div class="line">* <span class="doctag">@param</span> offsetToken offsetToken</div><div class="line">* <span class="doctag">@param</span> count offsetToken åœ¨ sqlTokens çš„é¡ºåº</div><div class="line">* <span class="doctag">@param</span> sqlTokens sqlTokens</div><div class="line">* <span class="doctag">@param</span> isRewrite æ˜¯å¦é‡å†™ã€‚å½“è·¯ç”±ç»“æœä¸ºå•åˆ†ç‰‡æ—¶æ— éœ€é‡å†™</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendLimitOffsetToken</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder, <span class="keyword">final</span> OffsetToken offsetToken, <span class="keyword">final</span> <span class="keyword">int</span> count, <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens, <span class="keyword">final</span> <span class="keyword">boolean</span> isRewrite)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ‹¼æ¥ OffsetToken</span></div><div class="line">   sqlBuilder.appendLiterals(isRewrite ? <span class="string">"0"</span> : String.valueOf(offsetToken.getOffset()));</div><div class="line">   <span class="comment">// SQLToken åé¢çš„å­—ç¬¦ä¸²</span></div><div class="line">   <span class="keyword">int</span> beginPosition = offsetToken.getBeginPosition() + String.valueOf(offsetToken.getOffset()).length();</div><div class="line">   <span class="keyword">int</span> endPosition = sqlTokens.size() - <span class="number">1</span> == count ? originalSQL.length() : sqlTokens.get(count + <span class="number">1</span>).getBeginPosition();</div><div class="line">   sqlBuilder.appendLiterals(originalSQL.substring(beginPosition, endPosition));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å½“åˆ†é¡µ<strong>è·¨åˆ†ç‰‡</strong>æ—¶ï¼Œéœ€è¦æ¯ä¸ªåˆ†ç‰‡éƒ½æŸ¥è¯¢ååœ¨<strong>å†…å­˜</strong>ä¸­è¿›è¡Œèšåˆã€‚æ­¤æ—¶ <code>isRewrite = true</code>ã€‚ä¸ºä»€ä¹ˆæ˜¯ <code>&quot;0&quot;</code> å¼€å§‹å‘¢ï¼Ÿæ¯ä¸ªåˆ†ç‰‡åœ¨ [0, offset) çš„è®°å½•<strong>å¯èƒ½</strong>å±äºå®é™…åˆ†é¡µç»“æœï¼Œå› è€ŒæŸ¥è¯¢æ¯ä¸ªåˆ†ç‰‡éœ€è¦ä» 0 å¼€å§‹ã€‚</li>
<li>å½“åˆ†é¡µ<strong>å•åˆ†ç‰‡</strong>æ—¶ï¼Œåˆ™æ— éœ€é‡å†™ï¼Œè¯¥åˆ†ç‰‡æ‰§è¡Œçš„ç»“æœå³æ˜¯æœ€ç»ˆç»“æœã€‚<strong>SQLæ”¹å†™åœ¨SQLè·¯ç”±ä¹‹åå°±æœ‰è¿™ä¸ªå¥½å¤„</strong>ã€‚å¦‚æœå…ˆæ”¹å†™ï¼Œå› ä¸ºæ²¡åŠæ³•çŸ¥é“æœ€ç»ˆæ˜¯å•åˆ†ç‰‡è¿˜æ˜¯è·¨åˆ†ç‰‡ï¼Œè€ƒè™‘æ­£ç¡®æ€§ï¼Œåªèƒ½ç»Ÿä¸€ä½¿ç”¨è·¨åˆ†ç‰‡ã€‚</li>
</ul>
<h2>3.4 RowCountToken</h2>
<p>è°ƒç”¨ <code>#appendLimitRowCount()</code> æ–¹æ³•æ‹¼æ¥ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendLimitRowCount</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder, <span class="keyword">final</span> RowCountToken rowCountToken, <span class="keyword">final</span> <span class="keyword">int</span> count, <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens, <span class="keyword">final</span> <span class="keyword">boolean</span> isRewrite)</span> </span>&#123;</div><div class="line">   SelectStatement selectStatement = (SelectStatement) sqlStatement;</div><div class="line">   Limit limit = selectStatement.getLimit();</div><div class="line">   <span class="keyword">if</span> (!isRewrite) &#123; <span class="comment">// è·¯ç”±ç»“æœä¸ºå•åˆ†ç‰‡</span></div><div class="line">       sqlBuilder.appendLiterals(String.valueOf(rowCountToken.getRowCount()));</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((!selectStatement.getGroupByItems().isEmpty() || <span class="comment">// [1.1] è·¨åˆ†ç‰‡åˆ†ç»„éœ€è¦åœ¨å†…å­˜è®¡ç®—ï¼Œå¯èƒ½éœ€è¦å…¨éƒ¨åŠ è½½</span></div><div class="line">           !selectStatement.getAggregationSelectItems().isEmpty()) <span class="comment">// [1.2] è·¨åˆ†ç‰‡èšåˆåˆ—éœ€è¦åœ¨å†…å­˜è®¡ç®—ï¼Œå¯èƒ½éœ€è¦å…¨éƒ¨åŠ è½½</span></div><div class="line">           &amp;&amp; !selectStatement.isSameGroupByAndOrderByItems()) &#123; <span class="comment">// [2] å¦‚æœæ’åºä¸€è‡´ï¼Œå³å„åˆ†ç‰‡å·²ç»æ’åºå¥½ç»“æœï¼Œå°±ä¸éœ€è¦å…¨éƒ¨åŠ è½½</span></div><div class="line">       sqlBuilder.appendLiterals(String.valueOf(Integer.MAX_VALUE));</div><div class="line">   &#125; <span class="keyword">else</span> &#123; <span class="comment">// è·¯ç”±ç»“æœä¸ºå¤šåˆ†ç‰‡</span></div><div class="line">       sqlBuilder.appendLiterals(String.valueOf(limit.isRowCountRewriteFlag() ? rowCountToken.getRowCount() + limit.getOffsetValue() : rowCountToken.getRowCount()));</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// SQLToken åé¢çš„å­—ç¬¦ä¸²</span></div><div class="line">   <span class="keyword">int</span> beginPosition = rowCountToken.getBeginPosition() + String.valueOf(rowCountToken.getRowCount()).length();</div><div class="line">   <span class="keyword">int</span> endPosition = sqlTokens.size() - <span class="number">1</span> == count ? originalSQL.length() : sqlTokens.get(count + <span class="number">1</span>).getBeginPosition();</div><div class="line">   sqlBuilder.appendLiterals(originalSQL.substring(beginPosition, endPosition));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>[1.1] <code>!selectStatement.getGroupByItems().isEmpty()</code> è·¨åˆ†ç‰‡<strong>åˆ†ç»„</strong>éœ€è¦åœ¨å†…å­˜è®¡ç®—ï¼Œ<strong>å¯èƒ½</strong>éœ€è¦å…¨éƒ¨åŠ è½½ã€‚å¦‚æœä¸å…¨éƒ¨åŠ è½½ï¼Œéƒ¨åˆ†ç»“æœè¢«åˆ†é¡µæ¡ä»¶é”™è¯¯ç»“æœï¼Œä¼šå¯¼è‡´ç»“æœä¸æ­£ç¡®ã€‚</li>
<li>[1.2] <code>!selectStatement.getAggregationSelectItems().isEmpty())</code> è·¨åˆ†ç‰‡<strong>èšåˆåˆ—</strong>éœ€è¦åœ¨å†…å­˜è®¡ç®—ï¼Œ<strong>å¯èƒ½</strong>éœ€è¦å…¨éƒ¨åŠ è½½ã€‚å¦‚æœä¸å…¨éƒ¨åŠ è½½ï¼Œéƒ¨åˆ†ç»“æœè¢«åˆ†é¡µæ¡ä»¶é”™è¯¯ç»“æœï¼Œä¼šå¯¼è‡´ç»“æœä¸æ­£ç¡®ã€‚</li>
<li>[1.1][1.2]ï¼Œ<strong>å¯èƒ½</strong>å˜æˆå¿…é¡»çš„å‰ææ˜¯ GROUP BY å’Œ ORDER BY æ’åºä¸ä¸€è‡´ã€‚å¦‚æœä¸€è‡´ï¼Œå„åˆ†ç‰‡å·²ç»æ’åºå®Œæˆï¼Œæ— éœ€å†…å­˜ä¸­æ’åºã€‚</li>
</ul>
<h3>3.4.1 åˆ†é¡µè¡¥å……</h3>
<p>OffsetTokenã€RowCountToken åªæœ‰åœ¨åˆ†é¡µå¯¹åº”ä½ç½®éå ä½ç¬¦ <code>?</code> æ‰å­˜åœ¨ã€‚å½“å¯¹åº”ä½ç½®æ˜¯å ä½ç¬¦æ—¶ï¼Œä¼šå¯¹<strong>åˆ†é¡µæ¡ä»¶å¯¹åº”çš„é¢„ç¼–è¯‘ SQL å ä½ç¬¦å‚æ•°</strong>è¿›è¡Œé‡å†™ï¼Œ<strong>æ•´ä½“é€»è¾‘å’Œ OffsetTokenã€RowCountToken æ˜¯ä¸€è‡´çš„</strong>ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ğŸ‘¼ ParsingSQLRouter#route() è°ƒç”¨ #processLimit() </span></div><div class="line"></div><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å¤„ç†åˆ†é¡µæ¡ä»¶</div><div class="line">*</div><div class="line">* <span class="doctag">@see</span> SQLRewriteEngine#appendLimitRowCount(SQLBuilder, RowCountToken, int, List, boolean) </div><div class="line">* <span class="doctag">@param</span> parameters å ä½ç¬¦å¯¹åº”å‚æ•°åˆ—è¡¨</div><div class="line">* <span class="doctag">@param</span> selectStatement Select SQLè¯­å¥å¯¹è±¡</div><div class="line">* <span class="doctag">@param</span> isSingleRouting æ˜¯å¦å•è¡¨è·¯ç”±</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processLimit</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SelectStatement selectStatement, <span class="keyword">final</span> <span class="keyword">boolean</span> isSingleRouting)</span> </span>&#123;</div><div class="line">   <span class="keyword">boolean</span> isNeedFetchAll = (!selectStatement.getGroupByItems().isEmpty() <span class="comment">// // [1.1] è·¨åˆ†ç‰‡åˆ†ç»„éœ€è¦åœ¨å†…å­˜è®¡ç®—ï¼Œå¯èƒ½éœ€è¦å…¨éƒ¨åŠ è½½</span></div><div class="line">                               || !selectStatement.getAggregationSelectItems().isEmpty()) <span class="comment">// [1.2] è·¨åˆ†ç‰‡èšåˆåˆ—éœ€è¦åœ¨å†…å­˜è®¡ç®—ï¼Œå¯èƒ½éœ€è¦å…¨éƒ¨åŠ è½½</span></div><div class="line">                           &amp;&amp; !selectStatement.isSameGroupByAndOrderByItems(); <span class="comment">// [2] å¦‚æœæ’åºä¸€è‡´ï¼Œå³å„åˆ†ç‰‡å·²ç»æ’åºå¥½ç»“æœï¼Œå°±ä¸éœ€è¦å…¨éƒ¨åŠ è½½</span></div><div class="line">   selectStatement.getLimit().processParameters(parameters, !isSingleRouting, isNeedFetchAll);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Limit.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å¡«å……æ”¹å†™åˆ†é¡µå‚æ•°.</div><div class="line">* <span class="doctag">@param</span> parameters å‚æ•°</div><div class="line">* <span class="doctag">@param</span> isRewrite æ˜¯å¦é‡å†™å‚æ•°</div><div class="line">* <span class="doctag">@param</span> isFetchAll æ˜¯å¦è·å–æ‰€æœ‰æ•°æ®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processParameters</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> <span class="keyword">boolean</span> isRewrite, <span class="keyword">final</span> <span class="keyword">boolean</span> isFetchAll)</span> </span>&#123;</div><div class="line">   fill(parameters);</div><div class="line">   <span class="keyword">if</span> (isRewrite) &#123;</div><div class="line">       rewrite(parameters, isFetchAll);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* å°†å ä½ç¬¦å‚æ•°é‡Œæ˜¯åˆ†é¡µçš„å‚æ•°èµ‹å€¼ç»™ offset ã€rowCount</div><div class="line">* èµ‹å€¼çš„å‰ææ¡ä»¶æ˜¯ offsetã€rowCount æ˜¯ å ä½ç¬¦</div><div class="line">* <span class="doctag">@param</span> parameters å ä½ç¬¦å‚æ•°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fill</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> offset = <span class="number">0</span>;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != <span class="keyword">this</span>.offset) &#123;</div><div class="line">       offset = -<span class="number">1</span> == <span class="keyword">this</span>.offset.getIndex() ? getOffsetValue() : NumberUtil.roundHalfUp(parameters.get(<span class="keyword">this</span>.offset.getIndex()));</div><div class="line">       <span class="keyword">this</span>.offset.setValue(offset);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">int</span> rowCount = <span class="number">0</span>;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != <span class="keyword">this</span>.rowCount) &#123;</div><div class="line">       rowCount = -<span class="number">1</span> == <span class="keyword">this</span>.rowCount.getIndex() ? getRowCountValue() : NumberUtil.roundHalfUp(parameters.get(<span class="keyword">this</span>.rowCount.getIndex()));</div><div class="line">       <span class="keyword">this</span>.rowCount.setValue(rowCount);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (offset &lt; <span class="number">0</span> || rowCount &lt; <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingException(<span class="string">"LIMIT offset and row count can not be a negative value."</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* é‡å†™åˆ†é¡µæ¡ä»¶å¯¹åº”çš„å‚æ•°</div><div class="line">* <span class="doctag">@param</span> parameters å‚æ•°</div><div class="line">* <span class="doctag">@param</span> isFetchAll æ˜¯å¦æ‹‰å–æ‰€æœ‰</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rewrite</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> <span class="keyword">boolean</span> isFetchAll)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> rewriteOffset = <span class="number">0</span>;</div><div class="line">   <span class="keyword">int</span> rewriteRowCount;</div><div class="line">   <span class="comment">// é‡å†™</span></div><div class="line">   <span class="keyword">if</span> (isFetchAll) &#123;</div><div class="line">       rewriteRowCount = Integer.MAX_VALUE;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rowCountRewriteFlag) &#123;</div><div class="line">       rewriteRowCount = <span class="keyword">null</span> == rowCount ? -<span class="number">1</span> : getOffsetValue() + rowCount.getValue();</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       rewriteRowCount = rowCount.getValue();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å‚æ•°è®¾ç½®</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != offset &amp;&amp; offset.getIndex() &gt; -<span class="number">1</span>) &#123;</div><div class="line">       parameters.set(offset.getIndex(), rewriteOffset);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != rowCount &amp;&amp; rowCount.getIndex() &gt; -<span class="number">1</span>) &#123;</div><div class="line">       parameters.set(rowCount.getIndex(), rewriteRowCount);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.5 OrderByToken</h2>
<p>è°ƒç”¨ <code>#appendOrderByToken()</code> æ–¹æ³•æ‹¼æ¥ã€‚æ•°æ®åº“é‡Œï¼Œå½“æ—  ORDER BYæ¡ä»¶ è€Œæœ‰ GROUP BY æ¡ä»¶æ—¶å€™ï¼Œä¼šä½¿ç”¨ GROUP BYæ¡ä»¶å°†ç»“æœå‡åºæ’åºï¼š</p>
<ul>
<li><code>SELECT order_id FROM t_order GROUP BY order_id</code> ç­‰ä»·äº <code>SELECT order_id FROM t_order GROUP BY order_id ORDER BY order_id ASC</code></li>
<li><code>SELECT order_id FROM t_order GROUP BY order_id DESC</code> ç­‰ä»·äº <code>SELECT order_id FROM t_order GROUP BY order_id ORDER BY order_id DESC</code></li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‹¼æ¥ OrderByToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLæ„å»ºå™¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendOrderByToken</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder)</span> </span>&#123;</div><div class="line">   SelectStatement selectStatement = (SelectStatement) sqlStatement;</div><div class="line">   <span class="comment">// æ‹¼æ¥ OrderByToken</span></div><div class="line">   StringBuilder orderByLiterals = <span class="keyword">new</span> StringBuilder(<span class="string">" ORDER BY "</span>);</div><div class="line">   <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (OrderItem each : selectStatement.getOrderByItems()) &#123;</div><div class="line">       <span class="keyword">if</span> (<span class="number">0</span> == i) &#123;</div><div class="line">           orderByLiterals.append(each.getColumnLabel()).append(<span class="string">" "</span>).append(each.getType().name());</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           orderByLiterals.append(<span class="string">","</span>).append(each.getColumnLabel()).append(<span class="string">" "</span>).append(each.getType().name());</div><div class="line">       &#125;</div><div class="line">       i++;</div><div class="line">   &#125;</div><div class="line">   orderByLiterals.append(<span class="string">" "</span>);</div><div class="line">   sqlBuilder.appendLiterals(orderByLiterals.toString());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å½“ SQL ä¸º <code>SELECT order_id FROM t_order o GROUP BY order_id</code> è¿”å›ç»“æœï¼š
<img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/08.png" alt=""></li>
</ul>
<h2>3.6 GeneratedKeyToken</h2>
<p>å‰ç½®é˜…è¯»ï¼š<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-4/?mp">ã€ŠSQL è§£æï¼ˆå››ï¼‰ä¹‹æ’å…¥SQLã€‹</a></p>
<p>GeneratedKeyTokenï¼Œå’Œå…¶å®ƒ SQLToken ä¸åŒï¼Œåœ¨ <strong>SQLè§£æ</strong> å®Œè¿›è¡Œå¤„ç†ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLStatement <span class="title">parse</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> <span class="keyword">int</span> parametersSize)</span> </span>&#123;</div><div class="line">   SQLParsingEngine parsingEngine = <span class="keyword">new</span> SQLParsingEngine(databaseType, logicSQL, shardingRule);</div><div class="line">   Context context = MetricsContext.start(<span class="string">"Parse SQL"</span>);</div><div class="line">   SQLStatement result = parsingEngine.parse();</div><div class="line">   <span class="keyword">if</span> (result <span class="keyword">instanceof</span> InsertStatement) &#123; <span class="comment">// å¤„ç† GenerateKeyToken</span></div><div class="line">       ((InsertStatement) result).appendGenerateKeyToken(shardingRule, parametersSize);</div><div class="line">   &#125;</div><div class="line">   MetricsContext.stop(context);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// InsertStatement.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è¿½åŠ è‡ªå¢ä¸»é”®æ ‡è®°å¯¹è±¡.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingRule åˆ†ç‰‡è§„åˆ™</div><div class="line">* <span class="doctag">@param</span> parametersSize å‚æ•°ä¸ªæ•°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendGenerateKeyToken</span><span class="params">(<span class="keyword">final</span> ShardingRule shardingRule, <span class="keyword">final</span> <span class="keyword">int</span> parametersSize)</span> </span>&#123;</div><div class="line">   <span class="comment">// SQL é‡Œæœ‰ä¸»é”®åˆ—</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != generatedKey) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// TableRule å­˜åœ¨</span></div><div class="line">   Optional&lt;TableRule&gt; tableRule = shardingRule.tryFindTableRule(getTables().getSingleTableName());</div><div class="line">   <span class="keyword">if</span> (!tableRule.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// GeneratedKeyToken å­˜åœ¨</span></div><div class="line">   Optional&lt;GeneratedKeyToken&gt; generatedKeysToken = findGeneratedKeyToken();</div><div class="line">   <span class="keyword">if</span> (!generatedKeysToken.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å¤„ç† GenerateKeyToken</span></div><div class="line">   ItemsToken valuesToken = <span class="keyword">new</span> ItemsToken(generatedKeysToken.get().getBeginPosition());</div><div class="line">   <span class="keyword">if</span> (<span class="number">0</span> == parametersSize) &#123;</div><div class="line">       appendGenerateKeyToken(shardingRule, tableRule.get(), valuesToken);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       appendGenerateKeyToken(shardingRule, tableRule.get(), valuesToken, parametersSize);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç§»é™¤ generatedKeysToken</span></div><div class="line">   getSqlTokens().remove(generatedKeysToken.get());</div><div class="line">   <span class="comment">// æ–°å¢ ItemsToken</span></div><div class="line">   getSqlTokens().add(valuesToken);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>æ ¹æ®<strong>å ä½ç¬¦å‚æ•°</strong>æ•°é‡ä¸åŒï¼Œè°ƒç”¨çš„ <code>#appendGenerateKeyToken()</code> æ˜¯<strong>ä¸åŒ</strong>çš„ï¼š</li>
<li><strong>å ä½ç¬¦å‚æ•°æ•°é‡ = 0</strong> æ—¶ï¼Œç›´æ¥ç”Ÿæˆ<strong>åˆ†å¸ƒå¼ä¸»é”®</strong>ï¼Œä¿æŒæ— å ä½ç¬¦çš„åšæ³•ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// InsertStatement.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendGenerateKeyToken</span><span class="params">(<span class="keyword">final</span> ShardingRule shardingRule, <span class="keyword">final</span> TableRule tableRule, <span class="keyword">final</span> ItemsToken valuesToken)</span> </span>&#123;</div><div class="line">   <span class="comment">// ç”Ÿæˆåˆ†å¸ƒå¼ä¸»é”®</span></div><div class="line">   Number generatedKey = shardingRule.generateKey(tableRule.getLogicTable());</div><div class="line">   <span class="comment">// æ·»åŠ åˆ° ItemsToken</span></div><div class="line">   valuesToken.getItems().add(generatedKey.toString());</div><div class="line">   <span class="comment">// å¢åŠ  Conditionï¼Œç”¨äºè·¯ç”±</span></div><div class="line">   getConditions().add(<span class="keyword">new</span> Condition(<span class="keyword">new</span> Column(tableRule.getGenerateKeyColumn(), tableRule.getLogicTable()), <span class="keyword">new</span> SQLNumberExpression(generatedKey)), shardingRule);</div><div class="line">   <span class="comment">// ç”Ÿæˆ GeneratedKey</span></div><div class="line">   <span class="keyword">this</span>.generatedKey = <span class="keyword">new</span> GeneratedKey(tableRule.getLogicTable(), -<span class="number">1</span>, generatedKey);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><strong>å ä½ç¬¦å‚æ•°æ•°é‡ &gt; 0</strong> æ—¶ï¼Œç”Ÿæˆè‡ªå¢åˆ—çš„å ä½ç¬¦ï¼Œä¿æŒæœ‰å ä½ç¬¦çš„åšæ³•ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendGenerateKeyToken</span><span class="params">(<span class="keyword">final</span> ShardingRule shardingRule, <span class="keyword">final</span> TableRule tableRule, <span class="keyword">final</span> ItemsToken valuesToken, <span class="keyword">final</span> <span class="keyword">int</span> parametersSize)</span> </span>&#123;</div><div class="line">   <span class="comment">// ç”Ÿæˆå ä½ç¬¦</span></div><div class="line">   valuesToken.getItems().add(<span class="string">"?"</span>);</div><div class="line">   <span class="comment">// å¢åŠ  Conditionï¼Œç”¨äºè·¯ç”±</span></div><div class="line">   getConditions().add(<span class="keyword">new</span> Condition(<span class="keyword">new</span> Column(tableRule.getGenerateKeyColumn(), tableRule.getLogicTable()), <span class="keyword">new</span> SQLPlaceholderExpression(parametersSize)), shardingRule);</div><div class="line">   <span class="comment">// ç”Ÿæˆ GeneratedKey</span></div><div class="line">   generatedKey = <span class="keyword">new</span> GeneratedKey(tableRule.getGenerateKeyColumn(), parametersSize, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å› ä¸º GenerateKeyToken å·²ç»å¤„ç†å®Œï¼Œæ‰€ä»¥ç§»é™¤ï¼Œé¿å… <code>SQLRewriteEngine#rewrite()</code> äºŒæ¬¡æ”¹å†™ã€‚å¦å¤–ï¼Œé€šè¿‡ ItemsToken è¡¥å……è‡ªå¢åˆ—ã€‚</li>
<li>ç”Ÿæˆ GeneratedKey ä¼šåœ¨ ParsingSQLRouter è¿›ä¸€æ­¥å¤„ç†ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLRouteResult <span class="title">route</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   <span class="keyword">final</span> Context context = MetricsContext.start(<span class="string">"Route SQL"</span>);</div><div class="line">   SQLRouteResult result = <span class="keyword">new</span> SQLRouteResult(sqlStatement);</div><div class="line">   <span class="comment">// å¤„ç† æ’å…¥SQL ä¸»é”®å­—æ®µ</span></div><div class="line">   <span class="keyword">if</span> (sqlStatement <span class="keyword">instanceof</span> InsertStatement &amp;&amp; <span class="keyword">null</span> != ((InsertStatement) sqlStatement).getGeneratedKey()) &#123;</div><div class="line">       processGeneratedKey(parameters, (InsertStatement) sqlStatement, result);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">&#125;  </div><div class="line"><span class="comment">/**</span></div><div class="line">* å¤„ç† æ’å…¥SQL ä¸»é”®å­—æ®µ</div><div class="line">* å½“ ä¸»é”®ç¼–å· æœªç”Ÿæˆæ—¶ï¼Œ&#123;<span class="doctag">@link</span> ShardingRule#generateKey(String)&#125; è¿›è¡Œç”Ÿæˆ</div><div class="line">* <span class="doctag">@param</span> parameters å ä½ç¬¦å‚æ•°</div><div class="line">* <span class="doctag">@param</span> insertStatement Insert SQLè¯­å¥å¯¹è±¡</div><div class="line">* <span class="doctag">@param</span> sqlRouteResult SQLè·¯ç”±ç»“æœ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processGeneratedKey</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> InsertStatement insertStatement, <span class="keyword">final</span> SQLRouteResult sqlRouteResult)</span> </span>&#123;</div><div class="line">   GeneratedKey generatedKey = insertStatement.getGeneratedKey();</div><div class="line">   <span class="keyword">if</span> (parameters.isEmpty()) &#123; <span class="comment">// å·²æœ‰ä¸»é”®ï¼Œæ— å ä½ç¬¦ï¼ŒINSERT INTO t_order(order_id, user_id) VALUES (1, 100);</span></div><div class="line">       sqlRouteResult.getGeneratedKeys().add(generatedKey.getValue());</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parameters.size() == generatedKey.getIndex()) &#123; <span class="comment">// ä¸»é”®å­—æ®µä¸å­˜åœ¨å­˜åœ¨ï¼ŒINSERT INTO t_order(user_id) VALUES(?);</span></div><div class="line">       Number key = shardingRule.generateKey(insertStatement.getTables().getSingleTableName()); <span class="comment">// ç”Ÿæˆä¸»é”®ç¼–å·</span></div><div class="line">       parameters.add(key);</div><div class="line">       setGeneratedKeys(sqlRouteResult, key);</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (-<span class="number">1</span> != generatedKey.getIndex()) &#123; <span class="comment">// ä¸»é”®å­—æ®µå­˜åœ¨ï¼ŒINSERT INTO t_order(order_id, user_id) VALUES(?, ?);</span></div><div class="line">       setGeneratedKeys(sqlRouteResult, (Number) parameters.get(generatedKey.getIndex()));</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¾ç½® ä¸»é”®ç¼–å· åˆ° SQLè·¯ç”±ç»“æœ</div><div class="line">* <span class="doctag">@param</span> sqlRouteResult SQLè·¯ç”±ç»“æœ</div><div class="line">* <span class="doctag">@param</span> generatedKey ä¸»é”®ç¼–å·</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setGeneratedKeys</span><span class="params">(<span class="keyword">final</span> SQLRouteResult sqlRouteResult, <span class="keyword">final</span> Number generatedKey)</span> </span>&#123;</div><div class="line">   generatedKeys.add(generatedKey);</div><div class="line">   sqlRouteResult.getGeneratedKeys().clear();</div><div class="line">   sqlRouteResult.getGeneratedKeys().addAll(generatedKeys);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>parameters.size() == generatedKey.getIndex()</code> å¤„å¯¹åº” <code>#appendGenerateKeyToken()</code> çš„ <strong>å ä½ç¬¦å‚æ•°æ•°é‡ &gt; 0</strong> æƒ…å†µï¼Œæ­¤æ—¶ä¼šç”Ÿæˆ<strong>åˆ†å¸ƒå¼ä¸»é”®</strong>ã€‚ğŸ˜ˆ è¯¥å¤„æ˜¯ä¸æ˜¯å¯ä»¥è€ƒè™‘æŠŠç”Ÿæˆ<strong>åˆ†å¸ƒå¼ä¸»é”®</strong>æŒªåˆ° <code>#appendGenerateKeyToken()</code>ï¼Œè¿™æ ·æ›´åŠ ç»Ÿä¸€ä¸€äº›ã€‚</li>
</ul>
<h1>4. SQL ç”Ÿæˆ</h1>
<p><strong>SQLè·¯ç”±</strong>å®Œåï¼Œä¼šç”Ÿæˆå„æ•°æ®åˆ†ç‰‡çš„<strong>æ‰§è¡ŒSQL</strong>ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLRouteResult <span class="title">route</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   SQLRouteResult result = <span class="keyword">new</span> SQLRouteResult(sqlStatement);</div><div class="line">   <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç ... å¤„ç† æ’å…¥SQL ä¸»é”®å­—æ®µ</span></div><div class="line">   </div><div class="line">   <span class="comment">// è·¯ç”±</span></div><div class="line">   RoutingResult routingResult = route(parameters, sqlStatement);</div><div class="line">   </div><div class="line">   <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç ... SQLé‡å†™å¼•æ“</span></div><div class="line">   SQLRewriteEngine rewriteEngine = <span class="keyword">new</span> SQLRewriteEngine(shardingRule, logicSQL, sqlStatement);</div><div class="line">   <span class="keyword">boolean</span> isSingleRouting = routingResult.isSingleRouting();</div><div class="line">   <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç ... å¤„ç†åˆ†é¡µ</span></div><div class="line">   <span class="comment">// SQL é‡å†™</span></div><div class="line">   SQLBuilder sqlBuilder = rewriteEngine.rewrite(!isSingleRouting);</div><div class="line">   <span class="comment">// ç”Ÿæˆ ExecutionUnit</span></div><div class="line">   <span class="keyword">if</span> (routingResult <span class="keyword">instanceof</span> CartesianRoutingResult) &#123;</div><div class="line">       <span class="keyword">for</span> (CartesianDataSource cartesianDataSource : ((CartesianRoutingResult) routingResult).getRoutingDataSources()) &#123;</div><div class="line">           <span class="keyword">for</span> (CartesianTableReference cartesianTableReference : cartesianDataSource.getRoutingTableReferences()) &#123;</div><div class="line">               <span class="comment">// ğŸ‘¼ ç”Ÿæˆ SQL</span></div><div class="line">               result.getExecutionUnits().add(<span class="keyword">new</span> SQLExecutionUnit(cartesianDataSource.getDataSource(), rewriteEngine.generateSQL(cartesianTableReference, sqlBuilder)));</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">for</span> (TableUnit each : routingResult.getTableUnits().getTableUnits()) &#123;</div><div class="line">           <span class="comment">// ğŸ‘¼ ç”Ÿæˆ SQL</span></div><div class="line">           result.getExecutionUnits().add(<span class="keyword">new</span> SQLExecutionUnit(each.getDataSourceName(), rewriteEngine.generateSQL(each, sqlBuilder)));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è°ƒç”¨ <code>RewriteEngine#generateSQL()</code> ç”Ÿæˆ<strong>æ‰§è¡ŒSQL</strong>ã€‚å¯¹äºç¬›å¡å°”ç§¯è·¯ç”±ç»“æœå’Œç®€å•è·¯ç”±ç»“æœä¼ é€’çš„å‚æ•°ç•¥æœ‰ä¸åŒï¼šå‰è€…ä½¿ç”¨ CartesianDataSource ( CartesianTableReference )ï¼Œåè€…ä½¿ç”¨è·¯ç”±è¡¨å•å…ƒ ( TableUnit )ã€‚å¯¹è·¯ç”±ç»“æœä¸æ˜¯å¾ˆäº†è§£çš„åŒå­¦ï¼Œå»ºè®®çœ‹ä¸‹ <a href="http://www.yunai.me/Sharding-JDBC/sql-route-2/?mp">ã€ŠSQL è·¯ç”±ï¼ˆäºŒï¼‰ä¹‹åˆ†åº“åˆ†è¡¨è·¯ç”±ã€‹</a>ã€‚</li>
</ul>
<p><code>RewriteEngine#generateSQL()</code> å¯¹äºç¬›å¡å°”ç§¯è·¯ç”±ç»“æœå’Œç®€å•è·¯ç”±ç»“æœä¸¤ç§æƒ…å†µï¼Œå¤„ç†ä¸Šå¤§ä½“æ˜¯ä¸€è‡´çš„ï¼š1. è·å¾— SQL ç›¸å…³<strong>é€»è¾‘è¡¨</strong>å¯¹åº”çš„<strong>çœŸå®è¡¨</strong>æ˜ å°„ï¼Œ2. æ ¹æ®æ˜ å°„æ”¹å†™ SQL ç›¸å…³<strong>é€»è¾‘è¡¨</strong>ä¸º<strong>çœŸå®è¡¨</strong>ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ç”ŸæˆSQLè¯­å¥.</div><div class="line">* <span class="doctag">@param</span> tableUnit è·¯ç”±è¡¨å•å…ƒ</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLæ„å»ºå™¨</div><div class="line">* <span class="doctag">@return</span> SQLè¯­å¥</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">generateSQL</span><span class="params">(<span class="keyword">final</span> TableUnit tableUnit, <span class="keyword">final</span> SQLBuilder sqlBuilder)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> sqlBuilder.toSQL(getTableTokens(tableUnit));</div><div class="line">&#125;  </div><div class="line"><span class="comment">/**</span></div><div class="line">* ç”ŸæˆSQLè¯­å¥.</div><div class="line">* <span class="doctag">@param</span> cartesianTableReference ç¬›å¡å°”ç§¯è·¯ç”±è¡¨å•å…ƒ</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLæ„å»ºå™¨</div><div class="line">* <span class="doctag">@return</span> SQLè¯­å¥</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">generateSQL</span><span class="params">(<span class="keyword">final</span> CartesianTableReference cartesianTableReference, <span class="keyword">final</span> SQLBuilder sqlBuilder)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> sqlBuilder.toSQL(getTableTokens(cartesianTableReference));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">// SQLBuilder.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ç”ŸæˆSQLè¯­å¥.</div><div class="line">* <span class="doctag">@param</span> tableTokens å ä½ç¬¦é›†åˆï¼ˆé€»è¾‘è¡¨ä¸çœŸå®è¡¨æ˜ å°„ï¼‰</div><div class="line">* <span class="doctag">@return</span> SQLè¯­å¥</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toSQL</span><span class="params">(<span class="keyword">final</span> Map&lt;String, String&gt; tableTokens)</span> </span>&#123;</div><div class="line">   StringBuilder result = <span class="keyword">new</span> StringBuilder();</div><div class="line">   <span class="keyword">for</span> (Object each : segments) &#123;</div><div class="line">       <span class="keyword">if</span> (each <span class="keyword">instanceof</span> TableToken &amp;&amp; tableTokens.containsKey(((TableToken) each).tableName)) &#123;</div><div class="line">           result.append(tableTokens.get(((TableToken) each).tableName));</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           result.append(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#toSQL()</code> ç»“æœå¦‚å›¾ï¼š <img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/09.png" alt="">
ğŸ˜œ å¯¹ <strong>SQLæ”¹å†™</strong> æ˜¯ä¸æ˜¯æ¸…æ™°å¾ˆå¤šäº†ã€‚</li>
</ul>
<hr>
<p>ä¸‹é¢æˆ‘ä»¬ä»¥<strong>ç¬›å¡å°”ç§¯è·¯ç”±ç»“æœ</strong>è·å¾— SQL ç›¸å…³<strong>é€»è¾‘è¡¨</strong>å¯¹åº”çš„<strong>çœŸå®è¡¨</strong>æ˜ å°„ä¸ºä¾‹å­(<em>ç®€å•è·¯ç”±ç»“æœåŸºæœ¬ç±»ä¼¼è€Œä¸”ç®€å•</em>)ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—ï¼ˆç¬›å¡å°”ç§¯è¡¨è·¯ç”±ç»„é‡Œçš„è·¯ç”±è¡¨å•å…ƒé€»è¾‘è¡¨ å’Œ ä¸å…¶äº’ä¸ºBindingTableå…³ç³»çš„é€»è¾‘è¡¨ï¼‰å¯¹åº”çš„çœŸå®è¡¨æ˜ å°„ï¼ˆé€»è¾‘è¡¨éœ€è¦åœ¨ SQL ä¸­å­˜åœ¨ï¼‰</div><div class="line">* <span class="doctag">@param</span> cartesianTableReference ç¬›å¡å°”ç§¯è¡¨è·¯ç”±ç»„</div><div class="line">* <span class="doctag">@return</span> é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">getTableTokens</span><span class="params">(<span class="keyword">final</span> CartesianTableReference cartesianTableReference)</span> </span>&#123;</div><div class="line">   Map&lt;String, String&gt; tableTokens = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (TableUnit each : cartesianTableReference.getTableUnits()) &#123;</div><div class="line">       tableTokens.put(each.getLogicTableName(), each.getActualTableName());</div><div class="line">       <span class="comment">// æŸ¥æ‰¾ BindingTableRule</span></div><div class="line">       Optional&lt;BindingTableRule&gt; bindingTableRule = shardingRule.findBindingTableRule(each.getLogicTableName());</div><div class="line">       <span class="keyword">if</span> (bindingTableRule.isPresent()) &#123;</div><div class="line">           tableTokens.putAll(getBindingTableTokens(each, bindingTableRule.get()));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> tableTokens;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾— BindingTable å…³ç³»çš„é€»è¾‘è¡¨å¯¹åº”çš„çœŸå®è¡¨æ˜ å°„ï¼ˆé€»è¾‘è¡¨éœ€è¦åœ¨ SQL ä¸­å­˜åœ¨ï¼‰</div><div class="line">* <span class="doctag">@param</span> tableUnit è·¯ç”±å•å…ƒ</div><div class="line">* <span class="doctag">@param</span> bindingTableRule Bindingè¡¨è§„åˆ™é…ç½®å¯¹è±¡</div><div class="line">* <span class="doctag">@return</span> æ˜ å°„</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">getBindingTableTokens</span><span class="params">(<span class="keyword">final</span> TableUnit tableUnit, <span class="keyword">final</span> BindingTableRule bindingTableRule)</span> </span>&#123;</div><div class="line">   Map&lt;String, String&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (String eachTable : sqlStatement.getTables().getTableNames()) &#123;</div><div class="line">       <span class="keyword">if</span> (!eachTable.equalsIgnoreCase(tableUnit.getLogicTableName()) &amp;&amp; bindingTableRule.hasLogicTable(eachTable)) &#123;</div><div class="line">           result.put(eachTable, bindingTableRule.getBindingActualTable(tableUnit.getDataSourceName(), eachTable, tableUnit.getActualTableName()));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬›å¡å°”ç§¯è¡¨è·¯ç”±ç»„( CartesianTableReference )åŒ…å«<strong>å¤šä¸ª</strong>è·¯ç”±è¡¨å•å…ƒ( TableUnit )ã€‚æ¯ä¸ªè·¯ç”±è¡¨å•å…ƒéœ€è¦éå†ã€‚</li>
<li>è·¯ç”±è¡¨å•å…ƒæœ¬èº«åŒ…å«é€»è¾‘è¡¨å’ŒçœŸå®è¡¨ï¼Œç›´æ¥æ·»åŠ åˆ°æ˜ å°„å³å¯ã€‚</li>
<li>äº’ä¸º BindingTable å…³ç³»çš„è¡¨åªè®¡ç®—ä¸€æ¬¡è·¯ç”±åˆ†ç‰‡ï¼Œå› æ­¤<strong>æœªè®¡ç®—</strong>çš„çœŸå®è¡¨éœ€è¦ä»¥å…¶å¯¹åº”çš„<strong>å·²è®¡ç®—</strong>çš„çœŸå®è¡¨å»æŸ¥æ‰¾ï¼Œå³ <code>bindingTableRule.getBindingActualTable(tableUnit.getDataSourceName(), eachTable, tableUnit.getActualTableName())</code> å¤„é€»è¾‘ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// BindingTableRule.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ ¹æ®å…¶ä»–Bindingè¡¨çœŸå®è¡¨åç§°è·å–ç›¸åº”çš„çœŸå®Bindingè¡¨åç§°.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> dataSource æ•°æ®æºåç§°</div><div class="line">* <span class="doctag">@param</span> logicTable é€»è¾‘è¡¨åç§°</div><div class="line">* <span class="doctag">@param</span> otherActualTable å…¶ä»–çœŸå®Bindingè¡¨åç§°</div><div class="line">* <span class="doctag">@return</span> çœŸå®Bindingè¡¨åç§°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getBindingActualTable</span><span class="params">(<span class="keyword">final</span> String dataSource, <span class="keyword">final</span> String logicTable, <span class="keyword">final</span> String otherActualTable)</span> </span>&#123;</div><div class="line">   <span class="comment">// è®¡ç®— otherActualTable åœ¨å…¶ TableRule çš„ actualTable æ˜¯ç¬¬å‡ ä¸ª</span></div><div class="line">   <span class="keyword">int</span> index = -<span class="number">1</span>;</div><div class="line">   <span class="keyword">for</span> (TableRule each : tableRules) &#123;</div><div class="line">       <span class="keyword">if</span> (each.isDynamic()) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Dynamic table cannot support Binding table."</span>);</div><div class="line">       &#125;</div><div class="line">       index = each.findActualTableIndex(dataSource, otherActualTable);</div><div class="line">       <span class="keyword">if</span> (-<span class="number">1</span> != index) &#123;</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   Preconditions.checkState(-<span class="number">1</span> != index, String.format(<span class="string">"Actual table [%s].[%s] is not in table config"</span>, dataSource, otherActualTable));</div><div class="line">   <span class="comment">// è®¡ç®— logicTable åœ¨å…¶ TableRule çš„ ç¬¬index çš„ çœŸå®è¡¨</span></div><div class="line">   <span class="keyword">for</span> (TableRule each : tableRules) &#123;</div><div class="line">       <span class="keyword">if</span> (each.getLogicTable().equalsIgnoreCase(logicTable)) &#123;</div><div class="line">           <span class="keyword">return</span> each.getActualTables().get(index).getTableName();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(String.format(<span class="string">"Cannot find binding actual table, data source: %s, logic table: %s, other actual table: %s"</span>, dataSource, logicTable, otherActualTable));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å¯èƒ½çœ‹èµ·æ¥æœ‰äº›ç»•ï¼Œæˆ‘ä»¬çœ‹å¼ å›¾ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/10.png" alt=""></p>
<p><strong>å‹æƒ…æç¤º</strong>ï¼šè¿™é‡Œä¸å«Œå•°å—¦åœ¨æä¸€å¥ï¼Œäº’ä¸º BindingTable çš„è¡¨ï¼Œé…ç½® TableRule æ—¶ï¼Œ<code>actualTables</code> æ•°é‡ä¸€å®šè¦ä¸€è‡´ï¼Œå¦åˆ™å¤šå‡ºæ¥çš„è¡¨ï¼Œå¯èƒ½ä¼šæ— æ³•è¢«è·¯ç”±åˆ°ã€‚</p>
<h1>666. å½©è›‹</h1>
<p>å“ˆå“ˆå“ˆï¼Œçœ‹å®Œ<strong>SQLæ”¹å†™</strong>åï¼Œ<strong>SQLè§£æ</strong>æ˜¯ä¸æ˜¯æ¸…æ™°å¤šäº†ï¼å˜¿å˜¿å˜¿ï¼Œåæ­£æˆ‘ç°åœ¨æœ‰ç‚¹å—¨ã€‚æ©ï¼Œè›®å—¨çš„ã€‚</p>
<p>å½“ç„¶ï¼Œå¦‚æœ<strong>SQLè§£æ</strong>ç†è§£ä¸Šæœ‰ç‚¹ç–‘æƒ‘çš„ä½ ï¼Œ<strong>æ¬¢è¿</strong>åŠ æˆ‘çš„å¾®ä¿¡ï¼Œå’± <strong>1å¯¹1</strong> æåŸºã€‚å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ï¼š<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</a> å³å¯è·å¾—ã€‚</p>
<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<p>é“å‹ï¼Œè½¬å‘ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>
<p>Let's Go! <a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šåˆ†å¸ƒå¼ä¸»é”®ã€‹</a>ã€<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL æ‰§è¡Œã€‹</a>ã€<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šç»“æœèšåˆã€‹</a> ç»§ç»­ã€‚</p>
<p><em>æ„Ÿè°¢æŠ€æœ¯ç‰›é€¼å¦‚ä½ è€å¿ƒçš„é˜…è¯»æœ¬æ–‡ã€‚</em></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;o
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±ï¼ˆä¸‰ï¼‰ä¹‹Springä¸YAMLé…ç½®</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-route-3/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-route-3/</id>
    <published>2017-08-07T16:00:00.000Z</published>
    <updated>2017-08-10T17:25:54.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<p>æŠ±æ­‰ï¼Œç«™å‘æ–‡ã€‚è¿‘æœŸçœ‹æƒ…å†µæ›´æ–°ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;o
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±ï¼ˆäºŒï¼‰ä¹‹åˆ†åº“åˆ†è¡¨è·¯ç”±</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-route-2/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-route-2/</id>
    <published>2017-08-05T16:00:00.000Z</published>
    <updated>2017-08-10T17:25:50.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Sharding-JDBC 1.5.0 æ­£å¼ç‰ˆ</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. SQLRouteResult</a></li>
<li><a href="#">3. è·¯ç”±ç­–ç•¥ x ç®—æ³•</a></li>
<li><a href="#">4. SQL è·¯ç”±</a></li>
<li><a href="#">5. DatabaseHintSQLRouter</a></li>
<li><a href="#">6. ParsingSQLRouter</a>
<ul>
<li><a href="#">6.1 SimpleRoutingEngine</a></li>
<li><a href="#">6.2 ComplexRoutingEngine</a></li>
<li><a href="#">6.3 CartesianRoutingEngine</a></li>
<li><a href="#">6.3 ParsingSQLRouter ä¸»#route()</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡åˆ†äº«åˆ†è¡¨åˆ†åº“<strong>è·¯ç”±</strong>ç›¸å…³çš„å®ç°ã€‚æ¶‰åŠå†…å®¹å¦‚ä¸‹ï¼š</p>
<ol>
<li>SQL è·¯ç”±ç»“æœ</li>
<li>è·¯ç”±ç­–ç•¥ x ç®—æ³•</li>
<li>SQL è·¯ç”±å™¨</li>
</ol>
<p>å†…å®¹é¡ºåºå¦‚ç¼–å·ã€‚</p>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>
ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<p>SQL è·¯ç”±å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/06.png" alt=""></p>
<h1>2. SQLRouteResult</h1>
<p>ç»è¿‡ <strong>SQLè§£æ</strong>ã€<strong>SQLè·¯ç”±</strong>åï¼Œäº§ç”Ÿ<strong>SQLè·¯ç”±ç»“æœ</strong>ï¼Œå³ SQLRouteResultã€‚æ ¹æ®è·¯ç”±ç»“æœï¼Œ<strong>ç”ŸæˆSQL</strong>ï¼Œ<strong>æ‰§è¡ŒSQL</strong>ã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/01.png" alt=""></p>
<ul>
<li><code>sqlStatement</code> ï¼šSQLè¯­å¥å¯¹è±¡ï¼Œç»è¿‡<strong>SQLè§£æ</strong>çš„ç»“æœå¯¹è±¡ã€‚</li>
<li><code>executionUnits</code> ï¼šSQLæœ€å°æ‰§è¡Œå•å…ƒé›†åˆã€‚<strong>SQLæ‰§è¡Œ</strong>æ—¶ï¼Œæ‰§è¡Œæ¯ä¸ªå•å…ƒã€‚</li>
<li><code>generatedKeys</code> ï¼š<strong>æ’å…¥</strong>SQLè¯­å¥ç”Ÿæˆçš„ä¸»é”®ç¼–å·é›†åˆã€‚ç›®å‰ä¸æ”¯æŒæ‰¹é‡æ’å…¥è€Œä½¿ç”¨é›†åˆçš„åŸå› ï¼ŒçŒœæµ‹æ˜¯ä¸ºäº†æœªæ¥æ”¯æŒæ‰¹é‡æ’å…¥åšå‡†å¤‡ã€‚</li>
</ul>
<h1>3. è·¯ç”±ç­–ç•¥ x ç®—æ³•</h1>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_04/04.png" alt=""></p>
<p>ShardingStrategyï¼Œåˆ†ç‰‡ç­–ç•¥ã€‚ç›®å‰æ”¯æŒä¸¤ç§åˆ†ç‰‡ï¼š</p>
<p><em>åˆ†ç‰‡èµ„æºï¼šåœ¨åˆ†åº“ç­–ç•¥é‡ŒæŒ‡çš„æ˜¯åº“ï¼Œåœ¨åˆ†è¡¨ç­–ç•¥é‡ŒæŒ‡çš„æ˜¯è¡¨ã€‚</em></p>
<p>ã€1ã€‘ è®¡ç®—<strong>é™æ€</strong>åˆ†ç‰‡ï¼ˆå¸¸ç”¨ï¼‰</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingStrategy.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¡ç®—é™æ€åˆ†ç‰‡.</div><div class="line">* <span class="doctag">@param</span> sqlType SQLè¯­å¥çš„ç±»å‹</div><div class="line">* <span class="doctag">@param</span> availableTargetNames æ‰€æœ‰çš„å¯ç”¨åˆ†ç‰‡èµ„æºé›†åˆ</div><div class="line">* <span class="doctag">@param</span> shardingValues åˆ†ç‰‡å€¼é›†åˆ</div><div class="line">* <span class="doctag">@return</span> åˆ†åº“åæŒ‡å‘çš„æ•°æ®æºåç§°é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doStaticSharding</span><span class="params">(<span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> Collection&lt;ShardingValue&lt;?&gt;&gt; shardingValues)</span> </span>&#123;</div><div class="line">   Collection&lt;String&gt; result = <span class="keyword">new</span> TreeSet&lt;&gt;(String.CASE_INSENSITIVE_ORDER);</div><div class="line">   <span class="keyword">if</span> (shardingValues.isEmpty()) &#123;</div><div class="line">       Preconditions.checkState(!isInsertMultiple(sqlType, availableTargetNames), <span class="string">"INSERT statement should contain sharding value."</span>); <span class="comment">// æ’å…¥ä¸èƒ½æœ‰å¤šèµ„æºå¯¹è±¡</span></div><div class="line">       result.addAll(availableTargetNames);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       result.addAll(doSharding(shardingValues, availableTargetNames));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* æ’å…¥SQL æ˜¯å¦æ’å…¥å¤šä¸ªåˆ†ç‰‡</div><div class="line">* <span class="doctag">@param</span> sqlType SQLç±»å‹</div><div class="line">* <span class="doctag">@param</span> availableTargetNames æ‰€æœ‰çš„å¯ç”¨åˆ†ç‰‡èµ„æºé›†åˆ</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isInsertMultiple</span><span class="params">(<span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> SQLType.INSERT == sqlType &amp;&amp; availableTargetNames.size() &gt; <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>æ’å…¥SQL éœ€è¦æœ‰ç‰‡é”®å€¼ï¼Œå¦åˆ™æ— æ³•åˆ¤æ–­å•ä¸ªåˆ†ç‰‡èµ„æºã€‚<em>ï¼ˆSharding-JDBC ç›®å‰ä»…æ”¯æŒå•æ¡è®°å½•æ’å…¥ï¼‰</em></li>
</ul>
<p>ã€2ã€‘è®¡ç®—<strong>åŠ¨æ€</strong>åˆ†ç‰‡</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingStrategy.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¡ç®—åŠ¨æ€åˆ†ç‰‡.</div><div class="line">* <span class="doctag">@param</span> shardingValues åˆ†ç‰‡å€¼é›†åˆ</div><div class="line">* <span class="doctag">@return</span> åˆ†åº“åæŒ‡å‘çš„åˆ†ç‰‡èµ„æºé›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doDynamicSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;ShardingValue&lt;?&gt;&gt; shardingValues)</span> </span>&#123;</div><div class="line">   Preconditions.checkState(!shardingValues.isEmpty(), <span class="string">"Dynamic table should contain sharding value."</span>); <span class="comment">// åŠ¨æ€åˆ†ç‰‡å¿…é¡»æœ‰åˆ†ç‰‡å€¼</span></div><div class="line">   Collection&lt;String&gt; availableTargetNames = Collections.emptyList();</div><div class="line">   Collection&lt;String&gt; result = <span class="keyword">new</span> TreeSet&lt;&gt;(String.CASE_INSENSITIVE_ORDER);</div><div class="line">   result.addAll(doSharding(shardingValues, availableTargetNames));</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>åŠ¨æ€åˆ†ç‰‡å¯¹åº” <code>TableRule.dynamic=true</code></li>
<li>åŠ¨æ€åˆ†ç‰‡å¿…é¡»æœ‰åˆ†ç‰‡å€¼</li>
</ul>
<p>ğŸ˜ˆ é—·äº†ï¼Œçœ‹èµ·æ¥ä¸¤è€…æ²¡å•¥åŒºåˆ«ï¼Ÿç­”æ¡ˆåœ¨<strong>åˆ†ç‰‡ç®—æ³•</strong>ä¸Šã€‚æˆ‘ä»¬å…ˆçœ‹ <code>#doSharding()</code> æ–¹æ³•çš„å®ç°ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingStrategy.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¡ç®—åˆ†ç‰‡</div><div class="line">* <span class="doctag">@param</span> shardingValues åˆ†ç‰‡å€¼é›†åˆ</div><div class="line">* <span class="doctag">@param</span> availableTargetNames æ‰€æœ‰çš„å¯ç”¨åˆ†ç‰‡èµ„æºé›†åˆ</div><div class="line">* <span class="doctag">@return</span> åˆ†åº“åæŒ‡å‘çš„åˆ†ç‰‡èµ„æºé›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;String&gt; <span class="title">doSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;ShardingValue&lt;?&gt;&gt; shardingValues, <span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ— ç‰‡é”®</span></div><div class="line">   <span class="keyword">if</span> (shardingAlgorithm <span class="keyword">instanceof</span> NoneKeyShardingAlgorithm) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.singletonList(((NoneKeyShardingAlgorithm) shardingAlgorithm).doSharding(availableTargetNames, shardingValues.iterator().next()));</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å•ç‰‡é”®</span></div><div class="line">   <span class="keyword">if</span> (shardingAlgorithm <span class="keyword">instanceof</span> SingleKeyShardingAlgorithm) &#123;</div><div class="line">       SingleKeyShardingAlgorithm&lt;?&gt; singleKeyShardingAlgorithm = (SingleKeyShardingAlgorithm&lt;?&gt;) shardingAlgorithm;</div><div class="line">       ShardingValue shardingValue = shardingValues.iterator().next();</div><div class="line">       <span class="keyword">switch</span> (shardingValue.getType()) &#123;</div><div class="line">           <span class="keyword">case</span> SINGLE:</div><div class="line">               <span class="keyword">return</span> Collections.singletonList(singleKeyShardingAlgorithm.doEqualSharding(availableTargetNames, shardingValue));</div><div class="line">           <span class="keyword">case</span> LIST:</div><div class="line">               <span class="keyword">return</span> singleKeyShardingAlgorithm.doInSharding(availableTargetNames, shardingValue);</div><div class="line">           <span class="keyword">case</span> RANGE:</div><div class="line">               <span class="keyword">return</span> singleKeyShardingAlgorithm.doBetweenSharding(availableTargetNames, shardingValue);</div><div class="line">           <span class="keyword">default</span>:</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(shardingValue.getType().getClass().getName());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å¤šç‰‡é”®</span></div><div class="line">   <span class="keyword">if</span> (shardingAlgorithm <span class="keyword">instanceof</span> MultipleKeysShardingAlgorithm) &#123;</div><div class="line">       <span class="keyword">return</span> ((MultipleKeysShardingAlgorithm) shardingAlgorithm).doSharding(availableTargetNames, shardingValues);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(shardingAlgorithm.getClass().getName());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>æ— åˆ†ç‰‡é”®ç®—æ³•ï¼šå¯¹åº” NoneKeyShardingAlgorithm åˆ†ç‰‡ç®—æ³•æ¥å£ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NoneKeyShardingAlgorithm</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;?&gt;&gt; <span class="keyword">extends</span> <span class="title">ShardingAlgorithm</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">doSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, ShardingValue&lt;T&gt; shardingValue)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å•ç‰‡é”®ç®—æ³•ï¼šå¯¹åº” SingleKeyShardingAlgorithm åˆ†ç‰‡ç®—æ³•æ¥å£ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SingleKeyShardingAlgorithm</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;?&gt;&gt; <span class="keyword">extends</span> <span class="title">ShardingAlgorithm</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">doEqualSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, ShardingValue&lt;T&gt; shardingValue)</span></span>;</div><div class="line">    <span class="function">Collection&lt;String&gt; <span class="title">doInSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, ShardingValue&lt;T&gt; shardingValue)</span></span>;</div><div class="line">    <span class="function">Collection&lt;String&gt; <span class="title">doBetweenSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, ShardingValue&lt;T&gt; shardingValue)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th style="text-align:left">ShardingValueType</th>
<th style="text-align:left">SQL æ“ä½œç¬¦</th>
<th style="text-align:left">æ¥å£æ–¹æ³•</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">SINGLE</td>
<td style="text-align:left">=</td>
<td style="text-align:left"><code>#doEqualSharding()</code></td>
</tr>
<tr>
<td style="text-align:left">LIST</td>
<td style="text-align:left">IN</td>
<td style="text-align:left"><code>#doInSharding()</code></td>
</tr>
<tr>
<td style="text-align:left">RANGE</td>
<td style="text-align:left">BETWEEN</td>
<td style="text-align:left"><code>#doBetweenSharding()</code></td>
</tr>
</tbody>
</table>
<ul>
<li>å¤šç‰‡é”®ç®—æ³•ï¼šå¯¹åº” MultipleKeysShardingAlgorithm åˆ†ç‰‡ç®—æ³•æ¥å£ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MultipleKeysShardingAlgorithm</span> <span class="keyword">extends</span> <span class="title">ShardingAlgorithm</span> </span>&#123;</div><div class="line">    <span class="function">Collection&lt;String&gt; <span class="title">doSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, Collection&lt;ShardingValue&lt;?&gt;&gt; shardingValues)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åˆ†ç‰‡ç®—æ³•ç±»ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/02.png" alt=""></p>
<p>æ¥çœ‹çœ‹ Sharding-JDBC å®ç°çš„æ— éœ€åˆ†åº“çš„åˆ†ç‰‡ç®—æ³• NoneDatabaseShardingAlgorithm (NoneTableShardingAlgorithm åŸºæœ¬ä¸€æ¨¡ä¸€æ ·)ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NoneDatabaseShardingAlgorithm</span> <span class="keyword">implements</span> <span class="title">SingleKeyDatabaseShardingAlgorithm</span>&lt;<span class="title">String</span>&gt;, <span class="title">MultipleKeysDatabaseShardingAlgorithm</span> </span>&#123; </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> Collection&lt;ShardingValue&lt;?&gt;&gt; shardingValues)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> availableTargetNames;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doEqualSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> ShardingValue&lt;String&gt; shardingValue)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> availableTargetNames.isEmpty() ? <span class="keyword">null</span> : availableTargetNames.iterator().next();</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doInSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> ShardingValue&lt;String&gt; shardingValue)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> availableTargetNames;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doBetweenSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> ShardingValue&lt;String&gt; shardingValue)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> availableTargetNames;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>**ä¸€å®šè¦æ³¨æ„ï¼ŒNoneXXXXShardingAlgorithm åªé€‚ç”¨äºæ— åˆ†åº“/è¡¨çš„éœ€æ±‚ï¼Œå¦åˆ™ä¼šæ˜¯é”™è¯¯çš„è·¯ç”±ç»“æœã€‚**ä¾‹å¦‚ï¼Œ<code>#doEqualSharding()</code> è¿”å›çš„æ˜¯ç¬¬ä¸€ä¸ªåˆ†ç‰‡èµ„æºã€‚</li>
</ul>
<hr>
<p>å†æ¥çœ‹æµ‹è¯•ç›®å½•ä¸‹å®ç°çš„<strong>ä½™æ•°åŸºå¶åˆ†è¡¨ç®—æ³•</strong> ModuloTableShardingAlgorithm çš„å®ç°ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// com.dangdang.ddframe.rdb.integrate.fixture.ModuloTableShardingAlgorithm.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ModuloTableShardingAlgorithm</span> <span class="keyword">implements</span> <span class="title">SingleKeyTableShardingAlgorithm</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doEqualSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; tableNames, <span class="keyword">final</span> ShardingValue&lt;Integer&gt; shardingValue)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (String each : tableNames) &#123;</div><div class="line">            <span class="keyword">if</span> (each.endsWith(shardingValue.getValue() % <span class="number">2</span> + <span class="string">""</span>)) &#123;</div><div class="line">                <span class="keyword">return</span> each;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doInSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; tableNames, <span class="keyword">final</span> ShardingValue&lt;Integer&gt; shardingValue)</span> </span>&#123;</div><div class="line">        Collection&lt;String&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(tableNames.size());</div><div class="line">        <span class="keyword">for</span> (Integer value : shardingValue.getValues()) &#123;</div><div class="line">            <span class="keyword">for</span> (String tableName : tableNames) &#123;</div><div class="line">                <span class="keyword">if</span> (tableName.endsWith(value % <span class="number">2</span> + <span class="string">""</span>)) &#123;</div><div class="line">                    result.add(tableName);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doBetweenSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; tableNames, <span class="keyword">final</span> ShardingValue&lt;Integer&gt; shardingValue)</span> </span>&#123;</div><div class="line">        Collection&lt;String&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(tableNames.size());</div><div class="line">        Range&lt;Integer&gt; range = shardingValue.getValueRange();</div><div class="line">        <span class="keyword">for</span> (Integer i = range.lowerEndpoint(); i &lt;= range.upperEndpoint(); i++) &#123;</div><div class="line">            <span class="keyword">for</span> (String each : tableNames) &#123;</div><div class="line">                <span class="keyword">if</span> (each.endsWith(i % <span class="number">2</span> + <span class="string">""</span>)) &#123;</div><div class="line">                    result.add(each);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>æˆ‘ä»¬å¯ä»¥å‚è€ƒè¿™ä¸ªä¾‹å­ç¼–å†™è‡ªå·±çš„åˆ†ç‰‡ç®—å“Ÿ ğŸ‘¼ã€‚</li>
<li>å¤šç‰‡é”®åˆ†åº“ç®—æ³•æ¥å£å®ç°ä¾‹å­ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/test/java/com/dangdang/ddframe/rdb/integrate/fixture/MultipleKeysModuloDatabaseShardingAlgorithm.java" rel="external nofollow noopener noreferrer" target="_blank">MultipleKeysModuloDatabaseShardingAlgorithm.java</a></li>
</ul>
<hr>
<p>ğŸ˜ˆ æ¥çœ‹çœ‹<strong>åŠ¨æ€è®¡ç®—åˆ†ç‰‡</strong>éœ€è¦æ€ä¹ˆå®ç°åˆ†ç‰‡ç®—æ³•ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// com.dangdang.ddframe.rdb.integrate.fixture.SingleKeyDynamicModuloTableShardingAlgorithm.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleKeyDynamicModuloTableShardingAlgorithm</span> <span class="keyword">implements</span> <span class="title">SingleKeyTableShardingAlgorithm</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * è¡¨å‰ç¼€</div><div class="line">    */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String tablePrefix;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doEqualSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> ShardingValue&lt;Integer&gt; shardingValue)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> tablePrefix + shardingValue.getValue() % <span class="number">10</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doInSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> ShardingValue&lt;Integer&gt; shardingValue)</span> </span>&#123;</div><div class="line">        Collection&lt;String&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(shardingValue.getValues().size());</div><div class="line">        <span class="keyword">for</span> (Integer value : shardingValue.getValues()) &#123;</div><div class="line">            result.add(tablePrefix + value % <span class="number">10</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doBetweenSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> ShardingValue&lt;Integer&gt; shardingValue)</span> </span>&#123;</div><div class="line">        Collection&lt;String&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(availableTargetNames.size());</div><div class="line">        Range&lt;Integer&gt; range = shardingValue.getValueRange();</div><div class="line">        <span class="keyword">for</span> (Integer i = range.lowerEndpoint(); i &lt;= range.upperEndpoint(); i++) &#123;</div><div class="line">            result.add(tablePrefix + i % <span class="number">10</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>éªšå¹´ï¼Œæ˜¯ä¸æ˜¯æ˜ç™½äº†ä¸€äº›ï¼Ÿ<strong>åŠ¨æ€è¡¨</strong>æ— éœ€æŠŠçœŸå®è¡¨é…ç½®åˆ° TableRuleï¼Œè€Œæ˜¯é€šè¿‡<strong>åˆ†ç‰‡ç®—æ³•</strong>è®¡ç®—å‡º<strong>çœŸå®è¡¨</strong>ã€‚</li>
</ul>
<h1>4. SQL è·¯ç”±</h1>
<p>SQLRouterï¼ŒSQL è·¯ç”±å™¨æ¥å£ï¼Œå…±æœ‰ä¸¤ç§å®ç°ï¼š</p>
<ul>
<li>DatabaseHintSQLRouterï¼šé€šè¿‡æç¤ºä¸”ä»…è·¯ç”±è‡³æ•°æ®åº“çš„SQLè·¯ç”±å™¨</li>
<li>ParsingSQLRouterï¼šéœ€è¦è§£æçš„SQLè·¯ç”±å™¨</li>
</ul>
<p>å®ƒä»¬å®ç° <code>#parse()</code>è¿›è¡Œ<strong>SQLè§£æ</strong>ï¼Œ<code>#route()</code>è¿›è¡Œ<strong>SQLè·¯ç”±</strong>ã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/03.png" alt=""></p>
<hr>
<p>RoutingEngineï¼Œè·¯ç”±å¼•æ“æ¥å£ï¼Œå…±æœ‰å››ç§å®ç°ï¼š</p>
<ul>
<li>DatabaseHintRoutingEngineï¼šåŸºäºæ•°æ®åº“æç¤ºçš„è·¯ç”±å¼•æ“</li>
<li>SimpleRoutingEngineï¼šç®€å•è·¯ç”±å¼•æ“</li>
<li>CartesianRoutingEngineï¼šç¬›å¡å°”ç§¯çš„åº“è¡¨è·¯ç”±</li>
<li>ComplexRoutingEngineï¼šæ··åˆå¤šåº“è¡¨è·¯ç”±å¼•æ“</li>
</ul>
<p><strong>ComplexRoutingEngine æ ¹æ®è·¯ç”±ç»“æœä¼šè½¬åŒ–æˆ SimpleRoutingEngine æˆ– ComplexRoutingEngine</strong>ã€‚ä¸‹æ–‡ä¼šçœ‹ç›¸åº”æºç ã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/04.png" alt=""></p>
<hr>
<p>è·¯ç”±ç»“æœæœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>RoutingResultï¼šç®€å•è·¯ç”±ç»“æœ</li>
<li>CartesianRoutingResultï¼šç¬›å¡å°”ç§¯è·¯ç”±ç»“æœ</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/05.png" alt=""></p>
<p>ä»å›¾ä¸­ï¼Œæˆ‘ä»¬å·²ç»èƒ½å¤§æ¦‚çœ‹åˆ°ä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œæ›´å…·ä½“çš„ä¸‹æ–‡éšæºç ä¸€èµ·åˆ†äº«ã€‚</p>
<p>ğŸ˜ˆ SQLRouteResult å’Œ RoutingResult æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p>
<ul>
<li>SQLRouteResultï¼š<strong>æ•´ä¸ªSQLè·¯ç”±</strong>è¿”å›çš„è·¯ç”±ç»“æœ</li>
<li>RoutingResultï¼š<strong>RoutingEngine</strong>è¿”å›è·¯ç”±ç»“æœ</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/06.png" alt=""></p>
<hr>
<p>ä¸€ä¸‹å­çœ‹åˆ°è¿™ä¹ˆå¤š**&quot;å¯¹è±¡&quot;<strong>ï¼Œå¯èƒ½æœ‰ç‚¹</strong>ç´§å¼ **ã€‚ä¸è¦ç´§å¼ ï¼Œæˆ‘ä»¬ä¸€èµ·åœ¨æ•´ç†ä¸‹ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">è·¯ç”±å™¨</th>
<th style="text-align:left">è·¯ç”±å¼•æ“</th>
<th style="text-align:left">è·¯ç”±ç»“æœ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">DatabaseHintSQLRouter</td>
<td style="text-align:left">DatabaseHintRoutingEngine</td>
<td style="text-align:left">RoutingResult</td>
</tr>
<tr>
<td style="text-align:left">ParsingSQLRouter</td>
<td style="text-align:left">SimpleRoutingEngine</td>
<td style="text-align:left">RoutingResult</td>
</tr>
<tr>
<td style="text-align:left">ParsingSQLRouter</td>
<td style="text-align:left">CartesianRoutingEngine</td>
<td style="text-align:left">CartesianRoutingResult</td>
</tr>
</tbody>
</table>
<p>ğŸ˜ˆ é€—æ¯”åšä¸»ç»™å¤§å®¶è§£å†³äº†**&quot;å¯¹è±¡&quot;<strong>ï¼Œæ˜¯ä¸æ˜¯åº”è¯¥</strong>åˆ†äº«æœ‹å‹åœˆ**ã€‚</p>
<h1>5. DatabaseHintSQLRouter</h1>
<p>DatabaseHintSQLRouterï¼ŒåŸºäºæ•°æ®åº“æç¤ºçš„è·¯ç”±å¼•æ“ã€‚è·¯ç”±å™¨å·¥å‚ SQLRouterFactory åˆ›å»ºè·¯ç”±å™¨æ—¶ï¼Œåˆ¤æ–­åˆ°ä½¿ç”¨æ•°æ®åº“æç¤º( Hint ) æ—¶ï¼Œåˆ›å»º DatabaseHintSQLRouterã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DatabaseHintRoutingEngine.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SQLRouter <span class="title">createSQLRouter</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> HintManagerHolder.isDatabaseShardingOnly() ? <span class="keyword">new</span> DatabaseHintSQLRouter(shardingContext) : <span class="keyword">new</span> ParsingSQLRouter(shardingContext);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å…ˆæ¥çœ‹ä¸‹ HintManagerHolderã€HintManager <strong>éƒ¨åˆ†ç›¸å…³</strong>çš„ä»£ç ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// HintManagerHolder.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HintManagerHolder</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * HintManager çº¿ç¨‹å˜é‡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;HintManager&gt; HINT_MANAGER_HOLDER = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ¤æ–­æ˜¯å¦å½“å‰åªåˆ†åº“.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span> æ˜¯å¦å½“å‰åªåˆ†åº“.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isDatabaseShardingOnly</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span> != HINT_MANAGER_HOLDER.get() &amp;&amp; HINT_MANAGER_HOLDER.get().isDatabaseShardingOnly();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ¸…ç†çº¿ç´¢åˆ†ç‰‡ç®¡ç†å™¨çš„æœ¬åœ°çº¿ç¨‹æŒæœ‰è€….</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</div><div class="line">        HINT_MANAGER_HOLDER.remove();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// HintManager.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HintManager</span> <span class="keyword">implements</span> <span class="title">AutoCloseable</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åº“åˆ†ç‰‡å€¼é›†åˆ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ShardingKey, ShardingValue&lt;?&gt;&gt; databaseShardingValues = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åªåšåº“åˆ†ç‰‡</div><div class="line">     * &#123;<span class="doctag">@link</span> DatabaseHintRoutingEngine&#125;</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> databaseShardingOnly;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–çº¿ç´¢åˆ†ç‰‡ç®¡ç†å™¨å®ä¾‹.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span> çº¿ç´¢åˆ†ç‰‡ç®¡ç†å™¨å®ä¾‹</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HintManager <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        HintManager result = <span class="keyword">new</span> HintManager();</div><div class="line">        HintManagerHolder.setHintManager(result);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è®¾ç½®åˆ†åº“åˆ†ç‰‡å€¼.</div><div class="line">     * </div><div class="line">     * &lt;p&gt;åˆ†ç‰‡æ“ä½œç¬¦ä¸ºç­‰å·.è¯¥æ–¹æ³•é€‚ç”¨äºåªåˆ†åº“çš„åœºæ™¯&lt;/p&gt;</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> value åˆ†ç‰‡å€¼</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDatabaseShardingValue</span><span class="params">(<span class="keyword">final</span> Comparable&lt;?&gt; value)</span> </span>&#123;</div><div class="line">        databaseShardingOnly = <span class="keyword">true</span>;</div><div class="line">        addDatabaseShardingValue(HintManagerHolder.DB_TABLE_NAME, HintManagerHolder.DB_COLUMN_NAME, value);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>é‚£ä¹ˆå¦‚æœè¦ä½¿ç”¨ DatabaseHintSQLRouterï¼Œæˆ‘ä»¬åªéœ€è¦ <code>HintManager.getInstance().setDatabaseShardingValue(åº“åˆ†ç‰‡å€¼)</code> å³å¯ã€‚è¿™é‡Œæœ‰ä¸¤ç‚¹è¦æ³¨æ„ä¸‹ï¼š</p>
<ul>
<li><code>HintManager#getInstance()</code>ï¼Œæ¯æ¬¡è·å–åˆ°çš„éƒ½æ˜¯<strong>æ–°</strong>çš„ HintManagerï¼Œå¤šæ¬¡èµ‹å€¼éœ€è¦å°å¿ƒã€‚</li>
<li><code>HintManager#close()</code>ï¼Œä½¿ç”¨å®Œéœ€è¦å»æ¸…ç†ï¼Œé¿å…ä¸‹ä¸ªè¯·æ±‚è¯»åˆ°é—æ¼çš„çº¿ç¨‹å˜é‡ã€‚</li>
</ul>
<hr>
<p>çœ‹çœ‹ DatabaseHintSQLRouter çš„å®ç°ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DatabaseHintSQLRouter.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLStatement <span class="title">parse</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> <span class="keyword">int</span> parametersSize)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> SQLJudgeEngine(logicSQL).judge(); <span class="comment">// åªè§£æ SQL ç±»å‹</span></div><div class="line">&#125;  </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="comment">// TODO insertçš„SQLä»ç„¶éœ€è¦è§£æè‡ªå¢ä¸»é”®</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLRouteResult <span class="title">route</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   Context context = MetricsContext.start(<span class="string">"Route SQL"</span>);</div><div class="line">   SQLRouteResult result = <span class="keyword">new</span> SQLRouteResult(sqlStatement);</div><div class="line">   <span class="comment">// è·¯ç”±</span></div><div class="line">   RoutingResult routingResult = <span class="keyword">new</span> DatabaseHintRoutingEngine(shardingRule.getDataSourceRule(), shardingRule.getDatabaseShardingStrategy(), sqlStatement.getType())</div><div class="line">           .route();</div><div class="line">   <span class="comment">// SQLæœ€å°æ‰§è¡Œå•å…ƒ</span></div><div class="line">   <span class="keyword">for</span> (TableUnit each : routingResult.getTableUnits().getTableUnits()) &#123;</div><div class="line">       result.getExecutionUnits().add(<span class="keyword">new</span> SQLExecutionUnit(each.getDataSourceName(), logicSQL));</div><div class="line">   &#125;</div><div class="line">   MetricsContext.stop(context);</div><div class="line">   <span class="keyword">if</span> (showSQL) &#123;</div><div class="line">       SQLLogger.logSQL(logicSQL, sqlStatement, result.getExecutionUnits(), parameters);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#parse()</code> åªè§£æäº† SQL ç±»å‹ï¼Œå³ SELECT / UPDATE / DELETE / INSERT ã€‚</li>
<li><strong>ä½¿ç”¨çš„åˆ†åº“ç­–ç•¥æ¥è‡ª ShardingRuleï¼Œä¸æ˜¯ TableRuleï¼Œè¿™ä¸ªä¸€å®šè¦ç•™å¿ƒã€‚<strong>â“å› ä¸º SQL æœªè§£æ</strong>è¡¨å</strong>ã€‚å› æ­¤ï¼Œå³ä½¿åœ¨ TableRule è®¾ç½®äº† <code>actualTables</code> å±æ€§ä¹Ÿæ˜¯æ²¡æœ‰æ•ˆæœçš„ã€‚</li>
<li>ç›®å‰ä¸æ”¯æŒ Sharding-JDBC çš„ä¸»é”®è‡ªå¢ã€‚â“å› ä¸º SQL æœªè§£æ<strong>è‡ªå¢ä¸»é”®</strong>ã€‚ä»ä»£ç ä¸Šçš„<code>TODO</code>åº”è¯¥ä¼šæ”¯æŒã€‚</li>
<li><code>HintManager.getInstance().setDatabaseShardingValue(åº“åˆ†ç‰‡å€¼)</code> è®¾ç½®çš„åº“åˆ†ç‰‡å€¼ä½¿ç”¨çš„æ˜¯  EQUALSï¼Œå› è€Œåˆ†åº“ç­–ç•¥è®¡ç®—å‡ºæ¥çš„åªæœ‰<strong>ä¸€ä¸ªåº“åˆ†ç‰‡</strong>ï¼Œå³ TableUnit åªæœ‰ä¸€ä¸ªï¼ŒSQLExecutionUnit åªæœ‰ä¸€ä¸ªã€‚</li>
</ul>
<hr>
<p>çœ‹çœ‹ DatabaseHintSQLRouter çš„å®ç°ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DatabaseHintRoutingEngine.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> RoutingResult <span class="title">route</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ä» Hint è·å¾— åˆ†ç‰‡é”®å€¼</span></div><div class="line">   Optional&lt;ShardingValue&lt;?&gt;&gt; shardingValue = HintManagerHolder.getDatabaseShardingValue(<span class="keyword">new</span> ShardingKey(HintManagerHolder.DB_TABLE_NAME, HintManagerHolder.DB_COLUMN_NAME));</div><div class="line">   Preconditions.checkState(shardingValue.isPresent());</div><div class="line">   log.debug(<span class="string">"Before database sharding only db:&#123;&#125; sharding values: &#123;&#125;"</span>, dataSourceRule.getDataSourceNames(), shardingValue.get());</div><div class="line">   <span class="comment">// è·¯ç”±ã€‚è¡¨åˆ†ç‰‡è§„åˆ™ä½¿ç”¨çš„æ˜¯ ShardingRule é‡Œçš„ã€‚å› ä¸ºæ²¡ SQL è§£æã€‚</span></div><div class="line">   Collection&lt;String&gt; routingDataSources = databaseShardingStrategy.doStaticSharding(sqlType, dataSourceRule.getDataSourceNames(), Collections.&lt;ShardingValue&lt;?&gt;&gt;singleton(shardingValue.get()));</div><div class="line">   Preconditions.checkState(!routingDataSources.isEmpty(), <span class="string">"no database route info"</span>);</div><div class="line">   log.debug(<span class="string">"After database sharding only result: &#123;&#125;"</span>, routingDataSources);</div><div class="line">   <span class="comment">// è·¯ç”±ç»“æœ</span></div><div class="line">   RoutingResult result = <span class="keyword">new</span> RoutingResult();</div><div class="line">   <span class="keyword">for</span> (String each : routingDataSources) &#123;</div><div class="line">       result.getTableUnits().getTableUnits().add(<span class="keyword">new</span> TableUnit(each, <span class="string">""</span>, <span class="string">""</span>));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><strong>åª</strong>è°ƒç”¨ <code>databaseShardingStrategy.doStaticSharding()</code> æ–¹æ³•è®¡ç®—<strong>åº“</strong>åˆ†ç‰‡ã€‚</li>
<li><code>new TableUnit(each, &quot;&quot;, &quot;&quot;)</code> çš„ <code>logicTableName</code>ï¼Œ<code>actualTableName</code> éƒ½æ˜¯ç©ºä¸²ï¼Œç›¸ä¿¡åŸå› ä½ å·²ç»çŸ¥é“ã€‚</li>
</ul>
<h1>6. ParsingSQLRouter</h1>
<p>ParsingSQLRouterï¼Œéœ€è¦è§£æçš„SQLè·¯ç”±å™¨ã€‚</p>
<p>ParsingSQLRouter ä½¿ç”¨ SQLParsingEngine <strong>è§£æSQL</strong>ã€‚å¯¹<strong>SQLè§£æ</strong>æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹çœ‹æ‹™ä½œ<a href="http://www.yunai.me/categories/Sharding-JDBC/?mp">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æã€‹</a>ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLStatement <span class="title">parse</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> <span class="keyword">int</span> parametersSize)</span> </span>&#123;</div><div class="line">   SQLParsingEngine parsingEngine = <span class="keyword">new</span> SQLParsingEngine(databaseType, logicSQL, shardingRule);</div><div class="line">   Context context = MetricsContext.start(<span class="string">"Parse SQL"</span>);</div><div class="line">   SQLStatement result = parsingEngine.parse();</div><div class="line">   <span class="keyword">if</span> (result <span class="keyword">instanceof</span> InsertStatement) &#123;</div><div class="line">       ((InsertStatement) result).appendGenerateKeyToken(shardingRule, parametersSize);</div><div class="line">   &#125;</div><div class="line">   MetricsContext.stop(context);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#appendGenerateKeyToken()</code> ä¼šåœ¨<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL æ”¹å†™ã€‹</a>åˆ†äº«</li>
</ul>
<hr>
<p>ParsingSQLRouter åœ¨è·¯ç”±æ—¶ï¼Œä¼šæ ¹æ®<strong>è¡¨æƒ…å†µ</strong>ä½¿ç”¨ SimpleRoutingEngine æˆ– CartesianRoutingEngine è¿›è¡Œè·¯ç”±ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> RoutingResult <span class="title">route</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   Collection&lt;String&gt; tableNames = sqlStatement.getTables().getTableNames();</div><div class="line">   RoutingEngine routingEngine;</div><div class="line">   <span class="keyword">if</span> (<span class="number">1</span> == tableNames.size() || shardingRule.isAllBindingTables(tableNames)) &#123;</div><div class="line">       routingEngine = <span class="keyword">new</span> SimpleRoutingEngine(shardingRule, parameters, tableNames.iterator().next(), sqlStatement);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="comment">// TODO å¯é…ç½®æ˜¯å¦æ‰§è¡Œç¬›å¡å°”ç§¯</span></div><div class="line">       routingEngine = <span class="keyword">new</span> ComplexRoutingEngine(shardingRule, parameters, tableNames, sqlStatement);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> routingEngine.route();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å½“åªè¿›è¡Œ<strong>ä¸€å¼ è¡¨</strong>æˆ–è€…<strong>å¤šè¡¨äº’ä¸ºBindingTableå…³ç³»</strong>æ—¶ï¼Œä½¿ç”¨ SimpleRoutingEngine ç®€å•è·¯ç”±å¼•æ“ã€‚<strong>å¤šè¡¨äº’ä¸ºBindingTableå…³ç³»</strong>æ—¶ï¼Œæ¯å¼ è¡¨çš„è·¯ç”±ç»“æœæ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥åªè¦è®¡ç®—ç¬¬ä¸€å¼ è¡¨çš„åˆ†ç‰‡å³å¯ã€‚</li>
<li><code>tableNames.iterator().next()</code> æ³¨æ„ä¸‹ï¼Œ<code>tableNames</code> å˜é‡æ˜¯ <code>new TreeMap&lt;&gt;(String.CASE_INSENSITIVE_ORDER)</code>ã€‚æ‰€ä»¥ <code>SELECT * FROM t_order o join t_order_item i ON o.order_id = i.order_id</code> å³ä½¿ <code>t_order_item</code> æ’åœ¨ <code>t_order</code> å‰é¢ï¼Œ<code>tableNames.iterator().next()</code> è¿”å›çš„æ˜¯ <code>t_order</code>ã€‚å½“ <code>t_order</code> å’Œ <code>t_order_item</code> ä¸º <strong>BindingTableå…³ç³»</strong> æ—¶ï¼Œè®¡ç®—çš„æ˜¯ <code>t_order</code> è·¯ç”±åˆ†ç‰‡ã€‚</li>
<li>BindingTableå…³ç³»åœ¨ ShardingRule çš„ <code>tableRules</code> é…ç½®ã€‚é…ç½®è¯¥å…³ç³» TableRule æœ‰å¦‚ä¸‹éœ€è¦éµå®ˆçš„è§„åˆ™ï¼š
<ul>
<li>åˆ†ç‰‡ç­–ç•¥ä¸ç®—æ³•ç›¸åŒ</li>
<li>æ•°æ®æºé…ç½®å¯¹è±¡ç›¸åŒ</li>
<li>çœŸå®è¡¨<strong>æ•°é‡</strong>ç›¸åŒ</li>
</ul>
</li>
</ul>
<p><strong>ä¸¾ä¸ªä¾‹å­</strong>ï¼š</p>
<ul>
<li>SQL ï¼š<code>SELECT * FROM t_order o join t_order_item i ON o.order_id = i.order_id</code></li>
<li>åˆ†åº“åˆ†è¡¨æƒ…å†µï¼š</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">multi_db_multi_table_01</div><div class="line">  â”œâ”€â”€ t_order_0                        â”œâ”€â”€ t_order_item_01</div><div class="line">  â””â”€â”€ t_order_1                        â”œâ”€â”€ t_order_item_02</div><div class="line">                                       â”œâ”€â”€ t_order_item_03</div><div class="line">                                       â”œâ”€â”€ t_order_item_04</div><div class="line">multi_db_multi_table_02</div><div class="line">  â”œâ”€â”€ t_order_0                        â”œâ”€â”€ t_order_item_01</div><div class="line">  â””â”€â”€ t_order_1                        â”œâ”€â”€ t_order_item_02</div><div class="line">                                       â”œâ”€â”€ t_order_item_03</div><div class="line">                                       â”œâ”€â”€ t_order_item_04</div></pre></td></tr></table></figure></p>
<p>æœ€ç»ˆæ‰§è¡Œçš„SQLå¦‚ä¸‹ï¼š</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order_item_01 i <span class="keyword">JOIN</span> t_order_01 o <span class="keyword">ON</span> o.order_id = i.order_id </div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order_item_01 i <span class="keyword">JOIN</span> t_order_01 o <span class="keyword">ON</span> o.order_id = i.order_id </div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order_item_02 i <span class="keyword">JOIN</span> t_order_02 o <span class="keyword">ON</span> o.order_id = i.order_id</div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order_item_02 i <span class="keyword">JOIN</span> t_order_02 o <span class="keyword">ON</span> o.order_id = i.order_id</div></pre></td></tr></table></figure></p>
<ul>
<li><code>t_order_item_03</code>ã€<code>t_order_item_04</code> æ— æ³•è¢«æŸ¥è¯¢åˆ°ã€‚</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹ <code>#isAllBindingTables()</code> å¦‚ä½•å®ç°<strong>å¤šè¡¨äº’ä¸ºBindingTableå…³ç³»</strong>ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingRule.java</span></div><div class="line"><span class="comment">// è°ƒç”¨é¡ºåº #isAllBindingTables()=&gt;#filterAllBindingTables()=&gt;#findBindingTableRule()=&gt;#findBindingTableRule()</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ¤æ–­é€»è¾‘è¡¨åç§°é›†åˆæ˜¯å¦å…¨éƒ¨å±äºBindingè¡¨.</div><div class="line">* <span class="doctag">@param</span> logicTables é€»è¾‘è¡¨åç§°é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAllBindingTables</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; logicTables)</span> </span>&#123;</div><div class="line">   Collection&lt;String&gt; bindingTables = filterAllBindingTables(logicTables);</div><div class="line">   <span class="keyword">return</span> !bindingTables.isEmpty() &amp;&amp; bindingTables.containsAll(logicTables);</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è¿‡æ»¤å‡ºæ‰€æœ‰çš„Bindingè¡¨åç§°.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">filterAllBindingTables</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; logicTables)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (logicTables.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   Optional&lt;BindingTableRule&gt; bindingTableRule = findBindingTableRule(logicTables);</div><div class="line">   <span class="keyword">if</span> (!bindingTableRule.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// äº¤é›†</span></div><div class="line">   Collection&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(bindingTableRule.get().getAllLogicTables());</div><div class="line">   result.retainAll(logicTables);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—åŒ…å«&lt;strong&gt;ä»»ä¸€&lt;/strong&gt;åœ¨é€»è¾‘è¡¨åç§°é›†åˆçš„bindingè¡¨é…ç½®çš„é€»è¾‘è¡¨åç§°é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Optional&lt;BindingTableRule&gt; <span class="title">findBindingTableRule</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; logicTables)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (String each : logicTables) &#123;</div><div class="line">       Optional&lt;BindingTableRule&gt; result = findBindingTableRule(each);</div><div class="line">       <span class="keyword">if</span> (result.isPresent()) &#123;</div><div class="line">           <span class="keyword">return</span> result;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> Optional.absent();</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* æ ¹æ®é€»è¾‘è¡¨åç§°è·å–bindingè¡¨é…ç½®çš„é€»è¾‘è¡¨åç§°é›†åˆ.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Optional&lt;BindingTableRule&gt; <span class="title">findBindingTableRule</span><span class="params">(<span class="keyword">final</span> String logicTable)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (BindingTableRule each : bindingTableRules) &#123;</div><div class="line">       <span class="keyword">if</span> (each.hasLogicTable(logicTable)) &#123;</div><div class="line">           <span class="keyword">return</span> Optional.of(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> Optional.absent();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>é€»è¾‘çœ‹èµ·æ¥æ¯”è¾ƒé•¿ï¼Œç›®çš„æ˜¯æ‰¾åˆ°ä¸€æ¡ BindingTableRule åŒ…å«<strong>æ‰€æœ‰</strong>é€»è¾‘è¡¨é›†åˆ</li>
<li>ä¸æ”¯æŒ<a href="https://zh.wikipedia.org/wiki/%E4%BC%A0%E9%80%92%E5%85%B3%E7%B3%BB" rel="external nofollow noopener noreferrer" target="_blank">ã€Šä¼ é€’å…³ç³»ã€‹</a>ï¼šé…ç½® BindingTableRule æ—¶ï¼Œ<strong>ç›¸åŒç»‘å®šå…³ç³»ä¸€å®šè¦é…ç½®åœ¨ä¸€æ¡</strong>ï¼Œå¿…é¡»æ˜¯ <code>[a, b, c]</code>ï¼Œè€Œä¸èƒ½æ˜¯ <code>[a, b], [b, c]</code>ã€‚</li>
</ul>
<h2>6.1 SimpleRoutingEngine</h2>
<p>SimpleRoutingEngineï¼Œç®€å•è·¯ç”±å¼•æ“ã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/07.png" alt=""></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SimpleRoutingEngine.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;String&gt; <span class="title">routeDataSources</span><span class="params">(<span class="keyword">final</span> TableRule tableRule)</span> </span>&#123;</div><div class="line">   DatabaseShardingStrategy strategy = shardingRule.getDatabaseShardingStrategy(tableRule);</div><div class="line">   List&lt;ShardingValue&lt;?&gt;&gt; shardingValues = HintManagerHolder.isUseShardingHint() ? getDatabaseShardingValuesFromHint(strategy.getShardingColumns())</div><div class="line">           : getShardingValues(strategy.getShardingColumns());</div><div class="line">   Collection&lt;String&gt; result = strategy.doStaticSharding(sqlStatement.getType(), tableRule.getActualDatasourceNames(), shardingValues);</div><div class="line">   Preconditions.checkState(!result.isEmpty(), <span class="string">"no database route info"</span>);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="keyword">private</span> List&lt;ShardingValue&lt;?&gt;&gt; getShardingValues(<span class="keyword">final</span> Collection&lt;String&gt; shardingColumns) &#123;</div><div class="line">   List&lt;ShardingValue&lt;?&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(shardingColumns.size());</div><div class="line">   <span class="keyword">for</span> (String each : shardingColumns) &#123;</div><div class="line">       Optional&lt;Condition&gt; condition = sqlStatement.getConditions().find(<span class="keyword">new</span> Column(each, logicTableName));</div><div class="line">       <span class="keyword">if</span> (condition.isPresent()) &#123;</div><div class="line">           result.add(condition.get().getShardingValue(parameters));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å¯ä»¥ä½¿ç”¨ HintManager è®¾ç½®<strong>åº“</strong>åˆ†ç‰‡å€¼è¿›è¡Œ<strong>å¼ºåˆ¶è·¯ç”±</strong>ã€‚</li>
<li><code>#getShardingValues()</code> æˆ‘ä»¬çœ‹åˆ°äº†<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹</a>åˆ†äº«çš„ Condition å¯¹è±¡ã€‚ä¹‹å‰æˆ‘ä»¬æåˆ°è¿‡<strong>Parser åŠç†è§£SQLçš„ç›®çš„ä¹‹ä¸€æ˜¯ï¼šæç‚¼åˆ†ç‰‡ä¸Šä¸‹æ–‡</strong>ï¼Œæ­¤å¤„å³æ˜¯è¯¥ç›®çš„çš„ä½“ç°ã€‚Condition é‡Œåªæ”¾<strong>æ˜ç¡®</strong>å½±å“è·¯ç”±çš„æ¡ä»¶ï¼Œä¾‹å¦‚ï¼š<code>order_id = 1</code>, <code>order_id IN (1, 2)</code>, <code>order_id BETWEEN (1, 3)</code>ï¼Œä¸æ”¾<strong>æ— æ³•è®¡ç®—</strong>çš„æ¡ä»¶ï¼Œä¾‹å¦‚ï¼š<code>o.order_id = i.order_id</code>ã€‚è¯¥æ–¹æ³•é‡Œï¼Œä½¿ç”¨<strong>åˆ†ç‰‡é”®</strong>ä» Condition æŸ¥æ‰¾ <strong>åˆ†ç‰‡å€¼</strong>ã€‚ğŸ™‚ æ˜¯ä¸æ˜¯å¯¹ Condition çš„è®¤è¯†æ›´åŠ æ¸…æ™°ä¸€ä¸¢ä¸¢è½ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SimpleRoutingEngine.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;String&gt; <span class="title">routeTables</span><span class="params">(<span class="keyword">final</span> TableRule tableRule, <span class="keyword">final</span> Collection&lt;String&gt; routedDataSources)</span> </span>&#123;</div><div class="line">   TableShardingStrategy strategy = shardingRule.getTableShardingStrategy(tableRule);</div><div class="line">   List&lt;ShardingValue&lt;?&gt;&gt; shardingValues = HintManagerHolder.isUseShardingHint() ? getTableShardingValuesFromHint(strategy.getShardingColumns())</div><div class="line">           : getShardingValues(strategy.getShardingColumns());</div><div class="line">   Collection&lt;String&gt; result = tableRule.isDynamic() ? strategy.doDynamicSharding(shardingValues)</div><div class="line">           : strategy.doStaticSharding(sqlStatement.getType(), tableRule.getActualTableNames(routedDataSources), shardingValues);</div><div class="line">   Preconditions.checkState(!result.isEmpty(), <span class="string">"no table route info"</span>);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å¯ä»¥ä½¿ç”¨ HintManager è®¾ç½®<strong>è¡¨</strong>åˆ†ç‰‡å€¼è¿›è¡Œ<strong>å¼ºåˆ¶è·¯ç”±</strong>ã€‚</li>
<li>æ ¹æ® <code>dynamic</code> å±æ€§æ¥åˆ¤æ–­è°ƒç”¨ <code>#doDynamicSharding()</code> è¿˜æ˜¯ <code>#doStaticSharding()</code> è®¡ç®—åˆ†ç‰‡ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SimpleRoutingEngine.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> RoutingResult <span class="title">generateRoutingResult</span><span class="params">(<span class="keyword">final</span> TableRule tableRule, <span class="keyword">final</span> Collection&lt;String&gt; routedDataSources, <span class="keyword">final</span> Collection&lt;String&gt; routedTables)</span> </span>&#123;</div><div class="line">   RoutingResult result = <span class="keyword">new</span> RoutingResult();</div><div class="line">   <span class="keyword">for</span> (DataNode each : tableRule.getActualDataNodes(routedDataSources, routedTables)) &#123;</div><div class="line">       result.getTableUnits().getTableUnits().add(<span class="keyword">new</span> TableUnit(each.getDataSourceName(), logicTableName, each.getTableName()));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// TableRule.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ ¹æ®æ•°æ®æºåç§°è¿‡æ»¤è·å–çœŸå®æ•°æ®å•å…ƒ.</div><div class="line">* <span class="doctag">@param</span> targetDataSources æ•°æ®æºåç§°é›†åˆ</div><div class="line">* <span class="doctag">@param</span> targetTables çœŸå®è¡¨åç§°é›†åˆ</div><div class="line">* <span class="doctag">@return</span> çœŸå®æ•°æ®å•å…ƒ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;DataNode&gt; <span class="title">getActualDataNodes</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; targetDataSources, <span class="keyword">final</span> Collection&lt;String&gt; targetTables)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> dynamic ? getDynamicDataNodes(targetDataSources, targetTables) : getStaticDataNodes(targetDataSources, targetTables);</div><div class="line">&#125;  </div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;DataNode&gt; <span class="title">getDynamicDataNodes</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; targetDataSources, <span class="keyword">final</span> Collection&lt;String&gt; targetTables)</span> </span>&#123;</div><div class="line">   Collection&lt;DataNode&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(targetDataSources.size() * targetTables.size());</div><div class="line">   <span class="keyword">for</span> (String targetDataSource : targetDataSources) &#123;</div><div class="line">       <span class="keyword">for</span> (String targetTable : targetTables) &#123;</div><div class="line">           result.add(<span class="keyword">new</span> DataNode(targetDataSource, targetTable));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125; </div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;DataNode&gt; <span class="title">getStaticDataNodes</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; targetDataSources, <span class="keyword">final</span> Collection&lt;String&gt; targetTables)</span> </span>&#123;</div><div class="line">   Collection&lt;DataNode&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(actualTables.size());</div><div class="line">   <span class="keyword">for</span> (DataNode each : actualTables) &#123;</div><div class="line">       <span class="keyword">if</span> (targetDataSources.contains(each.getDataSourceName()) &amp;&amp; targetTables.contains(each.getTableName())) &#123;</div><div class="line">           result.add(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>åœ¨ SimpleRoutingEngine åªç”Ÿæˆäº†å½“å‰è¡¨çš„ TableUnitsã€‚å¦‚æœå­˜åœ¨<strong>ä¸å…¶äº’ä¸ºBindingTableå…³ç³»</strong>çš„è¡¨çš„ TableUnits æ€ä¹ˆè·å¾—ï¼Ÿä½ å¯ä»¥æƒ³æƒ³å™¢ï¼Œå½“ç„¶åœ¨åæ–‡<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL æ”¹å†™ã€‹</a>ä¹Ÿä¼šç»™å‡ºç­”æ¡ˆï¼Œçœ‹çœ‹å’Œä½ æƒ³çš„æ˜¯å¦ä¸€æ ·ã€‚</li>
</ul>
<h2>6.2 ComplexRoutingEngine</h2>
<p>ComplexRoutingEngineï¼Œæ··åˆå¤šåº“è¡¨è·¯ç”±å¼•æ“ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ComplexRoutingEngine.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> RoutingResult <span class="title">route</span><span class="params">()</span> </span>&#123;</div><div class="line">   Collection&lt;RoutingResult&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(logicTables.size());</div><div class="line">   Collection&lt;String&gt; bindingTableNames = <span class="keyword">new</span> TreeSet&lt;&gt;(String.CASE_INSENSITIVE_ORDER);</div><div class="line">   <span class="comment">// è®¡ç®—æ¯ä¸ªé€»è¾‘è¡¨çš„ç®€å•è·¯ç”±åˆ†ç‰‡</span></div><div class="line">   <span class="keyword">for</span> (String each : logicTables) &#123;</div><div class="line">       Optional&lt;TableRule&gt; tableRule = shardingRule.tryFindTableRule(each);</div><div class="line">       <span class="keyword">if</span> (tableRule.isPresent()) &#123;</div><div class="line">           <span class="keyword">if</span> (!bindingTableNames.contains(each)) &#123;</div><div class="line">               result.add(<span class="keyword">new</span> SimpleRoutingEngine(shardingRule, parameters, tableRule.get().getLogicTable(), sqlStatement).route());</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// äº’ä¸º BindingTable å…³ç³»çš„è¡¨åŠ åˆ° bindingTableNames é‡Œï¼Œä¸é‡å¤è®¡ç®—åˆ†ç‰‡</span></div><div class="line">           Optional&lt;BindingTableRule&gt; bindingTableRule = shardingRule.findBindingTableRule(each);</div><div class="line">           <span class="keyword">if</span> (bindingTableRule.isPresent()) &#123;</div><div class="line">               bindingTableNames.addAll(Lists.transform(bindingTableRule.get().getTableRules(), <span class="keyword">new</span> Function&lt;TableRule, String&gt;() &#123;</div><div class="line">                   </div><div class="line">                   <span class="meta">@Override</span></div><div class="line">                   <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(<span class="keyword">final</span> TableRule input)</span> </span>&#123;</div><div class="line">                       <span class="keyword">return</span> input.getLogicTable();</div><div class="line">                   &#125;</div><div class="line">               &#125;));</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   log.trace(<span class="string">"mixed tables sharding result: &#123;&#125;"</span>, result);</div><div class="line">   <span class="keyword">if</span> (result.isEmpty()) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ShardingJdbcException(<span class="string">"Cannot find table rule and default data source with logic tables: '%s'"</span>, logicTables);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// é˜²å¾¡æ€§ç¼–ç¨‹ã€‚shardingRule#isAllBindingTables() å·²ç»è¿‡æ»¤äº†è¿™ä¸ªæƒ…å†µã€‚</span></div><div class="line">   <span class="keyword">if</span> (<span class="number">1</span> == result.size()) &#123;</div><div class="line">       <span class="keyword">return</span> result.iterator().next();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// äº¤ç»™ CartesianRoutingEngine å½¢æˆç¬›å¡å°”ç§¯ç»“æœ</span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> CartesianRoutingEngine(result).route();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ComplexRoutingEngine è®¡ç®—æ¯ä¸ªé€»è¾‘è¡¨çš„ç®€å•è·¯ç”±åˆ†ç‰‡ï¼Œè·¯ç”±ç»“æœäº¤ç»™ CartesianRoutingEngine <strong>ç»§ç»­</strong>è·¯ç”±å½¢æˆç¬›å¡å°”ç§¯ç»“æœã€‚</li>
</ul>
<p><img src="http://www.yunai.me//images/Sharding-JDBC/2017_08_06/08.png" alt=""></p>
<ul>
<li>ç”±äºç›®å‰ ComplexRoutingEngine è·¯ç”±å‰å·²ç»åˆ¤æ–­<strong>å…¨éƒ¨è¡¨äº’ä¸º BindingTable å…³ç³»</strong>ï¼Œå› è€Œä¸ä¼šå‡ºç° <code>result.size == 1</code>ï¼Œå±äºé˜²å¾¡æ€§ç¼–ç¨‹ã€‚</li>
<li><strong>éƒ¨åˆ†è¡¨äº’ä¸º BindingTable å…³ç³»</strong>æ—¶ï¼ŒComplexRoutingEngine ä¸é‡å¤è®¡ç®—åˆ†ç‰‡ã€‚</li>
</ul>
<h2>6.3 CartesianRoutingEngine</h2>
<p>CartesianRoutingEngineï¼Œç¬›å¡å°”ç§¯çš„åº“è¡¨è·¯ç”±ã€‚</p>
<p>å®ç°é€»è¾‘ä¸Š<strong>ç›¸å¯¹</strong>å¤æ‚ï¼Œè¯·ä¿æŒè€å¿ƒå“Ÿï¼ŒğŸ˜ˆ å…¶å®ç›®çš„å°±æ˜¯å®ç°<strong>è¿è¿çœ‹</strong>çš„æ•ˆæœï¼š</p>
<ul>
<li>RoutingResult[0] <code>x</code> RoutingResult[1] â€¦â€¦ <code>x</code> RoutingResult[n- 1] <code>x</code> RoutingResult[n]</li>
<li><strong>åŒåº“</strong> æ‰å¯ä»¥è¿›è¡Œç¬›å¡å°”ç§¯</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CartesianRoutingEngine.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> CartesianRoutingResult <span class="title">route</span><span class="params">()</span> </span>&#123;</div><div class="line">   CartesianRoutingResult result = <span class="keyword">new</span> CartesianRoutingResult();</div><div class="line">   <span class="keyword">for</span> (Entry&lt;String, Set&lt;String&gt;&gt; entry : getDataSourceLogicTablesMap().entrySet()) &#123; <span class="comment">// Entry&lt;æ•°æ®æºï¼ˆåº“ï¼‰, Set&lt;é€»è¾‘è¡¨&gt;&gt; entry</span></div><div class="line">       <span class="comment">// è·å¾—å½“å‰æ•°æ®æºï¼ˆåº“ï¼‰çš„ è·¯ç”±è¡¨å•å…ƒåˆ†ç»„</span></div><div class="line">       List&lt;Set&lt;String&gt;&gt; actualTableGroups = getActualTableGroups(entry.getKey(), entry.getValue()); <span class="comment">// List&lt;Set&lt;çœŸå®è¡¨&gt;&gt;</span></div><div class="line">       List&lt;Set&lt;TableUnit&gt;&gt; tableUnitGroups = toTableUnitGroups(entry.getKey(), actualTableGroups);</div><div class="line">       <span class="comment">// ç¬›å¡å°”ç§¯ï¼Œå¹¶åˆå¹¶ç»“æœ</span></div><div class="line">       result.merge(entry.getKey(), getCartesianTableReferences(Sets.cartesianProduct(tableUnitGroups)));</div><div class="line">   &#125;</div><div class="line">   log.trace(<span class="string">"cartesian tables sharding result: &#123;&#125;"</span>, result);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬ä¸€æ­¥ï¼Œè·å¾—<strong>åŒåº“</strong>å¯¹åº”çš„<strong>é€»è¾‘è¡¨</strong>é›†åˆï¼Œå³ <strong>Entry&lt;æ•°æ®æºï¼ˆåº“ï¼‰, Set&lt;é€»è¾‘è¡¨&gt;&gt; entry</strong>ã€‚</li>
<li>ç¬¬äºŒæ­¥ï¼Œéå†<strong>æ•°æ®æºï¼ˆåº“ï¼‰</strong>ï¼Œè·å¾—å½“å‰<strong>æ•°æ®æºï¼ˆåº“ï¼‰<strong>çš„</strong>è·¯ç”±è¡¨å•å…ƒåˆ†ç»„</strong>ã€‚</li>
<li>ç¬¬ä¸‰æ­¥ï¼Œå¯¹<strong>è·¯ç”±è¡¨å•å…ƒåˆ†ç»„</strong>è¿›è¡Œ<strong>ç¬›å¡å°”ç§¯</strong>ï¼Œå¹¶åˆå¹¶åˆ°è·¯ç”±ç»“æœã€‚</li>
</ul>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬ä¸€èµ·é€æ­¥çœ‹çœ‹ä»£ç å®ç°ã€‚</p>
<ul>
<li>SQL ï¼š<code>SELECT * FROM t_order o join t_order_item i ON o.order_id = i.order_id</code></li>
<li>åˆ†åº“åˆ†è¡¨æƒ…å†µï¼š</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">multi_db_multi_table_01</div><div class="line">  â”œâ”€â”€ t_order_0                        â”œâ”€â”€ t_order_item_01</div><div class="line">  â””â”€â”€ t_order_1                        â”œâ”€â”€ t_order_item_02</div><div class="line">multi_db_multi_table_02</div><div class="line">  â”œâ”€â”€ t_order_0                        â”œâ”€â”€ t_order_item_01</div><div class="line">  â””â”€â”€ t_order_1                        â”œâ”€â”€ t_order_item_02</div></pre></td></tr></table></figure></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ç¬¬ä¸€æ­¥</span></div><div class="line"><span class="comment">// CartesianRoutingEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—åŒåº“å¯¹åº”çš„é€»è¾‘è¡¨é›†åˆ</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> Map&lt;String, Set&lt;String&gt;&gt; getDataSourceLogicTablesMap() &#123;</div><div class="line">   Collection&lt;String&gt; intersectionDataSources = getIntersectionDataSources();</div><div class="line">   Map&lt;String, Set&lt;String&gt;&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;(routingResults.size());</div><div class="line">   <span class="comment">// è·å¾—åŒåº“å¯¹åº”çš„é€»è¾‘è¡¨é›†åˆ</span></div><div class="line">   <span class="keyword">for</span> (RoutingResult each : routingResults) &#123;</div><div class="line">       <span class="keyword">for</span> (Entry&lt;String, Set&lt;String&gt;&gt; entry : each.getTableUnits().getDataSourceLogicTablesMap(intersectionDataSources).entrySet()) &#123; <span class="comment">// è¿‡æ»¤æ‰ä¸åœ¨æ•°æ®æºï¼ˆåº“ï¼‰äº¤é›†çš„é€»è¾‘è¡¨</span></div><div class="line">           <span class="keyword">if</span> (result.containsKey(entry.getKey())) &#123;</div><div class="line">               result.get(entry.getKey()).addAll(entry.getValue());</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               result.put(entry.getKey(), entry.getValue());</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—æ‰€æœ‰è·¯ç”±ç»“æœé‡Œçš„æ•°æ®æºï¼ˆåº“ï¼‰äº¤é›†</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;String&gt; <span class="title">getIntersectionDataSources</span><span class="params">()</span> </span>&#123;</div><div class="line">   Collection&lt;String&gt; result = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (RoutingResult each : routingResults) &#123;</div><div class="line">       <span class="keyword">if</span> (result.isEmpty()) &#123;</div><div class="line">           result.addAll(each.getTableUnits().getDataSourceNames());</div><div class="line">       &#125;</div><div class="line">       result.retainAll(each.getTableUnits().getDataSourceNames()); <span class="comment">// äº¤é›†</span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#getDataSourceLogicTablesMap()</code> è¿”å›å¦‚å›¾ï¼š<img src="http://www.yunai.me//images/Sharding-JDBC/2017_08_06/09.png" alt=""></li>
</ul>
<hr>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ç¬¬äºŒæ­¥</span></div><div class="line"><span class="comment">// CartesianRoutingEngine.java</span></div><div class="line"><span class="keyword">private</span> List&lt;Set&lt;String&gt;&gt; getActualTableGroups(<span class="keyword">final</span> String dataSource, <span class="keyword">final</span> Set&lt;String&gt; logicTables) &#123;</div><div class="line">   List&lt;Set&lt;String&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(logicTables.size());</div><div class="line">   <span class="keyword">for</span> (RoutingResult each : routingResults) &#123;</div><div class="line">       result.addAll(each.getTableUnits().getActualTableNameGroups(dataSource, logicTables));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="keyword">private</span> List&lt;Set&lt;TableUnit&gt;&gt; toTableUnitGroups(<span class="keyword">final</span> String dataSource, <span class="keyword">final</span> List&lt;Set&lt;String&gt;&gt; actualTableGroups) &#123;</div><div class="line">   List&lt;Set&lt;TableUnit&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(actualTableGroups.size());</div><div class="line">   <span class="keyword">for</span> (Set&lt;String&gt; each : actualTableGroups) &#123;</div><div class="line">       result.add(<span class="keyword">new</span> HashSet&lt;&gt;(Lists.transform(<span class="keyword">new</span> ArrayList&lt;&gt;(each), <span class="keyword">new</span> Function&lt;String, TableUnit&gt;() &#123;</div><div class="line">    </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> TableUnit <span class="title">apply</span><span class="params">(<span class="keyword">final</span> String input)</span> </span>&#123;</div><div class="line">               <span class="keyword">return</span> findTableUnit(dataSource, input);</div><div class="line">           &#125;</div><div class="line">       &#125;)));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#getActualTableGroups()</code> è¿”å›å¦‚å›¾ï¼š<img src="http://www.yunai.me//images/Sharding-JDBC/2017_08_06/10.png" alt=""></li>
<li><code>#toTableUnitGroups()</code> è¿”å›å¦‚å›¾ï¼š<img src="http://www.yunai.me//images/Sharding-JDBC/2017_08_06/11.png" alt=""></li>
</ul>
<hr>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CartesianRoutingEngine.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> List&lt;CartesianTableReference&gt; <span class="title">getCartesianTableReferences</span><span class="params">(<span class="keyword">final</span> Set&lt;List&lt;TableUnit&gt;&gt; cartesianTableUnitGroups)</span> </span>&#123;</div><div class="line">   List&lt;CartesianTableReference&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(cartesianTableUnitGroups.size());</div><div class="line">   <span class="keyword">for</span> (List&lt;TableUnit&gt; each : cartesianTableUnitGroups) &#123;</div><div class="line">       result.add(<span class="keyword">new</span> CartesianTableReference(each));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CartesianRoutingResult.java</span></div><div class="line"><span class="meta">@Getter</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;CartesianDataSource&gt; routingDataSources = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">final</span> String dataSource, <span class="keyword">final</span> Collection&lt;CartesianTableReference&gt; routingTableReferences)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (CartesianTableReference each : routingTableReferences) &#123;</div><div class="line">       merge(dataSource, each);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">final</span> String dataSource, <span class="keyword">final</span> CartesianTableReference routingTableReference)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (CartesianDataSource each : routingDataSources) &#123;</div><div class="line">       <span class="keyword">if</span> (each.getDataSource().equalsIgnoreCase(dataSource)) &#123;</div><div class="line">           each.getRoutingTableReferences().add(routingTableReference);</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   routingDataSources.add(<span class="keyword">new</span> CartesianDataSource(dataSource, routingTableReference));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>
<p><code>Sets.cartesianProduct(tableUnitGroups)</code> è¿”å›å¦‚å›¾ï¼ˆGuava å·¥å…·åº“çœŸå¼ºå¤§ï¼‰ï¼š<img src="http://www.yunai.me//images/Sharding-JDBC/2017_08_06/12.png" alt=""></p>
</li>
<li>
<p><code>#getCartesianTableReferences()</code> è¿”å›å¦‚å›¾ï¼š<img src="http://www.yunai.me//images/Sharding-JDBC/2017_08_06/13.png" alt=""></p>
<p>CartesianTableReferenceï¼Œç¬›å¡å°”ç§¯è¡¨<strong>è·¯ç”±ç»„</strong>ï¼ŒåŒ…å«<strong>å¤šæ¡</strong> TableUnitï¼Œå³ TableUnit[0] <code>x</code> TableUnit[1] â€¦â€¦ <code>x</code> TableUnit[n]ã€‚ä¾‹å¦‚å›¾ä¸­ï¼š<code>t_order_01 x t_order_item_02</code>ï¼Œæœ€ç»ˆè½¬æ¢æˆ SQL ä¸º <code>SELECT * FROM t_order_01 o join t_order_item_02 i ON o.order_id = i.order_id</code>ã€‚</p>
</li>
<li>
<p><code>#merge()</code> åˆå¹¶ç¬›å¡å°”ç§¯è·¯ç”±ç»“æœã€‚CartesianRoutingResult åŒ…å«å¤šä¸ª CartesianDataSourceï¼Œå› æ­¤éœ€è¦å°† CartesianTableReference åˆå¹¶ï¼ˆæ·»åŠ ï¼‰åˆ°å¯¹åº”çš„ CartesianDataSourceã€‚å½“ç„¶ï¼Œç›®å‰åœ¨å®ç°æ—¶å·²ç»æ˜¯æŒ‰ç…§**æ•°æ®æºï¼ˆåº“ï¼‰**ç”Ÿæˆå¯¹åº”çš„ CartesianTableReferenceã€‚</p>
</li>
</ul>
<h2>6.4 ParsingSQLRouter ä¸»#route()</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLRouteResult <span class="title">route</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   <span class="keyword">final</span> Context context = MetricsContext.start(<span class="string">"Route SQL"</span>);</div><div class="line">   SQLRouteResult result = <span class="keyword">new</span> SQLRouteResult(sqlStatement);</div><div class="line">   <span class="comment">// å¤„ç† æ’å…¥SQL ä¸»é”®å­—æ®µ</span></div><div class="line">   <span class="keyword">if</span> (sqlStatement <span class="keyword">instanceof</span> InsertStatement &amp;&amp; <span class="keyword">null</span> != ((InsertStatement) sqlStatement).getGeneratedKey()) &#123;</div><div class="line">       processGeneratedKey(parameters, (InsertStatement) sqlStatement, result);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ğŸ’ğŸ’ğŸ’ è·¯ç”± ğŸ’ğŸ’ğŸ’</span></div><div class="line">   RoutingResult routingResult = route(parameters, sqlStatement);</div><div class="line">   <span class="comment">// SQLé‡å†™å¼•æ“</span></div><div class="line">   SQLRewriteEngine rewriteEngine = <span class="keyword">new</span> SQLRewriteEngine(shardingRule, logicSQL, sqlStatement);</div><div class="line">   <span class="keyword">boolean</span> isSingleRouting = routingResult.isSingleRouting();</div><div class="line">   <span class="comment">// å¤„ç†åˆ†é¡µ</span></div><div class="line">   <span class="keyword">if</span> (sqlStatement <span class="keyword">instanceof</span> SelectStatement &amp;&amp; <span class="keyword">null</span> != ((SelectStatement) sqlStatement).getLimit()) &#123;</div><div class="line">       processLimit(parameters, (SelectStatement) sqlStatement, isSingleRouting);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// SQL é‡å†™</span></div><div class="line">   SQLBuilder sqlBuilder = rewriteEngine.rewrite(!isSingleRouting);</div><div class="line">   <span class="comment">// ç”Ÿæˆ ExecutionUnit</span></div><div class="line">   <span class="keyword">if</span> (routingResult <span class="keyword">instanceof</span> CartesianRoutingResult) &#123;</div><div class="line">       <span class="keyword">for</span> (CartesianDataSource cartesianDataSource : ((CartesianRoutingResult) routingResult).getRoutingDataSources()) &#123;</div><div class="line">           <span class="keyword">for</span> (CartesianTableReference cartesianTableReference : cartesianDataSource.getRoutingTableReferences()) &#123;</div><div class="line">               result.getExecutionUnits().add(<span class="keyword">new</span> SQLExecutionUnit(cartesianDataSource.getDataSource(), rewriteEngine.generateSQL(cartesianTableReference, sqlBuilder))); <span class="comment">// ç”Ÿæˆ SQL</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">for</span> (TableUnit each : routingResult.getTableUnits().getTableUnits()) &#123;</div><div class="line">           result.getExecutionUnits().add(<span class="keyword">new</span> SQLExecutionUnit(each.getDataSourceName(), rewriteEngine.generateSQL(each, sqlBuilder))); <span class="comment">// ç”Ÿæˆ SQL</span></div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   MetricsContext.stop(context);</div><div class="line">   <span class="comment">// æ‰“å° SQL</span></div><div class="line">   <span class="keyword">if</span> (showSQL) &#123;</div><div class="line">       SQLLogger.logSQL(logicSQL, sqlStatement, result.getExecutionUnits(), parameters);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>RoutingResult routingResult = route(parameters, sqlStatement);</code> <strong>è°ƒç”¨</strong>çš„å°±æ˜¯ä¸Šæ–‡åˆ†æçš„ SimpleRoutingEngineã€ComplexRoutingEngineã€CartesianRoutingEngine çš„ <code>#route()</code> æ–¹æ³•ã€‚</li>
<li><code>#processGeneratedKey()</code>ã€<code>#processLimit()</code>ã€<code>#rewrite()</code>ã€<code>#generateSQL()</code> ç­‰ä¼šæ”¾åœ¨<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL æ”¹å†™ã€‹</a> åˆ†äº«ã€‚</li>
</ul>
<h1>666. å½©è›‹</h1>
<p>ç¯‡å¹…æœ‰äº›é•¿ï¼Œå¸Œæœ›èƒ½è®©å¤§å®¶å¯¹<strong>è·¯ç”±</strong>æœ‰æ¯”è¾ƒå®Œæ•´çš„è®¤è¯†ã€‚<br>
å¦‚æœå†…å®¹æœ‰é”™è¯¯ï¼Œçƒ¦è¯·æ‚¨æŒ‡æ­£ï¼Œæˆ‘ä¼š<strong>è®¤çœŸ</strong>ä¿®æ”¹ã€‚<br>
å¦‚æœè¡¨è¿°ä¸æ¸…æ™°ï¼Œä¸å¤ªç†è§£çš„ï¼Œæ¬¢è¿åŠ æˆ‘å¾®ä¿¡ï¼ˆwangwenbin-serverï¼‰ä¸€èµ·æ¢è®¨ã€‚</p>
<p>è°¢è°¢ä½ æŠ€æœ¯è¿™ä¹ˆå¥½ï¼Œè¿˜<strong>è€å¿ƒ</strong>çœ‹å®Œäº†æœ¬æ–‡ã€‚</p>
<p>å¼ºåˆ¶è·¯ç”± HintManager è®²çš„ç›¸å¯¹ç•¥è¿‡ï¼Œå¯ä»¥çœ‹å¦‚ä¸‹å†…å®¹è¿›ä¸€æ­¥äº†è§£ï¼š</p>
<ol>
<li><a href="http://dangdangdotcom.github.io/sharding-jdbc/02-guide/hint-sharding-value/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£-å¼ºåˆ¶è·¯ç”±ã€‹</a></li>
<li><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/9354031743b63e44cbded5618980ae71a15f0260/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/api/HintManager.java#L41" rel="external nofollow noopener noreferrer" target="_blank">HintManager.java æºç </a></li>
</ol>
<p>åšç€è„¸çš®ï¼Œé“å‹ï¼Œè¾›è‹¦<strong>åˆ†äº«æœ‹å‹åœˆ</strong>å¯å¥½ï¼Ÿï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;o
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±ï¼ˆä¸€ï¼‰ä¹‹åˆ†åº“åˆ†è¡¨é…ç½®</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-route-1/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-route-1/</id>
    <published>2017-08-03T16:00:00.000Z</published>
    <updated>2017-08-10T17:25:42.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Sharding-JDBC 1.5.0 æ­£å¼ç‰ˆ</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. TableRule</a>
<ul>
<li><a href="#">2.1 logicTable</a></li>
<li><a href="#">2.2 æ•°æ®å•å…ƒ</a>
<ul>
<li><a href="#">2.2.1 DataNode</a></li>
<li><a href="#">2.2.2 DynamicDataNode</a></li>
</ul>
</li>
<li><a href="#">2.3 åˆ†åº“/åˆ†è¡¨ç­–ç•¥</a></li>
<li><a href="#">2.4 ä¸»é”®ç”Ÿæˆ</a></li>
</ul>
</li>
<li><a href="#">3. ShardingRule</a>
<ul>
<li><a href="#">3.1 dataSourceRule</a></li>
<li><a href="#">3.2 tableRules</a></li>
<li><a href="#">3.3 bindingTableRules</a></li>
</ul>
</li>
<li><a href="#">4. ShardingStrategy</a></li>
<li><a href="#">5. ShardingAlgorithm</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>ğŸ˜†<a href="http://www.yunai.me/categories/Sharding-JDBC/?self">ã€ŠSQL è§£æã€‹</a> å·²ç»å‘Šäºæ®µè½ï¼Œæˆ‘ä»¬è¦å¼€å§‹æ–°çš„æ—…ç¨‹ï¼š<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL è·¯ç”±ã€‹</a>ã€‚ç›¸æ¯”<strong>SQLè§£æ</strong>ï¼Œè·¯ç”±ä¼šå®¹æ˜“ç†è§£å¾ˆå¤šï¼Œéª—äººæ˜¯å°ğŸ·ã€‚æ•´ä¸ªç³»åˆ—é¢„è®¡ä¼šæ‹†åˆ†æˆ<strong>ä¸‰å°ç¯‡</strong>æ–‡ç« ï¼š</p>
<ol>
<li>ã€Šåˆ†åº“åˆ†è¡¨é…ç½®ã€‹</li>
<li>ã€Šåˆ†è¡¨åˆ†åº“è·¯ç”±ã€‹</li>
<li>ã€ŠSpringä¸YAMLé…ç½®ã€‹</li>
</ol>
<p>ç¬¬ä¸€ã€äºŒç¯‡ä¼šåœ¨<strong>è¿‘æœŸ</strong>æ›´æ–°ã€‚ç¬¬ä¸‰ç¯‡ä¼šåœ¨<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL æ”¹å†™ã€‹</a>ã€<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL æ‰§è¡Œã€‹</a>å®Œæˆåè¿›è¡Œæ›´æ–°ã€‚ğŸ˜ˆæ”¹å†™å’Œæ‰§è¡Œç›¸å¯¹æœ‰è¶£ã€‚</p>
<p>ğŸ‘¼é“å‹ï¼Œæ‚¨çœ‹ï¼Œé€—æ¯”åšä¸»**â€œå¾ˆæœ‰è§„åˆ’â€**ï¼Œæ˜¯å…³æ³¨å…¬ä¼—å·ä¸€æ³¢<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</a>è¿˜æ˜¯åˆ†äº«æœ‹å‹åœˆã€‚</p>
<hr>
<p>é˜…è¯»æœ¬æ–‡ä¹‹å‰ï¼Œå»ºè®®å·²ç»è¯»è¿‡<strong>å®˜æ–¹</strong>ç›¸å…³æ–‡ç« ï¼š</p>
<ul>
<li><a href="http://dangdangdotcom.github.io/sharding-jdbc/02-guide/concepts/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSharding-JDBC æ ¸å¿ƒæ¦‚å¿µã€‹</a></li>
<li><a href="http://dangdangdotcom.github.io/sharding-jdbc/02-guide/sharding/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSharding-JDBC åˆ†è¡¨åˆ†åº“ã€‹</a></li>
</ul>
<p>åˆ†è¡¨åˆ†åº“é…ç½®ä¼šæ¶‰åŠå¦‚ä¸‹ç±»ï¼š</p>
<ul>
<li>TableRule è¡¨è§„åˆ™é…ç½®å¯¹è±¡</li>
<li>ShardingRule åˆ†åº“åˆ†è¡¨è§„åˆ™é…ç½®å¯¹è±¡</li>
<li>ShardingStrategy åˆ†ç‰‡ç­–ç•¥</li>
<li>ShardingAlgorithm åˆ†ç‰‡ç®—æ³•</li>
</ul>
<p>æˆ‘ä»¬æ¥ä¸€èµ·é€ä¸ªç±»å¾€ä¸‹çœ‹ã€‚</p>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>
ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1>2. TableRule</h1>
<p>TableRuleï¼Œè¡¨è§„åˆ™é…ç½®å¯¹è±¡ï¼Œå†…åµŒ TableRuleBuilder å¯¹è±¡è¿›è¡Œåˆ›å»ºã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_04/01.png" alt=""></p>
<h2>2.1 logicTable</h2>
<blockquote>
<p>æ•°æ®åˆ†ç‰‡çš„<strong>é€»è¾‘è¡¨</strong>ï¼Œå¯¹äºæ°´å¹³æ‹†åˆ†çš„æ•°æ®åº“(è¡¨)ï¼ŒåŒä¸€ç±»è¡¨çš„æ€»ç§°ã€‚<br>
ä¾‹ï¼šè®¢å•æ•°æ®æ ¹æ®ä¸»é”®å°¾æ•°æ‹†åˆ†ä¸º10å¼ è¡¨,åˆ†åˆ«æ˜¯t_order_0åˆ°t_order_9ï¼Œä»–ä»¬çš„é€»è¾‘è¡¨åä¸ºt_orderã€‚</p>
</blockquote>
<h2>2.2 æ•°æ®å•å…ƒ</h2>
<p>Sharding-JDBC æœ‰ä¸¤ç§ç±»å‹<strong>æ•°æ®å•å…ƒ</strong>ï¼š</p>
<ul>
<li>DataNode ï¼š<strong>é™æ€</strong>åˆ†åº“åˆ†è¡¨æ•°æ®å•å…ƒ</li>
</ul>
<blockquote>
<p>æ•°æ®åˆ†ç‰‡çš„æœ€å°å•å…ƒï¼Œç”±æ•°æ®æºåç§°å’Œæ•°æ®è¡¨ç»„æˆã€‚<br>
ä¾‹ï¼šds_1.t_order_0ã€‚é…ç½®æ—¶é»˜è®¤å„ä¸ªåˆ†ç‰‡æ•°æ®åº“çš„è¡¨ç»“æ„å‡ç›¸åŒï¼Œç›´æ¥é…ç½®é€»è¾‘è¡¨å’ŒçœŸå®è¡¨å¯¹åº”å…³ç³»å³å¯ã€‚<br>
å¦‚æœå„æ•°æ®åº“çš„è¡¨ç»“æœä¸åŒï¼Œå¯ä½¿ç”¨ds.actual_tableé…ç½®ã€‚</p>
</blockquote>
<ul>
<li>DynamicDataNode ï¼š<strong>åŠ¨æ€</strong>è¡¨çš„åˆ†åº“åˆ†è¡¨æ•°æ®å•å…ƒ</li>
</ul>
<blockquote>
<p>é€»è¾‘è¡¨å’ŒçœŸå®è¡¨ä¸ä¸€å®šéœ€è¦åœ¨é…ç½®è§„åˆ™ä¸­é™æ€é…ç½®ã€‚<br>
æ¯”å¦‚æŒ‰ç…§æ—¥æœŸåˆ†ç‰‡çš„åœºæ™¯ï¼ŒçœŸå®è¡¨çš„åç§°éšç€æ—¶é—´çš„æ¨ç§»ä¼šäº§ç”Ÿå˜åŒ–ã€‚<br>
æ­¤ç±»éœ€æ±‚Sharding-JDBCæ˜¯æ”¯æŒçš„ï¼Œä¸è¿‡ç›®å‰é…ç½®å¹¶ä¸å‹å¥½ï¼Œä¼šåœ¨æ–°ç‰ˆæœ¬ä¸­æå‡ã€‚</p>
</blockquote>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_04/02.png" alt=""></p>
<p>TableRuleBuilder è°ƒç”¨ <code>#build()</code> æ–¹æ³•åˆ›å»º TableRuleã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TableRuleBuilder.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TableRuleBuilder</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> TableRule <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">       KeyGenerator keyGenerator = <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> != generateKeyColumn &amp;&amp; <span class="keyword">null</span> != keyGeneratorClass) &#123;</div><div class="line">           keyGenerator = KeyGeneratorFactory.createKeyGenerator(keyGeneratorClass);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> TableRule(logicTable, dynamic, actualTables, dataSourceRule, dataSourceNames, databaseShardingStrategy, tableShardingStrategy, generateKeyColumn, keyGenerator);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// TableRule.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">TableRule</span><span class="params">(<span class="keyword">final</span> String logicTable, <span class="keyword">final</span> <span class="keyword">boolean</span> dynamic, <span class="keyword">final</span> List&lt;String&gt; actualTables, <span class="keyword">final</span> DataSourceRule dataSourceRule, <span class="keyword">final</span> Collection&lt;String&gt; dataSourceNames,</span></span></div><div class="line">                <span class="keyword">final</span> DatabaseShardingStrategy databaseShardingStrategy, <span class="keyword">final</span> TableShardingStrategy tableShardingStrategy,</div><div class="line">                <span class="keyword">final</span> String generateKeyColumn, <span class="keyword">final</span> KeyGenerator keyGenerator) &#123;</div><div class="line">   Preconditions.checkNotNull(logicTable);</div><div class="line">   <span class="keyword">this</span>.logicTable = logicTable;</div><div class="line">   <span class="keyword">this</span>.dynamic = dynamic;</div><div class="line">   <span class="keyword">this</span>.databaseShardingStrategy = databaseShardingStrategy;</div><div class="line">   <span class="keyword">this</span>.tableShardingStrategy = tableShardingStrategy;</div><div class="line">   <span class="keyword">if</span> (dynamic) &#123; <span class="comment">// åŠ¨æ€è¡¨çš„åˆ†åº“åˆ†è¡¨æ•°æ®å•å…ƒ</span></div><div class="line">       Preconditions.checkNotNull(dataSourceRule);</div><div class="line">       <span class="keyword">this</span>.actualTables = generateDataNodes(dataSourceRule);</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">null</span> == actualTables || actualTables.isEmpty()) &#123; <span class="comment">// é™æ€è¡¨çš„åˆ†åº“åˆ†è¡¨æ•°æ®å•å…ƒ</span></div><div class="line">       Preconditions.checkNotNull(dataSourceRule);</div><div class="line">       <span class="keyword">this</span>.actualTables = generateDataNodes(Collections.singletonList(logicTable), dataSourceRule, dataSourceNames);</div><div class="line">   &#125; <span class="keyword">else</span> &#123; <span class="comment">// é™æ€è¡¨çš„åˆ†åº“åˆ†è¡¨æ•°æ®å•å…ƒ</span></div><div class="line">       <span class="keyword">this</span>.actualTables = generateDataNodes(actualTables, dataSourceRule, dataSourceNames);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">this</span>.generateKeyColumn = generateKeyColumn;</div><div class="line">   <span class="keyword">this</span>.keyGenerator = keyGenerator;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>2.2.1 DataNode</h3>
<p>å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨<strong>é™æ€</strong>åˆ†åº“åˆ†è¡¨æ•°æ®å•å…ƒï¼Œå³ DataNodeã€‚å¦‚ä¸Šæ–‡æ³¨é‡Šå¤„ <code>é™æ€è¡¨çš„åˆ†åº“åˆ†è¡¨æ•°æ®å•å…ƒ</code> å¤„æ‰€è§ï¼Œåˆ†æˆ<strong>ä¸¤</strong>ç§åˆ¤æ–­ï¼Œå®è´¨ä¸Šç¬¬ä¸€ç§æ˜¯å°† <code>logicTable</code> ä½œä¸º <code>actualTable</code>ï¼Œå³åœ¨<strong>åº“</strong>é‡Œä¸è¿›è¡Œåˆ†è¡¨ï¼Œæ˜¯ç¬¬äºŒç§çš„ä¸€ç§ç‰¹ä¾‹ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹ <code>#generateDataNodes()</code> æ–¹æ³•ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TableRule.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ç”Ÿæˆé™æ€æ•°æ®åˆ†ç‰‡èŠ‚ç‚¹</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> actualTables çœŸå®è¡¨</div><div class="line">* <span class="doctag">@param</span> dataSourceRule æ•°æ®æºé…ç½®å¯¹è±¡</div><div class="line">* <span class="doctag">@param</span> actualDataSourceNames æ•°æ®æºåé›†åˆ</div><div class="line">* <span class="doctag">@return</span> é™æ€æ•°æ®åˆ†ç‰‡èŠ‚ç‚¹</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> List&lt;DataNode&gt; <span class="title">generateDataNodes</span><span class="params">(<span class="keyword">final</span> List&lt;String&gt; actualTables, <span class="keyword">final</span> DataSourceRule dataSourceRule, <span class="keyword">final</span> Collection&lt;String&gt; actualDataSourceNames)</span> </span>&#123;</div><div class="line">   Collection&lt;String&gt; dataSourceNames = getDataSourceNames(dataSourceRule, actualDataSourceNames);</div><div class="line">   List&lt;DataNode&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(actualTables.size() * (dataSourceNames.isEmpty() ? <span class="number">1</span> : dataSourceNames.size()));</div><div class="line">   <span class="keyword">for</span> (String actualTable : actualTables) &#123;</div><div class="line">       <span class="keyword">if</span> (DataNode.isValidDataNode(actualTable)) &#123; <span class="comment">// å½“ actualTable ä¸º $&#123;dataSourceName&#125;.$&#123;tableName&#125; æ—¶</span></div><div class="line">           result.add(<span class="keyword">new</span> DataNode(actualTable));</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">for</span> (String dataSourceName : dataSourceNames) &#123;</div><div class="line">               result.add(<span class="keyword">new</span> DataNode(dataSourceName, actualTable));</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* æ ¹æ® æ•°æ®æºé…ç½®å¯¹è±¡ å’Œ æ•°æ®æºåé›†åˆ è·å¾— æœ€ç»ˆçš„æ•°æ®æºåé›†åˆ</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> dataSourceRule æ•°æ®æºé…ç½®å¯¹è±¡</div><div class="line">* <span class="doctag">@param</span> actualDataSourceNames æ•°æ®æºåé›†åˆ</div><div class="line">* <span class="doctag">@return</span> æœ€ç»ˆçš„æ•°æ®æºåé›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;String&gt; <span class="title">getDataSourceNames</span><span class="params">(<span class="keyword">final</span> DataSourceRule dataSourceRule, <span class="keyword">final</span> Collection&lt;String&gt; actualDataSourceNames)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> == dataSourceRule) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> == actualDataSourceNames || actualDataSourceNames.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span> dataSourceRule.getDataSourceNames();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> actualDataSourceNames;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬ä¸€ç§æƒ…å†µï¼Œ<strong>è‡ªå®šä¹‰åˆ†å¸ƒ</strong>ã€‚<code>actualTable</code> ä¸º <code>${dataSourceName}.${tableName}</code> æ—¶ï¼Œå³å·²ç»æ˜ç¡®çœŸå®è¡¨æ‰€åœ¨æ•°æ®æºã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">TableRule.builder(<span class="string">"t_order"</span>).actualTables(Arrays.asList(<span class="string">"db0.t_order_0"</span>, <span class="string">"db1.t_order_1"</span>, <span class="string">"db1.t_order_2"</span>))</div></pre></td></tr></table></figure></p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">db0</div><div class="line">  â””â”€â”€ t_order_0 </div><div class="line">db1</div><div class="line">  â”œâ”€â”€ t_order_1</div><div class="line">  â””â”€â”€ t_order_2</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬äºŒç§æƒ…å†µï¼Œ<strong>å‡åŒ€åˆ†å¸ƒ</strong>ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">TableRule.builder(<span class="string">"t_order"</span>).actualTables(Arrays.asList(<span class="string">"t_order_0"</span>, <span class="string">"t_order_1"</span>))</div></pre></td></tr></table></figure></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">db0</div><div class="line">  â”œâ”€â”€ t_order_0 </div><div class="line">  â””â”€â”€ t_order_1 </div><div class="line">db1</div><div class="line">  â”œâ”€â”€ t_order_0 </div><div class="line">  â””â”€â”€ t_order_1</div></pre></td></tr></table></figure></p>
<p><code>#getDataSourceNames()</code> ä½¿ç”¨ <code>dataSourceRule</code> å’Œ <code>actualDataSourceNames</code> è·å–æ•°æ®æºçš„é€»è¾‘çœ‹èµ·æ¥æœ‰ç§â€œè¯¡å¼‚â€ã€‚<strong>å®é™… TableRuleBuilder åˆ›å»º TableRule æ—¶ï¼Œä½¿ç”¨ <code>dataSourceRule</code> è€Œä¸è¦ä½¿ç”¨ <code>actualDataSourceNames</code></strong>ã€‚</p>
<h3>2.2.2 DynamicDataNode</h3>
<p>å°‘æ•°ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨<strong>åŠ¨æ€</strong>åˆ†åº“åˆ†è¡¨æ•°æ®å•å…ƒï¼Œå³ DynamicDataNodeã€‚
<strong>é€šè¿‡ <code>dynamic=true</code> å±æ€§é…ç½®</strong>ã€‚ç”Ÿæˆä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TableRule.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> List&lt;DataNode&gt; <span class="title">generateDataNodes</span><span class="params">(<span class="keyword">final</span> DataSourceRule dataSourceRule)</span> </span>&#123;</div><div class="line">   Collection&lt;String&gt; dataSourceNames = dataSourceRule.getDataSourceNames();</div><div class="line">   List&lt;DataNode&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(dataSourceNames.size());</div><div class="line">   <span class="keyword">for</span> (String each : dataSourceNames) &#123;</div><div class="line">       result.add(<span class="keyword">new</span> DynamicDataNode(each));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ğŸ˜‚ ä»ä»£ç ä¸Šçœ‹ï¼Œè²Œä¼¼å’Œ<strong>åŠ¨æ€</strong>åˆ†åº“åˆ†è¡¨æ•°æ®å•å…ƒæ²¡ä¸€æ¯›é’±å…³ç³»ï¼Ÿï¼åˆ«æ‰é¸¡ï¼Œç­”æ¡ˆåœ¨<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šåˆ†è¡¨åˆ†åº“è·¯ç”±ã€‹</a> ä¸Šã€‚</p>
<h2>2.3 åˆ†åº“/åˆ†è¡¨ç­–ç•¥</h2>
<ul>
<li><code>databaseShardingStrategy</code> ï¼šåˆ†åº“ç­–ç•¥</li>
<li><code>tableShardingStrategy</code> ï¼šåˆ†è¡¨ç­–ç•¥</li>
</ul>
<p>å½“åˆ†åº“/åˆ†è¡¨ç­–ç•¥ä¸é…ç½®æ—¶ï¼Œä½¿ç”¨ ShardingRule é…ç½®çš„åˆ†åº“/åˆ†è¡¨ç­–ç•¥ã€‚</p>
<h2>2.4 ä¸»é”®ç”Ÿæˆ</h2>
<ul>
<li><code>generateKeyColumn</code> ï¼šä¸»é”®å­—æ®µ</li>
<li><code>keyGenerator</code> ï¼šä¸»é”®ç”Ÿæˆå™¨</li>
</ul>
<p>å½“ä¸»é”®ç”Ÿæˆå™¨ä¸é…ç½®æ—¶ï¼Œä½¿ç”¨ ShardingRule é…ç½®çš„ä¸»é”®ç”Ÿæˆå™¨ã€‚</p>
<h1>3. ShardingRule</h1>
<p>ShardingRuleï¼Œåˆ†åº“åˆ†è¡¨è§„åˆ™é…ç½®å¯¹è±¡ï¼Œå†…åµŒ ShardingRuleBuilder å¯¹è±¡è¿›è¡Œåˆ›å»ºã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_04/03.png" alt=""></p>
<p>å…¶ä¸­ databaseShardingStrategyã€tableShardingStrategyã€keyGeneratorã€defaultGenerator å’Œ TableRule å±æ€§é‡å¤ï¼Œç”¨äºå½“ TableRule æœªé…ç½®å¯¹åº”å±æ€§ï¼Œä½¿ç”¨ ShardingRule æä¾›çš„è¯¥å±æ€§ã€‚</p>
<h2>3.1 dataSourceRule</h2>
<p><code>dataSourceRule</code>ï¼Œæ•°æ®æºé…ç½®å¯¹è±¡ã€‚ShardingRule éœ€è¦æ•°æ®æºé…ç½®æ­£ç¡®ã€‚è¿™ç‚¹å’Œ TableRule æ˜¯ä¸åŒçš„ã€‚TableRule å¯¹ <code>dataSourceRule</code> <strong>åªä½¿ç”¨æ•°æ®æºåå­—ï¼Œæœ€ç»ˆæ‰§è¡ŒSQL ä½¿ç”¨æ•°æ®æºåå­—ä» ShardingRule è·å–æ•°æ®æºè¿æ¥</strong>ã€‚å¤§å®¶å¯ä»¥å›åˆ°æœ¬æ–‡ã€2.2.1 DataNodeã€‘ç»†çœ‹ä¸‹ DataNode çš„ç”Ÿæˆè¿‡ç¨‹ã€‚</p>
<h2>3.2 tableRules</h2>
<p><code>tableRules</code>ï¼Œè¡¨è§„åˆ™é…ç½®å¯¹è±¡<strong>é›†åˆ</strong>ã€‚</p>
<h2>3.3 bindingTableRules</h2>
<blockquote>
<p>æŒ‡åœ¨ä»»ä½•åœºæ™¯ä¸‹åˆ†ç‰‡è§„åˆ™å‡ä¸€è‡´çš„ä¸»è¡¨å’Œå­è¡¨ã€‚<br>
ä¾‹ï¼šè®¢å•è¡¨å’Œè®¢å•é¡¹è¡¨ï¼Œå‡æŒ‰ç…§è®¢å•IDåˆ†ç‰‡ï¼Œåˆ™æ­¤ä¸¤å¼ è¡¨äº’ä¸ºBindingTableå…³ç³»ã€‚<br>
BindingTableå…³ç³»çš„å¤šè¡¨å…³è”æŸ¥è¯¢ä¸ä¼šå‡ºç°ç¬›å¡å°”ç§¯å…³è”ï¼Œå…³è”æŸ¥è¯¢æ•ˆç‡å°†å¤§å¤§æå‡ã€‚</p>
</blockquote>
<p>ğŸ˜ˆ è¿™ä¹ˆè¯´ï¼Œå¯èƒ½ä¸å¤ªå®¹æ˜“ç†è§£ã€‚<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šåˆ†è¡¨åˆ†åº“è·¯ç”±ã€‹</a>ï¼Œæˆ‘ä»¬åœ¨æºç çš„åŸºç¡€ä¸Šï¼Œå¥½å¥½ç†è§£ä¸‹ã€‚<strong>éå¸¸é‡è¦ï¼Œç‰¹åˆ«æ˜¯æ€§èƒ½ä¼˜åŒ–ä¸Šé¢</strong>ã€‚</p>
<h1>4. ShardingStrategy</h1>
<p>ShardingStrategyï¼Œåˆ†ç‰‡ç­–ç•¥ã€‚</p>
<ul>
<li>é’ˆå¯¹åˆ†åº“ã€åˆ†è¡¨æœ‰ä¸¤ä¸ªå­ç±»ã€‚</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_04/04.png" alt=""></p>
<ul>
<li>DatabaseShardingStrategyï¼Œä½¿ç”¨<strong>åˆ†åº“</strong>ç®—æ³•è¿›è¡Œåˆ†ç‰‡</li>
<li>TableShardingStrategyï¼Œä½¿ç”¨<strong>åˆ†è¡¨</strong>ç®—æ³•è¿›è¡Œåˆ†ç‰‡</li>
</ul>
<p><a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šåˆ†è¡¨åˆ†åº“è·¯ç”±ã€‹</a> ä¼šè¿›ä¸€æ­¥è¯´æ˜ã€‚</p>
<h1>5. ShardingAlgorithm</h1>
<p>ShardingAlgorithmï¼Œåˆ†ç‰‡ç®—æ³•ã€‚</p>
<ul>
<li>é’ˆå¯¹åˆ†åº“ã€åˆ†è¡¨æœ‰ä¸¤ä¸ªå­<strong>æ¥å£</strong>ã€‚</li>
<li>é’ˆå¯¹<strong>åˆ†ç‰‡é”®</strong>æ•°é‡åˆ†æˆï¼šæ— åˆ†ç‰‡é”®ç®—æ³•ã€å•ç‰‡é”®ç®—æ³•ã€å¤šç‰‡é”®ç®—æ³•ã€‚</li>
</ul>
<p><strong>å…¶ä¸­ NoneKeyDatabaseShardingAlgorithmã€NoneTableShardingAlgorithm ä¸º ShardingRule åœ¨æœªè®¾ç½®åˆ†åº“ã€åˆ†è¡¨ç®—æ³•çš„é»˜è®¤å€¼</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingRule.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ShardingRule</span><span class="params">(</span></span></div><div class="line">       <span class="keyword">final</span> DataSourceRule dataSourceRule, <span class="keyword">final</span> Collection&lt;TableRule&gt; tableRules, <span class="keyword">final</span> Collection&lt;BindingTableRule&gt; bindingTableRules,</div><div class="line">       <span class="keyword">final</span> DatabaseShardingStrategy databaseShardingStrategy, <span class="keyword">final</span> TableShardingStrategy tableShardingStrategy, <span class="keyword">final</span> KeyGenerator keyGenerator) &#123;</div><div class="line">   <span class="comment">// ... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">   <span class="keyword">this</span>.databaseShardingStrategy = <span class="keyword">null</span> == databaseShardingStrategy ? <span class="keyword">new</span> DatabaseShardingStrategy(</div><div class="line">           Collections.&lt;String&gt;emptyList(), <span class="keyword">new</span> NoneDatabaseShardingAlgorithm()) : databaseShardingStrategy;</div><div class="line">   <span class="keyword">this</span>.tableShardingStrategy = <span class="keyword">null</span> == tableShardingStrategy ? <span class="keyword">new</span> TableShardingStrategy(</div><div class="line">           Collections.&lt;String&gt;emptyList(), <span class="keyword">new</span> NoneTableShardingAlgorithm()) : tableShardingStrategy;</div><div class="line">   <span class="comment">// ... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šåˆ†è¡¨åˆ†åº“è·¯ç”±ã€‹</a> ä¼šè¿›ä¸€æ­¥è¯´æ˜ã€‚</p>
<h1>666. å½©è›‹</h1>
<p>æœ¬æ–‡çœ‹ä¼¼åœ¨æ°´æ›´ï¼Œå®æ˜¯ä¸º<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šåˆ†è¡¨åˆ†åº“è·¯ç”±ã€‹</a>åšé“ºå«ï¼ˆä¸€é˜µè„¸çº¢ğŸ˜³ï¼‰ã€‚</p>
<p>Butï¼Œæ— è®ºæ€ä¹ˆè¯´ï¼Œé“å‹ï¼Œæˆ‘åšäº†æ–°çš„å…³æ³¨äºŒç»´ç ï¼ˆæ„Ÿè°¢çŒ«ğŸ±å…ˆç”Ÿï¼‰ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥æ¨èä¸€æ³¢å…¬ä¼—å·ç»™åŸºä½¬ã€‚</p>
<p>æ©ï¼Œç»§ç»­æ›´æ–°ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;o
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆå…­ï¼‰ä¹‹åˆ é™¤SQL</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-parse-6/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-parse-6/</id>
    <published>2017-08-01T16:00:00.000Z</published>
    <updated>2017-08-10T17:25:37.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Sharding-JDBC 1.5.0 æ­£å¼ç‰ˆ</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. DeleteStatement</a></li>
<li><a href="#">3. #parse()</a>
<ul>
<li><a href="#">3.1 #skipBetweenDeleteAndTable()</a></li>
<li><a href="#">3.2 #parseSingleTable()</a></li>
<li><a href="#">3.3 #parseWhere()</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡å‰ç½®é˜…è¯»ï¼š</p>
<ul>
<li><a href="http://www.yunai.me/Sharding-JDBC/sql-parse-1/?self">ã€ŠSQL è§£æï¼ˆä¸€ï¼‰ä¹‹è¯æ³•è§£æã€‹</a></li>
<li><a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹</a></li>
</ul>
<p>æœ¬æ–‡åˆ†äº«<strong>åˆ é™¤SQLè§£æ</strong>çš„æºç å®ç°ã€‚</p>
<p>ğŸ™‚ å¦‚æœä½ å·²ç»ç†è§£<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-3/?self">ã€ŠSQL è§£æï¼ˆä¸‰ï¼‰ä¹‹æŸ¥è¯¢SQLã€‹</a>ï¼Œé‚£æœ¬æ–‡ä¼šæ˜¯ä¸€ç¯‡æ°´æ–‡ï¼Œå½“æˆä¸€ç§æ”¾æ¾å§ã€‚è¿˜æ˜¯è·Ÿå‰æ–‡ä¸€æ ·ï¼Œä»¥ MySQL ä¸¾ä¾‹å­ã€‚æˆ‘ä»¬æ¥ä¸€èµ·çœ‹çœ‹ MySQLDeleteParserã€‚</p>
<p>MySQL DELETE è¯­æ³•ä¸€å…±æœ‰ 2 ç§ ï¼š</p>
<ul>
<li>ç¬¬ä¸€ç§ï¼š<strong>Single-table syntax</strong></li>
</ul>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">DELETE</span> [<span class="keyword">LOW_PRIORITY</span>] [<span class="keyword">QUICK</span>] [<span class="keyword">IGNORE</span>] <span class="keyword">FROM</span> tbl_name</div><div class="line">    [<span class="keyword">PARTITION</span> (partition_name,...)]</div><div class="line">    [<span class="keyword">WHERE</span> where_condition]</div><div class="line">    [<span class="keyword">ORDER</span> <span class="keyword">BY</span> ...]</div><div class="line">    [<span class="keyword">LIMIT</span> <span class="keyword">row_count</span>]</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬äºŒç§ï¼š<strong>Multiple-table syntax</strong></li>
</ul>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">DELETE</span> [<span class="keyword">LOW_PRIORITY</span>] [<span class="keyword">QUICK</span>] [<span class="keyword">IGNORE</span>]</div><div class="line">    tbl_name[.*] [, tbl_name[.*]] ...</div><div class="line">    <span class="keyword">FROM</span> table_references</div><div class="line">    [<span class="keyword">WHERE</span> where_condition]</div><div class="line">    </div><div class="line">ã€<span class="keyword">OR</span>ã€‘</div><div class="line"></div><div class="line"><span class="keyword">DELETE</span> [<span class="keyword">LOW_PRIORITY</span>] [<span class="keyword">QUICK</span>] [<span class="keyword">IGNORE</span>]</div><div class="line">    <span class="keyword">FROM</span> tbl_name[.*] [, tbl_name[.*]] ...</div><div class="line">    <span class="keyword">USING</span> table_references</div><div class="line">    [<span class="keyword">WHERE</span> where_condition]</div></pre></td></tr></table></figure></p>
<p>Sharding-JDBC ç›®å‰ä»…æ”¯æŒç¬¬ä¸€ç§ã€‚ä¸šåŠ¡åœºæ™¯ä¸Šä½¿ç”¨ç¬¬äºŒç§çš„å¾ˆå°‘å¾ˆå°‘ã€‚</p>
<p>Sharding-JDBC æ›´æ–°SQLè§£æä¸»æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_02/01.png" alt=""></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractDeleteParser.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> DeleteStatement <span class="title">parse</span><span class="params">()</span> </span>&#123;</div><div class="line">   sqlParser.getLexer().nextToken(); <span class="comment">// è·³è¿‡ DELETE</span></div><div class="line">   skipBetweenDeleteAndTable(); <span class="comment">// // è·³è¿‡å…³é”®å­—ï¼Œä¾‹å¦‚ï¼šMYSQL é‡Œçš„ LOW_PRIORITYã€IGNORE å’Œ FROM</span></div><div class="line">   sqlParser.parseSingleTable(deleteStatement); <span class="comment">// è§£æè¡¨</span></div><div class="line">   sqlParser.skipUntil(DefaultKeyword.WHERE); <span class="comment">// è·³åˆ° WHERE</span></div><div class="line">   sqlParser.parseWhere(deleteStatement); <span class="comment">// è§£æ WHERE</span></div><div class="line">   <span class="keyword">return</span> deleteStatement;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>
ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1>2. DeleteStatement</h1>
<p>åˆ é™¤SQL è§£æç»“æœã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UpdateStatement</span> <span class="keyword">extends</span> <span class="title">AbstractSQLStatement</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ğŸ˜ˆ å¯¹ï¼Œæ²¡æœ‰å…¶ä»–å±æ€§ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>DELETE IGNORE FROM t_user WHERE user_id = ?</code> çš„<strong>è§£æç»“æœ</strong>ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_02/02.png" alt=""></p>
<h1>3. #parse()</h1>
<h2>3.1 #skipBetweenDeleteAndTable()</h2>
<p>åœ¨ <code>DELETE</code> å’Œ è¡¨å ä¹‹é—´æœ‰äº›è¯æ³•ï¼Œå¯¹ SQL è·¯ç”±å’Œæ”¹å†™æ— å½±å“ï¼Œè¿›è¡Œè·³è¿‡ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MySQLDeleteParser.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">skipBetweenDeleteAndTable</span><span class="params">()</span> </span>&#123;</div><div class="line">   getSqlParser().skipAll(MySQLKeyword.LOW_PRIORITY, MySQLKeyword.QUICK, MySQLKeyword.IGNORE);</div><div class="line">   getSqlParser().skipIfEqual(DefaultKeyword.FROM);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// OracleDeleteParser.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">skipBetweenDeleteAndTable</span><span class="params">()</span> </span>&#123;</div><div class="line">   getSqlParser().skipIfEqual(DefaultKeyword.FROM);</div><div class="line">   getSqlParser().skipIfEqual(OracleKeyword.ONLY);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.2 #parseSingleTable()</h2>
<p>è§£æ<strong>è¡¨</strong>ï¼Œè¯·çœ‹<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹çš„ <code>#parseSingleTable()</code> å°èŠ‚</a>ã€‚</p>
<h2>3.3 #parseWhere()</h2>
<p>è§£æ WHERE æ¡ä»¶ã€‚è§£æä»£ç ï¼š<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹çš„#parseWhere()å°èŠ‚</a>ã€‚</p>
<h1>666. å½©è›‹</h1>
<p>é“å‹ï¼Œå¸®æˆ‘åˆ†äº«ä¸€æ³¢æ€ä¹ˆæ ·ï¼Ÿ</p>
<p><strong>åé¢ SQL è·¯ç”±å’Œæ”¹å†™ä¼šæ›´åŠ æœ‰è¶£å“Ÿï¼</strong></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;o
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆäº”ï¼‰ä¹‹æ›´æ–°SQL</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-parse-5/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-parse-5/</id>
    <published>2017-07-30T16:00:00.000Z</published>
    <updated>2017-08-10T17:25:34.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Sharding-JDBC 1.5.0 æ­£å¼ç‰ˆ</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. UpdateStatement</a></li>
<li><a href="#">3. #parse()</a>
<ul>
<li><a href="#">3.1 #skipBetweenUpdateAndTable()</a></li>
<li><a href="#">3.2 #parseSingleTable()</a></li>
<li><a href="#">3.3 #parseSetItems()</a></li>
<li><a href="#">3.4 #parseWhere()</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡å‰ç½®é˜…è¯»ï¼š</p>
<ul>
<li><a href="http://www.yunai.me/Sharding-JDBC/sql-parse-1/?self">ã€ŠSQL è§£æï¼ˆä¸€ï¼‰ä¹‹è¯æ³•è§£æã€‹</a></li>
<li><a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹</a></li>
</ul>
<p>æœ¬æ–‡åˆ†äº«<strong>æ›´æ–°SQLè§£æ</strong>çš„æºç å®ç°ã€‚</p>
<p>æ›´æ–°SQLè§£ææ¯”æŸ¥è¯¢SQLè§£æå¤æ‚åº¦ä½çš„å¤šçš„å¤šã€‚ä¸åŒæ•°æ®åº“åœ¨æ’å…¥SQLè¯­æ³•ä¸Šä¹Ÿç»Ÿä¸€çš„å¤šã€‚<strong>æœ¬æ–‡åˆ†äº« MySQL æ›´æ–°SQLè§£æå™¨ MySQLUpdateParser</strong>ã€‚</p>
<p>MySQL UPDATE è¯­æ³•ä¸€å…±æœ‰ 2 ç§ ï¼š</p>
<ul>
<li>ç¬¬ä¸€ç§ï¼š<strong>Single-table syntax</strong></li>
</ul>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">UPDATE</span> [<span class="keyword">LOW_PRIORITY</span>] [<span class="keyword">IGNORE</span>] table_reference</div><div class="line">    <span class="keyword">SET</span> col_name1=&#123;expr1|<span class="keyword">DEFAULT</span>&#125; [, col_name2=&#123;expr2|<span class="keyword">DEFAULT</span>&#125;] ...</div><div class="line">    [<span class="keyword">WHERE</span> where_condition]</div><div class="line">    [<span class="keyword">ORDER</span> <span class="keyword">BY</span> ...]</div><div class="line">    [<span class="keyword">LIMIT</span> <span class="keyword">row_count</span>]</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬äºŒç§ï¼š<strong>Multiple-table syntax</strong></li>
</ul>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">UPDATE</span> [<span class="keyword">LOW_PRIORITY</span>] [<span class="keyword">IGNORE</span>] table_references</div><div class="line">    <span class="keyword">SET</span> col_name1=&#123;expr1|<span class="keyword">DEFAULT</span>&#125; [, col_name2=&#123;expr2|<span class="keyword">DEFAULT</span>&#125;] ...</div><div class="line">    [<span class="keyword">WHERE</span> where_condition]</div></pre></td></tr></table></figure></p>
<p>Sharding-JDBC ç›®å‰ä»…æ”¯æŒç¬¬ä¸€ç§ã€‚ä¸šåŠ¡åœºæ™¯ä¸Šä½¿ç”¨ç¬¬äºŒç§çš„å¾ˆå°‘å¾ˆå°‘ã€‚</p>
<p>Sharding-JDBC æ›´æ–°SQLè§£æä¸»æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_31/01.png" alt=""></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractUpdateParser.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> UpdateStatement <span class="title">parse</span><span class="params">()</span> </span>&#123;</div><div class="line">   sqlParser.getLexer().nextToken(); <span class="comment">// è·³è¿‡ UPDATE</span></div><div class="line">   skipBetweenUpdateAndTable(); <span class="comment">// è·³è¿‡å…³é”®å­—ï¼Œä¾‹å¦‚ï¼šMYSQL é‡Œçš„ LOW_PRIORITYã€IGNORE</span></div><div class="line">   sqlParser.parseSingleTable(updateStatement); <span class="comment">// è§£æè¡¨</span></div><div class="line">   parseSetItems(); <span class="comment">// è§£æ SET</span></div><div class="line">   sqlParser.skipUntil(DefaultKeyword.WHERE);</div><div class="line">   sqlParser.setParametersIndex(parametersIndex);</div><div class="line">   sqlParser.parseWhere(updateStatement);</div><div class="line">   <span class="keyword">return</span> updateStatement; <span class="comment">// è§£æ WHERE</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>
ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1>2. UpdateStatement</h1>
<p>æ›´æ–°SQL è§£æç»“æœã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UpdateStatement</span> <span class="keyword">extends</span> <span class="title">AbstractSQLStatement</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ğŸ˜ˆ å¯¹ï¼Œæ²¡æœ‰å…¶ä»–å±æ€§ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>UPDATE t_user SET nickname = ?, age = ? WHERE user_id = ?</code> çš„<strong>è§£æç»“æœ</strong>ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_31/02.png" alt=""></p>
<h1>3. #parse()</h1>
<h2>3.1 #skipBetweenUpdateAndTable()</h2>
<p>åœ¨ <code>UPDATE</code> å’Œ è¡¨å ä¹‹é—´æœ‰äº›è¯æ³•ï¼Œå¯¹ SQL è·¯ç”±å’Œæ”¹å†™æ— å½±å“ï¼Œè¿›è¡Œè·³è¿‡ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MySQLUpdateParser.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">skipBetweenUpdateAndTable</span><span class="params">()</span> </span>&#123;</div><div class="line">   getSqlParser().skipAll(MySQLKeyword.LOW_PRIORITY, MySQLKeyword.IGNORE);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// OracleUpdateParser.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">skipBetweenUpdateAndTable</span><span class="params">()</span> </span>&#123;</div><div class="line">   getSqlParser().skipIfEqual(OracleKeyword.ONLY);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.2 #parseSingleTable()</h2>
<p>è§£æ<strong>è¡¨</strong>ï¼Œè¯·çœ‹<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹çš„ <code>#parseSingleTable()</code> å°èŠ‚</a>ã€‚</p>
<h2>3.3 #parseSetItems()</h2>
<p>è§£æ<code>SET</code>åè¯­å¥ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractUpdateParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æå¤šä¸ª SET é¡¹</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSetItems</span><span class="params">()</span> </span>&#123;</div><div class="line">   sqlParser.accept(DefaultKeyword.SET);</div><div class="line">   <span class="keyword">do</span> &#123;</div><div class="line">       parseSetItem();</div><div class="line">   &#125; <span class="keyword">while</span> (sqlParser.skipIfEqual(Symbol.COMMA)); <span class="comment">// ä»¥ "," åˆ†éš”</span></div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æå•ä¸ª SET é¡¹</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSetItem</span><span class="params">()</span> </span>&#123;</div><div class="line">   parseSetColumn();</div><div class="line">   sqlParser.skipIfEqual(Symbol.EQ, Symbol.COLON_EQ);</div><div class="line">   parseSetValue();</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æå•ä¸ª SET é¡¹</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSetColumn</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(Symbol.LEFT_PAREN)) &#123;</div><div class="line">       sqlParser.skipParentheses();</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">int</span> beginPosition = sqlParser.getLexer().getCurrentToken().getEndPosition();</div><div class="line">   String literals = sqlParser.getLexer().getCurrentToken().getLiterals();</div><div class="line">   sqlParser.getLexer().nextToken();</div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(Symbol.DOT)) &#123; <span class="comment">// å­—æ®µæœ‰åˆ«å</span></div><div class="line">       <span class="comment">// TableToken</span></div><div class="line">       <span class="keyword">if</span> (updateStatement.getTables().getSingleTableName().equalsIgnoreCase(SQLUtil.getExactlyValue(literals))) &#123;</div><div class="line">           updateStatement.getSqlTokens().add(<span class="keyword">new</span> TableToken(beginPosition - literals.length(), literals));</div><div class="line">       &#125;</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æå•ä¸ª SET å€¼</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSetValue</span><span class="params">()</span> </span>&#123;</div><div class="line">   sqlParser.parseExpression(updateStatement);</div><div class="line">   parametersIndex = sqlParser.getParametersIndex();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.4 #parseWhere()</h2>
<p>è§£æ WHERE æ¡ä»¶ã€‚è§£æä»£ç ï¼š<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹çš„#parseWhere()å°èŠ‚</a>ã€‚</p>
<h1>666. å½©è›‹</h1>
<p>ğŸ˜ æ¯”æ›´æ–°SQLè§£ææ˜¯ä¸æ˜¯ç®€å•ï¼Œæ›´ä¸ç”¨å¯¹æ¯”æŸ¥è¯¢SQLè§£æã€‚ğŸ˜³æœ‰ä¸€ç§åœ¨æ°´æ›´çš„æ„Ÿè§‰ã€‚å˜¿å˜¿ï¼Œä¸‹ä¸€ç¯‡ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šåˆ é™¤SQLè§£æã€‹</a>ï¼‰ä¼šæ›´åŠ å®¹æ˜“ã€‚</p>
<p>é“å‹ï¼Œå¸®æˆ‘åˆ†äº«ä¸€æ³¢æ€ä¹ˆæ ·ï¼Ÿ</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;o
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆå››ï¼‰ä¹‹æ’å…¥SQL</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-parse-4/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-parse-4/</id>
    <published>2017-07-28T16:00:00.000Z</published>
    <updated>2017-08-10T17:25:31.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Sharding-JDBC 1.5.0 æ­£å¼ç‰ˆ</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. InsertStatement</a></li>
<li><a href="#">3. #parse()</a>
<ul>
<li><a href="#">3.1 #parseInfo()</a></li>
<li><a href="#">3.2 #parseColumns()</a></li>
<li><a href="#">3.3 #parseValues()</a></li>
<li><a href="#">3.4 #parseCustomizedInsert()</a></li>
<li><a href="#">3.5 #appendGenerateKey()</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡å‰ç½®é˜…è¯»ï¼š</p>
<ul>
<li><a href="http://www.yunai.me/Sharding-JDBC/sql-parse-1/?self">ã€ŠSQL è§£æï¼ˆä¸€ï¼‰ä¹‹è¯æ³•è§£æã€‹</a></li>
<li><a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹</a></li>
</ul>
<p>æœ¬æ–‡åˆ†äº«<strong>æ’å…¥SQLè§£æ</strong>çš„æºç å®ç°ã€‚</p>
<p>ä¸è€ƒè™‘ INSERT SELECT æƒ…å†µä¸‹ï¼Œæ’å…¥SQLè§£ææ¯”æŸ¥è¯¢SQLè§£æå¤æ‚åº¦ä½çš„å¤šçš„å¤šã€‚ä¸åŒæ•°æ®åº“åœ¨æ’å…¥SQLè¯­æ³•ä¸Šä¹Ÿç»Ÿä¸€çš„å¤šã€‚<strong>æœ¬æ–‡åˆ†äº« MySQL æ’å…¥SQLè§£æå™¨ MySQLInsertParser</strong>ã€‚</p>
<p>MySQL INSERT è¯­æ³•ä¸€å…±æœ‰ 3 ç§ ï¼š</p>
<ul>
<li>ç¬¬ä¸€ç§ï¼š<code>INSERT {VALUES | VALUES}</code></li>
</ul>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> [<span class="keyword">LOW_PRIORITY</span> | <span class="keyword">DELAYED</span> | <span class="keyword">HIGH_PRIORITY</span>] [<span class="keyword">IGNORE</span>]</div><div class="line">    [<span class="keyword">INTO</span>] tbl_name</div><div class="line">    [<span class="keyword">PARTITION</span> (partition_name,...)]</div><div class="line">    [(col_name,...)]</div><div class="line">    &#123;<span class="keyword">VALUES</span> | <span class="keyword">VALUE</span>&#125; (&#123;expr | <span class="keyword">DEFAULT</span>&#125;,...),(...),...</div><div class="line">    [ <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span></div><div class="line">      col_name=expr</div><div class="line">        [, col_name=expr] ... ]</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬äºŒç§ï¼š<code>INSERT SET</code></li>
</ul>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> [<span class="keyword">LOW_PRIORITY</span> | <span class="keyword">DELAYED</span> | <span class="keyword">HIGH_PRIORITY</span>] [<span class="keyword">IGNORE</span>]</div><div class="line">    [<span class="keyword">INTO</span>] tbl_name</div><div class="line">    [<span class="keyword">PARTITION</span> (partition_name,...)]</div><div class="line">    <span class="keyword">SET</span> col_name=&#123;expr | <span class="keyword">DEFAULT</span>&#125;, ...</div><div class="line">    [ <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span></div><div class="line">      col_name=expr</div><div class="line">        [, col_name=expr] ... ]</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬ä¸‰ç§ï¼š<code>INSERT SELECT</code></li>
</ul>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> [<span class="keyword">LOW_PRIORITY</span> | <span class="keyword">HIGH_PRIORITY</span>] [<span class="keyword">IGNORE</span>]</div><div class="line">    [<span class="keyword">INTO</span>] tbl_name</div><div class="line">    [<span class="keyword">PARTITION</span> (partition_name,...)]</div><div class="line">    [(col_name,...)]</div><div class="line">    <span class="keyword">SELECT</span> ...</div><div class="line">    [ <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span></div><div class="line">      col_name=expr</div><div class="line">        [, col_name=expr] ... ]</div></pre></td></tr></table></figure></p>
<p>Sharding-JDBC ç›®å‰æ”¯æŒï¼š</p>
<ul>
<li>ç¬¬ä¸€ç§ï¼š<code>INSERT {VALUES | VALUES}</code> <strong>å•æ¡è®°å½•</strong></li>
<li>ç¬¬äºŒç§ï¼š<code>INSERT SET</code></li>
</ul>
<p>Sharding-JDBC æ’å…¥SQLè§£æä¸»æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_29/01.png" alt=""></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInsertParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> InsertStatement <span class="title">parse</span><span class="params">()</span> </span>&#123;</div><div class="line">   sqlParser.getLexer().nextToken(); <span class="comment">// è·³è¿‡ INSERT å…³é”®å­—</span></div><div class="line">   parseInto(); <span class="comment">// è§£æINTO</span></div><div class="line">   parseColumns(); <span class="comment">// è§£æè¡¨</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.SELECT, Symbol.LEFT_PAREN)) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support subquery"</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (getValuesKeywords().contains(sqlParser.getLexer().getCurrentToken().getType())) &#123; <span class="comment">// ç¬¬ä¸€ç§æ’å…¥SQLæƒ…å†µ</span></div><div class="line">       parseValues();</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getCustomizedInsertKeywords().contains(sqlParser.getLexer().getCurrentToken().getType())) &#123; <span class="comment">// ç¬¬äºŒç§æ’å…¥SQLæƒ…å†µ</span></div><div class="line">       parseCustomizedInsert();</div><div class="line">   &#125;</div><div class="line">   appendGenerateKey(); <span class="comment">// è‡ªå¢ä¸»é”®</span></div><div class="line">   <span class="keyword">return</span> insertStatement;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>
ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1>2. InsertStatement</h1>
<p>æ’å…¥SQL è§£æç»“æœã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InsertStatement</span> <span class="keyword">extends</span> <span class="title">AbstractSQLStatement</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ’å…¥å­—æ®µ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Collection&lt;Column&gt; columns = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     *</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> GeneratedKey generatedKey;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ’å…¥å­—æ®µ ä¸‹ä¸€ä¸ªToken å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> columnsListLastPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å€¼å­—æ®µ ä¸‹ä¸€ä¸ªToken å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> valuesListLastPosition;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>INSERT INTO t_order (uid, nickname) VALUES (?, ?)</code> çš„<strong>è§£æç»“æœ</strong>ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_29/02.png" alt=""></p>
<h1>3. #parse()</h1>
<h2>3.1 #parseInto()</h2>
<p>è§£æ<strong>è¡¨</strong>ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInsertParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æè¡¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseInto</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ä¾‹å¦‚ï¼ŒOracleï¼ŒINSERT FIRST/ALL ç›®å‰ä¸æ”¯æŒ</span></div><div class="line">   <span class="keyword">if</span> (getUnsupportedKeywords().contains(sqlParser.getLexer().getCurrentToken().getType())) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(sqlParser.getLexer().getCurrentToken().getType());</div><div class="line">   &#125;</div><div class="line">   sqlParser.skipUntil(DefaultKeyword.INTO);</div><div class="line">   sqlParser.getLexer().nextToken();</div><div class="line">   <span class="comment">// è§£æè¡¨</span></div><div class="line">   sqlParser.parseSingleTable(insertStatement);</div><div class="line">   skipBetweenTableAndValues();</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·³è¿‡ è¡¨ å’Œ æ’å…¥å­—æ®µ ä¸­é—´çš„ Token</div><div class="line">* ä¾‹å¦‚ MySQL ï¼š[PARTITION (partition_name,...)]</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">skipBetweenTableAndValues</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">while</span> (getSkippedKeywordsBetweenTableAndValues().contains(sqlParser.getLexer().getCurrentToken().getType())) &#123;</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       <span class="keyword">if</span> (sqlParser.equalAny(Symbol.LEFT_PAREN)) &#123;</div><div class="line">           sqlParser.skipParentheses();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­ <code>#parseSingleTable()</code> è¯·çœ‹<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹çš„ <code>#parseSingleTable()</code> å°èŠ‚</a>ã€‚</p>
<h2>3.2 #parseColumns()</h2>
<p>è§£æ<strong>æ’å…¥å­—æ®µ</strong>ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInsertParser.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseColumns</span><span class="params">()</span> </span>&#123;</div><div class="line">   Collection&lt;Column&gt; result = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(Symbol.LEFT_PAREN)) &#123;</div><div class="line">       String tableName = insertStatement.getTables().getSingleTableName();</div><div class="line">       Optional&lt;String&gt; generateKeyColumn = shardingRule.getGenerateKeyColumn(tableName); <span class="comment">// è‡ªåŠ¨ç”Ÿæˆé”®ä¿¡æ¯</span></div><div class="line">       <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">       <span class="keyword">do</span> &#123;</div><div class="line">           <span class="comment">// Column æ’å…¥å­—æ®µ</span></div><div class="line">           sqlParser.getLexer().nextToken();</div><div class="line">           String columnName = SQLUtil.getExactlyValue(sqlParser.getLexer().getCurrentToken().getLiterals());</div><div class="line">           result.add(<span class="keyword">new</span> Column(columnName, tableName));</div><div class="line">           sqlParser.getLexer().nextToken();</div><div class="line">           <span class="comment">// è‡ªåŠ¨ç”Ÿæˆé”®</span></div><div class="line">           <span class="keyword">if</span> (generateKeyColumn.isPresent() &amp;&amp; generateKeyColumn.get().equalsIgnoreCase(columnName)) &#123;</div><div class="line">               generateKeyColumnIndex = count;</div><div class="line">           &#125;</div><div class="line">           count++;</div><div class="line">       &#125; <span class="keyword">while</span> (!sqlParser.equalAny(Symbol.RIGHT_PAREN) &amp;&amp; !sqlParser.equalAny(Assist.END));</div><div class="line">       <span class="comment">//</span></div><div class="line">       insertStatement.setColumnsListLastPosition(sqlParser.getLexer().getCurrentToken().getEndPosition() - sqlParser.getLexer().getCurrentToken().getLiterals().length());</div><div class="line">       <span class="comment">//</span></div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">   &#125;</div><div class="line">   insertStatement.getColumns().addAll(result);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.3 #parseValues()</h2>
<p>è§£æ<strong>å€¼å­—æ®µ</strong></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æå€¼å­—æ®µ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseValues</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">boolean</span> parsed = <span class="keyword">false</span>;</div><div class="line">   <span class="keyword">do</span> &#123;</div><div class="line">       <span class="keyword">if</span> (parsed) &#123; <span class="comment">// åªå…è®¸INSERT INTO ä¸€æ¡</span></div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support multiple insert"</span>);</div><div class="line">       &#125;</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       sqlParser.accept(Symbol.LEFT_PAREN);</div><div class="line">       <span class="comment">// è§£æè¡¨è¾¾å¼</span></div><div class="line">       List&lt;SQLExpression&gt; sqlExpressions = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">       <span class="keyword">do</span> &#123;</div><div class="line">           sqlExpressions.add(sqlParser.parseExpression());</div><div class="line">       &#125; <span class="keyword">while</span> (sqlParser.skipIfEqual(Symbol.COMMA));</div><div class="line">       <span class="comment">//</span></div><div class="line">       insertStatement.setValuesListLastPosition(sqlParser.getLexer().getCurrentToken().getEndPosition() - sqlParser.getLexer().getCurrentToken().getLiterals().length());</div><div class="line">       <span class="comment">// è§£æå€¼å­—æ®µ</span></div><div class="line">       <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">       <span class="keyword">for</span> (Column each : insertStatement.getColumns()) &#123;</div><div class="line">           SQLExpression sqlExpression = sqlExpressions.get(count);</div><div class="line">           insertStatement.getConditions().add(<span class="keyword">new</span> Condition(each, sqlExpression), shardingRule);</div><div class="line">           <span class="keyword">if</span> (generateKeyColumnIndex == count) &#123; <span class="comment">// è‡ªåŠ¨ç”Ÿæˆé”®</span></div><div class="line">               insertStatement.setGeneratedKey(createGeneratedKey(each, sqlExpression));</div><div class="line">           &#125;</div><div class="line">           count++;</div><div class="line">       &#125;</div><div class="line">       sqlParser.accept(Symbol.RIGHT_PAREN);</div><div class="line">       parsed = <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">while</span> (sqlParser.equalAny(Symbol.COMMA)); <span class="comment">// å­—æ®µä»¥ "," åˆ†éš”</span></div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ›å»º è‡ªåŠ¨ç”Ÿæˆé”®</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> column å­—æ®µ</div><div class="line">* <span class="doctag">@param</span> sqlExpression è¡¨è¾¾å¼</div><div class="line">* <span class="doctag">@return</span> è‡ªåŠ¨ç”Ÿæˆé”®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> GeneratedKey <span class="title">createGeneratedKey</span><span class="params">(<span class="keyword">final</span> Column column, <span class="keyword">final</span> SQLExpression sqlExpression)</span> </span>&#123;</div><div class="line">   GeneratedKey result;</div><div class="line">   <span class="keyword">if</span> (sqlExpression <span class="keyword">instanceof</span> SQLPlaceholderExpression) &#123; <span class="comment">// å ä½ç¬¦</span></div><div class="line">       result = <span class="keyword">new</span> GeneratedKey(column.getName(), ((SQLPlaceholderExpression) sqlExpression).getIndex(), <span class="keyword">null</span>);</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlExpression <span class="keyword">instanceof</span> SQLNumberExpression) &#123; <span class="comment">// æ•°å­—</span></div><div class="line">       result = <span class="keyword">new</span> GeneratedKey(column.getName(), -<span class="number">1</span>, ((SQLNumberExpression) sqlExpression).getNumber());</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ShardingJdbcException(<span class="string">"Generated key only support number."</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>3.4.1 GeneratedKey</h3>
<p>è‡ªåŠ¨ç”Ÿæˆé”®ï¼Œ<strong>å±äºåˆ†ç‰‡ä¸Šä¸‹æ–‡ä¿¡æ¯</strong>ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GeneratedKey</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å­—æ®µ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String column;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç¬¬å‡ ä¸ªå ä½ç¬¦</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å€¼</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Number value;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>3.4.2 Condition</h3>
<p>æ¡ä»¶å¯¹è±¡ï¼Œ<strong>å±äºåˆ†ç‰‡ä¸Šä¸‹æ–‡ä¿¡æ¯</strong>ã€‚åœ¨<strong>æ’å…¥SQLè§£æ</strong>é‡Œå­˜å‚¨<strong>å½±å“åˆ†ç‰‡çš„å€¼å­—æ®µ</strong>ã€‚åç»­<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL è·¯ç”±ã€‹</a> ä¼šä¸“é—¨åˆ†äº«è¿™å—ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Condition</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å­—æ®µ</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Column column;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥å…¶å®ƒå±æ€§</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Column</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ—å</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¡¨å</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String tableName;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.4 #parseCustomizedInsert()</h2>
<p>è§£æ<strong>ç¬¬äºŒç§æ’å…¥SQL</strong>ï¼š<code>INSERT SET</code>ã€‚ä¾‹å¦‚ï¼š</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">test</span> <span class="keyword">SET</span> <span class="keyword">id</span> = <span class="number">4</span>  <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> <span class="keyword">name</span> = <span class="string">'doubi'</span>, <span class="keyword">name</span> = <span class="string">'hehe'</span>;</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">test</span> <span class="keyword">SET</span> <span class="keyword">id</span> = <span class="number">4</span>, <span class="keyword">name</span> = <span class="string">'hehe'</span>;</div></pre></td></tr></table></figure></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseInsertSet</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">do</span> &#123;</div><div class="line">       getSqlParser().getLexer().nextToken();</div><div class="line">       <span class="comment">// æ’å…¥å­—æ®µ</span></div><div class="line">       Column column = <span class="keyword">new</span> Column(SQLUtil.getExactlyValue(getSqlParser().getLexer().getCurrentToken().getLiterals()), getInsertStatement().getTables().getSingleTableName());</div><div class="line">       getSqlParser().getLexer().nextToken();</div><div class="line">       <span class="comment">// ç­‰å·</span></div><div class="line">       getSqlParser().accept(Symbol.EQ);</div><div class="line">       <span class="comment">// ã€å€¼ã€‘è¡¨è¾¾å¼</span></div><div class="line">       SQLExpression sqlExpression;</div><div class="line">       <span class="keyword">if</span> (getSqlParser().equalAny(Literals.INT)) &#123;</div><div class="line">           sqlExpression = <span class="keyword">new</span> SQLNumberExpression(Integer.parseInt(getSqlParser().getLexer().getCurrentToken().getLiterals()));</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getSqlParser().equalAny(Literals.FLOAT)) &#123;</div><div class="line">           sqlExpression = <span class="keyword">new</span> SQLNumberExpression(Double.parseDouble(getSqlParser().getLexer().getCurrentToken().getLiterals()));</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getSqlParser().equalAny(Literals.CHARS)) &#123;</div><div class="line">           sqlExpression = <span class="keyword">new</span> SQLTextExpression(getSqlParser().getLexer().getCurrentToken().getLiterals());</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getSqlParser().equalAny(DefaultKeyword.NULL)) &#123;</div><div class="line">           sqlExpression = <span class="keyword">new</span> SQLIgnoreExpression();</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getSqlParser().equalAny(Symbol.QUESTION)) &#123;</div><div class="line">           sqlExpression = <span class="keyword">new</span> SQLPlaceholderExpression(getSqlParser().getParametersIndex());</div><div class="line">           getSqlParser().increaseParametersIndex();</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">""</span>);</div><div class="line">       &#125;</div><div class="line">       getSqlParser().getLexer().nextToken();</div><div class="line">       <span class="comment">// Condition</span></div><div class="line">       <span class="keyword">if</span> (getSqlParser().equalAny(Symbol.COMMA, DefaultKeyword.ON, Assist.END)) &#123;</div><div class="line">           getInsertStatement().getConditions().add(<span class="keyword">new</span> Condition(column, sqlExpression), getShardingRule());</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           getSqlParser().skipUntil(Symbol.COMMA, DefaultKeyword.ON);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">while</span> (getSqlParser().equalAny(Symbol.COMMA)); <span class="comment">// å­—æ®µä»¥ "," åˆ†éš”</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.5 #appendGenerateKey()</h2>
<p>å½“è¡¨è®¾ç½®<strong>è‡ªåŠ¨ç”Ÿæˆé”®</strong>ï¼Œå¹¶ä¸”æ’å…¥SQL<strong>æ²¡</strong>å†™è‡ªå¢å­—æ®µï¼Œå¢åŠ è¯¥å­—æ®µã€‚ä¾‹å¦‚ï¼š</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">// ä¸»é”®ä¸ºuser_id</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user(nickname, age) <span class="keyword">VALUES</span> (?, ?)</div></pre></td></tr></table></figure></p>
<p>åç»­ SQL æ”¹å†™ä¼šç”Ÿæˆè¯¥è‡ªå¢ç¼–å·ï¼Œå¹¶æ”¹å†™è¯¥ SQLã€‚åç»­<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL æ”¹å†™ã€‹</a> ä¼šä¸“é—¨åˆ†äº«è¿™å—ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendGenerateKey</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// å½“è¡¨è®¾ç½®è‡ªåŠ¨ç”Ÿæˆé”®ï¼Œå¹¶ä¸”æ’å…¥SQLæ²¡å†™è‡ªå¢å­—æ®µ</span></div><div class="line">   String tableName = insertStatement.getTables().getSingleTableName();</div><div class="line">   Optional&lt;String&gt; generateKeyColumn = shardingRule.getGenerateKeyColumn(tableName);</div><div class="line">   <span class="keyword">if</span> (!generateKeyColumn.isPresent() || <span class="keyword">null</span> != insertStatement.getGeneratedKey()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ItemsToken</span></div><div class="line">   ItemsToken columnsToken = <span class="keyword">new</span> ItemsToken(insertStatement.getColumnsListLastPosition());</div><div class="line">   columnsToken.getItems().add(generateKeyColumn.get());</div><div class="line">   insertStatement.getSqlTokens().add(columnsToken);</div><div class="line">   <span class="comment">// GeneratedKeyToken</span></div><div class="line">   insertStatement.getSqlTokens().add(<span class="keyword">new</span> GeneratedKeyToken(insertStatement.getValuesListLastPosition()));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>3.5.1 GeneratedKeyToken</h3>
<p>è‡ªå¢ä¸»é”®æ ‡è®°å¯¹è±¡ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GeneratedKeyToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>666. å½©è›‹</h1>
<p>ğŸ˜ˆ æ˜¯ä¸æ˜¯æ¯”<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-3/?self">ã€ŠSQL è§£æï¼ˆä¸‰ï¼‰ä¹‹æ’å…¥SQLã€‹</a>ç®€å•å¾ˆå¤šã€‚</p>
<p><strong>é“å‹ï¼Œå¯å¦åˆ†äº«ä¸€æ³¢ã€æœ¬æ–‡ã€‘åˆ°æœ‹å‹åœˆ</strong>ã€‚</p>
<p><strong>ç»§ç»­åŠ æ²¹æ›´æ–°ï¼</strong></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;o
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆä¸‰ï¼‰ä¹‹æŸ¥è¯¢SQL</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-parse-3/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-parse-3/</id>
    <published>2017-07-26T16:00:00.000Z</published>
    <updated>2017-08-10T17:25:27.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Sharding-JDBC 1.5.0 æ­£å¼ç‰ˆ</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. SelectStatement</a>
<ul>
<li><a href="#">2.1 AbstractSQLStatement</a></li>
<li><a href="#">2.2 SQLToken</a></li>
</ul>
</li>
<li><a href="#">3. #query()</a>
<ul>
<li><a href="#">3.1 #parseDistinct()</a></li>
<li><a href="#">3.2 #parseSelectList()</a></li>
<li><a href="#">3.3 #skipToFrom()</a></li>
<li><a href="#">3.4 #parseFrom()</a></li>
<li><a href="#">3.5 #parseWhere()</a></li>
<li><a href="#">3.6 #parseGroupBy()</a></li>
<li><a href="#">3.7 #parseOrderBy()</a></li>
<li><a href="#">3.8 #parseLimit()</a></li>
<li><a href="#">3.9 #queryRest()</a></li>
</ul>
</li>
<li><a href="#">4. appendDerivedç­‰æ–¹æ³•</a>
<ul>
<li><a href="#">4.1 appendAvgDerivedColumns</a></li>
<li><a href="#">4.2 appendDerivedOrderColumns</a></li>
<li><a href="#">4.3 ItemsToken</a></li>
<li><a href="#">4.4 appendDerivedOrderBy()</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡å‰ç½®é˜…è¯»ï¼š</p>
<ul>
<li><a href="http://www.yunai.me/Sharding-JDBC/sql-parse-1/?self">ã€ŠSQL è§£æï¼ˆä¸€ï¼‰ä¹‹è¯æ³•è§£æã€‹</a></li>
<li><a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹</a></li>
</ul>
<p>æœ¬æ–‡åˆ†äº«<strong>æ’å…¥SQLè§£æ</strong>çš„æºç å®ç°ã€‚</p>
<p>ç”±äºæ¯ä¸ªæ•°æ®åº“åœ¨éµå®ˆ SQL è¯­æ³•è§„èŒƒçš„åŒæ—¶ï¼Œåˆæœ‰å„è‡ªç‹¬ç‰¹çš„è¯­æ³•ã€‚å› æ­¤ï¼Œåœ¨ Sharding-JDBC é‡Œæ¯ä¸ªæ•°æ®åº“éƒ½æœ‰è‡ªå·±çš„ SELECT è¯­å¥çš„è§£æå™¨å®ç°æ–¹å¼ï¼Œå½“ç„¶ç»å¤§éƒ¨åˆ†é€»è¾‘æ˜¯ç›¸åŒçš„ã€‚<strong>æœ¬æ–‡ä¸»è¦åˆ†äº«ç¬”è€…æœ€å¸¸ç”¨çš„ MySQL æŸ¥è¯¢</strong>ã€‚</p>
<p>æŸ¥è¯¢ SQL è§£æä¸»æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/03.png" alt=""></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> SelectStatement <span class="title">parse</span><span class="params">()</span> </span>&#123;</div><div class="line">   query();</div><div class="line">   parseOrderBy();</div><div class="line">   customizedSelect();</div><div class="line">   appendDerivedColumns();</div><div class="line">   appendDerivedOrderBy();</div><div class="line">   <span class="keyword">return</span> selectStatement;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#parseOrderBy()</code> ï¼šå¯¹äº MySQL æŸ¥è¯¢è¯­å¥è§£æå™¨æ— æ•ˆæœï¼Œå› ä¸ºå·²ç»åœ¨ <code>#query()</code> æ–¹æ³•é‡Œé¢å·²ç»è°ƒç”¨ <code>#parseOrderBy()</code>ï¼Œå› æ­¤å›¾ä¸­çœç•¥è¯¥æ–¹æ³•ã€‚</li>
<li><code>#customizedSelect()</code> ï¼šOracleã€SQLServer æŸ¥è¯¢è¯­å¥è§£æå™¨é‡å†™äº†è¯¥æ–¹æ³•ï¼Œå¯¹äº MySQL æŸ¥è¯¢è§£æå™¨æ˜¯ä¸ªç©ºæ–¹æ³•ï¼Œè¿›è¡Œçœç•¥ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å•ç‹¬å»ç ”ç©¶ç ”ç©¶ã€‚</li>
</ul>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>
ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<p>ğŸ‘¼ æŸ¥è¯¢è¯­å¥è§£ææ˜¯å¢åˆ æ”¹æŸ¥é‡Œé¢<strong>æœ€çµæ´»ä¹Ÿæ˜¯æœ€å¤æ‚çš„</strong>ï¼Œå¸Œæœ›å¤§å®¶æœ‰è€å¿ƒçœ‹å®Œæœ¬æ–‡ã€‚ç†è§£æŸ¥è¯¢è¯­å¥è§£æï¼Œå¦å¤–ä¸‰ç§è¯­å¥ç†è§£èµ·æ¥ç®€ç›´æ˜¯ SO EASYã€‚éª—äººæ˜¯å°ç‹—ğŸ¶ã€‚<br>
ğŸ™‚å¦‚æœå¯¹æœ¬æ–‡æœ‰ä¸ç†è§£çš„åœ°æ–¹ï¼Œå¯ä»¥ç»™æˆ‘çš„å…¬ä¼—å·**ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">èŠ‹è‰¿çš„åç«¯å°å±‹</a>ï¼‰<strong>ç•™è¨€ï¼Œæˆ‘ä¼š</strong>é€æ¡è®¤çœŸè€å¿ƒ**å›å¤ã€‚éª—äººæ˜¯å°çŒªğŸ·ã€‚</p>
<p>OKï¼Œä¸åºŸè¯å•¦ï¼Œå¼€å§‹æˆ‘ä»¬è¿™æ®µç—›å¹¶å¿«ä¹çš„æ—…é€”ã€‚</p>
<h1>2. SelectStatement</h1>
<p>ğŸ™‚ <strong>æœ¬èŠ‚åªä»‹ç»è¿™äº›ç±»ï¼Œæ–¹ä¾¿æœ¬æ–‡ä¸‹èŠ‚åˆ†ææºç å®ç°å¤§å®¶èƒ½çŸ¥é“è®¤è¯†å®ƒä»¬</strong> ğŸ™‚</p>
<p>SelectStatementï¼ŒæŸ¥è¯¢è¯­å¥è§£æç»“æœå¯¹è±¡ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SelectStatement.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectStatement</span> <span class="keyword">extends</span> <span class="title">AbstractSQLStatement</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ˜¯å¦è¡Œ DISTINCT / DISTINCTROW / UNION</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> distinct;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ˜¯å¦æŸ¥è¯¢æ‰€æœ‰å­—æ®µï¼Œå³ SELECT *</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> containStar;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æœ€åä¸€ä¸ªæŸ¥è¯¢é¡¹ä¸‹ä¸€ä¸ª Token çš„å¼€å§‹ä½ç½®</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #items</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> selectListLastPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æœ€åä¸€ä¸ªåˆ†ç»„é¡¹ä¸‹ä¸€ä¸ª Token çš„å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> groupByLastPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æŸ¥è¯¢é¡¹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;SelectItem&gt; items = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ†ç»„é¡¹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;OrderItem&gt; groupByItems = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ’åºé¡¹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;OrderItem&gt; orderByItems = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ†é¡µ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Limit limit;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å¯¹å±æ€§æŒ‰ç…§ç±»å‹è¿›è¡Œå½’ç±»ï¼š</p>
<ul>
<li>ç‰¹æ®Š
<ul>
<li>distinct</li>
</ul>
</li>
<li>æŸ¥è¯¢å­—æ®µ
<ul>
<li>containStar</li>
<li>items</li>
<li>selectListLastPosition</li>
</ul>
</li>
<li>åˆ†ç»„æ¡ä»¶
<ul>
<li>groupByItems</li>
<li>groupByLastPosition</li>
</ul>
</li>
<li>æ’åºæ¡ä»¶
<ul>
<li>orderByItems</li>
</ul>
</li>
<li>åˆ†é¡µæ¡ä»¶
<ul>
<li>limit</li>
</ul>
</li>
</ul>
<h2>2.1 AbstractSQLStatement</h2>
<p>å¢åˆ æ”¹æŸ¥è§£æç»“æœå¯¹è±¡çš„<strong>æŠ½è±¡çˆ¶ç±»</strong>ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractSQLStatement</span> <span class="keyword">implements</span> <span class="title">SQLStatement</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL ç±»å‹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SQLType type;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¡¨</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Tables tables = <span class="keyword">new</span> Tables();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¿‡æ»¤æ¡ä»¶ã€‚</div><div class="line">     * åªæœ‰å¯¹è·¯ç”±ç»“æœæœ‰å½±å“çš„æ¡ä»¶ï¼Œæ‰æ·»åŠ è¿›æ•°ç»„</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Conditions conditions = <span class="keyword">new</span> Conditions();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQLæ ‡è®°å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>2.2 SQLToken</h2>
<p>SQLTokenï¼ŒSQLæ ‡è®°å¯¹è±¡æ¥å£ï¼ŒSQL æ”¹å†™æ—¶ä½¿ç”¨åˆ°ã€‚ä¸‹é¢éƒ½æ˜¯å®ƒçš„å®ç°ç±»ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">ç±»</th>
<th style="text-align:left">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GeneratedKeyToken</td>
<td style="text-align:left">è‡ªå¢ä¸»é”®æ ‡è®°å¯¹è±¡</td>
</tr>
<tr>
<td style="text-align:left">TableToken</td>
<td style="text-align:left">è¡¨æ ‡è®°å¯¹è±¡</td>
</tr>
<tr>
<td style="text-align:left">ItemsToken</td>
<td style="text-align:left">é€‰æ‹©é¡¹æ ‡è®°å¯¹è±¡</td>
</tr>
<tr>
<td style="text-align:left">OffsetToken</td>
<td style="text-align:left">åˆ†é¡µåç§»é‡æ ‡è®°å¯¹è±¡</td>
</tr>
<tr>
<td style="text-align:left">OrderByToken</td>
<td style="text-align:left">æ’åºæ ‡è®°å¯¹è±¡</td>
</tr>
<tr>
<td style="text-align:left">RowCountToken</td>
<td style="text-align:left">åˆ†é¡µé•¿åº¦æ ‡è®°å¯¹è±¡</td>
</tr>
</tbody>
</table>
<h1>3. #query()</h1>
<p><code>#query()</code>ï¼ŒæŸ¥è¯¢ SQL è§£æã€‚</p>
<p><strong>MySQL SELECT Syntax</strong>ï¼š</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">// https://dev.mysql.com/doc/refman/5.7/en/select.html</div><div class="line"><span class="keyword">SELECT</span></div><div class="line">    [ALL | <span class="keyword">DISTINCT</span> | <span class="keyword">DISTINCTROW</span> ]</div><div class="line">      [<span class="keyword">HIGH_PRIORITY</span>]</div><div class="line">      [<span class="keyword">STRAIGHT_JOIN</span>]</div><div class="line">      [<span class="keyword">SQL_SMALL_RESULT</span>] [<span class="keyword">SQL_BIG_RESULT</span>] [<span class="keyword">SQL_BUFFER_RESULT</span>]</div><div class="line">      [<span class="keyword">SQL_CACHE</span> | SQL_NO_CACHE] [<span class="keyword">SQL_CALC_FOUND_ROWS</span>]</div><div class="line">    select_expr [, select_expr ...]</div><div class="line">    [<span class="keyword">FROM</span> table_references</div><div class="line">      [<span class="keyword">PARTITION</span> partition_list]</div><div class="line">    [<span class="keyword">WHERE</span> where_condition]</div><div class="line">    [<span class="keyword">GROUP</span> <span class="keyword">BY</span> &#123;col_name | expr | <span class="keyword">position</span>&#125;</div><div class="line">      [<span class="keyword">ASC</span> | <span class="keyword">DESC</span>], ... [<span class="keyword">WITH</span> <span class="keyword">ROLLUP</span>]]</div><div class="line">    [<span class="keyword">HAVING</span> where_condition]</div><div class="line">    [<span class="keyword">ORDER</span> <span class="keyword">BY</span> &#123;col_name | expr | <span class="keyword">position</span>&#125;</div><div class="line">      [<span class="keyword">ASC</span> | <span class="keyword">DESC</span>], ...]</div><div class="line">    [<span class="keyword">LIMIT</span> &#123;[<span class="keyword">offset</span>,] <span class="keyword">row_count</span> | <span class="keyword">row_count</span> <span class="keyword">OFFSET</span> <span class="keyword">offset</span>&#125;]</div><div class="line">    [<span class="keyword">PROCEDURE</span> procedure_name(argument_list)]</div><div class="line">    [<span class="keyword">INTO</span> <span class="keyword">OUTFILE</span> <span class="string">'file_name'</span></div><div class="line">        [<span class="built_in">CHARACTER</span> <span class="keyword">SET</span> charset_name]</div><div class="line">        export_options</div><div class="line">      | <span class="keyword">INTO</span> <span class="keyword">DUMPFILE</span> <span class="string">'file_name'</span></div><div class="line">      | <span class="keyword">INTO</span> var_name [, var_name]]</div><div class="line">    [<span class="keyword">FOR</span> <span class="keyword">UPDATE</span> | <span class="keyword">LOCK</span> <span class="keyword">IN</span> <span class="keyword">SHARE</span> <span class="keyword">MODE</span>]]</div></pre></td></tr></table></figure></p>
<p>å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/04.png" alt=""></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MySQLSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (getSqlParser().equalAny(DefaultKeyword.SELECT)) &#123;</div><div class="line">       getSqlParser().getLexer().nextToken();</div><div class="line">       parseDistinct();</div><div class="line">       getSqlParser().skipAll(MySQLKeyword.HIGH_PRIORITY, DefaultKeyword.STRAIGHT_JOIN, MySQLKeyword.SQL_SMALL_RESULT, MySQLKeyword.SQL_BIG_RESULT, MySQLKeyword.SQL_BUFFER_RESULT,</div><div class="line">               MySQLKeyword.SQL_CACHE, MySQLKeyword.SQL_NO_CACHE, MySQLKeyword.SQL_CALC_FOUND_ROWS);</div><div class="line">       parseSelectList(); <span class="comment">// è§£æ æŸ¥è¯¢å­—æ®µ</span></div><div class="line">       skipToFrom(); <span class="comment">// è·³åˆ° FROM å¤„</span></div><div class="line">   &#125;</div><div class="line">   parseFrom();<span class="comment">// è§£æ è¡¨ï¼ˆJOIN ON / FROM å•&amp;å¤šè¡¨ï¼‰</span></div><div class="line">   parseWhere(); <span class="comment">// è§£æ WHERE æ¡ä»¶</span></div><div class="line">   parseGroupBy(); <span class="comment">// è§£æ Group By å’Œ Havingï¼ˆç›®å‰ä¸æ”¯æŒï¼‰æ¡ä»¶</span></div><div class="line">   parseOrderBy(); <span class="comment">// è§£æ Order By æ¡ä»¶</span></div><div class="line">   parseLimit(); <span class="comment">// è§£æ åˆ†é¡µ Limit æ¡ä»¶</span></div><div class="line">   <span class="comment">// [PROCEDURE] æš‚ä¸æ”¯æŒ</span></div><div class="line">   <span class="keyword">if</span> (getSqlParser().equalAny(DefaultKeyword.PROCEDURE)) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(getSqlParser().getLexer().getCurrentToken().getType());</div><div class="line">   &#125;</div><div class="line">   queryRest();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.1 #parseDistinct()</h2>
<p>è§£æ DISTINCTã€DISTINCTROWã€UNION è°“è¯­ã€‚</p>
<p>æ ¸å¿ƒä»£ç ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseDistinct</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.DISTINCT, DefaultKeyword.DISTINCTROW, DefaultKeyword.UNION)) &#123;</div><div class="line">       selectStatement.setDistinct(<span class="keyword">true</span>);</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       <span class="keyword">if</span> (hasDistinctOn() &amp;&amp; sqlParser.equalAny(DefaultKeyword.ON)) &#123; <span class="comment">// PostgreSQL ç‹¬æœ‰è¯­æ³•ï¼š DISTINCT ON</span></div><div class="line">           sqlParser.getLexer().nextToken();</div><div class="line">           sqlParser.skipParentheses();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.ALL)) &#123;</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ­¤å¤„ DISTINCT å’Œ DISTINCT(å­—æ®µ) ä¸åŒï¼Œå®ƒæ˜¯é’ˆå¯¹æŸ¥è¯¢ç»“æœåšå»é‡ï¼Œå³æ•´è¡Œé‡å¤ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p>
<p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">mysql&gt; SELECT item_id, order_id FROM t_order_item;</div><div class="line">+---------+----------+</div><div class="line">| item_id | order_id |</div><div class="line">+---------+----------+</div><div class="line">| 1       | 1        |</div><div class="line">| 1       | 1        |</div><div class="line">+---------+----------+</div><div class="line">2 rows in set (0.03 sec)</div><div class="line"></div><div class="line">mysql&gt; SELECT DISTINCT item_id, order_id FROM t_order_item;</div><div class="line">+---------+----------+</div><div class="line">| item_id | order_id |</div><div class="line">+---------+----------+</div><div class="line">| 1       | 1        |</div><div class="line">+---------+----------+</div><div class="line">1 rows in set (0.02 sec)</div></pre></td></tr></table></figure></p>
<h2>3.2 #parseSelectList()</h2>
<table>
<thead>
<tr>
<th>SELECT</th>
<th>o.user_id</th>
<th>COUNT(DISTINCT i.item_id) AS item_count</th>
<th>MAX(i.item_id)</th>
<th>FROM</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>SelectItem</td>
<td>SelectItem</td>
<td>SelectItem</td>
<td></td>
</tr>
</tbody>
</table>
<p>å°† SQL <strong>æŸ¥è¯¢å­—æ®µ</strong> æŒ‰ç…§<strong>é€—å·( , )<strong>åˆ‡å‰²æˆ</strong>å¤šä¸ª</strong>é€‰æ‹©é¡¹( SelectItem)ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseSelectList</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">do</span> &#123;</div><div class="line">       <span class="comment">// è§£æå•ä¸ªé€‰æ‹©é¡¹</span></div><div class="line">       parseSelectItem();</div><div class="line">   &#125; <span class="keyword">while</span> (sqlParser.skipIfEqual(Symbol.COMMA));</div><div class="line">   <span class="comment">// è®¾ç½® æœ€åä¸€ä¸ªæŸ¥è¯¢é¡¹ä¸‹ä¸€ä¸ª Token çš„å¼€å§‹ä½ç½®</span></div><div class="line">   selectStatement.setSelectListLastPosition(sqlParser.getLexer().getCurrentToken().getEndPosition() - sqlParser.getLexer().getCurrentToken().getLiterals().length());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>3.2.1 SelectItem é€‰æ‹©é¡¹</h3>
<p>SelectItem æ¥å£ï¼Œ<strong>å±äºåˆ†ç‰‡ä¸Šä¸‹æ–‡ä¿¡æ¯</strong>ï¼Œæœ‰ 2 ä¸ªå®ç°ç±»ï¼š</p>
<ul>
<li>CommonSelectItem ï¼šé€šç”¨é€‰æ‹©é¡¹</li>
<li>AggregationSelectItem ï¼šèšåˆé€‰æ‹©é¡¹</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/01.png" alt=""></p>
<p>è§£æå•ä¸ª SelectItem æ ¸å¿ƒä»£ç ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSelectItem</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ç¬¬å››ç§æƒ…å†µï¼ŒSQL Server ç‹¬æœ‰</span></div><div class="line">   <span class="keyword">if</span> (isRowNumberSelectItem()) &#123;</div><div class="line">       selectStatement.getItems().add(parseRowNumberSelectItem());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   sqlParser.skipIfEqual(DefaultKeyword.CONNECT_BY_ROOT); <span class="comment">// Oracle ç‹¬æœ‰ï¼šhttps://docs.oracle.com/cd/B19306_01/server.102/b14200/operators004.htm</span></div><div class="line">   String literals = sqlParser.getLexer().getCurrentToken().getLiterals();</div><div class="line">   <span class="comment">// ç¬¬ä¸€ç§æƒ…å†µï¼Œ* é€šç”¨é€‰æ‹©é¡¹ï¼ŒSELECT *</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(Symbol.STAR) || Symbol.STAR.getLiterals().equals(SQLUtil.getExactlyValue(literals))) &#123;</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       selectStatement.getItems().add(<span class="keyword">new</span> CommonSelectItem(Symbol.STAR.getLiterals(), sqlParser.parseAlias()));</div><div class="line">       selectStatement.setContainStar(<span class="keyword">true</span>);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç¬¬äºŒç§æƒ…å†µï¼Œèšåˆé€‰æ‹©é¡¹</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.MAX, DefaultKeyword.MIN, DefaultKeyword.SUM, DefaultKeyword.AVG, DefaultKeyword.COUNT)) &#123;</div><div class="line">       selectStatement.getItems().add(<span class="keyword">new</span> AggregationSelectItem(AggregationType.valueOf(literals.toUpperCase()), sqlParser.skipParentheses(), sqlParser.parseAlias()));</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç¬¬ä¸‰ç§æƒ…å†µï¼Œé * é€šç”¨é€‰æ‹©é¡¹</span></div><div class="line">   StringBuilder expression = <span class="keyword">new</span> StringBuilder();</div><div class="line">   Token lastToken = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">while</span> (!sqlParser.equalAny(DefaultKeyword.AS) &amp;&amp; !sqlParser.equalAny(Symbol.COMMA) &amp;&amp; !sqlParser.equalAny(DefaultKeyword.FROM) &amp;&amp; !sqlParser.equalAny(Assist.END)) &#123;</div><div class="line">       String value = sqlParser.getLexer().getCurrentToken().getLiterals();</div><div class="line">       <span class="keyword">int</span> position = sqlParser.getLexer().getCurrentToken().getEndPosition() - value.length();</div><div class="line">       expression.append(value);</div><div class="line">       lastToken = sqlParser.getLexer().getCurrentToken();</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       <span class="keyword">if</span> (sqlParser.equalAny(Symbol.DOT)) &#123;</div><div class="line">           selectStatement.getSqlTokens().add(<span class="keyword">new</span> TableToken(position, value));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ä¸å¸¦ ASï¼Œå¹¶ä¸”æœ‰åˆ«åï¼Œå¹¶ä¸”åˆ«åä¸ç­‰äºè‡ªå·±ï¼ˆtipsï¼šè¿™é‡Œé‡ç‚¹çœ‹ã€‚åˆ¤æ–­è¿™ä¹ˆå¤æ‚çš„åŸå› ï¼šé˜²æ­¢substringæ“ä½œæˆªå–ç»“æœé”™è¯¯ï¼‰</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != lastToken &amp;&amp; Literals.IDENTIFIER == lastToken.getType()</div><div class="line">           &amp;&amp; !isSQLPropertyExpression(expression, lastToken) <span class="comment">// è¿‡æ»¤æ‰ï¼Œåˆ«åæ˜¯è‡ªå·±çš„æƒ…å†µã€1ã€‘ï¼ˆä¾‹å¦‚ï¼ŒSELECT u.user_id u.user_id FROM t_userï¼‰</span></div><div class="line">           &amp;&amp; !expression.toString().equals(lastToken.getLiterals())) &#123; <span class="comment">// è¿‡æ»¤æ‰ï¼Œæ— åˆ«åçš„æƒ…å†µã€2ã€‘ï¼ˆä¾‹å¦‚ï¼ŒSELECT user_id FROM t_userï¼‰</span></div><div class="line">       selectStatement.getItems().add(</div><div class="line">               <span class="keyword">new</span> CommonSelectItem(SQLUtil.getExactlyValue(expression.substring(<span class="number">0</span>, expression.lastIndexOf(lastToken.getLiterals()))), Optional.of(lastToken.getLiterals())));</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å¸¦ ASï¼ˆä¾‹å¦‚ï¼ŒSELECT user_id AS userIdï¼‰ æˆ–è€… æ— åˆ«åï¼ˆä¾‹å¦‚ï¼ŒSELECT user_idï¼‰</span></div><div class="line">   selectStatement.getItems().add(<span class="keyword">new</span> CommonSelectItem(SQLUtil.getExactlyValue(expression.toString()), sqlParser.parseAlias()));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸€å…±åˆ†æˆ 4 ç§å¤§çš„æƒ…å†µï¼Œæˆ‘ä»¬æ¥é€æ¡æ¢³ç†ï¼š</p>
<ul>
<li>ç¬¬ä¸€ç§ï¼š<strong><code>*</code> é€šç”¨é€‰æ‹©é¡¹</strong>ï¼š<br>
ä¾‹å¦‚ï¼Œ<code>SELECT * FROM t_user</code> çš„ <code>*</code>ã€‚<br>
ä¸ºä»€ä¹ˆè¦åŠ    <code>Symbol.STAR.getLiterals().equals(SQLUtil.getExactlyValue(literals))</code> åˆ¤æ–­å‘¢ï¼Ÿ</li>
</ul>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="string">`*`</span> <span class="keyword">FROM</span> t_user; // ä¹Ÿèƒ½è¾¾åˆ°æŸ¥è¯¢æ‰€æœ‰å­—æ®µçš„æ•ˆæœ</div></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬äºŒç§ï¼š<strong>èšåˆé€‰æ‹©é¡¹</strong>ï¼š<br>
ä¾‹å¦‚ï¼Œ<code>SELECT COUNT(user_id) FROM t_user</code> çš„ <code>COUNT(user_id)</code>ã€‚</li>
</ul>
<p>è§£æç»“æœ AggregationSelectItemï¼š<br>
<img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/05.png" alt=""></p>
<p><code>sqlParser.skipParentheses()</code> è§£æè§<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹çš„AbstractParserå°èŠ‚</a>ã€‚</p>
<ul>
<li>ç¬¬ä¸‰ç§ï¼š<strong>é <code>*</code> é€šç”¨é€‰æ‹©é¡¹</strong>ï¼š</li>
</ul>
<p>ä¾‹å¦‚ï¼Œ<code>SELECT user_id FROM t_user</code>ã€‚</p>
<p>ä»å®ç°ä¸Šï¼Œé€»è¾‘ä¼šå¤æ‚å¾ˆå¤šã€‚ç›¸æ¯”ç¬¬ä¸€ç§ï¼Œå¯ä»¥æ ¹æ® <code>*</code> åšå­—æ®µåˆ¤æ–­ï¼›ç›¸æ¯”ç¬¬äºŒç§ï¼Œå¯ä»¥ä½¿ç”¨ <code>(</code> å’Œ <code>)</code> åšå­—æ®µåˆ¤æ–­ã€‚èƒ½å¤Ÿåˆ¤æ–­ä¸€ä¸ª<strong>åŒ…å«åˆ«åçš„</strong> SelectItem ç»“æŸæœ‰ 4 ç§ Tokenï¼Œæ ¹æ®ç»“æŸæ–¹å¼æˆ‘ä»¬åˆ†æˆ 2 ç§ï¼š</p>
<ul>
<li>DefaultKeyword.AS ï¼šèƒ½å¤Ÿæ¥è§¦å‡º SelectItem å­—æ®µï¼Œ<strong>å³ä¸åŒ…å«åˆ«å</strong>ã€‚ä¾‹å¦‚ï¼Œ<code>SELECT user_id AS uid FROM t_user</code>ï¼Œèƒ½å¤Ÿç›´æ¥è§£æå‡º <code>user_id</code>ã€‚</li>
<li>Symbol.COMMA / DefaultKeyword.FROM / Assist.END ï¼š<strong>åŒ…å«åˆ«å</strong>ã€‚ä¾‹å¦‚ï¼Œ<code>SELECT user_id uid FROM t_user</code>ï¼Œè§£æç»“æœä¸º <code>user_id uid</code>ã€‚</li>
</ul>
<p>åŸºäºè¿™ä¸ªåœ¨é…åˆä¸Šé¢çš„ä»£ç æ³¨é‡Šï¼Œå¤§å®¶å†é‡æ–°ç†è§£ä¸‹ç¬¬ä¸‰ç§æƒ…å†µçš„å®ç°ã€‚</p>
<ul>
<li>ç¬¬å››ç§ï¼šSQLServer ROW_NUMBERï¼š</li>
</ul>
<p>ROW_NUMBER æ˜¯ SQLServer ç‹¬æœ‰çš„ã€‚ç”±äºæœ¬æ–‡å¤§éƒ¨åˆ†çš„è¯»è€…ä½¿ç”¨çš„ MySQL / Oracleï¼Œå°±è·³è¿‡äº†ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ <a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/9354031743b63e44cbded5618980ae71a15f0260/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/parsing/parser/dialect/sqlserver/SQLServerSelectParser.java" rel="external nofollow noopener noreferrer" target="_blank">SQLServerSelectParser#parseRowNumberSelectItem()</a> æ–¹æ³•ã€‚</p>
<h3>3.2.2 #parseAlias() è§£æåˆ«å</h3>
<p>è§£æåˆ«åï¼Œåˆ†æˆæ˜¯å¦å¸¦ <code>AS</code> ä¸¤ç§æƒ…å†µã€‚è§£æä»£ç ï¼š<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹çš„#parseAlias()å°èŠ‚</a>ã€‚</p>
<h3>3.2.3 TableToken è¡¨æ ‡è®°å¯¹è±¡</h3>
<p>TableTokenï¼Œè®°å½•è¡¨ååœ¨ SQL é‡Œå‡ºç°çš„<strong>ä½ç½®</strong>å’Œ<strong>åå­—</strong>ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TableToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¡¨è¾¾å¼</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String originalLiterals;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–è¡¨åç§°.</div><div class="line">     * <span class="doctag">@return</span> è¡¨åç§°</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTableName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> SQLUtil.getExactlyValue(originalLiterals);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¾‹å¦‚ä¸Šæ–‡ç¬¬ä¸‰ç§æƒ…å†µã€‚
<img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/06.png" alt=""></p>
<h2>3.3 #skipToFrom()</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* è·³åˆ° FROM å¤„</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">skipToFrom</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">while</span> (!getSqlParser().equalAny(DefaultKeyword.FROM) &amp;&amp; !getSqlParser().equalAny(Assist.END)) &#123;</div><div class="line">       getSqlParser().getLexer().nextToken();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.4 #parseFrom()</h2>
<p>è§£æè¡¨ä»¥åŠè¡¨è¿æ¥å…³ç³»ã€‚<strong>è¿™å—ç›¸å¯¹æ¯”è¾ƒå¤æ‚ï¼Œè¯·å¤§å®¶è€å¿ƒ+è€å¿ƒ+è€å¿ƒã€‚</strong></p>
<p><strong>MySQL JOIN Syntax</strong>ï¼š</p>
<p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">// https://dev.mysql.com/doc/refman/5.7/en/join.html</div><div class="line">table_references:</div><div class="line">    escaped_table_reference [, escaped_table_reference] ...</div><div class="line"></div><div class="line">escaped_table_reference:</div><div class="line">    table_reference</div><div class="line">  | &#123; OJ table_reference &#125;</div><div class="line"></div><div class="line">table_reference:</div><div class="line">    table_factor</div><div class="line">  | join_table</div><div class="line"></div><div class="line">table_factor:</div><div class="line">    tbl_name [PARTITION (partition_names)]</div><div class="line">        [[AS] alias] [index_hint_list]</div><div class="line">  | table_subquery [AS] alias</div><div class="line">  | ( table_references )</div><div class="line"></div><div class="line">join_table:</div><div class="line">    table_reference [INNER | CROSS] JOIN table_factor [join_condition]</div><div class="line">  | table_reference STRAIGHT_JOIN table_factor</div><div class="line">  | table_reference STRAIGHT_JOIN table_factor ON conditional_expr</div><div class="line">  | table_reference &#123;LEFT|RIGHT&#125; [OUTER] JOIN table_reference join_condition</div><div class="line">  | table_reference NATURAL [&#123;LEFT|RIGHT&#125; [OUTER]] JOIN table_factor</div><div class="line"></div><div class="line">join_condition:</div><div class="line">    ON conditional_expr</div><div class="line">  | USING (column_list)</div><div class="line"></div><div class="line">index_hint_list:</div><div class="line">    index_hint [, index_hint] ...</div><div class="line"></div><div class="line">index_hint:</div><div class="line">    USE &#123;INDEX|KEY&#125;</div><div class="line">      [FOR &#123;JOIN|ORDER BY|GROUP BY&#125;] ([index_list])</div><div class="line">  | IGNORE &#123;INDEX|KEY&#125;</div><div class="line">      [FOR &#123;JOIN|ORDER BY|GROUP BY&#125;] (index_list)</div><div class="line">  | FORCE &#123;INDEX|KEY&#125;</div><div class="line">      [FOR &#123;JOIN|ORDER BY|GROUP BY&#125;] (index_list)</div><div class="line"></div><div class="line">index_list:</div><div class="line">    index_name [, index_name] ...</div></pre></td></tr></table></figure></p>
<h3>3.4.1 JOIN ON / FROM TABLE</h3>
<p>å…ˆæŠ›å¼€<strong>å­æŸ¥è¯¢</strong>çš„æƒ…å†µï¼Œåªè€ƒè™‘å¦‚ä¸‹ä¸¤ç§ SQL æƒ…å†µã€‚</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">// JOIN ON ï¼š å®é™…å¯ä»¥ç»§ç»­ JOIN ON æ›´å¤šè¡¨</div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o <span class="keyword">JOIN</span> t_order_item i <span class="keyword">ON</span> o.order_id = i.order_id; </div><div class="line">// FROM å¤šè¡¨ ï¼šå®é™…å¯ä»¥ç»§ç»­ FROM å¤šæ›´è¡¨</div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o, t_order_item i</div></pre></td></tr></table></figure></p>
<p>åœ¨çœ‹å®ç°ä»£ç ä¹‹å‰ï¼Œå…ˆä¸€èµ·çœ‹ä¸‹è°ƒç”¨é¡ºåºå›¾ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/02.png" alt=""></p>
<p>çœ‹æ‡‚ä¸Šå›¾åï¼Œæ¥ç»§ç»­çœ‹ä¸‹å®ç°ä»£ç ï¼ˆğŸ™‚<strong>ä»£ç æœ‰ç‚¹å¤šï¼Œä¸è¦æ–¹ï¼</strong>ï¼‰ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£ææ‰€æœ‰è¡¨åå’Œè¡¨åˆ«å</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseFrom</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.FROM)) &#123;</div><div class="line">       parseTable();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£ææ‰€æœ‰è¡¨åå’Œè¡¨åˆ«å</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseTable</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è§£æå­æŸ¥è¯¢</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(Symbol.LEFT_PAREN)) &#123;</div><div class="line">       <span class="keyword">if</span> (!selectStatement.getTables().isEmpty()) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support subquery for nested tables."</span>);</div><div class="line">       &#125;</div><div class="line">       selectStatement.setContainStar(<span class="keyword">false</span>);</div><div class="line">       sqlParser.skipUselessParentheses(); <span class="comment">// å»æ‰å­æŸ¥è¯¢å·¦æ‹¬å·</span></div><div class="line">       parse(); <span class="comment">// è§£æå­æŸ¥è¯¢ SQL</span></div><div class="line">       sqlParser.skipUselessParentheses(); <span class="comment">// å»æ‰å­æŸ¥è¯¢å³æ‹¬å·</span></div><div class="line">       <span class="comment">//</span></div><div class="line">       <span class="keyword">if</span> (!selectStatement.getTables().isEmpty()) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   parseTableFactor(); <span class="comment">// è§£æå½“å‰è¡¨</span></div><div class="line">   parseJoinTable(); <span class="comment">// è§£æä¸‹ä¸€ä¸ªè¡¨</span></div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æå•ä¸ªè¡¨åå’Œè¡¨åˆ«å</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseTableFactor</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> beginPosition = sqlParser.getLexer().getCurrentToken().getEndPosition() - sqlParser.getLexer().getCurrentToken().getLiterals().length();</div><div class="line">   String literals = sqlParser.getLexer().getCurrentToken().getLiterals();</div><div class="line">   sqlParser.getLexer().nextToken();</div><div class="line">   <span class="comment">// TODO åŒ…å«Schemaè§£æ</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(Symbol.DOT)) &#123; <span class="comment">// https://dev.mysql.com/doc/refman/5.7/en/information-schema.html ï¼šSELECT table_name, table_type, engine FROM information_schema.tables</span></div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       sqlParser.parseAlias();</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// FIXME æ ¹æ®shardingRuleè¿‡æ»¤table</span></div><div class="line">   selectStatement.getSqlTokens().add(<span class="keyword">new</span> TableToken(beginPosition, literals));</div><div class="line">   <span class="comment">// è¡¨ ä»¥åŠ è¡¨åˆ«å</span></div><div class="line">   selectStatement.getTables().add(<span class="keyword">new</span> Table(SQLUtil.getExactlyValue(literals), sqlParser.parseAlias()));</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æ Join Table æˆ–è€… FROM ä¸‹ä¸€å¼  Table</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseJoinTable</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.skipJoin()) &#123;</div><div class="line">       <span class="comment">// è¿™é‡Œè°ƒç”¨ parseJoinTable() è€Œä¸æ˜¯ parseTableFactor() ï¼šä¸‹ä¸€ä¸ª Table å¯èƒ½æ˜¯å­æŸ¥è¯¢</span></div><div class="line">       <span class="comment">// ä¾‹å¦‚ï¼šSELECT * FROM t_order JOIN (SELECT * FROM t_order_item JOIN t_order_other ON ) .....</span></div><div class="line">       parseTable();</div><div class="line">       <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.ON)) &#123; <span class="comment">// JOIN è¡¨æ—¶ ON æ¡ä»¶</span></div><div class="line">           <span class="keyword">do</span> &#123;</div><div class="line">               parseTableCondition(sqlParser.getLexer().getCurrentToken().getEndPosition());</div><div class="line">               sqlParser.accept(Symbol.EQ);</div><div class="line">               parseTableCondition(sqlParser.getLexer().getCurrentToken().getEndPosition() - sqlParser.getLexer().getCurrentToken().getLiterals().length());</div><div class="line">           &#125; <span class="keyword">while</span> (sqlParser.skipIfEqual(DefaultKeyword.AND));</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.USING)) &#123; <span class="comment">// JOIN è¡¨æ—¶ USING ä¸ºä½¿ç”¨ä¸¤è¡¨ç›¸åŒå­—æ®µç›¸åŒæ—¶å¯¹ ON çš„ç®€åŒ–ã€‚ä¾‹å¦‚ä»¥ä¸‹ä¸¤æ¡ SQL ç­‰ä»·ï¼š</span></div><div class="line">                                                                   <span class="comment">// SELECT * FROM t_order o JOIN t_order_item i USING (order_id);</span></div><div class="line">                                                                   <span class="comment">// SELECT * FROM t_order o JOIN t_order_item i ON o.order_id = i.order_id</span></div><div class="line">           sqlParser.skipParentheses();</div><div class="line">       &#125;</div><div class="line">       parseJoinTable(); <span class="comment">// ç»§ç»­é€’å½’</span></div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æ ON æ¡ä»¶é‡Œçš„ TableToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> startPosition å¼€å§‹ä½ç½®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseTableCondition</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> startPosition)</span> </span>&#123;</div><div class="line">   SQLExpression sqlExpression = sqlParser.parseExpression();</div><div class="line">   <span class="keyword">if</span> (!(sqlExpression <span class="keyword">instanceof</span> SQLPropertyExpression)) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   SQLPropertyExpression sqlPropertyExpression = (SQLPropertyExpression) sqlExpression;</div><div class="line">   <span class="keyword">if</span> (selectStatement.getTables().getTableNames().contains(SQLUtil.getExactlyValue(sqlPropertyExpression.getOwner().getName()))) &#123;</div><div class="line">       selectStatement.getSqlTokens().add(<span class="keyword">new</span> TableToken(startPosition, sqlPropertyExpression.getOwner().getName()));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>OKï¼Œé€’å½’å› ä¸ºå¹³æ—¶æ—¥å¸¸ä¸­å†™çš„æ¯”è¾ƒå°‘ï¼Œå¯èƒ½ç†è§£èµ·æ¥å¯èƒ½ä¼šå›°éš¾ä¸€äº›ï¼ŒåŠªåŠ›çœ‹æ‡‚ï¼ğŸ™‚<strong>å¦‚æœçœŸçš„çœ‹ä¸æ‡‚ï¼Œå¯ä»¥åŠ å¾®ä¿¡å…¬ä¼—å·ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">èŠ‹è‰¿çš„åç«¯å°å±‹</a>ï¼‰ï¼Œæˆ‘æ¥å¸®ä½ ä¸€èµ·ç†è§£ã€‚</strong></p>
<h3>3.4.2 å­æŸ¥è¯¢</h3>
<p>Sharding-JDBC ç›®å‰æ”¯æŒ<strong>ç¬¬ä¸€ä¸ª</strong>åŒ…å«å¤šå±‚çº§çš„æ•°æ®å­æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼š</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> o3.* <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o) o2) o3;</div><div class="line"><span class="keyword">SELECT</span> o3.* <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o) o2) o3 <span class="keyword">JOIN</span> t_order_item i <span class="keyword">ON</span> o3.order_id = i.order_id;</div></pre></td></tr></table></figure></p>
<p>ä¸æ”¯æŒ<strong>ç¬¬äºŒä¸ªå¼€å§‹</strong>åŒ…å«å¤šå±‚çº§çš„æ•°æ®å­æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼š</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> o3.* <span class="keyword">FROM</span> t_order_item i <span class="keyword">JOIN</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o) o2) o3 <span class="keyword">ON</span> o3.order_id = i.order_id; // æ­¤æ¡ SQL æ˜¯ä¸Šé¢ç¬¬äºŒæ¡ SQL å·¦å³é‡è¡¨é¢ å€’</div><div class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o <span class="keyword">WHERE</span> o.id <span class="keyword">IN</span> (<span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> t_order <span class="keyword">WHERE</span> <span class="keyword">status</span> = ?)) // <span class="keyword">FROM</span> å®˜æ–¹ä¸æ”¯æŒ <span class="keyword">SQL</span> ä¸¾ä¾‹</div></pre></td></tr></table></figure></p>
<p>ä½¿ç”¨<strong>ç¬¬äºŒä¸ªå¼€å§‹</strong>çš„å­æŸ¥è¯¢ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// AbstractSelectParser.java#parseTable()ç‰‡æ®µ</div><div class="line">if (!selectStatement.getTables().isEmpty()) &#123;</div><div class="line">    throw new UnsupportedOperationException(&quot;Cannot support subquery for nested tables.&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä½¿ç”¨å­æŸ¥è¯¢ï¼Œå»ºè®®è®¤çœŸé˜…è¯»å®˜æ–¹<a href="http://dangdangdotcom.github.io/sharding-jdbc/02-guide/subquery/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šåˆ†é¡µåŠå­æŸ¥è¯¢ã€‹</a>æ–‡æ¡£ã€‚</p>
<h3>3.4.3 #parseJoinTable()</h3>
<p>MySQLSelectParser é‡å†™äº† <code>#parseJoinTable()</code> æ–¹æ³•ç”¨äºè§£æ USE / IGNORE / FORCE index_hintã€‚å…·ä½“è¯­æ³•è§ä¸Šæ–‡ <strong>JOIN Syntax</strong>ã€‚è¿™é‡Œå°±è·³è¿‡ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»çœ‹çœ‹ã€‚</p>
<h3>3.4.4 Tables è¡¨é›†åˆå¯¹è±¡</h3>
<p><strong>å±äºåˆ†ç‰‡ä¸Šä¸‹æ–‡ä¿¡æ¯</strong></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Tables.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Tables</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Table&gt; tables = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Table.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Table</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¡¨</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ«å</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Optional&lt;String&gt; alias;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// AbstractSelectParser.java#parseTableFactor()ç‰‡æ®µ</span></div><div class="line">selectStatement.getTables().add(<span class="keyword">new</span> Table(SQLUtil.getExactlyValue(literals), sqlParser.parseAlias()));</div></pre></td></tr></table></figure></p>
<h2>3.5 #parseWhere()</h2>
<p>è§£æ WHERE æ¡ä»¶ã€‚è§£æä»£ç ï¼š<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹çš„#parseWhere()å°èŠ‚</a>ã€‚</p>
<h2>3.6 #parseGroupBy()</h2>
<p>è§£æåˆ†ç»„æ¡ä»¶ï¼Œå®ç°ä¸Šæ¯”è¾ƒç±»ä¼¼ <code>#parseSelectList</code>ï¼Œä¼šæ›´åŠ ç®€å•ä¸€äº›ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æ Group By å’Œ Havingï¼ˆæš‚æ—¶ä¸æ”¯æŒï¼‰</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseGroupBy</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.GROUP)) &#123;</div><div class="line">       sqlParser.accept(DefaultKeyword.BY);</div><div class="line">       <span class="comment">// è§£æ Group By æ¯ä¸ªå­—æ®µ</span></div><div class="line">       <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">           addGroupByItem(sqlParser.parseExpression(selectStatement));</div><div class="line">           <span class="keyword">if</span> (!sqlParser.equalAny(Symbol.COMMA)) &#123;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           sqlParser.getLexer().nextToken();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">while</span> (sqlParser.equalAny(DefaultKeyword.WITH) || sqlParser.getLexer().getCurrentToken().getLiterals().equalsIgnoreCase(<span class="string">"ROLLUP"</span>)) &#123;</div><div class="line">           sqlParser.getLexer().nextToken();</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// Havingï¼ˆæš‚æ—¶ä¸æ”¯æŒï¼‰</span></div><div class="line">       <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.HAVING)) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support Having"</span>);</div><div class="line">       &#125;</div><div class="line">       selectStatement.setGroupByLastPosition(sqlParser.getLexer().getCurrentToken().getEndPosition());</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.HAVING)) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support Having"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æ Group By å•ä¸ªå­—æ®µ</div><div class="line">* Group By æ¡ä»¶æ˜¯å¸¦æœ‰æ’åºåŠŸèƒ½ï¼Œé»˜è®¤ASC</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlExpression è¡¨è¾¾å¼</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addGroupByItem</span><span class="params">(<span class="keyword">final</span> SQLExpression sqlExpression)</span> </span>&#123;</div><div class="line">   <span class="comment">// Group By å­—æ®µ DESC / ASC / ;é»˜è®¤æ˜¯ ASCã€‚</span></div><div class="line">   OrderType orderByType = OrderType.ASC;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.ASC)) &#123;</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.DESC)) &#123;</div><div class="line">       orderByType = OrderType.DESC;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è§£æ OrderItem</span></div><div class="line">   OrderItem orderItem;</div><div class="line">   <span class="keyword">if</span> (sqlExpression <span class="keyword">instanceof</span> SQLPropertyExpression) &#123;</div><div class="line">       SQLPropertyExpression sqlPropertyExpression = (SQLPropertyExpression) sqlExpression;</div><div class="line">       orderItem = <span class="keyword">new</span> OrderItem(SQLUtil.getExactlyValue(sqlPropertyExpression.getOwner().getName()), SQLUtil.getExactlyValue(sqlPropertyExpression.getName()), orderByType,</div><div class="line">               getAlias(SQLUtil.getExactlyValue(sqlPropertyExpression.getOwner() + <span class="string">"."</span> + SQLUtil.getExactlyValue(sqlPropertyExpression.getName()))));</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlExpression <span class="keyword">instanceof</span> SQLIdentifierExpression) &#123;</div><div class="line">       SQLIdentifierExpression sqlIdentifierExpression = (SQLIdentifierExpression) sqlExpression;</div><div class="line">       orderItem = <span class="keyword">new</span> OrderItem(SQLUtil.getExactlyValue(sqlIdentifierExpression.getName()), orderByType, getAlias(SQLUtil.getExactlyValue(sqlIdentifierExpression.getName())));</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   selectStatement.getGroupByItems().add(orderItem);</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* å­—æ®µåœ¨æŸ¥è¯¢é¡¹é‡Œçš„åˆ«å</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> name å­—æ®µ</div><div class="line">* <span class="doctag">@return</span> åˆ«å</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Optional&lt;String&gt; <span class="title">getAlias</span><span class="params">(<span class="keyword">final</span> String name)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (selectStatement.isContainStar()) &#123;</div><div class="line">       <span class="keyword">return</span> Optional.absent();</div><div class="line">   &#125;</div><div class="line">   String rawName = SQLUtil.getExactlyValue(name);</div><div class="line">   <span class="keyword">for</span> (SelectItem each : selectStatement.getItems()) &#123;</div><div class="line">       <span class="keyword">if</span> (rawName.equalsIgnoreCase(SQLUtil.getExactlyValue(each.getExpression()))) &#123;</div><div class="line">           <span class="keyword">return</span> each.getAlias();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (rawName.equalsIgnoreCase(each.getAlias().orNull())) &#123;</div><div class="line">           <span class="keyword">return</span> Optional.of(rawName);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> Optional.absent();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>3.6.1 OrderItem æ’åºé¡¹</h3>
<p><strong>å±äºåˆ†ç‰‡ä¸Šä¸‹æ–‡ä¿¡æ¯</strong></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderItem</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * æ‰€å±è¡¨åˆ«å</div><div class="line">    */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Optional&lt;String&gt; owner;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * æ’åºå­—æ®µ</div><div class="line">    */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Optional&lt;String&gt; name;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * æ’åºç±»å‹</div><div class="line">    */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderType type;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * æŒ‰ç…§ç¬¬å‡ ä¸ªæŸ¥è¯¢å­—æ®µæ’åº</div><div class="line">    * ORDER BY æ•°å­— çš„ æ•°å­—ä»£è¡¨çš„æ˜¯ç¬¬å‡ ä¸ªå­—æ®µ</div><div class="line">    */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index = -<span class="number">1</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * å­—æ®µåœ¨æŸ¥è¯¢é¡¹(&#123;<span class="doctag">@link</span> com.dangdang.ddframe.rdb.sharding.parsing.parser.context.selectitem.SelectItem&#125; çš„åˆ«å</div><div class="line">    */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> Optional&lt;String&gt; alias;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.7 #parseOrderBy()</h2>
<p>è§£ææ’åºæ¡ä»¶ã€‚å®ç°é€»è¾‘ç±»ä¼¼ <code>#parseGroupBy()</code>ï¼Œè¿™é‡Œå°±è·³è¿‡ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»çœ‹çœ‹ã€‚</p>
<h2>3.8 #parseLimit()</h2>
<p>è§£æåˆ†é¡µ Limit æ¡ä»¶ã€‚ç›¸å¯¹ç®€å•ï¼Œè¿™é‡Œå°±è·³è¿‡ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»çœ‹çœ‹ã€‚æ³¨æ„ä¸‹ï¼Œåˆ†æˆ 3 ç§æƒ…å†µï¼š</p>
<ul>
<li>LIMIT row_count</li>
<li>LIMIT offset, row_count</li>
<li>LIMIT row_count OFFSET offset</li>
</ul>
<h3>3.8.1 Limit</h3>
<p>åˆ†é¡µå¯¹è±¡ã€‚<strong>å±äºåˆ†ç‰‡ä¸Šä¸‹æ–‡ä¿¡æ¯</strong>ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Limit.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Limit</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ˜¯å¦é‡å†™rowCount</div><div class="line">     * TODO å¾…è¡¥å……ï¼šé¢„è®¡å’Œå†…å­˜åˆ†é¡µåˆå¹¶æœ‰å…³</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> rowCountRewriteFlag;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * offset</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> LimitValue offset;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * row</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> LimitValue rowCount;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// LimitValue.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LimitValue</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å€¼</div><div class="line">     * å½“ value == -1 æ—¶ï¼Œä¸ºå ä½ç¬¦</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> value;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç¬¬å‡ ä¸ªå ä½ç¬¦</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>3.8.2 OffsetToken RowCountToken</h3>
<ul>
<li>OffsetTokenï¼šåˆ†é¡µåç§»é‡æ ‡è®°å¯¹è±¡</li>
<li>RowCountTokenï¼šåˆ†é¡µé•¿åº¦æ ‡è®°å¯¹è±¡</li>
</ul>
<p><strong>åªæœ‰åœ¨å¯¹åº”ä½ç½®éå ä½ç¬¦æ‰æœ‰è¯¥ SQLToken</strong>ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// OffsetToken.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OffsetToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL æ‰€åœ¨å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åç§»å€¼</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> offset;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RowCountToken.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RowCountToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL æ‰€åœ¨å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¡Œæ•°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> rowCount;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.9 #queryRest()</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">queryRest</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.UNION, DefaultKeyword.EXCEPT, DefaultKeyword.INTERSECT, DefaultKeyword.MINUS)) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(sqlParser.getLexer().getCurrentToken().getType());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸æ”¯æŒ UNION / EXCEPT / INTERSECT / MINUS ï¼Œè°ƒç”¨ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<h1>4. appendDerivedç­‰æ–¹æ³•</h1>
<p>å› ä¸º Sharding-JDBC å¯¹è¡¨åšäº†åˆ†ç‰‡ï¼Œåœ¨ AVG , GROUP BY , ORDER BY éœ€è¦å¯¹ SQL è¿›è¡Œä¸€äº›æ”¹å†™ï¼Œ<strong>ä»¥è¾¾åˆ°èƒ½åœ¨å†…å­˜é‡Œå¯¹ç»“æœåšè¿›ä¸€æ­¥å¤„ç†</strong>ï¼Œä¾‹å¦‚æ±‚å¹³å‡å€¼ã€åˆ†ç»„ã€æ’åºç­‰ã€‚</p>
<p>ğŸ˜ˆï¼šæ‰“èµ·ç²¾ç¥ï¼Œæ­¤å—æ˜¯éå¸¸æœ‰è¶£çš„ã€‚</p>
<h2>4.1 appendAvgDerivedColumns</h2>
<p>è§£å†³ AVG æŸ¥è¯¢ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* é’ˆå¯¹ AVG èšåˆå­—æ®µï¼Œå¢åŠ æ¨å¯¼å­—æ®µ</div><div class="line">* AVG æ”¹å†™æˆ SUM + COUNT æŸ¥è¯¢ï¼Œå†…å­˜è®¡ç®—å‡º AVG ç»“æœã€‚</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> itemsToken é€‰æ‹©é¡¹æ ‡è®°å¯¹è±¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendAvgDerivedColumns</span><span class="params">(<span class="keyword">final</span> ItemsToken itemsToken)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> derivedColumnOffset = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (SelectItem each : selectStatement.getItems()) &#123;</div><div class="line">       <span class="keyword">if</span> (!(each <span class="keyword">instanceof</span> AggregationSelectItem) || AggregationType.AVG != ((AggregationSelectItem) each).getType()) &#123;</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       AggregationSelectItem avgItem = (AggregationSelectItem) each;</div><div class="line">       <span class="comment">// COUNT å­—æ®µ</span></div><div class="line">       String countAlias = String.format(DERIVED_COUNT_ALIAS, derivedColumnOffset);</div><div class="line">       AggregationSelectItem countItem = <span class="keyword">new</span> AggregationSelectItem(AggregationType.COUNT, avgItem.getInnerExpression(), Optional.of(countAlias));</div><div class="line">       <span class="comment">// SUM å­—æ®µ</span></div><div class="line">       String sumAlias = String.format(DERIVED_SUM_ALIAS, derivedColumnOffset);</div><div class="line">       AggregationSelectItem sumItem = <span class="keyword">new</span> AggregationSelectItem(AggregationType.SUM, avgItem.getInnerExpression(), Optional.of(sumAlias));</div><div class="line">       <span class="comment">// AggregationSelectItem è®¾ç½®</span></div><div class="line">       avgItem.getDerivedAggregationSelectItems().add(countItem);</div><div class="line">       avgItem.getDerivedAggregationSelectItems().add(sumItem);</div><div class="line">       <span class="comment">// TODO å°†AVGåˆ—æ›¿æ¢æˆå¸¸æ•°ï¼Œé¿å…æ•°æ®åº“å†è®¡ç®—æ— ç”¨çš„AVGå‡½æ•°</span></div><div class="line">       <span class="comment">// ItemsToken</span></div><div class="line">       itemsToken.getItems().add(countItem.getExpression() + <span class="string">" AS "</span> + countAlias + <span class="string">" "</span>);</div><div class="line">       itemsToken.getItems().add(sumItem.getExpression() + <span class="string">" AS "</span> + sumAlias + <span class="string">" "</span>);</div><div class="line">       <span class="comment">//</span></div><div class="line">       derivedColumnOffset++;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>4.2 appendDerivedOrderColumns</h2>
<p>è§£å†³ GROUP BY , ORDER BYã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* é’ˆå¯¹ GROUP BY æˆ– ORDER BY å­—æ®µï¼Œå¢åŠ æ¨å¯¼å­—æ®µ</div><div class="line">* å¦‚æœè¯¥å­—æ®µä¸åœ¨æŸ¥è¯¢å­—æ®µé‡Œï¼Œéœ€è¦é¢å¤–æŸ¥è¯¢è¯¥å­—æ®µï¼Œè¿™æ ·æ‰èƒ½åœ¨å†…å­˜é‡Œ GROUP BY æˆ– ORDER BY</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> itemsToken é€‰æ‹©é¡¹æ ‡è®°å¯¹è±¡</div><div class="line">* <span class="doctag">@param</span> orderItems æ’åºå­—æ®µ</div><div class="line">* <span class="doctag">@param</span> aliasPattern åˆ«åæ¨¡å¼</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendDerivedOrderColumns</span><span class="params">(<span class="keyword">final</span> ItemsToken itemsToken, <span class="keyword">final</span> List&lt;OrderItem&gt; orderItems, <span class="keyword">final</span> String aliasPattern)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> derivedColumnOffset = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (OrderItem each : orderItems) &#123;</div><div class="line">       <span class="keyword">if</span> (!isContainsItem(each)) &#123;</div><div class="line">           String alias = String.format(aliasPattern, derivedColumnOffset++);</div><div class="line">           each.setAlias(Optional.of(alias));</div><div class="line">           itemsToken.getItems().add(each.getQualifiedName().get() + <span class="string">" AS "</span> + alias + <span class="string">" "</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* æŸ¥è¯¢å­—æ®µæ˜¯å¦åŒ…å«æ’åºå­—æ®µ</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> orderItem æ’åºå­—æ®µ</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isContainsItem</span><span class="params">(<span class="keyword">final</span> OrderItem orderItem)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (selectStatement.isContainStar()) &#123; <span class="comment">// SELECT *</span></div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (SelectItem each : selectStatement.getItems()) &#123;</div><div class="line">       <span class="keyword">if</span> (-<span class="number">1</span> != orderItem.getIndex()) &#123; <span class="comment">// ORDER BY ä½¿ç”¨æ•°å­—</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (each.getAlias().isPresent() &amp;&amp; orderItem.getAlias().isPresent() &amp;&amp; each.getAlias().get().equalsIgnoreCase(orderItem.getAlias().get())) &#123; <span class="comment">// å­—æ®µåˆ«åæ¯”è¾ƒ</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!each.getAlias().isPresent() &amp;&amp; orderItem.getQualifiedName().isPresent() &amp;&amp; each.getExpression().equalsIgnoreCase(orderItem.getQualifiedName().get())) &#123; <span class="comment">// å­—æ®µåŸåæ¯”è¾ƒ</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>4.3 ItemsToken</h2>
<p>é€‰æ‹©é¡¹æ ‡è®°å¯¹è±¡ï¼Œ<strong>å±äºåˆ†ç‰‡ä¸Šä¸‹æ–‡ä¿¡æ¯</strong>ï¼Œç›®å‰æœ‰ 3 ä¸ªæƒ…å†µä¼šåˆ›å»ºï¼š</p>
<ol>
<li><code>AVG</code> æŸ¥è¯¢é¢å¤– COUNT å’Œ SUMï¼š<code>#appendAvgDerivedColumns()</code></li>
<li><code>GROUP BY</code> ä¸åœ¨ æŸ¥è¯¢å­—æ®µï¼Œé¢å¤–æŸ¥è¯¢è¯¥å­—æ®µ ï¼š<code>#appendDerivedOrderColumns()</code></li>
<li><code>ORDER BY</code> ä¸åœ¨ æŸ¥è¯¢å­—æ®µï¼Œé¢å¤–æŸ¥è¯¢è¯¥å­—æ®µ ï¼š<code>#appendDerivedOrderColumns()</code></li>
</ol>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemsToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å­—æ®µåæ•°ç»„</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; items = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>4.4 appendDerivedOrderBy()</h2>
<p>å½“ SQL æœ‰èšåˆæ¡ä»¶è€Œæ— æ’åºæ¡ä»¶ï¼Œæ ¹æ®èšåˆæ¡ä»¶è¿›è¡Œæ’åºã€‚è¿™æ˜¯æ•°æ®åº“è‡ªå·±çš„æ‰§è¡Œè§„åˆ™ã€‚</p>
<p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">mysql&gt; SELECT order_id FROM t_order GROUP BY order_id;</div><div class="line">+----------+</div><div class="line">| order_id |</div><div class="line">+----------+</div><div class="line">| 1        |</div><div class="line">| 2        |</div><div class="line">| 3        |</div><div class="line">+----------+</div><div class="line">3 rows in set (0.05 sec)</div><div class="line"></div><div class="line">mysql&gt; SELECT order_id FROM t_order GROUP BY order_id DESC;</div><div class="line">+----------+</div><div class="line">| order_id |</div><div class="line">+----------+</div><div class="line">| 3        |</div><div class="line">| 2        |</div><div class="line">| 1        |</div><div class="line">+----------+</div><div class="line">3 rows in set (0.02 sec)</div></pre></td></tr></table></figure></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å½“æ—  Order By æ¡ä»¶æ—¶ï¼Œä½¿ç”¨ Group By ä½œä¸ºæ’åºæ¡ä»¶ï¼ˆæ•°æ®åº“æœ¬èº«è§„åˆ™ï¼‰</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendDerivedOrderBy</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!getSelectStatement().getGroupByItems().isEmpty() &amp;&amp; getSelectStatement().getOrderByItems().isEmpty()) &#123;</div><div class="line">       getSelectStatement().getOrderByItems().addAll(getSelectStatement().getGroupByItems());</div><div class="line">       getSelectStatement().getSqlTokens().add(<span class="keyword">new</span> OrderByToken(getSelectStatement().getGroupByLastPosition()));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>4.3.1 OrderByToken</h3>
<p>æ’åºæ ‡è®°å¯¹è±¡ã€‚å½“æ—  Order By æ¡ä»¶æ—¶ï¼Œä½¿ç”¨ Group By ä½œä¸ºæ’åºæ¡ä»¶ï¼ˆæ•°æ®åº“æœ¬èº«è§„åˆ™ï¼‰ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// OrderByToken.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderByToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL æ‰€åœ¨å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>666. å½©è›‹</h1>
<p>å’³å’³å’³ï¼Œç¡®å®æœ‰ä¸€äº›ç•¥é•¿ã€‚ä½†è¯·ç›¸ä¿¡ï¼ŒINSERT / UPDATE / DELETE ä¼šç®€å•å¾ˆå¤šå¾ˆå¤šã€‚è€ƒè¯•è€ƒçš„ SQL æœ€å¤šçš„æ˜¯ä»€ä¹ˆï¼ŸSELECT è¯­å¥å‘€ï¼ä¸ºå•¥ï¼Œéš¾å‘—ã€‚æ©ï¼Œæˆ‘ç›¸ä¿¡çœ‹åˆ°æ­¤å¤„çš„ä½ ï¼Œä¸€å®šæ˜¯èƒ½çœ‹æ‡‚çš„ï¼ŒåŠ æ²¹ï¼</p>
<p>ğŸ™‚å¦‚æœå¯¹æœ¬æ–‡æœ‰ä¸ç†è§£çš„åœ°æ–¹ï¼Œå¯ä»¥å…³æ³¨æˆ‘çš„å…¬ä¼—å·**ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">èŠ‹è‰¿çš„åç«¯å°å±‹</a>ï¼‰<strong>è·å¾—</strong>å¾®ä¿¡å·**ï¼Œæˆ‘ä»¬æ¥ä¸€åœºï¼Œ1 å¯¹ 1 çš„æåŸºå§ï¼Œä¸ä¸ä¸ï¼Œæ˜¯äº¤æµäº¤æµã€‚</p>
<p>é“å‹ï¼Œå¸®æˆ‘åˆ†äº«ä¸€æ³¢æ€ä¹ˆæ ·ï¼Ÿ</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;o
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æ</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-parse-2/</id>
    <published>2017-07-25T16:00:00.000Z</published>
    <updated>2017-08-10T17:25:23.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼š<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</a>**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Sharding-JDBC 1.5.0 æ­£å¼ç‰ˆ</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. SQLParsingEngine</a></li>
<li><a href="#">3. SQLParser SQLè§£æå™¨</a>
<ul>
<li><a href="#">3.1 AbstractParser</a></li>
<li><a href="#">3.2 SQLParser</a>
<ul>
<li><a href="#">3.2.1 #parseExpression() å’Œ SQLExpression</a></li>
<li><a href="#">3.2.2 #parseAlias()</a></li>
<li><a href="#">3.2.3 #parseSingleTable()</a></li>
<li><a href="#">3.2.4 #skipJoin()</a></li>
<li><a href="#">3.2.5 #parseWhere()</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#">4. StatementParser SQLè¯­å¥è§£æå™¨</a>
<ul>
<li><a href="#">4.1 StatementParser</a></li>
<li><a href="#">4.2 Statement</a></li>
</ul>
</li>
<li><a href="#">5. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>ä¸Šç¯‡æ–‡ç« <a href="http://www.yunai.me/Sharding-JDBC/sql-parse-1/">ã€Šè¯æ³•è§£æã€‹</a>åˆ†äº«äº†<strong>è¯æ³•è§£æå™¨Lexer</strong>æ˜¯å¦‚ä½•è§£æ SQL é‡Œçš„è¯æ³•ã€‚æœ¬æ–‡åˆ†äº«<strong>SQLè§£æå¼•æ“</strong>æ˜¯å¦‚ä½•è§£æä¸ç†è§£ SQLçš„ã€‚å› ä¸ºæœ¬æ–‡å»ºç«‹åœ¨<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-1/">ã€Šè¯æ³•è§£æã€‹</a>ä¹‹ä¸Šï¼Œä½ éœ€è¦é˜…è¯»å®ƒååœ¨å¼€å§‹è¿™æ®µæ—…ç¨‹ã€‚ğŸ™‚å¦‚æœå¯¹è¯æ³•è§£æä¸å®Œå…¨ç†è§£ï¼Œè¯·ç»™æˆ‘çš„å…¬ä¼—å·**ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">èŠ‹è‰¿çš„åç«¯å°å±‹</a>ï¼‰<strong>ç•™è¨€ï¼Œæˆ‘ä¼š</strong>é€æ¡è®¤çœŸè€å¿ƒ**å›å¤ã€‚</p>
<p>åŒºåˆ«äº Lexerï¼ŒParser <strong>ç†è§£SQL</strong>ï¼š</p>
<ul>
<li><strong>æç‚¼åˆ†ç‰‡ä¸Šä¸‹æ–‡</strong></li>
<li><strong>æ ‡è®°éœ€è¦SQLæ”¹å†™çš„éƒ¨åˆ†</strong></li>
</ul>
<p>Parser æœ‰ä¸‰ä¸ªç»„ä»¶ï¼š</p>
<ul>
<li>SQLParsingEngine ï¼šSQL è§£æå¼•æ“</li>
<li>SQLParser ï¼šSQL è§£æå™¨</li>
<li>StatementParser ï¼šSQLè¯­å¥è§£æå™¨</li>
</ul>
<p>SQLParsingEngine è°ƒç”¨ StatementParser è§£æ SQLã€‚<br>
StatementParser è°ƒç”¨ SQLParser è§£æ SQL è¡¨è¾¾å¼ã€‚<br>
SQLParser è°ƒç”¨ Lexer è§£æ SQL è¯æ³•ã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/01.png" alt=""></p>
<p>ğŸ˜œ æ˜¯ä¸æ˜¯è§‰å¾— SQLParser å’Œ StatementParser çœ‹èµ·æ¥å¾ˆæ¥è¿‘ï¼Ÿä¸‹æ–‡ä¸ºä½ æ­å¼€è¿™ä¸ªç­”æ¡ˆã€‚</p>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>
ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>
ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1>2. SQLParsingEngine</h1>
<p>SQLParsingEngineï¼ŒSQL è§£æå¼•æ“ã€‚å…¶ <code>#parse()</code> æ–¹æ³•ä½œä¸º SQL è§£æå…¥å£ï¼Œæœ¬èº«ä¸å¸¦å¤æ‚é€»è¾‘ï¼Œé€šè¿‡è°ƒç”¨ SQL å¯¹åº”çš„ StatementParser è¿›è¡Œ SQL è§£æã€‚</p>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParsingEngine.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLStatement <span class="title">parse</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å– SQLè§£æå™¨</span></div><div class="line">   SQLParser sqlParser = getSQLParser();</div><div class="line">   <span class="comment">//</span></div><div class="line">   sqlParser.skipIfEqual(Symbol.SEMI); <span class="comment">// è·³è¿‡ ";"</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.WITH)) &#123; <span class="comment">// WITH Syntax</span></div><div class="line">       skipWith(sqlParser);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è·å–å¯¹åº” SQLè¯­å¥è§£æå™¨ è§£æSQL</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.SELECT)) &#123;</div><div class="line">       <span class="keyword">return</span> SelectParserFactory.newInstance(sqlParser).parse();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.INSERT)) &#123;</div><div class="line">       <span class="keyword">return</span> InsertParserFactory.newInstance(shardingRule, sqlParser).parse();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.UPDATE)) &#123;</div><div class="line">       <span class="keyword">return</span> UpdateParserFactory.newInstance(sqlParser).parse();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.DELETE)) &#123;</div><div class="line">       <span class="keyword">return</span> DeleteParserFactory.newInstance(sqlParser).parse();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(sqlParser.getLexer().getCurrentToken().getType());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>3. SQLParser SQLè§£æå™¨</h1>
<p>SQLParserï¼ŒSQL è§£æå™¨ã€‚å’Œè¯æ³•è§£æå™¨ Lexer ä¸€æ ·ï¼Œä¸åŒæ•°æ®åº“æœ‰ä¸åŒçš„å®ç°ã€‚</p>
<p>ç±»å›¾å¦‚ä¸‹ï¼ˆ<strong>åŒ…å«æ‰€æœ‰å±æ€§å’Œæ–¹æ³•</strong>ï¼‰ï¼ˆ<strong><a href="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/02.png">æ”¾å¤§å›¾ç‰‡</a></strong>ï¼‰ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/02.png" alt=""></p>
<h2>3.1 AbstractParser</h2>
<p>AbstractParserï¼ŒSQLParser çš„æŠ½è±¡çˆ¶ç±»ï¼Œå¯¹ Lexer ç®€å•å°è£…ã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li><code>#skipIfEqual()</code>ï¼šåˆ¤æ–­å½“å‰è¯æ³•æ ‡è®°ç±»å‹æ˜¯å¦ä¸å…¶ä¸­ä¸€ä¸ªä¼ å…¥å€¼ç›¸ç­‰</li>
<li><code>#equalAny()</code>ï¼šåˆ¤æ–­å½“å‰è¯æ³•æ ‡è®°ç±»å‹æ˜¯å¦ä¸å…¶ä¸­ä¸€ä¸ªä¼ å…¥å€¼ç›¸ç­‰</li>
</ul>
<p><em><strong>è¿™é‡Œæœ‰ä¸€ç‚¹æˆ‘ä»¬éœ€è¦æ³¨æ„ï¼ŒSQLParser å¹¶ä¸æ˜¯ç­‰ Lexer è§£æå®Œè¯æ³•( Token )ï¼Œå†æ ¹æ®è¯æ³•å»ç†è§£ SQLã€‚è€Œæ˜¯ï¼Œåœ¨ç†è§£ SQL çš„è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨ Lexer è¿›è¡Œåˆ†è¯ã€‚</strong></em></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParsingEngine.java#parse()ç‰‡æ®µ</span></div><div class="line"><span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.SELECT)) &#123;</div><div class="line">    <span class="keyword">return</span> SelectParserFactory.newInstance(sqlParser).parse();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// AbstractParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equalAny</span><span class="params">(<span class="keyword">final</span> TokenType... tokenTypes)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (TokenType each : tokenTypes) &#123;</div><div class="line">       <span class="keyword">if</span> (each == lexer.getCurrentToken().getType()) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>â†‘â†‘â†‘ åˆ¤æ–­å½“å‰<strong>è¯æ³•</strong>æ˜¯å¦ä¸º SELECTã€‚å®é™… AbstractParser åªçŸ¥é“å½“å‰è¯æ³•ï¼Œå¹¶<strong>ä¸çŸ¥é“</strong>åé¢è¿˜æœ‰å“ªäº›è¯æ³•ï¼Œä¹Ÿ<strong>ä¸çŸ¥é“</strong>ä¹‹å‰æœ‰å“ªäº›è¯æ³•ã€‚</li>
</ul>
<p>æˆ‘ä»¬æ¥çœ‹ AbstractParser é‡Œæ¯”è¾ƒå¤æ‚çš„æ–¹æ³• <code>#skipParentheses()</code> å¸®åŠ©å¤§å®¶å†ç†è§£ä¸‹ã€‚è¯·è®¤çœŸçœ‹ä»£ç æ³¨é‡Šå™¢ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·³è¿‡å°æ‹¬å·å†…æ‰€æœ‰çš„è¯æ³•æ ‡è®°.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> å°æ‹¬å·å†…æ‰€æœ‰çš„è¯æ³•æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">skipParentheses</span><span class="params">()</span> </span>&#123;</div><div class="line">   StringBuilder result = <span class="keyword">new</span> StringBuilder(<span class="string">""</span>);</div><div class="line">   <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">   <span class="keyword">if</span> (Symbol.LEFT_PAREN == getLexer().getCurrentToken().getType()) &#123;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> beginPosition = getLexer().getCurrentToken().getEndPosition();</div><div class="line">       result.append(Symbol.LEFT_PAREN.getLiterals());</div><div class="line">       getLexer().nextToken();</div><div class="line">       <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">           <span class="keyword">if</span> (equalAny(Symbol.QUESTION)) &#123;</div><div class="line">               increaseParametersIndex();</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// åˆ°è¾¾ç»“å°¾ æˆ–è€… åŒ¹é…åˆé€‚æ•°çš„)å³æ‹¬å·</span></div><div class="line">           <span class="keyword">if</span> (Assist.END == getLexer().getCurrentToken().getType() || (Symbol.RIGHT_PAREN == getLexer().getCurrentToken().getType() &amp;&amp; <span class="number">0</span> == count)) &#123;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// å¤„ç†é‡Œé¢æœ‰å¤šä¸ªæ‹¬å·çš„æƒ…å†µï¼Œä¾‹å¦‚ï¼šSELECT COUNT(DISTINCT(order_id) FROM t_order</span></div><div class="line">           <span class="keyword">if</span> (Symbol.LEFT_PAREN == getLexer().getCurrentToken().getType()) &#123;</div><div class="line">               count++;</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Symbol.RIGHT_PAREN == getLexer().getCurrentToken().getType()) &#123;</div><div class="line">               count--;</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// ä¸‹ä¸€ä¸ªè¯æ³•</span></div><div class="line">           getLexer().nextToken();</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// è·å¾—æ‹¬å·å†…çš„å†…å®¹</span></div><div class="line">       result.append(getLexer().getInput().substring(beginPosition, getLexer().getCurrentToken().getEndPosition()));</div><div class="line">       <span class="comment">// ä¸‹ä¸€ä¸ªè¯æ³•</span></div><div class="line">       getLexer().nextToken();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªç±»å…¶å®ƒæ–¹æ³•å¾ˆé‡è¦ï¼Œé€»è¾‘ç›¸å¯¹ç®€å•ï¼Œæˆ‘ä»¬å°±ä¸å ç”¨ç¯‡å¹…äº†ã€‚å¤§å®¶ä¸€å®šè¦çœ‹å“Ÿï¼Œåé¢è°ƒç”¨éå¸¸éå¸¸å¤šã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/master/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/parsing/parser/AbstractParser.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractParser.java ä¼ é€é—¨</a>ã€‚ğŸ‘¼ä¹Ÿå¯ä»¥å…³æ³¨æˆ‘çš„å…¬ä¼—å·**ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">èŠ‹è‰¿çš„åç«¯å°å±‹</a>ï¼‰<strong>å‘é€å…³é”®å­—ã€sjdbcã€‘è·å–</strong>å¢åŠ æ–¹æ³•å†…æ³¨é‡Šçš„é¡¹ç›®åœ°å€**ã€‚</p>
<h2>3.2 SQLParser</h2>
<p>SQLParserï¼ŒSQL è§£æå™¨ï¼Œ<strong>ä¸»è¦æä¾›åªè€ƒè™‘ SQL å—çš„è§£ææ–¹æ³•ï¼Œ<em>ä¸è€ƒè™‘ SQL ä¸Šä¸‹æ–‡</em></strong>ã€‚ä¸‹æ–‡å³å°†æåˆ°çš„ StatementParser å°† SQL æ‹†æˆå¯¹åº”çš„<strong>å—</strong>ï¼Œè°ƒç”¨ SQLParser è¿›è¡Œè§£æã€‚ğŸ¤“ è¿™ä¹ˆè¯´ï¼Œå¯èƒ½ä¼šæœ‰äº›æŠ½è±¡ï¼Œæˆ‘ä»¬ä¸‹é¢æ¥ä¸€èµ·çœ‹ã€‚</p>
<p>SQLParser çœ‹èµ·æ¥æ–¹æ³•ç‰¹åˆ«å¤šï¼Œåˆå¹¶ä¸‹ä¸€å…± 5 ç§ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">æ–¹æ³•</th>
<th style="text-align:left">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">#parseExpression()</td>
<td style="text-align:left">è§£æè¡¨è¾¾å¼</td>
</tr>
<tr>
<td style="text-align:left">#parseAlias()</td>
<td style="text-align:left">è§£æåˆ«å</td>
</tr>
<tr>
<td style="text-align:left">#parseSingleTable()</td>
<td style="text-align:left">è§£æå•è¡¨</td>
</tr>
<tr>
<td style="text-align:left">#skipJoin()</td>
<td style="text-align:left">è·³è¿‡è¡¨å…³è”è¯æ³•</td>
</tr>
<tr>
<td style="text-align:left">#parseWhere()</td>
<td style="text-align:left">è§£ææŸ¥è¯¢æ¡ä»¶</td>
</tr>
</tbody>
</table>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/03.png" alt=""></p>
<p>çœ‹äº†è¿™ 5 ä¸ªæ–¹æ³•æ˜¯å¦æœ‰ç‚¹ç†è§£äº†ï¼ŸSQLParser ä¸è€ƒè™‘ SQL æ˜¯ SELECT / INSERT / UPDATE / DELETE ï¼Œå®ƒè€ƒè™‘çš„æ˜¯ï¼Œ<strong>ç»™æˆ‘çš„æ˜¯ WHERE å¤„è§£ææŸ¥è¯¢æ¡ä»¶ï¼Œæˆ–æ˜¯ INSERT INTO è§£æå•è¡¨ ç­‰</strong>ï¼Œæä¾› SELECT / INSERT / UPDATE / DELETE éœ€è¦çš„ SQL å—å…¬ç”¨è§£æã€‚</p>
<h3>3.2.1 #parseExpression() å’Œ SQLExpression</h3>
<p>SQLExpressionï¼ŒSQLè¡¨è¾¾å¼æ¥å£ã€‚ç›®å‰ 6 ç§å®ç°ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">ç±»</th>
<th style="text-align:left">è¯´æ˜</th>
<th style="text-align:left">å¯¹åº”Token</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">SQLIdentifierExpression</td>
<td style="text-align:left">æ ‡è¯†è¡¨è¾¾å¼</td>
<td style="text-align:left">Literals.IDENTIFIER</td>
</tr>
<tr>
<td style="text-align:left">SQLPropertyExpression</td>
<td style="text-align:left">å±æ€§è¡¨è¾¾å¼</td>
<td style="text-align:left">æ— </td>
</tr>
<tr>
<td style="text-align:left">SQLNumberExpression</td>
<td style="text-align:left">æ•°å­—è¡¨è¾¾å¼</td>
<td style="text-align:left">Literals.INT, Literals.HEX</td>
</tr>
<tr>
<td style="text-align:left">SQLPlaceholderExpression</td>
<td style="text-align:left">å ä½ç¬¦è¡¨è¾¾å¼</td>
<td style="text-align:left">Symbol.QUESTION</td>
</tr>
<tr>
<td style="text-align:left">SQLTextExpression</td>
<td style="text-align:left">å­—ç¬¦è¡¨è¾¾å¼</td>
<td style="text-align:left">Literals.CHARS</td>
</tr>
<tr>
<td style="text-align:left">SQLIgnoreExpression</td>
<td style="text-align:left">åˆ†ç‰‡ä¸­æ— éœ€å…³æ³¨çš„SQLè¡¨è¾¾å¼</td>
<td style="text-align:left">æ— </td>
</tr>
</tbody>
</table>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/04.png" alt=""></p>
<ul>
<li>SQLPropertyExpression ä¾‹å¦‚ï¼š<code>SELECT * FROM t_order o ORDER BY o.order_id</code> ä¸­çš„ <code>o.order_id</code>ã€‚<strong>SQLPropertyExpression ä» SQLIdentifierExpression è¿›ä¸€æ­¥åˆ¤æ–­è§£æè€Œæ¥ã€‚</strong>
<img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/05.png" alt=""></li>
<li>SQLIgnoreExpression ä¾‹å¦‚ï¼š<code>SELECT * FROM t_order o ORDER BY o.order_id % 2</code> ä¸­çš„<code>o.order_id % 2</code>ã€‚<strong>å¤åˆè¡¨è¾¾å¼éƒ½ä¼šè§£ææˆ SQLIgnoreExpressionã€‚</strong></li>
</ul>
<p>è§£æ SQLExpression æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æè¡¨è¾¾å¼.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> è¡¨è¾¾å¼</div><div class="line">*/</div><div class="line"><span class="comment">// TODO å®Œå–„Expressionè§£æçš„å„ç§åœºæ™¯</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> SQLExpression <span class="title">parseExpression</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è§£æè¡¨è¾¾å¼</span></div><div class="line">   String literals = getLexer().getCurrentToken().getLiterals();</div><div class="line">   <span class="keyword">final</span> SQLExpression expression = getExpression(literals);</div><div class="line">   <span class="comment">// SQLIdentifierExpression éœ€è¦ç‰¹æ®Šå¤„ç†ã€‚è€ƒè™‘è‡ªå®šä¹‰å‡½æ•°ï¼Œè¡¨å.å±æ€§æƒ…å†µã€‚</span></div><div class="line">   <span class="keyword">if</span> (skipIfEqual(Literals.IDENTIFIER)) &#123;</div><div class="line">       <span class="keyword">if</span> (skipIfEqual(Symbol.DOT)) &#123; <span class="comment">// ä¾‹å¦‚ï¼ŒORDER BY o.uid ä¸­çš„ "o.uid"</span></div><div class="line">           String property = getLexer().getCurrentToken().getLiterals();</div><div class="line">           getLexer().nextToken();</div><div class="line">           <span class="keyword">return</span> skipIfCompositeExpression() ? <span class="keyword">new</span> SQLIgnoreExpression() : <span class="keyword">new</span> SQLPropertyExpression(<span class="keyword">new</span> SQLIdentifierExpression(literals), property);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (equalAny(Symbol.LEFT_PAREN)) &#123; <span class="comment">// ä¾‹å¦‚ï¼ŒGROUP BY DATE(create_time) ä¸­çš„ "DATE(create_time)"</span></div><div class="line">           skipParentheses();</div><div class="line">           skipRestCompositeExpression();</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> SQLIgnoreExpression();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> skipIfCompositeExpression() ? <span class="keyword">new</span> SQLIgnoreExpression() : expression;</div><div class="line">   &#125;</div><div class="line">   getLexer().nextToken();</div><div class="line">   <span class="keyword">return</span> skipIfCompositeExpression() ? <span class="keyword">new</span> SQLIgnoreExpression() : expression;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾— è¯æ³•Token å¯¹åº”çš„ SQLExpression</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> literals è¯æ³•å­—é¢é‡æ ‡è®°</div><div class="line">* <span class="doctag">@return</span> SQLExpression</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> SQLExpression <span class="title">getExpression</span><span class="params">(<span class="keyword">final</span> String literals)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (equalAny(Symbol.QUESTION)) &#123;</div><div class="line">       increaseParametersIndex();</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLPlaceholderExpression(getParametersIndex() - <span class="number">1</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.CHARS)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLTextExpression(literals);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// TODO è€ƒè™‘longçš„æƒ…å†µ</span></div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.INT)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLNumberExpression(Integer.parseInt(literals));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.FLOAT)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLNumberExpression(Double.parseDouble(literals));</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// TODO è€ƒè™‘longçš„æƒ…å†µ</span></div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.HEX)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLNumberExpression(Integer.parseInt(literals, <span class="number">16</span>));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.IDENTIFIER)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLIdentifierExpression(SQLUtil.getExactlyValue(literals));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> SQLIgnoreExpression();</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* å¦‚æœæ˜¯ å¤åˆè¡¨è¾¾å¼ï¼Œè·³è¿‡ã€‚</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦è·³è¿‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">skipIfCompositeExpression</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (equalAny(Symbol.PLUS, Symbol.SUB, Symbol.STAR, Symbol.SLASH, Symbol.PERCENT, Symbol.AMP, Symbol.BAR, Symbol.DOUBLE_AMP, Symbol.DOUBLE_BAR, Symbol.CARET, Symbol.DOT, Symbol.LEFT_PAREN)) &#123;</div><div class="line">       skipParentheses();</div><div class="line">       skipRestCompositeExpression();</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·³è¿‡å‰©ä½™å¤åˆè¡¨è¾¾å¼</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">skipRestCompositeExpression</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">while</span> (skipIfEqual(Symbol.PLUS, Symbol.SUB, Symbol.STAR, Symbol.SLASH, Symbol.PERCENT, Symbol.AMP, Symbol.BAR, Symbol.DOUBLE_AMP, Symbol.DOUBLE_BAR, Symbol.CARET, Symbol.DOT)) &#123;</div><div class="line">       <span class="keyword">if</span> (equalAny(Symbol.QUESTION)) &#123;</div><div class="line">           increaseParametersIndex();</div><div class="line">       &#125;</div><div class="line">       getLexer().nextToken();</div><div class="line">       skipParentheses();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è§£æäº† SQLExpression æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿæˆ‘ä»¬ä¼šåœ¨<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠæŸ¥è¯¢SQLè§£æã€‹</a>ã€<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šæ’å…¥SQLè§£æã€‹</a>ã€<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šæ›´æ–°SQLè§£æã€‹</a>ã€<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šåˆ é™¤SQLè§£æã€‹</a>ã€‚ç•™ä¸ªæ‚¬å¿µğŸ˜ˆï¼Œå…³æ³¨æˆ‘çš„å…¬ä¼—å·**ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">èŠ‹è‰¿çš„åç«¯å°å±‹</a>ï¼‰**ï¼Œ<strong>å®æ—¶æ”¶åˆ°æ–°æ–‡æ›´æ–°é€šçŸ¥</strong>ã€‚</p>
<h3>3.2.2 #parseAlias()</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æåˆ«å.ä¸ä»…ä»…æ˜¯å­—æ®µçš„åˆ«åï¼Œä¹Ÿå¯ä»¥æ˜¯è¡¨çš„åˆ«åã€‚</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> åˆ«å</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Optional&lt;String&gt; <span class="title">parseAlias</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è§£æå¸¦ AS æƒ…å†µ</span></div><div class="line">   <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.AS)) &#123;</div><div class="line">       <span class="keyword">if</span> (equalAny(Symbol.values())) &#123;</div><div class="line">           <span class="keyword">return</span> Optional.absent();</div><div class="line">       &#125;</div><div class="line">       String result = SQLUtil.getExactlyValue(getLexer().getCurrentToken().getLiterals());</div><div class="line">       getLexer().nextToken();</div><div class="line">       <span class="keyword">return</span> Optional.of(result);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è§£æåˆ«å</span></div><div class="line">   <span class="comment">// TODO å¢åŠ å“ªäº›æ•°æ®åº“è¯†åˆ«å“ªäº›å…³é”®å­—ä½œä¸ºåˆ«åçš„é…ç½®</span></div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.IDENTIFIER, Literals.CHARS, DefaultKeyword.USER, DefaultKeyword.END, DefaultKeyword.CASE, DefaultKeyword.KEY, DefaultKeyword.INTERVAL, DefaultKeyword.CONSTRAINT)) &#123;</div><div class="line">       String result = SQLUtil.getExactlyValue(getLexer().getCurrentToken().getLiterals());</div><div class="line">       getLexer().nextToken();</div><div class="line">       <span class="keyword">return</span> Optional.of(result);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> Optional.absent();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>3.2.3 #parseSingleTable()</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æå•è¡¨.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlStatement SQLè¯­å¥å¯¹è±¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseSingleTable</span><span class="params">(<span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   <span class="keyword">boolean</span> hasParentheses = <span class="keyword">false</span>;</div><div class="line">   <span class="keyword">if</span> (skipIfEqual(Symbol.LEFT_PAREN)) &#123;</div><div class="line">       <span class="keyword">if</span> (equalAny(DefaultKeyword.SELECT)) &#123; <span class="comment">// multiple-update æˆ–è€… multiple-delete</span></div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support subquery"</span>);</div><div class="line">       &#125;</div><div class="line">       hasParentheses = <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   Table table;</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> beginPosition = getLexer().getCurrentToken().getEndPosition() - getLexer().getCurrentToken().getLiterals().length();</div><div class="line">   String literals = getLexer().getCurrentToken().getLiterals();</div><div class="line">   getLexer().nextToken();</div><div class="line">   <span class="keyword">if</span> (skipIfEqual(Symbol.DOT)) &#123;</div><div class="line">       getLexer().nextToken();</div><div class="line">       <span class="keyword">if</span> (hasParentheses) &#123;</div><div class="line">           accept(Symbol.RIGHT_PAREN);</div><div class="line">       &#125;</div><div class="line">       table = <span class="keyword">new</span> Table(SQLUtil.getExactlyValue(literals), parseAlias());</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">if</span> (hasParentheses) &#123;</div><div class="line">           accept(Symbol.RIGHT_PAREN);</div><div class="line">       &#125;</div><div class="line">       table = <span class="keyword">new</span> Table(SQLUtil.getExactlyValue(literals), parseAlias());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (skipJoin()) &#123; <span class="comment">// multiple-update æˆ–è€… multiple-delete</span></div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support Multiple-Table."</span>);</div><div class="line">   &#125;</div><div class="line">   sqlStatement.getSqlTokens().add(<span class="keyword">new</span> TableToken(beginPosition, literals));</div><div class="line">   sqlStatement.getTables().add(table);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>3.2.4 #skipJoin()</h3>
<p>è·³è¿‡è¡¨å…³è”è¯æ³•ï¼Œæ”¯æŒ <code>SELECT * FROM t_user, t_order WHERE ...</code>, <code>SELECT * FROM t_user JOIN t_order ON ...</code>ã€‚ä¸‹ç¯‡<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠæŸ¥è¯¢SQLè§£æã€‹</a><strong>è§£æè¡¨</strong>ä¼šç”¨åˆ°è¿™ä¸ªæ–¹æ³•ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·³è¿‡è¡¨å…³è”è¯æ³•.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦è¡¨å…³è”.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">skipJoin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.LEFT, DefaultKeyword.RIGHT, DefaultKeyword.FULL)) &#123;</div><div class="line">       skipIfEqual(DefaultKeyword.OUTER);</div><div class="line">       accept(DefaultKeyword.JOIN);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.INNER)) &#123;</div><div class="line">       accept(DefaultKeyword.JOIN);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.JOIN, Symbol.COMMA, DefaultKeyword.STRAIGHT_JOIN)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.CROSS)) &#123;</div><div class="line">       <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.JOIN, DefaultKeyword.APPLY)) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.OUTER)) &#123;</div><div class="line">       <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.APPLY)) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>3.2.5 #parseWhere()</h3>
<p>è§£æ WHERE æŸ¥è¯¢æ¡ä»¶ã€‚ç›®å‰æ”¯æŒ AND æ¡ä»¶ï¼Œä¸æ”¯æŒ OR æ¡ä»¶ã€‚è¿‘æœŸ OR æ¡ä»¶æ”¯æŒçš„å¯èƒ½æ€§æ¯”è¾ƒä½ã€‚å¦å¤–æ¡ä»¶è¿™å—å¯¹æ‹¬å·è§£æéœ€è¦ç»§ç»­ä¼˜åŒ–ï¼Œå®é™…ä½¿ç”¨è¯·å‹¿å†™å†—ä½™çš„æ‹¬å·ã€‚ä¾‹å¦‚ï¼š<code>SELECT * FROM tbl_name1 WHERE ((val1=?) AND (val2=?)) AND val3 =?</code>ã€‚</p>
<p>æ ¹æ®ä¸åŒçš„è¿ç®—æ“ä½œç¬¦ï¼Œåˆ†æˆå¦‚ä¸‹æƒ…å†µï¼š</p>
<table>
<thead>
<tr>
<th>è¿ç®—ç¬¦</th>
<th>é™„åŠ æ¡ä»¶</th>
<th>æ–¹æ³•</th>
</tr>
</thead>
<tbody>
<tr>
<td>=</td>
<td></td>
<td>#parseEqualCondition()</td>
</tr>
<tr>
<td>IN</td>
<td></td>
<td>#parseInCondition()</td>
</tr>
<tr>
<td>BETWEEN</td>
<td></td>
<td>#parseBetweenCondition()</td>
</tr>
<tr>
<td>&lt;, &lt;=, &gt;, &gt;=</td>
<td>Oracle æˆ– SQLServer åˆ†é¡µ</td>
<td>#parseRowNumberCondition()</td>
</tr>
<tr>
<td>&lt;, &lt;=, &gt;, &gt;=</td>
<td></td>
<td>#parseOtherCondition()</td>
</tr>
<tr>
<td>LIKE</td>
<td></td>
<td>parseOtherCondition</td>
</tr>
</tbody>
</table>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£ææ‰€æœ‰æŸ¥è¯¢æ¡ä»¶ã€‚</div><div class="line">* ç›®å‰ä¸æ”¯æŒ OR æ¡ä»¶ã€‚</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlStatement SQL</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseConditions</span><span class="params">(<span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   <span class="comment">// AND æŸ¥è¯¢</span></div><div class="line">   <span class="keyword">do</span> &#123;</div><div class="line">       parseComparisonCondition(sqlStatement);</div><div class="line">   &#125; <span class="keyword">while</span> (skipIfEqual(DefaultKeyword.AND));</div><div class="line">   <span class="comment">// ç›®å‰ä¸æ”¯æŒ OR æ¡ä»¶</span></div><div class="line">   <span class="keyword">if</span> (equalAny(DefaultKeyword.OR)) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(getLexer().getCurrentToken().getType());</div><div class="line">   &#125;</div><div class="line">&#125; </div><div class="line"><span class="comment">// TODO è§£æç»„åˆexpr</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æå•ä¸ªæŸ¥è¯¢æ¡ä»¶</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlStatement SQL</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseComparisonCondition</span><span class="params">(<span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   skipIfEqual(Symbol.LEFT_PAREN);</div><div class="line">   SQLExpression left = parseExpression(sqlStatement);</div><div class="line">   <span class="keyword">if</span> (equalAny(Symbol.EQ)) &#123;</div><div class="line">       parseEqualCondition(sqlStatement, left);</div><div class="line">       skipIfEqual(Symbol.RIGHT_PAREN);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(DefaultKeyword.IN)) &#123;</div><div class="line">       parseInCondition(sqlStatement, left);</div><div class="line">       skipIfEqual(Symbol.RIGHT_PAREN);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(DefaultKeyword.BETWEEN)) &#123;</div><div class="line">       parseBetweenCondition(sqlStatement, left);</div><div class="line">       skipIfEqual(Symbol.RIGHT_PAREN);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(Symbol.LT, Symbol.GT, Symbol.LT_EQ, Symbol.GT_EQ)) &#123;</div><div class="line">       <span class="keyword">if</span> (left <span class="keyword">instanceof</span> SQLIdentifierExpression &amp;&amp; sqlStatement <span class="keyword">instanceof</span> SelectStatement</div><div class="line">               &amp;&amp; isRowNumberCondition((SelectStatement) sqlStatement, ((SQLIdentifierExpression) left).getName())) &#123;</div><div class="line">           parseRowNumberCondition((SelectStatement) sqlStatement);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (left <span class="keyword">instanceof</span> SQLPropertyExpression &amp;&amp; sqlStatement <span class="keyword">instanceof</span> SelectStatement</div><div class="line">               &amp;&amp; isRowNumberCondition((SelectStatement) sqlStatement, ((SQLPropertyExpression) left).getName())) &#123;</div><div class="line">           parseRowNumberCondition((SelectStatement) sqlStatement);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           parseOtherCondition(sqlStatement);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (equalAny(DefaultKeyword.LIKE)) &#123;</div><div class="line">       parseOtherCondition(sqlStatement);</div><div class="line">   &#125;</div><div class="line">   skipIfEqual(Symbol.RIGHT_PAREN);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>#parseComparisonCondition()</code> è§£æåˆ° <code>å·¦SQLè¡¨è¾¾å¼(left)</code> å’Œ è¿ç®—ç¬¦ï¼Œè°ƒç”¨ç›¸åº”æ–¹æ³•è¿›ä¸€æ­¥å¤„ç†ã€‚æˆ‘ä»¬é€‰æ‹© <code>#parseEqualCondition()</code> çœ‹ä¸‹ï¼Œå…¶ä»–æ–¹æ³•æœ‰å…´è¶£è·³è½¬ <a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/master/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/parsing/parser/SQLParser.java" rel="external nofollow noopener noreferrer" target="_blank">SQLParser</a> æŸ¥çœ‹ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æ = æ¡ä»¶</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlStatement SQL</div><div class="line">* <span class="doctag">@param</span> left å·¦SQLExpression</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseEqualCondition</span><span class="params">(<span class="keyword">final</span> SQLStatement sqlStatement, <span class="keyword">final</span> SQLExpression left)</span> </span>&#123;</div><div class="line">   getLexer().nextToken();</div><div class="line">   SQLExpression right = parseExpression(sqlStatement);</div><div class="line">   <span class="comment">// æ·»åŠ åˆ—</span></div><div class="line">   <span class="comment">// TODO å¦‚æœæœ‰å¤šè¡¨,ä¸”æ‰¾ä¸åˆ°columnæ˜¯å“ªä¸ªè¡¨çš„,åˆ™ä¸åŠ å…¥condition,ä»¥åéœ€è¦è§£æbinding table</span></div><div class="line">   <span class="keyword">if</span> ((sqlStatement.getTables().isSingleTable() || left <span class="keyword">instanceof</span> SQLPropertyExpression)</div><div class="line">           <span class="comment">// åªæœ‰å¯¹è·¯ç”±ç»“æœæœ‰å½±å“çš„æ‰ä¼šæ·»åŠ åˆ° conditionsã€‚SQLPropertyExpression å’Œ SQLIdentifierExpression æ— æ³•åˆ¤æ–­ï¼Œæ‰€ä»¥æœªåŠ å…¥ conditions</span></div><div class="line">           &amp;&amp; (right <span class="keyword">instanceof</span> SQLNumberExpression || right <span class="keyword">instanceof</span> SQLTextExpression || right <span class="keyword">instanceof</span> SQLPlaceholderExpression)) &#123;</div><div class="line">       Optional&lt;Column&gt; column = find(sqlStatement.getTables(), left);</div><div class="line">       <span class="keyword">if</span> (column.isPresent()) &#123;</div><div class="line">           sqlStatement.getConditions().add(<span class="keyword">new</span> Condition(column.get(), right), shardingRule);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>#parseEqualCondition()</code> è§£æåˆ° <code>å³SQLè¡¨è¾¾å¼(right)</code>ï¼Œå¹¶åˆ¤æ–­ <code>å·¦å³SQLè¡¨è¾¾å¼</code> ä¸è·¯ç”±é€»è¾‘æ˜¯å¦æœ‰å½±å“ï¼Œå¦‚æœæœ‰ï¼Œåˆ™åŠ å…¥åˆ° Conditionã€‚<strong>è¿™ä¸ªå°±æ˜¯ <code>#parseWhere()</code> çš„ç›®çš„ï¼šè§£æ WHERE æŸ¥è¯¢æ¡ä»¶å¯¹è·¯ç”±æœ‰å½±å“çš„æ¡ä»¶ã€‚</strong><a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šè·¯ç”±ã€‹</a>ç›¸å…³çš„é€»è¾‘ï¼Œä¼šå•ç‹¬å¼€æ–‡ç« ä»‹ç»ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆç•™æœ‰æ˜ åƒã€‚</p>
<h1>4. StatementParser SQLè¯­å¥è§£æå™¨</h1>
<h2>4.1 StatementParser</h2>
<p>StatementParserï¼ŒSQLè¯­å¥è§£æå™¨ã€‚æ¯ç§ SQLï¼Œéƒ½æœ‰ç›¸åº”çš„ SQLè¯­å¥è§£æå™¨å®ç°ã€‚ä¸åŒæ•°æ®åº“ï¼Œç»§æ‰¿è¿™äº› SQLè¯­å¥è§£æå™¨ï¼Œå®ç°å„è‡ª SQL ä¸Šçš„å·®å¼‚ã€‚å¤§ä½“ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/06.png" alt=""></p>
<p>SQLParsingEngine æ ¹æ®ä¸åŒ SQL è°ƒç”¨å¯¹åº”å·¥å‚åˆ›å»º StatementParserã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectParserFactory</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ›å»ºSelectè¯­å¥è§£æå™¨.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> sqlParser SQLè§£æå™¨</div><div class="line">     * <span class="doctag">@return</span> Selectè¯­å¥è§£æå™¨</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AbstractSelectParser <span class="title">newInstance</span><span class="params">(<span class="keyword">final</span> SQLParser sqlParser)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (sqlParser <span class="keyword">instanceof</span> MySQLParser) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> MySQLSelectParser(sqlParser);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (sqlParser <span class="keyword">instanceof</span> OracleParser) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> OracleSelectParser(sqlParser);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (sqlParser <span class="keyword">instanceof</span> SQLServerParser) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SQLServerSelectParser(sqlParser);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (sqlParser <span class="keyword">instanceof</span> PostgreSQLParser) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PostgreSQLSelectParser(sqlParser);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(String.format(<span class="string">"Cannot support sqlParser class [%s]."</span>, sqlParser.getClass()));</div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è°ƒç”¨ <code>StatementParser#parse()</code> å®ç°æ–¹æ³•ï¼Œå¯¹ SQL è¿›è¡Œè§£æã€‚å…·ä½“è§£æè¿‡ç¨‹ï¼Œå¦å¼€æ–‡ç« åˆ†äº«ã€‚</p>
<h2>4.2 Statement</h2>
<p>ä¸åŒ SQL è§£æåï¼Œè¿”å›å¯¹åº”çš„ SQL ç»“æœ,å³ Statementã€‚å¤§ä½“ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/07.png" alt=""></p>
<p>Statement åŒ…å«ä¸¤éƒ¨åˆ†ä¿¡æ¯ï¼š</p>
<ul>
<li>
<p>åˆ†ç‰‡ä¸Šä¸‹æ–‡ï¼šç”¨äº SQL è·¯ç”±ã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/08.png" alt=""></p>
</li>
<li>
<p>SQL æ ‡è®°å¯¹è±¡ï¼šç”¨äº SQL æ”¹å†™ã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_26/09.png" alt=""></p>
</li>
</ul>
<p>æˆ‘ä»¬ä¼šåœ¨åæ–‡å¢åˆ æ”¹æŸ¥SQLè§£æçš„è¿‡ç¨‹ä¸­åˆ†äº«åˆ°å®ƒä»¬ã€‚</p>
<h2>4.3 é¢„å‘Š</h2>
<table>
<thead>
<tr>
<th>Parser</th>
<th>Statement</th>
<th>åˆ†äº«æ–‡ç« </th>
</tr>
</thead>
<tbody>
<tr>
<td>SelectStatementParser</td>
<td>SelectStatement + AbstractSQLStatement</td>
<td><a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠæŸ¥è¯¢SQLè§£æã€‹</a></td>
</tr>
<tr>
<td>InsertStatementParser</td>
<td>InsertStatement</td>
<td><a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šæ’å…¥SQLè§£æã€‹</a></td>
</tr>
<tr>
<td>UpdateStatementParser</td>
<td>UpdateStatement</td>
<td><a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šæ›´æ–°SQLè§£æã€‹</a></td>
</tr>
<tr>
<td>DeleteStatementParser</td>
<td>DeleteStatement</td>
<td><a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šåˆ é™¤SQLè§£æã€‹</a></td>
</tr>
</tbody>
</table>
<h1>5. å½©è›‹</h1>
<p>è€é“ï¼Œæ˜¯ä¸æ˜¯æœ‰ä¸¢ä¸¢é•¿ï¼Ÿ<br>
å¦‚æœæœ‰åœ°æ–¹é”™è¯¯ï¼Œçƒ¦è¯·æŒ‡å‡ºğŸ™‚ã€‚<br>
å¦‚æœæœ‰åœ°æ–¹ä¸æ˜¯å¾ˆç†è§£ï¼Œå¯ä»¥åŠ æˆ‘çš„å…¬ä¼—å·**ï¼ˆ<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">èŠ‹è‰¿çš„åç«¯å°å±‹</a>ï¼‰<strong>ç•™è¨€ï¼Œæˆ‘ä¼š</strong>é€æ¡è®¤çœŸè€å¿ƒ**å›å¤ã€‚<br>
å¦‚æœè§‰å¾—è¿˜å‡‘åˆï¼ŒåŠ³é©¾åˆ†äº«æœ‹å‹åœˆæˆ–è€…åŸºä½¬ã€‚</p>
<p><a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠæŸ¥è¯¢SQLè§£æã€‹</a>å·²ç»å†™äº†ä¸€åŠï¼Œé¢„è®¡å¾ˆå¿«...</p>
<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼š&lt;a href=&quot;http://www.yu
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆä¸€ï¼‰ä¹‹è¯æ³•è§£æ</title>
    <link href="http://www.yunai.me/Sharding-JDBC/sql-parse-1/"/>
    <id>http://www.yunai.me/Sharding-JDBC/sql-parse-1/</id>
    <published>2017-07-22T16:00:00.000Z</published>
    <updated>2017-08-10T17:25:17.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Sharding-JDBC 1.5.0 æ­£å¼ç‰ˆ</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. Lexer è¯æ³•è§£æå™¨</a></li>
<li><a href="#">3. Token è¯æ³•æ ‡è®°</a>
<ul>
<li><a href="#">3.1 DefaultKeyword è¯æ³•å…³é”®è¯</a></li>
<li><a href="#">3.2 Literals è¯æ³•å­—é¢é‡æ ‡è®°</a>
<ul>
<li><a href="#">3.2.1 Literals.IDENTIFIER è¯æ³•å…³é”®è¯</a></li>
<li><a href="#">3.2.2 Literals.VARIABLE å˜é‡</a></li>
<li><a href="#">3.2.3 Literals.CHARS å­—ç¬¦ä¸²</a></li>
<li><a href="#">3.2.4 Literals.HEX åå…­è¿›åˆ¶</a></li>
<li><a href="#">3.2.5 Literals.INT æ•´æ•°</a></li>
<li><a href="#">3.2.6 Literals.FLOAT æµ®ç‚¹æ•°</a></li>
</ul>
</li>
<li><a href="#">3.3 Symbol è¯æ³•ç¬¦å·æ ‡è®°</a></li>
<li><a href="#">3.4 Assist è¯æ³•è¾…åŠ©æ ‡è®°</a></li>
</ul>
</li>
<li><a href="#">4. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p><strong>SQL è§£æå¼•æ“</strong>ï¼Œæ•°æ®åº“ä¸­é—´ä»¶å¿…å¤‡çš„åŠŸèƒ½å’Œæµç¨‹ã€‚Sharding-JDBC åœ¨ <code>1.5.0.M1</code> æ­£å¼å‘å¸ƒæ—¶ï¼Œå°† SQL è§£æå¼•æ“ä» Druid æ›¿æ¢æˆäº†è‡ªç ”çš„ã€‚<strong>æ–°å¼•æ“ä»…è§£æåˆ†ç‰‡ä¸Šä¸‹æ–‡ï¼Œå¯¹äº SQL é‡‡ç”¨&quot;åŠç†è§£&quot;ç†å¿µï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½å’Œå…¼å®¹æ€§ï¼ŒåŒæ—¶é™ä½äº†ä»£ç å¤æ‚åº¦</strong>ï¼ˆä¸ç†è§£æ²¡å…³ç³»ï¼Œæˆ‘ä»¬åç»­ä¼šæ›´æ–°æ–‡ç« è§£é‡Šè¯¥ä¼˜ç‚¹ï¼‰ã€‚ å›½å†…å¦ä¸€æ¬¾æ•°æ®åº“ä¸­é—´ä»¶ MyCAT SQL è§£æå¼•æ“ä¹Ÿæ˜¯ Druidï¼Œç›®å‰ä¹Ÿåœ¨å¼€å‘å±äºè‡ªå·±çš„ SQL è§£æå¼•æ“ã€‚</p>
<p>å¯èƒ½æœ‰åŒå­¦çœ‹åˆ°<strong>SQL è§£æ</strong>ä¼šè¢«å“åˆ°ï¼Œè¯·æ·¡å®šï¼Œè€å¿ƒå¾€ä¸‹çœ‹ã€‚ã€ŠSQL è§£æã€‹å†…å®¹æˆ‘ä»¬ä¼šåˆ†æˆ 5 ç¯‡ç›¸å¯¹ç®€çŸ­çš„æ–‡ç« ï¼Œè®©å¤§å®¶èƒ½å¤Ÿç›¸å¯¹è½»æ¾æ„‰å¿«çš„å»ç†è§£ï¼š</p>
<ol>
<li>è¯æ³•è§£æ</li>
<li>æ’å…¥ SQL è§£æ</li>
<li>æŸ¥è¯¢ SQL è§£æ</li>
<li>æ›´æ–° SQL è§£æ</li>
<li>åˆ é™¤ SQL è§£æ</li>
</ol>
<hr>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_23/01.png" alt=""></p>
<p><strong>SQL è§£æå¼•æ“</strong>åœ¨ <code>parsing</code> åŒ…ä¸‹ï¼Œå¦‚ä¸Šå›¾æ‰€è§åŒ…å«ä¸¤å¤§ç»„ä»¶ï¼š</p>
<ol>
<li>Lexerï¼š<strong>è¯æ³•</strong>è§£æå™¨ã€‚</li>
<li>Parserï¼š<strong>SQL</strong>è§£æå™¨ã€‚</li>
</ol>
<p>ä¸¤è€…éƒ½æ˜¯è§£æå™¨ï¼ŒåŒºåˆ«åœ¨äº Lexer åªåšè¯æ³•çš„è§£æï¼Œä¸å…³æ³¨ä¸Šä¸‹æ–‡ï¼Œå°†å­—ç¬¦ä¸²æ‹†è§£æˆ N ä¸ªè¯æ³•ã€‚è€Œ Parser åœ¨ Lexer çš„åŸºç¡€ä¸Šï¼Œè¿˜éœ€è¦ç†è§£ SQL ã€‚æ‰“ä¸ªæ¯”æ–¹ï¼š</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">SQL ï¼š<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_user  </div><div class="line">Lexer ï¼š[<span class="keyword">SELECT</span>] [ * ] [<span class="keyword">FROM</span>] [t_user]  </div><div class="line">Parser ï¼šè¿™æ˜¯ä¸€æ¡ [<span class="keyword">SELECT</span>] æŸ¥è¯¢è¡¨ä¸º [t_user] ï¼Œå¹¶ä¸”è¿”å› [ * ] æ‰€æœ‰å­—æ®µçš„ <span class="keyword">SQL</span>ã€‚</div></pre></td></tr></table></figure></p>
<p>ğŸ™‚ä¸å®Œå…¨æ‡‚ï¼Ÿæ²¡å…³ç³»ï¼Œæœ¬æ–‡çš„ä¸»è§’æ˜¯ Lexerï¼Œæˆ‘ä»¬é€šè¿‡æºç ä¸€ç‚¹ä¸€ç‚¹ç†è§£ã€‚ä¸€å…± 1400 è¡Œå·¦å³ä»£ç å·¦å³ï¼Œè¿˜åŒ…å«æ³¨é‡Šç­‰ç­‰ï¼Œå®é™…æ›´å°‘å™¢ã€‚</p>
<h1>2. Lexer è¯æ³•è§£æå™¨</h1>
<p><strong>Lexer åŸç†</strong>ï¼š<strong>é¡ºåºé¡ºåºé¡ºåº</strong> è§£æ SQLï¼Œå°†å­—ç¬¦ä¸²æ‹†è§£æˆ N ä¸ªè¯æ³•ã€‚</p>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Lexer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¾“å‡ºå­—ç¬¦ä¸²</div><div class="line">     * æ¯”å¦‚ï¼šSQL</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String input;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¯æ³•æ ‡è®°å­—å…¸</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Dictionary dictionary;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è§£æåˆ° SQL çš„ offset</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> offset;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å½“å‰ è¯æ³•æ ‡è®°</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> Token currentToken;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ†æä¸‹ä¸€ä¸ªè¯æ³•æ ‡è®°.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #currentToken</div><div class="line">     * <span class="doctag">@see</span> #offset</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">nextToken</span><span class="params">()</span> </span>&#123;</div><div class="line">        skipIgnoredToken();</div><div class="line">        <span class="keyword">if</span> (isVariableBegin()) &#123; <span class="comment">// å˜é‡</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanVariable();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isNCharBegin()) &#123; <span class="comment">// N\</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, ++offset).scanChars();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isIdentifierBegin()) &#123; <span class="comment">// Keyword + Literals.IDENTIFIER</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanIdentifier();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isHexDecimalBegin()) &#123; <span class="comment">// åå…­è¿›åˆ¶</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanHexDecimal();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isNumberBegin()) &#123; <span class="comment">// æ•°å­—ï¼ˆæ•´æ•°+æµ®ç‚¹æ•°ï¼‰</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanNumber();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isSymbolBegin()) &#123; <span class="comment">// ç¬¦å·</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanSymbol();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isCharsBegin()) &#123; <span class="comment">// å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼š"abc"</span></div><div class="line">            currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanChars();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isEnd()) &#123; <span class="comment">// ç»“æŸ</span></div><div class="line">            currentToken = <span class="keyword">new</span> Token(Assist.END, <span class="string">""</span>, offset);</div><div class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// åˆ†æé”™è¯¯ï¼Œæ— ç¬¦åˆæ¡ä»¶çš„è¯æ³•æ ‡è®°</span></div><div class="line">            currentToken = <span class="keyword">new</span> Token(Assist.ERROR, <span class="string">""</span>, offset);</div><div class="line">        &#125;</div><div class="line">        offset = currentToken.getEndPosition();</div><div class="line">        <span class="comment">// System.out.println("| " + currentToken.getLiterals() + " | " + currentToken.getType() + " | " + currentToken.getEndPosition() + " |");</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·³è¿‡å¿½ç•¥çš„è¯æ³•æ ‡è®°</div><div class="line">     * 1. ç©ºæ ¼</div><div class="line">     * 2. SQL Hint</div><div class="line">     * 3. SQL æ³¨é‡Š</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">skipIgnoredToken</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// ç©ºæ ¼</span></div><div class="line">        offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipWhitespace();</div><div class="line">        <span class="comment">// SQL Hint</span></div><div class="line">        <span class="keyword">while</span> (isHintBegin()) &#123;</div><div class="line">            offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipHint();</div><div class="line">            offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipWhitespace();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// SQL æ³¨é‡Š</span></div><div class="line">        <span class="keyword">while</span> (isCommentBegin()) &#123;</div><div class="line">            offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipComment();</div><div class="line">            offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipWhitespace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>é€šè¿‡ <code>#nextToken()</code> æ–¹æ³•ï¼Œä¸æ–­è§£æå‡º Token(<em>è¯æ³•æ ‡è®°</em>)ã€‚æˆ‘ä»¬æ¥æ‰§è¡Œä¸€æ¬¡ï¼Œçœ‹çœ‹ SQL ä¼šè¢«æ‹†è§£æˆå“ªäº› Tokenã€‚</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">SQL ï¼š<span class="keyword">SELECT</span> i.* <span class="keyword">FROM</span> t_order o <span class="keyword">JOIN</span> t_order_item i <span class="keyword">ON</span> o.order_id=i.order_id <span class="keyword">WHERE</span> o.user_id=? <span class="keyword">AND</span> o.order_id=?</div></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th>literals</th>
<th>TokenTypeç±»</th>
<th>TokenTypeå€¼</th>
<th>endPosition</th>
</tr>
</thead>
<tbody>
<tr>
<td>SELECT</td>
<td>DefaultKeyword</td>
<td>SELECT</td>
<td>6</td>
</tr>
<tr>
<td>i</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>8</td>
</tr>
<tr>
<td>.</td>
<td>Symbol</td>
<td>DOT</td>
<td>9</td>
</tr>
<tr>
<td>*</td>
<td>Symbol</td>
<td>STAR</td>
<td>10</td>
</tr>
<tr>
<td>FROM</td>
<td>DefaultKeyword</td>
<td>FROM</td>
<td>15</td>
</tr>
<tr>
<td>t_order</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>23</td>
</tr>
<tr>
<td>o</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>25</td>
</tr>
<tr>
<td>JOIN</td>
<td>DefaultKeyword</td>
<td>JOIN</td>
<td>30</td>
</tr>
<tr>
<td>t_order_item</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>43</td>
</tr>
<tr>
<td>i</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>45</td>
</tr>
<tr>
<td>ON</td>
<td>DefaultKeyword</td>
<td>ON</td>
<td>48</td>
</tr>
<tr>
<td>o</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>50</td>
</tr>
<tr>
<td>.</td>
<td>Symbol</td>
<td>DOT</td>
<td>51</td>
</tr>
<tr>
<td>order_id</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>59</td>
</tr>
<tr>
<td>=</td>
<td>Symbol</td>
<td>EQ</td>
<td>60</td>
</tr>
<tr>
<td>i</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>61</td>
</tr>
<tr>
<td>.</td>
<td>Symbol</td>
<td>DOT</td>
<td>62</td>
</tr>
<tr>
<td>order_id</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>70</td>
</tr>
<tr>
<td>WHERE</td>
<td>DefaultKeyword</td>
<td>WHERE</td>
<td>76</td>
</tr>
<tr>
<td>o</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>78</td>
</tr>
<tr>
<td>.</td>
<td>Symbol</td>
<td>DOT</td>
<td>79</td>
</tr>
<tr>
<td>user_id</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>86</td>
</tr>
<tr>
<td>=</td>
<td>Symbol</td>
<td>EQ</td>
<td>87</td>
</tr>
<tr>
<td>?</td>
<td>Symbol</td>
<td>QUESTION</td>
<td>88</td>
</tr>
<tr>
<td>AND</td>
<td>DefaultKeyword</td>
<td>AND</td>
<td>92</td>
</tr>
<tr>
<td>o</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>94</td>
</tr>
<tr>
<td>.</td>
<td>Symbol</td>
<td>DOT</td>
<td>95</td>
</tr>
<tr>
<td>order_id</td>
<td>Literals</td>
<td>IDENTIFIER</td>
<td>103</td>
</tr>
<tr>
<td>=</td>
<td>Symbol</td>
<td>EQ</td>
<td>104</td>
</tr>
<tr>
<td>?</td>
<td>Symbol</td>
<td>QUESTION</td>
<td>105</td>
</tr>
<tr>
<td></td>
<td>Assist</td>
<td>END</td>
<td>105</td>
</tr>
</tbody>
</table>
<p>çœ¼å°–çš„åŒå­¦å¯èƒ½çœ‹åˆ°äº† Tokenizerã€‚å¯¹çš„ï¼Œå®ƒæ˜¯ Lexer çš„å¥½åŸºä½¬ï¼Œè´Ÿè´£<strong>åˆ†è¯</strong>ã€‚</p>
<p><em>æˆ‘ä»¬æ¥æ€»ç»“ä¸‹ï¼Œ<code>Lexer#nextToken()</code> æ–¹æ³•é‡Œï¼Œä½¿ç”¨ <code>#skipIgnoredToken()</code> æ–¹æ³•è·³è¿‡å¿½ç•¥çš„ Tokenï¼Œé€šè¿‡ <code>#isXXXX()</code> æ–¹æ³•åˆ¤æ–­å¥½ä¸‹ä¸€ä¸ª Token çš„ç±»å‹åï¼Œ<strong>äº¤ç»™ Tokenizer è¿›è¡Œåˆ†è¯è¿”å› Token</strong>ã€‚â€¼ï¸æ­¤å¤„å¯ä»¥è€ƒè™‘åšä¸ªä¼˜åŒ–ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½ <code>new Tokenizer(...)</code> å‡ºæ¥ï¼Œä¸€ä¸ª Lexer æ­é…ä¸€ä¸ª Tokenizerã€‚</em></p>
<hr>
<p>ç”±äºä¸åŒæ•°æ®åº“éµå®ˆ SQL è§„èŒƒç•¥æœ‰ä¸åŒï¼Œæ‰€ä»¥ä¸åŒçš„æ•°æ®åº“å¯¹åº”ä¸åŒçš„ Lexerã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_23/02.png" alt=""></p>
<p>å­ Lexer é€šè¿‡é‡å†™æ–¹æ³•å®ç°è‡ªå·±ç‹¬æœ‰çš„ SQL è¯­æ³•ã€‚</p>
<h1>3. Token è¯æ³•æ ‡è®°</h1>
<p>ä¸Šæ–‡æˆ‘ä»¬å·²ç»çœ‹è¿‡ Token çš„ä¾‹å­ï¼Œä¸€å…±æœ‰ 3 ä¸ªå±æ€§ï¼š</p>
<ul>
<li>TokenType type ï¼šè¯æ³•æ ‡è®°ç±»å‹</li>
<li>String literals ï¼šè¯æ³•å­—é¢é‡æ ‡è®°</li>
<li>int endPosition ï¼š<code>literals</code> åœ¨ SQL é‡Œçš„ç»“æŸä½ç½®</li>
</ul>
<p>TokenType è¯æ³•æ ‡è®°ç±»å‹ï¼Œä¸€å…±åˆ†æˆ 4 ä¸ªå¤§ç±»ï¼š</p>
<ul>
<li>DefaultKeyword ï¼šè¯æ³•å…³é”®è¯</li>
<li>Literals ï¼šè¯æ³•å­—é¢é‡æ ‡è®°</li>
<li>Symbol ï¼šè¯æ³•ç¬¦å·æ ‡è®°</li>
<li>Assist ï¼šè¯æ³•è¾…åŠ©æ ‡è®°</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_23/03.png" alt=""></p>
<h2>3.1 DefaultKeyword è¯æ³•å…³é”®è¯</h2>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_23/04.png" alt=""></p>
<p><strong>ä¸åŒæ•°æ®åº“æœ‰è‡ªå·±ç‹¬æœ‰çš„_è¯æ³•å…³é”®è¯_ï¼Œä¾‹å¦‚ MySQL ç†ŸçŸ¥çš„åˆ†é¡µ Limitã€‚</strong></p>
<p>æˆ‘ä»¬ä»¥ MySQL ä¸¾ä¸ªä¾‹å­ï¼Œå½“åˆ›å»º MySQLLexer æ—¶ï¼Œä¼šåŠ è½½ DefaultKeyword å’Œ MySQLKeywordï¼ˆ <em>OracleLexerã€PostgreSQLLexerã€SQLServerLexer åŒ MySQLLexer</em> ï¼‰ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MySQLLexer.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MySQLLexer</span> <span class="keyword">extends</span> <span class="title">Lexer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å­—å…¸</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Dictionary dictionary = <span class="keyword">new</span> Dictionary(MySQLKeyword.values());</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MySQLLexer</span><span class="params">(<span class="keyword">final</span> String input)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(input, dictionary);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Dictionary.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Dictionary</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¯æ³•å…³é”®è¯Map</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Keyword&gt; tokens = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1024</span>);</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Dictionary</span><span class="params">(<span class="keyword">final</span> Keyword... dialectKeywords)</span> </span>&#123;</div><div class="line">        fill(dialectKeywords);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è£…ä¸Šé»˜è®¤è¯æ³•å…³é”®è¯ + æ–¹è¨€è¯æ³•å…³é”®è¯</div><div class="line">     * ä¸åŒçš„æ•°æ®åº“æœ‰ç›¸åŒçš„é»˜è®¤è¯æ³•å…³é”®è¯ï¼Œæœ‰æœ‰ä¸åŒçš„æ–¹è¨€å…³é”®è¯</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> dialectKeywords æ–¹è¨€è¯æ³•å…³é”®è¯</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fill</span><span class="params">(<span class="keyword">final</span> Keyword... dialectKeywords)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (DefaultKeyword each : DefaultKeyword.values()) &#123;</div><div class="line">            tokens.put(each.name(), each);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (Keyword each : dialectKeywords) &#123;</div><div class="line">            tokens.put(each.toString(), each);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Keyword ä¸ Literals.IDENTIFIER æ˜¯ä¸€èµ·è§£æçš„ï¼Œæˆ‘ä»¬æ”¾åœ¨ Literals.IDENTIFIER å¤„ä¸€èµ·åˆ†æã€‚</p>
<h2>3.2 Literals è¯æ³•å­—é¢é‡æ ‡è®°</h2>
<p>Literals è¯æ³•å­—é¢é‡æ ‡è®°ï¼Œä¸€å…±åˆ†æˆ 6 ç§ï¼š</p>
<ul>
<li>IDENTIFIER ï¼šè¯æ³•å…³é”®è¯</li>
<li>VARIABLE ï¼šå˜é‡</li>
<li>CHARS ï¼šå­—ç¬¦ä¸²</li>
<li>HEX ï¼šåå…­è¿›åˆ¶</li>
<li>INT ï¼šæ•´æ•°</li>
<li>FLOAT ï¼šæµ®ç‚¹æ•°</li>
</ul>
<h3>3.2.1 Literals.IDENTIFIER è¯æ³•å…³é”®è¯</h3>
<p>è¯æ³•å…³é”®è¯ã€‚ä¾‹å¦‚ï¼šè¡¨åï¼ŒæŸ¥è¯¢å­—æ®µ ç­‰ç­‰ã€‚</p>
<p>è§£æ Literals.IDENTIFIER ä¸ Keyword æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isIdentifierBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> isIdentifierBegin(getCurrentChar(<span class="number">0</span>));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isIdentifierBegin</span><span class="params">(<span class="keyword">final</span> <span class="keyword">char</span> ch)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> CharType.isAlphabet(ch) || <span class="string">'`'</span> == ch || <span class="string">'_'</span> == ch || <span class="string">'$'</span> == ch;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Tokenizer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰«ææ ‡è¯†ç¬¦.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> æ ‡è¯†ç¬¦æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Token <span class="title">scanIdentifier</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// `å­—æ®µ`ï¼Œä¾‹å¦‚ï¼šSELECT `id` FROM t_user ä¸­çš„ `id`</span></div><div class="line">   <span class="keyword">if</span> (<span class="string">'`'</span> == charAt(offset)) &#123;</div><div class="line">       <span class="keyword">int</span> length = getLengthUntilTerminatedChar(<span class="string">'`'</span>);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Token(Literals.IDENTIFIER, input.substring(offset, offset + length), offset + length);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">int</span> length = <span class="number">0</span>;</div><div class="line">   <span class="keyword">while</span> (isIdentifierChar(charAt(offset + length))) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   String literals = input.substring(offset, offset + length);</div><div class="line">   <span class="comment">// å¤„ç† order / group ä½œä¸ºè¡¨å</span></div><div class="line">   <span class="keyword">if</span> (isAmbiguousIdentifier(literals)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Token(processAmbiguousIdentifier(offset + length, literals), literals, offset + length);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ä» è¯æ³•å…³é”®è¯ æŸ¥æ‰¾æ˜¯å¦æ˜¯ Keywordï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› Keywordï¼Œå¦åˆ™è¿”å› Literals.IDENTIFIER</span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Token(dictionary.findTokenType(literals, Literals.IDENTIFIER), literals, offset + length);</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¡ç®—åˆ°ç»“æŸå­—ç¬¦çš„é•¿åº¦</div><div class="line">*</div><div class="line">* <span class="doctag">@see</span> #hasEscapeChar(char, int) å¤„ç†ç±»ä¼¼ SELECT a AS `b``c` FROM tableã€‚æ­¤å¤„è¿ç»­çš„ "``" ä¸æ˜¯ç»“å°¾ï¼Œå¦‚æœä¼ é€’çš„æ˜¯ "`" ä¼šäº§ç”Ÿè¯¯åˆ¤ï¼Œæ‰€ä»¥åŠ äº†è¿™ä¸ªåˆ¤æ–­</div><div class="line">* <span class="doctag">@param</span> terminatedChar ç»“æŸå­—ç¬¦</div><div class="line">* <span class="doctag">@return</span> é•¿åº¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getLengthUntilTerminatedChar</span><span class="params">(<span class="keyword">final</span> <span class="keyword">char</span> terminatedChar)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> length = <span class="number">1</span>;</div><div class="line">   <span class="keyword">while</span> (terminatedChar != charAt(offset + length) || hasEscapeChar(terminatedChar, offset + length)) &#123;</div><div class="line">       <span class="keyword">if</span> (offset + length &gt;= input.length()) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnterminatedCharException(terminatedChar);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (hasEscapeChar(terminatedChar, offset + length)) &#123;</div><div class="line">           length++;</div><div class="line">       &#125;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> length + <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦æ˜¯ Escape å­—ç¬¦</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> charIdentifier å­—ç¬¦</div><div class="line">* <span class="doctag">@param</span> offset ä½ç½®</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasEscapeChar</span><span class="params">(<span class="keyword">final</span> <span class="keyword">char</span> charIdentifier, <span class="keyword">final</span> <span class="keyword">int</span> offset)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> charIdentifier == charAt(offset) &amp;&amp; charIdentifier == charAt(offset + <span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isIdentifierChar</span><span class="params">(<span class="keyword">final</span> <span class="keyword">char</span> ch)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> CharType.isAlphabet(ch) || CharType.isDigital(ch) || <span class="string">'_'</span> == ch || <span class="string">'$'</span> == ch || <span class="string">'#'</span> == ch;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦æ˜¯å¼•èµ·æ­§ä¹‰çš„æ ‡è¯†ç¬¦</div><div class="line">* ä¾‹å¦‚ "SELECT * FROM group"ï¼Œæ­¤æ—¶ "group" ä»£è¡¨çš„æ˜¯è¡¨åï¼Œè€Œéè¯æ³•å…³é”®è¯</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> literals æ ‡è¯†ç¬¦</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isAmbiguousIdentifier</span><span class="params">(<span class="keyword">final</span> String literals)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> DefaultKeyword.ORDER.name().equalsIgnoreCase(literals) || DefaultKeyword.GROUP.name().equalsIgnoreCase(literals);</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–å¼•èµ·æ­§ä¹‰çš„æ ‡è¯†ç¬¦å¯¹åº”çš„è¯æ³•æ ‡è®°ç±»å‹</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> offset ä½ç½®</div><div class="line">* <span class="doctag">@param</span> literals æ ‡è¯†ç¬¦</div><div class="line">* <span class="doctag">@return</span> è¯æ³•æ ‡è®°ç±»å‹</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> TokenType <span class="title">processAmbiguousIdentifier</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> offset, <span class="keyword">final</span> String literals)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">   <span class="keyword">while</span> (CharType.isWhitespace(charAt(offset + i))) &#123;</div><div class="line">       i++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (DefaultKeyword.BY.name().equalsIgnoreCase(String.valueOf(<span class="keyword">new</span> <span class="keyword">char</span>[] &#123;charAt(offset + i), charAt(offset + i + <span class="number">1</span>)&#125;))) &#123;</div><div class="line">       <span class="keyword">return</span> dictionary.findTokenType(literals);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> Literals.IDENTIFIER;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>3.2.2 Literals.VARIABLE å˜é‡</h3>
<p>å˜é‡ã€‚ä¾‹å¦‚ï¼š<code>SELECT @@VERSION</code> ã€‚</p>
<p>è§£ææ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦æ˜¯ å˜é‡</div><div class="line">* MySQL ä¸ SQL Server æ”¯æŒ</div><div class="line">* </div><div class="line">* <span class="doctag">@see</span> Tokenizer#scanVariable()</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isVariableBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Tokenizer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰«æå˜é‡.</div><div class="line">* åœ¨ MySQL é‡Œï¼Œ@ä»£è¡¨ç”¨æˆ·å˜é‡ï¼›@@ä»£è¡¨ç³»ç»Ÿå˜é‡ã€‚</div><div class="line">* åœ¨ SQLServer é‡Œï¼Œæœ‰ @@ã€‚</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> å˜é‡æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Token <span class="title">scanVariable</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> length = <span class="number">1</span>;</div><div class="line">   <span class="keyword">if</span> (<span class="string">'@'</span> == charAt(offset + <span class="number">1</span>)) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">while</span> (isVariableChar(charAt(offset + length))) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Token(Literals.VARIABLE, input.substring(offset, offset + length), offset + length);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>3.2.3 Literals.CHARS å­—ç¬¦ä¸²</h3>
<p>å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚ï¼š<code>SELECT &quot;123&quot;</code> ã€‚</p>
<p>è§£ææ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦ N\</div><div class="line">* ç›®å‰ SQLServer ç‹¬æœ‰ï¼šåœ¨ SQL Server ä¸­è™•ç† Unicode å­—ä¸²å¸¸æ•¸æ™‚ï¼Œå¿…éœ€ç‚ºæ‰€æœ‰çš„ Unicode å­—ä¸²åŠ ä¸Šå‰ç½®è© N</div><div class="line">*</div><div class="line">* <span class="doctag">@see</span> Tokenizer#scanChars()</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isNCharBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> isSupportNChars() &amp;&amp; <span class="string">'N'</span> == getCurrentChar(<span class="number">0</span>) &amp;&amp; <span class="string">'\''</span> == getCurrentChar(<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isCharsBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="string">'\''</span> == getCurrentChar(<span class="number">0</span>) || <span class="string">'\"'</span> == getCurrentChar(<span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Tokenizer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰«æå­—ç¬¦ä¸².</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> å­—ç¬¦ä¸²æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Token <span class="title">scanChars</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> scanChars(charAt(offset));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> Token <span class="title">scanChars</span><span class="params">(<span class="keyword">final</span> <span class="keyword">char</span> terminatedChar)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> length = getLengthUntilTerminatedChar(terminatedChar);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Token(Literals.CHARS, input.substring(offset + <span class="number">1</span>, offset + length - <span class="number">1</span>), offset + length);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>3.2.4 Literals.HEX åå…­è¿›åˆ¶</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦æ˜¯ åå…­è¿›åˆ¶</div><div class="line">*</div><div class="line">* <span class="doctag">@see</span> Tokenizer#scanHexDecimal()</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isHexDecimalBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="string">'0'</span> == getCurrentChar(<span class="number">0</span>) &amp;&amp; <span class="string">'x'</span> == getCurrentChar(<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Tokenizer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰«æåå…­è¿›åˆ¶æ•°.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> åå…­è¿›åˆ¶æ•°æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Token <span class="title">scanHexDecimal</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> length = HEX_BEGIN_SYMBOL_LENGTH;</div><div class="line">   <span class="comment">// è´Ÿæ•°</span></div><div class="line">   <span class="keyword">if</span> (<span class="string">'-'</span> == charAt(offset + length)) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">while</span> (isHex(charAt(offset + length))) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Token(Literals.HEX, input.substring(offset, offset + length), offset + length);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>3.2.5 Literals.INT æ•´æ•°</h3>
<p>æ•´æ•°ã€‚ä¾‹å¦‚ï¼š<code>SELECT * FROM t_user WHERE id = 1</code>ã€‚</p>
<p>Literals.INT ä¸ Literals.FLOAT æ˜¯ä¸€èµ·è§£æçš„ï¼Œæˆ‘ä»¬æ”¾åœ¨ Literals.FLOAT å¤„ä¸€èµ·åˆ†æã€‚</p>
<h3>3.2.6 Literals.FLOAT æµ®ç‚¹æ•°</h3>
<p>æµ®ç‚¹æ•°ã€‚ä¾‹å¦‚ï¼š<code>SELECT * FROM t_user WHERE id = 1.0</code>ã€‚
æµ®ç‚¹æ•°åŒ…å«å‡ ç§ï¼š&quot;1.0&quot;ï¼Œ&quot;1.0F&quot;ï¼Œ&quot;7.823E5&quot;ï¼ˆç§‘å­¦è®¡æ•°æ³•ï¼‰ã€‚</p>
<p>è§£ææ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦æ˜¯ æ•°å­—</div><div class="line">* '-' éœ€è¦ç‰¹æ®Šå¤„ç†ã€‚".2" è¢«å¤„ç†æˆçœç•¥0çš„å°æ•°ï¼Œ"-.2" ä¸èƒ½è¢«å¤„ç†æˆçœç•¥çš„å°æ•°ï¼Œå¦åˆ™ä¼šå‡ºé—®é¢˜ã€‚</div><div class="line">* ä¾‹å¦‚è¯´ï¼Œ"SELECT a-.2" å¤„ç†çš„ç»“æœæ˜¯ "SELECT" / "a" / "-" / ".2"</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isNumberBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> CharType.isDigital(getCurrentChar(<span class="number">0</span>)) <span class="comment">// æ•°å­—</span></div><div class="line">           || (<span class="string">'.'</span> == getCurrentChar(<span class="number">0</span>) &amp;&amp; CharType.isDigital(getCurrentChar(<span class="number">1</span>)) &amp;&amp; !isIdentifierBegin(getCurrentChar(-<span class="number">1</span>)) <span class="comment">// æµ®ç‚¹æ•°</span></div><div class="line">           || (<span class="string">'-'</span> == getCurrentChar(<span class="number">0</span>) &amp;&amp; (<span class="string">'.'</span> == getCurrentChar(<span class="number">0</span>) || CharType.isDigital(getCurrentChar(<span class="number">1</span>))))); <span class="comment">// è´Ÿæ•°</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Tokenizer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰«ææ•°å­—.</div><div class="line">* è§£ææ•°å­—çš„ç»“æœä¼šæœ‰ä¸¤ç§ï¼šæ•´æ•° å’Œ æµ®ç‚¹æ•°.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> æ•°å­—æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Token <span class="title">scanNumber</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> length = <span class="number">0</span>;</div><div class="line">   <span class="comment">// è´Ÿæ•°</span></div><div class="line">   <span class="keyword">if</span> (<span class="string">'-'</span> == charAt(offset + length)) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æµ®ç‚¹æ•°</span></div><div class="line">   length += getDigitalLength(offset + length);</div><div class="line">   <span class="keyword">boolean</span> isFloat = <span class="keyword">false</span>;</div><div class="line">   <span class="keyword">if</span> (<span class="string">'.'</span> == charAt(offset + length)) &#123;</div><div class="line">       isFloat = <span class="keyword">true</span>;</div><div class="line">       length++;</div><div class="line">       length += getDigitalLength(offset + length);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç§‘å­¦è®¡æ•°è¡¨ç¤ºï¼Œä¾‹å¦‚ï¼šSELECT 7.823E5</span></div><div class="line">   <span class="keyword">if</span> (isScientificNotation(offset + length)) &#123;</div><div class="line">       isFloat = <span class="keyword">true</span>;</div><div class="line">       length++;</div><div class="line">       <span class="keyword">if</span> (<span class="string">'+'</span> == charAt(offset + length) || <span class="string">'-'</span> == charAt(offset + length)) &#123;</div><div class="line">           length++;</div><div class="line">       &#125;</div><div class="line">       length += getDigitalLength(offset + length);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æµ®ç‚¹æ•°ï¼Œä¾‹å¦‚ï¼šSELECT 1.333F</span></div><div class="line">   <span class="keyword">if</span> (isBinaryNumber(offset + length)) &#123;</div><div class="line">       isFloat = <span class="keyword">true</span>;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Token(isFloat ? Literals.FLOAT : Literals.INT, input.substring(offset, offset + length), offset + length);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œè¦ç‰¹åˆ«æ³¨æ„ä¸‹ï¼š<strong>&quot;-&quot;</strong>ã€‚åœ¨æ•°å­—è¡¨è¾¾å®ä¾‹ï¼Œå¯ä»¥åˆ¤å®šä¸º è´Ÿå· å’Œ å‡å·ï¼ˆä¸è€ƒè™‘ç§‘å­¦è®¡æ•°æ³•ï¼‰ã€‚</p>
<ul>
<li>&quot;.2&quot;  è§£æç»“æœæ˜¯ &quot;.2&quot;</li>
<li>&quot;-.2&quot; è§£æç»“æœä¸èƒ½æ˜¯ &quot;-.2&quot;ï¼Œè€Œæ˜¯ &quot;-&quot; å’Œ &quot;.2&quot;ã€‚</li>
</ul>
<h2>3.3 Symbol è¯æ³•ç¬¦å·æ ‡è®°</h2>
<p>è¯æ³•ç¬¦å·æ ‡è®°ã€‚ä¾‹å¦‚ï¼š&quot;{&quot;, &quot;}&quot;, &quot;&gt;=&quot; ç­‰ç­‰ã€‚</p>
<p>è§£ææ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lexer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦æ˜¯ ç¬¦å·</div><div class="line">*</div><div class="line">* <span class="doctag">@see</span> Tokenizer#scanSymbol()</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSymbolBegin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> CharType.isSymbol(getCurrentChar(<span class="number">0</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CharType.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ¤æ–­æ˜¯å¦ä¸ºç¬¦å·.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> ch å¾…åˆ¤æ–­çš„å­—ç¬¦</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦ä¸ºç¬¦å·</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isSymbol</span><span class="params">(<span class="keyword">final</span> <span class="keyword">char</span> ch)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="string">'('</span> == ch || <span class="string">')'</span> == ch || <span class="string">'['</span> == ch || <span class="string">']'</span> == ch || <span class="string">'&#123;'</span> == ch || <span class="string">'&#125;'</span> == ch || <span class="string">'+'</span> == ch || <span class="string">'-'</span> == ch || <span class="string">'*'</span> == ch || <span class="string">'/'</span> == ch || <span class="string">'%'</span> == ch || <span class="string">'^'</span> == ch || <span class="string">'='</span> == ch</div><div class="line">           || <span class="string">'&gt;'</span> == ch || <span class="string">'&lt;'</span> == ch || <span class="string">'~'</span> == ch || <span class="string">'!'</span> == ch || <span class="string">'?'</span> == ch || <span class="string">'&amp;'</span> == ch || <span class="string">'|'</span> == ch || <span class="string">'.'</span> == ch || <span class="string">':'</span> == ch || <span class="string">'#'</span> == ch || <span class="string">','</span> == ch || <span class="string">';'</span> == ch;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Tokenizer.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰«æç¬¦å·.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> ç¬¦å·æ ‡è®°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Token <span class="title">scanSymbol</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> length = <span class="number">0</span>;</div><div class="line">   <span class="keyword">while</span> (CharType.isSymbol(charAt(offset + length))) &#123;</div><div class="line">       length++;</div><div class="line">   &#125;</div><div class="line">   String literals = input.substring(offset, offset + length);</div><div class="line">   <span class="comment">// å€’åºéå†ï¼ŒæŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„ ç¬¦å·ã€‚ä¾‹å¦‚ literals = ";;"ï¼Œä¼šæ˜¯æ‹†åˆ†æˆä¸¤ä¸ª ";"ã€‚å¦‚æœåŸºäºæ­£åºï¼Œliterals = "&lt;="ï¼Œä¼šè¢«è§£ææˆ "&lt;" + "="ã€‚</span></div><div class="line">   Symbol symbol;</div><div class="line">   <span class="keyword">while</span> (<span class="keyword">null</span> == (symbol = Symbol.literalsOf(literals))) &#123;</div><div class="line">       literals = input.substring(offset, offset + --length);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Token(symbol, literals, offset + length);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.4 Assist è¯æ³•è¾…åŠ©æ ‡è®°</h2>
<p>Assist è¯æ³•è¾…åŠ©æ ‡è®°ï¼Œä¸€å…±åˆ†æˆ 2 ç§ï¼š</p>
<ul>
<li>END ï¼šåˆ†æç»“æŸ</li>
<li>ERROR ï¼šåˆ†æé”™è¯¯ã€‚</li>
</ul>
<h1>4. å½©è›‹</h1>
<p>è€é“ï¼Œæ˜¯ä¸æ˜¯æ¯”æƒ³è±¡ä¸­ç®€å•ä¸€äº›ï¼Ÿï¼ç»§ç»­åŠ æ²¹å†™ Parser ç›¸å…³çš„æ–‡ç« ï¼æ¥ä¸€æ³¢å¾®ä¿¡å…¬ä¼—å·å…³æ³¨å§ã€‚</p>
<hr>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¹¿çš„åœºæ™¯ã€‚ç™»è®°å§ï¼Œå°‘å¹´ï¼</strong></p>
<hr>
<p><strong>æˆ‘åˆ›å»ºäº†ä¸€ä¸ªå¾®ä¿¡ç¾¤ã€æºç åœˆã€‘ï¼Œå¸Œæœ›å’Œå¤§å®¶åˆ†äº«äº¤æµè¯»æºç çš„ç»éªŒã€‚<br>
è¯»æºç å…ˆéš¾åæ˜“ï¼ŒæŒæ¡æ–¹æ³•åï¼Œå¯ä»¥åšæ›´æœ‰æ·±åº¦çš„å­¦ä¹ ã€‚<br>
è€Œä¸”æŒæ¡æ–¹æ³•å¹¶ä¸éš¾å™¢ã€‚<br>
åŠ ç¾¤æ–¹å¼ï¼šå¾®ä¿¡å…¬ä¼—å·å‘é€å…³é”®å­—ã€qunã€‘ã€‚</strong></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>MyCAT æºç åˆ†æ  â€”â€” SQL ON MongoDB</title>
    <link href="http://www.yunai.me/MyCAT/connect-mongodb/"/>
    <id>http://www.yunai.me/MyCAT/connect-mongodb/</id>
    <published>2017-07-18T16:00:00.000Z</published>
    <updated>2017-07-31T12:30:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ä¸»æµç¨‹</a></li>
<li><a href="#">3. æŸ¥è¯¢æ“ä½œ</a></li>
<li><a href="#">4. æ’å…¥æ“ä½œ</a></li>
<li><a href="#">5. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>å¯èƒ½ä½ åœ¨çœ‹åˆ°è¿™ä¸ªæ ‡é¢˜ä¼šå°å°çš„åƒæƒŠï¼ŒMyCAT èƒ½ä½¿ç”¨ MongoDB åšæ•°æ®èŠ‚ç‚¹ã€‚æ˜¯çš„ï¼Œæ²¡é”™ï¼Œç¡®å®å¯ä»¥ã€‚<br>
å¼å¼å¼ï¼Œè®©æˆ‘ä»¬å¼€å¯è¿™æ®µç¥å¥‡çš„â€œæ—…é€”â€ã€‚</p>
<p>æœ¬æ–‡ä¸»è¦åˆ†æˆå››éƒ¨åˆ†ï¼š</p>
<ol>
<li>æ€»ä½“æµç¨‹ï¼Œè®©ä½ æœ‰ä¸ªæ•´ä½“çš„è®¤è¯†</li>
<li>æŸ¥è¯¢æ“ä½œ</li>
<li>æ’å…¥æ“ä½œ</li>
<li>å½©è›‹ï¼ŒğŸ˜ˆå½©è›‹ï¼ŒğŸ™‚å½©è›‹</li>
</ol>
<p>å»ºè®®ä½ çœ‹è¿‡è¿™ä¸¤ç¯‡æ–‡ç« ï¼ˆ<em>éå¿…é¡»</em>ï¼‰ï¼š</p>
<ol>
<li><a href="http://www.yunai.me/MyCAT/single-db-single-table-insert/?self">ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹</a></li>
<li><a href="http://www.yunai.me/MyCAT/single-db-single-table-select/?self">ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹</a></li>
</ol>
<h1>2. ä¸»æµç¨‹</h1>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_19/01.png" alt=""></p>
<ol>
<li><code>MyCAT Server</code> æ¥æ”¶ <code>MySQL Client</code> åŸºäº <strong>MySQLåè®®</strong> çš„è¯·æ±‚ï¼Œç¿»è¯‘ <strong>SQL</strong> æˆ <strong>MongoDBæ“ä½œ</strong> å‘é€ç»™ <code>MongoDB Server</code>ã€‚</li>
<li><code>MyCAT Server</code> æ¥æ”¶ <code>MongoDB Server</code> è¿”å›çš„ <strong>MongoDBæ•°æ®</strong>ï¼Œç¿»è¯‘æˆ <code>MySQLæ•°æ®ç»“æœ</code> è¿”å›ç»™ <code>MySQL Client</code>ã€‚</li>
</ol>
<p>è¿™æ ·ä¸€çœ‹ï¼ŒMyCAT è¿æ¥ MongoDB æ˜¯ä¸æ˜¯å°‘ç¥å¥‡ä¸€ç‚¹åˆ—ã€‚</p>
<hr>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_19/02.png" alt=""></p>
<blockquote>
<p>Javaæ•°æ®åº“è¿æ¥ï¼Œï¼ˆJava Database Connectivityï¼Œç®€ç§°JDBCï¼‰æ˜¯Javaè¯­è¨€ä¸­ç”¨æ¥è§„èŒƒå®¢æˆ·ç«¯ç¨‹åºå¦‚ä½•æ¥è®¿é—®æ•°æ®åº“çš„åº”ç”¨ç¨‹åºæ¥å£ï¼Œæä¾›äº†è¯¸å¦‚æŸ¥è¯¢å’Œæ›´æ–°æ•°æ®åº“ä¸­æ•°æ®çš„æ–¹æ³•ã€‚JDBCä¹Ÿæ˜¯Sun Microsystemsçš„å•†æ ‡ã€‚JDBCæ˜¯é¢å‘å…³ç³»å‹æ•°æ®åº“çš„ã€‚</p>
</blockquote>
<p>MyCAT ä½¿ç”¨ JDBC è§„èŒƒï¼ŒæŠ½è±¡äº†å¯¹ MongoDB çš„è®¿é—®ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼ŒMyCAT ä¹ŸæŠ½è±¡äº† SequoiaDB çš„è®¿é—®ã€‚å¯èƒ½è¿™æ ·è¯´æ³•æœ‰äº›æŠ½è±¡ï¼Œçœ‹ä¸ªç±»å›¾å‹å‹æƒŠã€‚</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_19/03.png" alt=""></p>
<p>æ˜¯ä¸æ˜¯ç†Ÿæ‚‰çš„å‘³é“ã€‚<strong>ä¸å¾—ä¸è¯´ JDBC è§„èŒƒçš„ç²¾å¦™ã€‚</strong></p>
<h1>3. æŸ¥è¯¢æ“ä½œ</h1>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">id</span>, <span class="keyword">name</span> <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> <span class="keyword">name</span> &gt; <span class="string">''</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> _id <span class="keyword">DESC</span>;</div></pre></td></tr></table></figure></p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_19/04.png" alt=""></p>
<p>çœ‹é¡ºåºå›¾å·²ç»å¾ˆæ–¹ä¾¿çš„ç†è§£æ•´ä½“é€»è¾‘ï¼Œæˆ‘å°±ä¸å¤šåºŸè¯å•¦ã€‚æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªæ ¸å¿ƒçš„ä»£ç é€»è¾‘ã€‚</p>
<p><strong>1ã€æŸ¥è¯¢ MongoDB</strong></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MongoSQLParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> MongoData <span class="title">query</span><span class="params">()</span> <span class="keyword">throws</span> MongoSQLException </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!(statement <span class="keyword">instanceof</span> SQLSelectStatement)) &#123;</div><div class="line">       <span class="comment">//return null;</span></div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"not a query sql statement"</span>);</div><div class="line">   &#125;</div><div class="line">   MongoData mongo = <span class="keyword">new</span> MongoData();</div><div class="line">   DBCursor c = <span class="keyword">null</span>;</div><div class="line">   SQLSelectStatement selectStmt = (SQLSelectStatement) statement;</div><div class="line">   SQLSelectQuery sqlSelectQuery = selectStmt.getSelect().getQuery();</div><div class="line">   <span class="keyword">int</span> icount = <span class="number">0</span>;</div><div class="line">   <span class="keyword">if</span> (sqlSelectQuery <span class="keyword">instanceof</span> MySqlSelectQueryBlock) &#123;</div><div class="line">       MySqlSelectQueryBlock mysqlSelectQuery = (MySqlSelectQueryBlock) selectStmt.getSelect().getQuery();</div><div class="line"></div><div class="line">       BasicDBObject fields = <span class="keyword">new</span> BasicDBObject();</div><div class="line"></div><div class="line">       <span class="comment">// æ˜¾ç¤ºï¼ˆè¿”å›ï¼‰çš„å­—æ®µ</span></div><div class="line">       <span class="keyword">for</span> (SQLSelectItem item : mysqlSelectQuery.getSelectList()) &#123;</div><div class="line">           <span class="comment">//System.out.println(item.toString());</span></div><div class="line">           <span class="keyword">if</span> (!(item.getExpr() <span class="keyword">instanceof</span> SQLAllColumnExpr)) &#123;</div><div class="line">               <span class="keyword">if</span> (item.getExpr() <span class="keyword">instanceof</span> SQLAggregateExpr) &#123;</div><div class="line">                   SQLAggregateExpr expr = (SQLAggregateExpr) item.getExpr();</div><div class="line">                   <span class="keyword">if</span> (expr.getMethodName().equals(<span class="string">"COUNT"</span>)) &#123; <span class="comment">// TODO å¾…è¯»ï¼šcountï¼ˆ*ï¼‰</span></div><div class="line">                       icount = <span class="number">1</span>;</div><div class="line">                       mongo.setField(getExprFieldName(expr), Types.BIGINT);</div><div class="line">                   &#125;</div><div class="line">                   fields.put(getExprFieldName(expr), <span class="number">1</span>);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   fields.put(getFieldName(item), <span class="number">1</span>);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// è¡¨å</span></div><div class="line">       SQLTableSource table = mysqlSelectQuery.getFrom();</div><div class="line">       DBCollection coll = <span class="keyword">this</span>._db.getCollection(table.toString());</div><div class="line">       mongo.setTable(table.toString());</div><div class="line"></div><div class="line">       <span class="comment">// WHERE</span></div><div class="line">       SQLExpr expr = mysqlSelectQuery.getWhere();</div><div class="line">       DBObject query = parserWhere(expr);</div><div class="line"></div><div class="line">       <span class="comment">// GROUP BY</span></div><div class="line">       SQLSelectGroupByClause groupby = mysqlSelectQuery.getGroupBy();</div><div class="line">       BasicDBObject gbkey = <span class="keyword">new</span> BasicDBObject();</div><div class="line">       <span class="keyword">if</span> (groupby != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">for</span> (SQLExpr gbexpr : groupby.getItems()) &#123;</div><div class="line">               <span class="keyword">if</span> (gbexpr <span class="keyword">instanceof</span> SQLIdentifierExpr) &#123;</div><div class="line">                   String name = ((SQLIdentifierExpr) gbexpr).getName();</div><div class="line">                   gbkey.put(name, Integer.valueOf(<span class="number">1</span>));</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           icount = <span class="number">2</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// SKIP / LIMIT</span></div><div class="line">       <span class="keyword">int</span> limitoff = <span class="number">0</span>;</div><div class="line">       <span class="keyword">int</span> limitnum = <span class="number">0</span>;</div><div class="line">       <span class="keyword">if</span> (mysqlSelectQuery.getLimit() != <span class="keyword">null</span>) &#123;</div><div class="line">           limitoff = getSQLExprToInt(mysqlSelectQuery.getLimit().getOffset());</div><div class="line">           limitnum = getSQLExprToInt(mysqlSelectQuery.getLimit().getRowCount());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (icount == <span class="number">1</span>) &#123; <span class="comment">// COUNTï¼ˆ*ï¼‰</span></div><div class="line">           mongo.setCount(coll.count(query));</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (icount == <span class="number">2</span>) &#123; <span class="comment">// MapReduce</span></div><div class="line">           BasicDBObject initial = <span class="keyword">new</span> BasicDBObject();</div><div class="line">           initial.put(<span class="string">"num"</span>, <span class="number">0</span>);</div><div class="line">           String reduce = <span class="string">"function (obj, prev) &#123; "</span> + <span class="string">"  prev.num++&#125;"</span>;</div><div class="line">           mongo.setGrouyBy(coll.group(gbkey, query, initial, reduce));</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">if</span> ((limitoff &gt; <span class="number">0</span>) || (limitnum &gt; <span class="number">0</span>)) &#123;</div><div class="line">               c = coll.find(query, fields).skip(limitoff).limit(limitnum);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               c = coll.find(query, fields);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="comment">// order by</span></div><div class="line">           SQLOrderBy orderby = mysqlSelectQuery.getOrderBy();</div><div class="line">           <span class="keyword">if</span> (orderby != <span class="keyword">null</span>) &#123;</div><div class="line">               BasicDBObject order = <span class="keyword">new</span> BasicDBObject();</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; orderby.getItems().size(); i++) &#123;</div><div class="line">                   SQLSelectOrderByItem orderitem = orderby.getItems().get(i);</div><div class="line">                   order.put(orderitem.getExpr().toString(), getSQLExprToAsc(orderitem.getType()));</div><div class="line">               &#125;</div><div class="line">               c.sort(order);</div><div class="line">               <span class="comment">// System.out.println(order);</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       mongo.setCursor(c);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> mongo;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>2ã€æŸ¥è¯¢æ¡ä»¶</strong></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MongoSQLParser.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parserWhere</span><span class="params">(SQLExpr aexpr, BasicDBObject o)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (aexpr <span class="keyword">instanceof</span> SQLBinaryOpExpr) &#123;</div><div class="line">       SQLBinaryOpExpr expr = (SQLBinaryOpExpr) aexpr;</div><div class="line">       SQLExpr exprL = expr.getLeft();</div><div class="line">       <span class="keyword">if</span> (!(exprL <span class="keyword">instanceof</span> SQLBinaryOpExpr)) &#123;</div><div class="line">           <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"="</span>)) &#123;</div><div class="line">               o.put(exprL.toString(), getExpValue(expr.getRight()));</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               String op = <span class="string">""</span>;</div><div class="line">               <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"&lt;"</span>)) &#123;</div><div class="line">                   op = <span class="string">"$lt"</span>;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"&lt;="</span>)) &#123;</div><div class="line">                   op = <span class="string">"$lte"</span>;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"&gt;"</span>)) &#123;</div><div class="line">                   op = <span class="string">"$gt"</span>;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"&gt;="</span>)) &#123;</div><div class="line">                   op = <span class="string">"$gte"</span>;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"!="</span>)) &#123;</div><div class="line">                   op = <span class="string">"$ne"</span>;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"&lt;&gt;"</span>)) &#123;</div><div class="line">                   op = <span class="string">"$ne"</span>;</div><div class="line">               &#125;</div><div class="line">               parserDBObject(o, exprL.toString(), op, getExpValue(expr.getRight()));</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"AND"</span>)) &#123;</div><div class="line">               parserWhere(exprL, o);</div><div class="line">               parserWhere(expr.getRight(), o);</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expr.getOperator().getName().equals(<span class="string">"OR"</span>)) &#123;</div><div class="line">               orWhere(exprL, expr.getRight(), o);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Can't identify the operation of  of where"</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">orWhere</span><span class="params">(SQLExpr exprL, SQLExpr exprR, BasicDBObject ob)</span> </span>&#123;</div><div class="line">   BasicDBObject xo = <span class="keyword">new</span> BasicDBObject();</div><div class="line">   BasicDBObject yo = <span class="keyword">new</span> BasicDBObject();</div><div class="line">   parserWhere(exprL, xo);</div><div class="line">   parserWhere(exprR, yo);</div><div class="line">   ob.put(<span class="string">"$or"</span>, <span class="keyword">new</span> Object[]&#123;xo, yo&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>3ã€è§£æ MongoDB æ•°æ®</strong></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MongoResultSet.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">MongoResultSet</span><span class="params">(MongoData mongo, String schema)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">this</span>._cursor = mongo.getCursor();</div><div class="line">   <span class="keyword">this</span>._schema = schema;</div><div class="line">   <span class="keyword">this</span>._table = mongo.getTable();</div><div class="line">   <span class="keyword">this</span>.isSum = mongo.getCount() &gt; <span class="number">0</span>;</div><div class="line">   <span class="keyword">this</span>._sum = mongo.getCount();</div><div class="line">   <span class="keyword">this</span>.isGroupBy = mongo.getType();</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.isGroupBy) &#123;</div><div class="line">       dblist = mongo.getGrouyBys();</div><div class="line">       <span class="keyword">this</span>.isSum = <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>._cursor != <span class="keyword">null</span>) &#123;</div><div class="line">       select = _cursor.getKeysWanted().keySet().toArray(<span class="keyword">new</span> String[<span class="number">0</span>]);</div><div class="line">       <span class="comment">// è§£æ fields</span></div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>._cursor.hasNext()) &#123;</div><div class="line">           _cur = _cursor.next();</div><div class="line">           <span class="keyword">if</span> (_cur != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">if</span> (select.length == <span class="number">0</span>) &#123;</div><div class="line">                   SetFields(_cur.keySet());</div><div class="line">               &#125;</div><div class="line">               _row = <span class="number">1</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// è®¾ç½® fields ç±»å‹</span></div><div class="line">       <span class="keyword">if</span> (select.length == <span class="number">0</span>) &#123;</div><div class="line">           select = <span class="keyword">new</span> String[]&#123;<span class="string">"_id"</span>&#125;;</div><div class="line">           SetFieldType(<span class="keyword">true</span>);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           SetFieldType(<span class="keyword">false</span>);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       SetFields(mongo.getFields().keySet());<span class="comment">//new String[]&#123;"COUNT(*)"&#125;;</span></div><div class="line">       SetFieldType(mongo.getFields());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å½“ä½¿ç”¨ <code>SELECT *</code> æŸ¥è¯¢å­—æ®µæ—¶ï¼Œfields ä½¿ç”¨ç¬¬ä¸€æ¡æ•°æ®è¿”å›çš„ fieldsã€‚å³ä½¿ï¼Œåé¢çš„æ•°æ®æœ‰å…¶ä»– fieldsï¼Œä¹Ÿä¸è¿”å›ã€‚</li>
</ul>
<p><strong>4ã€è¿”å›æ•°æ®ç»™ MySQL Client</strong></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JDBCConnection.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ouputResultSet</span><span class="params">(ServerConnection sc, String sql)</span></span></div><div class="line">       <span class="keyword">throws</span> SQLException &#123;</div><div class="line">   ResultSet rs = <span class="keyword">null</span>;</div><div class="line">   Statement stmt = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       stmt = con.createStatement();</div><div class="line">       rs = stmt.executeQuery(sql);</div><div class="line"></div><div class="line">       <span class="comment">// header</span></div><div class="line">       List&lt;FieldPacket&gt; fieldPks = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">       ResultSetUtil.resultSetToFieldPacket(sc.getCharset(), fieldPks, rs, <span class="keyword">this</span>.isSpark);</div><div class="line">       <span class="keyword">int</span> colunmCount = fieldPks.size();</div><div class="line">       ByteBuffer byteBuf = sc.allocate();</div><div class="line">       ResultSetHeaderPacket headerPkg = <span class="keyword">new</span> ResultSetHeaderPacket();</div><div class="line">       headerPkg.fieldCount = fieldPks.size();</div><div class="line">       headerPkg.packetId = ++packetId;</div><div class="line">       byteBuf = headerPkg.write(byteBuf, sc, <span class="keyword">true</span>);</div><div class="line">       byteBuf.flip();</div><div class="line">       <span class="keyword">byte</span>[] header = <span class="keyword">new</span> <span class="keyword">byte</span>[byteBuf.limit()];</div><div class="line">       byteBuf.get(header);</div><div class="line">       byteBuf.clear();</div><div class="line">       List&lt;<span class="keyword">byte</span>[]&gt; fields = <span class="keyword">new</span> ArrayList&lt;<span class="keyword">byte</span>[]&gt;(fieldPks.size());</div><div class="line">       <span class="keyword">for</span> (FieldPacket curField : fieldPks) &#123;</div><div class="line">           curField.packetId = ++packetId;</div><div class="line">           byteBuf = curField.write(byteBuf, sc, <span class="keyword">false</span>);</div><div class="line">           byteBuf.flip();</div><div class="line">           <span class="keyword">byte</span>[] field = <span class="keyword">new</span> <span class="keyword">byte</span>[byteBuf.limit()];</div><div class="line">           byteBuf.get(field);</div><div class="line">           byteBuf.clear();</div><div class="line">           fields.add(field);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// header eof</span></div><div class="line">       EOFPacket eofPckg = <span class="keyword">new</span> EOFPacket();</div><div class="line">       eofPckg.packetId = ++packetId;</div><div class="line">       byteBuf = eofPckg.write(byteBuf, sc, <span class="keyword">false</span>);</div><div class="line">       byteBuf.flip();</div><div class="line">       <span class="keyword">byte</span>[] eof = <span class="keyword">new</span> <span class="keyword">byte</span>[byteBuf.limit()];</div><div class="line">       byteBuf.get(eof);</div><div class="line">       byteBuf.clear();</div><div class="line">       <span class="keyword">this</span>.respHandler.fieldEofResponse(header, fields, eof, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">       <span class="comment">// row</span></div><div class="line">       <span class="keyword">while</span> (rs.next()) &#123;</div><div class="line">           RowDataPacket curRow = <span class="keyword">new</span> RowDataPacket(colunmCount);</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; colunmCount; i++) &#123;</div><div class="line">               <span class="keyword">int</span> j = i + <span class="number">1</span>;</div><div class="line">               <span class="keyword">if</span> (MysqlDefs.isBianry((<span class="keyword">byte</span>) fieldPks.get(i).type)) &#123;</div><div class="line">                   curRow.add(rs.getBytes(j));</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fieldPks.get(i).type == MysqlDefs.FIELD_TYPE_DECIMAL ||</div><div class="line">                       fieldPks.get(i).type == (MysqlDefs.FIELD_TYPE_NEW_DECIMAL - <span class="number">256</span>)) &#123; <span class="comment">// field type is unsigned byte</span></div><div class="line">                   <span class="comment">// ensure that do not use scientific notation format</span></div><div class="line">                   BigDecimal val = rs.getBigDecimal(j);</div><div class="line">                   curRow.add(StringUtil.encode(val != <span class="keyword">null</span> ? val.toPlainString() : <span class="keyword">null</span>, sc.getCharset()));</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   curRow.add(StringUtil.encode(rs.getString(j), sc.getCharset()));</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           curRow.packetId = ++packetId;</div><div class="line">           byteBuf = curRow.write(byteBuf, sc, <span class="keyword">false</span>);</div><div class="line">           byteBuf.flip();</div><div class="line">           <span class="keyword">byte</span>[] row = <span class="keyword">new</span> <span class="keyword">byte</span>[byteBuf.limit()];</div><div class="line">           byteBuf.get(row);</div><div class="line">           byteBuf.clear();</div><div class="line">           <span class="keyword">this</span>.respHandler.rowResponse(row, <span class="keyword">this</span>);</div><div class="line">       &#125;</div><div class="line">       fieldPks.clear();</div><div class="line">       <span class="comment">// row eof</span></div><div class="line">       eofPckg = <span class="keyword">new</span> EOFPacket();</div><div class="line">       eofPckg.packetId = ++packetId;</div><div class="line">       byteBuf = eofPckg.write(byteBuf, sc, <span class="keyword">false</span>);</div><div class="line">       byteBuf.flip();</div><div class="line">       eof = <span class="keyword">new</span> <span class="keyword">byte</span>[byteBuf.limit()];</div><div class="line">       byteBuf.get(eof);</div><div class="line">       sc.recycle(byteBuf);</div><div class="line">       <span class="keyword">this</span>.respHandler.rowEofResponse(eof, <span class="keyword">this</span>);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="keyword">if</span> (rs != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               rs.close();</div><div class="line">           &#125; <span class="keyword">catch</span> (SQLException e) &#123;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (stmt != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               stmt.close();</div><div class="line">           &#125; <span class="keyword">catch</span> (SQLException e) &#123;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// MongoResultSet.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(String columnLabel)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   Object x = getObject(columnLabel);</div><div class="line">   <span class="keyword">if</span> (x == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> x.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å½“è¿”å›å­—æ®µå€¼æ˜¯ Object æ—¶ï¼Œè¿”å›è¯¥å¯¹è±¡.toString()ã€‚ä¾‹å¦‚ï¼š</li>
</ul>
<p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">mysql&gt; select * from user order by _id asc;</div><div class="line">+--------------------------+------+-------------------------------+</div><div class="line">| _id                      | name | profile                       |</div><div class="line">+--------------------------+------+-------------------------------+</div><div class="line">| 1                        | 123  | &#123; "age" : 1 , "height" : 100&#125; |</div></pre></td></tr></table></figure></p>
<h1>4. æ’å…¥æ“ä½œ</h1>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_19/05.png" alt=""></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MongoSQLParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">()</span> <span class="keyword">throws</span> MongoSQLException </span>&#123;</div><div class="line">   <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> SQLInsertStatement) &#123;</div><div class="line">       <span class="keyword">return</span> InsertData((SQLInsertStatement) statement);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> SQLUpdateStatement) &#123;</div><div class="line">       <span class="keyword">return</span> UpData((SQLUpdateStatement) statement);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> SQLDropTableStatement) &#123;</div><div class="line">       <span class="keyword">return</span> dropTable((SQLDropTableStatement) statement);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> SQLDeleteStatement) &#123;</div><div class="line">       <span class="keyword">return</span> DeleteDate((SQLDeleteStatement) statement);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> SQLCreateTableStatement) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">InsertData</span><span class="params">(SQLInsertStatement state)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (state.getValues().getValues().size() == <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"number of  columns error"</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (state.getValues().getValues().size() != state.getColumns().size()) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"number of values and columns have to match"</span>);</div><div class="line">   &#125;</div><div class="line">   SQLTableSource table = state.getTableSource();</div><div class="line">   BasicDBObject o = <span class="keyword">new</span> BasicDBObject();</div><div class="line">   <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (SQLExpr col : state.getColumns()) &#123;</div><div class="line">       o.put(getFieldName2(col), getExpValue(state.getValues().getValues().get(i)));</div><div class="line">       i++;</div><div class="line">   &#125;</div><div class="line">   DBCollection coll = <span class="keyword">this</span>._db.getCollection(table.toString());</div><div class="line">   coll.insert(o);</div><div class="line">   <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>5. å½©è›‹</h1>
<p>è€é“ï¼Œçœ‹åˆ°è¿™é‡Œï¼Œæ¥ä¸€æ³¢å¾®ä¿¡å…¬ä¼—å·å…³æ³¨å§ï¼Ÿï¼</p>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt="wechat_mp"></p>
<p><strong>1ã€æ”¯æŒå¤š MongoDB ï¼Œå¹¶ä½¿ç”¨ MyCAT è¿›è¡Œåˆ†ç‰‡ã€‚</strong></p>
<p>MyCAT é…ç½®ï¼š<a href="https://github.com/YunaiV/Mycat-Server/tree/1.6/src/test/resources/multi_mongodb" rel="external nofollow noopener noreferrer" target="_blank">multi_mongodb</a></p>
<p><strong>2ã€æ”¯æŒ MongoDB + MySQL ä½œä¸ºåŒä¸€ä¸ª MyCAT Table çš„æ•°æ®èŠ‚ç‚¹ã€‚æŸ¥è¯¢æ—¶ï¼Œå¯ä»¥åˆå¹¶æ•°æ®ç»“æœã€‚</strong></p>
<p>æŸ¥è¯¢æ—¶ï¼Œè¿”å› MySQL æ•°æ®è®°å½•å­—æ®µè¦æ¯” MongoDB æ•°æ®è®°å½•å­—æ®µå…¨ï¼Œå¦åˆ™ï¼Œåˆå¹¶ç»“æœæ—¶ä¼šæŠ¥é”™ã€‚</p>
<p>MyCAT é…ç½®ï¼š<a href="https://github.com/YunaiV/Mycat-Server/tree/1.6/src/test/resources/single_mongodb_mysql" rel="external nofollow noopener noreferrer" target="_blank">single_mongodb_mysql</a></p>
<p><strong>3ã€MongoDB ä½œä¸ºæ•°æ®èŠ‚ç‚¹æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ MyCAT æä¾›çš„æ•°æ®åº“ä¸»é”®å­—æ®µåŠŸèƒ½ã€‚</strong></p>
<p>MyCAT é…ç½®ï¼š<a href="https://github.com/YunaiV/Mycat-Server/tree/1.6/src/test/resources/single_mongodb" rel="external nofollow noopener noreferrer" target="_blank">single_mongodb</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol
    
    </summary>
    
      <category term="MyCAT" scheme="http://www.yunai.me/categories/MyCAT/"/>
    
    
  </entry>
  
  <entry>
    <title>MyCAT æºç åˆ†æ  â€”â€” PreparedStatement é‡æ–°å…¥é—¨</title>
    <link href="http://www.yunai.me/MyCAT/what-is-PreparedStatement/"/>
    <id>http://www.yunai.me/MyCAT/what-is-PreparedStatement/</id>
    <published>2017-07-16T16:00:00.000Z</published>
    <updated>2017-07-31T12:30:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. JDBC Client å®ç°</a></li>
<li><a href="#">3. MyCAT Server å®ç°</a>
<ul>
<li><a href="#">3.1 åˆ›å»º PreparedStatement</a></li>
<li><a href="#">3.2 æ‰§è¡Œ SQL</a></li>
</ul>
</li>
<li><a href="#">4. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>ç›¸ä¿¡å¾ˆå¤šåŒå­¦åœ¨å­¦ä¹  JDBC æ—¶ï¼Œéƒ½ç¢°åˆ° <code>PreparedStatement</code> å’Œ <code>Statement</code>ã€‚ç©¶ç«Ÿè¯¥ä½¿ç”¨å“ªä¸ªå‘¢ï¼Ÿæœ€ç»ˆå¾ˆå¯èƒ½æ˜¯<strong>æ‡µé‡Œæ‡µæ‡‚</strong>çš„çœ‹äº†å„ç§æ€»ç»“ï¼Œä½¿ç”¨ <code>PreparedStatement</code>ã€‚é‚£ä¹ˆæœ¬æ–‡ï¼Œé€šè¿‡ MyCAT å¯¹ <code>PreparedStatement</code> çš„å®ç°å¯¹å¤§å®¶èƒ½å¤Ÿé‡æ–°ç†è§£ä¸‹ã€‚</p>
<p>æœ¬æ–‡ä¸»è¦åˆ†æˆä¸¤éƒ¨åˆ†ï¼š</p>
<ol>
<li>JDBC Client å¦‚ä½•å®ç° <code>PreparedStatement</code>ã€‚</li>
<li>MyCAT Server å¦‚ä½•å¤„ç† <code>PreparedStatement</code>ã€‚</li>
</ol>
<p>ğŸ˜ˆ Let's Goã€‚</p>
<h1>2. JDBC Client å®ç°</h1>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€æ®µå¤§å®¶æœ€å–œæ¬¢å¤åˆ¶ç²˜è´´ä¹‹ä¸€çš„ä»£ç ï¼ŒJDBC PreparedStatement æŸ¥è¯¢ MySQL æ•°æ®åº“ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PreparedStatementDemo</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException </span>&#123;</div><div class="line">        <span class="comment">// 1. è·å¾—æ•°æ®åº“è¿æ¥</span></div><div class="line">        Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</div><div class="line">        Connection conn = DriverManager.getConnection(<span class="string">"jdbc:mysql://127.0.0.1:8066/dbtest?useServerPrepStmts=true"</span>, <span class="string">"root"</span>, <span class="string">"123456"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// PreparedStatement</span></div><div class="line">        PreparedStatement ps = conn.prepareStatement(<span class="string">"SELECT id, username, password FROM t_user WHERE id = ?"</span>);</div><div class="line">        ps.setLong(<span class="number">1</span>, Math.abs(<span class="keyword">new</span> Random().nextLong()));</div><div class="line"></div><div class="line">        <span class="comment">// execute</span></div><div class="line">        ps.executeQuery();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è·å– MySQL è¿æ¥æ—¶ï¼Œ<code>useServerPrepStmts=true</code>  æ˜¯<strong>éå¸¸éå¸¸éå¸¸é‡è¦</strong>çš„å‚æ•°ã€‚å¦‚æœä¸é…ç½®ï¼Œ<code>PreparedStatement</code> å®é™…æ˜¯ä¸ª<strong>å‡</strong>çš„ <code>PreparedStatement</code>ï¼ˆæ–°ç‰ˆæœ¬é»˜è®¤ä¸º FALSEï¼Œæ®è¯´éƒ¨åˆ†è€ç‰ˆæœ¬é»˜è®¤ä¸º TRUEï¼‰ï¼Œæœªå¼€å¯æœåŠ¡ç«¯çº§åˆ«çš„ SQL é¢„ç¼–è¯‘ã€‚</p>
<p>WHY ï¼Ÿæ¥çœ‹ä¸‹ JDBC é‡Œé¢æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// com.mysql.jdbc.ConnectionImpl.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> PreparedStatement <span class="title">prepareStatement</span><span class="params">(String sql, <span class="keyword">int</span> resultSetType, <span class="keyword">int</span> resultSetConcurrency)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">synchronized</span> (getConnectionMutex()) &#123;</div><div class="line">       checkClosed();</div><div class="line">       </div><div class="line">       PreparedStatement pStmt = <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">boolean</span> canServerPrepare = <span class="keyword">true</span>;</div><div class="line">       String nativeSql = getProcessEscapeCodesForPrepStmts() ? nativeSQL(sql) : sql;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.useServerPreparedStmts &amp;&amp; getEmulateUnsupportedPstmts()) &#123;</div><div class="line">           canServerPrepare = canHandleAsServerPreparedStatement(nativeSql);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.useServerPreparedStmts &amp;&amp; canServerPrepare) &#123;</div><div class="line">           <span class="keyword">if</span> (<span class="keyword">this</span>.getCachePreparedStatements()) &#123; <span class="comment">// ä»ç¼“å­˜ä¸­è·å– pStmt</span></div><div class="line">               <span class="keyword">synchronized</span> (<span class="keyword">this</span>.serverSideStatementCache) &#123;</div><div class="line">                   pStmt = (com.mysql.jdbc.ServerPreparedStatement) <span class="keyword">this</span>.serverSideStatementCache</div><div class="line">                           .remove(makePreparedStatementCacheKey(<span class="keyword">this</span>.database, sql));</div><div class="line"></div><div class="line">                   <span class="keyword">if</span> (pStmt != <span class="keyword">null</span>) &#123;</div><div class="line">                       ((com.mysql.jdbc.ServerPreparedStatement) pStmt).setClosed(<span class="keyword">false</span>);</div><div class="line">                       pStmt.clearParameters(); <span class="comment">// æ¸…ç†ä¸Šæ¬¡ç•™ä¸‹çš„å‚æ•°</span></div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   <span class="keyword">if</span> (pStmt == <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="comment">// .... çœç•¥ä»£ç  ï¼šå‘ Server æäº¤ SQL é¢„ç¼–è¯‘ã€‚</span></div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">// å‘ Server æäº¤ SQL é¢„ç¼–è¯‘ã€‚</span></div><div class="line">                   pStmt = ServerPreparedStatement.getInstance(getMultiHostSafeProxy(), nativeSql, <span class="keyword">this</span>.database, resultSetType, resultSetConcurrency);</div><div class="line"></div><div class="line">                   pStmt.setResultSetType(resultSetType);</div><div class="line">                   pStmt.setResultSetConcurrency(resultSetConcurrency);</div><div class="line">               &#125; <span class="keyword">catch</span> (SQLException sqlEx) &#123;</div><div class="line">                   <span class="comment">// Punt, if necessary</span></div><div class="line">                   <span class="keyword">if</span> (getEmulateUnsupportedPstmts()) &#123;</div><div class="line">                       pStmt = (PreparedStatement) clientPrepareStatement(nativeSql, resultSetType, resultSetConcurrency, <span class="keyword">false</span>);</div><div class="line">                   &#125; <span class="keyword">else</span> &#123;</div><div class="line">                       <span class="keyword">throw</span> sqlEx;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           pStmt = (PreparedStatement) clientPrepareStatement(nativeSql, resultSetType, resultSetConcurrency, <span class="keyword">false</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> pStmt;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ã€å‰è€…ã€‘å½“ Client å¼€å¯ <code>useServerPreparedStmts</code> å¹¶ä¸” Server æ”¯æŒ <code>ServerPrepare</code>ï¼Œ<strong>Client ä¼šå‘ Server æäº¤ SQL é¢„ç¼–è¯‘è¯·æ±‚</strong>ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.useServerPreparedStmts &amp;&amp; canServerPrepare) &#123;</div><div class="line">    pStmt = ServerPreparedStatement.getInstance(getMultiHostSafeProxy(), nativeSql, <span class="keyword">this</span>.database, resultSetType, resultSetConcurrency);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ã€åè€…ã€‘å½“ Client æœªå¼€å¯ <code>useServerPreparedStmts</code> æˆ–è€… Server ä¸æ”¯æŒ <code>ServerPrepare</code>ï¼ŒClient åˆ›å»º <code>PreparedStatement</code>ï¼Œ<strong>_ä¸ä¼š_å‘ Server æäº¤ SQL é¢„ç¼–è¯‘è¯·æ±‚</strong>ã€‚</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">pStmt = (PreparedStatement) clientPrepareStatement(nativeSql, resultSetType, resultSetConcurrency, <span class="keyword">false</span>);</div></pre></td></tr></table></figure></p>
<p><strong>å³ä½¿è¿™æ ·ï¼Œç©¶ç«Ÿä¸ºä»€ä¹ˆæ€§èƒ½ä¼šæ›´å¥½å‘¢ï¼Ÿ</strong></p>
<ul>
<li>ã€å‰è€…ã€‘è¿”å›çš„ <code>PreparedStatement</code> å¯¹è±¡ç±»æ˜¯ <code>JDBC42ServerPreparedStatement.java</code>ï¼Œåç»­æ¯æ¬¡æ‰§è¡Œ SQL åªéœ€å°†å¯¹åº”å ä½ç¬¦?å¯¹åº”çš„å€¼æäº¤ç»™ Serverå³å¯ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“å’Œ SQL è§£æå¼€é”€ã€‚</li>
<li>ã€åè€…ã€‘è¿”å›çš„ <code>PreparedStatement</code> å¯¹è±¡ç±»æ˜¯ <code>JDBC42PreparedStatement.java</code>ï¼Œåç»­æ¯æ¬¡æ‰§è¡Œ SQL éœ€è¦å°†<strong>å®Œæ•´</strong>çš„ SQL æäº¤ç»™ Serverï¼Œå¢åŠ äº†ç½‘ç»œä¼ è¾“å’Œ SQL è§£æå¼€é”€ã€‚</li>
</ul>
<p><em>ğŸŒšï¼šã€å‰è€…ã€‘æ€§èƒ½ä¸€å®šæ¯”ã€åè€…ã€‘å¥½å—ï¼Ÿç›¸ä¿¡ä½ å·²ç»æœ‰äº†æ­£ç¡®çš„ç­”æ¡ˆã€‚</em></p>
<h1>3. MyCAT Server å®ç°</h1>
<h2>3.1 åˆ›å»º PreparedStatement</h2>
<p>è¯¥æ“ä½œå¯¹åº” Client <code>conn.prepareStatement(....)</code>ã€‚</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_17/01.png" alt=""></p>
<p>MyCAT æ¥æ”¶åˆ°è¯·æ±‚åï¼Œåˆ›å»º <code>PreparedStatement</code>ï¼Œå¹¶è¿”å› <code>statementId</code> ç­‰ä¿¡æ¯ã€‚Client å‘èµ· SQL æ‰§è¡Œæ—¶ï¼Œéœ€è¦å°† <code>statementId</code> å¸¦ç»™ MyCATã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ServerPrepareHandler.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(String sql)</span> </span>&#123;</div><div class="line">LOGGER.debug(<span class="string">"use server prepare, sql: "</span> + sql);</div><div class="line"></div><div class="line">   PreparedStatement pstmt = pstmtForSql.get(sql);</div><div class="line">   <span class="keyword">if</span> (pstmt == <span class="keyword">null</span>) &#123; <span class="comment">// ç¼“å­˜ä¸­è·å–</span></div><div class="line">   	<span class="comment">// è§£æè·å–å­—æ®µä¸ªæ•°å’Œå‚æ•°ä¸ªæ•°</span></div><div class="line">   	<span class="keyword">int</span> columnCount = getColumnCount(sql);</div><div class="line">   	<span class="keyword">int</span> paramCount = getParamCount(sql);</div><div class="line">       pstmt = <span class="keyword">new</span> PreparedStatement(++pstmtId, sql, columnCount, paramCount);</div><div class="line">       pstmtForSql.put(pstmt.getStatement(), pstmt);</div><div class="line">       pstmtForId.put(pstmt.getId(), pstmt);</div><div class="line">   &#125;</div><div class="line">   PreparedStmtResponse.response(pstmt, source);</div><div class="line">&#125;</div><div class="line"><span class="comment">// PreparedStmtResponse.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">response</span><span class="params">(PreparedStatement pstmt, FrontendConnection c)</span> </span>&#123;</div><div class="line">   <span class="keyword">byte</span> packetId = <span class="number">0</span>;</div><div class="line"></div><div class="line">   <span class="comment">// write preparedOk packet</span></div><div class="line">   PreparedOkPacket preparedOk = <span class="keyword">new</span> PreparedOkPacket();</div><div class="line">   preparedOk.packetId = ++packetId;</div><div class="line">   preparedOk.statementId = pstmt.getId();</div><div class="line">   preparedOk.columnsNumber = pstmt.getColumnsNumber();</div><div class="line">   preparedOk.parametersNumber = pstmt.getParametersNumber();</div><div class="line">   ByteBuffer buffer = preparedOk.write(c.allocate(), c,<span class="keyword">true</span>);</div><div class="line"></div><div class="line">   <span class="comment">// write parameter field packet</span></div><div class="line">   <span class="keyword">int</span> parametersNumber = preparedOk.parametersNumber;</div><div class="line">   <span class="keyword">if</span> (parametersNumber &gt; <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parametersNumber; i++) &#123;</div><div class="line">           FieldPacket field = <span class="keyword">new</span> FieldPacket();</div><div class="line">           field.packetId = ++packetId;</div><div class="line">           buffer = field.write(buffer, c,<span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">       EOFPacket eof = <span class="keyword">new</span> EOFPacket();</div><div class="line">       eof.packetId = ++packetId;</div><div class="line">       buffer = eof.write(buffer, c,<span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// write column field packet</span></div><div class="line">   <span class="keyword">int</span> columnsNumber = preparedOk.columnsNumber;</div><div class="line">   <span class="keyword">if</span> (columnsNumber &gt; <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; columnsNumber; i++) &#123;</div><div class="line">           FieldPacket field = <span class="keyword">new</span> FieldPacket();</div><div class="line">           field.packetId = ++packetId;</div><div class="line">           buffer = field.write(buffer, c,<span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">       EOFPacket eof = <span class="keyword">new</span> EOFPacket();</div><div class="line">       eof.packetId = ++packetId;</div><div class="line">       buffer = eof.write(buffer, c,<span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// send buffer</span></div><div class="line">   c.write(buffer);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>æ¯ä¸ªè¿æ¥ä¹‹é—´ï¼ŒPreparedStatement ä¸å…±äº«ï¼Œå³ä¸åŒè¿æ¥ï¼Œå³ä½¿ SQLç›¸åŒï¼Œå¯¹åº”çš„ PreparedStatement ä¸åŒã€‚</strong></p>
<h2>3.2 æ‰§è¡Œ SQL</h2>
<p>è¯¥æ“ä½œå¯¹åº” Client <code>conn.execute(....)</code>ã€‚</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_17/02.png" alt=""></p>
<p>MyCAT æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå°† PreparedStatement ä½¿ç”¨è¯·æ±‚çš„å‚æ•°æ ¼å¼åŒ–æˆå¯æ‰§è¡Œçš„ SQL è¿›è¡Œæ‰§è¡Œã€‚ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">String sql = pstmt.sql.format(request.params);</div><div class="line">execute(sql);</div></pre></td></tr></table></figure></p>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ServerPrepareHandler.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</div><div class="line">   <span class="keyword">long</span> pstmtId = ByteUtil.readUB4(data, <span class="number">5</span>);</div><div class="line">   PreparedStatement pstmt = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">if</span> ((pstmt = pstmtForId.get(pstmtId)) == <span class="keyword">null</span>) &#123;</div><div class="line">       source.writeErrMessage(ErrorCode.ER_ERROR_WHEN_EXECUTING_COMMAND, <span class="string">"Unknown pstmtId when executing."</span>);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="comment">// å‚æ•°è¯»å–</span></div><div class="line">       ExecutePacket packet = <span class="keyword">new</span> ExecutePacket(pstmt);</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           packet.read(data, source.getCharset());</div><div class="line">       &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line">           source.writeErrMessage(ErrorCode.ER_ERROR_WHEN_EXECUTING_COMMAND, e.getMessage());</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">       BindValue[] bindValues = packet.values;</div><div class="line">       <span class="comment">// è¿˜åŸsqlä¸­çš„åŠ¨æ€å‚æ•°ä¸ºå®é™…å‚æ•°å€¼</span></div><div class="line">       String sql = prepareStmtBindValue(pstmt, bindValues);</div><div class="line">       <span class="comment">// æ‰§è¡Œsql</span></div><div class="line">       source.getSession2().setPrepared(<span class="keyword">true</span>);</div><div class="line">       source.query(sql);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">prepareStmtBindValue</span><span class="params">(PreparedStatement pstmt, BindValue[] bindValues)</span> </span>&#123;</div><div class="line">   String sql = pstmt.getStatement();</div><div class="line">   <span class="keyword">int</span>[] paramTypes = pstmt.getParametersType();</div><div class="line"></div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">   <span class="keyword">int</span> idx = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, len = sql.length(); i &lt; len; i++) &#123;</div><div class="line">       <span class="keyword">char</span> c = sql.charAt(i);</div><div class="line">       <span class="keyword">if</span> (c != <span class="string">'?'</span>) &#123;</div><div class="line">           sb.append(c);</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// å¤„ç†å ä½ç¬¦?</span></div><div class="line">       <span class="keyword">int</span> paramType = paramTypes[idx];</div><div class="line">       BindValue bindValue = bindValues[idx];</div><div class="line">       idx++;</div><div class="line">       <span class="comment">// å¤„ç†å­—æ®µä¸ºç©ºçš„æƒ…å†µ</span></div><div class="line">       <span class="keyword">if</span> (bindValue.isNull) &#123;</div><div class="line">           sb.append(<span class="string">"NULL"</span>);</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// éç©ºæƒ…å†µ, æ ¹æ®å­—æ®µç±»å‹è·å–å€¼</span></div><div class="line">       <span class="keyword">switch</span> (paramType &amp; <span class="number">0xff</span>) &#123;</div><div class="line">           <span class="keyword">case</span> Fields.FIELD_TYPE_TINY:</div><div class="line">               sb.append(String.valueOf(bindValue.byteBinding));</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> Fields.FIELD_TYPE_SHORT:</div><div class="line">               sb.append(String.valueOf(bindValue.shortBinding));</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> Fields.FIELD_TYPE_LONG:</div><div class="line">               sb.append(String.valueOf(bindValue.intBinding));</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="comment">// .... çœç•¥éæ ¸å¿ƒä»£ç </span></div><div class="line">        &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> sb.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>4. å½©è›‹</h1>
<p>ğŸ’¯ çœ‹åˆ°æ­¤å¤„æ˜¯ä¸æ˜¯çœŸçˆ±ï¼Ÿï¼åæ­£æˆ‘ä¿¡äº†ã€‚<br>
ç»™è€é“ä»¬é¢å¤–åŠ ä¸ªğŸ—ã€‚</p>
<p>ç»†å¿ƒçš„åŒå­¦ä»¬å¯èƒ½å·²ç»æ³¨æ„åˆ° JDBC Client æ˜¯æ”¯æŒç¼“å­˜ <code>PreparedStatement</code>ï¼Œæ— éœ€æ¯æ¬¡éƒ½è®© Server è¿›è¡Œåˆ›å»ºã€‚</p>
<p>å½“é…ç½® MySQL æ•°æ®è¿æ¥ <code>cachePrepStmts=true</code> æ—¶å¼€å¯ Client çº§åˆ«çš„ç¼“å­˜ã€‚Butï¼Œ<strong>æ­¤å¤„çš„ç¼“å­˜åˆå’Œä¸€èˆ¬çš„ç¼“å­˜ä¸ä¸€æ ·</strong>ï¼Œæ˜¯ä½¿ç”¨ <code>remove</code> çš„æ–¹å¼è·å¾—çš„ï¼Œå¹¶ä¸”åˆ›å»ºå¥½ <code>PreparedStatement</code> æ—¶ä¹Ÿä¸æ·»åŠ åˆ°ç¼“å­˜ã€‚é‚£ä»€ä¹ˆæ—¶å€™æ·»åŠ ç¼“å­˜å‘¢ï¼Ÿåœ¨ <code>pstmt.close()</code> æ—¶ï¼Œå¹¶ä¸”**<code>pstmt</code> æ˜¯é€šè¿‡ç¼“å­˜è·å–æ—¶**ï¼Œæ·»åŠ åˆ°ç¼“å­˜ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ServerPreparedStatement.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   MySQLConnection locallyScopedConn = <span class="keyword">this</span>.connection;</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (locallyScopedConn == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span>; <span class="comment">// already closed</span></div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">synchronized</span> (locallyScopedConn.getConnectionMutex()) &#123;</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.isCached &amp;&amp; isPoolable() &amp;&amp; !<span class="keyword">this</span>.isClosed) &#123;</div><div class="line">           clearParameters();</div><div class="line">           <span class="keyword">this</span>.isClosed = <span class="keyword">true</span>;</div><div class="line">           <span class="keyword">this</span>.connection.recachePreparedStatement(<span class="keyword">this</span>);</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       realClose(<span class="keyword">true</span>, <span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// ConnectionImpl.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recachePreparedStatement</span><span class="params">(ServerPreparedStatement pstmt)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">synchronized</span> (getConnectionMutex()) &#123;</div><div class="line">       <span class="keyword">if</span> (getCachePreparedStatements() &amp;&amp; pstmt.isPoolable()) &#123;</div><div class="line">           <span class="keyword">synchronized</span> (<span class="keyword">this</span>.serverSideStatementCache) &#123;</div><div class="line">               <span class="keyword">this</span>.serverSideStatementCache.put(makePreparedStatementCacheKey(pstmt.currentCatalog, pstmt.originalSql), pstmt);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå®ç°ï¼Ÿ<code>PreparedStatement</code> æ˜¯æœ‰çŠ¶æ€çš„å˜é‡ï¼Œæˆ‘ä»¬ä¼šå» <code>setXXX(pos, value)</code>ï¼Œä¸€æ—¦å¤šçº¿ç¨‹å…±äº«ï¼Œä¼šå¯¼è‡´é”™ä¹±ã€‚</p>
<p>ğŸ—¿ è¿™ä¸ªâ€œå½©è›‹â€è¿˜æ»¡æ„ä¹ˆï¼Ÿ<strong>è¯·å…³æ³¨æˆ‘çš„å…¬ä¼—å·ï¼šèŠ‹è‰¿çš„åç«¯å°å±‹</strong>ã€‚ä¸‹ä¸€ç¯‡æ›´æ–°ï¼šã€ŠMyCATæºç è§£æ â€”â€” MongoDBã€‹ï¼Œæå¤§å¯èƒ½å°±åœ¨æœ¬å‘¨å™¢ã€‚</p>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt="wechat_mp"></p>
<p>å¦å¤–æ¨èä¸€ç¯‡æ–‡ç« ï¼š<a href="https://www.zybuluo.com/stefanlu/note/254899" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJDBC PreparedStatementã€‹</a>ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol
    
    </summary>
    
      <category term="MyCAT" scheme="http://www.yunai.me/categories/MyCAT/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” ä¸ºä»€ä¹ˆé˜…è¯» Sharding-JDBC æºç ï¼Ÿ</title>
    <link href="http://www.yunai.me/Sharding-JDBC/why-read-Sharding-JDBC-source-code/"/>
    <id>http://www.yunai.me/Sharding-JDBC/why-read-Sharding-JDBC-source-code/</id>
    <published>2017-07-15T16:00:00.000Z</published>
    <updated>2017-08-10T04:03:18.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h2>ä¸ºä»€ä¹ˆé˜…è¯» Sharding-JDBC æºç ï¼Ÿ</h2>
<ol>
<li>çœ‹å®Œå¤§éƒ¨åˆ†çš„ MyCAT æºç ï¼Œæœ‰æƒŠå–œçš„åœ°æ–¹ï¼Œä¹Ÿæœ‰å¤±æœ›çš„åœ°æ–¹ï¼Œå› è€Œæƒ³çœ‹çœ‹ Sharding-JDBC è¿›è¡Œä¸‹å¯¹æ¯”ã€‚å°½ç®¡ï¼ŒSharding-JDBC æ˜¯ Client ç«¯çº§åˆ«ï¼ŒMyCAT æ˜¯ Server çº§åˆ«ã€‚</li>
<li>Sharding-JDBC ç»å†è¿‡å½“å½“æœ¬èº«ä¸šåŠ¡çš„è€ƒéªŒï¼Œä»å¯é æ€§ä¸Šæ¥è¯´ä¼šæ›´è®©äººæœ‰ä¿¡èµ–æ„Ÿã€‚</li>
<li>æ–‡æ¡£æ›´åŠ å®Œå–„ï¼Œå¼€å‘ä½“ç³»æ›´åŠ å¥å…¨ã€‚</li>
<li>Sharding-JDBC 1.5.0.M3 å‘å¸ƒã€‚</li>
<li><strong>æœ€å¤§åŠªåŠ›é€è¾¾å‹</strong>äº‹åŠ¡æ”¯æŒï¼Œæƒ³è¦è¿›ä¸€æ­¥äº†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆã€‚Last But Very Importmentã€‚</li>
</ol>
<h2>ä½¿ç”¨å…¬å¸</h2>
<ol>
<li>äº¬ä¸œ ( FROM æ°‘é—´ )</li>
<li>å”¯å“ä¼š ( FROM æ°‘é—´ )</li>
<li>è½¬è½¬ ( FROM https://github.com/dangdangdotcom/sharding-jdbc/issues/234 )</li>
<li>è¶³è®° ( FROM https://github.com/dangdangdotcom/sharding-jdbc/issues/234 )</li>
<li><strong>ä¸å®šä¹‰æ›´æ–°</strong> ( FROM https://github.com/dangdangdotcom/sharding-jdbc/issues/234 )</li>
</ol>
<h2>æ­¥éª¤</h2>
<ul>
<li>
<p>FROM MyCAT</p>
<p><strong>ä» MyCAT é˜…è¯»è®¡åˆ’å¤åˆ¶ï¼Œç”¨äºå¯¹æ¯”ã€‚</strong></p>
</li>
<li>
<p>[x] <s>NIO</s></p>
</li>
<li>
<p>[x] <s>åˆ†å¸ƒå¼äº‹åŠ¡</s></p>
</li>
<li>
<p>[x] <s>MyCAT ä¸»ä»</s></p>
</li>
<li>
<p>[x] <s>æ”¯æŒprepareé¢„ç¼–è¯‘æŒ‡ä»¤</s></p>
</li>
<li>
<p>[x] è‡ªå¢åºåˆ—</p>
</li>
<li>
<p>[x] å•åº“ä»»æ„ Join</p>
</li>
<li>
<p>[x] <s>è·¨åº“2è¡¨ Join</s></p>
</li>
<li>
<p>[x] <s>è·¨åº“å¤šè¡¨ Join</s></p>
</li>
<li>
<p>[x] SQL è§£æ</p>
</li>
<li>
<p>[ ] è¯»å†™åˆ†ç¦»</p>
</li>
<li>
<p>[x] <s>MySQL ä¸»ä»</s></p>
</li>
<li>
<p>[x] <s>è‡ªåŠ¨æ•…éšœåˆ‡æ¢</s></p>
</li>
<li>
<p>[x] <s>Galera Cluster é›†ç¾¤</s></p>
</li>
<li>
<p>[x] <s>MHA é›†ç¾¤</s></p>
</li>
<li>
<p>[x] <s>Percona é›†ç¾¤</s></p>
</li>
<li>
<p>[x] <s>æœåŠ¡é™çº§</s></p>
</li>
<li>
<p>[x] <s>å¤šç§Ÿæˆ·</s></p>
</li>
<li>
<p>[x] è·¯ç”±</p>
</li>
<li>
<p>[x] <s>MyCAT é›†ç¾¤</s></p>
</li>
<li>
<p>[x] <s>æ³¨è§£</s></p>
</li>
<li>
<p>[x] <s>ç¼“å­˜</s></p>
</li>
<li>
<p>[x] <s>ç›‘æ§</s></p>
</li>
<li>
<p>[x] <s>Mongodb</s></p>
</li>
<li>
<p>[ ] å†…å­˜ç®¡ç†</p>
</li>
<li>
<p>[ ] æ•°æ®èšåˆ</p>
</li>
<li>
<p>[ ] æ•°æ®æ’åº</p>
</li>
<li>
<p>[x] åˆ†è¡¨</p>
</li>
<li>
<p>[x] åˆ†åº“</p>
</li>
<li>
<p>[x] <s>å…¨å±€è¡¨</s></p>
</li>
<li>
<p>[x] <s>E/Rå…³ç³»</s></p>
</li>
<li>
<p>[x] <s>æœåŠ¡é™çº§</s></p>
</li>
<li>
<p>[x] <s>SQL æ³¨å…¥æ”»å‡»æ‹¦æˆª</s></p>
</li>
<li>
<p>[x] <s>MySQL åè®®</s></p>
</li>
<li>
<p>[x] <s>PostgreSQL åè®®</s></p>
</li>
<li>
<p>[ ] å­˜å‚¨è¿‡ç¨‹</p>
</li>
<li>
<p>FROM Sharding-JDBC</p>
<p><strong>ä» å®˜ç½‘ ä»‹ç»è·å–ã€‚</strong></p>
</li>
<li>
<p>[ ] åˆ†å¸ƒå¼äº‹åŠ¡ ï¼šæœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡</p>
</li>
<li>
<p>[ ] åˆ†å¸ƒå¼äº‹åŠ¡ ï¼šTCCå‹äº‹åŠ¡(TBD)</p>
</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>MyCAT æºç åˆ†æ  â€”â€” XAåˆ†å¸ƒå¼äº‹åŠ¡</title>
    <link href="http://www.yunai.me/MyCAT/xa-distributed-transaction/"/>
    <id>http://www.yunai.me/MyCAT/xa-distributed-transaction/</id>
    <published>2017-07-14T16:00:00.000Z</published>
    <updated>2017-07-31T12:30:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. XA æ¦‚å¿µ</a></li>
<li><a href="#">3. MyCAT ä»£ç å®ç°</a>
<ul>
<li><a href="#">3.1 JDBC Demo ä»£ç </a></li>
<li><a href="#">3.2 MyCAT å¼€å¯ XA äº‹åŠ¡</a></li>
<li><a href="#">3.3 MyCAT æ¥æ”¶ SQL</a></li>
<li><a href="#">3.4 MySQL æ¥æ”¶ COMMIT</a>
<ul>
<li><a href="#">3.4.1 å•èŠ‚ç‚¹äº‹åŠ¡ or å¤šèŠ‚ç‚¹äº‹åŠ¡</a></li>
<li><a href="#">3.4.2 åè°ƒæ—¥å¿—</a></li>
<li><a href="#">3.4.3 MultiNodeCoordinator</a></li>
</ul>
</li>
<li><a href="#">3.5 MyCAT å¯åŠ¨å›æ»š XAäº‹åŠ¡</a></li>
</ul>
</li>
<li><a href="#">4. MyCAT å®ç°ç¼ºé™·</a>
<ul>
<li><a href="#">4.1 åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½</a></li>
<li><a href="#">4.2 æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨ PREPARE å°±è¿›è¡Œ COMMIT</a></li>
<li><a href="#">4.3 MyCAT å¯åŠ¨å›æ»š PREPARE çš„ XAäº‹åŠ¡</a></li>
<li><a href="#">4.4 å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—</a></li>
<li><a href="#">4.5 XA COMMIT éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†</a></li>
</ul>
</li>
<li><a href="#">5. å½©è›‹</a></li>
</ul>
<hr>
<h1>1. æ¦‚è¿°</h1>
<p>æ•°æ®åº“æ‹†åˆ†åï¼Œä¸šåŠ¡ä¸Šä¼šç¢°åˆ°éœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡çš„åœºæ™¯ã€‚MyCAT åŸºäº XA å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚å›½å†…ç›®å‰å¦å¤–ä¸€æ¬¾å¾ˆç«çš„æ•°æ®åº“ä¸­é—´ä»¶ Sharding-JDBC å‡†å¤‡åŸºäº TCC å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚</p>
<p>æœ¬æ–‡å†…å®¹åˆ†æˆä¸‰éƒ¨åˆ†ï¼š</p>
<ol>
<li>XA æ¦‚å¿µç®€è¿°</li>
<li>MyCAT ä»£ç å¦‚ä½•å®ç° XA</li>
<li>MyCAT åœ¨å®ç° XA å­˜åœ¨çš„ä¸€äº›ç¼ºé™·</li>
</ol>
<h1>2. XA æ¦‚å¿µ</h1>
<blockquote></blockquote>
<p>X/Open ç»„ç»‡ï¼ˆå³ç°åœ¨çš„ Open Group ï¼‰å®šä¹‰äº†åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†æ¨¡å‹ã€‚ X/Open DTP æ¨¡å‹ï¼ˆ 1994 ï¼‰åŒ…æ‹¬ï¼š</p>
<ol>
<li>åº”ç”¨ç¨‹åºï¼ˆ <strong>AP</strong> ï¼‰</li>
<li>äº‹åŠ¡ç®¡ç†å™¨ï¼ˆ <strong>TM</strong> ï¼‰</li>
<li>èµ„æºç®¡ç†å™¨ï¼ˆ <strong>RM</strong> ï¼‰</li>
<li>é€šä¿¡èµ„æºç®¡ç†å™¨ï¼ˆ <strong>CRM</strong> ï¼‰<br>
ä¸€èˆ¬ï¼Œå¸¸è§çš„äº‹åŠ¡ç®¡ç†å™¨ï¼ˆ TM ï¼‰æ˜¯äº¤æ˜“ä¸­é—´ä»¶ï¼Œå¸¸è§çš„èµ„æºç®¡ç†å™¨ï¼ˆ <strong>RM</strong> ï¼‰æ˜¯æ•°æ®åº“ï¼Œå¸¸è§çš„é€šä¿¡èµ„æºç®¡ç†å™¨ï¼ˆ <strong>CRM</strong> ï¼‰æ˜¯æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œä¸‹å›¾æ˜¯X/Open DTPæ¨¡å‹ï¼š</li>
</ol>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_15/01.png" alt=""></p>
<blockquote>
<p>ä¸€èˆ¬çš„ç¼–ç¨‹æ–¹å¼æ˜¯è¿™æ ·çš„ï¼š</p>
</blockquote>
<ol>
<li>é…ç½® <strong>TM</strong> ï¼Œé€šè¿‡ <strong>TM</strong> æˆ–è€… <strong>RM</strong> æä¾›çš„æ–¹å¼ï¼ŒæŠŠ <strong>RM</strong> æ³¨å†Œåˆ° <strong>TM</strong>ã€‚å¯ä»¥ç†è§£ä¸ºç»™ <strong>TM</strong> æ³¨å†Œ <strong>RM</strong> ä½œä¸ºæ•°æ®æºã€‚ä¸€ä¸ª <strong>TM</strong> å¯ä»¥æ³¨å†Œå¤šä¸ª <strong>RM</strong>ã€‚</li>
<li><strong>AP</strong> ä» <strong>TM</strong> è·å–èµ„æºç®¡ç†å™¨çš„ä»£ç†ï¼ˆä¾‹å¦‚ï¼šä½¿ç”¨JTAæ¥å£ï¼Œä»TMç®¡ç†çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè·å–å‡ºè¿™ä¸ªTMæ‰€ç®¡ç†çš„RMçš„JDBCè¿æ¥æˆ–JMSè¿æ¥ï¼‰<br>
<strong>AP</strong> å‘ <strong>TM</strong> å‘èµ·ä¸€ä¸ªå…¨å±€äº‹åŠ¡ã€‚è¿™æ—¶ï¼Œ<strong>TM</strong> ä¼šé€šçŸ¥å„ä¸ª <strong>RM</strong>ã€‚<strong>XID</strong>ï¼ˆå…¨å±€äº‹åŠ¡IDï¼‰ä¼šé€šçŸ¥åˆ°å„ä¸ªRMã€‚</li>
<li><strong>AP</strong> é€šè¿‡ <strong>TM</strong> ä¸­è·å–çš„è¿æ¥ï¼Œ<strong>é—´æ¥</strong>æ“ä½œ <strong>RM</strong> è¿›è¡Œä¸šåŠ¡æ“ä½œã€‚è¿™æ—¶ï¼Œ<strong>TM</strong> åœ¨æ¯æ¬¡ <strong>AP</strong> æ“ä½œæ—¶æŠŠ <strong>XID</strong>(åŒ…æ‹¬æ‰€å±åˆ†æ”¯çš„ä¿¡æ¯)ä¼ é€’ç»™ <strong>RM</strong>ï¼Œ<strong>RM</strong> æ­£æ˜¯é€šè¿‡è¿™ä¸ª <strong>XID</strong> å…³è”æ¥æ“ä½œå’Œäº‹åŠ¡çš„å…³ç³»çš„ã€‚</li>
<li><strong>AP</strong> ç»“æŸå…¨å±€äº‹åŠ¡æ—¶ï¼Œ<strong>TM</strong> ä¼šé€šçŸ¥ <strong>RM</strong> å…¨å±€äº‹åŠ¡ç»“æŸã€‚å¼€å§‹äºŒæ®µæäº¤ï¼Œä¹Ÿå°±æ˜¯prepare - commitçš„è¿‡ç¨‹ã€‚</li>
</ol>
<hr>
<blockquote>
<p>XAåè®®æŒ‡çš„æ˜¯TMï¼ˆäº‹åŠ¡ç®¡ç†å™¨ï¼‰å’ŒRMï¼ˆèµ„æºç®¡ç†å™¨ï¼‰ä¹‹é—´çš„æ¥å£ã€‚ç›®å‰ä¸»æµçš„å…³ç³»å‹æ•°æ®åº“äº§å“éƒ½æ˜¯å®ç°äº†XAæ¥å£çš„ã€‚JTA(Java Transaction API)æ˜¯ç¬¦åˆX/Open DTPæ¨¡å‹çš„ï¼Œäº‹åŠ¡ç®¡ç†å™¨å’Œèµ„æºç®¡ç†å™¨ä¹‹é—´ä¹Ÿä½¿ç”¨äº†XAåè®®ã€‚ æœ¬è´¨ä¸Šä¹Ÿæ˜¯å€ŸåŠ©ä¸¤é˜¶æ®µæäº¤åè®®æ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡çš„ï¼Œä¸‹é¢åˆ†åˆ«æ¥çœ‹çœ‹XAäº‹åŠ¡æˆåŠŸå’Œå¤±è´¥çš„æ¨¡å‹å›¾ï¼š</p>
</blockquote>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_15/02.png" alt="æˆåŠŸ"></p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_15/03.png" alt="å¤±è´¥"></p>
<hr>
<p>ğŸ˜ˆ çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯æœ‰ç§é»‘äººé—®å·çš„æ„Ÿè§‰ï¼Ÿæ·¡å®šï¼æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ MyCAT ä»£ç å±‚é¢æ˜¯å¦‚ä½•å®ç° XA çš„ã€‚å¦å¤–ï¼Œæœ‰å…´è¶£å¯¹æ¦‚å¿µäº†è§£æ›´å¤šçš„ï¼Œå¯ä»¥å‚çœ‹å¦‚ä¸‹æ–‡ç« ï¼š</p>
<ol>
<li><a href="http://www.infoq.com/cn/articles/xa-transactions-handle" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠXAäº‹åŠ¡å¤„ç†ã€‹</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/xa-statements.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠXA Transaction SQL Syntaxã€‹</a></li>
<li><a href="http://www.voidcn.com/blog/gao1738/article/p-4554083.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMySQL XA äº‹åŠ¡æ”¯æŒè°ƒç ”ã€‹</a></li>
</ol>
<h1>3. MyCAT ä»£ç å®ç°</h1>
<ul>
<li>MyCAT ï¼šTMï¼Œåè°ƒè€…ã€‚</li>
<li>æ•°æ®èŠ‚ç‚¹ ï¼šRMï¼Œå‚ä¸è€…ã€‚</li>
</ul>
<h2>3.1 JDBC Demo ä»£ç </h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCATXAClientDemo</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException </span>&#123;</div><div class="line">        <span class="comment">// 1. è·å¾—æ•°æ®åº“è¿æ¥</span></div><div class="line">        Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</div><div class="line">        Connection conn = DriverManager.getConnection(<span class="string">"jdbc:mysql://127.0.0.1:8066/dbtest"</span>, <span class="string">"root"</span>, <span class="string">"123456"</span>);</div><div class="line">        conn.setAutoCommit(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 2. å¼€å¯ MyCAT XA äº‹åŠ¡</span></div><div class="line">        conn.prepareStatement(<span class="string">"set xa=on"</span>).execute();</div><div class="line"></div><div class="line">        <span class="comment">// 3. æ’å…¥ SQL</span></div><div class="line">        <span class="comment">// 3.1 SQL1 Aåº“</span></div><div class="line">        <span class="keyword">long</span> uid = Math.abs(<span class="keyword">new</span> Random().nextLong());</div><div class="line">        String username = UUID.randomUUID().toString();</div><div class="line">        String password = UUID.randomUUID().toString();</div><div class="line">        String sql1 = String.format(<span class="string">"insert into t_user(id, username, password) VALUES (%d, '%s', '%s')"</span>,</div><div class="line">                uid, username, password);</div><div class="line">        conn.prepareStatement(sql1).execute();</div><div class="line">        <span class="comment">// 3.2 SQL2 Båº“</span></div><div class="line">        <span class="keyword">long</span> orderId = Math.abs(<span class="keyword">new</span> Random().nextLong());</div><div class="line">        String nickname = UUID.randomUUID().toString();</div><div class="line">        String sql2 = String.format(<span class="string">"insert into t_order(id, uid, nickname) VALUES(%d, %s, '%s')"</span>, orderId, uid, nickname);</div><div class="line">        conn.prepareStatement(sql2).execute();</div><div class="line"></div><div class="line">        <span class="comment">// 4. æäº¤ XA äº‹åŠ¡</span></div><div class="line">        conn.commit();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>set xa=on</code> MyCAT å¼€å¯ XA äº‹åŠ¡ã€‚</li>
<li><code>conn.commit</code> æäº¤ XA äº‹åŠ¡ã€‚</li>
</ul>
<h2>3.2 MyCAT å¼€å¯ XA äº‹åŠ¡</h2>
<p>å½“ MyCAT æ¥æ”¶åˆ° <code>set xa = on</code> å‘½ä»¤æ—¶ï¼Œå¼€å¯ XA äº‹åŠ¡ï¼Œå¹¶ç”Ÿæˆ XA äº‹åŠ¡ç¼–å·ã€‚XA äº‹åŠ¡ç¼–å·ç”Ÿæˆç®—æ³•ä¸º UUIDã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SetHandler.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String stmt, ServerConnection c, <span class="keyword">int</span> offset)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> rs = ServerParseSet.parse(stmt, offset);</div><div class="line">		<span class="keyword">switch</span> (rs &amp; <span class="number">0xff</span>) &#123;</div><div class="line">		<span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line">		<span class="keyword">case</span> XA_FLAG_ON: &#123;</div><div class="line">			<span class="keyword">if</span> (c.isAutocommit()) &#123;</div><div class="line">				c.writeErrMessage(ErrorCode.ERR_WRONG_USED, <span class="string">"set xa cmd on can't used in autocommit connection "</span>);</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			c.getSession2().setXATXEnabled(<span class="keyword">true</span>);</div><div class="line">			c.write(c.writeToBuffer(OkPacket.OK, c.allocate()));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">case</span> XA_FLAG_OFF: &#123;</div><div class="line">			c.writeErrMessage(ErrorCode.ERR_WRONG_USED,</div><div class="line">					<span class="string">"set xa cmd off not for external use "</span>);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// NonBlockingSession.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setXATXEnabled</span><span class="params">(<span class="keyword">boolean</span> xaTXEnabled)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (xaTXEnabled) &#123;</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.xaTXID == <span class="keyword">null</span>) &#123;</div><div class="line">           xaTXID = genXATXID(); <span class="comment">// ğŸ˜ˆğŸ˜ˆğŸ˜ˆè·å¾— XA äº‹åŠ¡ç¼–å·</span></div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">this</span>.xaTXID = <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">genXATXID</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> MycatServer.getInstance().getXATXIDGLOBAL();</div><div class="line">&#125;</div><div class="line"><span class="comment">// MycatServer.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getXATXIDGLOBAL</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="string">"'"</span> + getUUID() + <span class="string">"'"</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUUID</span><span class="params">()</span> </span>&#123; <span class="comment">// ğŸ˜ˆğŸ˜ˆğŸ˜ˆ</span></div><div class="line">   String s = UUID.randomUUID().toString();</div><div class="line">   <span class="keyword">return</span> s.substring(<span class="number">0</span>, <span class="number">8</span>) + s.substring(<span class="number">9</span>, <span class="number">13</span>) + s.substring(<span class="number">14</span>, <span class="number">18</span>) + s.substring(<span class="number">19</span>, <span class="number">23</span>) + s.substring(<span class="number">24</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.3 MyCAT æ¥æ”¶ SQL</h2>
<p>æ­¤å¤„ SQL æŒ‡çš„æ˜¯ <code>insert</code>ã€<code>update</code>ã€<code>delete</code> æ“ä½œã€‚</p>
<p>å½“å‘æŸä¸ªæ•°æ®èŠ‚ç‚¹<strong>ç¬¬ä¸€æ¬¡</strong>å‘èµ· SQL æ—¶ï¼Œä¼šåœ¨ SQL å‰é¢é™„åŠ  <code>XA START 'xaTranId'</code>ï¼Œå¹¶è®¾ç½®è¯¥æ•°æ®èŠ‚ç‚¹<strong>è¿æ¥</strong>äº‹åŠ¡çŠ¶æ€ä¸º <code>TxState.TX_STARTED_STATE</code>ï¼ˆ<em>åˆ†å¸ƒå¼äº‹åŠ¡çŠ¶æ€ï¼Œä¸‹æ–‡ä¼šä¸“é—¨æ•´ç†</em>ï¼‰ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MySQLConnection.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">synAndDoExecute</span><span class="params">(String xaTxID, RouteResultsetNode rrn,</span></span></div><div class="line">                                 <span class="keyword">int</span> clientCharSetIndex, <span class="keyword">int</span> clientTxIsoLation,</div><div class="line">                                 <span class="keyword">boolean</span> clientAutoCommit) &#123;</div><div class="line">   String xaCmd = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">boolean</span> conAutoComit = <span class="keyword">this</span>.autocommit;</div><div class="line">   String conSchema = <span class="keyword">this</span>.schema;</div><div class="line">   <span class="comment">// never executed modify sql,so auto commit</span></div><div class="line">   <span class="keyword">boolean</span> expectAutocommit = !modifiedSQLExecuted || isFromSlaveDB() || clientAutoCommit;</div><div class="line">   <span class="keyword">if</span> (expectAutocommit == <span class="keyword">false</span> &amp;&amp; xaTxID != <span class="keyword">null</span> &amp;&amp; xaStatus == TxState.TX_INITIALIZE_STATE) &#123; <span class="comment">// ğŸ˜ˆğŸ˜ˆğŸ˜ˆ</span></div><div class="line">       xaCmd = <span class="string">"XA START "</span> + xaTxID + <span class="string">';'</span>;</div><div class="line">       <span class="keyword">this</span>.xaStatus = TxState.TX_STARTED_STATE;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">   <span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line">   <span class="keyword">if</span> (xaCmd != <span class="keyword">null</span>) &#123;</div><div class="line">       sb.append(xaCmd);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// and our query sql to multi command at last</span></div><div class="line">   sb.append(rrn.getStatement() + <span class="string">";"</span>);</div><div class="line">   <span class="comment">// syn and execute others</span></div><div class="line">   <span class="keyword">this</span>.sendQueryCmd(sb.toString());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸¾ä¸ª å˜é‡<code>sb</code> çš„ä¾‹å­ï¼š</p>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SET</span> <span class="keyword">names</span> utf8;<span class="keyword">SET</span> autocommit=<span class="number">0</span>;XA <span class="keyword">START</span> <span class="string">'1f2da7353e8846e5833b8d8dd041cfb1'</span>,<span class="string">'db2'</span>;<span class="keyword">insert</span> <span class="keyword">into</span> t_user(<span class="keyword">id</span>, username, <span class="keyword">password</span>) <span class="keyword">VALUES</span> (<span class="number">3400</span>, <span class="string">'b7c5ec1f-11cc-4599-851c-06ad617fec42'</span>, <span class="string">'d2694679-f6a2-4623-a339-48d4a868be90'</span>);</div></pre></td></tr></table></figure></p>
<h2>3.4 MySQL æ¥æ”¶ COMMIT</h2>
<h3>3.4.1 å•èŠ‚ç‚¹äº‹åŠ¡ or å¤šèŠ‚ç‚¹äº‹åŠ¡</h3>
<p><code>COMMIT</code> æ‰§è¡Œæ—¶ï¼ŒMyCAT ä¼šåˆ¤æ–­ XA äº‹åŠ¡é‡Œï¼Œæ¶‰åŠåˆ°çš„æ•°æ®åº“èŠ‚ç‚¹æ•°é‡ã€‚</p>
<ul>
<li>å¦‚æœèŠ‚ç‚¹æ•°é‡ä¸º 1ï¼Œå•èŠ‚ç‚¹äº‹åŠ¡ï¼Œä½¿ç”¨ <code>CommitNodeHandler</code> å¤„ç†ã€‚</li>
<li>å¦‚æœèŠ‚ç‚¹æ•°é‡ &gt; 1ï¼Œå¤šèŠ‚ç‚¹äº‹åŠ¡ï¼Œä½¿ç”¨ <code>MultiNodeCoordinator</code> å¤„ç†ã€‚</li>
</ul>
<p><code>CommitNodeHandler</code> ç›¸æ¯” <code>MultiNodeCoordinator</code> æ¥è¯´ï¼Œåªæœ‰ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ï¼Œä¸éœ€è¦è¿›è¡Œå¤šèŠ‚ç‚¹åè°ƒï¼Œé€»è¾‘ä¼šç›¸å¯¹ç®€å•ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å¦å¤–çœ‹ã€‚æˆ‘ä»¬ä¸»è¦åˆ†æ <code>MultiNodeCoordinator</code>ã€‚</p>
<h3>3.4.2 åè°ƒæ—¥å¿—</h3>
<p><strong>åè°ƒæ—¥å¿—</strong>ï¼Œè®°å½•åè°ƒè¿‡ç¨‹ä¸­å„æ•°æ®èŠ‚ç‚¹ XA äº‹åŠ¡çŠ¶æ€ï¼Œå¤„ç†<strong>MyCATå¼‚å¸¸å¥”æºƒ</strong>æˆ–è€…<strong>æ•°æ®èŠ‚ç‚¹éƒ¨åˆ†XA COMMITï¼Œå¦å¤–éƒ¨åˆ† XA PREPARE</strong>ä¸‹çš„çŠ¶æ€æ¢å¤ã€‚</p>
<p><strong>XA äº‹åŠ¡å…±æœ‰ç§</strong>ï¼š</p>
<ol>
<li>TX_INITIALIZE_STATE ï¼šäº‹åŠ¡åˆå§‹åŒ–</li>
<li>TX_STARTED_STATE ï¼šäº‹åŠ¡å¼€å§‹å®Œæˆ</li>
<li>TX_PREPARED_STATE ï¼šäº‹åŠ¡å‡†å¤‡å®Œæˆ</li>
<li>TX_COMMITED_STATE ï¼šäº‹åŠ¡æäº¤å®Œæˆ</li>
<li>TX_ROLLBACKED_STATE ï¼šäº‹åŠ¡å›æ»šå®Œæˆ</li>
</ol>
<p><strong>çŠ¶æ€å˜æ›´æµ</strong> ï¼šTX_INITIALIZE_STATE =&gt; TX_STARTED_STATE =&gt; TX_PREPARED_STATE =&gt; TX_COMMITED_STATE / TX_ROLLBACKED_STATE ã€‚</p>
<p><strong>åè°ƒæ—¥å¿—åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†</strong>ï¼š</p>
<ol>
<li>CoordinatorLogEntry ï¼šåè°ƒè€…æ—¥å¿—</li>
<li>ParticipantLogEntry ï¼šå‚ä¸è€…æ—¥å¿—ã€‚<strong>æ­¤å¤„ï¼Œæ•°æ®èŠ‚ç‚¹æ‰®æ¼”å‚ä¸è€…çš„è§’è‰²ã€‚ä¸‹æ–‡ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°å‚ä¸è€…ä¸æ•°æ®èŠ‚ç‚¹æ··ç”¨çš„æƒ…å†µï¼Œæœ›è§è°…ã€‚</strong></li>
</ol>
<p><em>ä¸€æ¬¡ XA äº‹åŠ¡ï¼Œå¯¹åº”ä¸€æ¡ <code>CoordinatorLogEntry</code>ã€‚ä¸€æ¡<code>CoordinatorLogEntry</code> åŒ…å« Næ¡<code>ParticipantLogEntry</code></em>ã€‚ æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CoordinatorLogEntry ï¼šåè°ƒè€…æ—¥å¿—</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CoordinatorLogEntry</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * XA äº‹åŠ¡ç¼–å·</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String id;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å‚ä¸è€…æ—¥å¿—æ•°ç»„</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ParticipantLogEntry[] participants;</div><div class="line">&#125;</div><div class="line"><span class="comment">// ParticipantLogEntry ï¼šå‚ä¸è€…æ—¥å¿—</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParticipantLogEntry</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * XA äº‹åŠ¡ç¼–å·</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> String coordinatorId;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•°æ®åº“ uri</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> String uri;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¿‡æœŸæè¿°</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">long</span> expires;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * XA äº‹åŠ¡çŠ¶æ€</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> txState;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å‚ä¸è€…åå­—</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> String resourceName;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>MyCAT è®°å½•åè°ƒæ—¥å¿—ä»¥ JSONæ ¼å¼ åˆ°æ–‡ä»¶</strong>ã€‚<strong>æ¯è¡Œ</strong>åŒ…å«ä¸€æ¡<code>CoordinatorLogEntry</code>ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p>
<p><figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;<span class="attr">"id"</span>:<span class="string">"'e827b3fe666c4d968961350d19adda31'"</span>,<span class="attr">"participants"</span>:[&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db3"</span>&#125;,&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db1"</span>&#125;]&#125;</div><div class="line">&#123;<span class="attr">"id"</span>:<span class="string">"'f00b61fa17cb4ec5b8264a6d82f847d0'"</span>,<span class="attr">"participants"</span>:[&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db2"</span>&#125;,&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db1"</span>&#125;]&#125;</div></pre></td></tr></table></figure></p>
<p>å®ç°ç±»ä¸ºï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// XA åè°ƒè€…æ—¥å¿— å­˜å‚¨æ¥å£ï¼šhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/Repository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Repository</span> </span>&#123;&#125;</div><div class="line"><span class="comment">// XA åè°ƒè€…æ—¥å¿— æ–‡ä»¶å­˜å‚¨ï¼šhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/impl/FileSystemRepository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileSystemRepository</span> <span class="keyword">implements</span> <span class="title">Repository</span> </span>&#123;&#125;</div><div class="line"><span class="comment">// XA åè°ƒè€…æ—¥å¿— æ–‡ä»¶å­˜å‚¨ï¼šhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/impl/InMemoryRepository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InMemoryRepository</span> <span class="keyword">implements</span> <span class="title">Repository</span> </span>&#123;&#125;</div></pre></td></tr></table></figure></p>
<p>ç›®å‰æ—¥å¿—æ–‡ä»¶å†™å…¥çš„æ–¹å¼æ€§èƒ½è¾ƒå·®ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸åšåˆ†æï¼Œåœ¨ã€4. MyCAT å®ç°ç¼ºé™·ã€‘é‡Œä¸€èµ·è®²ã€‚</p>
<h3>3.4.3 MultiNodeCoordinator</h3>
<p>æ•²æ•²æ•²ï¼Œè¿™é‡Œæ˜¯æœ¬æ–‡çš„é‡ç‚¹ä¹‹ä¸€å™¢ã€‚ğŸ˜ˆ</p>
<p><strong>ç¬¬ä¸€é˜¶æ®µï¼šå‘èµ· PREPAREã€‚</strong></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeBatchNodeCmd</span><span class="params">(SQLCtrlCommand cmdHandler)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.cmdHandler = cmdHandler;</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> initCount = session.getTargetCount();</div><div class="line">   runningCount.set(initCount);</div><div class="line">   nodeCount = initCount;</div><div class="line">   failed.set(<span class="keyword">false</span>);</div><div class="line">   faileCount.set(<span class="number">0</span>);</div><div class="line">   <span class="comment">//recovery nodes log</span></div><div class="line">   ParticipantLogEntry[] participantLogEntry = <span class="keyword">new</span> ParticipantLogEntry[initCount];</div><div class="line">   <span class="comment">// æ‰§è¡Œ</span></div><div class="line">   <span class="keyword">int</span> started = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (RouteResultsetNode rrn : session.getTargetKeys()) &#123;</div><div class="line">       <span class="keyword">if</span> (rrn == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">final</span> BackendConnection conn = session.getTarget(rrn);</div><div class="line">       <span class="keyword">if</span> (conn != <span class="keyword">null</span>) &#123;</div><div class="line">           conn.setResponseHandler(<span class="keyword">this</span>);</div><div class="line">           <span class="comment">//process the XA_END XA_PREPARE Command</span></div><div class="line">           MySQLConnection mysqlCon = (MySQLConnection) conn;</div><div class="line">           String xaTxId = <span class="keyword">null</span>;</div><div class="line">           <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) &#123;</div><div class="line">               xaTxId = session.getXaTXID() + <span class="string">",'"</span> + mysqlCon.getSchema() + <span class="string">"'"</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (mysqlCon.getXaStatus() == TxState.TX_STARTED_STATE) &#123; <span class="comment">// XA äº‹åŠ¡</span></div><div class="line">               <span class="comment">//recovery Log</span></div><div class="line">               participantLogEntry[started] = <span class="keyword">new</span> ParticipantLogEntry(xaTxId, conn.getHost(), <span class="number">0</span>, conn.getSchema(), ((MySQLConnection) conn).getXaStatus());</div><div class="line">               String[] cmds = <span class="keyword">new</span> String[]&#123;<span class="string">"XA END "</span> + xaTxId, <span class="comment">// XA END å‘½ä»¤</span></div><div class="line">                       <span class="string">"XA PREPARE "</span> + xaTxId&#125;; <span class="comment">// XA PREPARE å‘½ä»¤</span></div><div class="line">               mysqlCon.execBatchCmd(cmds);</div><div class="line">           &#125; <span class="keyword">else</span> &#123; <span class="comment">// é XA äº‹åŠ¡</span></div><div class="line">               <span class="comment">// recovery Log</span></div><div class="line">               participantLogEntry[started] = <span class="keyword">new</span> ParticipantLogEntry(xaTxId, conn.getHost(), <span class="number">0</span>, conn.getSchema(), ((MySQLConnection) conn).getXaStatus());</div><div class="line">               cmdHandler.sendCommand(session, conn);</div><div class="line">           &#125;</div><div class="line">           ++started;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// xa recovery log</span></div><div class="line">   <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) &#123;</div><div class="line">       CoordinatorLogEntry coordinatorLogEntry = <span class="keyword">new</span> CoordinatorLogEntry(session.getXaTXID(), <span class="keyword">false</span>, participantLogEntry);</div><div class="line">       inMemoryRepository.put(session.getXaTXID(), coordinatorLogEntry);</div><div class="line">       fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (started &lt; nodeCount) &#123; <span class="comment">// TODO ç–‘é—®ï¼šå¦‚ä½•è§¦å‘</span></div><div class="line">       runningCount.set(started);</div><div class="line">       LOGGER.warn(<span class="string">"some connection failed to execute "</span> + (nodeCount - started));</div><div class="line">       <span class="comment">/**</span></div><div class="line">        * assumption: only caused by front-end connection close. &lt;br/&gt;</div><div class="line">        * Otherwise, packet must be returned to front-end</div><div class="line">        */</div><div class="line">       failed.set(<span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å‘å„æ•°æ®èŠ‚ç‚¹å‘é€ <code>XA END</code> + <code>XA PREPARE</code> æŒ‡ä»¤ã€‚ä¸¾ä¸ª å˜é‡<code>cmds</code> ä¾‹å­ï¼š</li>
</ul>
<p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">XA <span class="keyword">END</span> <span class="string">'4cbb18214d0b47adbdb0658598666677'</span>,<span class="string">'db3'</span>;XA <span class="keyword">PREPARE</span> <span class="string">'4cbb18214d0b47adbdb0658598666677'</span>,<span class="string">'db3'</span>;</div></pre></td></tr></table></figure></p>
<ul>
<li>è®°å½•åè°ƒæ—¥å¿—ã€‚æ¯æ¡å‚ä¸è€…æ—¥å¿—çŠ¶æ€ä¸º <code>TxState.TX_STARTED_STATE</code>ã€‚</li>
</ul>
<hr>
<p><strong>ç¬¬äºŒé˜¶æ®µï¼šå‘èµ· COMMITã€‚</strong></p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">okResponse</span><span class="params">(<span class="keyword">byte</span>[] ok, BackendConnection conn)</span> </span>&#123;</div><div class="line">   <span class="comment">// process the XA Transatcion 2pc commit</span></div><div class="line">   <span class="keyword">if</span> (conn <span class="keyword">instanceof</span> MySQLConnection) &#123;</div><div class="line">       MySQLConnection mysqlCon = (MySQLConnection) conn;</div><div class="line">       <span class="keyword">switch</span> (mysqlCon.getXaStatus()) &#123;</div><div class="line">           <span class="keyword">case</span> TxState.TX_STARTED_STATE:</div><div class="line">               <span class="comment">//if there have many SQL execute wait the okResponse,will come to here one by one</span></div><div class="line">               <span class="comment">//should be wait all nodes ready ,then send xa commit to all nodes.</span></div><div class="line">               <span class="keyword">if</span> (mysqlCon.batchCmdFinished()) &#123;</div><div class="line">                   String xaTxId = session.getXaTXID();</div><div class="line">                   String cmd = <span class="string">"XA COMMIT "</span> + xaTxId + <span class="string">",'"</span> + mysqlCon.getSchema() + <span class="string">"'"</span>;</div><div class="line">                   <span class="keyword">if</span> (LOGGER.isDebugEnabled()) &#123;</div><div class="line">                       LOGGER.debug(<span class="string">"Start execute the cmd :"</span> + cmd + <span class="string">",current host:"</span> + mysqlCon.getHost() + <span class="string">":"</span> + mysqlCon.getPort());</div><div class="line">                   &#125;</div><div class="line">                   <span class="comment">// recovery log</span></div><div class="line">                   CoordinatorLogEntry coordinatorLogEntry = inMemoryRepository.get(xaTxId);</div><div class="line">                   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntry.participants.length; i++) &#123;</div><div class="line">                       LOGGER.debug(<span class="string">"[In Memory CoordinatorLogEntry]"</span> + coordinatorLogEntry.participants[i]);</div><div class="line">                       <span class="keyword">if</span> (coordinatorLogEntry.participants[i].resourceName.equals(conn.getSchema())) &#123;</div><div class="line">                           coordinatorLogEntry.participants[i].txState = TxState.TX_PREPARED_STATE;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">                   inMemoryRepository.put(xaTxId, coordinatorLogEntry);</div><div class="line">                   fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">                   <span class="comment">// send commit</span></div><div class="line">                   mysqlCon.setXaStatus(TxState.TX_PREPARED_STATE);</div><div class="line">                   mysqlCon.execCmd(cmd);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           <span class="keyword">case</span> TxState.TX_PREPARED_STATE: &#123;</div><div class="line">               <span class="comment">// recovery log</span></div><div class="line">               String xaTxId = session.getXaTXID();</div><div class="line">               CoordinatorLogEntry coordinatorLogEntry = inMemoryRepository.get(xaTxId);</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntry.participants.length; i++) &#123;</div><div class="line">                   <span class="keyword">if</span> (coordinatorLogEntry.participants[i].resourceName.equals(conn.getSchema())) &#123;</div><div class="line">                       coordinatorLogEntry.participants[i].txState = TxState.TX_COMMITED_STATE;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">               inMemoryRepository.put(xaTxId, coordinatorLogEntry);</div><div class="line">               fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">               <span class="comment">// XA reset status now</span></div><div class="line">               mysqlCon.setXaStatus(TxState.TX_INITIALIZE_STATE);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">default</span>:</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// é‡Šæ”¾è¿æ¥</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.cmdHandler.relaseConOnOK()) &#123;</div><div class="line">       session.releaseConnection(conn);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       session.releaseConnectionIfSafe(conn, LOGGER.isDebugEnabled(), <span class="keyword">false</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ˜¯å¦æ‰€æœ‰èŠ‚ç‚¹éƒ½å®Œæˆcommitï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å›Client æˆåŠŸ</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.finished()) &#123;</div><div class="line">       cmdHandler.okResponse(session, ok);</div><div class="line">       <span class="keyword">if</span> (cmdHandler.isAutoClearSessionCons()) &#123;</div><div class="line">           session.clearResources(<span class="keyword">false</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">/* 1.  äº‹åŠ¡æäº¤å,xa äº‹åŠ¡ç»“æŸ   */</span></div><div class="line">       <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) &#123;</div><div class="line">           session.setXATXEnabled(<span class="keyword">false</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">/* 2. preAcStates ä¸ºtrue,äº‹åŠ¡ç»“æŸå,éœ€è¦è®¾ç½®ä¸ºtrueã€‚preAcStates ä¸ºacä¸Šä¸€ä¸ªçŠ¶æ€    */</span></div><div class="line">       <span class="keyword">if</span> (session.getSource().isPreAcStates()) &#123;</div><div class="line">           session.getSource().setAutocommit(<span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>mysqlCon.batchCmdFinished()</code> æ¯ä¸ªæ•°æ®èŠ‚ç‚¹ï¼Œç¬¬ä¸€æ¬¡è¿”å›çš„æ˜¯ <code>XA END</code> æˆåŠŸï¼Œç¬¬äºŒæ¬¡è¿”å›çš„æ˜¯ <code>XA PREPARE</code>ã€‚åœ¨ <code>XA PREPARE</code> æˆåŠŸåï¼Œè®°å½•è¯¥æ•°æ®èŠ‚ç‚¹çš„<strong>å‚ä¸è€…æ—¥å¿—</strong>çŠ¶æ€ä¸º <code>TxState.TX_PREPARED_STATE</code>ã€‚ä¹‹åï¼Œå‘è¯¥æ•°æ®èŠ‚ç‚¹å‘èµ· <code>XA COMMIT</code> å‘½ä»¤ã€‚</li>
<li><code>XA COMMIT</code> è¿”å›æˆåŠŸåï¼Œè®°å½•è¯¥æ•°æ®èŠ‚ç‚¹çš„<strong>äº‹åŠ¡å‚ä¸è€…æ—¥å¿—</strong>çŠ¶æ€ä¸º <code>TxState.TX_COMMITED_STATE</code>ã€‚</li>
<li>å½“æ‰€æœ‰æ•°æ®èŠ‚ç‚¹ï¼ˆå‚ä¸è€…ï¼‰éƒ½æ‰§è¡Œå®Œæˆ <code>XA COMMIT</code> è¿”å›ï¼Œå³ <code>this.finished() == true</code>ï¼Œè¿”å› MySQL Client XA äº‹åŠ¡æäº¤æˆåŠŸã€‚</li>
</ul>
<p>[x] <code>XA PREPARE</code> å’Œ <code>XA COMMIT</code>ï¼Œæ•°æ®èŠ‚ç‚¹å¯èƒ½è¿”å›å¤±è´¥ï¼Œç›®å‰æš‚æ—¶æ²¡æ¨¡æ‹Ÿå‡ºæ¥ï¼Œå¯¹åº”æ–¹æ³•ä¸º <code>#errorResponse(....)</code>ã€‚</p>
<h2>3.5 MyCAT å¯åŠ¨å›æ»š XAäº‹åŠ¡</h2>
<p>MyCAT å¯åŠ¨æ—¶ï¼Œä¼š<strong>å›æ»šå¤„äºTxState.TX_PREPARED_STATE</strong>çš„ <code>ParticipantLogEntry</code> å¯¹åº”çš„æ•°æ®èŠ‚ç‚¹çš„ XA äº‹åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MycatServer.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performXARecoveryLog</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// fetch the recovery log</span></div><div class="line">   CoordinatorLogEntry[] coordinatorLogEntries = getCoordinatorLogEntries();</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntries.length; i++) &#123;</div><div class="line">       CoordinatorLogEntry coordinatorLogEntry = coordinatorLogEntries[i];</div><div class="line">       <span class="keyword">boolean</span> needRollback = <span class="keyword">false</span>;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; coordinatorLogEntry.participants.length; j++) &#123;</div><div class="line">           ParticipantLogEntry participantLogEntry = coordinatorLogEntry.participants[j];</div><div class="line">           <span class="keyword">if</span> (participantLogEntry.txState == TxState.TX_PREPARED_STATE) &#123;</div><div class="line">               needRollback = <span class="keyword">true</span>;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (needRollback) &#123;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; coordinatorLogEntry.participants.length; j++) &#123;</div><div class="line">               ParticipantLogEntry participantLogEntry = coordinatorLogEntry.participants[j];</div><div class="line">               <span class="comment">//XA rollback</span></div><div class="line">               String xacmd = <span class="string">"XA ROLLBACK "</span> + coordinatorLogEntry.id + <span class="string">';'</span>;</div><div class="line">               OneRawSQLQueryResultHandler resultHandler = <span class="keyword">new</span> OneRawSQLQueryResultHandler(<span class="keyword">new</span> String[<span class="number">0</span>], <span class="keyword">new</span> XARollbackCallback());</div><div class="line">               outloop:</div><div class="line">               <span class="keyword">for</span> (SchemaConfig schema : MycatServer.getInstance().getConfig().getSchemas().values()) &#123;</div><div class="line">                   <span class="keyword">for</span> (TableConfig table : schema.getTables().values()) &#123;</div><div class="line">                       <span class="keyword">for</span> (String dataNode : table.getDataNodes()) &#123;</div><div class="line">                           PhysicalDBNode dn = MycatServer.getInstance().getConfig().getDataNodes().get(dataNode);</div><div class="line">                           <span class="keyword">if</span> (dn.getDbPool().getSource().getConfig().getIp().equals(participantLogEntry.uri)</div><div class="line">                                   &amp;&amp; dn.getDatabase().equals(participantLogEntry.resourceName)) &#123;</div><div class="line">                               <span class="comment">//XA STATE ROLLBACK</span></div><div class="line">                               participantLogEntry.txState = TxState.TX_ROLLBACKED_STATE;</div><div class="line">                               SQLJob sqlJob = <span class="keyword">new</span> SQLJob(xacmd, dn.getDatabase(), resultHandler, dn.getDbPool().getSource());</div><div class="line">                               sqlJob.run();</div><div class="line">                               <span class="keyword">break</span> outloop;</div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// init into in memory cached</span></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntries.length; i++) &#123;</div><div class="line">  MultiNodeCoordinator.inMemoryRepository.put(coordinatorLogEntries[i].id, coordinatorLogEntries[i]);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// discard the recovery log</span></div><div class="line">    MultiNodeCoordinator.fileRepository.writeCheckpoint(MultiNodeCoordinator.inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>4. MyCAT å®ç°ç¼ºé™·</h1>
<p>MyCAT 1.6.5 ç‰ˆæœ¬å®ç°å¼±XAäº‹åŠ¡ï¼Œç›¸å¯¹æ¥è¯´ï¼Œç¬”è€…è®¤ä¸ºè·ç¦»å®é™…ç”Ÿäº§ä½¿ç”¨å­˜åœ¨ä¸€äº›å·®è·ã€‚ä¸‹é¢ç½—åˆ—å¯èƒ½å­˜åœ¨çš„ç¼ºé™·ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œéº»çƒ¦æŒ‡å‡ºã€‚ğŸ™‚å¸Œæœ› MyCAT åœ¨åˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°ä¸Šï¼Œèƒ½å¤Ÿè¶Šæ¥è¶Šç»™åŠ›ã€‚</p>
<h2>4.1 åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½</h2>
<p>1ã€<code>CoordinatorLogEntry</code>ã€<code>ParticipantLogEntry</code> åœ¨æ¯æ¬¡å†™å…¥æ–‡ä»¶æ—¶ï¼Œæ˜¯å°†å†…å­˜ä¸­æ‰€æœ‰çš„æ—¥å¿—<strong>å…¨éƒ¨é‡æ–°</strong>å†™å…¥ï¼Œå¯¼è‡´å†™å…¥æ€§èƒ½éšç€ XA äº‹åŠ¡æ¬¡æ•°çš„å¢åŠ ï¼Œæ€§èƒ½ä¼šè¶Šæ¥è¶Šç³Ÿç³•ï¼Œå¯¼è‡´ XA äº‹åŠ¡æ•´ä½“æ€§èƒ½ä¼šéå¸¸å·®ã€‚å¦å¤–ï¼Œè¯¥æ–¹æ³•æ˜¯<strong>åŒæ­¥</strong>çš„ï¼Œä¹ŸåŠ å¤§äº†å†™å…¥çš„å»¶è¿Ÿã€‚</p>
<p>å»ºè®®ï¼šå…ˆè·å¾—å¯å†™å…¥æ–‡ä»¶çš„ OFFSETï¼Œå†™å…¥åè°ƒæ—¥å¿—åˆ°æ–‡ä»¶ï¼Œå†…å­˜ç»´æŠ¤å¥½ XAäº‹åŠ¡ç¼–å· ä¸ OFFSET çš„æ˜ å°„å…³ç³»ï¼Œä»è€Œå®ç°<strong>é¡ºåºå†™å…¥</strong> + <strong>å¹¶è¡Œå†™å…¥</strong>ã€‚</p>
<p>2ã€å†…å­˜é‡Œç»´æŠ¤äº†æ‰€æœ‰çš„åè°ƒæ—¥å¿—ï¼Œå ç”¨å†…å­˜ä¼šè¶Šæ¥è¶Šå¤§ï¼Œå¹¶ä¸”æ— é‡Šæ”¾æœºåˆ¶ã€‚å³ä½¿é‡å¯ï¼Œåè°ƒæ—¥å¿—ä¹Ÿä¼šé‡æ–°åŠ è½½åˆ°å†…å­˜ã€‚</p>
<p>å»ºè®®ï¼šå·²å®Œå…¨å›æ»šæˆ–è€…æäº¤çš„åè°ƒæ—¥å¿—ä¸æ”¾å…¥å†…å­˜ã€‚å¦å¤–æœ‰æ–‡ä»¶å­˜å‚¨å¥½ XAäº‹åŠ¡ç¼–å· ä¸ OFFSET çš„æ˜ å°„å…³ç³»ã€‚</p>
<p>3ã€åè°ƒæ—¥å¿—åªå†™å…¥å•ä¸ªæ–‡ä»¶ã€‚</p>
<p>å»ºè®®ï¼šåˆ†æ‹†åè°ƒæ—¥å¿—æ–‡ä»¶ã€‚</p>
<p>PSï¼šæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹ <code>RocketMQ</code> å¯¹ <code>CommitLog</code> çš„å­˜å‚¨ï¼Œæ€§èƒ½ä¸Šå¾ˆèµï¼</p>
<h2>4.2 æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨ PREPARE å°±è¿›è¡Œ COMMIT</h2>
<p>XA äº‹åŠ¡å®šä¹‰ï¼Œéœ€è¦ç­‰å¾…æ‰€æœ‰å‚ä¸è€…<strong>å…¨éƒ¨</strong> <code>XA PREPARE</code> æˆåŠŸå®Œæˆåå‘èµ· <code>XA COMMIT</code>ã€‚ç›®å‰ MyCAT æ˜¯æŸä¸ªæ•°æ®èŠ‚ç‚¹ <code>XA PREPARE</code> å®Œæˆå<strong>ç«‹å³</strong>è¿›è¡Œ <code>XA COMMIT</code>ã€‚æ¯”å¦‚è¯´ï¼šç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹æäº¤äº† <code>XA END;XA PREPARE</code> æ—¶ï¼Œç¬¬äºŒä¸ªæ•°æ®èŠ‚åœ¨è¿›è¡Œ <code>XA END;XA PREAPRE;</code> å‰æŒ‚äº†ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¾ç„¶ä¼š <code>XA COMMIT</code> æˆåŠŸã€‚</p>
<p>å»ºè®®ï¼šæŒ‰ç…§ä¸¥æ ¼çš„ XA äº‹åŠ¡å®šä¹‰ã€‚</p>
<h2>4.3 MyCAT å¯åŠ¨å›æ»š PREPARE çš„ XAäº‹åŠ¡</h2>
<p>1ã€MyCAT å¯åŠ¨æ—¶ï¼Œå›æ»šæ‰€æœ‰çš„ <code>PREPARE</code> çš„ XA äº‹åŠ¡ï¼Œå¯èƒ½æŸä¸ª XA äº‹åŠ¡ï¼Œéƒ¨åˆ† <code>COMMIT</code>ï¼Œéƒ¨åˆ† <code>PREPARE</code>ã€‚æ­¤æ—¶ç›´æ¥å›æ»šï¼Œä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚</p>
<p>å»ºè®®ï¼šå½“åˆ¤æ–­åˆ°æŸä¸ª XA äº‹åŠ¡å­˜åœ¨ <code>PREPARE</code> çš„å‚ä¸è€…ï¼Œ<strong>åŒæ—¶åˆ¤æ–­è¯¥ XA äº‹åŠ¡é‡Œå…¶ä»–å‚ä¸è€…çš„äº‹åŠ¡çŠ¶æ€</strong>ä»¥åŠ<strong>æ•°æ®èŠ‚ç‚¹é‡Œ XA äº‹åŠ¡çŠ¶æ€</strong>ï¼Œæ¯”å¦‚å‚ä¸è€…ä¸º <code>MySQL</code>æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>XA RECOVER</code> æŸ¥è¯¢å¤„äº <code>PREPARE</code> æ‰€æœ‰çš„ XA äº‹åŠ¡ã€‚</p>
<p>2ã€å›æ»š <code>PREPARE</code> æ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œåœ¨æœªè¿›è¡Œå®Œæˆæ—¶å·²ç»è®¾ç½®æ–‡ä»¶é‡Œå›æ»šæˆåŠŸã€‚å¦‚æœå¼‚æ­¥è¿‡ç¨‹ä¸­å¤±è´¥ï¼Œä¼šå¯¼è‡´ XA äº‹åŠ¡çŠ¶æ€ä¸ä¸€è‡´ã€‚</p>
<p>å»ºè®®ï¼šå›è°ƒæˆåŠŸåï¼Œæ›´æ–°è¯¥ XA äº‹åŠ¡çŠ¶æ€ã€‚</p>
<h2>4.4 å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—</h2>
<p>è¯¥æƒ…å†µè¾ƒä¸ºæç«¯ã€‚å‘èµ· <code>XA PREPARE</code>å®Œåï¼ŒMyCAT æŒ‚äº†ã€‚é‡å¯åï¼Œè¯¥ XA äº‹åŠ¡åœ¨ MyCAT é‡Œå°±â€œæ¶ˆå¤±â€œäº†ï¼Œå‚ä¸è€…çš„è¯¥ XA äº‹åŠ¡ä¸€ç›´å¤„äº <code>PREPARE</code> çŠ¶æ€ã€‚ä»ç†è®ºä¸Šæ¥è¯´ï¼Œéœ€è¦å›æ»šè¯¥ XA äº‹åŠ¡ã€‚</p>
<p>å»ºè®®ï¼šè®°å½•åè°ƒæ—¥å¿—ã€‚</p>
<h2>4.5 XA COMMIT éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†</h2>
<p>å½“ä¸€éƒ¨åˆ†èŠ‚ç‚¹ <code>XA COMMIT</code> å®Œæˆï¼Œå¦å¤–ä¸€éƒ¨åˆ†æ­¤æ—¶æŒ‚äº†ã€‚åœ¨ç®¡ç†å‘˜é‡å¯æŒ‚æ‰çš„èŠ‚ç‚¹ï¼Œå…¶å¯¹åº”çš„ XA äº‹åŠ¡æœªè¿›ä¸€æ­¥å¤„ç†ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚</p>
<p>å»ºè®®ï¼šğŸ˜ˆæœ¨æœ‰å»ºè®®ã€‚ä¹Ÿå¾ˆå¥½å¥‡ï¼Œå¦‚æœæ˜¯è¿™æ ·çš„æƒ…å†µï¼Œå¦‚ä½•å¤„ç†è¾ƒä¸ºåˆé€‚ã€‚å¦‚æœ‰å¤§å¤§çŸ¥é“ï¼Œçƒ¦è¯·å‘ŠçŸ¥ä¸‹ã€‚</p>
<h1>5. å½©è›‹</h1>
<p>ä¾‹è¡Œâ€œå½©è›‹â€ï¼Ÿ</p>
<ul>
<li><a href="http://blog.csdn.net/d6619309/article/details/52330334" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMycatæºç ç¯‡ : MyCatäº‹åŠ¡ç®¡ç†æœºåˆ¶åˆ†æã€‹</a> æ¥è‡ª MyCAT Committer çš„æ–‡ç« </li>
<li><a href="http://mysql.taobao.org/monthly/2015/04/05/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMySQL Â· æ‰è™«åŠ¨æ€ Â· è¿æ¥æ–­å¼€å¯¼è‡´XAäº‹åŠ¡ä¸¢å¤±ã€‹</a></li>
<li><a href="http://www.infoq.com/cn/articles/solution-of-distributed-system-transaction-consistency" rel="external nofollow noopener noreferrer" target="_blank">ã€Šåˆ†å¸ƒå¼ç³»ç»Ÿäº‹åŠ¡ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆã€‹</a></li>
<li><a href="http://blog.csdn.net/fly2749/article/details/44998203" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMySQLæ•°æ®åº“åˆ†å¸ƒå¼äº‹åŠ¡XAä¼˜ç¼ºç‚¹ä¸æ”¹è¿›æ–¹æ¡ˆã€‹</a></li>
<li><a href="http://www.hollischuang.com/archives/1580" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥ç†è§£åˆ†å¸ƒå¼ç³»ç»Ÿçš„2PCå’Œ3PCã€‹</a></li>
<li><a href="https://github.com/YunaiV/yunaiv.github.io/blob/master/source/_drafts/MyCAT/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1.xmind" rel="external nofollow noopener noreferrer" target="_blank">ã€åˆ†å¸ƒå¼äº‹åŠ¡.xmindã€‘</a> ç¬”è€…æ‹™ä½œ</li>
<li><a href="http://www.yunai.me/RocketMQ/message-transaction/?self">ã€ŠRocketMQ æºç åˆ†æ â€”â€” äº‹åŠ¡æ¶ˆæ¯ã€‹</a> ç¬”è€…æ‹™ä½œ</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol
    
    </summary>
    
      <category term="MyCAT" scheme="http://www.yunai.me/categories/MyCAT/"/>
    
    
  </entry>
  
</feed>
