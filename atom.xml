<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</title>
  
  <subtitle>æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.iocoder.cn/"/>
  <updated>2017-09-14T12:24:21.000Z</updated>
  <id>http://www.iocoder.cn/</id>
  
  <author>
    <name>ç‹æ–‡æ–Œ</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>TCC-Transaction æºç åˆ†æ â€”â€” è¿ç»´å¹³å°</title>
    <link href="http://www.iocoder.cn/TCC-Transaction/console/"/>
    <id>http://www.iocoder.cn/TCC-Transaction/console/</id>
    <published>2018-02-27T16:00:00.000Z</published>
    <updated>2017-09-14T12:24:21.000Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="TCC-Transaction" scheme="http://www.iocoder.cn/categories/TCC-Transaction/"/>
    
    
  </entry>
  
  <entry>
    <title>TCC-Transaction æºç åˆ†æ â€”â€” Dubbo æ”¯æŒ</title>
    <link href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/"/>
    <id>http://www.iocoder.cn/TCC-Transaction/dubbo-support/</id>
    <published>2018-02-27T16:00:00.000Z</published>
    <updated>2017-09-14T12:24:54.000Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="TCC-Transaction" scheme="http://www.iocoder.cn/categories/TCC-Transaction/"/>
    
    
  </entry>
  
  <entry>
    <title>TCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡æ¢å¤</title>
    <link href="http://www.iocoder.cn/TCC-Transaction/transaction-recovery/"/>
    <id>http://www.iocoder.cn/TCC-Transaction/transaction-recovery/</id>
    <published>2018-02-21T16:00:00.000Z</published>
    <updated>2017-09-15T07:56:32.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. äº‹åŠ¡é‡è¯•é…ç½®</a></li><li><a href="#">3. äº‹åŠ¡é‡è¯•å®šæ—¶ä»»åŠ¡</a></li><li><a href="#">4. å¼‚å¸¸äº‹åŠ¡æ¢å¤</a><ul><li><a href="#">4.1 åŠ è½½å¼‚å¸¸äº‹åŠ¡é›†åˆ</a></li><li><a href="#">4.2 æ¢å¤å¼‚å¸¸äº‹åŠ¡é›†åˆ</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« <strong>TCC æ¢å¤</strong>ã€‚ä¸»è¦æ¶‰åŠå¦‚ä¸‹äºŒä¸ª package è·¯å¾„ä¸‹çš„ç±»ï¼š</p><ul><li><code>org.mengyun.tcctransaction.recover</code><ul><li>RecoverConfigï¼Œäº‹åŠ¡æ¢å¤é…ç½®<strong>æ¥å£</strong></li><li>TransactionRecoveryï¼Œäº‹åŠ¡æ¢å¤é€»è¾‘</li></ul></li><li><code>org.mengyun.tcctransaction.spring.recover</code> ï¼š<ul><li>DefaultRecoverConfigï¼Œé»˜è®¤äº‹åŠ¡æ¢å¤é…ç½®<strong>å®ç°</strong></li><li>RecoverScheduledJobï¼Œäº‹åŠ¡æ¢å¤å®šæ—¶ä»»åŠ¡</li></ul></li></ul><p>æœ¬æ–‡æ¶‰åŠåˆ°çš„ç±»å…³ç³»å¦‚ä¸‹å›¾( <a href="http://www.iocoder.cn/images/TCC-Transaction/2018_02_22/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_22/01.png" alt=""></p><p>åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-repository/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡å­˜å‚¨å™¨ã€‹</a>ä¸­ï¼Œäº‹åŠ¡ä¿¡æ¯è¢«æŒä¹…åŒ–åˆ°å¤–éƒ¨çš„å­˜å‚¨å™¨ä¸­ã€‚<strong>äº‹åŠ¡å­˜å‚¨æ˜¯äº‹åŠ¡æ¢å¤çš„åŸºç¡€</strong>ã€‚é€šè¿‡è¯»å–å¤–éƒ¨å­˜å‚¨å™¨ä¸­çš„å¼‚å¸¸äº‹åŠ¡ï¼Œå®šæ—¶ä»»åŠ¡ä¼šæŒ‰ç…§ä¸€å®šé¢‘ç‡å¯¹äº‹åŠ¡è¿›è¡Œé‡è¯•ï¼Œç›´åˆ°äº‹åŠ¡å®Œæˆæˆ–è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚</p><h1>2. äº‹åŠ¡é‡è¯•é…ç½®</h1><p><code>org.mengyun.tcctransaction.recover.RecoverConfig</code>ï¼Œäº‹åŠ¡æ¢å¤é…ç½®<strong>æ¥å£</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RecoverConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æœ€å¤§é‡è¯•æ¬¡æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getMaxRetryCount</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æ¢å¤é—´éš”æ—¶é—´ï¼Œå•ä½ï¼šç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getRecoverDuration</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> cron è¡¨è¾¾å¼</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">String <span class="title">getCronExpression</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> å»¶è¿Ÿå–æ¶ˆå¼‚å¸¸é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Set&lt;Class&lt;? extends Exception&gt;&gt; getDelayCancelExceptions();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®¾ç½®å»¶è¿Ÿå–æ¶ˆå¼‚å¸¸é›†åˆ</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> delayRecoverExceptions å»¶è¿Ÿå–æ¶ˆå¼‚å¸¸é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDelayCancelExceptions</span><span class="params">(Set&lt;Class&lt;? extends Exception&gt;&gt; delayRecoverExceptions)</span></span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>#getMaxRetryCount()</code>ï¼Œå•ä¸ªäº‹åŠ¡æ¢å¤æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œç›®å‰ä»…æ‰“å‡ºé”™è¯¯æ—¥å¿—ï¼Œä¸‹æ–‡ä¼šçœ‹åˆ°å®ç°ã€‚</li><li><code>#getRecoverDuration()</code>ï¼Œå•ä¸ªäº‹åŠ¡æ¢å¤é‡è¯•çš„é—´éš”æ—¶é—´ï¼Œå•ä½ï¼šç§’ã€‚</li><li><code>#getCronExpression()</code>ï¼Œå®šæ—¶ä»»åŠ¡ cron è¡¨è¾¾å¼ã€‚</li><li><code>#getDelayCancelExceptions()</code>ï¼Œå»¶è¿Ÿå–æ¶ˆå¼‚å¸¸é›†åˆã€‚</li></ul><hr><p><code>org.mengyun.tcctransaction.spring.recover.DefaultRecoverConfig</code>ï¼Œ<strong>é»˜è®¤</strong>äº‹åŠ¡æ¢å¤é…ç½®å®ç°ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultRecoverConfig</span> <span class="keyword">implements</span> <span class="title">RecoverConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> RecoverConfig INSTANCE = <span class="keyword">new</span> DefaultRecoverConfig();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æœ€å¤§é‡è¯•æ¬¡æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxRetryCount = <span class="number">30</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ¢å¤é—´éš”æ—¶é—´ï¼Œå•ä½ï¼šç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> recoverDuration = <span class="number">120</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * cron è¡¨è¾¾å¼</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String cronExpression = <span class="string">"0 */1 * * * ?"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å»¶è¿Ÿå–æ¶ˆå¼‚å¸¸é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Set&lt;Class&lt;? extends Exception&gt;&gt; delayCancelExceptions = <span class="keyword">new</span> HashSet&lt;Class&lt;? extends Exception&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultRecoverConfig</span><span class="params">()</span> </span>&#123;</div><div class="line">        delayCancelExceptions.add(OptimisticLockException.class);</div><div class="line">        delayCancelExceptions.add(SocketTimeoutException.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDelayCancelExceptions</span><span class="params">(Set&lt;Class&lt;? extends Exception&gt;&gt; delayCancelExceptions)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.delayCancelExceptions.addAll(delayCancelExceptions);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>maxRetryCount</code>ï¼Œå•ä¸ªäº‹åŠ¡æ¢å¤æœ€å¤§é‡è¯•æ¬¡æ•° ä¸º 30ã€‚</li><li><code>recoverDuration</code>ï¼Œå•ä¸ªäº‹åŠ¡æ¢å¤é‡è¯•çš„é—´éš”æ—¶é—´ä¸º 120 ç§’ã€‚</li><li><code>cronExpression</code>ï¼Œå®šæ—¶ä»»åŠ¡ cron è¡¨è¾¾å¼ä¸º <code>&quot;0 */1 * * * ?&quot;</code>ï¼Œæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ã€‚å¦‚æœä½ å¸Œæœ›å®šæ—¶ä»»åŠ¡æ‰§è¡Œçš„æ›´é¢‘ç¹ï¼Œå¯ä»¥ä¿®æ”¹ cron è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ <code>0/30 * * * * ?</code>ï¼Œæ¯ 30 ç§’æ‰§è¡Œä¸€æ¬¡ã€‚</li><li><code>delayCancelExceptions</code>ï¼Œå»¶è¿Ÿå–æ¶ˆå¼‚å¸¸é›†åˆã€‚åœ¨ DefaultRecoverConfig æ„é€ æ–¹æ³•é‡Œï¼Œé¢„å…ˆæ·»åŠ äº† OptimisticLockException / SocketTimeoutException ã€‚<ul><li>é’ˆå¯¹ <strong>SocketTimeoutException</strong> ï¼štry é˜¶æ®µï¼Œæœ¬åœ°å‚ä¸è€…è°ƒç”¨è¿œç¨‹å‚ä¸è€…( è¿œç¨‹æœåŠ¡ï¼Œä¾‹å¦‚ Dubboï¼ŒHttp æœåŠ¡)ï¼Œè¿œç¨‹å‚ä¸è€… try é˜¶æ®µçš„æ–¹æ³•é€»è¾‘æ‰§è¡Œæ—¶é—´è¾ƒé•¿ï¼Œè¶…è¿‡ Socket ç­‰å¾…æ—¶é•¿ï¼Œå‘ç”Ÿ SocketTimeoutExceptionï¼Œå¦‚æœç«‹åˆ»æ‰§è¡Œäº‹åŠ¡å›æ»šï¼Œè¿œç¨‹å‚ä¸è€… try çš„æ–¹æ³•æœªæ‰§è¡Œå®Œæˆï¼Œå¯èƒ½å¯¼è‡´ cancel çš„æ–¹æ³•å®é™…æœªæ‰§è¡Œ( try çš„æ–¹æ³•æœªæ‰§è¡Œå®Œæˆï¼Œæ•°æ®åº“äº‹åŠ¡ã€é TCC äº‹åŠ¡ã€‘æœªæäº¤ï¼Œcancel çš„æ–¹æ³•è¯»å–æ•°æ®æ—¶å‘ç°æœªå˜æ›´ï¼Œå¯¼è‡´æ–¹æ³•å®é™…æœªæ‰§è¡Œï¼Œæœ€ç»ˆ try çš„æ–¹æ³•æ‰§è¡Œå®Œåï¼Œæäº¤æ•°æ®åº“äº‹åŠ¡ã€é TCC äº‹åŠ¡ã€‘ï¼Œè¾ƒä¸ºæç«¯ )ï¼Œæœ€ç»ˆå¼•èµ·æ•°æ®ä¸ä¸€è‡´ã€‚åœ¨<strong>äº‹åŠ¡æ¢å¤</strong>æ—¶ï¼Œä¼šå¯¹è¿™ç§æƒ…å†µçš„äº‹åŠ¡è¿›è¡Œå–æ¶ˆå›æ»šï¼Œå¦‚æœæ­¤æ—¶è¿œç¨‹å‚ä¸è€…çš„ try çš„æ–¹æ³•è¿˜æœªç»“æŸï¼Œè¿˜æ˜¯å¯èƒ½å‘ç”Ÿæ•°æ®ä¸ä¸€è‡´ã€‚<ul><li>å®˜æ–¹è§£é‡Šï¼š<a href="https://github.com/changmingxie/tcc-transaction/issues/87" rel="external nofollow noopener noreferrer" target="_blank">ä¸ºä»€ä¹ˆ tcc äº‹åŠ¡åˆ‡é¢ä¸­å¯¹ä¹è§‚é”ä¸socketè¶…æ—¶å¼‚å¸¸ä¸åšå›æ»šå¤„ç†ï¼ŒåªæŠ›å¼‚å¸¸ï¼Ÿ</a></li></ul></li><li>é’ˆå¯¹ OptimisticLockException ï¼šè¿˜æ˜¯ SocketTimeoutException çš„æƒ…å†µï¼Œäº‹åŠ¡æ¢å¤é—´éš”æ—¶é—´å°äº Socket è¶…æ—¶æ—¶é—´ï¼Œæ­¤æ—¶äº‹åŠ¡æ¢å¤è°ƒç”¨è¿œç¨‹å‚ä¸è€…å–æ¶ˆå›æ»šäº‹åŠ¡ï¼Œè¿œç¨‹å‚ä¸è€…ä¸‹æ¬¡æ›´æ–°äº‹åŠ¡æ—¶ï¼Œä¼šå› ä¸ºä¹è§‚é”æ›´æ–°å¤±è´¥ï¼ŒæŠ›å‡º OptimisticLockExceptionã€‚å¦‚æœ CompensableTransactionInterceptor æ­¤æ—¶ç«‹åˆ»å–æ¶ˆå›æ»šï¼Œå¯èƒ½ä¼šå’Œå®šæ—¶ä»»åŠ¡çš„å–æ¶ˆå›æ»šå†²çªï¼Œå› æ­¤ç»Ÿä¸€äº¤ç»™å®šæ—¶ä»»åŠ¡å¤„ç†ã€‚<ul><li>å®˜æ–¹è§£é‡Šï¼š<a href="https://github.com/changmingxie/tcc-transaction/issues/53" rel="external nofollow noopener noreferrer" target="_blank">äº‹åŠ¡æ¢å¤çš„ç–‘é—®</a></li><li>è¿™å—ç¬”è€…è¿˜æœ‰ä¸€äº›ç–‘é—®ï¼Œå¦‚æœæœ‰åˆ«çš„å¯èƒ½æ€§å¯¼è‡´è¿™ä¸ªæƒ…å†µï¼Œéº»çƒ¦å‘ŠçŸ¥ä¸‹ç¬”è€…ã€‚è°¢è°¢ã€‚</li></ul></li></ul></li></ul><h1>3. äº‹åŠ¡é‡è¯•å®šæ—¶ä»»åŠ¡</h1><p><code>org.mengyun.tcctransaction.spring.recover.RecoverScheduledJob</code>ï¼Œäº‹åŠ¡æ¢å¤å®šæ—¶ä»»åŠ¡ï¼ŒåŸºäº Quartz å®ç°è°ƒåº¦ï¼Œä¸æ–­ä¸æ–­ä¸æ–­æ‰§è¡Œäº‹åŠ¡æ¢å¤ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RecoverScheduledJob</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> TransactionRecovery transactionRecovery;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> TransactionConfigurator transactionConfigurator;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Scheduler scheduler;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Quartz JobDetail</span></div><div class="line">            MethodInvokingJobDetailFactoryBean jobDetail = <span class="keyword">new</span> MethodInvokingJobDetailFactoryBean();</div><div class="line">            jobDetail.setTargetObject(transactionRecovery);</div><div class="line">            jobDetail.setTargetMethod(<span class="string">"startRecover"</span>);</div><div class="line">            jobDetail.setName(<span class="string">"transactionRecoveryJob"</span>);</div><div class="line">            jobDetail.setConcurrent(<span class="keyword">false</span>); <span class="comment">// ç¦æ­¢å¹¶å‘</span></div><div class="line">            jobDetail.afterPropertiesSet();</div><div class="line">            <span class="comment">// Quartz CronTriggerFactoryBean</span></div><div class="line">            CronTriggerFactoryBean cronTrigger = <span class="keyword">new</span> CronTriggerFactoryBean();</div><div class="line">            cronTrigger.setBeanName(<span class="string">"transactionRecoveryCronTrigger"</span>);</div><div class="line">            cronTrigger.setCronExpression(transactionConfigurator.getRecoverConfig().getCronExpression());</div><div class="line">            cronTrigger.setJobDetail(jobDetail.getObject());</div><div class="line">            cronTrigger.afterPropertiesSet();</div><div class="line">            <span class="comment">// å¯åŠ¨ä»»åŠ¡è°ƒåº¦</span></div><div class="line">            scheduler.scheduleJob(jobDetail.getObject(), cronTrigger.getObject());</div><div class="line">            <span class="comment">// å¯åŠ¨ Quartz Scheduler</span></div><div class="line">            scheduler.start();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>MethodInvokingJobDetailFactoryBean#setConcurrent(false)</code> æ–¹æ³•ï¼Œç¦ç”¨ä»»åŠ¡å¹¶å‘æ‰§è¡Œã€‚</li><li>è°ƒç”¨ <code>MethodInvokingJobDetailFactoryBean#setTargetObject(...)</code> + <code>MethodInvokingJobDetailFactoryBean#setTargetMethod(...)</code> æ–¹æ³•ï¼Œè®¾ç½®ä»»åŠ¡è°ƒç”¨ <code>TransactionRecovery#startRecover(...)</code> æ–¹æ³•æ‰§è¡Œã€‚</li></ul><p><strong>å¦‚æœåº”ç”¨é›†ç¾¤éƒ¨ç½²ï¼Œä¼šä¸ä¼šç›¸åŒäº‹åŠ¡è¢«å¤šä¸ªå®šæ—¶ä»»åŠ¡åŒæ—¶é‡è¯•</strong>ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ä¸ä¼šï¼Œäº‹åŠ¡åœ¨é‡è¯•æ—¶ä¼šä¹è§‚é”æ›´æ–°ï¼ŒåŒæ—¶åªæœ‰ä¸€ä¸ªåº”ç”¨èŠ‚ç‚¹èƒ½æ›´æ–°æˆåŠŸã€‚</p><p>å®˜æ–¹è§£é‡Šï¼š<a href="https://github.com/changmingxie/tcc-transaction/issues/98" rel="external nofollow noopener noreferrer" target="_blank">å¤šæœºéƒ¨ç½²ä¸‹ï¼Œæ‰€æœ‰æœºå™¨éƒ½å®•æœºï¼Œä»å¼‚å¸¸ä¸­æ¢å¤æ—¶ï¼Œæ‰€æœ‰çš„æœºå™¨å²‚ä¸æ˜¯éƒ½å¯ä»¥æŸ¥è¯¢åˆ°æ‰€æœ‰çš„éœ€è¦æ¢å¤çš„æœåŠ¡ï¼Ÿ</a></p><p>å½“ç„¶æç«¯æƒ…å†µä¸‹ï¼ŒSocket è°ƒç”¨è¶…æ—¶æ—¶é—´å¤§äºäº‹åŠ¡é‡è¯•é—´éš”ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹åœ¨é‡è¯•æŸä¸ªäº‹åŠ¡ï¼Œä¸€ç›´æœªæ‰§è¡Œå®Œæˆï¼Œç¬¬äºŒä¸ªèŠ‚ç‚¹å·²ç»å¯ä»¥é‡è¯•ã€‚</p><p>psï¼šå»ºè®®ï¼ŒSocket è°ƒç”¨è¶…æ—¶æ—¶é—´å°äºäº‹åŠ¡é‡è¯•é—´éš”ã€‚</p><p><strong>æ˜¯å¦å®šæ—¶ä»»åŠ¡å’Œåº”ç”¨æœåŠ¡å™¨è§£è€¦</strong>ï¼Ÿ</p><p>èš‚èšé‡‘æœçš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ DTS é‡‡ç”¨ client-server æ¨¡å¼ï¼š</p><ul><li>xts-client ï¼šè´Ÿè´£äº‹åŠ¡çš„åˆ›å»ºã€æäº¤ã€å›æ»šã€è®°å½•ã€‚</li><li>xts-server ï¼šè´Ÿè´£å¼‚å¸¸äº‹åŠ¡çš„æ¢å¤ã€‚</li></ul><blockquote><p>FROM <a href="https://www.cloud.alipay.com/docs/2/46887" rel="external nofollow noopener noreferrer" target="_blank">ã€Šèš‚èšé‡‘èäº‘ DTS æ–‡æ¡£ã€‹</a><br>åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ (Distributed Transaction Service, DTS) æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ï¼Œç”¨æ¥ä¿éšœåœ¨å¤§è§„æ¨¡åˆ†å¸ƒå¼ç¯å¢ƒä¸‹äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚DTS ä»æ¶æ„ä¸Šåˆ†ä¸º xts-client å’Œ xts-server ä¸¤éƒ¨åˆ†ï¼Œå‰è€…æ˜¯ä¸€ä¸ªåµŒå…¥å®¢æˆ·ç«¯åº”ç”¨çš„ JAR åŒ…ï¼Œä¸»è¦è´Ÿè´£äº‹åŠ¡æ•°æ®çš„å†™å…¥å’Œå¤„ç†ï¼›åè€…æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç³»ç»Ÿï¼Œä¸»è¦è´Ÿè´£å¼‚å¸¸äº‹åŠ¡çš„æ¢å¤ã€‚</p></blockquote><h1>4. å¼‚å¸¸äº‹åŠ¡æ¢å¤</h1><p><code>org.mengyun.tcctransaction.recover.TransactionRecovery</code>ï¼Œå¼‚å¸¸äº‹åŠ¡æ¢å¤ï¼Œå®ç°ä¸»ä½“ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionRecovery</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¯åŠ¨æ¢å¤äº‹åŠ¡é€»è¾‘</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startRecover</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// åŠ è½½å¼‚å¸¸äº‹åŠ¡é›†åˆ</span></div><div class="line">        List&lt;Transaction&gt; transactions = loadErrorTransactions();</div><div class="line">        <span class="comment">// æ¢å¤å¼‚å¸¸äº‹åŠ¡é›†åˆ</span></div><div class="line">        recoverErrorTransactions(transactions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>4.1 åŠ è½½å¼‚å¸¸äº‹åŠ¡é›†åˆ</h2><p>è°ƒç”¨ <code>#loadErrorTransactions()</code> æ–¹æ³•ï¼ŒåŠ è½½å¼‚å¸¸äº‹åŠ¡é›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;Transaction&gt; <span class="title">loadErrorTransactions</span><span class="params">()</span> </span>&#123;</div><div class="line">   TransactionRepository transactionRepository = transactionConfigurator.getTransactionRepository();</div><div class="line">   <span class="keyword">long</span> currentTimeInMillis = Calendar.getInstance().getTimeInMillis();</div><div class="line">   RecoverConfig recoverConfig = transactionConfigurator.getRecoverConfig();</div><div class="line">   <span class="keyword">return</span> transactionRepository.findAllUnmodifiedSince(<span class="keyword">new</span> Date(currentTimeInMillis - recoverConfig.getRecoverDuration() * <span class="number">1000</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>å¼‚å¸¸äº‹åŠ¡çš„å®šä¹‰</strong>ï¼šå½“å‰æ—¶é—´è¶…è¿‡ - äº‹åŠ¡å˜æ›´æ—¶é—´( æœ€åæ‰§è¡Œæ—¶é—´ ) &gt;= äº‹åŠ¡æ¢å¤é—´éš”( <code>RecoverConfig#getRecoverDuration()</code> )ã€‚è¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œå·²å®Œæˆçš„äº‹åŠ¡ä¼šä»äº‹åŠ¡å­˜å‚¨å™¨åˆ é™¤ã€‚</li></ul><h2>4.2 æ¢å¤å¼‚å¸¸äº‹åŠ¡é›†åˆ</h2><p>è°ƒç”¨ <code>#recoverErrorTransactions(...)</code> æ–¹æ³•ï¼Œæ¢å¤å¼‚å¸¸äº‹åŠ¡é›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recoverErrorTransactions</span><span class="params">(List&lt;Transaction&gt; transactions)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Transaction transaction : transactions) &#123;</div><div class="line">       <span class="comment">// è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°</span></div><div class="line">       <span class="keyword">if</span> (transaction.getRetriedCount() &gt; transactionConfigurator.getRecoverConfig().getMaxRetryCount()) &#123;</div><div class="line">           logger.error(String.format(<span class="string">"recover failed with max retry count,will not try again. txid:%s, status:%s,retried count:%d,transaction content:%s"</span>, transaction.getXid(), transaction.getStatus().getId(), transaction.getRetriedCount(), JSON.toJSONString(transaction)));</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// åˆ†æ”¯äº‹åŠ¡è¶…è¿‡æœ€å¤§å¯é‡è¯•æ—¶é—´</span></div><div class="line">       <span class="keyword">if</span> (transaction.getTransactionType().equals(TransactionType.BRANCH)</div><div class="line">               &amp;&amp; (transaction.getCreateTime().getTime() +</div><div class="line">               transactionConfigurator.getRecoverConfig().getMaxRetryCount() *</div><div class="line">                       transactionConfigurator.getRecoverConfig().getRecoverDuration() * <span class="number">1000</span></div><div class="line">               &gt; System.currentTimeMillis())) &#123;</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// Confirm / Cancel</span></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// å¢åŠ é‡è¯•æ¬¡æ•°</span></div><div class="line">           transaction.addRetriedCount();</div><div class="line">           <span class="comment">// Confirm</span></div><div class="line">           <span class="keyword">if</span> (transaction.getStatus().equals(TransactionStatus.CONFIRMING)) &#123;</div><div class="line">               transaction.changeStatus(TransactionStatus.CONFIRMING);</div><div class="line">               transactionConfigurator.getTransactionRepository().update(transaction);</div><div class="line">               transaction.commit();</div><div class="line">               transactionConfigurator.getTransactionRepository().delete(transaction);</div><div class="line">           <span class="comment">// Cancel</span></div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (transaction.getStatus().equals(TransactionStatus.CANCELLING)</div><div class="line">                   || transaction.getTransactionType().equals(TransactionType.ROOT)) &#123; <span class="comment">// å¤„ç†å»¶è¿Ÿå–æ¶ˆçš„æƒ…å†µ</span></div><div class="line">               transaction.changeStatus(TransactionStatus.CANCELLING);</div><div class="line">               transactionConfigurator.getTransactionRepository().update(transaction);</div><div class="line">               transaction.rollback();</div><div class="line">               transactionConfigurator.getTransactionRepository().delete(transaction);</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</div><div class="line">           <span class="keyword">if</span> (throwable <span class="keyword">instanceof</span> OptimisticLockException</div><div class="line">                   || ExceptionUtils.getRootCause(throwable) <span class="keyword">instanceof</span> OptimisticLockException) &#123;</div><div class="line">               logger.warn(String.format(<span class="string">"optimisticLockException happened while recover. txid:%s, status:%s,retried count:%d,transaction content:%s"</span>, transaction.getXid(), transaction.getStatus().getId(), transaction.getRetriedCount(), JSON.toJSONString(transaction)), throwable);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               logger.error(String.format(<span class="string">"recover failed, txid:%s, status:%s,retried count:%d,transaction content:%s"</span>, transaction.getXid(), transaction.getStatus().getId(), transaction.getRetriedCount(), JSON.toJSONString(transaction)), throwable);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å½“å•ä¸ªäº‹åŠ¡è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°æ—¶ï¼Œä¸å†é‡è¯•ï¼Œåªæ‰“å°å¼‚å¸¸ï¼Œæ­¤æ—¶éœ€è¦<strong>äººå·¥ä»‹å…¥</strong>è§£å†³ã€‚å¯ä»¥æ¥å…¥ ELK æ”¶é›†æ—¥å¿—ç›‘æ§æŠ¥è­¦ã€‚</li><li>å½“<strong>åˆ†æ”¯äº‹åŠ¡</strong>è¶…è¿‡æœ€å¤§å¯é‡è¯•æ—¶é—´æ—¶ï¼Œä¸å†é‡è¯•ã€‚å¯èƒ½æœ‰åŒå­¦å’Œæˆ‘ä¸€å¼€å§‹ç†è§£çš„æ˜¯ç›¸åŒçš„ï¼Œå®é™…<strong>åˆ†æ”¯äº‹åŠ¡</strong>å¯¹åº”çš„åº”ç”¨æœåŠ¡å™¨ä¹Ÿå¯ä»¥é‡è¯•<strong>åˆ†æ”¯äº‹åŠ¡</strong>ï¼Œä¸æ˜¯å¿…é¡»<strong>æ ¹äº‹åŠ¡</strong>å‘èµ·é‡è¯•ï¼Œä»è€Œä¸€èµ·é‡è¯•<strong>åˆ†æ”¯äº‹åŠ¡</strong>ã€‚è¿™ç‚¹è¦æ³¨æ„ä¸‹ã€‚</li><li>å½“äº‹åŠ¡å¤„äº TransactionStatus.CONFIRMING çŠ¶æ€æ—¶ï¼Œæäº¤äº‹åŠ¡ï¼Œé€»è¾‘å’Œ <code>TransactionManager#commit()</code> ç±»ä¼¼ã€‚</li><li>å½“äº‹åŠ¡å¤„äº TransactionStatus.CONFIRMING çŠ¶æ€ï¼Œæˆ–è€…<strong>äº‹åŠ¡ç±»å‹ä¸ºæ ¹äº‹åŠ¡</strong>ï¼Œå›æ»šäº‹åŠ¡ï¼Œé€»è¾‘å’Œ <code>TransactionManager#rollback()</code> ç±»ä¼¼ã€‚è¿™é‡ŒåŠ åˆ¤æ–­çš„<strong>äº‹åŠ¡ç±»å‹ä¸ºæ ¹äº‹åŠ¡</strong>ï¼Œç”¨äºå¤„ç†å»¶è¿Ÿå›æ»šå¼‚å¸¸çš„äº‹åŠ¡çš„å›æ»šã€‚</li></ul><h1>666. å½©è›‹</h1><p>åœ¨å†™æœ¬æ–‡çš„è¿‡ç¨‹ä¸­ï¼Œæ— æ„ä¸­ç¿»åˆ°èš‚èšäº‘çš„æ–‡æ¡£ï¼Œåˆ†äº«ç»™çœ‹åˆ°æ­¤å¤„çš„çœŸçˆ±ä»¬ã€‚</p><p>çœŸçˆ±ä»¬ï¼Œè¯·çŒ›å‡»<a href="https://git.cloud.alipay.com/dx/AntCloudPayPublic" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠAntCloudPayPublicã€‹</a>è·³è½¬ã€‚</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_22/02.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. äº‹åŠ¡é‡è¯•é…ç½®&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;3. äº‹åŠ¡é‡è¯•å®šæ—¶ä»»åŠ¡&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;4. å¼‚å¸¸äº‹åŠ¡æ¢å¤&lt;/a&gt;
&lt;u
      
    
    </summary>
    
      <category term="TCC-Transaction" scheme="http://www.iocoder.cn/categories/TCC-Transaction/"/>
    
    
  </entry>
  
  <entry>
    <title>TCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡å­˜å‚¨å™¨</title>
    <link href="http://www.iocoder.cn/TCC-Transaction/transaction-repository/"/>
    <id>http://www.iocoder.cn/TCC-Transaction/transaction-repository/</id>
    <published>2018-02-14T16:00:00.000Z</published>
    <updated>2017-09-15T04:02:25.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. åºåˆ—åŒ–</a><ul><li><a href="#">2.1 JDK åºåˆ—åŒ–å®ç°</a></li><li><a href="#">2.2 Kyro åºåˆ—åŒ–å®ç°</a></li><li><a href="#">2.3 JSON åºåˆ—åŒ–å®ç°</a></li></ul></li><li><a href="#">3. å­˜å‚¨å™¨</a><ul><li><a href="#">3.1 å¯ç¼“å­˜çš„äº‹åŠ¡å­˜å‚¨å™¨æŠ½è±¡ç±»</a></li><li><a href="#">3.2 JDBC äº‹åŠ¡å­˜å‚¨å™¨</a></li><li><a href="#">3.3 Redis äº‹åŠ¡å­˜å‚¨å™¨</a></li><li><a href="#">3.4 Zookeeper äº‹åŠ¡å­˜å‚¨å™¨</a></li><li><a href="#">3.5 File äº‹åŠ¡å­˜å‚¨å™¨</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« <strong>äº‹åŠ¡å­˜å‚¨å™¨</strong>ã€‚ä¸»è¦æ¶‰åŠå¦‚ä¸‹ Maven é¡¹ç›®ï¼š</p><ul><li><code>tcc-transaction-core</code> ï¼štcc-transaction åº•å±‚å®ç°ã€‚</li></ul><p>åœ¨ TCC çš„è¿‡ç¨‹ä¸­ï¼Œæ ¹æ®åº”ç”¨å†…å­˜ä¸­çš„äº‹åŠ¡ä¿¡æ¯å®Œæˆæ•´ä¸ªäº‹åŠ¡æµç¨‹ã€‚But å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå°†äº‹åŠ¡ä¿¡æ¯åªæ”¾åœ¨åº”ç”¨å†…å­˜ä¸­æ˜¯è¿œè¿œä¸å¤Ÿå¯é çš„ã€‚ä¾‹å¦‚ï¼š</p><ol><li>åº”ç”¨è¿›ç¨‹å¼‚å¸¸å´©æºƒï¼Œæœªå®Œæˆçš„äº‹åŠ¡ä¿¡æ¯å°†ä¸¢å¤±ã€‚</li><li>åº”ç”¨è¿›ç¨‹é›†ç¾¤ï¼Œå½“æä¾›è¿œç¨‹æœåŠ¡è°ƒç”¨æ—¶ï¼Œäº‹åŠ¡ä¿¡æ¯éœ€è¦é›†ç¾¤å†…å…±äº«ã€‚</li><li>å‘èµ·äº‹åŠ¡çš„åº”ç”¨éœ€è¦é‡å¯éƒ¨ç½²æ–°ç‰ˆæœ¬ï¼Œå› ä¸ºå„ç§åŸå› ï¼Œæœ‰æœªå®Œæˆçš„äº‹åŠ¡ã€‚</li></ol><p>å› æ­¤ï¼ŒTCC-Transaction å°†äº‹åŠ¡ä¿¡æ¯æ·»åŠ åˆ°å†…å­˜ä¸­çš„åŒæ—¶ï¼Œä¼šä½¿ç”¨å¤–éƒ¨å­˜å‚¨è¿›è¡ŒæŒä¹…åŒ–ã€‚ç›®å‰æä¾›å››ç§å¤–éƒ¨å­˜å‚¨ï¼š</p><ul><li>JdbcTransactionRepositoryï¼ŒJDBC äº‹åŠ¡å­˜å‚¨å™¨</li><li>RedisTransactionRepositoryï¼ŒRedis äº‹åŠ¡å­˜å‚¨å™¨</li><li>ZooKeeperTransactionRepositoryï¼ŒZookeeper äº‹åŠ¡å­˜å‚¨å™¨</li><li>FileSystemTransactionRepositoryï¼ŒFile äº‹åŠ¡å­˜å‚¨å™¨</li></ul><p>æœ¬æ–‡æ¶‰åŠåˆ°çš„ç±»å…³ç³»å¦‚ä¸‹å›¾( <a href="http://www.iocoder.cn/images/TCC-Transaction/2018_02_15/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_15/01.png" alt=""></p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º TCC-Transaction ç‚¹èµï¼<a href="https://github.com/changmingxie/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>psï¼šç¬”è€…å‡è®¾ä½ å·²ç»é˜…è¯»è¿‡<a href="https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x" rel="external nofollow noopener noreferrer" target="_blank">ã€Štcc-transaction å®˜æ–¹æ–‡æ¡£ â€”â€” ä½¿ç”¨æŒ‡å—1.2.xã€‹</a>ã€‚</p><h1>2. åºåˆ—åŒ–</h1><p>åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/tcc-core/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” TCC å®ç°ã€‹ã€Œ4. äº‹åŠ¡ä¸å‚ä¸è€…ã€</a>ï¼Œå¯ä»¥çœ‹åˆ° Transaction æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„å¯¹è±¡ï¼Œå†…åµŒ Participant æ•°ç»„ï¼Œè€Œ Participant æœ¬èº«ä¹Ÿæ˜¯å¤æ‚çš„å¯¹è±¡ï¼Œå†…åµŒäº†æ›´å¤šçš„å…¶ä»–å¯¹è±¡ï¼Œå› æ­¤ï¼Œå­˜å‚¨å™¨åœ¨æŒä¹…åŒ– Transaction æ—¶ï¼Œéœ€è¦åºåˆ—åŒ–åæ‰èƒ½å­˜å‚¨ã€‚</p><p><code>org.mengyun.tcctransaction.serializer.ObjectSerializer</code>ï¼Œå¯¹è±¡åºåˆ—åŒ–<strong>æ¥å£</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ObjectSerializer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">byte</span>[] serialize(T t);</div><div class="line">    </div><div class="line">    <span class="function">T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>ç›®å‰æä¾› <strong>JDKè‡ªå¸¦åºåˆ—åŒ–</strong> å’Œ <strong>Kyroåºåˆ—åŒ–</strong> ä¸¤ç§å®ç°ã€‚</p><h2>2.1 JDK åºåˆ—åŒ–å®ç°</h2><p><code>org.mengyun.tcctransaction.serializer.JdkSerializationSerializer</code>ï¼ŒJDK åºåˆ—åŒ–å®ç°ã€‚æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»<a href="https://github.com/changmingxie/tcc-transaction/blob/70130d12004456fd4b97510c210c24502a1b3acb/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/serializer/JdkSerializationSerializer.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</p><p><strong>TCC-Transaction ä½¿ç”¨çš„é»˜è®¤çš„åºåˆ—åŒ–</strong>ã€‚</p><h2>2.2 Kyro åºåˆ—åŒ–å®ç°</h2><p><code>org.mengyun.tcctransaction.serializer.KryoTransactionSerializer</code>ï¼ŒKyro åºåˆ—åŒ–å®ç°ã€‚æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»<a href="https://github.com/changmingxie/tcc-transaction/blob/70130d12004456fd4b97510c210c24502a1b3acb/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/serializer/KryoTransactionSerializer.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</p><h2>2.3 JSON åºåˆ—åŒ–å®ç°</h2><p>JDK å’Œ Kyro çš„åºåˆ—åŒ–å®ç°ï¼Œè‚‰çœ¼æ— æ³•ç›´è§‚å…·ä½“å­˜å‚¨äº‹åŠ¡çš„ä¿¡æ¯ï¼Œä½ å¯ä»¥é€šè¿‡å®ç° ObjectSerializer æ¥å£ï¼Œå®ç°è‡ªå®šä¹‰çš„ JSON åºåˆ—åŒ–ã€‚</p><h1>3. å­˜å‚¨å™¨</h1><p><code>org.mengyun.tcctransaction.TransactionRepository</code>ï¼Œäº‹åŠ¡å­˜å‚¨å™¨<strong>æ¥å£</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ–°å¢äº‹åŠ¡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æ–°å¢æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">create</span><span class="params">(Transaction transaction)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ›´æ–°äº‹åŠ¡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æ›´æ–°æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">update</span><span class="params">(Transaction transaction)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ é™¤äº‹åŠ¡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> åˆ é™¤æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">delete</span><span class="params">(Transaction transaction)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·å–äº‹åŠ¡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> xid äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> äº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">Transaction <span class="title">findByXid</span><span class="params">(TransactionXid xid)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·å–è¶…è¿‡æŒ‡å®šæ—¶é—´çš„äº‹åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> date æŒ‡å®šæ—¶é—´</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> äº‹åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">List&lt;Transaction&gt; <span class="title">findAllUnmodifiedSince</span><span class="params">(Date date)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>ä¸åŒçš„å­˜å‚¨å™¨é€šè¿‡å®ç°è¯¥æ¥å£ï¼Œæä¾›äº‹åŠ¡çš„å¢åˆ æ”¹æŸ¥åŠŸèƒ½ã€‚</p><h2>3.1 å¯ç¼“å­˜çš„äº‹åŠ¡å­˜å‚¨å™¨æŠ½è±¡ç±»</h2><p><code>org.mengyun.tcctransaction.repository.CachableTransactionRepository</code>ï¼Œ<strong>å¯ç¼“å­˜</strong>çš„äº‹åŠ¡å­˜å‚¨å™¨<strong>æŠ½è±¡ç±»</strong>ï¼Œå®ç°å¢åˆ æ”¹æŸ¥äº‹åŠ¡æ—¶ï¼ŒåŒæ—¶ç¼“å­˜äº‹åŠ¡ä¿¡æ¯ã€‚åœ¨ä¸Šé¢ç±»å›¾ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ° TCC-Transaction è‡ªå¸¦çš„å¤šç§å­˜å‚¨å™¨éƒ½ç»§æ‰¿è¯¥æŠ½è±¡ç±»ã€‚</p><p><strong>CachableTransactionRepository æ„é€ æ–¹æ³•</strong>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CachableTransactionRepository</span> <span class="keyword">implements</span> <span class="title">TransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¼“å­˜è¿‡æœŸæ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> expireDuration = <span class="number">120</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¼“å­˜</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Cache&lt;Xid, Transaction&gt; transactionXidCompensableTransactionCache;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CachableTransactionRepository</span><span class="params">()</span> </span>&#123;</div><div class="line">        transactionXidCompensableTransactionCache = CacheBuilder.newBuilder().expireAfterAccess(expireDuration, TimeUnit.SECONDS).maximumSize(<span class="number">1000</span>).build();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä½¿ç”¨ <a href="https://github.com/google/guava/wiki/CachesExplained" rel="external nofollow noopener noreferrer" target="_blank">Guava Cache</a> å†…å­˜ç¼“å­˜äº‹åŠ¡ä¿¡æ¯ï¼Œè®¾ç½®æœ€å¤§ç¼“å­˜ä¸ªæ•°ä¸º 1000 ä¸ªï¼Œç¼“å­˜è¿‡æœŸæ—¶é—´ä¸ºæœ€åè®¿é—®æ—¶é—´ 120 ç§’ã€‚</li></ul><hr><p><strong><code>#create(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">create</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> result = doCreate(transaction);</div><div class="line">   <span class="keyword">if</span> (result &gt; <span class="number">0</span>) &#123;</div><div class="line">       putToCache(transaction);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ·»åŠ åˆ°ç¼“å­˜</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">putToCache</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   transactionXidCompensableTransactionCache.put(transaction.getXid(), transaction);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ–°å¢äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ–°å¢æ•°é‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">doCreate</span><span class="params">(Transaction transaction)</span></span>;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#doCreate(...)</code> æ–¹æ³•ï¼Œæ–°å¢äº‹åŠ¡ã€‚æ–°å¢æˆåŠŸåï¼Œè°ƒç”¨ <code>#putToCache(...)</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡åˆ°ç¼“å­˜ã€‚</li><li><code>#doCreate(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›æ–°å¢äº‹åŠ¡åŠŸèƒ½ã€‚</li></ul><hr><p><strong><code>#update(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> result = <span class="number">0</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       result = doUpdate(transaction);</div><div class="line">       <span class="keyword">if</span> (result &gt; <span class="number">0</span>) &#123;</div><div class="line">           putToCache(transaction);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> OptimisticLockException();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="keyword">if</span> (result &lt;= <span class="number">0</span>) &#123; <span class="comment">// æ›´æ–°å¤±è´¥ï¼Œç§»é™¤ç¼“å­˜ã€‚ä¸‹æ¬¡è®¿é—®ï¼Œä»å­˜å‚¨å™¨è¯»å–</span></div><div class="line">           removeFromCache(transaction);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç§»é™¤äº‹åŠ¡ä»ç¼“å­˜</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">removeFromCache</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   transactionXidCompensableTransactionCache.invalidate(transaction.getXid());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ›´æ–°äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ›´æ–°æ•°é‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">doUpdate</span><span class="params">(Transaction transaction)</span></span>;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#doUpdate(...)</code> æ–¹æ³•ï¼Œæ›´æ–°äº‹åŠ¡ã€‚<ul><li>è‹¥æ›´æ–°æˆåŠŸåï¼Œè°ƒç”¨ <code>#putToCache(...)</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡åˆ°ç¼“å­˜ã€‚</li><li>è‹¥æ›´æ–°å¤±è´¥åï¼ŒæŠ›å‡º OptimisticLockException å¼‚å¸¸ã€‚æœ‰ä¸¤ç§æƒ…å†µä¼šå¯¼è‡´æ›´æ–°å¤±è´¥ï¼š(1) è¯¥äº‹åŠ¡å·²ç»è¢«æäº¤ï¼Œè¢«åˆ é™¤ï¼›(2) ä¹è§‚é”æ›´æ–°æ—¶ï¼Œç¼“å­˜çš„äº‹åŠ¡çš„ç‰ˆæœ¬å·( <code>Transaction.version</code> )å’Œå­˜å‚¨å™¨é‡Œçš„äº‹åŠ¡çš„ç‰ˆæœ¬å·ä¸åŒï¼Œæ›´æ–°å¤±è´¥ã€‚<strong>ä¸ºä»€ä¹ˆ</strong>ï¼Ÿåœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-recovery/">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡æ¢å¤ã€‹</a>è¯¦ç»†è§£æã€‚æ›´æ–°å¤±è´¥ï¼Œæ„å‘³ç€ç¼“å­˜å·²ç»ä¸ä¸ä¸€è‡´ï¼Œè°ƒç”¨ <code>#removeFromCache(...)</code> æ–¹æ³•ï¼Œç§»é™¤äº‹åŠ¡ä»ç¼“å­˜ä¸­ã€‚</li></ul></li><li><code>#doUpdate(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›æ›´æ–°äº‹åŠ¡åŠŸèƒ½ã€‚</li></ul><hr><p><strong><code>#delete(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> result;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       result = doDelete(transaction);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       removeFromCache(transaction);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ é™¤äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> åˆ é™¤æ•°é‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">doDelete</span><span class="params">(Transaction transaction)</span></span>;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#doDelete(...)</code> æ–¹æ³•ï¼Œåˆ é™¤äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>#removeFromCache(...)</code> æ–¹æ³•ï¼Œç§»é™¤äº‹åŠ¡ä»ç¼“å­˜ä¸­ã€‚</li><li><code>#doDelete(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›åˆ é™¤äº‹åŠ¡åŠŸèƒ½ã€‚</li></ul><hr><p><strong><code>#findByXid(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Transaction <span class="title">findByXid</span><span class="params">(TransactionXid transactionXid)</span> </span>&#123;</div><div class="line">   Transaction transaction = findFromCache(transactionXid);</div><div class="line">   <span class="keyword">if</span> (transaction == <span class="keyword">null</span>) &#123;</div><div class="line">       transaction = doFindOne(transactionXid);</div><div class="line">       <span class="keyword">if</span> (transaction != <span class="keyword">null</span>) &#123;</div><div class="line">           putToCache(transaction);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> transaction;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å¾—äº‹åŠ¡ä»ç¼“å­˜ä¸­</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionXid äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Transaction <span class="title">findFromCache</span><span class="params">(TransactionXid transactionXid)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> transactionXidCompensableTransactionCache.getIfPresent(transactionXid);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æŸ¥è¯¢äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> xid äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Transaction <span class="title">doFindOne</span><span class="params">(Xid xid)</span></span>;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#findFromCache()</code> æ–¹æ³•ï¼Œä¼˜å…ˆä»ç¼“å­˜ä¸­è·å–äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>#doFindOne()</code> æ–¹æ³•ï¼Œç¼“å­˜ä¸­äº‹åŠ¡ä¸å­˜åœ¨ï¼Œä»å­˜å‚¨å™¨ä¸­è·å–ã€‚è·å–åˆ°åï¼Œè°ƒç”¨ <code>#putToCache()</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡åˆ°ç¼“å­˜ä¸­ã€‚</li><li><code>#doFindOne(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›æŸ¥è¯¢äº‹åŠ¡åŠŸèƒ½ã€‚</li></ul><hr><p><strong><code>#findAllUnmodifiedSince(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Transaction&gt; <span class="title">findAllUnmodifiedSince</span><span class="params">(Date date)</span> </span>&#123;</div><div class="line">   List&lt;Transaction&gt; transactions = doFindAllUnmodifiedSince(date);</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°ç¼“å­˜</span></div><div class="line">   <span class="keyword">for</span> (Transaction transaction : transactions) &#123;</div><div class="line">       putToCache(transaction);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> transactions;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å–è¶…è¿‡æŒ‡å®šæ—¶é—´çš„äº‹åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> date æŒ‡å®šæ—¶é—´</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> äº‹åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> List&lt;Transaction&gt; <span class="title">doFindAllUnmodifiedSince</span><span class="params">(Date date)</span></span>;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#findAllUnmodifiedSince(...)</code> æ–¹æ³•ï¼Œä»å­˜å‚¨å™¨è·å–è¶…è¿‡æŒ‡å®šæ—¶é—´çš„äº‹åŠ¡é›†åˆã€‚è°ƒç”¨ <code>#putToCache(...)</code> æ–¹æ³•ï¼Œå¾ªç¯äº‹åŠ¡é›†åˆæ·»åŠ åˆ°ç¼“å­˜ã€‚</li><li><code>#doFindAllUnmodifiedSince(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›è·å–è¶…è¿‡æŒ‡å®šæ—¶é—´çš„äº‹åŠ¡é›†åˆåŠŸèƒ½ã€‚</li></ul><h2>3.2 JDBC äº‹åŠ¡å­˜å‚¨å™¨</h2><p><code>org.mengyun.tcctransaction.repository.JdbcTransactionRepository</code>ï¼ŒJDBC äº‹åŠ¡å­˜å‚¨å™¨ï¼Œé€šè¿‡ JDBC é©±åŠ¨ï¼Œå°† Transaction å­˜å‚¨åˆ° MySQL / Oracle / PostgreSQL / SQLServer ç­‰å…³ç³»æ•°æ®åº“ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcTransactionRepository</span> <span class="keyword">extends</span> <span class="title">CachableTransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é¢†åŸŸ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String domain;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¡¨åç¼€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String tbSuffix;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ•°æ®æº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> DataSource dataSource;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åºåˆ—åŒ–</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ObjectSerializer serializer = <span class="keyword">new</span> JdkSerializationSerializer();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>domain</code>ï¼Œé¢†åŸŸï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ç§°ä¸ºæ¨¡å—åï¼Œåº”ç”¨åï¼Œ<strong>ç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªèµ„æº</strong>ã€‚ä¾‹å¦‚ï¼ŒMaven æ¨¡å— <code>xxx-order</code>ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®è¯¥å±æ€§ä¸º <code>ORDER</code>ã€‚</li><li><code>tbSuffix</code>ï¼Œè¡¨åç¼€ã€‚é»˜è®¤å­˜å‚¨è¡¨åä¸º <code>TCC_TRANSACTION</code>ï¼Œé…ç½®è¡¨ååï¼Œä¸º <code>TCC_TRANSACTION${tbSuffix}</code>ã€‚</li><li><code>dataSource</code>ï¼Œå­˜å‚¨æ•°æ®çš„æ•°æ®æºã€‚</li><li><code>serializer</code>ï¼Œåºåˆ—åŒ–ã€‚**å½“æ•°æ®åº“é‡Œå·²ç»æœ‰æ•°æ®çš„æƒ…å†µä¸‹ï¼Œä¸è¦æ›´æ¢åˆ«çš„åºåˆ—åŒ–ï¼Œå¦åˆ™ä¼šå¯¼è‡´ååºåˆ—åŒ–æŠ¥é”™ã€‚**å»ºè®®ï¼šTCC-Transaction å­˜å‚¨æ—¶ï¼Œæ–°å¢å­—æ®µï¼Œè®°å½•åºåˆ—åŒ–çš„æ–¹å¼ã€‚</li></ul><p>è¡¨ç»“æ„å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">CREATE TABLE `TCC_TRANSACTION` (</div><div class="line">  `TRANSACTION_ID` <span class="keyword">int</span>(<span class="number">11</span>) NOT NULL AUTO_INCREMENT,</div><div class="line">  `DOMAIN` varchar(<span class="number">100</span>) DEFAULT NULL,</div><div class="line">  `GLOBAL_TX_ID` varbinary(<span class="number">32</span>) NOT NULL,</div><div class="line">  `BRANCH_QUALIFIER` varbinary(<span class="number">32</span>) NOT NULL,</div><div class="line">  `CONTENT` varbinary(<span class="number">8000</span>) DEFAULT NULL,</div><div class="line">  `STATUS` <span class="keyword">int</span>(<span class="number">11</span>) DEFAULT NULL,</div><div class="line">  `TRANSACTION_TYPE` <span class="keyword">int</span>(<span class="number">11</span>) DEFAULT NULL,</div><div class="line">  `RETRIED_COUNT` <span class="keyword">int</span>(<span class="number">11</span>) DEFAULT NULL,</div><div class="line">  `CREATE_TIME` datetime DEFAULT NULL,</div><div class="line">  `LAST_UPDATE_TIME` datetime DEFAULT NULL,</div><div class="line">  `VERSION` <span class="keyword">int</span>(<span class="number">11</span>) DEFAULT NULL,</div><div class="line">  <span class="function">PRIMARY <span class="title">KEY</span> <span class="params">(`TRANSACTION_ID`)</span>,</span></div><div class="line"><span class="function">  UNIQUE KEY `UX_TX_BQ` <span class="params">(`GLOBAL_TX_ID`,`BRANCH_QUALIFIER`)</span></span></div><div class="line"><span class="function">) ENGINE</span>=InnoDB DEFAULT CHARSET=utf8</div></pre></td></tr></table></figure></p><ul><li><code>TRANSACTION_ID</code>ï¼Œä»…ä»…æ•°æ®åº“è‡ªå¢ï¼Œæ— å®é™…ç”¨é€”ã€‚</li><li><code>CONTENT</code>ï¼ŒTransaction åºåˆ—åŒ–ã€‚</li></ul><p>psï¼šç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/c164ff5ab29d31e08bc7061de5bc7403f3e40f1d/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/repository/JdbcTransactionRepository.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ JdbcTransactionRepository ä»£ç å®ç°ï¼Œå·²ç»æ·»åŠ å®Œæ•´ä¸­æ–‡æ³¨é‡Šã€‚</p><h2>3.3 Redis äº‹åŠ¡å­˜å‚¨å™¨</h2><p><code>org.mengyun.tcctransaction.repository.RedisTransactionRepository</code>ï¼ŒRedis äº‹åŠ¡å­˜å‚¨å™¨ï¼Œå°† Transaction å­˜å‚¨åˆ° Redisã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisTransactionRepository</span> <span class="keyword">extends</span> <span class="title">CachableTransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Jedis Pool</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> JedisPool jedisPool;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * key å‰ç¼€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String keyPrefix = <span class="string">"TCC:"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åºåˆ—åŒ–</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ObjectSerializer serializer = <span class="keyword">new</span> JdkSerializationSerializer();</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>keyPrefix</code>ï¼Œkey å‰ç¼€ã€‚ç±»ä¼¼ JdbcTransactionRepository çš„ <code>domain</code> å±æ€§ã€‚</li></ul><p>ä¸€ä¸ªäº‹åŠ¡å­˜å‚¨åˆ° Reidsï¼Œä½¿ç”¨ Redis çš„æ•°æ®ç»“æ„ä¸º <a href="https://redis.io/commands#hash" rel="external nofollow noopener noreferrer" target="_blank">HASHES</a>ã€‚</p><ul><li><p>key : ä½¿ç”¨ <code>keyPrefix</code> + <code>xid</code>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºäº‹åŠ¡çš„ Redis Key</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> keyPrefix key å‰ç¼€</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> xid äº‹åŠ¡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> Redis Key</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getRedisKey(String keyPrefix, Xid xid) &#123;</div><div class="line">   <span class="keyword">byte</span>[] prefix = keyPrefix.getBytes();</div><div class="line">   <span class="keyword">byte</span>[] globalTransactionId = xid.getGlobalTransactionId();</div><div class="line">   <span class="keyword">byte</span>[] branchQualifier = xid.getBranchQualifier();</div><div class="line">   <span class="comment">// æ‹¼æ¥ key</span></div><div class="line">   <span class="keyword">byte</span>[] key = <span class="keyword">new</span> <span class="keyword">byte</span>[prefix.length + globalTransactionId.length + branchQualifier.length];</div><div class="line">   System.arraycopy(prefix, <span class="number">0</span>, key, <span class="number">0</span>, prefix.length);</div><div class="line">   System.arraycopy(globalTransactionId, <span class="number">0</span>, key, prefix.length, globalTransactionId.length);</div><div class="line">   System.arraycopy(branchQualifier, <span class="number">0</span>, key, prefix.length + globalTransactionId.length, branchQualifier.length);</div><div class="line">   <span class="keyword">return</span> key;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>HASHES çš„ key ï¼šä½¿ç”¨ <code>version</code>ã€‚</p><ul><li>æ·»åŠ å’Œæ›´æ–° Transaction æ—¶ï¼Œä½¿ç”¨ Redis <a href="https://redis.io/commands/hsetnx" rel="external nofollow noopener noreferrer" target="_blank">HSETNX</a>ï¼Œä¸å­˜åœ¨å½“å‰ç‰ˆæœ¬çš„å€¼æ—¶ï¼Œè¿›è¡Œè®¾ç½®ï¼Œé‡è€Œå®ç°ç±»ä¼¼ä¹è§‚é”çš„æ›´æ–°ã€‚</li><li>è¯»å– Transaction æ—¶ï¼Œä½¿ç”¨ Redis <a href="https://redis.io/commands/hgetall" rel="external nofollow noopener noreferrer" target="_blank">HGETALL</a>ï¼Œå°† Transaction æ‰€æœ‰ <code>version</code> å¯¹åº”çš„å€¼è¯»å–åˆ°å†…å­˜åï¼Œå– <code>version</code> å€¼æœ€å¤§çš„å¯¹åº”çš„å€¼ã€‚</li></ul></li><li><p>HASHES çš„ value ï¼šè°ƒç”¨ <code>TransactionSerializer#serialize(...)</code> æ–¹æ³•ï¼Œåºåˆ—åŒ– Transactionã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] serialize(ObjectSerializer serializer, Transaction transaction) &#123;</div><div class="line">   Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</div><div class="line">   map.put(<span class="string">"GLOBAL_TX_ID"</span>, transaction.getXid().getGlobalTransactionId());</div><div class="line">   map.put(<span class="string">"BRANCH_QUALIFIER"</span>, transaction.getXid().getBranchQualifier());</div><div class="line">   map.put(<span class="string">"STATUS"</span>, transaction.getStatus().getId());</div><div class="line">   map.put(<span class="string">"TRANSACTION_TYPE"</span>, transaction.getTransactionType().getId());</div><div class="line">   map.put(<span class="string">"RETRIED_COUNT"</span>, transaction.getRetriedCount());</div><div class="line">   map.put(<span class="string">"CREATE_TIME"</span>, transaction.getCreateTime());</div><div class="line">   map.put(<span class="string">"LAST_UPDATE_TIME"</span>, transaction.getLastUpdateTime());</div><div class="line">   map.put(<span class="string">"VERSION"</span>, transaction.getVersion());</div><div class="line">   <span class="comment">// åºåˆ—åŒ–</span></div><div class="line">   map.put(<span class="string">"CONTENT"</span>, serializer.serialize(transaction));</div><div class="line">   <span class="keyword">return</span> serializer.serialize(map);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>TODO ä¸ºä»€ä¹ˆåºåˆ—åŒ–ä¸¤æ¬¡</li></ul></li></ul><p>åœ¨å®ç° <code>#doFindAllUnmodifiedSince(date)</code> æ–¹æ³•ï¼Œæ— æ³•åƒæ•°æ®åº“ä½¿ç”¨æ—¶é—´æ¡ä»¶è¿›è¡Œè¿‡æ»¤ï¼Œå› æ­¤ï¼ŒåŠ è½½æ‰€æœ‰äº‹åŠ¡ååœ¨å†…å­˜ä¸­è¿‡æ»¤ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> List&lt;Transaction&gt; <span class="title">doFindAllUnmodifiedSince</span><span class="params">(Date date)</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å¾—æ‰€æœ‰äº‹åŠ¡</span></div><div class="line">   List&lt;Transaction&gt; allTransactions = doFindAll();</div><div class="line">   <span class="comment">// è¿‡æ»¤æ—¶é—´</span></div><div class="line">   List&lt;Transaction&gt; allUnmodifiedSince = <span class="keyword">new</span> ArrayList&lt;Transaction&gt;();</div><div class="line">   <span class="keyword">for</span> (Transaction transaction : allTransactions) &#123;</div><div class="line">       <span class="keyword">if</span> (transaction.getLastUpdateTime().compareTo(date) &lt; <span class="number">0</span>) &#123;</div><div class="line">           allUnmodifiedSince.add(transaction);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> allUnmodifiedSince;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>psï¼šç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/c164ff5ab29d31e08bc7061de5bc7403f3e40f1d/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/repository/RedisTransactionRepository.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ RedisTransactionRepository ä»£ç å®ç°ï¼Œå·²ç»æ·»åŠ å®Œæ•´ä¸­æ–‡æ³¨é‡Šã€‚</p><blockquote><p>FROM <a href="https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x#%E9%85%8D%E7%BD%AEtcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠTCC-Transaction å®˜æ–¹æ–‡æ¡£ â€”â€” ä½¿ç”¨æŒ‡å—1.2.xã€‹</a><br>ä½¿ç”¨ RedisTransactionRepository éœ€è¦é…ç½® Redis æœåŠ¡å™¨å¦‚ä¸‹ï¼š<br>appendonly yes<br>appendfsync always</p></blockquote><h2>3.4 Zookeeper äº‹åŠ¡å­˜å‚¨å™¨</h2><p><code>org.mengyun.tcctransaction.repository.ZooKeeperTransactionRepository</code>ï¼ŒZookeeper äº‹åŠ¡å­˜å‚¨å™¨ï¼Œå°† Transaction å­˜å‚¨åˆ° Zookeeperã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZooKeeperTransactionRepository</span> <span class="keyword">extends</span> <span class="title">CachableTransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Zookeeper æœåŠ¡å™¨åœ°å€æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String zkServers;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Zookeeper è¶…æ—¶æ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> zkTimeout;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * TCC å­˜å‚¨ Zookeeper æ ¹ç›®å½•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String zkRootPath = <span class="string">"/tcc"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Zookeeper è¿æ¥</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ZooKeeper zk;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åºåˆ—åŒ–</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ObjectSerializer serializer = <span class="keyword">new</span> JdkSerializationSerializer();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>zkRootPath</code>ï¼Œå­˜å‚¨ Zookeeper æ ¹ç›®å½•ï¼Œç±»ä¼¼ JdbcTransactionRepository çš„ <code>domain</code> å±æ€§ã€‚</li></ul><p>ä¸€ä¸ªäº‹åŠ¡å­˜å‚¨åˆ° Zookeeperï¼Œä½¿ç”¨ Zookeeper çš„<strong>æŒä¹…æ•°æ®èŠ‚ç‚¹</strong>ã€‚</p><ul><li><p>pathï¼š<code>${zkRootPath}</code> + <code>/</code> + <code>${xid}</code>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ZooKeeperTransactionRepository.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getTxidPath</span><span class="params">(Xid xid)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> String.format(<span class="string">"%s/%s"</span>, zkRootPath, xid);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// TransactionXid.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">   StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</div><div class="line">   stringBuilder.append(<span class="string">"globalTransactionId:"</span>).append(UUID.nameUUIDFromBytes(globalTransactionId).toString());</div><div class="line">   stringBuilder.append(<span class="string">","</span>).append(<span class="string">"branchQualifier:"</span>).append(UUID.nameUUIDFromBytes(branchQualifier).toString());</div><div class="line">   <span class="keyword">return</span> stringBuilder.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>dataï¼šè°ƒç”¨ <code>TransactionSerializer#serialize(...)</code> æ–¹æ³•ï¼Œåºåˆ—åŒ– Transactionã€‚</p></li><li><p>versionï¼šä½¿ç”¨ Zookeeper æ•°æ®èŠ‚ç‚¹è‡ªå¸¦ç‰ˆæœ¬åŠŸèƒ½ã€‚è¿™é‡Œè¦æ³¨æ„ä¸‹ï¼ŒTransaction çš„ç‰ˆæœ¬ä» 1 å¼€å§‹ï¼Œè€Œ Zookeeper æ•°æ®èŠ‚ç‚¹ç‰ˆæœ¬ä» 0 å¼€å§‹ã€‚</p></li></ul><p>psï¼šç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/c164ff5ab29d31e08bc7061de5bc7403f3e40f1d/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/repository/ZooKeeperTransactionRepository.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ ZooKeeperTransactionRepository ä»£ç å®ç°ï¼Œå·²ç»æ·»åŠ å®Œæ•´ä¸­æ–‡æ³¨é‡Šã€‚</p><p>å¦å¤–ï¼Œåœ¨ç”Ÿäº§ä¸Šæš‚æ—¶ä¸å»ºè®®ä½¿ç”¨ ZooKeeperTransactionRepositoryï¼ŒåŸå› æœ‰ä¸¤ç‚¹ï¼š</p><ul><li>ä¸æ”¯æŒ Zookeeper å®‰å…¨è®¤è¯ã€‚</li><li>ä½¿ç”¨ Zookeeper æ—¶ï¼Œæœªè€ƒè™‘æ–­ç½‘é‡è¿ç­‰æƒ…å†µã€‚</li></ul><p>å¦‚æœä½ è¦ä½¿ç”¨ Zookeeper è¿›è¡Œäº‹åŠ¡çš„å­˜å‚¨ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ <a href="https://curator.apache.org/" rel="external nofollow noopener noreferrer" target="_blank">Apache Curator</a> æ“ä½œ Zookeeperï¼Œé‡å†™ ZooKeeperTransactionRepository éƒ¨åˆ†ä»£ç ã€‚</p><h2>3.5 File äº‹åŠ¡å­˜å‚¨å™¨</h2><p><code>org.mengyun.tcctransaction.repository.FileSystemTransactionRepository</code>ï¼ŒFile äº‹åŠ¡å­˜å‚¨å™¨ï¼Œå°† Transaction å­˜å‚¨åˆ°æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>å®ç°ä¸Šå’Œ ZooKeeperTransactionRepositoryï¼ŒåŒºåˆ«ä¸»è¦åœ¨äºä¸æ”¯æŒä¹è§‚é”æ›´æ–°ã€‚æœ‰å…´è¶£çš„åŒå­¦ç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/c164ff5ab29d31e08bc7061de5bc7403f3e40f1d/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/repository/FileSystemTransactionRepository.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ï¼Œè¿™é‡Œå°±ä¸æ‹“å±•å¼€æ¥ã€‚</p><p>å¦å¤–ï¼Œåœ¨ç”Ÿäº§ä¸Šä¸å»ºè®®ä½¿ç”¨ FileSystemTransactionRepositoryï¼Œå› ä¸ºä¸æ”¯æŒå¤šèŠ‚ç‚¹å…±äº«ã€‚ç”¨åˆ†å¸ƒå¼å­˜å‚¨æŒ‚è½½æ–‡ä»¶å¦è¯´ï¼Œå½“ç„¶è¿˜æ˜¯ä¸å»ºè®®ï¼Œå› ä¸ºä¸æ”¯æŒä¹è§‚é”å¹¶å‘æ›´æ–°ã€‚</p><h1>666. å½©è›‹</h1><p>è¿™ç¯‡ç•¥( è¶… )å¾®( çº§ )æ°´æ›´ï¼Œå“ˆå“ˆå“ˆï¼Œä¸º<a href="http://www.iocoder.cn/TCC-Transaction/transaction-recover/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡æ¢å¤ã€‹</a>åšé“ºå«å•¦ã€‚</p><p>ä½¿ç”¨ RedisTransactionRepository å’Œ ZooKeeperTransactionRepository å­˜å‚¨äº‹åŠ¡è¿˜æ˜¯ Get è›®å¤šç‚¹çš„ã€‚</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_15/02.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. åºåˆ—åŒ–&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2.1 JDK åºåˆ—åŒ–å®ç°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2.2 Kyro åºåˆ—åŒ–å®ç°&lt;/a
      
    
    </summary>
    
      <category term="TCC-Transaction" scheme="http://www.iocoder.cn/categories/TCC-Transaction/"/>
    
    
  </entry>
  
  <entry>
    <title>TCC-Transaction æºç åˆ†æ â€”â€” TCC å®ç°</title>
    <link href="http://www.iocoder.cn/TCC-Transaction/tcc-core/"/>
    <id>http://www.iocoder.cn/TCC-Transaction/tcc-core/</id>
    <published>2018-02-07T16:00:00.000Z</published>
    <updated>2017-09-15T05:30:46.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. TCC åŸç†</a></li><li><a href="#">3. TCC-Transaction åŸç†</a></li><li><a href="#">4. äº‹åŠ¡ä¸å‚ä¸è€…</a><ul><li><a href="#">4.1 äº‹åŠ¡</a></li><li><a href="#">4.2 å‚ä¸è€…</a></li></ul></li><li><a href="#">5. äº‹åŠ¡ç®¡ç†å™¨</a><ul><li><a href="#">5.1 å‘èµ·æ ¹äº‹åŠ¡</a></li><li><a href="#">5.2 ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡</a></li><li><a href="#">5.3 ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡</a></li><li><a href="#">5.4 æäº¤äº‹åŠ¡</a></li><li><a href="#">5.5 å›æ»šäº‹åŠ¡</a></li><li><a href="#">5.6 æ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡</a></li></ul></li><li><a href="#">6. äº‹åŠ¡æ‹¦æˆªå™¨</a><ul><li><a href="#">6.1 Compensable</a></li><li><a href="#">6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨</a></li><li><a href="#">6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« <strong>TCC å®ç°</strong>ã€‚ä¸»è¦æ¶‰åŠå¦‚ä¸‹ä¸‰ä¸ª Maven é¡¹ç›®ï¼š</p><ul><li><code>tcc-transaction-core</code> ï¼štcc-transaction åº•å±‚å®ç°ã€‚</li><li><code>tcc-transaction-api</code> ï¼štcc-transaction ä½¿ç”¨ APIã€‚</li><li><code>tcc-transaction-spring</code> ï¼štcc-transaction Spring æ”¯æŒã€‚</li></ul><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º TCC-Transaction ç‚¹èµï¼<a href="https://github.com/changmingxie/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>OKï¼Œå¼€å§‹æˆ‘ä»¬çš„ç¬¬ä¸€æ®µ TCC æ—…ç¨‹å§ã€‚</p><p>psï¼šç¬”è€…å‡è®¾ä½ å·²ç»é˜…è¯»è¿‡<a href="https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x" rel="external nofollow noopener noreferrer" target="_blank">ã€Štcc-transaction å®˜æ–¹æ–‡æ¡£ â€”â€” ä½¿ç”¨æŒ‡å—1.2.xã€‹</a>ã€‚</p><p>ps2ï¼š<strong>æœªç‰¹æ®Šè¯´æ˜çš„æƒ…å†µä¸‹ï¼Œæœ¬æ–‡äº‹åŠ¡æŒ‡çš„æ˜¯ TCCäº‹åŠ¡</strong>ã€‚</p><h1>2. TCC åŸç†</h1><blockquote><p>FROM https://support.hwclouds.com/devg-servicestage/zh-cn_topic_0056814426.html<br><strong>TCCäº‹åŠ¡</strong><br>ä¸ºäº†è§£å†³åœ¨äº‹åŠ¡è¿è¡Œè¿‡ç¨‹ä¸­å¤§é¢—ç²’åº¦èµ„æºé”å®šçš„é—®é¢˜ï¼Œä¸šç•Œæå‡ºä¸€ç§æ–°çš„äº‹åŠ¡æ¨¡å‹ï¼Œå®ƒæ˜¯åŸºäº<strong>ä¸šåŠ¡å±‚é¢</strong>çš„äº‹åŠ¡å®šä¹‰ã€‚é”ç²’åº¦å®Œå…¨ç”±ä¸šåŠ¡è‡ªå·±æ§åˆ¶ã€‚å®ƒæœ¬è´¨æ˜¯ä¸€ç§è¡¥å¿çš„æ€è·¯ã€‚å®ƒæŠŠäº‹åŠ¡è¿è¡Œè¿‡ç¨‹åˆ†æˆ Tryã€Confirm / Cancel ä¸¤ä¸ªé˜¶æ®µã€‚åœ¨æ¯ä¸ªé˜¶æ®µçš„é€»è¾‘ç”±<strong>ä¸šåŠ¡ä»£ç æ§åˆ¶</strong>ã€‚è¿™æ ·å°±äº‹åŠ¡çš„é”ç²’åº¦å¯ä»¥å®Œå…¨è‡ªç”±æ§åˆ¶ã€‚ä¸šåŠ¡å¯ä»¥åœ¨ç‰ºç‰²éš”ç¦»æ€§çš„æƒ…å†µä¸‹ï¼Œè·å–æ›´é«˜çš„æ€§èƒ½ã€‚</p></blockquote><ul><li>Try é˜¶æ®µ<ul><li>Try ï¼šå°è¯•æ‰§è¡Œä¸šåŠ¡<ul><li>å®Œæˆæ‰€æœ‰ä¸šåŠ¡æ£€æŸ¥( ä¸€è‡´æ€§ )</li><li>é¢„ç•™å¿…é¡»ä¸šåŠ¡èµ„æº( å‡†éš”ç¦»æ€§ )</li></ul></li></ul></li><li>Confirm / Cancel é˜¶æ®µï¼š<ul><li>Confirm ï¼šç¡®è®¤æ‰§è¡Œä¸šåŠ¡<ul><li>çœŸæ­£æ‰§è¡Œä¸šåŠ¡</li><li>ä¸åšä»»åŠ¡ä¸šåŠ¡æ£€æŸ¥</li><li>Confirm æ“ä½œæ»¡è¶³å¹‚ç­‰æ€§</li></ul></li><li>Cancel ï¼šå–æ¶ˆæ‰§è¡Œä¸šåŠ¡<ul><li>é‡Šæ”¾ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æº</li><li>Cancel æ“ä½œæ»¡è¶³å¹‚ç­‰æ€§</li></ul></li><li>Confirm ä¸ Cancel äº’æ–¥</li></ul></li></ul><p>æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_08/01.jpeg" alt=""></p><ul><li><p><strong>çº¢æ¡†éƒ¨åˆ†</strong>åŠŸèƒ½ç”± <code>tcc-transaction-core</code> å®ç°ï¼š</p><ul><li>å¯åŠ¨ä¸šåŠ¡æ´»åŠ¨</li><li>ç™»è®°ä¸šåŠ¡æ“ä½œ</li><li>æäº¤ / å›æ»šä¸šåŠ¡æ´»åŠ¨</li></ul></li><li><p><strong>é»„æ¡†éƒ¨åˆ†</strong>åŠŸèƒ½ç”± <code>tcc-transaction-http-sample</code> å®ç°( å®˜æ–¹æä¾›çš„ç¤ºä¾‹é¡¹ç›® )ï¼š</p><ul><li>Try æ“ä½œ</li><li>Confirm æ“ä½œ</li><li>Cancel æ“ä½œ</li></ul></li></ul><p><strong>ä¸ 2PCåè®® æ¯”è¾ƒ</strong>ï¼š</p><ul><li>ä½äºä¸šåŠ¡æœåŠ¡å±‚è€Œéè‡ªæ„¿å±‚</li><li>æ²¡æœ‰å•ç‹¬çš„å‡†å¤‡( Prepare )é˜¶æ®µï¼ŒTry æ“ä½œå…¼å¤‡è‡ªæ„¿æ“ä½œä¸å‡†å¤‡èƒ½åŠ›</li><li>Try æ“ä½œå¯ä»¥çµæ´»é€‰æ‹©ä¸šåŠ¡èµ„æºçš„é”å®šç²’åº¦</li><li>è¾ƒé«˜å¼€å‘æˆæœ¬</li></ul><p>å‚è€ƒèµ„æ–™ï¼š</p><ul><li><a href="https://www.zhihu.com/question/31813039" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ”¯ä»˜å®è¿è¥æ¶æ„ä¸­æŸ”æ€§äº‹åŠ¡æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿã€‹</a></li><li><a href="http://kaimingwan.com/post/fen-bu-shi/fen-bu-shi-shi-wu-de-dian-xing-chu-li-fang-shi-2pc-tcc-yi-bu-que-bao-he-zui-da-nu-li-xing" rel="external nofollow noopener noreferrer" target="_blank">ã€Šåˆ†å¸ƒå¼äº‹åŠ¡çš„å…¸å‹å¤„ç†æ–¹å¼:2PCã€TCCã€å¼‚æ­¥ç¡®ä¿å’Œæœ€å¤§åŠªåŠ›å‹ã€‹</a></li></ul><h1>3. TCC-Transaction åŸç†</h1><p>åœ¨ TCC é‡Œï¼Œä¸€ä¸ªä¸šåŠ¡æ´»åŠ¨å¯ä»¥æœ‰å¤šä¸ªäº‹åŠ¡ï¼Œæ¯ä¸ªä¸šåŠ¡æ“ä½œå½’å±äºä¸åŒçš„äº‹åŠ¡ï¼Œå³ä¸€ä¸ªäº‹åŠ¡å¯ä»¥åŒ…å«å¤šä¸ªä¸šåŠ¡æ“ä½œã€‚TCC-Transaction å°†æ¯ä¸ªä¸šåŠ¡æ“ä½œæŠ½è±¡æˆ<strong>äº‹åŠ¡å‚ä¸è€…</strong>ï¼Œæ¯ä¸ªäº‹åŠ¡å¯ä»¥åŒ…å«å¤šä¸ª<strong>å‚ä¸è€…</strong>ã€‚</p><p>å‚ä¸è€…éœ€è¦å£°æ˜ try / confirm / cancel ä¸‰ä¸ªç±»å‹çš„æ–¹æ³•ï¼Œå’Œ TCC çš„æ“ä½œä¸€ä¸€å¯¹åº”ã€‚åœ¨ç¨‹åºé‡Œï¼Œé€šè¿‡ @Compensable æ³¨è§£æ ‡è®°åœ¨ try æ–¹æ³•ä¸Šï¼Œå¹¶å¡«å†™å¯¹åº”çš„ confirm / cancel æ–¹æ³•ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// try</span></div><div class="line"><span class="meta">@Compensable</span>(confirmMethod = <span class="string">"confirmRecord"</span>, cancelMethod = <span class="string">"cancelRecord"</span>, transactionContextEditor = MethodTransactionContextEditor.class)</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">record</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">// confirm</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirmRecord</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">// cancel</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelRecord</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> </span>&#123;&#125;</div></pre></td></tr></table></figure></p><ul><li>åœ¨ç¤ºä¾‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° TransactionContextï¼Œäº‹åŠ¡ä¸Šä¸‹æ–‡ï¼Œè¿™ä¸ªæ˜¯æ€ä¹ˆç”Ÿæˆçš„å‘¢ï¼Ÿè¿™é‡Œå…ˆå–ä¸€ä¸ªå…³å­ã€‚</li></ul><p>TCC-Transaction æœ‰ä¸¤ä¸ªæ‹¦æˆªå™¨ï¼Œé€šè¿‡å¯¹ @Compensable AOP åˆ‡é¢( å‚ä¸è€… try æ–¹æ³• )è¿›è¡Œæ‹¦æˆªï¼Œé€æ˜åŒ–å¯¹å‚ä¸è€… confirm / cancel æ–¹æ³•è°ƒç”¨ï¼Œä»è€Œå®ç° TCC ã€‚<strong>ç®€åŒ–</strong>æµç¨‹å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_08/03.png" alt=""></p><p>ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œå¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ï¼Œå®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š</p><ul><li>åœ¨ Try é˜¶æ®µï¼Œå¯¹äº‹åŠ¡çš„å‘èµ·ã€ä¼ æ’­ã€‚</li><li>åœ¨ Confirm / Cancel é˜¶æ®µï¼Œå¯¹äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚</li><li><strong>ä¸ºä»€ä¹ˆä¼šæœ‰å¯¹äº‹åŠ¡çš„ä¼ æ’­å‘¢</strong>ï¼Ÿåœ¨è¿œç¨‹è°ƒç”¨æœåŠ¡çš„å‚ä¸è€…æ—¶ï¼Œä¼šé€šè¿‡**&quot;å‚æ•°&quot;**( éœ€è¦åºåˆ—åŒ– )çš„å½¢å¼ä¼ é€’äº‹åŠ¡ç»™è¿œç¨‹å‚ä¸è€…ã€‚</li></ul><p>ç¬¬äºŒä¸ªæ‹¦æˆªå™¨ï¼Œèµ„æºåè°ƒè€…æ‹¦æˆªå™¨ï¼Œå®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š</p><ul><li>åœ¨ Try é˜¶æ®µï¼Œæ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡ä¸­ã€‚å½“äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸å­˜åœ¨æ—¶ï¼Œè¿›è¡Œåˆ›å»ºã€‚</li></ul><p>å®é™…æ‹¦æˆªå™¨å¯¹äº‹åŠ¡çš„å¤„ç†ä¼šæ¯”ä¸Šå›¾å¤æ‚ä¸€äº›ï¼Œåœ¨æœ¬æ–‡<a href="#">ã€Œ6. äº‹åŠ¡æ‹¦æˆªå™¨ã€</a>è¯¦ç»†è§£æã€‚</p><p>åœ¨ TCC-Transaction ä»£ç å®ç°ä¸Šï¼Œç»„ä»¶åˆ†å±‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_08/04.png" alt=""></p><p>æœ¬æ–‡æŒ‰ç…§å¦‚ä¸‹é¡ºåºåˆ†äº«ï¼š</p><ul><li><a href="#">ã€Œ4. äº‹åŠ¡æ‹¦æˆªå™¨ã€</a></li><li><a href="#">ã€Œ5. äº‹åŠ¡ç®¡ç†å™¨ã€</a></li><li><a href="#">ã€Œ6. äº‹åŠ¡ç®¡ç†å™¨ã€</a></li></ul><p>å†…å®¹æ˜¯<strong>è‡ªä¸‹è€Œä¸Š</strong>çš„æ–¹å¼åˆ†äº«ï¼Œæ¯ä¸ªç»„ä»¶å¯ä»¥æ›´åŠ æ•´ä½“çš„è¢«è®¤è¯†ã€‚å½“ç„¶è¿™å¯èƒ½å¯¹ä½ ç†è§£æ—¶äº§ç”Ÿä¸€è„¸é—·é€¼ï¼Œæ‰€ä»¥æ¨èä¸¤ç§é˜…è¯»æ–¹å¼ï¼š</p><ul><li>ç®€è¯» x 1 + æ·±è¯» x 1</li><li>å€’ç€è¯»ï¼Œå‘ç°æœªåˆ†äº«çš„æ–¹æ³•ï¼Œå…¨æ–‡æ£€ç´¢è¯¥æ–¹æ³•ã€‚</li></ul><p>äº‹åŠ¡å­˜å‚¨å™¨åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-repository/?self">ã€ŠTCC-Transaction æºç è§£æ â€”â€” äº‹åŠ¡å­˜å‚¨äºæ¢å¤ã€‹</a>è¯¦ç»†è§£æã€‚</p><p>äº‹åŠ¡æ¢å¤åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-recovery/?self">ã€ŠTCC-Transaction æºç è§£æ â€”â€” äº‹åŠ¡æ¢å¤ã€‹</a>è¯¦ç»†è§£æã€‚</p><h1>4. äº‹åŠ¡ä¸å‚ä¸è€…</h1><p>åœ¨ TCC é‡Œï¼Œ<strong>ä¸€ä¸ª</strong>äº‹åŠ¡( <code>org.mengyun.tcctransaction.Transaction</code> ) å¯ä»¥æœ‰<strong>å¤šä¸ª</strong>å‚ä¸è€…( <code>org.mengyun.tcctransaction.Participant</code> )å‚ä¸ä¸šåŠ¡æ´»åŠ¨ã€‚ç±»å›¾å…³ç³»å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/TCC-Transaction/2018_02_08/02.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_08/02.png" alt=""></p><h2>4.1 äº‹åŠ¡</h2><p><strong>Transaction å®ç°ä»£ç å¦‚ä¸‹</strong>ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Transaction</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7291423944314337931L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> TransactionXid xid;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡çŠ¶æ€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> TransactionStatus status;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ç±»å‹</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> TransactionType transactionType;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é‡è¯•æ¬¡æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> retriedCount = <span class="number">0</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ›å»ºæ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Date createTime = <span class="keyword">new</span> Date();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æœ€åæ›´æ–°æ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Date lastUpdateTime = <span class="keyword">new</span> Date();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç‰ˆæœ¬å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> version = <span class="number">1</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‚ä¸è€…é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> List&lt;Participant&gt; participants = <span class="keyword">new</span> ArrayList&lt;Participant&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é™„å¸¦å±æ€§æ˜ å°„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; attachments = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Object&gt;();</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ·»åŠ å‚ä¸è€…</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> participant å‚ä¸è€…</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enlistParticipant</span><span class="params">(Participant participant)</span> </span>&#123;</div><div class="line">        participants.add(participant);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æäº¤ TCC äº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Participant participant : participants) &#123;</div><div class="line">            participant.commit();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å›æ»š TCC äº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Participant participant : participants) &#123;</div><div class="line">            participant.rollback();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>xidï¼Œäº‹åŠ¡ç¼–å·( TransactionXid )ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªäº‹åŠ¡ã€‚ä½¿ç”¨ UUID ç®—æ³•ç”Ÿæˆï¼Œ<strong>ä¿è¯å”¯ä¸€æ€§</strong>ã€‚<code>org.mengyun.tcctransaction.api.TransactionXid</code> å®ç° <a href="https://docs.oracle.com/javase/8/docs/api/javax/transaction/xa/Xid.html" rel="external nofollow noopener noreferrer" target="_blank"><code>javax.transaction.xa.Xid</code></a> æ¥å£ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionXid</span> <span class="keyword">implements</span> <span class="title">Xid</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">6817267250789142043L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * xid æ ¼å¼æ ‡è¯†ç¬¦</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> formatId = <span class="number">1</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å…¨å±€äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] globalTransactionId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ†æ”¯äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] branchQualifier;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>TODO ä¸ºä»€ä¹ˆè¦ç»§æ‰¿ Xid æ¥å£ï¼Ÿ</li></ul></li><li><p>statusï¼Œäº‹åŠ¡çŠ¶æ€( TransactionStatus )ã€‚<code>org.mengyun.tcctransaction.api.TransactionStatus</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> TransactionStatus &#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å°è¯•ä¸­çŠ¶æ€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    TRYING(<span class="number">1</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¡®è®¤ä¸­çŠ¶æ€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    CONFIRMING(<span class="number">2</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å–æ¶ˆä¸­çŠ¶æ€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    CANCELLING(<span class="number">3</span>);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>transactionTypeï¼Œäº‹åŠ¡ç±»å‹( TransactionType )ã€‚<code>org.mengyun.tcctransaction.common.TransactionType</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> TransactionType &#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ ¹äº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    ROOT(<span class="number">1</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ†æ”¯äº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    BRANCH(<span class="number">2</span>);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> id;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>åœ¨<a href="#">ã€Œ6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ã€</a>æœ‰è¯¦ç»†è§£æï¼Œå¯ä»¥çœ‹åˆ°çœ‹åˆ°è¿™ä¸¤ç§äº‹åŠ¡æ˜¯å¦‚ä½•å‘èµ·ã€‚</li></ul></li><li><p>retriedCountï¼Œé‡è¯•æ¬¡æ•°ã€‚åœ¨ TCC è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å‚ä¸è€…å¼‚å¸¸å´©æºƒï¼Œè¿™ä¸ªæ—¶å€™ä¼šè¿›è¡Œé‡è¯•ç›´åˆ°æˆåŠŸæˆ–è¶…è¿‡æœ€å¤§æ¬¡æ•°ã€‚åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-recovery/?self">ã€ŠTCC-Transaction æºç è§£æ â€”â€” äº‹åŠ¡æ¢å¤ã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>versionï¼Œç‰ˆæœ¬å·ï¼Œç”¨äºä¹è§‚é”æ›´æ–°äº‹åŠ¡ã€‚åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-repository/?self">ã€ŠTCC-Transaction æºç è§£æ â€”â€” äº‹åŠ¡å­˜å‚¨å™¨ã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>attachmentsï¼Œé™„å¸¦å±æ€§æ˜ å°„ã€‚åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/?self">ã€ŠTCC-Transaction æºç è§£æ â€”â€” Dubbo æ”¯æŒã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>æä¾› <code>#enlistParticipant()</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡å‚ä¸è€…ã€‚</p></li><li><p>æä¾› <code>#commit()</code> æ–¹æ³•ï¼Œè°ƒç”¨å‚ä¸è€…ä»¬æäº¤äº‹åŠ¡ã€‚</p></li><li><p>æä¾› <code>#rollback()</code> æ–¹æ³•ï¼Œè°ƒç”¨å‚ä¸è€…å›æ»šäº‹åŠ¡ã€‚</p></li></ul><h2>4.2 å‚ä¸è€…</h2><p><strong>Participant å®ç°ä»£ç å¦‚ä¸‹</strong>ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Participant</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">4127729421281425247L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> TransactionXid xid;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> InvocationContext confirmInvocationContext;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ–¹æ³•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> InvocationContext cancelInvocationContext;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Terminator terminator = <span class="keyword">new</span> Terminator();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Class&lt;? extends TransactionContextEditor&gt; transactionContextEditorClass;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æäº¤äº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> </span>&#123;</div><div class="line">        terminator.invoke(<span class="keyword">new</span> TransactionContext(xid, TransactionStatus.CONFIRMING.getId()), confirmInvocationContext, transactionContextEditorClass);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å›æ»šäº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> </span>&#123;</div><div class="line">        terminator.invoke(<span class="keyword">new</span> TransactionContext(xid, TransactionStatus.CANCELLING.getId()), cancelInvocationContext, transactionContextEditorClass);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>xidï¼Œå‚ä¸è€…äº‹åŠ¡ç¼–å·ã€‚é€šè¿‡ <code>TransactionXid.globalTransactionId</code> å±æ€§ï¼Œå…³è”ä¸Šå…¶æ‰€å±çš„äº‹åŠ¡ã€‚å½“å‚ä¸è€…è¿›è¡Œè¿œç¨‹è°ƒç”¨æ—¶ï¼Œè¿œç¨‹çš„<strong>åˆ†æ”¯</strong>äº‹åŠ¡çš„äº‹åŠ¡ç¼–å·ç­‰äºè¯¥å‚ä¸è€…çš„äº‹åŠ¡ç¼–å·ã€‚é€šè¿‡äº‹åŠ¡ç¼–å·çš„å…³è”ï¼ŒTCC Confirm / Cancel é˜¶æ®µï¼Œä½¿ç”¨å‚ä¸è€…çš„äº‹åŠ¡ç¼–å·å’Œè¿œç¨‹çš„<strong>åˆ†æ”¯</strong>äº‹åŠ¡è¿›è¡Œå…³è”ï¼Œä»è€Œå®ç°äº‹åŠ¡çš„æäº¤å’Œå›æ»šï¼Œåœ¨<a href="#">ã€Œ5.2 ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡ã€ + ã€Œ6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ã€</a>å¯ä»¥çœ‹åˆ°å…·ä½“å®ç°ã€‚</p></li><li><p>confirmInvocationContextï¼Œç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡( InvocationContext )ã€‚<code>org.mengyun.tcctransaction.InvocationContext</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvocationContext</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">7969140711432461165L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç±»</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Class targetClass;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ–¹æ³•å</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String methodName;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‚æ•°ç±»å‹æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Class[] parameterTypes;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‚æ•°æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Object[] args;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>InvocationContextï¼Œæ‰§è¡Œæ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡ï¼Œè®°å½•ç±»ã€æ–¹æ³•åã€å‚æ•°ç±»å‹æ•°ç»„ã€å‚æ•°æ•°ç»„ã€‚é€šè¿‡è¿™äº›å±æ€§ï¼Œå¯ä»¥æ‰§è¡Œæäº¤ / å›æ»šäº‹åŠ¡ã€‚åœ¨ <code>org.mengyun.tcctransaction.Terminator</code> ä¼šçœ‹åˆ°å…·ä½“çš„ä»£ç å®ç°ã€‚<strong>æœ¬è´¨ä¸Šï¼ŒTCC é€šè¿‡å¤šä¸ªå‚ä¸è€…çš„ try / confirm / cancel æ–¹æ³•ï¼Œå®ç°äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´æ€§</strong>ã€‚</li></ul></li><li><p>cancelInvocationContextï¼Œå–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡( InvocationContext )ã€‚</p></li><li><p>terminatorï¼Œæ‰§è¡Œå™¨( Terminator )ã€‚<code>org.mengyun.tcctransaction.Terminator</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Terminator</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">164958655471605778L</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(TransactionContext transactionContext, InvocationContext invocationContext, Class&lt;? extends TransactionContextEditor&gt; transactionContextEditorClass)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(invocationContext.getMethodName())) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// è·å¾— å‚ä¸è€…å¯¹è±¡</span></div><div class="line">                Object target = FactoryBuilder.factoryOf(invocationContext.getTargetClass()).getInstance();</div><div class="line">                <span class="comment">// è·å¾— æ–¹æ³•</span></div><div class="line">                Method method = target.getClass().getMethod(invocationContext.getMethodName(), invocationContext.getParameterTypes());</div><div class="line">                <span class="comment">// è®¾ç½® äº‹åŠ¡ä¸Šä¸‹æ–‡ åˆ°æ–¹æ³•å‚æ•°</span></div><div class="line">                FactoryBuilder.factoryOf(transactionContextEditorClass).getInstance().set(transactionContext, target, method, invocationContext.getArgs());</div><div class="line">                <span class="comment">// æ‰§è¡Œæ–¹æ³•</span></div><div class="line">                <span class="keyword">return</span> method.invoke(target, invocationContext.getArgs());</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>FactoryBuilderï¼Œå·¥å‚ Builderï¼Œæ„Ÿå…´è¶£çš„åŒå­¦ç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/8553baad29597603d9007d61aec3ea5201632d1b/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/support/FactoryBuilder.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ï¼Œå·²ç»æ·»åŠ å®Œæ•´ä¸­æ–‡ä»£ç æ³¨é‡Šã€‚</li><li>TransactionContextEditorï¼Œåœ¨æœ¬æ–‡<a href="#">ã€Œ6.1 Compensableã€</a>è¯¦ç»†è§£æã€‚</li></ul></li><li><p>transactionContextEditorClassï¼Œäº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘ï¼Œåœ¨<a href="#">ã€Œ6.1 Compensableã€</a>è¯¦ç»†è§£æã€‚</p></li><li><p>æäº¤ <code>#commit()</code> æ–¹æ³•ï¼Œæäº¤å‚ä¸è€…è‡ªå·±çš„äº‹åŠ¡ã€‚</p></li><li><p>æäº¤ <code>#rollback()</code> æ–¹æ³•ï¼Œå›æ»šå‚ä¸è€…è‡ªå·±çš„äº‹åŠ¡ã€‚</p></li></ul><h1>5. äº‹åŠ¡ç®¡ç†å™¨</h1><p><code>org.mengyun.tcctransaction.TransactionManager</code>ï¼Œäº‹åŠ¡ç®¡ç†å™¨ï¼Œæä¾›äº‹åŠ¡çš„è·å–ã€å‘èµ·ã€æäº¤ã€å›æ»šï¼Œå‚ä¸è€…çš„æ–°å¢ç­‰ç­‰æ–¹æ³•ã€‚</p><h2>5.1 å‘èµ·æ ¹äº‹åŠ¡</h2><p>æä¾› <code>begin()</code> æ–¹æ³•ï¼Œå‘èµ·æ ¹äº‹åŠ¡ã€‚è¯¥æ–¹æ³•åœ¨<strong>è°ƒç”¨æ–¹æ³•ç±»å‹ä¸º MethodType.ROOT å¹¶ä¸” äº‹åŠ¡å¤„äº Try é˜¶æ®µ</strong>è¢«è°ƒç”¨ã€‚MethodType åœ¨<a href="#">ã€Œ6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ã€</a>è¯¦ç»†è§£æã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å‘èµ·æ ¹äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Transaction <span class="title">begin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// åˆ›å»º æ ¹äº‹åŠ¡</span></div><div class="line">   Transaction transaction = <span class="keyword">new</span> Transaction(TransactionType.ROOT);</div><div class="line">   <span class="comment">// å­˜å‚¨ äº‹åŠ¡</span></div><div class="line">   transactionRepository.create(transaction);</div><div class="line">   <span class="comment">// æ³¨å†Œ äº‹åŠ¡</span></div><div class="line">   registerTransaction(transaction);</div><div class="line">   <span class="keyword">return</span> transaction;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ Transaction æ„é€ æ–¹æ³•ï¼Œåˆ›å»º<strong>æ ¹äº‹åŠ¡</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Transaction.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºæŒ‡å®šç±»å‹çš„äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionType äº‹åŠ¡ç±»å‹</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Transaction</span><span class="params">(TransactionType transactionType)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.xid = <span class="keyword">new</span> TransactionXid();</div><div class="line">   <span class="keyword">this</span>.status = TransactionStatus.TRYING; <span class="comment">// å°è¯•ä¸­çŠ¶æ€</span></div><div class="line">   <span class="keyword">this</span>.transactionType = transactionType;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ç›®å‰è¯¥æ„é€ æ–¹æ³•åªæœ‰ <code>TransactionManager#begin()</code> åœ¨è°ƒç”¨ï¼Œå³åªåˆ›å»º<strong>æ ¹äº‹åŠ¡</strong>ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>TransactionRepository#crete()</code> æ–¹æ³•ï¼Œå­˜å‚¨äº‹åŠ¡ã€‚</p></li><li><p>è°ƒç”¨ <code>#registerTransaction(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œäº‹åŠ¡åˆ°å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt; CURRENT = <span class="keyword">new</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt;();</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ³¨å†Œäº‹åŠ¡åˆ°å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerTransaction</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (CURRENT.get() == <span class="keyword">null</span>) &#123;</div><div class="line">       CURRENT.set(<span class="keyword">new</span> LinkedList&lt;Transaction&gt;());</div><div class="line">   &#125;</div><div class="line">   CURRENT.get().push(transaction); <span class="comment">// æ·»åŠ åˆ°å¤´éƒ¨</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>å¯èƒ½æœ‰åŒå­¦ä¼šæ¯”è¾ƒå¥½å¥‡ï¼Œä¸ºä»€ä¹ˆä½¿ç”¨é˜Ÿåˆ—å­˜å‚¨å½“å‰çº¿ç¨‹äº‹åŠ¡</strong>ï¼ŸTCC-Transaction æ”¯æŒ<strong>å¤šä¸ª</strong>çš„äº‹åŠ¡<strong>ç‹¬ç«‹å­˜åœ¨</strong>ï¼Œååˆ›å»ºçš„äº‹åŠ¡å…ˆæäº¤ï¼Œç±»ä¼¼ Spring çš„<code>org.springframework.transaction.annotation.Propagation.REQUIRES_NEW</code> ã€‚åœ¨ä¸‹æ–‡ï¼Œå¾ˆå¿«æˆ‘ä»¬å°±ä¼šçœ‹åˆ° TCC-Transaction è‡ªå·±çš„ <code>org.mengyun.tcctransaction.api.Propagation</code> ã€‚</li></ul></li></ul><h2>5.2 ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡</h2><p>è°ƒç”¨ <code>#propagationNewBegin(...)</code> æ–¹æ³•ï¼Œä¼ æ’­å‘èµ·<strong>åˆ†æ”¯</strong>äº‹åŠ¡ã€‚è¯¥æ–¹æ³•åœ¨<strong>è°ƒç”¨æ–¹æ³•ç±»å‹ä¸º MethodType.PROVIDER å¹¶ä¸” äº‹åŠ¡å¤„äº Try é˜¶æ®µ</strong>è¢«è°ƒç”¨ã€‚MethodType åœ¨<a href="#">ã€Œ6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ã€</a>è¯¦ç»†è§£æã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionContext äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> åˆ†æ”¯äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Transaction <span class="title">propagationNewBegin</span><span class="params">(TransactionContext transactionContext)</span> </span>&#123;</div><div class="line">  <span class="comment">// åˆ›å»º åˆ†æ”¯äº‹åŠ¡</span></div><div class="line">  Transaction transaction = <span class="keyword">new</span> Transaction(transactionContext);</div><div class="line">  <span class="comment">// å­˜å‚¨ äº‹åŠ¡</span></div><div class="line">  transactionRepository.create(transaction);</div><div class="line">  <span class="comment">// æ³¨å†Œ äº‹åŠ¡</span></div><div class="line">  registerTransaction(transaction);</div><div class="line">  <span class="keyword">return</span> transaction;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ Transaction æ„é€ æ–¹æ³•ï¼Œåˆ›å»º<strong>åˆ†æ”¯äº‹åŠ¡</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºåˆ†æ”¯äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionContext äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Transaction</span><span class="params">(TransactionContext transactionContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.xid = transactionContext.getXid(); <span class="comment">// äº‹åŠ¡ä¸Šä¸‹æ–‡çš„ xid</span></div><div class="line">   <span class="keyword">this</span>.status = TransactionStatus.TRYING; <span class="comment">// å°è¯•ä¸­çŠ¶æ€</span></div><div class="line">   <span class="keyword">this</span>.transactionType = TransactionType.BRANCH; <span class="comment">// åˆ†æ”¯äº‹åŠ¡</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>åˆ†æ”¯</strong>äº‹åŠ¡ä½¿ç”¨ä¼ æ’­çš„äº‹åŠ¡ä¸Šä¸‹æ–‡çš„äº‹åŠ¡ç¼–å·ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>TransactionRepository#crete()</code> æ–¹æ³•ï¼Œå­˜å‚¨äº‹åŠ¡ã€‚ä¸ºä»€ä¹ˆè¦å­˜å‚¨<strong>åˆ†æ”¯</strong>äº‹åŠ¡ï¼Œåœ¨<a href="#">ã€Œ6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨ã€</a>è¯¦ç»†è§£æã€‚</p></li><li><p>è°ƒç”¨ <code>#registerTransaction(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œäº‹åŠ¡åˆ°å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ã€‚</p></li></ul><h2>5.3 ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡</h2><p>è°ƒç”¨ <code>#propagationExistBegin(...)</code> æ–¹æ³•ï¼Œä¼ æ’­å‘èµ·<strong>åˆ†æ”¯</strong>äº‹åŠ¡ã€‚è¯¥æ–¹æ³•åœ¨<strong>è°ƒç”¨æ–¹æ³•ç±»å‹ä¸º MethodType.PROVIDER å¹¶ä¸” äº‹åŠ¡å¤„äº Confirm / Cancel é˜¶æ®µ</strong>è¢«è°ƒç”¨ã€‚MethodType åœ¨<a href="#">ã€Œ6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ã€</a>è¯¦ç»†è§£æã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionContext äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> åˆ†æ”¯äº‹åŠ¡</span></div><div class="line"><span class="comment">* <span class="doctag">@throws</span> NoExistedTransactionException å½“äº‹åŠ¡ä¸å­˜åœ¨æ—¶</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Transaction <span class="title">propagationExistBegin</span><span class="params">(TransactionContext transactionContext)</span> <span class="keyword">throws</span> NoExistedTransactionException </span>&#123;</div><div class="line">   <span class="comment">// æŸ¥è¯¢ äº‹åŠ¡</span></div><div class="line">   Transaction transaction = transactionRepository.findByXid(transactionContext.getXid());</div><div class="line">   <span class="keyword">if</span> (transaction != <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="comment">// è®¾ç½® äº‹åŠ¡ çŠ¶æ€</span></div><div class="line">       transaction.changeStatus(TransactionStatus.valueOf(transactionContext.getStatus()));</div><div class="line">       <span class="comment">// æ³¨å†Œ äº‹åŠ¡</span></div><div class="line">       registerTransaction(transaction);</div><div class="line">       <span class="keyword">return</span> transaction;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> NoExistedTransactionException();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>TransactionRepository#findByXid()</code> æ–¹æ³•ï¼ŒæŸ¥è¯¢äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>Transaction#changeStatus(...)</code> æ–¹æ³•ï¼Œ<strong>è®¾ç½®</strong>äº‹åŠ¡çŠ¶æ€ä¸º CONFIRMING æˆ– CANCELLINGã€‚</li><li>è°ƒç”¨ <code>#registerTransaction(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œäº‹åŠ¡åˆ°å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ã€‚</li><li>ä¸ºä»€ä¹ˆæ­¤å¤„æ˜¯<strong>åˆ†æ”¯</strong>äº‹åŠ¡å‘¢ï¼Ÿç»“åˆ <code>#propagationNewBegin(...)</code> æ€è€ƒä¸‹ã€‚</li></ul><h2>5.4 æäº¤äº‹åŠ¡</h2><p>è°ƒç”¨ <code>#commit(...)</code> æ–¹æ³•ï¼Œæäº¤äº‹åŠ¡ã€‚è¯¥æ–¹æ³•åœ¨<strong>äº‹åŠ¡å¤„äº Confirm / Cancel é˜¶æ®µ</strong>è¢«è°ƒç”¨ã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æäº¤äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å– äº‹åŠ¡</span></div><div class="line">   Transaction transaction = getCurrentTransaction();</div><div class="line">   <span class="comment">// è®¾ç½® äº‹åŠ¡çŠ¶æ€ ä¸º CONFIRMING</span></div><div class="line">   transaction.changeStatus(TransactionStatus.CONFIRMING);</div><div class="line">   <span class="comment">// æ›´æ–° äº‹åŠ¡</span></div><div class="line">   transactionRepository.update(transaction);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// æäº¤ äº‹åŠ¡</span></div><div class="line">       transaction.commit();</div><div class="line">       <span class="comment">// åˆ é™¤ äº‹åŠ¡</span></div><div class="line">       transactionRepository.delete(transaction);</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable commitException) &#123;</div><div class="line">       logger.error(<span class="string">"compensable transaction confirm failed."</span>, commitException);</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ConfirmingException(commitException);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#getCurrentTransaction()</code> æ–¹æ³•ï¼Œ è·å–äº‹åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Transaction <span class="title">getCurrentTransaction</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (isTransactionActive()) &#123;</div><div class="line">       <span class="keyword">return</span> CURRENT.get().peek(); <span class="comment">// è·å¾—å¤´éƒ¨å…ƒç´ </span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTransactionActive</span><span class="params">()</span> </span>&#123;</div><div class="line">   Deque&lt;Transaction&gt; transactions = CURRENT.get();</div><div class="line">   <span class="keyword">return</span> transactions != <span class="keyword">null</span> &amp;&amp; !transactions.isEmpty();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä¸ºä»€ä¹ˆè·å¾—é˜Ÿåˆ—<strong>å¤´éƒ¨</strong>å…ƒç´ å‘¢ï¼Ÿè¯¥å…ƒç´ å³æ˜¯ä¸Šæ–‡è°ƒç”¨ <code>#registerTransaction(...)</code> æ³¨å†Œåˆ°é˜Ÿåˆ—å¤´éƒ¨ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>Transaction#changeStatus(...)</code> æ–¹æ³•ï¼Œ <strong>è®¾ç½®</strong>äº‹åŠ¡çŠ¶æ€ä¸º CONFIRMINGã€‚</p></li><li><p>è°ƒç”¨ <code>TransactionRepository#update(...)</code> æ–¹æ³•ï¼Œ <strong>æ›´æ–°</strong>äº‹åŠ¡ã€‚</p></li><li><p>è°ƒç”¨ <code>Transaction#commit(...)</code> æ–¹æ³•ï¼Œ <strong>æäº¤</strong>äº‹åŠ¡ã€‚</p></li><li><p>è°ƒç”¨ <code>TransactionRepository#delete(...)</code> æ–¹æ³•ï¼Œ<strong>åˆ é™¤</strong>äº‹åŠ¡ã€‚</p></li></ul><h2>5.5 å›æ»šäº‹åŠ¡</h2><p>è°ƒç”¨ <code>#rollback(...)</code> æ–¹æ³•ï¼Œå–æ¶ˆäº‹åŠ¡ï¼Œå’Œ <code>#commit()</code> æ–¹æ³•åŸºæœ¬ç±»ä¼¼ã€‚è¯¥æ–¹æ³•åœ¨<strong>äº‹åŠ¡å¤„äº Confirm / Cancel é˜¶æ®µ</strong>è¢«è°ƒç”¨ã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å›æ»šäº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å– äº‹åŠ¡</span></div><div class="line">   Transaction transaction = getCurrentTransaction();</div><div class="line">   <span class="comment">// è®¾ç½® äº‹åŠ¡çŠ¶æ€ ä¸º CANCELLING</span></div><div class="line">   transaction.changeStatus(TransactionStatus.CANCELLING);</div><div class="line">   <span class="comment">// æ›´æ–° äº‹åŠ¡</span></div><div class="line">   transactionRepository.update(transaction);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// æäº¤ äº‹åŠ¡</span></div><div class="line">       transaction.rollback();</div><div class="line">       <span class="comment">// åˆ é™¤ äº‹åŠ¡</span></div><div class="line">       transactionRepository.delete(transaction);</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable rollbackException) &#123;</div><div class="line">       logger.error(<span class="string">"compensable transaction rollback failed."</span>, rollbackException);</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> CancellingException(rollbackException);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#getCurrentTransaction()</code> æ–¹æ³•ï¼Œè·å–äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>Transaction#changeStatus(...)</code> æ–¹æ³•ï¼Œ <strong>è®¾ç½®</strong>äº‹åŠ¡çŠ¶æ€ä¸º CANCELLINGã€‚</li><li>è°ƒç”¨ <code>TransactionRepository#update(...)</code> æ–¹æ³•ï¼Œ <strong>æ›´æ–°</strong>äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>Transaction#rollback(...)</code> æ–¹æ³•ï¼Œ <strong>å›æ»š</strong>äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>TransactionRepository#delete(...)</code> æ–¹æ³•ï¼Œ<strong>åˆ é™¤</strong>äº‹åŠ¡ã€‚</li></ul><h2>5.6 æ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡</h2><p>è°ƒç”¨ <code>#enlistParticipant(...)</code> æ–¹æ³•ï¼Œæ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡ã€‚è¯¥æ–¹æ³•åœ¨<strong>äº‹åŠ¡å¤„äº Try é˜¶æ®µ</strong>è¢«è°ƒç”¨ï¼Œåœ¨<a href="#">ã€Œ6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨ã€</a>æœ‰è¯¦ç»†è§£æã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> participant å‚ä¸è€…</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enlistParticipant</span><span class="params">(Participant participant)</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å– äº‹åŠ¡</span></div><div class="line">   Transaction transaction = <span class="keyword">this</span>.getCurrentTransaction();</div><div class="line">   <span class="comment">// æ·»åŠ å‚ä¸è€…</span></div><div class="line">   transaction.enlistParticipant(participant);</div><div class="line">   <span class="comment">// æ›´æ–° äº‹åŠ¡</span></div><div class="line">   transactionRepository.update(transaction);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#getCurrentTransaction()</code> æ–¹æ³•ï¼Œè·å–äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>Transaction#enlistParticipant(...)</code> æ–¹æ³•ï¼Œ æ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>TransactionRepository#update(...)</code> æ–¹æ³•ï¼Œ <strong>æ›´æ–°</strong>äº‹åŠ¡ã€‚</li></ul><h1>6. äº‹åŠ¡æ‹¦æˆªå™¨</h1><p>TCC-Transaction åŸºäº <code>org.mengyun.tcctransaction.api.@Compensable</code> + <code>org.aspectj.lang.annotation.@Aspect</code> <strong>æ³¨è§£</strong> <strong>AOP åˆ‡é¢</strong>å®ç°ä¸šåŠ¡æ–¹æ³•çš„ TCC äº‹åŠ¡å£°æ˜<strong>æ‹¦æˆª</strong>ï¼ŒåŒ Spring çš„ <code>org.springframework.transaction.annotation.@Transactional</code> çš„å®ç°ã€‚</p><p>TCC-Transaction æœ‰ä¸¤ä¸ªæ‹¦æˆªå™¨ï¼š</p><ul><li><code>org.mengyun.tcctransaction.interceptor.CompensableTransactionInterceptor</code>ï¼Œå¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ã€‚</li><li><code>org.mengyun.tcctransaction.interceptor.ResourceCoordinatorInterceptor</code>ï¼Œèµ„æºåè°ƒè€…æ‹¦æˆªå™¨ã€‚</li></ul><p>åœ¨åˆ†äº«æ‹¦æˆªå™¨çš„å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä¸€èµ·çœ‹çœ‹ @Compensable æ³¨è§£ã€‚</p><h2>6.1 Compensable</h2><p>@Compensableï¼Œæ ‡è®°å¯è¡¥å¿çš„æ–¹æ³•æ³¨è§£ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Compensable &#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä¼ æ’­çº§åˆ«</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">Propagation <span class="title">propagation</span><span class="params">()</span> <span class="keyword">default</span> Propagation.REQUIRED</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ–¹æ³•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">String <span class="title">confirmMethod</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ–¹æ³•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">String <span class="title">cancelMethod</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Class&lt;? extends TransactionContextEditor&gt; transactionContextEditor() <span class="keyword">default</span> DefaultTransactionContextEditor.class;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>propagationï¼Œä¼ æ’­çº§åˆ«( Propagation )ï¼Œé»˜è®¤ Propagation.REQUIREDã€‚å’Œ Spring çš„ Propagation é™¤äº†ç¼ºå°‘å‡ ä¸ªå±æ€§ï¼ŒåŸºæœ¬ä¸€è‡´ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Propagation &#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æ–°å»ºä¸€ä¸ªäº‹åŠ¡ã€‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    REQUIRED(<span class="number">0</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œã€‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    SUPPORTS(<span class="number">1</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æŠ›å‡ºå¼‚å¸¸ã€‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    MANDATORY(<span class="number">2</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ–°å»ºäº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    REQUIRES_NEW(<span class="number">3</span>);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> value;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>confirmMethodï¼Œç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ–¹æ³•åã€‚</p></li><li><p>cancelMethodï¼Œå–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ–¹æ³•åã€‚</p></li><li><p>TransactionContextEditorï¼Œäº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨( TransactionContextEditor )ï¼Œç”¨äºè®¾ç½®å’Œè·å¾—äº‹åŠ¡ä¸Šä¸‹æ–‡( TransactionContext )ï¼Œåœ¨<a href="#">ã€Œ6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨ã€</a>å¯ä»¥çœ‹åˆ°è¢«è°ƒç”¨ï¼Œæ­¤å¤„åªçœ‹å®ƒçš„ä»£ç å®ç°ã€‚<code>org.mengyun.tcctransaction.api.TransactionContextEditor</code> æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionContextEditor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»å‚æ•°ä¸­è·å¾—äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> target å¯¹è±¡</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> method æ–¹æ³•</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> args å‚æ•°</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">TransactionContext <span class="title">get</span><span class="params">(Object target, Method method, Object[] args)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®¾ç½®äº‹åŠ¡ä¸Šä¸‹æ–‡åˆ°å‚æ•°ä¸­</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> transactionContext äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> target å¯¹è±¡</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> method æ–¹æ³•</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> args å‚æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(TransactionContext transactionContext, Object target, Method method, Object[] args)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>DefaultTransactionContextEditorï¼Œ<strong>é»˜è®¤</strong>äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨å®ç°ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DefaultTransactionContextEditor</span> <span class="keyword">implements</span> <span class="title">TransactionContextEditor</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> TransactionContext <span class="title">get</span><span class="params">(Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> position = getTransactionContextParamPosition(method.getParameterTypes());</div><div class="line">        <span class="keyword">if</span> (position &gt;= <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> (TransactionContext) args[position];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(TransactionContext transactionContext, Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> position = getTransactionContextParamPosition(method.getParameterTypes());</div><div class="line">        <span class="keyword">if</span> (position &gt;= <span class="number">0</span>) &#123;</div><div class="line">            args[position] = transactionContext; <span class="comment">// è®¾ç½®æ–¹æ³•å‚æ•°</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·å¾—äº‹åŠ¡ä¸Šä¸‹æ–‡åœ¨æ–¹æ³•å‚æ•°é‡Œçš„ä½ç½®</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> parameterTypes å‚æ•°ç±»å‹é›†åˆ</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> ä½ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getTransactionContextParamPosition</span><span class="params">(Class&lt;?&gt;[] parameterTypes)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> position = -<span class="number">1</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterTypes.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (parameterTypes[i].equals(org.mengyun.tcctransaction.api.TransactionContext.class)) &#123;</div><div class="line">                position = i;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> position;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>NullableTransactionContextEditorï¼Œæ— äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨å®ç°ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">NullableTransactionContextEditor</span> <span class="keyword">implements</span> <span class="title">TransactionContextEditor</span> </span>&#123;</div><div class="line">    </div><div class="line">     <span class="meta">@Override</span></div><div class="line">     <span class="function"><span class="keyword">public</span> TransactionContext <span class="title">get</span><span class="params">(Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">     &#125;</div><div class="line">    </div><div class="line">     <span class="meta">@Override</span></div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(TransactionContext transactionContext, Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p></li><li><p>DubboTransactionContextEditorï¼ŒDubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨å®ç°ï¼Œé€šè¿‡ Dubbo éšå¼ä¼ å‚æ–¹å¼è·å¾—äº‹åŠ¡ä¸Šä¸‹æ–‡ï¼Œåœ¨<a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/?self">ã€ŠTCC-Transaction æºç è§£æ â€”â€” Dubbo æ”¯æŒã€‹</a>è¯¦ç»†è§£æã€‚</p></li></ul></li></ul><h2>6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨</h2><p>å…ˆä¸€èµ·æ¥çœ‹ä¸‹å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨å¯¹åº”çš„åˆ‡é¢ <code>org.mengyun.tcctransaction.interceptor.CompensableTransactionAspect</code>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CompensableTransactionAspect</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> CompensableTransactionInterceptor compensableTransactionInterceptor;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCompensableTransactionInterceptor</span><span class="params">(CompensableTransactionInterceptor compensableTransactionInterceptor)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.compensableTransactionInterceptor = compensableTransactionInterceptor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(org.mengyun.tcctransaction.api.Compensable)"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">compensableService</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Around</span>(<span class="string">"compensableService()"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interceptCompensableMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="keyword">return</span> compensableTransactionInterceptor.interceptCompensableMethod(pjp);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>é€šè¿‡ <code>org.aspectj.lang.annotation.@Pointcut</code> + <code>org.aspectj.lang.annotation.@Around</code> æ³¨è§£ï¼Œé…ç½®å¯¹ <strong>@Compensable æ³¨è§£çš„æ–¹æ³•</strong>è¿›è¡Œæ‹¦æˆªï¼Œè°ƒç”¨ <code>CompensableTransactionInterceptor#interceptCompensableMethod(...)</code> æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</li></ul><p><strong>CompensableTransactionInterceptor å®ç°ä»£ç å¦‚ä¸‹</strong>ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompensableTransactionInterceptor</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> TransactionManager transactionManager;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Set&lt;Class&lt;? extends Exception&gt;&gt; delayCancelExceptions;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interceptCompensableMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="comment">// è·å¾—å¸¦ @Compensable æ³¨è§£çš„æ–¹æ³•</span></div><div class="line">        Method method = CompensableMethodUtils.getCompensableMethod(pjp);</div><div class="line">        <span class="comment">//</span></div><div class="line">        Compensable compensable = method.getAnnotation(Compensable.class);</div><div class="line">        Propagation propagation = compensable.propagation();</div><div class="line">        <span class="comment">// è·å¾— äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line">        TransactionContext transactionContext = FactoryBuilder.factoryOf(compensable.transactionContextEditor()).getInstance().get(pjp.getTarget(), method, pjp.getArgs());</div><div class="line">        <span class="comment">// å½“å‰çº¿ç¨‹æ˜¯å¦åœ¨äº‹åŠ¡ä¸­</span></div><div class="line">        <span class="keyword">boolean</span> isTransactionActive = transactionManager.isTransactionActive();</div><div class="line">        <span class="comment">// åˆ¤æ–­äº‹åŠ¡ä¸Šä¸‹æ–‡æ˜¯å¦åˆæ³•</span></div><div class="line">        <span class="keyword">if</span> (!TransactionUtils.isLegalTransactionContext(isTransactionActive, propagation, transactionContext)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"no active compensable transaction while propagation is mandatory for method "</span> + method.getName());</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// è®¡ç®—æ–¹æ³•ç±»å‹</span></div><div class="line">        MethodType methodType = CompensableMethodUtils.calculateMethodType(propagation, isTransactionActive, transactionContext);</div><div class="line">        <span class="comment">// å¤„ç†</span></div><div class="line">        <span class="keyword">switch</span> (methodType) &#123;</div><div class="line">            <span class="keyword">case</span> ROOT:</div><div class="line">                <span class="keyword">return</span> rootMethodProceed(pjp);</div><div class="line">            <span class="keyword">case</span> PROVIDER:</div><div class="line">                <span class="keyword">return</span> providerMethodProceed(pjp, transactionContext);</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">return</span> pjp.proceed();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>CompensableMethodUtils#getCompensableMethod(...)</code> æ–¹æ³•ï¼Œè·å¾—å¸¦ @Compensable æ³¨è§£çš„æ–¹æ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CompensableMethodUtils.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å¾—å¸¦ <span class="doctag">@Compensable</span> æ³¨è§£çš„æ–¹æ³•</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> pjp åˆ‡é¢ç‚¹</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ–¹æ³•</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Method <span class="title">getCompensableMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> </span>&#123;</div><div class="line">   Method method = ((MethodSignature) (pjp.getSignature())).getMethod(); <span class="comment">// ä»£ç†æ–¹æ³•å¯¹è±¡</span></div><div class="line">   <span class="keyword">if</span> (method.getAnnotation(Compensable.class) == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           method = pjp.getTarget().getClass().getMethod(method.getName(), method.getParameterTypes()); <span class="comment">// å®é™…æ–¹æ³•å¯¹è±¡</span></div><div class="line">       &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> method;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>TransactionContextEditor#get(...)</code> æ–¹æ³•ï¼Œä»å‚æ•°ä¸­è·å¾—äº‹åŠ¡ä¸Šä¸‹æ–‡ã€‚<strong>ä¸ºä»€ä¹ˆä»å‚æ•°ä¸­å¯ä»¥è·å¾—äº‹åŠ¡ä¸Šä¸‹æ–‡å‘¢</strong>ï¼Ÿåœ¨<a href="#">ã€Œ6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨ã€</a>æ­æ™“ç­”æ¡ˆã€‚</p></li><li><p>è°ƒç”¨ <code>TransactionManager#isTransactionActive()</code> æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹æ˜¯å¦åœ¨äº‹åŠ¡ä¸­ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionManager.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt; CURRENT = <span class="keyword">new</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTransactionActive</span><span class="params">()</span> </span>&#123;</div><div class="line">   Deque&lt;Transaction&gt; transactions = CURRENT.get();</div><div class="line">   <span class="keyword">return</span> transactions != <span class="keyword">null</span> &amp;&amp; !transactions.isEmpty();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>TransactionUtils#isLegalTransactionContext(...)</code> æ–¹æ³•ï¼Œåˆ¤æ–­äº‹åŠ¡ä¸Šä¸‹æ–‡æ˜¯å¦åˆæ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionUtils.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ¤æ–­äº‹åŠ¡ä¸Šä¸‹æ–‡æ˜¯å¦åˆæ³•</span></div><div class="line"><span class="comment">* åœ¨ Propagation.MANDATORY å¿…é¡»æœ‰åœ¨äº‹åŠ¡å†…</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> isTransactionActive æ˜¯å¦</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> propagation ä¼ æ’­çº§åˆ«</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionContext äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ˜¯å¦åˆæ³•</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isLegalTransactionContext</span><span class="params">(<span class="keyword">boolean</span> isTransactionActive, Propagation propagation, TransactionContext transactionContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (propagation.equals(Propagation.MANDATORY) &amp;&amp; !isTransactionActive &amp;&amp; transactionContext == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å½“ä¼ æ’­çº§åˆ«ä¸º Propagation.MANDATORY æ—¶ï¼Œè¦æ±‚å¿…é¡»åœ¨äº‹åŠ¡ä¸­ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>CompensableMethodUtils#calculateMethodType(...)</code> æ–¹æ³•ï¼Œè®¡ç®—æ–¹æ³•ç±»å‹ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è®¡ç®—æ–¹æ³•ç±»å‹</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> propagation ä¼ æ’­çº§åˆ«</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> isTransactionActive æ˜¯å¦äº‹åŠ¡å¼€å¯</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionContext äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ–¹æ³•ç±»å‹</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MethodType <span class="title">calculateMethodType</span><span class="params">(Propagation propagation, <span class="keyword">boolean</span> isTransactionActive, TransactionContext transactionContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> ((propagation.equals(Propagation.REQUIRED) &amp;&amp; !isTransactionActive &amp;&amp; transactionContext == <span class="keyword">null</span>) <span class="comment">// Propagation.REQUIREDï¼šæ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æ–°å»ºä¸€ä¸ªäº‹åŠ¡ã€‚</span></div><div class="line">           || propagation.equals(Propagation.REQUIRES_NEW)) &#123; <span class="comment">// Propagation.REQUIRES_NEWï¼šæ–°å»ºäº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚</span></div><div class="line">       <span class="keyword">return</span> MethodType.ROOT;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((propagation.equals(Propagation.REQUIRED) <span class="comment">// Propagation.REQUIREDï¼šæ”¯æŒå½“å‰äº‹åŠ¡</span></div><div class="line">               || propagation.equals(Propagation.MANDATORY)) <span class="comment">// Propagation.MANDATORYï¼šæ”¯æŒå½“å‰äº‹åŠ¡</span></div><div class="line">           &amp;&amp; !isTransactionActive &amp;&amp; transactionContext != <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span> MethodType.PROVIDER;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">return</span> MethodType.NORMAL;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è®¡ç®—æ–¹æ³•ç±»å‹( MethodType )çš„ç›®çš„ï¼Œå¯ä»¥æ ¹æ®ä¸åŒæ–¹æ³•ç±»å‹ï¼Œåšä¸åŒçš„äº‹åŠ¡å¤„ç†ã€‚</li><li>æ–¹æ³•ç±»å‹ä¸º MethodType.ROOT æ—¶ï¼Œå‘èµ·<strong>æ ¹äº‹åŠ¡</strong>ï¼Œåˆ¤æ–­æ¡ä»¶å¦‚ä¸‹äºŒé€‰ä¸€ï¼š<ul><li>äº‹åŠ¡ä¼ æ’­çº§åˆ«ä¸º Propagation.REQUIREDï¼Œå¹¶ä¸”å½“å‰æ²¡æœ‰äº‹åŠ¡ã€‚</li><li>äº‹åŠ¡ä¼ æ’­çº§åˆ«ä¸º Propagation.REQUIRES_NEWï¼Œæ–°å»ºäº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚<strong>æ­¤æ—¶ï¼Œäº‹åŠ¡ç®¡ç†å™¨çš„å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—å¯èƒ½ä¼šå­˜åœ¨å¤šä¸ªäº‹åŠ¡</strong>ã€‚</li></ul></li><li>æ–¹æ³•ç±»å‹ä¸º MethodType.ROOT æ—¶ï¼Œå‘èµ·<strong>åˆ†æ”¯äº‹åŠ¡</strong>ï¼Œåˆ¤æ–­æ¡ä»¶å¦‚ä¸‹äºŒé€‰ä¸€ï¼š<ul><li>äº‹åŠ¡ä¼ æ’­çº§åˆ«ä¸º Propagation.REQUIREDï¼Œå¹¶ä¸”å½“å‰ä¸å­˜åœ¨äº‹åŠ¡ï¼Œ<strong>å¹¶ä¸”æ–¹æ³•å‚æ•°ä¼ é€’äº†äº‹åŠ¡ä¸Šä¸‹æ–‡</strong>ã€‚</li><li>äº‹åŠ¡ä¼ æ’­çº§åˆ«ä¸º Propagation.PROVIDERï¼Œå¹¶ä¸”å½“å‰ä¸å­˜åœ¨äº‹åŠ¡ï¼Œ<strong>å¹¶ä¸”æ–¹æ³•å‚æ•°ä¼ é€’äº†äº‹åŠ¡ä¸Šä¸‹æ–‡</strong>ã€‚</li><li><strong>å½“å‰ä¸å­˜åœ¨äº‹åŠ¡ï¼Œæ–¹æ³•å‚æ•°ä¼ é€’äº†äº‹åŠ¡ä¸Šä¸‹æ–‡æ˜¯ä»€ä¹ˆæ„æ€</strong>ï¼Ÿå½“è·¨æœåŠ¡<strong>è¿œç¨‹</strong>è°ƒç”¨æ—¶ï¼Œè¢«è°ƒç”¨æœåŠ¡æœ¬èº«( <strong>æœåŠ¡æä¾›è€…</strong> )ä¸åœ¨äº‹åŠ¡ä¸­ï¼Œé€šè¿‡ä¼ é€’äº‹åŠ¡ä¸Šä¸‹æ–‡å‚æ•°ï¼Œèå…¥å½“å‰äº‹åŠ¡ã€‚</li></ul></li><li>æ–¹æ³•ç±»å‹ä¸º MethodType.Normal æ—¶ï¼Œä¸è¿›è¡Œäº‹åŠ¡å¤„ç†ã€‚</li><li>MethodType.CONSUMER é¡¹ç›®å·²ç»ä¸å†ä½¿ç”¨ï¼ŒçŒœæµ‹å·²åºŸå¼ƒã€‚</li></ul></li><li><p>å½“æ–¹æ³•ç±»å‹ä¸º MethodType.ROOT æ—¶ï¼Œè°ƒç”¨ <code>#rootMethodProceed(...)</code> æ–¹æ³•ï¼Œå‘èµ· <strong>TCC æ•´ä½“æµç¨‹</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">rootMethodProceed</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">   Object returnValue;</div><div class="line">   Transaction transaction = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// å‘èµ·æ ¹äº‹åŠ¡</span></div><div class="line">       transaction = transactionManager.begin();</div><div class="line">       <span class="comment">// æ‰§è¡Œæ–¹æ³•åŸé€»è¾‘</span></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           returnValue = pjp.proceed();</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable tryingException) &#123;</div><div class="line">           <span class="keyword">if</span> (isDelayCancelException(tryingException)) &#123; <span class="comment">// æ˜¯å¦å»¶è¿Ÿå›æ»š</span></div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               logger.warn(String.format(<span class="string">"compensable transaction trying failed. transaction content:%s"</span>, JSON.toJSONString(transaction)), tryingException);</div><div class="line">               <span class="comment">// å›æ»šäº‹åŠ¡</span></div><div class="line">               transactionManager.rollback();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">throw</span> tryingException;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// æäº¤äº‹åŠ¡</span></div><div class="line">       transactionManager.commit();</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="comment">// å°†äº‹åŠ¡ä»å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ç§»é™¤</span></div><div class="line">       transactionManager.cleanAfterCompletion(transaction);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> returnValue;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#transactionManager()</code> æ–¹æ³•ï¼Œå‘èµ·<strong>æ ¹äº‹åŠ¡</strong>ï¼Œ<strong>TCC Try é˜¶æ®µå¼€å§‹</strong>ã€‚</p></li><li><p>è°ƒç”¨ <code>ProceedingJoinPoint#proceed()</code> æ–¹æ³•ï¼Œæ‰§è¡Œæ–¹æ³•<strong>åŸé€»è¾‘( å³ Try é€»è¾‘ )</strong>ã€‚</p></li><li><p>å½“åŸé€»è¾‘æ‰§è¡Œå¼‚å¸¸æ—¶ï¼Œ<strong>TCC Try é˜¶æ®µå¤±è´¥</strong>ï¼Œè°ƒç”¨ <code>TransactionManager#rollback(...)</code> æ–¹æ³•ï¼Œ<strong>TCC Cancel é˜¶æ®µ</strong>ï¼Œå›æ»šäº‹åŠ¡ã€‚æ­¤å¤„ <code>#isDelayCancelException(...)</code> æ–¹æ³•ï¼Œåˆ¤æ–­å¼‚å¸¸æ˜¯å¦ä¸ºå»¶è¿Ÿå–æ¶ˆå›æ»šå¼‚å¸¸ï¼Œéƒ¨åˆ†å¼‚å¸¸ä¸é€‚åˆç«‹å³å›æ»šäº‹åŠ¡ï¼Œåœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-recovery/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡æ¢å¤ã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>å½“åŸé€»è¾‘æ‰§è¡ŒæˆåŠŸæ—¶ï¼Œ<strong>TCC Try é˜¶æ®µæˆåŠŸ</strong>ï¼Œè°ƒç”¨ <code>TransactionManager#commit(...)</code> æ–¹æ³•ï¼Œ<strong>TCC Confirm é˜¶æ®µ</strong>ï¼Œæäº¤äº‹åŠ¡ã€‚</p></li><li><p>è°ƒç”¨ <code>TransactionManager#cleanAfterCompletion(...)</code> æ–¹æ³•ï¼Œå°†äº‹åŠ¡ä»å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ç§»é™¤ï¼Œé¿å…çº¿ç¨‹å†²çªã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionManager.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanAfterCompletion</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (isTransactionActive() &amp;&amp; transaction != <span class="keyword">null</span>) &#123;</div><div class="line">        Transaction currentTransaction = getCurrentTransaction();</div><div class="line">        <span class="keyword">if</span> (currentTransaction == transaction) &#123;</div><div class="line">            CURRENT.get().pop();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"Illegal transaction when clean after completion"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li></ul></li><li><p>å½“æ–¹æ³•ç±»å‹ä¸º Propagation.PROVIDER æ—¶ï¼ŒæœåŠ¡æä¾›è€…å‚ä¸ <strong>TCC æ•´ä½“æµç¨‹</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">providerMethodProceed</span><span class="params">(ProceedingJoinPoint pjp, TransactionContext transactionContext)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">   Transaction transaction = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">switch</span> (TransactionStatus.valueOf(transactionContext.getStatus())) &#123;</div><div class="line">           <span class="keyword">case</span> TRYING:</div><div class="line">               <span class="comment">// ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡</span></div><div class="line">               transaction = transactionManager.propagationNewBegin(transactionContext);</div><div class="line">               <span class="keyword">return</span> pjp.proceed();</div><div class="line">           <span class="keyword">case</span> CONFIRMING:</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">// ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡</span></div><div class="line">                   transaction = transactionManager.propagationExistBegin(transactionContext);</div><div class="line">                   <span class="comment">// æäº¤äº‹åŠ¡</span></div><div class="line">                   transactionManager.commit();</div><div class="line">               &#125; <span class="keyword">catch</span> (NoExistedTransactionException excepton) &#123;</div><div class="line">                   <span class="comment">//the transaction has been commit,ignore it.</span></div><div class="line">               &#125;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> CANCELLING:</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">// ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡</span></div><div class="line">                   transaction = transactionManager.propagationExistBegin(transactionContext);</div><div class="line">                   <span class="comment">// å›æ»šäº‹åŠ¡</span></div><div class="line">                   transactionManager.rollback();</div><div class="line">               &#125; <span class="keyword">catch</span> (NoExistedTransactionException exception) &#123;</div><div class="line">                   <span class="comment">//the transaction has been rollback,ignore it.</span></div><div class="line">               &#125;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="comment">// å°†äº‹åŠ¡ä»å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ç§»é™¤</span></div><div class="line">       transactionManager.cleanAfterCompletion(transaction);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è¿”å›ç©ºå€¼</span></div><div class="line">   Method method = ((MethodSignature) (pjp.getSignature())).getMethod();</div><div class="line">   <span class="keyword">return</span> ReflectionUtils.getNullValue(method.getReturnType());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>å½“äº‹åŠ¡å¤„äº TransactionStatus.TRYING æ—¶ï¼Œè°ƒç”¨ <code>TransactionManager#propagationExistBegin(...)</code> æ–¹æ³•ï¼Œä¼ æ’­å‘èµ·<strong>åˆ†æ”¯</strong>äº‹åŠ¡ã€‚å‘èµ·<strong>åˆ†æ”¯</strong>äº‹åŠ¡å®Œæˆåï¼Œè°ƒç”¨ <code>ProceedingJoinPoint#proceed()</code> æ–¹æ³•ï¼Œæ‰§è¡Œæ–¹æ³•<strong>åŸé€»è¾‘( å³ Try é€»è¾‘ )</strong>ã€‚</p><ul><li><strong>ä¸ºä»€ä¹ˆè¦ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡</strong>ï¼Ÿåœ¨<strong>æ ¹äº‹åŠ¡</strong>è¿›è¡Œ Confirm / Cancel æ—¶ï¼Œè°ƒç”¨<strong>æ ¹äº‹åŠ¡</strong>ä¸Šçš„å‚ä¸è€…ä»¬æäº¤æˆ–å›æ»šäº‹åŠ¡æ—¶ï¼Œè¿›è¡Œè¿œç¨‹æœåŠ¡æ–¹æ³•è°ƒç”¨çš„å‚ä¸è€…ï¼Œå¯ä»¥é€šè¿‡è‡ªå·±çš„äº‹åŠ¡ç¼–å·å…³è”ä¸Šä¼ æ’­çš„<strong>åˆ†æ”¯</strong>äº‹åŠ¡( ä¸¤è€…çš„äº‹åŠ¡ç¼–å·ç›¸ç­‰ )ï¼Œè¿›è¡Œäº‹åŠ¡çš„æäº¤æˆ–å›æ»šã€‚</li></ul></li><li><p>å½“äº‹åŠ¡å¤„äº TransactionStatus.CONFIRMING æ—¶ï¼Œè°ƒç”¨ <code>TransactionManager#commit()</code> æ–¹æ³•ï¼Œæäº¤äº‹åŠ¡ã€‚</p></li><li><p>å½“äº‹åŠ¡å¤„äº TransactionStatus.CANCELLING æ—¶ï¼Œè°ƒç”¨ <code>TransactionManager#rollback()</code> æ–¹æ³•ï¼Œæäº¤äº‹åŠ¡ã€‚</p></li><li><p>è°ƒç”¨ <code>TransactionManager#cleanAfterCompletion(...)</code> æ–¹æ³•ï¼Œå°†äº‹åŠ¡ä»å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ç§»é™¤ï¼Œé¿å…çº¿ç¨‹å†²çªã€‚</p></li><li><p>å½“äº‹åŠ¡å¤„äº TransactionStatus.CONFIRMING / TransactionStatus.CANCELLING æ—¶ï¼Œè°ƒç”¨ <code>ReflectionUtils#getNullValue(...)</code> æ–¹æ³•ï¼Œè¿”å›ç©ºå€¼ã€‚<strong>ä¸ºä»€ä¹ˆè¿”å›ç©ºå€¼</strong>ï¼ŸConfirm / Cancel ç›¸å…³æ–¹æ³•ï¼Œæ˜¯é€šè¿‡ AOP åˆ‡é¢è°ƒç”¨ï¼Œåªè°ƒç”¨ï¼Œä¸å¤„ç†è¿”å›å€¼ï¼Œä½†æ˜¯åˆä¸èƒ½æ²¡æœ‰è¿”å›å€¼ï¼Œå› æ­¤ç›´æ¥è¿”å›ç©ºã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getNullValue</span><span class="params">(Class type)</span> </span>&#123;</div><div class="line">   <span class="comment">// å¤„ç†åŸºæœ¬ç±»å‹</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">boolean</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">byte</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">short</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">int</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">long</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">float</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">double</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å¤„ç†å¯¹è±¡</span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul></li><li><p>å½“æ–¹æ³•ç±»å‹ä¸º Propagation.NORMAL æ—¶ï¼Œæ‰§è¡Œæ–¹æ³•åŸé€»è¾‘ï¼Œ<strong>ä¸è¿›è¡Œäº‹åŠ¡å¤„ç†</strong>ã€‚</p></li></ul><h2>6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨</h2><p>å…ˆä¸€èµ·æ¥çœ‹ä¸‹èµ„æºåè°ƒè€…æ‹¦æˆªå™¨  å¯¹åº”çš„åˆ‡é¢ <code>org.mengyun.tcctransaction.interceptor.CompensableTransactionAspect</code>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceCoordinatorAspect</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ResourceCoordinatorInterceptor resourceCoordinatorInterceptor;</div><div class="line"></div><div class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(org.mengyun.tcctransaction.api.Compensable)"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transactionContextCall</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Around</span>(<span class="string">"transactionContextCall()"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interceptTransactionContextMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="keyword">return</span> resourceCoordinatorInterceptor.interceptTransactionContextMethod(pjp);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResourceCoordinatorInterceptor</span><span class="params">(ResourceCoordinatorInterceptor resourceCoordinatorInterceptor)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.resourceCoordinatorInterceptor = resourceCoordinatorInterceptor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>é€šè¿‡ <code>org.aspectj.lang.annotation.@Pointcut</code> + <code>org.aspectj.lang.annotation.@Around</code> æ³¨è§£ï¼Œé…ç½®å¯¹ <strong>@Compensable æ³¨è§£çš„æ–¹æ³•</strong>è¿›è¡Œæ‹¦æˆªï¼Œè°ƒç”¨ <code>ResourceCoordinatorInterceptor#interceptTransactionContextMethod(...)</code> æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</li></ul><p><strong>ResourceCoordinatorInterceptor å®ç°ä»£ç å¦‚ä¸‹</strong>ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceCoordinatorInterceptor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> TransactionManager transactionManager;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interceptTransactionContextMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        Transaction transaction = transactionManager.getCurrentTransaction();</div><div class="line">        <span class="keyword">if</span> (transaction != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">switch</span> (transaction.getStatus()) &#123;</div><div class="line">                <span class="keyword">case</span> TRYING:</div><div class="line">                    <span class="comment">// æ·»åŠ äº‹åŠ¡å‚ä¸è€…</span></div><div class="line">                    enlistParticipant(pjp);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> CONFIRMING:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> CANCELLING:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// æ‰§è¡Œæ–¹æ³•åŸé€»è¾‘</span></div><div class="line">        <span class="keyword">return</span> pjp.proceed(pjp.getArgs());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å½“äº‹åŠ¡å¤„äº TransactionStatus.TRYING æ—¶ï¼Œè°ƒç”¨ <code>#enlistParticipant(...)</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡å‚ä¸è€…ã€‚</li><li>è°ƒç”¨ <code>ProceedingJoinPoint#proceed(...)</code> æ–¹æ³•ï¼Œæ‰§è¡Œæ–¹æ³•åŸé€»è¾‘ã€‚</li></ul><p><strong><code>ResourceCoordinatorInterceptor#enlistParticipant()</code> å®ç°ä»£ç å¦‚ä¸‹</strong>ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enlistParticipant</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> IllegalAccessException, InstantiationException </span>&#123;</div><div class="line">   <span class="comment">// è·å¾— @Compensable æ³¨è§£</span></div><div class="line">   Method method = CompensableMethodUtils.getCompensableMethod(pjp);</div><div class="line">   <span class="keyword">if</span> (method == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(String.format(<span class="string">"join point not found method, point is : %s"</span>, pjp.getSignature().getName()));</div><div class="line">   &#125;</div><div class="line">   Compensable compensable = method.getAnnotation(Compensable.class);</div><div class="line">   <span class="comment">// è·å¾— ç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ–¹æ³• å’Œ å–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ–¹æ³•</span></div><div class="line">   String confirmMethodName = compensable.confirmMethod();</div><div class="line">   String cancelMethodName = compensable.cancelMethod();</div><div class="line">   <span class="comment">// è·å– å½“å‰çº¿ç¨‹äº‹åŠ¡ç¬¬ä¸€ä¸ª(å¤´éƒ¨)å…ƒç´ </span></div><div class="line">   Transaction transaction = transactionManager.getCurrentTransaction();</div><div class="line">   <span class="comment">// åˆ›å»º äº‹åŠ¡ç¼–å·</span></div><div class="line">   TransactionXid xid = <span class="keyword">new</span> TransactionXid(transaction.getXid().getGlobalTransactionId());</div><div class="line">   <span class="comment">// TODO</span></div><div class="line">   <span class="keyword">if</span> (FactoryBuilder.factoryOf(compensable.transactionContextEditor()).getInstance().get(pjp.getTarget(), method, pjp.getArgs()) == <span class="keyword">null</span>) &#123;</div><div class="line">       FactoryBuilder.factoryOf(compensable.transactionContextEditor()).getInstance().set(<span class="keyword">new</span> TransactionContext(xid, TransactionStatus.TRYING.getId()), pjp.getTarget(), ((MethodSignature) pjp.getSignature()).getMethod(), pjp.getArgs());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è·å¾—ç±»</span></div><div class="line">   Class targetClass = ReflectionUtils.getDeclaringType(pjp.getTarget().getClass(), method.getName(), method.getParameterTypes());</div><div class="line">   <span class="comment">// åˆ›å»º ç¡®è®¤æ‰§è¡Œæ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡ å’Œ å–æ¶ˆæ‰§è¡Œæ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡</span></div><div class="line">   InvocationContext confirmInvocation = <span class="keyword">new</span> InvocationContext(targetClass,</div><div class="line">           confirmMethodName,</div><div class="line">           method.getParameterTypes(), pjp.getArgs());</div><div class="line">   InvocationContext cancelInvocation = <span class="keyword">new</span> InvocationContext(targetClass,</div><div class="line">           cancelMethodName,</div><div class="line">           method.getParameterTypes(), pjp.getArgs());</div><div class="line">   <span class="comment">// åˆ›å»º äº‹åŠ¡å‚ä¸è€…</span></div><div class="line">   Participant participant =</div><div class="line">           <span class="keyword">new</span> Participant(</div><div class="line">                   xid,</div><div class="line">                   confirmInvocation,</div><div class="line">                   cancelInvocation,</div><div class="line">                   compensable.transactionContextEditor());</div><div class="line">   <span class="comment">// æ·»åŠ  äº‹åŠ¡å‚ä¸è€… åˆ° äº‹åŠ¡</span></div><div class="line">   transactionManager.enlistParticipant(participant);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>CompensableMethodUtils#getCompensableMethod(...)</code> æ–¹æ³•ï¼Œè·å¾—å¸¦ @Compensable æ³¨è§£çš„æ–¹æ³•ã€‚</p></li><li><p>è°ƒç”¨ <code>#getCurrentTransaction()</code> æ–¹æ³•ï¼Œ è·å–äº‹åŠ¡ã€‚</p></li><li><p>è°ƒç”¨ TransactionXid æ„é€ æ–¹æ³•ï¼Œåˆ›å»º<strong>åˆ†æ”¯</strong>äº‹åŠ¡ç¼–å·ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * å…¨å±€äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] globalTransactionId;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * åˆ†æ”¯äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] branchQualifier;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">TransactionXid</span><span class="params">(<span class="keyword">byte</span>[] globalTransactionId)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.globalTransactionId = globalTransactionId;</div><div class="line">   branchQualifier = uuidToByteArray(UUID.randomUUID()); <span class="comment">// ç”Ÿæˆ åˆ†æ”¯äº‹åŠ¡ç¼–å·</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>åˆ†æ”¯äº‹åŠ¡ç¼–å·( <code>branchQualifier</code> ) éœ€è¦ç”Ÿæˆã€‚</li></ul></li><li><p>TODO TransactionContext å’Œ Participant çš„å…³ç³»ã€‚</p></li><li><p>è°ƒç”¨ <code>ReflectionUtils#getDeclaringType(...)</code> æ–¹æ³•ï¼Œè·å¾—å£°æ˜ @Compensable æ–¹æ³•çš„å®é™…ç±»ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Class <span class="title">getDeclaringType</span><span class="params">(Class aClass, String methodName, Class&lt;?&gt;[] parameterTypes)</span> </span>&#123;</div><div class="line">   Method method;</div><div class="line">   Class findClass = aClass;</div><div class="line">   <span class="keyword">do</span> &#123;</div><div class="line">       Class[] clazzes = findClass.getInterfaces();</div><div class="line">       <span class="keyword">for</span> (Class clazz : clazzes) &#123;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               method = clazz.getDeclaredMethod(methodName, parameterTypes);</div><div class="line">           &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">               method = <span class="keyword">null</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (method != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">return</span> clazz;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       findClass = findClass.getSuperclass();</div><div class="line">   &#125; <span class="keyword">while</span> (!findClass.equals(Object.class));</div><div class="line">   <span class="keyword">return</span> aClass;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ InvocationContext æ„é€ æ–¹æ³•ï¼Œåˆ†åˆ«åˆ›å»ºç¡®è®¤æ‰§è¡Œæ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡å’Œå–æ¶ˆæ‰§è¡Œæ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç±»</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> Class targetClass;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ–¹æ³•å</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> String methodName;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å‚æ•°ç±»å‹æ•°ç»„</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> Class[] parameterTypes;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å‚æ•°æ•°ç»„</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> Object[] args;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvocationContext</span><span class="params">(Class targetClass, String methodName, Class[] parameterTypes, Object... args)</span> </span>&#123;</div><div class="line">  <span class="keyword">this</span>.methodName = methodName;</div><div class="line">  <span class="keyword">this</span>.parameterTypes = parameterTypes;</div><div class="line">  <span class="keyword">this</span>.targetClass = targetClass;</div><div class="line">  <span class="keyword">this</span>.args = args;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ Participant æ„é€ æ–¹æ³•ï¼Œåˆ›å»ºäº‹åŠ¡å‚ä¸è€…ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Participant</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">4127729421281425247L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> TransactionXid xid;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> InvocationContext confirmInvocationContext;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ–¹æ³•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> InvocationContext cancelInvocationContext;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Terminator terminator = <span class="keyword">new</span> Terminator();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Class&lt;? extends TransactionContextEditor&gt; transactionContextEditorClass;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Participant</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Participant</span><span class="params">(TransactionXid xid, InvocationContext confirmInvocationContext, InvocationContext cancelInvocationContext, Class&lt;? extends TransactionContextEditor&gt; transactionContextEditorClass)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.xid = xid;</div><div class="line">        <span class="keyword">this</span>.confirmInvocationContext = confirmInvocationContext;</div><div class="line">        <span class="keyword">this</span>.cancelInvocationContext = cancelInvocationContext;</div><div class="line">        <span class="keyword">this</span>.transactionContextEditorClass = transactionContextEditorClass;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>TransactionManager#enlistParticipant(...)</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡å‚ä¸è€…åˆ°äº‹åŠ¡ã€‚</p></li></ul><h1>666. å½©è›‹</h1><p>å—é™äºæœ¬äººçš„èƒ½åŠ›ï¼Œè›®å¤šå¤„è¡¨è¾¾ä¸å¤Ÿæ¸…æ™°æˆ–è€…æ˜“æ‡‚ï¼Œéå¸¸æŠ±æ­‰ã€‚å¦‚æœä½ å¯¹ä»»ä½•åœ°æ–¹æœ‰ä»»ä½•ç–‘é—®ï¼Œæ¬¢è¿æ·»åŠ æœ¬äººå¾®ä¿¡å·( wangwenbin-server )ï¼ŒæœŸå¾…ä¸ä½ çš„äº¤æµã€‚ä¸é™äº TCCï¼Œä¹Ÿå¯ä»¥æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä¹Ÿå¯ä»¥æ˜¯å¾®æœåŠ¡ï¼Œä»¥åŠç­‰ç­‰ã€‚</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_08/05.png" alt=""></p><p>å¤–é€ä¸€æœ¬æ­¦æ—ç§˜ç±ï¼šå¸¦ä¸­æ–‡æ³¨é‡Šçš„ TCC-Transaction ä»“åº“åœ°å€ï¼Œç›®å‰æ­£åœ¨æ…¢æ…¢å®Œå–„ã€‚ä¼ é€é—¨ï¼š<a href="https://github.com/YunaiV/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/YunaiV/tcc-transaction</a>ã€‚</p><p>å†é€ä¸€æœ¬è‘µèŠ±å®å…¸ï¼š<a href="https://my.oschina.net/fileoptions/blog/899991" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠTCCå‹åˆ†å¸ƒå¼äº‹åŠ¡åŸç†å’Œå®ç°ã€‹ç³»åˆ—</a>ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. TCC åŸç†&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;3. TCC-Transaction åŸç†&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;4. äº‹åŠ¡ä¸
      
    
    </summary>
    
      <category term="TCC-Transaction" scheme="http://www.iocoder.cn/categories/TCC-Transaction/"/>
    
    
  </entry>
  
  <entry>
    <title>TCC-Transaction æºç åˆ†æ â€”â€” è°ƒè¯•ç¯å¢ƒæ­å»º</title>
    <link href="http://www.iocoder.cn/TCC-Transaction/build-debugging-environment/"/>
    <id>http://www.iocoder.cn/TCC-Transaction/build-debugging-environment/</id>
    <published>2018-01-31T16:00:00.000Z</published>
    <updated>2017-09-09T05:41:29.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><ul><li><a href="#">1. ä¾èµ–å·¥å…·</a></li><li><a href="#">2. æºç æ‹‰å–</a></li><li><a href="#">3. åˆå§‹åŒ–æ•°æ®åº“</a></li><li><a href="#">4. å¯åŠ¨ capital é¡¹ç›®</a></li><li><a href="#">5. å¯åŠ¨ redpacket é¡¹ç›®</a></li><li><a href="#">6. å¯åŠ¨ order é¡¹ç›®</a></li><li><a href="#">7. äº¤æµ</a></li></ul><h1>1. ä¾èµ–å·¥å…·</h1><ul><li>Maven</li><li>Git</li><li>JDK</li><li>MySQL</li><li>IntelliJ IDEA</li></ul><h1>2. æºç æ‹‰å–</h1><p>ä»å®˜æ–¹ä»“åº“ <a href="https://github.com/changmingxie/tcc-transaction.git" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/changmingxie/tcc-transaction.git</a> <code>Fork</code> å‡ºå±äºè‡ªå·±çš„ä»“åº“ã€‚ä¸ºä»€ä¹ˆè¦ <code>Fork</code> ï¼Ÿæ—¢ç„¶å¼€å§‹é˜…è¯»ã€è°ƒè¯•æºç ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå†™ä¸€äº›æ³¨é‡Šï¼Œæœ‰äº†è‡ªå·±çš„ä»“åº“ï¼Œå¯ä»¥è¿›è¡Œè‡ªç”±çš„æäº¤ã€‚ğŸ˜ˆ</p><p>ä½¿ç”¨ <code>IntelliJ IDEA</code> ä» <code>Fork</code> å‡ºæ¥çš„ä»“åº“æ‹‰å–ä»£ç ã€‚æ‹‰å–å®Œæˆåï¼Œ<code>Maven</code> ä¼šä¸‹è½½ä¾èµ–åŒ…ï¼Œå¯èƒ½ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œè€å¿ƒç­‰å¾…ä¸‹ã€‚</p><p>æœ¬æ–‡åŸºäº <code>master-1.2.x</code> åˆ†æ”¯ã€‚</p><h1>3. åˆå§‹åŒ–æ•°æ®åº“</h1><p>å®˜æ–¹æä¾›äº†ä¸¤ä¸ª Demo é¡¹ç›®ä¾‹å­ï¼š</p><ul><li>tcc-transaction-dubbo-sample</li><li>tcc-transaction-http-sample</li></ul><p>è€ƒè™‘åˆ°ä¸æ˜¯æ‰€æœ‰æ‰€æœ‰åŒå­¦éƒ½ä½¿ç”¨è¿‡ Dubbo æœåŠ¡åŒ–æ¡†æ¶ï¼Œæˆ‘ä»¬ä»¥ tcc-transaction-http-sample é¡¹ä¸ºä¾‹å­ã€‚</p><p>æ‰“å¼€ tcc-transaction-http-sample/src/main/dbscripts ç›®å½•ï¼Œæœ‰å››ä¸ª SQL è„šæœ¬æ–‡ä»¶ï¼š</p><ul><li><code>create_db_cap.sql</code> ï¼štcc-transaction-http-capital  é¡¹ç›®æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ã€‚</li><li><code>create_db_ord.sql</code> ï¼štcc-transaction-http-order é¡¹ç›®æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ã€‚</li><li><code>create_db_red.sql</code> ï¼štcc-transaction-http-redpacket é¡¹ç›®æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ã€‚</li><li><code>create_db_tcc.sql</code> ï¼štcc-transaction <strong>åº•å±‚</strong>æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ã€‚</li></ul><p>ç¬”è€…ä½¿ç”¨ Navicat è¿›è¡Œæ•°æ®åº“è„šæœ¬æ‰§è¡Œã€‚ä½¿ç”¨æ–¹å¼ä¸ºï¼šNavicat èœå• Connection -&gt; Execute SQL Fileï¼Œé€‰æ‹©è„šæœ¬æ–‡ä»¶ï¼Œé€ä¸ªæ‰§è¡Œã€‚</p><p>ç›®å‰æ•°æ®åº“è„šæœ¬æœªä½¿ç”¨ <code>USE</code> è¯­å¥é€‰æ‹©å¯¹åº”æ•°æ®åº“ï¼Œæ¯ä¸ªè„šæœ¬éƒ½éœ€è¦è¿›è¡Œæ·»åŠ ã€‚ä»¥ <code>create_db_cap.sql</code> ä¸¾ä¾‹å­ï¼š</p><p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="string">`tcc_cap`</span> <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8 */</span>;</div><div class="line"><span class="comment">-- æ–°å¢ USE</span></div><div class="line"><span class="keyword">USE</span> <span class="string">`tcc_cap`</span>;</div></pre></td></tr></table></figure></p><h1>4. å¯åŠ¨ capital é¡¹ç›®</h1><ol><li><p>ä¿®æ”¹é¡¹ç›®ä¸‹ <code>jdbc.properties</code> æ–‡ä»¶ï¼Œ<strong>å¡«å†™æˆä½ çš„æ•°æ®åº“åœ°å€</strong>ã€‚</p></li><li><p>ä½¿ç”¨ IDEA é…ç½® Tomcat è¿›è¡Œå¯åŠ¨ã€‚è¿™é‡Œè¦æ³¨æ„ä¸‹ï¼š</p><p><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// appcontext-service-provider.xml</div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"httpServer"</span></span></div><div class="line"><span class="tag">     <span class="attr">class</span>=<span class="string">"org.springframework.remoting.support.SimpleHttpServerFactoryBean"</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"contexts"</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">util:map</span>&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"/remoting/CapitalTradeOrderService"</span> <span class="attr">value-ref</span>=<span class="string">"capitalTradeOrderServiceExporter"</span>/&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"/remoting/CapitalAccountService"</span> <span class="attr">value-ref</span>=<span class="string">"capitalAccountServiceExporter"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="name">util:map</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"8081"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p><ul><li>é»˜è®¤å¼€å¯ 8081 ç«¯å£æä¾›æ¥å£æœåŠ¡ã€‚æ‰€ä»¥é…ç½® Tomcat çš„ç«¯å£ä¸èƒ½å†ä½¿ç”¨ 8081ï¼Œé¿å…å†²çªã€‚ä¾‹å¦‚ï¼Œç¬”è€…ä½¿ç”¨ 18081ã€‚</li></ul></li><li><p>è®¿é—® <code>http://127.0.0.1:18081/</code>ï¼Œçœ‹åˆ° &quot;hello tcc transacton http sample capital&quot;ï¼Œä»£è¡¨é¡¹ç›®å¯åŠ¨å®Œæˆã€‚<strong><code>18081</code> ä¸ºä½ å¡«å†™çš„ Tomcat ç«¯å£</strong>ã€‚</p></li></ol><h1>5. å¯åŠ¨ redpacket é¡¹ç›®</h1><p>åŒ tcc-transaction-http-capital é¡¹ç›®ã€‚</p><h1>6. å¯åŠ¨ order é¡¹ç›®</h1><ol><li>ä¿®æ”¹é¡¹ç›®ä¸‹ <code>jdbc.properties</code> æ–‡ä»¶ï¼Œ<strong>å¡«å†™æˆä½ çš„æ•°æ®åº“åœ°å€</strong>ã€‚</li><li>ä½¿ç”¨ IDEA é…ç½® Tomcat è¿›è¡Œå¯åŠ¨ã€‚</li><li>è®¿é—® <code>http://127.0.0.1:8080/</code>ï¼Œçœ‹åˆ° &quot;sample è¯´æ˜...&quot;ï¼Œä»£è¡¨é¡¹ç›®å¯åŠ¨å®Œæˆã€‚<strong><code>8080</code> ä¸ºä½ å¡«å†™çš„ Tomcat ç«¯å£</strong>ã€‚</li><li>ç‚¹å‡» [å•†å“åˆ—è¡¨é“¾æ¥] -&gt; [è´­ä¹°] -&gt; [æ”¯ä»˜]ï¼Œå¦‚æœçœ‹åˆ° &quot;æ”¯ä»˜æˆåŠŸ&quot; æˆ–è€… &quot;æ”¯ä»˜å¤±è´¥&quot;ï¼Œæ­å–œä½ ğŸ‰ï¼Œä½ å·²ç»æˆåŠŸæ­å»ºå®Œä½ çš„è°ƒè¯•ç¯å¢ƒã€‚æ„‰å¿«çš„å¼€å§‹ç©è€æŠŠã€‚</li></ol><h1>666. å½©è›‹</h1><p>è°ƒè¯•ç¯å¢ƒæ­å»ºæ˜¯é˜…è¯»æºç çš„ç¬¬ä¸€æ­¥ï¼Œå¦‚æœä½ ç¢°åˆ°æ— æ³•æ­å»ºæˆåŠŸçš„æƒ…å†µï¼Œè¯·ç»™ç¬”è€…å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> )ç•™è¨€ã€‚ç¬”è€…ä¼šç»™ä½  1:1 çš„é«˜çº§( <strong>æåŸº</strong> )æ”¯æŒã€‚</p><p>å¦å¤–è¿™æ˜¯ä¸€ä¸ªç³»åˆ—æ–‡ï¼Œæœ¬ç³»åˆ—æ›´æ–° TCC-Transaction ï¼Œä¸‹ä¸€ä¸ªç³»åˆ—æ›´æ–° ByteTCC ã€‚å—¨çš®ä¸ï¼Ÿï¼</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_01/01.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
      
    
    </summary>
    
      <category term="TCC-Transaction" scheme="http://www.iocoder.cn/categories/TCC-Transaction/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Cloud æºç åˆ†æ â€”â€” é«˜å¯ç”¨</title>
    <link href="http://www.iocoder.cn/Elastic-Job/cloud-high-availability/"/>
    <id>http://www.iocoder.cn/Elastic-Job/cloud-high-availability/</id>
    <published>2018-01-14T16:00:00.000Z</published>
    <updated>2017-09-07T13:01:19.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. Scheduler é›†ç¾¤</a></li><li><a href="#">3. Scheduler éƒ¨ç½²</a></li><li><a href="#">4. Scheduler æ•…éšœè½¬ç§»</a></li><li><a href="#">5. Scheduler æ•°æ®å­˜å‚¨</a><ul><li><a href="#">5.1 RunningService</a></li><li><a href="#">5.2 ProducerManager</a></li><li><a href="#">5.3 TaskScheduler</a></li></ul></li><li><a href="#">6. Mesos Master å´©æºƒ</a></li><li><a href="#">7. Mesos Slave å´©æºƒ</a></li><li><a href="#">8. Scheduler æ ¸å¯¹</a></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Cloud é«˜å¯ç”¨</strong>ã€‚</p><p>ä¸€ä¸ªé«˜å¯ç”¨çš„ Elastic-Job-Cloud ç»„æˆå¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_15/01.png" alt=""></p><ul><li>Mesos Master é›†ç¾¤</li><li>Mesos Slave é›†ç¾¤</li><li>Zookeeper é›†ç¾¤</li><li>Elastic-Job-Cloud-Scheduler é›†ç¾¤</li><li>Elastic-Job-Cloud-Executor é›†ç¾¤</li></ul><p><strong>æœ¬æ–‡é‡ç‚¹åˆ†äº« Elastic-Job-Cloud-Scheduler å¦‚ä½•å®ç°é«˜å¯ç”¨ã€‚</strong></p><p>Mesos Master / Mesos Slave / Zookeeper é«˜å¯ç”¨ï¼ŒåŒå­¦ä»¬å¯ä»¥è‡ªè¡Œ Google è§£å†³ã€‚Elastic-Job-Cloud-Executor è¿è¡Œåœ¨ Mesos Slave ä¸Šï¼Œé€šè¿‡ Mesos Slave é›†ç¾¤å¤šèŠ‚ç‚¹å®ç°é«˜å¯ç”¨ã€‚</p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><h1>2. Scheduler é›†ç¾¤</h1><p>Elastic-Job-Cloud-Scheduler é€šè¿‡è‡³å°‘ä¸¤ä¸ªèŠ‚ç‚¹å®ç°é›†ç¾¤ã€‚**é›†ç¾¤ä¸­é€šè¿‡ä¸»èŠ‚ç‚¹é€‰ä¸¾ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œåªæœ‰ä¸»èŠ‚ç‚¹æä¾›æœåŠ¡ï¼Œä»å®ä¾‹å¤„äº&quot;å¾…å‘½&quot;çŠ¶æ€ã€‚å½“ä¸»èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œä»èŠ‚ç‚¹ä¼šé€‰ä¸¾å‡ºæ–°çš„ä¸»èŠ‚ç‚¹ç»§ç»­æä¾›æœåŠ¡ã€‚**å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Bootstrap</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="comment">// åˆå§‹åŒ– æ³¨å†Œä¸­å¿ƒ</span></div><div class="line">        CoordinatorRegistryCenter regCenter = <span class="keyword">new</span> ZookeeperRegistryCenter(BootstrapEnvironment.getInstance().getZookeeperConfiguration());</div><div class="line">        regCenter.init();</div><div class="line">        <span class="comment">// åˆå§‹åŒ– Zookeeper é€‰ä¸¾æœåŠ¡</span></div><div class="line">        <span class="keyword">final</span> ZookeeperElectionService electionService = <span class="keyword">new</span> ZookeeperElectionService(</div><div class="line">                BootstrapEnvironment.getInstance().getFrameworkHostPort(), (CuratorFramework) regCenter.getRawClient(), HANode.ELECTION_NODE, <span class="keyword">new</span> SchedulerElectionCandidate(regCenter));</div><div class="line">        electionService.start();</div><div class="line">        <span class="comment">// æŒ‚èµ· ä¸»è¿›ç¨‹</span></div><div class="line">        <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</div><div class="line">        latch.await();</div><div class="line">        <span class="comment">// Hook TODO è²Œä¼¼ä½ç½®ä¸å¯¹ï¼Ÿ</span></div><div class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(<span class="string">"shutdown-hook"</span>) &#123;</div><div class="line">        </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                electionService.stop();</div><div class="line">                latch.countDown();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>Bootstrapï¼ŒElastic-Job-Cloud-Scheduler å¯åŠ¨å™¨ï¼ˆä»¿ä½›åœ¨è¯´åºŸè¯ï¼‰ã€‚</li><li>CoordinatorRegistryCenterï¼Œç”¨äºåè°ƒåˆ†å¸ƒå¼æœåŠ¡çš„æ³¨å†Œä¸­å¿ƒï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/reg-center-zookeeper/?">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li><li>ZookeeperElectionServiceï¼ŒZookeeper é€‰ä¸¾æœåŠ¡ï¼Œæœ¬å°èŠ‚çš„ä¸»è§’ã€‚</li></ul><p>è°ƒç”¨ <code>ZookeeperElectionService#start()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Zookeeper é€‰ä¸¾æœåŠ¡ä»¥å®ç° Elastic-Job-Cloud-Scheduler ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> CountDownLatch leaderLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</div><div class="line">    </div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> LeaderSelector leaderSelector;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZookeeperElectionService</span><span class="params">(<span class="keyword">final</span> String identity, <span class="keyword">final</span> CuratorFramework client, <span class="keyword">final</span> String electionPath, <span class="keyword">final</span> ElectionCandidate electionCandidate)</span> </span>&#123;</div><div class="line">   <span class="comment">// åˆ›å»º LeaderSelector</span></div><div class="line">   leaderSelector = <span class="keyword">new</span> LeaderSelector(client, electionPath, <span class="keyword">new</span> LeaderSelectorListenerAdapter() &#123;</div><div class="line">       </div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">takeLeadership</span><span class="params">(<span class="keyword">final</span> CuratorFramework client)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">           <span class="comment">// ... çœç•¥ã€æš‚æ—¶ã€‘æ— å…³ä»£ç </span></div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line">   <span class="comment">// è®¾ç½®é‡å¤å‚ä¸é€‰ä¸¾ä¸»èŠ‚ç‚¹</span></div><div class="line">   leaderSelector.autoRequeue();</div><div class="line">   <span class="comment">// è®¾ç½®å‚ä¸èŠ‚ç‚¹çš„ç¼–å·</span></div><div class="line">   leaderSelector.setId(identity);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å¼€å§‹é€‰ä¸¾.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">   log.debug(<span class="string">"Elastic job: &#123;&#125; start to elect leadership"</span>, leaderSelector.getId());</div><div class="line">   leaderSelector.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>é€šè¿‡ <a href="https://curator.apache.org/apidocs/org/apache/curator/framework/recipes/leader/LeaderSelector.html" rel="external nofollow noopener noreferrer" target="_blank">Apache Curator LeaderSelector</a> å®ç°åˆ†å¸ƒå¼å¤šèŠ‚ç‚¹é€‰ä¸¾ã€‚</p><blockquote><p>FROM https://curator.apache.org/apidocs/org/apache/curator/framework/recipes/leader/LeaderSelector.html<br>Abstraction to select a &quot;leader&quot; amongst multiple contenders in a group of JMVs connected to a Zookeeper cluster. If a group of N thread/processes contends for leadership, one will be assigned leader until it releases leadership at which time another one from the group will be chosen.<br>Note that this class uses an underlying InterProcessMutex and as a result leader election is &quot;fair&quot; - each user will become leader in the order originally requested (from ZK's point of view).</p></blockquote></li><li><p>è°ƒç”¨ <code>LeaderSelector#autoRequeue()</code> æ–¹æ³•ï¼Œè®¾ç½®é‡å¤å‚ä¸é€‰ä¸¾ä¸»èŠ‚ç‚¹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè‡ªå·±é€‰ä¸¾æˆä¸ºä¸»èŠ‚ç‚¹åï¼Œä¸å†å‚ä¸ä¸‹æ¬¡é€‰ä¸¾ã€‚è®¾ç½®é‡å¤å‚ä¸é€‰ä¸¾ä¸»èŠ‚ç‚¹åï¼Œæ¯æ¬¡é€‰ä¸¾éƒ½ä¼šå‚ä¸ã€‚åœ¨ Elastic-Job-Cloud-Scheduler é‡Œï¼Œæˆ‘ä»¬æ˜¾ç„¶è¦é‡å¤å‚ä¸é€‰ä¸¾ã€‚</p></li><li><p>è°ƒç”¨ <code>LeaderSelector#setId()</code> æ–¹æ³•ï¼Œè®¾ç½®å‚ä¸èŠ‚ç‚¹çš„ç¼–å·ã€‚åœ¨ Elastic-Job-Cloud-Scheduler é‡Œæš‚æ—¶æ²¡æœ‰å®é™…ç”¨é€”ã€‚ç¼–å·ç®—æ³•ä¸º <code>BootstrapEnvironment.getInstance().getFrameworkHostPort()</code>ï¼Œå³ï¼š<code>HOST:PORT</code>ã€‚</p></li><li><p>è°ƒç”¨ <code>#start()</code> æ–¹æ³•ï¼Œå¼€å§‹é€‰ä¸¾ã€‚<strong>å½“è‡ªå·±é€‰ä¸¾ä¸»èŠ‚ç‚¹æˆåŠŸ</strong>ï¼Œå›è°ƒ <code>LeaderSelector#takeLeadership()</code> æ–¹æ³•ã€‚</p></li></ul><p>å›è°ƒ <code>LeaderSelector#takeLeadership()</code> æ–¹æ³•ï¼ŒElastic-Job-Cloud-Scheduler <strong>ä¸»èŠ‚ç‚¹å¼€å§‹é¢†å¯¼çŠ¶æ€</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ZookeeperElectionService.LeaderSelector å†…éƒ¨å®ç°ç±»</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">takeLeadership</span><span class="params">(<span class="keyword">final</span> CuratorFramework client)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    log.info(<span class="string">"Elastic job: &#123;&#125; has leadership"</span>, identity);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// å¼€å§‹é¢†å¯¼çŠ¶æ€</span></div><div class="line">        electionCandidate.startLeadership();</div><div class="line">        <span class="comment">// æŒ‚èµ· è¿›ç¨‹</span></div><div class="line">        leaderLatch.await();</div><div class="line">        log.warn(<span class="string">"Elastic job: &#123;&#125; lost leadership."</span>, identity);</div><div class="line">        <span class="comment">// ç»ˆæ­¢é¢†å¯¼çŠ¶æ€</span></div><div class="line">        electionCandidate.stopLeadership();</div><div class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> JobSystemException exception) &#123;</div><div class="line">        <span class="comment">// å¼‚å¸¸é€€å‡º</span></div><div class="line">        log.error(<span class="string">"Elastic job: Starting error"</span>, exception);</div><div class="line">        System.exit(<span class="number">1</span>);  </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>SchedulerElectionCandidate#startLeadership()</code> æ–¹æ³•ï¼Œå¼€å§‹é¢†å¯¼çŠ¶æ€ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerElectionCandidate.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerElectionCandidate</span> <span class="keyword">implements</span> <span class="title">ElectionCandidate</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CoordinatorRegistryCenter regCenter;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> SchedulerService schedulerService;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SchedulerElectionCandidate</span><span class="params">(<span class="keyword">final</span> CoordinatorRegistryCenter regCenter)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.regCenter = regCenter;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startLeadership</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            schedulerService = <span class="keyword">new</span> SchedulerService(regCenter);</div><div class="line">            schedulerService.start();</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable throwable) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(throwable);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SchedulerService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼å¯åŠ¨.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">   facadeService.start();</div><div class="line">   producerManager.startup();</div><div class="line">   statisticManager.startup();</div><div class="line">   cloudJobConfigurationListener.start();</div><div class="line">   taskLaunchScheduledService.startAsync();</div><div class="line">   restfulService.start();</div><div class="line">   schedulerDriver.start();</div><div class="line">   <span class="keyword">if</span> (env.getFrameworkConfiguration().isEnabledReconcile()) &#123;</div><div class="line">       reconcileService.startAsync();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å½“ Elastic-Job-Cloud-Scheduler <strong>ä¸»èŠ‚ç‚¹</strong>è°ƒç”¨ <code>SchedulerService#start()</code> æ–¹æ³•åï¼Œå„ç§æœåŠ¡åˆå§‹åŒ–å®Œæˆï¼Œç‰¹åˆ«æ˜¯å’Œ Mesos Master çš„è¿æ¥ï¼Œå¯ä»¥æ„‰å¿«çš„è¿›è¡Œä½œä¸šè°ƒåº¦ç­‰ç­‰æœåŠ¡ã€‚</li><li>Elastic-Job-Cloud-Scheduler <strong>ä»èŠ‚ç‚¹</strong>ï¼Œå› ä¸ºæ— æ³•å›è°ƒ <code>LeaderSelector#takeLeadership()</code> æ–¹æ³•ï¼Œå¤„äº&quot;å¾…å‘½&quot;çŠ¶æ€ã€‚å½“ä¸»èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œä»èŠ‚ç‚¹ä¼šé€‰ä¸¾å‡ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œè§¦å‘ <code>LeaderSelector#takeLeadership()</code> æ–¹æ³•å›è°ƒï¼Œç»§ç»­æä¾›æœåŠ¡ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>CountLatch#await()</code> æ–¹æ³•ï¼ŒæŒ‚èµ·<strong>ä¸»èŠ‚ç‚¹</strong> <code>LeaderSelector#takeLeadership()</code> æ–¹æ³•ç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚ä¸ºä»€ä¹ˆè¦è¿›è¡ŒæŒ‚èµ·ï¼Ÿå¦‚æœè°ƒç”¨å®Œè¯¥æ–¹æ³•ï¼Œ<strong>ä¸»èŠ‚ç‚¹</strong>å°±ä¼šè®©å‡º<strong>ä¸»èŠ‚ç‚¹</strong>èº«ä»½ï¼Œè¿™æ ·ä¼šå¯¼è‡´ Elastic-Job-Cloud-Scheduler é›†ç¾¤ä¸æ–­ä¸æ–­ä¸æ–­æ›´æ–°ä¸»èŠ‚ç‚¹ï¼Œæ— æ³•æ­£å¸¸æä¾›æœåŠ¡ã€‚</p></li><li><p>å½“ Elastic-Job-Cloud-Scheduler <strong>ä¸»èŠ‚ç‚¹</strong>å…³é—­æ—¶ï¼Œè§¦å‘ä¸Šæ–‡ä»£ç çœ‹åˆ°çš„ ShutdownHook ï¼Œå…³é—­æœåŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Bootstrap.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Bootstrap</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(<span class="string">"shutdown-hook"</span>) &#123;</div><div class="line">        </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="comment">// åœæ­¢é€‰ä¸¾</span></div><div class="line">                electionService.stop();</div><div class="line">                latch.countDown();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>ElectionService#stop()</code> æ–¹æ³•ï¼Œåœæ­¢é€‰ä¸¾ï¼Œä»è€Œç»ˆæ­¢é¢†å¯¼çŠ¶æ€ï¼Œå…³é—­å„ç§æœåŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ZookeeperElectionService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</div><div class="line">    log.info(<span class="string">"Elastic job: stop leadership election"</span>);</div><div class="line">    <span class="comment">// ç»“æŸ #takeLeadership() æ–¹æ³•çš„è¿›ç¨‹æŒ‚èµ·</span></div><div class="line">    leaderLatch.countDown();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// å…³é—­ LeaderSelector</span></div><div class="line">        leaderSelector.close();</div><div class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ignored) &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SchedulerElectionCandidate.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopLeadership</span><span class="params">()</span> </span>&#123;</div><div class="line">    schedulerService.stop();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SchedulerService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * åœæ­¢è¿è¡Œ.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</div><div class="line">    restfulService.stop();</div><div class="line">    taskLaunchScheduledService.stopAsync();</div><div class="line">    cloudJobConfigurationListener.stop();</div><div class="line">    statisticManager.shutdown();</div><div class="line">    producerManager.shutdown();</div><div class="line">    schedulerDriver.stop(<span class="keyword">true</span>);</div><div class="line">    facadeService.stop();</div><div class="line">    <span class="keyword">if</span> (env.getFrameworkConfiguration().isEnabledReconcile()) &#123;</div><div class="line">        reconcileService.stopAsync();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul></li><li><p>å½“å‘ç”Ÿ JobSystemException å¼‚å¸¸æ—¶ï¼Œå³è°ƒç”¨ <code>SchedulerElectionCandidate#startLeadership()</code> æ–¹æ³•å‘ç”Ÿå¼‚å¸¸( <code>SchedulerElectionCandidate#stopLeadership()</code> å®é™…ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ )ï¼Œè°ƒç”¨ <code>System.exit(1)</code> æ–¹æ³•ï¼ŒElastic-Job-Cloud-Scheduler ä¸»èŠ‚ç‚¹<strong>å¼‚å¸¸å´©æºƒ</strong>ã€‚</p><ul><li>ç›®å‰çŒœæµ‹<strong>å¯èƒ½</strong>æœ‰ç§æƒ…å†µä¼šå¯¼è‡´å¼‚å¸¸å´©æºƒã€‚ï¼ˆ1ï¼‰ä¸€ä¸ª Elastic-Job-Cloud-Scheduler é›†ç¾¤æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ A / Bï¼Œé€šè¿‡é€‰ä¸¾ A æˆä¸ºä¸»èŠ‚ç‚¹ï¼›ï¼ˆ2ï¼‰çªç„¶ Zookeeper é›†ç¾¤å´©æºƒï¼Œæ¢å¤åï¼ŒA èŠ‚ç‚¹é€‰ä¸¾<strong>æ°å¥½</strong>åˆæˆä¸ºä¸»èŠ‚ç‚¹ï¼Œå› ä¸ºæœªè°ƒç”¨ <code>SchedulerElectionCandidate#stopLeadership()</code> å…³é—­åŸæ¥çš„å„ç§æœåŠ¡ï¼Œå¯¼è‡´<strong>å†æ¬¡</strong>è°ƒç”¨ <code>SchedulerElectionCandidate#startLeadership()</code> ä¼šå‘ç”Ÿå¼‚å¸¸ï¼Œä¾‹å¦‚è¯´ RestfulService æœåŠ¡ï¼Œéœ€è¦å ç”¨ä¸€ä¸ªç«¯å£æä¾›æœåŠ¡ï¼Œé‡æ–°åˆå§‹åŒ–ï¼Œä¼šå‘ç”Ÿç«¯å£å†²çªæŠ›å‡ºå¼‚å¸¸ã€‚ç¬”è€…å°è¯•æ¨¡æ‹Ÿï¼Œé€šè¿‡ä¸€ä¸ª Elastic-Job-Cloud-Scheduler + Zookeeper çš„æƒ…å†µï¼Œèƒ½å¤Ÿè§¦å‘è¯¥æƒ…å†µï¼Œæ­¥éª¤å¦‚ä¸‹ï¼šï¼ˆ1ï¼‰Zookeeper å¯åŠ¨ï¼›ï¼ˆ2ï¼‰Elastic-Job-Cloud-Scheduler å¯åŠ¨ï¼Œé€‰ä¸¾æˆä¸ºä¸»èŠ‚ç‚¹ï¼Œæ­£å¸¸åˆå§‹åŒ–ï¼›ï¼ˆ3ï¼‰é‡å¯ Zookeeperï¼›ï¼ˆ4ï¼‰Elastic-Job-Cloud-Scheduler å†æ¬¡é€‰ä¸¾æˆä¸ºä¸»èŠ‚ç‚¹ï¼Œå› ä¸º RestfulService ç«¯å£å†²çªå¼‚å¸¸åˆå§‹åŒ–å´©æºƒã€‚**å¦‚æœçœŸå‡ºç°è¿™ç§æƒ…å†µæ€ä¹ˆåŠå‘¢ï¼Ÿ**åœ¨ã€Œ3. Scheduler éƒ¨ç½²ã€æ­æ™“ç­”æ¡ˆã€‚</li></ul></li></ul><p>Elastic-Job-Lite åœ¨ä¸»èŠ‚ç‚¹é€‰ä¸¾å®ç°æ–¹å¼ä¸Šç•¥æœ‰ä¸åŒï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹<a href="http://www.iocoder.cn/Elastic-Job/election/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‹</a>çš„å®ç°ã€‚</p><h1>3. Scheduler éƒ¨ç½²</h1><p>æ¯”è¾ƒå®¹æ˜“æƒ³åˆ°çš„ä¸€ç§æ–¹å¼ï¼Œé€‰æ‹©å¤šå°ä¸»æœºéƒ¨ç½² Elastic-Job-Cloud-Executor å¤šä¸ªèŠ‚ç‚¹ã€‚</p><p>But...... æˆ‘ä»¬è¦æƒ³ä¸‹ï¼ŒElastic-Job-Cloud-Executor è¿è¡Œåœ¨ Mesos ä¹‹ä¸Šï¼Œå¯ä»¥ä½¿ç”¨ä¸Š Mesos çš„èµ„æºè°ƒåº¦å’Œéƒ¨ç½²æœåŠ¡ã€‚å¼•å…¥ Mesos ä¸Šè‘—åçš„æ¡†æ¶ <a href="https://mesosphere.github.io/marathon/" rel="external nofollow noopener noreferrer" target="_blank">Marathon</a>ã€‚å®ƒå¯ä»¥å¸¦æ¥<strong>æ‰€æœ‰åå°è¿›ç¨‹( ä¾‹å¦‚ï¼ŒElastic-Job-Cloud-Executor )èƒ½å¤Ÿè¿è¡Œåœ¨ä»»æ„æœºå™¨ä¸Šï¼ŒMarathon ä¼šåœ¨åå°å·²æœ‰å®ä¾‹å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨å¯åŠ¨æ–°å®ä¾‹</strong>çš„å¥½å¤„ã€‚æ˜¯ä¸æ˜¯å¾ˆèµ +1024 ï¼Ÿï¼</p><blockquote><p>FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P47<br>Mesos é›†ç¾¤é‡Œçš„å¸¸è§æ–¹æ¡ˆæ˜¯åœ¨ Marathon ä¸Šè¿è¡Œé›†ç¾¤çš„ Mesos æ¡†æ¶ã€‚ä½†æ˜¯ Marathon æœ¬èº«å°±æ˜¯ä¸€ç§ Mesos çš„æ¡†æ¶ï¼é‚£ä¹ˆåœ¨ Marathon ä¸Šè¿è¡Œ Mesos æ¡†æ¶æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿä¸ç”¨è€ƒè™‘å¦‚ä½•å°†æ¯ç§æ¡†æ¶çš„è°ƒåº¦å™¨éƒ¨ç½²åˆ°ç‰¹å®šçš„ä¸»æœºä¸Šå¹¶ä¸”å¤„ç†è¿™äº›ä¸»æœºçš„æ•…éšœï¼ŒMarathon èƒ½å¤Ÿç¡®ä¿æ¡†æ¶çš„è°ƒåº¦å™¨æ€»æ˜¯åœ¨é›†ç¾¤é‡Œçš„æŸå¤„è¿è¡Œç€ã€‚è¿™æ ·å¤§å¹…ç®€åŒ–äº†åœ¨é«˜å¯ç”¨é…ç½®é‡Œéƒ¨ç½²æ–°æ¡†æ¶çš„å¤æ‚åº¦ã€‚</p></blockquote><p>å—¯...... å½“ç„¶ï¼ŒMarathon æˆ‘ä»¬ä¹Ÿè¦åšé«˜å¯ç”¨ã€‚</p><p>ğŸ˜ˆ Marathon åŸæ¥ä¸­æ–‡æ˜¯é©¬æ‹‰æ¾ã€‚å“ˆå“ˆå“ˆï¼Œå¾ˆé€‚åˆçš„åå­—ã€‚</p><h1>4. Scheduler æ•…éšœè½¬ç§»</h1><p>å½“åŸæœ‰ Elastic-Job-Cloud-Scheduler <strong>ä¸»èŠ‚ç‚¹</strong>å´©æºƒæ—¶ï¼Œ<strong>ä»èŠ‚ç‚¹</strong>é‡æ–°è¿›è¡Œä¸»èŠ‚ç‚¹é€‰ä¸¾ï¼Œå®Œæˆæ•…éšœè½¬ç§»ã€‚é‚£ä¹ˆæ­¤æ—¶ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ–°<strong>ä¸»èŠ‚ç‚¹</strong>å¦‚ä½•æ¥ç®¡å·²ç»åœ¨æ‰§è¡Œä¸­çš„ Elastic-Job-Cloud-Executer ä»¬å‘¢ï¼Ÿ</p><p>ç¬¬ä¸€ç§æ–¹æ¡ˆï¼Œå…³é—­åŸæœ‰çš„æ‰€æœ‰ Elastic-Job-Cloud-Executor ä»¬ï¼Œç„¶åé‡æ–°è°ƒåº¦å¯åŠ¨ã€‚æ˜¾ç„¶ï¼Œè¿™ä¸ªæ–¹å¼å¤ªè¿‡æš´åŠ›ã€‚å¦‚æœæœ‰äº›ä½œä¸šä»»åŠ¡è¿è¡Œæ—¶é—´è¾ƒé•¿ï¼Œç›´æ¥ä¸­æ–­ä¸æ˜¯å¾ˆå‹å¥½ã€‚å†æ¯”å¦‚ï¼ŒElastic-Job-Cloud-Scheduler èŠ‚ç‚¹éœ€è¦è¿›è¡Œå‡çº§ï¼Œä¹Ÿå…³é—­ Elastic-Job-Cloud-Executorï¼Œä¹Ÿä¸åˆç†ï¼Œå’Œä½¿ç”¨é«˜å¯ç”¨æ€§é›†ç¾¤æ“ä½œç³»ç»Ÿçš„åˆè¡·æ˜¯èƒŒç¦»çš„ã€‚<strong>è¯¥æ–¹æ¡ˆï¼Œä¸æ¨è</strong>ã€‚</p><p>ç¬¬äºŒç§æ–¹æ¡ˆï¼Œé‡ç”¨<strong>åŸä¸»èŠ‚ç‚¹</strong>çš„ Mesos <strong>FrameworkID</strong>ã€‚åŸç†å¦‚ä¸‹ï¼š</p><blockquote><p>FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P72<br>åœ¨ Mesos é‡Œï¼Œè°ƒåº¦å™¨ç”±å…¶ FrameworkIDã€FrameworkInfo é‡Œçš„å¯é€‰å€¼å”¯ä¸€ç¡®å®šã€‚FrameworkID å¿…é¡»ç”± Mesos åˆ†é…ï¼Œä»è€Œç¡®ä¿å¯¹äºæ¯ä¸ªæ¡†æ¶æ¥è¯´è¯¥å€¼æ˜¯å”¯ä¸€ç¡®å®šçš„ã€‚ç°åœ¨ï¼Œéœ€è¦åœ¨åˆ†é… FrameworkID æ—¶å­˜å‚¨è¯¥å€¼ï¼Œè¿™æ ·æœªæ¥çš„ä¸»å®ä¾‹æ‰å¯ä»¥é‡ç”¨è¯¥å€¼ã€‚</p></blockquote><p>åœ¨ Elastic-Job-Cloud-Scheduler ä½¿ç”¨æ³¨å†Œä¸­å¿ƒ( Zookeeper ) çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${NAMESPACE}/ha/framework_id</code> å­˜å‚¨ FrameworkIDï¼Œå­˜å‚¨å€¼ä¸º <code>${FRAMEWORK_ID}</code>ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p><blockquote><p>[zk: localhost:2181(CONNECTED) 1] get /elastic-job-cloud/ha/framework_idd31e7faa-aa72-4d0a-8941-512984d5af49-0001</p></blockquote><p>è°ƒç”¨ <code>SchedulerService#getSchedulerDriver()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Mesos Scheduler Driver æ—¶ï¼Œä» Zookeeper è·å–æ˜¯å¦å·²ç»å­˜åœ¨ FrameworkIDã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerService.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> SchedulerDriver <span class="title">getSchedulerDriver</span><span class="params">(<span class="keyword">final</span> TaskScheduler taskScheduler, <span class="keyword">final</span> JobEventBus jobEventBus, <span class="keyword">final</span> FrameworkIDService frameworkIDService)</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å– FrameworkID</span></div><div class="line">   Optional&lt;String&gt; frameworkIDOptional = frameworkIDService.fetch();</div><div class="line">   Protos.FrameworkInfo.Builder builder = Protos.FrameworkInfo.newBuilder();</div><div class="line">   <span class="comment">// å¦‚æœå­˜åœ¨ï¼Œè®¾ç½® FrameworkID</span></div><div class="line">   <span class="keyword">if</span> (frameworkIDOptional.isPresent()) &#123;</div><div class="line">       builder.setId(Protos.FrameworkID.newBuilder().setValue(frameworkIDOptional.get()).build());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">   Protos.FrameworkInfo frameworkInfo = builder.setUser(mesosConfig.getUser()).setName(frameworkName)</div><div class="line">                .setHostname(mesosConfig.getHostname())</div><div class="line">                .setFailoverTimeout(FRAMEWORK_FAILOVER_TIMEOUT_SECONDS)</div><div class="line">                .setWebuiUrl(WEB_UI_PROTOCOL + env.getFrameworkHostPort()).setCheckpoint(<span class="keyword">true</span>).build();</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>FrameworkIDService#fetch()</code> æ–¹æ³•ï¼Œä»æ³¨å†Œä¸­å¿ƒè·å– FrameworkID ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Optional&lt;String&gt; <span class="title">fetch</span><span class="params">()</span> </span>&#123;</div><div class="line">   String frameworkId = regCenter.getDirectly(HANode.FRAMEWORK_ID_NODE);</div><div class="line">   <span class="keyword">return</span> Strings.isNullOrEmpty(frameworkId) ? Optional.&lt;String&gt;absent() : Optional.of(frameworkId);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>Protos.FrameworkInfo.Builder#setId(...)</code> æ–¹æ³•ï¼Œå½“ FrameworkID å­˜åœ¨æ—¶ï¼Œè®¾ç½® FrameworkIDã€‚</p></li><li><p>è°ƒç”¨ <code>Protos.FrameworkInfo.Builder#setFailoverTimeout(...)</code> æ–¹æ³•ï¼Œè®¾ç½® Scheduler æœ€å¤§æ•…éšœè½¬ç§»æ—¶é—´ï¼Œå³ FrameworkID è¿‡æœŸæ—¶é—´ã€‚Elastic-Job-Cloud-Scheduler é»˜è®¤è®¾ç½®ä¸€å‘¨ã€‚</p></li></ul><p>å½“ Elastic-Job-Cloud-Scheduler é›†ç¾¤ç¬¬ä¸€æ¬¡åˆå§‹åŒ–ï¼Œä¸Šé¢çš„é€»è¾‘æ˜¾ç„¶è·å–ä¸åˆ° FrameworkIDï¼Œåœ¨å‘ Mesos Master åˆå§‹åŒ–æˆåŠŸåï¼Œå›è°ƒ <code>SchedulerEngine#registered(...)</code> æ–¹æ³•è¿›è¡Œä¿å­˜ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerEngine.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerEngine</span> <span class="keyword">implements</span> <span class="title">Scheduler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registered</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver, <span class="keyword">final</span> Protos.FrameworkID frameworkID, <span class="keyword">final</span> Protos.MasterInfo masterInfo)</span> </span>&#123;</div><div class="line">        log.info(<span class="string">"call registered"</span>);</div><div class="line">        <span class="comment">// ä¿å­˜FrameworkID</span></div><div class="line">        frameworkIDService.save(frameworkID.getValue());</div><div class="line">        <span class="comment">// è¿‡æœŸ TaskScheduler Lease</span></div><div class="line">        taskScheduler.expireAllLeases();</div><div class="line">        <span class="comment">// æ³¨å†Œ Mesos Master ä¿¡æ¯</span></div><div class="line">        MesosStateService.register(masterInfo.getHostname(), masterInfo.getPort());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// FrameworkIDService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(<span class="keyword">final</span> String id)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(HANode.FRAMEWORK_ID_NODE)) &#123; <span class="comment">// ä¸å­˜åœ¨æ‰ä¿å­˜</span></div><div class="line">       regCenter.persist(HANode.FRAMEWORK_ID_NODE, id);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h1>5. Scheduler æ•°æ®å­˜å‚¨</h1><p>æ–°çš„ Elastic-Job-Cloud-Scheduler <strong>ä¸»èŠ‚ç‚¹</strong>åœ¨æ•…éšœè½¬ç§»ï¼Œä¸ä»…ä»…æ¥ç®¡ Elastic-Job-Cloud-Executorï¼Œ<strong>è¿˜éœ€è¦æ¥ç®¡æ•°æ®å­˜å‚¨</strong>ã€‚</p><p>Elastic-Job-Cloud-Executor ä½¿ç”¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )å­˜å‚¨æ•°æ®ã€‚æ•°æ®å­˜å‚¨åˆ†æˆä¸¤éƒ¨åˆ†ï¼š</p><ul><li>configï¼Œäº‘ä½œä¸šåº”ç”¨é…ç½®ã€äº‘ä½œä¸šé…ç½®ã€‚</li><li>stateï¼Œä½œä¸šçŠ¶æ€ä¿¡æ¯ã€‚</li></ul><p>æ•´ä½“å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_15/02.png" alt=""></p><p>Elastic-Job-Cloud-Scheduler <strong>å„ä¸ªæœåŠ¡</strong>æ ¹æ®æ•°æ®å­˜å‚¨å¯åŠ¨åˆå§‹åŒ–ã€‚ä¸‹é¢æ¥çœ‹çœ‹ä¾èµ–æ•°æ®å­˜å‚¨è¿›è¡Œåˆå§‹åŒ–çš„æœåŠ¡ä»£ç å®ç°ã€‚</p><h2>5.1 RunningService</h2><p>RunningServiceï¼Œä»»åŠ¡è¿è¡Œæ—¶æœåŠ¡ã€‚è°ƒç”¨ <code>RunningService#start()</code> æ–¹æ³•ï¼Œå¯åŠ¨ä»»åŠ¡è¿è¡Œé˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RunningService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¿è¡Œä¸­ä½œä¸šæ˜ å°„</span></div><div class="line"><span class="comment">     * keyï¼šä½œä¸šåç§°</span></div><div class="line"><span class="comment">     * valueï¼šä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Set&lt;TaskContext&gt;&gt; RUNNING_TASKS = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(TASK_INITIAL_SIZE);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        clear();</div><div class="line">        List&lt;String&gt; jobKeys = regCenter.getChildrenKeys(RunningNode.ROOT);</div><div class="line">        <span class="keyword">for</span> (String each : jobKeys) &#123;</div><div class="line">            <span class="comment">// ä»è¿è¡Œä¸­é˜Ÿåˆ—ç§»é™¤ä¸å­˜åœ¨é…ç½®çš„ä½œä¸šä»»åŠ¡</span></div><div class="line">            <span class="keyword">if</span> (!configurationService.load(each).isPresent()) &#123;</div><div class="line">                remove(each);</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// æ·»åŠ  è¿è¡Œä¸­ä½œä¸šæ˜ å°„</span></div><div class="line">            RUNNING_TASKS.put(each, Sets.newCopyOnWriteArraySet(Lists.transform(regCenter.getChildrenKeys(RunningNode.getRunningJobNodePath(each)), <span class="keyword">new</span> Function&lt;String, TaskContext&gt;() &#123;</div><div class="line">                </div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> TaskContext <span class="title">apply</span><span class="params">(<span class="keyword">final</span> String input)</span> </span>&#123;</div><div class="line">                    <span class="keyword">return</span> TaskContext.from(regCenter.get(RunningNode.getRunningTaskNodePath(TaskContext.MetaInfo.from(input).toString())));</div><div class="line">                &#125;</div><div class="line">            &#125;)));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>å› ä¸ºè¿è¡Œä¸­ä½œä¸šæ˜ å°„( <code>RUNNING_TASKS</code> )ä½¿ç”¨çš„é¢‘æ¬¡å¾ˆå¤šï¼ŒElastic-Job-Cloud-Scheduler ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚æ¯æ¬¡åˆå§‹åŒ–æ—¶ï¼Œä½¿ç”¨ä»æ•°æ®å­˜å‚¨<strong>è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—</strong>åŠ è½½åˆ°å†…å­˜ã€‚</p></li><li><p>è¿™é‡Œæˆ‘ä»¬åœ¨çœ‹ä¸‹<strong>è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—</strong>çš„æ·»åŠ ( <code>#add()</code> )æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!configurationService.load(taskContext.getMetaInfo().getJobName()).isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°è¿è¡Œä¸­çš„ä»»åŠ¡é›†åˆ</span></div><div class="line">   getRunningTasks(taskContext.getMetaInfo().getJobName()).add(taskContext);</div><div class="line">   <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºå¸¸é©»ä»»åŠ¡</span></div><div class="line">   <span class="keyword">if</span> (!isDaemon(taskContext.getMetaInfo().getJobName())) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°è¿è¡Œä¸­é˜Ÿåˆ—</span></div><div class="line">   String runningTaskNodePath = RunningNode.getRunningTaskNodePath(taskContext.getMetaInfo().toString());</div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(runningTaskNodePath)) &#123;</div><div class="line">       regCenter.persist(runningTaskNodePath, taskContext.getId());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—åªå­˜å‚¨å¸¸é©»ä½œä¸šçš„ä»»åŠ¡</strong>ã€‚æ‰€ä»¥<strong>ç¬æ—¶</strong>ä½œä¸šï¼Œåœ¨æ•…éšœè½¬ç§»æ—¶ï¼Œå¯èƒ½å­˜åœ¨ç›¸åŒä½œä¸šç›¸åŒåˆ†ç‰‡ä»»åŠ¡<strong>åŒæ—¶</strong>è°ƒåº¦æ‰§è¡Œã€‚ä¸¾ä¸ªæ —å­ğŸŒ°ï¼ŒElastic-Job-Cloud-Scheduler é›†ç¾¤æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ A( ä¸»èŠ‚ç‚¹ ) / B( ä»èŠ‚ç‚¹ )ï¼Œï¼ˆ1ï¼‰A èŠ‚ç‚¹æ¯ 5 åˆ†é’Ÿè°ƒåº¦ä¸€æ¬¡ç¬æ—¶ä½œä¸šä»»åŠ¡ T ï¼ŒT æ¯æ¬¡æ‰§è¡Œæ¶ˆè€—æ—¶é—´å®é™…è¶…è¿‡ 5 åˆ†é’Ÿ( å…ˆä¸è¦è€ƒè™‘æ˜¯å¦åˆç† )ã€‚ï¼ˆ2ï¼‰A èŠ‚ç‚¹å´©æºƒï¼ŒB èŠ‚ç‚¹æˆä¸ºä¸»èŠ‚ç‚¹ï¼Œ5 åˆ†é’Ÿåè°ƒåº¦ T ä½œä¸šï¼Œå› ä¸º<strong>è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—åªå­˜å‚¨å¸¸é©»ä½œä¸šçš„ä»»åŠ¡</strong>ï¼Œæ¢å¤åçš„ <code>RUNNING_TASKS</code> ä¸å­˜åœ¨è¯¥ä½œä¸šä»»åŠ¡ï¼Œå› æ­¤å¯ä»¥è°ƒåº¦ T ä½œä¸šï¼Œå®é™… T ä½œä¸šæ­£åœ¨ Elastic-Job-Cloud-Executor æ‰§è¡Œä¸­ã€‚</li></ul></li></ul><h2>5.2 ProducerManager</h2><p>ProducerManagerï¼Œå‘å¸ƒä»»åŠ¡ä½œä¸šè°ƒåº¦ç®¡ç†å™¨ã€‚è°ƒç”¨ <code>ProducerManager#startup()</code> æ–¹æ³•ï¼Œå¯åŠ¨ä½œä¸šè°ƒåº¦å™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerManager</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startup</span><span class="params">()</span> </span>&#123;</div><div class="line">        log.info(<span class="string">"Start producer manager"</span>);</div><div class="line">        <span class="comment">// å‘å¸ƒç¬æ—¶ä½œä¸šä»»åŠ¡çš„è°ƒåº¦å™¨</span></div><div class="line">        transientProducerScheduler.start();</div><div class="line">        <span class="comment">// åˆå§‹åŒ–è°ƒåº¦ä½œä¸š</span></div><div class="line">        <span class="keyword">for</span> (CloudJobConfiguration each : configService.loadAll()) &#123;</div><div class="line">            schedule(each);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>ConfigService#loadAll()</code> æ–¹æ³•ï¼Œä»<strong>æ•°æ®å­˜å‚¨</strong>è¯»å–æ‰€æœ‰ä½œä¸šé…ç½®ã€‚</li><li>è°ƒç”¨ <code>#schedule()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–è°ƒåº¦ä½œä¸šã€‚<ul><li><strong>ç¬æ—¶</strong>ä½œä¸šï¼Œåœ¨ Elastic-Job-Cloud-Scheduler è®¡æ—¶è°ƒåº¦ï¼Œç±»ä¼¼æ¯ XX ç§’ / åˆ† / æ—¶ / å¤©ä¹‹ç±»çš„ä½œä¸šéœ€è¦é‡æ–°è®¡æ—¶ï¼Œè¿™ä¸ªè¯·æ³¨æ„ã€‚</li><li><strong>å¸¸é©»</strong>ä½œä¸šï¼Œåœ¨ Elastic-Job-Cloud-Executor è®¡æ—¶è°ƒåº¦ï¼Œæš‚æ— å½±å“ã€‚</li><li>åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹ã€Œ3. Producer å‘å¸ƒä»»åŠ¡ã€</a>æœ‰è¯¦ç»†è§£æã€‚</li></ul></li></ul><h2>5.3 TaskScheduler</h2><p>TaskSchedulerï¼ŒFenzo ä½œä¸šè°ƒåº¦å™¨ï¼Œæ ¹æ® Mesos Offer å’Œä½œä¸šä»»åŠ¡çš„ä¼˜åŒ–åˆ†é…ã€‚å› ä¸ºå…¶åˆ†é…æ˜¯ä¾èµ–å½“å‰å®é™… Mesos Offer å’Œ ä½œä¸šä»»åŠ¡è¿è¡Œçš„æƒ…å†µï¼ŒçŒœæµ‹<strong>å¯èƒ½</strong>å¯¹ä¼˜åŒ–åˆ†é…æœ‰å½±å“ï¼Œä½†ä¸å½±å“æ­£ç¡®æ€§ã€‚ç¬”è€…å¯¹ TaskScheduler äº†è§£ä¸æ˜¯å¾ˆæ·±å…¥ï¼Œä»…ä»…ä½œä¸ºçŒœæµ‹ã€‚</p><p>åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹ã€Œ4.1ã€ã€Œ4.2ã€ã€Œ4.3ã€</a>æœ‰å’Œ TaskScheduler ç›¸å…³çš„å†…å®¹è§£æã€‚</p><h1>6. Mesos Master å´©æºƒ</h1><p>Mesos Master é›†ç¾¤ï¼ŒMesos Master ä¸»èŠ‚ç‚¹å´©æºƒåï¼ŒMesos Master é›†ç¾¤é‡æ–°é€‰ä¸¾åï¼ŒSchedulerã€Mesos Slave <strong>ä» Zookeeper è·å–åˆ°æœ€æ–°çš„ Mesos Master ä¸»èŠ‚ç‚¹é‡æ–°è¿›è¡Œæ³¨å†Œ</strong>ï¼Œä¸å½±å“ Scheduler ã€Mesos Slave ã€ä»»åŠ¡æ‰§è¡Œã€‚</p><p>è°ƒç”¨ <code>SchedulerService#getSchedulerDriver(...)</code> æ–¹æ³•ï¼Œè®¾ç½® SchedulerDriver ä» Mesos Zookeeper Address è¯»å–å½“å‰ Mesos Master åœ°å€ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerService.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> SchedulerDriver <span class="title">getSchedulerDriver</span><span class="params">(<span class="keyword">final</span> TaskScheduler taskScheduler, <span class="keyword">final</span> JobEventBus jobEventBus, <span class="keyword">final</span> FrameworkIDService frameworkIDService)</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">    MesosConfiguration mesosConfig = env.getMesosConfiguration();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MesosSchedulerDriver(<span class="keyword">new</span> SchedulerEngine(taskScheduler, facadeService, jobEventBus, frameworkIDService, statisticManager), frameworkInfo, mesosConfig.getUrl() <span class="comment">// Mesos Master URL</span></div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// MesosSchedulerDriver.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">MesosSchedulerDriver</span><span class="params">(Scheduler scheduler,</span></span></div><div class="line"><span class="function"><span class="params">                            FrameworkInfo framework,</span></span></div><div class="line"><span class="function"><span class="params">                            String master)</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç      </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>MesosSchedulerDriver æ„é€ æ–¹æ³•ç¬¬ä¸‰ä¸ªå‚æ•° <code>master</code>ï¼Œä»£è¡¨ Mesos ä½¿ç”¨çš„ Zookeeper åœ°å€ï¼Œä¾‹å¦‚ï¼š<code>zk://127.0.0.1:2181/mesos</code>ã€‚ç”Ÿäº§ç¯å¢ƒè¯·é…ç½®å¤š Zookeeper èŠ‚ç‚¹ï¼Œä¾‹å¦‚ï¼š<code>zk://host1:port1,host2:port2,.../path</code>ã€‚</p></li><li><p>ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p><p><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 10] ls /mesos</div><div class="line">[log_replicas, json.info_0000000017]</div><div class="line">[zk: localhost:2181(CONNECTED) 11] get /mesos/json.info_0000000017</div><div class="line">&#123;"address":&#123;"hostname":"localhost","ip":"127.0.0.1","port":5050&#125;,"hostname":"localhost","id":"685fe32d-e30c-4df7-b891-3d96b06fee88","ip":16777343,"pid":"master@127.0.0.1:5050","port":5050,"version":"1.4.0"&#125;</div></pre></td></tr></table></figure></p></li></ul><p>Elastic-Job-Cloud-Scheduler æ³¨å†Œä¸Šã€é‡æ–°æ³¨å†Œä¸Šã€æ–­å¼€ Mesos Master å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerEngine</span> <span class="keyword">implements</span> <span class="title">Scheduler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registered</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver, <span class="keyword">final</span> Protos.FrameworkID frameworkID, <span class="keyword">final</span> Protos.MasterInfo masterInfo)</span> </span>&#123;</div><div class="line">        log.info(<span class="string">"call registered"</span>);</div><div class="line">        <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">        <span class="comment">// æ³¨å†Œ Mesos Master ä¿¡æ¯</span></div><div class="line">        MesosStateService.register(masterInfo.getHostname(), masterInfo.getPort());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reregistered</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver, <span class="keyword">final</span> Protos.MasterInfo masterInfo)</span> </span>&#123;</div><div class="line">        <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">        <span class="comment">// æ³¨å†Œ Mesos Master ä¿¡æ¯</span></div><div class="line">        MesosStateService.register(masterInfo.getHostname(), masterInfo.getPort());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disconnected</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver)</span> </span>&#123;</div><div class="line">        log.warn(<span class="string">"call disconnected"</span>);</div><div class="line">        MesosStateService.deregister();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>MesosStateServiceï¼ŒMesosçŠ¶æ€æœåŠ¡ï¼Œæä¾›è°ƒç”¨ Mesos Master API æœåŠ¡ï¼Œä¾‹å¦‚è·å–æ‰€æœ‰æ‰§è¡Œå™¨ã€‚</p></li><li><p>è°ƒç”¨ <code>MesosStateService#register(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œ Mesos Master ä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MesosStateService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String stateUrl;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> String hostName, <span class="keyword">final</span> <span class="keyword">int</span> port)</span> </span>&#123;</div><div class="line">        stateUrl = String.format(<span class="string">"http://%s:%d/state"</span>, hostName, port);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>MesosStateService#deregister(...)</code> æ–¹æ³•ï¼Œæ³¨é”€ Mesos Master ä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">deregister</span><span class="params">()</span> </span>&#123;</div><div class="line">    stateUrl = <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><p><a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹P110 å¦‚ä½•å¤„ç† master çš„æ•…éšœ</a>ï¼Œæœ‰å…´è¶£çš„åŒå­¦ä¹Ÿå¯ä»¥<strong>ä»”ç»†</strong>çœ‹çœ‹ã€‚</p><h1>7. Mesos Slave å´©æºƒ</h1><p>åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-failover/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>ä¸­ï¼Œæœç´¢å…³é”®å­— <strong>&quot;TASK_LOST&quot;</strong>ï¼Œæœ‰ Mesos Slave å´©æºƒåï¼Œå¯¹ Elastic-Job-Cloud-Scheduler å’Œ Elastic-Job-Cloud-Executor çš„å½±å“ã€‚</p><p><a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹P109 å¦‚ä½•å¤„ç† slave çš„æ•…éšœ</a>ï¼Œæœ‰å…´è¶£çš„åŒå­¦ä¹Ÿå¯ä»¥<strong>ä»”ç»†</strong>çœ‹çœ‹ã€‚</p><h1>8. Scheduler æ ¸å¯¹</h1><blockquote><p>FROM http://mesos.apache.org/documentation/latest/reconciliation/<br>Messages between framework schedulers and the Mesos master may be dropped due to failures and network partitions. This may cause a framework scheduler and the master to have <strong>different views of the current state of the cluster</strong>. For example, consider a launch task request sent by a framework. There are many ways that failures can prevent the task launch operation from succeeding, such as:</p></blockquote><blockquote><ul><li>Framework fails after persisting its intent to launch the task, but before the launch task message was sent.</li><li>Master fails before receiving the message.</li><li>Master fails after receiving the message but before sending it to the agent.</li></ul></blockquote><p>é€šè¿‡<strong>æ ¸å¯¹</strong>ç‰¹æ€§è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ ¸å¯¹æ˜¯åè°ƒå™¨å¦‚ä½•å’Œ Mesos Master ä¸€èµ·æ£€æŸ¥è°ƒåº¦å™¨æ‰€è®¤ä¸ºçš„é›†ç¾¤çŠ¶æ€æ˜¯å¦å’Œ Mesos Master æ‰€è®¤ä¸ºçš„é›†ç¾¤çŠ¶æ€å®ŒæˆåŒ¹é…ã€‚</p><p>è°ƒç”¨ <code>SchedulerDriver#reconcileTasks(...)</code> æ–¹æ³•ï¼ŒæŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ã€‚ä»£ç æ¥å£å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SchedulerDriver</span> </span>&#123;</div><div class="line">    <span class="function">Status <span class="title">reconcileTasks</span><span class="params">(Collection&lt;TaskStatus&gt; statuses)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>åªèƒ½</strong>æŸ¥è¯¢**éç»ˆæ­¢çŠ¶æ€( non-terminal )**çš„ä»»åŠ¡ã€‚æ ¸å¯¹çš„ä¸»è¦åŸå› ï¼Œç¡®è®¤ä»»åŠ¡æ˜¯å¦è¿˜åœ¨è¿è¡Œï¼Œæˆ–è€…å·²ç»è¿›å…¥äº†ä¸­æ–­çŠ¶æ€ã€‚<ul><li>terminalï¼šTASK_ERRORã€TASK_FAILEDã€TASK_FINISHEDã€TASK_KILLED</li><li>non-terminalï¼šTASK_DROPPEDã€TASK_GONEã€TASK_GONE_BY_OPERATORã€TASK_KILLINGã€TASK_LOSTã€TASK_RUNNINGã€TASK_STAGINGã€TASK_STARTINGã€TASK_UNREACHABLEã€TASK_UNKNOWN</li></ul></li><li>å½“ <code>statuses</code> éç©ºæ—¶ï¼Œ<strong>æ˜¾ç¤º</strong>æŸ¥è¯¢ï¼Œé€šè¿‡å›è°ƒ <code>Scheduler#statusUpdate(...)</code> æ–¹æ³•å¼‚æ­¥è¿”å›<strong>æŒ‡å®š</strong>çš„ä»»åŠ¡çš„çŠ¶æ€ã€‚</li><li>å½“ <code>statuses</code> ä¸ºç©ºæ—¶ï¼Œ<strong>éšå¼</strong>æŸ¥è¯¢ï¼Œé€šè¿‡å›è°ƒ <code>Scheduler#statusUpdate(...)</code> æ–¹æ³•å¼‚æ­¥è¿”å›<strong>å…¨éƒ¨</strong>çš„ä»»åŠ¡çš„çŠ¶æ€ã€‚</li></ul><p>ReconcileServiceï¼Œæ ¸å¯¹ Mesos ä¸ Scheduler ä¹‹é—´çš„ä»»åŠ¡çŠ¶æ€ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReconcileService</span> <span class="keyword">extends</span> <span class="title">AbstractScheduledService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">runOneIteration</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        lock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            explicitReconcile();</div><div class="line">            implicitReconcile();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Scheduler <span class="title">scheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">        FrameworkConfiguration configuration = BootstrapEnvironment.getInstance().getFrameworkConfiguration();</div><div class="line">        <span class="keyword">return</span> Scheduler.newFixedDelaySchedule(configuration.getReconcileIntervalMinutes(), configuration.getReconcileIntervalMinutes(), TimeUnit.MINUTES);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>é€šè¿‡é…ç½® <code>FrameworkConfiguration#reconcileIntervalMinutes</code> è®¾ç½®ï¼Œæ¯éš”å¤šå°‘åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡æ ¸å¯¹ã€‚è‹¥é…ç½®æ—¶é—´å¤§äº 0 æ‰å¼€å¯ä»»åŠ¡çŠ¶æ€æ ¸å¯¹åŠŸèƒ½ã€‚</p></li><li><p>è°ƒç”¨ <code>#explicitReconcile()</code> æ–¹æ³•ï¼ŒæŸ¥è¯¢è¿è¡Œä¸­çš„ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">explicitReconcile</span><span class="params">()</span> </span>&#123;</div><div class="line">   lock.lock();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// è·å–è¿è¡Œä¸­çš„ä½œä¸šä»»åŠ¡ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line">       Set&lt;TaskContext&gt; runningTask = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">       <span class="keyword">for</span> (Set&lt;TaskContext&gt; each : facadeService.getAllRunningTasks().values()) &#123;</div><div class="line">           runningTask.addAll(each);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (runningTask.isEmpty()) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">       log.info(<span class="string">"Requesting &#123;&#125; tasks reconciliation with the Mesos master"</span>, runningTask.size());</div><div class="line">       <span class="comment">// æŸ¥è¯¢æŒ‡å®šä»»åŠ¡</span></div><div class="line">       schedulerDriver.reconcileTasks(Collections2.transform(runningTask, <span class="keyword">new</span> Function&lt;TaskContext, Protos.TaskStatus&gt;() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="keyword">public</span> Protos.<span class="function">TaskStatus <span class="title">apply</span><span class="params">(<span class="keyword">final</span> TaskContext input)</span> </span>&#123;</div><div class="line">               <span class="keyword">return</span> Protos.TaskStatus.newBuilder()</div><div class="line">                       .setTaskId(Protos.TaskID.newBuilder().setValue(input.getId()).build())</div><div class="line">                       .setSlaveId(Protos.SlaveID.newBuilder().setValue(input.getSlaveId()).build())</div><div class="line">                       .setState(Protos.TaskState.TASK_RUNNING)</div><div class="line">                       .build();</div><div class="line">           &#125;</div><div class="line">       &#125;));</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       lock.unlock();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>#implicitReconcile()</code> æ–¹æ³•ï¼ŒæŸ¥è¯¢æ‰€æœ‰ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">implicitReconcile</span><span class="params">()</span> </span>&#123;</div><div class="line">   lock.lock();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// æŸ¥è¯¢å…¨éƒ¨ä»»åŠ¡</span></div><div class="line">       schedulerDriver.reconcileTasks(Collections.&lt;Protos.TaskStatus&gt;emptyList());</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       lock.unlock();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ä¸ºä»€ä¹ˆè¿™é‡Œè¦ä½¿ç”¨ ReentrantLock é”å‘¢ï¼ŸElastic-Job-Cloud-Scheduler æä¾› CloudOperationRestfulApiï¼Œæ”¯æŒä½¿ç”¨ HTTP Restful API ä¸»åŠ¨è§¦å‘ <code>#explicitReconcile()</code> å’Œ <code>#implicitReconcile()</code> æ–¹æ³•ï¼Œ<strong>é€šè¿‡é”é¿å…å¹¶å‘æ ¸å¯¹</strong>ã€‚å¯¹ CloudOperationRestfulApi æœ‰å…´è¶£çš„åŒå­¦ï¼Œç›´æ¥ç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/a52d4062bf1f1d729fa4dbf2d1225e0d97778cb9/elastic-job-cloud/elastic-job-cloud-scheduler/src/main/java/com/dangdang/ddframe/job/cloud/scheduler/restful/CloudOperationRestfulApi.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹å®ç°ã€‚</p></li></ul><p>TODOï¼šä¸ºå•¥è¦å…ˆæ˜¾å†éšå‘¢ï¼Ÿ</p><p>TODOï¼šThis reconciliation algorithm must be run after each (re-)registration.</p><p>å…¶ä»– Scheduler æ ¸å¯¹èµ„æ–™ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹çœ‹ï¼š</p><ul><li><a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹P76 æ·»åŠ æ ¸å¯¹ ã€P111 æ•…éšœè½¬ç§»æœŸé—´çš„æ ¸å¯¹</a></li><li><a href="http://mesos.apache.org/documentation/latest/reconciliation/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos å®˜æ–¹æ–‡æ¡£ â€”â€” reconciliationã€‹</a></li></ul><p>Elastic-Job-Lite ä¹Ÿä¼šå­˜åœ¨ä½œä¸šèŠ‚ç‚¹ å’Œ Zookeeper æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹<a href="http://www.iocoder.cn/Elastic-Job/reconcile/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” è‡ªè¯Šæ–­ä¿®å¤ã€‹</a>çš„å®ç°ã€‚</p><h1>666. å½©è›‹</h1><p>ç»™è‹±æ–‡å’Œæˆ‘ä¸€æ ·åŠæ–¤å…«ä¸¤çš„åŒå­¦ä¸€æœ¬è‘µèŠ±å®å…¸+è¾Ÿé‚ªå‰‘è°±ï¼š</p><ul><li><a href="https://mesos-cn.gitbooks.io/mesos-cn/content/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesosä¸­æ–‡æ‰‹å†Œã€‹</a>ã€‚</li><li><a href="http://www.jianshu.com/p/726e28ea488a" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos å®¹é”™ã€æ•…éšœã€‹</a></li></ul><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_15/03.png" alt=""></p><p>æ•´ä¸ª Elastic-Job-Cloud å®Œç»“ï¼Œæ’’èŠ±ï¼</p><p>æ”¶è·è›®å¤šçš„ï¼Œå­¦ä¹ çš„ç¬¬ä¸€å¥—åŸºäºäº‘åŸç”Ÿ( CloudNative )å®ç°çš„ä¸­é—´ä»¶ï¼ŒæœŸå¾…æœ‰åŸºäºäº‘åŸç”Ÿçš„æœåŠ¡åŒ–ä¸­é—´ä»¶ã€‚</p><p>ä¸€å¼€å§‹å› ä¸º Elastic-Job-Cloud åŸºäº Mesos å®ç°ï¼Œå†…å¿ƒè¿˜æ˜¯æœ‰ç‚¹ææƒ§æ„Ÿï¼Œåé¢ç¡¬å•ƒ + æ­é…<a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a>ï¼Œæ¯”é¢„æƒ³çš„æ—¶é—´å¿«äº†ä¸€åŠå®Œæˆè¿™ä¸ªç³»åˆ—ã€‚åœ¨è¿™é‡Œå¼ºçƒˆæ¨èè¿™æœ¬ä¹¦ã€‚å¦å¤–ï¼Œç­‰æ—¶é—´ç›¸å¯¹ç©ºï¼Œä¼šç ”ç©¶ä¸‹å¦å¤–ä¸€ä¸ªæ²ªæ±Ÿå¼€æºçš„åŸºäº Mesos å®ç°çš„åˆ†å¸ƒå¼è°ƒåº¦ç³»ç»Ÿ <a href="https://github.com/HujiangTechnology/Juice" rel="external nofollow noopener noreferrer" target="_blank">Juice</a>ã€‚ä¸æ˜¯å¾ˆç¡®å®šä¼šä¸ä¼šå‡ºæºç è§£æçš„æ–‡ç« ï¼Œå°½é‡è¾“å‡ºå™¶ã€‚</p><p>åé¢ä¼šç»§ç»­æ›´æ–°æºç è§£æç³»åˆ—ï¼Œä¸‹ä¸€ä¸ªç³»åˆ—åº”è¯¥æ˜¯<a href="https://github.com/changmingxie/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ã€Štcc-transaction æºç è§£æã€‹</a>ã€‚åœ¨é€‰æ‹©è¦ç ”ç©¶çš„ tcc ä¸­é—´ä»¶è¿˜æ˜¯è›®çº ç»“çš„ï¼Œå“ˆå“ˆï¼Œè¿™é‡Œå¬ä» <a href="http://www.54tianzhisheng.cn/" rel="external nofollow noopener noreferrer" target="_blank">zhisheng</a> çš„å»ºè®®ã€‚å¦‚æœä¸å¥½ï¼Œæˆ‘ä¿è¯ä¼šæ‰“æ­»ä½ çš„ã€‚</p><p>å¸Œæœ›åšæŒä¸æ‡ˆçš„åˆ†äº«æºç è§£æä¼šæœ‰æ›´å¤šçš„åŒè¡Œè€…é˜…è¯»ã€‚ç¡®å®ï¼Œæºç è§£æçš„å—ä¼—ç•¥å°ã€‚</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_15/04.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. Scheduler é›†ç¾¤&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a hre
      
    
    </summary>
    
      <category term="Elastic-Job-Cloud" scheme="http://www.iocoder.cn/categories/Elastic-Job-Cloud/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»</title>
    <link href="http://www.iocoder.cn/Elastic-Job/cloud-job-failover/"/>
    <id>http://www.iocoder.cn/Elastic-Job/cloud-job-failover/</id>
    <published>2018-01-09T16:00:00.000Z</published>
    <updated>2017-09-07T08:34:21.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. è®°å½•ä½œä¸šå¤±æ•ˆè½¬ç§»</a></li><li><a href="#">3. æäº¤å¤±æ•ˆè½¬ç§»ä½œä¸š</a></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Cloud ä½œä¸šå¤±æ•ˆè½¬ç§»</strong>ã€‚å¯¹åº”åˆ° Elastic-Job-Lite æºç è§£ææ–‡ç« ä¸º<a href="http://www.iocoder.cn/Elastic-Job/job-failover/?self">ã€ŠElastic-Job-Lite ä½œä¸šä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>ã€‚</p><p>ä½ éœ€è¦å¯¹<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>æœ‰ä¸€å®šçš„äº†è§£ã€‚</p><p>å½“ä½œä¸šä»»åŠ¡åœ¨ Elastic-Job-Cloud-Executor å¼‚å¸¸å´©æºƒæ—¶ï¼Œè¯¥ä»»åŠ¡åœ¨ä¸‹æ¬¡è°ƒåº¦ä¹‹å‰ä¸ä¼šè¢«é‡æ–°æ‰§è¡Œã€‚å¼€å¯å¤±æ•ˆè½¬ç§»åŠŸèƒ½åï¼Œè¯¥ä½œä¸šä»»åŠ¡ä¼šç«‹å³è¢« Elastic-Job-Cloud-Scheduler é‡æ–°è°ƒåº¦ï¼Œæäº¤ Elastic-Job-Cloud-Executor <strong>ç«‹å³</strong>æ‰§è¡Œã€‚</p><p>åœ¨ Elastic-Job-Cloud é‡Œï¼Œæˆ‘ä»¬äº†è§£åˆ°ä½œä¸šåˆ†æˆ<strong>ç¬æ—¶</strong>ä½œä¸šå’Œ<strong>å¸¸é©»</strong>ä½œä¸šã€‚å®é™…ä¸Šé¢å¤±æ•ˆè½¬ç§»çš„å®šä¹‰æš‚æ—¶åªé€‚ç”¨äº<strong>ç¬æ—¶</strong>ä½œä¸šã€‚å¯¹äº<strong>å¸¸é©»</strong>ä½œä¸šï¼Œä½œä¸šä»»åŠ¡å¼‚å¸¸å´©æºƒåï¼Œæ— è®ºä½ æ˜¯å¦å¼€å¯å¤±æ•ˆè½¬ç§»åŠŸèƒ½ï¼ŒElastic-Job-Cloud-Scheduler ä¼šç«‹åˆ»æäº¤ Elastic-Job-Cloud-Executor <strong>é‡æ–°è°ƒåº¦</strong>æ‰§è¡Œã€‚</p><p><strong>ä¸ºä»€ä¹ˆæ­¤å¤„ä½¿ç”¨çš„æ˜¯â€œé‡æ–°è°ƒåº¦â€ï¼Œè€Œä¸æ˜¯â€œç«‹å³æ‰§è¡Œâ€å‘¢</strong>ï¼Ÿç›®å‰ç‰ˆæœ¬ Elasitc-Job-Cloud æš‚æ—¶ä¸æ”¯æŒ<strong>å¸¸é©»</strong>ä½œä¸šçš„å¤±æ•ˆè½¬ç§»ï¼Œå½“ä½œä¸šä»»åŠ¡å¼‚å¸¸å´©æºƒï¼Œæœ¬æ¬¡æ‰§è¡Œ<strong>ä¸ä¼šé‡æ–°æ‰§è¡Œ</strong>ï¼Œä½†æ˜¯ä¸ºäº†ä½œä¸šä»»åŠ¡åç»­èƒ½å¤Ÿè°ƒåº¦æ‰§è¡Œï¼Œæ‰€ä»¥å†æ¬¡æäº¤ Elastic-Job-Cloud-Schedulerã€‚</p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>OKï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ä½œä¸šå¤±æ•ˆè½¬ç§»çš„å®ç°æ–¹å¼å’Œä½œä¸šä»»åŠ¡å¼‚å¸¸å´©æºƒçš„å¤šé‡åœºæ™¯ã€‚</p><h1>2. è®°å½•ä½œä¸šå¤±æ•ˆè½¬ç§»</h1><p>å½“ä½œä¸šä»»åŠ¡å¼‚å¸¸å´©æºƒæ—¶ï¼ŒElastic-Job-Cloud-Scheduler é€šè¿‡ Mesos ä»»åŠ¡çŠ¶æ€å˜æ›´æ¥å£( <code>#statusUpdate()</code> )å®ç°å¯¹ä»»åŠ¡çŠ¶æ€çš„ç›‘å¬å¤„ç†ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerEngine</span> <span class="keyword">implements</span> <span class="title">Scheduler</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">statusUpdate</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver, <span class="keyword">final</span> Protos.TaskStatus taskStatus)</span> </span>&#123;</div><div class="line">        String taskId = taskStatus.getTaskId().getValue();</div><div class="line">        TaskContext taskContext = TaskContext.from(taskId);</div><div class="line">        String jobName = taskContext.getMetaInfo().getJobName();</div><div class="line">        log.trace(<span class="string">"call statusUpdate task state is: &#123;&#125;, task id is: &#123;&#125;"</span>, taskStatus.getState(), taskId);</div><div class="line">        jobEventBus.post(<span class="keyword">new</span> JobStatusTraceEvent(jobName, taskContext.getId(), taskContext.getSlaveId(), Source.CLOUD_SCHEDULER, </div><div class="line">                taskContext.getType(), String.valueOf(taskContext.getMetaInfo().getShardingItems()), State.valueOf(taskStatus.getState().name()), taskStatus.getMessage()));</div><div class="line">        <span class="keyword">switch</span> (taskStatus.getState()) &#123;</div><div class="line">            <span class="keyword">case</span> TASK_RUNNING:</div><div class="line">                <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> TASK_FINISHED:</div><div class="line">                <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> TASK_KILLED:</div><div class="line">                <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> TASK_LOST:</div><div class="line">            <span class="keyword">case</span> TASK_DROPPED:</div><div class="line">            <span class="keyword">case</span> TASK_GONE:</div><div class="line">            <span class="keyword">case</span> TASK_GONE_BY_OPERATOR:</div><div class="line">            <span class="keyword">case</span> TASK_FAILED: <span class="comment">// æ‰§è¡Œä½œä¸šä»»åŠ¡è¢«é”™è¯¯ç»ˆæ­¢</span></div><div class="line">            <span class="keyword">case</span> TASK_ERROR: <span class="comment">// ä»»åŠ¡é”™è¯¯</span></div><div class="line">                log.warn(<span class="string">"task id is: &#123;&#125;, status is: &#123;&#125;, message is: &#123;&#125;, source is: &#123;&#125;"</span>, taskId, taskStatus.getState(), taskStatus.getMessage(), taskStatus.getSource());</div><div class="line">                <span class="comment">// å°†ä»»åŠ¡ä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤</span></div><div class="line">                facadeService.removeRunning(taskContext);</div><div class="line">                <span class="comment">// è®°å½•å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</span></div><div class="line">                facadeService.recordFailoverTask(taskContext);</div><div class="line">                <span class="comment">// é€šçŸ¥ TaskScheduler ä»»åŠ¡ä¸åˆ†é…åœ¨å¯¹åº”ä¸»æœºä¸Š</span></div><div class="line">                unAssignTask(taskId);</div><div class="line">                <span class="comment">// ç»Ÿè®¡</span></div><div class="line">                statisticManager.taskRunFailed();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> TASK_UNKNOWN:</div><div class="line">            <span class="keyword">case</span> TASK_UNREACHABLE:</div><div class="line">                log.error(<span class="string">"task id is: &#123;&#125;, status is: &#123;&#125;, message is: &#123;&#125;, source is: &#123;&#125;"</span>, taskId, taskStatus.getState(), taskStatus.getMessage(), taskStatus.getSource());</div><div class="line">                statisticManager.taskRunFailed();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>ä¸€å…±æœ‰ 6 ç§çŠ¶æ€åˆ¤å®šä¸ºä½œä¸šä»»åŠ¡å´©æºƒï¼Œæˆ‘ä»¬æ¥ä¸€ä¸ªä¸€ä¸ªçœ‹çœ‹ï¼š</p><ul><li><p>TASK_DROPPED / TASK_GONE / TASK_GONE_BY_OPERATOR</p><p>è¿™ä¸‰ä¸ªçŠ¶æ€ï¼Œç¬”è€…æš‚æ—¶ä¸å¤ªäº†è§£ï¼Œè¿™é‡Œå…ˆå¼•ç”¨ä¸€äº›èµ„æ–™ï¼Œæ¬¢è¿æœ‰äº†è§£çš„åŒå­¦æŒ‡æ•™ä¸€ä¸‹ã€‚</p><blockquote><p>FROM http://mesos.apache.org/api/latest/java/org/apache/mesos/Protos.TaskState.html<br><strong>TASK_DROPPED</strong>ï¼šThe task failed to launch because of a transient error.<br><strong>TASK_GONE</strong>ï¼šThe task is no longer running.<br><strong>TASK_GONE_BY_OPERATOR</strong>ï¼šThe task was running on an agent that the master cannot contact; the operator has asserted that the agent has been shutdown, but this has not been directly confirmed by the master.</p><p>FROM http://mesos.apache.org/blog/mesos-1-1-0-released/<br>[MESOS-5344] - Experimental support for partition-aware Mesos frameworks. In previous Mesos releases, when an agent is partitioned from the master and then reregisters with the cluster, all tasks running on the agent are terminated and the agent is shutdown. In Mesos 1.1, partitioned agents will no longer be shutdown when they reregister with the master. By default, tasks running on such agents will still be killed (for backward compatibility); however, frameworks can opt-in to the new PARTITION_AWARE capability. If they do this, their tasks will not be killed when a partition is healed. This allows frameworks to define their own policies for how to handle partitioned tasks. Enabling the PARTITION_AWARE capability also introduces a new set of task states: TASK_UNREACHABLE, TASK_DROPPED, TASK_GONE, TASK_GONE_BY_OPERATOR, and TASK_UNKNOWN. <strong>These new states are intended to eventually replace the TASK_LOST state</strong>.</p></blockquote></li><li><p>TASK_FAILED</p><p>æ‰§è¡Œä½œä¸šä»»åŠ¡è¢«<strong>é”™è¯¯</strong>ç»ˆæ­¢ã€‚ä¾‹å¦‚ï¼Œæ‰§è¡Œå™¨( Elastic-Job-Cloud-Executor )å¼‚å¸¸å´©æºƒï¼Œæˆ–è€…è¢«æ€æ­»ã€‚</p></li><li><p>TASK_ERROR</p><p>ä»»åŠ¡å¯åŠ¨å°è¯•å¤±è´¥é”™è¯¯ã€‚ä¾‹å¦‚ï¼Œæ‰§è¡Œå™¨( Elastic-Job-Cloud-Executor ) æ¥æ”¶åˆ°çš„ä»»åŠ¡çš„ä½œä¸šé…ç½®ä¸æ­£ç¡®ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">    <span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œè¿è¡Œä¸­ã€‚</span></div><div class="line">    executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_RUNNING).build());</div><div class="line">    <span class="comment">//</span></div><div class="line">    Map&lt;String, Object&gt; data = SerializationUtils.deserialize(taskInfo.getData().toByteArray());</div><div class="line">    ShardingContexts shardingContexts = (ShardingContexts) data.get(<span class="string">"shardingContext"</span>);</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    JobConfigurationContext jobConfig = <span class="keyword">new</span> JobConfigurationContext((Map&lt;String, String&gt;) data.get(<span class="string">"jobConfigContext"</span>));</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// è·å¾— åˆ†å¸ƒå¼ä½œä¸š</span></div><div class="line">        ElasticJob elasticJob = getElasticJobInstance(jobConfig);</div><div class="line">        <span class="comment">// è°ƒåº¦å™¨æä¾›å†…éƒ¨æœåŠ¡çš„é—¨é¢å¯¹è±¡</span></div><div class="line">        <span class="keyword">final</span> CloudJobFacade jobFacade = <span class="keyword">new</span> CloudJobFacade(shardingContexts, jobConfig, jobEventBus);</div><div class="line">        <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">        <span class="keyword">if</span> (jobConfig.isTransient()) &#123;</div><div class="line">            <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">            JobExecutorFactory.getJobExecutor(elasticJob, jobFacade).execute();</div><div class="line">            <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œå·²å®Œæˆã€‚</span></div><div class="line">            executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_FINISHED).build());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// åˆå§‹åŒ– å¸¸é©»ä½œä¸šè°ƒåº¦å™¨</span></div><div class="line">            <span class="keyword">new</span> DaemonTaskScheduler(elasticJob, jobConfig, jobFacade, executorDriver, taskInfo.getTaskId()).init();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// CHECKSTYLE:OFF</span></div><div class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable ex) &#123;</div><div class="line">        <span class="comment">// CHECKSTYLE:ON</span></div><div class="line">        log.error(<span class="string">"Elastic-Job-Cloud-Executor error"</span>, ex);</div><div class="line">        <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œé”™è¯¯ã€‚</span></div><div class="line">        executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_ERROR).setMessage(ExceptionUtil.transform(ex)).build());</div><div class="line">        <span class="comment">// åœæ­¢è‡ªå·±</span></div><div class="line">        executorDriver.stop();</div><div class="line">        <span class="keyword">throw</span> ex;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#getElasticJobInstance()</code> æ–¹æ³•ï¼Œå› ä¸ºä»»åŠ¡çš„ä½œä¸šé…ç½®ä¸æ­£ç¡®æŠ›å‡º<strong>å¼‚å¸¸</strong>ã€‚ä¾‹å¦‚ï¼Œä»»åŠ¡ç±»ä¸å­˜åœ¨ï¼›Spring çš„ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼›Spring å®¹å™¨åˆå§‹åŒ–å‡ºé”™ï¼›Spring Bean å¯¹è±¡åˆå§‹åŒ–æˆ–è·å–å‡ºé”™ï¼›ä»¥åŠç­‰ç­‰ã€‚</p></li><li><p><strong>ç¬æ—¶</strong>ä½œä¸šï¼Œè°ƒç”¨ <code>AbstractElasticJobExecutor#execute(...)</code> æ–¹æ³•ï¼Œå‘ç”Ÿ<strong>å¼‚å¸¸</strong>ï¼Œå¹¶ä¸”<strong>å¼‚å¸¸è¢«æŠ›å‡º</strong>ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒAbstractElasticJobExecutor å†…éƒ¨ä½¿ç”¨ DefaultJobExceptionHandler å¤„ç†å‘ç”Ÿçš„å¼‚å¸¸ï¼Œ<strong>ä¸ä¼šæŠ›å‡ºå¼‚å¸¸</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultJobExceptionHandler</span> <span class="keyword">implements</span> <span class="title">JobExceptionHandler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleException</span><span class="params">(<span class="keyword">final</span> String jobName, <span class="keyword">final</span> Throwable cause)</span> </span>&#123;</div><div class="line">        log.error(String.format(<span class="string">"Job '%s' exception occur in job processing"</span>, jobName), cause);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li></li></ul></li><li><p><strong>å¸¸é©»</strong>ä½œä¸šï¼Œè°ƒç”¨ <code>DaemonTaskScheduler#(...)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–å‘ç”Ÿ<strong>å¼‚å¸¸</strong>ã€‚</p></li><li><p>å› ä¸ºä¸Šè¿°çš„ç§ç§å¼‚å¸¸ï¼Œè°ƒç”¨ <code>ExecutorDriver#sendStatusUpdate(...)</code>ï¼Œæ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸º TASK_ERRORã€‚å¦å¤–ï¼Œè°ƒç”¨ <code>ExecutorDriver#stop()</code> æ–¹æ³•ï¼Œå…³é—­è‡ªå·±ã€‚<strong>è¿™æ„å‘³ç€ï¼Œä¸€ä¸ªæ‰§è¡Œå™¨ä¸Šå¦‚æœå­˜åœ¨ä¸€ä¸ªä½œä¸šä»»åŠ¡å‘ç”Ÿ TASK_ERRORï¼Œå…¶ä»–ä½œä¸šä»»åŠ¡å³ä½¿æ˜¯æ­£å¸¸çš„ï¼Œä¹Ÿä¼šæ›´æ–°ä½œä¸šä»»åŠ¡çŠ¶æ€ä¸º TASK_FAILED</strong>ã€‚è¿™å—åƒä¸‡è¦æ³¨æ„ã€‚TODO è¿™ä¸ªéœ€è¦ç¡®è®¤ä¸‹ã€‚</p></li></ul></li><li><p>TASK_LOST</p><p>æ‰§è¡Œä½œä¸šä»»åŠ¡çš„ Elastic-Job-Cloud-Executor æ‰€åœ¨çš„ Mesos Slave ä¸ Mesos Master å› ä¸º<strong>ç½‘ç»œé—®é¢˜æˆ– Mesos Slave å´©æºƒ</strong>å¼•èµ·ä¸¢å¤±è¿æ¥ï¼Œ<strong>å¯èƒ½</strong>å¯¼è‡´å…¶ä¸Šçš„æ‰€æœ‰ä½œä¸šä»»åŠ¡çŠ¶æ€å˜ä¸º TASK_LOSTã€‚</p><p><strong>å½“ Slave å®•æœºåé‡å¯ï¼Œå¯¼è‡´ TASK_LOST æ—¶ï¼ŒMesosåˆæ˜¯æ€ä¹ˆæ¥å¤„ç†çš„å‘¢ï¼Ÿ</strong></p><blockquote><p>FROM http://dockone.io/article/2513<br>åœ¨ Master å’Œ Slave ä¹‹é—´ï¼Œä¸€èˆ¬éƒ½æ˜¯ç”± Master ä¸»åŠ¨å‘æ¯ä¸€ä¸ª Slave å‘é€Pingæ¶ˆæ¯ï¼Œå¦‚æœåœ¨è®¾å®šæ—¶é—´å†…ï¼ˆflag.slave_ping_timeoutï¼Œé»˜è®¤15sï¼‰æ²¡æœ‰æ”¶åˆ°Slave çš„å›å¤ï¼Œå¹¶ä¸”è¾¾åˆ°ä¸€å®šæ¬¡æ•°ï¼ˆflag.max_slave_ping_timeoutsï¼Œé»˜è®¤æ¬¡æ•°ä¸º5ï¼‰ï¼Œé‚£ä¹ˆ Master ä¼šæ“ä½œä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li>å°†è¯¥ Slave ä» Master ä¸­åˆ é™¤ï¼Œæ­¤æ—¶è¯¥ Slave çš„èµ„æºå°†ä¸ä¼šå†åˆ†é…ç»™Schedulerã€‚</li><li>éå†è¯¥ Slave ä¸Šè¿è¡Œçš„æ‰€æœ‰ä»»åŠ¡ï¼Œå‘å¯¹åº”çš„ Framework å‘é€ä»»åŠ¡çš„ Task_Lost çŠ¶æ€æ›´æ–°ï¼ŒåŒæ—¶æŠŠè¿™äº›ä»»åŠ¡ä»Masterä¸­åˆ é™¤ã€‚</li><li>éå†è¯¥ Slave ä¸Šçš„æ‰€æœ‰ Executorï¼Œå¹¶åˆ é™¤ã€‚</li><li>è§¦å‘ Rescind Offerï¼ŒæŠŠè¿™ä¸ª Slave ä¸Šå·²ç»åˆ†é…ç»™ Scheduler çš„ Offer æ’¤é”€ã€‚</li><li>æŠŠè¿™ä¸ª Slave ä» Master çš„ Replicated log ä¸­åˆ é™¤ï¼ˆMesos Master ä¾èµ– Replicated log ä¸­çš„éƒ¨åˆ†æŒä¹…åŒ–é›†ç¾¤é…ç½®ä¿¡æ¯è¿›è¡Œ failer over / recoveryï¼‰ã€‚</li></ol></blockquote><ul><li>å¿…é¡» Slave è¿›è¡Œé‡å¯ï¼Œå› ä¸ºå¯¹æ‰§è¡Œå™¨çš„ç›¸å…³æ“ä½œåªèƒ½é€šè¿‡ Mesos Slaveï¼Œå³ <strong>Scheduler &lt;=&gt; Mesos Master &lt;=&gt; Mesos Slave &lt;=&gt; Executor</strong>ã€‚å¦‚æœ Slave ä¸€ç›´ä¸è¿›è¡Œé‡å¯ï¼Œæ‰§è¡Œå™¨ä¼šä¸€ç›´è¿è¡Œï¼Œé™¤éæœ‰å¦å¤–çš„æœºåˆ¶ï¼Œ<strong>é€šçŸ¥</strong>åˆ°æ‰§è¡Œå™¨ã€‚</li></ul><p>But..................<br>ç¬”è€…å°è¯•å¦‚ä¸Šæµç¨‹ï¼Œä½¿ç”¨ <code>kill -9</code> æ¨¡æ‹Ÿ Mesos Slave å¼‚å¸¸å´©æºƒï¼Œç­‰å¾… Mesos Master å‘ç° Mesos Slave å·²ç»å…³é—­ï¼Œ<strong>é‡å¯ Mesos Slave</strong>ï¼Œç»“æœæ‰§è¡Œå™¨( Elastic-Job-Cloud-Executor )æœªå…³é—­ï¼Œè°ƒåº¦å™¨( Elastic-Job-Cloud-Scheduler )å¹¶æœªæ”¶åˆ°ä»»åŠ¡çš„ TASK_LOSTã€‚ï¼Ÿï¼Ÿï¼Ÿä»€ä¹ˆæƒ…å†µï¼Ÿï¼Ÿï¼Ÿç¿»æŸ¥å¦‚ä¸‹æ–‡æ¡£ï¼š</p><ul><li><a href="http://mesos.apache.org/documentation/latest/high-availability-framework-guide/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos å®˜æ–¹æ–‡æ¡£ â€”â€” high-availability-framework-guideã€‹</a>æœç´¢æ ‡é¢˜ &quot;Dealing with Partitioned or Failed Agents&quot;ã€‚</li><li><a href="http://mesos.apache.org/documentation/latest/agent-recovery/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos å®˜æ–¹æ–‡æ¡£ â€”â€” agent-recoveryã€‹</a>æœç´¢å…³æ ‡é¢˜ &quot;Agent Recovery&quot;ã€‚</li></ul><p>å› ä¸º Elastic-Job-Cloud-Scheduler æ³¨å†Œåˆ° Mesos Master æ—¶ï¼Œå¼€å¯äº† <code>checkpoint</code> å’Œ <code>PARTITION_AWARE</code>ã€‚å¼€å¯ <code>checkpoint</code> åï¼ŒMesos Slave ä¼šå°†è®°å½•<strong>æ£€æŸ¥ç‚¹</strong>ä¿¡æ¯ï¼Œ Mesos Slave é‡å¯åï¼Œä¼šè¯»å–æ£€æŸ¥ç‚¹æ£€æŸ¥ä¿¡æ¯ï¼Œ**é‡æ–°è¿æ¥ä¸Š( ä¸ä¼šå…³é—­ )**è¿è¡Œåœ¨å®ƒä¸Šé¢çš„æ‰§è¡Œå™¨( Elastic-Job-Cloud-Scheduler )ã€‚å¼€å¯ <code>PARTITION_AWARE</code> åï¼ŒTASK_LOST ä¼šè¢«åŒºåˆ†æˆ TASK_UNREACHABLE, TASK_DROPPED, TASK_GONE, TASK_GONE_BY_OPERATOR, and TASK_UNKNOWNã€‚è¡¨ç°å¦‚ä¸‹ï¼š</p><ul><li><code>kill -9</code> æ¨¡æ‹Ÿ Mesos Slave å¼‚å¸¸å´©æºƒï¼Œç­‰å¾… Mesos Master å‘ç° Mesos Slave å·²ç»å…³é—­</li><li>è°ƒåº¦å™¨( Elastic-Job-Cloud-Scheduler ) æ¥æ”¶ç›´æ¥ç”± Mesos Master å‘é€çš„è¯¥ Mesos Slave ä¸Šçš„æ¯ä¸ªä»»åŠ¡ TASK_UNREACHABLEã€‚</li><li>Mesos Slave é‡å¯å®Œæˆã€‚</li><li>æ‰§è¡Œå™¨( Elastic-Job-Cloud-Executor ) é‡æ–°æ³¨å†Œåˆ°é‡å¯å¥½çš„ Mesos Slave ï¼Œå¹¶ç»§ç»­è¿è¡Œä»»åŠ¡ã€‚</li></ul><p>å¦‚æœ Elastic-Job-Cloud-Scheduler æ³¨å†Œåˆ° Mesos Master æ—¶ï¼Œå…³é—­äº† <code>PARTITION_AWARE</code> å’Œ <code>checkpoint</code>ï¼Œè¡¨ç°åŒ <strong>TASK_LOST</strong> æè¿°çš„è¿‡ç¨‹ã€‚</p><p>å¼€å¯ <code>checkpoint</code> å’Œ <code>PARTITION_AWARE</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><pre><code><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerService.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> SchedulerDriver <span class="title">getSchedulerDriver</span><span class="params">(<span class="keyword">final</span> TaskScheduler taskScheduler, <span class="keyword">final</span> JobEventBus jobEventBus, <span class="keyword">final</span> FrameworkIDService frameworkIDService)</span> </span>&#123;</div><div class="line">      Protos.FrameworkInfo.Builder builder = Protos.FrameworkInfo.newBuilder();</div><div class="line">      <span class="comment">// PARTITION_AWARE</span></div><div class="line">      builder.addCapabilitiesBuilder().setType(Protos.FrameworkInfo.Capability.Type.PARTITION_AWARE);</div><div class="line">      Protos.FrameworkInfo frameworkInfo = builder.setUser(mesosConfig.getUser()).setName(frameworkName)</div><div class="line">          .setHostname(mesosConfig.getHostname()).setFailoverTimeout(FRAMEWORK_FAILOVER_TIMEOUT_SECONDS)</div><div class="line">          .setWebuiUrl(WEB_UI_PROTOCOL + env.getFrameworkHostPort())</div><div class="line">          .setCheckpoint(<span class="keyword">true</span>) <span class="comment">// checkpoint</span></div><div class="line">          .build();</div><div class="line">      <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line"> &#125;</div></pre></td></tr></table></figure></code></pre><p><strong>æ˜¯ä¸æ˜¯å¼€å¯äº† <code>checkpoint</code>ï¼ŒMesos Slave é‡å¯ä¸ä¼šå…³é—­æ‰§è¡Œå™¨ï¼Ÿ</strong></p><p>ç­”æ¡ˆå½“ç„¶æ˜¯ä¸æ˜¯çš„ã€‚å½“ Mesos Slave é…ç½® <code>recover = cleanup</code> æˆ–è€… é‡å¯æ—¶é—´è¶…è¿‡ <code>recovery_timeout</code> ( é»˜è®¤ï¼Œ15 åˆ†é’Ÿ )æ—¶ï¼Œé‡å¯å®Œæˆåï¼ŒMesos Slave å…³é—­è¿è¡Œåœ¨å®ƒä¸Šé¢çš„æ‰§è¡Œå™¨( Elastic-Job-Cloud-Executor )ï¼Œè°ƒåº¦å™¨( Elastic-Job-Cloud-Scheduler ) æ¥æ”¶åˆ°çš„è¯¥ Mesos Slave ä¸Šçš„æ¯ä¸ªä»»åŠ¡ TASK_FAILEDã€‚</p><ul><li>å‚è€ƒæ–‡æ¡£ï¼š<a href="http://mesos.apache.org/documentation/latest/agent-recovery/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos å®˜æ–¹æ–‡æ¡£ â€”â€” agent-recoveryã€‹</a>æœç´¢æ ‡é¢˜ &quot;Agent Configuration&quot;ã€‚</li></ul></li></ul><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_10/01.png" alt=""></p><hr><p>è°ƒç”¨ <code>FacadeService#recordFailoverTask(...)</code> æ–¹æ³•ï¼Œè®°å½•å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordFailoverTask</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   Optional&lt;CloudJobConfiguration&gt; jobConfigOptional = jobConfigService.load(taskContext.getMetaInfo().getJobName());</div><div class="line">   <span class="keyword">if</span> (!jobConfigOptional.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (isDisable(jobConfigOptional.get())) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   CloudJobConfiguration jobConfig = jobConfigOptional.get();</div><div class="line">   <span class="keyword">if</span> (jobConfig.getTypeConfig().getCoreConfig().isFailover() <span class="comment">// å¼€å¯å¤±æ•ˆè½¬ç§»</span></div><div class="line">           || CloudJobExecutionType.DAEMON == jobConfig.getJobExecutionType()) &#123; <span class="comment">// å¸¸é©»ä½œä¸š</span></div><div class="line">       failoverService.add(taskContext);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å¯¹äº<strong>ç¬æ—¶</strong>ä½œä¸šï¼Œå¿…é¡»å¼€å¯ <code>JobCoreConfiguration.failover = true</code>ï¼Œæ‰èƒ½å¤±æ•ˆè½¬ç§»ï¼Œè¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£ã€‚</li><li>å¯¹äº<strong>å¸¸é©»</strong>ä½œä¸šï¼Œæš‚æ—¶ä¸æ”¯æŒå¤±æ•ˆè½¬ç§»ã€‚å› ä¸ºå¸¸é©»ä½œä¸šæ˜¯åœ¨æ‰§è¡Œå™¨( Elastic-Job-Executor ) è¿›è¡Œè°ƒåº¦æ‰§è¡Œï¼Œå¦‚æœä¸æ·»åŠ åˆ°å¤±æ•ˆè½¬ç§»ä½œä¸šé˜Ÿåˆ—ï¼Œé‡æ–°æäº¤åˆ°æ‰§è¡Œå™¨( Elastic-Job-Executor )ï¼Œåç»­å°±ä¸èƒ½è°ƒåº¦æ‰§è¡Œè¯¥ä½œä¸šäº†ã€‚</li><li>è°ƒç”¨ <code>FailoverService#add(...)</code> æ–¹æ³•ï¼Œå°†ä»»åŠ¡æ”¾å…¥å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</li></ul><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (regCenter.getNumChildren(FailoverNode.ROOT) &gt; env.getFrameworkConfiguration().getJobStateQueueSize()) &#123;</div><div class="line">       log.warn(<span class="string">"Cannot add job, caused by read state queue size is larger than &#123;&#125;."</span>, env.getFrameworkConfiguration().getJobStateQueueSize());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   String failoverTaskNodePath = FailoverNode.getFailoverTaskNodePath(taskContext.getMetaInfo().toString());</div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(failoverTaskNodePath) <span class="comment">// åˆ¤æ–­ä¸åœ¨å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</span></div><div class="line">           &amp;&amp; !runningService.isTaskRunning(taskContext.getMetaInfo())) &#123; <span class="comment">// åˆ¤æ–­ä¸åœ¨è¿è¡Œä¸­</span></div><div class="line">       regCenter.persist(failoverTaskNodePath, taskContext.getId());</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// FailoverNode.java</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FailoverNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = StateNode.ROOT + <span class="string">"/failover"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FAILOVER_JOB = ROOT + <span class="string">"/%s"</span>; <span class="comment">// %s=$&#123;JOB_NAME&#125;</span></div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FAILOVER_TASK = FAILOVER_JOB + <span class="string">"/%s"</span>; <span class="comment">// %s=$&#123;TASK_META_INFO&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>FailoverServiceï¼Œå¤±æ•ˆè½¬ç§»é˜Ÿåˆ—æœåŠ¡ã€‚</p></li><li><p><strong>å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</strong>å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${NAMESPACE}/state/failover/${JOB_NAME}/${TASK_META_INFO}</code>ï¼Œå­˜å‚¨å€¼ä¸ºä»»åŠ¡ç¼–å·ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p><p><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">    [zk: localhost:2181(CONNECTED) 2] ls /elastic-job-cloud/state/failover/test_job_simple</div><div class="line">[test_job_simple@-@0]</div><div class="line">[zk: localhost:2181(CONNECTED) 3] get /elastic-job-cloud/state/failover/test_job_simple/test_job_simple@-@0</div><div class="line">test_job_simple@-@0@-@READY@-@4da72be3-43d5-4f02-9d7e-45feb30b8fcb-S2@-@8f2a5bb5-2941-4ece-b192-0f936e60faa7</div></pre></td></tr></table></figure></p></li><li><p>åœ¨è¿ç»´å¹³å°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_10/02.png" alt=""></p></li></ul><h1>3. æäº¤å¤±æ•ˆè½¬ç§»ä½œä¸š</h1><p>åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹ã€Œ4.1 åˆ›å»º Fenzo ä»»åŠ¡è¯·æ±‚ã€</a>é‡Œï¼Œè°ƒç”¨ <code>FacadeService#getEligibleJobContext()</code> æ–¹æ³•ï¼Œè·å–æœ‰èµ„æ ¼è¿è¡Œçš„ä½œä¸šæ—¶ã€‚<code>FacadeService#getEligibleJobContext()</code> ä¸ä»…è°ƒç”¨ <code>ReadyService#getAllEligibleJobContexts(...)</code> æ–¹æ³•ï¼Œä»<strong>å¾…æ‰§è¡Œé˜Ÿåˆ—</strong>ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡ï¼Œä¹Ÿè°ƒç”¨ <code>FailoverService#getAllEligibleJobContexts()</code> æ–¹æ³•ï¼Œä»<strong>å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</strong>ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;JobContext&gt; <span class="title">getAllEligibleJobContexts</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ä¸å­˜åœ¨ å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</span></div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(FailoverNode.ROOT)) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è·å– å¤±æ•ˆè½¬ç§»é˜Ÿåˆ— çš„ä½œä¸šä»¬</span></div><div class="line">   List&lt;String&gt; jobNames = regCenter.getChildrenKeys(FailoverNode.ROOT);</div><div class="line">   Collection&lt;JobContext&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(jobNames.size());</div><div class="line">   Set&lt;HashCode&gt; assignedTasks = <span class="keyword">new</span> HashSet&lt;&gt;(jobNames.size() * <span class="number">10</span>, <span class="number">1</span>);</div><div class="line">   <span class="keyword">for</span> (String each : jobNames) &#123;</div><div class="line">       <span class="comment">// ä¸ºç©ºæ—¶ï¼Œç§»é™¤ å¤±æ•ˆè½¬ç§»é˜Ÿåˆ— çš„ä½œä¸š</span></div><div class="line">       List&lt;String&gt; taskIdList = regCenter.getChildrenKeys(FailoverNode.getFailoverJobNodePath(each));</div><div class="line">       <span class="keyword">if</span> (taskIdList.isEmpty()) &#123;</div><div class="line">           regCenter.remove(FailoverNode.getFailoverJobNodePath(each));</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// æ’é™¤ ä½œä¸šé…ç½® ä¸å­˜åœ¨çš„ä½œä¸š</span></div><div class="line">       Optional&lt;CloudJobConfiguration&gt; jobConfig = configService.load(each);</div><div class="line">       <span class="keyword">if</span> (!jobConfig.isPresent()) &#123;</div><div class="line">           regCenter.remove(FailoverNode.getFailoverJobNodePath(each));</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// è·å¾—å¾…æ‰§è¡Œçš„åˆ†ç‰‡é›†åˆ</span></div><div class="line">       List&lt;Integer&gt; assignedShardingItems = getAssignedShardingItems(each, taskIdList, assignedTasks);</div><div class="line">       <span class="comment">//</span></div><div class="line">       <span class="keyword">if</span> (!assignedShardingItems.isEmpty() &amp;&amp; jobConfig.isPresent()) &#123;</div><div class="line">           result.add(<span class="keyword">new</span> JobContext(jobConfig.get(), assignedShardingItems, ExecutionType.FAILOVER));    </div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> List&lt;Integer&gt; <span class="title">getAssignedShardingItems</span><span class="params">(<span class="keyword">final</span> String jobName, <span class="keyword">final</span> List&lt;String&gt; taskIdList, <span class="keyword">final</span> Set&lt;HashCode&gt; assignedTasks)</span> </span>&#123;</div><div class="line">   List&lt;Integer&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(taskIdList.size());</div><div class="line">   <span class="keyword">for</span> (String each : taskIdList) &#123;</div><div class="line">       TaskContext.MetaInfo metaInfo = TaskContext.MetaInfo.from(each);</div><div class="line">       <span class="keyword">if</span> (assignedTasks.add(Hashing.md5().newHasher().putString(jobName, Charsets.UTF_8).putInt(metaInfo.getShardingItems().get(<span class="number">0</span>)).hash()) <span class="comment">// æ’é‡</span></div><div class="line">               &amp;&amp; !runningService.isTaskRunning(metaInfo)) &#123; <span class="comment">// æ’é™¤æ­£åœ¨è¿è¡Œä¸­</span></div><div class="line">           result.add(metaInfo.getShardingItems().get(<span class="number">0</span>));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><hr><p>åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹ã€Œ4.4 åˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯ã€</a>é‡Œï¼Œè°ƒç”¨ <code>LaunchingTasks#getIntegrityViolationJobs()</code> æ–¹æ³•ï¼Œè·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LaunchingTasks.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> vmAssignmentResults ä¸»æœºåˆ†é…ä»»åŠ¡ç»“æœé›†åˆ</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function">Collection&lt;String&gt; <span class="title">getIntegrityViolationJobs</span><span class="params">(<span class="keyword">final</span> Collection&lt;VMAssignmentResult&gt; vmAssignmentResults)</span> </span>&#123;</div><div class="line">   Map&lt;String, Integer&gt; assignedJobShardingTotalCountMap = getAssignedJobShardingTotalCountMap(vmAssignmentResults);</div><div class="line">   Collection&lt;String&gt; result = <span class="keyword">new</span> HashSet&lt;&gt;(assignedJobShardingTotalCountMap.size(), <span class="number">1</span>);</div><div class="line">   <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : assignedJobShardingTotalCountMap.entrySet()) &#123;</div><div class="line">       JobContext jobContext = eligibleJobContextsMap.get(entry.getKey());</div><div class="line">       <span class="keyword">if</span> (ExecutionType.FAILOVER != jobContext.getType() <span class="comment">// ä¸åŒ…æ‹¬ FAILOVER æ‰§è¡Œç±»å‹çš„ä½œä¸š</span></div><div class="line">               &amp;&amp; !entry.getValue().equals(jobContext.getJobConfig().getTypeConfig().getCoreConfig().getShardingTotalCount())) &#123;</div><div class="line">           log.warn(<span class="string">"Job &#123;&#125; is not assigned at this time, because resources not enough to run all sharding instances."</span>, entry.getKey());</div><div class="line">           result.add(entry.getKey());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä¸€ä¸ªä½œä¸šå¯èƒ½å­˜åœ¨éƒ¨åˆ†åˆ†ç‰‡éœ€è¦å¤±æ•ˆè½¬ç§»ï¼Œä¸éœ€è¦è€ƒè™‘å®Œæ•´æ€§ã€‚</li></ul><hr><p>åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹ã€Œ4.7 ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸šã€</a>é‡Œï¼Œè°ƒç”¨ <code>FailoverService#remove(...)</code> æ–¹æ³•ï¼Œä»å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ä¸­åˆ é™¤ç›¸å…³ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> Collection&lt;TaskContext.MetaInfo&gt; metaInfoList)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (TaskContext.MetaInfo each : metaInfoList) &#123;</div><div class="line">       regCenter.remove(FailoverNode.getFailoverTaskNodePath(each.toString()));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h1>666. å½©è›‹</h1><p>åŸæœ¬ä»¥ä¸ºä¼šæ˜¯ä¸€ç¯‡æ°´æ›´ï¼Œåé¢ç ”ç©¶ TASK_LOSTï¼Œå‘ç°æ”¶è·å¤§å¤§çš„ï¼Œå¹²è´§å¦¥å¦¥çš„ã€‚</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_10/03.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. è®°å½•ä½œä¸šå¤±æ•ˆè½¬ç§»&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#
      
    
    </summary>
    
      <category term="Elastic-Job-Cloud" scheme="http://www.iocoder.cn/categories/Elastic-Job-Cloud/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Cloud æºç åˆ†æ â€”â€” æœ¬åœ°è¿è¡Œæ¨¡å¼</title>
    <link href="http://www.iocoder.cn/Elastic-Job/cloud-local-executor/"/>
    <id>http://www.iocoder.cn/Elastic-Job/cloud-local-executor/</id>
    <published>2018-01-02T16:00:00.000Z</published>
    <updated>2017-09-06T10:53:50.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. é…ç½®</a></li><li><a href="#">3. è¿è¡Œ</a></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Cloud æœ¬åœ°è¿è¡Œæ¨¡å¼</strong>ï¼Œå¯¹åº”<a href="http://elasticjob.io/docs/elastic-job-cloud/02-guide/local-executor/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” æœ¬åœ°è¿è¡Œæ¨¡å¼ã€‹</a>ã€‚</p><p><strong>æœ‰ä»€ä¹ˆç”¨å‘¢</strong>ï¼Ÿå¼•ç”¨å®˜æ–¹è§£ç­”ï¼š</p><blockquote><p>åœ¨å¼€å‘ Elastic-Job-Cloud ä½œä¸šæ—¶ï¼Œå¼€å‘äººå‘˜å¯ä»¥è„±ç¦» Mesos ç¯å¢ƒï¼Œåœ¨æœ¬åœ°è¿è¡Œå’Œè°ƒè¯•ä½œä¸šã€‚å¯ä»¥åˆ©ç”¨æœ¬åœ°è¿è¡Œæ¨¡å¼å……åˆ†çš„è°ƒè¯•ä¸šåŠ¡åŠŸèƒ½ä»¥åŠå•å…ƒæµ‹è¯•ï¼Œå®Œæˆä¹‹åå†éƒ¨ç½²è‡³ Mesos é›†ç¾¤ã€‚<br>æœ¬åœ°è¿è¡Œä½œä¸šæ— éœ€å®‰è£… Mesos ç¯å¢ƒã€‚</p></blockquote><p>ğŸ˜ˆ æ˜¯ä¸æ˜¯å¾ˆèµ + 1024ï¼Ÿï¼</p><p>æœ¬æ–‡æ¶‰åŠåˆ°ä¸»ä½“ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Elastic-Job/2018_01_03/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_03/01.png" alt=""></p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><h1>2. é…ç½®</h1><p>LocalCloudJobConfigurationï¼Œæœ¬åœ°äº‘ä½œä¸šé…ç½®ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-local-executor/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹ã€Œ3.2 æœ¬åœ°äº‘ä½œä¸šé…ç½®ã€</a>æœ‰è¯¦ç»†è§£æã€‚</p><p>åˆ›å»ºæœ¬åœ°äº‘ä½œä¸šé…ç½®ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼ˆæ¥è‡ªå®˜æ–¹ï¼‰ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">LocalCloudJobConfiguration config = <span class="keyword">new</span> LocalCloudJobConfiguration(</div><div class="line">    <span class="keyword">new</span> SimpleJobConfiguration(</div><div class="line">    <span class="comment">// é…ç½®ä½œä¸šç±»å‹å’Œä½œä¸šåŸºæœ¬ä¿¡æ¯</span></div><div class="line">    JobCoreConfiguration.newBuilder(<span class="string">"FooJob"</span>, <span class="string">"*/2 * * * * ?"</span>, <span class="number">3</span>) </div><div class="line">        .shardingItemParameters(<span class="string">"0=Beijing,1=Shanghai,2=Guangzhou"</span>)</div><div class="line">        .jobParameter(<span class="string">"dbName=dangdang"</span>).build(), <span class="string">"com.dangdang.foo.FooJob"</span>),</div><div class="line">        <span class="comment">// é…ç½®å½“å‰è¿è¡Œçš„ä½œä¸šæ˜¯ç¬¬å‡ ä¸ªåˆ†ç‰‡ </span></div><div class="line">        <span class="number">1</span>,  </div><div class="line">        <span class="comment">// é…ç½®Springç›¸å…³å‚æ•°ã€‚å¦‚æœä¸é…ç½®ï¼Œä»£è¡¨ä¸ä½¿ç”¨ Spring é…ç½®ã€‚</span></div><div class="line">        <span class="string">"testSimpleJob"</span> , <span class="string">"applicationContext.xml"</span>);</div></pre></td></tr></table></figure></p><h1>3. è¿è¡Œ</h1><p>LocalTaskExecutorï¼Œæœ¬åœ°ä½œä¸šæ‰§è¡Œå™¨ã€‚</p><p>åˆ›å»ºæœ¬åœ°ä½œä¸šæ‰§è¡Œå™¨ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼ˆæ¥è‡ªå®˜æ–¹ï¼‰ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">new</span> LocalTaskExecutor(localJobConfig).execute();</div></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨ <code>LocalTaskExecutor#execute()</code> æ–¹æ³•ï¼Œæ‰§è¡Œä½œä¸šé€»è¾‘ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LocalTaskExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">   AbstractElasticJobExecutor jobExecutor;</div><div class="line">   CloudJobFacade jobFacade = <span class="keyword">new</span> CloudJobFacade(getShardingContexts(), getJobConfigurationContext(), <span class="keyword">new</span> JobEventBus());</div><div class="line">   <span class="comment">// åˆ›å»ºæ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">switch</span> (localCloudJobConfiguration.getTypeConfig().getJobType()) &#123;</div><div class="line">       <span class="keyword">case</span> SIMPLE:</div><div class="line">           jobExecutor = <span class="keyword">new</span> SimpleJobExecutor(getJobInstance(SimpleJob.class), jobFacade);</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> DATAFLOW:</div><div class="line">           jobExecutor = <span class="keyword">new</span> DataflowJobExecutor(getJobInstance(DataflowJob.class), jobFacade);</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> SCRIPT:</div><div class="line">           jobExecutor = <span class="keyword">new</span> ScriptJobExecutor(jobFacade);</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">default</span>:</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(localCloudJobConfiguration.getTypeConfig().getJobType().name());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">   jobExecutor.execute();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#getShardingContexts()</code> æ–¹æ³•ï¼Œåˆ›å»ºåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ( ShardingContexts )ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ShardingContexts <span class="title">getShardingContexts</span><span class="params">()</span> </span>&#123;</div><div class="line">   JobCoreConfiguration coreConfig = localCloudJobConfiguration.getTypeConfig().getCoreConfig();</div><div class="line">   Map&lt;Integer, String&gt; shardingItemMap = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1</span>, <span class="number">1</span>);</div><div class="line">   shardingItemMap.put(localCloudJobConfiguration.getShardingItem(),</div><div class="line">           <span class="keyword">new</span> ShardingItemParameters(coreConfig.getShardingItemParameters()).getMap().get(localCloudJobConfiguration.getShardingItem()));</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ShardingContexts(</div><div class="line">           <span class="comment">// taskId ğŸ‘‡</span></div><div class="line">           Joiner.on(<span class="string">"@-@"</span>).join(localCloudJobConfiguration.getJobName(), localCloudJobConfiguration.getShardingItem(), <span class="string">"READY"</span>, <span class="string">"foo_slave_id"</span>, <span class="string">"foo_uuid"</span>),</div><div class="line">           localCloudJobConfiguration.getJobName(), coreConfig.getShardingTotalCount(), coreConfig.getJobParameter(), shardingItemMap);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>#getJobConfigurationContext()</code> æ–¹æ³•ï¼Œåˆ›å»ºå†…éƒ¨çš„ä½œä¸šé…ç½®ä¸Šä¸‹æ–‡( JobConfigurationContext )ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> JobConfigurationContext <span class="title">getJobConfigurationContext</span><span class="params">()</span> </span>&#123;</div><div class="line">   Map&lt;String, String&gt; jobConfigurationMap = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">   jobConfigurationMap.put(<span class="string">"jobClass"</span>, localCloudJobConfiguration.getTypeConfig().getJobClass());</div><div class="line">   jobConfigurationMap.put(<span class="string">"jobType"</span>, localCloudJobConfiguration.getTypeConfig().getJobType().name());</div><div class="line">   jobConfigurationMap.put(<span class="string">"jobName"</span>, localCloudJobConfiguration.getJobName());</div><div class="line">   jobConfigurationMap.put(<span class="string">"beanName"</span>, localCloudJobConfiguration.getBeanName());</div><div class="line">   jobConfigurationMap.put(<span class="string">"applicationContext"</span>, localCloudJobConfiguration.getApplicationContext());</div><div class="line">   <span class="keyword">if</span> (JobType.DATAFLOW == localCloudJobConfiguration.getTypeConfig().getJobType()) &#123; <span class="comment">// æ•°æ®æµä½œä¸š</span></div><div class="line">       jobConfigurationMap.put(<span class="string">"streamingProcess"</span>, Boolean.toString(((DataflowJobConfiguration) localCloudJobConfiguration.getTypeConfig()).isStreamingProcess()));</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (JobType.SCRIPT == localCloudJobConfiguration.getTypeConfig().getJobType()) &#123; <span class="comment">// è„šæœ¬ä½œä¸š</span></div><div class="line">       jobConfigurationMap.put(<span class="string">"scriptCommandLine"</span>, ((ScriptJobConfiguration) localCloudJobConfiguration.getTypeConfig()).getScriptCommandLine());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> JobConfigurationContext(jobConfigurationMap);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>#getJobInstance(...)</code> æ–¹æ³•ï¼Œ è·å¾—åˆ†å¸ƒå¼ä½œä¸š( ElasticJob )å®ç°å®ä¾‹ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> &lt;T extends ElasticJob&gt; <span class="function">T <span class="title">getJobInstance</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; clazz)</span> </span>&#123;</div><div class="line">   Object result;</div><div class="line">   <span class="keyword">if</span> (Strings.isNullOrEmpty(localCloudJobConfiguration.getApplicationContext())) &#123; <span class="comment">// ç›´æ¥åˆ›å»º ElasticJob</span></div><div class="line">       String jobClass = localCloudJobConfiguration.getTypeConfig().getJobClass();</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           result = Class.forName(jobClass).newInstance();</div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ReflectiveOperationException ex) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(<span class="string">"Elastic-Job: Class '%s' initialize failure, the error message is '%s'."</span>, jobClass, ex.getMessage());</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123; <span class="comment">// Spring ç¯å¢ƒè·å¾— ElasticJob</span></div><div class="line">       result = <span class="keyword">new</span> ClassPathXmlApplicationContext(localCloudJobConfiguration.getApplicationContext()).getBean(localCloudJobConfiguration.getBeanName());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> clazz.cast(result);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>AbstractElasticJobExecutor#execute()</code> æ–¹æ³•ï¼Œæ‰§è¡Œä½œä¸šé€»è¾‘ã€‚ Elastic-Job-Lite å’Œ Elastic-Job-Cloud ä½œä¸šæ‰§è¡ŒåŸºæœ¬ä¸€è‡´ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</p></li></ul><h1>666. å½©è›‹</h1><p>èŠ‹é“å›ï¼šå¯èƒ½æœ‰ç‚¹æ°´æ›´ï¼Œå’Œå¤§å®¶å®é™…å¼€å‘å¤ªç›¸å…³ï¼Œæƒ³æƒ³è¿˜æ˜¯æ›´æ–°ä¸‹ã€‚<br>æ—ç™½å›ï¼šå“å“Ÿå“Ÿï¼Œå“å“Ÿå–‚ã€‚</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_03/02.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. é…ç½®&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;3. è¿
      
    
    </summary>
    
      <category term="Elastic-Job-Cloud" scheme="http://www.iocoder.cn/categories/Elastic-Job-Cloud/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆäºŒï¼‰</title>
    <link href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-second/"/>
    <id>http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-second/</id>
    <published>2017-12-27T16:00:00.000Z</published>
    <updated>2017-09-07T15:59:34.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. äº‘ä½œä¸šæ“ä½œ</a><ul><li><a href="#">2.1 æ³¨å†Œäº‘ä½œä¸šé…ç½®</a></li><li><a href="#">2.2 ç¦ç”¨äº‘ä½œä¸š</a></li><li><a href="#">2.3 å¯åŠ¨äº‘ä½œä¸š</a></li><li><a href="#">2.4 æ›´æ–°äº‘ä½œä¸šé…ç½®</a></li><li><a href="#">2.5 æ³¨é”€äº‘ä½œä¸š</a></li><li><a href="#">2.6 è§¦å‘ä¸€æ¬¡äº‘ä½œä¸š</a></li></ul></li><li><a href="#">3. äº‘ä½œä¸šåº”ç”¨æ“ä½œ</a><ul><li><a href="#">3.1 æ³¨å†Œäº‘ä½œä¸šåº”ç”¨</a></li><li><a href="#">3.2 æ›´æ–°äº‘ä½œä¸šåº”ç”¨é…ç½®</a></li><li><a href="#">3.3 ç¦ç”¨äº‘ä½œä¸šåº”ç”¨</a></li><li><a href="#">3.4 å¯ç”¨äº‘ä½œä¸šåº”ç”¨</a></li><li><a href="#">3.5 æ³¨é”€äº‘ä½œä¸šåº”ç”¨</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Cloud äº‘ä½œä¸šåº”ç”¨é…ç½®å’Œäº‘ä½œä¸šé…ç½®å˜æ›´å¯¹ä½œä¸šè°ƒåº¦çš„å½±å“</strong>ï¼Œä½œä¸º<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>çš„è¡¥å……å†…å®¹ã€‚æ‰€ä»¥éœ€è¦ä½ å¯¹<strong>ä½œä¸šè°ƒåº¦</strong>å·²ç»æœ‰ä¸€å®šäº†è§£çš„åŸºç¡€ä¸Šã€‚</p><p>ğŸ™‚ å¦‚æœä½ åšä½œä¸šè°ƒåº¦æœ‰ä»»ä½•æƒ³äº¤æµï¼Œæ¬¢è¿åŠ æˆ‘çš„å…¬ä¼—å·( èŠ‹é“æºç  ) æˆ– å¾®ä¿¡( wangwenbin-server ) äº¤æµã€‚</p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><h1>2. äº‘ä½œä¸šæ“ä½œ</h1><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>è¿ç»´å¹³å°</strong>æˆ– Restful API å¯¹äº‘ä½œä¸šè¿›è¡Œæ“ä½œã€‚å‰è€…æ˜¯å¯¹åè€…çš„ç•Œé¢åŒ…è£…ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_28/01.png" alt=""></p><h2>2.1 æ³¨å†Œäº‘ä½œä¸šé…ç½®</h2><p><a href="http://www.iocoder.cn/Elastic-Job/cloud-job-config/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹ã€Œ3.1.1 æ“ä½œäº‘ä½œä¸šé…ç½®ã€</a>æœ‰è¯¦ç»†è§£æã€‚</p><h2>2.2 ç¦ç”¨äº‘ä½œä¸š</h2><p>è°ƒç”¨ <code>CloudJobRestfulApi#disable(...)</code> æ–¹æ³•ï¼Œç¦ç”¨äº‘ä½œä¸šï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@POST</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/&#123;jobName&#125;/disable"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disable</span><span class="params">(@PathParam(<span class="string">"jobName"</span>)</span> <span class="keyword">final</span> String jobName) </span>&#123;</div><div class="line">   <span class="keyword">if</span> (configService.load(jobName).isPresent()) &#123;</div><div class="line">       <span class="comment">// å°†ä½œä¸šæ”¾å…¥ç¦ç”¨é˜Ÿåˆ—</span></div><div class="line">       facadeService.disableJob(jobName);</div><div class="line">       <span class="comment">// åœæ­¢è°ƒåº¦ä½œä¸š</span></div><div class="line">       producerManager.unschedule(jobName);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>FacadeService#disableJob(...)</code> æ–¹æ³•ï¼Œå°†ä½œä¸šæ”¾å…¥<strong>ç¦ç”¨ä½œä¸šé˜Ÿåˆ—</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disableJob</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   disableJobService.add(jobName);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DisableJobService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (regCenter.getNumChildren(DisableJobNode.ROOT) &gt; env.getFrameworkConfiguration().getJobStateQueueSize()) &#123;</div><div class="line">       log.warn(<span class="string">"Cannot add disable job, caused by read state queue size is larger than &#123;&#125;."</span>, env.getFrameworkConfiguration().getJobStateQueueSize());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å°†ä½œä¸šæ”¾å…¥ç¦ç”¨é˜Ÿåˆ—</span></div><div class="line">   String disableJobNodePath = DisableJobNode.getDisableJobNodePath(jobName);</div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(disableJobNodePath)) &#123;</div><div class="line">       regCenter.persist(disableJobNodePath, jobName);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DisableJobNode.java</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DisableJobNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = StateNode.ROOT + <span class="string">"/disable/job"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DISABLE_JOB = ROOT + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;JOB_NAME&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>DisableJobServiceï¼Œç¦ç”¨ä½œä¸šé˜Ÿåˆ—æœåŠ¡ã€‚</p></li><li><p>ç¦ç”¨ä½œä¸šé˜Ÿåˆ—å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${NAMESPACE}/state/disable/job/${JOB_NAME}</code>ï¼Œå­˜å‚¨å€¼ä¸ºä½œä¸šåç§°ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p><p><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">    [zk: localhost:2181(CONNECTED) 6] ls /elastic-job-cloud/state/disable/job</div><div class="line">[test_job_simple]</div></pre></td></tr></table></figure></p></li></ul></li><li><p>è°ƒç”¨ <code>ProducerManager#unschedule(...)</code> æ–¹æ³•ï¼Œåœæ­¢è°ƒåº¦ä½œä¸šã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unschedule</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ€æ­»ä½œä¸šå¯¹åº”çš„ Mesos ä»»åŠ¡ä»¬</span></div><div class="line">   <span class="keyword">for</span> (TaskContext each : runningService.getRunningTasks(jobName)) &#123;</div><div class="line">       schedulerDriver.killTask(Protos.TaskID.newBuilder().setValue(each.getId()).build());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å°†ä½œä¸šä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤</span></div><div class="line">   runningService.remove(jobName);</div><div class="line">   <span class="comment">// å°†ä½œä¸šä»å¾…è¿è¡Œé˜Ÿåˆ—åˆ é™¤</span></div><div class="line">   readyService.remove(Lists.newArrayList(jobName));</div><div class="line">   <span class="comment">// åœæ­¢ä½œä¸šè°ƒåº¦</span></div><div class="line">   Optional&lt;CloudJobConfiguration&gt; jobConfig = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (jobConfig.isPresent()) &#123;</div><div class="line">       transientProducerScheduler.deregister(jobConfig.get());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>SchedulerDriver#killTask(...)</code> æ–¹æ³•ï¼Œæ€æ­»ä½œä¸šå¯¹åº”çš„ Mesos ä»»åŠ¡ä»¬ï¼Œé€‚ç”¨<strong>å¸¸é©»ä½œä¸š</strong>ã€‚Elastic-Job-Cloud-Scheduler ä¼šæ¥æ”¶åˆ° Mesos æ€æ­»ä»»åŠ¡çš„è¯·æ±‚ï¼Œè°ƒç”¨ <code>TaskExecutor#killTask(...)</code> æ–¹æ³•ï¼Œåœæ­¢ä»»åŠ¡è°ƒåº¦ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TaskExecutor.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">killTask</span><span class="params">(<span class="keyword">final</span> ExecutorDriver executorDriver, <span class="keyword">final</span> Protos.TaskID taskID)</span> </span>&#123;</div><div class="line">        <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œå·²æ€æ­»ã€‚</span></div><div class="line">        executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskID).setState(Protos.TaskState.TASK_KILLED).build());</div><div class="line">        <span class="comment">// å…³é—­è¯¥ Mesos ä»»åŠ¡çš„è°ƒåº¦</span></div><div class="line">        DaemonTaskScheduler.shutdown(taskID);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DaemonTaskScheduler.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åœæ­¢ä»»åŠ¡è°ƒåº¦.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskID ä»»åŠ¡ä¸»é”®</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">(<span class="keyword">final</span> Protos.TaskID taskID)</span> </span>&#123;</div><div class="line">   <span class="comment">// ç§»é™¤ä»»åŠ¡çš„ Quartz Scheduler</span></div><div class="line">   Scheduler scheduler = RUNNING_SCHEDULERS.remove(taskID.getValue());</div><div class="line">   <span class="comment">// å…³é—­ä»»åŠ¡çš„ Quartz Scheduler</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != scheduler) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           scheduler.shutdown();</div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li></li></ul></li><li><p>è°ƒç”¨ <code>RunningService#remove(...)</code> æ–¹æ³•ï¼Œå°†ä½œä¸šä»<strong>è¿è¡Œæ—¶é˜Ÿåˆ—</strong>åˆ é™¤ã€‚</p></li><li><p>è°ƒç”¨ <code>ReadyService#remove(...)</code> æ–¹æ³•ï¼Œå°†ä½œä¸šä»<strong>å¾…è¿è¡Œé˜Ÿåˆ—</strong>åˆ é™¤ã€‚</p></li><li><p>è°ƒç”¨ <code>TransientProducerScheduler#deregister(...)</code> æ–¹æ³•ï¼Œåœæ­¢ä½œä¸šè°ƒåº¦ï¼Œé€‚ç”¨<strong>ç¬æ—¶ä½œä¸š</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">deregister</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">    <span class="comment">// ç§»é™¤ä½œä¸š</span></div><div class="line">    repository.remove(jobConfig.getJobName());</div><div class="line">    <span class="comment">// è‹¥ cron ä¸å†å¯¹åº”æœ‰ä½œä¸šè°ƒåº¦ï¼Œç§»é™¤ Quartz Scheduler å¯¹ cron å¯¹åº”çš„ Quartz Job</span></div><div class="line">    String cron = jobConfig.getTypeConfig().getCoreConfig().getCron();</div><div class="line">    <span class="keyword">if</span> (!repository.containsKey(buildJobKey(cron))) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            scheduler.unscheduleJob(TriggerKey.triggerKey(cron));</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul></li></ul><h2>2.3 å¯åŠ¨äº‘ä½œä¸š</h2><p>è°ƒç”¨ <code>CloudJobRestfulApi#enable(...)</code> æ–¹æ³•ï¼Œå¯ç”¨äº‘ä½œä¸šï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@DELETE</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/&#123;jobName&#125;/disable"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enable</span><span class="params">(@PathParam(<span class="string">"jobName"</span>)</span> <span class="keyword">final</span> String jobName) <span class="keyword">throws</span> JSONException </span>&#123;</div><div class="line">   Optional&lt;CloudJobConfiguration&gt; configOptional = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (configOptional.isPresent()) &#123;</div><div class="line">       <span class="comment">// å°†ä½œä¸šç§»å‡ºç¦ç”¨é˜Ÿåˆ—</span></div><div class="line">       facadeService.enableJob(jobName);</div><div class="line">       <span class="comment">// é‡æ–°è°ƒåº¦ä½œä¸š</span></div><div class="line">       producerManager.reschedule(jobName);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>FacadeService#enableJob(...)</code> æ–¹æ³•ï¼Œå°†ä½œä¸šç§»å‡º<strong>ç¦ç”¨ä½œä¸šé˜Ÿåˆ—</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enableJob</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   disableJobService.remove(jobName);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DisableJobService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   regCenter.remove(DisableJobNode.getDisableJobNodePath(jobName));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>ProducerManager#reschedule(...)</code> æ–¹æ³•ï¼Œå°†ä½œä¸šé‡æ–°è°ƒåº¦ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reschedule</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   <span class="comment">// åœæ­¢è°ƒåº¦ä½œä¸š</span></div><div class="line">   unschedule(jobName);</div><div class="line">   <span class="comment">// è°ƒåº¦ä½œä¸š</span></div><div class="line">   Optional&lt;CloudJobConfiguration&gt; jobConfig = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (jobConfig.isPresent()) &#123;</div><div class="line">       schedule(jobConfig.get());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#unschedule(...)</code> æ–¹æ³•ï¼Œåœæ­¢è°ƒåº¦ä½œä¸šã€‚</li><li>è°ƒç”¨ <code>#schedule(...)</code> æ–¹æ³•ï¼Œè°ƒåº¦ä½œä¸šï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li></ul></li></ul><h2>2.4 æ›´æ–°äº‘ä½œä¸šé…ç½®</h2><p>è°ƒç”¨ <code>CloudJobRestfulApi#update(...)</code> æ–¹æ³•ï¼Œæ›´æ–°äº‘ä½œä¸šé…ç½®ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CloudJobRestfulApi.java</span></div><div class="line"><span class="meta">@PUT</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/update"</span>)</div><div class="line"><span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   producerManager.update(jobConfig);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ProducerManager.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   Optional&lt;CloudJobConfiguration&gt; jobConfigFromZk = configService.load(jobConfig.getJobName());</div><div class="line">   <span class="keyword">if</span> (!jobConfigFromZk.isPresent()) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Cannot found job '%s', please register first."</span>, jobConfig.getJobName());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ä¿®æ”¹äº‘ä½œä¸šé…ç½®</span></div><div class="line">   configService.update(jobConfig);</div><div class="line">   <span class="comment">// é‡æ–°è°ƒåº¦ä½œä¸š</span></div><div class="line">   reschedule(jobConfig.getJobName());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>ConfigService#update(jobConfig)</code> æ–¹æ³•ï¼Œä¿®æ”¹äº‘ä½œä¸šé…ç½®ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   regCenter.update(CloudJobConfigurationNode.getRootNodePath(jobConfig.getJobName()), CloudJobConfigurationGsonFactory.toJson(jobConfig));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>#reschedule(...)</code> æ–¹æ³•ï¼Œé‡æ–°è°ƒåº¦ä½œä¸šã€‚</p></li></ul><p>å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„ äº‘ä½œä¸šé…ç½®è¢«æ›´æ–°æ—¶ï¼Œäº‘ä½œä¸šé…ç½®å˜æ›´ç›‘å¬( CloudJobConfigurationListener )ä¼šç›‘å¬åˆ°ï¼Œå¹¶æ‰§è¡Œæ›´æ–°ç›¸åº”é€»è¾‘ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudJobConfigurationListener</span> <span class="keyword">implements</span> <span class="title">TreeCacheListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childEvent</span><span class="params">(<span class="keyword">final</span> CuratorFramework client, <span class="keyword">final</span> TreeCacheEvent event)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        String path = <span class="keyword">null</span> == event.getData() ? <span class="string">""</span> : event.getData().getPath();</div><div class="line">        <span class="keyword">if</span> (isJobConfigNode(event, path, Type.NODE_ADDED)) &#123;</div><div class="line">            <span class="comment">// .... çœç•¥æ— å…³ä»£ç </span></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isJobConfigNode(event, path, Type.NODE_UPDATED)) &#123;</div><div class="line">            CloudJobConfiguration jobConfig = getJobConfig(event);</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == jobConfig) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// ä»å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­åˆ é™¤ç›¸å…³ä½œä¸š</span></div><div class="line">            <span class="keyword">if</span> (CloudJobExecutionType.DAEMON == jobConfig.getJobExecutionType()) &#123;</div><div class="line">                readyService.remove(Collections.singletonList(jobConfig.getJobName()));</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// è®¾ç½®ç¦ç”¨é”™è¿‡é‡æ‰§è¡Œ</span></div><div class="line">            <span class="keyword">if</span> (!jobConfig.getTypeConfig().getCoreConfig().isMisfire()) &#123;</div><div class="line">                readyService.setMisfireDisabled(jobConfig.getJobName());</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// é‡æ–°è°ƒåº¦ä½œä¸š</span></div><div class="line">            producerManager.reschedule(jobConfig.getJobName());</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isJobConfigNode(event, path, Type.NODE_REMOVED)) &#123;</div><div class="line">            <span class="comment">// .... çœç•¥æ— å…³ä»£ç </span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>CloudJobConfigurationListener å®ç° TreeCacheListener å®ç°å¯¹ Zookeeper æ•°æ®å˜æ›´çš„ç›‘å¬ã€‚å¯¹ TreeCacheListener æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥æŸ¥çœ‹ <a href="https://curator.apache.org/" rel="external nofollow noopener noreferrer" target="_blank">Apache Curator</a> ç›¸å…³çŸ¥è¯†ã€‚</p></li><li><p>è°ƒç”¨ <code>ReadyService#remove(...)</code> æ–¹æ³•ï¼Œå°†ä½œä¸šä»<strong>å¾…è¿è¡Œé˜Ÿåˆ—</strong>åˆ é™¤ã€‚TODOï¼Œä¸ºå•¥è¦åˆ é™¤ï¼Ÿ</p></li><li><p>è°ƒç”¨ <code>ReadyService#setMisfireDisabled(...)</code> æ–¹æ³•ï¼Œè®¾ç½®ç¦ç”¨é”™è¿‡é‡æ‰§è¡Œã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMisfireDisabled</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   Optional&lt;CloudJobConfiguration&gt; cloudJobConfig = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (cloudJobConfig.isPresent() &amp;&amp; <span class="keyword">null</span> != regCenter.getDirectly(ReadyNode.getReadyJobNodePath(jobName))) &#123;</div><div class="line">       regCenter.persist(ReadyNode.getReadyJobNodePath(jobName), <span class="string">"1"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>ç¬æ—¶ä½œä¸š</strong>å¼€å¯ <code>misfire</code> åŠŸèƒ½æ—¶ï¼Œå½“ä»»åŠ¡æ‰§è¡Œè¿‡ä¹…è§¦å‘ <code>misifre</code> ä¼šä¸æ–­ç´¯ç§¯å¾…æ‰§è¡Œæ¬¡æ•°ã€‚å¦‚æœå…³é—­ <code>misfire</code> åŠŸèƒ½ï¼Œéœ€è¦å°†å¤šæ¬¡æ‰§è¡Œæ¬¡æ•°å½’ <code>&quot;1&quot;</code>ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>ProducerManager#reschedule(...)</code> æ–¹æ³•ï¼Œé‡æ–°è°ƒåº¦ä½œä¸šã€‚TODOï¼Œä¸ºå•¥è¦é‡å¤è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Ÿ</p></li></ul><h2>2.5 æ³¨é”€äº‘ä½œä¸š</h2><p>è°ƒç”¨ <code>CloudJobRestfulApi#deregister(...)</code> æ–¹æ³•ï¼Œæ³¨é”€äº‘ä½œä¸šï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CloudJobRestfulApi.java</span></div><div class="line"><span class="meta">@DELETE</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/deregister"</span>)</div><div class="line"><span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deregister</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   producerManager.deregister(jobName);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ProducerManager.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deregister</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   Optional&lt;CloudJobConfiguration&gt; jobConfig = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (jobConfig.isPresent()) &#123;</div><div class="line">       <span class="comment">//  ä»ä½œä¸šç¦ç”¨é˜Ÿåˆ—ä¸­åˆ é™¤ä½œä¸š</span></div><div class="line">       disableJobService.remove(jobName);</div><div class="line">       <span class="comment">// åˆ é™¤äº‘ä½œä¸š</span></div><div class="line">       configService.remove(jobName);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// åœæ­¢è°ƒåº¦ä½œä¸š</span></div><div class="line">   unschedule(jobName);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>DisableJobService#remove(...)</code> æ–¹æ³•ï¼Œä»<strong>ä½œä¸šç¦ç”¨é˜Ÿåˆ—</strong>ä¸­åˆ é™¤ä½œä¸šï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   regCenter.remove(DisableJobNode.getDisableJobNodePath(jobName));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><ul><li><p>è°ƒç”¨ <code>CloudJobConfigurationService#remove(...)</code> æ–¹æ³•ï¼Œåˆ é™¤äº‘ä½œä¸šé…ç½®ã€‚</p></li><li><p>è°ƒç”¨ <code>#reschedule(...)</code> æ–¹æ³•ï¼Œé‡æ–°è°ƒåº¦ä½œä¸šã€‚</p></li></ul><p>å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„ äº‘ä½œä¸šé…ç½®è¢«åˆ é™¤æ—¶ï¼Œ<strong>äº‘ä½œä¸šé…ç½®å˜æ›´ç›‘å¬å™¨</strong>( CloudJobConfigurationListener )ä¼šç›‘å¬åˆ°ï¼Œå¹¶æ‰§è¡Œåˆ é™¤ç›¸åº”é€»è¾‘ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudJobConfigurationListener</span> <span class="keyword">implements</span> <span class="title">TreeCacheListener</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CoordinatorRegistryCenter regCenter;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ProducerManager producerManager;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReadyService readyService;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CloudJobConfigurationListener</span><span class="params">(<span class="keyword">final</span> CoordinatorRegistryCenter regCenter, <span class="keyword">final</span> ProducerManager producerManager)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.regCenter = regCenter;</div><div class="line">        readyService = <span class="keyword">new</span> ReadyService(regCenter);</div><div class="line">        <span class="keyword">this</span>.producerManager = producerManager;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childEvent</span><span class="params">(<span class="keyword">final</span> CuratorFramework client, <span class="keyword">final</span> TreeCacheEvent event)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        String path = <span class="keyword">null</span> == event.getData() ? <span class="string">""</span> : event.getData().getPath();</div><div class="line">        <span class="keyword">if</span> (isJobConfigNode(event, path, Type.NODE_ADDED)) &#123;</div><div class="line">            <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isJobConfigNode(event, path, Type.NODE_UPDATED)) &#123;</div><div class="line">            <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isJobConfigNode(event, path, Type.NODE_REMOVED)) &#123;</div><div class="line">            String jobName = path.substring(CloudJobConfigurationNode.ROOT.length() + <span class="number">1</span>, path.length());</div><div class="line">            producerManager.unschedule(jobName);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#reschedule(...)</code> æ–¹æ³•ï¼Œé‡æ–°è°ƒåº¦ä½œä¸šã€‚</li></ul><h2>2.6 è§¦å‘ä¸€æ¬¡äº‘ä½œä¸š</h2><p>è°ƒç”¨ <code>CloudJobRestfulApi#trigger(...)</code> æ–¹æ³•ï¼Œè§¦å‘ä¸€æ¬¡äº‘ä½œä¸šï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@POST</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/trigger"</span>)</div><div class="line"><span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">trigger</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   <span class="comment">// å¸¸é©»ä½œä¸šä¸å…è®¸è§¦å‘ä¸€æ¬¡ä½œä¸š</span></div><div class="line">   Optional&lt;CloudJobConfiguration&gt; config = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (config.isPresent() &amp;&amp; CloudJobExecutionType.DAEMON == config.get().getJobExecutionType()) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(<span class="string">"Daemon job '%s' cannot support trigger."</span>, jobName);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å°†ç¬æ—¶ä½œä¸šæ”¾å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line">   facadeService.addTransient(jobName);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ç›®å‰<strong>å¸¸é©»</strong>ä½œä¸š<strong>ä¸æ”¯æŒ</strong>è§¦å‘ä¸€æ¬¡äº‘ä½œä¸šã€‚å¦‚æœæƒ³å®ç°è¯¥åŠŸèƒ½ï¼Œéœ€è¦ Elastic-Job-Cloud-Scheduler é€šè¿‡ Mesos å‘é€è‡ªå®šä¹‰æ¶ˆæ¯ï¼Œé€šçŸ¥ Elastic-Job-Cloud-Executor è§¦å‘è¯¥ä½œä¸šå¯¹åº”çš„ä»»åŠ¡ä»¬ã€‚</li><li>è°ƒç”¨ <code>FacadeService#addTransient(...)</code> æ–¹æ³•ï¼Œå°†ç¬æ—¶ä½œä¸šæ”¾å…¥<strong>å¾…æ‰§è¡Œé˜Ÿåˆ—</strong>ã€‚å½“ä¸”ä»…å½“äº‘ä½œä¸šé…ç½® <code>JobCoreConfiguration.misfire = true</code> æ—¶ï¼Œè¯¥ä½œä¸šåœ¨<strong>å¾…æ‰§è¡Œé˜Ÿåˆ—</strong>çš„æ‰§è¡Œæ¬¡æ•°ä¸æ–­ç´¯ç§¯åŠ ä¸€ã€‚åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹ã€Œ3.2.3 ProducerJobã€</a>æœ‰è¯¦ç»†è§£æã€‚</li></ul><h1>3. äº‘ä½œä¸šåº”ç”¨æ“ä½œ</h1><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>è¿ç»´å¹³å°</strong>æˆ– Restful API å¯¹äº‘ä½œä¸šåº”ç”¨è¿›è¡Œæ“ä½œã€‚å‰è€…æ˜¯å¯¹åè€…çš„ç•Œé¢åŒ…è£…ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_28/02.png" alt=""></p><h2>3.1 æ³¨å†Œäº‘ä½œä¸šåº”ç”¨</h2><p><a href="http://www.iocoder.cn/Elastic-Job/cloud-job-config/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹ã€Œ2.2 æ“ä½œäº‘ä½œä¸šAppé…ç½®ã€</a>æœ‰è¯¦ç»†è§£æã€‚</p><h2>3.2 æ›´æ–°äº‘ä½œä¸šåº”ç”¨é…ç½®</h2><p>è°ƒç”¨ <code>CloudAppRestfulApi#update(...)</code> æ–¹æ³•ï¼Œæ›´æ–°äº‘ä½œä¸šåº”ç”¨é…ç½®ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CloudAppRestfulApi.java</span></div><div class="line"><span class="meta">@PUT</span></div><div class="line"><span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">final</span> CloudAppConfiguration appConfig)</span> </span>&#123;</div><div class="line">   appConfigService.update(appConfig);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CloudAppConfigurationService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">final</span> CloudAppConfiguration appConfig)</span> </span>&#123;</div><div class="line">   regCenter.update(CloudAppConfigurationNode.getRootNodePath(appConfig.getAppName()), CloudAppConfigurationGsonFactory.toJson(appConfig));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>3.3 ç¦ç”¨äº‘ä½œä¸šåº”ç”¨</h2><p>è°ƒç”¨ <code>CloudAppRestfulApi#disable(...)</code> æ–¹æ³•ï¼Œç¦ç”¨äº‘ä½œä¸šåº”ç”¨ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@POST</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/&#123;appName&#125;/disable"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disable</span><span class="params">(@PathParam(<span class="string">"appName"</span>)</span> <span class="keyword">final</span> String appName) </span>&#123;</div><div class="line">   <span class="keyword">if</span> (appConfigService.load(appName).isPresent()) &#123;</div><div class="line">       <span class="comment">// å°†åº”ç”¨æ”¾å…¥ç¦ç”¨é˜Ÿåˆ—</span></div><div class="line">       disableAppService.add(appName);</div><div class="line">       <span class="comment">// åœæ­¢åº”ç”¨å¯¹åº”æ‰€æœ‰ä½œä¸šçš„è°ƒåº¦</span></div><div class="line">       <span class="keyword">for</span> (CloudJobConfiguration each : jobConfigService.loadAll()) &#123;</div><div class="line">           <span class="keyword">if</span> (appName.equals(each.getAppName())) &#123;</div><div class="line">               producerManager.unschedule(each.getJobName());</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>DisableAppService#add(...)</code> æ–¹æ³•ï¼Œå°†åº”ç”¨æ”¾å…¥<strong>ç¦ç”¨åº”ç”¨é˜Ÿåˆ—</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DisableAppService.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DisableAppService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> String appName)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (regCenter.getNumChildren(DisableAppNode.ROOT) &gt; env.getFrameworkConfiguration().getJobStateQueueSize()) &#123;</div><div class="line">            log.warn(<span class="string">"Cannot add disable app, caused by read state queue size is larger than &#123;&#125;."</span>, env.getFrameworkConfiguration().getJobStateQueueSize());</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        String disableAppNodePath = DisableAppNode.getDisableAppNodePath(appName);</div><div class="line">        <span class="keyword">if</span> (!regCenter.isExisted(disableAppNodePath)) &#123;</div><div class="line">            regCenter.persist(disableAppNodePath, appName);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DisableAppNode.java</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DisableAppNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = StateNode.ROOT + <span class="string">"/disable/app"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DISABLE_APP = ROOT + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;APP_NAME&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>DisableAppServiceï¼Œç¦ç”¨åº”ç”¨é˜Ÿåˆ—æœåŠ¡ã€‚</p></li><li><p>ç¦ç”¨åº”ç”¨é˜Ÿåˆ—å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${NAMESPACE}/state/disable/app/${APP_NAME}</code>ï¼Œå­˜å‚¨å€¼ä¸ºåº”ç”¨åã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p><p><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">    [zk: localhost:2181(CONNECTED) 6] ls /elastic-job-cloud/state/disable/app</div><div class="line">[example_app]</div></pre></td></tr></table></figure></p></li></ul></li><li><p>éå†åº”ç”¨å¯¹åº”æ‰€æœ‰ä½œä¸šï¼Œè°ƒç”¨ <code>ProducerManager#unschedule(...)</code> æ–¹æ³•ï¼Œåœæ­¢ä½œä¸šè°ƒåº¦ã€‚</p></li></ul><h2>3.4 å¯ç”¨äº‘ä½œä¸šåº”ç”¨</h2><p>è°ƒç”¨ <code>CloudAppRestfulApi#enable(...)</code> æ–¹æ³•ï¼Œå¯ç”¨äº‘ä½œä¸šåº”ç”¨ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CloudAppRestfulApi.java</span></div><div class="line"><span class="meta">@DELETE</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/&#123;appName&#125;/disable"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enable</span><span class="params">(@PathParam(<span class="string">"appName"</span>)</span> <span class="keyword">final</span> String appName) <span class="keyword">throws</span> JSONException </span>&#123;</div><div class="line">   <span class="keyword">if</span> (appConfigService.load(appName).isPresent()) &#123;</div><div class="line">       <span class="comment">// ä»ç¦ç”¨åº”ç”¨é˜Ÿåˆ—ä¸­åˆ é™¤åº”ç”¨</span></div><div class="line">       disableAppService.remove(appName);</div><div class="line">       <span class="comment">// é‡æ–°å¼€å¯åº”ç”¨å¯¹åº”æ‰€æœ‰ä½œä¸šçš„è°ƒåº¦</span></div><div class="line">       <span class="keyword">for</span> (CloudJobConfiguration each : jobConfigService.loadAll()) &#123;</div><div class="line">           <span class="keyword">if</span> (appName.equals(each.getAppName())) &#123;</div><div class="line">               producerManager.reschedule(each.getJobName());</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DisableAppService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> String appName)</span> </span>&#123;</div><div class="line">   regCenter.remove(DisableAppNode.getDisableAppNodePath(appName));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>3.5 æ³¨é”€äº‘ä½œä¸šåº”ç”¨</h2><p>è°ƒç”¨ <code>CloudAppRestfulApi#deregister(...)</code> æ–¹æ³•ï¼Œæ³¨é”€äº‘ä½œä¸šåº”ç”¨ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@DELETE</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/&#123;appName&#125;"</span>)</div><div class="line"><span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deregister</span><span class="params">(@PathParam(<span class="string">"appName"</span>)</span> <span class="keyword">final</span> String appName) </span>&#123;</div><div class="line">   <span class="keyword">if</span> (appConfigService.load(appName).isPresent()) &#123;</div><div class="line">       <span class="comment">// ç§»é™¤åº”ç”¨å’Œåº”ç”¨å¯¹åº”æ‰€æœ‰ä½œä¸šçš„é…ç½®</span></div><div class="line">       removeAppAndJobConfigurations(appName);</div><div class="line">       <span class="comment">// åœæ­¢åº”ç”¨å¯¹åº”çš„æ‰§è¡Œå™¨( Elastic-Job-Cloud-Scheduler )</span></div><div class="line">       stopExecutors(appName);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#removeAppAndJobConfigurations(...)</code> æ–¹æ³•ï¼Œç§»é™¤åº”ç”¨å’Œåº”ç”¨å¯¹åº”æ‰€æœ‰ä½œä¸šçš„é…ç½®ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeAppAndJobConfigurations</span><span class="params">(<span class="keyword">final</span> String appName)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ³¨é”€(ç§»é™¤)åº”ç”¨å¯¹åº”æ‰€æœ‰ä½œä¸šçš„é…ç½®</span></div><div class="line">   <span class="keyword">for</span> (CloudJobConfiguration each : jobConfigService.loadAll()) &#123;</div><div class="line">       <span class="keyword">if</span> (appName.equals(each.getAppName())) &#123;</div><div class="line">           producerManager.deregister(each.getJobName());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ä»ç¦ç”¨åº”ç”¨é˜Ÿåˆ—ä¸­åˆ é™¤åº”ç”¨</span></div><div class="line">   disableAppService.remove(appName);</div><div class="line">   <span class="comment">// åˆ é™¤äº‘ä½œä¸šAppé…ç½®</span></div><div class="line">   appConfigService.remove(appName);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>#stopExecutors(...)</code> æ–¹æ³•ï¼Œåœæ­¢åº”ç”¨å¯¹åº”çš„æ‰§è¡Œå™¨( Elastic-Job-Cloud-Scheduler )ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CloudAppRestfulApi.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopExecutors</span><span class="params">(<span class="keyword">final</span> String appName)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Collection&lt;ExecutorStateInfo&gt; executorBriefInfo = mesosStateService.executors(appName);</div><div class="line">       <span class="keyword">for</span> (ExecutorStateInfo each : executorBriefInfo) &#123;</div><div class="line">           producerManager.sendFrameworkMessage(ExecutorID.newBuilder().setValue(each.getId()).build(),</div><div class="line">                   SlaveID.newBuilder().setValue(each.getSlaveId()).build(), <span class="string">"STOP"</span>.getBytes());</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> JSONException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ProducerManager.java </span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendFrameworkMessage</span><span class="params">(<span class="keyword">final</span> ExecutorID executorId, <span class="keyword">final</span> SlaveID slaveId, <span class="keyword">final</span> <span class="keyword">byte</span>[] data)</span> </span>&#123;</div><div class="line">    schedulerDriver.sendFrameworkMessage(executorId, slaveId, data);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>SchedulerDriver#sendFrameworkMessage(...)</code> æ–¹æ³•ï¼Œé€šè¿‡ Mesos å‘äº‘ä½œä¸šåº”ç”¨å¯¹åº”çš„æ‰§è¡Œå™¨ä»¬( Elastic-Job-Cloud-Executor ) å‘é€æ¶ˆæ¯ä¸º <code>&quot;STOP&quot;</code> ä»è€Œå…³é—­æ‰§è¡Œå™¨ã€‚Elastic-Job-Cloud-Executor ä¼šæ¥æ”¶åˆ° Mesos æ¶ˆæ¯ï¼Œè°ƒç”¨ <code>TaskExecutor#frameworkMessage(...)</code> æ–¹æ³•ï¼Œå…³é—­è‡ªå·±ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</li></ul><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">frameworkMessage</span><span class="params">(<span class="keyword">final</span> ExecutorDriver executorDriver, <span class="keyword">final</span> <span class="keyword">byte</span>[] bytes)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != bytes &amp;&amp; <span class="string">"STOP"</span>.equals(<span class="keyword">new</span> String(bytes))) &#123;</div><div class="line">        log.error(<span class="string">"call frameworkMessage executor stopped."</span>);</div><div class="line">        executorDriver.stop();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h1>666. å½©è›‹</h1><p>Elastic-Job-Cloud ä½œä¸šè°ƒåº¦ä¸¤ç¯‡å†…å®¹åˆ°æ­¤å°±ç»“æŸå•¦ã€‚åç»­æˆ‘ä»¬ä¼šæ›´æ–°å¤§å®¶å…³å¿ƒçš„<a href="http://www.iocoder.cn/Elastic-Job/cloud-high-availability/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” é«˜å¯ç”¨ã€‹</a>æ˜¯å¦‚ä½•å®ç°çš„å™¢ã€‚</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_28/03.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. äº‘ä½œä¸šæ“ä½œ&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2
      
    
    </summary>
    
      <category term="Elastic-Job-Cloud" scheme="http://www.iocoder.cn/categories/Elastic-Job-Cloud/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰</title>
    <link href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/"/>
    <id>http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/</id>
    <published>2017-12-20T16:00:00.000Z</published>
    <updated>2017-09-07T15:54:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. ä½œä¸šæ‰§è¡Œç±»å‹</a></li><li><a href="#">3. Producer å‘å¸ƒä»»åŠ¡</a><ul><li><a href="#">3.1 å¸¸é©»ä½œä¸š</a></li><li><a href="#">3.2 ç¬æ—¶ä½œä¸š</a><ul><li><a href="#">3.2.1 TransientProducerScheduler</a></li><li><a href="#">3.2.2 æ³¨å†Œç¬æ—¶ä½œä¸š</a></li><li><a href="#">3.2.3 ProducerJob</a></li></ul></li><li><a href="#">3.3 å°ç»“</a></li></ul></li><li><a href="#">4. TaskLaunchScheduledService æäº¤ä»»åŠ¡</a><ul><li><a href="#">4.1 åˆ›å»º Fenzo ä»»åŠ¡è¯·æ±‚</a></li><li><a href="#">4.2 AppConstraintEvaluator</a></li><li><a href="#">4.3 å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ° Mesos Offer</a></li><li><a href="#">4.4 åˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯</a><ul><li><a href="#">4.4.1 åˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ä¿¡æ¯</a></li></ul></li><li><a href="#">4.5 å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—</a></li><li><a href="#">4.6 ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š</a></li><li><a href="#">4.7 æäº¤ä»»åŠ¡ç»™ Mesos</a></li></ul></li><li><a href="#">5. TaskExecutor æ‰§è¡Œä»»åŠ¡</a><ul><li><a href="#">5.1 TaskThread</a></li><li><a href="#">5.2 DaemonTaskScheduler</a></li></ul></li><li><a href="#">6. SchedulerEngine å¤„ç†ä»»åŠ¡çš„çŠ¶æ€å˜æ›´</a></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Cloud è°ƒåº¦ä¸»æµç¨‹</strong>ã€‚å¯¹åº”åˆ° Elastic-Job-Lite æºç è§£ææ–‡ç« å¦‚ä¸‹ï¼š</p><ul><li><a href="http://www.iocoder.cn/Elastic-Job/job-init/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆå§‹åŒ–ã€‹</a></li><li><a href="http://www.iocoder.cn/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a></li><li><a href="http://www.iocoder.cn/Elastic-Job/job-sharding/">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a></li></ul><p>å¦‚æœä½ é˜…è¯»è¿‡ä»¥ä¸‹æ–‡ç« ï¼Œæœ‰åŠ©äºå¯¹æœ¬æ–‡çš„ç†è§£ï¼š</p><ul><li><a href="http://www.infoq.com/cn/news/2016/09/Mesos-Elastic-Job-Cloud" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠåŸºäºMesosçš„å½“å½“ä½œä¸šäº‘Elastic Job Cloudã€‹</a></li><li><a href="https://segmentfault.com/a/1190000007723430" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç”±æµ…å…¥æ·± | å¦‚ä½•ä¼˜é›…åœ°å†™ä¸€ä¸ªMesos Frameworkã€‹</a></li></ul><p>ğŸ˜ˆ å¦å¤–ï¼Œç¬”è€…å‡è®¾ä½ å·²ç»å¯¹ <strong><a href="http://www.iocoder.cn/categories/Elastic-Job/?self">ã€ŠElastic-Job-Lite æºç åˆ†æç³»åˆ—ã€‹</a></strong> æœ‰ä¸€å®šçš„äº†è§£ã€‚</p><p>æœ¬æ–‡æ¶‰åŠåˆ°ä¸»ä½“ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/01.png" alt=""></p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>Elastic-Job-Cloud åŸºäº Mesos å®ç°åˆ†å¸ƒå¼ä½œä¸šè°ƒåº¦ï¼Œæˆ–è€…è¯´ Elastic-Job-Cloud æ˜¯ Mesos ä¸Šçš„ æ¡†æ¶( Framework )ã€‚</p><p>ä¸€ä¸ª Mesos æ¡†æ¶ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>æ§åˆ¶å™¨éƒ¨åˆ†ï¼Œç§°ä¸ºè°ƒåº¦å™¨( Scheduler )ã€‚</li><li>å·¥ä½œå•å…ƒéƒ¨åˆ†ï¼Œç§°ä¸ºæ‰§è¡Œå™¨( Executor )ã€‚</li></ul><p>Elastic-Job-Cloud ç”±ä¸¤ä¸ªé¡¹ç›®ç»„æˆï¼š</p><ul><li>Elastic-Job-Cloud-Schedulerï¼Œå®ç°è°ƒåº¦å™¨ï¼Œå®ç°ç±»ä¸º <code>com.dangdang.ddframe.job.cloud.scheduler.mesos.SchedulerEngine</code>ã€‚</li><li>Elastic-Job-Cloud-Executorï¼Œå®ç°æ‰§è¡Œå™¨ï¼Œå®ç°ç±»ä¸º <code>com.dangdang.ddframe.job.cloud.executor.TaskExecutor</code>ã€‚</li></ul><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/11.png" alt=""></p><p>æœ¬æ–‡ç•¥å¾®**â€œå•°å—¦â€<strong>ï¼Œè¯·ä¿æŒ</strong>è€å¿ƒ**ã€‚æ­é…<a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç”¨Mesosæ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a>ä¸€èµ·é˜…è¯»ï¼Œç†è§£éš¾åº¦é™ä½ 99%ã€‚OKï¼Œå¼€å§‹æˆ‘ä»¬çš„ Cloud ä¹‹æ—…ã€‚</p><h1>2. ä½œä¸šæ‰§è¡Œç±»å‹</h1><p>åœ¨ Elastic-Job-Cloudï¼Œä½œä¸šæ‰§è¡Œåˆ†æˆä¸¤ç§ç±»å‹ï¼š</p><ul><li>å¸¸é©»ä½œä¸š</li></ul><blockquote><p>å¸¸é©»ä½œä¸šæ˜¯ä½œä¸šä¸€æ—¦å¯åŠ¨ï¼Œæ— è®ºè¿è¡Œä¸å¦å‡å ç”¨ç³»ç»Ÿèµ„æºï¼›<br>å¸¸é©»ä½œä¸šé€‚åˆåˆå§‹åŒ–æ—¶é—´é•¿ã€è§¦å‘é—´éš”çŸ­ã€å®æ—¶æ€§è¦æ±‚é«˜çš„ä½œä¸šï¼Œè¦æ±‚èµ„æºé…å¤‡å……è¶³ã€‚</p></blockquote><ul><li>ç¬æ—¶ä½œä¸š</li></ul><blockquote><p>ç¬æ—¶ä½œä¸šæ˜¯åœ¨ä½œä¸šå¯åŠ¨æ—¶å ç”¨èµ„æºï¼Œè¿è¡Œå®Œæˆåé‡Šæ”¾èµ„æºã€‚<br>ç¬æ—¶ä½œä¸šé€‚åˆåˆå§‹åŒ–æ—¶é—´çŸ­ã€è§¦å‘é—´éš”é•¿ã€å…è®¸å»¶è¿Ÿçš„ä½œä¸šï¼Œä¸€èˆ¬ç”¨äºèµ„æºä¸å¤ªå……åˆ†ï¼Œæˆ–ä½œä¸šè¦æ±‚çš„èµ„æºå¤šï¼Œé€‚åˆèµ„æºé”™å³°ä½¿ç”¨çš„åœºæ™¯ã€‚</p></blockquote><p>Elastic-Job-Cloud ä¸åŒäº Elastic-Job-Lite å»ä¸­å¿ƒåŒ–æ‰§è¡Œè°ƒåº¦ï¼Œè½¬å˜ä¸º <strong>Mesos Framework çš„ä¸­å¿ƒèŠ‚ç‚¹è°ƒåº¦</strong>ã€‚è¿™é‡Œä¸å¤ªç†è§£ï¼Œæ²¡å…³ç³»ï¼Œä¸‹æ–‡çœ‹åˆ°å…·ä½“ä»£ç å°±èƒ½æ˜ç™½äº†ã€‚</p><p>å¸¸é©»ä½œä¸šã€ç¬æ—¶ä½œä¸šåœ¨è°ƒåº¦ä¸­ä¼šç•¥æœ‰ä¸åŒï¼Œå¤§ä½“<strong>ç²—ç•¥</strong>æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/02.png" alt=""></p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬é’ˆå¯¹æ¯ä¸ªè¿‡ç¨‹ä¸€èŠ‚ä¸€èŠ‚è§£æã€‚</p><h1>3. Producer å‘å¸ƒä»»åŠ¡</h1><p>åœ¨ä¸Šæ–‡<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-config/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹çš„ã€Œ3.1.1 æ“ä½œäº‘ä½œä¸šé…ç½®ã€</a>å¯ä»¥çœ‹åˆ°æ·»åŠ äº‘ä½œä¸šé…ç½®åï¼ŒElastic-Job-Cloud-Scheduler ä¼šæ‰§è¡Œ<strong>ä½œä¸šè°ƒåº¦</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ProducerManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è°ƒåº¦ä½œä¸š.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">schedule</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   <span class="comment">// åº”ç”¨ æˆ– ä½œä¸š è¢«ç¦ç”¨ï¼Œä¸è°ƒåº¦</span></div><div class="line">   <span class="keyword">if</span> (disableAppService.isDisabled(jobConfig.getAppName()) || disableJobService.isDisabled(jobConfig.getJobName())) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (CloudJobExecutionType.TRANSIENT == jobConfig.getJobExecutionType()) &#123; <span class="comment">// ç¬æ—¶ä½œä¸š</span></div><div class="line">       transientProducerScheduler.register(jobConfig);</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (CloudJobExecutionType.DAEMON == jobConfig.getJobExecutionType()) &#123; <span class="comment">// å¸¸é©»ä½œä¸š</span></div><div class="line">       readyService.addDaemon(jobConfig.getJobName());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬æ—¶ä½œä¸šå’Œå¸¸é©»ä½œä¸šåœ¨è°ƒåº¦ä¸Šä¼šæœ‰ä¸€å®šçš„ä¸åŒã€‚</li></ul><h2>3.1 å¸¸é©»ä½œä¸š</h2><p>å¸¸é©»ä½œä¸šåœ¨è°ƒåº¦æ—¶ï¼Œç›´æ¥æ·»åŠ åˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ã€‚Whatï¼Ÿå²‚ä¸æ˜¯é©¬ä¸Šå°±è¿è¡Œäº†ï¼No No Noï¼Œç­”æ¡ˆåœ¨ã€Œ5. TaskExecutor æ‰§è¡Œä»»åŠ¡ã€ï¼Œè¿™é‡Œå…ˆæ‰“ä½ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ReadyService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å°†å¸¸é©»ä½œä¸šæ”¾å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobName ä½œä¸šåç§°</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDaemon</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (regCenter.getNumChildren(ReadyNode.ROOT) &gt; env.getFrameworkConfiguration().getJobStateQueueSize()) &#123;</div><div class="line">       log.warn(<span class="string">"Cannot add daemon job, caused by read state queue size is larger than &#123;&#125;."</span>, env.getFrameworkConfiguration().getJobStateQueueSize());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   Optional&lt;CloudJobConfiguration&gt; cloudJobConfig = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (!cloudJobConfig.isPresent() || CloudJobExecutionType.DAEMON != cloudJobConfig.get().getJobExecutionType() || runningService.isJobRunning(jobName)) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°å¾…æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line">   regCenter.persist(ReadyNode.getReadyJobNodePath(jobName), <span class="string">"1"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ReadyNode.java</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadyNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = StateNode.ROOT + <span class="string">"/ready"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String READY_JOB = ROOT + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;JOB_NAME&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>ReadyServiceï¼Œå¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—æœåŠ¡ï¼Œæä¾›å¯¹å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—çš„å„ç§æ“ä½œæ–¹æ³•ã€‚</p></li><li><p><strong>å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong>å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${NAMESPACE}/state/ready/${JOB_NAME}</code>ï¼Œå­˜å‚¨å€¼ä¸ºå¾…æ‰§è¡Œæ¬¡æ•°ã€‚ä¾‹å¦‚æ­¤å¤„ï¼Œå¾…æ‰§è¡Œæ¬¡æ•°ä¸º <code>1</code>ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p><p><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 4] ls /elastic-job-cloud/state/ready</div><div class="line">[test_job_simple]</div><div class="line">[zk: localhost:2181(CONNECTED) 5] get /elastic-job-cloud/state/ready/test_job_simple</div><div class="line">1</div></pre></td></tr></table></figure></p></li><li><p>åœ¨è¿ç»´å¹³å°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/10.png" alt=""></p></li><li><p>ä»å®˜æ–¹çš„ RoadMap æ¥çœ‹ï¼Œ<strong>å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong>æœªæ¥ä¼šä½¿ç”¨ Redis å­˜å‚¨ä»¥æé«˜æ€§èƒ½ã€‚</p><blockquote><p>FROM http://elasticjob.io/docs/elastic-job-cloud/03-design/roadmap/<br>Redis Based Queue Improvement</p></blockquote></li></ul><h2>3.2 ç¬æ—¶ä½œä¸š</h2><p>ç¬æ—¶ä½œä¸šåœ¨è°ƒåº¦æ—¶ï¼Œä½¿ç”¨<strong>å‘å¸ƒç¬æ—¶ä½œä¸šä»»åŠ¡çš„è°ƒåº¦å™¨</strong>( TransientProducerScheduler )è°ƒåº¦ä½œä¸šã€‚å½“ç¬æ—¶ä½œä¸šåˆ°è¾¾ä½œä¸šæ‰§è¡Œæ—¶é—´ï¼Œæ·»åŠ åˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ã€‚</p><h3>3.2.1 TransientProducerScheduler</h3><p>TransientProducerSchedulerï¼Œå‘å¸ƒç¬æ—¶ä½œä¸šä»»åŠ¡çš„è°ƒåº¦å™¨ï¼ŒåŸºäº Quartz å®ç°å¯¹ç¬æ—¶ä½œä¸šçš„è°ƒåº¦ã€‚åˆå§‹åŒ–ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransientProducerScheduler.java</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">   scheduler = getScheduler();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       scheduler.start();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Scheduler <span class="title">getScheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">   StdSchedulerFactory factory = <span class="keyword">new</span> StdSchedulerFactory();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       factory.initialize(getQuartzProperties());</div><div class="line">       <span class="keyword">return</span> factory.getScheduler();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> Properties <span class="title">getQuartzProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">   Properties result = <span class="keyword">new</span> Properties();</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.class"</span>, SimpleThreadPool.class.getName());</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.threadCount"</span>, Integer.toString(Runtime.getRuntime().availableProcessors() * <span class="number">2</span>)); <span class="comment">// çº¿ç¨‹æ± æ•°é‡</span></div><div class="line">   result.put(<span class="string">"org.quartz.scheduler.instanceName"</span>, <span class="string">"ELASTIC_JOB_CLOUD_TRANSIENT_PRODUCER"</span>);</div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.class"</span>, ShutdownHookPlugin.class.getName());</div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.cleanShutdown"</span>, Boolean.TRUE.toString());</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3>3.2.2 æ³¨å†Œç¬æ—¶ä½œä¸š</h3><p>è°ƒç”¨ <code>TransientProducerScheduler#register(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œç¬æ—¶ä½œä¸šã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransientProducerScheduler.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> TransientProducerRepository repository;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   String cron = jobConfig.getTypeConfig().getCoreConfig().getCron();</div><div class="line">   <span class="comment">// æ·»åŠ  cron ä½œä¸šé›†åˆ</span></div><div class="line">   JobKey jobKey = buildJobKey(cron);</div><div class="line">   repository.put(jobKey, jobConfig.getJobName());</div><div class="line">   <span class="comment">// è°ƒåº¦ ä½œä¸š</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">if</span> (!scheduler.checkExists(jobKey)) &#123;</div><div class="line">           scheduler.scheduleJob(buildJobDetail(jobKey), buildTrigger(jobKey.getName()));</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#buildJobKey(...)</code> æ–¹æ³•ï¼Œåˆ›å»º Quartz JobKeyã€‚ä½ ä¼šå‘ç°å¾ˆæœ‰æ„æ€çš„ä½¿ç”¨çš„æ˜¯ <code>cron</code> å‚æ•°ä½œä¸ºä¸»é”®ã€‚Whyï¼Ÿåœ¨çœ‹ä¸‹ <code>!scheduler.checkExists(jobKey)</code> å¤„ï¼Œç›¸åŒ JobKey( <code>cron</code> ) çš„ä½œä¸šä¸é‡å¤æ³¨å†Œåˆ° Quartz Schedulerã€‚Whyï¼Ÿæ­¤å¤„æ˜¯ä¸€ä¸ªä¼˜åŒ–ï¼Œç›¸åŒ <code>cron</code> ä½¿ç”¨åŒä¸€ä¸ª Quartz Jobï¼ŒElastic-Job-Cloud-Scheduler å¯èƒ½ä¼šæ³¨å†Œå¤§é‡çš„ç¬æ—¶ä½œä¸šï¼Œå¦‚æœä¸€ä¸ªç¬æ—¶ä½œä¸šåˆ›å»ºä¸€ä¸ª Quartz Job å¤ªè¿‡æµªè´¹ï¼Œç‰¹åˆ«æ˜¯ <code>cron</code> æ¯åˆ†é’Ÿã€æ¯5åˆ†é’Ÿã€æ¯å°æ—¶ã€æ¯å¤©å·²ç»è¦†ç›–äº†å¤§é‡çš„ç¬æ—¶ä½œä¸šçš„æƒ…å†µã€‚å› æ­¤ï¼Œç›¸åŒ <code>cron</code> ä½¿ç”¨åŒä¸€ä¸ª Quartz Jobã€‚</p></li><li><p>è°ƒç”¨ <code>TransientProducerRepository#put(...)</code> ä»¥ Quartz JobKey ä¸ºä¸»é”®èšåˆä½œä¸šã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TransientProducerRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * cron ä½œä¸šé›†åˆ</span></div><div class="line"><span class="comment">     * keyï¼šä½œä¸šKey</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;JobKey, List&lt;String&gt;&gt; cronTasks = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>, <span class="number">1</span>);</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">final</span> JobKey jobKey, <span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">        remove(jobName);</div><div class="line">        List&lt;String&gt; taskList = cronTasks.get(jobKey);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == taskList) &#123;</div><div class="line">            taskList = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</div><div class="line">            taskList.add(jobName);</div><div class="line">            cronTasks.put(jobKey, taskList);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!taskList.contains(jobName)) &#123;</div><div class="line">            taskList.add(jobName);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>#buildJobDetail(...)</code> åˆ›å»º Quartz Job ä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> JobDetail <span class="title">buildJobDetail</span><span class="params">(<span class="keyword">final</span> JobKey jobKey)</span> </span>&#123;</div><div class="line">    JobDetail result = JobBuilder.newJob(ProducerJob.class) <span class="comment">// ProducerJob.java</span></div><div class="line">            .withIdentity(jobKey).build();</div><div class="line">    result.getJobDataMap().put(<span class="string">"repository"</span>, repository);</div><div class="line">    result.getJobDataMap().put(<span class="string">"readyService"</span>, readyService);</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>JobBuilder#newJob(...)</code> çš„å‚æ•°æ˜¯ ProducerJobï¼Œä¸‹æ–‡ä¼šè®²è§£åˆ°ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>#buildTrigger(...)</code> åˆ›å»º Quartz Triggerã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Trigger <span class="title">buildTrigger</span><span class="params">(<span class="keyword">final</span> String cron)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> TriggerBuilder.newTrigger()</div><div class="line">           .withIdentity(cron)</div><div class="line">           .withSchedule(CronScheduleBuilder.cronSchedule(cron) <span class="comment">// cron</span></div><div class="line">           .withMisfireHandlingInstructionDoNothing())</div><div class="line">           .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h3>3.2.3 ProducerJob</h3><p>ProducerJobï¼Œå½“ Quartz Job åˆ°è¾¾ <code>cron</code> æ‰§è¡Œæ—¶é—´( å³ä½œä¸šæ‰§è¡Œæ—¶é—´)ï¼Œå°†ç›¸åº”çš„ç¬æ—¶ä½œä¸šæ·»åŠ åˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerJob</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</div><div class="line">        </div><div class="line">   <span class="keyword">private</span> TransientProducerRepository repository;</div><div class="line">   </div><div class="line">   <span class="keyword">private</span> ReadyService readyService;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</div><div class="line">       List&lt;String&gt; jobNames = repository.get(context.getJobDetail().getKey());</div><div class="line">       <span class="keyword">for</span> (String each : jobNames) &#123;</div><div class="line">           readyService.addTransient(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>TransientProducerRepository#get(...)</code> æ–¹æ³•ï¼Œè·å¾—è¯¥ Job å¯¹åº”çš„ä½œä¸šé›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TransientProducerRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * cron ä½œä¸šé›†åˆ</span></div><div class="line"><span class="comment">     * keyï¼šä½œä¸šKey</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;JobKey, List&lt;String&gt;&gt; cronTasks = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>, <span class="number">1</span>);</div><div class="line">    </div><div class="line">    <span class="function">List&lt;String&gt; <span class="title">get</span><span class="params">(<span class="keyword">final</span> JobKey jobKey)</span> </span>&#123;</div><div class="line">        List&lt;String&gt; result = cronTasks.get(jobKey);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span> == result ? Collections.&lt;String&gt;emptyList() : result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>ReadyService#addTransient(...)</code> æ–¹æ³•ï¼Œæ·»åŠ ç¬æ—¶ä½œä¸šåˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å°†ç¬æ—¶ä½œä¸šæ”¾å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobName ä½œä¸šåç§°</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addTransient</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   <span class="comment">//</span></div><div class="line">   <span class="keyword">if</span> (regCenter.getNumChildren(ReadyNode.ROOT) &gt; env.getFrameworkConfiguration().getJobStateQueueSize()) &#123;</div><div class="line">       log.warn(<span class="string">"Cannot add transient job, caused by read state queue size is larger than &#123;&#125;."</span>, env.getFrameworkConfiguration().getJobStateQueueSize());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">//</span></div><div class="line">   Optional&lt;CloudJobConfiguration&gt; cloudJobConfig = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (!cloudJobConfig.isPresent() || CloudJobExecutionType.TRANSIENT != cloudJobConfig.get().getJobExecutionType()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// </span></div><div class="line">   String readyJobNode = ReadyNode.getReadyJobNodePath(jobName);</div><div class="line">   String times = regCenter.getDirectly(readyJobNode);</div><div class="line">   <span class="keyword">if</span> (cloudJobConfig.get().getTypeConfig().getCoreConfig().isMisfire()) &#123;</div><div class="line">       regCenter.persist(readyJobNode, Integer.toString(<span class="keyword">null</span> == times ? <span class="number">1</span> : Integer.parseInt(times) + <span class="number">1</span>));</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       regCenter.persist(ReadyNode.getReadyJobNodePath(jobName), <span class="string">"1"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>æ·»åŠ ç¬æ—¶ä½œä¸šåˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong> å’Œ <strong>æ·»åŠ å¸¸é©»ä½œä¸šåˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong>åŸºæœ¬æ˜¯ä¸€è‡´çš„ã€‚</li><li>å½“ä½œä¸šé…ç½®å…è®¸ <code>misfire</code>ï¼Œåˆ™ä¸æ–­ç´¯ç§¯ä½œä¸šå¯æ‰§è¡Œæ¬¡æ•°ã€‚</li></ul></li></ul><h2>3.3 å°ç»“</h2><p>æ— è®ºæ˜¯å¸¸é©»ä½œä¸šè¿˜æ˜¯ç¬æ—¶ä½œä¸šï¼Œéƒ½ä¼šåŠ å…¥åˆ°<strong>å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong>ã€‚ç›®å‰æˆ‘ä»¬çœ‹åˆ°ç¬æ—¶ä½œä¸šçš„æ¯æ¬¡è°ƒåº¦æ˜¯ TransientProducerScheduler è´Ÿè´£ã€‚é‚£ä¹ˆå¸¸é©»ä½œä¸šçš„æ¯æ¬¡è°ƒåº¦å‘¢ï¼Ÿã€Œ5. TaskExecutor æ‰§è¡Œä»»åŠ¡ã€ä¼šçœ‹åˆ°å®ƒçš„è°ƒåº¦ï¼Œè¿™æ˜¯ Elastic-Job-Cloud è®¾è®¡å·§å¦™æœ‰è¶£çš„åœ°æ–¹ã€‚</p><h1>4. TaskLaunchScheduledService æäº¤ä»»åŠ¡</h1><p>TaskLaunchScheduledServiceï¼Œä»»åŠ¡æäº¤è°ƒåº¦æœåŠ¡ã€‚å®ƒç»§æ‰¿ Guava AbstractScheduledService å®ç°å®šæ—¶å°†å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—çš„ä½œä¸šæäº¤åˆ° Mesos è¿›è¡Œè°ƒåº¦æ‰§è¡Œã€‚å®ç°<strong>å®šæ—¶</strong>ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskLaunchScheduledService</span> <span class="keyword">extends</span> <span class="title">AbstractScheduledService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">serviceName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"task-launch-processor"</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Scheduler <span class="title">scheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Scheduler.newFixedDelaySchedule(<span class="number">2</span>, <span class="number">10</span>, TimeUnit.SECONDS);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">runOneIteration</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥éƒ¨åˆ†æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>æ¯ 10 ç§’æ‰§è¡Œæäº¤ä»»åŠ¡( <code>#runOneIteration()</code> )ã€‚å¯¹ Guava AbstractScheduledService ä¸äº†è§£çš„åŒå­¦ï¼Œå¯ä»¥é˜…è¯»å®Œæœ¬æ–‡å Google ä¸‹ã€‚å› ä¸ºæ˜¯é€šè¿‡æ¯ 10 ç§’è½®è¯¢çš„æ–¹å¼æäº¤ä»»åŠ¡ï¼Œæ‰€ä»¥<strong>ç¬æ—¶ä½œä¸š</strong>çš„æ‰§è¡Œæ—¶é—´ä¸æ˜¯éå¸¸ä¸¥æ ¼ï¼Œå­˜åœ¨ç•¥æœ‰å»¶è¿Ÿï¼Œè¿™ä¸ªå®é™…åœ¨ä½¿ç”¨éœ€è¦æ³¨æ„çš„ã€‚é‚£<strong>å¸¸é©»ä½œä¸š</strong>å‘¢ï¼Œçœ‹å®Œæœ¬æ–‡ï¼Œä½ å°±ä¼šçŸ¥é“ç­”æ¡ˆã€‚</li></ul><p><code>#runOneIteration()</code> æ–¹æ³•ç›¸å¯¹æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬ä¸€å—ä¸€å—æ‹†è§£ï¼Œ<strong>è€å¿ƒ</strong>ç†è§£ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">runOneIteration</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       System.out.println(<span class="string">"runOneIteration:"</span> + <span class="keyword">new</span> Date());</div><div class="line">       <span class="comment">// åˆ›å»º Fenzo ä»»åŠ¡è¯·æ±‚</span></div><div class="line">       LaunchingTasks launchingTasks = <span class="keyword">new</span> LaunchingTasks(facadeService.getEligibleJobContext());</div><div class="line">       List&lt;TaskRequest&gt; taskRequests = launchingTasks.getPendingTasks();</div><div class="line">       <span class="comment">// è·å–æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„äº‘ä½œä¸šApp https://github.com/Netflix/Fenzo/wiki/Constraints</span></div><div class="line">       <span class="keyword">if</span> (!taskRequests.isEmpty()) &#123;</div><div class="line">           AppConstraintEvaluator.getInstance().loadAppRunningState();</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ° Mesos Offer</span></div><div class="line">       Collection&lt;VMAssignmentResult&gt; vmAssignmentResults = taskScheduler.scheduleOnce(taskRequests, LeasesQueue.getInstance().drainTo()).getResultMap().values();</div><div class="line">       <span class="comment">// åˆ›å»º Mesos ä»»åŠ¡è¯·æ±‚</span></div><div class="line">       List&lt;TaskContext&gt; taskContextsList = <span class="keyword">new</span> LinkedList&lt;&gt;(); <span class="comment">// ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line">       Map&lt;List&lt;Protos.OfferID&gt;, List&lt;Protos.TaskInfo&gt;&gt; offerIdTaskInfoMap = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">// Mesos ä»»åŠ¡ä¿¡æ¯é›†åˆ</span></div><div class="line">       <span class="keyword">for</span> (VMAssignmentResult each: vmAssignmentResults) &#123;</div><div class="line">           List&lt;VirtualMachineLease&gt; leasesUsed = each.getLeasesUsed();</div><div class="line">           List&lt;Protos.TaskInfo&gt; taskInfoList = <span class="keyword">new</span> ArrayList&lt;&gt;(each.getTasksAssigned().size() * <span class="number">10</span>);</div><div class="line">           taskInfoList.addAll(getTaskInfoList(</div><div class="line">                   launchingTasks.getIntegrityViolationJobs(vmAssignmentResults), <span class="comment">// è·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</span></div><div class="line">                   each, leasesUsed.get(<span class="number">0</span>).hostname(), leasesUsed.get(<span class="number">0</span>).getOffer()));</div><div class="line">           <span class="keyword">for</span> (Protos.TaskInfo taskInfo : taskInfoList) &#123;</div><div class="line">               taskContextsList.add(TaskContext.from(taskInfo.getTaskId().getValue()));</div><div class="line">           &#125;</div><div class="line">           offerIdTaskInfoMap.put(getOfferIDs(leasesUsed), <span class="comment">// è·å¾— Offer ID é›†åˆ</span></div><div class="line">                   taskInfoList);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// éå†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line">       <span class="keyword">for</span> (TaskContext each : taskContextsList) &#123;</div><div class="line">           <span class="comment">// å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—</span></div><div class="line">           facadeService.addRunning(each);</div><div class="line">           <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_STAGING)</span></div><div class="line">           jobEventBus.post(createJobStatusTraceEvent(each));</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š</span></div><div class="line">       facadeService.removeLaunchTasksFromQueue(taskContextsList);</div><div class="line">       <span class="comment">// æäº¤ä»»åŠ¡ç»™ Mesos</span></div><div class="line">       <span class="keyword">for</span> (Entry&lt;List&lt;OfferID&gt;, List&lt;TaskInfo&gt;&gt; each : offerIdTaskInfoMap.entrySet()) &#123;</div><div class="line">           schedulerDriver.launchTasks(each.getKey(), each.getValue());</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</div><div class="line">       log.error(<span class="string">"Launch task error"</span>, throwable);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="comment">// æ¸…ç† AppConstraintEvaluator æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„äº‘ä½œä¸šApp</span></div><div class="line">       AppConstraintEvaluator.getInstance().clearAppRunningState();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>4.1 åˆ›å»º Fenzo ä»»åŠ¡è¯·æ±‚</h2><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line">LaunchingTasks launchingTasks = <span class="keyword">new</span> LaunchingTasks(facadeService.getEligibleJobContext());</div><div class="line">List&lt;TaskRequest&gt; taskRequests = launchingTasks.getPendingTasks();</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>FacadeService#getEligibleJobContext()</code> æ–¹æ³•ï¼Œè·å–æœ‰èµ„æ ¼è¿è¡Œçš„ä½œä¸šã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å–æœ‰èµ„æ ¼è¿è¡Œçš„ä½œä¸š.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> ä½œä¸šä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;JobContext&gt; <span class="title">getEligibleJobContext</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ä»å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡</span></div><div class="line">   Collection&lt;JobContext&gt; failoverJobContexts = failoverService.getAllEligibleJobContexts();</div><div class="line">   <span class="comment">// ä»å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡</span></div><div class="line">   Collection&lt;JobContext&gt; readyJobContexts = readyService.getAllEligibleJobContexts(failoverJobContexts);</div><div class="line">   <span class="comment">// åˆå¹¶</span></div><div class="line">   Collection&lt;JobContext&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(failoverJobContexts.size() + readyJobContexts.size());</div><div class="line">   result.addAll(failoverJobContexts);</div><div class="line">   result.addAll(readyJobContexts);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>FailoverService#getAllEligibleJobContexts()</code> æ–¹æ³•ï¼Œä»<strong>å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</strong>ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡ã€‚<strong>TaskLaunchScheduledService æäº¤çš„ä»»åŠ¡è¿˜å¯èƒ½æ¥è‡ªå¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</strong>ã€‚æœ¬æ–‡æš‚æ—¶ä¸è§£æå¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ç›¸å…³å®ç°ï¼Œé¿å…å¢åŠ å¤æ‚åº¦å½±å“å¤§å®¶çš„ç†è§£ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-failover/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>è°ƒç”¨ <code>ReadyService#getAllEligibleJobContexts(...)</code> æ–¹æ³•ï¼Œä»<strong>å¾…æ‰§è¡Œé˜Ÿåˆ—</strong>ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ReadyService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä»å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> ineligibleJobContexts æ— èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;JobContext&gt; <span class="title">getAllEligibleJobContexts</span><span class="params">(<span class="keyword">final</span> Collection&lt;JobContext&gt; ineligibleJobContexts)</span> </span>&#123;</div><div class="line">   <span class="comment">// ä¸å­˜åœ¨ å¾…æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(ReadyNode.ROOT)) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ— èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡ è½¬æ¢æˆ æ— èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šé›†åˆ</span></div><div class="line">   Collection&lt;String&gt; ineligibleJobNames = Collections2.transform(ineligibleJobContexts, <span class="keyword">new</span> Function&lt;JobContext, String&gt;() &#123;</div><div class="line">       </div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(<span class="keyword">final</span> JobContext input)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> input.getJobConfig().getJobName();</div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line">   <span class="comment">// è·å– å¾…æ‰§è¡Œé˜Ÿåˆ— æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡</span></div><div class="line">   List&lt;String&gt; jobNames = regCenter.getChildrenKeys(ReadyNode.ROOT);</div><div class="line">   List&lt;JobContext&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(jobNames.size());</div><div class="line">   <span class="keyword">for</span> (String each : jobNames) &#123;</div><div class="line">       <span class="keyword">if</span> (ineligibleJobNames.contains(each)) &#123;</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// æ’é™¤ ä½œä¸šé…ç½® ä¸å­˜åœ¨çš„ä½œä¸š</span></div><div class="line">       Optional&lt;CloudJobConfiguration&gt; jobConfig = configService.load(each);</div><div class="line">       <span class="keyword">if</span> (!jobConfig.isPresent()) &#123;</div><div class="line">           regCenter.remove(ReadyNode.getReadyJobNodePath(each));</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!runningService.isJobRunning(each)) &#123; <span class="comment">// æ’é™¤ è¿è¡Œä¸­ çš„ä½œä¸š</span></div><div class="line">           result.add(JobContext.from(jobConfig.get(), ExecutionType.READY));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li></li></ul></li><li><p>JobContextï¼Œä½œä¸šè¿è¡Œä¸Šä¸‹æ–‡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobContext.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobContext</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CloudJobConfiguration jobConfig;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Integer&gt; assignedShardingItems;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutionType type;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é€šè¿‡ä½œä¸šé…ç½®åˆ›å»ºä½œä¸šè¿è¡Œä¸Šä¸‹æ–‡.</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> type æ‰§è¡Œç±»å‹</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> ä½œä¸šè¿è¡Œä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobContext <span class="title">from</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig, <span class="keyword">final</span> ExecutionType type)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> shardingTotalCount = jobConfig.getTypeConfig().getCoreConfig().getShardingTotalCount();</div><div class="line">        <span class="comment">// åˆ†ç‰‡é¡¹</span></div><div class="line">        List&lt;Integer&gt; shardingItems = <span class="keyword">new</span> ArrayList&lt;&gt;(shardingTotalCount);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shardingTotalCount; i++) &#123;</div><div class="line">            shardingItems.add(i);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JobContext(jobConfig, shardingItems, type);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul></li></ul><ul><li><p>LaunchingTasksï¼Œåˆ†é…ä»»åŠ¡è¡Œä¸ºåŒ…ã€‚åˆ›å»º LaunchingTasks ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LaunchingTasks</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line"><span class="comment">     * keyï¼šä½œä¸šå</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, JobContext&gt; eligibleJobContextsMap;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LaunchingTasks</span><span class="params">(<span class="keyword">final</span> Collection&lt;JobContext&gt; eligibleJobContexts)</span> </span>&#123;</div><div class="line">        eligibleJobContextsMap = <span class="keyword">new</span> HashMap&lt;&gt;(eligibleJobContexts.size(), <span class="number">1</span>);</div><div class="line">        <span class="keyword">for</span> (JobContext each : eligibleJobContexts) &#123;</div><div class="line">            eligibleJobContextsMap.put(each.getJobConfig().getJobName(), each);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>LaunchingTasks#getPendingTasks()</code> æ–¹æ³•ï¼Œè·å¾—å¾…æ‰§è¡Œä»»åŠ¡é›†åˆã€‚<strong>è¿™é‡Œè¦æ³¨æ„ï¼Œæ¯ä¸ªä½œä¸šå¦‚æœæœ‰å¤šä¸ªåˆ†ç‰‡ï¼Œåˆ™ä¼šç”Ÿæˆå¤šä¸ªå¾…æ‰§è¡Œä»»åŠ¡ï¼Œå³æ­¤å¤„å®Œæˆäº†ä½œä¸šåˆ†ç‰‡</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LaunchingTasks.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å¾—å¾…æ‰§è¡Œä»»åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> å¾…æ‰§è¡Œä»»åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function">List&lt;TaskRequest&gt; <span class="title">getPendingTasks</span><span class="params">()</span> </span>&#123;</div><div class="line">   List&lt;TaskRequest&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(eligibleJobContextsMap.size() * <span class="number">10</span>);</div><div class="line">   <span class="keyword">for</span> (JobContext each : eligibleJobContextsMap.values()) &#123;</div><div class="line">       result.addAll(createTaskRequests(each));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºå¾…æ‰§è¡Œä»»åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobContext ä½œä¸šè¿è¡Œä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> å¾…æ‰§è¡Œä»»åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;TaskRequest&gt; <span class="title">createTaskRequests</span><span class="params">(<span class="keyword">final</span> JobContext jobContext)</span> </span>&#123;</div><div class="line">   Collection&lt;TaskRequest&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(jobContext.getAssignedShardingItems().size());</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : jobContext.getAssignedShardingItems()) &#123;</div><div class="line">       result.add(<span class="keyword">new</span> JobTaskRequest(<span class="keyword">new</span> TaskContext(jobContext.getJobConfig().getJobName(), Collections.singletonList(each), jobContext.getType()), jobContext.getJobConfig()));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// TaskContext.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskContext</span> </span>&#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * ä»»åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> String id;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * ä»»åŠ¡å…ƒä¿¡æ¯</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> MetaInfo metaInfo;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * æ‰§è¡Œç±»å‹</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> ExecutionType type;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Mesos Slave ç¼–å·</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> String slaveId;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * æ˜¯å¦é—²ç½®</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">boolean</span> idle;</div><div class="line">   </div><div class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MetaInfo</span> </span>&#123;</div><div class="line"></div><div class="line">       <span class="comment">/**</span></div><div class="line"><span class="comment">        * ä½œä¸šå</span></div><div class="line"><span class="comment">        */</span></div><div class="line">       <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">       <span class="comment">/**</span></div><div class="line"><span class="comment">        * ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line"><span class="comment">        */</span></div><div class="line">       <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Integer&gt; shardingItems;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="comment">// ... çœç•¥éƒ¨åˆ†æ–¹æ³•</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobTaskRequest.JAVA</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobTaskRequest</span> <span class="keyword">implements</span> <span class="title">TaskRequest</span> </span>&#123;</div><div class="line">    </div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> TaskContext taskContext;</div><div class="line">       </div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> CloudJobConfiguration jobConfig;</div><div class="line">       </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> taskContext.getId();</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getCPUs</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> jobConfig.getCpuCount();</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getMemory</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> jobConfig.getMemoryMB();</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="comment">// ... çœç•¥éƒ¨åˆ†æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#createTaskRequests(...)</code> æ–¹æ³•ï¼Œ<strong>å°†å•ä¸ªä½œä¸šæŒ‰ç…§å…¶ä½œä¸šåˆ†ç‰‡æ€»æ•°æ‹†åˆ†æˆä¸€ä¸ªæˆ–å¤šä¸ªå¾…æ‰§è¡Œä»»åŠ¡é›†åˆ</strong>ã€‚</li><li>TaskContextï¼Œä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡ã€‚</li><li>JobTaskRequestï¼Œä½œä¸šä»»åŠ¡è¯·æ±‚å¯¹è±¡ã€‚</li></ul></li><li><p>å› ä¸ºå¯¹è±¡æœ‰ç‚¹å¤šï¼Œæˆ‘ä»¬æ¥è´´ä¸€ä¸ª <code>LaunchingTasks#getPendingTasks()</code> æ–¹æ³•çš„è¿”å›ç»“æœã€‚<img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/03.png" alt=""></p></li></ul><p><strong>å‹æƒ…æç¤ºï¼Œä»£ç å¯èƒ½æ¯”è¾ƒå¤šï¼Œè¯·è€å¿ƒè§‚çœ‹ã€‚</strong></p><h2>4.2 AppConstraintEvaluator</h2><p>åœ¨è¯´ AppConstraintEvaluator ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä¸€èµ·äº†<strong>ç®€å•</strong>è§£ä¸‹ <a href="https://github.com/Netflix/Fenzo/wiki" rel="external nofollow noopener noreferrer" target="_blank">Netflix Fenzo</a>ã€‚</p><blockquote><p>FROM http://dockone.io/article/636<br>Fenzoæ˜¯ä¸€ä¸ªåœ¨Mesosæ¡†æ¶ä¸Šåº”ç”¨çš„é€šç”¨ä»»åŠ¡è°ƒåº¦å™¨ã€‚å®ƒå¯ä»¥è®©ä½ é€šè¿‡å®ç°å„ç§ä¼˜åŒ–ç­–ç•¥çš„æ’ä»¶ï¼Œæ¥ä¼˜åŒ–ä»»åŠ¡è°ƒåº¦ï¼ŒåŒæ—¶è¿™ä¹Ÿæœ‰åˆ©äºé›†ç¾¤çš„è‡ªåŠ¨ç¼©æ”¾ã€‚</p></blockquote><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/05.png" alt=""></p><p>Elastic-Job-Cloud-Scheduler åŸºäº Fenzo å®ç°å¯¹ Mesos çš„å¼¹æ€§èµ„æºåˆ†é…ã€‚</p><p>ä¾‹å¦‚ï¼ŒAppConstraintEvaluatorï¼ŒApp ç›®æ ‡ Mesos Slave é€‚é…åº¦é™åˆ¶å™¨ï¼Œé€‰æ‹© Slave æ—¶éœ€è¦è€ƒè™‘å…¶ä¸Šæ˜¯å¦è¿è¡Œæœ‰ App çš„ Executorï¼Œå¦‚æœæ²¡æœ‰è¿è¡Œ Executor éœ€è¦å°†å…¶èµ„æºæ¶ˆè€—è€ƒè™‘è¿›é€‚é…è®¡ç®—ç®—æ³•ä¸­ã€‚å®ƒæ˜¯ <a href="https://github.com/Netflix/Fenzo/blob/5de0e0861def4a655be35a9624e67318a6c0afac/fenzo-core/src/main/java/com/netflix/fenzo/ConstraintEvaluator.java" rel="external nofollow noopener noreferrer" target="_blank">Fenzo ConstraintEvaluator æ¥å£</a> åœ¨ Elastic-Job-Cloud-Scheduler çš„è‡ªå®šä¹‰ä»»åŠ¡çº¦æŸå®ç°ã€‚é€šè¿‡è¿™ä¸ªä»»åŠ¡çº¦æŸï¼Œåœ¨ä¸‹æ–‡è°ƒç”¨ <code>TaskScheduler#scheduleOnce(...)</code> æ–¹æ³•è°ƒåº¦ä»»åŠ¡æ‰€éœ€èµ„æºæ—¶ï¼Œä¼šå°† AppConstraintEvaluator è€ƒè™‘è¿›å»ã€‚</p><p>é‚£ä¹ˆä½œä¸šä»»åŠ¡è¯·æ±‚( JobTaskRequest ) æ˜¯æ€ä¹ˆå…³è”ä¸Š AppConstraintEvaluator çš„å‘¢ï¼Ÿ</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobTaskRequest.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobTaskRequest</span> <span class="keyword">implements</span> <span class="title">TaskRequest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> List&lt;? extends ConstraintEvaluator&gt; getHardConstraints() &#123;</div><div class="line">        <span class="keyword">return</span> Collections.singletonList(AppConstraintEvaluator.getInstance());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><a href="https://github.com/Netflix/Fenzo/blob/20d71b5c3213063fc938cd2841dc7569601d1d99/fenzo-core/src/main/java/com/netflix/fenzo/TaskRequest.java" rel="external nofollow noopener noreferrer" target="_blank">Fenzo TaskRequest æ¥å£</a> æ˜¯ Fenzo çš„ä»»åŠ¡è¯·æ±‚æ¥å£ï¼Œé€šè¿‡å®ç° <code>#getHardConstraints()</code> æ–¹æ³•ï¼Œå…³è”ä¸Š TaskRequest å’Œ ConstraintEvaluatorã€‚</li></ul><p>å…³è”ä¸Šä¹‹åï¼Œä»»åŠ¡åŒ¹é… Mesos Slave èµ„æºæ—¶ï¼Œè°ƒç”¨ <code>ConstraintEvaluator#evaluate(...)</code> å®ç°æ–¹æ³•åˆ¤æ–­æ˜¯å¦ç¬¦åˆçº¦æŸï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConstraintEvaluator</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Result</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isSuccessful;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String failureReason;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Inspects a target to decide whether or not it meets the constraints appropriate to a particular task.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> taskRequest a description of the task to be assigned</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> targetVM a description of the host that is a potential match for the task</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> taskTrackerState the current status of tasks and task assignments in the system at large</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> a successful Result if the target meets the constraints enforced by this constraint evaluator, or</span></div><div class="line"><span class="comment">     *         an unsuccessful Result otherwise</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">evaluate</span><span class="params">(TaskRequest taskRequest, VirtualMachineCurrentState targetVM,</span></span></div><div class="line"><span class="function"><span class="params">                           TaskTrackerState taskTrackerState)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>OKï¼Œç®€å•äº†è§£ç»“æŸï¼Œæœ‰å…´è¶£äº†è§£æ›´å¤šçš„åŒå­¦ï¼Œè¯·ç‚¹å‡»<a href="https://github.com/Netflix/Fenzo/wiki/Constraints" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Constraintsã€‹</a>ã€‚ä¸‹é¢æ¥çœ‹çœ‹ Elastic-Job-Cloud-Scheduler è‡ªå®šä¹‰å®ç°çš„ä»»åŠ¡çº¦æŸ AppConstraintEvaluatorã€‚</p><hr><p>è°ƒç”¨ <code>AppConstraintEvaluator#loadAppRunningState()</code> æ–¹æ³•ï¼ŒåŠ è½½å½“å‰è¿è¡Œä¸­çš„<strong>äº‘ä½œä¸šApp</strong>ï¼Œä¸º <code>AppConstraintEvaluator#evaluate(...)</code> æ–¹æ³•æä¾›è¯¥æ•°æ®ã€‚ä»£ç å®ç°å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AppConstraintEvaluator.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; runningApps = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">loadAppRunningState</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">for</span> (MesosStateService.ExecutorStateInfo each : facadeService.loadExecutorInfo()) &#123;</div><div class="line">           runningApps.add(each.getId());</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> JSONException | UniformInterfaceException | ClientHandlerException e) &#123;</div><div class="line">       clearAppRunningState();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>FacadeService#loadExecutorInfo()</code> æ–¹æ³•ï¼Œä» Mesos è·å–æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ Mesos æ‰§è¡Œå™¨( Executor )çš„ä¿¡æ¯ã€‚æ‰§è¡Œå™¨å’Œäº‘ä½œä¸šAppæœ‰å•¥å…³ç³»ï¼Ÿ<strong>æ¯ä¸ªäº‘ä½œä¸šApp å³æ˜¯ä¸€ä¸ª Elastic-Job-Cloud-Executor å®ä¾‹ã€‚</strong>ã€‚<code>FacadeService#loadExecutorInfo()</code> æ–¹æ³•è¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦è‡ªå·±çœ‹ä¸‹ï¼Œä¸»è¦æ˜¯å¯¹ Mesos çš„ APIæ“ä½œï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ <code>runningApps</code> çš„ç»“æœï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/04.png" alt=""></p></li></ul><hr><p>è°ƒç”¨ <code>TaskScheduler#scheduleOnce(...)</code> æ–¹æ³•è°ƒåº¦æäº¤ä»»åŠ¡æ‰€éœ€èµ„æºæ—¶ï¼Œä¼šè°ƒç”¨ <code>ConstraintEvaluator#loadAppRunningState()</code> æ£€æŸ¥åˆ†é…çš„èµ„æºæ˜¯å¦ç¬¦åˆä»»åŠ¡çš„çº¦æŸæ¡ä»¶ã€‚<code>AppConstraintEvaluator#loadAppRunningState()</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AppConstraintEvaluator.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">evaluate</span><span class="params">(<span class="keyword">final</span> TaskRequest taskRequest, <span class="keyword">final</span> VirtualMachineCurrentState targetVM, <span class="keyword">final</span> TaskTrackerState taskTrackerState)</span> </span>&#123;</div><div class="line">   <span class="keyword">double</span> assigningCpus = <span class="number">0.0</span>d;</div><div class="line">   <span class="keyword">double</span> assigningMemoryMB = <span class="number">0.0</span>d;</div><div class="line">   <span class="keyword">final</span> String slaveId = targetVM.getAllCurrentOffers().iterator().next().getSlaveId().getValue();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// åˆ¤æ–­å½“å‰åˆ†é…çš„ Mesos Slave æ˜¯å¦è¿è¡Œç€è¯¥ä½œä¸šä»»åŠ¡è¯·æ±‚å¯¹åº”çš„äº‘ä½œä¸šApp</span></div><div class="line">       <span class="keyword">if</span> (isAppRunningOnSlave(taskRequest.getId(), slaveId)) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, <span class="string">""</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// åˆ¤æ–­å½“å‰åˆ†é…çš„ Mesos Slave å¯åŠ¨äº‘ä½œä¸šApp æ˜¯å¦è¶…è¿‡èµ„æºé™åˆ¶</span></div><div class="line">       Set&lt;String&gt; calculatedApps = <span class="keyword">new</span> HashSet&lt;&gt;(); <span class="comment">// å·²è®¡ç®—ä½œä¸šAppé›†åˆ</span></div><div class="line">       List&lt;TaskRequest&gt; taskRequests = <span class="keyword">new</span> ArrayList&lt;&gt;(targetVM.getTasksCurrentlyAssigned().size() + <span class="number">1</span>);</div><div class="line">       taskRequests.add(taskRequest);</div><div class="line">       <span class="keyword">for</span> (TaskAssignmentResult each : targetVM.getTasksCurrentlyAssigned()) &#123; <span class="comment">// å½“å‰å·²ç»åˆ†é…ä½œä¸šè¯·æ±‚</span></div><div class="line">           taskRequests.add(each.getRequest());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">for</span> (TaskRequest each : taskRequests) &#123;</div><div class="line">           assigningCpus += each.getCPUs();</div><div class="line">           assigningMemoryMB += each.getMemory();</div><div class="line">           <span class="keyword">if</span> (isAppRunningOnSlave(each.getId(), slaveId)) &#123; <span class="comment">// ä½œä¸šAppå·²ç»å¯åŠ¨</span></div><div class="line">               <span class="keyword">continue</span>;</div><div class="line">           &#125;</div><div class="line">           CloudAppConfiguration assigningAppConfig = getAppConfiguration(each.getId());</div><div class="line">           <span class="keyword">if</span> (!calculatedApps.add(assigningAppConfig.getAppName())) &#123; <span class="comment">// æ˜¯å¦å·²ç»è®¡ç®—è¯¥App</span></div><div class="line">               <span class="keyword">continue</span>;</div><div class="line">           &#125;</div><div class="line">           assigningCpus += assigningAppConfig.getCpuCount();</div><div class="line">           assigningMemoryMB += assigningAppConfig.getMemoryMB();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> LackConfigException ex) &#123;</div><div class="line">       log.warn(<span class="string">"Lack config, disable &#123;&#125;"</span>, getName(), ex);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, <span class="string">""</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (assigningCpus &gt; targetVM.getCurrAvailableResources().cpuCores()) &#123; <span class="comment">// cpu</span></div><div class="line">       log.debug(<span class="string">"Failure &#123;&#125; &#123;&#125; cpus:&#123;&#125;/&#123;&#125;"</span>, taskRequest.getId(), slaveId, assigningCpus, targetVM.getCurrAvailableResources().cpuCores());</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>, String.format(<span class="string">"cpu:%s/%s"</span>, assigningCpus, targetVM.getCurrAvailableResources().cpuCores()));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (assigningMemoryMB &gt; targetVM.getCurrAvailableResources().memoryMB()) &#123; <span class="comment">// memory</span></div><div class="line">       log.debug(<span class="string">"Failure &#123;&#125; &#123;&#125; mem:&#123;&#125;/&#123;&#125;"</span>, taskRequest.getId(), slaveId, assigningMemoryMB, targetVM.getCurrAvailableResources().memoryMB());</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>, String.format(<span class="string">"mem:%s/%s"</span>, assigningMemoryMB, targetVM.getCurrAvailableResources().memoryMB()));</div><div class="line">   &#125;</div><div class="line">   log.debug(<span class="string">"Success &#123;&#125; &#123;&#125; cpus:&#123;&#125;/&#123;&#125; mem:&#123;&#125;/&#123;&#125;"</span>, taskRequest.getId(), slaveId, assigningCpus, targetVM.getCurrAvailableResources()</div><div class="line">           .cpuCores(), assigningMemoryMB, targetVM.getCurrAvailableResources().memoryMB());</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, String.format(<span class="string">"cpus:%s/%s mem:%s/%s"</span>, assigningCpus, targetVM.getCurrAvailableResources()</div><div class="line">           .cpuCores(), assigningMemoryMB, targetVM.getCurrAvailableResources().memoryMB()));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#isAppRunningOnSlave()</code> æ–¹æ³•ï¼Œåˆ¤æ–­å½“å‰åˆ†é…çš„ Mesos Slave æ˜¯å¦è¿è¡Œç€è¯¥ä½œä¸šä»»åŠ¡è¯·æ±‚å¯¹åº”çš„äº‘ä½œä¸šAppã€‚è‹¥äº‘ä½œä¸šAppæœªè¿è¡Œï¼Œåˆ™è¯¥ä½œä¸šä»»åŠ¡è¯·æ±‚æäº¤ç»™ Mesos åï¼Œè¯¥ Mesos Slave ä¼šå¯åŠ¨è¯¥äº‘ä½œä¸š Appï¼ŒApp æœ¬èº«ä¼šå ç”¨ä¸€å®šçš„ <code>CloudAppConfiguration#cpu</code> å’Œ <code>CloudAppConfiguration#memory</code>ï¼Œè®¡ç®—æ—¶éœ€è¦ç»Ÿè®¡ï¼Œé¿å…è¶…è¿‡å½“å‰ Mesos Slave å‰©ä½™ <code>cpu</code> å’Œ <code>memory</code>ã€‚</li><li>å½“è®¡ç®—ç¬¦åˆçº¦æŸæ—¶ï¼Œè¿”å› <code>Result(true, ...)</code>ï¼›å¦åˆ™ï¼Œè¿”å› <code>Result(false, ...)</code>ã€‚</li><li>TODO å¼‚å¸¸ä¸ºå•¥è¿”å›trueã€‚</li></ul><h2>4.3 å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ° Mesos Offer</h2><p>æˆ‘ä»¬å…ˆ<strong>ç®€å•</strong>äº†è§£ä¸‹ Elastic-Job-Cloud-Scheduler å®ç°çš„ Mesos Scheduler ç±» <code>com.dangdang.ddframe.job.cloud.scheduler.mesos.SchedulerEngine</code>ã€‚è°ƒåº¦å™¨çš„ä¸»è¦èŒè´£ä¹‹ä¸€ï¼š<strong>åœ¨æ¥å—åˆ°çš„ Offer ä¸Šå¯åŠ¨ä»»åŠ¡</strong>ã€‚SchedulerEngine æ¥æ”¶åˆ°èµ„æº Offerï¼Œå…ˆå­˜å‚¨åˆ°èµ„æºé¢„å é˜Ÿåˆ—( LeasesQueue )ï¼Œç­‰åˆ°ä½œä¸šè¢«è°ƒåº¦éœ€è¦å¯åŠ¨ä»»åŠ¡æ—¶è¿›è¡Œä½¿ç”¨ã€‚å­˜å‚¨åˆ°èµ„æºé¢„å é˜Ÿåˆ—å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerEngine</span> <span class="keyword">implements</span> <span class="title">Scheduler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">resourceOffers</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver, <span class="keyword">final</span> List&lt;Protos.Offer&gt; offers)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Protos.Offer offer: offers) &#123;</div><div class="line">            log.trace(<span class="string">"Adding offer &#123;&#125; from host &#123;&#125;"</span>, offer.getId(), offer.getHostname());</div><div class="line">            LeasesQueue.getInstance().offer(offer);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>org.apache.mesos.Scheduler</code>ï¼ŒMesos è°ƒåº¦å™¨<strong>æ¥å£</strong>ï¼Œå®ç°è¯¥æ¥å£æˆä¸ºè‡ªå®šä¹‰ Mesos è°ƒåº¦å™¨ã€‚</p></li><li><p>å®ç° <code>#resourceOffers(...)</code> æ–¹æ³•ï¼Œæœ‰æ–°çš„èµ„æº Offer æ—¶ï¼Œä¼šè¿›è¡Œè°ƒç”¨ã€‚åœ¨ SchedulerEngine ä¼šè°ƒç”¨ <code>#offer(...)</code> æ–¹æ³•ï¼Œå­˜å‚¨ Offer åˆ°èµ„æºé¢„å é˜Ÿåˆ—ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LeasesQueue</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•ä¾‹</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LeasesQueue INSTANCE = <span class="keyword">new</span> LeasesQueue();</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;VirtualMachineLease&gt; queue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·å–å®ä¾‹.</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> å•ä¾‹å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LeasesQueue <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> INSTANCE;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ·»åŠ èµ„æºè‡³é˜Ÿåˆ—é¢„å .</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> offer èµ„æº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offer</span><span class="params">(<span class="keyword">final</span> Protos.Offer offer)</span> </span>&#123;</div><div class="line">        queue.offer(<span class="keyword">new</span> VMLeaseObject(offer));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥ #drainTo() æ–¹æ³•ï¼Œä¸‹æ–‡è§£æã€‚</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>VMLeaseObjectï¼Œ<a href="#">Netflix Fenzo</a> å¯¹ Mesos Offer çš„æŠ½è±¡åŒ…è£…ï¼Œç‚¹å‡»<a href="https://github.com/Netflix/Fenzo/blob/faa8a4dd411fff1792c9d788d1288a11e3635ba7/fenzo-core/src/main/java/com/netflix/fenzo/plugins/VMLeaseObject.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹å®ç°ä»£ç ï¼Œé©¬ä¸Šä¼šçœ‹åˆ°å®ƒçš„ç”¨é€”ã€‚</li></ul></li></ul><p>å¦å¤–ï¼Œå¯èƒ½æœ‰åŒå­¦å¯¹ Mesos Offer ç†è§£æ¯”è¾ƒç”Ÿæ¶©ï¼ŒOffer å®šä¹‰å¦‚ä¸‹ï¼š</p><blockquote><p>FROM https://segmentfault.com/a/1190000007723430<br>Offeræ˜¯Mesosèµ„æºçš„æŠ½è±¡ï¼Œæ¯”å¦‚è¯´æœ‰å¤šå°‘CPUã€å¤šå°‘memoryï¼Œdiscæ˜¯å¤šå°‘ï¼Œéƒ½æ”¾åœ¨Offeré‡Œï¼Œæ‰“åŒ…ç»™ä¸€ä¸ªFrameworkï¼Œç„¶åFrameworkæ¥å†³å®šåˆ°åº•æ€ä¹ˆç”¨è¿™ä¸ªOfferã€‚</p></blockquote><hr><p>OKï¼ŒçŸ¥è¯†é“ºå«å®Œæˆï¼Œå›åˆ°æœ¬å°èŠ‚çš„é‡å¿ƒï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line">Collection&lt;VMAssignmentResult&gt; vmAssignmentResults = taskScheduler.scheduleOnce(taskRequests, LeasesQueue.getInstance().drainTo()).getResultMap().values();</div><div class="line"></div><div class="line"><span class="comment">// LeasesQueue.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LeasesQueue</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;VirtualMachineLease&gt; queue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;VirtualMachineLease&gt; <span class="title">drainTo</span><span class="params">()</span> </span>&#123;</div><div class="line">        List&lt;VirtualMachineLease&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(queue.size());</div><div class="line">        queue.drainTo(result);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>è°ƒç”¨ <code>TaskScheduler#scheduleOnce(...)</code> æ–¹æ³•ï¼Œå°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ° Mesos Offerã€‚é€šè¿‡ Fenzo TaskScheduler å®ç°å¯¹å¤šä¸ªä»»åŠ¡åˆ†é…åˆ°å¤šä¸ª Mesos Offer çš„<strong>åˆç†ä¼˜åŒ–åˆ†é…</strong>ã€‚è¿™æ˜¯ä¸€ä¸ªç›¸å¯¹å¤æ‚çš„é—®é¢˜ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿ</p><blockquote><p>FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P76<br>å°†ä»»åŠ¡åŒ¹é…åˆ° offer ä¸Šï¼Œé¦–æ¬¡é€‚é…é€šå¸¸æ˜¯æœ€å¥½çš„ç®—æ³•ã€‚ä½ å¯èƒ½ä¼šæƒ³ï¼Œå¦‚æœåœ¨æ›´å¤šçš„å·¥ä½œé‡Œå°è¯•è®¡ç®—å‡ºåŒ¹é…è¯¥ offer çš„ä¼˜åŒ–ç»„åˆï¼Œå¯èƒ½æ¯”é¦–æ¬¡é€‚é…æ›´èƒ½é«˜æ•ˆåœ°åˆ©ç”¨ offerã€‚è¿™ç»å¯¹æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯è¦è€ƒè™‘å¦‚ä¸‹è¿™äº›æ–¹é¢ï¼šå¯¹äºå¯åŠ¨æ‰€æœ‰ç­‰å¾…è¿è¡Œçš„ä»»åŠ¡æ¥è¯´ï¼Œé›†ç¾¤é‡Œè¦ä¹ˆæœ‰å……è¶³çš„èµ„æºè¦ä¹ˆæ²¡æœ‰ã€‚å¦‚æœèµ„æºå¾ˆå¤šï¼Œé‚£ä¹ˆé¦–æ¬¡é€‚é…è‚¯å®šä¸€ç›´éƒ½èƒ½ä¿è¯æ¯ä¸ªä»»åŠ¡çš„å¯åŠ¨ã€‚å¦‚æœèµ„æºä¸å¤Ÿï¼Œæ€ä¹ˆéƒ½æ— æ³•å¯åŠ¨æ‰€æœ‰ä»»åŠ¡ã€‚å› æ­¤ï¼Œç¼–å†™ä»£ç é€‰æ‹©æ¥ä¸‹æ¥ä¼šè¿è¡Œå“ªä¸ªä»»åŠ¡æ˜¯å¾ˆè‡ªç„¶çš„ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯æœåŠ¡çš„è´¨é‡ã€‚åªæœ‰å½“èµ„æºåˆšå¤Ÿç”¨æ—¶ï¼Œæ‰éœ€è¦æ›´ä¸ºç²¾ç»†çš„æ‰“åŒ…ç®—æ³•ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™é‡Œçš„é—®é¢˜ â€”â€” é€šå¸¸ç§°ä¸ºèƒŒåŒ…é—®é¢˜( Knapsack problem ) â€”â€” æ˜¯ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„ NP å®Œå…¨é—®é¢˜ã€‚NP å®Œå…¨é—®é¢˜æŒ‡çš„æ˜¯éœ€è¦ç›¸å½“é•¿æ—¶é—´æ‰èƒ½æ‰¾åˆ°æœ€ä¼˜è§£å†³æ–¹æ¡ˆçš„é—®é¢˜ï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•å·²çŸ¥é“æŠ€å·§èƒ½å¤Ÿå¿«é€Ÿè§£å†³è¿™ç±»é—®é¢˜ã€‚</p></blockquote><p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œåªè€ƒè™‘ <code>memory</code> èµ„æºæƒ…å†µä¸‹ï¼Œæœ‰ä¸€å° Slave å†…å­˜ä¸º 8GB ï¼Œç°åœ¨è¦è¿è¡Œä¸‰ä¸ª 1GB çš„ä½œä¸šå’Œ 5GB çš„ä½œä¸šã€‚å…¶ä¸­ 5GB çš„ä½œä¸šåœ¨ 1GB è¿è¡Œå¤šæ¬¡ä¹‹åæ‰æ‰§è¡Œã€‚</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/06.png" alt=""></p><p>å®é™…æƒ…å†µä¼šæ¯”å›¾æ›´åŠ å¤æ‚çš„å¤šçš„å¤šã€‚é€šè¿‡ä½¿ç”¨ Fenzo ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„ï¼Œå¹¶ä¸”ä»¤äººæ»¡æ„çš„åˆ†é…ã€‚ä¸ºäº†è®©ä½ å¯¹ Fenzo æœ‰æ›´åŠ é€å½»çš„ç†è§£ï¼Œè¿™é‡Œå†å¼•ç”¨ä¸€æ®µå¯¹å…¶çš„ä»‹ç»ï¼š</p><blockquote><p>FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P80<br><strong>è°ƒç”¨åº“å‡½æ•° Fenzo</strong><br>Fenzo æ˜¯ Nettflix åœ¨ 2015 å¹´å¤å¤©å‘å¸ƒçš„åº“å‡½æ•°ã€‚Fenzo ä¸ºåŸºäº java çš„è°ƒåº¦å™¨æä¾›äº†å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œå®Œæˆ offer ç¼“å†²ï¼Œå¤šä»»åŠ¡å¯åŠ¨ï¼Œä»¥åŠè½¯å’Œç¡¬çº¦æŸæ¡ä»¶çš„åŒ¹é…ã€‚å°±ç®—ä¸æ˜¯æ‰€æœ‰çš„ï¼Œä¹Ÿæ˜¯å¾ˆå¤šè°ƒåº¦å™¨éƒ½èƒ½å¤Ÿå—ç›Šäºä½¿ç”¨ Fenzo æ¥å®Œæˆè®¡ç®—ä»»åŠ¡åˆ†é…ï¼Œè€Œä¸ç”¨è‡ªå·±ç¼–å†™ offer ç¼“å†²ã€æ‰“åŒ…å’Œæ”¾ç½®è·¯ç”±ç­‰ã€‚</p></blockquote><p>ä¸‹é¢ï¼Œæ¥çœ‹ä¸¤æ¬¡ <code>TaskScheduler#scheduleOnce(...)</code> çš„è¿”å›ï¼š</p><ul><li><p>ç¬¬ä¸€æ¬¡è°ƒåº¦ï¼š<img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/07.png" alt=""></p></li><li><p>ç¬¬äºŒæ¬¡è°ƒåº¦ï¼š<img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/08.png" alt=""></p></li><li><p><code>com.netflix.fenzo.VMAssignmentResult</code>ï¼Œæ¯å°ä¸»æœºåˆ†é…ä»»åŠ¡ç»“æœã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VMAssignmentResult</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä¸»æœº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String hostname;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½¿ç”¨çš„ Mesos Offer</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;VirtualMachineLease&gt; leasesUsed;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ†é…çš„ä»»åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;TaskAssignmentResult&gt; tasksAssigned;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><p>å—é™äºç¬”è€…çš„èƒ½åŠ›ï¼Œå»ºè®®ä½ å¯ä»¥åœ¨é˜…è¯»å¦‚ä¸‹æ–‡ç« ï¼Œæ›´é€å½»çš„ç†è§£ TaskScheduler ï¼š</p><ul><li><a href="https://github.com/Netflix/Fenzo/wiki/How-to-use-Fenzo" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Constraintsã€‹</a></li><li><a href="https://github.com/Netflix/Fenzo/wiki/Building-Your-Scheduler" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Building Your Schedulerã€‹</a></li><li><a href="https://github.com/Netflix/Fenzo/wiki/Scheduling-Tasks" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Scheduling Tasksã€‹</a></li><li><a href="https://github.com/Netflix/Fenzo/wiki/Insights#how-to-learn-which-tasks-are-assigned-to-which-hosts" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” How to Learn Which Tasks Are Assigned to Which Hostsã€‹</a></li></ul><h2>4.4 åˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯</h2><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line">List&lt;TaskContext&gt; taskContextsList = <span class="keyword">new</span> LinkedList&lt;&gt;(); <span class="comment">// ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line">Map&lt;List&lt;Protos.OfferID&gt;, List&lt;Protos.TaskInfo&gt;&gt; offerIdTaskInfoMap = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">// Mesos ä»»åŠ¡ä¿¡æ¯é›†åˆ</span></div><div class="line"><span class="keyword">for</span> (VMAssignmentResult each: vmAssignmentResults) &#123;</div><div class="line">    List&lt;VirtualMachineLease&gt; leasesUsed = each.getLeasesUsed();</div><div class="line">    List&lt;Protos.TaskInfo&gt; taskInfoList = <span class="keyword">new</span> ArrayList&lt;&gt;(each.getTasksAssigned().size() * <span class="number">10</span>);</div><div class="line">    taskInfoList.addAll(getTaskInfoList(</div><div class="line">            launchingTasks.getIntegrityViolationJobs(vmAssignmentResults), <span class="comment">// è·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</span></div><div class="line">            each, leasesUsed.get(<span class="number">0</span>).hostname(), leasesUsed.get(<span class="number">0</span>).getOffer()));</div><div class="line">    <span class="keyword">for</span> (Protos.TaskInfo taskInfo : taskInfoList) &#123;</div><div class="line">        taskContextsList.add(TaskContext.from(taskInfo.getTaskId().getValue()));</div><div class="line">    &#125;</div><div class="line">    offerIdTaskInfoMap.put(getOfferIDs(leasesUsed), <span class="comment">// è·å¾— Offer ID é›†åˆ</span></div><div class="line">            taskInfoList);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>offerIdTaskInfoMap</code>ï¼ŒMesos ä»»åŠ¡ä¿¡æ¯é›†åˆã€‚key å’Œ value éƒ½ä¸ºç›¸åŒ Mesos Slave Offer å’Œ ä»»åŠ¡ã€‚ä¸ºä»€ä¹ˆï¼Ÿè°ƒç”¨ <code>SchedulerDriver#launchTasks(...)</code> æ–¹æ³•æäº¤<strong>ä¸€æ¬¡</strong>ä»»åŠ¡æ—¶ï¼Œå¿…é¡»ä¿è¯æ‰€æœ‰ä»»åŠ¡å’Œ Offer åœ¨ç›¸åŒ Mesos Slave ä¸Šã€‚</p><blockquote><p>FROM FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P61<br><strong>ç»„åˆ offer</strong><br>latchTasks æ¥å— offer åˆ—è¡¨ä¸ºè¾“å…¥ï¼Œè¿™å°±å…è®¸ç”¨æˆ·å°†ä¸€äº›ç›¸åŒ slave çš„ offer ç»„åˆèµ·æ¥ï¼Œä»è€Œå°†è¿™äº› offer çš„èµ„æºæ”¾åˆ°æ± é‡Œã€‚å®ƒè¿˜èƒ½æ¥å—ä»»åŠ¡åˆ—è¡¨ä¸ºè¾“å…¥ï¼Œè¿™æ ·å°±èƒ½å¤Ÿå¯åŠ¨é€‚åˆç»™å®š offer çš„è¶³å¤Ÿå¤šçš„ä»»åŠ¡ã€‚æ³¨æ„æ‰€æœ‰ä»»åŠ¡å’Œ offer éƒ½å¿…é¡»æ˜¯åŒä¸€å° slave â€”â€” å¦‚æœä¸åœ¨åŒä¸€å° slave ä¸Šï¼ŒlaunchTasks å°±ä¼šå¤±è´¥ã€‚å¦‚æœæƒ³åœ¨å¤šå° slave ä¸Šå¯åŠ¨ä»»åŠ¡ï¼Œå¤šæ¬¡è°ƒç”¨ latchTasks å³å¯ã€‚</p></blockquote></li><li><p>è°ƒç”¨ <code>LaunchingTasks#getIntegrityViolationJobs(...)</code> æ–¹æ³•ï¼Œè·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆã€‚<strong>ä¸€ä¸ªä½œä¸šæœ‰å¤šä¸ªåˆ†ç‰‡ï¼Œå› ä¸º Mesos Offer ä¸è¶³ï¼Œå¯¼è‡´æœ‰éƒ¨åˆ†åˆ†ç‰‡ä¸èƒ½æ‰§è¡Œï¼Œåˆ™æ•´ä¸ªä½œä¸šéƒ½ä¸è¿›è¡Œæ‰§è¡Œ</strong>ã€‚ä»£ç å®ç°å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LaunchingTasks.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> vmAssignmentResults ä¸»æœºåˆ†é…ä»»åŠ¡ç»“æœé›†åˆ</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function">Collection&lt;String&gt; <span class="title">getIntegrityViolationJobs</span><span class="params">(<span class="keyword">final</span> Collection&lt;VMAssignmentResult&gt; vmAssignmentResults)</span> </span>&#123;</div><div class="line">   Map&lt;String, Integer&gt; assignedJobShardingTotalCountMap = getAssignedJobShardingTotalCountMap(vmAssignmentResults);</div><div class="line">   Collection&lt;String&gt; result = <span class="keyword">new</span> HashSet&lt;&gt;(assignedJobShardingTotalCountMap.size(), <span class="number">1</span>);</div><div class="line">   <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : assignedJobShardingTotalCountMap.entrySet()) &#123;</div><div class="line">       JobContext jobContext = eligibleJobContextsMap.get(entry.getKey());</div><div class="line">       <span class="keyword">if</span> (ExecutionType.FAILOVER != jobContext.getType() <span class="comment">// ä¸åŒ…æ‹¬ FAILOVER æ‰§è¡Œç±»å‹çš„ä½œä¸š</span></div><div class="line">               &amp;&amp; !entry.getValue().equals(jobContext.getJobConfig().getTypeConfig().getCoreConfig().getShardingTotalCount())) &#123;</div><div class="line">           log.warn(<span class="string">"Job &#123;&#125; is not assigned at this time, because resources not enough to run all sharding instances."</span>, entry.getKey());</div><div class="line">           result.add(entry.getKey());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å¾—æ¯ä¸ªä½œä¸šåˆ†ç‰‡æ•°é›†åˆ</span></div><div class="line"><span class="comment">* keyï¼šä½œä¸šå</span></div><div class="line"><span class="comment">* valueï¼šåˆ†ç‰‡æ€»æ•°</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> vmAssignmentResults ä¸»æœºåˆ†é…ä»»åŠ¡ç»“æœé›†åˆ</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ¯ä¸ªä½œä¸šåˆ†ç‰‡æ•°é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, Integer&gt; <span class="title">getAssignedJobShardingTotalCountMap</span><span class="params">(<span class="keyword">final</span> Collection&lt;VMAssignmentResult&gt; vmAssignmentResults)</span> </span>&#123;</div><div class="line">   Map&lt;String, Integer&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;(eligibleJobContextsMap.size(), <span class="number">1</span>);</div><div class="line">   <span class="keyword">for</span> (VMAssignmentResult vmAssignmentResult: vmAssignmentResults) &#123;</div><div class="line">       <span class="keyword">for</span> (TaskAssignmentResult tasksAssigned: vmAssignmentResult.getTasksAssigned()) &#123;</div><div class="line">           String jobName = TaskContext.from(tasksAssigned.getTaskId()).getMetaInfo().getJobName();</div><div class="line">           <span class="keyword">if</span> (result.containsKey(jobName)) &#123;</div><div class="line">               result.put(jobName, result.get(jobName) + <span class="number">1</span>);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               result.put(jobName, <span class="number">1</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><ul><li><p>è°ƒç”¨ <code>#getTaskInfoList(...)</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>å•ä¸ªä¸»æœº</strong>çš„ Mesos ä»»åŠ¡ä¿¡æ¯é›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> List&lt;Protos.TaskInfo&gt; getTaskInfoList(<span class="keyword">final</span> Collection&lt;String&gt; integrityViolationJobs, <span class="keyword">final</span> VMAssignmentResult vmAssignmentResult, <span class="keyword">final</span> String hostname, <span class="keyword">final</span> Protos.Offer offer) &#123;</div><div class="line">   List&lt;Protos.TaskInfo&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(vmAssignmentResult.getTasksAssigned().size());</div><div class="line">   <span class="keyword">for</span> (TaskAssignmentResult each: vmAssignmentResult.getTasksAssigned()) &#123;</div><div class="line">       TaskContext taskContext = TaskContext.from(each.getTaskId());</div><div class="line">       String jobName = taskContext.getMetaInfo().getJobName();</div><div class="line">       <span class="keyword">if</span> (!integrityViolationJobs.contains(jobName) <span class="comment">// æ’é™¤ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä»»åŠ¡</span></div><div class="line">               &amp;&amp; !facadeService.isRunning(taskContext) <span class="comment">// æ’é™¤æ­£åœ¨è¿è¡Œä¸­çš„ä»»åŠ¡</span></div><div class="line">               &amp;&amp; !facadeService.isJobDisabled(jobName)) &#123; <span class="comment">// æ’é™¤è¢«ç¦ç”¨çš„ä»»åŠ¡</span></div><div class="line">           <span class="comment">// åˆ›å»º Mesos ä»»åŠ¡</span></div><div class="line">           Protos.TaskInfo taskInfo = getTaskInfo(offer, each);</div><div class="line">           <span class="keyword">if</span> (<span class="keyword">null</span> != taskInfo) &#123;</div><div class="line">               result.add(taskInfo);</div><div class="line">               <span class="comment">// æ·»åŠ ä»»åŠ¡ä¸»é”®å’Œä¸»æœºåç§°çš„æ˜ å°„</span></div><div class="line">               facadeService.addMapping(taskInfo.getTaskId().getValue(), hostname);</div><div class="line">               <span class="comment">// é€šçŸ¥ TaskScheduler ä¸»æœºåˆ†é…äº†è¿™ä¸ªä»»åŠ¡</span></div><div class="line">               taskScheduler.getTaskAssigner().call(each.getRequest(), hostname);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#getTaskInfo(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ï¼Œåœ¨<a href="#">ã€Œ4.4.1 åˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ä¿¡æ¯ã€</a>è¯¦ç»†è§£æã€‚</p></li><li><p>è°ƒç”¨ <code>FacadeService#addMapping(...)</code> æ–¹æ³•ï¼Œæ·»åŠ ä»»åŠ¡ä¸»é”®å’Œä¸»æœºåç§°çš„æ˜ å°„ã€‚é€šè¿‡è¯¥æ˜ å°„ï¼Œå¯ä»¥æ ¹æ®ä»»åŠ¡ä¸»é”®æŸ¥è¯¢åˆ°å¯¹åº”çš„ä¸»æœºåã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ·»åŠ ä»»åŠ¡ä¸»é”®å’Œä¸»æœºåç§°çš„æ˜ å°„.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskId ä»»åŠ¡ä¸»é”®</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> hostname ä¸»æœºåç§°</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMapping</span><span class="params">(<span class="keyword">final</span> String taskId, <span class="keyword">final</span> String hostname)</span> </span>&#123;</div><div class="line">   runningService.addMapping(taskId, hostname);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RunningService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä»»åŠ¡ä¸»é”®å’Œä¸»æœºåç§°çš„æ˜ å°„</span></div><div class="line"><span class="comment">* key: ä»»åŠ¡ä¸»é”®</span></div><div class="line"><span class="comment">* value: ä¸»æœºåç§°</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, String&gt; TASK_HOSTNAME_MAPPER = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(TASK_INITIAL_SIZE);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMapping</span><span class="params">(<span class="keyword">final</span> String taskId, <span class="keyword">final</span> String hostname)</span> </span>&#123;</div><div class="line">   TASK_HOSTNAME_MAPPER.putIfAbsent(taskId, hostname);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>TaskScheduler#getTaskAssigner()#call(...)</code> æ–¹æ³•ï¼Œé€šçŸ¥ TaskScheduler ä»»åŠ¡è¢«<strong>ç¡®è®¤</strong>åˆ†é…åˆ°è¿™ä¸ªä¸»æœºã€‚TaskScheduler åšä»»åŠ¡å’Œ Offer çš„åŒ¹é…ï¼Œå¯¹å“ªäº›ä»»åŠ¡è¿è¡Œåœ¨å“ªäº›ä¸»æœºæ˜¯æœ‰ä¾èµ–çš„ï¼Œä¸ç„¶æ€ä¹ˆåšåŒ¹é…ä¼˜åŒ–å‘¢ã€‚åœ¨<a href="https://github.com/Netflix/Fenzo/wiki/How-to-use-Fenzo#notify-the-scheduler-of-assigns-and-unassigns-of-tasks" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Notify the Scheduler of Assigns and UnAssigns of Tasksã€‹</a>å¯ä»¥è¿›ä¸€æ­¥äº†è§£ã€‚</p></li></ul></li><li><p>è°ƒç”¨ <code>#getOfferIDs(...)</code> æ–¹æ³•ï¼Œè·å¾— Offer ID é›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> List&lt;Protos.OfferID&gt; getOfferIDs(<span class="keyword">final</span> List&lt;VirtualMachineLease&gt; leasesUsed) &#123;</div><div class="line">   List&lt;Protos.OfferID&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (VirtualMachineLease virtualMachineLease: leasesUsed) &#123;</div><div class="line">       result.add(virtualMachineLease.getOffer().getId());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h3>4.4.1 åˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ä¿¡æ¯</h3><p>è°ƒç”¨ <code>#getTaskInfo()</code> æ–¹æ³•ï¼Œåˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><strong>å¦‚ä¸‹ä¼šæ¶‰åŠå¤§é‡çš„ Mesos API</strong></p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.<span class="function">TaskInfo <span class="title">getTaskInfo</span><span class="params">(<span class="keyword">final</span> Protos.Offer offer, <span class="keyword">final</span> TaskAssignmentResult taskAssignmentResult)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ ¡éªŒ ä½œä¸šé…ç½® æ˜¯å¦å­˜åœ¨</span></div><div class="line">   TaskContext taskContext = TaskContext.from(taskAssignmentResult.getTaskId());</div><div class="line">   Optional&lt;CloudJobConfiguration&gt; jobConfigOptional = facadeService.load(taskContext.getMetaInfo().getJobName());</div><div class="line">   <span class="keyword">if</span> (!jobConfigOptional.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">   CloudJobConfiguration jobConfig = jobConfigOptional.get();</div><div class="line">   <span class="comment">// æ ¡éªŒ ä½œä¸šé…ç½® æ˜¯å¦å­˜åœ¨</span></div><div class="line">   Optional&lt;CloudAppConfiguration&gt; appConfigOptional = facadeService.loadAppConfig(jobConfig.getAppName());</div><div class="line">   <span class="keyword">if</span> (!appConfigOptional.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">   CloudAppConfiguration appConfig = appConfigOptional.get();</div><div class="line">   <span class="comment">// è®¾ç½® Mesos Slave ID</span></div><div class="line">   taskContext.setSlaveId(offer.getSlaveId().getValue());</div><div class="line">   <span class="comment">// è·å¾— åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line">   ShardingContexts shardingContexts = getShardingContexts(taskContext, appConfig, jobConfig);</div><div class="line">   <span class="comment">// ç¬æ—¶çš„è„šæœ¬ä½œä¸šï¼Œä½¿ç”¨ Mesos å‘½ä»¤è¡Œæ‰§è¡Œï¼Œæ— éœ€ä½¿ç”¨æ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">boolean</span> isCommandExecutor = CloudJobExecutionType.TRANSIENT == jobConfig.getJobExecutionType() &amp;&amp; JobType.SCRIPT == jobConfig.getTypeConfig().getJobType();</div><div class="line">   String script = appConfig.getBootstrapScript();</div><div class="line">   <span class="keyword">if</span> (isCommandExecutor) &#123;</div><div class="line">       script = ((ScriptJobConfiguration) jobConfig.getTypeConfig()).getScriptCommandLine();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// åˆ›å»º å¯åŠ¨å‘½ä»¤</span></div><div class="line">   Protos.CommandInfo.URI uri = buildURI(appConfig, isCommandExecutor);</div><div class="line">   Protos.CommandInfo command = buildCommand(uri, script, shardingContexts, isCommandExecutor);</div><div class="line">   <span class="comment">// åˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯</span></div><div class="line">   <span class="keyword">if</span> (isCommandExecutor) &#123;</div><div class="line">       <span class="keyword">return</span> buildCommandExecutorTaskInfo(taskContext, jobConfig, shardingContexts, offer, command);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">return</span> buildCustomizedExecutorTaskInfo(taskContext, appConfig, jobConfig, shardingContexts, offer, command);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#getShardingContexts(...)</code> æ–¹æ³•ï¼Œ è·å¾—åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ShardingContexts <span class="title">getShardingContexts</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> CloudAppConfiguration appConfig, <span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   Map&lt;Integer, String&gt; shardingItemParameters = <span class="keyword">new</span> ShardingItemParameters(jobConfig.getTypeConfig().getCoreConfig().getShardingItemParameters()).getMap();</div><div class="line">   Map&lt;Integer, String&gt; assignedShardingItemParameters = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1</span>, <span class="number">1</span>);</div><div class="line">   <span class="keyword">int</span> shardingItem = taskContext.getMetaInfo().getShardingItems().get(<span class="number">0</span>); <span class="comment">// å•ä¸ªä½œä¸šåˆ†ç‰‡</span></div><div class="line">   assignedShardingItemParameters.put(shardingItem, shardingItemParameters.containsKey(shardingItem) ? shardingItemParameters.get(shardingItem) : <span class="string">""</span>);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ShardingContexts(taskContext.getId(), jobConfig.getJobName(), jobConfig.getTypeConfig().getCoreConfig().getShardingTotalCount(),</div><div class="line">           jobConfig.getTypeConfig().getCoreConfig().getJobParameter(), assignedShardingItemParameters, appConfig.getEventTraceSamplingCount());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>å½“ä»»åŠ¡ä¸º<strong>ç¬æ—¶</strong>çš„<strong>è„šæœ¬</strong>ä½œä¸šæ—¶ï¼Œä½¿ç”¨ Mesos Slave å‘½ä»¤è¡Œè°ƒç”¨å³å¯ï¼Œæ— éœ€ä½¿ç”¨ Elastic-Job-Cloud-Executorã€‚</p></li><li><p>è°ƒç”¨ <code>#buildURI(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºæ‰§è¡Œå™¨çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½åœ°å€ã€‚è¯•ä¸‹ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.CommandInfo.<span class="function">URI <span class="title">buildURI</span><span class="params">(<span class="keyword">final</span> CloudAppConfiguration appConfig, <span class="keyword">final</span> <span class="keyword">boolean</span> isCommandExecutor)</span> </span>&#123;</div><div class="line">   Protos.CommandInfo.URI.Builder result = Protos.CommandInfo.URI.newBuilder()</div><div class="line">           .setValue(appConfig.getAppURL())</div><div class="line">           .setCache(appConfig.isAppCacheEnable()); <span class="comment">// cache</span></div><div class="line">   <span class="keyword">if</span> (isCommandExecutor &amp;&amp; !SupportedExtractionType.isExtraction(appConfig.getAppURL())) &#123;</div><div class="line">       result.setExecutable(<span class="keyword">true</span>); <span class="comment">// æ˜¯å¦å¯æ‰§è¡Œ</span></div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       result.setExtract(<span class="keyword">true</span>); <span class="comment">// æ˜¯å¦éœ€è¦è§£å‹</span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>äº‘ä½œä¸šåº”ç”¨é…ç½® <code>CloudAppConfiguration.appURL</code> ï¼Œé€šè¿‡ Mesos å®ç°æ–‡ä»¶çš„ä¸‹è½½ã€‚</p></li><li><p>äº‘ä½œä¸šåº”ç”¨é…ç½® <code>CloudAppConfiguration.appCacheEnable</code>ï¼Œåº”ç”¨æ–‡ä»¶ä¸‹è½½æ˜¯å¦ç¼“å­˜ã€‚</p><blockquote><p>FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P99<br><strong>Fetcher ç¼“å­˜</strong><br>Mesos 0.23 é‡Œå‘å¸ƒç§°ä¸º fetcher ç¼“å­˜çš„æ–°åŠŸèƒ½ã€‚fetcher ç¼“å­˜ç¡®ä¿æ¯ä¸ª artifact åœ¨æ¯ä¸ª slave åªä¼šä¸‹è½½ä¸€æ¬¡ï¼Œå³ä½¿å¤šä¸ªæ‰§è¡Œå™¨è¯·æ±‚åŒä¸€ä¸ª artifactï¼Œä¹Ÿåªéœ€è¦ç­‰å¾…å•è¯ä¸‹è½½å®Œæˆå³å¯ã€‚</p></blockquote></li></ul></li><li><p>è°ƒç”¨ <code>#buildCommand(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºæ‰§è¡Œå™¨å¯åŠ¨å‘½ä»¤ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.<span class="function">CommandInfo <span class="title">buildCommand</span><span class="params">(<span class="keyword">final</span> Protos.CommandInfo.URI uri, <span class="keyword">final</span> String script, <span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> <span class="keyword">boolean</span> isCommandExecutor)</span> </span>&#123;</div><div class="line">   Protos.CommandInfo.Builder result = Protos.CommandInfo.newBuilder().addUris(uri).setShell(<span class="keyword">true</span>);</div><div class="line">   <span class="keyword">if</span> (isCommandExecutor) &#123;</div><div class="line">       CommandLine commandLine = CommandLine.parse(script);</div><div class="line">       commandLine.addArgument(GsonFactory.getGson().toJson(shardingContexts), <span class="keyword">false</span>);</div><div class="line">       result.setValue(Joiner.on(<span class="string">" "</span>).join(commandLine.getExecutable(), Joiner.on(<span class="string">" "</span>).join(commandLine.getArguments())));</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       result.setValue(script);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><ul><li><p>è°ƒç”¨ <code>#buildCommandExecutorTaskInfo(...)</code> æ–¹æ³•ï¼Œä¸º<strong>ç¬æ—¶</strong>çš„<strong>è„šæœ¬</strong>ä½œä¸šåˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.<span class="function">TaskInfo <span class="title">buildCommandExecutorTaskInfo</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> CloudJobConfiguration jobConfig, <span class="keyword">final</span> ShardingContexts shardingContexts,</span></span></div><div class="line"><span class="function"><span class="params">                                                    <span class="keyword">final</span> Protos.Offer offer, <span class="keyword">final</span> Protos.CommandInfo command)</span> </span>&#123;</div><div class="line">   Protos.TaskInfo.Builder result = Protos.TaskInfo.newBuilder().setTaskId(Protos.TaskID.newBuilder().setValue(taskContext.getId()).build())</div><div class="line">           .setName(taskContext.getTaskName()).setSlaveId(offer.getSlaveId())</div><div class="line">           .addResources(buildResource(<span class="string">"cpus"</span>, jobConfig.getCpuCount(), offer.getResourcesList()))</div><div class="line">           .addResources(buildResource(<span class="string">"mem"</span>, jobConfig.getMemoryMB(), offer.getResourcesList()))</div><div class="line">           .setData(ByteString.copyFrom(<span class="keyword">new</span> TaskInfoData(shardingContexts, jobConfig).serialize())); <span class="comment">//</span></div><div class="line">   <span class="keyword">return</span> result.setCommand(command).build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><ul><li><p>è°ƒç”¨ <code>#buildCustomizedExecutorTaskInfo(...)</code> æ–¹æ³•ï¼Œåˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.<span class="function">TaskInfo <span class="title">buildCustomizedExecutorTaskInfo</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> CloudAppConfiguration appConfig, <span class="keyword">final</span> CloudJobConfiguration jobConfig, </span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> Protos.Offer offer, <span class="keyword">final</span> Protos.CommandInfo command)</span> </span>&#123;</div><div class="line">   Protos.TaskInfo.Builder result = Protos.TaskInfo.newBuilder().setTaskId(Protos.TaskID.newBuilder().setValue(taskContext.getId()).build())</div><div class="line">           .setName(taskContext.getTaskName()).setSlaveId(offer.getSlaveId())</div><div class="line">           .addResources(buildResource(<span class="string">"cpus"</span>, jobConfig.getCpuCount(), offer.getResourcesList()))</div><div class="line">           .addResources(buildResource(<span class="string">"mem"</span>, jobConfig.getMemoryMB(), offer.getResourcesList()))</div><div class="line">           .setData(ByteString.copyFrom(<span class="keyword">new</span> TaskInfoData(shardingContexts, jobConfig).serialize()));</div><div class="line">   <span class="comment">// ExecutorInfo</span></div><div class="line">   Protos.ExecutorInfo.Builder executorBuilder = Protos.ExecutorInfo.newBuilder().setExecutorId(Protos.ExecutorID.newBuilder()</div><div class="line">           .setValue(taskContext.getExecutorId(jobConfig.getAppName()))) <span class="comment">// æ‰§è¡Œå™¨ ID</span></div><div class="line">           .setCommand(command)</div><div class="line">           .addResources(buildResource(<span class="string">"cpus"</span>, appConfig.getCpuCount(), offer.getResourcesList()))</div><div class="line">           .addResources(buildResource(<span class="string">"mem"</span>, appConfig.getMemoryMB(), offer.getResourcesList()));</div><div class="line">   <span class="keyword">if</span> (env.getJobEventRdbConfiguration().isPresent()) &#123;</div><div class="line">       executorBuilder.setData(ByteString.copyFrom(SerializationUtils.serialize(env.getJobEventRdbConfigurationMap()))).build();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.setExecutor(executorBuilder.build()).build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>Protos.ExecutorInfo.Builder#setValue(...)</code> æ–¹æ³•ï¼Œè®¾ç½®<strong>æ‰§è¡Œå™¨ç¼–å·</strong>ã€‚å¤§å¤šæ•°åœ¨ Mesos å®ç°çš„æ‰§è¡Œå™¨ï¼Œä¸€ä¸ªä»»åŠ¡å¯¹åº”ä¸€ä¸ªæ‰§è¡Œå™¨ã€‚è€Œ Elastic-Job-Cloud-Executor ä¸åŒäºå¤§å¤šæ•°åœ¨ Mesos ä¸Šçš„æ‰§è¡Œå™¨ï¼Œä¸€ä¸ªæ‰§è¡Œå™¨å¯ä»¥å¯¹åº”å¤šä¸ªä½œä¸šã€‚ä»€ä¹ˆæ„æ€ï¼Ÿåœ¨ä¸€ä¸ª Mesos Slaveï¼Œ<strong>ç›¸åŒ</strong>ä½œä¸šåº”ç”¨ï¼Œåªä¼šå¯åŠ¨ä¸€ä¸ª Elastic-Job-Cloud-Schedulerã€‚å½“è¯¥æ‰§è¡Œå™¨ä¸å­˜åœ¨æ—¶ï¼Œå¯åŠ¨ä¸€ä¸ªã€‚å½“è¯¥æ‰§è¡Œå™¨å·²ç»å­˜åœ¨ï¼Œå¤ç”¨è¯¥æ‰§è¡Œå™¨ã€‚é‚£ä¹ˆæ˜¯å¦‚ä½•å®ç°è¯¥åŠŸèƒ½çš„å‘¢ï¼Ÿ<strong>ç›¸åŒ</strong>ä½œä¸šåº”ç”¨ï¼Œåœ¨åŒä¸€ä¸ª Mesos Slaveï¼Œä½¿ç”¨ç›¸åŒæ‰§è¡Œå™¨ç¼–å·ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * è·å–ä»»åŠ¡æ‰§è¡Œå™¨ä¸»é”®.</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> appName åº”ç”¨åç§°</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> ä»»åŠ¡æ‰§è¡Œå™¨ä¸»é”®</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getExecutorId</span><span class="params">(<span class="keyword">final</span> String appName)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Joiner.on(DELIMITER).join(appName, slaveId);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul></li></ul><h2>4.5 å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—</h2><p>è°ƒç”¨ <code>FacadeService#addRunning(...)</code> æ–¹æ³•ï¼Œå°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRunning</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   runningService.add(taskContext);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RunningService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!configurationService.load(taskContext.getMetaInfo().getJobName()).isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°è¿è¡Œä¸­çš„ä»»åŠ¡é›†åˆ</span></div><div class="line">   getRunningTasks(taskContext.getMetaInfo().getJobName()).add(taskContext);</div><div class="line">   <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºå¸¸é©»ä»»åŠ¡</span></div><div class="line">   <span class="keyword">if</span> (!isDaemon(taskContext.getMetaInfo().getJobName())) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°è¿è¡Œä¸­é˜Ÿåˆ—</span></div><div class="line">   String runningTaskNodePath = RunningNode.getRunningTaskNodePath(taskContext.getMetaInfo().toString());</div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(runningTaskNodePath)) &#123;</div><div class="line">       regCenter.persist(runningTaskNodePath, taskContext.getId());</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RunningNode.java</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RunningNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = StateNode.ROOT + <span class="string">"/running"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RUNNING_JOB = ROOT + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;JOB_NAME&#125;</span></div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RUNNING_TASK = RUNNING_JOB + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;TASK_META_INFO&#125;ã€‚$&#123;TASK_META_INFO&#125;=$&#123;JOB_NAME&#125;@-@$&#123;ITEM_ID&#125;ã€‚</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>RunningServiceï¼Œä»»åŠ¡è¿è¡Œæ—¶æœåŠ¡ï¼Œæä¾›å¯¹è¿è¡Œä¸­çš„ä»»åŠ¡é›†åˆã€è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—çš„å„ç§æ“ä½œæ–¹æ³•ã€‚</p></li><li><p>è°ƒç”¨ <code>#getRunningTasks()</code> æ–¹æ³•ï¼Œè·å¾—<strong>è¿è¡Œä¸­çš„ä»»åŠ¡é›†åˆ</strong>ï¼Œå¹¶å°†å½“å‰ä»»åŠ¡æ·»åŠ åˆ°å…¶ä¸­ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;TaskContext&gt; <span class="title">getRunningTasks</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   Set&lt;TaskContext&gt; taskContexts = <span class="keyword">new</span> CopyOnWriteArraySet&lt;&gt;();</div><div class="line">   Collection&lt;TaskContext&gt; result = RUNNING_TASKS.putIfAbsent(jobName, taskContexts);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span> == result ? taskContexts : result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>åœ¨è¿ç»´å¹³å°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å½“å‰ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/09.png" alt=""></p></li><li><p>å¸¸é©»ä½œä¸šä¼šå­˜å‚¨åœ¨<strong>è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—</strong>ã€‚è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${NAMESPACE}/state/running/${JOB_NAME}/${TASK_META_INFO}</code>ï¼Œå­˜å‚¨å€¼ä¸ºä»»åŠ¡ç¼–å·ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p><p><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 14] ls /elastic-job-cloud/state/running/test_job_simple</div><div class="line">[test_job_simple@-@0, test_job_simple@-@1, test_job_simple@-@2]</div><div class="line">[zk: localhost:2181(CONNECTED) 15] get /elastic-job-cloud/state/running/test_job_simple/test_job_simple@-@0</div><div class="line">test_job_simple@-@0@-@READY@-@400197d9-76ca-464b-b2f0-e0fba5c2a598-S0@-@9780ed12-9612-45e3-ac14-feb2911896ff</div></pre></td></tr></table></figure></p></li></ul><h2>4.6 ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š</h2><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line">facadeService.removeLaunchTasksFromQueue(taskContextsList);</div><div class="line"></div><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContexts ä»»åŠ¡ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeLaunchTasksFromQueue</span><span class="params">(<span class="keyword">final</span> List&lt;TaskContext&gt; taskContexts)</span> </span>&#123;</div><div class="line">   List&lt;TaskContext&gt; failoverTaskContexts = <span class="keyword">new</span> ArrayList&lt;&gt;(taskContexts.size());</div><div class="line">   Collection&lt;String&gt; readyJobNames = <span class="keyword">new</span> HashSet&lt;&gt;(taskContexts.size(), <span class="number">1</span>);</div><div class="line">   <span class="keyword">for</span> (TaskContext each : taskContexts) &#123;</div><div class="line">       <span class="keyword">switch</span> (each.getType()) &#123;</div><div class="line">           <span class="keyword">case</span> FAILOVER:</div><div class="line">               failoverTaskContexts.add(each);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> READY:</div><div class="line">               readyJobNames.add(each.getMetaInfo().getJobName());</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">default</span>:</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ä»å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ä¸­åˆ é™¤ç›¸å…³ä»»åŠ¡</span></div><div class="line">   failoverService.remove(Lists.transform(failoverTaskContexts, <span class="keyword">new</span> Function&lt;TaskContext, TaskContext.MetaInfo&gt;() &#123;</div><div class="line">       </div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="keyword">public</span> TaskContext.<span class="function">MetaInfo <span class="title">apply</span><span class="params">(<span class="keyword">final</span> TaskContext input)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> input.getMetaInfo();</div><div class="line">       &#125;</div><div class="line">   &#125;));</div><div class="line">   <span class="comment">// ä»å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­åˆ é™¤ç›¸å…³ä½œä¸š</span></div><div class="line">   readyService.remove(readyJobNames);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>4.7 æäº¤ä»»åŠ¡ç»™ Mesos</h2><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line"><span class="keyword">for</span> (Entry&lt;List&lt;OfferID&gt;, List&lt;TaskInfo&gt;&gt; each : offerIdTaskInfoMap.entrySet()) &#123;</div><div class="line">   schedulerDriver.launchTasks(each.getKey(), each.getValue());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>SchedulerDriver#launchTasks(...)</code> æ–¹æ³•ï¼Œæäº¤ä»»åŠ¡ç»™ Mesos Masterã€‚ç”± Mesos Master è°ƒåº¦ä»»åŠ¡ç»™ Mesos Slaveã€‚Mesos Slave æäº¤æ‰§è¡Œå™¨æ‰§è¡Œä»»åŠ¡ã€‚</li></ul><h1>5. TaskExecutor æ‰§è¡Œä»»åŠ¡</h1><p>TaskExecutorï¼Œå®ç°äº† Mesos Executor æ¥å£ <code>org.apache.mesos.Executor</code>ã€‚æ‰§è¡Œå™¨çš„ä¸»è¦èŒè´£ä¹‹ä¸€ï¼š<strong>æ‰§è¡Œè°ƒåº¦å™¨æ‰€è¯·æ±‚çš„ä»»åŠ¡</strong>ã€‚TaskExecutor æ¥æ”¶åˆ° Mesos Slave æäº¤çš„ä»»åŠ¡ï¼Œè°ƒç”¨ <code>#launchTask(...)</code> æ–¹æ³•ï¼Œå¤„ç†ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DaemonTaskScheduler.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">launchTask</span><span class="params">(<span class="keyword">final</span> ExecutorDriver executorDriver, <span class="keyword">final</span> Protos.TaskInfo taskInfo)</span> </span>&#123;</div><div class="line">   executorService.submit(<span class="keyword">new</span> TaskThread(executorDriver, taskInfo));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>ExecutorService#submit(...)</code> æ–¹æ³•ï¼Œæäº¤ TaskThread åˆ°çº¿ç¨‹æ± ï¼Œæ‰§è¡Œä»»åŠ¡ã€‚</li></ul><h2>5.1 TaskThread</h2><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@RequiredArgsConstructor</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> ExecutorDriver executorDriver;</div><div class="line">   </div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> TaskInfo taskInfo;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œè¿è¡Œä¸­ã€‚</span></div><div class="line">       executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_RUNNING).build());</div><div class="line">       <span class="comment">//</span></div><div class="line">       Map&lt;String, Object&gt; data = SerializationUtils.deserialize(taskInfo.getData().toByteArray());</div><div class="line">       ShardingContexts shardingContexts = (ShardingContexts) data.get(<span class="string">"shardingContext"</span>);</div><div class="line">       <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">       JobConfigurationContext jobConfig = <span class="keyword">new</span> JobConfigurationContext((Map&lt;String, String&gt;) data.get(<span class="string">"jobConfigContext"</span>));</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// è·å¾— åˆ†å¸ƒå¼ä½œä¸š</span></div><div class="line">           ElasticJob elasticJob = getElasticJobInstance(jobConfig);</div><div class="line">           <span class="comment">// è°ƒåº¦å™¨æä¾›å†…éƒ¨æœåŠ¡çš„é—¨é¢å¯¹è±¡</span></div><div class="line">           <span class="keyword">final</span> CloudJobFacade jobFacade = <span class="keyword">new</span> CloudJobFacade(shardingContexts, jobConfig, jobEventBus);</div><div class="line">           <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">           <span class="keyword">if</span> (jobConfig.isTransient()) &#123;</div><div class="line">               <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">               JobExecutorFactory.getJobExecutor(elasticJob, jobFacade).execute();</div><div class="line">               <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œå·²å®Œæˆã€‚</span></div><div class="line">               executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_FINISHED).build());</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="comment">// åˆå§‹åŒ– å¸¸é©»ä½œä¸šè°ƒåº¦å™¨</span></div><div class="line">               <span class="keyword">new</span> DaemonTaskScheduler(elasticJob, jobConfig, jobFacade, executorDriver, taskInfo.getTaskId()).init();</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// CHECKSTYLE:OFF</span></div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable ex) &#123;</div><div class="line">           <span class="comment">// CHECKSTYLE:ON</span></div><div class="line">           log.error(<span class="string">"Elastic-Job-Cloud-Executor error"</span>, ex);</div><div class="line">           executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_ERROR).setMessage(ExceptionUtil.transform(ex)).build());</div><div class="line">           executorDriver.stop();</div><div class="line">           <span class="keyword">throw</span> ex;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>ä» <code>TaskInfo.data</code> å±æ€§ä¸­ï¼Œå¯ä»¥è·å¾—æäº¤ä»»åŠ¡é™„å¸¦çš„æ•°æ®ï¼Œä¾‹å¦‚åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ( ShardingContexts )ï¼Œå†…éƒ¨çš„ä½œä¸šé…ç½®ä¸Šä¸‹æ–‡( JobConfigurationContext )ã€‚</p></li><li><p>è°ƒç”¨ <code>#getElasticJobInstance()</code> æ–¹æ³•ï¼Œè·å¾—ä»»åŠ¡éœ€è¦æ‰§è¡Œçš„åˆ†å¸ƒå¼ä½œä¸š( Elastic-Job )ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ElasticJob <span class="title">getElasticJobInstance</span><span class="params">(<span class="keyword">final</span> JobConfigurationContext jobConfig)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!Strings.isNullOrEmpty(jobConfig.getBeanName()) &amp;&amp; !Strings.isNullOrEmpty(jobConfig.getApplicationContext())) &#123; <span class="comment">// spring ç¯å¢ƒ</span></div><div class="line">      <span class="keyword">return</span> getElasticJobBean(jobConfig);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">return</span> getElasticJobClass(jobConfig);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä» Spring å®¹å™¨ä¸­è·å¾—ä½œä¸šå¯¹è±¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> ä½œä¸šå¯¹è±¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> ElasticJob <span class="title">getElasticJobBean</span><span class="params">(<span class="keyword">final</span> JobConfigurationContext jobConfig)</span> </span>&#123;</div><div class="line">  String applicationContextFile = jobConfig.getApplicationContext();</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">null</span> == applicationContexts.get(applicationContextFile)) &#123;</div><div class="line">      <span class="keyword">synchronized</span> (applicationContexts) &#123;</div><div class="line">          <span class="keyword">if</span> (<span class="keyword">null</span> == applicationContexts.get(applicationContextFile)) &#123;</div><div class="line">              applicationContexts.put(applicationContextFile, <span class="keyword">new</span> ClassPathXmlApplicationContext(applicationContextFile));</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> (ElasticJob) applicationContexts.get(applicationContextFile).getBean(jobConfig.getBeanName());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºä½œä¸šå¯¹è±¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> ä½œä¸šå¯¹è±¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> ElasticJob <span class="title">getElasticJobClass</span><span class="params">(<span class="keyword">final</span> JobConfigurationContext jobConfig)</span> </span>&#123;</div><div class="line">  String jobClass = jobConfig.getTypeConfig().getJobClass();</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      Class&lt;?&gt; elasticJobClass = Class.forName(jobClass);</div><div class="line">      <span class="keyword">if</span> (!ElasticJob.class.isAssignableFrom(elasticJobClass)) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(<span class="string">"Elastic-Job: Class '%s' must implements ElasticJob interface."</span>, jobClass);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (elasticJobClass != ScriptJob.class) &#123;</div><div class="line">          <span class="keyword">return</span> (ElasticJob) elasticJobClass.newInstance();</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">  &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ReflectiveOperationException ex) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(<span class="string">"Elastic-Job: Class '%s' initialize failure, the error message is '%s'."</span>, jobClass, ex.getMessage());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å½“ä½œä¸šæ˜¯<strong>ç¬æ—¶</strong>ä½œä¸šæ—¶ï¼Œè°ƒç”¨ <code>AbstractElasticJobExecutor#execute(...)</code> æ‰§è¡Œä½œä¸šé€»è¾‘ï¼Œå¹¶è°ƒç”¨ <code>ExecutorDriver#sendStatusUpdate(...)</code> å‘é€çŠ¶æ€ï¼Œæ›´æ–° Mesos ä»»åŠ¡å·²å®Œæˆ( Protos.TaskState.TASK_FINISHED )ã€‚<code>AbstractElasticJobExecutor#execute(...)</code> å®ç°ä»£ç ï¼Œåœ¨ Elastic-Job-Lite å’Œ Elastic-Job-Cloud åŸºæœ¬ä¸€è‡´ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li><li>å½“ä½œä¸šæ˜¯<strong>å¸¸é©»</strong>ä½œä¸šæ—¶ï¼Œè°ƒç”¨ <code>DaemonTaskScheduler#init()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–ä½œä¸šè°ƒåº¦ï¼Œåœ¨ã€Œ5.2 DaemonTaskSchedulerã€è¯¦ç»†è§£æã€‚</li></ul></li></ul><h2>5.2 DaemonTaskScheduler</h2><p><strong>ç¬æ—¶</strong>ä½œä¸šï¼Œé€šè¿‡ Elastic-Job-Cloud-Scheduler è°ƒåº¦ä»»åŠ¡ï¼Œæäº¤ Elastic-Job-Cloud-Executor æ‰§è¡Œåï¼Œç­‰å¾… Elastic-Job-Scheduler è¿›è¡Œä¸‹æ¬¡è°ƒåº¦ã€‚</p><p><strong>å¸¸é©»</strong>ä½œä¸šï¼Œé€šè¿‡ Elastic-Job-Scheduler æäº¤ Elastic-Job-Cloud-Executor è¿›è¡Œè°ƒåº¦ã€‚Elastic-Job-Cloud-Executor ä½¿ç”¨ DaemonTaskScheduler ä¸æ–­å¯¹å¸¸é©»ä½œä¸šè¿›è¡Œè°ƒåº¦è€Œæ— éœ€ Elastic-Job-Cloud-Scheduler å‚ä¸å…¶ä¸­ã€‚</p><p>è¿™å°±æ˜¯<strong>ç¬æ—¶</strong>ä½œä¸šå’Œ<strong>å¸¸é©»</strong>ä½œä¸šä¸åŒä¹‹å¤„ã€‚</p><p>DaemonTaskSchedulerï¼Œå¸¸é©»ä½œä¸šè°ƒåº¦å™¨ã€‚è°ƒç”¨ <code>DaemonTaskScheduler#init()</code> æ–¹æ³•ï¼Œå¯¹<strong>ä¸€ä¸ª</strong>ä½œä¸šåˆå§‹åŒ–è°ƒåº¦ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆå§‹åŒ–ä½œä¸š.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// Quartz JobDetail</span></div><div class="line">   JobDetail jobDetail = JobBuilder.newJob(DaemonJob.class)</div><div class="line">           .withIdentity(jobRootConfig.getTypeConfig().getCoreConfig().getJobName()).build();</div><div class="line">   jobDetail.getJobDataMap().put(ELASTIC_JOB_DATA_MAP_KEY, elasticJob);</div><div class="line">   jobDetail.getJobDataMap().put(JOB_FACADE_DATA_MAP_KEY, jobFacade);</div><div class="line">   jobDetail.getJobDataMap().put(EXECUTOR_DRIVER_DATA_MAP_KEY, executorDriver);</div><div class="line">   jobDetail.getJobDataMap().put(TASK_ID_DATA_MAP_KEY, taskId);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       scheduleJob(initializeScheduler(), jobDetail, taskId.getValue(), jobRootConfig.getTypeConfig().getCoreConfig().getCron());</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> Scheduler <span class="title">initializeScheduler</span><span class="params">()</span> <span class="keyword">throws</span> SchedulerException </span>&#123;</div><div class="line">   StdSchedulerFactory factory = <span class="keyword">new</span> StdSchedulerFactory();</div><div class="line">   factory.initialize(getBaseQuartzProperties());</div><div class="line">   <span class="keyword">return</span> factory.getScheduler();</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> Properties <span class="title">getBaseQuartzProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">   Properties result = <span class="keyword">new</span> Properties();</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.class"</span>, org.quartz.simpl.SimpleThreadPool.class.getName());</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.threadCount"</span>, <span class="string">"1"</span>); <span class="comment">// çº¿ç¨‹æ•°ï¼š1</span></div><div class="line">   result.put(<span class="string">"org.quartz.scheduler.instanceName"</span>, taskId.getValue());</div><div class="line">   <span class="keyword">if</span> (!jobRootConfig.getTypeConfig().getCoreConfig().isMisfire()) &#123;</div><div class="line">       result.put(<span class="string">"org.quartz.jobStore.misfireThreshold"</span>, <span class="string">"1"</span>);</div><div class="line">   &#125;</div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.class"</span>, ShutdownHookPlugin.class.getName());</div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.cleanShutdown"</span>, Boolean.TRUE.toString());</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleJob</span><span class="params">(<span class="keyword">final</span> Scheduler scheduler, <span class="keyword">final</span> JobDetail jobDetail, <span class="keyword">final</span> String triggerIdentity, <span class="keyword">final</span> String cron)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">if</span> (!scheduler.checkExists(jobDetail.getKey())) &#123;</div><div class="line">           scheduler.scheduleJob(jobDetail, createTrigger(triggerIdentity, cron));</div><div class="line">       &#125;</div><div class="line">       scheduler.start();</div><div class="line">       RUNNING_SCHEDULERS.putIfAbsent(scheduler.getSchedulerName(), scheduler);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> CronTrigger <span class="title">createTrigger</span><span class="params">(<span class="keyword">final</span> String triggerIdentity, <span class="keyword">final</span> String cron)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> TriggerBuilder.newTrigger()</div><div class="line">           .withIdentity(triggerIdentity)</div><div class="line">           .withSchedule(CronScheduleBuilder.cronSchedule(cron)</div><div class="line">           .withMisfireHandlingInstructionDoNothing())</div><div class="line">           .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>DaemonTaskScheduler åŸºäº Quartz å®ç°ä½œä¸šè°ƒåº¦ã€‚è¿™é‡Œå¤§å®¶çœ‹ä¸‹æºç ï¼Œå°±ä¸å•°å—¦è§£é‡Šå•¦ã€‚</li><li>JobBuilder#newJob(...) çš„å‚æ•°æ˜¯ DaemonJobï¼Œä¸‹æ–‡ä¼šè®²è§£åˆ°ã€‚</li></ul><p><strong>DaemonJob å®ç°ä»£ç </strong>å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DaemonJob</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> ElasticJob elasticJob;</div><div class="line">   </div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> JobFacade jobFacade;</div><div class="line">   </div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> ExecutorDriver executorDriver;</div><div class="line">    </div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> Protos.TaskID taskId;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</div><div class="line">       ShardingContexts shardingContexts = jobFacade.getShardingContexts();</div><div class="line">       <span class="keyword">int</span> jobEventSamplingCount = shardingContexts.getJobEventSamplingCount();</div><div class="line">       <span class="keyword">int</span> currentJobEventSamplingCount = shardingContexts.getCurrentJobEventSamplingCount();</div><div class="line">       <span class="keyword">if</span> (jobEventSamplingCount &gt; <span class="number">0</span> &amp;&amp; ++currentJobEventSamplingCount &lt; jobEventSamplingCount) &#123;</div><div class="line">           shardingContexts.setCurrentJobEventSamplingCount(currentJobEventSamplingCount);</div><div class="line">           <span class="comment">//</span></div><div class="line">           jobFacade.getShardingContexts().setAllowSendJobEvent(<span class="keyword">false</span>);</div><div class="line">           <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">           JobExecutorFactory.getJobExecutor(elasticJob, jobFacade).execute();</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">//</span></div><div class="line">           jobFacade.getShardingContexts().setAllowSendJobEvent(<span class="keyword">true</span>);</div><div class="line">           <span class="comment">//</span></div><div class="line">           executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskId).setState(Protos.TaskState.TASK_RUNNING).setMessage(<span class="string">"BEGIN"</span>).build());</div><div class="line">           <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">           JobExecutorFactory.getJobExecutor(elasticJob, jobFacade).execute();</div><div class="line">           <span class="comment">//</span></div><div class="line">           executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskId).setState(Protos.TaskState.TASK_RUNNING).setMessage(<span class="string">"COMPLETE"</span>).build());</div><div class="line">           <span class="comment">// </span></div><div class="line">           shardingContexts.setCurrentJobEventSamplingCount(<span class="number">0</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>AbstractElasticJobExecutor#execute(...)</code> æ‰§è¡Œä½œä¸šé€»è¾‘ã€‚<code>AbstractElasticJobExecutor#execute(...)</code> å®ç°ä»£ç ï¼Œåœ¨ Elastic-Job-Lite å’Œ Elastic-Job-Cloud åŸºæœ¬ä¸€è‡´ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p><code>jobEventSamplingCount</code> æ¥è‡ªåº”ç”¨é…ç½® (<code>CloudAppConfiguration.eventTraceSamplingCount</code>) å±æ€§ï¼Œå¸¸é©»ä½œä¸šäº‹ä»¶é‡‡æ ·ç‡ç»Ÿè®¡æ¡æ•°ï¼Œé»˜è®¤é‡‡æ ·å…¨éƒ¨è®°å½•ã€‚ä¸ºé¿å…æ•°æ®é‡è¿‡å¤§ï¼Œå¯å¯¹é¢‘ç¹è°ƒåº¦çš„å¸¸é©»ä½œä¸šé…ç½®é‡‡æ ·ç‡ï¼Œå³ä½œä¸šæ¯æ‰§è¡ŒNæ¬¡ï¼Œæ‰ä¼šè®°å½•ä½œä¸šæ‰§è¡ŒåŠè¿½è¸ªç›¸å…³æ•°æ®ã€‚</p><p>å½“æ»¡è¶³é‡‡æ ·æ¡ä»¶æ—¶ï¼Œè°ƒç”¨ <code>ShardingContexts#setAllowSendJobEvent(true)</code>ï¼Œæ ‡è®°<strong>è¦</strong>è®°å½•ä½œä¸šäº‹ä»¶ã€‚å¦åˆ™ï¼Œè°ƒç”¨ <code>ShardingContexts#setAllowSendJobEvent(false)</code>ï¼Œæ ‡è®°<strong>ä¸</strong>è®°å½•ä½œä¸šæ—¶é—´ã€‚ä½œä¸šäº‹ä»¶è¿½è¸ªåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-event-trace/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šäº‹ä»¶è¿½è¸ªã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</p><p>å¦å¤–ï¼Œå½“æ»¡è¶³é‡‡æ ·è°ƒè¯•æ—¶ï¼Œä¹Ÿä¼šè°ƒç”¨ <code>ExecutorDriver#sendStatusUpdate(...)</code> æ–¹æ³•ï¼Œæ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸ºè¿è¡Œä¸­ï¼Œå¹¶é™„å¸¦ <code>&quot;BEGIN&quot;</code> æˆ– <code>&quot;COMPLETE&quot;</code> æ¶ˆæ¯ã€‚</p></li></ul><h1>6. SchedulerEngine å¤„ç†ä»»åŠ¡çš„çŠ¶æ€å˜æ›´</h1><p>Mesos è°ƒåº¦å™¨çš„èŒè´£ä¹‹ä¸€ï¼Œ<strong>å¤„ç†ä»»åŠ¡çš„çŠ¶æ€ï¼Œç‰¹åˆ«æ˜¯å“åº”ä»»åŠ¡å’Œæ•…éšœ</strong>ã€‚å› æ­¤åœ¨ Elastic-Job-Cloud-Executor è°ƒç”¨ <code>ExecutorDriver#sendStatusUpdate(...)</code> æ–¹æ³•ï¼Œæ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€æ—¶ï¼Œè§¦å‘è°ƒç”¨ Elastic-Job-Cloud-Scheduler çš„ SchedulerEngine çš„ <code>#statusUpdate(...)</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">statusUpdate</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver, <span class="keyword">final</span> Protos.TaskStatus taskStatus)</span> </span>&#123;</div><div class="line">   String taskId = taskStatus.getTaskId().getValue();</div><div class="line">   TaskContext taskContext = TaskContext.from(taskId);</div><div class="line">   String jobName = taskContext.getMetaInfo().getJobName();</div><div class="line">   log.trace(<span class="string">"call statusUpdate task state is: &#123;&#125;, task id is: &#123;&#125;"</span>, taskStatus.getState(), taskId);</div><div class="line">   jobEventBus.post(<span class="keyword">new</span> JobStatusTraceEvent(jobName, taskContext.getId(), taskContext.getSlaveId(), Source.CLOUD_SCHEDULER, </div><div class="line">           taskContext.getType(), String.valueOf(taskContext.getMetaInfo().getShardingItems()), State.valueOf(taskStatus.getState().name()), taskStatus.getMessage()));</div><div class="line">   <span class="keyword">switch</span> (taskStatus.getState()) &#123;</div><div class="line">       <span class="keyword">case</span> TASK_RUNNING:</div><div class="line">           <span class="keyword">if</span> (!facadeService.load(jobName).isPresent()) &#123;</div><div class="line">               schedulerDriver.killTask(Protos.TaskID.newBuilder().setValue(taskId).build());</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (<span class="string">"BEGIN"</span>.equals(taskStatus.getMessage())) &#123;</div><div class="line">               facadeService.updateDaemonStatus(taskContext, <span class="keyword">false</span>);</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"COMPLETE"</span>.equals(taskStatus.getMessage())) &#123;</div><div class="line">               facadeService.updateDaemonStatus(taskContext, <span class="keyword">true</span>);</div><div class="line">               statisticManager.taskRunSuccessfully();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> TASK_FINISHED:</div><div class="line">           facadeService.removeRunning(taskContext);</div><div class="line">           unAssignTask(taskId);</div><div class="line">           statisticManager.taskRunSuccessfully();</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> TASK_KILLED:</div><div class="line">           log.warn(<span class="string">"task id is: &#123;&#125;, status is: &#123;&#125;, message is: &#123;&#125;, source is: &#123;&#125;"</span>, taskId, taskStatus.getState(), taskStatus.getMessage(), taskStatus.getSource());</div><div class="line">           facadeService.removeRunning(taskContext);</div><div class="line">           facadeService.addDaemonJobToReadyQueue(jobName);</div><div class="line">           unAssignTask(taskId);</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> TASK_LOST:</div><div class="line">       <span class="keyword">case</span> TASK_DROPPED:</div><div class="line">       <span class="keyword">case</span> TASK_GONE:</div><div class="line">       <span class="keyword">case</span> TASK_GONE_BY_OPERATOR:</div><div class="line">       <span class="keyword">case</span> TASK_FAILED:</div><div class="line">       <span class="keyword">case</span> TASK_ERROR:</div><div class="line">           log.warn(<span class="string">"task id is: &#123;&#125;, status is: &#123;&#125;, message is: &#123;&#125;, source is: &#123;&#125;"</span>, taskId, taskStatus.getState(), taskStatus.getMessage(), taskStatus.getSource());</div><div class="line">           facadeService.removeRunning(taskContext);</div><div class="line">           facadeService.recordFailoverTask(taskContext);</div><div class="line">           unAssignTask(taskId);</div><div class="line">           statisticManager.taskRunFailed();</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> TASK_UNKNOWN:</div><div class="line">       <span class="keyword">case</span> TASK_UNREACHABLE:</div><div class="line">           log.error(<span class="string">"task id is: &#123;&#125;, status is: &#123;&#125;, message is: &#123;&#125;, source is: &#123;&#125;"</span>, taskId, taskStatus.getState(), taskStatus.getMessage(), taskStatus.getSource());</div><div class="line">           statisticManager.taskRunFailed();</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">default</span>:</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>å½“æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸º <code>TASK_RUNNING</code> æ—¶ï¼Œæ ¹æ®é™„å¸¦æ¶ˆæ¯ä¸º <code>&quot;BEGIN&quot;</code> æˆ– <code>&quot;COMPLETE&quot;</code>ï¼Œåˆ†åˆ«è°ƒç”¨ <code>FacadeService#updateDaemonStatus(false / true)</code> æ–¹æ³•ï¼Œæ›´æ–°ä½œä¸šé—²ç½®çŠ¶æ€ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ›´æ–°å¸¸é©»ä½œä¸šè¿è¡ŒçŠ¶æ€.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> isIdle æ˜¯å¦ç©ºé—²</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateDaemonStatus</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> <span class="keyword">boolean</span> isIdle)</span> </span>&#123;</div><div class="line">   runningService.updateIdle(taskContext, isIdle);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">// RunningService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ›´æ–°ä½œä¸šé—²ç½®çŠ¶æ€.</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> isIdle æ˜¯å¦é—²ç½®</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateIdle</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> <span class="keyword">boolean</span> isIdle)</span> </span>&#123;</div><div class="line">   <span class="keyword">synchronized</span> (RUNNING_TASKS) &#123;</div><div class="line">       Optional&lt;TaskContext&gt; taskContextOptional = findTask(taskContext);</div><div class="line">       <span class="keyword">if</span> (taskContextOptional.isPresent()) &#123;</div><div class="line">           taskContextOptional.get().setIdle(isIdle);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           add(taskContext);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>è‹¥ä½œä¸šé…ç½®ä¸å­˜åœ¨æ—¶ï¼Œè°ƒç”¨ <code>SchedulerDriver#killTask(...)</code> æ–¹æ³•ï¼Œæ€æ­»è¯¥ Mesos ä»»åŠ¡ã€‚åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-second/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆäºŒï¼‰ã€‹</a>è¿›ä¸€æ­¥è§£æã€‚</p></li><li><p>å½“æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸º <code>TASK_FINISHED</code> æ—¶ï¼Œè°ƒç”¨ <code>FacadeService#removeRunning(...)</code> æ–¹æ³•ï¼Œå°†ä»»åŠ¡ä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å°†ä»»åŠ¡ä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeRunning</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   runningService.remove(taskContext);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RunningService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å°†ä»»åŠ¡ä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   <span class="comment">// ç§»é™¤è¿è¡Œä¸­çš„ä»»åŠ¡é›†åˆ</span></div><div class="line">   getRunningTasks(taskContext.getMetaInfo().getJobName()).remove(taskContext);</div><div class="line">   <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºå¸¸é©»ä»»åŠ¡</span></div><div class="line">   <span class="keyword">if</span> (!isDaemonOrAbsent(taskContext.getMetaInfo().getJobName())) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å°†ä»»åŠ¡ä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤</span></div><div class="line">   regCenter.remove(RunningNode.getRunningTaskNodePath(taskContext.getMetaInfo().toString()));</div><div class="line">   String jobRootNode = RunningNode.getRunningJobNodePath(taskContext.getMetaInfo().getJobName());</div><div class="line">   <span class="keyword">if</span> (regCenter.isExisted(jobRootNode) &amp;&amp; regCenter.getChildrenKeys(jobRootNode).isEmpty()) &#123;</div><div class="line">       regCenter.remove(jobRootNode);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å½“è¯¥ä½œä¸šå¯¹åº”çš„æ‰€æœ‰ Mesos ä»»åŠ¡çŠ¶æ€éƒ½æ›´æ–°ä¸º <code>TASK_FINISHED</code> åï¼Œä½œä¸šå¯ä»¥å†æ¬¡è¢« Elastic-Job-Cloud-Scheduler è°ƒåº¦ã€‚</li></ul><p>è°ƒç”¨ <code>#unAssignTask(...)</code> æ–¹æ³•ï¼Œé€šçŸ¥ TaskScheduler ä»»åŠ¡è¢«<strong>ç¡®è®¤</strong>æœªåˆ†é…åˆ°è¿™ä¸ªä¸»æœºã€‚TaskScheduler åšä»»åŠ¡å’Œ Offer çš„åŒ¹é…ï¼Œå¯¹å“ªäº›ä»»åŠ¡è¿è¡Œåœ¨å“ªäº›ä¸»æœºæ˜¯æœ‰ä¾èµ–çš„ï¼Œä¸ç„¶æ€ä¹ˆåšåŒ¹é…ä¼˜åŒ–å‘¢ã€‚åœ¨<a href="https://github.com/Netflix/Fenzo/wiki/How-to-use-Fenzo#notify-the-scheduler-of-assigns-and-unassigns-of-tasks" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Notify the Scheduler of Assigns and UnAssigns of Tasksã€‹</a>å¯ä»¥è¿›ä¸€æ­¥äº†è§£ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unAssignTask</span><span class="params">(<span class="keyword">final</span> String taskId)</span> </span>&#123;</div><div class="line">    String hostname = facadeService.popMapping(taskId);</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != hostname) &#123;</div><div class="line">        taskScheduler.getTaskUnAssigner().call(TaskContext.getIdForUnassignedSlave(taskId), hostname);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>å½“æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸º <code>TASK_KILLED</code> æ—¶ï¼Œè°ƒç”¨ <code>FacadeService#addDaemonJobToReadyQueue(...)</code> æ–¹æ³•ï¼Œå°†å¸¸é©»ä½œä¸šæ”¾å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—ã€‚**ä¸ºä»€ä¹ˆè¦å°†å¸¸é©»ä½œä¸šæ”¾å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—å‘¢ï¼Ÿ**è¢« Kill æ‰çš„ä½œä¸šåç»­è¦ç»§ç»­è°ƒåº¦æ‰§è¡Œï¼Œå¦‚æœä¸åŠ å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—ï¼ŒTaskLaunchScheduledService å°±æ— æ³•æäº¤ä½œä¸šç»™ Elastic-Job-Cloud-Executor ç»§ç»­è°ƒåº¦æ‰§è¡Œã€‚</p><p>å¦å¤–ä¼šè°ƒç”¨ <code>FacadeService#removeRunning(...)</code>ã€<code>#unAssignTask(...)</code> æ–¹æ³•ã€‚</p></li><li><p>å½“æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸º <code>TASK_ERROR</code> ç­‰ç­‰æ—¶ï¼Œè°ƒç”¨ <code>FacadeService#recordFailoverTask(...)</code> æ–¹æ³•ï¼Œåœ¨ <a href="http://www.iocoder.cn/Elastic-Job/cloud-job-failover/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>è¯¦ç»†è§£æã€‚</p><p>å¦å¤–ä¼šè°ƒç”¨ <code>FacadeService#removeRunning(...)</code> å’Œ <code>#unAssignTask(...)</code> æ–¹æ³•ã€‚</p></li></ul><h1>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šçœŸçš„çœŸçš„çœŸçš„ï¼Œå¥½é•¿å¥½é•¿å¥½é•¿å•Šã€‚ä½†æ˜¯çœŸçš„çœŸçš„çœŸçš„ï¼Œå¹²è´§ï¼<br>èŠ‹é“å›ï¼šé‚£å¿…é¡»çš„ï¼</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/12.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ä½œä¸šæ‰§è¡Œç±»å‹&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;
      
    
    </summary>
    
      <category term="Elastic-Job-Cloud" scheme="http://www.iocoder.cn/categories/Elastic-Job-Cloud/"/>
    
    
  </entry>
  
  <entry>
    <title>é—²èŠå¦‚ä½•é˜…è¯»æºç </title>
    <link href="http://www.iocoder.cn/Architecture/how-to-read-article/"/>
    <id>http://www.iocoder.cn/Architecture/how-to-read-article/</id>
    <published>2017-12-14T16:00:00.000Z</published>
    <updated>2017-09-15T08:54:30.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li><a href="#">1. é˜…è¯»ä¸æ•´ç†</a></li><li><a href="#">2. å…¬ä¼—å·æ¨è</a></li><li><a href="#">3. åº”ç”¨æ¨è</a></li><li><a href="#">4. ä¹¦ç±æ¨è</a></li><li><a href="#">5. Warning</a></li></ul><hr><h1>1. æ•´ç†ä¸é˜…è¯»</h1><p>æˆ‘æƒ³ï¼Œåº”è¯¥æœ‰å¾ˆå¤šèƒ–å‹ç¢°åˆ°å›°æƒ‘ï¼š</p><ul><li>å¾®ä¿¡å…¬ä¼—å·å‡ åä¸ª <strong>99+</strong> æœªé˜…è¯»ã€‚</li><li>æ˜é‡‘ / å¼€æºä¸­å›½ / å¼€å‘è€…å¤´æ¡ / æå®¢å¤´æ¡ ç­‰ç­‰æŠ€æœ¯ç¤¾åŒºæ¥ä¸åŠé˜…è¯»ã€‚</li><li>å¶å°”çœ‹åˆ°æœ‹å‹åœˆ / å¾®ä¿¡ç¾¤ä¸é”™çš„æ–‡ç« ï¼Œåªç‚¹äº†èµï¼Œå´å¿˜è®°é˜…è¯»ã€‚</li></ul><p>è¿™é‡Œæˆ‘åˆ†äº«ä¸‹æˆ‘çš„æ¢³ç†æ–¹å¼ï¼Œå¯èƒ½ä¸æ˜¯æœ€ä¼˜ï¼Œä½†æ˜¯æˆ‘ç›¸ä¿¡ï¼Œåªè¦ä½ æ„¿æ„å°è¯•ï¼Œå¯¹ä½ çš„æ”¶è´§ä¸€å®šéå¸¸å¤§ã€‚</p><p><strong>å…¨éƒ¨æ–‡ç« åŸºäºå°è±¡ç¬”è®°æ•´ç†</strong><br><strong>å…¨éƒ¨æ–‡ç« åŸºäºå°è±¡ç¬”è®°æ•´ç†</strong><br><strong>å…¨éƒ¨æ–‡ç« åŸºäºå°è±¡ç¬”è®°æ•´ç†</strong></p><ul><li>å¾®ä¿¡å…¬ä¼—å· <strong>å¥½æ–‡ç« </strong>è½¬åˆ°ã€å°è±¡ç¬”è®°-å¾…è¯»åˆ—è¡¨ã€‘ï¼Œåˆ é™¤è¯¥æ–‡ç« æ¶ˆæ¯ã€‚</li><li>æ˜é‡‘ / å¼€å‘è€…å¤´æ¡ / å¼€æºä¸­å›½ / æå®¢å¤´æ¡ <strong>å¥½æ–‡ç« </strong>è½¬åˆ°ã€å°è±¡ç¬”è®°-å¾…è¯»åˆ—è¡¨ã€‘ã€‚</li><li>æœ‹å‹åœˆ / å¾®ä¿¡ç¾¤ <strong>å¥½æ–‡ç« </strong>è½¬åˆ°ã€å°è±¡ç¬”è®°-å¾…è¯»åˆ—è¡¨ã€‘ã€‚</li></ul><p>æ¯å¤©ä¸Šä¸‹ç­åœ°é“è¯»ã€å°è±¡ç¬”è®°-å¾…è¯»åˆ—è¡¨ã€‘ã€‚</p><ul><li>å¦‚æœåˆé€‚çš„æ–‡ç« ï¼Œç•™ä¸‹ï¼Œæ ‡ç­¾å½’ç±»ã€‚</li><li>ä¸åˆé€‚ï¼Œåˆ é™¤ã€‚</li><li>è¿‡äºå›°éš¾çš„æ–‡ç« ï¼Œæ”¾å…¥å¦å¤–ä¸€ä¸ªåˆ—è¡¨ï¼Œæ”¶æ‹¾å¥½å¿ƒæƒ…æ¥çœ‹ï¼Œä¸€èˆ¬å‘¨æœ«ã€‚</li></ul><p>å¦‚ä¸‹æ˜¯æˆ‘ 2017 å¹´åœ¨<strong>åœ°é“</strong>ä¸Šé˜…è¯»äº†å‡ åƒç¯‡æ–‡ç« æ¢³ç†ä¸‹çš„ 800 ç¯‡å·¦å³æ–‡ç« ï¼š</p><p><img src="https://user-gold-cdn.xitu.io/2017/7/13/9187cd431f3917d2afc5975e00fb4ee6?imageView2/2/w/1280/h/960/q/85/interlace/1" alt=""></p><p>å¤©ä¸‹æ–‡ç« ä¸€å¤§**â€œæŠ„â€**ï¼Œçœ‹çš„å¤šäº†ï¼Œè‡ªç„¶å°±å¿«ã€‚</p><p><strong>å¦‚æœä½ æƒ³è¦æˆ‘æ•´ç†çš„æ–‡ç« ï¼Œè¯·å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€èŠ‹é“æºç ã€‘ï¼Œç•™è¨€å‘é€ä½ çš„å°è±¡ç¬”è®°é‚®ç®±ã€‚</strong><br><strong>å¦‚æœä½ æƒ³è¦æˆ‘æ•´ç†çš„æ–‡ç« ï¼Œè¯·å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€èŠ‹é“æºç ã€‘ï¼Œç•™è¨€å‘é€ä½ çš„å°è±¡ç¬”è®°é‚®ç®±ã€‚</strong><br><strong>å¦‚æœä½ æƒ³è¦æˆ‘æ•´ç†çš„æ–‡ç« ï¼Œè¯·å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€èŠ‹é“æºç ã€‘ï¼Œç•™è¨€å‘é€ä½ çš„å°è±¡ç¬”è®°é‚®ç®±ã€‚</strong></p><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><h1>2. å…¬ä¼—å·æ¨è</h1><p>æŒ‰ç…§å­—æ¯æ’åºã€‚</p><p>å¯èƒ½æ¯”è¾ƒå¤šï¼Œå¯ä»¥é€‰æ‹©è‡ªå·±å–œæ¬¢çš„å…ˆå…³æ³¨ä¸€æ³¢ã€‚</p><p>å¦å¤–ï¼Œå…¬ä¼—å·ä¹‹é—´æ–‡ç« æ˜¯ä¼šæœ‰é‡å¤çš„ã€‚</p><h2>2.1 æŠ€æœ¯ç±»</h2><ul><li>AIå‰çº¿</li><li>é˜¿é‡ŒæŠ€æœ¯</li><li>ArchSummit</li><li>å¹¶å‘ç¼–ç¨‹ç½‘</li><li>BySocketæ³¥ç“¦åŒ </li><li>ç¨‹åºè§†ç•Œ</li><li>ç¨‹åºå‘˜DD</li><li>ç¨‹åºå‘˜æ—¥å¿—</li><li>æ˜¥å¤©çš„å½­è¾¹</li><li>CRUD</li><li>å¤§ç çŒ´</li><li>DBAplusç¤¾ç¾¤</li><li>Docker</li><li>dumpcacheæå®¢æŠ€æœ¯</li><li>EGONetworks</li><li>é¥¿ç§‘æŠ€</li><li>å‡¤å‡°ç‰Œè€ç†Š</li><li>æœåŠ¡ç«¯æ€ç»´</li><li>é«˜å¯ç”¨æ¶æ„</li><li>é«˜æ•ˆå¼€å‘è¿ç»´</li><li>GDG</li><li>GitChat</li><li>Goä¸­å›½</li><li>æ²ªæ±Ÿç§‘æŠ€å­¦é™¢</li><li>InfoQ</li><li>IPDCHAT</li><li>æ¶æ„å¸ˆ</li><li>æ¶æ„å¸ˆä¹‹è·¯</li><li>æ¶æ„æ–‡æ‘˜</li><li>æ¶æ„ä¹‹å®¶</li><li>K8SæŠ€æœ¯ç¤¾åŒº</li><li>å¼€æ¶›çš„åšå®¢</li><li>è€å¶èŒ¶é¦†</li><li>èŠèŠæ¶æ„</li><li>ç¾å›¢ç‚¹è¯„æŠ€æœ¯å›¢é˜Ÿ</li><li>MongoDBä¸­æ–‡ç¤¾åŒº</li><li>Nettyä¹‹å®¶</li><li>ä½ å‡ç¬¨</li><li>PingCAP</li><li>QCon</li><li>å®¹å™¨æ—¶ä»£</li><li>æ•°äººäº‘</li><li>SpringCloudç¤¾åŒº</li><li>StuQ</li><li>å”¯æŠ€æœ¯</li><li>å”¯å“ä¼šå®‰å…¨åº”æ€¥å“åº”ä¸­å¿ƒ</li><li>å”¯å“ä¼šè´¨é‡å·¥ç¨‹</li><li>æºç¨‹æŠ€æœ¯ä¸­å¿ƒ</li><li>äº‘æ –ç¤¾åŒº</li><li>ä¸­ç”Ÿä»£æŠ€æœ¯</li></ul><h2>2.2 éæŠ€æœ¯ç±»</h2><ul><li>ç¬”è®°ä¾ </li><li>èœå•å°‘çˆ·</li><li>caozçš„æ¢¦å‘“</li><li>å·®è¯„</li><li>é¸Ÿå“¥ç¬”è®°</li><li>é¬¼è„šä¸ƒ</li><li>åæ—¶ä»£</li><li>äº’è”ç½‘æ€ç»´</li><li>æ··æ²Œå¤§å­¦</li><li>ç»çº¬åˆ›æŠ•</li><li>å¼€æŸ’</li><li>ç§‘æŠ€ç¾å­¦</li><li>é€»è¾‘æ€ç»´</li><li>MacTalk</li><li>å…¨æ ˆPMç¬”è®°</li><li>äººäººéƒ½æ˜¯äº§å“ç»ç†</li><li>warfalcon</li><li>å°é“æ¶ˆæ¯</li><li>36æ°ª</li><li>3Wäº’è”ç½‘æ·±åº¦ç²¾é€‰</li></ul><h1>3. åº”ç”¨æ¨è</h1><ul><li>æ˜é‡‘</li><li>å¼€æºä¸­å›½</li><li>å¼€å‘è€…å¤´æ¡</li></ul><h1>4. ä¹¦ç±æ¨è</h1><p><a href="https://item.jd.com/10877320.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ—¶é—´ç®¡ç†:å¦‚ä½•å……åˆ†åˆ©ç”¨ä½ çš„24å°æ—¶ï¼ˆæ¼«ç”»ç‰ˆï¼‰ã€‹</a></p><p>å¾ˆè–„çš„ä¸€æœ¬å°ä¹¦ï¼Œ2 å°æ—¶å†…é˜…è¯»å®Œæˆï¼Œåªè¦ä½ æ„¿æ„å®è·µï¼Œå°±èƒ½æ¯”ç¬”è€…æ›´åŠ å‰å®³ã€‚ğŸ˜³</p><h1>5. Warning</h1><p>åªæœ‰è¾“å…¥æ²¡æœ‰è¾“å‡ºçš„å·¥ç¨‹å¸ˆä¸æ˜¯å¥½æ¶æ„å¸ˆã€‚</p><p>æ‰€ä»¥åœ¨ä¸æ–­é˜…è¯»è¾“å…¥çš„åŒäº‹ï¼Œè¯·å°è¯•è¾“å‡ºä½ çš„é“ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. é˜…è¯»ä¸æ•´ç†&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. å…¬ä¼—å·æ¨è&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;3. åº”ç”¨æ¨è&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;4. ä¹¦ç±æ¨è&lt;/a&gt;&lt;/li&gt;
&lt;
      
    
    </summary>
    
      <category term="æŠ€æœ¯æ‚æ–‡" scheme="http://www.iocoder.cn/categories/%E6%8A%80%E6%9C%AF%E6%9D%82%E6%96%87/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®</title>
    <link href="http://www.iocoder.cn/Elastic-Job/cloud-job-config/"/>
    <id>http://www.iocoder.cn/Elastic-Job/cloud-job-config/</id>
    <published>2017-12-13T16:00:00.000Z</published>
    <updated>2017-09-06T10:53:51.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. äº‘ä½œä¸šApp</a><ul><li><a href="#">2.1 äº‘ä½œä¸šAppé…ç½®ç±»</a></li><li><a href="#">2.2 æ“ä½œäº‘ä½œä¸šAppé…ç½®</a></li></ul></li><li><a href="#3">3. äº‘ä½œä¸š</a><ul><li><a href="#">3.1 äº‘ä½œä¸šé…ç½®</a><ul><li><a href="#">3.1.1 æ“ä½œäº‘ä½œä¸šé…ç½®</a></li></ul></li><li><a href="#">3.2 æœ¬åœ°äº‘ä½œä¸šé…ç½®</a></li><li><a href="#">3.3 äº‘ä½œä¸šé…ç½®æ€»ç»“</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Cloud ä½œä¸šé…ç½®</strong>ã€‚</p><p>å¦‚æœä½ é˜…è¯»è¿‡ä»¥ä¸‹æ–‡ç« ï¼Œæœ‰åŠ©äºå¯¹æœ¬æ–‡çš„ç†è§£ï¼š</p><ul><li><a href="http://elasticjob.io/docs/elastic-job-cloud/02-guide/cloud-restful-api/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” RESTFUL APIã€‹</a></li><li><a href="http://www.iocoder.cn/Elastic-Job/job-config/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹</a></li><li><a href="https://segmentfault.com/a/1190000007723430" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç”±æµ…å…¥æ·± | å¦‚ä½•ä¼˜é›…åœ°å†™ä¸€ä¸ªMesos Frameworkã€‹</a></li></ul><p>ğŸ˜ˆ å¦å¤–ï¼Œç¬”è€…å‡è®¾ä½ å·²ç»å¯¹ <strong><a href="http://www.iocoder.cn/categories/Elastic-Job/?self">ã€ŠElastic-Job-Lite æºç åˆ†æç³»åˆ—ã€‹</a></strong> æœ‰ä¸€å®šçš„äº†è§£ã€‚</p><p>æœ¬æ–‡æ¶‰åŠåˆ°ä¸»ä½“ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_12_14/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_14/01.png" alt=""></p><ul><li><strong>é»„è‰²</strong>çš„ç±»åœ¨ <code>elastic-job-common-core</code> é¡¹ç›®é‡Œï¼Œä¸º Elastic-Job-Liteã€Elastic-Job-Cloud <strong>å…¬ç”¨</strong>ä½œä¸šé…ç½®ç±»ã€‚</li><li><strong>ç´«è‰²</strong>çš„ç±»åœ¨ <code>elastic-job-cloud</code> é¡¹ç›®é‡Œï¼Œä¸º Elastic-Job-Cloud ä½œä¸šé…ç½®ç±»ã€‚</li><li><strong>çº¢è‰²</strong>çš„ç±»åœ¨ <code>elastic-job-lite</code> é¡¹ç›®é‡Œï¼Œä¸º Elastic-Job-Lite ä½œä¸šé…ç½®ç±»ã€‚</li></ul><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><h1>2. äº‘ä½œä¸šApp</h1><p>é¦–å…ˆï¼Œç†è§£ä¸‹ <strong>äº‘ä½œä¸šApp</strong> çš„å®šä¹‰ï¼š</p><blockquote><p>FROM http://dangdangdotcom.github.io/elastic-job/elastic-job-cloud/02-guide/cloud-concepts/</p><p>ä½œä¸šAPPæŒ‡ä½œä¸šæ‰“åŒ…éƒ¨ç½²åçš„åº”ç”¨ï¼Œæè¿°äº†ä½œä¸šå¯åŠ¨éœ€è¦ç”¨åˆ°çš„CPUã€å†…å­˜ã€å¯åŠ¨è„šæœ¬åŠåº”ç”¨ä¸‹è½½è·¯å¾„ç­‰åŸºæœ¬ä¿¡æ¯ï¼Œæ¯ä¸ªAPPå¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªä½œä¸šã€‚</p></blockquote><p>ç®€å•æ¥è¯´ï¼Œä¸€ä¸ªäº‘ä½œä¸šAppå¯ä»¥ç†è§£æˆç”±å¤šä¸ªä½œä¸šæ‰“åœ¨ä¸€èµ·çš„ <code>jar</code>ã€‚</p><h2>2.1 äº‘ä½œä¸šAppé…ç½®ç±»</h2><p>CloudAppConfigurationï¼Œäº‘ä½œä¸šAppé…ç½®ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudAppConfiguration</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String appName;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨åŒ…åœ°å€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String appURL;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å¯åŠ¨è„šæœ¬</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String bootstrapScript;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * cpu æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">double</span> cpuCount = <span class="number">1</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å†…å­˜ å¤§å°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">double</span> memoryMB = <span class="number">128</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ¯æ¬¡æ‰§è¡Œä½œä¸šæ—¶æ˜¯å¦ä»ç¼“å­˜ä¸­è¯»å–åº”ç”¨ã€‚ç¦ç”¨åˆ™æ¯æ¬¡æ‰§è¡Œä»»åŠ¡å‡ä»åº”ç”¨ä»“åº“ä¸‹è½½åº”ç”¨è‡³æœ¬åœ°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> appCacheEnable = <span class="keyword">true</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¸¸é©»ä½œä¸šäº‹ä»¶é‡‡æ ·ç‡ç»Ÿè®¡æ¡æ•°ï¼Œé»˜è®¤ä¸é‡‡æ ·å…¨éƒ¨è®°å½•ã€‚</span></div><div class="line"><span class="comment">     * ä¸ºé¿å…æ•°æ®é‡è¿‡å¤§ï¼Œå¯å¯¹é¢‘ç¹è°ƒåº¦çš„å¸¸é©»ä½œä¸šé…ç½®é‡‡æ ·ç‡ï¼Œå³ä½œä¸šæ¯æ‰§è¡ŒNæ¬¡ï¼Œæ‰ä¼šè®°å½•ä½œä¸šæ‰§è¡ŒåŠè¿½è¸ªç›¸å…³æ•°æ®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> eventTraceSamplingCount;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>åœ¨ Elastic-Job-Lite é‡Œï¼Œæ‰“åŒ…ä½œä¸šï¼Œéƒ¨ç½²åˆ°æœåŠ¡å™¨é‡Œå¯åŠ¨ã€‚è€Œåœ¨ Elastic-Job-Cloud é‡Œï¼Œæ‰“åŒ…ä½œä¸šä¸Šä¼ è‡³å¯ä¸‹è½½çš„åœ°å€ã€‚ä½œä¸šè¢«è°ƒåº¦æ—¶ï¼ŒMesos ä¼šä» <code>appURL</code> ä¸‹è½½åº”ç”¨åŒ…ï¼Œä½¿ç”¨ <code>bootstrapScript</code> å¯åŠ¨åº”ç”¨è¿›è¡Œæ‰§è¡Œã€‚å®é™…æƒ…å†µä¼šæ›´åŠ å¤æ‚ä¸€ä¸¢ä¸¢ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor/?self">ã€ŠElastic-Job-Cloud æºç è§£æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>è¯¦ç»†è§£æã€‚</li><li><code>cpuCount</code>, <code>memoryMB</code> é…ç½®<strong>äº‘ä½œä¸šAppè‡ªèº«å ç”¨çš„èµ„æºæƒ…å†µ</strong>ã€‚å…¶åŒ…å«çš„æ¯ä¸ªä½œä¸šå ç”¨çš„èµ„æºæƒ…å†µï¼Œä½¿ç”¨ä½œä¸šå¯¹åº”çš„äº‘ä½œä¸šé…ç½®( CloudJobConfiguration ) ï¼Œä¸‹æ–‡ä¹Ÿä¼šçœ‹åˆ°ã€‚</li><li><code>appCacheEnable</code>ï¼šæ¯æ¬¡æ‰§è¡Œä½œä¸šæ—¶æ˜¯å¦ä»ç¼“å­˜ä¸­è¯»å–åº”ç”¨ã€‚ç¦ç”¨åˆ™æ¯æ¬¡æ‰§è¡Œä»»åŠ¡å‡ä»åº”ç”¨ä»“åº“ä¸‹è½½åº”ç”¨è‡³æœ¬åœ°ã€‚</li><li><code>eventTraceSamplingCount</code>ï¼šå¸¸é©»ä½œä¸šäº‹ä»¶é‡‡æ ·ç‡ç»Ÿè®¡æ¡æ•°ï¼Œé»˜è®¤é‡‡æ ·å…¨éƒ¨è®°å½•ã€‚ä¸ºé¿å…æ•°æ®é‡è¿‡å¤§ï¼Œå¯å¯¹é¢‘ç¹è°ƒåº¦çš„å¸¸é©»ä½œä¸šé…ç½®é‡‡æ ·ç‡ï¼Œå³ä½œä¸šæ¯æ‰§è¡ŒNæ¬¡ï¼Œæ‰ä¼šè®°å½•ä½œä¸šæ‰§è¡ŒåŠè¿½è¸ªç›¸å…³æ•°æ®ã€‚</li></ul><h2>2.2 æ“ä½œäº‘ä½œä¸šAppé…ç½®</h2><p>äº‘ä½œä¸šAppé…ç½®æœ‰å¤šç§æ“ä½œï¼š</p><ol><li>æ·»åŠ  / æ›´æ–° / åˆ é™¤</li><li>å¼€å¯ / ç¦ç”¨</li></ol><p>æœ‰ä¸¤ç§æ–¹å¼è¿›è¡Œæ“ä½œï¼Œä»¥<strong>æ·»åŠ </strong>ä¸¾ä¾‹å­ï¼š</p><ul><li><p>è°ƒç”¨ HTTP æ¥å£ï¼š</p><p><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">curl -l -H "Content-type: application/json" -X POST -d '&#123;"appName":"foo_app","appURL":"http://app_host:8080/yourJobs.gz","cpuCount":0.1,"memoryMB":64.0,"bootstrapScript":"bin/start.sh","appCacheEnable":true,"eventTraceSamplingCount":0&#125;' http://elastic_job_cloud_host:8899/api/app</div></pre></td></tr></table></figure></p></li><li><p>è¿ç»´å¹³å°</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_14/02.png" alt=""></p></li></ul><p>è¿ç»´å¹³å°æ˜¯å¯¹è°ƒç”¨ HTTP æ¥å£çš„UIå°è£…ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CloudAppRestfulApi</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/app"</span>)</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudAppRestfulApi</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ³¨å†Œåº”ç”¨é…ç½®.</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> appConfig åº”ç”¨é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@POST</span></div><div class="line">    <span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> CloudAppConfiguration appConfig)</span> </span>&#123;</div><div class="line">        Optional&lt;CloudAppConfiguration&gt; appConfigFromZk = appConfigService.load(appConfig.getAppName());</div><div class="line">        <span class="keyword">if</span> (appConfigFromZk.isPresent()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AppConfigurationException(<span class="string">"app '%s' already existed."</span>, appConfig.getAppName());</div><div class="line">        &#125;</div><div class="line">        appConfigService.add(appConfig);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CloudAppConfigurationService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ·»åŠ äº‘ä½œä¸šAPPé…ç½®.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> appConfig äº‘ä½œä¸šAppé…ç½®å¯¹è±¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> CloudAppConfiguration appConfig)</span> </span>&#123;</div><div class="line">   regCenter.persist(CloudAppConfigurationNode.getRootNodePath(appConfig.getAppName()), CloudAppConfigurationGsonFactory.toJson(appConfig));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CloudAppConfigurationNode.JAVA</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudAppConfigurationNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT =  <span class="string">"/config/app"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String APP_CONFIG =  ROOT + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;APP_NAME&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>CloudAppRestfulApiï¼Œäº‘ä½œä¸šåº”ç”¨çš„REST APIï¼Œå®ç°äº†äº‘ä½œä¸šAppé…ç½®çš„å¤šç§æ“ä½œçš„ HTTP æ¥å£ã€‚</li><li>CloudAppConfigurationServiceï¼Œäº‘ä½œä¸šAppé…ç½®æœåŠ¡ï¼Œå®ç°äº†äº‘ä½œä¸šåº”ç”¨çš„å­˜å‚¨åŠŸèƒ½ã€‚</li><li>è°ƒç”¨ <code>AppConfigService#add(...)</code> æ–¹æ³•ï¼Œå­˜å‚¨ CloudAppConfiguration åˆ°æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>${NAMESPACE}/config/app/${APP_NAME}</code>ï¼ŒJSON æ ¼å¼åŒ–å¯¹è±¡ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</li></ul><p><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 1] get /elastic-job-cloud/config/app/exampleApp</div><div class="line">&#123;"appName":"exampleApp","appURL":"http://785j8w.com1.z0.glb.clouddn.com/elastic-job-example-cloud-2.1.5.tar.gz","bootstrapScript":"bin/start.sh","cpuCount":1.0,"memoryMB":128.0,"appCacheEnable":true,"eventTraceSamplingCount":0&#125;</div></pre></td></tr></table></figure></p><h1>3. äº‘ä½œä¸š</h1><p>ä¸€ä¸ªäº‘ä½œä¸šåº”ç”¨å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªäº‘ä½œä¸šã€‚äº‘ä½œä¸šæœ‰<strong>ä¸¤ç§</strong>ä½œä¸šé…ç½®ï¼šäº‘ä½œä¸šé…ç½®ã€æœ¬åœ°äº‘ä½œä¸šé…ç½®ã€‚ä¸‹é¢æ¥åˆ†åˆ«åˆ†äº«å®ƒä»¬ã€‚</p><h2>3.1 äº‘ä½œä¸šé…ç½®</h2><p>CloudJobConfigurationï¼Œäº‘ä½œä¸šé…ç½®ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudJobConfiguration</span> <span class="keyword">implements</span> <span class="title">JobRootConfiguration</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šåº”ç”¨åç§° &#123;<span class="doctag">@link</span> com.dangdang.ddframe.job.cloud.scheduler.config.app.CloudAppConfiguration&#125;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String appName;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šç±»å‹é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobTypeConfiguration typeConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•ç‰‡ä½œä¸šæ‰€éœ€è¦çš„CPUæ•°é‡ï¼Œæœ€å°å€¼ä¸º0.001</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">double</span> cpuCount;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•ç‰‡ä½œä¸šæ‰€éœ€è¦çš„å†…å­˜MBï¼Œæœ€å°å€¼ä¸º1</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">double</span> memoryMB;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šæ‰§è¡Œç±»å‹</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CloudJobExecutionType jobExecutionType;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Springå®¹å™¨ä¸­é…ç½®çš„beanåç§°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String beanName;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Springæ–¹å¼é…ç½®Springé…ç½®æ–‡ä»¶ç›¸å¯¹è·¯å¾„ä»¥åŠåç§°ï¼Œå¦‚ï¼šMETA-INF\applicationContext.xml</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String applicationContext; </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>JobTypeConfigurationï¼Œä½œä¸šç±»å‹é…ç½®ï¼Œåœ¨ <code>elastic-job-common-core</code> é¡¹ç›®é‡Œï¼Œä¸º Elastic-Job-Liteã€Elastic-Job-Cloud <strong>å…¬ç”¨</strong>ä½œä¸šé…ç½®ç±»ã€‚åœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-config/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹çš„ã€Œ2.2.1 ä½œä¸šç±»å‹é…ç½®ã€</a>æœ‰è¯¦ç»†è§£æã€‚</li><li><code>cpuCount</code>, <code>memoryMB</code> é…ç½®<strong>å•ç‰‡ä½œä¸šå ç”¨çš„èµ„æºæƒ…å†µ</strong>ã€‚è¿™é‡Œä¸€å®šè¦æ³¨æ„æ˜¯å•ç‰‡ä½œä¸šï¼Œä¾‹å¦‚ä¸€ä¸ªä½œä¸šæœ‰ä¸‰ä¸ªåˆ†ç‰‡( <code>shardingTotalCount = 3</code> )ï¼Œåˆ™å ç”¨èµ„æºä¸º 3 * <code>cpuCount</code> + 3 * <code>memoryMB</code>ã€‚</li><li>ä½œä¸šæ‰§è¡Œç±»å‹( CloudJobExecutionType )æœ‰ä¸¤ç§ï¼šå¸¸é©»ä½œä¸š( DAEMON )ï¼Œç¬æ—¶ä½œä¸š( TRANSIENT )ã€‚åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor/?self">ã€ŠElastic-Job-Cloud æºç è§£æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>è¯¦ç»†è§£æã€‚Elastic-Job-Cloud ç‹¬æœ‰ï¼Œéå¸¸æœ‰è¶£ã€‚ğŸ‘ğŸ‘ğŸ‘</li><li><code>beanName</code>, <code>applicationContext</code> å®ç° Spring å¯åŠ¨æ–¹å¼ä½œä¸šã€‚åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor/?self">ã€ŠElastic-Job-Cloud æºç è§£æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li></ul><h3>3.1.1 æ“ä½œäº‘ä½œä¸šé…ç½®</h3><p>äº‘ä½œä¸šé…ç½®æœ‰å¤šç§æ“ä½œï¼š</p><ol><li>æ·»åŠ  / æ›´æ–° / åˆ é™¤</li><li>å¼€å¯ / ç¦ç”¨</li></ol><p>æœ‰ä¸¤ç§æ–¹å¼è¿›è¡Œæ“ä½œï¼Œä»¥<strong>æ·»åŠ </strong>ä¸¾ä¾‹å­ï¼š</p><ul><li><p>è°ƒç”¨ HTTP æ¥å£ï¼š</p><p><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">// Javaå¯åŠ¨æ–¹å¼ä½œä¸šæ³¨å†Œ</div><div class="line">curl -l -H "Content-type: application/json" -X POST -d '&#123;"jobName":"foo_job","appName":"foo_app","jobClass":"yourJobClass","jobType":"SIMPLE","jobExecutionType":"TRANSIENT","cron":"0/5 * * * * ?","shardingTotalCount":5,"cpuCount":0.1,"memoryMB":64.0,"appURL":"http://app_host:8080/foo-job.tar.gz","failover":true,"misfire":true,"bootstrapScript":"bin/start.sh"&#125;' http://elastic_job_cloud_host:8899/api/job/register</div><div class="line"></div><div class="line">// Springå¯åŠ¨æ–¹å¼ä½œä¸šæ³¨å†Œ</div><div class="line">curl -l -H "Content-type: application/json" -X POST -d '&#123;"jobName":"foo_job","jobClass":"yourJobClass","beanName":"yourBeanName","applicationContext":"applicationContext.xml","jobType":"SIMPLE","jobExecutionType":"TRANSIENT","cron":"0/5 * * * * ?","shardingTotalCount":5,"cpuCount":0.1,"memoryMB":64.0,"appURL":"http://file_host:8080/foo-job.tar.gz","failover":false,"misfire":true,"bootstrapScript":"bin/start.sh"&#125;' http://elastic_job_cloud_masterhost:8899/api/job/register</div></pre></td></tr></table></figure></p></li><li><p>è¿ç»´å¹³å°</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_14/03.png" alt=""></p></li></ul><p>è¿ç»´å¹³å°æ˜¯å¯¹è°ƒç”¨ HTTP æ¥å£çš„UIå°è£…ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CloudJobRestfulApi.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudJobRestfulApi</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ³¨å†Œä½œä¸š.</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@POST</span></div><div class="line">    <span class="meta">@Path</span>(<span class="string">"/register"</span>)</div><div class="line">    <span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">        producerManager.register(jobConfig);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ProducerManager.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerManager</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ³¨å†Œä½œä¸š.</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (disableJobService.isDisabled(jobConfig.getJobName())) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Job '%s' has been disable."</span>, jobConfig.getJobName());</div><div class="line">        &#125;</div><div class="line">        Optional&lt;CloudAppConfiguration&gt; appConfigFromZk = appConfigService.load(jobConfig.getAppName());</div><div class="line">        <span class="keyword">if</span> (!appConfigFromZk.isPresent()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AppConfigurationException(<span class="string">"Register app '%s' firstly."</span>, jobConfig.getAppName());</div><div class="line">        &#125;</div><div class="line">        Optional&lt;CloudJobConfiguration&gt; jobConfigFromZk = configService.load(jobConfig.getJobName());</div><div class="line">        <span class="keyword">if</span> (jobConfigFromZk.isPresent()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Job '%s' already existed."</span>, jobConfig.getJobName());</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// æ·»åŠ äº‘ä½œä¸šé…ç½®</span></div><div class="line">        configService.add(jobConfig);</div><div class="line">        <span class="comment">// è°ƒåº¦ä½œä¸š</span></div><div class="line">        schedule(jobConfig);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CloudJobConfigurationService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ·»åŠ äº‘ä½œä¸šé…ç½®.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobConfig äº‘ä½œä¸šé…ç½®å¯¹è±¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   regCenter.persist(CloudJobConfigurationNode.getRootNodePath(jobConfig.getJobName()), CloudJobConfigurationGsonFactory.toJson(jobConfig));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CloudJobConfigurationNode.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudJobConfigurationNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT =  <span class="string">"/config/job"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String JOB_CONFIG =  ROOT + <span class="string">"/%s"</span>;  <span class="comment">// %s = $&#123;JOB_NAME&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>CloudJobRestfulApiï¼Œä½œä¸šäº‘Jobçš„REST APIï¼Œå®ç°äº†ä½œä¸šäº‘Jobé…ç½®çš„å¤šç§æ“ä½œã€æŸ¥è¯¢è¿è¡Œä¸­ / å¾…è¿è¡Œ / å¤±æ•ˆè½¬ç§»ä½œä¸šåˆ—è¡¨ç­‰ HTTP æ¥å£ã€‚</p></li><li><p>ProducerManagerï¼Œå‘å¸ƒä»»åŠ¡ä½œä¸šè°ƒåº¦ç®¡ç†å™¨ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç±»ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor/?self">ã€ŠElastic-Job-Cloud æºç è§£æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>CloudJobConfigurationServiceï¼Œä½œä¸šé…ç½®æœåŠ¡ï¼Œå®ç°äº†ä½œä¸šé…ç½®çš„å­˜å‚¨åŠŸèƒ½ã€‚</p></li><li><p>è°ƒç”¨ <code>CloudJobConfigurationService#add(...)</code> æ–¹æ³•ï¼Œå­˜å‚¨ CloudJobConfiguration åˆ°æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>${NAMESPACE}/config/job/${JOB_NAME}</code>ï¼ŒJSON æ ¼å¼åŒ–å¯¹è±¡ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p><p><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">    [zk: localhost:2181(CONNECTED) 3] get /elastic-job-cloud/config/job/test_job_simple</div><div class="line">&#123;"jobName":"test_job_simple","jobClass":"com.dangdang.ddframe.job.example.job.simple.JavaSimpleJob","jobType":"SIMPLE","cron":"0/10 * * * * ?","shardingTotalCount":1,"shardingItemParameters":"","jobParameter":"","failover":false,"misfire":false,"description":"","jobProperties":&#123;"job_exception_handler":"com.dangdang.ddframe.job.executor.handler.impl.DefaultJobExceptionHandler","executor_service_handler":"com.dangdang.ddframe.job.executor.handler.impl.DefaultExecutorServiceHandler"&#125;,"appName":"exampleApp","cpuCount":0.1,"memoryMB":64.0,"jobExecutionType":"TRANSIENT"&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>#schedule(...)</code> æ–¹æ³•ï¼Œè°ƒåº¦ä½œä¸šã€‚è¿™æ˜¯ä¸ªå¾ˆæœ‰è¶£çš„æ–¹æ³•ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor/?self">ã€ŠElastic-Job-Cloud æºç è§£æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>è¯¦ç»†è§£æã€‚</p></li></ul><h2>3.2 æœ¬åœ°äº‘ä½œä¸šé…ç½®</h2><p>LocalCloudJobConfigurationï¼Œæœ¬åœ°äº‘ä½œä¸šé…ç½®ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public final class LocalCloudJobConfiguration implements JobRootConfiguration &#123;</div><div class="line">    </div><div class="line">    private final JobTypeConfiguration typeConfig;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * åˆ†ç‰‡ä½œä¸šåºå·</div><div class="line">     */</div><div class="line">    private final int shardingItem;</div><div class="line">    </div><div class="line">    private String beanName;</div><div class="line">    </div><div class="line">    private String applicationContext;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>shardingItem</code>ï¼Œåˆ†ç‰‡ä½œä¸šåºå·ï¼Œç”¨äºæœ¬åœ°è°ƒè¯•æŒ‡å®šåˆ†ç‰‡ä½œä¸šé¡¹ã€‚</li></ul><p>åˆ°åº•æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ</p><blockquote><p>åœ¨å¼€å‘Elastic-Job-Cloudä½œä¸šæ—¶ï¼Œå¼€å‘äººå‘˜å¯ä»¥è„±ç¦»Mesosç¯å¢ƒï¼Œåœ¨æœ¬åœ°è¿è¡Œå’Œè°ƒè¯•ä½œä¸šã€‚å¯ä»¥åˆ©ç”¨æœ¬åœ°è¿è¡Œæ¨¡å¼å……åˆ†çš„è°ƒè¯•ä¸šåŠ¡åŠŸèƒ½ä»¥åŠå•å…ƒæµ‹è¯•ï¼Œå®Œæˆä¹‹åå†éƒ¨ç½²è‡³Mesosé›†ç¾¤ã€‚<br>æœ¬åœ°è¿è¡Œä½œä¸šæ— éœ€å®‰è£…Mesosç¯å¢ƒã€‚</p></blockquote><p>åœ¨<a href="http://elasticjob.io/docs/elastic-job-cloud/02-guide/local-executor/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” æœ¬åœ°è¿è¡Œæ¨¡å¼ã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</p><h2>3.3 äº‘ä½œä¸šé…ç½®æ€»ç»“</h2><ul><li>CloudJobConfigurationï¼šç”Ÿäº§è¿è¡Œä½¿ç”¨ã€‚</li><li>LocalCloudJobConfigurationï¼šæœ¬åœ°å¼€å‘è°ƒè¯•ã€‚</li></ul><h1>666. å½©è›‹</h1><p>èŠ‹é“å›ï¼šæœ¬æ–‡ä¸»è¦ä¸º<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor/?self">ã€ŠElastic-Job-Cloud æºç è§£æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>åšé“ºå«ï¼Œè¿™ä¼šæ˜¯ä¸€ç¯‡é•¿æ–‡ã€‚è¯»æ‡‚ Elastic-Job-Cloud ä½œä¸šè°ƒåº¦åï¼Œæ•´ä¸ªäººè„‘æ´åˆå¼€çš„ä¸è¡Œä¸è¡Œçš„ï¼<br>æ—ç™½å›ï¼šæ”¯æŒ+1024ã€‚</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_14/04.png" alt=""></p><p>å¦å¤–ï¼Œæ¨èèµ„æ–™å¦‚ä¸‹ï¼Œå¯¹ç†è§£ Elastic-Job-Cloud å¾ˆæœ‰å¸®åŠ©ã€‚</p><ul><li><a href="http://www.infoq.com/cn/news/2016/09/Mesos-Elastic-Job-Cloud" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠåŸºäºMesosçš„å½“å½“ä½œä¸šäº‘Elastic Job Cloudã€‹</a></li><li><a href="http://www.infoq.com/cn/presentations/how-to-build-elastic-job-cloud" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå¦‚ä½•ä»0åˆ°1æ­å»ºå¼¹æ€§ä½œä¸šäº‘Elastic-Job-Cloudã€‹</a></li></ul><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. äº‘ä½œä¸šApp&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;
      
    
    </summary>
    
      <category term="Elastic-Job-Cloud" scheme="http://www.iocoder.cn/categories/Elastic-Job-Cloud/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” è¿ç»´å¹³å°</title>
    <link href="http://www.iocoder.cn/Elastic-Job/job-console/"/>
    <id>http://www.iocoder.cn/Elastic-Job/job-console/</id>
    <published>2017-12-06T16:00:00.000Z</published>
    <updated>2017-09-06T10:53:51.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. Mavenæ¨¡å— elastic-job-common-restful</a></li><li><a href="#">3. Mavenæ¨¡å— elastic-job-console</a></li><li><a href="#">4. Mavenæ¨¡å— elastic-job-lite-lifecycle</a></li><li><a href="#">5. å…¶å®ƒ</a></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite è¿ç»´å¹³å°</strong>ã€‚å†…å®¹å¯¹åº”<a href="http://dangdangdotcom.github.io/elastic-job/elastic-job-lite/02-guide/web-console/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” è¿ç»´å¹³å°ã€‹</a>ã€‚</p><p>è¿ç»´å¹³å°å®ç°ä¸Šæ¯”è¾ƒæ˜“æ‡‚ï¼Œå°±ä¸ç‰¹åˆ«<strong>å•°å—¦</strong>çš„è§£æï¼Œç®€ç•¥è¯´ä¸‹æ¯ä¸ªç±»çš„ç”¨é€”å’Œ UI ä¸Šçš„å…³è”ã€‚</p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><h1>2. Mavenæ¨¡å— elastic-job-common-restful</h1><ol><li>RestfulServer å†…åµŒæœåŠ¡å™¨ï¼ŒåŸºäº Jetty å®ç°</li><li>GSONProvider åç«¯æ¥å£ JSON æ ¼å¼åŒ–</li><li>RestfulExceptionMapper å¼‚å¸¸æ˜ å°„</li><li>WwwAuthFilter æˆæƒè®¤è¯ Filter</li></ol><h1>3. Mavenæ¨¡å— elastic-job-console</h1><h2>3.1 domain åŒ…</h2><ul><li>RegistryCenterConfigurations / RegistryCenterConfiguration ï¼šæ³¨å†Œä¸­å¿ƒé…ç½®å®ä½“ç›¸å…³ã€‚</li><li>EventTraceDataSourceConfigurations / EventTraceDataSourceConfiguration / EventTraceDataSource / EventTraceDataSourceFactory ï¼šäº‹ä»¶äº‹ä»¶è¿½è¸ªæ•°æ®æºé…ç½®å®ä½“ç›¸å…³ã€‚</li></ul><h2>3.2 filter åŒ…</h2><ul><li>GlobalConfigurationFilter ï¼šå…¨å±€é…ç½®è¿‡æ»¤å™¨ï¼ŒåŠ è½½å½“å‰ä¼šè¯( HttpSession ) é€‰æ‹©çš„ RegistryCenterConfiguration / EventTraceDataSource ã€‚</li></ul><h2>3.3 repository åŒ…</h2><p>ä½¿ç”¨ <strong>XMLæ–‡ä»¶</strong> å­˜å‚¨ EventTraceDataSource / RegistryCenterConfiguration é…ç½®å®ä½“ã€‚</p><h2>3.4 restful åŒ…</h2><ul><li><p><code>config</code> / RegistryCenterRestfulApi ï¼šæ³¨å†Œä¸­å¿ƒé…ç½®( RegistryCenterConfiguration )çš„RESTful API<img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_07/01.png" alt=""></p></li><li><p><code>config</code> / EventTraceDataSourceRestfulApi ï¼šäº‹ä»¶è¿½è¸ªæ•°æ®æºé…ç½®( EventTraceDataSource )çš„RESTful API<img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_07/02.png" alt=""></p></li><li><p><code>config</code> / LiteJobConfigRestfulApi ï¼šä½œä¸šé…ç½®( LiteJobConfiguration )çš„RESTful API<img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_07/03.png" alt=""></p></li><li><p>EventTraceHistoryRestfulApi ï¼šäº‹ä»¶è¿½è¸ªå†å²è®°å½•( <code>JOB_EXECUTION_LOG</code> / <code>JOB_STATUS_TRACE_LOG</code> )çš„RESTful API<img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_07/06.png" alt=""><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_07/07.png" alt=""></p></li><li><p>ServerOperationRestfulApi ï¼šæœåŠ¡å™¨ç»´åº¦æ“ä½œçš„RESTful APIã€‚<img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_07/05.png" alt=""></p></li><li><p>JobOperationRestfulApi ï¼šä½œä¸šç»´åº¦æ“ä½œçš„RESTful APIã€‚<img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_07/04.png" alt=""></p></li></ul><h2>3.5 service åŒ…</h2><ul><li>RegistryCenterConfigurationService ï¼šæ³¨å†Œä¸­å¿ƒ( RegistryCenterConfiguration )é…ç½®æœåŠ¡ã€‚</li><li>EventTraceDataSourceConfigurationService ï¼šäº‹ä»¶è¿½è¸ªæ•°æ®æºé…ç½®( EventTraceDataSource )æœåŠ¡ã€‚</li><li>JobAPIService ï¼šå’Œä½œä¸šç›¸å…³çš„ API é›†åˆæœåŠ¡ã€‚è¿™äº› API åœ¨ Mavenæ¨¡å— <code>elastic-job-lite-lifecycle</code> å®ç°ã€‚<ul><li>JobSettingsAPIï¼šä½œä¸šé…ç½®çš„APIã€‚</li><li>JobOperateAPI ï¼šæ“ä½œä½œä¸šçš„APIã€‚</li><li>ShardingOperateAPI ï¼šæ“ä½œåˆ†ç‰‡çš„APIã€‚</li><li>JobStatisticsAPI ï¼šJobStatisticsAPIã€‚</li><li>ServerStatisticsAPI ï¼šä½œä¸šæœåŠ¡å™¨çŠ¶æ€å±•ç¤ºçš„APIã€‚</li><li>ShardingStatisticsAPI ï¼šä½œä¸šåˆ†ç‰‡çŠ¶æ€å±•ç¤ºçš„APIã€‚</li></ul></li></ul><h1>4. Mavenæ¨¡å— elastic-job-lite-lifecycle</h1><p>åœ¨ JobAPIService å·²ç»åŸºæœ¬æåˆ°ï¼Œè¿™é‡Œä¸é‡å¤å™è¿°ã€‚</p><h1>5. å…¶å®ƒ</h1><ol><li>å‰åç«¯åˆ†ç¦»ï¼Œåç«¯ä½¿ç”¨ JSON ä¸ºå‰ç«¯æä¾›æ•°æ®æ¥å£ã€‚</li><li>åç«¯ API ä½¿ç”¨ Restful è®¾è®¡è§„èŒƒã€‚</li><li>å›½é™…åŒ–ä½¿ç”¨ <code>jquery.i18n.js</code> å®ç°ã€‚</li><li>ç•Œé¢ä½¿ç”¨ Bootstrap AdminLTE æ¨¡æ¿å®ç°ã€‚</li></ol><h1>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šè¿™å†™çš„... ç•¥é£˜é€¸ï¼ˆéšæ„ï¼‰<br>èŠ‹é“å›ï¼šå“ˆå“ˆå“ˆï¼Œæˆ‘è¦å¼€å§‹ Elastic-Job-Cloud å•¦å•¦å•¦å•¦ã€‚</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_07/08.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. Mavenæ¨¡å— elastic-job-common-restf
      
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.iocoder.cn/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>é—²èŠå¦‚ä½•é˜…è¯»æºç ï¼ˆéŸ³é¢‘ï¼‰</title>
    <link href="http://www.iocoder.cn/Architecture/how-to-read-source-code/"/>
    <id>http://www.iocoder.cn/Architecture/how-to-read-source-code/</id>
    <published>2017-12-01T16:00:00.000Z</published>
    <updated>2017-09-06T10:53:51.000Z</updated>
    
    <content type="html"><![CDATA[<h1>0. ä»é›¶å¼€å§‹</h1><p>ä¸€ä¸ªå–äº†å‡é…’çš„è§†é¢‘ï¼š</p><p><a href="https://v.qq.com/x/page/p0543tzm648.html" rel="external nofollow noopener noreferrer" target="_blank">è§†é¢‘ä¼ é€é—¨</a><br><a href="https://v.qq.com/x/page/p0543tzm648.html" rel="external nofollow noopener noreferrer" target="_blank">è§†é¢‘ä¼ é€é—¨</a><br><a href="https://v.qq.com/x/page/p0543tzm648.html" rel="external nofollow noopener noreferrer" target="_blank">è§†é¢‘ä¼ é€é—¨</a></p><p>è¯·å…³æ³¨ç¬”è€…çš„å…¬ä¼—å·ï¼šèŠ‹é“æºç </p><ul><li>ä¸“æ³¨æºç è§£æä¸‰åå¹´ï¼</li><li>ä¸“æ³¨æºç è§£æä¸‰åå¹´ï¼</li><li>ä¸“æ³¨æºç è§£æä¸‰åå¹´ï¼</li><li><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></li></ul><h1>1. è°ƒè¯•</h1><p>é€šè¿‡ IDE å·¥å…·<strong>è°ƒè¯•</strong>çš„æ–¹å¼é˜…è¯»æºç ã€‚</p><h2>1.1 Elastic-Job</h2><ul><li>GitHubåœ°å€ï¼šhttps://github.com/dangdangdotcom/elastic-job<ul><li>å¼€æºä¸æ˜“ï¼Œè¯·ç‚¹ Star æ”¯æŒã€‚</li><li>ä¸ªäºº Forkï¼Œå¢åŠ éƒ¨åˆ†ä¸­æ–‡æ³¨é‡Š GitHubåœ°å€ï¼šhttps://github.com/YunaiV/elastic-job</li></ul></li><li>ä¸ºä»€ä¹ˆé˜…è¯» Elastic-Job æºç ï¼Ÿï¼šhttp://www.iocoder.cn/Elastic-Job/why-read-Elastic-Job-source-code/</li><li>è°ƒè¯•æ–¹å¼ï¼š<code>com.dangdang.ddframe.job.example.JavaMain</code> ç›´æ¥ DEBUG å³å¯ã€‚</li></ul><h2>1.2 Sharding-JDBC</h2><ul><li>GitHubåœ°å€ï¼šhttps://github.com/dangdangdotcom/sharding-jdbc<ul><li>å¼€æºä¸æ˜“ï¼Œè¯·ç‚¹ Star æ”¯æŒã€‚</li><li>ä¸ªäºº Forkï¼Œå¢åŠ éƒ¨åˆ†ä¸­æ–‡æ³¨é‡Š GitHubåœ°å€ï¼šhttps://github.com/YunaiV/sharding-jdbc<ul><li>åŸºäº Sharding-JDBC V1.5.1 ç‰ˆæœ¬ï¼Œå»ºè®®é˜…è¯»æœ€æ–°ç‰ˆæœ¬ä»£ç ï¼Œæˆ‘çš„å¯ä»¥ä½œä¸ºæ³¨é‡Šè¡¥å……ã€‚</li></ul></li></ul></li><li>ä¸ºä»€ä¹ˆé˜…è¯» Sharding-JDBC æºç ï¼Ÿï¼šhttp://www.iocoder.cn/Sharding-JDBC/why-read-Sharding-JDBC-source-code/</li><li>è°ƒè¯•æ–¹å¼ï¼š<code>com.dangdang.ddframe.rdb.sharding.example.jdbc.Main</code> é…ç½®æ•°æ®æºåå¯ä»¥ DEBUGã€‚</li><li>æ‹†è§£å›¾ï¼š<img src="http://www.iocoder.cn/images/Architecture/2017_12_02/01.png" alt=""></li></ul><h2>1.3 MyCAT</h2><ul><li>GitHubåœ°å€ï¼šhttps://github.com/MyCATApache/Mycat-Server<ul><li>å¼€æºä¸æ˜“ï¼Œè¯·ç‚¹ Star æ”¯æŒã€‚</li><li>ä¸ªäºº Forkï¼Œå¢åŠ éƒ¨åˆ†ä¸­æ–‡æ³¨é‡Š GitHubåœ°å€ï¼šhttps://github.com/YunaiV/Mycat-Server</li></ul></li><li>ä¸ºä»€ä¹ˆé˜…è¯» MyCAT æºç ï¼Ÿï¼šhttp://www.iocoder.cn/MyCAT/why-read-MyCAT-source-code/</li><li>è°ƒè¯•æ–¹å¼ï¼šhttp://www.iocoder.cn/MyCAT/build-debugging-environment/</li></ul><h2>1.4 RocketMQ</h2><ul><li>GitHubåœ°å€ï¼šhttps://github.com/apache/incubator-rocketmq<ul><li>å¼€æºä¸æ˜“ï¼Œè¯·ç‚¹ Star æ”¯æŒã€‚</li><li>ä¸ªäºº Forkï¼Œå¢åŠ éƒ¨åˆ†ä¸­æ–‡æ³¨é‡Š GitHubåœ°å€ï¼šhttps://github.com/YunaiV/incubator-rocketmq</li></ul></li><li>ä¸ºä»€ä¹ˆé˜…è¯» RocketMQ æºç ï¼Ÿï¼šhttp://www.iocoder.cn/RocketMQ/why-read-RocketMQ-source-code/</li><li>è°ƒè¯•æ–¹å¼ï¼šæœ‰ç‚¹æƒ³ä¸èµ·æ¥äº†ã€‚ä»¥åè¡¥å……å“ˆã€‚</li></ul><h2>1.5 è¡¥å……</h2><p>å¦‚æœæºç æ¯”è¾ƒå¤šï¼Œä½ ä¸å¤ªæ¸…æ¥šæŒ‰ç…§ä»€ä¹ˆæ ·çš„åŠŸèƒ½é¡ºåºè°ƒè¯•ä¸‹å»ï¼Œå¯ä»¥å‚è€ƒæˆ‘å†™çš„åšå®¢ã€‚è¿™ä¸ªä¸æ˜¯å¹¿å‘Šã€‚ç¡®å®æœ‰æœ‹å‹æ˜¯å¯¹ç…§ç€åšå®¢é¡ºåºè°ƒè¯•çš„ã€‚</p><h1>2. UMLå›¾</h1><p>æ¨èä½¿ç”¨ Astah ç¤¾åŒºç‰ˆã€‚å¯¹çš„ï¼Œä¸è¦è€ƒè™‘ç ´è§£ä¸ç ´è§£çš„ã€‚ç¤¾åŒºç‰ˆï¼Œå¤Ÿï¼</p><p>å¦å¤–ï¼Œè¯·ä¸è¦çº ç»“ç”¨ä»€ä¹ˆ UML å·¥å…·ç‰›é€¼ï¼é‡ç‚¹å…ˆè¿ˆå‡ºè°ƒè¯•æºç é‚£ä¸€æ­¥ï¼Œå…¶ä»–çš„ï¼Œæ…¢æ…¢ä¼˜åŒ–ã€‚</p><p>æ¨èç”»ä¸¤ç§å›¾ï¼š</p><ul><li><p>ç±»å›¾ï¼šå¯¹æ•´ä½“ã€æˆ–è€…æŸä¸ªæ¨¡å—ï¼Œæœ‰ç³»ç»Ÿæ€§çš„è®¤è¯†ã€‚</p><p><img src="http://www.iocoder.cn/images/Architecture/2017_12_02/02.png" alt=""></p></li><li><p>é¡ºåºå›¾ï¼šå¯¹æµç¨‹çš„è°ƒç”¨é¡ºåºæœ‰æ•´ä½“çš„è®¤è¯†ï¼Œé¿å…è°ƒè¯•ï¼Œè¶Šè°ƒè¯•è¶Šæ™•ã€‚</p><p><img src="http://www.iocoder.cn/images/Architecture/2017_12_02/03.png" alt=""></p></li></ul><p>å¦‚æœä½ ä¸ä¼šç”» UML å›¾ï¼Œç›´æ¥ç›´æ¥ Googleï¼Œä¸è¦å»æ‰¾ä»€ä¹ˆ UML çš„ä¹¦ï¼Œå…ˆå¹²èµ·æ¥ï¼</p><p>æ©ï¼Œç¬”è€…ä¸æ’é™¤çœ‹ UML ä¹¦ï¼Œå› ä¸ºï¼Œæˆ‘ä¹Ÿçœ‹è¿‡å‡ æœ¬ï¼Œæ”¶è·ä¸å°ï¼Œå“ˆå“ˆå“ˆå“ˆã€‚</p><h1>3. è¾“å‡º</h1><p>é˜…è¯»æºç ï¼Œä¸å°è¯•è¾“å‡ºï¼Œå°±æ˜¯åœ¨è€æµæ°“ã€‚</p><p>æ¨èä¸‰ç§è¾“å‡ºæ–¹å¼ï¼š</p><ol><li>å†™åšå®¢ã€‚</li><li>å›¢é˜Ÿåˆ†äº«ã€‚</li><li>é€ å°è½®ã€‚</li></ol><p>åˆšå¼€å§‹æ¨èå†™åšå®¢ã€‚å¯¹çš„ï¼Œä¸å¤ªå»ºè®®åªå†™è‡ªå·±çœ‹å¾—æ‡‚çš„ç¬”è®°ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1&gt;0. ä»é›¶å¼€å§‹&lt;/h1&gt;
&lt;p&gt;ä¸€ä¸ªå–äº†å‡é…’çš„è§†é¢‘ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://v.qq.com/x/page/p0543tzm648.html&quot; rel=&quot;external nofollow noopener noreferrer&quot; target=
      
    
    </summary>
    
      <category term="æŠ€æœ¯æ‚æ–‡" scheme="http://www.iocoder.cn/categories/%E6%8A%80%E6%9C%AF%E6%9D%82%E6%96%87/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šç›‘æ§æœåŠ¡</title>
    <link href="http://www.iocoder.cn/Elastic-Job/job-monitor/"/>
    <id>http://www.iocoder.cn/Elastic-Job/job-monitor/</id>
    <published>2017-11-30T16:00:00.000Z</published>
    <updated>2017-09-06T10:53:51.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. MonitorService</a></li><li><a href="#">3. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šç›‘æ§æœåŠ¡</strong>ã€‚å†…å®¹å¯¹åº”<a href="http://dangdangdotcom.github.io/elastic-job/elastic-job-lite/02-guide/dump/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” DUMPä½œä¸šè¿è¡Œä¿¡æ¯ã€‹</a>ã€‚</p><blockquote><p>ä½¿ç”¨Elastic-Job-Liteè¿‡ç¨‹ä¸­å¯èƒ½ä¼šç¢°åˆ°ä¸€äº›åˆ†å¸ƒå¼é—®é¢˜ï¼Œå¯¼è‡´ä½œä¸šè¿è¡Œä¸ç¨³å®šã€‚<br>ç”±äºæ— æ³•åœ¨ç”Ÿäº§ç¯å¢ƒè°ƒè¯•ï¼Œé€šè¿‡dumpå‘½ä»¤å¯ä»¥æŠŠä½œä¸šå†…éƒ¨ç›¸å…³ä¿¡æ¯dumpå‡ºæ¥ï¼Œæ–¹ä¾¿å¼€å‘è€…debugåˆ†æï¼› å¦å¤–ä¸ºäº†ä¸æ³„éœ²éšç§ï¼Œå·²å°†ç›¸å…³ä¿¡æ¯ä¸­çš„ipåœ°å€ä»¥ip1, ip2â€¦çš„å½¢å¼è¿‡æ»¤ï¼Œå¯ä»¥åœ¨äº’è”ç½‘ä¸Šå…¬å¼€ä¼ è¾“ç¯å¢ƒä¿¡æ¯ï¼Œä¾¿äºè¿›ä¸€æ­¥å®Œå–„Elastic-Jobã€‚</p></blockquote><p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_12_01/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_01/01.png" alt=""></p><ul><li>åœ¨ Elastic-Job-lite é‡Œï¼Œä½œä¸šç›‘æ§æœåŠ¡( MonitorService ) å®ç°äº†<strong>DUMPä½œä¸šè¿è¡Œä¿¡æ¯</strong>åŠŸèƒ½ã€‚</li></ul><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><h1>2. MonitorService</h1><p>MonitorServiceï¼Œä½œä¸šç›‘æ§æœåŠ¡ã€‚</p><p><strong>åˆå§‹åŒ– MonitorService æ–¹æ³•å®ç°å¦‚ä¸‹</strong>ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MonitorService.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> port = configService.load(<span class="keyword">true</span>).getMonitorPort();</div><div class="line">   <span class="keyword">if</span> (port &lt; <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       log.info(<span class="string">"Elastic job: Monitor service is running, the port is '&#123;&#125;'"</span>, port);</div><div class="line">       openSocketForMonitor(port);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException ex) &#123;</div><div class="line">       log.error(<span class="string">"Elastic job: Monitor service listen failure, error is: "</span>, ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">openSocketForMonitor</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> port)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">   serverSocket = <span class="keyword">new</span> ServerSocket(port);</div><div class="line">   <span class="keyword">new</span> Thread() &#123;</div><div class="line">       </div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">           <span class="keyword">while</span> (!closed) &#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   process(serverSocket.accept());</div><div class="line">               &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException ex) &#123;</div><div class="line">                   log.error(<span class="string">"Elastic job: Monitor service open socket for monitor failure, error is: "</span>, ex);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>åœ¨ä½œä¸šé…ç½®çš„ç›‘æ§æœåŠ¡ç«¯å£å±æ€§( <code>LiteJobConfiguration.monitorPort</code> )å¯åŠ¨ <strong>ServerSocket</strong>ã€‚ä¸€ä¸ªä½œä¸šå¯¹åº”ä¸€ä¸ªä½œä¸šç›‘æ§ç«¯å£ï¼Œæ‰€ä»¥é…ç½®æ—¶ï¼Œè¯·ä¸è¦é‡å¤ç«¯å£å™¢ã€‚</li></ul><p><strong>å¤„ç† dumpå‘½ä»¤ æ–¹æ³•å¦‚ä¸‹</strong>ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MonitorService.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> Socket socket)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">   <span class="keyword">try</span> (</div><div class="line">           BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(socket.getInputStream()));</div><div class="line">           BufferedWriter writer = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(socket.getOutputStream()));</div><div class="line">           Socket autoCloseSocket = socket) &#123;</div><div class="line">       <span class="comment">// è¯»å–å‘½ä»¤</span></div><div class="line">       String cmdLine = reader.readLine();</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> != cmdLine &amp;&amp; DUMP_COMMAND.equalsIgnoreCase(cmdLine)) &#123; <span class="comment">// DUMP</span></div><div class="line">           List&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">           dumpDirectly(<span class="string">"/"</span> + jobName, result);</div><div class="line">           outputMessage(writer, Joiner.on(<span class="string">"\n"</span>).join(SensitiveInfoUtils.filterSensitiveIps(result)) + <span class="string">"\n"</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>#process()</code> æ–¹æ³•ï¼Œç›®å‰åªæ”¯æŒ <code>DUMP</code> å‘½ä»¤ã€‚å¦‚æœä½ æœ‰è‡ªå®šä¹‰å‘½ä»¤çš„éœ€è¦ï¼Œå¯ä»¥æ‹“å±•è¯¥æ–¹æ³•ã€‚</p></li><li><p>è°ƒç”¨ <code>#dumpDirectly()</code> æ–¹æ³•ï¼Œè¾“å‡ºå½“å‰ä½œä¸šåå¯¹åº”çš„ç›¸å…³è°ƒè¯•ä¿¡æ¯ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dumpDirectly</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> List&lt;String&gt; result)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (String each : regCenter.getChildrenKeys(path)) &#123;</div><div class="line">       String zkPath = path + <span class="string">"/"</span> + each;</div><div class="line">       String zkValue = regCenter.get(zkPath);</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> == zkValue) &#123;</div><div class="line">           zkValue = <span class="string">""</span>;</div><div class="line">       &#125;</div><div class="line">       TreeCache treeCache = (TreeCache) regCenter.getRawCache(<span class="string">"/"</span> + jobName);</div><div class="line">       ChildData treeCacheData = treeCache.getCurrentData(zkPath);</div><div class="line">       String treeCachePath =  <span class="keyword">null</span> == treeCacheData ? <span class="string">""</span> : treeCacheData.getPath();</div><div class="line">       String treeCacheValue = <span class="keyword">null</span> == treeCacheData ? <span class="string">""</span> : <span class="keyword">new</span> String(treeCacheData.getData());</div><div class="line">       <span class="comment">// åˆ¤æ–­ TreeCacheç¼“å­˜ å’Œ æ³¨å†Œä¸­å¿ƒ æ•°æ®ä¸€è‡´</span></div><div class="line">       <span class="keyword">if</span> (zkValue.equals(treeCacheValue) &amp;&amp; zkPath.equals(treeCachePath)) &#123;</div><div class="line">           result.add(Joiner.on(<span class="string">" | "</span>).join(zkPath, zkValue));</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           result.add(Joiner.on(<span class="string">" | "</span>).join(zkPath, zkValue, treeCachePath, treeCacheValue));</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// é€’å½’</span></div><div class="line">       dumpDirectly(zkPath, result);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å½“ä½œä¸šæœ¬åœ° <strong>TreeCacheç¼“å­˜</strong> å’Œæ³¨å†Œä¸­å¿ƒæ•°æ®ä¸ä¸€è‡´æ—¶ï¼ŒDUMP å‡º [zkPath, zkValue, treeCachePath, treeCacheValue]ã€‚å½“ç›¸åŒæ—¶ï¼Œåªéœ€ DUMP å‡º [zkPath, zkValue]ï¼Œ<strong>æ–¹ä¾¿çœ‹å‡ºæœ¬åœ°å’Œæ³¨å†Œä¸­å¿ƒæ˜¯å¦å­˜åœ¨æ•°æ®å·®å¼‚ã€‚</strong></li></ul></li><li><p>DUMP ä¿¡æ¯ä¾‹å­å¦‚ä¸‹ï¼š</p><p><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">Yunai-MacdeMacBook-Pro-2:elastic-job yunai$ <span class="built_in">echo</span> <span class="string">"dump"</span> | nc 127.0.0.1 10024</div><div class="line">/javaSimpleJob/sharding | </div><div class="line">/javaSimpleJob/sharding/2 | </div><div class="line">/javaSimpleJob/sharding/2/instance | ip198@-@5100</div><div class="line">/javaSimpleJob/sharding/1 | </div><div class="line">/javaSimpleJob/sharding/1/instance | ip198@-@5100</div><div class="line">/javaSimpleJob/sharding/0 | </div><div class="line">/javaSimpleJob/sharding/0/instance | ip198@-@5100</div><div class="line">/javaSimpleJob/servers | </div><div class="line">/javaSimpleJob/servers/ip2 | </div><div class="line">/javaSimpleJob/servers/ip198 | </div><div class="line">/javaSimpleJob/leader | </div><div class="line">/javaSimpleJob/leader/sharding | </div><div class="line">/javaSimpleJob/leader/failover | </div><div class="line">/javaSimpleJob/leader/failover/latch | </div><div class="line">/javaSimpleJob/leader/failover/items | </div><div class="line">/javaSimpleJob/leader/election | </div><div class="line">/javaSimpleJob/leader/election/latch | </div><div class="line">/javaSimpleJob/leader/election/instance | ip198@-@5100</div><div class="line">/javaSimpleJob/instances | </div><div class="line">/javaSimpleJob/instances/ip198@-@5100 | </div><div class="line">/javaSimpleJob/config | &#123;<span class="string">"jobName"</span>:<span class="string">"javaSimpleJob"</span>,<span class="string">"jobClass"</span>:<span class="string">"com.dangdang.ddframe.job.example.job.simple.JavaSimpleJob"</span>,<span class="string">"jobType"</span>:<span class="string">"SIMPLE"</span>,<span class="string">"cron"</span>:<span class="string">"0 0/2 * * * ?"</span>,<span class="string">"shardingTotalCount"</span>:3,<span class="string">"shardingItemParameters"</span>:<span class="string">"0\u003dBeijing,1\u003dShanghai,2\u003dGuangzhou"</span>,<span class="string">"jobParameter"</span>:<span class="string">""</span>,<span class="string">"failover"</span>:<span class="literal">true</span>,<span class="string">"misfire"</span>:<span class="literal">true</span>,<span class="string">"description"</span>:<span class="string">""</span>,<span class="string">"jobProperties"</span>:&#123;<span class="string">"job_exception_handler"</span>:<span class="string">"com.dangdang.ddframe.job.executor.handler.impl.DefaultJobExceptionHandler"</span>,<span class="string">"executor_service_handler"</span>:<span class="string">"com.dangdang.ddframe.job.executor.handler.impl.DefaultExecutorServiceHandler"</span>&#125;,<span class="string">"monitorExecution"</span>:<span class="literal">false</span>,<span class="string">"maxTimeDiffSeconds"</span>:-1,<span class="string">"monitorPort"</span>:10024,<span class="string">"jobShardingStrategyClass"</span>:<span class="string">"com.dangdang.ddframe.job.lite.api.strategy.impl.OdevitySortByNameJobShardingStrategy"</span>,<span class="string">"reconcileIntervalMinutes"</span>:10,<span class="string">"disabled"</span>:<span class="literal">false</span>,<span class="string">"overwrite"</span>:<span class="literal">true</span>&#125;</div></pre></td></tr></table></figure></p></li></ul><h1>666. å½©è›‹</h1><p>èŠ‹é“å›ï¼šæ˜¯æ˜¯æ˜¯ï¼Œå¯¹å¯¹çš„ï¼Œæˆ‘æ°´æ›´å•¦ï¼ğŸ˜†</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_01/02.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. MonitorService&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a h
      
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.iocoder.cn/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” è‡ªè¯Šæ–­ä¿®å¤</title>
    <link href="http://www.iocoder.cn/Elastic-Job/reconcile/"/>
    <id>http://www.iocoder.cn/Elastic-Job/reconcile/</id>
    <published>2017-11-27T16:00:00.000Z</published>
    <updated>2017-09-06T10:53:51.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. ReconcileService</a></li><li><a href="#">3. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite è‡ªè¯Šæ–­ä¿®å¤</strong>ã€‚</p><blockquote><p>åœ¨åˆ†å¸ƒå¼çš„åœºæ™¯ä¸‹ç”±äºç½‘ç»œã€æ—¶é’Ÿç­‰åŸå› ï¼Œå¯èƒ½å¯¼è‡´ Zookeeper çš„æ•°æ®ä¸çœŸå®è¿è¡Œçš„ä½œä¸šäº§ç”Ÿä¸ä¸€è‡´ï¼Œè¿™ç§ä¸ä¸€è‡´é€šè¿‡æ­£å‘çš„æ ¡éªŒæ— æ³•å®Œå…¨é¿å…ã€‚éœ€è¦å¦å¤–å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å®šæ—¶æ ¡éªŒæ³¨å†Œä¸­å¿ƒæ•°æ®ä¸çœŸå®ä½œä¸šçŠ¶æ€çš„ä¸€è‡´æ€§ï¼Œå³ç»´æŒ Elastic-Job çš„<strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ã€‚</p></blockquote><p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_11_28/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_11_28/01.png" alt=""></p><ul><li>åœ¨ Elastic-Job-lite é‡Œï¼Œè°ƒè§£åˆ†å¸ƒå¼ä½œä¸šä¸ä¸€è‡´çŠ¶æ€æœåŠ¡( ReconcileService ) å®ç°äº†<strong>è‡ªè¯Šæ–­ä¿®å¤</strong>åŠŸèƒ½ã€‚</li></ul><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><h1>2. ReconcileService</h1><p>ReconcileServiceï¼Œè°ƒè§£åˆ†å¸ƒå¼ä½œä¸šä¸ä¸€è‡´çŠ¶æ€æœåŠ¡ã€‚</p><p>ReconcileService ç»§æ‰¿ Google Guava AbstractScheduledService æŠ½è±¡ç±»ï¼Œå®ç° <code>#scheduler()</code>ã€<code>#runOneIteration()</code> æ–¹æ³•ï¼Œè¾¾åˆ°<strong>å‘¨æœŸæ€§</strong>æ ¡éªŒæ³¨å†Œä¸­å¿ƒæ•°æ®ä¸çœŸå®ä½œä¸šçŠ¶æ€çš„ä¸€è‡´æ€§ã€‚</p><p><strong><code>#scheduler()</code> æ–¹æ³•å®ç°å¦‚ä¸‹</strong>ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ReconcileService.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Scheduler <span class="title">scheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> Scheduler.newFixedDelaySchedule(<span class="number">0</span>, <span class="number">1</span>, TimeUnit.MINUTES);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>æ¯ 1 åˆ†é’Ÿä¼šè°ƒç”¨ä¸€æ¬¡ <code>#runOneIteration()</code> æ–¹æ³•è¿›è¡Œæ ¡éªŒã€‚</li><li>Google Guava AbstractScheduledService ç›¸å…³çš„çŸ¥è¯†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·± Google å­¦ä¹ å“Ÿã€‚</li></ul><p><strong><code>#runOneIteration()</code> æ–¹æ³•å®ç°å¦‚ä¸‹</strong>ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ReconcileService.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">runOneIteration</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">   LiteJobConfiguration config = configService.load(<span class="keyword">true</span>);</div><div class="line">   <span class="keyword">int</span> reconcileIntervalMinutes = <span class="keyword">null</span> == config ? -<span class="number">1</span> : config.getReconcileIntervalMinutes();</div><div class="line">   <span class="keyword">if</span> (reconcileIntervalMinutes &gt; <span class="number">0</span> &amp;&amp; (System.currentTimeMillis() - lastReconcileTime &gt;= reconcileIntervalMinutes * <span class="number">60</span> * <span class="number">1000</span>)) &#123; <span class="comment">// æ ¡éªŒæ˜¯å¦è¾¾åˆ°æ ¡éªŒå‘¨æœŸ</span></div><div class="line">       <span class="comment">// è®¾ç½®æœ€åæ ¡éªŒæ—¶é—´</span></div><div class="line">       lastReconcileTime = System.currentTimeMillis();</div><div class="line">       <span class="keyword">if</span> (leaderService.isLeaderUntilBlock() <span class="comment">// ä¸»ä½œä¸šèŠ‚ç‚¹æ‰å¯ä»¥æ‰§è¡Œ</span></div><div class="line">               &amp;&amp; !shardingService.isNeedSharding() <span class="comment">// å½“å‰ä½œä¸šä¸éœ€è¦é‡æ–°åˆ†ç‰‡</span></div><div class="line">               &amp;&amp; shardingService.hasShardingInfoInOfflineServers()) &#123; <span class="comment">// æŸ¥è¯¢æ˜¯åŒ…å«æœ‰åˆ†ç‰‡èŠ‚ç‚¹çš„ä¸åœ¨çº¿æœåŠ¡å™¨</span></div><div class="line">           log.warn(<span class="string">"Elastic Job: job status node has inconsistent value,start reconciling..."</span>);</div><div class="line">           <span class="comment">// è®¾ç½®éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°</span></div><div class="line">           shardingService.setReshardingFlag();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>é€šè¿‡ä½œä¸šé…ç½®ï¼Œè®¾ç½®<strong>ä¿®å¤ä½œä¸šæœåŠ¡å™¨ä¸ä¸€è‡´çŠ¶æ€æœåŠ¡è°ƒåº¦é—´éš”æ—¶é—´</strong>å±æ€§( <code>LiteJobConfiguration.reconcileIntervalMinutes</code> )ã€‚</li><li>è°ƒç”¨ <code>ShardingService#setReshardingFlag()</code> æ–¹æ³•ï¼Œè®¾ç½®éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°ã€‚è¿™ä¸ªä¹Ÿæ˜¯ ReconcileService æœ€æœ¬è´¨çš„è¡Œä¸ºï¼Œæœ‰äº†è¿™ä¸ªæ ‡è®°åï¼Œä½œä¸šä¼šé‡æ–°è¿›è¡Œåˆ†ç‰‡ï¼Œ<strong>è¾¾åˆ°ä½œä¸šèŠ‚ç‚¹æœ¬åœ°åˆ†ç‰‡æ•°æ®ä¸ Zookeeper æ•°æ®ä¸€è‡´</strong>ã€‚ä½œä¸šåˆ†ç‰‡é€»è¾‘ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li><li>è°ƒè§£åˆ†å¸ƒå¼ä½œä¸šä¸ä¸€è‡´çŠ¶æ€æœåŠ¡ä¸€å…±æœ‰ä¸‰ä¸ªæ¡ä»¶ï¼š<ul><li><p>è°ƒç”¨ <code>LeaderService#isLeaderUntilBlock()</code> æ–¹æ³•ï¼Œåˆ¤æ–­å½“å‰ä½œä¸šèŠ‚ç‚¹æ˜¯å¦ä¸ºä¸»èŠ‚ç‚¹ã€‚åœ¨<a href="http://www.iocoder.cn/Elastic-Job/election/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>è°ƒç”¨ <code>ShardingService#isNeedSharding()</code> æ–¹æ³•ï¼Œåˆ¤æ–­å½“å‰ä½œä¸šæ˜¯å¦éœ€è¦é‡åˆ†ç‰‡ã€‚å¦‚æœéœ€è¦é‡æ–°åˆ†ç‰‡ï¼Œå°±ä¸è¦é‡å¤è®¾ç½®å½“å‰ä½œä¸šéœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°ã€‚</p></li><li><p>è°ƒç”¨ <code>ShardingService#hasShardingInfoInOfflineServers()</code> æ–¹æ³•ï¼ŒæŸ¥è¯¢æ˜¯å¦åŒ…å«æœ‰åˆ†ç‰‡èŠ‚ç‚¹çš„ä¸åœ¨çº¿æœåŠ¡å™¨ã€‚<strong>æ°¸ä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${JOB_NAME}/sharding/${ITEM_INDEX}/instance</code> å­˜å‚¨åˆ†é…çš„ä½œä¸šèŠ‚ç‚¹ä¸»é”®( <code>${JOB_INSTANCE_ID}</code> )ï¼Œ <strong>ä¸ä¼š</strong>éšç€ä½œä¸šèŠ‚ç‚¹å› ä¸ºå„ç§åŸå› æ–­å¼€åä¼šè¯è¶…æ—¶ç§»é™¤ï¼Œè€Œ<strong>ä¸´æ—¶</strong>æ•°æ®èŠ‚ç‚¹<code>/${JOB_NAME}/instances/${JOB_INSTANCE_ID}</code> <strong>ä¼š</strong>éšç€ä½œä¸šèŠ‚ç‚¹å› ä¸ºå„ç§åŸå› æ–­å¼€åè¶…æ—¶ä¼šè¯è¶…æ—¶ç§»é™¤ã€‚å½“æŸ¥è¯¢åˆ°åŒ…å«æœ‰åˆ†ç‰‡èŠ‚ç‚¹çš„ä¸åœ¨çº¿çš„ä½œä¸šèŠ‚ç‚¹ï¼Œè®¾ç½®éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°åè¿›è¡Œé‡æ–°åˆ†ç‰‡ï¼Œå°†å…¶æŒæœ‰çš„ä½œä¸šåˆ†ç‰‡åˆ†é…ç»™å…¶å®ƒåœ¨çº¿çš„ä½œä¸šèŠ‚ç‚¹ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingService.java</span></div><div class="line"> <span class="comment">/**</span></div><div class="line"><span class="comment"> * æŸ¥è¯¢æ˜¯åŒ…å«æœ‰åˆ†ç‰‡èŠ‚ç‚¹çš„ä¸åœ¨çº¿æœåŠ¡å™¨.</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> æ˜¯åŒ…å«æœ‰åˆ†ç‰‡èŠ‚ç‚¹çš„ä¸åœ¨çº¿æœåŠ¡å™¨</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasShardingInfoInOfflineServers</span><span class="params">()</span> </span>&#123;</div><div class="line">    List&lt;String&gt; onlineInstances = jobNodeStorage.getJobNodeChildrenKeys(InstanceNode.ROOT); <span class="comment">// `/$&#123;JOB_NAME&#125;/instances/$&#123;JOB_INSTANCE_ID&#125;`</span></div><div class="line">    <span class="keyword">int</span> shardingTotalCount = configService.load(<span class="keyword">true</span>).getTypeConfig().getCoreConfig().getShardingTotalCount();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shardingTotalCount; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (!onlineInstances.contains(jobNodeStorage.getJobNodeData(ShardingNode.getInstanceNode(i)))) &#123; <span class="comment">// `/$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_INDEX&#125;/instance`</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul></li></ul><h1>666. å½©è›‹</h1><p>èŠ‹é“å›ï¼šã€åŠ¨ä½œï¼šä¸€è„šè¸¢å¼€æ—ç™½å›ã€‘ï¼Œè¿™æ˜¯å¯¹å‰é¢è§£æçš„ä¸»èŠ‚ç‚¹é€‰ä¸¾å’Œä½œä¸šåˆ†ç‰‡çš„å¤ä¹ ï¼ä¸æ˜¯æ°´æ›´ï¼<br>æ—ç™½å›ï¼šä½ æ‰¿è®¤æ°´...ã€åŠ¨ä½œï¼šèŠ‹é“å›åˆæ¥ä¸€è®°åƒå¹´æ€ã€‘</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_11_28/02.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ReconcileService&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a
      
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.iocoder.cn/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šç›‘å¬å™¨</title>
    <link href="http://www.iocoder.cn/Elastic-Job/job-listener/"/>
    <id>http://www.iocoder.cn/Elastic-Job/job-listener/</id>
    <published>2017-11-20T16:00:00.000Z</published>
    <updated>2017-09-06T10:53:51.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. ElasticJobListener</a></li><li><a href="#">3. AbstractDistributeOnceElasticJobListener</a></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šç›‘å¬å™¨</strong>ã€‚</p><p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_11_21/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_11_21/01.png" alt=""></p><ul><li>ç»¿è‰²<strong>ç›‘å¬å™¨</strong>æ¥å£ ElasticJobListenerï¼Œæ¯å°ä½œä¸šèŠ‚ç‚¹å‡æ‰§è¡Œã€‚</li><li>ç²‰è‰²<strong>ç›‘å¬å™¨</strong>æ¥å£ AbstractDistributeOnceElasticJobListenerï¼Œåˆ†å¸ƒå¼åœºæ™¯ä¸­ä»…å•ä¸€èŠ‚ç‚¹æ‰§è¡Œã€‚</li><li>è“è‰²ç±»åœ¨ <code>com.dangdang.ddframe.job.lite.internal.guarantee</code> é‡Œï¼Œä¿è¯åˆ†å¸ƒå¼ä»»åŠ¡å…¨éƒ¨å¼€å§‹å’Œç»“æŸçŠ¶æ€ã€‚ AbstractDistributeOnceElasticJobListener é€šè¿‡ <code>guarantee</code> åŠŸèƒ½ï¼Œå®ç°åˆ†å¸ƒå¼åœºæ™¯ä¸­ä»…å•ä¸€èŠ‚ç‚¹æ‰§è¡Œã€‚</li></ul><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><h1>2. ElasticJobListener</h1><p>ElasticJobListenerï¼Œä½œä¸šç›‘å¬å™¨æ¥å£ï¼Œ<strong>æ¯å°ä½œä¸šèŠ‚ç‚¹å‡æ‰§è¡Œ</strong>ã€‚</p><blockquote><p>è‹¥ä½œä¸šå¤„ç†ä½œä¸šæœåŠ¡å™¨çš„æ–‡ä»¶ï¼Œå¤„ç†å®Œæˆååˆ é™¤æ–‡ä»¶ï¼Œå¯è€ƒè™‘ä½¿ç”¨æ¯ä¸ªèŠ‚ç‚¹å‡æ‰§è¡Œæ¸…ç†ä»»åŠ¡ã€‚æ­¤ç±»å‹ä»»åŠ¡å®ç°ç®€å•ï¼Œä¸”æ— éœ€è€ƒè™‘å…¨å±€åˆ†å¸ƒå¼ä»»åŠ¡æ˜¯å¦å®Œæˆï¼Œè¯·å°½é‡ä½¿ç”¨æ­¤ç±»å‹ç›‘å¬å™¨ã€‚</p></blockquote><p>æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ElasticJobListener</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šæ‰§è¡Œå‰çš„æ‰§è¡Œçš„æ–¹æ³•.</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">beforeJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span></span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šæ‰§è¡Œåçš„æ‰§è¡Œçš„æ–¹æ³•.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">afterJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>è°ƒç”¨æ‰§è¡Œå¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ...çœç•¥æ— å…³ä»£ç </span></div><div class="line">   </div><div class="line">   <span class="comment">// æ‰§è¡Œ ä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       jobFacade.beforeJobExecuted(shardingContexts);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable cause) &#123;</div><div class="line">       jobExceptionHandler.handleException(jobName, cause);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ...çœç•¥æ— å…³ä»£ç ï¼ˆæ‰§è¡Œ æ™®é€šè§¦å‘çš„ä½œä¸šï¼‰</span></div><div class="line">   <span class="comment">// ...çœç•¥æ— å…³ä»£ç ï¼ˆæ‰§è¡Œ è¢«è·³è¿‡è§¦å‘çš„ä½œä¸šï¼‰</span></div><div class="line">   <span class="comment">// ...çœç•¥æ— å…³ä»£ç ï¼ˆæ‰§è¡Œ ä½œä¸šå¤±æ•ˆè½¬ç§»ï¼‰</span></div><div class="line">   </div><div class="line">   <span class="comment">// ...æ‰§è¡Œ ä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       jobFacade.afterJobExecuted(shardingContexts);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable cause) &#123;</div><div class="line">       jobExceptionHandler.handleException(jobName, cause);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>JobFacade å¯¹ä½œä¸šç›‘å¬å™¨ç®€å•å°è£…è¿›è¡Œè°ƒç”¨ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (ElasticJobListener each : elasticJobListeners) &#123;</div><div class="line">       each.beforeJobExecuted(shardingContexts);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (ElasticJobListener each : elasticJobListeners) &#123;</div><div class="line">       each.afterJobExecuted(shardingContexts);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ä¸‹æ–‡æåˆ°çš„ AbstractDistributeOnceElasticJobListenerï¼Œä¹Ÿæ˜¯è¿™ä¹ˆè°ƒç”¨ã€‚</p></li></ul><h1>3. AbstractDistributeOnceElasticJobListener</h1><p>AbstractDistributeOnceElasticJobListenerï¼Œåœ¨åˆ†å¸ƒå¼ä½œä¸šä¸­åªæ‰§è¡Œä¸€æ¬¡çš„ç›‘å¬å™¨ã€‚</p><blockquote><p>è‹¥ä½œä¸šå¤„ç†æ•°æ®åº“æ•°æ®ï¼Œå¤„ç†å®Œæˆååªéœ€ä¸€ä¸ªèŠ‚ç‚¹å®Œæˆæ•°æ®æ¸…ç†ä»»åŠ¡å³å¯ã€‚æ­¤ç±»å‹ä»»åŠ¡å¤„ç†å¤æ‚ï¼Œéœ€åŒæ­¥åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä½œä¸šçš„çŠ¶æ€åŒæ­¥ï¼Œæä¾›äº†è¶…æ—¶è®¾ç½®æ¥é¿å…ä½œä¸šä¸åŒæ­¥å¯¼è‡´çš„æ­»é”ï¼Œè¯·è°¨æ…ä½¿ç”¨ã€‚</p></blockquote><p><strong>åˆ›å»º</strong> AbstractDistributeOnceElasticJobListener ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDistributeOnceElasticJobListener</span> <span class="keyword">implements</span> <span class="title">ElasticJobListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¼€å§‹è¶…æ—¶æ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> startedTimeoutMilliseconds;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¼€å§‹ç­‰å¾…å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object startedWait = <span class="keyword">new</span> Object();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®Œæˆè¶…æ—¶æ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> completedTimeoutMilliseconds;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®Œæˆç­‰å¾…å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object completedWait = <span class="keyword">new</span> Object();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä¿è¯åˆ†å¸ƒå¼ä»»åŠ¡å…¨éƒ¨å¼€å§‹å’Œç»“æŸçŠ¶æ€çš„æœåŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> GuaranteeService guaranteeService;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> TimeService timeService = <span class="keyword">new</span> TimeService();</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbstractDistributeOnceElasticJobListener</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> startedTimeoutMilliseconds, <span class="keyword">final</span> <span class="keyword">long</span> completedTimeoutMilliseconds)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (startedTimeoutMilliseconds &lt;= <span class="number">0L</span>) &#123;</div><div class="line">            <span class="keyword">this</span>.startedTimeoutMilliseconds = Long.MAX_VALUE;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.startedTimeoutMilliseconds = startedTimeoutMilliseconds;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (completedTimeoutMilliseconds &lt;= <span class="number">0L</span>) &#123;</div><div class="line">            <span class="keyword">this</span>.completedTimeoutMilliseconds = Long.MAX_VALUE; </div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.completedTimeoutMilliseconds = completedTimeoutMilliseconds;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è¶…æ—¶å‚æ•° <code>startedTimeoutMilliseconds</code>ã€<code>completedTimeoutMilliseconds</code> åŠ¡å¿…ä¼ é€’ï¼Œé¿å…ä½œä¸šä¸åŒæ­¥å¯¼è‡´çš„æ­»é”ã€‚</li></ul><p>ğŸ‘‡ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹æœ¬æ–‡çš„<strong>é‡ç‚¹</strong>ï¼šAbstractDistributeOnceElasticJobListenerï¼Œåœ¨åˆ†å¸ƒå¼ä½œä¸šä¸­åªæ‰§è¡Œä¸€æ¬¡ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">beforeJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ³¨å†Œä½œä¸šåˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œ</span></div><div class="line">   guaranteeService.registerStart(shardingContexts.getShardingItemParameters().keySet());</div><div class="line">   <span class="comment">// åˆ¤æ–­æ˜¯å¦æ‰€æœ‰çš„åˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œ</span></div><div class="line">   <span class="keyword">if</span> (guaranteeService.isAllStarted()) &#123;</div><div class="line">       <span class="comment">// æ‰§è¡Œ</span></div><div class="line">       doBeforeJobExecutedAtLastStarted(shardingContexts);</div><div class="line">       <span class="comment">// æ¸…ç†å¯åŠ¨ä¿¡æ¯</span></div><div class="line">       guaranteeService.clearAllStartedInfo();</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç­‰å¾…</span></div><div class="line">   <span class="keyword">long</span> before = timeService.getCurrentMillis();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">synchronized</span> (startedWait) &#123;</div><div class="line">           startedWait.wait(startedTimeoutMilliseconds);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException ex) &#123;</div><div class="line">       Thread.interrupted();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç­‰å¾…è¶…æ—¶</span></div><div class="line">   <span class="keyword">if</span> (timeService.getCurrentMillis() - before &gt;= startedTimeoutMilliseconds) &#123;</div><div class="line">       <span class="comment">// æ¸…ç†å¯åŠ¨ä¿¡æ¯</span></div><div class="line">       guaranteeService.clearAllStartedInfo();</div><div class="line">       handleTimeout(startedTimeoutMilliseconds);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>GuaranteeService#registerStart(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œä½œä¸šåˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// GuaranteeService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStart</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingItems) &#123;</div><div class="line">       jobNodeStorage.createJobNodeIfNeeded(GuaranteeNode.getStartedNode(each));</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// GuaranteeNode.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GuaranteeNode</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = <span class="string">"guarantee"</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String STARTED_ROOT = ROOT + <span class="string">"/started"</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> String <span class="title">getStartedNode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> shardingItem)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> Joiner.on(<span class="string">"/"</span>).join(STARTED_ROOT, shardingItem);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>Zookeeper æ•°æ®èŠ‚ç‚¹ <code>/${JOB_NAME}/guarantee/started/${ITEM_INDEX}</code> ä¸º<strong>æ°¸ä¹…</strong>èŠ‚ç‚¹ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ã€‚ä¸ºä»€ä¹ˆæ˜¯<strong>æ°¸ä¹…</strong>èŠ‚ç‚¹å‘¢ï¼Ÿåœ¨ <code>GuaranteeService#isAllStarted()</code> è§åˆ†æ™“ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>GuaranteeService#isAllStarted()</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦æ‰€æœ‰çš„åˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ¤æ–­æ˜¯å¦æ‰€æœ‰çš„ä»»åŠ¡å‡å¯åŠ¨å®Œæ¯•.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ˜¯å¦æ‰€æœ‰çš„ä»»åŠ¡å‡å¯åŠ¨å®Œæ¯•</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAllStarted</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> jobNodeStorage.isJobNodeExisted(GuaranteeNode.STARTED_ROOT)</div><div class="line">           &amp;&amp; configService.load(<span class="keyword">false</span>).getTypeConfig().getCoreConfig().getShardingTotalCount() == jobNodeStorage.getJobNodeChildrenKeys(GuaranteeNode.STARTED_ROOT).size();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å½“ <code>/${JOB_NAME}/guarantee/started/</code> ç›®å½•ä¸‹ï¼Œæ‰€æœ‰ä½œä¸šåˆ†ç‰‡é¡¹éƒ½å¼€å§‹è¿è¡Œï¼Œå³è¿è¡Œæ€»æ•°ç­‰äºä½œä¸šåˆ†ç‰‡æ€»æ•°( <code>JobCoreConfiguration.ShardingTotalCount</code> )ï¼Œ<strong>ä»£è¡¨æ‰€æœ‰çš„ä»»åŠ¡å‡å¯åŠ¨å®Œæ¯•</strong>ã€‚</li><li>ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¸æ’é™¤æœ‰ä½œä¸šèŠ‚ç‚¹ä¼šæŒ‚æ‰ï¼Œå¦‚æœ <code>/${JOB_NAME}/guarantee/started/${ITEM_INDEX}</code> å­˜å‚¨<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ï¼Œä¼šå¯¼è‡´ä¸èƒ½æ»¡è¶³æ‰€æœ‰çš„åˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œçš„æ¡ä»¶ã€‚</li><li>ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè°ƒæ•´ä½œä¸šåˆ†ç‰‡æ€»æ•°( <code>JobCoreConfiguration.ShardingTotalCount</code> )ï¼Œä¼šå¯¼è‡´å¼‚å¸¸ã€‚</li></ul></li><li><p>å½“ä¸æ»¡è¶³æ‰€æœ‰çš„åˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œæ—¶ï¼Œä½œä¸šèŠ‚ç‚¹è°ƒç”¨ <code>Object#wait(...)</code>  æ–¹æ³•è¿›è¡Œç­‰å¾…ã€‚è¯¥ç­‰å¾…æ€ä¹ˆç»“æŸç­‰å¾…ï¼Ÿå½“æ»¡è¶³æ‰€æœ‰çš„åˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œçš„ä½œä¸šèŠ‚ç‚¹è°ƒç”¨ <code>GuaranteeService#clearAllStartedInfo()</code> æ—¶ï¼ŒStartedNodeRemovedJobListener ä¼šç›‘å¬åˆ° <code>/${JOB_NAME}/guarantee/started/</code> è¢«åˆ é™¤ï¼Œè°ƒç”¨ <code>Object#notifyAll(...)</code> æ–¹æ³•è¿›è¡Œå”¤é†’å…¨éƒ¨ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// GuaranteeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ¸…ç†æ‰€æœ‰ä»»åŠ¡å¯åŠ¨ä¿¡æ¯.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearAllStartedInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">   jobNodeStorage.removeJobNodeIfExisted(GuaranteeNode.STARTED_ROOT);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// StartedNodeRemovedJobListener.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StartedNodeRemovedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (Type.NODE_REMOVED == eventType &amp;&amp; guaranteeNode.isStartedRootNode(path)) &#123;</div><div class="line">           <span class="keyword">for</span> (ElasticJobListener each : elasticJobListeners) &#123;</div><div class="line">               <span class="keyword">if</span> (each <span class="keyword">instanceof</span> AbstractDistributeOnceElasticJobListener) &#123;</div><div class="line">                   ((AbstractDistributeOnceElasticJobListener) each).notifyWaitingTaskStart();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>#doBeforeJobExecutedAtLastStarted(...)</code> æ–¹æ³•ï¼Œæ‰§è¡Œæœ€åä¸€ä¸ªä½œä¸šæ‰§è¡Œå‰çš„æ‰§è¡Œçš„æ–¹æ³•ï¼Œå®ç°è¯¥æŠ½è±¡æ–¹æ³•ï¼Œå®Œæˆè‡ªå®šä¹‰é€»è¾‘ã€‚<code>#doAfterJobExecutedAtLastCompleted(...)</code> å®ç°çš„æ–¹å¼ä¸€æ ·ï¼Œå°±ä¸é‡å¤è§£æäº†ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractDistributeOnceElasticJobListener.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ†å¸ƒå¼ç¯å¢ƒä¸­æœ€åä¸€ä¸ªä½œä¸šæ‰§è¡Œå‰çš„æ‰§è¡Œçš„æ–¹æ³•.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doBeforeJobExecutedAtLastStarted</span><span class="params">(ShardingContexts shardingContexts)</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ†å¸ƒå¼ç¯å¢ƒä¸­æœ€åä¸€ä¸ªä½œä¸šæ‰§è¡Œåçš„æ‰§è¡Œçš„æ–¹æ³•.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doAfterJobExecutedAtLastCompleted</span><span class="params">(ShardingContexts shardingContexts)</span></span>;</div></pre></td></tr></table></figure></p></li><li><p>æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/Elastic-Job/2017_11_21/02.png" alt=""></p></li></ul><h1>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šå“å“Ÿå–‚ï¼ŒAbstractDistributeOnceElasticJobListener è¿˜ä¸é”™å“Ÿã€‚<br>èŠ‹é“å›ï¼šé‚£å¿…é¡»å¿…çš„ã€‚</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_11_21/03.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ElasticJobListener&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
      
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.iocoder.cn/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šäº‹ä»¶è¿½è¸ª</title>
    <link href="http://www.iocoder.cn/Elastic-Job/job-event-trace/"/>
    <id>http://www.iocoder.cn/Elastic-Job/job-event-trace/</id>
    <published>2017-11-13T16:00:00.000Z</published>
    <updated>2017-09-06T12:09:34.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. ä½œä¸šäº‹ä»¶æ€»çº¿</a></li><li><a href="#">3. ä½œä¸šäº‹ä»¶</a><ul><li><a href="#">3.1 ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶</a></li><li><a href="#">3.2 ä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶</a></li><li><a href="#">3.3 ä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨</a></li><li><a href="#">3.4 ä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢</a></li></ul></li><li><a href="#">4. ä½œä¸šç›‘å¬å™¨</a></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šäº‹ä»¶è¿½è¸ª</strong>ã€‚</p><p>å¦å¤–ï¼Œ<strong>Elastic-Job-Cloud ä½œä¸šäº‹ä»¶è¿½è¸ª</strong> å’Œ Elastic-Job-Lite åŸºæœ¬ç±»ä¼¼ï¼Œä¸å•ç‹¬å¼€ä¸€ç¯‡æ–‡ç« ï¼Œè®°å½•åœ¨è¯¥æ–‡ç« é‡Œã€‚å¦‚æœä½ å¯¹ Elastic-Job-Cloud æš‚æ—¶ä¸æ„Ÿå…´è¶£ï¼Œå¯ä»¥è·³è¿‡ç›¸åº”éƒ¨åˆ†ã€‚</p><p>Elastic-Job æä¾›äº†äº‹ä»¶è¿½è¸ªåŠŸèƒ½ï¼Œå¯é€šè¿‡äº‹ä»¶è®¢é˜…çš„æ–¹å¼å¤„ç†è°ƒåº¦è¿‡ç¨‹çš„é‡è¦äº‹ä»¶ï¼Œç”¨äºæŸ¥è¯¢ã€ç»Ÿè®¡å’Œç›‘æ§ã€‚Elastic-Job ç›®å‰è®¢é˜…ä¸¤ç§äº‹ä»¶ï¼ŒåŸºäº<strong>å…³ç³»å‹æ•°æ®åº“</strong>è®°å½•äº‹ä»¶ã€‚</p><p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_11_14/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_11_14/01.png" alt=""></p><ul><li>ä»¥ä¸Šç±»åœ¨ <code>com.dangdang.ddframe.job.event</code> åŒ…ï¼Œä¸ä»…ä¸º Elastic-Job-Liteï¼Œè€Œä¸”ä¸º Elastic-Job-Cloud å®ç°äº†äº‹ä»¶è¿½è¸ªåŠŸèƒ½ã€‚</li><li>ä½œä¸š<strong>äº‹ä»¶</strong>ï¼šç²‰è‰²çš„ç±»ã€‚</li><li>ä½œä¸š<strong>äº‹ä»¶æ€»çº¿</strong>ï¼šé»„è‰²çš„ç±»ã€‚</li><li>ä½œä¸š<strong>äº‹ä»¶ç›‘å¬å™¨</strong>ï¼šè“è‰²çš„ç±»ã€‚</li></ul><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><h1>2. ä½œä¸šäº‹ä»¶æ€»çº¿</h1><p>JobEventBusï¼Œä½œä¸šäº‹ä»¶æ€»çº¿ï¼Œæä¾›äº†æ³¨å†Œç›‘å¬å™¨ã€å‘å¸ƒäº‹ä»¶ä¸¤ä¸ªæ–¹æ³•ã€‚</p><p><strong>åˆ›å»º</strong> JobEventBus ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobEventBus</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šäº‹ä»¶é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobEventConfiguration jobEventConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * çº¿ç¨‹æ± æ‰§è¡ŒæœåŠ¡å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutorServiceObject executorServiceObject;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹ä»¶æ€»çº¿</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventBus eventBus;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦æ³¨å†Œä½œä¸šç›‘å¬å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isRegistered;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobEventBus</span><span class="params">()</span> </span>&#123;</div><div class="line">        jobEventConfig = <span class="keyword">null</span>;</div><div class="line">        executorServiceObject = <span class="keyword">null</span>;</div><div class="line">        eventBus = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobEventBus</span><span class="params">(<span class="keyword">final</span> JobEventConfiguration jobEventConfig)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.jobEventConfig = jobEventConfig;</div><div class="line">        executorServiceObject = <span class="keyword">new</span> ExecutorServiceObject(<span class="string">"job-event"</span>, Runtime.getRuntime().availableProcessors() * <span class="number">2</span>);</div><div class="line">        <span class="comment">// åˆ›å»º å¼‚æ­¥äº‹ä»¶æ€»çº¿</span></div><div class="line">        eventBus = <span class="keyword">new</span> AsyncEventBus(executorServiceObject.createExecutorService());</div><div class="line">        <span class="comment">// æ³¨å†Œ äº‹ä»¶ç›‘å¬å™¨</span></div><div class="line">        register();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>JobEventBus åŸºäº <a href="https://github.com/google/guava/wiki/EventBusExplained" rel="external nofollow noopener noreferrer" target="_blank">Google Guava EventBus</a>ï¼Œåœ¨<a href="http://www.iocoder.cn/Sharding-JDBC/sql-execute">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œã€‹ã€Œ4.1 EventBusã€</a>æœ‰è¯¦ç»†åˆ†äº«ã€‚è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ AsyncEventBus( <strong>å¼‚æ­¥äº‹ä»¶æ€»çº¿</strong> )ï¼Œæ³¨å†Œåœ¨å…¶ä¸Šé¢çš„ç›‘å¬å™¨æ˜¯<strong>å¼‚æ­¥</strong>ç›‘å¬æ‰§è¡Œï¼Œäº‹ä»¶å‘å¸ƒæ— éœ€é˜»å¡ç­‰å¾…ç›‘å¬å™¨æ‰§è¡Œå®Œé€»è¾‘ï¼Œæ‰€ä»¥å¯¹æ€§èƒ½ä¸å­˜åœ¨å½±å“ã€‚</p></li><li><p>ä½¿ç”¨ JobEventConfiguration( ä½œä¸šäº‹ä»¶é…ç½® ) åˆ›å»ºäº‹ä»¶ç›‘å¬å™¨ï¼Œè°ƒç”¨ <code>#register()</code> æ–¹æ³•è¿›è¡Œæ³¨å†Œç›‘å¬ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       eventBus.register(jobEventConfig.createJobEventListener());</div><div class="line">       isRegistered = <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> JobEventListenerConfigurationException ex) &#123;</div><div class="line">       log.error(<span class="string">"Elastic job: create JobEventListener failure, error is: "</span>, ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è¯¥æ–¹æ³•æ˜¯ç§æœ‰( <code>private</code> )æ–¹æ³•ï¼Œåªèƒ½ä½¿ç”¨ JobEventConfiguration åˆ›å»ºäº‹ä»¶ç›‘å¬å™¨æ³¨å†Œã€‚å½“ä¸ä¼ é€’è¯¥é…ç½®æ—¶ï¼Œæ„å‘³ç€ä¸å¼€å¯<strong>äº‹ä»¶è¿½è¸ª</strong>åŠŸèƒ½ã€‚</li></ul></li></ul><p><strong>å‘å¸ƒä½œä¸šäº‹ä»¶</strong></p><p>å‘å¸ƒä½œä¸šäº‹ä»¶( JobEvent ) ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventBus.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(<span class="keyword">final</span> JobEvent event)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (isRegistered &amp;&amp; !executorServiceObject.isShutdown()) &#123;</div><div class="line">       eventBus.post(event);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>åœ¨ Elaistc-Job-Lite é‡Œï¼ŒLiteJobFacade å¯¹ <code>JobEventBus#post(...)</code> è¿›è¡Œå°è£…ï¼Œæä¾›ç»™ä½œä¸šæ‰§è¡Œå™¨( AbstractElasticJobExecutor )è°ƒç”¨( Elastic-Job-Cloud å®é™…ä¹Ÿè¿›è¡Œäº†å°è£… )ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postJobExecutionEvent</span><span class="params">(<span class="keyword">final</span> JobExecutionEvent jobExecutionEvent)</span> </span>&#123;</div><div class="line">   jobEventBus.post(jobExecutionEvent);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postJobStatusTraceEvent</span><span class="params">(<span class="keyword">final</span> String taskId, <span class="keyword">final</span> State state, <span class="keyword">final</span> String message)</span> </span>&#123;</div><div class="line">   TaskContext taskContext = TaskContext.from(taskId);</div><div class="line">   jobEventBus.post(<span class="keyword">new</span> JobStatusTraceEvent(taskContext.getMetaInfo().getJobName(), taskContext.getId(),</div><div class="line">           taskContext.getSlaveId(), Source.LITE_EXECUTOR, taskContext.getType(), taskContext.getMetaInfo().getShardingItems().toString(), state, message));</div><div class="line">   <span class="keyword">if</span> (!Strings.isNullOrEmpty(message)) &#123;</div><div class="line">       log.trace(message);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>TaskContext é€šè¿‡ <code>#from(...)</code> æ–¹æ³•ï¼Œå¯¹ä½œä¸šä»»åŠ¡ID( <code>taskId</code> ) è§£æï¼Œè·å–ä»»åŠ¡ä¸Šä¸‹æ–‡ã€‚TaskContext ä»£ç æ³¨é‡Šå¾ˆå®Œæ•´ï¼Œç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/8926e94aa7c48dc635a36518da2c4b10194420a5/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/context/TaskContext.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</li></ul><h1>3. ä½œä¸šäº‹ä»¶</h1><p>ç›®å‰æœ‰ä¸¤ç§ä½œä¸šäº‹ä»¶( JobEvent )ï¼š</p><ul><li>JobStatusTraceEventï¼Œä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶ã€‚</li><li>JobExecutionEventï¼Œä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶ã€‚</li></ul><p>æœ¬å°èŠ‚åˆ†äº«ä¸¤æ–¹é¢ï¼š</p><ul><li>ä½œä¸šäº‹ä»¶<strong>å‘å¸ƒæ—¶æœº</strong>ã€‚</li><li>Elastic-Job åŸºäº<strong>å…³ç³»å‹æ•°æ®åº“</strong>è®°å½•äº‹ä»¶çš„<strong>è¡¨ç»“æ„</strong>ã€‚</li></ul><h2>3.1 ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶</h2><p>JobStatusTraceEventï¼Œä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobStatusTraceEvent</span> <span class="keyword">implements</span> <span class="title">JobEvent</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä¸»é”®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String id = UUID.randomUUID().toString();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šåç§°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åŸä½œä¸šä»»åŠ¡ID</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> String originalTaskId = <span class="string">""</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šä»»åŠ¡ID</span></div><div class="line"><span class="comment">     * æ¥è‡ª &#123;<span class="doctag">@link</span> com.dangdang.ddframe.job.executor.ShardingContexts#taskId&#125;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String taskId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ‰§è¡Œä½œä¸šæœåŠ¡å™¨çš„åå­—</span></div><div class="line"><span class="comment">     * Elastic-Job-Liteï¼Œä½œä¸šèŠ‚ç‚¹çš„ IP åœ°å€</span></div><div class="line"><span class="comment">     * Elastic-Job-Cloudï¼ŒMesos æ‰§è¡Œæœºä¸»é”®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String slaveId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»»åŠ¡æ¥æº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Source source;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»»åŠ¡æ‰§è¡Œç±»å‹</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutionType executionType;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line"><span class="comment">     * å¤šä¸ªåˆ†ç‰‡é¡¹ä»¥é€—å·åˆ†éš”</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String shardingItems;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> State state;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç›¸å…³ä¿¡æ¯</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String message;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®°å½•åˆ›å»ºæ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Date creationTime = <span class="keyword">new</span> Date();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>ExecutionTypeï¼Œæ‰§è¡Œç±»å‹ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ExecutionType &#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‡†å¤‡æ‰§è¡Œçš„ä»»åŠ¡.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    READY,</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¤±æ•ˆè½¬ç§»çš„ä»»åŠ¡.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    FAILOVER</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>Sourceï¼Œä»»åŠ¡æ¥æºã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Source &#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Elastic-Job-Cloud è°ƒåº¦å™¨</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   CLOUD_SCHEDULER,</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Elastic-Job-Cloud æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   CLOUD_EXECUTOR,</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Elastic-Job-Lite æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   LITE_EXECUTOR</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>Stateï¼Œä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> State &#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * å¼€å§‹ä¸­</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   TASK_STAGING,</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * è¿è¡Œä¸­</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   TASK_RUNNING,</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * å®Œæˆï¼ˆæ­£å¸¸ï¼‰</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   TASK_FINISHED,</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * å®Œæˆï¼ˆå¼‚å¸¸ï¼‰</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   TASK_ERROR,</div><div class="line">       </div><div class="line">   TASK_KILLED, TASK_LOST, TASK_FAILED,  TASK_DROPPED, TASK_GONE, TASK_GONE_BY_OPERATOR, TASK_UNREACHABLE, TASK_UNKNOWN</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>Elastic-Job-Lite ä½¿ç”¨  TASK_STAGINGã€TASK_RUNNINGã€TASK_FINISHEDã€TASK_ERROR å››ç§æ‰§è¡ŒçŠ¶æ€ã€‚</li><li>Elastic-Job-Cloud ä½¿ç”¨æ‰€æœ‰æ‰§è¡ŒçŠ¶æ€ã€‚</li></ul></li></ul><p>å…³ç³»æ•°æ®åº“è¡¨ <code>JOB_STATUS_TRACE_LOG</code> ç»“æ„å¦‚ä¸‹ï¼š</p><p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`JOB_STATUS_TRACE_LOG`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">varchar</span>(<span class="number">40</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`job_name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`original_task_id`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`task_id`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`slave_id`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`source`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`execution_type`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`sharding_item`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`state`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`message`</span> <span class="built_in">varchar</span>(<span class="number">4000</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`creation_time`</span> <span class="keyword">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`TASK_ID_STATE_INDEX`</span> (<span class="string">`task_id`</span>,<span class="string">`state`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COLLATE</span>=utf8_bin</div></pre></td></tr></table></figure></p><ul><li><p>Elastic-Job-Lite ä¸€æ¬¡ä½œä¸šæ‰§è¡Œè®°å½•å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_11_14/02.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_11_14/02.png" alt=""></p></li></ul><p><strong>JobStatusTraceEvent åœ¨ Elastic-Job-Lite å‘å¸ƒæ—¶æœº</strong>ï¼š</p><ul><li><p>State.TASK_STAGINGï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">    <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_STAGING)</span></div><div class="line">    <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">        jobFacade.postJobStatusTraceEvent(shardingContexts.getTaskId(), State.TASK_STAGING, String.format(<span class="string">"Job '%s' execute begin."</span>, jobName));</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>State.TASK_RUNNINGï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">   <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_RUNNING)</span></div><div class="line">   <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">       jobFacade.postJobStatusTraceEvent(taskId, State.TASK_RUNNING, <span class="string">""</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>State.TASK_FINISHEDã€State.TASK_ERRORã€ç¬¬ä¸€ç§ã€‘ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">    <span class="comment">// è·³è¿‡ å­˜åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡ä½œä¸š</span></div><div class="line">    <span class="keyword">if</span> (jobFacade.misfireIfRunning(shardingContexts.getShardingItemParameters().keySet())) &#123;</div><div class="line">      <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_FINISHED)</span></div><div class="line">      <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">          jobFacade.postJobStatusTraceEvent(shardingContexts.getTaskId(), State.TASK_FINISHED, String.format(</div><div class="line">                  <span class="string">"Previous job '%s' - shardingItems '%s' is still running, misfired job will start after previous job completed."</span>, jobName, </div><div class="line">                  shardingContexts.getShardingItemParameters().keySet()));</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><ul><li><p>State.TASK_FINISHEDã€State.TASK_ERRORã€ç¬¬äºŒç§ã€‘ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">  <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      process(shardingContexts, executionSource);</div><div class="line">  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">      <span class="comment">// æ ¹æ®æ˜¯å¦æœ‰å¼‚å¸¸ï¼Œå‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_FINISHED / State.TASK_ERROR)</span></div><div class="line">      <span class="keyword">if</span> (itemErrorMessages.isEmpty()) &#123;</div><div class="line">          <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">              jobFacade.postJobStatusTraceEvent(taskId, State.TASK_FINISHED, <span class="string">""</span>);</div><div class="line">          &#125;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">              jobFacade.postJobStatusTraceEvent(taskId, State.TASK_ERROR, itemErrorMessages.toString());</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><p><strong>JobStatusTraceEvent åœ¨ Elastic-Job-Cloud å‘å¸ƒæ—¶æœº</strong>ï¼š</p><p>Elastic-Job-Cloud é™¤äº†ä¸Šæ–‡ Elastic-Job-Lite ä¼šå¤šä¸€ä¸ªåœºæ™¯ä¸‹è®°å½•ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶( <strong>State.TASK_STAGING</strong> )ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TaskLaunchScheduledService.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> JobStatusTraceEvent <span class="title">createJobStatusTraceEvent</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">  TaskContext.MetaInfo metaInfo = taskContext.getMetaInfo();</div><div class="line">  JobStatusTraceEvent result = <span class="keyword">new</span> JobStatusTraceEvent(metaInfo.getJobName(), taskContext.getId(), taskContext.getSlaveId(),</div><div class="line">          Source.CLOUD_SCHEDULER, taskContext.getType(), String.valueOf(metaInfo.getShardingItems()), JobStatusTraceEvent.State.TASK_STAGING, <span class="string">""</span>);</div><div class="line">  <span class="comment">// å¤±æ•ˆè½¬ç§»</span></div><div class="line">  <span class="keyword">if</span> (ExecutionType.FAILOVER == taskContext.getType()) &#123;</div><div class="line">      Optional&lt;String&gt; taskContextOptional = facadeService.getFailoverTaskId(metaInfo);</div><div class="line">      <span class="keyword">if</span> (taskContextOptional.isPresent()) &#123;</div><div class="line">          result.setOriginalTaskId(taskContextOptional.get());</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä»»åŠ¡æäº¤è°ƒåº¦æœåŠ¡( TaskLaunchScheduledService )æäº¤ä»»åŠ¡æ—¶ï¼Œè®°å½•å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_STAGING)ã€‚</li></ul><p>Elastic-Job-Cloud æ ¹æ® Mesos Master é€šçŸ¥ä»»åŠ¡çŠ¶æ€å˜æ›´ï¼Œè®°å½•<strong>å¤šç§</strong>ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerEngine.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">statusUpdate</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver, <span class="keyword">final</span> Protos.TaskStatus taskStatus)</span> </span>&#123;</div><div class="line">   String taskId = taskStatus.getTaskId().getValue();</div><div class="line">   TaskContext taskContext = TaskContext.from(taskId);</div><div class="line">   String jobName = taskContext.getMetaInfo().getJobName();</div><div class="line">   log.trace(<span class="string">"call statusUpdate task state is: &#123;&#125;, task id is: &#123;&#125;"</span>, taskStatus.getState(), taskId);</div><div class="line">   <span class="comment">//</span></div><div class="line">   jobEventBus.post(<span class="keyword">new</span> JobStatusTraceEvent(jobName, taskContext.getId(), taskContext.getSlaveId(), Source.CLOUD_SCHEDULER,</div><div class="line">           taskContext.getType(), String.valueOf(taskContext.getMetaInfo().getShardingItems()), State.valueOf(taskStatus.getState().name()), taskStatus.getMessage()));</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>3.2 ä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶</h2><p>JobExecutionEventï¼Œä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobExecutionEvent</span> <span class="keyword">implements</span> <span class="title">JobEvent</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä¸»é”®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String id = UUID.randomUUID().toString();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä¸»æœºåç§°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String hostname = IpUtils.getHostName();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * IP</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String ip = IpUtils.getIp();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šä»»åŠ¡ID</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String taskId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šåå­—</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ‰§è¡Œæ¥æº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutionSource source;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> shardingItem;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¼€å§‹æ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Date startTime = <span class="keyword">new</span> Date();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç»“æŸæ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> Date completeTime;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦æ‰§è¡ŒæˆåŠŸ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> success;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ‰§è¡Œå¤±è´¥åŸå› </span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> JobExecutionEventThrowable failureCause;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>ExecutionSourceï¼Œæ‰§è¡Œæ¥æº</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ExecutionSource &#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * æ™®é€šè§¦å‘æ‰§è¡Œ</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   NORMAL_TRIGGER,</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * è¢«é”™è¿‡æ‰§è¡Œ</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   MISFIRE,</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * å¤±æ•ˆè½¬ç§»æ‰§è¡Œ</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   FAILOVER</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><p>å…³ç³»æ•°æ®åº“è¡¨ <code>JOB_EXECUTION_LOG</code> ç»“æ„å¦‚ä¸‹ï¼š</p><p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`JOB_EXECUTION_LOG`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">varchar</span>(<span class="number">40</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`job_name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`task_id`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`hostname`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`ip`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`sharding_item`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`execution_source`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`failure_cause`</span> <span class="built_in">varchar</span>(<span class="number">4000</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`is_success`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`start_time`</span> <span class="keyword">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`complete_time`</span> <span class="keyword">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COLLATE</span>=utf8_bin</div></pre></td></tr></table></figure></p><ul><li><p>Elastic-Job-Lite ä¸€æ¬¡ä½œä¸š<strong>å¤šä½œä¸šåˆ†ç‰‡é¡¹</strong>æ‰§è¡Œè®°å½•å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_11_14/03.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_11_14/03.png" alt=""></p></li></ul><p><strong>JobExecutionEvent åœ¨ Elastic-Job-Lite å‘å¸ƒæ—¶æœº</strong>ï¼š</p><pre><code><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> <span class="keyword">int</span> item, <span class="keyword">final</span> JobExecutionEvent startEvent)</span> </span>&#123;</div><div class="line">   <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(å¼€å§‹)</span></div><div class="line">   <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">       jobFacade.postJobExecutionEvent(startEvent);</div><div class="line">   &#125;</div><div class="line">   JobExecutionEvent completeEvent;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// æ‰§è¡Œå•ä¸ªä½œä¸š</span></div><div class="line">       process(<span class="keyword">new</span> ShardingContext(shardingContexts, item));</div><div class="line">       <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(æˆåŠŸ)</span></div><div class="line">       completeEvent = startEvent.executionSuccess();</div><div class="line">       <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">           jobFacade.postJobExecutionEvent(completeEvent);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable cause) &#123;</div><div class="line">       <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(å¤±è´¥)</span></div><div class="line">       completeEvent = startEvent.executionFailure(cause);</div><div class="line">       jobFacade.postJobExecutionEvent(completeEvent);</div><div class="line">       <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></code></pre><p><strong>JobExecutionEvent åœ¨ Elastic-Job-Cloud å‘å¸ƒæ—¶æœº</strong>ï¼š</p><p>å’Œ Elastic-Job-Cloud ä¸€è‡´ã€‚</p><h2>3.3 ä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨</h2><p>JobEventRdbStorageï¼Œä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨ã€‚</p><p><strong>åˆ›å»º</strong> JobEventRdbStorage ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">JobEventRdbStorage(<span class="keyword">final</span> DataSource dataSource) <span class="keyword">throws</span> SQLException &#123;</div><div class="line">   <span class="keyword">this</span>.dataSource = dataSource;</div><div class="line">   initTablesAndIndexes();</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initTablesAndIndexes</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">try</span> (Connection conn = dataSource.getConnection()) &#123;</div><div class="line">       createJobExecutionTableAndIndexIfNeeded(conn);</div><div class="line">       createJobStatusTraceTableAndIndexIfNeeded(conn);</div><div class="line">       databaseType = DatabaseType.valueFrom(conn.getMetaData().getDatabaseProductName());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#createJobExecutionTableAndIndexIfNeeded(...)</code> åˆ›å»º <code>JOB_EXECUTION_LOG</code> è¡¨å’Œç´¢å¼•ã€‚</li><li>è°ƒç”¨ <code>#createJobStatusTraceTableAndIndexIfNeeded(...)</code> åˆ›å»º <code>JOB_STATUS_TRACE_LOG</code> è¡¨å’Œç´¢å¼•ã€‚</li></ul><p><strong>å­˜å‚¨</strong> JobStatusTraceEvent ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventRdbStorage.java</span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">addJobStatusTraceEvent</span><span class="params">(<span class="keyword">final</span> JobStatusTraceEvent jobStatusTraceEvent)</span> </span>&#123;</div><div class="line">   String originalTaskId = jobStatusTraceEvent.getOriginalTaskId();</div><div class="line">   <span class="keyword">if</span> (State.TASK_STAGING != jobStatusTraceEvent.getState()) &#123;</div><div class="line">       originalTaskId = getOriginalTaskId(jobStatusTraceEvent.getTaskId());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line">   String sql = <span class="string">"INSERT INTO `"</span> + TABLE_JOB_STATUS_TRACE_LOG + <span class="string">"` (`id`, `job_name`, `original_task_id`, `task_id`, `slave_id`, `source`, `execution_type`, `sharding_item`,  "</span> </div><div class="line">           + <span class="string">"`state`, `message`, `creation_time`) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);"</span>;</div><div class="line">   <span class="comment">// ... çœç•¥ä½ æ‡‚çš„ä»£ç </span></div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getOriginalTaskId</span><span class="params">(<span class="keyword">final</span> String taskId)</span> </span>&#123;</div><div class="line">   String sql = String.format(<span class="string">"SELECT original_task_id FROM %s WHERE task_id = '%s' and state='%s'"</span>, TABLE_JOB_STATUS_TRACE_LOG, taskId, State.TASK_STAGING);</div><div class="line">   <span class="comment">// ... çœç•¥ä½ æ‡‚çš„ä»£ç </span></div><div class="line">   <span class="keyword">return</span> original_task_id;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>originalTaskId</code>ï¼ŒåŸä»»åŠ¡ä½œä¸šIDã€‚<ul><li>Elastic-Job-Lite æš‚æœªä½¿ç”¨åˆ°è¯¥å­—æ®µï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ã€‚</li><li>Elastic-Job-Cloud åœ¨<strong>ä½œä¸šå¤±æ•ˆè½¬ç§»</strong>åœºæ™¯ä¸‹ä½¿ç”¨è¯¥å­—æ®µï¼Œå­˜å‚¨å¤±æ•ˆè½¬ç§»çš„ä»»åŠ¡ä½œä¸šIDã€‚</li></ul></li></ul><p><strong>å­˜å‚¨</strong> JobExecutionEvent ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventRdbStorage.java</span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">addJobExecutionEvent</span><span class="params">(<span class="keyword">final</span> JobExecutionEvent jobExecutionEvent)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> == jobExecutionEvent.getCompleteTime()) &#123; <span class="comment">// ä½œä¸šåˆ†ç‰‡é¡¹æ‰§è¡Œå¼€å§‹</span></div><div class="line">       <span class="keyword">return</span> insertJobExecutionEvent(jobExecutionEvent);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">if</span> (jobExecutionEvent.isSuccess()) &#123; <span class="comment">// ä½œä¸šåˆ†ç‰‡é¡¹æ‰§è¡Œå®Œæˆï¼ˆæ­£å¸¸ï¼‰</span></div><div class="line">           <span class="keyword">return</span> updateJobExecutionEventWhenSuccess(jobExecutionEvent);</div><div class="line">       &#125; <span class="keyword">else</span> &#123; <span class="comment">// ä½œä¸šåˆ†ç‰‡é¡¹æ‰§è¡Œå®Œæˆï¼ˆå¼‚å¸¸ï¼‰</span></div><div class="line">           <span class="keyword">return</span> updateJobExecutionEventFailure(jobExecutionEvent);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä½œä¸šåˆ†ç‰‡é¡¹æ‰§è¡Œå®Œæˆè¿›è¡Œçš„æ˜¯<strong>æ›´æ–°</strong>æ“ä½œã€‚</li></ul><h2>3.4 ä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢</h2><p>JobEventRdbSearchï¼Œä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢ï¼Œæä¾›ç»™è¿ç»´å¹³å°è°ƒç”¨æŸ¥è¯¢æ•°æ®ã€‚æ„Ÿå…´è¶£çš„åŒå­¦ç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/8283acf01548222f39f7bfc202a8f89d27728e6c/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/event/rdb/JobEventRdbSearch.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</p><h1>4. ä½œä¸šç›‘å¬å™¨</h1><p>åœ¨ä¸Šæ–‡æˆ‘ä»¬çœ‹åˆ°ï¼Œä½œä¸šç›‘å¬å™¨é€šè¿‡ä¼ é€’ä½œä¸šäº‹ä»¶é…ç½®( JobEventConfiguration )ç»™ä½œä¸šäº‹ä»¶æ€»çº¿( JobEventBus ) <strong>è¿›è¡Œåˆ›å»ºç›‘å¬å™¨ï¼Œå¹¶æ³¨å†Œç›‘å¬å™¨åˆ°äº‹ä»¶æ€»çº¿</strong>ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸‹ Elastic-Job æä¾›çš„åŸºäº<strong>å…³ç³»æ•°æ®åº“</strong>çš„äº‹ä»¶é…ç½®å®ç°ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventConfiguration.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JobEventConfiguration</span> <span class="keyword">extends</span> <span class="title">JobEventIdentity</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ›å»ºä½œä¸šäº‹ä»¶ç›‘å¬å™¨.</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> ä½œä¸šäº‹ä»¶ç›‘å¬å™¨.</span></div><div class="line"><span class="comment">     * <span class="doctag">@throws</span> JobEventListenerConfigurationException ä½œä¸šäº‹ä»¶ç›‘å¬å™¨é…ç½®å¼‚å¸¸</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">JobEventListener <span class="title">createJobEventListener</span><span class="params">()</span> <span class="keyword">throws</span> JobEventListenerConfigurationException</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobEventRdbConfiguration.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobEventRdbConfiguration</span> <span class="keyword">extends</span> <span class="title">JobEventRdbIdentity</span> <span class="keyword">implements</span> <span class="title">JobEventConfiguration</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">transient</span> DataSource dataSource;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> JobEventListener <span class="title">createJobEventListener</span><span class="params">()</span> <span class="keyword">throws</span> JobEventListenerConfigurationException </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JobEventRdbListener(dataSource);</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobEventListenerConfigurationException(ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>JobEventRdbConfigurationï¼Œä½œä¸šæ•°æ®åº“äº‹ä»¶é…ç½®ã€‚è°ƒç”¨ <code>#createJobEventListener()</code> åˆ›å»ºä½œä¸šäº‹ä»¶æ•°æ®åº“ç›‘å¬å™¨( JobEventRdbListener )ã€‚</li></ul><p>JobEventRdbListenerï¼Œä½œä¸šäº‹ä»¶æ•°æ®åº“ç›‘å¬å™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventListener.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JobEventListener</span> <span class="keyword">extends</span> <span class="title">JobEventIdentity</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šæ‰§è¡Œäº‹ä»¶ç›‘å¬æ‰§è¡Œ.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> jobExecutionEvent ä½œä¸šæ‰§è¡Œäº‹ä»¶</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Subscribe</span></div><div class="line">    <span class="meta">@AllowConcurrentEvents</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">listen</span><span class="params">(JobExecutionEvent jobExecutionEvent)</span></span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šçŠ¶æ€ç—•è¿¹äº‹ä»¶ç›‘å¬æ‰§è¡Œ.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> jobStatusTraceEvent ä½œä¸šçŠ¶æ€ç—•è¿¹äº‹ä»¶</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Subscribe</span></div><div class="line">    <span class="meta">@AllowConcurrentEvents</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">listen</span><span class="params">(JobStatusTraceEvent jobStatusTraceEvent)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobEventRdbListener.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobEventRdbListener</span> <span class="keyword">extends</span> <span class="title">JobEventRdbIdentity</span> <span class="keyword">implements</span> <span class="title">JobEventListener</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobEventRdbStorage repository;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobEventRdbListener</span><span class="params">(<span class="keyword">final</span> DataSource dataSource)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        repository = <span class="keyword">new</span> JobEventRdbStorage(dataSource);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(<span class="keyword">final</span> JobExecutionEvent executionEvent)</span> </span>&#123;</div><div class="line">        repository.addJobExecutionEvent(executionEvent);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(<span class="keyword">final</span> JobStatusTraceEvent jobStatusTraceEvent)</span> </span>&#123;</div><div class="line">        repository.addJobStatusTraceEvent(jobStatusTraceEvent);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>é€šè¿‡ JobEventRdbStorage å­˜å‚¨ä½œä¸šäº‹ä»¶åˆ°å…³ç³»å‹æ•°æ®åº“ã€‚</li></ul><p><strong>å¦‚ä½•è‡ªå®šä¹‰ä½œä¸šç›‘å¬å™¨ï¼Ÿ</strong></p><p>æœ‰äº›åŒå­¦å¯èƒ½å¸Œæœ›ä½¿ç”¨ ES æˆ–è€…å…¶ä»–æ•°æ®åº“å­˜å‚¨ä½œä¸šäº‹ä»¶ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥é€šè¿‡å®ç° JobEventConfigurationã€JobEventListener è¿›è¡Œæ‹“å±•ã€‚</p><p><strong>Elastic-Job-Cloud JobEventConfiguration æ€ä¹ˆé…ç½®ï¼Ÿ</strong></p><ul><li><p>Elastic-Job-Cloud-Schedulerï¼šä» <code>conf/elastic-job-cloud-scheduler.properties</code> é…ç½®æ–‡ä»¶è¯»å–å¦‚ä¸‹å±æ€§ï¼Œç”Ÿæˆ JobEventConfiguration é…ç½®å¯¹è±¡ã€‚</p><ul><li><code>event_trace_rdb_driver</code></li><li><code>event_trace_rdb_url</code></li><li><code>event_trace_rdb_username</code></li><li><code>event_trace_rdb_password</code></li></ul></li><li><p>Elastic-Job-Cloud-Executorï¼šé€šè¿‡æ¥æ”¶åˆ°ä»»åŠ¡æ‰§è¡Œä¿¡æ¯é‡Œè¯»å–JobEventConfigurationï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TaskExecutor.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registered</span><span class="params">(<span class="keyword">final</span> ExecutorDriver executorDriver, <span class="keyword">final</span> Protos.ExecutorInfo executorInfo, <span class="keyword">final</span> Protos.FrameworkInfo frameworkInfo, <span class="keyword">final</span> Protos.SlaveInfo slaveInfo)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!executorInfo.getData().isEmpty()) &#123;</div><div class="line">       Map&lt;String, String&gt; data = SerializationUtils.deserialize(executorInfo.getData().toByteArray());</div><div class="line">       BasicDataSource dataSource = <span class="keyword">new</span> BasicDataSource();</div><div class="line">       dataSource.setDriverClassName(data.get(<span class="string">"event_trace_rdb_driver"</span>));</div><div class="line">       dataSource.setUrl(data.get(<span class="string">"event_trace_rdb_url"</span>));</div><div class="line">       dataSource.setPassword(data.get(<span class="string">"event_trace_rdb_password"</span>));</div><div class="line">       dataSource.setUsername(data.get(<span class="string">"event_trace_rdb_username"</span>));</div><div class="line">       jobEventBus = <span class="keyword">new</span> JobEventBus(<span class="keyword">new</span> JobEventRdbConfiguration(dataSource));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h1>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šçæ¯”æ¯”äº†è¿™ä¹ˆé•¿ï¼Œèƒ½ä¸èƒ½ç®€å•ç²—æš´ä¸€ç‚¹ã€‚<br>èŠ‹é“å›ï¼šæ˜¯æ˜¯æ˜¯ã€‚</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_11_14/04.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ä½œä¸šäº‹ä»¶æ€»çº¿&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;
      
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.iocoder.cn/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»</title>
    <link href="http://www.iocoder.cn/Elastic-Job/job-failover/"/>
    <id>http://www.iocoder.cn/Elastic-Job/job-failover/</id>
    <published>2017-11-06T16:00:00.000Z</published>
    <updated>2017-09-06T10:53:51.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. ä½œä¸šèŠ‚ç‚¹å´©æºƒç›‘å¬</a></li><li><a href="#">3. ä½œä¸šå¤±æ•ˆè½¬ç§»</a></li><li><a href="#">4. è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</a></li><li><a href="#">5. ç›‘å¬ä½œä¸šå¤±æ•ˆè½¬ç§»åŠŸèƒ½å…³é—­</a></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šå¤±æ•ˆè½¬ç§»</strong>ã€‚</p><p>å½“ä½œä¸šèŠ‚ç‚¹æ‰§è¡Œä½œä¸šå¼‚å¸¸å´©æºƒæ—¶ï¼Œå…¶æ‰€åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹åœ¨ä¸‹æ¬¡é‡æ–°åˆ†ç‰‡ä¹‹å‰ä¸ä¼šè¢«é‡æ–°æ‰§è¡Œã€‚å¼€å¯å¤±æ•ˆè½¬ç§»åŠŸèƒ½åï¼Œè¿™éƒ¨åˆ†ä½œä¸šåˆ†ç‰‡é¡¹å°†è¢«å…¶ä»–ä½œä¸šèŠ‚ç‚¹æŠ“å–åâ€œæ‰§è¡Œâ€ã€‚ä¸ºä»€ä¹ˆæ­¤å¤„çš„æ‰§è¡Œæ‰“å¼•å·å‘¢ï¼ŸğŸ˜ˆä¸‹æ–‡æˆ‘ä»¬ä¼šåˆ†äº«åˆ°å™¢ï¼Œå–ä¸ªå…³å­ã€‚</p><p>ç¬”è€…å¯¹<strong>å¤±æ•ˆè½¬ç§»</strong>ç†è§£äº†è›®ä¹…æ—¶é—´ï¼Œå› æ­¤å¼•ç”¨å®˜æ–¹å¯¹å®ƒçš„è§£é‡Šï¼Œè®©ä½ èƒ½æ›´å¥½çš„ç†è§£ï¼š</p><blockquote><p>æ¥æºåœ°å€ï¼šhttps://my.oschina.net/u/719192/blog/506062<br>å¤±æ•ˆè½¬ç§»ï¼š è¿è¡Œä¸­çš„ä½œä¸šæœåŠ¡å™¨å´©æºƒä¸ä¼šå¯¼è‡´é‡æ–°åˆ†ç‰‡ï¼Œåªä¼šåœ¨ä¸‹æ¬¡ä½œä¸šå¯åŠ¨æ—¶åˆ†ç‰‡ã€‚å¯ç”¨å¤±æ•ˆè½¬ç§»åŠŸèƒ½å¯ä»¥åœ¨æœ¬æ¬¡ä½œä¸šæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç›‘æµ‹å…¶ä»–ä½œä¸šæœåŠ¡å™¨ç©ºé—²ï¼ŒæŠ“å–æœªå®Œæˆçš„å­¤å„¿åˆ†ç‰‡é¡¹æ‰§è¡Œã€‚<br>-- åˆ†éš”ç¬¦ --<br>æ¥æºåœ°å€ï¼šhttp://dangdangdotcom.github.io/elastic-job/elastic-job-lite/03-design/lite-design/<br>å®ç°å¤±æ•ˆè½¬ç§»åŠŸèƒ½ï¼Œåœ¨æŸå°æœåŠ¡å™¨æ‰§è¡Œå®Œæ¯•åä¸»åŠ¨æŠ“å–æœªåˆ†é…çš„åˆ†ç‰‡ï¼Œå¹¶ä¸”åœ¨æŸå°æœåŠ¡å™¨ä¸‹çº¿åä¸»åŠ¨å¯»æ‰¾å¯ç”¨çš„æœåŠ¡å™¨æ‰§è¡Œä»»åŠ¡ã€‚</p></blockquote><p>è¿™æ ·çœ‹æ¦‚å¿µå¯èƒ½è¿˜æ˜¯æ¯”è¾ƒéš¾ç†è§£ï¼Œä»£ç æèµ·æ¥ï¼</p><p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_11_07/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_11_07/01.png" alt=""></p><ul><li>ç²‰è‰²çš„ç±»åœ¨ <code>com.dangdang.ddframe.job.lite.internal.failover</code> åŒ…ä¸‹ï¼Œå®ç°äº† Elastic-Job-Lite ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‚</li><li>FailoverServiceï¼Œä½œä¸šå¤±æ•ˆè½¬ç§»æœåŠ¡ã€‚</li><li>FailoverNodeï¼Œä½œä¸šå¤±æ•ˆè½¬ç§»æ•°æ®å­˜å‚¨è·¯å¾„ã€‚</li><li>FailoverListenerManagerï¼Œä½œä¸šå¤±æ•ˆè½¬ç§»ç›‘å¬ç®¡ç†å™¨ã€‚</li></ul><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><h1>2. ä½œä¸šèŠ‚ç‚¹å´©æºƒç›‘å¬</h1><p>å½“ä½œä¸šèŠ‚ç‚¹å´©æºƒæ—¶ï¼Œç›‘å¬å™¨ JobCrashedJobListener ä¼šç›‘å¬åˆ°è¯¥æƒ…å†µï¼Œè¿›è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»å¤„ç†ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobCrashedJobListener.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JobCrashedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (isFailoverEnabled() &amp;&amp; Type.NODE_REMOVED == eventType</div><div class="line">               &amp;&amp; instanceNode.isInstancePath(path)) &#123; <span class="comment">// /$&#123;JOB_NAME&#125;/instances/$&#123;INSTANCE_ID&#125;</span></div><div class="line">           String jobInstanceId = path.substring(instanceNode.getInstanceFullPath().length() + <span class="number">1</span>);</div><div class="line">           <span class="keyword">if</span> (jobInstanceId.equals(JobRegistry.getInstance().getJobInstance(jobName).getJobInstanceId())) &#123;</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           &#125;</div><div class="line">           List&lt;Integer&gt; failoverItems = failoverService.getFailoverItems(jobInstanceId); <span class="comment">// /$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/failover</span></div><div class="line">           <span class="keyword">if</span> (!failoverItems.isEmpty()) &#123;</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> each : failoverItems) &#123;</div><div class="line">                   failoverService.setCrashedFailoverFlag(each);</div><div class="line">                   failoverService.failoverIfNecessary();</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingService.getShardingItems(jobInstanceId)) &#123; <span class="comment">// /$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/instance</span></div><div class="line">                   failoverService.setCrashedFailoverFlag(each);</div><div class="line">                   failoverService.failoverIfNecessary();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>é€šè¿‡åˆ¤æ–­ <code>/${JOB_NAME}/instances/${INSTANCE_ID}</code> è¢«ç§»é™¤ï¼Œæ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»é€»è¾‘ã€‚â“è¯´å¥½çš„ä½œä¸šèŠ‚ç‚¹<strong>å´©æºƒ</strong>å‘¢ï¼Ÿç»è¿‡ç¡®è®¤ï¼Œç›®å‰è¿™å—å­˜åœ¨ BUGï¼Œæœªåˆ¤æ–­ä½œä¸šèŠ‚ç‚¹æ˜¯å¦ä¸ºå¥”æºƒã€‚<strong>æ‰€ä»¥åœ¨å½“å‰ç‰ˆæœ¬ï¼Œä½œä¸šå¤±æ•ˆè½¬ç§»é¢å‘çš„æ˜¯æ‰€æœ‰ä½œä¸šèŠ‚ç‚¹å…³é—­é€»è¾‘ï¼Œä¸ä»…é™äºä½œä¸šå´©æºƒå…³é—­ã€‚</strong></p></li><li><p>ä¼˜å…ˆè°ƒç”¨ <code>FailoverService#getFailoverItems(...)</code> æ–¹æ³•ï¼Œè·å¾—å…³é—­ä½œä¸šèŠ‚ç‚¹( <code>${JOB_INSTANCE_ID}</code> )å¯¹åº”çš„ <code>${JOB_NAME}/sharding/${ITEM_ID}/failover</code> ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p><p>è‹¥è¯¥ä½œä¸šåˆ†ç‰‡é¡¹ä¸ºç©ºï¼Œå†è°ƒç”¨ <code>ShardingService#getShardingItems(...)</code> æ–¹æ³•ï¼Œè·å¾—å…³é—­ä½œä¸šèŠ‚ç‚¹( <code>${JOB_INSTANCE_ID}</code> )å¯¹åº”çš„ <code>/${JOB_NAME}/sharding/${ITEM_ID}/instance</code> ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p><p>ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·çš„é¡ºåºå‘¢ï¼Ÿæ”¾åœ¨ <code>FailoverService#failoverIfNecessary()</code> ä¸€èµ·è®²ã€‚è¿™é‡Œå…ˆçœ‹ä¸‹ <code>FailoverService#getFailoverItems(...)</code> æ–¹æ³•çš„å®ç°ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getFailoverItems</span><span class="params">(<span class="keyword">final</span> String jobInstanceId)</span> </span>&#123;</div><div class="line">   List&lt;String&gt; items = jobNodeStorage.getJobNodeChildrenKeys(ShardingNode.ROOT);</div><div class="line">   List&lt;Integer&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(items.size());</div><div class="line">   <span class="keyword">for</span> (String each : items) &#123;</div><div class="line">       <span class="keyword">int</span> item = Integer.parseInt(each);</div><div class="line">       String node = FailoverNode.getExecutionFailoverNode(item); <span class="comment">// `$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/failover`</span></div><div class="line">       <span class="keyword">if</span> (jobNodeStorage.isJobNodeExisted(node) &amp;&amp; jobInstanceId.equals(jobNodeStorage.getJobNodeDataDirectly(node))) &#123;</div><div class="line">           result.add(item);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   Collections.sort(result);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>FailoverService#setCrashedFailoverFlag(...)</code> æ–¹æ³•ï¼Œè®¾ç½®å¤±æ•ˆçš„åˆ†ç‰‡é¡¹æ ‡è®° <code>/${JOB_NAME}/leader/failover/items/${ITEM_ID}</code>ã€‚è¯¥æ•°æ®èŠ‚ç‚¹ä¸º<strong>æ°¸ä¹…</strong>èŠ‚ç‚¹ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCrashedFailoverFlag</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> item)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!isFailoverAssigned(item)) &#123;</div><div class="line">       jobNodeStorage.createJobNodeIfNeeded(FailoverNode.getItemsNode(item)); <span class="comment">// /$&#123;JOB_NAME&#125;/leader/failover/items/$&#123;ITEM_ID&#125;</span></div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isFailoverAssigned</span><span class="params">(<span class="keyword">final</span> Integer item)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> jobNodeStorage.isJobNodeExisted(FailoverNode.getExecutionFailoverNode(item));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>FailoverService#failoverIfNecessary()</code> æ–¹æ³•ï¼Œå¦‚æœéœ€è¦å¤±æ•ˆè½¬ç§», åˆ™æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»ã€‚</p></li></ul><h1>3. ä½œä¸šå¤±æ•ˆè½¬ç§»</h1><p>è°ƒç”¨ <code>FailoverService#failoverIfNecessary()</code> æ–¹æ³•ï¼Œå¦‚æœéœ€è¦å¤±æ•ˆè½¬ç§», åˆ™æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failoverIfNecessary</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (needFailover()) &#123;</div><div class="line">       jobNodeStorage.executeInLeader(FailoverNode.LATCH, <span class="keyword">new</span> FailoverLeaderExecutionCallback());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#needFailover()</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦æ»¡è¶³å¤±æ•ˆè½¬ç§»æ¡ä»¶ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">needFailover</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="comment">// `$&#123;JOB_NAME&#125;/leader/failover/items/$&#123;ITEM_ID&#125;` æœ‰å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">    <span class="keyword">return</span> jobNodeStorage.isJobNodeExisted(FailoverNode.ITEMS_ROOT) &amp;&amp; !jobNodeStorage.getJobNodeChildrenKeys(FailoverNode.ITEMS_ROOT).isEmpty()</div><div class="line">            <span class="comment">// å½“å‰ä½œä¸šä¸åœ¨è¿è¡Œä¸­</span></div><div class="line">            &amp;&amp; !JobRegistry.getInstance().isJobRunning(jobName);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>æ¡ä»¶ä¸€ï¼š<code>${JOB_NAME}/leader/failover/items/${ITEM_ID}</code> æœ‰å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p></li><li><p>æ¡ä»¶äºŒï¼šå½“å‰ä½œä¸šä¸åœ¨è¿è¡Œä¸­ã€‚æ­¤æ¡ä»¶å³æ˜¯ä¸Šæ–‡æäº¤çš„ä½œä¸šèŠ‚ç‚¹<strong>ç©ºé—²</strong>çš„å®šä¹‰ã€‚</p><blockquote><p>å¤±æ•ˆè½¬ç§»ï¼š è¿è¡Œä¸­çš„ä½œä¸šæœåŠ¡å™¨å´©æºƒä¸ä¼šå¯¼è‡´é‡æ–°åˆ†ç‰‡ï¼Œåªä¼šåœ¨ä¸‹æ¬¡ä½œä¸šå¯åŠ¨æ—¶åˆ†ç‰‡ã€‚å¯ç”¨å¤±æ•ˆè½¬ç§»åŠŸèƒ½å¯ä»¥åœ¨æœ¬æ¬¡ä½œä¸šæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç›‘æµ‹å…¶ä»–ä½œä¸šæœåŠ¡å™¨ã€ç©ºé—²ã€‘ï¼ŒæŠ“å–æœªå®Œæˆçš„å­¤å„¿åˆ†ç‰‡é¡¹æ‰§è¡Œ</p></blockquote></li></ul></li><li><p>è°ƒç”¨ <code>JobNodeStorage#executeInLeader(...)</code> æ–¹æ³•ï¼Œä½¿ç”¨ <code>FailoverNode.LATCH</code>( <code>/${JOB_NAME}/leader/failover/latch</code> ) è·¯å¾„æ„æˆçš„<strong>åˆ†å¸ƒå¼é”</strong>ï¼Œä¿è¯ FailoverLeaderExecutionCallback çš„å›è°ƒæ–¹æ³•åŒä¸€æ—¶é—´ï¼Œå³ä½¿å¤šä¸ªä½œä¸šèŠ‚ç‚¹è°ƒç”¨ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªä½œä¸šèŠ‚ç‚¹è¿›è¡Œæ‰§è¡Œã€‚å¦å¤–ï¼Œè™½ç„¶ <code>JobNodeStorage#executeInLeader(...)</code> æ–¹æ³•ä¸Šå¸¦æœ‰ <code>Leader</code> å…³é”®å­—ï¼Œå®é™…éå¿…é¡»åœ¨ä¸»èŠ‚ç‚¹çš„æ“ä½œï¼Œä»»ä½•ä¸€ä¸ªæ‹¿åˆ°<strong>åˆ†å¸ƒå¼é”</strong>çš„ä½œä¸šèŠ‚ç‚¹éƒ½å¯ä»¥è°ƒç”¨ã€‚ç›®å‰å’Œ<strong>åˆ†å¸ƒå¼é”</strong>ç›¸å…³çš„é€»è¾‘ï¼Œåœ¨ Elastic-Job-Lite é‡Œï¼Œéƒ½ä¼šè°ƒç”¨ <code>JobNodeStorage#executeInLeader(...)</code> æ–¹æ³•ï¼Œæ•°æ®éƒ½å­˜å‚¨åœ¨ <code>/leader/</code> èŠ‚ç‚¹ç›®å½•ä¸‹ã€‚å…³äº<strong>åˆ†å¸ƒå¼é”</strong>ç›¸å…³çš„ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/reg-center-zookeeper/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒã€‹ã€Œ3.1 åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œã€</a>æœ‰è¯¦ç»†åˆ†äº«ã€‚</p></li></ul><hr><p>FailoverLeaderExecutionCallback å›è°ƒé€»è¾‘å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FailoverLeaderExecutionCallback</span> <span class="keyword">implements</span> <span class="title">LeaderExecutionCallback</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">// åˆ¤æ–­éœ€è¦å¤±æ•ˆè½¬ç§»</span></div><div class="line">       <span class="keyword">if</span> (JobRegistry.getInstance().isShutdown(jobName) || !needFailover()) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// è·å¾—ä¸€ä¸ª `$&#123;JOB_NAME&#125;/leader/failover/items/$&#123;ITEM_ID&#125;` ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">       <span class="keyword">int</span> crashedItem = Integer.parseInt(jobNodeStorage.getJobNodeChildrenKeys(FailoverNode.ITEMS_ROOT).get(<span class="number">0</span>));</div><div class="line">       log.debug(<span class="string">"Failover job '&#123;&#125;' begin, crashed item '&#123;&#125;'"</span>, jobName, crashedItem);</div><div class="line">       <span class="comment">// è®¾ç½®è¿™ä¸ª `$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/failover` ä½œä¸šåˆ†ç‰‡é¡¹ ä¸º å½“å‰ä½œä¸šèŠ‚ç‚¹</span></div><div class="line">       jobNodeStorage.fillEphemeralJobNode(FailoverNode.getExecutionFailoverNode(crashedItem), JobRegistry.getInstance().getJobInstance(jobName).getJobInstanceId());</div><div class="line">       <span class="comment">// ç§»é™¤è¿™ä¸ª `$&#123;JOB_NAME&#125;/leader/failover/items/$&#123;ITEM_ID&#125;` ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">       jobNodeStorage.removeJobNodeIfExisted(FailoverNode.getItemsNode(crashedItem));</div><div class="line">       <span class="comment">// TODO ä¸åº”ä½¿ç”¨triggerJob, è€Œæ˜¯ä½¿ç”¨executorç»Ÿä¸€è°ƒåº¦ ç–‘é—®ï¼šä¸ºä»€ä¹ˆè¦ç”¨executorç»Ÿä¸€ï¼Œåé¢ç ”ç©¶ä¸‹</span></div><div class="line">       <span class="comment">// è§¦å‘ä½œä¸šæ‰§è¡Œ</span></div><div class="line">       JobScheduleController jobScheduleController = JobRegistry.getInstance().getJobScheduleController(jobName);</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> != jobScheduleController) &#123;</div><div class="line">           jobScheduleController.triggerJob();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>å†æ¬¡è°ƒç”¨ <code>#needFailover()</code> æ–¹æ³•ï¼Œç¡®ä¿ç»è¿‡åˆ†å¸ƒå¼é”è·å–ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œä»ç„¶éœ€è¦å¤±æ•ˆè½¬ç§»ã€‚å› ä¸ºå¯èƒ½å¤šä¸ªä½œä¸šèŠ‚ç‚¹è°ƒç”¨äº†è¯¥å›è°ƒï¼Œç¬¬ä¸€ä¸ªä½œä¸šèŠ‚ç‚¹æ‰§è¡Œäº†å¤±æ•ˆè½¬ç§»ï¼Œå¯èƒ½ç¬¬äºŒä¸ªä½œä¸šèŠ‚ç‚¹å°±ä¸éœ€è¦æ‰§è¡Œå¤±æ•ˆè½¬ç§»äº†ã€‚</p></li><li><p>è°ƒç”¨ <code>JobNodeStorage#getJobNodeChildrenKeys(FailoverNode.ITEMS_ROOT)#get(0)</code> æ–¹æ³•ï¼Œè·å¾—<strong>ä¸€ä¸ª</strong> <code>${JOB_NAME}/leader/failover/items/${ITEM_ID}</code> ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p><p>è°ƒç”¨ <code>JobNodeStorage#fillEphemeralJobNode(...)</code> æ–¹æ³•ï¼Œè®¾ç½®è¿™ä¸ª<strong>ä¸´æ—¶</strong>æ•°æ®èŠ‚ç‚¹ <code>${JOB_NAME}/sharding/${ITEM_ID}failover</code> ä½œä¸šåˆ†ç‰‡é¡¹ä¸ºå½“å‰ä½œä¸šèŠ‚ç‚¹( <code>${JOB_INSTANCE_ID}</code> )ã€‚</p><p>è°ƒç”¨ <code>JobNodeStorage#removeJobNodeIfExisted(...)</code> æ–¹æ³•ï¼Œç§»é™¤è¿™ä¸ª<code>${JOB_NAME}/leader/failover/items/${ITEM_ID}</code> ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p></li><li><p>è°ƒç”¨ <code>JobScheduleController#triggerJob()</code> æ–¹æ³•ï¼Œç«‹å³å¯åŠ¨ä½œä¸šã€‚è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå®é™…ä½œä¸šä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œä»…ä»…æ˜¯è¿›è¡Œè§¦å‘ã€‚å¦‚æœæœ‰å¤šä¸ªå¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹ï¼Œå¤šæ¬¡è°ƒç”¨ <code>JobScheduleController#triggerJob()</code> æ–¹æ³•ä¼šä¸ä¼šå¯¼è‡´ä½œä¸šæ˜¯<strong>å¹¶è¡Œæ‰§è¡Œ</strong>çš„ï¼Ÿç­”æ¡ˆæ˜¯ä¸ä¼šï¼Œå› ä¸ºä¸€ä¸ªä½œä¸šçš„ Quartz çº¿ç¨‹æ•°è®¾ç½®ä¸º 1ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobScheduler.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> Properties <span class="title">getBaseQuartzProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">   Properties result = <span class="keyword">new</span> Properties();</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.threadCount"</span>, <span class="string">"1"</span>); <span class="comment">// Quartz çº¿ç¨‹æ•°ï¼š1</span></div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><hr><p>å¦‚æœè¯´ä½œä¸šåˆ†ç‰‡é¡¹å®ç°è½¬ç§»æ—¶ï¼Œæ¯ä¸ªä½œä¸šèŠ‚ç‚¹éƒ½ä¸å¤„äºéç©ºé—²çŠ¶æ€ï¼Œå²‚ä¸æ˜¯ FailoverLeaderExecutionCallback ä¸€ç›´æ— æ³•è¢«å›è°ƒï¼Ÿç­”æ¡ˆå½“ç„¶ä¸æ˜¯çš„ã€‚ä½œä¸šåœ¨æ‰§è¡Œå®Œåˆ†é…ç»™è‡ªå·±çš„ä½œä¸šåˆ†ç‰‡é¡¹ï¼Œä¼šè°ƒç”¨ <code>LiteJobFacade#failoverIfNecessary()</code> æ–¹æ³•ï¼Œè¿›è¡Œå¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹æŠ“å–ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ...  çœç•¥æ— å…³ä»£ç </span></div><div class="line">   </div><div class="line">   <span class="comment">// æ‰§è¡Œ æ™®é€šè§¦å‘çš„ä½œä¸š</span></div><div class="line">   execute(shardingContexts, JobExecutionEvent.ExecutionSource.NORMAL_TRIGGER);</div><div class="line">   <span class="comment">// æ‰§è¡Œ è¢«è·³è¿‡è§¦å‘çš„ä½œä¸š</span></div><div class="line">   <span class="keyword">while</span> (jobFacade.isExecuteMisfired(shardingContexts.getShardingItemParameters().keySet())) &#123;</div><div class="line">       jobFacade.clearMisfire(shardingContexts.getShardingItemParameters().keySet());</div><div class="line">       execute(shardingContexts, JobExecutionEvent.ExecutionSource.MISFIRE);</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="comment">// æ‰§è¡Œ ä½œä¸šå¤±æ•ˆè½¬ç§»</span></div><div class="line">   jobFacade.failoverIfNecessary();</div><div class="line">   </div><div class="line">   <span class="comment">// ...  çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failoverIfNecessary</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (configService.load(<span class="keyword">true</span>).isFailover()) &#123;</div><div class="line">       failoverService.failoverIfNecessary();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failoverIfNecessary</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (needFailover()) &#123;</div><div class="line">       jobNodeStorage.executeInLeader(FailoverNode.LATCH, <span class="keyword">new</span> FailoverLeaderExecutionCallback());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>è®©æˆ‘ä»¬åœ¨ç¿»å› JobCrashedJobListener å¤„ä»£ç ï¼Œä¸ºä»€ä¹ˆè·å–å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹æ˜¯è¿™æ ·çš„ä¼˜å…ˆé¡ºåºï¼Ÿä¸€ä¸ªä½œä¸šèŠ‚ç‚¹æ‹¥æœ‰ <code>${JOB_NAME}/sharding/${ITEM_ID}/failover</code> æ•°æ®åˆ†ç‰‡é¡¹ï¼Œæ„å‘³ç€åˆ†é…ç»™å®ƒçš„ä½œä¸šåˆ†ç‰‡é¡¹å·²ç»æ‰§è¡Œå®Œæˆï¼Œå¦åˆ™æ€ä¹ˆå›è°ƒ FailoverLeaderExecutionCallback æ–¹æ³•ï¼ŒæŠ“å–å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹å‘¢ï¼Ÿï¼</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_11_07/02.png" alt=""></p><p>æ—ç™½å›ï¼šåŒå‡»666ï¼Œå…³æ³¨ç¬”è€…å…¬ä¼—å·ä¸€æ³¢ã€‚</p><h1>4. è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</h1><p>åœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹ã€Œ4.2 è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡ã€</a>ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä½œä¸šæ‰§è¡Œå™¨( AbstractElasticJobExecutor ) æ‰§è¡Œä½œä¸šæ—¶ï¼Œä¼šè·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡è¿›è¡Œæ‰§è¡Œã€‚è·å–è¿‡ç¨‹æ€»ä½“å¦‚ä¸‹é¡ºåºå›¾( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_11_07/03.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_11_07/03.png" alt=""></p><ul><li>çº¢è‰²å‰å‰åœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a>æœ‰è¯¦ç»†åˆ†äº«ã€‚</li></ul><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ShardingContexts <span class="title">getShardingContexts</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å¾— å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">   <span class="keyword">boolean</span> isFailover = configService.load(<span class="keyword">true</span>).isFailover();</div><div class="line">   <span class="keyword">if</span> (isFailover) &#123;</div><div class="line">       List&lt;Integer&gt; failoverShardingItems = failoverService.getLocalFailoverItems();</div><div class="line">       <span class="keyword">if</span> (!failoverShardingItems.isEmpty()) &#123;</div><div class="line">           <span class="comment">// ã€å¿½ç•¥ï¼Œä½œä¸šåˆ†ç‰‡è¯¦è§£ã€‘è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨åˆ†ç‰‡ä¸Šä¸‹æ–‡</span></div><div class="line">           <span class="keyword">return</span> executionContextService.getJobShardingContext(failoverShardingItems);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ã€å¿½ç•¥ï¼Œä½œä¸šåˆ†ç‰‡è¯¦è§£ã€‘ä½œä¸šåˆ†ç‰‡ï¼Œå¦‚æœéœ€è¦åˆ†ç‰‡ä¸”å½“å‰èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹</span></div><div class="line">   shardingService.shardingIfNecessary();</div><div class="line">   <span class="comment">// ã€å¿½ç•¥ï¼Œä½œä¸šåˆ†ç‰‡è¯¦è§£ã€‘è·å¾— åˆ†é…åœ¨æœ¬æœºçš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">   List&lt;Integer&gt; shardingItems = shardingService.getLocalShardingItems();</div><div class="line">   <span class="comment">// ç§»é™¤ åˆ†é…åœ¨æœ¬æœºçš„å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹ç›®</span></div><div class="line">   <span class="keyword">if</span> (isFailover) &#123;</div><div class="line">       shardingItems.removeAll(failoverService.getLocalTakeOffItems());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç§»é™¤ è¢«ç¦ç”¨çš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">   shardingItems.removeAll(executionService.getDisabledItems(shardingItems));</div><div class="line">   <span class="comment">// ã€å¿½ç•¥ï¼Œä½œä¸šåˆ†ç‰‡è¯¦è§£ã€‘è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨åˆ†ç‰‡ä¸Šä¸‹æ–‡</span></div><div class="line">   <span class="keyword">return</span> executionContextService.getJobShardingContext(shardingItems);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>FailoverService#getLocalFailoverItems()</code> æ–¹æ³•ï¼Œè·å–è¿è¡Œåœ¨æœ¬ä½œä¸šèŠ‚ç‚¹çš„å¤±æ•ˆè½¬ç§»åˆ†ç‰‡é¡¹é›†åˆã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getLocalFailoverItems</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (JobRegistry.getInstance().isShutdown(jobName)) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> getFailoverItems(JobRegistry.getInstance().getJobInstance(jobName).getJobInstanceId()); <span class="comment">// `$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/failover`</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>è°ƒç”¨ <code>ExecutionContextService#getJobShardingContext()</code> æ–¹æ³•ï¼Œè·å–å½“å‰ä½œä¸šæœåŠ¡å™¨åˆ†ç‰‡ä¸Šä¸‹æ–‡ã€‚åœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹ã€Œ4. è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆã€</a>æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>å½“æœ¬ä½œä¸šèŠ‚ç‚¹ä¸å­˜åœ¨æŠ“å–çš„å¤±æ•ˆè½¬ç§»åˆ†ç‰‡é¡¹ï¼Œåˆ™è·å¾—åˆ†é…ç»™æœ¬ä½œä¸šåˆ†è§£çš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚æ­¤æ—¶ä½ ä¼šçœ‹åˆ°ç•¥å¥‡æ€ªçš„æ–¹æ³•è°ƒç”¨ï¼Œ<code>shardingItems.removeAll(failoverService.getLocalTakeOffItems())</code>ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼Œä½œä¸šèŠ‚ç‚¹AæŒæœ‰ä½œä¸šåˆ†ç‰‡é¡¹[0, 1]ï¼Œæ­¤æ—¶å¼‚å¸¸æ–­ç½‘ï¼Œå¯¼è‡´[0, 1]è¢«ä½œä¸šèŠ‚ç‚¹Bå¤±æ•ˆè½¬ç§»æŠ“å–ï¼Œæ­¤æ—¶è‹¥ä½œä¸šèŠ‚ç‚¹Aæ¢å¤ï¼Œä½œä¸šåˆ†ç‰‡é¡¹[0, 1]ä¾ç„¶å±äºä½œä¸šèŠ‚ç‚¹Aï¼Œä½†æ˜¯å¯èƒ½å·²ç»åœ¨ä½œä¸šèŠ‚ç‚¹Bæ‰§è¡Œï¼Œå› æ­¤éœ€è¦è¿›è¡Œç§»é™¤ï¼Œé¿å…å¤šèŠ‚ç‚¹è¿è¡Œç›¸åŒçš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚<code>FailoverService#getLocalTakeOffItems()</code> æ–¹æ³•å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å–è¿è¡Œåœ¨æœ¬ä½œä¸šæœåŠ¡å™¨çš„è¢«å¤±æ•ˆè½¬ç§»çš„åºåˆ—å·.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> è¿è¡Œåœ¨æœ¬ä½œä¸šæœåŠ¡å™¨çš„è¢«å¤±æ•ˆè½¬ç§»çš„åºåˆ—å·</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getLocalTakeOffItems</span><span class="params">()</span> </span>&#123;</div><div class="line">   List&lt;Integer&gt; shardingItems = shardingService.getLocalShardingItems();</div><div class="line">   List&lt;Integer&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(shardingItems.size());</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingItems) &#123;</div><div class="line">       <span class="keyword">if</span> (jobNodeStorage.isJobNodeExisted(FailoverNode.getExecutionFailoverNode(each))) &#123;</div><div class="line">           result.add(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h1>5. ç›‘å¬ä½œä¸šå¤±æ•ˆè½¬ç§»åŠŸèƒ½å…³é—­</h1><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FailoverSettingsChangedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">        </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (configNode.isConfigPath(path) &amp;&amp; Type.NODE_UPDATED == eventType</div><div class="line">               &amp;&amp; !LiteJobConfigurationGsonFactory.fromJson(data).isFailover()) &#123; <span class="comment">// å…³é—­å¤±æ•ˆè½¬ç§»åŠŸèƒ½</span></div><div class="line">           failoverService.removeFailoverInfo();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h1>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šå•Šå•Šå•Šï¼Œæœ‰ç‚¹ç»•ã€‚<br>èŠ‹é“å›ï¼šè€å¿ƒï¼Œè€å¿ƒï¼Œè€å¿ƒã€‚</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_11_07/04.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š&lt;/p&gt;
&lt;ol&gt;
      
    
    </summary>
    
      <category term="Elastic-Job-Lite" scheme="http://www.iocoder.cn/categories/Elastic-Job-Lite/"/>
    
    
  </entry>
  
</feed>
