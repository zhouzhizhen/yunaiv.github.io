<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</title>
  <subtitle>æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.yunai.me/"/>
  <updated>2017-08-29T04:52:39.000Z</updated>
  <id>http://www.yunai.me/</id>
  
  <author>
    <name>ç‹æ–‡æ–Œ</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>é—²èŠå¦‚ä½•é˜…è¯»æºç ï¼ˆéŸ³é¢‘ï¼‰</title>
    <link href="http://www.yunai.me/Architecture/how-to-read-source-code/"/>
    <id>http://www.yunai.me/Architecture/how-to-read-source-code/</id>
    <published>2017-12-01T16:00:00.000Z</published>
    <updated>2017-08-29T04:52:39.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0-ä»é›¶å¼€å§‹"><a href="#0-ä»é›¶å¼€å§‹" class="headerlink" title="0. ä»é›¶å¼€å§‹"></a>0. ä»é›¶å¼€å§‹</h1><p>è§†é¢‘ï¼š</p>
<iframe frameborder="0" width="640" height="498" src="https://v.qq.com/iframe/player.html?vid=p0543tzm648&tiny=0&auto=0" allowfullscreen></iframe>

<p>è¯·å…³æ³¨ç¬”è€…çš„å…¬ä¼—å·ï¼šèŠ‹é“æºç </p>
<ul>
<li>ä¸“æ³¨æºç è§£æä¸‰åå¹´ï¼</li>
<li>ä¸“æ³¨æºç è§£æä¸‰åå¹´ï¼</li>
<li>ä¸“æ³¨æºç è§£æä¸‰åå¹´ï¼</li>
<li><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></li>
</ul>
<h1 id="1-è°ƒè¯•"><a href="#1-è°ƒè¯•" class="headerlink" title="1. è°ƒè¯•"></a>1. è°ƒè¯•</h1><p>é€šè¿‡ IDE å·¥å…·<strong>è°ƒè¯•</strong>çš„æ–¹å¼é˜…è¯»æºç ã€‚</p>
<h2 id="1-1-Elastic-Job"><a href="#1-1-Elastic-Job" class="headerlink" title="1.1 Elastic-Job"></a>1.1 Elastic-Job</h2><ul>
<li>GitHubåœ°å€ï¼š<a href="https://github.com/dangdangdotcom/elastic-job" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/dangdangdotcom/elastic-job</a><ul>
<li>å¼€æºä¸æ˜“ï¼Œè¯·ç‚¹ Star æ”¯æŒã€‚</li>
<li>ä¸ªäºº Forkï¼Œå¢åŠ éƒ¨åˆ†ä¸­æ–‡æ³¨é‡Š GitHubåœ°å€ï¼š<a href="https://github.com/YunaiV/elastic-job" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/YunaiV/elastic-job</a></li>
</ul>
</li>
<li>ä¸ºä»€ä¹ˆé˜…è¯» Elastic-Job æºç ï¼Ÿï¼š<a href="http://www.yunai.me/Elastic-Job/why-read-Elastic-Job-source-code/">http://www.yunai.me/Elastic-Job/why-read-Elastic-Job-source-code/</a></li>
<li>è°ƒè¯•æ–¹å¼ï¼š<code>com.dangdang.ddframe.job.example.JavaMain</code> ç›´æ¥ DEBUG å³å¯ã€‚</li>
</ul>
<h2 id="1-2-Sharding-JDBC"><a href="#1-2-Sharding-JDBC" class="headerlink" title="1.2 Sharding-JDBC"></a>1.2 Sharding-JDBC</h2><ul>
<li>GitHubåœ°å€ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/dangdangdotcom/sharding-jdbc</a><ul>
<li>å¼€æºä¸æ˜“ï¼Œè¯·ç‚¹ Star æ”¯æŒã€‚</li>
<li>ä¸ªäºº Forkï¼Œå¢åŠ éƒ¨åˆ†ä¸­æ–‡æ³¨é‡Š GitHubåœ°å€ï¼š<a href="https://github.com/YunaiV/sharding-jdbc" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/YunaiV/sharding-jdbc</a><ul>
<li>åŸºäº Sharding-JDBC V1.5.1 ç‰ˆæœ¬ï¼Œå»ºè®®é˜…è¯»æœ€æ–°ç‰ˆæœ¬ä»£ç ï¼Œæˆ‘çš„å¯ä»¥ä½œä¸ºæ³¨é‡Šè¡¥å……ã€‚ </li>
</ul>
</li>
</ul>
</li>
<li>ä¸ºä»€ä¹ˆé˜…è¯» Sharding-JDBC æºç ï¼Ÿï¼š<a href="http://www.yunai.me/Sharding-JDBC/why-read-Sharding-JDBC-source-code/">http://www.yunai.me/Sharding-JDBC/why-read-Sharding-JDBC-source-code/</a></li>
<li>è°ƒè¯•æ–¹å¼ï¼š<code>com.dangdang.ddframe.rdb.sharding.example.jdbc.Main</code> é…ç½®æ•°æ®æºåå¯ä»¥ DEBUGã€‚</li>
<li>æ‹†è§£å›¾ï¼š<img src="http://www.yunai.me/images/Architecture/2017_12_02/01.png" alt=""></li>
</ul>
<h2 id="1-3-MyCAT"><a href="#1-3-MyCAT" class="headerlink" title="1.3 MyCAT"></a>1.3 MyCAT</h2><ul>
<li>GitHubåœ°å€ï¼š<a href="https://github.com/MyCATApache/Mycat-Server" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/MyCATApache/Mycat-Server</a><ul>
<li>å¼€æºä¸æ˜“ï¼Œè¯·ç‚¹ Star æ”¯æŒã€‚</li>
<li>ä¸ªäºº Forkï¼Œå¢åŠ éƒ¨åˆ†ä¸­æ–‡æ³¨é‡Š GitHubåœ°å€ï¼š<a href="https://github.com/YunaiV/Mycat-Server" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/YunaiV/Mycat-Server</a></li>
</ul>
</li>
<li>ä¸ºä»€ä¹ˆé˜…è¯» MyCAT æºç ï¼Ÿï¼š<a href="http://www.yunai.me/MyCAT/why-read-MyCAT-source-code/">http://www.yunai.me/MyCAT/why-read-MyCAT-source-code/</a></li>
<li>è°ƒè¯•æ–¹å¼ï¼š<a href="http://www.yunai.me/MyCAT/build-debugging-environment/">http://www.yunai.me/MyCAT/build-debugging-environment/</a></li>
</ul>
<h2 id="1-4-RocketMQ"><a href="#1-4-RocketMQ" class="headerlink" title="1.4 RocketMQ"></a>1.4 RocketMQ</h2><ul>
<li>GitHubåœ°å€ï¼š<a href="https://github.com/apache/incubator-rocketmq" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/apache/incubator-rocketmq</a><ul>
<li>å¼€æºä¸æ˜“ï¼Œè¯·ç‚¹ Star æ”¯æŒã€‚</li>
<li>ä¸ªäºº Forkï¼Œå¢åŠ éƒ¨åˆ†ä¸­æ–‡æ³¨é‡Š GitHubåœ°å€ï¼š<a href="https://github.com/YunaiV/incubator-rocketmq" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/YunaiV/incubator-rocketmq</a></li>
</ul>
</li>
<li>ä¸ºä»€ä¹ˆé˜…è¯» RocketMQ æºç ï¼Ÿï¼š<a href="http://www.yunai.me/RocketMQ/why-read-RocketMQ-source-code/">http://www.yunai.me/RocketMQ/why-read-RocketMQ-source-code/</a></li>
<li>è°ƒè¯•æ–¹å¼ï¼šæœ‰ç‚¹æƒ³ä¸èµ·æ¥äº†ã€‚ä»¥åè¡¥å……å“ˆã€‚</li>
</ul>
<h2 id="1-5-è¡¥å……"><a href="#1-5-è¡¥å……" class="headerlink" title="1.5 è¡¥å……"></a>1.5 è¡¥å……</h2><p>å¦‚æœæºç æ¯”è¾ƒå¤šï¼Œä½ ä¸å¤ªæ¸…æ¥šæŒ‰ç…§ä»€ä¹ˆæ ·çš„åŠŸèƒ½é¡ºåºè°ƒè¯•ä¸‹å»ï¼Œå¯ä»¥å‚è€ƒæˆ‘å†™çš„åšå®¢ã€‚è¿™ä¸ªä¸æ˜¯å¹¿å‘Šã€‚ç¡®å®æœ‰æœ‹å‹æ˜¯å¯¹ç…§ç€åšå®¢é¡ºåºè°ƒè¯•çš„ã€‚</p>
<h1 id="2-UMLå›¾"><a href="#2-UMLå›¾" class="headerlink" title="2. UMLå›¾"></a>2. UMLå›¾</h1><p>æ¨èä½¿ç”¨ Astah ç¤¾åŒºç‰ˆã€‚å¯¹çš„ï¼Œä¸è¦è€ƒè™‘ç ´è§£ä¸ç ´è§£çš„ã€‚ç¤¾åŒºç‰ˆï¼Œå¤Ÿï¼</p>
<p>å¦å¤–ï¼Œè¯·ä¸è¦çº ç»“ç”¨ä»€ä¹ˆ UML å·¥å…·ç‰›é€¼ï¼é‡ç‚¹å…ˆè¿ˆå‡ºè°ƒè¯•æºç é‚£ä¸€æ­¥ï¼Œå…¶ä»–çš„ï¼Œæ…¢æ…¢ä¼˜åŒ–ã€‚</p>
<p>æ¨èç”»ä¸¤ç§å›¾ï¼š</p>
<ul>
<li><p>ç±»å›¾ï¼šå¯¹æ•´ä½“ã€æˆ–è€…æŸä¸ªæ¨¡å—ï¼Œæœ‰ç³»ç»Ÿæ€§çš„è®¤è¯†ã€‚</p>
<p>  <img src="http://www.yunai.me/images/Architecture/2017_12_02/02.png" alt=""></p>
</li>
<li><p>é¡ºåºå›¾ï¼šå¯¹æµç¨‹çš„è°ƒç”¨é¡ºåºæœ‰æ•´ä½“çš„è®¤è¯†ï¼Œé¿å…è°ƒè¯•ï¼Œè¶Šè°ƒè¯•è¶Šæ™•ã€‚</p>
<p>  <img src="http://www.yunai.me/images/Architecture/2017_12_02/03.png" alt=""></p>
</li>
</ul>
<p>å¦‚æœä½ ä¸ä¼šç”» UML å›¾ï¼Œç›´æ¥ç›´æ¥ Googleï¼Œä¸è¦å»æ‰¾ä»€ä¹ˆ UML çš„ä¹¦ï¼Œå…ˆå¹²èµ·æ¥ï¼</p>
<p>æ©ï¼Œç¬”è€…ä¸æ’é™¤çœ‹ UML ä¹¦ï¼Œå› ä¸ºï¼Œæˆ‘ä¹Ÿçœ‹è¿‡å‡ æœ¬ï¼Œæ”¶è·ä¸å°ï¼Œå“ˆå“ˆå“ˆå“ˆã€‚</p>
<h1 id="3-è¾“å‡º"><a href="#3-è¾“å‡º" class="headerlink" title="3. è¾“å‡º"></a>3. è¾“å‡º</h1><p>é˜…è¯»æºç ï¼Œä¸å°è¯•è¾“å‡ºï¼Œå°±æ˜¯åœ¨è€æµæ°“ã€‚</p>
<p>æ¨èä¸‰ç§è¾“å‡ºæ–¹å¼ï¼š</p>
<ol>
<li>å†™åšå®¢ã€‚</li>
<li>å›¢é˜Ÿåˆ†äº«ã€‚</li>
<li>é€ å°è½®ã€‚</li>
</ol>
<p>åˆšå¼€å§‹æ¨èå†™åšå®¢ã€‚å¯¹çš„ï¼Œä¸å¤ªå»ºè®®åªå†™è‡ªå·±çœ‹å¾—æ‡‚çš„ç¬”è®°ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;0-ä»é›¶å¼€å§‹&quot;&gt;&lt;a href=&quot;#0-ä»é›¶å¼€å§‹&quot; class=&quot;headerlink&quot; title=&quot;0. ä»é›¶å¼€å§‹&quot;&gt;&lt;/a&gt;0. ä»é›¶å¼€å§‹&lt;/h1&gt;&lt;p&gt;è§†é¢‘ï¼š&lt;/p&gt;
&lt;iframe frameborder=&quot;0&quot; width=&quot;640&quot; height=&quot;
    
    </summary>
    
      <category term="æŠ€æœ¯æ‚æ–‡" scheme="http://www.yunai.me/categories/%E6%8A%80%E6%9C%AF%E6%9D%82%E6%96%87/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šç›‘æ§æœåŠ¡</title>
    <link href="http://www.yunai.me/Elastic-Job/job-monitor/"/>
    <id>http://www.yunai.me/Elastic-Job/job-monitor/</id>
    <published>2017-11-30T16:00:00.000Z</published>
    <updated>2017-08-28T11:04:25.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. MonitorService</a></li>
<li><a href="#">3. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šç›‘æ§æœåŠ¡</strong>ã€‚å†…å®¹å¯¹åº”<a href="http://dangdangdotcom.github.io/elastic-job/elastic-job-lite/02-guide/dump/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” DUMPä½œä¸šè¿è¡Œä¿¡æ¯ã€‹</a>ã€‚</p>
<blockquote>
<p>ä½¿ç”¨Elastic-Job-Liteè¿‡ç¨‹ä¸­å¯èƒ½ä¼šç¢°åˆ°ä¸€äº›åˆ†å¸ƒå¼é—®é¢˜ï¼Œå¯¼è‡´ä½œä¸šè¿è¡Œä¸ç¨³å®šã€‚<br>ç”±äºæ— æ³•åœ¨ç”Ÿäº§ç¯å¢ƒè°ƒè¯•ï¼Œé€šè¿‡dumpå‘½ä»¤å¯ä»¥æŠŠä½œä¸šå†…éƒ¨ç›¸å…³ä¿¡æ¯dumpå‡ºæ¥ï¼Œæ–¹ä¾¿å¼€å‘è€…debugåˆ†æï¼› å¦å¤–ä¸ºäº†ä¸æ³„éœ²éšç§ï¼Œå·²å°†ç›¸å…³ä¿¡æ¯ä¸­çš„ipåœ°å€ä»¥ip1, ip2â€¦çš„å½¢å¼è¿‡æ»¤ï¼Œå¯ä»¥åœ¨äº’è”ç½‘ä¸Šå…¬å¼€ä¼ è¾“ç¯å¢ƒä¿¡æ¯ï¼Œä¾¿äºè¿›ä¸€æ­¥å®Œå–„Elastic-Jobã€‚</p>
</blockquote>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_12_01/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_12_01/01.png" alt=""></p>
<ul>
<li>åœ¨ Elastic-Job-lite é‡Œï¼Œä½œä¸šç›‘æ§æœåŠ¡( MonitorService ) å®ç°äº†<strong>DUMPä½œä¸šè¿è¡Œä¿¡æ¯</strong>åŠŸèƒ½ã€‚</li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-MonitorService"><a href="#2-MonitorService" class="headerlink" title="2. MonitorService"></a>2. MonitorService</h1><p>MonitorServiceï¼Œä½œä¸šç›‘æ§æœåŠ¡ã€‚</p>
<p><strong>åˆå§‹åŒ– MonitorService æ–¹æ³•å®ç°å¦‚ä¸‹</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MonitorService.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> port = configService.load(<span class="keyword">true</span>).getMonitorPort();</div><div class="line">   <span class="keyword">if</span> (port &lt; <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       log.info(<span class="string">"Elastic job: Monitor service is running, the port is '&#123;&#125;'"</span>, port);</div><div class="line">       openSocketForMonitor(port);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException ex) &#123;</div><div class="line">       log.error(<span class="string">"Elastic job: Monitor service listen failure, error is: "</span>, ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">openSocketForMonitor</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> port)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">   serverSocket = <span class="keyword">new</span> ServerSocket(port);</div><div class="line">   <span class="keyword">new</span> Thread() &#123;</div><div class="line">       </div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">           <span class="keyword">while</span> (!closed) &#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   process(serverSocket.accept());</div><div class="line">               &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException ex) &#123;</div><div class="line">                   log.error(<span class="string">"Elastic job: Monitor service open socket for monitor failure, error is: "</span>, ex);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>åœ¨ä½œä¸šé…ç½®çš„ç›‘æ§æœåŠ¡ç«¯å£å±æ€§( <code>LiteJobConfiguration.monitorPort</code> )å¯åŠ¨ <strong>ServerSocket</strong>ã€‚ä¸€ä¸ªä½œä¸šå¯¹åº”ä¸€ä¸ªä½œä¸šç›‘æ§ç«¯å£ï¼Œæ‰€ä»¥é…ç½®æ—¶ï¼Œè¯·ä¸è¦é‡å¤ç«¯å£å™¢ã€‚</li>
</ul>
<p><strong>å¤„ç† dumpå‘½ä»¤ æ–¹æ³•å¦‚ä¸‹</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MonitorService.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> Socket socket)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">   <span class="keyword">try</span> (</div><div class="line">           BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(socket.getInputStream()));</div><div class="line">           BufferedWriter writer = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(socket.getOutputStream()));</div><div class="line">           Socket autoCloseSocket = socket) &#123;</div><div class="line">       <span class="comment">// è¯»å–å‘½ä»¤</span></div><div class="line">       String cmdLine = reader.readLine();</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> != cmdLine &amp;&amp; DUMP_COMMAND.equalsIgnoreCase(cmdLine)) &#123; <span class="comment">// DUMP</span></div><div class="line">           List&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">           dumpDirectly(<span class="string">"/"</span> + jobName, result);</div><div class="line">           outputMessage(writer, Joiner.on(<span class="string">"\n"</span>).join(SensitiveInfoUtils.filterSensitiveIps(result)) + <span class="string">"\n"</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#process()</code> æ–¹æ³•ï¼Œç›®å‰åªæ”¯æŒ <code>DUMP</code> å‘½ä»¤ã€‚å¦‚æœä½ æœ‰è‡ªå®šä¹‰å‘½ä»¤çš„éœ€è¦ï¼Œå¯ä»¥æ‹“å±•è¯¥æ–¹æ³•ã€‚</li>
<li><p>è°ƒç”¨ <code>#dumpDirectly()</code> æ–¹æ³•ï¼Œè¾“å‡ºå½“å‰ä½œä¸šåå¯¹åº”çš„ç›¸å…³è°ƒè¯•ä¿¡æ¯ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dumpDirectly</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> List&lt;String&gt; result)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (String each : regCenter.getChildrenKeys(path)) &#123;</div><div class="line">       String zkPath = path + <span class="string">"/"</span> + each;</div><div class="line">       String zkValue = regCenter.get(zkPath);</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> == zkValue) &#123;</div><div class="line">           zkValue = <span class="string">""</span>;</div><div class="line">       &#125;</div><div class="line">       TreeCache treeCache = (TreeCache) regCenter.getRawCache(<span class="string">"/"</span> + jobName);</div><div class="line">       ChildData treeCacheData = treeCache.getCurrentData(zkPath);</div><div class="line">       String treeCachePath =  <span class="keyword">null</span> == treeCacheData ? <span class="string">""</span> : treeCacheData.getPath();</div><div class="line">       String treeCacheValue = <span class="keyword">null</span> == treeCacheData ? <span class="string">""</span> : <span class="keyword">new</span> String(treeCacheData.getData());</div><div class="line">       <span class="comment">// åˆ¤æ–­ TreeCacheç¼“å­˜ å’Œ æ³¨å†Œä¸­å¿ƒ æ•°æ®ä¸€è‡´</span></div><div class="line">       <span class="keyword">if</span> (zkValue.equals(treeCacheValue) &amp;&amp; zkPath.equals(treeCachePath)) &#123;</div><div class="line">           result.add(Joiner.on(<span class="string">" | "</span>).join(zkPath, zkValue));</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           result.add(Joiner.on(<span class="string">" | "</span>).join(zkPath, zkValue, treeCachePath, treeCacheValue));</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// é€’å½’</span></div><div class="line">       dumpDirectly(zkPath, result);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å½“ä½œä¸šæœ¬åœ° <strong>TreeCacheç¼“å­˜</strong> å’Œæ³¨å†Œä¸­å¿ƒæ•°æ®ä¸ä¸€è‡´æ—¶ï¼ŒDUMP å‡º [zkPath, zkValue, treeCachePath, treeCacheValue]ã€‚å½“ç›¸åŒæ—¶ï¼Œåªéœ€ DUMP å‡º [zkPath, zkValue]ï¼Œ<strong>æ–¹ä¾¿çœ‹å‡ºæœ¬åœ°å’Œæ³¨å†Œä¸­å¿ƒæ˜¯å¦å­˜åœ¨æ•°æ®å·®å¼‚ã€‚</strong></li>
</ul>
</li>
<li><p>DUMP ä¿¡æ¯ä¾‹å­å¦‚ä¸‹ï¼š</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">Yunai-MacdeMacBook-Pro-2:elastic-job yunai$ <span class="built_in">echo</span> <span class="string">"dump"</span> | nc 127.0.0.1 10024</div><div class="line">/javaSimpleJob/sharding | </div><div class="line">/javaSimpleJob/sharding/2 | </div><div class="line">/javaSimpleJob/sharding/2/instance | ip198@-@5100</div><div class="line">/javaSimpleJob/sharding/1 | </div><div class="line">/javaSimpleJob/sharding/1/instance | ip198@-@5100</div><div class="line">/javaSimpleJob/sharding/0 | </div><div class="line">/javaSimpleJob/sharding/0/instance | ip198@-@5100</div><div class="line">/javaSimpleJob/servers | </div><div class="line">/javaSimpleJob/servers/ip2 | </div><div class="line">/javaSimpleJob/servers/ip198 | </div><div class="line">/javaSimpleJob/leader | </div><div class="line">/javaSimpleJob/leader/sharding | </div><div class="line">/javaSimpleJob/leader/failover | </div><div class="line">/javaSimpleJob/leader/failover/latch | </div><div class="line">/javaSimpleJob/leader/failover/items | </div><div class="line">/javaSimpleJob/leader/election | </div><div class="line">/javaSimpleJob/leader/election/latch | </div><div class="line">/javaSimpleJob/leader/election/instance | ip198@-@5100</div><div class="line">/javaSimpleJob/instances | </div><div class="line">/javaSimpleJob/instances/ip198@-@5100 | </div><div class="line">/javaSimpleJob/config | &#123;<span class="string">"jobName"</span>:<span class="string">"javaSimpleJob"</span>,<span class="string">"jobClass"</span>:<span class="string">"com.dangdang.ddframe.job.example.job.simple.JavaSimpleJob"</span>,<span class="string">"jobType"</span>:<span class="string">"SIMPLE"</span>,<span class="string">"cron"</span>:<span class="string">"0 0/2 * * * ?"</span>,<span class="string">"shardingTotalCount"</span>:3,<span class="string">"shardingItemParameters"</span>:<span class="string">"0\u003dBeijing,1\u003dShanghai,2\u003dGuangzhou"</span>,<span class="string">"jobParameter"</span>:<span class="string">""</span>,<span class="string">"failover"</span>:<span class="literal">true</span>,<span class="string">"misfire"</span>:<span class="literal">true</span>,<span class="string">"description"</span>:<span class="string">""</span>,<span class="string">"jobProperties"</span>:&#123;<span class="string">"job_exception_handler"</span>:<span class="string">"com.dangdang.ddframe.job.executor.handler.impl.DefaultJobExceptionHandler"</span>,<span class="string">"executor_service_handler"</span>:<span class="string">"com.dangdang.ddframe.job.executor.handler.impl.DefaultExecutorServiceHandler"</span>&#125;,<span class="string">"monitorExecution"</span>:<span class="literal">false</span>,<span class="string">"maxTimeDiffSeconds"</span>:-1,<span class="string">"monitorPort"</span>:10024,<span class="string">"jobShardingStrategyClass"</span>:<span class="string">"com.dangdang.ddframe.job.lite.api.strategy.impl.OdevitySortByNameJobShardingStrategy"</span>,<span class="string">"reconcileIntervalMinutes"</span>:10,<span class="string">"disabled"</span>:<span class="literal">false</span>,<span class="string">"overwrite"</span>:<span class="literal">true</span>&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>èŠ‹é“å›ï¼šæ˜¯æ˜¯æ˜¯ï¼Œå¯¹å¯¹çš„ï¼Œæˆ‘æ°´æ›´å•¦ï¼ğŸ˜†</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_12_01/02.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. MonitorService&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a h
    
    </summary>
    
      <category term="Elastic-Job" scheme="http://www.yunai.me/categories/Elastic-Job/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” è‡ªè¯Šæ–­ä¿®å¤</title>
    <link href="http://www.yunai.me/Elastic-Job/reconcile/"/>
    <id>http://www.yunai.me/Elastic-Job/reconcile/</id>
    <published>2017-11-27T16:00:00.000Z</published>
    <updated>2017-08-28T09:52:42.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ReconcileService</a></li>
<li><a href="#">3. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite è‡ªè¯Šæ–­ä¿®å¤</strong>ã€‚</p>
<blockquote>
<p>åœ¨åˆ†å¸ƒå¼çš„åœºæ™¯ä¸‹ç”±äºç½‘ç»œã€æ—¶é’Ÿç­‰åŸå› ï¼Œå¯èƒ½å¯¼è‡´ Zookeeper çš„æ•°æ®ä¸çœŸå®è¿è¡Œçš„ä½œä¸šäº§ç”Ÿä¸ä¸€è‡´ï¼Œè¿™ç§ä¸ä¸€è‡´é€šè¿‡æ­£å‘çš„æ ¡éªŒæ— æ³•å®Œå…¨é¿å…ã€‚éœ€è¦å¦å¤–å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å®šæ—¶æ ¡éªŒæ³¨å†Œä¸­å¿ƒæ•°æ®ä¸çœŸå®ä½œä¸šçŠ¶æ€çš„ä¸€è‡´æ€§ï¼Œå³ç»´æŒ Elastic-Job çš„<strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ã€‚</p>
</blockquote>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_11_28/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_28/01.png" alt=""></p>
<ul>
<li>åœ¨ Elastic-Job-lite é‡Œï¼Œè°ƒè§£åˆ†å¸ƒå¼ä½œä¸šä¸ä¸€è‡´çŠ¶æ€æœåŠ¡( ReconcileService ) å®ç°äº†<strong>è‡ªè¯Šæ–­ä¿®å¤</strong>åŠŸèƒ½ã€‚</li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-ReconcileService"><a href="#2-ReconcileService" class="headerlink" title="2. ReconcileService"></a>2. ReconcileService</h1><p>ReconcileServiceï¼Œè°ƒè§£åˆ†å¸ƒå¼ä½œä¸šä¸ä¸€è‡´çŠ¶æ€æœåŠ¡ã€‚</p>
<p>ReconcileService ç»§æ‰¿ Google Guava AbstractScheduledService æŠ½è±¡ç±»ï¼Œå®ç° <code>#scheduler()</code>ã€<code>#runOneIteration()</code> æ–¹æ³•ï¼Œè¾¾åˆ°<strong>å‘¨æœŸæ€§</strong>æ ¡éªŒæ³¨å†Œä¸­å¿ƒæ•°æ®ä¸çœŸå®ä½œä¸šçŠ¶æ€çš„ä¸€è‡´æ€§ã€‚</p>
<p><strong><code>#scheduler()</code> æ–¹æ³•å®ç°å¦‚ä¸‹</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ReconcileService.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Scheduler <span class="title">scheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> Scheduler.newFixedDelaySchedule(<span class="number">0</span>, <span class="number">1</span>, TimeUnit.MINUTES);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ¯ 1 åˆ†é’Ÿä¼šè°ƒç”¨ä¸€æ¬¡ <code>#runOneIteration()</code> æ–¹æ³•è¿›è¡Œæ ¡éªŒã€‚</li>
<li>Google Guava AbstractScheduledService ç›¸å…³çš„çŸ¥è¯†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·± Google å­¦ä¹ å“Ÿã€‚</li>
</ul>
<p><strong><code>#runOneIteration()</code> æ–¹æ³•å®ç°å¦‚ä¸‹</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ReconcileService.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">runOneIteration</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">   LiteJobConfiguration config = configService.load(<span class="keyword">true</span>);</div><div class="line">   <span class="keyword">int</span> reconcileIntervalMinutes = <span class="keyword">null</span> == config ? -<span class="number">1</span> : config.getReconcileIntervalMinutes();</div><div class="line">   <span class="keyword">if</span> (reconcileIntervalMinutes &gt; <span class="number">0</span> &amp;&amp; (System.currentTimeMillis() - lastReconcileTime &gt;= reconcileIntervalMinutes * <span class="number">60</span> * <span class="number">1000</span>)) &#123; <span class="comment">// æ ¡éªŒæ˜¯å¦è¾¾åˆ°æ ¡éªŒå‘¨æœŸ</span></div><div class="line">       <span class="comment">// è®¾ç½®æœ€åæ ¡éªŒæ—¶é—´</span></div><div class="line">       lastReconcileTime = System.currentTimeMillis();</div><div class="line">       <span class="keyword">if</span> (leaderService.isLeaderUntilBlock() <span class="comment">// ä¸»ä½œä¸šèŠ‚ç‚¹æ‰å¯ä»¥æ‰§è¡Œ</span></div><div class="line">               &amp;&amp; !shardingService.isNeedSharding() <span class="comment">// å½“å‰ä½œä¸šä¸éœ€è¦é‡æ–°åˆ†ç‰‡</span></div><div class="line">               &amp;&amp; shardingService.hasShardingInfoInOfflineServers()) &#123; <span class="comment">// æŸ¥è¯¢æ˜¯åŒ…å«æœ‰åˆ†ç‰‡èŠ‚ç‚¹çš„ä¸åœ¨çº¿æœåŠ¡å™¨</span></div><div class="line">           log.warn(<span class="string">"Elastic Job: job status node has inconsistent value,start reconciling..."</span>);</div><div class="line">           <span class="comment">// è®¾ç½®éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°</span></div><div class="line">           shardingService.setReshardingFlag();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>é€šè¿‡ä½œä¸šé…ç½®ï¼Œè®¾ç½®<strong>ä¿®å¤ä½œä¸šæœåŠ¡å™¨ä¸ä¸€è‡´çŠ¶æ€æœåŠ¡è°ƒåº¦é—´éš”æ—¶é—´</strong>å±æ€§( <code>LiteJobConfiguration.reconcileIntervalMinutes</code> )ã€‚</li>
<li>è°ƒç”¨ <code>ShardingService#setReshardingFlag()</code> æ–¹æ³•ï¼Œè®¾ç½®éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°ã€‚è¿™ä¸ªä¹Ÿæ˜¯ ReconcileService æœ€æœ¬è´¨çš„è¡Œä¸ºï¼Œæœ‰äº†è¿™ä¸ªæ ‡è®°åï¼Œä½œä¸šä¼šé‡æ–°è¿›è¡Œåˆ†ç‰‡ï¼Œ<strong>è¾¾åˆ°ä½œä¸šèŠ‚ç‚¹æœ¬åœ°åˆ†ç‰‡æ•°æ®ä¸ Zookeeper æ•°æ®ä¸€è‡´</strong>ã€‚ä½œä¸šåˆ†ç‰‡é€»è¾‘ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li>
<li><p>è°ƒè§£åˆ†å¸ƒå¼ä½œä¸šä¸ä¸€è‡´çŠ¶æ€æœåŠ¡ä¸€å…±æœ‰ä¸‰ä¸ªæ¡ä»¶ï¼š</p>
<ul>
<li>è°ƒç”¨ <code>LeaderService#isLeaderUntilBlock()</code> æ–¹æ³•ï¼Œåˆ¤æ–­å½“å‰ä½œä¸šèŠ‚ç‚¹æ˜¯å¦ä¸ºä¸»èŠ‚ç‚¹ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/election/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li>
<li>è°ƒç”¨ <code>ShardingService#isNeedSharding()</code> æ–¹æ³•ï¼Œåˆ¤æ–­å½“å‰ä½œä¸šæ˜¯å¦éœ€è¦é‡åˆ†ç‰‡ã€‚å¦‚æœéœ€è¦é‡æ–°åˆ†ç‰‡ï¼Œå°±ä¸è¦é‡å¤è®¾ç½®å½“å‰ä½œä¸šéœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°ã€‚</li>
<li><p>è°ƒç”¨ <code>ShardingService#hasShardingInfoInOfflineServers()</code> æ–¹æ³•ï¼ŒæŸ¥è¯¢æ˜¯å¦åŒ…å«æœ‰åˆ†ç‰‡èŠ‚ç‚¹çš„ä¸åœ¨çº¿æœåŠ¡å™¨ã€‚<strong>æ°¸ä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${JOB_NAME}/sharding/${ITEM_INDEX}/instance</code> å­˜å‚¨åˆ†é…çš„ä½œä¸šèŠ‚ç‚¹ä¸»é”®( <code>${JOB_INSTANCE_ID}</code> )ï¼Œ <strong>ä¸ä¼š</strong>éšç€ä½œä¸šèŠ‚ç‚¹å› ä¸ºå„ç§åŸå› æ–­å¼€åä¼šè¯è¶…æ—¶ç§»é™¤ï¼Œè€Œ<strong>ä¸´æ—¶</strong>æ•°æ®èŠ‚ç‚¹<code>/${JOB_NAME}/instances/${JOB_INSTANCE_ID}</code> <strong>ä¼š</strong>éšç€ä½œä¸šèŠ‚ç‚¹å› ä¸ºå„ç§åŸå› æ–­å¼€åè¶…æ—¶ä¼šè¯è¶…æ—¶ç§»é™¤ã€‚å½“æŸ¥è¯¢åˆ°åŒ…å«æœ‰åˆ†ç‰‡èŠ‚ç‚¹çš„ä¸åœ¨çº¿çš„ä½œä¸šèŠ‚ç‚¹ï¼Œè®¾ç½®éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°åè¿›è¡Œé‡æ–°åˆ†ç‰‡ï¼Œå°†å…¶æŒæœ‰çš„ä½œä¸šåˆ†ç‰‡åˆ†é…ç»™å…¶å®ƒåœ¨çº¿çš„ä½œä¸šèŠ‚ç‚¹ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingService.java</span></div><div class="line"> <span class="comment">/**</span></div><div class="line"> * æŸ¥è¯¢æ˜¯åŒ…å«æœ‰åˆ†ç‰‡èŠ‚ç‚¹çš„ä¸åœ¨çº¿æœåŠ¡å™¨.</div><div class="line"> * </div><div class="line"> * <span class="doctag">@return</span> æ˜¯åŒ…å«æœ‰åˆ†ç‰‡èŠ‚ç‚¹çš„ä¸åœ¨çº¿æœåŠ¡å™¨</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasShardingInfoInOfflineServers</span><span class="params">()</span> </span>&#123;</div><div class="line">    List&lt;String&gt; onlineInstances = jobNodeStorage.getJobNodeChildrenKeys(InstanceNode.ROOT); <span class="comment">// `/$&#123;JOB_NAME&#125;/instances/$&#123;JOB_INSTANCE_ID&#125;`</span></div><div class="line">    <span class="keyword">int</span> shardingTotalCount = configService.load(<span class="keyword">true</span>).getTypeConfig().getCoreConfig().getShardingTotalCount();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shardingTotalCount; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (!onlineInstances.contains(jobNodeStorage.getJobNodeData(ShardingNode.getInstanceNode(i)))) &#123; <span class="comment">// `/$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_INDEX&#125;/instance`</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>èŠ‹é“å›ï¼šã€åŠ¨ä½œï¼šä¸€è„šè¸¢å¼€æ—ç™½å›ã€‘ï¼Œè¿™æ˜¯å¯¹å‰é¢è§£æçš„ä¸»èŠ‚ç‚¹é€‰ä¸¾å’Œä½œä¸šåˆ†ç‰‡çš„å¤ä¹ ï¼ä¸æ˜¯æ°´æ›´ï¼<br>æ—ç™½å›ï¼šä½ æ‰¿è®¤æ°´â€¦ã€åŠ¨ä½œï¼šèŠ‹é“å›åˆæ¥ä¸€è®°åƒå¹´æ€ã€‘</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_28/02.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ReconcileService&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a
    
    </summary>
    
      <category term="Elastic-Job" scheme="http://www.yunai.me/categories/Elastic-Job/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šç›‘å¬å™¨</title>
    <link href="http://www.yunai.me/Elastic-Job/job-listener/"/>
    <id>http://www.yunai.me/Elastic-Job/job-listener/</id>
    <published>2017-11-20T16:00:00.000Z</published>
    <updated>2017-08-28T05:05:42.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ElasticJobListener</a></li>
<li><a href="#">3. AbstractDistributeOnceElasticJobListener</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šç›‘å¬å™¨</strong>ã€‚</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_11_21/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_21/01.png" alt=""></p>
<ul>
<li>ç»¿è‰²<strong>ç›‘å¬å™¨</strong>æ¥å£ ElasticJobListenerï¼Œæ¯å°ä½œä¸šèŠ‚ç‚¹å‡æ‰§è¡Œã€‚</li>
<li>ç²‰è‰²<strong>ç›‘å¬å™¨</strong>æ¥å£ AbstractDistributeOnceElasticJobListenerï¼Œåˆ†å¸ƒå¼åœºæ™¯ä¸­ä»…å•ä¸€èŠ‚ç‚¹æ‰§è¡Œã€‚</li>
<li>è“è‰²ç±»åœ¨ <code>com.dangdang.ddframe.job.lite.internal.guarantee</code> é‡Œï¼Œä¿è¯åˆ†å¸ƒå¼ä»»åŠ¡å…¨éƒ¨å¼€å§‹å’Œç»“æŸçŠ¶æ€ã€‚ AbstractDistributeOnceElasticJobListener é€šè¿‡ <code>guarantee</code> åŠŸèƒ½ï¼Œå®ç°åˆ†å¸ƒå¼åœºæ™¯ä¸­ä»…å•ä¸€èŠ‚ç‚¹æ‰§è¡Œã€‚</li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-ElasticJobListener"><a href="#2-ElasticJobListener" class="headerlink" title="2. ElasticJobListener"></a>2. ElasticJobListener</h1><p>ElasticJobListenerï¼Œä½œä¸šç›‘å¬å™¨æ¥å£ï¼Œ<strong>æ¯å°ä½œä¸šèŠ‚ç‚¹å‡æ‰§è¡Œ</strong>ã€‚</p>
<blockquote>
<p>è‹¥ä½œä¸šå¤„ç†ä½œä¸šæœåŠ¡å™¨çš„æ–‡ä»¶ï¼Œå¤„ç†å®Œæˆååˆ é™¤æ–‡ä»¶ï¼Œå¯è€ƒè™‘ä½¿ç”¨æ¯ä¸ªèŠ‚ç‚¹å‡æ‰§è¡Œæ¸…ç†ä»»åŠ¡ã€‚æ­¤ç±»å‹ä»»åŠ¡å®ç°ç®€å•ï¼Œä¸”æ— éœ€è€ƒè™‘å…¨å±€åˆ†å¸ƒå¼ä»»åŠ¡æ˜¯å¦å®Œæˆï¼Œè¯·å°½é‡ä½¿ç”¨æ­¤ç±»å‹ç›‘å¬å™¨ã€‚</p>
</blockquote>
<p>æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ElasticJobListener</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šæ‰§è¡Œå‰çš„æ‰§è¡Œçš„æ–¹æ³•.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">beforeJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span></span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šæ‰§è¡Œåçš„æ‰§è¡Œçš„æ–¹æ³•.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">afterJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è°ƒç”¨æ‰§è¡Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ...çœç•¥æ— å…³ä»£ç </span></div><div class="line">   </div><div class="line">   <span class="comment">// æ‰§è¡Œ ä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       jobFacade.beforeJobExecuted(shardingContexts);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable cause) &#123;</div><div class="line">       jobExceptionHandler.handleException(jobName, cause);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ...çœç•¥æ— å…³ä»£ç ï¼ˆæ‰§è¡Œ æ™®é€šè§¦å‘çš„ä½œä¸šï¼‰</span></div><div class="line">   <span class="comment">// ...çœç•¥æ— å…³ä»£ç ï¼ˆæ‰§è¡Œ è¢«è·³è¿‡è§¦å‘çš„ä½œä¸šï¼‰</span></div><div class="line">   <span class="comment">// ...çœç•¥æ— å…³ä»£ç ï¼ˆæ‰§è¡Œ ä½œä¸šå¤±æ•ˆè½¬ç§»ï¼‰</span></div><div class="line">   </div><div class="line">   <span class="comment">// ...æ‰§è¡Œ ä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       jobFacade.afterJobExecuted(shardingContexts);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable cause) &#123;</div><div class="line">       jobExceptionHandler.handleException(jobName, cause);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>JobFacade å¯¹ä½œä¸šç›‘å¬å™¨ç®€å•å°è£…è¿›è¡Œè°ƒç”¨ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (ElasticJobListener each : elasticJobListeners) &#123;</div><div class="line">       each.beforeJobExecuted(shardingContexts);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (ElasticJobListener each : elasticJobListeners) &#123;</div><div class="line">       each.afterJobExecuted(shardingContexts);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>ä¸‹æ–‡æåˆ°çš„ AbstractDistributeOnceElasticJobListenerï¼Œä¹Ÿæ˜¯è¿™ä¹ˆè°ƒç”¨ã€‚</p>
</li>
</ul>
<h1 id="3-AbstractDistributeOnceElasticJobListener"><a href="#3-AbstractDistributeOnceElasticJobListener" class="headerlink" title="3. AbstractDistributeOnceElasticJobListener"></a>3. AbstractDistributeOnceElasticJobListener</h1><p>AbstractDistributeOnceElasticJobListenerï¼Œåœ¨åˆ†å¸ƒå¼ä½œä¸šä¸­åªæ‰§è¡Œä¸€æ¬¡çš„ç›‘å¬å™¨ã€‚</p>
<blockquote>
<p>è‹¥ä½œä¸šå¤„ç†æ•°æ®åº“æ•°æ®ï¼Œå¤„ç†å®Œæˆååªéœ€ä¸€ä¸ªèŠ‚ç‚¹å®Œæˆæ•°æ®æ¸…ç†ä»»åŠ¡å³å¯ã€‚æ­¤ç±»å‹ä»»åŠ¡å¤„ç†å¤æ‚ï¼Œéœ€åŒæ­¥åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä½œä¸šçš„çŠ¶æ€åŒæ­¥ï¼Œæä¾›äº†è¶…æ—¶è®¾ç½®æ¥é¿å…ä½œä¸šä¸åŒæ­¥å¯¼è‡´çš„æ­»é”ï¼Œè¯·è°¨æ…ä½¿ç”¨ã€‚</p>
</blockquote>
<p><strong>åˆ›å»º</strong> AbstractDistributeOnceElasticJobListener ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDistributeOnceElasticJobListener</span> <span class="keyword">implements</span> <span class="title">ElasticJobListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¼€å§‹è¶…æ—¶æ—¶é—´</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> startedTimeoutMilliseconds;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¼€å§‹ç­‰å¾…å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object startedWait = <span class="keyword">new</span> Object();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å®Œæˆè¶…æ—¶æ—¶é—´</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> completedTimeoutMilliseconds;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å®Œæˆç­‰å¾…å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object completedWait = <span class="keyword">new</span> Object();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¿è¯åˆ†å¸ƒå¼ä»»åŠ¡å…¨éƒ¨å¼€å§‹å’Œç»“æŸçŠ¶æ€çš„æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> GuaranteeService guaranteeService;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> TimeService timeService = <span class="keyword">new</span> TimeService();</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbstractDistributeOnceElasticJobListener</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> startedTimeoutMilliseconds, <span class="keyword">final</span> <span class="keyword">long</span> completedTimeoutMilliseconds)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (startedTimeoutMilliseconds &lt;= <span class="number">0L</span>) &#123;</div><div class="line">            <span class="keyword">this</span>.startedTimeoutMilliseconds = Long.MAX_VALUE;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.startedTimeoutMilliseconds = startedTimeoutMilliseconds;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (completedTimeoutMilliseconds &lt;= <span class="number">0L</span>) &#123;</div><div class="line">            <span class="keyword">this</span>.completedTimeoutMilliseconds = Long.MAX_VALUE; </div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.completedTimeoutMilliseconds = completedTimeoutMilliseconds;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è¶…æ—¶å‚æ•° <code>startedTimeoutMilliseconds</code>ã€<code>completedTimeoutMilliseconds</code> åŠ¡å¿…ä¼ é€’ï¼Œé¿å…ä½œä¸šä¸åŒæ­¥å¯¼è‡´çš„æ­»é”ã€‚</li>
</ul>
<p>ğŸ‘‡ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹æœ¬æ–‡çš„<strong>é‡ç‚¹</strong>ï¼šAbstractDistributeOnceElasticJobListenerï¼Œåœ¨åˆ†å¸ƒå¼ä½œä¸šä¸­åªæ‰§è¡Œä¸€æ¬¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">beforeJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ³¨å†Œä½œä¸šåˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œ</span></div><div class="line">   guaranteeService.registerStart(shardingContexts.getShardingItemParameters().keySet());</div><div class="line">   <span class="comment">// åˆ¤æ–­æ˜¯å¦æ‰€æœ‰çš„åˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œ</span></div><div class="line">   <span class="keyword">if</span> (guaranteeService.isAllStarted()) &#123;</div><div class="line">       <span class="comment">// æ‰§è¡Œ</span></div><div class="line">       doBeforeJobExecutedAtLastStarted(shardingContexts);</div><div class="line">       <span class="comment">// æ¸…ç†å¯åŠ¨ä¿¡æ¯</span></div><div class="line">       guaranteeService.clearAllStartedInfo();</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç­‰å¾…</span></div><div class="line">   <span class="keyword">long</span> before = timeService.getCurrentMillis();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">synchronized</span> (startedWait) &#123;</div><div class="line">           startedWait.wait(startedTimeoutMilliseconds);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException ex) &#123;</div><div class="line">       Thread.interrupted();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç­‰å¾…è¶…æ—¶</span></div><div class="line">   <span class="keyword">if</span> (timeService.getCurrentMillis() - before &gt;= startedTimeoutMilliseconds) &#123;</div><div class="line">       <span class="comment">// æ¸…ç†å¯åŠ¨ä¿¡æ¯</span></div><div class="line">       guaranteeService.clearAllStartedInfo();</div><div class="line">       handleTimeout(startedTimeoutMilliseconds);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>GuaranteeService#registerStart(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œä½œä¸šåˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// GuaranteeService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStart</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingItems) &#123;</div><div class="line">       jobNodeStorage.createJobNodeIfNeeded(GuaranteeNode.getStartedNode(each));</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// GuaranteeNode.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GuaranteeNode</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = <span class="string">"guarantee"</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String STARTED_ROOT = ROOT + <span class="string">"/started"</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> String <span class="title">getStartedNode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> shardingItem)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> Joiner.on(<span class="string">"/"</span>).join(STARTED_ROOT, shardingItem);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Zookeeper æ•°æ®èŠ‚ç‚¹ <code>/${JOB_NAME}/guarantee/started/${ITEM_INDEX}</code> ä¸º<strong>æ°¸ä¹…</strong>èŠ‚ç‚¹ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ã€‚ä¸ºä»€ä¹ˆæ˜¯<strong>æ°¸ä¹…</strong>èŠ‚ç‚¹å‘¢ï¼Ÿåœ¨ <code>GuaranteeService#isAllStarted()</code> è§åˆ†æ™“ã€‚</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>GuaranteeService#isAllStarted()</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦æ‰€æœ‰çš„åˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ¤æ–­æ˜¯å¦æ‰€æœ‰çš„ä»»åŠ¡å‡å¯åŠ¨å®Œæ¯•.</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦æ‰€æœ‰çš„ä»»åŠ¡å‡å¯åŠ¨å®Œæ¯•</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAllStarted</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> jobNodeStorage.isJobNodeExisted(GuaranteeNode.STARTED_ROOT)</div><div class="line">           &amp;&amp; configService.load(<span class="keyword">false</span>).getTypeConfig().getCoreConfig().getShardingTotalCount() == jobNodeStorage.getJobNodeChildrenKeys(GuaranteeNode.STARTED_ROOT).size();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å½“ <code>/${JOB_NAME}/guarantee/started/</code> ç›®å½•ä¸‹ï¼Œæ‰€æœ‰ä½œä¸šåˆ†ç‰‡é¡¹éƒ½å¼€å§‹è¿è¡Œï¼Œå³è¿è¡Œæ€»æ•°ç­‰äºä½œä¸šåˆ†ç‰‡æ€»æ•°( <code>JobCoreConfiguration.ShardingTotalCount</code> )ï¼Œ<strong>ä»£è¡¨æ‰€æœ‰çš„ä»»åŠ¡å‡å¯åŠ¨å®Œæ¯•</strong>ã€‚</li>
<li>ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¸æ’é™¤æœ‰ä½œä¸šèŠ‚ç‚¹ä¼šæŒ‚æ‰ï¼Œå¦‚æœ <code>/${JOB_NAME}/guarantee/started/${ITEM_INDEX}</code> å­˜å‚¨<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ï¼Œä¼šå¯¼è‡´ä¸èƒ½æ»¡è¶³æ‰€æœ‰çš„åˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œçš„æ¡ä»¶ã€‚</li>
<li>ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè°ƒæ•´ä½œä¸šåˆ†ç‰‡æ€»æ•°( <code>JobCoreConfiguration.ShardingTotalCount</code> )ï¼Œä¼šå¯¼è‡´å¼‚å¸¸ã€‚</li>
</ul>
</li>
<li><p>å½“ä¸æ»¡è¶³æ‰€æœ‰çš„åˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œæ—¶ï¼Œä½œä¸šèŠ‚ç‚¹è°ƒç”¨ <code>Object#wait(...)</code>  æ–¹æ³•è¿›è¡Œç­‰å¾…ã€‚è¯¥ç­‰å¾…æ€ä¹ˆç»“æŸç­‰å¾…ï¼Ÿå½“æ»¡è¶³æ‰€æœ‰çš„åˆ†ç‰‡é¡¹å¼€å§‹è¿è¡Œçš„ä½œä¸šèŠ‚ç‚¹è°ƒç”¨ <code>GuaranteeService#clearAllStartedInfo()</code> æ—¶ï¼ŒStartedNodeRemovedJobListener ä¼šç›‘å¬åˆ° <code>/${JOB_NAME}/guarantee/started/</code> è¢«åˆ é™¤ï¼Œè°ƒç”¨ <code>Object#notifyAll(...)</code> æ–¹æ³•è¿›è¡Œå”¤é†’å…¨éƒ¨ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// GuaranteeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ¸…ç†æ‰€æœ‰ä»»åŠ¡å¯åŠ¨ä¿¡æ¯.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearAllStartedInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">   jobNodeStorage.removeJobNodeIfExisted(GuaranteeNode.STARTED_ROOT);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// StartedNodeRemovedJobListener.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StartedNodeRemovedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (Type.NODE_REMOVED == eventType &amp;&amp; guaranteeNode.isStartedRootNode(path)) &#123;</div><div class="line">           <span class="keyword">for</span> (ElasticJobListener each : elasticJobListeners) &#123;</div><div class="line">               <span class="keyword">if</span> (each <span class="keyword">instanceof</span> AbstractDistributeOnceElasticJobListener) &#123;</div><div class="line">                   ((AbstractDistributeOnceElasticJobListener) each).notifyWaitingTaskStart();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>#doBeforeJobExecutedAtLastStarted(...)</code> æ–¹æ³•ï¼Œæ‰§è¡Œæœ€åä¸€ä¸ªä½œä¸šæ‰§è¡Œå‰çš„æ‰§è¡Œçš„æ–¹æ³•ï¼Œå®ç°è¯¥æŠ½è±¡æ–¹æ³•ï¼Œå®Œæˆè‡ªå®šä¹‰é€»è¾‘ã€‚<code>#doAfterJobExecutedAtLastCompleted(...)</code> å®ç°çš„æ–¹å¼ä¸€æ ·ï¼Œå°±ä¸é‡å¤è§£æäº†ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractDistributeOnceElasticJobListener.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ†å¸ƒå¼ç¯å¢ƒä¸­æœ€åä¸€ä¸ªä½œä¸šæ‰§è¡Œå‰çš„æ‰§è¡Œçš„æ–¹æ³•.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doBeforeJobExecutedAtLastStarted</span><span class="params">(ShardingContexts shardingContexts)</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ†å¸ƒå¼ç¯å¢ƒä¸­æœ€åä¸€ä¸ªä½œä¸šæ‰§è¡Œåçš„æ‰§è¡Œçš„æ–¹æ³•.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doAfterJobExecutedAtLastCompleted</span><span class="params">(ShardingContexts shardingContexts)</span></span>;</div></pre></td></tr></table></figure>
</li>
<li><p>æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š<img src="http://www.yunai.me/images/Elastic-Job/2017_11_21/02.png" alt="">    </p>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šå“å“Ÿå–‚ï¼ŒAbstractDistributeOnceElasticJobListener è¿˜ä¸é”™å“Ÿã€‚<br>èŠ‹é“å›ï¼šé‚£å¿…é¡»å¿…çš„ã€‚</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_21/03.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ElasticJobListener&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
    
    </summary>
    
      <category term="Elastic-Job" scheme="http://www.yunai.me/categories/Elastic-Job/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šäº‹ä»¶è¿½è¸ª</title>
    <link href="http://www.yunai.me/Elastic-Job/job-event-trace/"/>
    <id>http://www.yunai.me/Elastic-Job/job-event-trace/</id>
    <published>2017-11-13T16:00:00.000Z</published>
    <updated>2017-08-28T05:02:42.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ä½œä¸šäº‹ä»¶æ€»çº¿</a></li>
<li><a href="#">3. ä½œä¸šäº‹ä»¶</a><ul>
<li><a href="#">3.1 ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶</a></li>
<li><a href="#">3.2 ä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶</a></li>
<li><a href="#">3.3 ä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨</a></li>
<li><a href="#">3.4 ä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢</a></li>
</ul>
</li>
<li><a href="#">4. ä½œä¸šç›‘å¬å™¨</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šäº‹ä»¶è¿½è¸ª</strong>ã€‚</p>
<p>Elastic-Job æä¾›äº†äº‹ä»¶è¿½è¸ªåŠŸèƒ½ï¼Œå¯é€šè¿‡äº‹ä»¶è®¢é˜…çš„æ–¹å¼å¤„ç†è°ƒåº¦è¿‡ç¨‹çš„é‡è¦äº‹ä»¶ï¼Œç”¨äºæŸ¥è¯¢ã€ç»Ÿè®¡å’Œç›‘æ§ã€‚Elastic-Job ç›®å‰è®¢é˜…ä¸¤ç§äº‹ä»¶ï¼ŒåŸºäº<strong>å…³ç³»å‹æ•°æ®åº“</strong>è®°å½•äº‹ä»¶ã€‚</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_11_14/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_14/01.png" alt=""></p>
<ul>
<li>ä»¥ä¸Šç±»åœ¨ <code>com.dangdang.ddframe.job.event</code> åŒ…ï¼Œä¸ä»…ä¸º Elastic-Job-Liteï¼Œè€Œä¸”ä¸º Elastic-Job-Cloud å®ç°äº†äº‹ä»¶è¿½è¸ªåŠŸèƒ½ã€‚</li>
<li>ä½œä¸š<strong>äº‹ä»¶</strong>ï¼šç²‰è‰²çš„ç±»ã€‚</li>
<li>ä½œä¸š<strong>äº‹ä»¶æ€»çº¿</strong>ï¼šé»„è‰²çš„ç±»ã€‚</li>
<li>ä½œä¸š<strong>äº‹ä»¶ç›‘å¬å™¨</strong>ï¼šè“è‰²çš„ç±»ã€‚ </li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-ä½œä¸šäº‹ä»¶æ€»çº¿"><a href="#2-ä½œä¸šäº‹ä»¶æ€»çº¿" class="headerlink" title="2. ä½œä¸šäº‹ä»¶æ€»çº¿"></a>2. ä½œä¸šäº‹ä»¶æ€»çº¿</h1><p>JobEventBusï¼Œä½œä¸šäº‹ä»¶æ€»çº¿ï¼Œæä¾›äº†æ³¨å†Œç›‘å¬å™¨ã€å‘å¸ƒäº‹ä»¶ä¸¤ä¸ªæ–¹æ³•ã€‚</p>
<p><strong>åˆ›å»º</strong> JobEventBus ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobEventBus</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šäº‹ä»¶é…ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobEventConfiguration jobEventConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * çº¿ç¨‹æ± æ‰§è¡ŒæœåŠ¡å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutorServiceObject executorServiceObject;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * äº‹ä»¶æ€»çº¿</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventBus eventBus;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ˜¯å¦æ³¨å†Œä½œä¸šç›‘å¬å™¨</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isRegistered;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobEventBus</span><span class="params">()</span> </span>&#123;</div><div class="line">        jobEventConfig = <span class="keyword">null</span>;</div><div class="line">        executorServiceObject = <span class="keyword">null</span>;</div><div class="line">        eventBus = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobEventBus</span><span class="params">(<span class="keyword">final</span> JobEventConfiguration jobEventConfig)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.jobEventConfig = jobEventConfig;</div><div class="line">        executorServiceObject = <span class="keyword">new</span> ExecutorServiceObject(<span class="string">"job-event"</span>, Runtime.getRuntime().availableProcessors() * <span class="number">2</span>);</div><div class="line">        <span class="comment">// åˆ›å»º å¼‚æ­¥äº‹ä»¶æ€»çº¿</span></div><div class="line">        eventBus = <span class="keyword">new</span> AsyncEventBus(executorServiceObject.createExecutorService());</div><div class="line">        <span class="comment">// æ³¨å†Œ äº‹ä»¶ç›‘å¬å™¨</span></div><div class="line">        register();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>JobEventBus åŸºäº <a href="https://github.com/google/guava/wiki/EventBusExplained" rel="external nofollow noopener noreferrer" target="_blank">Google Guava EventBus</a>ï¼Œåœ¨<a href="http://www.yunai.me/Sharding-JDBC/sql-execute">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œã€‹ã€Œ4.1 EventBusã€</a>æœ‰è¯¦ç»†åˆ†äº«ã€‚è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ AsyncEventBus( <strong>å¼‚æ­¥äº‹ä»¶æ€»çº¿</strong> )ï¼Œæ³¨å†Œåœ¨å…¶ä¸Šé¢çš„ç›‘å¬å™¨æ˜¯<strong>å¼‚æ­¥</strong>ç›‘å¬æ‰§è¡Œï¼Œäº‹ä»¶å‘å¸ƒæ— éœ€é˜»å¡ç­‰å¾…ç›‘å¬å™¨æ‰§è¡Œå®Œé€»è¾‘ï¼Œæ‰€ä»¥å¯¹æ€§èƒ½ä¸å­˜åœ¨å½±å“ã€‚</li>
<li><p>ä½¿ç”¨ JobEventConfiguration( ä½œä¸šäº‹ä»¶é…ç½® ) åˆ›å»ºäº‹ä»¶ç›‘å¬å™¨ï¼Œè°ƒç”¨ <code>#register()</code> æ–¹æ³•è¿›è¡Œæ³¨å†Œç›‘å¬ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       eventBus.register(jobEventConfig.createJobEventListener());</div><div class="line">       isRegistered = <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> JobEventListenerConfigurationException ex) &#123;</div><div class="line">       log.error(<span class="string">"Elastic job: create JobEventListener failure, error is: "</span>, ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è¯¥æ–¹æ³•æ˜¯ç§æœ‰( <code>private</code> )æ–¹æ³•ï¼Œåªèƒ½ä½¿ç”¨ JobEventConfiguration åˆ›å»ºäº‹ä»¶ç›‘å¬å™¨æ³¨å†Œã€‚å½“ä¸ä¼ é€’è¯¥é…ç½®æ—¶ï¼Œæ„å‘³ç€ä¸å¼€å¯<strong>äº‹ä»¶è¿½è¸ª</strong>åŠŸèƒ½ã€‚</li>
</ul>
</li>
</ul>
<p><strong>å‘å¸ƒä½œä¸šäº‹ä»¶</strong></p>
<p>å‘å¸ƒä½œä¸šäº‹ä»¶( JobEvent ) ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventBus.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(<span class="keyword">final</span> JobEvent event)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (isRegistered &amp;&amp; !executorServiceObject.isShutdown()) &#123;</div><div class="line">       eventBus.post(event);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ Elaistc-Job-Lite é‡Œï¼ŒLiteJobFacade å¯¹ <code>JobEventBus#post(...)</code> è¿›è¡Œå°è£…ï¼Œæä¾›ç»™ä½œä¸šæ‰§è¡Œå™¨( AbstractElasticJobExecutor )è°ƒç”¨( Elastic-Job-Cloud å®é™…ä¹Ÿè¿›è¡Œäº†å°è£… )ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postJobExecutionEvent</span><span class="params">(<span class="keyword">final</span> JobExecutionEvent jobExecutionEvent)</span> </span>&#123;</div><div class="line">   jobEventBus.post(jobExecutionEvent);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postJobStatusTraceEvent</span><span class="params">(<span class="keyword">final</span> String taskId, <span class="keyword">final</span> State state, <span class="keyword">final</span> String message)</span> </span>&#123;</div><div class="line">   TaskContext taskContext = TaskContext.from(taskId);</div><div class="line">   jobEventBus.post(<span class="keyword">new</span> JobStatusTraceEvent(taskContext.getMetaInfo().getJobName(), taskContext.getId(),</div><div class="line">           taskContext.getSlaveId(), Source.LITE_EXECUTOR, taskContext.getType(), taskContext.getMetaInfo().getShardingItems().toString(), state, message));</div><div class="line">   <span class="keyword">if</span> (!Strings.isNullOrEmpty(message)) &#123;</div><div class="line">       log.trace(message);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>TaskContext é€šè¿‡ <code>#from(...)</code> æ–¹æ³•ï¼Œå¯¹ä½œä¸šä»»åŠ¡ID( <code>taskId</code> ) è§£æï¼Œè·å–ä»»åŠ¡ä¸Šä¸‹æ–‡ã€‚TaskContext ä»£ç æ³¨é‡Šå¾ˆå®Œæ•´ï¼Œç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/8926e94aa7c48dc635a36518da2c4b10194420a5/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/context/TaskContext.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</li>
</ul>
<h1 id="3-ä½œä¸šäº‹ä»¶"><a href="#3-ä½œä¸šäº‹ä»¶" class="headerlink" title="3. ä½œä¸šäº‹ä»¶"></a>3. ä½œä¸šäº‹ä»¶</h1><p>ç›®å‰æœ‰ä¸¤ç§ä½œä¸šäº‹ä»¶( JobEvent )ï¼š</p>
<ul>
<li>JobStatusTraceEventï¼Œä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶ã€‚</li>
<li>JobExecutionEventï¼Œä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶ã€‚</li>
</ul>
<p>æœ¬å°èŠ‚åˆ†äº«ä¸¤æ–¹é¢ï¼š</p>
<ul>
<li>ä½œä¸šäº‹ä»¶<strong>å‘å¸ƒæ—¶æœº</strong>ã€‚</li>
<li>Elastic-Job åŸºäº<strong>å…³ç³»å‹æ•°æ®åº“</strong>è®°å½•äº‹ä»¶çš„<strong>è¡¨ç»“æ„</strong>ã€‚</li>
</ul>
<h2 id="3-1-ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶"><a href="#3-1-ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶" class="headerlink" title="3.1 ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶"></a>3.1 ä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶</h2><p>JobStatusTraceEventï¼Œä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobStatusTraceEvent</span> <span class="keyword">implements</span> <span class="title">JobEvent</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸»é”®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String id = UUID.randomUUID().toString();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåç§°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åŸä½œä¸šä»»åŠ¡ID</div><div class="line">     */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> String originalTaskId = <span class="string">""</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šä»»åŠ¡ID</div><div class="line">     * æ¥è‡ª &#123;<span class="doctag">@link</span> com.dangdang.ddframe.job.executor.ShardingContexts#taskId&#125;</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String taskId;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰§è¡Œä½œä¸šæœåŠ¡å™¨çš„åå­—</div><div class="line">     * Elastic-Job-Liteï¼Œä½œä¸šèŠ‚ç‚¹çš„ IP åœ°å€</div><div class="line">     * Elastic-Job-Cloudï¼ŒMesos æ‰§è¡Œæœºä¸»é”®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String slaveId;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä»»åŠ¡æ¥æº</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Source source;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä»»åŠ¡æ‰§è¡Œç±»å‹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutionType executionType;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåˆ†ç‰‡é¡¹</div><div class="line">     * å¤šä¸ªåˆ†ç‰‡é¡¹ä»¥é€—å·åˆ†éš”</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String shardingItems;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> State state;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç›¸å…³ä¿¡æ¯</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String message;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è®°å½•åˆ›å»ºæ—¶é—´</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Date creationTime = <span class="keyword">new</span> Date();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>ExecutionTypeï¼Œæ‰§è¡Œç±»å‹ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ExecutionType &#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å‡†å¤‡æ‰§è¡Œçš„ä»»åŠ¡.</div><div class="line">     */</div><div class="line">    READY,</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¤±æ•ˆè½¬ç§»çš„ä»»åŠ¡.</div><div class="line">     */</div><div class="line">    FAILOVER</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Sourceï¼Œä»»åŠ¡æ¥æºã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Source &#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Elastic-Job-Cloud è°ƒåº¦å™¨</div><div class="line">    */</div><div class="line">   CLOUD_SCHEDULER,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Elastic-Job-Cloud æ‰§è¡Œå™¨</div><div class="line">    */</div><div class="line">   CLOUD_EXECUTOR,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Elastic-Job-Lite æ‰§è¡Œå™¨</div><div class="line">    */</div><div class="line">   LITE_EXECUTOR</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Stateï¼Œä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> State &#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * å¼€å§‹ä¸­</div><div class="line">    */</div><div class="line">   TASK_STAGING,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * è¿è¡Œä¸­</div><div class="line">    */</div><div class="line">   TASK_RUNNING,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * å®Œæˆï¼ˆæ­£å¸¸ï¼‰</div><div class="line">    */</div><div class="line">   TASK_FINISHED,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * å®Œæˆï¼ˆå¼‚å¸¸ï¼‰</div><div class="line">    */</div><div class="line">   TASK_ERROR,</div><div class="line">       </div><div class="line">   TASK_KILLED, TASK_LOST, TASK_FAILED,  TASK_DROPPED, TASK_GONE, TASK_GONE_BY_OPERATOR, TASK_UNREACHABLE, TASK_UNKNOWN</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Elastic-Job-Lite åªæœ‰ TASK_STAGINGã€TASK_RUNNINGã€TASK_FINISHEDã€TASK_ERROR å››ç§æ‰§è¡ŒçŠ¶æ€ã€‚</li>
<li>Elastic-Job-Cloud æœ‰æ‰€æœ‰çš„æ‰§è¡ŒçŠ¶æ€ã€‚</li>
</ul>
</li>
</ul>
<p>å…³ç³»æ•°æ®åº“è¡¨ <code>JOB_STATUS_TRACE_LOG</code> ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`JOB_STATUS_TRACE_LOG`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">varchar</span>(<span class="number">40</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`job_name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`original_task_id`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`task_id`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`slave_id`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`source`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`execution_type`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`sharding_item`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`state`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`message`</span> <span class="built_in">varchar</span>(<span class="number">4000</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`creation_time`</span> <span class="keyword">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`TASK_ID_STATE_INDEX`</span> (<span class="string">`task_id`</span>,<span class="string">`state`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COLLATE</span>=utf8_bin</div></pre></td></tr></table></figure>
<ul>
<li><p>Elastic-Job-Lite ä¸€æ¬¡ä½œä¸šæ‰§è¡Œè®°å½•å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_11_14/02.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p>  <img src="http://www.yunai.me/images/Elastic-Job/2017_11_14/02.png" alt=""></p>
</li>
</ul>
<p>JobStatusTraceEvent åœ¨ Elastic-Job-Lite å‘å¸ƒæ—¶æœºï¼š</p>
<ul>
<li><p>State.TASK_STAGINGï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">    <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_STAGING)</span></div><div class="line">    <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">        jobFacade.postJobStatusTraceEvent(shardingContexts.getTaskId(), State.TASK_STAGING, String.format(<span class="string">"Job '%s' execute begin."</span>, jobName));</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>State.TASK_RUNNINGï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">   <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_RUNNING)</span></div><div class="line">   <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">       jobFacade.postJobStatusTraceEvent(taskId, State.TASK_RUNNING, <span class="string">""</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>State.TASK_FINISHEDã€State.TASK_ERRORã€ç¬¬ä¸€ç§ã€‘ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">    <span class="comment">// è·³è¿‡ å­˜åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡ä½œä¸š</span></div><div class="line">    <span class="keyword">if</span> (jobFacade.misfireIfRunning(shardingContexts.getShardingItemParameters().keySet())) &#123;</div><div class="line">      <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_FINISHED)</span></div><div class="line">      <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">          jobFacade.postJobStatusTraceEvent(shardingContexts.getTaskId(), State.TASK_FINISHED, String.format(</div><div class="line">                  <span class="string">"Previous job '%s' - shardingItems '%s' is still running, misfired job will start after previous job completed."</span>, jobName, </div><div class="line">                  shardingContexts.getShardingItemParameters().keySet()));</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>State.TASK_FINISHEDã€State.TASK_ERRORã€ç¬¬äºŒç§ã€‘ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">  <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      process(shardingContexts, executionSource);</div><div class="line">  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">      <span class="comment">// æ ¹æ®æ˜¯å¦æœ‰å¼‚å¸¸ï¼Œå‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_FINISHED / State.TASK_ERROR)</span></div><div class="line">      <span class="keyword">if</span> (itemErrorMessages.isEmpty()) &#123;</div><div class="line">          <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">              jobFacade.postJobStatusTraceEvent(taskId, State.TASK_FINISHED, <span class="string">""</span>);</div><div class="line">          &#125;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">              jobFacade.postJobStatusTraceEvent(taskId, State.TASK_ERROR, itemErrorMessages.toString());</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="3-2-ä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶"><a href="#3-2-ä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶" class="headerlink" title="3.2 ä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶"></a>3.2 ä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶</h2><p>JobExecutionEventï¼Œä½œä¸šæ‰§è¡Œè¿½è¸ªäº‹ä»¶ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobExecutionEvent</span> <span class="keyword">implements</span> <span class="title">JobEvent</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸»é”®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String id = UUID.randomUUID().toString();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸»æœºåç§°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String hostname = IpUtils.getHostName();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * IP</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String ip = IpUtils.getIp();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šä»»åŠ¡ID</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String taskId;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåå­—</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰§è¡Œæ¥æº</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutionSource source;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåˆ†ç‰‡é¡¹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> shardingItem;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¼€å§‹æ—¶é—´</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Date startTime = <span class="keyword">new</span> Date();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç»“æŸæ—¶é—´</div><div class="line">     */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> Date completeTime;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ˜¯å¦æ‰§è¡ŒæˆåŠŸ</div><div class="line">     */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> success;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰§è¡Œå¤±è´¥åŸå› </div><div class="line">     */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> JobExecutionEventThrowable failureCause;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>ExecutionSourceï¼Œæ‰§è¡Œæ¥æº</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ExecutionSource &#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * æ™®é€šè§¦å‘æ‰§è¡Œ</div><div class="line">    */</div><div class="line">   NORMAL_TRIGGER,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * è¢«é”™è¿‡æ‰§è¡Œ</div><div class="line">    */</div><div class="line">   MISFIRE,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * å¤±æ•ˆè½¬ç§»æ‰§è¡Œ</div><div class="line">    */</div><div class="line">   FAILOVER</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>å…³ç³»æ•°æ®åº“è¡¨ <code>JOB_EXECUTION_LOG</code> ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`JOB_EXECUTION_LOG`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">varchar</span>(<span class="number">40</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`job_name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`task_id`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`hostname`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`ip`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`sharding_item`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`execution_source`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`failure_cause`</span> <span class="built_in">varchar</span>(<span class="number">4000</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`is_success`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`start_time`</span> <span class="keyword">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`complete_time`</span> <span class="keyword">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COLLATE</span>=utf8_bin</div></pre></td></tr></table></figure>
<ul>
<li><p>Elastic-Job-Lite ä¸€æ¬¡ä½œä¸š<strong>å¤šä½œä¸šåˆ†ç‰‡é¡¹</strong>æ‰§è¡Œè®°å½•å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_11_14/03.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p>  <img src="http://www.yunai.me/images/Elastic-Job/2017_11_14/03.png" alt=""></p>
</li>
</ul>
<p>JobExecutionEvent åœ¨ Elastic-Job-Lite å‘å¸ƒæ—¶æœºï¼š</p>
<pre><code><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> <span class="keyword">int</span> item, <span class="keyword">final</span> JobExecutionEvent startEvent)</span> </span>&#123;</div><div class="line">   <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(å¼€å§‹)</span></div><div class="line">   <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">       jobFacade.postJobExecutionEvent(startEvent);</div><div class="line">   &#125;</div><div class="line">   JobExecutionEvent completeEvent;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// æ‰§è¡Œå•ä¸ªä½œä¸š</span></div><div class="line">       process(<span class="keyword">new</span> ShardingContext(shardingContexts, item));</div><div class="line">       <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(æˆåŠŸ)</span></div><div class="line">       completeEvent = startEvent.executionSuccess();</div><div class="line">       <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">           jobFacade.postJobExecutionEvent(completeEvent);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable cause) &#123;</div><div class="line">       <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(å¤±è´¥)</span></div><div class="line">       completeEvent = startEvent.executionFailure(cause);</div><div class="line">       jobFacade.postJobExecutionEvent(completeEvent);</div><div class="line">       <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><h2 id="3-3-ä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨"><a href="#3-3-ä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨" class="headerlink" title="3.3 ä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨"></a>3.3 ä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨</h2><p>JobEventRdbStorageï¼Œä½œä¸šäº‹ä»¶æ•°æ®åº“å­˜å‚¨ã€‚</p>
<p><strong>åˆ›å»º</strong> JobEventRdbStorage ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">JobEventRdbStorage(<span class="keyword">final</span> DataSource dataSource) <span class="keyword">throws</span> SQLException &#123;</div><div class="line">   <span class="keyword">this</span>.dataSource = dataSource;</div><div class="line">   initTablesAndIndexes();</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initTablesAndIndexes</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">try</span> (Connection conn = dataSource.getConnection()) &#123;</div><div class="line">       createJobExecutionTableAndIndexIfNeeded(conn);</div><div class="line">       createJobStatusTraceTableAndIndexIfNeeded(conn);</div><div class="line">       databaseType = DatabaseType.valueFrom(conn.getMetaData().getDatabaseProductName());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>#createJobExecutionTableAndIndexIfNeeded(...)</code> åˆ›å»º <code>JOB_EXECUTION_LOG</code> è¡¨å’Œç´¢å¼•ã€‚</li>
<li>è°ƒç”¨ <code>#createJobStatusTraceTableAndIndexIfNeeded(...)</code> åˆ›å»º <code>JOB_STATUS_TRACE_LOG</code> è¡¨å’Œç´¢å¼•ã€‚</li>
</ul>
<p><strong>å­˜å‚¨</strong> JobStatusTraceEvent ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventRdbStorage.java</span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">addJobStatusTraceEvent</span><span class="params">(<span class="keyword">final</span> JobStatusTraceEvent jobStatusTraceEvent)</span> </span>&#123;</div><div class="line">   String originalTaskId = jobStatusTraceEvent.getOriginalTaskId();</div><div class="line">   <span class="keyword">if</span> (State.TASK_STAGING != jobStatusTraceEvent.getState()) &#123;</div><div class="line">       originalTaskId = getOriginalTaskId(jobStatusTraceEvent.getTaskId());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line">   String sql = <span class="string">"INSERT INTO `"</span> + TABLE_JOB_STATUS_TRACE_LOG + <span class="string">"` (`id`, `job_name`, `original_task_id`, `task_id`, `slave_id`, `source`, `execution_type`, `sharding_item`,  "</span> </div><div class="line">           + <span class="string">"`state`, `message`, `creation_time`) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);"</span>;</div><div class="line">   <span class="comment">// ... çœç•¥ä½ æ‡‚çš„ä»£ç </span></div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getOriginalTaskId</span><span class="params">(<span class="keyword">final</span> String taskId)</span> </span>&#123;</div><div class="line">   String sql = String.format(<span class="string">"SELECT original_task_id FROM %s WHERE task_id = '%s' and state='%s'"</span>, TABLE_JOB_STATUS_TRACE_LOG, taskId, State.TASK_STAGING);</div><div class="line">   <span class="comment">// ... çœç•¥ä½ æ‡‚çš„ä»£ç </span></div><div class="line">   <span class="keyword">return</span> original_task_id;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>originalTaskId</code>ï¼ŒåŸä»»åŠ¡ä½œä¸šIDã€‚<ul>
<li>Elastic-Job-Lite æš‚æœªä½¿ç”¨åˆ°è¯¥å­—æ®µï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ã€‚</li>
<li>Elastic-Job-Cloud ä½¿ç”¨åˆ°ï¼Œç¬”è€…æš‚æœªç ”ç©¶åˆ°ã€‚å˜¿å˜¿ã€‚</li>
</ul>
</li>
</ul>
<p><strong>å­˜å‚¨</strong> JobExecutionEvent ä»£ç å¦‚ä¸‹ï¼š     </p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventRdbStorage.java</span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">addJobExecutionEvent</span><span class="params">(<span class="keyword">final</span> JobExecutionEvent jobExecutionEvent)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> == jobExecutionEvent.getCompleteTime()) &#123; <span class="comment">// ä½œä¸šåˆ†ç‰‡é¡¹æ‰§è¡Œå¼€å§‹</span></div><div class="line">       <span class="keyword">return</span> insertJobExecutionEvent(jobExecutionEvent);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">if</span> (jobExecutionEvent.isSuccess()) &#123; <span class="comment">// ä½œä¸šåˆ†ç‰‡é¡¹æ‰§è¡Œå®Œæˆï¼ˆæ­£å¸¸ï¼‰</span></div><div class="line">           <span class="keyword">return</span> updateJobExecutionEventWhenSuccess(jobExecutionEvent);</div><div class="line">       &#125; <span class="keyword">else</span> &#123; <span class="comment">// ä½œä¸šåˆ†ç‰‡é¡¹æ‰§è¡Œå®Œæˆï¼ˆå¼‚å¸¸ï¼‰</span></div><div class="line">           <span class="keyword">return</span> updateJobExecutionEventFailure(jobExecutionEvent);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä½œä¸šåˆ†ç‰‡é¡¹æ‰§è¡Œå®Œæˆè¿›è¡Œçš„æ˜¯<strong>æ›´æ–°</strong>æ“ä½œã€‚</li>
</ul>
<h2 id="3-4-ä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢"><a href="#3-4-ä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢" class="headerlink" title="3.4 ä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢"></a>3.4 ä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢</h2><p>JobEventRdbSearchï¼Œä½œä¸šäº‹ä»¶æ•°æ®åº“æŸ¥è¯¢ï¼Œæä¾›ç»™è¿ç»´å¹³å°è°ƒç”¨æŸ¥è¯¢æ•°æ®ã€‚æ„Ÿå…´è¶£çš„åŒå­¦ç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/8283acf01548222f39f7bfc202a8f89d27728e6c/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/event/rdb/JobEventRdbSearch.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</p>
<h1 id="4-ä½œä¸šç›‘å¬å™¨"><a href="#4-ä½œä¸šç›‘å¬å™¨" class="headerlink" title="4. ä½œä¸šç›‘å¬å™¨"></a>4. ä½œä¸šç›‘å¬å™¨</h1><p>åœ¨ä¸Šæ–‡æˆ‘ä»¬çœ‹åˆ°ï¼Œä½œä¸šç›‘å¬å™¨é€šè¿‡ä¼ é€’ä½œä¸šäº‹ä»¶é…ç½®( JobEventConfiguration )ç»™ä½œä¸šäº‹ä»¶æ€»çº¿( JobEventBus ) <strong>è¿›è¡Œåˆ›å»ºç›‘å¬å™¨ï¼Œå¹¶æ³¨å†Œç›‘å¬å™¨åˆ°äº‹ä»¶æ€»çº¿</strong>ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ Elastic-Job æä¾›çš„åŸºäº<strong>å…³ç³»æ•°æ®åº“</strong>çš„äº‹ä»¶é…ç½®å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventConfiguration.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JobEventConfiguration</span> <span class="keyword">extends</span> <span class="title">JobEventIdentity</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ›å»ºä½œä¸šäº‹ä»¶ç›‘å¬å™¨.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span> ä½œä¸šäº‹ä»¶ç›‘å¬å™¨.</div><div class="line">     * <span class="doctag">@throws</span> JobEventListenerConfigurationException ä½œä¸šäº‹ä»¶ç›‘å¬å™¨é…ç½®å¼‚å¸¸</div><div class="line">     */</div><div class="line">    <span class="function">JobEventListener <span class="title">createJobEventListener</span><span class="params">()</span> <span class="keyword">throws</span> JobEventListenerConfigurationException</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobEventRdbConfiguration.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobEventRdbConfiguration</span> <span class="keyword">extends</span> <span class="title">JobEventRdbIdentity</span> <span class="keyword">implements</span> <span class="title">JobEventConfiguration</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">transient</span> DataSource dataSource;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> JobEventListener <span class="title">createJobEventListener</span><span class="params">()</span> <span class="keyword">throws</span> JobEventListenerConfigurationException </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JobEventRdbListener(dataSource);</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobEventListenerConfigurationException(ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>JobEventRdbConfigurationï¼Œä½œä¸šæ•°æ®åº“äº‹ä»¶é…ç½®ã€‚è°ƒç”¨ <code>#createJobEventListener()</code> åˆ›å»ºä½œä¸šäº‹ä»¶æ•°æ®åº“ç›‘å¬å™¨( JobEventRdbListener )ã€‚</li>
</ul>
<p>JobEventRdbListenerï¼Œä½œä¸šäº‹ä»¶æ•°æ®åº“ç›‘å¬å™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobEventListener.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JobEventListener</span> <span class="keyword">extends</span> <span class="title">JobEventIdentity</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šæ‰§è¡Œäº‹ä»¶ç›‘å¬æ‰§è¡Œ.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> jobExecutionEvent ä½œä¸šæ‰§è¡Œäº‹ä»¶</div><div class="line">     */</div><div class="line">    <span class="meta">@Subscribe</span></div><div class="line">    <span class="meta">@AllowConcurrentEvents</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">listen</span><span class="params">(JobExecutionEvent jobExecutionEvent)</span></span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šçŠ¶æ€ç—•è¿¹äº‹ä»¶ç›‘å¬æ‰§è¡Œ.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> jobStatusTraceEvent ä½œä¸šçŠ¶æ€ç—•è¿¹äº‹ä»¶</div><div class="line">     */</div><div class="line">    <span class="meta">@Subscribe</span></div><div class="line">    <span class="meta">@AllowConcurrentEvents</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">listen</span><span class="params">(JobStatusTraceEvent jobStatusTraceEvent)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobEventRdbListener.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobEventRdbListener</span> <span class="keyword">extends</span> <span class="title">JobEventRdbIdentity</span> <span class="keyword">implements</span> <span class="title">JobEventListener</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobEventRdbStorage repository;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobEventRdbListener</span><span class="params">(<span class="keyword">final</span> DataSource dataSource)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        repository = <span class="keyword">new</span> JobEventRdbStorage(dataSource);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(<span class="keyword">final</span> JobExecutionEvent executionEvent)</span> </span>&#123;</div><div class="line">        repository.addJobExecutionEvent(executionEvent);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(<span class="keyword">final</span> JobStatusTraceEvent jobStatusTraceEvent)</span> </span>&#123;</div><div class="line">        repository.addJobStatusTraceEvent(jobStatusTraceEvent);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>é€šè¿‡ JobEventRdbStorage å­˜å‚¨ä½œä¸šäº‹ä»¶åˆ°å…³ç³»å‹æ•°æ®åº“ã€‚</li>
</ul>
<p><strong>å¦‚ä½•è‡ªå®šä¹‰ä½œä¸šç›‘å¬å™¨ï¼Ÿ</strong></p>
<p>æœ‰äº›åŒå­¦å¯èƒ½å¸Œæœ›ä½¿ç”¨ ES æˆ–è€…å…¶ä»–æ•°æ®åº“å­˜å‚¨ä½œä¸šäº‹ä»¶ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥é€šè¿‡å®ç° JobEventConfigurationã€JobEventListener è¿›è¡Œæ‹“å±•ã€‚</p>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šçæ¯”æ¯”äº†è¿™ä¹ˆé•¿ï¼Œèƒ½ä¸èƒ½ç®€å•ç²—æš´ä¸€ç‚¹ã€‚<br>èŠ‹é“å›ï¼šæ˜¯æ˜¯æ˜¯ã€‚</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_14/04.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ä½œä¸šäº‹ä»¶æ€»çº¿&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;
    
    </summary>
    
      <category term="Elastic-Job" scheme="http://www.yunai.me/categories/Elastic-Job/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»</title>
    <link href="http://www.yunai.me/Elastic-Job/job-failover/"/>
    <id>http://www.yunai.me/Elastic-Job/job-failover/</id>
    <published>2017-11-06T16:00:00.000Z</published>
    <updated>2017-08-28T18:30:09.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ä½œä¸šèŠ‚ç‚¹å´©æºƒç›‘å¬</a></li>
<li><a href="#">3. ä½œä¸šå¤±æ•ˆè½¬ç§»</a></li>
<li><a href="#">4. è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</a></li>
<li><a href="#">5. ç›‘å¬ä½œä¸šå¤±æ•ˆè½¬ç§»åŠŸèƒ½å…³é—­</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šå¤±æ•ˆè½¬ç§»</strong>ã€‚</p>
<p>å½“ä½œä¸šèŠ‚ç‚¹æ‰§è¡Œä½œä¸šå¼‚å¸¸å´©æºƒæ—¶ï¼Œå…¶æ‰€åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹åœ¨ä¸‹æ¬¡é‡æ–°åˆ†ç‰‡ä¹‹å‰ä¸ä¼šè¢«é‡æ–°æ‰§è¡Œã€‚å¼€å¯å¤±æ•ˆè½¬ç§»åŠŸèƒ½åï¼Œè¿™éƒ¨åˆ†ä½œä¸šåˆ†ç‰‡é¡¹å°†è¢«å…¶ä»–ä½œä¸šèŠ‚ç‚¹æŠ“å–åâ€œæ‰§è¡Œâ€ã€‚ä¸ºä»€ä¹ˆæ­¤å¤„çš„æ‰§è¡Œæ‰“å¼•å·å‘¢ï¼ŸğŸ˜ˆä¸‹æ–‡æˆ‘ä»¬ä¼šåˆ†äº«åˆ°å™¢ï¼Œå–ä¸ªå…³å­ã€‚</p>
<p>ç¬”è€…å¯¹<strong>å¤±æ•ˆè½¬ç§»</strong>ç†è§£äº†è›®ä¹…æ—¶é—´ï¼Œå› æ­¤å¼•ç”¨å®˜æ–¹å¯¹å®ƒçš„è§£é‡Šï¼Œè®©ä½ èƒ½æ›´å¥½çš„ç†è§£ï¼š</p>
<blockquote>
<p>æ¥æºåœ°å€ï¼š<a href="https://my.oschina.net/u/719192/blog/506062" rel="external nofollow noopener noreferrer" target="_blank">https://my.oschina.net/u/719192/blog/506062</a><br>å¤±æ•ˆè½¬ç§»ï¼š è¿è¡Œä¸­çš„ä½œä¸šæœåŠ¡å™¨å´©æºƒä¸ä¼šå¯¼è‡´é‡æ–°åˆ†ç‰‡ï¼Œåªä¼šåœ¨ä¸‹æ¬¡ä½œä¸šå¯åŠ¨æ—¶åˆ†ç‰‡ã€‚å¯ç”¨å¤±æ•ˆè½¬ç§»åŠŸèƒ½å¯ä»¥åœ¨æœ¬æ¬¡ä½œä¸šæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç›‘æµ‹å…¶ä»–ä½œä¸šæœåŠ¡å™¨ç©ºé—²ï¼ŒæŠ“å–æœªå®Œæˆçš„å­¤å„¿åˆ†ç‰‡é¡¹æ‰§è¡Œã€‚<br>â€“ åˆ†éš”ç¬¦ â€“<br>æ¥æºåœ°å€ï¼š<a href="http://dangdangdotcom.github.io/elastic-job/elastic-job-lite/03-design/lite-design/" rel="external nofollow noopener noreferrer" target="_blank">http://dangdangdotcom.github.io/elastic-job/elastic-job-lite/03-design/lite-design/</a><br>å®ç°å¤±æ•ˆè½¬ç§»åŠŸèƒ½ï¼Œåœ¨æŸå°æœåŠ¡å™¨æ‰§è¡Œå®Œæ¯•åä¸»åŠ¨æŠ“å–æœªåˆ†é…çš„åˆ†ç‰‡ï¼Œå¹¶ä¸”åœ¨æŸå°æœåŠ¡å™¨ä¸‹çº¿åä¸»åŠ¨å¯»æ‰¾å¯ç”¨çš„æœåŠ¡å™¨æ‰§è¡Œä»»åŠ¡ã€‚</p>
</blockquote>
<p>è¿™æ ·çœ‹æ¦‚å¿µå¯èƒ½è¿˜æ˜¯æ¯”è¾ƒéš¾ç†è§£ï¼Œä»£ç æèµ·æ¥ï¼</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_11_07/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_07/01.png" alt=""></p>
<ul>
<li>ç²‰è‰²çš„ç±»åœ¨ <code>com.dangdang.ddframe.job.lite.internal.failover</code> åŒ…ä¸‹ï¼Œå®ç°äº† Elastic-Job-Lite ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‚</li>
<li>FailoverServiceï¼Œä½œä¸šå¤±æ•ˆè½¬ç§»æœåŠ¡ã€‚</li>
<li>FailoverNodeï¼Œä½œä¸šå¤±æ•ˆè½¬ç§»æ•°æ®å­˜å‚¨è·¯å¾„ã€‚</li>
<li>FailoverListenerManagerï¼Œä½œä¸šå¤±æ•ˆè½¬ç§»ç›‘å¬ç®¡ç†å™¨ã€‚</li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-ä½œä¸šèŠ‚ç‚¹å´©æºƒç›‘å¬"><a href="#2-ä½œä¸šèŠ‚ç‚¹å´©æºƒç›‘å¬" class="headerlink" title="2. ä½œä¸šèŠ‚ç‚¹å´©æºƒç›‘å¬"></a>2. ä½œä¸šèŠ‚ç‚¹å´©æºƒç›‘å¬</h1><p>å½“ä½œä¸šèŠ‚ç‚¹å´©æºƒæ—¶ï¼Œç›‘å¬å™¨ JobCrashedJobListener ä¼šç›‘å¬åˆ°è¯¥æƒ…å†µï¼Œè¿›è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»å¤„ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobCrashedJobListener.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JobCrashedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (isFailoverEnabled() &amp;&amp; Type.NODE_REMOVED == eventType</div><div class="line">               &amp;&amp; instanceNode.isInstancePath(path)) &#123; <span class="comment">// /$&#123;JOB_NAME&#125;/instances/$&#123;INSTANCE_ID&#125;</span></div><div class="line">           String jobInstanceId = path.substring(instanceNode.getInstanceFullPath().length() + <span class="number">1</span>);</div><div class="line">           <span class="keyword">if</span> (jobInstanceId.equals(JobRegistry.getInstance().getJobInstance(jobName).getJobInstanceId())) &#123;</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           &#125;</div><div class="line">           List&lt;Integer&gt; failoverItems = failoverService.getFailoverItems(jobInstanceId); <span class="comment">// /$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/failover</span></div><div class="line">           <span class="keyword">if</span> (!failoverItems.isEmpty()) &#123;</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> each : failoverItems) &#123;</div><div class="line">                   failoverService.setCrashedFailoverFlag(each);</div><div class="line">                   failoverService.failoverIfNecessary();</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingService.getShardingItems(jobInstanceId)) &#123; <span class="comment">// /$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/instance</span></div><div class="line">                   failoverService.setCrashedFailoverFlag(each);</div><div class="line">                   failoverService.failoverIfNecessary();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>é€šè¿‡åˆ¤æ–­ <code>/${JOB_NAME}/instances/${INSTANCE_ID}</code> è¢«ç§»é™¤ï¼Œæ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»é€»è¾‘ã€‚â“è¯´å¥½çš„ä½œä¸šèŠ‚ç‚¹<strong>å´©æºƒ</strong>å‘¢ï¼Ÿç»è¿‡ç¡®è®¤ï¼Œç›®å‰è¿™å—å­˜åœ¨ BUGï¼Œæœªåˆ¤æ–­ä½œä¸šèŠ‚ç‚¹æ˜¯å¦ä¸ºå¥”æºƒã€‚<strong>æ‰€ä»¥åœ¨å½“å‰ç‰ˆæœ¬ï¼Œä½œä¸šå¤±æ•ˆè½¬ç§»é¢å‘çš„æ˜¯æ‰€æœ‰ä½œä¸šèŠ‚ç‚¹å…³é—­é€»è¾‘ï¼Œä¸ä»…é™äºä½œä¸šå´©æºƒå…³é—­ã€‚</strong></li>
<li><p>ä¼˜å…ˆè°ƒç”¨ <code>FailoverService#getFailoverItems(...)</code> æ–¹æ³•ï¼Œè·å¾—å…³é—­ä½œä¸šèŠ‚ç‚¹( <code>${JOB_INSTANCE_ID}</code> )å¯¹åº”çš„ <code>${JOB_NAME}/sharding/${ITEM_ID}/failover</code> ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p>
<p>è‹¥è¯¥ä½œä¸šåˆ†ç‰‡é¡¹ä¸ºç©ºï¼Œå†è°ƒç”¨ <code>ShardingService#getShardingItems(...)</code> æ–¹æ³•ï¼Œè·å¾—å…³é—­ä½œä¸šèŠ‚ç‚¹( <code>${JOB_INSTANCE_ID}</code> )å¯¹åº”çš„ <code>/${JOB_NAME}/sharding/${ITEM_ID}/instance</code> ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p>
<p>ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·çš„é¡ºåºå‘¢ï¼Ÿæ”¾åœ¨ <code>FailoverService#failoverIfNecessary()</code> ä¸€èµ·è®²ã€‚è¿™é‡Œå…ˆçœ‹ä¸‹ <code>FailoverService#getFailoverItems(...)</code> æ–¹æ³•çš„å®ç°ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getFailoverItems</span><span class="params">(<span class="keyword">final</span> String jobInstanceId)</span> </span>&#123;</div><div class="line">   List&lt;String&gt; items = jobNodeStorage.getJobNodeChildrenKeys(ShardingNode.ROOT);</div><div class="line">   List&lt;Integer&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(items.size());</div><div class="line">   <span class="keyword">for</span> (String each : items) &#123;</div><div class="line">       <span class="keyword">int</span> item = Integer.parseInt(each);</div><div class="line">       String node = FailoverNode.getExecutionFailoverNode(item); <span class="comment">// `$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/failover`</span></div><div class="line">       <span class="keyword">if</span> (jobNodeStorage.isJobNodeExisted(node) &amp;&amp; jobInstanceId.equals(jobNodeStorage.getJobNodeDataDirectly(node))) &#123;</div><div class="line">           result.add(item);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   Collections.sort(result);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>FailoverService#setCrashedFailoverFlag(...)</code> æ–¹æ³•ï¼Œè®¾ç½®å¤±æ•ˆçš„åˆ†ç‰‡é¡¹æ ‡è®° <code>/${JOB_NAME}/leader/failover/items/${ITEM_ID}</code>ã€‚è¯¥æ•°æ®èŠ‚ç‚¹ä¸º<strong>æ°¸ä¹…</strong>èŠ‚ç‚¹ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCrashedFailoverFlag</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> item)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!isFailoverAssigned(item)) &#123;</div><div class="line">       jobNodeStorage.createJobNodeIfNeeded(FailoverNode.getItemsNode(item)); <span class="comment">// /$&#123;JOB_NAME&#125;/leader/failover/items/$&#123;ITEM_ID&#125;</span></div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isFailoverAssigned</span><span class="params">(<span class="keyword">final</span> Integer item)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> jobNodeStorage.isJobNodeExisted(FailoverNode.getExecutionFailoverNode(item));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>FailoverService#failoverIfNecessary()</code> æ–¹æ³•ï¼Œå¦‚æœéœ€è¦å¤±æ•ˆè½¬ç§», åˆ™æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»ã€‚</p>
</li>
</ul>
<h1 id="3-ä½œä¸šå¤±æ•ˆè½¬ç§»"><a href="#3-ä½œä¸šå¤±æ•ˆè½¬ç§»" class="headerlink" title="3. ä½œä¸šå¤±æ•ˆè½¬ç§»"></a>3. ä½œä¸šå¤±æ•ˆè½¬ç§»</h1><p>è°ƒç”¨ <code>FailoverService#failoverIfNecessary()</code> æ–¹æ³•ï¼Œå¦‚æœéœ€è¦å¤±æ•ˆè½¬ç§», åˆ™æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failoverIfNecessary</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (needFailover()) &#123;</div><div class="line">       jobNodeStorage.executeInLeader(FailoverNode.LATCH, <span class="keyword">new</span> FailoverLeaderExecutionCallback());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>#needFailover()</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦æ»¡è¶³å¤±æ•ˆè½¬ç§»æ¡ä»¶ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">needFailover</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="comment">// `$&#123;JOB_NAME&#125;/leader/failover/items/$&#123;ITEM_ID&#125;` æœ‰å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">    <span class="keyword">return</span> jobNodeStorage.isJobNodeExisted(FailoverNode.ITEMS_ROOT) &amp;&amp; !jobNodeStorage.getJobNodeChildrenKeys(FailoverNode.ITEMS_ROOT).isEmpty()</div><div class="line">            <span class="comment">// å½“å‰ä½œä¸šä¸åœ¨è¿è¡Œä¸­</span></div><div class="line">            &amp;&amp; !JobRegistry.getInstance().isJobRunning(jobName);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ¡ä»¶ä¸€ï¼š<code>${JOB_NAME}/leader/failover/items/${ITEM_ID}</code> æœ‰å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</li>
<li><p>æ¡ä»¶äºŒï¼šå½“å‰ä½œä¸šä¸åœ¨è¿è¡Œä¸­ã€‚æ­¤æ¡ä»¶å³æ˜¯ä¸Šæ–‡æäº¤çš„ä½œä¸šèŠ‚ç‚¹<strong>ç©ºé—²</strong>çš„å®šä¹‰ã€‚</p>
<blockquote>
<p>å¤±æ•ˆè½¬ç§»ï¼š è¿è¡Œä¸­çš„ä½œä¸šæœåŠ¡å™¨å´©æºƒä¸ä¼šå¯¼è‡´é‡æ–°åˆ†ç‰‡ï¼Œåªä¼šåœ¨ä¸‹æ¬¡ä½œä¸šå¯åŠ¨æ—¶åˆ†ç‰‡ã€‚å¯ç”¨å¤±æ•ˆè½¬ç§»åŠŸèƒ½å¯ä»¥åœ¨æœ¬æ¬¡ä½œä¸šæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç›‘æµ‹å…¶ä»–ä½œä¸šæœåŠ¡å™¨ã€ç©ºé—²ã€‘ï¼ŒæŠ“å–æœªå®Œæˆçš„å­¤å„¿åˆ†ç‰‡é¡¹æ‰§è¡Œ</p>
</blockquote>
</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>JobNodeStorage#executeInLeader(...)</code> æ–¹æ³•ï¼Œä½¿ç”¨ <code>FailoverNode.LATCH</code>( <code>/${JOB_NAME}/leader/failover/latch</code> ) è·¯å¾„æ„æˆçš„<strong>åˆ†å¸ƒå¼é”</strong>ï¼Œä¿è¯ FailoverLeaderExecutionCallback çš„å›è°ƒæ–¹æ³•åŒä¸€æ—¶é—´ï¼Œå³ä½¿å¤šä¸ªä½œä¸šèŠ‚ç‚¹è°ƒç”¨ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªä½œä¸šèŠ‚ç‚¹è¿›è¡Œæ‰§è¡Œã€‚å¦å¤–ï¼Œè™½ç„¶ <code>JobNodeStorage#executeInLeader(...)</code> æ–¹æ³•ä¸Šå¸¦æœ‰ <code>Leader</code> å…³é”®å­—ï¼Œå®é™…éå¿…é¡»åœ¨ä¸»èŠ‚ç‚¹çš„æ“ä½œï¼Œä»»ä½•ä¸€ä¸ªæ‹¿åˆ°<strong>åˆ†å¸ƒå¼é”</strong>çš„ä½œä¸šèŠ‚ç‚¹éƒ½å¯ä»¥è°ƒç”¨ã€‚ç›®å‰å’Œ<strong>åˆ†å¸ƒå¼é”</strong>ç›¸å…³çš„é€»è¾‘ï¼Œåœ¨ Elastic-Job-Lite é‡Œï¼Œéƒ½ä¼šè°ƒç”¨ <code>JobNodeStorage#executeInLeader(...)</code> æ–¹æ³•ï¼Œæ•°æ®éƒ½å­˜å‚¨åœ¨ <code>/leader/</code> èŠ‚ç‚¹ç›®å½•ä¸‹ã€‚å…³äº<strong>åˆ†å¸ƒå¼é”</strong>ç›¸å…³çš„ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒã€‹ã€Œ3.1 åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œã€</a>æœ‰è¯¦ç»†åˆ†äº«ã€‚</p>
</li>
</ul>
<hr>
<p>FailoverLeaderExecutionCallback å›è°ƒé€»è¾‘å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FailoverLeaderExecutionCallback</span> <span class="keyword">implements</span> <span class="title">LeaderExecutionCallback</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">// åˆ¤æ–­éœ€è¦å¤±æ•ˆè½¬ç§»</span></div><div class="line">       <span class="keyword">if</span> (JobRegistry.getInstance().isShutdown(jobName) || !needFailover()) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// è·å¾—ä¸€ä¸ª `$&#123;JOB_NAME&#125;/leader/failover/items/$&#123;ITEM_ID&#125;` ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">       <span class="keyword">int</span> crashedItem = Integer.parseInt(jobNodeStorage.getJobNodeChildrenKeys(FailoverNode.ITEMS_ROOT).get(<span class="number">0</span>));</div><div class="line">       log.debug(<span class="string">"Failover job '&#123;&#125;' begin, crashed item '&#123;&#125;'"</span>, jobName, crashedItem);</div><div class="line">       <span class="comment">// è®¾ç½®è¿™ä¸ª `$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/failover` ä½œä¸šåˆ†ç‰‡é¡¹ ä¸º å½“å‰ä½œä¸šèŠ‚ç‚¹</span></div><div class="line">       jobNodeStorage.fillEphemeralJobNode(FailoverNode.getExecutionFailoverNode(crashedItem), JobRegistry.getInstance().getJobInstance(jobName).getJobInstanceId());</div><div class="line">       <span class="comment">// ç§»é™¤è¿™ä¸ª `$&#123;JOB_NAME&#125;/leader/failover/items/$&#123;ITEM_ID&#125;` ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">       jobNodeStorage.removeJobNodeIfExisted(FailoverNode.getItemsNode(crashedItem));</div><div class="line">       <span class="comment">// TODO ä¸åº”ä½¿ç”¨triggerJob, è€Œæ˜¯ä½¿ç”¨executorç»Ÿä¸€è°ƒåº¦ ç–‘é—®ï¼šä¸ºä»€ä¹ˆè¦ç”¨executorç»Ÿä¸€ï¼Œåé¢ç ”ç©¶ä¸‹</span></div><div class="line">       <span class="comment">// è§¦å‘ä½œä¸šæ‰§è¡Œ</span></div><div class="line">       JobScheduleController jobScheduleController = JobRegistry.getInstance().getJobScheduleController(jobName);</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> != jobScheduleController) &#123;</div><div class="line">           jobScheduleController.triggerJob();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å†æ¬¡è°ƒç”¨ <code>#needFailover()</code> æ–¹æ³•ï¼Œç¡®ä¿ç»è¿‡åˆ†å¸ƒå¼é”è·å–ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œä»ç„¶éœ€è¦å¤±æ•ˆè½¬ç§»ã€‚å› ä¸ºå¯èƒ½å¤šä¸ªä½œä¸šèŠ‚ç‚¹è°ƒç”¨äº†è¯¥å›è°ƒï¼Œç¬¬ä¸€ä¸ªä½œä¸šèŠ‚ç‚¹æ‰§è¡Œäº†å¤±æ•ˆè½¬ç§»ï¼Œå¯èƒ½ç¬¬äºŒä¸ªä½œä¸šèŠ‚ç‚¹å°±ä¸éœ€è¦æ‰§è¡Œå¤±æ•ˆè½¬ç§»äº†ã€‚</li>
<li><p>è°ƒç”¨ <code>JobNodeStorage#getJobNodeChildrenKeys(FailoverNode.ITEMS_ROOT)#get(0)</code> æ–¹æ³•ï¼Œè·å¾—<strong>ä¸€ä¸ª</strong> <code>${JOB_NAME}/leader/failover/items/${ITEM_ID}</code> ä½œä¸šåˆ†ç‰‡é¡¹ã€‚  </p>
<p>è°ƒç”¨ <code>JobNodeStorage#fillEphemeralJobNode(...)</code> æ–¹æ³•ï¼Œè®¾ç½®è¿™ä¸ª<strong>ä¸´æ—¶</strong>æ•°æ®èŠ‚ç‚¹ <code>${JOB_NAME}/sharding/${ITEM_ID}failover</code> ä½œä¸šåˆ†ç‰‡é¡¹ä¸ºå½“å‰ä½œä¸šèŠ‚ç‚¹( <code>${JOB_INSTANCE_ID}</code> )ã€‚  </p>
<p>è°ƒç”¨ <code>JobNodeStorage#removeJobNodeIfExisted(...)</code> æ–¹æ³•ï¼Œç§»é™¤è¿™ä¸ª<code>${JOB_NAME}/leader/failover/items/${ITEM_ID}</code> ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p>
</li>
<li><p>è°ƒç”¨ <code>JobScheduleController#triggerJob()</code> æ–¹æ³•ï¼Œç«‹å³å¯åŠ¨ä½œä¸šã€‚è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå®é™…ä½œä¸šä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œä»…ä»…æ˜¯è¿›è¡Œè§¦å‘ã€‚å¦‚æœæœ‰å¤šä¸ªå¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹ï¼Œå¤šæ¬¡è°ƒç”¨ <code>JobScheduleController#triggerJob()</code> æ–¹æ³•ä¼šä¸ä¼šå¯¼è‡´ä½œä¸šæ˜¯<strong>å¹¶è¡Œæ‰§è¡Œ</strong>çš„ï¼Ÿç­”æ¡ˆæ˜¯ä¸ä¼šï¼Œå› ä¸ºä¸€ä¸ªä½œä¸šçš„ Quartz çº¿ç¨‹æ•°è®¾ç½®ä¸º 1ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobScheduler.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> Properties <span class="title">getBaseQuartzProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">   Properties result = <span class="keyword">new</span> Properties();</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.threadCount"</span>, <span class="string">"1"</span>); <span class="comment">// Quartz çº¿ç¨‹æ•°ï¼š1</span></div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<p>å¦‚æœè¯´ä½œä¸šåˆ†ç‰‡é¡¹å®ç°è½¬ç§»æ—¶ï¼Œæ¯ä¸ªä½œä¸šèŠ‚ç‚¹éƒ½ä¸å¤„äºéç©ºé—²çŠ¶æ€ï¼Œå²‚ä¸æ˜¯ FailoverLeaderExecutionCallback ä¸€ç›´æ— æ³•è¢«å›è°ƒï¼Ÿç­”æ¡ˆå½“ç„¶ä¸æ˜¯çš„ã€‚ä½œä¸šåœ¨æ‰§è¡Œå®Œåˆ†é…ç»™è‡ªå·±çš„ä½œä¸šåˆ†ç‰‡é¡¹ï¼Œä¼šè°ƒç”¨ <code>LiteJobFacade#failoverIfNecessary()</code> æ–¹æ³•ï¼Œè¿›è¡Œå¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹æŠ“å–ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ...  çœç•¥æ— å…³ä»£ç </span></div><div class="line">   </div><div class="line">   <span class="comment">// æ‰§è¡Œ æ™®é€šè§¦å‘çš„ä½œä¸š</span></div><div class="line">   execute(shardingContexts, JobExecutionEvent.ExecutionSource.NORMAL_TRIGGER);</div><div class="line">   <span class="comment">// æ‰§è¡Œ è¢«è·³è¿‡è§¦å‘çš„ä½œä¸š</span></div><div class="line">   <span class="keyword">while</span> (jobFacade.isExecuteMisfired(shardingContexts.getShardingItemParameters().keySet())) &#123;</div><div class="line">       jobFacade.clearMisfire(shardingContexts.getShardingItemParameters().keySet());</div><div class="line">       execute(shardingContexts, JobExecutionEvent.ExecutionSource.MISFIRE);</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="comment">// æ‰§è¡Œ ä½œä¸šå¤±æ•ˆè½¬ç§»</span></div><div class="line">   jobFacade.failoverIfNecessary();</div><div class="line">   </div><div class="line">   <span class="comment">// ...  çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failoverIfNecessary</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (configService.load(<span class="keyword">true</span>).isFailover()) &#123;</div><div class="line">       failoverService.failoverIfNecessary();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failoverIfNecessary</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (needFailover()) &#123;</div><div class="line">       jobNodeStorage.executeInLeader(FailoverNode.LATCH, <span class="keyword">new</span> FailoverLeaderExecutionCallback());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è®©æˆ‘ä»¬åœ¨ç¿»å› JobCrashedJobListener å¤„ä»£ç ï¼Œä¸ºä»€ä¹ˆè·å–å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹æ˜¯è¿™æ ·çš„ä¼˜å…ˆé¡ºåºï¼Ÿä¸€ä¸ªä½œä¸šèŠ‚ç‚¹æ‹¥æœ‰ <code>${JOB_NAME}/sharding/${ITEM_ID}/failover</code> æ•°æ®åˆ†ç‰‡é¡¹ï¼Œæ„å‘³ç€åˆ†é…ç»™å®ƒçš„ä½œä¸šåˆ†ç‰‡é¡¹å·²ç»æ‰§è¡Œå®Œæˆï¼Œå¦åˆ™æ€ä¹ˆå›è°ƒ FailoverLeaderExecutionCallback æ–¹æ³•ï¼ŒæŠ“å–å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹å‘¢ï¼Ÿï¼</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_07/02.png" alt=""></p>
<p>æ—ç™½å›ï¼šåŒå‡»666ï¼Œå…³æ³¨ç¬”è€…å…¬ä¼—å·ä¸€æ³¢ã€‚</p>
<h1 id="4-è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ"><a href="#4-è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ" class="headerlink" title="4. è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ"></a>4. è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</h1><p>åœ¨<a href="http://www.yunai.me/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹ã€Œ4.2 è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡ã€</a>ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä½œä¸šæ‰§è¡Œå™¨( AbstractElasticJobExecutor ) æ‰§è¡Œä½œä¸šæ—¶ï¼Œä¼šè·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡è¿›è¡Œæ‰§è¡Œã€‚è·å–è¿‡ç¨‹æ€»ä½“å¦‚ä¸‹é¡ºåºå›¾( <a href="http://www.yunai.me/images/Elastic-Job/2017_11_07/03.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_07/03.png" alt=""></p>
<ul>
<li>çº¢è‰²å‰å‰åœ¨<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a>æœ‰è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ShardingContexts <span class="title">getShardingContexts</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å¾— å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">   <span class="keyword">boolean</span> isFailover = configService.load(<span class="keyword">true</span>).isFailover();</div><div class="line">   <span class="keyword">if</span> (isFailover) &#123;</div><div class="line">       List&lt;Integer&gt; failoverShardingItems = failoverService.getLocalFailoverItems();</div><div class="line">       <span class="keyword">if</span> (!failoverShardingItems.isEmpty()) &#123;</div><div class="line">           <span class="comment">// ã€å¿½ç•¥ï¼Œä½œä¸šåˆ†ç‰‡è¯¦è§£ã€‘è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨åˆ†ç‰‡ä¸Šä¸‹æ–‡</span></div><div class="line">           <span class="keyword">return</span> executionContextService.getJobShardingContext(failoverShardingItems);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ã€å¿½ç•¥ï¼Œä½œä¸šåˆ†ç‰‡è¯¦è§£ã€‘ä½œä¸šåˆ†ç‰‡ï¼Œå¦‚æœéœ€è¦åˆ†ç‰‡ä¸”å½“å‰èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹</span></div><div class="line">   shardingService.shardingIfNecessary();</div><div class="line">   <span class="comment">// ã€å¿½ç•¥ï¼Œä½œä¸šåˆ†ç‰‡è¯¦è§£ã€‘è·å¾— åˆ†é…åœ¨æœ¬æœºçš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">   List&lt;Integer&gt; shardingItems = shardingService.getLocalShardingItems();</div><div class="line">   <span class="comment">// ç§»é™¤ åˆ†é…åœ¨æœ¬æœºçš„å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹ç›®</span></div><div class="line">   <span class="keyword">if</span> (isFailover) &#123;</div><div class="line">       shardingItems.removeAll(failoverService.getLocalTakeOffItems());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç§»é™¤ è¢«ç¦ç”¨çš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">   shardingItems.removeAll(executionService.getDisabledItems(shardingItems));</div><div class="line">   <span class="comment">// ã€å¿½ç•¥ï¼Œä½œä¸šåˆ†ç‰‡è¯¦è§£ã€‘è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨åˆ†ç‰‡ä¸Šä¸‹æ–‡</span></div><div class="line">   <span class="keyword">return</span> executionContextService.getJobShardingContext(shardingItems);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>FailoverService#getLocalFailoverItems()</code> æ–¹æ³•ï¼Œè·å–è¿è¡Œåœ¨æœ¬ä½œä¸šèŠ‚ç‚¹çš„å¤±æ•ˆè½¬ç§»åˆ†ç‰‡é¡¹é›†åˆã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getLocalFailoverItems</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (JobRegistry.getInstance().isShutdown(jobName)) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> getFailoverItems(JobRegistry.getInstance().getJobInstance(jobName).getJobInstanceId()); <span class="comment">// `$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/failover`</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>ExecutionContextService#getJobShardingContext()</code> æ–¹æ³•ï¼Œè·å–å½“å‰ä½œä¸šæœåŠ¡å™¨åˆ†ç‰‡ä¸Šä¸‹æ–‡ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹ã€Œ4. è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆã€</a>æœ‰è¯¦ç»†è§£æã€‚</p>
</li>
<li><p>å½“æœ¬ä½œä¸šèŠ‚ç‚¹ä¸å­˜åœ¨æŠ“å–çš„å¤±æ•ˆè½¬ç§»åˆ†ç‰‡é¡¹ï¼Œåˆ™è·å¾—åˆ†é…ç»™æœ¬ä½œä¸šåˆ†è§£çš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚æ­¤æ—¶ä½ ä¼šçœ‹åˆ°ç•¥å¥‡æ€ªçš„æ–¹æ³•è°ƒç”¨ï¼Œ<code>shardingItems.removeAll(failoverService.getLocalTakeOffItems())</code>ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼Œä½œä¸šèŠ‚ç‚¹AæŒæœ‰ä½œä¸šåˆ†ç‰‡é¡¹[0, 1]ï¼Œæ­¤æ—¶å¼‚å¸¸æ–­ç½‘ï¼Œå¯¼è‡´[0, 1]è¢«ä½œä¸šèŠ‚ç‚¹Bå¤±æ•ˆè½¬ç§»æŠ“å–ï¼Œæ­¤æ—¶è‹¥ä½œä¸šèŠ‚ç‚¹Aæ¢å¤ï¼Œä½œä¸šåˆ†ç‰‡é¡¹[0, 1]ä¾ç„¶å±äºä½œä¸šèŠ‚ç‚¹Aï¼Œä½†æ˜¯å¯èƒ½å·²ç»åœ¨ä½œä¸šèŠ‚ç‚¹Bæ‰§è¡Œï¼Œå› æ­¤éœ€è¦è¿›è¡Œç§»é™¤ï¼Œé¿å…å¤šèŠ‚ç‚¹è¿è¡Œç›¸åŒçš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚<code>FailoverService#getLocalTakeOffItems()</code> æ–¹æ³•å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–è¿è¡Œåœ¨æœ¬ä½œä¸šæœåŠ¡å™¨çš„è¢«å¤±æ•ˆè½¬ç§»çš„åºåˆ—å·.</div><div class="line">* </div><div class="line">* <span class="doctag">@return</span> è¿è¡Œåœ¨æœ¬ä½œä¸šæœåŠ¡å™¨çš„è¢«å¤±æ•ˆè½¬ç§»çš„åºåˆ—å·</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getLocalTakeOffItems</span><span class="params">()</span> </span>&#123;</div><div class="line">   List&lt;Integer&gt; shardingItems = shardingService.getLocalShardingItems();</div><div class="line">   List&lt;Integer&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(shardingItems.size());</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingItems) &#123;</div><div class="line">       <span class="keyword">if</span> (jobNodeStorage.isJobNodeExisted(FailoverNode.getExecutionFailoverNode(each))) &#123;</div><div class="line">           result.add(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="5-ç›‘å¬ä½œä¸šå¤±æ•ˆè½¬ç§»åŠŸèƒ½å…³é—­"><a href="#5-ç›‘å¬ä½œä¸šå¤±æ•ˆè½¬ç§»åŠŸèƒ½å…³é—­" class="headerlink" title="5. ç›‘å¬ä½œä¸šå¤±æ•ˆè½¬ç§»åŠŸèƒ½å…³é—­"></a>5. ç›‘å¬ä½œä¸šå¤±æ•ˆè½¬ç§»åŠŸèƒ½å…³é—­</h1><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FailoverSettingsChangedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">        </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (configNode.isConfigPath(path) &amp;&amp; Type.NODE_UPDATED == eventType</div><div class="line">               &amp;&amp; !LiteJobConfigurationGsonFactory.fromJson(data).isFailover()) &#123; <span class="comment">// å…³é—­å¤±æ•ˆè½¬ç§»åŠŸèƒ½</span></div><div class="line">           failoverService.removeFailoverInfo();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šå•Šå•Šå•Šï¼Œæœ‰ç‚¹ç»•ã€‚<br>èŠ‹é“å›ï¼šè€å¿ƒï¼Œè€å¿ƒï¼Œè€å¿ƒã€‚</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_11_07/04.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘&lt;/strong&gt;æœ‰ç¦
    
    </summary>
    
      <category term="Elastic-Job" scheme="http://www.yunai.me/categories/Elastic-Job/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆ†ç‰‡</title>
    <link href="http://www.yunai.me/Elastic-Job/job-sharding/"/>
    <id>http://www.yunai.me/Elastic-Job/job-sharding/</id>
    <published>2017-10-30T16:00:00.000Z</published>
    <updated>2017-08-28T09:49:45.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ä½œä¸šåˆ†ç‰‡æ¡ä»¶</a></li>
<li><a href="#">3. åˆ†é…ä½œä¸šåˆ†ç‰‡é¡¹</a></li>
<li><a href="#">4. è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šåˆ†ç‰‡</strong>ã€‚</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_10_31/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_31/01.png" alt=""></p>
<ul>
<li>ç²‰è‰²çš„ç±»åœ¨ <code>com.dangdang.ddframe.job.lite.internal.sharding</code> åŒ…ä¸‹ï¼Œå®ç°äº† Elastic-Job-Lite ä½œä¸šåˆ†ç‰‡ã€‚</li>
<li>ShardingServiceï¼Œä½œä¸šåˆ†ç‰‡æœåŠ¡ã€‚</li>
<li>ShardingNodeï¼Œä½œä¸šåˆ†ç‰‡æ•°æ®å­˜å‚¨è·¯å¾„ã€‚</li>
<li>ShardingListenerManagerï¼Œä½œä¸šåˆ†ç‰‡ç›‘å¬ç®¡ç†å™¨ã€‚</li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-ä½œä¸šåˆ†ç‰‡æ¡ä»¶"><a href="#2-ä½œä¸šåˆ†ç‰‡æ¡ä»¶" class="headerlink" title="2. ä½œä¸šåˆ†ç‰‡æ¡ä»¶"></a>2. ä½œä¸šåˆ†ç‰‡æ¡ä»¶</h1><p>å½“ä½œä¸šæ»¡è¶³åˆ†ç‰‡æ¡ä»¶æ—¶ï¼Œä¸ä¼š<strong>ç«‹å³</strong>è¿›è¡Œä½œä¸šåˆ†ç‰‡åˆ†é…ï¼Œè€Œæ˜¯è®¾ç½®éœ€è¦é‡æ–°è¿›è¡Œåˆ†ç‰‡çš„<strong>æ ‡è®°</strong>ï¼Œç­‰åˆ°ä½œä¸šåˆ†ç‰‡è·å–æ—¶ï¼Œåˆ¤æ–­æœ‰è¯¥æ ‡è®°å<strong>æ‰§è¡Œ</strong>ä½œä¸šåˆ†é…ã€‚</p>
<p>è®¾ç½®éœ€è¦é‡æ–°è¿›è¡Œåˆ†ç‰‡çš„<strong>æ ‡è®°</strong>çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¾ç½®éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReshardingFlag</span><span class="params">()</span> </span>&#123;</div><div class="line">   jobNodeStorage.createJobNodeIfNeeded(ShardingNode.NECESSARY);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobNodeStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å¦‚æœå­˜åœ¨åˆ™åˆ›å»ºä½œä¸šèŠ‚ç‚¹.</div><div class="line">* å¦‚æœä½œä¸šæ ¹èŠ‚ç‚¹ä¸å­˜åœ¨è¡¨ç¤ºä½œä¸šå·²ç»åœæ­¢, ä¸å†ç»§ç»­åˆ›å»ºèŠ‚ç‚¹.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> node ä½œä¸šèŠ‚ç‚¹åç§°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createJobNodeIfNeeded</span><span class="params">(<span class="keyword">final</span> String node)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (isJobRootNodeExisted() &amp;&amp; !isJobNodeExisted(node)) &#123;</div><div class="line">       regCenter.persist(jobNodePath.getFullPath(node), <span class="string">""</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>#setReshardingFlag()</code> æ–¹æ³•è®¾ç½®<strong>éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°</strong> <code>/${JOB_NAME}/leader/sharding/necessary</code>ã€‚è¯¥ Zookeeper æ•°æ®èŠ‚ç‚¹æ˜¯<strong>æ°¸ä¹…</strong>èŠ‚ç‚¹ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ï¼Œä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 2] ls /elastic-job-example-lite-java/javaSimpleJob/leader/sharding</div><div class="line">[necessary]</div><div class="line">[zk: localhost:2181(CONNECTED) 3] get /elastic-job-example-lite-java/javaSimpleJob/leader/sharding/necessary</div></pre></td></tr></table></figure>
</li>
<li><p>è®¾ç½®æ ‡è®°ä¹‹åï¼Œé€šè¿‡è°ƒç”¨ <code>#isNeedSharding()</code> æ–¹æ³•å³å¯åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°åˆ†ç‰‡ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ¤æ–­æ˜¯å¦éœ€è¦é‡åˆ†ç‰‡.</div><div class="line">* </div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦éœ€è¦é‡åˆ†ç‰‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isNeedSharding</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> jobNodeStorage.isJobNodeExisted(ShardingNode.NECESSARY);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobNodeStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ¤æ–­ä½œä¸šèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> node ä½œä¸šèŠ‚ç‚¹åç§°</div><div class="line">* <span class="doctag">@return</span> ä½œä¸šèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isJobNodeExisted</span><span class="params">(<span class="keyword">final</span> String node)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> regCenter.isExisted(jobNodePath.getFullPath(node));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>è®¾ç½®éœ€è¦é‡æ–°è¿›è¡Œåˆ†ç‰‡æœ‰ 4 ç§æƒ…å†µ</strong></p>
<p><strong>ç¬¬ä¸€ç§</strong>ï¼Œæ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯æ—¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerFacade.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStartUpInfo</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> enabled)</span> </span>&#123;</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">   <span class="comment">// è®¾ç½® éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°</span></div><div class="line">   shardingService.setReshardingFlag();</div><div class="line">  <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>ç¬¬äºŒç§</strong>ï¼Œä½œä¸šåˆ†ç‰‡æ€»æ•°( <code>JobCoreConfiguration.shardingTotalCount</code> )å˜åŒ–æ—¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingTotalCountChangedJobListener.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShardingTotalCountChangedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (configNode.isConfigPath(path)</div><div class="line">               &amp;&amp; <span class="number">0</span> != JobRegistry.getInstance().getCurrentShardingTotalCount(jobName)) &#123;</div><div class="line">           <span class="keyword">int</span> newShardingTotalCount = LiteJobConfigurationGsonFactory.fromJson(data).getTypeConfig().getCoreConfig().getShardingTotalCount();</div><div class="line">           <span class="keyword">if</span> (newShardingTotalCount != JobRegistry.getInstance().getCurrentShardingTotalCount(jobName)) &#123; <span class="comment">// ä½œä¸šåˆ†ç‰‡æ€»æ•°å˜åŒ–</span></div><div class="line">               <span class="comment">// è®¾ç½®éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°</span></div><div class="line">               shardingService.setReshardingFlag();</div><div class="line">               <span class="comment">// è®¾ç½®å½“å‰åˆ†ç‰‡æ€»æ•°</span></div><div class="line">               JobRegistry.getInstance().setCurrentShardingTotalCount(jobName, newShardingTotalCount);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>ç¬¬ä¸‰ç§</strong>ï¼ŒæœåŠ¡å™¨å˜åŒ–æ—¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingListenerManager.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListenServersChangedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (!JobRegistry.getInstance().isShutdown(jobName)</div><div class="line">               &amp;&amp; (isInstanceChange(eventType, path)</div><div class="line">                   || isServerChange(path))) &#123;</div><div class="line">           shardingService.setReshardingFlag();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isInstanceChange</span><span class="params">(<span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String path)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> instanceNode.isInstancePath(path) &amp;&amp; Type.NODE_UPDATED != eventType;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isServerChange</span><span class="params">(<span class="keyword">final</span> String path)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> serverNode.isServerPath(path);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æœåŠ¡å™¨å˜åŒ–æœ‰<strong>ä¸¤ç§</strong>æƒ…å†µã€‚</li>
<li>ç¬¬ä¸€ç§ï¼Œ<code>#isServerChange(...)</code> æœåŠ¡å™¨è¢«å¼€å¯æˆ–ç¦ç”¨ã€‚</li>
<li>ç¬¬äºŒç§ï¼Œ<code>#isInstanceChange(...)</code> ä½œä¸šèŠ‚ç‚¹æ–°å¢æˆ–è€…ç§»é™¤ã€‚</li>
</ul>
<p><strong>ç¬¬å››ç§</strong>ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/reconcile/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” è‡ªè¯Šæ–­ä¿®å¤ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
<h1 id="3-åˆ†é…ä½œä¸šåˆ†ç‰‡é¡¹"><a href="#3-åˆ†é…ä½œä¸šåˆ†ç‰‡é¡¹" class="headerlink" title="3. åˆ†é…ä½œä¸šåˆ†ç‰‡é¡¹"></a>3. åˆ†é…ä½œä¸šåˆ†ç‰‡é¡¹</h1><p>è°ƒç”¨ <code>ShardingService#shardingIfNecessary()</code> æ–¹æ³•ï¼Œå¦‚æœéœ€è¦åˆ†ç‰‡ä¸”å½“å‰èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹, åˆ™ä½œä¸šåˆ†ç‰‡ã€‚</p>
<p>æ€»ä½“æµç¨‹å¦‚ä¸‹<strong>é¡ºåºå›¾</strong>ï¼š( <a href="http://www.yunai.me/images/Elastic-Job/2017_10_31/02.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_31/02.png" alt=""></p>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å¦‚æœéœ€è¦åˆ†ç‰‡ä¸”å½“å‰èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹, åˆ™ä½œä¸šåˆ†ç‰‡.</div><div class="line">* </div><div class="line">* å¦‚æœå½“å‰æ— å¯ç”¨èŠ‚ç‚¹åˆ™ä¸åˆ†ç‰‡.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shardingIfNecessary</span><span class="params">()</span> </span>&#123;</div><div class="line">   List&lt;JobInstance&gt; availableJobInstances = instanceService.getAvailableJobInstances();</div><div class="line">   <span class="keyword">if</span> (!isNeedSharding() <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°åˆ†ç‰‡</span></div><div class="line">           || availableJobInstances.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ã€éä¸»èŠ‚ç‚¹ã€‘ç­‰å¾… ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…å®Œæˆ</span></div><div class="line">   <span class="keyword">if</span> (!leaderService.isLeaderUntilBlock()) &#123; <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºã€ä¸»èŠ‚ç‚¹ã€‘</span></div><div class="line">       blockUntilShardingCompleted();</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ã€ä¸»èŠ‚ç‚¹ã€‘ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…</span></div><div class="line">   <span class="comment">// ç­‰å¾… ä½œä¸šæœªåœ¨è¿è¡Œä¸­çŠ¶æ€</span></div><div class="line">   waitingOtherJobCompleted();</div><div class="line">   <span class="comment">//</span></div><div class="line">   LiteJobConfiguration liteJobConfig = configService.load(<span class="keyword">false</span>);</div><div class="line">   <span class="keyword">int</span> shardingTotalCount = liteJobConfig.getTypeConfig().getCoreConfig().getShardingTotalCount();</div><div class="line">   <span class="comment">// è®¾ç½® ä½œä¸šæ­£åœ¨é‡åˆ†ç‰‡çš„æ ‡è®°</span></div><div class="line">   log.debug(<span class="string">"Job '&#123;&#125;' sharding begin."</span>, jobName);</div><div class="line">   jobNodeStorage.fillEphemeralJobNode(ShardingNode.PROCESSING, <span class="string">""</span>);</div><div class="line">   <span class="comment">// é‡ç½® ä½œä¸šåˆ†ç‰‡é¡¹ä¿¡æ¯</span></div><div class="line">   resetShardingInfo(shardingTotalCount);</div><div class="line">   <span class="comment">// ã€äº‹åŠ¡ä¸­ã€‘è®¾ç½® ä½œä¸šåˆ†ç‰‡é¡¹ä¿¡æ¯</span></div><div class="line">   JobShardingStrategy jobShardingStrategy = JobShardingStrategyFactory.getStrategy(liteJobConfig.getJobShardingStrategyClass());</div><div class="line">   jobNodeStorage.executeInTransaction(<span class="keyword">new</span> PersistShardingInfoTransactionExecutionCallback(jobShardingStrategy.sharding(availableJobInstances, jobName, shardingTotalCount)));</div><div class="line">   log.debug(<span class="string">"Job '&#123;&#125;' sharding complete."</span>, jobName);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>#isNeedSharding()</code> æ–¹æ³•åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°åˆ†ç‰‡ã€‚</li>
<li>è°ƒç”¨ <code>LeaderService#isLeaderUntilBlock()</code> æ–¹æ³•åˆ¤æ–­æ˜¯å¦ä¸º<strong>ä¸»èŠ‚ç‚¹</strong>ã€‚ä½œä¸šåˆ†ç‰‡é¡¹çš„åˆ†é…è¿‡ç¨‹ï¼š<ul>
<li>ã€ä¸»èŠ‚ç‚¹ã€‘<strong>æ‰§è¡Œ</strong>ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…ã€‚</li>
<li>ã€éä¸»èŠ‚ç‚¹ã€‘<strong>ç­‰å¾…</strong>ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…å®Œæˆã€‚</li>
<li><code>LeaderService#isLeaderUntilBlock()</code> æ–¹æ³•åœ¨<a href="http://www.yunai.me/Elastic-Job/election/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‹ã€Œ3. é€‰ä¸¾ä¸»èŠ‚ç‚¹ã€</a>æœ‰è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>#blockUntilShardingCompleted()</code> æ–¹æ³•ã€éä¸»èŠ‚ç‚¹ã€‘<strong>ç­‰å¾…</strong>ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…å®Œæˆã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">blockUntilShardingCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">while</span> (!leaderService.isLeaderUntilBlock() <span class="comment">// å½“å‰ä½œä¸šèŠ‚ç‚¹ä¸ä¸ºã€ä¸»èŠ‚ç‚¹ã€‘</span></div><div class="line">           &amp;&amp; (jobNodeStorage.isJobNodeExisted(ShardingNode.NECESSARY) <span class="comment">// å­˜åœ¨ä½œä¸šéœ€è¦é‡åˆ†ç‰‡çš„æ ‡è®°</span></div><div class="line">               || jobNodeStorage.isJobNodeExisted(ShardingNode.PROCESSING))) &#123; <span class="comment">// å­˜åœ¨ä½œä¸šæ­£åœ¨é‡åˆ†ç‰‡çš„æ ‡è®°</span></div><div class="line">       log.debug(<span class="string">"Job '&#123;&#125;' sleep short time until sharding completed."</span>, jobName);</div><div class="line">       BlockUtils.waitingShortTime();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>#LeaderService#isLeaderUntilBlock()</code> æ–¹æ³•åˆ¤æ–­æ˜¯å¦ä¸º<strong>ä¸»èŠ‚ç‚¹</strong>ã€‚ä¸ºä»€ä¹ˆä¸Šé¢åˆ¤æ–­äº†ä¸€æ¬¡ï¼Œè¿™é‡Œåˆåˆ¤æ–­ä¸€æ¬¡ï¼Ÿä¸»èŠ‚ç‚¹ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…è¿‡ç¨‹ä¸­ï¼Œä¸æ’é™¤è‡ªå·±æŒ‚æ‰äº†ï¼Œæ­¤æ—¶ã€éä¸»èŠ‚ç‚¹ã€‘è‹¥é€‰ä¸¾æˆä¸»èŠ‚ç‚¹ï¼Œæ— éœ€ç»§ç»­ç­‰å¾…ï¼Œå½“ç„¶ä¹Ÿä¸èƒ½ç­‰å¾…ï¼Œå› ä¸ºå·²ç»æ²¡èŠ‚ç‚¹åœ¨æ‰§è¡Œä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šå¡åœ¨è¿™é‡Œã€‚</li>
<li>å½“ <strong>ä½œä¸šéœ€è¦é‡åˆ†ç‰‡çš„æ ‡è®°</strong>ã€<strong>ä½œä¸šæ­£åœ¨é‡åˆ†ç‰‡çš„æ ‡è®°</strong> éƒ½ä¸å­˜åœ¨æ—¶ï¼Œæ„å‘³ç€ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…å·²ç»å®Œæˆï¼Œä¸‹æ–‡ PersistShardingInfoTransactionExecutionCallback ç±»é‡Œæˆ‘ä»¬ä¼šçœ‹åˆ°ã€‚</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>#waitingOtherJobCompleted()</code> æ–¹æ³•ç­‰å¾…ä½œä¸šæœªåœ¨è¿è¡Œä¸­çŠ¶æ€ã€‚ä½œä¸šæ˜¯å¦åœ¨è¿è¡Œä¸­éœ€è¦ <code>LiteJobConfiguration.monitorExecution = true</code>ï¼Œ<a href="http://www.yunai.me/Elastic-Job/election/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹ã€Œ4.6 æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸šã€</a>æœ‰è¯¦ç»†åˆ†äº«ã€‚</p>
</li>
<li>è°ƒç”¨ <code>ConfigurationService#load(...)</code> æ–¹æ³•ä»æ³¨å†Œä¸­å¿ƒè·å–ä½œä¸šé…ç½®( <strong>éç¼“å­˜</strong> )ï¼Œé¿å…ä¸»èŠ‚ç‚¹æœ¬åœ°ä½œä¸šé…ç½®å¯èƒ½éæœ€æ–°çš„ï¼Œä¸»è¦ç›®çš„æ˜¯è·å¾—ä½œä¸šåˆ†ç‰‡æ€»æ•°( <code>shardingTotalCount</code> )ã€‚</li>
<li>è°ƒç”¨ <code>jobNodeStorage.fillEphemeralJobNode(ShardingNode.PROCESSING, &quot;&quot;)</code> è®¾ç½®<strong>ä½œä¸šæ­£åœ¨é‡åˆ†ç‰‡çš„æ ‡è®°</strong> <code>/${JOB_NAME}/leader/sharding/processing</code>ã€‚è¯¥ Zookeeper æ•°æ®èŠ‚ç‚¹æ˜¯<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ï¼Œä»…ç”¨äºæ ‡è®°ä½œä¸šæ­£åœ¨é‡åˆ†ç‰‡ï¼Œæ— ç‰¹åˆ«ä¸šåŠ¡é€»è¾‘ã€‚</li>
<li><p>è°ƒç”¨ <code>#resetShardingInfo(...)</code> æ–¹æ³•<strong>é‡ç½®</strong>ä½œä¸šåˆ†ç‰‡ä¿¡æ¯ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resetShardingInfo</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount)</span> </span>&#123;</div><div class="line">  <span class="comment">// é‡ç½® æœ‰æ•ˆçš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shardingTotalCount; i++) &#123;</div><div class="line">      jobNodeStorage.removeJobNodeIfExisted(ShardingNode.getInstanceNode(i)); <span class="comment">// ç§»é™¤ `/$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/instance`</span></div><div class="line">      jobNodeStorage.createJobNodeIfNeeded(ShardingNode.ROOT + <span class="string">"/"</span> + i); <span class="comment">// åˆ›å»º `/$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;`</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">// ç§»é™¤ å¤šä½™çš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">  <span class="keyword">int</span> actualShardingTotalCount = jobNodeStorage.getJobNodeChildrenKeys(ShardingNode.ROOT).size();</div><div class="line">  <span class="keyword">if</span> (actualShardingTotalCount &gt; shardingTotalCount) &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = shardingTotalCount; i &lt; actualShardingTotalCount; i++) &#123;</div><div class="line">          jobNodeStorage.removeJobNodeIfExisted(ShardingNode.ROOT + <span class="string">"/"</span> + i); <span class="comment">// ç§»é™¤ `/$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;`</span></div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>JobShardingStrategy#sharding(...)</code> æ–¹æ³•<strong>è®¡ç®—</strong>æ¯ä¸ªèŠ‚ç‚¹åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚<a href="http://www.yunai.me/Elastic-Job/job-sharding-strategy/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆ†ç‰‡ç­–ç•¥ã€‹</a>æœ‰è¯¦ç»†åˆ†äº«ã€‚</p>
</li>
<li><p>è°ƒç”¨ <code>JobNodeStorage#executeInTransaction(...)</code> + <code>PersistShardingInfoTransactionExecutionCallback#execute()</code> æ–¹æ³•å®ç°åœ¨<strong>äº‹åŠ¡</strong>ä¸­<strong>è®¾ç½®</strong>æ¯ä¸ªèŠ‚ç‚¹åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PersistShardingInfoTransactionExecutionCallback.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersistShardingInfoTransactionExecutionCallback</span> <span class="keyword">implements</span> <span class="title">TransactionExecutionCallback</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…ç»“æœ</div><div class="line">    * keyï¼šä½œä¸šèŠ‚ç‚¹</div><div class="line">    * valueï¼šä½œä¸šåˆ†ç‰‡é¡¹</div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;JobInstance, List&lt;Integer&gt;&gt; shardingResults;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> CuratorTransactionFinal curatorTransactionFinal)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       <span class="comment">// è®¾ç½® æ¯ä¸ªèŠ‚ç‚¹åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">       <span class="keyword">for</span> (Map.Entry&lt;JobInstance, List&lt;Integer&gt;&gt; entry : shardingResults.entrySet()) &#123;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> shardingItem : entry.getValue()) &#123;</div><div class="line">               curatorTransactionFinal.create().forPath(jobNodePath.getFullPath(ShardingNode.getInstanceNode(shardingItem))</div><div class="line">                       , entry.getKey().getJobInstanceId().getBytes()).and();</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// ç§»é™¤ ä½œä¸šéœ€è¦é‡åˆ†ç‰‡çš„æ ‡è®°ã€ä½œä¸šæ­£åœ¨é‡åˆ†ç‰‡çš„æ ‡è®°</span></div><div class="line">       curatorTransactionFinal.delete().forPath(jobNodePath.getFullPath(ShardingNode.NECESSARY)).and();</div><div class="line">       curatorTransactionFinal.delete().forPath(jobNodePath.getFullPath(ShardingNode.PROCESSING)).and();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobNodeStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> callback æ‰§è¡Œæ“ä½œçš„å›è°ƒ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeInTransaction</span><span class="params">(<span class="keyword">final</span> TransactionExecutionCallback callback)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       CuratorTransactionFinal curatorTransactionFinal = getClient().inTransaction().check().forPath(<span class="string">"/"</span>).and();</div><div class="line">       callback.execute(curatorTransactionFinal);</div><div class="line">       curatorTransactionFinal.commit();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è®¾ç½®<strong>ä¸´æ—¶</strong>æ•°æ®èŠ‚ç‚¹ <code>/${JOB_NAME}/sharding/${ITEM_ID}/instance</code> ä¸ºåˆ†é…çš„ä½œä¸šèŠ‚ç‚¹çš„ä½œä¸šå®ä¾‹ä¸»é”®( <code>jobInstanceId</code> )ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 0] get /elastic-job-example-lite-java/javaSimpleJob/sharding/0/instance</div><div class="line">192.168.3.2@-@31492</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p><strong>ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…æ•´ä½“æµç¨‹æœ‰ç‚¹é•¿ï¼Œè€ç€å¿ƒçœ‹ï¼Œæ¯•ç«Ÿæ˜¯æ ¸å¿ƒä»£ç å“Ÿã€‚å¦‚æœä¸­é—´æœ‰ä»»ä½•ç–‘é—®ï¼Œæ¬¢è¿ç»™æˆ‘å…¬ä¼—å·ï¼š<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">èŠ‹é“æºç </a> ç•™è¨€ã€‚</strong></p>
<h1 id="4-è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ"><a href="#4-è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ" class="headerlink" title="4. è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ"></a>4. è·å–ä½œä¸šåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</h1><p>åœ¨<a href="http://www.yunai.me/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œçš„ã€‹ã€Œ4.2 è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡ã€</a>ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä½œä¸šæ‰§è¡Œå™¨( AbstractElasticJobExecutor ) æ‰§è¡Œä½œä¸šæ—¶ï¼Œä¼šè·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡è¿›è¡Œæ‰§è¡Œã€‚è·å–è¿‡ç¨‹æ€»ä½“å¦‚ä¸‹é¡ºåºå›¾( <a href="http://www.yunai.me/images/Elastic-Job/2017_10_31/03.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_31/03.png" alt=""></p>
<ul>
<li>æ©˜è‰²å‰å‰åœ¨<a href="http://www.yunai.me/Elastic-Job/job-failover/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>æœ‰è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ShardingContexts <span class="title">getShardingContexts</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ã€å¿½ç•¥ï¼Œä½œä¸šå¤±æ•ˆè½¬ç§»è¯¦è§£ã€‘è·å¾— å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">   <span class="keyword">boolean</span> isFailover = configService.load(<span class="keyword">true</span>).isFailover();</div><div class="line">   <span class="keyword">if</span> (isFailover) &#123;</div><div class="line">       List&lt;Integer&gt; failoverShardingItems = failoverService.getLocalFailoverItems();</div><div class="line">       <span class="keyword">if</span> (!failoverShardingItems.isEmpty()) &#123;</div><div class="line">           <span class="keyword">return</span> executionContextService.getJobShardingContext(failoverShardingItems);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ä½œä¸šåˆ†ç‰‡ï¼Œå¦‚æœéœ€è¦åˆ†ç‰‡ä¸”å½“å‰èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹</span></div><div class="line">   shardingService.shardingIfNecessary();</div><div class="line">   <span class="comment">// è·å¾— åˆ†é…åœ¨æœ¬æœºçš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">   List&lt;Integer&gt; shardingItems = shardingService.getLocalShardingItems();</div><div class="line">   <span class="comment">// ã€å¿½ç•¥ï¼Œä½œä¸šå¤±æ•ˆè½¬ç§»è¯¦è§£ã€‘ç§»é™¤ åˆ†é…åœ¨æœ¬æœºçš„å¤±æ•ˆè½¬ç§»çš„ä½œä¸šåˆ†ç‰‡é¡¹ç›®</span></div><div class="line">   <span class="keyword">if</span> (isFailover) &#123;</div><div class="line">       shardingItems.removeAll(failoverService.getLocalTakeOffItems());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç§»é™¤ è¢«ç¦ç”¨çš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">   shardingItems.removeAll(executionService.getDisabledItems(shardingItems));</div><div class="line">   <span class="comment">// è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨åˆ†ç‰‡ä¸Šä¸‹æ–‡</span></div><div class="line">   <span class="keyword">return</span> executionContextService.getJobShardingContext(shardingItems);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>ShardingService#shardingIfNecessary()</code> æ–¹æ³•ï¼Œå¦‚æœéœ€è¦åˆ†ç‰‡ä¸”å½“å‰èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹ï¼Œä½œä¸šåˆ†ç‰‡é¡¹<strong>åˆ†é…</strong>ã€‚<strong>ä¸æ˜¯æ¯æ¬¡éƒ½éœ€è¦ä½œä¸šåˆ†ç‰‡ï¼Œå¿…é¡»æ»¡è¶³ã€Œ2. ä½œä¸šåˆ†ç‰‡æ¡ä»¶ã€æ‰æ‰§è¡Œä½œä¸šåˆ†ç‰‡</strong>ã€‚</li>
<li><p>è°ƒç”¨ <code>ShardingService#getLocalShardingItems()</code>æ–¹æ³•ï¼Œè·å¾—åˆ†é…åœ¨<strong>æœ¬æœº</strong>çš„ä½œä¸šåˆ†ç‰‡é¡¹ï¼Œå³ <code>/${JOB_NAME}/sharding/${ITEM_ID}/instance</code> ä¸ºæœ¬æœºçš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–è¿è¡Œåœ¨æœ¬ä½œä¸šå®ä¾‹çš„åˆ†ç‰‡é¡¹é›†åˆ.</div><div class="line">* </div><div class="line">* <span class="doctag">@return</span> è¿è¡Œåœ¨æœ¬ä½œä¸šå®ä¾‹çš„åˆ†ç‰‡é¡¹é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getLocalShardingItems</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (JobRegistry.getInstance().isShutdown(jobName) || !serverService.isAvailableServer(JobRegistry.getInstance().getJobInstance(jobName).getIp())) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> getShardingItems(JobRegistry.getInstance().getJobInstance(jobName).getJobInstanceId());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–ä½œä¸šè¿è¡Œå®ä¾‹çš„åˆ†ç‰‡é¡¹é›†åˆ.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> jobInstanceId ä½œä¸šè¿è¡Œå®ä¾‹ä¸»é”®</div><div class="line">* <span class="doctag">@return</span> ä½œä¸šè¿è¡Œå®ä¾‹çš„åˆ†ç‰‡é¡¹é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getShardingItems</span><span class="params">(<span class="keyword">final</span> String jobInstanceId)</span> </span>&#123;</div><div class="line">   JobInstance jobInstance = <span class="keyword">new</span> JobInstance(jobInstanceId);</div><div class="line">   <span class="keyword">if</span> (!serverService.isAvailableServer(jobInstance.getIp())) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   List&lt;Integer&gt; result = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">   <span class="keyword">int</span> shardingTotalCount = configService.load(<span class="keyword">true</span>).getTypeConfig().getCoreConfig().getShardingTotalCount();</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shardingTotalCount; i++) &#123;</div><div class="line">       <span class="comment">// `/$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/instance`</span></div><div class="line">       <span class="keyword">if</span> (jobInstance.getJobInstanceId().equals(jobNodeStorage.getJobNodeData(ShardingNode.getInstanceNode(i)))) &#123;</div><div class="line">           result.add(i);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>shardingItems.removeAll(executionService.getDisabledItems(shardingItems))</code>ï¼Œç§»é™¤<strong>è¢«ç¦ç”¨</strong>çš„ä½œä¸šåˆ†ç‰‡é¡¹ï¼Œå³ <code>/${JOB_NAME}/sharding/${ITEM_ID}/disabled</code> <strong>å­˜åœ¨</strong>çš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ExecutionService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–ç¦ç”¨çš„ä»»åŠ¡åˆ†ç‰‡é¡¹.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> items éœ€è¦è·å–ç¦ç”¨çš„ä»»åŠ¡åˆ†ç‰‡é¡¹</div><div class="line">* <span class="doctag">@return</span> ç¦ç”¨çš„ä»»åŠ¡åˆ†ç‰‡é¡¹</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getDisabledItems</span><span class="params">(<span class="keyword">final</span> List&lt;Integer&gt; items)</span> </span>&#123;</div><div class="line">   List&lt;Integer&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(items.size());</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : items) &#123;</div><div class="line">       <span class="comment">// /$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/disabled</span></div><div class="line">       <span class="keyword">if</span> (jobNodeStorage.isJobNodeExisted(ShardingNode.getDisabledNode(each))) &#123;</div><div class="line">           result.add(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>ExecutionContextService#getJobShardingContext(...)</code> æ–¹æ³•ï¼Œè·å–<strong>å½“å‰</strong>ä½œä¸šæœåŠ¡å™¨åˆ†ç‰‡ä¸Šä¸‹æ–‡ã€‚</p>
</li>
</ul>
<p><strong>è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨åˆ†ç‰‡ä¸Šä¸‹æ–‡</strong></p>
<p>è°ƒç”¨ <code>ExecutionContextService#getJobShardingContext(...)</code> æ–¹æ³•ï¼Œè·å–<strong>å½“å‰</strong>ä½œä¸šæœåŠ¡å™¨åˆ†ç‰‡ä¸Šä¸‹æ–‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ExecutionContextService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> ShardingContexts <span class="title">getJobShardingContext</span><span class="params">(<span class="keyword">final</span> List&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   LiteJobConfiguration liteJobConfig = configService.load(<span class="keyword">false</span>);</div><div class="line">   <span class="comment">// ç§»é™¤ æ­£åœ¨è¿è¡Œä¸­çš„ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line">   removeRunningIfMonitorExecution(liteJobConfig.isMonitorExecution(), shardingItems);</div><div class="line">   <span class="comment">//</span></div><div class="line">   <span class="keyword">if</span> (shardingItems.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ShardingContexts(buildTaskId(liteJobConfig, shardingItems), liteJobConfig.getJobName(), liteJobConfig.getTypeConfig().getCoreConfig().getShardingTotalCount(), </div><div class="line">               liteJobConfig.getTypeConfig().getCoreConfig().getJobParameter(), Collections.&lt;Integer, String&gt;emptyMap());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è§£æåˆ†ç‰‡å‚æ•°</span></div><div class="line">   Map&lt;Integer, String&gt; shardingItemParameterMap = <span class="keyword">new</span> ShardingItemParameters(liteJobConfig.getTypeConfig().getCoreConfig().getShardingItemParameters()).getMap();</div><div class="line">   <span class="comment">// åˆ›å»º åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ShardingContexts(buildTaskId(liteJobConfig, shardingItems), <span class="comment">//</span></div><div class="line">           liteJobConfig.getJobName(), liteJobConfig.getTypeConfig().getCoreConfig().getShardingTotalCount(),</div><div class="line">           liteJobConfig.getTypeConfig().getCoreConfig().getJobParameter(),</div><div class="line">           getAssignedShardingItemParameterMap(shardingItems, shardingItemParameterMap)); <span class="comment">// è·å¾—å½“å‰ä½œä¸šèŠ‚ç‚¹çš„åˆ†ç‰‡å‚æ•°</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>#removeRunningIfMonitorExecution()</code> æ–¹æ³•ï¼Œç§»é™¤æ­£åœ¨è¿è¡Œä¸­çš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeRunningIfMonitorExecution</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> monitorExecution, <span class="keyword">final</span> List&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!monitorExecution) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   List&lt;Integer&gt; runningShardingItems = <span class="keyword">new</span> ArrayList&lt;&gt;(shardingItems.size());</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingItems) &#123;</div><div class="line">       <span class="keyword">if</span> (isRunning(each)) &#123;</div><div class="line">           runningShardingItems.add(each); <span class="comment">// /$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/running</span></div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   shardingItems.removeAll(runningShardingItems);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isRunning</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> shardingItem)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> jobNodeStorage.isJobNodeExisted(ShardingNode.getRunningNode(shardingItem));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>ä½¿ç”¨ ShardingItemParameters è§£æä½œä¸šåˆ†ç‰‡å‚æ•°ã€‚ä¾‹å¦‚ä½œä¸šåˆ†ç‰‡å‚æ•°( <code>JobCoreConfiguration.shardingItemParameters=&quot;0=Beijing,1=Shanghai,2=Guangzhou&quot;</code> ) è§£æç»“æœï¼š<br>  <img src="http://www.yunai.me/images/Elastic-Job/2017_10_31/04.png" alt=""></p>
<ul>
<li>ShardingItemParameters ä»£ç æ¸…æ™°æ˜“æ‡‚ï¼Œç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/fd45d3799565f69c6b604db83f78629d8c9a70cd/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/util/config/ShardingItemParameters.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>#buildTaskId(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºä½œä¸šä»»åŠ¡ID( <code>ShardingContexts.taskId</code> )ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">buildTaskId</span><span class="params">(<span class="keyword">final</span> LiteJobConfiguration liteJobConfig, <span class="keyword">final</span> List&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   JobInstance jobInstance = JobRegistry.getInstance().getJobInstance(jobName);</div><div class="line">   <span class="keyword">return</span> Joiner.on(<span class="string">"@-@"</span>).join(liteJobConfig.getJobName(), Joiner.on(<span class="string">","</span>).join(shardingItems), <span class="string">"READY"</span>, </div><div class="line">           <span class="keyword">null</span> == jobInstance.getJobInstanceId() ? <span class="string">"127.0.0.1@-@1"</span> : jobInstance.getJobInstanceId()); </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>taskId</code> = <code>${JOB_NAME}</code> + <code>@-@</code> + <code>${SHARDING_ITEMS}</code> + <code>@-@</code> + <code>READY</code> + <code>@-@</code> + <code>${IP}</code> + <code>@-@</code> + <code>${PID}</code>ã€‚ä¾‹å¦‚ï¼š<code>javaSimpleJob@-@0,1,2@-@READY@-@192.168.3.2@-@38330</code>ã€‚</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>#getAssignedShardingItemParameterMap(...)</code> æ–¹æ³•ï¼Œè·å¾—å½“å‰ä½œä¸šèŠ‚ç‚¹çš„åˆ†ç‰‡å‚æ•°ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">private</span> Map&lt;Integer, String&gt; <span class="title">getAssignedShardingItemParameterMap</span><span class="params">(<span class="keyword">final</span> List&lt;Integer&gt; shardingItems, <span class="keyword">final</span> Map&lt;Integer, String&gt; shardingItemParameterMap)</span> </span>&#123;</div><div class="line">       Map&lt;Integer, String&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;(shardingItemParameterMap.size(), <span class="number">1</span>);</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingItems) &#123;</div><div class="line">           result.put(each, shardingItemParameterMap.get(each));</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    ```    </div><div class="line"></div><div class="line">* ShardingContextsï¼Œåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆã€‚</div><div class="line">    ```Java</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ShardingContexts</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line">        </div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">4585977349142082152L</span>;</div><div class="line">        </div><div class="line">        <span class="comment">/**</span></div><div class="line">         * ä½œä¸šä»»åŠ¡ID.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String taskId;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * ä½œä¸šåç§°.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * åˆ†ç‰‡æ€»æ•°.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * ä½œä¸šè‡ªå®šä¹‰å‚æ•°.</div><div class="line">         * å¯ä»¥é…ç½®å¤šä¸ªç›¸åŒçš„ä½œä¸š, ä½†æ˜¯ç”¨ä¸åŒçš„å‚æ•°ä½œä¸ºä¸åŒçš„è°ƒåº¦å®ä¾‹.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String jobParameter;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * åˆ†é…äºæœ¬ä½œä¸šå®ä¾‹çš„åˆ†ç‰‡é¡¹å’Œå‚æ•°çš„Map.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, String&gt; shardingItemParameters;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * ä½œä¸šäº‹ä»¶é‡‡æ ·ç»Ÿè®¡æ•°.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> jobEventSamplingCount;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * å½“å‰ä½œä¸šäº‹ä»¶é‡‡æ ·ç»Ÿè®¡æ•°.</div><div class="line">         */</div><div class="line">        <span class="meta">@Setter</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> currentJobEventSamplingCount;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * æ˜¯å¦å…è®¸å¯ä»¥å‘é€ä½œä¸šäº‹ä»¶.</div><div class="line">         */</div><div class="line">        <span class="meta">@Setter</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> allowSendJobEvent = <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>jobEventSamplingCount</code>ï¼Œ<code>currentJobEventSamplingCount</code> åœ¨ Elastic-Job-Lite æš‚æœªè¿˜ä½¿ç”¨ï¼Œåœ¨ Elastic-Job-Cloud ä½¿ç”¨ã€‚</li>
</ul>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šå°ä¼™ä¼´ï¼Œæ›´æ–°äº†å¹²è´§å˜›ï¼ŒåŒå‡» 666ã€‚<br>èŠ‹é“å›ï¼šé‚£å¿…é¡»çš„å˜›ï¼Œè€Œä¸”è¿™ä¹ˆå‹¤å¿«æ›´æ–°ï¼æ˜¯ä¸æ˜¯åº”è¯¥åˆ†äº«ä¸€æ³¢æœ‹å‹åœˆã€‚</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_31/05.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ä½œä¸šåˆ†ç‰‡æ¡ä»¶&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;
    
    </summary>
    
      <category term="Elastic-Job" scheme="http://www.yunai.me/categories/Elastic-Job/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆ†ç‰‡ç­–ç•¥</title>
    <link href="http://www.yunai.me/Elastic-Job/job-sharding-strategy/"/>
    <id>http://www.yunai.me/Elastic-Job/job-sharding-strategy/</id>
    <published>2017-10-25T16:00:00.000Z</published>
    <updated>2017-08-28T09:43:34.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. è‡ªå¸¦ä½œä¸šåˆ†ç‰‡ç­–ç•¥</a><ul>
<li><a href="#">2.1 AverageAllocationJobShardingStrategy</a></li>
<li><a href="#">2.2 OdevitySortByNameJobShardingStrategy</a></li>
<li><a href="#">2.3 RotateServerByNameJobShardingStrategy</a></li>
</ul>
</li>
<li><a href="#">3. è‡ªå®šä¹‰ä½œä¸šåˆ†ç‰‡ç­–ç•¥</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šåˆ†ç‰‡ç­–ç•¥</strong>ã€‚</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_10_26/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_26/01.png" alt=""></p>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-è‡ªå¸¦ä½œä¸šåˆ†ç‰‡ç­–ç•¥"><a href="#2-è‡ªå¸¦ä½œä¸šåˆ†ç‰‡ç­–ç•¥" class="headerlink" title="2. è‡ªå¸¦ä½œä¸šåˆ†ç‰‡ç­–ç•¥"></a>2. è‡ªå¸¦ä½œä¸šåˆ†ç‰‡ç­–ç•¥</h1><p>JobShardingStrategyï¼Œä½œä¸šåˆ†ç‰‡ç­–ç•¥<strong>æ¥å£</strong>ã€‚åˆ†ç‰‡ç­–ç•¥é€šè¿‡å®ç°æ¥å£çš„ <code>#sharding(...)</code> æ–¹æ³•æä¾›ä½œä¸šåˆ†ç‰‡çš„<strong>è®¡ç®—</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JobShardingStrategy</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåˆ†ç‰‡.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> jobInstances æ‰€æœ‰å‚ä¸åˆ†ç‰‡çš„å•å…ƒåˆ—è¡¨</div><div class="line">     * <span class="doctag">@param</span> jobName ä½œä¸šåç§°</div><div class="line">     * <span class="doctag">@param</span> shardingTotalCount åˆ†ç‰‡æ€»æ•°</div><div class="line">     * <span class="doctag">@return</span> åˆ†ç‰‡ç»“æœ</div><div class="line">     */</div><div class="line">    Map&lt;JobInstance, List&lt;Integer&gt;&gt; sharding(List&lt;JobInstance&gt; jobInstances, String jobName, <span class="keyword">int</span> shardingTotalCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Elastic-Job-Lite æä¾›ä¸‰ç§è‡ªå¸¦çš„ä½œä¸šåˆ†ç‰‡ç­–ç•¥ï¼š</p>
<ul>
<li>AverageAllocationJobShardingStrategyï¼šåŸºäºå¹³å‡åˆ†é…ç®—æ³•çš„åˆ†ç‰‡ç­–ç•¥ã€‚</li>
<li>OdevitySortByNameJobShardingStrategyï¼šæ ¹æ®ä½œä¸šåçš„å“ˆå¸Œå€¼å¥‡å¶æ•°å†³å®šIPå‡é™åºç®—æ³•çš„åˆ†ç‰‡ç­–ç•¥ã€‚</li>
<li>RotateServerByNameJobShardingStrategyï¼šæ ¹æ®ä½œä¸šåçš„å“ˆå¸Œå€¼å¯¹ä½œä¸šèŠ‚ç‚¹åˆ—è¡¨è¿›è¡Œè½®è½¬çš„åˆ†ç‰‡ç­–ç•¥ã€‚</li>
</ul>
<h2 id="2-1-AverageAllocationJobShardingStrategy"><a href="#2-1-AverageAllocationJobShardingStrategy" class="headerlink" title="2.1 AverageAllocationJobShardingStrategy"></a>2.1 AverageAllocationJobShardingStrategy</h2><p>AverageAllocationJobShardingStrategyï¼ŒåŸºäºå¹³å‡åˆ†é…ç®—æ³•çš„åˆ†ç‰‡ç­–ç•¥ã€‚<strong>Elastic-Job-Lite é»˜è®¤çš„ä½œä¸šåˆ†ç‰‡ç­–ç•¥</strong>ã€‚</p>
<blockquote>
<p>å¦‚æœåˆ†ç‰‡ä¸èƒ½æ•´é™¤ï¼Œåˆ™ä¸èƒ½æ•´é™¤çš„å¤šä½™åˆ†ç‰‡å°†ä¾æ¬¡è¿½åŠ åˆ°åºå·å°çš„ä½œä¸šèŠ‚ç‚¹ã€‚å¦‚ï¼š<br>å¦‚æœæœ‰3å°ä½œä¸šèŠ‚ç‚¹ï¼Œåˆ†æˆ9ç‰‡ï¼Œåˆ™æ¯å°ä½œä¸šèŠ‚ç‚¹åˆ†åˆ°çš„åˆ†ç‰‡æ˜¯ï¼š1=[0,1,2], 2=[3,4,5], 3=[6,7,8]<br>å¦‚æœæœ‰3å°ä½œä¸šèŠ‚ç‚¹ï¼Œåˆ†æˆ8ç‰‡ï¼Œåˆ™æ¯å°ä½œä¸šèŠ‚ç‚¹åˆ†åˆ°çš„åˆ†ç‰‡æ˜¯ï¼š1=[0,1,6], 2=[2,3,7], 3=[4,5]<br>å¦‚æœæœ‰3å°ä½œä¸šèŠ‚ç‚¹ï¼Œåˆ†æˆ10ç‰‡ï¼Œåˆ™æ¯å°ä½œä¸šèŠ‚ç‚¹åˆ†åˆ°çš„åˆ†ç‰‡æ˜¯ï¼š1=[0,1,2,9], 2=[3,4,5], 3=[6,7,8]  </p>
</blockquote>
<p>ä»£ç å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AverageAllocationJobShardingStrategy</span> <span class="keyword">implements</span> <span class="title">JobShardingStrategy</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Map&lt;JobInstance, List&lt;Integer&gt;&gt; sharding(<span class="keyword">final</span> List&lt;JobInstance&gt; jobInstances, <span class="keyword">final</span> String jobName, <span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount) &#123;</div><div class="line">        <span class="comment">// ä¸å­˜åœ¨ ä½œä¸šè¿è¡Œå®ä¾‹</span></div><div class="line">        <span class="keyword">if</span> (jobInstances.isEmpty()) &#123;</div><div class="line">            <span class="keyword">return</span> Collections.emptyMap();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// åˆ†é…èƒ½è¢«æ•´é™¤çš„éƒ¨åˆ†</span></div><div class="line">        Map&lt;JobInstance, List&lt;Integer&gt;&gt; result = shardingAliquot(jobInstances, shardingTotalCount);</div><div class="line">        <span class="comment">// åˆ†é…ä¸èƒ½è¢«æ•´é™¤çš„éƒ¨åˆ†</span></div><div class="line">        addAliquant(jobInstances, shardingTotalCount, result);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>#shardingAliquot(...)</code> æ–¹æ³•åˆ†é…èƒ½<strong>è¢«æ•´é™¤</strong>çš„éƒ¨åˆ†ã€‚èƒ½æ•´é™¤çš„å’±å°±ä¸ä¸¾ä¾‹å­ã€‚å¦‚æœæœ‰ 3 å°ä½œä¸šèŠ‚ç‚¹ï¼Œåˆ†æˆ 8 ç‰‡ï¼Œè¢«æ•´é™¤çš„éƒ¨åˆ†æ˜¯å‰ 6 ç‰‡ [0, 1, 2, 3, 4, 5]ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ç»“æœï¼š1=[0,1], 2=[2,3], 3=[4,5]ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Map&lt;JobInstance, List&lt;Integer&gt;&gt; shardingAliquot(<span class="keyword">final</span> List&lt;JobInstance&gt; shardingUnits, <span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount) &#123;</div><div class="line">   Map&lt;JobInstance, List&lt;Integer&gt;&gt; result = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(shardingTotalCount, <span class="number">1</span>);</div><div class="line">   <span class="keyword">int</span> itemCountPerSharding = shardingTotalCount / shardingUnits.size(); <span class="comment">// æ¯ä¸ªä½œä¸šè¿è¡Œå®ä¾‹åˆ†é…çš„å¹³å‡åˆ†ç‰‡æ•°</span></div><div class="line">   <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (JobInstance each : shardingUnits) &#123;</div><div class="line">       List&lt;Integer&gt; shardingItems = <span class="keyword">new</span> ArrayList&lt;&gt;(itemCountPerSharding + <span class="number">1</span>);</div><div class="line">       <span class="comment">// é¡ºåºå‘ä¸‹åˆ†é…</span></div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = count * itemCountPerSharding; i &lt; (count + <span class="number">1</span>) * itemCountPerSharding; i++) &#123;</div><div class="line">           shardingItems.add(i);</div><div class="line">       &#125;</div><div class="line">       result.put(each, shardingItems);</div><div class="line">       count++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>#addAliquant(...)</code> æ–¹æ³•åˆ†é…èƒ½<strong>ä¸è¢«æ•´é™¤</strong>çš„éƒ¨åˆ†ã€‚ç»§ç»­ä¸Šé¢çš„ä¾‹å­ã€‚ä¸èƒ½è¢«æ•´é™¤çš„éƒ¨åˆ†æ˜¯å 2 ç‰‡ [6, 7]ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ç»“æœï¼š1=[0,1] + <strong>[6]</strong>, 2=[2,3] + <strong>[7]</strong>, 3=[4,5]ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addAliquant</span><span class="params">(<span class="keyword">final</span> List&lt;JobInstance&gt; shardingUnits, <span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount, <span class="keyword">final</span> Map&lt;JobInstance, List&lt;Integer&gt;&gt; shardingResults)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> aliquant = shardingTotalCount % shardingUnits.size(); <span class="comment">// ä½™æ•°</span></div><div class="line">   <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (Map.Entry&lt;JobInstance, List&lt;Integer&gt;&gt; entry : shardingResults.entrySet()) &#123;</div><div class="line">       <span class="keyword">if</span> (count &lt; aliquant) &#123;</div><div class="line">           entry.getValue().add(shardingTotalCount / shardingUnits.size() * shardingUnits.size() + count);</div><div class="line">       &#125;</div><div class="line">       count++;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>å¦‚ä½•å®ç°ä¸»å¤‡</strong></p>
<p>é€šè¿‡ä½œä¸šé…ç½®è®¾ç½®æ€»åˆ†ç‰‡æ•°ä¸º 1 ( <code>JobCoreConfiguration.shardingTotalCount = 1</code> )ï¼Œåªæœ‰ä¸€ä¸ªä½œä¸šåˆ†ç‰‡èƒ½å¤Ÿåˆ†é…åˆ°ä½œä¸šåˆ†ç‰‡é¡¹ï¼Œä»è€Œè¾¾åˆ°<strong>ä¸€ä¸»Nå¤‡</strong>ã€‚</p>
<h2 id="2-2-OdevitySortByNameJobShardingStrategy"><a href="#2-2-OdevitySortByNameJobShardingStrategy" class="headerlink" title="2.2 OdevitySortByNameJobShardingStrategy"></a>2.2 OdevitySortByNameJobShardingStrategy</h2><p>OdevitySortByNameJobShardingStrategyï¼Œæ ¹æ®ä½œä¸šåçš„å“ˆå¸Œå€¼å¥‡å¶æ•°å†³å®šIPå‡é™åºç®—æ³•çš„åˆ†ç‰‡ç­–ç•¥ã€‚</p>
<blockquote>
<p>ä½œä¸šåçš„å“ˆå¸Œå€¼ä¸ºå¥‡æ•°åˆ™IP <strong>é™åº</strong>.<br>ä½œä¸šåçš„å“ˆå¸Œå€¼ä¸ºå¶æ•°åˆ™IP <strong>å‡åº</strong>.<br>ç”¨äºä¸åŒçš„ä½œä¸šå¹³å‡åˆ†é…è´Ÿè½½è‡³ä¸åŒçš„ä½œä¸šèŠ‚ç‚¹.<br>å¦‚:   </p>
<ol>
<li>å¦‚æœæœ‰3å°ä½œä¸šèŠ‚ç‚¹, åˆ†æˆ2ç‰‡, ä½œä¸šåç§°çš„å“ˆå¸Œå€¼ä¸ºå¥‡æ•°, åˆ™æ¯å°ä½œä¸šèŠ‚ç‚¹åˆ†åˆ°çš„åˆ†ç‰‡æ˜¯: 1=[ ], 2=[1], 3=[0].  </li>
<li>å¦‚æœæœ‰3å°ä½œä¸šèŠ‚ç‚¹, åˆ†æˆ2ç‰‡, ä½œä¸šåç§°çš„å“ˆå¸Œå€¼ä¸ºå¶æ•°, åˆ™æ¯å°ä½œä¸šèŠ‚ç‚¹åˆ†åˆ°çš„åˆ†ç‰‡æ˜¯: 1=[0], 2=[1], 3=[ ].</li>
</ol>
</blockquote>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> Map&lt;JobInstance, List&lt;Integer&gt;&gt; sharding(<span class="keyword">final</span> List&lt;JobInstance&gt; jobInstances, <span class="keyword">final</span> String jobName, <span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount) &#123;</div><div class="line">   <span class="keyword">long</span> jobNameHash = jobName.hashCode();</div><div class="line">   <span class="keyword">if</span> (<span class="number">0</span> == jobNameHash % <span class="number">2</span>) &#123;</div><div class="line">       Collections.reverse(jobInstances);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> averageAllocationJobShardingStrategy.sharding(jobInstances, jobName, shardingTotalCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>ä»å®ç°ä»£ç ä¸Šï¼Œä»¿ä½›å’Œ IP å‡é™åºæ²¡ä»€ä¹ˆå…³ç³»ï¼Ÿç­”æ¡ˆåœ¨ä¼ é€’è¿›æ¥çš„å‚æ•° <code>jobInstances</code>ã€‚<code>jobInstances</code> å·²ç»æ˜¯æŒ‰ç…§ IP è¿›è¡Œ<strong>é™åº</strong>çš„æ•°ç»„ã€‚æ‰€ä»¥å½“åˆ¤æ–­åˆ°ä½œä¸šåçš„å“ˆå¸Œå€¼ä¸ºå¶æ•°æ—¶ï¼Œè¿›è¡Œæ•°ç»„åè½¬( <code>Collections#reverse(...)</code> )å®ç°æŒ‰ç…§ IP <strong>å‡åº</strong>ã€‚ä¸‹é¢çœ‹ä¸‹ä¸ºä»€ä¹ˆè¯´<code>jobInstances</code> å·²ç»æŒ‰ç…§ IP è¿›è¡Œ<strong>é™åº</strong>ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ZookeeperRegistryCenter.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getChildrenKeys</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       List&lt;String&gt; result = client.getChildren().forPath(key);</div><div class="line">       Collections.sort(result, <span class="keyword">new</span> Comparator&lt;String&gt;() &#123;</div><div class="line">           </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(<span class="keyword">final</span> String o1, <span class="keyword">final</span> String o2)</span> </span>&#123;</div><div class="line">               <span class="keyword">return</span> o2.compareTo(o1);</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>AverageAllocationJobShardingStrategy#sharding(...)</code> æ–¹æ³•å®Œæˆæœ€ç»ˆä½œä¸šåˆ†ç‰‡è®¡ç®—ã€‚</p>
</li>
</ul>
<h2 id="2-3-RotateServerByNameJobShardingStrategy"><a href="#2-3-RotateServerByNameJobShardingStrategy" class="headerlink" title="2.3 RotateServerByNameJobShardingStrategy"></a>2.3 RotateServerByNameJobShardingStrategy</h2><p>RotateServerByNameJobShardingStrategyï¼Œæ ¹æ®ä½œä¸šåçš„å“ˆå¸Œå€¼å¯¹ä½œä¸šèŠ‚ç‚¹åˆ—è¡¨è¿›è¡Œ<strong>è½®è½¬</strong>çš„åˆ†ç‰‡ç­–ç•¥ã€‚è¿™é‡Œçš„<strong>è½®è½¬</strong>æ€ä¹ˆå®šä¹‰å‘¢ï¼Ÿå¦‚æœæœ‰ 3 å°ä½œä¸šèŠ‚ç‚¹ï¼Œé¡ºåºä¸º [0, 1, 2]ï¼Œå¦‚æœä½œä¸šåçš„å“ˆå¸Œå€¼æ ¹æ®ä½œä¸šåˆ†ç‰‡æ€»æ•°å–æ¨¡ä¸º 1, ä½œä¸šèŠ‚ç‚¹é¡ºåºå˜ä¸º [1, 2, 0]ã€‚</p>
<p><strong>åˆ†ç‰‡çš„ç›®çš„</strong>ï¼Œæ˜¯å°†ä½œä¸šçš„è´Ÿè½½åˆç†çš„åˆ†é…åˆ°ä¸åŒçš„ä½œä¸šèŠ‚ç‚¹ä¸Šï¼Œè¦é¿å…åˆ†ç‰‡ç­–ç•¥æ€»æ˜¯è®©å›ºå®šçš„ä½œä¸šèŠ‚ç‚¹è´Ÿè½½ç‰¹åˆ«å¤§ï¼Œå…¶å®ƒå·¥ä½œèŠ‚ç‚¹è´Ÿè½½ç‰¹åˆ«å°ã€‚è¿™ä¸ªä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ<strong>å®˜æ–¹</strong>å¯¹æ¯” RotateServerByNameJobShardingStrategyã€AverageAllocationJobShardingStrategy å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>AverageAllocationJobShardingStrategyçš„ç¼ºç‚¹æ˜¯ï¼Œä¸€æ—¦åˆ†ç‰‡æ•°å°äºä½œä¸šä½œä¸šèŠ‚ç‚¹æ•°ï¼Œä½œä¸šå°†æ°¸è¿œåˆ†é…è‡³IPåœ°å€é å‰çš„ä½œä¸šèŠ‚ç‚¹ï¼Œå¯¼è‡´IPåœ°å€é åçš„ä½œä¸šèŠ‚ç‚¹ç©ºé—²ã€‚å¦‚ï¼š<br>OdevitySortByNameJobShardingStrategyåˆ™å¯ä»¥æ ¹æ®ä½œä¸šåç§°é‡æ–°åˆ†é…ä½œä¸šèŠ‚ç‚¹è´Ÿè½½ã€‚<br>å¦‚æœæœ‰3å°ä½œä¸šèŠ‚ç‚¹ï¼Œåˆ†æˆ2ç‰‡ï¼Œä½œä¸šåç§°çš„å“ˆå¸Œå€¼ä¸ºå¥‡æ•°ï¼Œåˆ™æ¯å°ä½œä¸šèŠ‚ç‚¹åˆ†åˆ°çš„åˆ†ç‰‡æ˜¯ï¼š1=[0], 2=[1], 3=[]<br>å¦‚æœæœ‰3å°ä½œä¸šèŠ‚ç‚¹ï¼Œåˆ†æˆ2ç‰‡ï¼Œä½œä¸šåç§°çš„å“ˆå¸Œå€¼ä¸ºå¶æ•°ï¼Œåˆ™æ¯å°ä½œä¸šèŠ‚ç‚¹åˆ†åˆ°çš„åˆ†ç‰‡æ˜¯ï¼š3=[0], 2=[1], 1=[]  </p>
</blockquote>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RotateServerByNameJobShardingStrategy</span> <span class="keyword">implements</span> <span class="title">JobShardingStrategy</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> AverageAllocationJobShardingStrategy averageAllocationJobShardingStrategy = <span class="keyword">new</span> AverageAllocationJobShardingStrategy();</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Map&lt;JobInstance, List&lt;Integer&gt;&gt; sharding(<span class="keyword">final</span> List&lt;JobInstance&gt; jobInstances, <span class="keyword">final</span> String jobName, <span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount) &#123;</div><div class="line">        <span class="keyword">return</span> averageAllocationJobShardingStrategy.sharding(rotateServerList(jobInstances, jobName), jobName, shardingTotalCount);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> List&lt;JobInstance&gt; <span class="title">rotateServerList</span><span class="params">(<span class="keyword">final</span> List&lt;JobInstance&gt; shardingUnits, <span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> shardingUnitsSize = shardingUnits.size();</div><div class="line">        <span class="keyword">int</span> offset = Math.abs(jobName.hashCode()) % shardingUnitsSize; <span class="comment">// è½®è½¬å¼€å§‹ä½ç½®</span></div><div class="line">        <span class="keyword">if</span> (<span class="number">0</span> == offset) &#123;</div><div class="line">            <span class="keyword">return</span> shardingUnits;</div><div class="line">        &#125;</div><div class="line">        List&lt;JobInstance&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(shardingUnitsSize);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shardingUnitsSize; i++) &#123;</div><div class="line">            <span class="keyword">int</span> index = (i + offset) % shardingUnitsSize;</div><div class="line">            result.add(shardingUnits.get(index));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>#rotateServerList(...)</code> å®ç°ä½œä¸šèŠ‚ç‚¹æ•°ç»„<strong>è½®è½¬</strong>ã€‚</li>
<li>è°ƒç”¨ <code>AverageAllocationJobShardingStrategy#sharding(...)</code> æ–¹æ³•å®Œæˆæœ€ç»ˆä½œä¸šåˆ†ç‰‡è®¡ç®—ã€‚</li>
</ul>
<h1 id="3-è‡ªå®šä¹‰ä½œä¸šåˆ†ç‰‡ç­–ç•¥"><a href="#3-è‡ªå®šä¹‰ä½œä¸šåˆ†ç‰‡ç­–ç•¥" class="headerlink" title="3. è‡ªå®šä¹‰ä½œä¸šåˆ†ç‰‡ç­–ç•¥"></a>3. è‡ªå®šä¹‰ä½œä¸šåˆ†ç‰‡ç­–ç•¥</h1><p>å¯èƒ½åœ¨ä½ çš„ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œéœ€è¦å®ç°è‡ªå®šä¹‰çš„ä½œä¸šåˆ†ç‰‡ç­–ç•¥ã€‚é€šè¿‡å®šä¹‰ç±»å®ç° JobShardingStrategy æ¥å£å³å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OOXXShardingStrategy</span> <span class="keyword">implements</span> <span class="title">JobShardingStrategy</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Map&lt;JobInstance, List&lt;Integer&gt;&gt; sharding(<span class="keyword">final</span> List&lt;JobInstance&gt; jobInstances, <span class="keyword">final</span> String jobName, <span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount) &#123;</div><div class="line">        <span class="comment">// å®ç°é€»è¾‘</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å®ç°åï¼Œé…ç½®å®ç°ç±»çš„<strong>å…¨è·¯å¾„</strong>åˆ° Liteä½œä¸šé…ç½®( LiteJobConfiguration )çš„ <code>jobShardingStrategyClass</code> å±æ€§ã€‚</p>
<p>ä½œä¸šè¿›è¡Œåˆ†ç‰‡è®¡ç®—æ—¶ï¼Œä½œä¸šåˆ†ç‰‡ç­–ç•¥å·¥å‚( JobShardingStrategyFactory ) ä¼šåˆ›å»ºä½œä¸šåˆ†ç‰‡ç­–ç•¥å®ä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobShardingStrategyFactory</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–ä½œä¸šåˆ†ç‰‡ç­–ç•¥å®ä¾‹.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> jobShardingStrategyClassName ä½œä¸šåˆ†ç‰‡ç­–ç•¥ç±»å</div><div class="line">     * <span class="doctag">@return</span> ä½œä¸šåˆ†ç‰‡ç­–ç•¥å®ä¾‹</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobShardingStrategy <span class="title">getStrategy</span><span class="params">(<span class="keyword">final</span> String jobShardingStrategyClassName)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (Strings.isNullOrEmpty(jobShardingStrategyClassName)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AverageAllocationJobShardingStrategy();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Class&lt;?&gt; jobShardingStrategyClass = Class.forName(jobShardingStrategyClassName);</div><div class="line">            <span class="keyword">if</span> (!JobShardingStrategy.class.isAssignableFrom(jobShardingStrategyClass)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Class '%s' is not job strategy class"</span>, jobShardingStrategyClassName);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> (JobShardingStrategy) jobShardingStrategyClass.newInstance();</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ClassNotFoundException | InstantiationException | IllegalAccessException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Sharding strategy class '%s' config error, message details are '%s'"</span>, jobShardingStrategyClassName, ex.getMessage());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šé›¾è‰ï¼Œåˆšå¤¸å¥–ä½ ï¼Œå°±åˆå¼€å§‹æ°´æ›´ã€‚<br>èŠ‹é“å›ï¼šå’³å’³å’³ï¼Œä½œä¸šåˆ†ç‰‡ç­–ç•¥ç‚’é¸¡é‡è¦çš„å¥½ä¸å¥½ï¼å˜¿å˜¿å˜¿ï¼Œä¸º<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a>åšä¸ªé“ºå«å˜›ã€‚</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_26/02.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. è‡ªå¸¦ä½œä¸šåˆ†ç‰‡ç­–ç•¥&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;
    
    </summary>
    
      <category term="Elastic-Job" scheme="http://www.yunai.me/categories/Elastic-Job/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä¸»èŠ‚ç‚¹é€‰ä¸¾</title>
    <link href="http://www.yunai.me/Elastic-Job/election/"/>
    <id>http://www.yunai.me/Elastic-Job/election/</id>
    <published>2017-10-20T16:00:00.000Z</published>
    <updated>2017-08-28T12:11:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="">1. æ¦‚è¿°</a></li>
<li><a href="">2. ä¸ºä»€ä¹ˆéœ€è¦é€‰ä¸¾ä¸»èŠ‚ç‚¹</a></li>
<li><a href="">3. é€‰ä¸¾ä¸»èŠ‚ç‚¹</a></li>
<li><a href="">4. åˆ é™¤ä¸»èŠ‚ç‚¹</a></li>
<li><a href="">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä¸»èŠ‚ç‚¹é€‰ä¸¾</strong>ã€‚</p>
<p>å»ºè®®å‰ç½®é˜…è¯»ï¼š</p>
<ul>
<li><a href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒã€‹</a></li>
<li><a href="http://www.yunai.me/Elastic-Job/job-storage/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ•°æ®å­˜å‚¨ã€‹</a></li>
<li><a href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper-listener/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒç›‘å¬å™¨ã€‹</a></li>
</ul>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_10_21/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_21/01.png" alt=""></p>
<ul>
<li>ç²‰è‰²çš„ç±»åœ¨ <code>com.dangdang.ddframe.job.lite.internal.election</code> åŒ…ä¸‹ï¼Œå®ç°äº† Elastic-Job-Lite ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‚</li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-ä¸ºä»€ä¹ˆéœ€è¦é€‰ä¸¾ä¸»èŠ‚ç‚¹"><a href="#2-ä¸ºä»€ä¹ˆéœ€è¦é€‰ä¸¾ä¸»èŠ‚ç‚¹" class="headerlink" title="2. ä¸ºä»€ä¹ˆéœ€è¦é€‰ä¸¾ä¸»èŠ‚ç‚¹"></a>2. ä¸ºä»€ä¹ˆéœ€è¦é€‰ä¸¾ä¸»èŠ‚ç‚¹</h1><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€æ®µ<strong>å®˜æ–¹</strong>å¯¹ Elastic-Job-Lite çš„ä»‹ç»ï¼š</p>
<blockquote>
<p>Elastic-Job-Lite å®šä½ä¸ºè½»é‡çº§æ— ä¸­å¿ƒåŒ–è§£å†³æ–¹æ¡ˆï¼Œä½¿ç”¨ jar åŒ…çš„å½¢å¼æä¾›åˆ†å¸ƒå¼ä»»åŠ¡çš„åè°ƒæœåŠ¡ã€‚</p>
</blockquote>
<p><strong>æ— ä¸­å¿ƒåŒ–</strong>ï¼Œæ„å‘³ç€ Elastic-Job-Lite ä¸å­˜åœ¨<strong>ä¸€ä¸ªä¸­å¿ƒ</strong>æ‰§è¡Œä¸€äº›æ“ä½œï¼Œä¾‹å¦‚ï¼šåˆ†é…ä½œä¸šåˆ†ç‰‡é¡¹ã€‚Elastic-Job-Lite é€‰ä¸¾ä¸»èŠ‚ç‚¹ï¼Œé€šè¿‡ä¸»èŠ‚ç‚¹è¿›è¡Œä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…ã€‚ç›®å‰ï¼Œå¿…é¡»åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œçš„æ“ä½œæœ‰ï¼šåˆ†é…ä½œä¸šåˆ†ç‰‡é¡¹ï¼Œè°ƒè§£åˆ†å¸ƒå¼ä½œä¸šä¸ä¸€è‡´çŠ¶æ€ã€‚</p>
<p>å¦å¤–ï¼Œä¸»èŠ‚ç‚¹çš„é€‰ä¸¾æ˜¯ä»¥<strong>ä½œä¸šä¸ºç»´åº¦</strong>ã€‚ä¾‹å¦‚ï¼šæœ‰ä¸€ä¸ª Elastic-Job-Lite é›†ç¾¤æœ‰ä¸‰ä¸ªä½œä¸šèŠ‚ç‚¹ <code>A</code>ã€<code>B</code>ã€<code>C</code>ï¼Œå­˜åœ¨ä¸¤ä¸ªä½œä¸š <code>a</code>ã€<code>b</code>ï¼Œå¯èƒ½ <code>a</code> ä½œä¸šçš„ä¸»èŠ‚ç‚¹æ˜¯ <code>C</code>ï¼Œ<code>b</code> ä½œä¸šçš„ä¸»èŠ‚ç‚¹æ˜¯ <code>A</code>ã€‚</p>
<h1 id="3-é€‰ä¸¾ä¸»èŠ‚ç‚¹"><a href="#3-é€‰ä¸¾ä¸»èŠ‚ç‚¹" class="headerlink" title="3. é€‰ä¸¾ä¸»èŠ‚ç‚¹"></a>3. é€‰ä¸¾ä¸»èŠ‚ç‚¹</h1><p>è°ƒç”¨ <code>LeaderService#electLeader()</code> é€‰ä¸¾ä¸»èŠ‚ç‚¹ã€‚</p>
<p>å¤§ä½“æµç¨‹å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_10_21/02.png">æ‰“å¼€å¤§å›¾</a> )ï¼š<br><img src="http://www.yunai.me/images/Elastic-Job/2017_10_21/02.png" alt=""></p>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LeaderService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* é€‰ä¸¾ä¸»èŠ‚ç‚¹.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">electLeader</span><span class="params">()</span> </span>&#123;</div><div class="line">   log.debug(<span class="string">"Elect a new leader now."</span>);</div><div class="line">   jobNodeStorage.executeInLeader(LeaderNode.LATCH, <span class="keyword">new</span> LeaderElectionExecutionCallback());</div><div class="line">   log.debug(<span class="string">"Leader election completed."</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobNodeStorage.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeInLeader</span><span class="params">(<span class="keyword">final</span> String latchNode, <span class="keyword">final</span> LeaderExecutionCallback callback)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> (LeaderLatch latch = <span class="keyword">new</span> LeaderLatch(getClient(), jobNodePath.getFullPath(latchNode))) &#123;</div><div class="line">       latch.start();</div><div class="line">       latch.await();</div><div class="line">       callback.execute();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       handleException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// LeaderElectionExecutionCallback.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeaderElectionExecutionCallback</span> <span class="keyword">implements</span> <span class="title">LeaderExecutionCallback</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (!hasLeader()) &#123; <span class="comment">// å½“å‰æ— ä¸»èŠ‚ç‚¹</span></div><div class="line">           jobNodeStorage.fillEphemeralJobNode(LeaderNode.INSTANCE, JobRegistry.getInstance().getJobInstance(jobName).getJobInstanceId());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä½¿ç”¨ Curator LeaderLatch åˆ†å¸ƒå¼é”ï¼Œ<strong>ä¿è¯åŒä¸€æ—¶é—´æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹</strong>èƒ½å¤Ÿè°ƒç”¨ <code>LeaderElectionExecutionCallback#execute()</code> æ–¹æ³•æ‰§è¡Œä¸»èŠ‚ç‚¹è®¾ç½®ã€‚Curator LeaderLatch åœ¨<a href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒã€‹ã€Œ3.1 åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œã€</a>æœ‰è¯¦ç»†è§£æã€‚</li>
<li><p>åœ¨ <code>LeaderElectionExecutionCallback#execute()</code> ä¸ºä»€ä¹ˆè¦è°ƒç”¨ <code>#hasLeader()</code> å‘¢ï¼ŸLeaderLatch <strong>åªä¿è¯åŒä¸€æ—¶é—´æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹</strong>ï¼Œåœ¨è·å¾—åˆ†å¸ƒå¼é”çš„å·¥ä½œèŠ‚ç‚¹ç»“æŸé€»è¾‘åï¼Œç¬¬äºŒä¸ªå·¥ä½œèŠ‚ç‚¹ä¼šå¼€å§‹é€»è¾‘ï¼Œå¦‚æœä¸åˆ¤æ–­å½“å‰æ˜¯å¦æœ‰ä¸»èŠ‚ç‚¹ï¼ŒåŸæ¥çš„ä¸»èŠ‚ç‚¹ä¼šè¢«è¦†ç›–ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LeaderService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * åˆ¤æ–­æ˜¯å¦å·²ç»æœ‰ä¸»èŠ‚ç‚¹.</div><div class="line"> * </div><div class="line"> * <span class="doctag">@return</span> æ˜¯å¦å·²ç»æœ‰ä¸»èŠ‚ç‚¹</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasLeader</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> jobNodeStorage.isJobNodeExisted(LeaderNode.INSTANCE);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>é€‰ä¸¾æˆåŠŸåï¼ŒZookeeper å­˜å‚¨<strong>ä½œä¸š</strong>çš„ä¸»èŠ‚ç‚¹ï¼š<code>/${JOB_NAME}/leader/electron/instance</code> ä¸ºå½“å‰èŠ‚ç‚¹ã€‚è¯¥èŠ‚ç‚¹ä¸º<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ã€‚</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 7] get /elastic-job-example-lite-java/javaSimpleJob/leader/election/instance</div><div class="line">192.168.16.137@-@82496</div></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>é€‰ä¸¾ä¸»èŠ‚ç‚¹æ—¶æœº</strong></p>
<p><strong>ç¬¬ä¸€ç§</strong>ï¼Œæ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯æ—¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> enabled ä½œä¸šæ˜¯å¦å¯ç”¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStartUpInfo</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> enabled)</span> </span>&#123;</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†æ–¹æ³•</span></div><div class="line">   <span class="comment">// é€‰ä¸¾ ä¸»èŠ‚ç‚¹</span></div><div class="line">   leaderService.electLeader();</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ–°çš„ä½œä¸šå¯åŠ¨æ—¶ï¼Œå³èƒ½ä¿è¯é€‰ä¸¾å‡ºä¸»èŠ‚ç‚¹ã€‚<ul>
<li>å½“è¯¥ä½œä¸š<strong>ä¸å­˜åœ¨</strong>ä¸»èŠ‚ç‚¹æ—¶ï¼Œå½“å‰ä½œä¸šèŠ‚ç‚¹<strong>æˆä¸º</strong>ä¸»èŠ‚ç‚¹ã€‚</li>
<li>å½“è¯¥ä½œä¸š<strong>å­˜åœ¨</strong>ä¸»èŠ‚ç‚¹ï¼Œå½“å‰ä½œä¸šèŠ‚ä¸»èŠ‚ç‚¹<strong>ä¸å˜</strong>ã€‚</li>
</ul>
</li>
</ul>
<p><strong>ç¬¬äºŒç§</strong>ï¼ŒèŠ‚ç‚¹æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeaderElectionJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (!JobRegistry.getInstance().isShutdown(jobName) &amp;&amp; (isActiveElection(path, data) || isPassiveElection(path, eventType))) &#123;</div><div class="line">           leaderService.electLeader();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ç¬¦åˆé‡æ–°é€‰ä¸¾ä¸»èŠ‚ç‚¹åˆ†æˆä¸¤ç§æƒ…å†µã€‚</li>
<li><p><strong>ä¸»åŠ¨</strong>é€‰ä¸¾ <code>#isActiveElection(...)</code></p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isActiveElection</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> !leaderService.hasLeader() <span class="comment">// ä¸å­˜åœ¨ä¸»èŠ‚ç‚¹</span></div><div class="line">          &amp;&amp; isLocalServerEnabled(path, data); <span class="comment">// å¼€å¯ä½œä¸š</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isLocalServerEnabled</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> serverNode.isLocalServerPath(path) </div><div class="line">       &amp;&amp; !ServerStatus.DISABLED.name().equals(data);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å½“ä½œä¸šè¢«ç¦ç”¨( <code>LiteJobConfiguration.disabled = true</code> )æ—¶ï¼Œä½œä¸šæ˜¯ä¸å­˜åœ¨ä¸»èŠ‚ç‚¹çš„ã€‚é‚£æœ‰åŒå­¦å°±æœ‰ç–‘é—®äº†ï¼Ÿ<code>LeaderService#electLeader()</code> æ²¡åšè¿™ä¸ªé™åˆ¶å‘€ï¼Œä½œä¸š<strong>æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯æ—¶</strong>ä¹Ÿè¿›è¡Œäº†é€‰ä¸¾ã€‚åœ¨ã€Œ4. åˆ é™¤ä¸»èŠ‚ç‚¹ã€å°ç»“ï¼Œæˆ‘ä»¬ä¼šè§£å¼€è¿™ä¸ªç­”æ¡ˆã€‚è¿™é‡Œå¤§å®¶å…ˆè®°ä½è¿™ä¸ªç»“è®ºã€‚</li>
<li>æ ¹æ®ä¸Šé¢æˆ‘ä»¬è¯´çš„ç»“è®ºï¼Œè¿™é‡Œå°±å¾ˆå¥½ç†è§£äº†ï¼Œ<code>#isActiveElection()</code> æ–¹æ³•åˆ¤æ–­äº†ä¸¤ä¸ªæ¡ä»¶ï¼š( 1 ) ä¸å­˜åœ¨ä¸»èŠ‚ç‚¹ï¼›( 2 ) å¼€å¯ä½œä¸šï¼Œä¸å†ç¦ç”¨ï¼Œå› æ­¤éœ€è¦è¿›è¡Œä¸»èŠ‚ç‚¹é€‰ä¸¾è½ã€‚</li>
<li>è¿™é‡Œåˆ¤æ–­å¼€å¯ä½œä¸šçš„æ–¹æ³• <code>#isLocalServerEnabled(...)</code> æœ‰ç‚¹ç‰¹æ®Šï¼Œå®ƒä¸æ˜¯é€šè¿‡ä½œä¸šèŠ‚ç‚¹æ˜¯å¦å¤„äºå¼€å¯çŠ¶æ€ï¼Œè€Œæ˜¯è¯¥æ•°æ®ä¸æ˜¯å°†ä½œä¸šèŠ‚ç‚¹æ›´æ–°æˆå…³é—­çŠ¶æ€ã€‚ä¸¾ä¸ªä¾‹å­ï¼šä½œä¸šèŠ‚ç‚¹å¤„äº<strong>ç¦ç”¨</strong>çŠ¶æ€ï¼Œä½¿ç”¨<strong>è¿ç»´å¹³å°</strong>è®¾ç½®ä½œä¸šèŠ‚ç‚¹å¼€å¯ï¼Œä¼šè¿›è¡Œä¸»èŠ‚ç‚¹é€‰ä¸¾ï¼›ä½œä¸šèŠ‚ç‚¹å¤„äº<strong>å¼€å¯</strong>çŠ¶æ€ï¼Œä½¿ç”¨<strong>è¿ç»´å¹³å°</strong>è®¾ç½®ä½œä¸šèŠ‚ç‚¹ç¦ç”¨ï¼Œä¸ä¼šè¿›è¡Œä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‚</li>
</ul>
</li>
<li><p><strong>è¢«åŠ¨</strong>é€‰ä¸¾ <code>#isPassiveElection(...)</code></p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isPassiveElection</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> isLeaderCrashed(path, eventType) <span class="comment">// ä¸»èŠ‚ç‚¹ Crashed</span></div><div class="line">          &amp;&amp; serverService.isAvailableServer(JobRegistry.getInstance().getJobInstance(jobName).getIp()); <span class="comment">// å½“å‰èŠ‚ç‚¹æ­£åœ¨è¿è¡Œä¸­ï¼ˆæœªæŒ‚æ‰ï¼‰</span></div><div class="line">&#125;</div><div class="line">   </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isLeaderCrashed</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> leaderNode.isLeaderInstancePath(path) &amp;&amp; Type.NODE_REMOVED == eventType;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å½“ä¸»èŠ‚ç‚¹å› ä¸ºå„ç§æƒ…å†µ( ã€Œ4. åˆ é™¤ä¸»èŠ‚ç‚¹ã€ä¼šåˆ—ä¸¾ )è¢«åˆ é™¤ï¼Œéœ€è¦é‡æ–°è¿›è¡Œé€‰ä¸¾ã€‚å¯¹çš„ï¼Œ<strong>å¿…é¡»ä¸»èŠ‚ç‚¹è¢«åˆ é™¤åæ‰å¯ä»¥é‡æ–°è¿›è¡Œé€‰ä¸¾</strong>ã€‚</li>
<li><code>#isPassiveElection(...)</code> æ–¹æ³•åˆ¤æ–­äº†ä¸¤ä¸ªæ¡ä»¶ï¼š( 1 ) åŸä¸»èŠ‚ç‚¹è¢«åˆ é™¤ï¼›( 2 ) å½“å‰èŠ‚ç‚¹æ­£åœ¨è¿è¡Œä¸­ï¼ˆæœªæŒ‚æ‰ï¼‰ï¼Œå¯ä»¥å‚åŠ ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‚</li>
<li><code>#isLeaderCrashed(...)</code> æ–¹æ³•è™½ç„¶å‘½åå¸¦æœ‰ <code>Crashed</code> è‹±æ–‡ï¼Œå®é™…ä¸»ä½œä¸šèŠ‚ç‚¹<strong>æ­£å¸¸</strong>é€€å‡ºä¹Ÿç¬¦åˆ<strong>è¢«åŠ¨</strong>é€‰ä¸¾æ¡ä»¶ã€‚</li>
</ul>
</li>
</ul>
<p><strong>ç­‰å¾…ä¸»èŠ‚ç‚¹é€‰ä¸¾å®Œæˆ</strong></p>
<p>å¿…é¡»åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œçš„æ“ä½œï¼Œæ‰§è¡Œä¹‹å‰ï¼Œéœ€è¦åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºä¸»èŠ‚ç‚¹ã€‚å¦‚æœä¸»èŠ‚ç‚¹å·²ç»é€‰ä¸¾å¥½ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œåˆ¤æ–­ã€‚ä½†æ˜¯ï¼Œä¸æ’é™¤ä¸»èŠ‚ç‚¹è¿˜æ²¡é€‰ä¸¾åˆ°ï¼Œå› è€Œéœ€è¦é˜»å¡ç­‰å¾…åˆ°ä¸»èŠ‚ç‚¹é€‰ä¸¾å®Œæˆåæ‰èƒ½è¿›è¡Œåˆ¤æ–­ã€‚</p>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LeaderService.java</span></div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦æ˜¯ä¸»èŠ‚ç‚¹.</div><div class="line">* </div><div class="line">* å¦‚æœä¸»èŠ‚ç‚¹æ­£åœ¨é€‰ä¸¾ä¸­è€Œå¯¼è‡´å–ä¸åˆ°ä¸»èŠ‚ç‚¹, åˆ™é˜»å¡è‡³ä¸»èŠ‚ç‚¹é€‰ä¸¾å®Œæˆå†è¿”å›.</div><div class="line">* </div><div class="line">* <span class="doctag">@return</span> å½“å‰èŠ‚ç‚¹æ˜¯å¦æ˜¯ä¸»èŠ‚ç‚¹</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLeaderUntilBlock</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ä¸å­˜åœ¨ä¸»èŠ‚ç‚¹ &amp;&amp; æœ‰å¯ç”¨çš„æœåŠ¡å™¨èŠ‚ç‚¹</span></div><div class="line">   <span class="keyword">while</span> (!hasLeader() &amp;&amp; serverService.hasAvailableServers()) &#123;</div><div class="line">       log.info(<span class="string">"Leader is electing, waiting for &#123;&#125; ms"</span>, <span class="number">100</span>);</div><div class="line">       BlockUtils.waitingShortTime();</div><div class="line">       <span class="keyword">if</span> (!JobRegistry.getInstance().isShutdown(jobName)</div><div class="line">               &amp;&amp; serverService.isAvailableServer(JobRegistry.getInstance().getJobInstance(jobName).getIp())) &#123; <span class="comment">// å½“å‰æœåŠ¡å™¨èŠ‚ç‚¹å¯ç”¨</span></div><div class="line">           electLeader();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è¿”å›å½“å‰èŠ‚ç‚¹æ˜¯å¦æ˜¯ä¸»èŠ‚ç‚¹</span></div><div class="line">   <span class="keyword">return</span> isLeader();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>BlockUtils#waitingShortTime()</code> æ–¹æ³•ï¼Œé€‰ä¸¾ä¸åˆ°ä¸»èŠ‚ç‚¹è¿›è¡Œç­‰å¾…ï¼Œé¿å…ä¸é—´æ–­ã€æ— é—´éš”çš„è¿›è¡Œä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‚</li>
</ul>
<h1 id="4-åˆ é™¤ä¸»èŠ‚ç‚¹"><a href="#4-åˆ é™¤ä¸»èŠ‚ç‚¹" class="headerlink" title="4. åˆ é™¤ä¸»èŠ‚ç‚¹"></a>4. åˆ é™¤ä¸»èŠ‚ç‚¹</h1><p>æœ‰ä¸»èŠ‚ç‚¹çš„é€‰ä¸¾ï¼Œå¿…ç„¶æœ‰ä¸»èŠ‚ç‚¹çš„åˆ é™¤ï¼Œå¦åˆ™æ€ä¹ˆè¿›è¡Œ<strong>é‡æ–°é€‰ä¸¾</strong>ã€‚</p>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LeaderService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ é™¤ä¸»èŠ‚ç‚¹ä¾›é‡æ–°é€‰ä¸¾.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeLeader</span><span class="params">()</span> </span>&#123;</div><div class="line">   jobNodeStorage.removeJobNodeIfExisted(LeaderNode.INSTANCE);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>åˆ é™¤ä¸»èŠ‚ç‚¹æ—¶æœº</strong></p>
<p><strong>ç¬¬ä¸€ç§</strong>ï¼Œä¸»èŠ‚ç‚¹è¿›ç¨‹<strong>æ­£å¸¸</strong>å…³é—­æ—¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobShutdownHookPlugin</span> <span class="keyword">extends</span> <span class="title">ShutdownHookPlugin</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line">        CoordinatorRegistryCenter regCenter = JobRegistry.getInstance().getRegCenter(jobName);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == regCenter) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        LeaderService leaderService = <span class="keyword">new</span> LeaderService(regCenter, jobName);</div><div class="line">        <span class="keyword">if</span> (leaderService.isLeader()) &#123;</div><div class="line">            leaderService.removeLeader(); <span class="comment">// ç§»é™¤ä¸»èŠ‚ç‚¹</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">new</span> InstanceService(regCenter, jobName).removeInstance();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£ï¼Œé€€å‡ºè¿›ç¨‹ï¼Œè‹¥è¯¥è¿›ç¨‹ä¸ºä¸»èŠ‚ç‚¹ï¼Œéœ€è¦å°†è‡ªå·±ç§»é™¤ã€‚</li>
</ul>
<p><strong>ç¬¬äºŒç§</strong>ï¼Œä¸»èŠ‚ç‚¹è¿›ç¨‹ CRASHED æ—¶ã€‚</p>
<p><code>${JOB_NAME}/leader/electron/instance</code> æ˜¯<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ï¼Œä¸»èŠ‚ç‚¹è¿›ç¨‹ CRASHED åï¼Œè¶…è¿‡æœ€å¤§ä¼šè¯æ—¶é—´ï¼ŒZookeeper è‡ªåŠ¨è¿›è¡Œåˆ é™¤ï¼Œè§¦å‘é‡æ–°é€‰ä¸¾é€»è¾‘ã€‚</p>
<p><strong>ç¬¬ä¸‰ç§</strong>ï¼Œä½œä¸šè¢«<strong>ç¦ç”¨</strong>æ—¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeaderAbdicationJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (leaderService.isLeader() &amp;&amp; isLocalServerDisabled(path, data)) &#123;</div><div class="line">           leaderService.removeLeader();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isLocalServerDisabled</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> serverNode.isLocalServerPath(path) &amp;&amp; ServerStatus.DISABLED.name().equals(data);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è¿™é‡Œå°±è§£ç­”ä¸Šé¢æˆ‘ä»¬é—ç•™çš„ç–‘é—®ã€‚è¢«ç¦ç”¨çš„ä½œä¸š<strong>æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯æ—¶</strong>å³ä½¿è¿›è¡Œäº†ä¸»èŠ‚ç‚¹é€‰ä¸¾ï¼Œä¹Ÿä¼šè¢«è¯¥ç›‘å¬å™¨å¤„ç†ï¼Œç§»é™¤è¯¥é€‰ä¸¾çš„ä¸»èŠ‚ç‚¹ã€‚</li>
</ul>
<p><strong>ç¬¬å››ç§</strong>ï¼Œä¸»èŠ‚ç‚¹è¿›ç¨‹<strong>è¿œç¨‹</strong>å…³é—­ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// InstanceShutdownStatusJobListener.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">InstanceShutdownStatusJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">        </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (!JobRegistry.getInstance().isShutdown(jobName)</div><div class="line">               &amp;&amp; !JobRegistry.getInstance().getJobScheduleController(jobName).isPaused() <span class="comment">// ä½œä¸šæœªæš‚åœè°ƒåº¦</span></div><div class="line">               &amp;&amp; isRemoveInstance(path, eventType) <span class="comment">// ç§»é™¤ã€è¿è¡Œå®ä¾‹ã€‘äº‹ä»¶</span></div><div class="line">               &amp;&amp; !isReconnectedRegistryCenter()) &#123; <span class="comment">// è¿è¡Œå®ä¾‹è¢«ç§»é™¤</span></div><div class="line">           schedulerFacade.shutdownInstance();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isRemoveInstance</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> instanceNode.isLocalInstancePath(path) &amp;&amp; Type.NODE_REMOVED == eventType;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isReconnectedRegistryCenter</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> instanceService.isLocalJobInstanceExisted();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SchedulerFacade.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ç»ˆæ­¢ä½œä¸šè°ƒåº¦.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdownInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (leaderService.isLeader()) &#123;</div><div class="line">       leaderService.removeLeader(); <span class="comment">// ç§»é™¤ä¸»èŠ‚ç‚¹</span></div><div class="line">   &#125;</div><div class="line">   monitorService.close();</div><div class="line">   <span class="keyword">if</span> (reconcileService.isRunning()) &#123;</div><div class="line">       reconcileService.stopAsync();</div><div class="line">   &#125;</div><div class="line">   JobRegistry.getInstance().shutdown(jobName);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>è¿œç¨‹</strong>å…³é—­ä½œä¸šèŠ‚ç‚¹æœ‰ä¸¤ç§æ–¹å¼ï¼š<ul>
<li>zkClient å‘èµ·å‘½ä»¤ï¼š<code>rmr /${NAMESPACE}/${JOB_NAME}/instances/${JOB_INSTANCE_ID}</code>ã€‚</li>
<li>è¿ç»´å¹³å°å‘èµ· <code>Shutdown</code> æ“ä½œã€‚<code>Shutdown</code> æ“ä½œå®è´¨ä¸Šå°±æ˜¯ç¬¬ä¸€ç§ã€‚<br>  <img src="http://www.yunai.me/images/Elastic-Job/2017_10_21/04.png" alt=""></li>
</ul>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šå“å“Ÿï¼Œè¿™æ¬¡ç«Ÿç„¶åˆ†äº«äº†ç‚¹å¹²è´§ ğŸ˜ˆ<br>èŠ‹é“å›ï¼šå˜¿å‘€å˜¿å‘€ï¼Œå¿…é¡»çš„å•Šï¼Œè™½ç„¶æœ‰ç‚¹ç„¦å¤´çƒ‚é¢å•¦ã€‚  </p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_21/03.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;&quot;&gt;2. ä¸ºä»€ä¹ˆéœ€è¦é€‰ä¸¾ä¸»èŠ‚ç‚¹&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;&quot;
    
    </summary>
    
      <category term="Elastic-Job" scheme="http://www.yunai.me/categories/Elastic-Job/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒç›‘å¬å™¨</title>
    <link href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper-listener/"/>
    <id>http://www.yunai.me/Elastic-Job/reg-center-zookeeper-listener/</id>
    <published>2017-10-13T16:00:00.000Z</published>
    <updated>2017-08-28T09:43:27.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ListenerManager</a></li>
<li><a href="#">3. AbstractListenerManager</a></li>
<li><a href="#">4. AbstractJobListener</a></li>
<li><a href="#">5. RegistryCenterConnectionStateListener</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite æ³¨å†Œä¸­å¿ƒç›‘å¬å™¨</strong>ã€‚</p>
<p>å»ºè®®å‰ç½®é˜…è¯»ï¼š</p>
<ul>
<li><a href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒã€‹</a></li>
</ul>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_10_14/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_14/01.png" alt=""></p>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-ListenerManager"><a href="#2-ListenerManager" class="headerlink" title="2. ListenerManager"></a>2. ListenerManager</h1><p>ListenerManagerï¼Œä½œä¸šæ³¨å†Œä¸­å¿ƒçš„ç›‘å¬å™¨ç®¡ç†è€…ã€‚ç®¡ç†è€…<strong>ä¸¤ç±»</strong>ç»„ä»¶ï¼š</p>
<ul>
<li>ç›‘å¬ç®¡ç†å™¨</li>
<li>æ³¨å†Œä¸­å¿ƒè¿æ¥çŠ¶æ€ç›‘å¬å™¨</li>
</ul>
<p>å…¶ä¸­<strong>ç›‘å¬ç®¡ç†å™¨</strong>ç®¡ç†ç€è‡ªå·±çš„ä½œä¸šæ³¨å†Œä¸­å¿ƒç›‘å¬å™¨ã€‚</p>
<p>ä¸€èµ·ä»ä»£ç å±‚é¢çœ‹çœ‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ListenerManager</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobNodeStorage jobNodeStorage;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ElectionListenerManager electionListenerManager;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ShardingListenerManager shardingListenerManager;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FailoverListenerManager failoverListenerManager;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MonitorExecutionListenerManager monitorExecutionListenerManager;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ShutdownListenerManager shutdownListenerManager;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TriggerListenerManager triggerListenerManager;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RescheduleListenerManager rescheduleListenerManager;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GuaranteeListenerManager guaranteeListenerManager;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RegistryCenterConnectionStateListener regCenterConnectionStateListener;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>ç¬¬ä¸€ç±»ï¼š<code>electionListenerManager</code> / <code>shardingListenerManager</code> / <code>failoverListenerManager</code> / <code>MonitorExecutionListenerManager</code> / <code>shutdownListenerManager</code> / <code>triggerListenerManager</code> / <code>rescheduleListenerManager</code> / <code>guaranteeListenerManager</code> æ˜¯ä¸åŒæœåŠ¡çš„<strong>ç›‘å¬ç®¡ç†å™¨</strong>ï¼Œéƒ½ç»§æ‰¿<strong>ä½œä¸šæ³¨å†Œä¸­å¿ƒçš„ç›‘å¬å™¨ç®¡ç†è€…çš„æŠ½è±¡ç±»</strong>( AbstractListenerManager )ã€‚æˆ‘ä»¬ä»¥ä¸‹ä¸€ç¯‡æ–‡ç« ä¼šæ¶‰åŠåˆ°çš„<strong>åˆ†ç‰‡ç›‘å¬ç®¡ç†å™¨</strong>( ShardingListenerManager ) æ¥ç…ç…å†…éƒ¨æ•´ä½“å®ç°ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ShardingListenerManager</span> <span class="keyword">extends</span> <span class="title">AbstractListenerManager</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        addDataListener(<span class="keyword">new</span> ShardingTotalCountChangedJobListener());</div><div class="line">        addDataListener(<span class="keyword">new</span> ListenServersChangedJobListener());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ShardingTotalCountChangedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">        <span class="comment">// .... çœç•¥æ–¹æ³•</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ListenServersChangedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">        <span class="comment">// .... çœç•¥æ–¹æ³•</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ShardingListenerManager å†…éƒ¨ç®¡ç†äº† ShardingTotalCountChangedJobListener / ListenServersChangedJobListener ä¸¤ä¸ªä½œä¸šæ³¨å†Œä¸­å¿ƒç›‘å¬å™¨ã€‚å…·ä½“ä½œä¸šæ³¨å†Œä¸­å¿ƒç›‘å¬å™¨æ˜¯ä»€ä¹ˆï¼Œæœ‰ä»€ä¹ˆç”¨é€”ï¼Œä¸‹æ–‡ä¼šè¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>ç¬¬äºŒç±»ï¼š<code>regCenterConnectionStateListener</code> æ˜¯æ³¨å†Œä¸­å¿ƒè¿æ¥çŠ¶æ€ç›‘å¬å™¨ã€‚ä¸‹æ–‡ä¹Ÿä¼šè¯¦ç»†è§£æã€‚</li>
</ul>
<p>åœ¨<a href="http://www.yunai.me/Elastic-Job/job-init?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆå§‹åŒ–ã€‹ã€Œ3.2.4ã€æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯</a>ï¼Œæˆ‘ä»¬çœ‹åˆ°ä½œä¸šåˆå§‹åŒ–æ—¶ï¼Œä¼šå¼€å¯æ‰€æœ‰æ³¨å†Œä¸­å¿ƒç›‘å¬å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerFacade.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> enabled ä½œä¸šæ˜¯å¦å¯ç”¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStartUpInfo</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> enabled)</span> </span>&#123;</div><div class="line">   <span class="comment">// å¼€å¯ æ‰€æœ‰ç›‘å¬å™¨</span></div><div class="line">   listenerManager.startAllListeners();</div><div class="line">   <span class="comment">// .... çœç•¥æ–¹æ³•</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ListenerManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å¼€å¯æ‰€æœ‰ç›‘å¬å™¨.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startAllListeners</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// å¼€å¯ ä¸åŒæœåŠ¡ç›‘å¬ç®¡ç†å™¨</span></div><div class="line">   electionListenerManager.start();</div><div class="line">   shardingListenerManager.start();</div><div class="line">   failoverListenerManager.start();</div><div class="line">   monitorExecutionListenerManager.start();</div><div class="line">   shutdownListenerManager.start();</div><div class="line">   triggerListenerManager.start();</div><div class="line">   rescheduleListenerManager.start();</div><div class="line">   guaranteeListenerManager.start();</div><div class="line">   <span class="comment">// å¼€å¯ æ³¨å†Œä¸­å¿ƒè¿æ¥çŠ¶æ€ç›‘å¬å™¨</span></div><div class="line">   jobNodeStorage.addConnectionStateListener(regCenterConnectionStateListener);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="3-AbstractListenerManager"><a href="#3-AbstractListenerManager" class="headerlink" title="3. AbstractListenerManager"></a>3. AbstractListenerManager</h1><p>AbstractListenerManagerï¼Œä½œä¸šæ³¨å†Œä¸­å¿ƒçš„ç›‘å¬å™¨ç®¡ç†è€…çš„<strong>æŠ½è±¡ç±»</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractListenerManager</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobNodeStorage jobNodeStorage;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">AbstractListenerManager</span><span class="params">(<span class="keyword">final</span> CoordinatorRegistryCenter regCenter, <span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">        jobNodeStorage = <span class="keyword">new</span> JobNodeStorage(regCenter, jobName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¼€å¯ç›‘å¬å™¨.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ·»åŠ æ³¨å†Œä¸­å¿ƒç›‘å¬å™¨</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> listener æ³¨å†Œä¸­å¿ƒç›‘å¬å™¨</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addDataListener</span><span class="params">(<span class="keyword">final</span> TreeCacheListener listener)</span> </span>&#123;</div><div class="line">        jobNodeStorage.addDataListener(listener);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#addDataListener()</code>ï¼Œå°†ä½œä¸šæ³¨å†Œä¸­å¿ƒçš„ç›‘å¬å™¨æ·»åŠ åˆ°æ³¨å†Œä¸­å¿ƒ TreeCache çš„ç›‘å¬è€…é‡Œã€‚<code>JobNodeStorage#addDataListener(...)</code> åœ¨<a href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆå§‹åŒ–ã€‹ã€Œ2.2ã€ç¼“å­˜</a>å·²ç»è¯¦ç»†è§£æã€‚</li>
<li><p>å­ç±»å®ç° <code>#start()</code> æ–¹æ³•å®ç°ç›‘å¬å™¨åˆå§‹åŒ–ã€‚ç›®å‰æ‰€æœ‰å­ç±»çš„å®ç°éƒ½æ˜¯å°†è‡ªå·±ç®¡ç†çš„æ³¨å†Œä¸­å¿ƒç›‘å¬å™¨è°ƒç”¨ <code>#addDataListener(...)</code>ï¼Œè¿˜æ˜¯ä»¥ ShardingListenerManager ä¸¾ä¾‹å­ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ShardingListenerManager</span> <span class="keyword">extends</span> <span class="title">AbstractListenerManager</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        addDataListener(<span class="keyword">new</span> ShardingTotalCountChangedJobListener());</div><div class="line">        addDataListener(<span class="keyword">new</span> ListenServersChangedJobListener());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="4-AbstractJobListener"><a href="#4-AbstractJobListener" class="headerlink" title="4. AbstractJobListener"></a>4. AbstractJobListener</h1><p>AbstractJobListenerï¼Œä½œä¸šæ³¨å†Œä¸­å¿ƒçš„ç›‘å¬å™¨<strong>æŠ½è±¡ç±»</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractJobListener</span> <span class="keyword">implements</span> <span class="title">TreeCacheListener</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">childEvent</span><span class="params">(<span class="keyword">final</span> CuratorFramework client, <span class="keyword">final</span> TreeCacheEvent event)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        ChildData childData = event.getData();</div><div class="line">        <span class="comment">// å¿½ç•¥æ‰éæ•°æ®å˜åŒ–çš„äº‹ä»¶ï¼Œä¾‹å¦‚ event.type ä¸º CONNECTION_SUSPENDEDã€CONNECTION_RECONNECTEDã€CONNECTION_LOSTã€INITIALIZED äº‹ä»¶</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == childData) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        String path = childData.getPath();</div><div class="line">        <span class="keyword">if</span> (path.isEmpty()) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        dataChanged(path, event.getType(), <span class="keyword">null</span> == childData.getData() ? <span class="string">""</span> : <span class="keyword">new</span> String(childData.getData(), Charsets.UTF_8));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * èŠ‚ç‚¹æ•°æ®å˜åŒ–</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> path èŠ‚ç‚¹è·¯å¾„</div><div class="line">     * <span class="doctag">@param</span> eventType äº‹ä»¶ç±»å‹</div><div class="line">     * <span class="doctag">@param</span> data æ•°æ®</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä½œä¸šæ³¨å†Œä¸­å¿ƒçš„ç›‘å¬å™¨<strong>å®ç°ç±»</strong>å®ç° <code>#dataChanged(...)</code>ï¼Œå¯¹èŠ‚ç‚¹æ•°æ®å˜åŒ–è¿›è¡Œå¤„ç†ã€‚</li>
<li><code>#childEvent(...)</code> å±è”½æ‰éèŠ‚ç‚¹æ•°æ®å˜åŒ–äº‹ä»¶ï¼Œä¾‹å¦‚ï¼šCONNECTION_SUSPENDEDã€CONNECTION_RECONNECTEDã€CONNECTION_LOSTã€INITIALIZED äº‹ä»¶ï¼Œåªå¤„ç† NODE_ADDEDã€NODE_UPDATEDã€NODE_REMOVED äº‹ä»¶ã€‚</li>
</ul>
<p>æˆ‘ä»¬å†æ‹¿ ShardingListenerManager ä¸¾ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ShardingListenerManager</span> <span class="keyword">extends</span> <span class="title">AbstractListenerManager</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ShardingTotalCountChangedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (configNode.isConfigPath(path) &amp;&amp; <span class="number">0</span> != JobRegistry.getInstance().getCurrentShardingTotalCount(jobName)) &#123;</div><div class="line">                <span class="keyword">int</span> newShardingTotalCount = LiteJobConfigurationGsonFactory.fromJson(data).getTypeConfig().getCoreConfig().getShardingTotalCount();</div><div class="line">                <span class="keyword">if</span> (newShardingTotalCount != JobRegistry.getInstance().getCurrentShardingTotalCount(jobName)) &#123;</div><div class="line">                    shardingService.setReshardingFlag();</div><div class="line">                    JobRegistry.getInstance().setCurrentShardingTotalCount(jobName, newShardingTotalCount);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ListenServersChangedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (!JobRegistry.getInstance().isShutdown(jobName) &amp;&amp; (isInstanceChange(eventType, path) || isServerChange(path))) &#123;</div><div class="line">                shardingService.setReshardingFlag();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isInstanceChange</span><span class="params">(<span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String path)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> instanceNode.isInstancePath(path) &amp;&amp; Type.NODE_UPDATED != eventType;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isServerChange</span><span class="params">(<span class="keyword">final</span> String path)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> serverNode.isServerPath(path);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>åœ¨<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä»»åŠ¡åˆ†ç‰‡ã€‹</a>è¯¦ç»†è§£æã€‚</li>
</ul>
<h1 id="5-RegistryCenterConnectionStateListener"><a href="#5-RegistryCenterConnectionStateListener" class="headerlink" title="5. RegistryCenterConnectionStateListener"></a>5. RegistryCenterConnectionStateListener</h1><p>RegistryCenterConnectionStateListenerï¼Œå®ç° Curator ConnectionStateListener æ¥å£ï¼Œæ³¨å†Œä¸­å¿ƒè¿æ¥çŠ¶æ€ç›‘å¬å™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistryCenterConnectionStateListener</span> <span class="keyword">implements</span> <span class="title">ConnectionStateListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stateChanged</span><span class="params">(<span class="keyword">final</span> CuratorFramework client, <span class="keyword">final</span> ConnectionState newState)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (JobRegistry.getInstance().isShutdown(jobName)) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        JobScheduleController jobScheduleController = JobRegistry.getInstance().getJobScheduleController(jobName);</div><div class="line">        <span class="keyword">if</span> (ConnectionState.SUSPENDED == newState || ConnectionState.LOST == newState) &#123; <span class="comment">// Zookeeper è¿æ¥ç»ˆç«¯ æˆ– è¿æ¥ä¸¢å¤±</span></div><div class="line">            <span class="comment">// æš‚åœä½œä¸šè°ƒåº¦</span></div><div class="line">            jobScheduleController.pauseJob();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ConnectionState.RECONNECTED == newState) &#123; <span class="comment">// Zookeeper é‡æ–°è¿ä¸Š</span></div><div class="line">            <span class="comment">// æŒä¹…åŒ–ä½œä¸šæœåŠ¡å™¨ä¸Šçº¿ä¿¡æ¯</span></div><div class="line">            serverService.persistOnline(serverService.isEnableServer(JobRegistry.getInstance().getJobInstance(jobName).getIp()));</div><div class="line">            <span class="comment">// æŒä¹…åŒ–ä½œä¸šè¿è¡Œå®ä¾‹ä¸Šçº¿ç›¸å…³ä¿¡æ¯</span></div><div class="line">            instanceService.persistOnline();</div><div class="line">            <span class="comment">// æ¸…é™¤æœ¬åœ°åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹è¿è¡Œä¸­çš„æ ‡è®°</span></div><div class="line">            executionService.clearRunningInfo(shardingService.getLocalShardingItems());</div><div class="line">            <span class="comment">// æ¢å¤ä½œä¸šè°ƒåº¦</span></div><div class="line">            jobScheduleController.resumeJob();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>å½“æ³¨å†Œä¸­å¿ƒè¿æ¥ SUSPENDED æˆ– LOST æ—¶ï¼Œæš‚åœ<strong>æœ¬åœ°</strong>ä½œä¸šè°ƒåº¦ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobScheduleController.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">pauseJob</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">if</span> (!scheduler.isShutdown()) &#123;</div><div class="line">           scheduler.pauseAll();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>å½“æ³¨å†Œä¸­å¿ƒé‡æ–°è¿æ¥æˆåŠŸ( RECONNECTED )ï¼Œæ¢å¤<strong>æœ¬åœ°</strong>ä½œä¸šè°ƒåº¦ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* æ¢å¤ä½œä¸š.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">resumeJob</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">if</span> (!scheduler.isShutdown()) &#123;</div><div class="line">          scheduler.resumeAll();</div><div class="line">      &#125;</div><div class="line">  &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šèŠ‹é“å›ï¼Œä½ åˆæ°´æ›´äº†ï¼<br>èŠ‹é“å›ï¼šæ˜¯æ˜¯æ˜¯ï¼Œæ˜¯æ˜¯æ˜¯ï¼</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_14/02.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ListenerManager&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a 
    
    </summary>
    
      <category term="Elastic-Job" scheme="http://www.yunai.me/categories/Elastic-Job/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ•°æ®å­˜å‚¨</title>
    <link href="http://www.yunai.me/Elastic-Job/job-storage/"/>
    <id>http://www.yunai.me/Elastic-Job/job-storage/</id>
    <published>2017-10-06T16:00:00.000Z</published>
    <updated>2017-08-28T09:48:49.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#1-%E6%A6%82%E8%BF%B0">1. æ¦‚è¿°</a></li>
<li><a href="#2-jobnodepath">2. JobNodePath</a></li>
<li><a href="#3-jobnodestorage">3. JobNodeStorage</a></li>
<li><a href="#4-configurationnode">4. ConfigurationNode</a></li>
<li><a href="#5-servernode">5. ServerNode</a></li>
<li><a href="#6-instancenode">6. InstanceNode</a></li>
<li><a href="#7-shardingnode">7. ShardingNode</a></li>
<li><a href="#8-leadernode">8. LeaderNode</a></li>
<li><a href="#9-failovernode">9. FailoverNode</a></li>
<li><a href="#10-guaranteenode">10. GuaranteeNode</a></li>
<li><a href="#666-%E5%BD%A9%E8%9B%8B">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šæ•°æ®å­˜å‚¨</strong>ã€‚</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_10_07/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_07/01.png" alt=""></p>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-JobNodePath"><a href="#2-JobNodePath" class="headerlink" title="2. JobNodePath"></a>2. JobNodePath</h1><p>JobNodePathï¼Œä½œä¸šèŠ‚ç‚¹è·¯å¾„ç±»ã€‚<strong>ä½œä¸šèŠ‚ç‚¹æ˜¯åœ¨æ™®é€šçš„èŠ‚ç‚¹å‰åŠ ä¸Šä½œä¸šåç§°çš„å‰ç¼€</strong>ã€‚</p>
<p>åœ¨ Zookeeper çœ‹ä¸€ä¸ªä½œä¸šçš„æ•°æ®å­˜å‚¨ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 65] ls /elastic-job-example-lite-java/javaSimpleJob</div><div class="line">[leader, servers, config, instances, sharding]</div></pre></td></tr></table></figure>
<ul>
<li><code>elastic-job-example-lite-java</code>ï¼šä½œä¸šèŠ‚ç‚¹é›†ç¾¤åï¼Œä½¿ç”¨ <code>ZookeeperConfiguration.namespace</code> å±æ€§é…ç½®ã€‚</li>
<li><code>javaSimpleJob</code>ï¼šä½œä¸šåå­—ï¼Œä½¿ç”¨ <code>JobCoreConfiguration.jobName</code> å±æ€§é…ç½®ã€‚</li>
<li><code>config</code> / <code>servers</code> / <code>instances</code> / <code>sharding</code> / <code>leader</code>ï¼šä¸åŒæœåŠ¡çš„æ•°æ®å­˜å‚¨èŠ‚ç‚¹è·¯å¾„ã€‚</li>
</ul>
<p>JobNodePathï¼Œæ³¨é‡Šå¾ˆæ˜“æ‡‚ï¼Œç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/7dc099541a16de49f024fc59e46377a726be7f6b/elastic-job-lite/elastic-job-lite-core/src/main/java/com/dangdang/ddframe/job/lite/internal/storage/JobNodePath.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ã€‚è¿™é‡Œæˆ‘ä»¬æ¢³ç†ä¸‹ JobNodePath å’Œ<strong>å…¶å®ƒèŠ‚ç‚¹è·¯å¾„ç±»</strong>çš„å…³ç³»ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">Zookeeper è·¯å¾„</th>
<th style="text-align:left">JobNodePath é™æ€å±æ€§</th>
<th style="text-align:left">JobNodePath æ–¹æ³•</th>
<th style="text-align:left">èŠ‚ç‚¹è·¯å¾„ç±»</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>config</code></td>
<td style="text-align:left">CONFIG_NODE</td>
<td style="text-align:left"><code>#getConfigNodePath()</code></td>
<td style="text-align:left">ConfigurationNode</td>
</tr>
<tr>
<td style="text-align:left"><code>servers</code></td>
<td style="text-align:left">SERVERS_NODE</td>
<td style="text-align:left"><code>#getServerNodePath()</code></td>
<td style="text-align:left">ServerNode</td>
</tr>
<tr>
<td style="text-align:left"><code>instances</code></td>
<td style="text-align:left">INSTANCES_NODE</td>
<td style="text-align:left"><code>#getInstancesNodePath()</code></td>
<td style="text-align:left">InstanceNode</td>
</tr>
<tr>
<td style="text-align:left"><code>sharding</code></td>
<td style="text-align:left">SHARDING_NODE</td>
<td style="text-align:left"><code>#getShardingNodePath()</code></td>
<td style="text-align:left">ShardingNode</td>
</tr>
<tr>
<td style="text-align:left"><code>leader</code></td>
<td style="text-align:left">/</td>
<td style="text-align:left"><code>#getFullPath(node)</code></td>
<td style="text-align:left">LeaderNode</td>
</tr>
<tr>
<td style="text-align:left"><code>leader/failover</code></td>
<td style="text-align:left">/</td>
<td style="text-align:left"><code>#getFullPath(node)</code></td>
<td style="text-align:left">FailoverNode</td>
</tr>
<tr>
<td style="text-align:left"><code>guarantee</code></td>
<td style="text-align:left">/</td>
<td style="text-align:left"><code>#getFullPath(node)</code></td>
<td style="text-align:left">GuaranteeNode</td>
</tr>
</tbody>
</table>
<h1 id="3-JobNodeStorage"><a href="#3-JobNodeStorage" class="headerlink" title="3. JobNodeStorage"></a>3. JobNodeStorage</h1><p>JobNodeStorageï¼Œä½œä¸šèŠ‚ç‚¹æ•°æ®è®¿é—®ç±»ã€‚</p>
<p>Elastic-Job-Lite ä½¿ç”¨<strong>æ³¨å†Œä¸­å¿ƒ</strong>å­˜å‚¨ä½œä¸šèŠ‚ç‚¹æ•°æ®ï¼ŒJobNodeStorage å¯¹æ³¨å†Œä¸­å¿ƒæä¾›çš„æ–¹æ³•åšä¸‹ç®€å•çš„å°è£…æä¾›è°ƒç”¨ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobNodeStorage.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> CoordinatorRegistryCenter regCenter;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> JobNodePath jobNodePath;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ¤æ–­ä½œä¸šèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> node ä½œä¸šèŠ‚ç‚¹åç§°</div><div class="line">* <span class="doctag">@return</span> ä½œä¸šèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isJobNodeExisted</span><span class="params">(<span class="keyword">final</span> String node)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> regCenter.isExisted(jobNodePath.getFullPath(node));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobNodePath.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–èŠ‚ç‚¹å…¨è·¯å¾„.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> node èŠ‚ç‚¹åç§°</div><div class="line">* <span class="doctag">@return</span> èŠ‚ç‚¹å…¨è·¯å¾„</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getFullPath</span><span class="params">(<span class="keyword">final</span> String node)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> String.format(<span class="string">"/%s/%s"</span>, jobName, node);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä¼ é€’çš„å‚æ•° <code>node</code> åªæ˜¯ç®€å•çš„<strong>ä½œä¸šèŠ‚ç‚¹åç§°</strong>ï¼Œé€šè¿‡è°ƒç”¨ <code>JobNodePath#getFullPath(...)</code> æ–¹æ³•è·å–èŠ‚ç‚¹å…¨è·¯å¾„ã€‚</li>
<li>å…¶å®ƒæ–¹æ³•ç±»ä¼¼ï¼Œæœ‰å…´è¶£çš„åŒå­¦ç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/7dc099541a16de49f024fc59e46377a726be7f6b/elastic-job-lite/elastic-job-lite-core/src/main/java/com/dangdang/ddframe/job/lite/internal/storage/JobNodePath.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ã€‚</li>
</ul>
<h1 id="4-ConfigurationNode"><a href="#4-ConfigurationNode" class="headerlink" title="4. ConfigurationNode"></a>4. ConfigurationNode</h1><p>ConfigurationNodeï¼Œé…ç½®èŠ‚ç‚¹è·¯å¾„ã€‚</p>
<p>åœ¨ Zookeeper çœ‹ä¸€ä¸ªä½œä¸šçš„<strong>é…ç½®</strong>èŠ‚ç‚¹æ•°æ®å­˜å‚¨ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 67] get /elastic-job-example-lite-java/javaSimpleJob/config</div><div class="line">&#123;<span class="string">"jobName"</span>:<span class="string">"javaSimpleJob"</span>,<span class="string">"jobClass"</span>:<span class="string">"com.dangdang.ddframe.job.example.job.simple.JavaSimpleJob"</span>,<span class="string">"jobType"</span>:<span class="string">"SIMPLE"</span>,<span class="string">"cron"</span>:<span class="string">"0/5 * * * * ?"</span>,<span class="string">"shardingTotalCount"</span>:3,<span class="string">"shardingItemParameters"</span>:<span class="string">"0\u003dBeijing,1\u003dShanghai,2\u003dGuangzhou"</span>,<span class="string">"jobParameter"</span>:<span class="string">""</span>,<span class="string">"failover"</span>:<span class="literal">true</span>,<span class="string">"misfire"</span>:<span class="literal">true</span>,<span class="string">"description"</span>:<span class="string">""</span>,<span class="string">"jobProperties"</span>:&#123;<span class="string">"job_exception_handler"</span>:<span class="string">"com.dangdang.ddframe.job.executor.handler.impl.DefaultJobExceptionHandler"</span>,<span class="string">"executor_service_handler"</span>:<span class="string">"com.dangdang.ddframe.job.executor.handler.impl.DefaultExecutorServiceHandler"</span>&#125;,<span class="string">"monitorExecution"</span>:<span class="literal">true</span>,<span class="string">"maxTimeDiffSeconds"</span>:-1,<span class="string">"monitorPort"</span>:-1,<span class="string">"jobShardingStrategyClass"</span>:<span class="string">""</span>,<span class="string">"reconcileIntervalMinutes"</span>:10,<span class="string">"disabled"</span>:<span class="literal">false</span>,<span class="string">"overwrite"</span>:<span class="literal">true</span>&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>/config</code> æ˜¯<strong>æŒä¹…</strong>èŠ‚ç‚¹ï¼Œå­˜å‚¨Liteä½œä¸šé…ç½®( LiteJobConfiguration ) JSONåŒ–å­—ç¬¦ä¸²ã€‚</li>
</ul>
<p>ConfigurationNode ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigurationNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = <span class="string">"config"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ConfigurationNode å¦‚ä½•è¯»å–ã€å­˜å‚¨ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-config/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹çš„ã€Œ3.ã€ä½œä¸šé…ç½®æœåŠ¡</a>å·²ç»è¯¦ç»†è§£æã€‚</p>
<h1 id="5-ServerNode"><a href="#5-ServerNode" class="headerlink" title="5. ServerNode"></a>5. ServerNode</h1><p>ServerNodeï¼ŒæœåŠ¡å™¨èŠ‚ç‚¹è·¯å¾„ã€‚</p>
<p>åœ¨ Zookeeper çœ‹ä¸€ä¸ªä½œä¸šçš„<strong>æœåŠ¡å™¨</strong>èŠ‚ç‚¹æ•°æ®å­˜å‚¨ï¼š </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 72] ls /elastic-job-example-lite-java/javaSimpleJob/servers</div><div class="line">[192.168.16.164, 169.254.93.156, 192.168.252.57, 192.168.16.137, 192.168.3.2, 192.168.43.31]</div><div class="line">[zk: localhost:2181(CONNECTED) 73] get /elastic-job-example-lite-java/javaSimpleJob/servers/192.168.16.164</div></pre></td></tr></table></figure>
<ul>
<li><code>/servers/</code> ç›®å½•ä¸‹ä»¥ <code>IP</code> ä¸ºæ•°æ®èŠ‚ç‚¹è·¯å¾„å­˜å‚¨æ¯ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ã€‚å¦‚æœ<strong>ç›¸åŒIP</strong>æœåŠ¡å™¨æœ‰å¤šä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ï¼Œåªå­˜å‚¨ä¸€ä¸ª <code>IP</code> æ•°æ®èŠ‚ç‚¹ã€‚</li>
<li><code>/servers/${IP}</code> æ˜¯<strong>æŒä¹…</strong>èŠ‚ç‚¹ï¼Œä¸å­˜å‚¨ä»»ä½•ä¿¡æ¯ï¼Œåªæ˜¯ç©ºä¸²( <code>&quot;&quot;</code>);</li>
</ul>
<p>ServerNode ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æœåŠ¡å™¨ä¿¡æ¯æ ¹èŠ‚ç‚¹.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = <span class="string">"servers"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVERS = ROOT + <span class="string">"/%s"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ServerNode å¦‚ä½•å­˜å‚¨ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-init/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆå§‹åŒ–ã€‹çš„ã€Œ3.2.4ã€æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯</a>å·²ç»è¯¦ç»†è§£æã€‚</p>
<h1 id="6-InstanceNode"><a href="#6-InstanceNode" class="headerlink" title="6. InstanceNode"></a>6. InstanceNode</h1><p>InstanceNodeï¼Œè¿è¡Œå®ä¾‹èŠ‚ç‚¹è·¯å¾„ã€‚</p>
<p>åœ¨ Zookeeper çœ‹ä¸€ä¸ªä½œä¸šçš„<strong>è¿è¡Œå®ä¾‹</strong>èŠ‚ç‚¹æ•°æ®å­˜å‚¨ï¼š </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 81] ls /elastic-job-example-lite-java/javaSimpleJob/instances</div><div class="line">[192.168.16.137@-@56010]</div><div class="line">[zk: localhost:2181(CONNECTED) 82] get /elastic-job-example-lite-java/javaSimpleJob/instances</div></pre></td></tr></table></figure>
<ul>
<li><code>/instances</code> ç›®å½•ä¸‹ä»¥ä½œä¸šå®ä¾‹ä¸»é”®( <code>JOB_INSTANCE_ID</code> ) ä¸ºæ•°æ®èŠ‚ç‚¹è·¯å¾„å­˜å‚¨æ¯ä¸ªè¿è¡Œå®ä¾‹èŠ‚ç‚¹ã€‚</li>
<li><code>/instances/${JOB_INSTANCE_ID}</code> æ˜¯<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ï¼Œä¸å­˜å‚¨ä»»ä½•ä¿¡æ¯ï¼Œåªæ˜¯ç©ºä¸²( <code>&quot;&quot;</code>);</li>
<li><p><code>JOB_INSTANCE_ID</code> ç”Ÿæˆæ–¹å¼ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobInstance.java</span></div><div class="line"></div><div class="line">jobInstanceId = IpUtils.getIp()</div><div class="line">                + DELIMITER</div><div class="line">                + ManagementFactory.getRuntimeMXBean().getName().split(<span class="string">"@"</span>)[<span class="number">0</span>]; <span class="comment">// PID</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>InstanceNode ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InstanceNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¿è¡Œå®ä¾‹ä¿¡æ¯æ ¹èŠ‚ç‚¹.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = <span class="string">"instances"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String INSTANCES = ROOT + <span class="string">"/%s"</span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–å½“å‰è¿è¡Œå®ä¾‹èŠ‚ç‚¹è·¯å¾„</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> å½“å‰è¿è¡Œå®ä¾‹èŠ‚ç‚¹è·¯å¾„</div><div class="line">     */</div><div class="line">    <span class="function">String <span class="title">getLocalInstanceNode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> String.format(INSTANCES, JobRegistry.getInstance().getJobInstance(jobName).getJobInstanceId());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>InstanceNode å¦‚ä½•å­˜å‚¨ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-init/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆå§‹åŒ–ã€‹çš„ã€Œ3.2.4ã€æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯</a>å·²ç»è¯¦ç»†è§£æã€‚</p>
<h1 id="7-ShardingNode"><a href="#7-ShardingNode" class="headerlink" title="7. ShardingNode"></a>7. ShardingNode</h1><p>ShardingNodeï¼Œåˆ†ç‰‡èŠ‚ç‚¹è·¯å¾„ã€‚</p>
<p>åœ¨ Zookeeper çœ‹ä¸€ä¸ªä½œä¸šçš„<strong>åˆ†ç‰‡</strong>èŠ‚ç‚¹æ•°æ®å­˜å‚¨ï¼š </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 1] ls /elastic-job-example-lite-java/javaSimpleJob/sharding</div><div class="line">[0, 1, 2]</div><div class="line">[zk: localhost:2181(CONNECTED) 2] ls /elastic-job-example-lite-java/javaSimpleJob/sharding/0</div><div class="line">[running, instance, misfire]</div><div class="line">[zk: localhost:2181(CONNECTED) 3] get /elastic-job-example-lite-java/javaSimpleJob/sharding/0/instance</div><div class="line">192.168.16.137@-@56010</div></pre></td></tr></table></figure>
<ul>
<li><code>/sharding/${ITEM_ID}</code> ç›®å½•ä¸‹ä»¥ä½œä¸šåˆ†ç‰‡é¡¹åºå·( <code>ITEM_ID</code> ) ä¸ºæ•°æ®èŠ‚ç‚¹è·¯å¾„å­˜å‚¨ä½œä¸šåˆ†ç‰‡é¡¹çš„ <code>instance</code> / <code>running</code> / <code>misfire</code> / <code>disable</code> <strong>æ•°æ®èŠ‚ç‚¹</strong>ä¿¡æ¯ã€‚</li>
<li><code>/sharding/${ITEM_ID}/instance</code> æ˜¯<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ï¼Œå­˜å‚¨è¯¥ä½œä¸šåˆ†ç‰‡é¡¹<strong>åˆ†é…åˆ°çš„ä½œä¸šå®ä¾‹ä¸»é”®</strong>( <code>JOB_INSTANCE_ID</code> )ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a>è¯¦ç»†è§£æã€‚</li>
<li><code>/sharding/${ITEM_ID}/running</code> æ˜¯<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ï¼Œå½“è¯¥ä½œä¸šåˆ†ç‰‡é¡¹<strong>æ­£åœ¨è¿è¡Œ</strong>ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ï¼›å½“è¯¥ä½œä¸šåˆ†ç‰‡é¡¹<strong>ä¸åœ¨è¿è¡Œ</strong>ï¼Œç§»é™¤è¯¥æ•°æ®èŠ‚ç‚¹ã€‚<a href="http://www.yunai.me/Elastic-Job/job-init/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹çš„ã€Œ4.6ã€æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸š</a>å·²ç»è¯¦ç»†è§£æã€‚</li>
<li><code>/sharding/${ITEM_ID}/misfire</code> æ˜¯<strong>æ°¸ä¹…èŠ‚ç‚¹</strong>ï¼Œå½“è¯¥ä½œä¸šåˆ†ç‰‡é¡¹<strong>è¢«é”™è¿‡æ‰§è¡Œ</strong>ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ï¼›å½“è¯¥ä½œä¸šåˆ†ç‰‡é¡¹é‡æ–°æ‰§è¡Œï¼Œç§»é™¤è¯¥æ•°æ®èŠ‚ç‚¹ã€‚<a href="http://www.yunai.me/Elastic-Job/job-init/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹çš„ã€Œ4.7ã€æ‰§è¡Œè¢«é”™è¿‡è§¦å‘çš„ä½œä¸š</a>å·²ç»è¯¦ç»†è§£æã€‚</li>
<li><code>/sharding/${ITEM_ID}/disable</code> æ˜¯<strong>æ°¸ä¹…èŠ‚ç‚¹</strong>ï¼Œå½“è¯¥ä½œä¸šåˆ†ç‰‡é¡¹<strong>è¢«ç¦ç”¨</strong>ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ï¼›å½“è¯¥ä½œä¸šåˆ†ç‰‡é¡¹<strong>è¢«å¼€å¯</strong>ï¼Œç§»é™¤æ•°æ®èŠ‚ç‚¹ã€‚</li>
</ul>
<p>ShardingNodeï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ShardingNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰§è¡ŒçŠ¶æ€æ ¹èŠ‚ç‚¹.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = <span class="string">"sharding"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String INSTANCE_APPENDIX = <span class="string">"instance"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String INSTANCE = ROOT + <span class="string">"/%s/"</span> + INSTANCE_APPENDIX;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String RUNNING_APPENDIX = <span class="string">"running"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String RUNNING = ROOT + <span class="string">"/%s/"</span> + RUNNING_APPENDIX;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String MISFIRE = ROOT + <span class="string">"/%s/misfire"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String DISABLED = ROOT + <span class="string">"/%s/disabled"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String LEADER_ROOT = LeaderNode.ROOT + <span class="string">"/"</span> + ROOT;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String NECESSARY = LEADER_ROOT + <span class="string">"/necessary"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String PROCESSING = LEADER_ROOT + <span class="string">"/processing"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>LEADER_ROOT / NECESSARY / PROCESSING æ”¾åœ¨ã€Œ4.7ã€<strong>LeaderNode</strong> è§£æã€‚</li>
</ul>
<h1 id="8-LeaderNode"><a href="#8-LeaderNode" class="headerlink" title="8. LeaderNode"></a>8. LeaderNode</h1><p>LeaderNodeï¼Œä¸»èŠ‚ç‚¹è·¯å¾„ã€‚</p>
<p>åœ¨ <code>leader</code> ç›®å½•ä¸‹ä¸€å…±æœ‰ä¸‰ä¸ªå­˜å‚¨å­èŠ‚ç‚¹ï¼š</p>
<ul>
<li><code>election</code>ï¼šä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‚</li>
<li><code>sharding</code>ï¼šä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…ã€‚</li>
<li><code>failover</code>ï¼šä½œä¸šå¤±æ•ˆè½¬ç§»ã€‚</li>
</ul>
<p><strong>ä¸»èŠ‚ç‚¹é€‰ä¸¾</strong></p>
<p>åœ¨ Zookeeper çœ‹ä¸€ä¸ªä½œä¸šçš„ <strong><code>leader/election</code></strong> èŠ‚ç‚¹æ•°æ®å­˜å‚¨ï¼š </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 1] ls /elastic-job-example-lite-java/javaSimpleJob/leader/election</div><div class="line">[latch, instance]</div><div class="line">[zk: localhost:2181(CONNECTED) 2] get /elastic-job-example-lite-java/javaSimpleJob/leader/election/instance</div><div class="line">192.168.16.137@-@1910</div></pre></td></tr></table></figure>
<ul>
<li><code>/leader/election/instance</code> æ˜¯<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ï¼Œå½“ä½œä¸šé›†ç¾¤å®Œæˆé€‰ä¸¾åï¼Œå­˜å‚¨ä¸»ä½œä¸šå®ä¾‹ä¸»é”®( <code>JOB_INSTANCE_ID</code> )ã€‚</li>
<li><code>/leader/election/latch</code> ä¸»èŠ‚ç‚¹é€‰ä¸¾åˆ†å¸ƒå¼é”ï¼Œæ˜¯ Apache Curator é’ˆå¯¹ Zookeeper å®ç°çš„<strong>åˆ†å¸ƒå¼é”</strong>çš„ä¸€ç§ï¼Œç¬”è€…æš‚æœªäº†è§£å­˜å‚¨å½¢å¼ï¼Œæ— æ³•è§£é‡Šã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒã€‹çš„ã€Œ3.1ã€åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œ</a>è¿›è¡Œäº†ç®€å•è§£æã€‚</li>
</ul>
<p><strong>ä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…</strong></p>
<p>åœ¨ Zookeeper çœ‹ä¸€ä¸ªä½œä¸šçš„ <strong><code>leader/sharding</code></strong> èŠ‚ç‚¹æ•°æ®å­˜å‚¨ï¼š </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 1] ls /elastic-job-example-lite-java/javaSimpleJob/leader/sharding</div><div class="line">[necessary, processing]</div><div class="line">[zk: localhost:2181(CONNECTED) 2] ä¸ªget /elastic-job-example-lite-java/javaSimpleJob/leader/sharding</div><div class="line"></div><div class="line">[zk: localhost:2181(CONNECTED) 3] ä¸ªget /elastic-job-example-lite-java/javaSimpleJob/leader/processing</div></pre></td></tr></table></figure>
<ul>
<li><code>/leader/sharding/necessary</code> æ˜¯<strong>æ°¸ä¹…èŠ‚ç‚¹</strong>ï¼Œå½“<strong>ç›¸åŒä½œä¸š</strong>æœ‰æ–°çš„ä½œä¸šèŠ‚ç‚¹åŠ å…¥æˆ–è€…ç§»é™¤æ—¶ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ï¼Œæ ‡è®°éœ€è¦è¿›è¡Œä½œä¸šåˆ†ç‰‡é¡¹é‡æ–°åˆ†é…ï¼›å½“é‡æ–°åˆ†é…å®Œæˆåï¼Œç§»é™¤è¯¥æ•°æ®èŠ‚ç‚¹ã€‚</li>
<li><code>/leader/sharding/processing</code> æ˜¯<strong>ä¸´æ—¶èŠ‚ç‚¹</strong>ï¼Œå½“å¼€å§‹é‡æ–°åˆ†é…ä½œä¸šåˆ†ç‰‡é¡¹æ—¶ï¼Œå­˜å‚¨ç©ºä¸²( <code>&quot;&quot;</code> )ï¼Œæ ‡è®°æ­£åœ¨è¿›è¡Œé‡æ–°åˆ†é…ï¼›å½“é‡æ–°åˆ†é…å®Œæˆåï¼Œç§»é™¤è¯¥æ•°æ®èŠ‚ç‚¹ã€‚</li>
<li>å½“ä¸”ä»…å½“ä½œä¸šèŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹æ—¶ï¼Œæ‰å¯ä»¥æ‰§è¡Œä½œä¸šåˆ†ç‰‡é¡¹åˆ†é…ï¼Œ<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a>è¯¦ç»†è§£æã€‚</li>
</ul>
<p><strong>ä½œä¸šå¤±æ•ˆè½¬ç§»</strong></p>
<p>ä½œä¸šå¤±æ•ˆè½¬ç§»æ•°æ®èŠ‚ç‚¹åœ¨ FailoverNodeï¼Œæ”¾åœ¨ã€Œ9ã€<strong>FailoverNode</strong> è§£æã€‚</p>
<p>è¿™é‡Œå¤§å®¶å¯èƒ½ä¼šå’Œæˆ‘ä¸€æ ·æ¯”è¾ƒç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆ <code>/leader/failover</code> æ”¾åœ¨ <code>/leader</code> ç›®å½•ä¸‹ï¼Œè€Œä¸ç‹¬ç«‹æˆä¸ºä¸€ä¸ªæ ¹ç›®å½•ï¼Ÿç»è¿‡ç¡®è®¤ï¼Œ<strong>ä½œä¸šå¤±æ•ˆè½¬ç§»</strong> è®¾è®¡åˆ°åˆ†å¸ƒå¼é”ï¼Œç»Ÿä¸€å­˜å‚¨åœ¨ <code>/leader</code> ç›®å½•ä¸‹ã€‚</p>
<hr>
<p>LeaderNodeï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LeaderNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸»èŠ‚ç‚¹æ ¹è·¯å¾„.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = <span class="string">"leader"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ELECTION_ROOT = ROOT + <span class="string">"/election"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String INSTANCE = ELECTION_ROOT + <span class="string">"/instance"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String  LATCH = ELECTION_ROOT + <span class="string">"/latch"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="9-FailoverNode"><a href="#9-FailoverNode" class="headerlink" title="9. FailoverNode"></a>9. FailoverNode</h1><p>FailoverNodeï¼Œå¤±æ•ˆè½¬ç§»èŠ‚ç‚¹è·¯å¾„ã€‚</p>
<p>åœ¨ Zookeeper çœ‹ä¸€ä¸ªä½œä¸šçš„<strong>å¤±æ•ˆè½¬ç§»</strong>èŠ‚ç‚¹æ•°æ®å­˜å‚¨ï¼š </p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">[zk: localhost:<span class="number">2181</span>(CONNECTED) <span class="number">2</span>] ls /elastic-job-example-lite-java/javaSimpleJob/leader/failover</div><div class="line">[latch, items]</div><div class="line">[zk: localhost:<span class="number">2181</span>(CONNECTED) <span class="number">4</span>] ls /elastic-job-example-lite-java/javaSimpleJob/leader/failover/items</div><div class="line">[<span class="number">0</span>]</div></pre></td></tr></table></figure>
<ul>
<li><code>/leader/failover/latch</code> ä½œä¸šå¤±æ•ˆè½¬ç§»åˆ†å¸ƒå¼é”ï¼Œå’Œ <code>/leader/failover/latch</code> æ˜¯ä¸€è‡´çš„ã€‚</li>
<li><code>/leader/items/${ITEM_ID}</code> æ˜¯<strong>æ°¸ä¹…èŠ‚ç‚¹</strong>ï¼Œå½“æŸå°ä½œä¸šèŠ‚ç‚¹ CRASH æ—¶ï¼Œå…¶åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹æ ‡è®°éœ€è¦è¿›è¡Œå¤±æ•ˆè½¬ç§»ï¼Œå­˜å‚¨å…¶åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹çš„ <code>/leader/items/${ITEM_ID}</code> ä¸ºç©ºä¸²( <code>&quot;&quot;</code> )ï¼›å½“å¤±æ•ˆè½¬ç§»æ ‡è®°ï¼Œç§»é™¤ <code>/leader/items/${ITEM_ID}</code>ï¼Œå­˜å‚¨ <code>/sharding/${ITEM_ID}/failover</code> ä¸ºç©ºä¸²( <code>&quot;&quot;</code> )ï¼Œ<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ï¼Œéœ€è¦è¿›è¡Œå¤±æ•ˆè½¬ç§»æ‰§è¡Œã€‚<a href="http://www.yunai.me/Elastic-Job/job-failover/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>è¯¦ç»†è§£æã€‚</li>
</ul>
<p>FailoverNode ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FailoverNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String FAILOVER = <span class="string">"failover"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String LEADER_ROOT = LeaderNode.ROOT + <span class="string">"/"</span> + FAILOVER;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ITEMS_ROOT = LEADER_ROOT + <span class="string">"/items"</span>;</div><div class="line">        </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ITEMS = ITEMS_ROOT + <span class="string">"/%s"</span>;</div><div class="line">        </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String LATCH = LEADER_ROOT + <span class="string">"/latch"</span>;</div><div class="line">        </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXECUTION_FAILOVER = ShardingNode.ROOT + <span class="string">"/%s/"</span> + FAILOVER;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">getItemsNode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> item)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> String.format(ITEMS, item);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">getExecutionFailoverNode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> item)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> String.format(EXECUTION_FAILOVER, item);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="10-GuaranteeNode"><a href="#10-GuaranteeNode" class="headerlink" title="10. GuaranteeNode"></a>10. GuaranteeNode</h1><p>GuaranteeNodeï¼Œä¿è¯åˆ†å¸ƒå¼ä»»åŠ¡å…¨éƒ¨å¼€å§‹å’Œç»“æŸçŠ¶æ€èŠ‚ç‚¹è·¯å¾„ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-listener/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šç›‘å¬å™¨ã€‹</a>è¯¦ç»†è§£æã€‚</p>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šèŠ‹é“å›ï¼Œä½ åˆæ°´æ›´äº†ï¼<br>èŠ‹é“å›ï¼šå±å±å±ï¼ŒåŠ³èµ„æ€¼æ­»ä½ ï¼å¦‚ä¸‹æ˜¯ä½œä¸šæ•°æ®å­˜å‚¨æ•´ç†ï¼Œå“¼å“¼å“ˆå…®ï¼</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_10_07/02.png" alt=""></p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-%E6%A6%82%E8%BF%B0&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-jobnodepath&quot;&gt;2.
    
    </summary>
    
      <category term="Elastic-Job" scheme="http://www.yunai.me/categories/Elastic-Job/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒ</title>
    <link href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper/"/>
    <id>http://www.yunai.me/Elastic-Job/reg-center-zookeeper/</id>
    <published>2017-09-29T16:00:00.000Z</published>
    <updated>2017-08-25T07:44:29.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. åŸºäº Zookeeper æ³¨å†Œä¸­å¿ƒ</a><ul>
<li><a href="#">2.1 åˆå§‹åŒ–</a></li>
<li><a href="#">2.2 ç¼“å­˜</a></li>
<li><a href="#">2.3 å…³é—­</a></li>
<li><a href="#">2.4 è·å¾—æ•°æ®</a></li>
<li><a href="#">2.5 è·å¾—æ³¨å†Œå­èŠ‚ç‚¹</a></li>
<li><a href="#">2.6 å­˜å‚¨æ³¨å†Œæ•°æ®</a></li>
<li><a href="#">2.7 å­˜å‚¨é¡ºåºæ³¨å†Œæ•°æ®</a></li>
<li><a href="#">2.8 ç§»é™¤æ³¨å†Œæ•°æ®</a></li>
<li><a href="#">2.9 è·å–æ³¨å†Œä¸­å¿ƒå½“å‰æ—¶é—´</a></li>
<li><a href="#">2.10 æ³¨å†Œä¸­å¿ƒå¼‚å¸¸å¤„ç†å™¨</a></li>
</ul>
</li>
<li><a href="#">3. ä½œä¸šèŠ‚ç‚¹æ•°æ®è®¿é—®ç±»</a><ul>
<li><a href="#">3.1 åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œ</a></li>
<li><a href="#">3.2 åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite æ³¨å†Œä¸­å¿ƒ</strong>ã€‚</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_09_30/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_09_30/01.png" alt=""></p>
<ul>
<li><strong>é»„è‰²</strong>çš„ç±»åœ¨ <code>elastic-job-common-core</code> é¡¹ç›®é‡Œï¼Œä¸º Elastic-Job-Liteã€Elastic-Job-Cloud <strong>å…¬ç”¨</strong>æ³¨å†Œä¸­å¿ƒç±»ã€‚</li>
<li>ä½œä¸šèŠ‚ç‚¹æ•°æ®è®¿é—®ç±»( JobNodeStorage )çš„<strong>åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œ</strong>ã€<strong>åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ</strong>ä¸¤ä¸ªæ–¹æ³•å’Œæ³¨å†Œä¸­å¿ƒ<strong>åè°ƒåˆ†å¸ƒå¼æœåŠ¡</strong>æœ‰å…³ç³»ï¼Œä»<a href="http://www.yunai.me/Elastic-Job/job-storage/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ•°æ®å­˜å‚¨ã€‹</a>æ‘˜å‡ºæ¥ï¼Œæ”¾æœ¬æ–‡è§£æã€‚</li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-åŸºäº-Zookeeper-æ³¨å†Œä¸­å¿ƒ"><a href="#2-åŸºäº-Zookeeper-æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="2. åŸºäº Zookeeper æ³¨å†Œä¸­å¿ƒ"></a>2. åŸºäº Zookeeper æ³¨å†Œä¸­å¿ƒ</h1><p>ZookeeperRegistryCenterï¼ŒåŸºäº Zookeeper æ³¨å†Œä¸­å¿ƒã€‚ä»ä¸Šé¢çš„ç±»å›¾å¯ä»¥çœ‹åˆ°ï¼ŒZookeeperRegistryCenter å®ç° CoordinatorRegistryCenter æ¥å£ï¼ŒCoordinatorRegistryCenter ç»§æ‰¿ RegistryCenter æ¥å£ã€‚</p>
<ul>
<li>RegistryCenterï¼Œæ³¨å†Œä¸­å¿ƒï¼Œå®šä¹‰äº†ç®€å•çš„å¢åˆ æ”¹æŸ¥æ³¨å†Œæ•°æ®å’ŒæŸ¥è¯¢æ—¶é—´çš„æ¥å£æ–¹æ³•ã€‚</li>
<li>CoordinatorRegistryCenterï¼Œç”¨äºåè°ƒåˆ†å¸ƒå¼æœåŠ¡çš„æ³¨å†Œä¸­å¿ƒï¼Œå®šä¹‰äº†æŒä¹…èŠ‚ç‚¹ã€ä¸´æ—¶èŠ‚ç‚¹ã€æŒä¹…é¡ºåºèŠ‚ç‚¹ã€ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ç­‰<strong>ç›®å½•æœåŠ¡</strong>æ¥å£æ–¹æ³•ï¼Œéšæ€§çš„è¦æ±‚æä¾›<strong>äº‹åŠ¡</strong>ã€<strong>åˆ†å¸ƒå¼é”</strong>ã€<strong>æ•°æ®è®¢é˜…</strong>ç­‰ç‰¹æ€§ã€‚</li>
</ul>
<p>ZookeeperRegistryCenter ä½¿ç”¨ <a href="https://curator.apache.org/" rel="external nofollow noopener noreferrer" target="_blank">Apache Curator</a> è¿›è¡Œ Zookeeper æ³¨å†Œä¸­å¿ƒã€‚</p>
<h2 id="2-1-åˆå§‹åŒ–"><a href="#2-1-åˆå§‹åŒ–" class="headerlink" title="2.1 åˆå§‹åŒ–"></a>2.1 åˆå§‹åŒ–</h2><p>ZookeeperConfigurationï¼ŒåŸºäº Zookeeper çš„æ³¨å†Œä¸­å¿ƒé…ç½®ï¼Œæ³¨é‡Šå®Œæ•´ï¼Œç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/7dc099541a16de49f024fc59e46377a726be7f6b/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/reg/zookeeper/ZookeeperConfiguration.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">   log.debug(<span class="string">"Elastic job: zookeeper registry center init, server lists is: &#123;&#125;."</span>, zkConfig.getServerLists());</div><div class="line">   CuratorFrameworkFactory.Builder builder = CuratorFrameworkFactory.builder()</div><div class="line">           .connectString(zkConfig.getServerLists())</div><div class="line">           .retryPolicy(<span class="keyword">new</span> ExponentialBackoffRetry(zkConfig.getBaseSleepTimeMilliseconds(), zkConfig.getMaxRetries(), zkConfig.getMaxSleepTimeMilliseconds()))</div><div class="line">           .namespace(zkConfig.getNamespace()); <span class="comment">// å‘½åç©ºé—´</span></div><div class="line">   <span class="keyword">if</span> (<span class="number">0</span> != zkConfig.getSessionTimeoutMilliseconds()) &#123;</div><div class="line">       builder.sessionTimeoutMs(zkConfig.getSessionTimeoutMilliseconds()); <span class="comment">// ä¼šè¯è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ 60 * 1000 æ¯«ç§’</span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (<span class="number">0</span> != zkConfig.getConnectionTimeoutMilliseconds()) &#123;</div><div class="line">       builder.connectionTimeoutMs(zkConfig.getConnectionTimeoutMilliseconds()); <span class="comment">// è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ 15 * 1000 æ¯«ç§’</span></div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è®¤è¯</span></div><div class="line">   <span class="keyword">if</span> (!Strings.isNullOrEmpty(zkConfig.getDigest())) &#123;</div><div class="line">       builder.authorization(<span class="string">"digest"</span>, zkConfig.getDigest().getBytes(Charsets.UTF_8))</div><div class="line">               .aclProvider(<span class="keyword">new</span> ACLProvider() &#123;</div><div class="line">               </div><div class="line">                   <span class="meta">@Override</span></div><div class="line">                   <span class="function"><span class="keyword">public</span> List&lt;ACL&gt; <span class="title">getDefaultAcl</span><span class="params">()</span> </span>&#123;</div><div class="line">                       <span class="keyword">return</span> ZooDefs.Ids.CREATOR_ALL_ACL;</div><div class="line">                   &#125;</div><div class="line">               </div><div class="line">                   <span class="meta">@Override</span></div><div class="line">                   <span class="function"><span class="keyword">public</span> List&lt;ACL&gt; <span class="title">getAclForPath</span><span class="params">(<span class="keyword">final</span> String path)</span> </span>&#123;</div><div class="line">                       <span class="keyword">return</span> ZooDefs.Ids.CREATOR_ALL_ACL;</div><div class="line">                   &#125;</div><div class="line">               &#125;);</div><div class="line">   &#125;</div><div class="line">   client = builder.build();</div><div class="line">   client.start();</div><div class="line">   <span class="comment">// è¿æ¥ Zookeeper</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">if</span> (!client.blockUntilConnected(zkConfig.getMaxSleepTimeMilliseconds() * zkConfig.getMaxRetries(), TimeUnit.MILLISECONDS)) &#123;</div><div class="line">           client.close();</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.OperationTimeoutException();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ExponentialBackoffRetryï¼Œå½“ Zookeeper å¤±å»é“¾æ¥åé‡æ–°è¿æ¥çš„<strong>ä¸€ç§</strong>ç­–ç•¥ï¼šåŠ¨æ€è®¡ç®—æ¯æ¬¡è®¡ç®—é‡è¿çš„é—´éš”ï¼Œæ—¶é—´é—´éš” = <code>baseSleepTimeMs * Math.max(1, random.nextInt(1 &lt;&lt; (retryCount + 1)))</code>ã€‚å¦‚æœå¯¹å…¶å®ƒé‡è¿ç­–ç•¥æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹ <a href="https://github.com/apache/curator/blob/abaabb5f65c2161f77527165a15d2420f6c88219/curator-client/src/main/java/org/apache/curator/RetryPolicy.java" rel="external nofollow noopener noreferrer" target="_blank">RetryPolicy</a> çš„å®ç°ç±»ï¼Œæœ¬æ–‡å°±ä¸å±•å¼€äº†ã€‚</li>
<li><strong>ç›¸åŒ</strong>çš„ä½œä¸šé›†ç¾¤ä½¿ç”¨<strong>ç›¸åŒ</strong>çš„ Zookeeper å‘½åç©ºé—´( <code>ZookeeperConfiguration.namespace</code> )ã€‚</li>
</ul>
<h2 id="2-2-ç¼“å­˜"><a href="#2-2-ç¼“å­˜" class="headerlink" title="2.2 ç¼“å­˜"></a>2.2 ç¼“å­˜</h2><p>é€šè¿‡ Curator TreeCache å®ç°ç›‘æ§æ•´ä¸ªæ ‘( Zookeeperç›®å½• )çš„æ•°æ®è®¢é˜…å’Œç¼“å­˜ï¼ŒåŒ…æ‹¬èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå­èŠ‚ç‚¹çš„çŠ¶æ€ã€‚</p>
<p><strong>åˆå§‹åŒ–ä½œä¸šç¼“å­˜</strong></p>
<p>ä½œä¸šåˆå§‹åŒ–æ³¨å†Œæ—¶ï¼Œåˆå§‹åŒ–ç¼“å­˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobRegistry.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerJob</span><span class="params">(<span class="keyword">final</span> String jobName, <span class="keyword">final</span> JobScheduleController jobScheduleController, <span class="keyword">final</span> CoordinatorRegistryCenter regCenter)</span> </span>&#123;</div><div class="line">   schedulerMap.put(jobName, jobScheduleController);</div><div class="line">   regCenterMap.put(jobName, regCenter);</div><div class="line">   <span class="comment">// æ·»åŠ æ³¨å†Œä¸­å¿ƒç¼“å­˜</span></div><div class="line">   regCenter.addCacheData(<span class="string">"/"</span> + jobName);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">// ZookeeperRegistryCenter.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ç¼“å­˜</div><div class="line">* keyï¼š/ä½œä¸šå/</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, TreeCache&gt; caches = <span class="keyword">new</span> HashMap&lt;&gt;();</div></pre></td></tr></table></figure>
<p><strong>ä½œä¸šæœåŠ¡è®¢é˜…æ•°æ®</strong></p>
<p>æ¯ä¸ªä¸åŒçš„æœåŠ¡ï¼Œéƒ½ä¼šè®¢é˜…æ•°æ®å®ç°åŠŸèƒ½é€»è¾‘ã€‚åœ¨åç»­ä¸åŒæœåŠ¡çš„æ–‡ç« ï¼Œæˆ‘ä»¬ä¼šè¯¦ç»†è§£æã€‚ğŸ™‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDataListener</span><span class="params">(<span class="keyword">final</span> TreeCacheListener listener)</span> </span>&#123;</div><div class="line">   TreeCache cache = (TreeCache) regCenter.getRawCache(<span class="string">"/"</span> + jobName);</div><div class="line">   cache.getListenable().addListener(listener);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>å…³é—­ä½œä¸šç¼“å­˜</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evictCacheData</span><span class="params">(<span class="keyword">final</span> String cachePath)</span> </span>&#123;</div><div class="line">   TreeCache cache = caches.remove(cachePath + <span class="string">"/"</span>);</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != cache) &#123;</div><div class="line">       cache.close();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯¹ Curator TreeCache æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥ç‚¹å‡»<a href="http://colobu.com/2014/12/15/zookeeper-recipes-by-example-5/" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç»§ç»­äº†è§£ã€‚</p>
<h2 id="2-3-å…³é—­"><a href="#2-3-å…³é—­" class="headerlink" title="2.3 å…³é—­"></a>2.3 å…³é—­</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Entry&lt;String, TreeCache&gt; each : caches.entrySet()) &#123;</div><div class="line">       each.getValue().close();</div><div class="line">   &#125;</div><div class="line">   waitForCacheClose();</div><div class="line">   CloseableUtils.closeQuietly(client);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">/* TODO ç­‰å¾…500ms, cacheå…ˆå…³é—­å†å…³é—­client, å¦åˆ™ä¼šæŠ›å¼‚å¸¸</span></div><div class="line">* å› ä¸ºå¼‚æ­¥å¤„ç†, å¯èƒ½ä¼šå¯¼è‡´clientå…ˆå…³é—­è€Œcacheè¿˜æœªå…³é—­ç»“æŸ.</div><div class="line">* ç­‰å¾…Curatoræ–°ç‰ˆæœ¬è§£å†³è¿™ä¸ªbug.</div><div class="line">* BUGåœ°å€ï¼šhttps://issues.apache.org/jira/browse/CURATOR-157</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">waitForCacheClose</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Thread.sleep(<span class="number">500L</span>);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException ex) &#123;</div><div class="line">       Thread.currentThread().interrupt();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-4-è·å¾—æ•°æ®"><a href="#2-4-è·å¾—æ•°æ®" class="headerlink" title="2.4 è·å¾—æ•°æ®"></a>2.4 è·å¾—æ•°æ®</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">   TreeCache cache = findTreeCache(key); <span class="comment">// è·å–ç¼“å­˜</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> == cache) &#123;</div><div class="line">       <span class="keyword">return</span> getDirectly(key);</div><div class="line">   &#125;</div><div class="line">   ChildData resultInCache = cache.getCurrentData(key); <span class="comment">// ç¼“å­˜ä¸­è·å– value</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != resultInCache) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span> == resultInCache.getData() ? <span class="keyword">null</span> : <span class="keyword">new</span> String(resultInCache.getData(), Charsets.UTF_8);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> getDirectly(key);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getDirectly</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> String(client.getData().forPath(key), Charsets.UTF_8);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#get(...)</code> å…ˆä» <strong>TreeCacheç¼“å­˜</strong> è·å–ï¼Œåä» Zookeeper è·å–ã€‚</li>
<li><code>#getDirectly(...)</code> <strong>ç›´æ¥</strong>ä» Zookeeper è·å–ã€‚</li>
<li><p><code>#findTreeCache(...)</code> ä»£ç å¦‚ä¸‹ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> TreeCache <span class="title">findTreeCache</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Entry&lt;String, TreeCache&gt; entry : caches.entrySet()) &#123;</div><div class="line">       <span class="keyword">if</span> (key.startsWith(entry.getKey())) &#123;</div><div class="line">           <span class="keyword">return</span> entry.getValue();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="2-5-è·å¾—æ³¨å†Œå­èŠ‚ç‚¹"><a href="#2-5-è·å¾—æ³¨å†Œå­èŠ‚ç‚¹" class="headerlink" title="2.5 è·å¾—æ³¨å†Œå­èŠ‚ç‚¹"></a>2.5 è·å¾—æ³¨å†Œå­èŠ‚ç‚¹</h2><p><strong>è·å–å­èŠ‚ç‚¹åç§°é›†åˆ(é™åº)</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getChildrenKeys</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       List&lt;String&gt; result = client.getChildren().forPath(key);</div><div class="line">       Collections.sort(result, <span class="keyword">new</span> Comparator&lt;String&gt;() &#123;</div><div class="line">           </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(<span class="keyword">final</span> String o1, <span class="keyword">final</span> String o2)</span> </span>&#123;</div><div class="line">               <span class="keyword">return</span> o2.compareTo(o1);</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>è·å–å­èŠ‚ç‚¹æ•°é‡</strong>    </p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNumChildren</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Stat stat = client.checkExists().forPath(key);</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> != stat) &#123;</div><div class="line">           <span class="keyword">return</span> stat.getNumChildren();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-6-å­˜å‚¨æ³¨å†Œæ•°æ®"><a href="#2-6-å­˜å‚¨æ³¨å†Œæ•°æ®" class="headerlink" title="2.6 å­˜å‚¨æ³¨å†Œæ•°æ®"></a>2.6 å­˜å‚¨æ³¨å†Œæ•°æ®</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">persist</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String value)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">if</span> (!isExisted(key)) &#123;</div><div class="line">           client.create().creatingParentsIfNeeded().withMode(CreateMode.PERSISTENT).forPath(key, value.getBytes(Charsets.UTF_8));</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           update(key, value);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">persistEphemeral</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String value)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">if</span> (isExisted(key)) &#123;</div><div class="line">           client.delete().deletingChildrenIfNeeded().forPath(key);</div><div class="line">       &#125;</div><div class="line">       client.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL).forPath(key, value.getBytes(Charsets.UTF_8));</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#persist(...)</code> å­˜å‚¨<strong>æŒä¹…</strong>èŠ‚ç‚¹æ•°æ®ã€‚é€»è¾‘ç­‰ä»·äº insertOrUpdate æ“ä½œã€‚</li>
<li><code>persistEphemeral(...)</code> å­˜å‚¨<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹æ•°æ®ã€‚èŠ‚ç‚¹ç±»å‹æ— æ³•å˜æ›´ï¼Œå› æ­¤å¦‚æœæ•°æ®å·²å­˜åœ¨ï¼Œéœ€è¦å…ˆè¿›è¡Œåˆ é™¤ã€‚</li>
<li><p><code>#isExisted(...)</code>ã€<code>#update(...)</code> ä»£ç å¦‚ä¸‹ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExisted</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span> != client.checkExists().forPath(key);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">   </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String value)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       client.inTransaction().check().forPath(key).and().setData().forPath(key, value.getBytes(Charsets.UTF_8)).and().commit();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#update(...)</code> ä½¿ç”¨<strong>äº‹åŠ¡</strong>æ ¡éªŒé”®( key )å­˜åœ¨æ‰è¿›è¡Œæ›´æ–°ã€‚</li>
</ul>
</li>
</ul>
<h2 id="2-7-å­˜å‚¨é¡ºåºæ³¨å†Œæ•°æ®"><a href="#2-7-å­˜å‚¨é¡ºåºæ³¨å†Œæ•°æ®" class="headerlink" title="2.7 å­˜å‚¨é¡ºåºæ³¨å†Œæ•°æ®"></a>2.7 å­˜å‚¨é¡ºåºæ³¨å†Œæ•°æ®</h2><p>å®ç°é€»è¾‘å’Œ<strong>å­˜å‚¨æ³¨å†Œæ•°æ®</strong>ç±»ä¼¼ã€‚Elastic-Job æœªä½¿ç”¨è¯¥æ–¹æ³•ï¼Œè·³è¿‡ã€‚</p>
<h2 id="2-8-ç§»é™¤æ³¨å†Œæ•°æ®"><a href="#2-8-ç§»é™¤æ³¨å†Œæ•°æ®" class="headerlink" title="2.8 ç§»é™¤æ³¨å†Œæ•°æ®"></a>2.8 ç§»é™¤æ³¨å†Œæ•°æ®</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       client.delete().deletingChildrenIfNeeded().forPath(key);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-9-è·å–æ³¨å†Œä¸­å¿ƒå½“å‰æ—¶é—´"><a href="#2-9-è·å–æ³¨å†Œä¸­å¿ƒå½“å‰æ—¶é—´" class="headerlink" title="2.9 è·å–æ³¨å†Œä¸­å¿ƒå½“å‰æ—¶é—´"></a>2.9 è·å–æ³¨å†Œä¸­å¿ƒå½“å‰æ—¶é—´</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getRegistryCenterTime</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">   <span class="keyword">long</span> result = <span class="number">0L</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       persist(key, <span class="string">""</span>);</div><div class="line">       result = client.checkExists().forPath(key).getMtime();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">   &#125;</div><div class="line">   Preconditions.checkState(<span class="number">0L</span> != result, <span class="string">"Cannot get registry center time."</span>);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>é€šè¿‡æ›´æ–°èŠ‚ç‚¹ï¼Œè·å¾—è¯¥èŠ‚ç‚¹çš„æœ€åæ›´æ–°æ—¶é—´( <code>mtime</code> )è·å¾— Zookeeper çš„æ—¶é—´ã€‚six six sixã€‚</li>
</ul>
<h2 id="2-10-æ³¨å†Œä¸­å¿ƒå¼‚å¸¸å¤„ç†å™¨"><a href="#2-10-æ³¨å†Œä¸­å¿ƒå¼‚å¸¸å¤„ç†å™¨" class="headerlink" title="2.10 æ³¨å†Œä¸­å¿ƒå¼‚å¸¸å¤„ç†å™¨"></a>2.10 æ³¨å†Œä¸­å¿ƒå¼‚å¸¸å¤„ç†å™¨</h2><p>RegExceptionHandlerï¼Œæ³¨å†Œä¸­å¿ƒå¼‚å¸¸å¤„ç†å™¨ã€‚åœ¨ä¸Šé¢çš„æ“ä½œ Zookeeper å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ <code>RegExceptionHandler.handleException(...)</code> å¤„ç†å¼‚å¸¸ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleException</span><span class="params">(<span class="keyword">final</span> Exception cause)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> == cause) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (isIgnoredException(cause) || <span class="keyword">null</span> != cause.getCause() &amp;&amp; isIgnoredException(cause.getCause())) &#123;</div><div class="line">       log.debug(<span class="string">"Elastic job: ignored exception for: &#123;&#125;"</span>, cause.getMessage());</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> InterruptedException) &#123;</div><div class="line">       Thread.currentThread().interrupt();</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RegException(cause);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isIgnoredException</span><span class="params">(<span class="keyword">final</span> Throwable cause)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> cause <span class="keyword">instanceof</span> ConnectionLossException || cause <span class="keyword">instanceof</span> NoNodeException || cause <span class="keyword">instanceof</span> NodeExistsException;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>éƒ¨åˆ†å¼‚å¸¸ä¼šè¢«æ— è§†ï¼Œä»…æ‰“å°å¼‚å¸¸ã€‚ä¾‹å¦‚è°ƒç”¨ <code>#getDirectly(...)</code> è·å¾—æ³¨å†Œæ•°æ®æ—¶ï¼Œå¯èƒ½èŠ‚ç‚¹ä¸å­˜åœ¨ï¼ŒæŠ›å‡º NodeExistsExceptionï¼Œè¿™ç§å¼‚å¸¸å¯ä»¥æ— è§†ã€‚</li>
</ul>
<h1 id="3-ä½œä¸šèŠ‚ç‚¹æ•°æ®è®¿é—®ç±»"><a href="#3-ä½œä¸šèŠ‚ç‚¹æ•°æ®è®¿é—®ç±»" class="headerlink" title="3. ä½œä¸šèŠ‚ç‚¹æ•°æ®è®¿é—®ç±»"></a>3. ä½œä¸šèŠ‚ç‚¹æ•°æ®è®¿é—®ç±»</h1><p>JobNodeStorageï¼Œä½œä¸šèŠ‚ç‚¹æ•°æ®è®¿é—®ç±»ã€‚</p>
<h2 id="3-1-åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œ"><a href="#3-1-åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œ" class="headerlink" title="3.1 åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œ"></a>3.1 åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œ</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobNodeStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œæ“ä½œ.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> latchNode åˆ†å¸ƒå¼é”ä½¿ç”¨çš„èŠ‚ç‚¹ï¼Œä¾‹å¦‚ï¼šleader/election/latch</div><div class="line">* <span class="doctag">@param</span> callback æ‰§è¡Œæ“ä½œçš„å›è°ƒ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeInLeader</span><span class="params">(<span class="keyword">final</span> String latchNode, <span class="keyword">final</span> LeaderExecutionCallback callback)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> (LeaderLatch latch = <span class="keyword">new</span> LeaderLatch(getClient(), jobNodePath.getFullPath(latchNode))) &#123;</div><div class="line">       latch.start();</div><div class="line">       latch.await();</div><div class="line">       callback.execute();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       handleException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><a href="https://curator.apache.org/" rel="external nofollow noopener noreferrer" target="_blank">Apache Curator</a> ä½¿ç”¨ Zookeeper å®ç°äº†ä¸¤ç§åˆ†å¸ƒå¼é”ï¼ŒLeaderLatch æ˜¯å…¶ä¸­çš„ä¸€ç§ã€‚ä½¿ç”¨<strong>ä¸€ä¸ª</strong> Zookeeper èŠ‚ç‚¹è·¯å¾„åˆ›å»º<strong>ä¸€ä¸ª</strong> LeaderLatchï¼Œ<code>#start()</code> åï¼Œè°ƒç”¨ <code>#await()</code> ç­‰å¾…æ‹¿åˆ°è¿™æŠŠ<strong>é”</strong>ã€‚å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹æ‰§è¡Œäº†<strong>ç›¸åŒèŠ‚ç‚¹è·¯å¾„</strong>çš„ LeaderLatch çš„ <code>#await()</code> åï¼ŒåŒä¸€æ—¶åˆ»æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œå…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾…ã€‚å½“è¯¥çº¿ç¨‹é‡Šæ”¾( <code>LeaderLatch#close()</code> )åï¼Œä¸‹ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‹¿åˆ°è¯¥<strong>é”</strong>ç»§ç»­æ‰§è¡Œã€‚ç”¨ Java å¹¶å‘åŒ… Lock ä¸¾ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeInLeader</span><span class="params">(Lock lock)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        lock.lock();</div><div class="line">        <span class="comment">// doSomething();</span></div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        lock.unlock();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><a href="https://github.com/Netflix/curator/wiki/Leader-Latch" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” LeaderLatchã€‹</a>ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹çœ‹ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/election/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‹</a>ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ° <code>#executeInLeader(...)</code> çš„ä½¿ç”¨ã€‚</p>
<p>å¦ä¸€ç§åˆ†å¸ƒå¼é”å®ç°ï¼Œ<a href="https://github.com/Netflix/curator/wiki/Leader-Election" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” LeaderElectionã€‹</a>ï¼Œæœ‰å…´è¶£ä¹Ÿå¯ä»¥çœ‹çœ‹ã€‚åœ¨ Elastic-Job-Cloud ä¸­ä½¿ç”¨åˆ°äº†ï¼Œåç»­è¿›è¡Œè§£æã€‚</p>
<h2 id="3-2-åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ"><a href="#3-2-åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ" class="headerlink" title="3.2 åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ"></a>3.2 åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobNodeStorage.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeInTransaction</span><span class="params">(<span class="keyword">final</span> TransactionExecutionCallback callback)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       CuratorTransactionFinal curatorTransactionFinal = getClient().inTransaction().check().forPath(<span class="string">"/"</span>).and();</div><div class="line">       callback.execute(curatorTransactionFinal);</div><div class="line">       curatorTransactionFinal.commit();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å¼€å¯äº‹åŠ¡ï¼Œæ‰§è¡Œ TransactionExecutionCallback å›è°ƒé€»è¾‘ï¼Œæäº¤äº‹åŠ¡ã€‚</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šç…ç¬”èŠ‹é“å›ï¼Œåˆåœ¨æ°´æ›´<br>èŠ‹é“å›ï¼šäººè‰°ä¸æ‹†ï¼Œå¥½ä¸å¥½ã€‚</p>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. åŸº
    
    </summary>
    
      <category term="Elastic-Job" scheme="http://www.yunai.me/categories/Elastic-Job/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œ</title>
    <link href="http://www.yunai.me/Elastic-Job/job-execute/"/>
    <id>http://www.yunai.me/Elastic-Job/job-execute/</id>
    <published>2017-09-22T16:00:00.000Z</published>
    <updated>2017-08-28T11:05:39.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#1-%E6%A6%82%E8%BF%B0">1. æ¦‚è¿°</a></li>
<li><a href="#2-lite%E8%B0%83%E5%BA%A6%E4%BD%9C%E4%B8%9A">2. Liteè°ƒåº¦ä½œä¸š</a></li>
<li><a href="#3-%E6%89%A7%E8%A1%8C%E5%99%A8%E5%88%9B%E5%BB%BA">3. æ‰§è¡Œå™¨åˆ›å»º</a><ul>
<li><a href="#31-%E5%8A%A0%E8%BD%BD%E4%BD%9C%E4%B8%9A%E9%85%8D%E7%BD%AE">3.1 åŠ è½½ä½œä¸šé…ç½®</a></li>
<li><a href="#32-%E8%8E%B7%E5%8F%96%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0">3.2 è·å–ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± </a></li>
<li><a href="#33-%E8%8E%B7%E5%8F%96%E4%BD%9C%E4%B8%9A%E5%BC%82%E5%B8%B8%E6%89%A7%E8%A1%8C%E5%99%A8">3.3 è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨</a></li>
</ul>
</li>
<li><a href="#4-%E6%89%A7%E8%A1%8C%E5%99%A8%E6%89%A7%E8%A1%8C">4. æ‰§è¡Œå™¨æ‰§è¡Œ</a><ul>
<li><a href="#41-%E6%A3%80%E6%9F%A5%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E7%8E%AF%E5%A2%83">4.1 æ£€æŸ¥ä½œä¸šæ‰§è¡Œç¯å¢ƒ</a></li>
<li><a href="#42-%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E4%BD%9C%E4%B8%9A%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%88%86%E7%89%87%E4%B8%8A%E4%B8%8B%E6%96%87">4.2 è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡</a></li>
<li><a href="#43-%E5%8F%91%E5%B8%83%E4%BD%9C%E4%B8%9A%E7%8A%B6%E6%80%81%E8%BF%BD%E8%B8%AA%E4%BA%8B%E4%BB%B6">4.3 å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶</a></li>
<li><a href="#44-%E8%B7%B3%E8%BF%87%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E4%B8%AD%E7%9A%84%E8%A2%AB%E9%94%99%E8%BF%87%E6%89%A7%E8%A1%8C%E7%9A%84%E4%BD%9C%E4%B8%9A">4.4 è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š</a></li>
<li><a href="#45-%E6%89%A7%E8%A1%8C%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E5%89%8D%E7%9A%84%E6%96%B9%E6%B3%95">4.5 æ‰§è¡Œä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•</a></li>
<li><a href="#46-%E6%89%A7%E8%A1%8C%E6%99%AE%E9%80%9A%E8%A7%A6%E5%8F%91%E7%9A%84%E4%BD%9C%E4%B8%9A">4.6 æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸š</a><ul>
<li><a href="#461-%E7%AE%80%E5%8D%95%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E5%99%A8">4.6.1 ç®€å•ä½œä¸šæ‰§è¡Œå™¨</a></li>
<li><a href="#462-%E6%95%B0%E6%8D%AE%E6%B5%81%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E5%99%A8">4.6.2 æ•°æ®æµä½œä¸šæ‰§è¡Œå™¨</a></li>
<li><a href="#463-%E8%84%9A%E6%9C%AC%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E5%99%A8">4.6.3 è„šæœ¬ä½œä¸šæ‰§è¡Œå™¨</a></li>
</ul>
</li>
<li><a href="#47-%E6%89%A7%E8%A1%8C%E8%A2%AB%E9%94%99%E8%BF%87%E8%A7%A6%E5%8F%91%E7%9A%84%E4%BD%9C%E4%B8%9A">4.7 æ‰§è¡Œè¢«é”™è¿‡è§¦å‘çš„ä½œä¸š</a></li>
<li><a href="#48-%E6%89%A7%E8%A1%8C%E4%BD%9C%E4%B8%9A%E5%A4%B1%E6%95%88%E8%BD%AC%E7%A7%BB">4.8 æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»</a></li>
<li><a href="#49-%E6%89%A7%E8%A1%8C%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C%E5%90%8E%E7%9A%84%E6%96%B9%E6%B3%95">4.9 æ‰§è¡Œä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•</a></li>
</ul>
</li>
<li><a href="#666-%E5%BD%A9%E8%9B%8B">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šæ‰§è¡Œ</strong>ã€‚</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_09_23/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_09_23/01.png" alt=""></p>
<ul>
<li><strong>é»„è‰²</strong>çš„ç±»åœ¨ <code>elastic-job-common-core</code> é¡¹ç›®é‡Œï¼Œä¸º Elastic-Job-Liteã€Elastic-Job-Cloud <strong>å…¬ç”¨</strong>ä½œä¸šæ‰§è¡Œç±»ã€‚</li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-Liteè°ƒåº¦ä½œä¸š"><a href="#2-Liteè°ƒåº¦ä½œä¸š" class="headerlink" title="2. Liteè°ƒåº¦ä½œä¸š"></a>2. Liteè°ƒåº¦ä½œä¸š</h1><p>Liteè°ƒåº¦ä½œä¸š( LiteJob )ï¼Œä½œä¸šè¢«è°ƒåº¦åï¼Œè°ƒç”¨ <code>#execute()</code> æ‰§è¡Œä½œä¸šã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆæ˜¯ LiteJob ä½œä¸ºå…¥å£å‘¢ï¼Ÿ</strong></p>
<p>åœ¨<a href="http://www.yunai.me/Elastic-Job/job-init/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆå§‹åŒ–ã€‹çš„ã€Œ3.2.3ã€åˆ›å»ºä½œä¸šè°ƒåº¦æ§åˆ¶å™¨</a>é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Quartz çš„ JobDetail åˆ›å»ºä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">JobDetail result = JobBuilder.newJob(LiteJob.class).withIdentity(liteJobConfig.getJobName()).build();</div></pre></td></tr></table></figure>
<p><code>#newJob()</code> é‡Œçš„å‚æ•°æ˜¯ LiteJobï¼Œå› æ­¤ï¼Œæ¯æ¬¡ Quartz åˆ°è¾¾è°ƒåº¦æ—¶é—´æ—¶ï¼Œä¼šåˆ›å»ºè¯¥å¯¹è±¡è¿›è¡Œä½œä¸šæ‰§è¡Œã€‚</p>
<hr>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LiteJob</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> ElasticJob elasticJob;</div><div class="line">    </div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> JobFacade jobFacade;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</div><div class="line">        JobExecutorFactory.getJobExecutor(elasticJob, jobFacade).execute();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>LiteJob é€šè¿‡ JobExecutorFactory è·å¾—åˆ°ä½œä¸šæ‰§è¡Œå™¨( AbstractElasticJobExecutor )ï¼Œå¹¶è¿›è¡Œæ‰§è¡Œï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobExecutorFactory</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–ä½œä¸šæ‰§è¡Œå™¨.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> elasticJob åˆ†å¸ƒå¼å¼¹æ€§ä½œä¸š</div><div class="line">     * <span class="doctag">@param</span> jobFacade ä½œä¸šå†…éƒ¨æœåŠ¡é—¨é¢æœåŠ¡</div><div class="line">     * <span class="doctag">@return</span> ä½œä¸šæ‰§è¡Œå™¨</div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AbstractElasticJobExecutor <span class="title">getJobExecutor</span><span class="params">(<span class="keyword">final</span> ElasticJob elasticJob, <span class="keyword">final</span> JobFacade jobFacade)</span> </span>&#123;</div><div class="line">        <span class="comment">// ScriptJob</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == elasticJob) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ScriptJobExecutor(jobFacade);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// SimpleJob</span></div><div class="line">        <span class="keyword">if</span> (elasticJob <span class="keyword">instanceof</span> SimpleJob) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SimpleJobExecutor((SimpleJob) elasticJob, jobFacade);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// DataflowJob</span></div><div class="line">        <span class="keyword">if</span> (elasticJob <span class="keyword">instanceof</span> DataflowJob) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DataflowJobExecutor((DataflowJob) elasticJob, jobFacade);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Cannot support job type '%s'"</span>, elasticJob.getClass().getCanonicalName());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>JobExecutorFactoryï¼Œä½œä¸šæ‰§è¡Œå™¨å·¥å‚ï¼Œæ ¹æ®ä¸åŒçš„ä½œä¸šç±»å‹ï¼Œè¿”å›å¯¹åº”çš„<strong>ä½œä¸šæ‰§è¡Œå™¨</strong>ã€‚</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">ä½œä¸š</th>
<th style="text-align:left">ä½œä¸šæ¥å£</th>
<th style="text-align:left">æ‰§è¡Œå™¨</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ç®€å•ä½œä¸š</td>
<td style="text-align:left">SimpleJob</td>
<td style="text-align:left">SimpleJobExecutor</td>
</tr>
<tr>
<td style="text-align:left">æ•°æ®æµä½œä¸š</td>
<td style="text-align:left">DataflowJob</td>
<td style="text-align:left">DataflowJobExecutor</td>
</tr>
<tr>
<td style="text-align:left">è„šæœ¬ä½œä¸š</td>
<td style="text-align:left">ScriptJob</td>
<td style="text-align:left">ScriptJobExecutor</td>
</tr>
</tbody>
</table>
<h1 id="3-æ‰§è¡Œå™¨åˆ›å»º"><a href="#3-æ‰§è¡Œå™¨åˆ›å»º" class="headerlink" title="3. æ‰§è¡Œå™¨åˆ›å»º"></a>3. æ‰§è¡Œå™¨åˆ›å»º</h1><p>AbstractElasticJobExecutorï¼Œä½œä¸šæ‰§è¡Œå™¨æŠ½è±¡ç±»ã€‚ä¸åŒä½œä¸šæ‰§è¡Œå™¨éƒ½ç»§æ‰¿è¯¥ç±»ï¼Œåˆ›å»ºçš„è¿‡ç¨‹æ˜¯ä¸€è‡´çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šé—¨é¢å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span>(AccessLevel.PROTECTED)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobFacade jobFacade;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šé…ç½®</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span>(AccessLevel.PROTECTED)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobRootConfiguration jobRootConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåç§°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± </div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutorService executorService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šå¼‚å¸¸å¤„ç†å™¨</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobExceptionHandler jobExceptionHandler;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ†ç‰‡é”™è¯¯ä¿¡æ¯é›†åˆ</div><div class="line">     * keyï¼šåˆ†ç‰‡åºå·</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, String&gt; itemErrorMessages;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">AbstractElasticJobExecutor</span><span class="params">(<span class="keyword">final</span> JobFacade jobFacade)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.jobFacade = jobFacade;</div><div class="line">        <span class="comment">// åŠ è½½ ä½œä¸šé…ç½®</span></div><div class="line">        jobRootConfig = jobFacade.loadJobRootConfiguration(<span class="keyword">true</span>);</div><div class="line">        jobName = jobRootConfig.getTypeConfig().getCoreConfig().getJobName();</div><div class="line">        <span class="comment">// è·å– ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± </span></div><div class="line">        executorService = ExecutorServiceHandlerRegistry.getExecutorServiceHandler(jobName, (ExecutorServiceHandler) getHandler(JobProperties.JobPropertiesEnum.EXECUTOR_SERVICE_HANDLER));</div><div class="line">        <span class="comment">// è·å– ä½œä¸šå¼‚å¸¸å¤„ç†å™¨</span></div><div class="line">        jobExceptionHandler = (JobExceptionHandler) getHandler(JobProperties.JobPropertiesEnum.JOB_EXCEPTION_HANDLER);</div><div class="line">        <span class="comment">// è®¾ç½® åˆ†ç‰‡é”™è¯¯ä¿¡æ¯é›†åˆ</span></div><div class="line">        itemErrorMessages = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(jobRootConfig.getTypeConfig().getCoreConfig().getShardingTotalCount(), <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SimpleJobExecutor.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleJobExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç®€å•ä½œä¸šå®ç°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SimpleJob simpleJob;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleJobExecutor</span><span class="params">(<span class="keyword">final</span> SimpleJob simpleJob, <span class="keyword">final</span> JobFacade jobFacade)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(jobFacade);</div><div class="line">        <span class="keyword">this</span>.simpleJob = simpleJob;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DataflowJobExecutor.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DataflowJobExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•°æ®æµä½œä¸šå¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataflowJob&lt;Object&gt; dataflowJob;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataflowJobExecutor</span><span class="params">(<span class="keyword">final</span> DataflowJob&lt;Object&gt; dataflowJob, <span class="keyword">final</span> JobFacade jobFacade)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(jobFacade);</div><div class="line">        <span class="keyword">this</span>.dataflowJob = dataflowJob;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ScriptJobExecutor.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ScriptJobExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ScriptJobExecutor</span><span class="params">(<span class="keyword">final</span> JobFacade jobFacade)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(jobFacade);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-1-åŠ è½½ä½œä¸šé…ç½®"><a href="#3-1-åŠ è½½ä½œä¸šé…ç½®" class="headerlink" title="3.1 åŠ è½½ä½œä¸šé…ç½®"></a>3.1 åŠ è½½ä½œä¸šé…ç½®</h2><p>ä»<strong>ç¼“å­˜</strong>ä¸­è¯»å–ä½œä¸šé…ç½®ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-config/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹çš„ã€Œ3.1ã€è¯»å–ä½œä¸šé…ç½®</a> å·²ç»è§£æã€‚</p>
<h2 id="3-2-è·å–ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± "><a href="#3-2-è·å–ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± " class="headerlink" title="3.2 è·å–ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± "></a>3.2 è·å–ä½œä¸šæ‰§è¡Œçº¿ç¨‹æ± </h2><p>ä½œä¸šæ¯æ¬¡æ‰§è¡Œæ—¶ï¼Œå¯èƒ½åˆ†é…åˆ°<strong>å¤šä¸ªåˆ†ç‰‡é¡¹</strong>ï¼Œéœ€è¦ä½¿ç”¨çº¿ç¨‹æ± å®ç°<strong>å¹¶è¡Œ</strong>æ‰§è¡Œã€‚è€ƒè™‘åˆ°ä¸åŒä½œä¸šä¹‹é—´çš„éš”ç¦»æ€§ï¼Œé€šè¿‡<strong>ä¸€ä¸ªä½œä¸šä¸€ä¸ªçº¿ç¨‹æ± </strong>å®ç°ã€‚çº¿ç¨‹æ± æœåŠ¡å¤„ç†å™¨æ³¨å†Œè¡¨( ExecutorServiceHandlerRegistry ) è·å–ä½œä¸šçº¿ç¨‹æ± ( <code>#getExecutorServiceHandler(....)</code> )ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorServiceHandlerRegistry</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * çº¿ç¨‹æ± é›†åˆ</div><div class="line">     * keyï¼šä½œä¸šåå­—</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, ExecutorService&gt; REGISTRY = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–çº¿ç¨‹æ± æœåŠ¡.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> jobName ä½œä¸šåç§°</div><div class="line">     * <span class="doctag">@param</span> executorServiceHandler çº¿ç¨‹æ± æœåŠ¡å¤„ç†å™¨</div><div class="line">     * <span class="doctag">@return</span> çº¿ç¨‹æ± æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> ExecutorService <span class="title">getExecutorServiceHandler</span><span class="params">(<span class="keyword">final</span> String jobName, <span class="keyword">final</span> ExecutorServiceHandler executorServiceHandler)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!REGISTRY.containsKey(jobName)) &#123;</div><div class="line">            REGISTRY.put(jobName, executorServiceHandler.createExecutorService(jobName));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> REGISTRY.get(jobName);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ExecutorServiceHandlerRegistry ä½¿ç”¨ ExecutorServiceHandler åˆ›å»ºçº¿ç¨‹æ± ã€‚ExecutorServiceHandler æœ¬èº«æ˜¯ä¸ª<strong>æ¥å£</strong>ï¼Œé»˜è®¤ä½¿ç”¨ DefaultExecutorServiceHandler å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ExecutorServiceHandler.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExecutorServiceHandler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ›å»ºçº¿ç¨‹æ± æœåŠ¡å¯¹è±¡.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> jobName ä½œä¸šå</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span> çº¿ç¨‹æ± æœåŠ¡å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="function">ExecutorService <span class="title">createExecutorService</span><span class="params">(<span class="keyword">final</span> String jobName)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DefaultExecutorServiceHandler.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultExecutorServiceHandler</span> <span class="keyword">implements</span> <span class="title">ExecutorServiceHandler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ExecutorService <span class="title">createExecutorService</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ExecutorServiceObject(<span class="string">"inner-job-"</span> + jobName, Runtime.getRuntime().availableProcessors() * <span class="number">2</span>).createExecutorService();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è°ƒç”¨ ExecutorServiceObject çš„ <code>#createExecutorService(....)</code> æ–¹æ³•åˆ›å»ºçº¿ç¨‹æ± ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorServiceObject</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor threadPoolExecutor;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExecutorServiceObject</span><span class="params">(<span class="keyword">final</span> String namingPattern, <span class="keyword">final</span> <span class="keyword">int</span> threadSize)</span> </span>&#123;</div><div class="line">        workQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line">        threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(threadSize, threadSize, <span class="number">5L</span>, TimeUnit.MINUTES, workQueue, </div><div class="line">                <span class="keyword">new</span> BasicThreadFactory.Builder().namingPattern(Joiner.on(<span class="string">"-"</span>).join(namingPattern, <span class="string">"%s"</span>)).build());</div><div class="line">        threadPoolExecutor.allowCoreThreadTimeOut(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ›å»ºçº¿ç¨‹æ± æœåŠ¡å¯¹è±¡.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> çº¿ç¨‹æ± æœåŠ¡å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> ExecutorService <span class="title">createExecutorService</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> MoreExecutors.listeningDecorator(MoreExecutors.getExitingExecutorService(threadPoolExecutor));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>MoreExecutors#listeningDecorator(...)</code> åœ¨<a href="http://www.yunai.me/Sharding-JDBC/sql-execute/?self">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œã€‹</a> å·²ç»è§£æã€‚</li>
<li><p><code>MoreExecutors#getExitingExecutorService(...)</code> æ–¹æ³•é€»è¾‘ï¼šå°† ThreadPoolExecutor è½¬æ¢æˆ ExecutorServiceï¼Œå¹¶å¢åŠ  JVM å…³é—­é’©å­ï¼Œå®ç° <strong>120s</strong> ç­‰å¾…ä»»åŠ¡å®Œæˆï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">service.shutdown();</div><div class="line">service.awaitTermination(terminationTimeout, timeUnit);</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p><strong>å¦‚ä½•å®ç°è‡ªå®šä¹‰ ExecutorServiceHandler ?</strong></p>
<p>å…ˆçœ‹ä¸‹ AbstractElasticJobExecutor æ˜¯å¦‚ä½•è·å¾—<strong>æ¯ä¸ªä½œä¸š</strong>çš„ ExecutorServiceHandler ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—ã€è‡ªå®šä¹‰ã€‘å¤„ç†å™¨</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> jobPropertiesEnum ä½œä¸šå±æ€§æšä¸¾</div><div class="line">* <span class="doctag">@return</span> å¤„ç†å™¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getHandler</span><span class="params">(<span class="keyword">final</span> JobProperties.JobPropertiesEnum jobPropertiesEnum)</span> </span>&#123;</div><div class="line">   String handlerClassName = jobRootConfig.getTypeConfig().getCoreConfig().getJobProperties().get(jobPropertiesEnum);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Class&lt;?&gt; handlerClass = Class.forName(handlerClassName);</div><div class="line">       <span class="keyword">if</span> (jobPropertiesEnum.getClassType().isAssignableFrom(handlerClass)) &#123; <span class="comment">// å¿…é¡»æ˜¯æ¥å£å®ç°ï¼Œæ‰ä½¿ç”¨ã€è‡ªå®šä¹‰ã€‘</span></div><div class="line">           <span class="keyword">return</span> handlerClass.newInstance();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> getDefaultHandler(jobPropertiesEnum, handlerClassName);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ReflectiveOperationException ex) &#123;</div><div class="line">       <span class="keyword">return</span> getDefaultHandler(jobPropertiesEnum, handlerClassName);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—ã€é»˜è®¤ã€‘å¤„ç†å™¨</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> jobPropertiesEnum ä½œä¸šå±æ€§æšä¸¾</div><div class="line">* <span class="doctag">@param</span> handlerClassName å¤„ç†å™¨ç±»å</div><div class="line">* <span class="doctag">@return</span> å¤„ç†å™¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getDefaultHandler</span><span class="params">(<span class="keyword">final</span> JobProperties.JobPropertiesEnum jobPropertiesEnum, <span class="keyword">final</span> String handlerClassName)</span> </span>&#123;</div><div class="line">   log.warn(<span class="string">"Cannot instantiation class '&#123;&#125;', use default '&#123;&#125;' class."</span>, handlerClassName, jobPropertiesEnum.getKey());</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">return</span> Class.forName(jobPropertiesEnum.getDefaultValue()).newInstance();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ClassNotFoundException | InstantiationException | IllegalAccessException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(e);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ¯ä¸ªå¤„ç†å™¨éƒ½ä¼šå¯¹åº”ä¸€ä¸ª JobPropertiesEnumï¼Œä½¿ç”¨æšä¸¾è·å¾—å¤„ç†å™¨ã€‚ä¼˜å…ˆä» <code>JobProperties.map</code> è·å–<strong>è‡ªå®šä¹‰</strong>çš„å¤„ç†å™¨å®ç°ç±»ï¼Œå¦‚æœä¸ç¬¦åˆæ¡ä»¶( æœªå®ç°æ­£ç¡®æ¥å£ æˆ–è€… åˆ›å»ºå¤„ç†å™¨å¤±è´¥ )ï¼Œä½¿ç”¨<strong>é»˜è®¤</strong>çš„å¤„ç†å™¨å®ç°ã€‚</li>
<li>æ¯ä¸ªä½œä¸šå¯ä»¥é…ç½®<strong>ä¸åŒ</strong>çš„å¤„ç†å™¨ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-config/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹çš„ã€Œ2.2.2ã€ä½œä¸šæ ¸å¿ƒé…ç½®</a> å·²ç»è§£æã€‚</li>
</ul>
<h2 id="3-3-è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨"><a href="#3-3-è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨" class="headerlink" title="3.3 è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨"></a>3.3 è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨</h2><p>è·å–ä½œä¸šå¼‚å¸¸æ‰§è¡Œå™¨( JobExceptionHandler )å’Œ ExecutorServiceHandler( ExecutorServiceHandler )<strong>ç›¸åŒ</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ExecutorServiceHandler.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JobExceptionHandler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¤„ç†ä½œä¸šå¼‚å¸¸.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> jobName ä½œä¸šåç§°</div><div class="line">     * <span class="doctag">@param</span> cause å¼‚å¸¸åŸå› </div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handleException</span><span class="params">(String jobName, Throwable cause)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DefaultJobExceptionHandler.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultJobExceptionHandler</span> <span class="keyword">implements</span> <span class="title">JobExceptionHandler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleException</span><span class="params">(<span class="keyword">final</span> String jobName, <span class="keyword">final</span> Throwable cause)</span> </span>&#123;</div><div class="line">        log.error(String.format(<span class="string">"Job '%s' exception occur in job processing"</span>, jobName), cause);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>é»˜è®¤å®ç° DefaultJobExceptionHandler <strong>æ‰“å°å¼‚å¸¸æ—¥å¿—ï¼Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸</strong>ã€‚</li>
</ul>
<h1 id="4-æ‰§è¡Œå™¨æ‰§è¡Œ"><a href="#4-æ‰§è¡Œå™¨æ‰§è¡Œ" class="headerlink" title="4. æ‰§è¡Œå™¨æ‰§è¡Œ"></a>4. æ‰§è¡Œå™¨æ‰§è¡Œ</h1><p>æ‰§è¡Œé€»è¾‘ä¸»æµç¨‹å¦‚ä¸‹å›¾( <a href="http://www.yunai.me/images/Elastic-Job/2017_09_23/02.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_09_23/02.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// æ£€æŸ¥ ä½œä¸šæ‰§è¡Œç¯å¢ƒ</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       jobFacade.checkJobExecutionEnvironment();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> JobExecutionEnvironmentException cause) &#123;</div><div class="line">       jobExceptionHandler.handleException(jobName, cause);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è·å– å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡</span></div><div class="line">   ShardingContexts shardingContexts = jobFacade.getShardingContexts();</div><div class="line">   <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_STAGING)</span></div><div class="line">   <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">       jobFacade.postJobStatusTraceEvent(shardingContexts.getTaskId(), State.TASK_STAGING, String.format(<span class="string">"Job '%s' execute begin."</span>, jobName));</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è·³è¿‡ å­˜åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡ä½œä¸š</span></div><div class="line">   <span class="keyword">if</span> (jobFacade.misfireIfRunning(shardingContexts.getShardingItemParameters().keySet())) &#123;</div><div class="line">       <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_FINISHED)</span></div><div class="line">       <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">           jobFacade.postJobStatusTraceEvent(shardingContexts.getTaskId(), State.TASK_FINISHED, String.format(</div><div class="line">                   <span class="string">"Previous job '%s' - shardingItems '%s' is still running, misfired job will start after previous job completed."</span>, jobName, </div><div class="line">                   shardingContexts.getShardingItemParameters().keySet()));</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ‰§è¡Œ ä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       jobFacade.beforeJobExecuted(shardingContexts);</div><div class="line">       <span class="comment">//CHECKSTYLE:OFF</span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable cause) &#123;</div><div class="line">       <span class="comment">//CHECKSTYLE:ON</span></div><div class="line">       jobExceptionHandler.handleException(jobName, cause);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ‰§è¡Œ æ™®é€šè§¦å‘çš„ä½œä¸š</span></div><div class="line">   execute(shardingContexts, JobExecutionEvent.ExecutionSource.NORMAL_TRIGGER);</div><div class="line">   <span class="comment">// æ‰§è¡Œ è¢«è·³è¿‡è§¦å‘çš„ä½œä¸š</span></div><div class="line">   <span class="keyword">while</span> (jobFacade.isExecuteMisfired(shardingContexts.getShardingItemParameters().keySet())) &#123;</div><div class="line">       jobFacade.clearMisfire(shardingContexts.getShardingItemParameters().keySet());</div><div class="line">       execute(shardingContexts, JobExecutionEvent.ExecutionSource.MISFIRE);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ‰§è¡Œ ä½œä¸šå¤±æ•ˆè½¬ç§»</span></div><div class="line">   jobFacade.failoverIfNecessary();</div><div class="line">   <span class="comment">// æ‰§è¡Œ ä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       jobFacade.afterJobExecuted(shardingContexts);</div><div class="line">       <span class="comment">//CHECKSTYLE:OFF</span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable cause) &#123;</div><div class="line">       <span class="comment">//CHECKSTYLE:ON</span></div><div class="line">       jobExceptionHandler.handleException(jobName, cause);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»£ç æ­¥éª¤æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥å¾€ä¸‹çœ‹ã€‚</p>
<h2 id="4-1-æ£€æŸ¥ä½œä¸šæ‰§è¡Œç¯å¢ƒ"><a href="#4-1-æ£€æŸ¥ä½œä¸šæ‰§è¡Œç¯å¢ƒ" class="headerlink" title="4.1 æ£€æŸ¥ä½œä¸šæ‰§è¡Œç¯å¢ƒ"></a>4.1 æ£€æŸ¥ä½œä¸šæ‰§è¡Œç¯å¢ƒ</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkJobExecutionEnvironment</span><span class="params">()</span> <span class="keyword">throws</span> JobExecutionEnvironmentException </span>&#123;</div><div class="line">   configService.checkMaxTimeDiffSecondsTolerable();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>ConfigService#checkMaxTimeDiffSecondsTolerable()</code> æ–¹æ³•æ ¡éªŒæœ¬æœºæ—¶é—´æ˜¯å¦åˆæ³•ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-config/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹çš„ã€Œ3.3ã€æ ¡éªŒæœ¬æœºæ—¶é—´æ˜¯å¦åˆæ³•</a> å·²ç»è§£æã€‚</li>
<li>å½“æ ¡éªŒæœ¬æœºæ—¶é—´ä¸åˆæ³•æ—¶ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚è‹¥ä½¿ç”¨ DefaultJobExceptionHandler ä½œä¸ºå¼‚å¸¸å¤„ç†ï¼Œ<strong>åªæ‰“å°æ—¥å¿—ï¼Œä¸ä¼šç»ˆæ­¢ä½œä¸šæ‰§è¡Œ</strong>ã€‚å¦‚æœä½ çš„ä½œä¸šå¯¹æ—¶é—´ç²¾å‡†åº¦æœ‰æ¯”è¾ƒé«˜çš„è¦æ±‚ï¼ŒæœŸæœ›ä½œä¸š<strong>ç»ˆæ­¢</strong>æ‰§è¡Œï¼Œå¯ä»¥è‡ªå®šä¹‰ JobExceptionHandler å®ç°å¯¹å¼‚å¸¸çš„å¤„ç†ã€‚</li>
</ul>
<h2 id="4-2-è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡"><a href="#4-2-è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡" class="headerlink" title="4.2 è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡"></a>4.2 è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡</h2><p>è°ƒç”¨ <code>LiteJobFacade#getShardingContexts()</code> æ–¹æ³•è·å–å½“å‰ä½œä¸šæœåŠ¡å™¨çš„åˆ†ç‰‡ä¸Šä¸‹æ–‡ã€‚é€šè¿‡è¿™ä¸ªæ–¹æ³•ï¼Œä½œä¸šè·å¾—<strong>å…¶æ‰€åˆ†é…æ‰§è¡Œçš„åˆ†ç‰‡é¡¹</strong>ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
<h2 id="4-3-å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶"><a href="#4-3-å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶" class="headerlink" title="4.3 å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶"></a>4.3 å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶</h2><p>è°ƒç”¨ <code>LiteJobFacade#postJobStatusTraceEvent()</code> æ–¹æ³•å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-event-trace/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šäº‹ä»¶è¿½è¸ªã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
<h2 id="4-4-è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š"><a href="#4-4-è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š" class="headerlink" title="4.4 è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š"></a>4.4 è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š</h2><p>è¯¥é€»è¾‘å’Œ<strong>ã€Œ4.7ã€æ‰§è¡Œè¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š</strong>ï¼Œä¸€èµ·è§£æï¼Œå¯ä»¥æ•´ä½“æ€§çš„ç†è§£ Elastic-Job-Lite å¯¹è¢«é”™è¿‡æ‰§è¡Œ( misfired )çš„ä½œä¸šå¤„ç†ã€‚</p>
<h2 id="4-5-æ‰§è¡Œä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•"><a href="#4-5-æ‰§è¡Œä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•" class="headerlink" title="4.5 æ‰§è¡Œä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•"></a>4.5 æ‰§è¡Œä½œä¸šæ‰§è¡Œå‰çš„æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (ElasticJobListener each : elasticJobListeners) &#123;</div><div class="line">       each.beforeJobExecuted(shardingContexts);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ä½œä¸šç›‘å¬å™¨æ‰§è¡Œä½œä¸š<strong>æ‰§è¡Œå‰</strong>çš„æ–¹æ³•ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-listener/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šç›‘å¬å™¨ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
<h2 id="4-6-æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸š"><a href="#4-6-æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸š" class="headerlink" title="4.6 æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸š"></a>4.6 æ‰§è¡Œæ™®é€šè§¦å‘çš„ä½œä¸š</h2><p>è¿™ä¸ªå°èŠ‚çš„æ ‡é¢˜ä¸å¤ªå‡†ç¡®ï¼Œå…¶ä»–<strong>ä½œä¸šæ¥æº</strong>( ExecutionSource )ä¹Ÿæ˜¯æ‰§è¡Œè¿™æ ·çš„é€»è¾‘ã€‚æœ¬å°èŠ‚æ‰§è¡Œä½œä¸šä¼šç»å† 4 ä¸ªæ–¹æ³•ï¼Œæ–¹æ³•<strong>é¡ºåº</strong>å¾€ä¸‹è°ƒç”¨ï¼Œæˆ‘ä»¬é€ä¸ªæ¥çœ‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œå¤šä¸ªä½œä¸šçš„åˆ†ç‰‡</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</div><div class="line">* <span class="doctag">@param</span> executionSource æ‰§è¡Œæ¥æº</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œå¤šä¸ªä½œä¸šçš„åˆ†ç‰‡</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</div><div class="line">* <span class="doctag">@param</span> executionSource æ‰§è¡Œæ¥æº</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œå•ä¸ªä½œä¸šçš„åˆ†ç‰‡</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</div><div class="line">* <span class="doctag">@param</span> item åˆ†ç‰‡åºå·</div><div class="line">* <span class="doctag">@param</span> startEvent æ‰§è¡Œäº‹ä»¶(å¼€å§‹)</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> <span class="keyword">int</span> item, <span class="keyword">final</span> JobExecutionEvent startEvent)</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œå•ä¸ªä½œä¸šçš„åˆ†ç‰‡ã€å­ç±»å®ç°ã€‘</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContext åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(ShardingContext shardingContext)</span></span>;</div></pre></td></tr></table></figure>
<p>psï¼š<strong>ä½œä¸šäº‹ä»¶</strong>ç›¸å…³é€»è¾‘ï¼Œå…ˆç»Ÿä¸€è·³è¿‡ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-event-trace/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šäº‹ä»¶è¿½è¸ªã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
<hr>
<p><strong>private void execute(shardingContexts, executionSource)</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ— å¯æ‰§è¡Œçš„åˆ†ç‰‡ï¼Œå‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_FINISHED)</span></div><div class="line">   <span class="keyword">if</span> (shardingContexts.getShardingItemParameters().isEmpty()) &#123;</div><div class="line">       <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">           jobFacade.postJobStatusTraceEvent(shardingContexts.getTaskId(), State.TASK_FINISHED, String.format(<span class="string">"Sharding item for job '%s' is empty."</span>, jobName));</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯</span></div><div class="line">   jobFacade.registerJobBegin(shardingContexts);</div><div class="line">   <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_RUNNING)</span></div><div class="line">   String taskId = shardingContexts.getTaskId();</div><div class="line">   <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">       jobFacade.postJobStatusTraceEvent(taskId, State.TASK_RUNNING, <span class="string">""</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// TODO</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       process(shardingContexts, executionSource);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="comment">// TODO è€ƒè™‘å¢åŠ ä½œä¸šå¤±è´¥çš„çŠ¶æ€ï¼Œå¹¶ä¸”è€ƒè™‘å¦‚ä½•å¤„ç†ä½œä¸šå¤±è´¥çš„æ•´ä½“å›è·¯</span></div><div class="line">       <span class="comment">// æ³¨å†Œä½œä¸šå®Œæˆä¿¡æ¯</span></div><div class="line">       jobFacade.registerJobCompleted(shardingContexts);</div><div class="line">       <span class="comment">// æ ¹æ®æ˜¯å¦æœ‰å¼‚å¸¸ï¼Œå‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_FINISHED / State.TASK_ERROR)</span></div><div class="line">       <span class="keyword">if</span> (itemErrorMessages.isEmpty()) &#123;</div><div class="line">           <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">               jobFacade.postJobStatusTraceEvent(taskId, State.TASK_FINISHED, <span class="string">""</span>);</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">               jobFacade.postJobStatusTraceEvent(taskId, State.TASK_ERROR, itemErrorMessages.toString());</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>æ–¹æ³•å‚æ•° <code>executionSource</code> ä»£è¡¨æ‰§è¡Œæ¥æº( ExecutionSource )ï¼Œä¸€å…±æœ‰ä¸‰ç§ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ExecutionSource &#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * æ™®é€šè§¦å‘æ‰§è¡Œ</div><div class="line">    */</div><div class="line">   NORMAL_TRIGGER,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * è¢«é”™è¿‡æ‰§è¡Œ</div><div class="line">    */</div><div class="line">   MISFIRE,</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * å¤±æ•ˆè½¬ç§»æ‰§è¡Œ</div><div class="line">    */</div><div class="line">   FAILOVER</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>LiteJobFacade#registerJobBegin(...)</code> æ–¹æ³•æ³¨å†Œä½œä¸š<strong>å¯åŠ¨</strong>ä¿¡æ¯ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerJobBegin</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   executionService.registerJobBegin(shardingContexts);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ExecutionService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerJobBegin</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   JobRegistry.getInstance().setJobRunning(jobName, <span class="keyword">true</span>);</div><div class="line">   <span class="keyword">if</span> (!configService.load(<span class="keyword">true</span>).isMonitorExecution()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingContexts.getShardingItemParameters().keySet()) &#123;</div><div class="line">       jobNodeStorage.fillEphemeralJobNode(ShardingNode.getRunningNode(each), <span class="string">""</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä»…å½“ä½œä¸šé…ç½®è®¾ç½®<strong>ç›‘æ§ä½œä¸šè¿è¡Œæ—¶çŠ¶æ€</strong>( <code>LiteJobConfiguration.monitorExecution = true</code> )æ—¶ï¼Œè®°å½•ä½œä¸šè¿è¡ŒçŠ¶æ€ã€‚</li>
<li>è°ƒç”¨ <code>JobNodeStorage#fillEphemeralJobNode(...)</code> æ–¹æ³•è®°å½•<strong>åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹</strong>æ­£åœ¨è¿è¡Œä¸­ã€‚å¦‚ä½•è®°å½•çš„ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-storage/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ•°æ®å­˜å‚¨ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>LiteJobFacade#registerJobCompleted(...)</code> æ–¹æ³•æ³¨å†Œä½œä¸š<strong>å®Œæˆ</strong>ä¿¡æ¯ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerJobCompleted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   executionService.registerJobCompleted(shardingContexts);</div><div class="line">   <span class="keyword">if</span> (configService.load(<span class="keyword">true</span>).isFailover()) &#123;</div><div class="line">       failoverService.updateFailoverComplete(shardingContexts.getShardingItemParameters().keySet());</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ExecutionService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ³¨å†Œä½œä¸šå®Œæˆä¿¡æ¯.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> shardingContexts åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerJobCompleted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   JobRegistry.getInstance().setJobRunning(jobName, <span class="keyword">false</span>);</div><div class="line">   <span class="keyword">if</span> (!configService.load(<span class="keyword">true</span>).isMonitorExecution()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingContexts.getShardingItemParameters().keySet()) &#123;</div><div class="line">       jobNodeStorage.removeJobNodeIfExisted(ShardingNode.getRunningNode(each));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä»…å½“ä½œä¸šé…ç½®è®¾ç½®<strong>ç›‘æ§ä½œä¸šè¿è¡Œæ—¶çŠ¶æ€</strong>( <code>LiteJobConfiguration.monitorExecution = true</code> )ï¼Œç§»é™¤ä½œä¸šè¿è¡ŒçŠ¶æ€ã€‚</li>
<li>è°ƒç”¨ <code>JobNodeStorage#removeJobNodeIfExisted(...)</code> æ–¹æ³•<strong>ç§»é™¤åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹</strong>æ­£åœ¨è¿è¡Œä¸­çš„æ ‡è®°ï¼Œè¡¨ç¤ºä½œä¸šåˆ†ç‰‡é¡¹ä¸åœ¨è¿è¡Œä¸­çŠ¶æ€ã€‚</li>
<li>è°ƒç”¨ <code>FailoverService#updateFailoverComplete(...)</code> æ–¹æ³•æ›´æ–°æ‰§è¡Œå®Œæ¯•å¤±æ•ˆè½¬ç§»çš„åˆ†ç‰‡é¡¹çŠ¶æ€ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-failover/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
</li>
</ul>
<hr>
<p><strong>private void process(shardingContexts, executionSource)</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> JobExecutionEvent.ExecutionSource executionSource)</span> </span>&#123;</div><div class="line">   Collection&lt;Integer&gt; items = shardingContexts.getShardingItemParameters().keySet();</div><div class="line">   <span class="comment">// å•åˆ†ç‰‡ï¼Œç›´æ¥æ‰§è¡Œ</span></div><div class="line">   <span class="keyword">if</span> (<span class="number">1</span> == items.size()) &#123;</div><div class="line">       <span class="keyword">int</span> item = shardingContexts.getShardingItemParameters().keySet().iterator().next();</div><div class="line">       JobExecutionEvent jobExecutionEvent =  <span class="keyword">new</span> JobExecutionEvent(shardingContexts.getTaskId(), jobName, executionSource, item);</div><div class="line">       <span class="comment">// æ‰§è¡Œä¸€ä¸ªä½œä¸š</span></div><div class="line">       process(shardingContexts, item, jobExecutionEvent);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å¤šåˆ†ç‰‡ï¼Œå¹¶è¡Œæ‰§è¡Œ</span></div><div class="line">   <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(items.size());</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">final</span> <span class="keyword">int</span> each : items) &#123;</div><div class="line">       <span class="keyword">final</span> JobExecutionEvent jobExecutionEvent = <span class="keyword">new</span> JobExecutionEvent(shardingContexts.getTaskId(), jobName, executionSource, each);</div><div class="line">       <span class="keyword">if</span> (executorService.isShutdown()) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">       executorService.submit(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">           </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">// æ‰§è¡Œä¸€ä¸ªä½œä¸š</span></div><div class="line">                   process(shardingContexts, each, jobExecutionEvent);</div><div class="line">               &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                   latch.countDown();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç­‰å¾…å¤šåˆ†ç‰‡å…¨éƒ¨å®Œæˆ</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       latch.await();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException ex) &#123;</div><div class="line">       Thread.currentThread().interrupt();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>åˆ†é…<strong>å•</strong>åˆ†ç‰‡é¡¹æ—¶ï¼Œç›´æ¥æ‰§è¡Œï¼Œæ— éœ€ä½¿ç”¨çº¿ç¨‹æ± ï¼Œæ€§èƒ½æ›´ä¼˜ã€‚</li>
<li>åˆ†é…<strong>å¤š</strong>åˆ†ç‰‡é¡¹æ—¶ï¼Œä½¿ç”¨çº¿ç¨‹æ± <strong>å¹¶å‘</strong>æ‰§è¡Œï¼Œé€šè¿‡ CountDownLatch å®ç°ç­‰å¾…åˆ†ç‰‡é¡¹å…¨éƒ¨æ‰§è¡Œå®Œæˆã€‚</li>
</ul>
<hr>
<p><strong>private void process(shardingContexts, item, startEvent)</strong><br><strong>protected abstract void process(shardingContext)</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> <span class="keyword">int</span> item, <span class="keyword">final</span> JobExecutionEvent startEvent)</span> </span>&#123;</div><div class="line">   <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(å¼€å§‹)</span></div><div class="line">   <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">       jobFacade.postJobExecutionEvent(startEvent);</div><div class="line">   &#125;</div><div class="line">   log.trace(<span class="string">"Job '&#123;&#125;' executing, item is: '&#123;&#125;'."</span>, jobName, item);</div><div class="line">   JobExecutionEvent completeEvent;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// æ‰§è¡Œå•ä¸ªä½œä¸š</span></div><div class="line">       process(<span class="keyword">new</span> ShardingContext(shardingContexts, item));</div><div class="line">       <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(æˆåŠŸ)</span></div><div class="line">       completeEvent = startEvent.executionSuccess();</div><div class="line">       log.trace(<span class="string">"Job '&#123;&#125;' executed, item is: '&#123;&#125;'."</span>, jobName, item);</div><div class="line">       <span class="keyword">if</span> (shardingContexts.isAllowSendJobEvent()) &#123;</div><div class="line">           jobFacade.postJobExecutionEvent(completeEvent);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// CHECKSTYLE:OFF</span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable cause) &#123;</div><div class="line">       <span class="comment">// CHECKSTYLE:ON</span></div><div class="line">       <span class="comment">// å‘å¸ƒæ‰§è¡Œäº‹ä»¶(å¤±è´¥)</span></div><div class="line">       completeEvent = startEvent.executionFailure(cause);</div><div class="line">       jobFacade.postJobExecutionEvent(completeEvent);</div><div class="line">       <span class="comment">// è®¾ç½®è¯¥åˆ†ç‰‡æ‰§è¡Œå¼‚å¸¸ä¿¡æ¯</span></div><div class="line">       itemErrorMessages.put(item, ExceptionUtil.transform(cause));</div><div class="line">       <span class="comment">//</span></div><div class="line">       jobExceptionHandler.handleException(jobName, cause);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(ShardingContext shardingContext)</span></span>;</div></pre></td></tr></table></figure>
<ul>
<li>ä¸åŒä½œä¸šæ‰§è¡Œå™¨å®ç°ç±»é€šè¿‡å®ç° <code>#process(shardingContext)</code> æŠ½è±¡æ–¹æ³•ï¼Œå®ç°å¯¹<strong>å•ä¸ªåˆ†ç‰‡é¡¹</strong>ä½œä¸šçš„å¤„ç†ã€‚</li>
<li>ä¸åŒä½œä¸šæ‰§è¡Œå™¨å®ç°ç±»é€šè¿‡å®ç° <code>#process(shardingContext)</code> æŠ½è±¡æ–¹æ³•ï¼Œå®ç°å¯¹<strong>å•ä¸ªåˆ†ç‰‡é¡¹</strong>ä½œä¸šçš„å¤„ç†ã€‚</li>
<li>ä¸åŒä½œä¸šæ‰§è¡Œå™¨å®ç°ç±»é€šè¿‡å®ç° <code>#process(shardingContext)</code> æŠ½è±¡æ–¹æ³•ï¼Œå®ç°å¯¹<strong>å•ä¸ªåˆ†ç‰‡é¡¹</strong>ä½œä¸šçš„å¤„ç†ã€‚</li>
</ul>
<h3 id="4-6-1-ç®€å•ä½œä¸šæ‰§è¡Œå™¨"><a href="#4-6-1-ç®€å•ä½œä¸šæ‰§è¡Œå™¨" class="headerlink" title="4.6.1 ç®€å•ä½œä¸šæ‰§è¡Œå™¨"></a>4.6.1 ç®€å•ä½œä¸šæ‰§è¡Œå™¨</h3><p>SimpleJobExecutorï¼Œç®€å•ä½œä¸šæ‰§è¡Œå™¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleJobExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç®€å•ä½œä¸šå®ç°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SimpleJob simpleJob;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">        simpleJob.execute(shardingContext);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>SimpleJob#execute()</code> æ–¹æ³•å¯¹å•ä¸ªåˆ†ç‰‡é¡¹ä½œä¸šè¿›è¡Œå¤„ç†ã€‚</li>
</ul>
<h3 id="4-6-2-æ•°æ®æµä½œä¸šæ‰§è¡Œå™¨"><a href="#4-6-2-æ•°æ®æµä½œä¸šæ‰§è¡Œå™¨" class="headerlink" title="4.6.2 æ•°æ®æµä½œä¸šæ‰§è¡Œå™¨"></a>4.6.2 æ•°æ®æµä½œä¸šæ‰§è¡Œå™¨</h3><p>DataflowJobExecutorï¼Œæ•°æ®æµä½œä¸šæ‰§è¡Œå™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DataflowJobExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•°æ®æµä½œä¸šå¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataflowJob&lt;Object&gt; dataflowJob;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">        DataflowJobConfiguration dataflowConfig = (DataflowJobConfiguration) getJobRootConfig().getTypeConfig();</div><div class="line">        <span class="keyword">if</span> (dataflowConfig.isStreamingProcess()) &#123; <span class="comment">// æµå¼å¤„ç†æ•°æ®</span></div><div class="line">            streamingExecute(shardingContext);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            oneOffExecute(shardingContext);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æµå¼å¤„ç†</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> shardingContext åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">streamingExecute</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">        List&lt;Object&gt; data = fetchData(shardingContext);</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">null</span> != data &amp;&amp; !data.isEmpty()) &#123;</div><div class="line">            processData(shardingContext, data);</div><div class="line">            <span class="keyword">if</span> (!getJobFacade().isEligibleForJobRunning()) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            data = fetchData(shardingContext);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸€æ¬¡å¤„ç†</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> shardingContext åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">oneOffExecute</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">        List&lt;Object&gt; data = fetchData(shardingContext);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != data &amp;&amp; !data.isEmpty()) &#123;</div><div class="line">            processData(shardingContext, data);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>å½“ä½œä¸šé…ç½®è®¾ç½®æµå¼å¤„ç†æ•°æ®( <code>DataflowJobConfiguration.streamingProcess = true</code> ) æ—¶ï¼Œè°ƒç”¨ <code>#streamingExecute()</code> <strong>ä¸æ–­</strong>åŠ è½½æ•°æ®ï¼Œ<strong>ä¸æ–­</strong>å¤„ç†æ•°æ®ï¼Œç›´åˆ°<strong>æ•°æ®ä¸ºç©º</strong> æˆ–è€… <strong>ä½œä¸šä¸é€‚åˆç»§ç»­è¿è¡Œ</strong>ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEligibleForJobRunning</span><span class="params">()</span> </span>&#123;</div><div class="line">   LiteJobConfiguration liteJobConfig = configService.load(<span class="keyword">true</span>);</div><div class="line">   <span class="keyword">if</span> (liteJobConfig.getTypeConfig() <span class="keyword">instanceof</span> DataflowJobConfiguration) &#123;</div><div class="line">       <span class="keyword">return</span> !shardingService.isNeedSharding() <span class="comment">// ä½œä¸šä¸éœ€è¦é‡æ–°åˆ†ç‰‡</span></div><div class="line">               &amp;&amp; ((DataflowJobConfiguration) liteJobConfig.getTypeConfig()).isStreamingProcess();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> !shardingService.isNeedSharding(); <span class="comment">// ä½œä¸šä¸éœ€è¦é‡æ–°åˆ†ç‰‡</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>ä½œä¸šéœ€è¦é‡æ–°åˆ†ç‰‡ï¼Œæ‰€ä»¥ä¸é€‚åˆç»§ç»­æµå¼æ•°æ®å¤„ç†ã€‚</p>
<blockquote>
<p>å¦‚æœé‡‡ç”¨æµå¼ä½œä¸šå¤„ç†æ–¹å¼ï¼Œå»ºè®®processDataå¤„ç†æ•°æ®åæ›´æ–°å…¶çŠ¶æ€ï¼Œé¿å…fetchDataå†æ¬¡æŠ“å–åˆ°ï¼Œä»è€Œä½¿å¾—ä½œä¸šæ°¸ä¸åœæ­¢ã€‚ æµå¼æ•°æ®å¤„ç†å‚ç…§TbScheduleè®¾è®¡ï¼Œé€‚ç”¨äºä¸é—´æ­‡çš„æ•°æ®å¤„ç†ã€‚</p>
</blockquote>
</li>
</ul>
</li>
<li><p>å½“ä½œä¸šé…ç½®<strong>ä¸</strong>è®¾ç½®æµå¼å¤„ç†æ•°æ®( <code>DataflowJobConfiguration.streamingProcess = false</code> ) æ—¶ï¼Œè°ƒç”¨ <code>#oneOffExecute()</code> <strong>ä¸€æ¬¡</strong>åŠ è½½æ•°æ®ï¼Œ<strong>ä¸€æ¬¡</strong>å¤„ç†æ•°æ®ã€‚</p>
</li>
<li><p>è°ƒç”¨ <code>#fetchData()</code> æ–¹æ³•åŠ è½½æ•°æ®ï¼›è°ƒç”¨ <code>#processData(...)</code> æ–¹æ³•å¤„ç†æ•°æ®ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DataflowJobExecutor.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åŠ è½½æ•°æ®</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContext åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">* <span class="doctag">@return</span> æ•°æ®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> List&lt;Object&gt; <span class="title">fetchData</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> dataflowJob.fetchData(shardingContext);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* å¤„ç†æ•°æ®</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingContext åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">* <span class="doctag">@param</span> data æ•°æ®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processData</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext, <span class="keyword">final</span> List&lt;Object&gt; data)</span> </span>&#123;</div><div class="line">   dataflowJob.processData(shardingContext, data);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="4-6-3-è„šæœ¬ä½œä¸šæ‰§è¡Œå™¨"><a href="#4-6-3-è„šæœ¬ä½œä¸šæ‰§è¡Œå™¨" class="headerlink" title="4.6.3 è„šæœ¬ä½œä¸šæ‰§è¡Œå™¨"></a>4.6.3 è„šæœ¬ä½œä¸šæ‰§è¡Œå™¨</h3><p>ScriptJobExecutorï¼Œè„šæœ¬ä½œä¸šæ‰§è¡Œå™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ScriptJobExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractElasticJobExecutor</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> String scriptCommandLine = ((ScriptJobConfiguration) getJobRootConfig().getTypeConfig()).getScriptCommandLine();</div><div class="line">        <span class="keyword">if</span> (Strings.isNullOrEmpty(scriptCommandLine)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Cannot find script command line for job '%s', job is not executed."</span>, shardingContext.getJobName());</div><div class="line">        &#125;</div><div class="line">        executeScript(shardingContext, scriptCommandLine);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰§è¡Œè„šæœ¬</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> shardingContext åˆ†ç‰‡ä¸Šä¸‹æ–‡</div><div class="line">     * <span class="doctag">@param</span> scriptCommandLine æ‰§è¡Œè„šæœ¬è·¯å¾„</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeScript</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext, <span class="keyword">final</span> String scriptCommandLine)</span> </span>&#123;</div><div class="line">        CommandLine commandLine = CommandLine.parse(scriptCommandLine);</div><div class="line">        <span class="comment">// JSON æ ¼å¼ä¼ é€’å‚æ•°</span></div><div class="line">        commandLine.addArgument(GsonFactory.getGson().toJson(shardingContext), <span class="keyword">false</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">new</span> DefaultExecutor().execute(commandLine);</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Execute script failure."</span>, ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p><code>scriptCommandLine</code> ä¼ é€’çš„æ˜¯<strong>è„šæœ¬è·¯å¾„</strong>ã€‚ä½¿ç”¨ <a href="https://commons.apache.org/proper/commons-exec/" rel="external nofollow noopener noreferrer" target="_blank">Apache Commons Exec</a> å·¥å…·åŒ…å®ç°è„šæœ¬è°ƒç”¨ï¼š</p>
<blockquote>
<p>Scriptç±»å‹ä½œä¸šæ„ä¸ºè„šæœ¬ç±»å‹ä½œä¸šï¼Œæ”¯æŒshellï¼Œpythonï¼Œperlç­‰æ‰€æœ‰ç±»å‹è„šæœ¬ã€‚åªéœ€é€šè¿‡æ§åˆ¶å°æˆ–ä»£ç é…ç½®scriptCommandLineå³å¯ï¼Œæ— éœ€ç¼–ç ã€‚æ‰§è¡Œè„šæœ¬è·¯å¾„å¯åŒ…å«å‚æ•°ï¼Œå‚æ•°ä¼ é€’å®Œæ¯•åï¼Œä½œä¸šæ¡†æ¶ä¼šè‡ªåŠ¨è¿½åŠ æœ€åä¸€ä¸ªå‚æ•°ä¸ºä½œä¸šè¿è¡Œæ—¶ä¿¡æ¯ã€‚</p>
</blockquote>
</li>
<li><p>è„šæœ¬å‚æ•°ä¼ é€’ä½¿ç”¨ JSON æ ¼å¼ã€‚</p>
</li>
</ul>
<h2 id="4-7-æ‰§è¡Œè¢«é”™è¿‡è§¦å‘çš„ä½œä¸š"><a href="#4-7-æ‰§è¡Œè¢«é”™è¿‡è§¦å‘çš„ä½œä¸š" class="headerlink" title="4.7 æ‰§è¡Œè¢«é”™è¿‡è§¦å‘çš„ä½œä¸š"></a>4.7 æ‰§è¡Œè¢«é”™è¿‡è§¦å‘çš„ä½œä¸š</h2><p>å½“ä½œä¸šæ‰§è¡Œè¿‡ä¹…ï¼Œå¯¼è‡´åˆ°è¾¾ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´æœªè¿›è¡Œä¸‹ä¸€æ¬¡ä½œä¸šæ‰§è¡Œï¼ŒElastic-Job-Lite ä¼šè®¾ç½®è¯¥ä½œä¸šåˆ†ç‰‡é¡¹ä¸ºè¢«é”™è¿‡æ‰§è¡Œ( misfired )ã€‚ä¸‹ä¸€æ¬¡ä½œä¸šæ‰§è¡Œæ—¶ï¼Œä¼š<strong>è¡¥å……</strong>æ‰§è¡Œè¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸šåˆ†ç‰‡é¡¹ã€‚</p>
<p><strong>æ ‡è®°ä½œä¸šè¢«é”™è¿‡æ‰§è¡Œ</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobScheduler.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> Scheduler <span class="title">createScheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">   Scheduler result;</div><div class="line">   <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">   result.getListenerManager().addTriggerListener(schedulerFacade.newJobTriggerListener());</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Properties <span class="title">getBaseQuartzProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">   result.put(<span class="string">"org.quartz.jobStore.misfireThreshold"</span>, <span class="string">"1"</span>);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobScheduleController.class</span></div><div class="line"><span class="function"><span class="keyword">private</span> CronTrigger <span class="title">createTrigger</span><span class="params">(<span class="keyword">final</span> String cron)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> TriggerBuilder.newTrigger()</div><div class="line">           .withIdentity(triggerIdentity)</div><div class="line">           .withSchedule(CronScheduleBuilder.cronSchedule(cron)</div><div class="line">           .withMisfireHandlingInstructionDoNothing())</div><div class="line">           .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>org.quartz.jobStore.misfireThreshold</code> è®¾ç½®è¶…è¿‡ 1 æ¯«ç§’ï¼Œä½œä¸šåˆ†ç‰‡é¡¹å³è¢«è§†ä¸ºé”™è¿‡æ‰§è¡Œã€‚</li>
<li><code>#withMisfireHandlingInstructionDoNothing()</code> è®¾ç½® Quartz ç³»ç»Ÿä¸ä¼šç«‹åˆ»å†æ‰§è¡Œä»»åŠ¡ï¼Œè€Œæ˜¯ç­‰åˆ°è·ç¦»ç›®å‰æ—¶é—´æœ€è¿‘çš„é¢„è®¡æ—¶é—´æ‰§è¡Œã€‚<strong>é‡æ–°æ‰§è¡Œè¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸šäº¤ç»™ Elastic-Job-Lite å¤„ç†</strong>ã€‚</li>
<li><p>ä½¿ç”¨ TriggerListener ç›‘å¬è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸šåˆ†ç‰‡é¡¹ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobTriggerListener.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobTriggerListener</span> <span class="keyword">extends</span> <span class="title">TriggerListenerSupport</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">triggerMisfired</span><span class="params">(<span class="keyword">final</span> Trigger trigger)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != trigger.getPreviousFireTime()) &#123;</div><div class="line">            executionService.setMisfire(shardingService.getLocalShardingItems());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ExecutionService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMisfire</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; items)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : items) &#123;</div><div class="line">       jobNodeStorage.createJobNodeIfNeeded(ShardingNode.getMisfireNode(each));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>#setMisfire(...)</code> è®¾ç½®ä½œä¸šåˆ†ç‰‡é¡¹è¢«é”™è¿‡æ‰§è¡Œã€‚</li>
</ul>
</li>
</ul>
<p><strong>è·³è¿‡æ­£åœ¨è¿è¡Œä¸­çš„è¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸š</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">misfireIfRunning</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> executionService.misfireIfHasRunningItems(shardingItems);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ExecutionService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">misfireIfHasRunningItems</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; items)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!hasRunningItems(items)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">   setMisfire(items);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasRunningItems</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; items)</span> </span>&#123;</div><div class="line">   LiteJobConfiguration jobConfig = configService.load(<span class="keyword">true</span>);</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> == jobConfig || !jobConfig.isMonitorExecution()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : items) &#123;</div><div class="line">       <span class="keyword">if</span> (jobNodeStorage.isJobNodeExisted(ShardingNode.getRunningNode(each))) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å½“åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹é‡Œå­˜åœ¨<strong>ä»»æ„ä¸€ä¸ªåˆ†ç‰‡æ­£åœ¨è¿è¡Œ</strong>ä¸­ï¼Œè®¾ç½®åˆ†ç‰‡é¡¹<strong>éƒ½</strong>è¢«é”™è¿‡æ‰§è¡Œ( <code>misfired</code> )ï¼Œå¹¶ä¸æ‰§è¡Œè¿™äº›ä½œä¸šåˆ†ç‰‡ã€‚å¦‚æœä¸è¿›è¡Œè·³è¿‡ï¼Œåˆ™å¯èƒ½å¯¼è‡´<strong>åŒæ—¶</strong>è¿è¡ŒæŸä¸ªä½œä¸šåˆ†ç‰‡ã€‚</li>
<li>è¯¥åŠŸèƒ½ä¾èµ–ä½œä¸šé…ç½®<strong>ç›‘æ§ä½œä¸šè¿è¡Œæ—¶çŠ¶æ€</strong>( <code>LiteJobConfiguration.monitorExecution = true</code> )æ—¶ç”Ÿæ•ˆã€‚</li>
</ul>
<p><strong>æ‰§è¡Œè¢«é”™è¿‡æ‰§è¡Œçš„ä½œä¸šåˆ†ç‰‡é¡¹</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractElasticJobExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">   <span class="comment">// æ‰§è¡Œ è¢«è·³è¿‡è§¦å‘çš„ä½œä¸š</span></div><div class="line">   <span class="keyword">while</span> (jobFacade.isExecuteMisfired(shardingContexts.getShardingItemParameters().keySet())) &#123;</div><div class="line">       jobFacade.clearMisfire(shardingContexts.getShardingItemParameters().keySet());</div><div class="line">       execute(shardingContexts, JobExecutionEvent.ExecutionSource.MISFIRE);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExecuteMisfired</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> isEligibleForJobRunning() <span class="comment">// åˆé€‚ç»§ç»­è¿è¡Œ</span></div><div class="line">           &amp;&amp; configService.load(<span class="keyword">true</span>).getTypeConfig().getCoreConfig().isMisfire() <span class="comment">// ä½œä¸šé…ç½®å¼€å¯ä½œä¸šè¢«é”™è¿‡è§¦å‘</span></div><div class="line">           &amp;&amp; !executionService.getMisfiredJobItems(shardingItems).isEmpty(); <span class="comment">// æ‰€æ‰§è¡Œçš„ä½œä¸šåˆ†ç‰‡å­˜åœ¨è¢«é”™è¿‡( misfired )</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearMisfire</span><span class="params">(<span class="keyword">final</span> Collection&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   executionService.clearMisfire(shardingItems);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ¸…é™¤åˆ†é…çš„ä½œä¸šåˆ†ç‰‡é¡¹è¢«é”™è¿‡æ‰§è¡Œçš„æ ‡è¯†ï¼Œå¹¶æ‰§è¡Œä½œä¸šåˆ†ç‰‡é¡¹ã€‚</li>
<li>ä¸ºä»€ä¹ˆæ­¤å¤„ä½¿ç”¨ <strong>while(â€¦)</strong>ï¼Ÿ<strong>é˜²å¾¡æ€§ç¼–ç¨‹</strong>ï¼Œ<code>#isExecuteMisfired(...)</code> åˆ¤æ–­ä½¿ç”¨<strong>å†…å­˜ç¼“å­˜</strong>çš„æ•°æ®ï¼Œè€Œè¯¥æ•°æ®çš„æ›´æ–°ä¾èµ– Zookeeper é€šçŸ¥è¿›è¡Œ<strong>å¼‚æ­¥</strong>æ›´æ–°ï¼Œå¯èƒ½å› ä¸ºå„ç§æƒ…å†µï¼Œä¾‹å¦‚ç½‘ç»œï¼Œæ•°æ®å¯èƒ½æœªåŠæ—¶æ›´æ–°å¯¼è‡´<strong>æ•°æ®ä¸ä¸€è‡´</strong>ã€‚ä½¿ç”¨ <strong>while(â€¦)</strong> è¿›è¡Œé˜²å¾¡ç¼–ç¨‹ï¼Œä¿è¯<strong>å†…å­˜ç¼“å­˜</strong>çš„æ•°æ®å·²ç»æ›´æ–°ã€‚</li>
</ul>
<h2 id="4-8-æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»"><a href="#4-8-æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»" class="headerlink" title="4.8 æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»"></a>4.8 æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failoverIfNecessary</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (configService.load(<span class="keyword">true</span>).isFailover()) &#123;</div><div class="line">       failoverService.failoverIfNecessary();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ä½œä¸šå¤±æ•ˆè½¬ç§»æœåŠ¡( FailoverService )æ‰§è¡Œä½œä¸šå¤±æ•ˆè½¬ç§»( <code>#failoverIfNecessary()</code> )ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-failover/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
<h2 id="4-9-æ‰§è¡Œä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•"><a href="#4-9-æ‰§è¡Œä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•" class="headerlink" title="4.9 æ‰§è¡Œä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•"></a>4.9 æ‰§è¡Œä½œä¸šæ‰§è¡Œåçš„æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterJobExecuted</span><span class="params">(<span class="keyword">final</span> ShardingContexts shardingContexts)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (ElasticJobListener each : elasticJobListeners) &#123;</div><div class="line">       each.afterJobExecuted(shardingContexts);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ä½œä¸šç›‘å¬å™¨æ‰§è¡Œä½œä¸š<strong>æ‰§è¡Œå</strong>çš„æ–¹æ³•ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-listener/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šç›‘å¬å™¨ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å‘¼ï¼ç•¥é•¿ç•¥é•¿ç•¥é•¿ï¼</p>
<p>ä¸‹é¢ä¼šæ›´æ–°å¦‚ä¸‹ä¸¤ç¯‡æ–‡ç« ï¼Œä¸ºåç»­çš„ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€å¤±æ•ˆè½¬ç§»ã€ä½œä¸šåˆ†ç‰‡ç­–ç•¥ç­‰æ–‡ç« åšé“ºå«ï¼š</p>
<ul>
<li><a href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” æ³¨å†Œä¸­å¿ƒã€‹</a></li>
<li><a href="http://www.yunai.me/Elastic-Job/job-storage/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ•°æ®å­˜å‚¨ã€‹</a></li>
</ul>
<p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>
<p>å•Šå•Šå•Šï¼Œæˆ‘å¥½æƒ³é©¬ä¸Šæ‹œè¯» Elastic-Job-Cloudã€‚ä¸ºäº†ä½ ä»¬ï¼Œæˆ‘å¿ä½äº†å¿ƒç¢ã€‚</p>
<p>æ—ç™½å›ï¼šç…ç¬”ç¬”è€…å·²ç»å·å·åœ¨è¯»äº†ã€‚<br>èŠ‹é“å›ï¼šæ—ç™½å›ï¼Œä½ å¤§çˆ·ï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-%E6%A6%82%E8%BF%B0&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-lite%E8%B0%83%E
    
    </summary>
    
      <category term="Elastic-Job" scheme="http://www.yunai.me/categories/Elastic-Job/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆå§‹åŒ–</title>
    <link href="http://www.yunai.me/Elastic-Job/job-init/"/>
    <id>http://www.yunai.me/Elastic-Job/job-init/</id>
    <published>2017-09-15T16:00:00.000Z</published>
    <updated>2017-08-28T11:05:29.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ä½œä¸šæ³¨å†Œè¡¨</a></li>
<li><a href="#">3. ä½œä¸šè°ƒåº¦å™¨</a><ul>
<li><a href="#">3.1 åˆ›å»º</a></li>
<li><a href="#">3.2 åˆå§‹åŒ–</a><ul>
<li><a href="#">3.2.1 æ›´æ–°ä½œä¸šé…ç½®</a></li>
<li><a href="#">3.2.2 è®¾ç½®å½“å‰ä½œä¸šåˆ†ç‰‡æ€»æ•°</a></li>
<li><a href="#">3.2.3 åˆ›å»ºä½œä¸šè°ƒåº¦æ§åˆ¶å™¨</a></li>
<li><a href="#">3.2.4 æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯</a></li>
<li><a href="#">3.2.5 è°ƒåº¦ä½œä¸š</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šåˆå§‹åŒ–</strong>ã€‚</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_09_09/16.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_09_16/01.png" alt=""></p>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-ä½œä¸šæ³¨å†Œè¡¨"><a href="#2-ä½œä¸šæ³¨å†Œè¡¨" class="headerlink" title="2. ä½œä¸šæ³¨å†Œè¡¨"></a>2. ä½œä¸šæ³¨å†Œè¡¨</h1><p>ä½œä¸šæ³¨å†Œè¡¨( JobRegistry )ï¼Œç»´æŠ¤äº†å•ä¸ª Elastic-Job-Lite <strong>è¿›ç¨‹å†…</strong>ä½œä¸šç›¸å…³ä¿¡æ¯ï¼Œå¯ä»¥ç†è§£æˆå…¶ä¸“å±çš„ Spring IOC å®¹å™¨ã€‚å› æ­¤ï¼Œå…¶æœ¬èº«æ˜¯ä¸€ä¸ª<strong>å•ä¾‹</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å•ä¾‹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> JobRegistry instance;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šè°ƒåº¦æ§åˆ¶å™¨é›†åˆ</div><div class="line">     * keyï¼šä½œä¸šåç§°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Map&lt;String, JobScheduleController&gt; schedulerMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ³¨å†Œä¸­å¿ƒé›†åˆ</div><div class="line">     * keyï¼šä½œä¸šåç§°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Map&lt;String, CoordinatorRegistryCenter&gt; regCenterMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šè¿è¡Œå®ä¾‹é›†åˆ</div><div class="line">     * keyï¼šä½œä¸šåç§°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Map&lt;String, JobInstance&gt; jobInstanceMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¿è¡Œä¸­ä½œä¸šé›†åˆ</div><div class="line">     * keyï¼šä½œä¸šåå­—</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Map&lt;String, Boolean&gt; jobRunningMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šæ€»åˆ†ç‰‡æ•°é‡é›†åˆ</div><div class="line">     * keyï¼šä½œä¸šåå­—</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Map&lt;String, Integer&gt; currentShardingTotalCountMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–ä½œä¸šæ³¨å†Œè¡¨å®ä¾‹.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span> ä½œä¸šæ³¨å†Œè¡¨å®ä¾‹</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobRegistry <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == instance) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (JobRegistry.class) &#123;</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> == instance) &#123;</div><div class="line">                    instance = <span class="keyword">new</span> JobRegistry();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// .... çœç•¥æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>instance</code> æ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œé€šè¿‡ <code>#getInstance()</code> æ–¹æ³•è·å–è¯¥å•ä¾‹ã€‚è¯¥å•ä¾‹çš„åˆ›å»ºæ–¹å¼ä¸º<strong><a href="http://wuchong.me/blog/2014/08/28/how-to-correctly-write-singleton-pattern/#%E5%8F%8C%E9%87%8D%E6%A3%80%E9%AA%8C%E9%94%81" rel="external nofollow noopener noreferrer" target="_blank">åŒé‡æ£€éªŒé”æ¨¡å¼</a></strong>ã€‚</li>
<li>Mapé›†åˆå±æ€§<strong>å…¨éƒ¨</strong>ä»¥<strong>ä½œä¸šåç§°</strong>ä½œä¸º KEYï¼Œé€šè¿‡ä½œä¸šåç§°ï¼Œå¯ä»¥è·å¾—ä½œä¸šç›¸å…³ä¿¡æ¯ã€‚</li>
<li>çœç•¥çš„æ–¹æ³•ï¼Œä¸‹æ–‡åœ¨å®é™…è°ƒç”¨æ—¶ï¼Œè¿›è¡Œè§£æã€‚</li>
</ul>
<h1 id="3-ä½œä¸šè°ƒåº¦å™¨"><a href="#3-ä½œä¸šè°ƒåº¦å™¨" class="headerlink" title="3. ä½œä¸šè°ƒåº¦å™¨"></a>3. ä½œä¸šè°ƒåº¦å™¨</h1><p>ä½œä¸šè°ƒåº¦å™¨( JobScheduler )ï¼Œåˆ›å»ºå¹¶åˆå§‹åŒ–åï¼Œè¿›è¡Œä½œä¸šè°ƒåº¦ã€‚</p>
<p><strong>Elastic-Job-Lite ä½¿ç”¨ Quartz ä½œä¸ºè°ƒåº¦å†…æ ¸ã€‚</strong></p>
<h2 id="3-1-åˆ›å»º"><a href="#3-1-åˆ›å»º" class="headerlink" title="3.1 åˆ›å»º"></a>3.1 åˆ›å»º</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobScheduler</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Liteä½œä¸šé…ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LiteJobConfiguration liteJobConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ³¨å†Œä¸­å¿ƒ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CoordinatorRegistryCenter regCenter;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è°ƒåº¦å™¨é—¨é¢å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SchedulerFacade schedulerFacade;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šé—¨é¢å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobFacade jobFacade;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobScheduler</span><span class="params">(<span class="keyword">final</span> CoordinatorRegistryCenter regCenter, <span class="keyword">final</span> LiteJobConfiguration liteJobConfig, <span class="keyword">final</span> ElasticJobListener... elasticJobListeners)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(regCenter, liteJobConfig, <span class="keyword">new</span> JobEventBus(), elasticJobListeners);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobScheduler</span><span class="params">(<span class="keyword">final</span> CoordinatorRegistryCenter regCenter, <span class="keyword">final</span> LiteJobConfiguration liteJobConfig, <span class="keyword">final</span> JobEventConfiguration jobEventConfig, </span></span></div><div class="line">                        <span class="keyword">final</span> ElasticJobListener... elasticJobListeners) &#123;</div><div class="line">        <span class="keyword">this</span>(regCenter, liteJobConfig, <span class="keyword">new</span> JobEventBus(jobEventConfig), elasticJobListeners);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">JobScheduler</span><span class="params">(<span class="keyword">final</span> CoordinatorRegistryCenter regCenter, <span class="keyword">final</span> LiteJobConfiguration liteJobConfig, <span class="keyword">final</span> JobEventBus jobEventBus, <span class="keyword">final</span> ElasticJobListener... elasticJobListeners)</span> </span>&#123;</div><div class="line">        <span class="comment">// æ·»åŠ  ä½œä¸šè¿è¡Œå®ä¾‹</span></div><div class="line">        JobRegistry.getInstance().addJobInstance(liteJobConfig.getJobName(), <span class="keyword">new</span> JobInstance());</div><div class="line">        <span class="comment">// è®¾ç½® Liteä½œä¸šé…ç½®</span></div><div class="line">        <span class="keyword">this</span>.liteJobConfig = liteJobConfig;</div><div class="line">        <span class="keyword">this</span>.regCenter = regCenter;</div><div class="line">        <span class="comment">// è®¾ç½® ä½œä¸šç›‘å¬å™¨</span></div><div class="line">        List&lt;ElasticJobListener&gt; elasticJobListenerList = Arrays.asList(elasticJobListeners);</div><div class="line">        setGuaranteeServiceForElasticJobListeners(regCenter, elasticJobListenerList);</div><div class="line">        <span class="comment">// è®¾ç½® è°ƒåº¦å™¨é—¨é¢å¯¹è±¡</span></div><div class="line">        schedulerFacade = <span class="keyword">new</span> SchedulerFacade(regCenter, liteJobConfig.getJobName(), elasticJobListenerList);</div><div class="line">        <span class="comment">// è®¾ç½® ä½œä¸šé—¨é¢å¯¹è±¡</span></div><div class="line">        jobFacade = <span class="keyword">new</span> LiteJobFacade(regCenter, liteJobConfig.getJobName(), Arrays.asList(elasticJobListeners), jobEventBus);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>#JobRegistry#addJobInstance()</code> æ–¹æ³•æ·»<strong>åŠ ä½œä¸šè¿è¡Œå®ä¾‹( JobInstance )</strong>ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobRegistry.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ä½œä¸šè¿è¡Œå®ä¾‹é›†åˆ</div><div class="line">* keyï¼šä½œä¸šåç§°</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> Map&lt;String, JobInstance&gt; jobInstanceMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line"><span class="comment">/**</span></div><div class="line">* æ·»åŠ ä½œä¸šå®ä¾‹.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> jobName ä½œä¸šåç§°</div><div class="line">* <span class="doctag">@param</span> jobInstance ä½œä¸šå®ä¾‹</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addJobInstance</span><span class="params">(<span class="keyword">final</span> String jobName, <span class="keyword">final</span> JobInstance jobInstance)</span> </span>&#123;</div><div class="line">   jobInstanceMap.put(jobName, jobInstance);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobInstance.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobInstance</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DELIMITER = <span class="string">"@-@"</span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šå®ä¾‹ä¸»é”®.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobInstanceId;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        jobInstanceId = IpUtils.getIp()</div><div class="line">                + DELIMITER</div><div class="line">                + ManagementFactory.getRuntimeMXBean().getName().split(<span class="string">"@"</span>)[<span class="number">0</span>]; <span class="comment">// PID</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>jobInstanceId</code> æ ¼å¼ï¼š<code>${IP}@-@${PID}</code>ã€‚å…¶ä¸­ <code>PID</code> ä¸ºè¿›ç¨‹ç¼–å·ã€‚åŒä¸€ä¸ª Elastic-Job-Lite å®ä¾‹ï¼Œ<strong>ä¸åŒ</strong>çš„ä½œä¸šä½¿ç”¨<strong>ç›¸åŒ</strong>çš„ä½œä¸šå®ä¾‹ä¸»é”®ã€‚</li>
</ul>
</li>
<li><p>è®¾ç½®ä½œä¸šç›‘å¬å™¨ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-listener/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šç›‘å¬å™¨ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
</li>
<li><p>SchedulerFacadeï¼Œä¸º<strong>è°ƒåº¦å™¨</strong>æä¾›å†…éƒ¨æœåŠ¡çš„é—¨é¢ç±»ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerFacade</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåç§°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šé…ç½®æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConfigurationService configService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåˆ†ç‰‡æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ShardingService shardingService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸»èŠ‚ç‚¹æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LeaderService leaderService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šæœåŠ¡å™¨æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServerService serverService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šè¿è¡Œå®ä¾‹æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InstanceService instanceService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰§è¡Œä½œä¸šæœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutionService executionService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šç›‘æ§æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MonitorService monitorService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è°ƒè§£ä½œä¸šä¸ä¸€è‡´çŠ¶æ€æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReconcileService reconcileService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šæ³¨å†Œä¸­å¿ƒçš„ç›‘å¬å™¨ç®¡ç†è€…</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> ListenerManager listenerManager;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SchedulerFacade</span><span class="params">(<span class="keyword">final</span> CoordinatorRegistryCenter regCenter, <span class="keyword">final</span> String jobName, <span class="keyword">final</span> List&lt;ElasticJobListener&gt; elasticJobListeners)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.jobName = jobName;</div><div class="line">        <span class="comment">// .... çœç•¥ new XXXXX() å¯¹è±¡</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>LiteJobFacadeï¼Œä¸º<strong>ä½œä¸š</strong>æä¾›å†…éƒ¨æœåŠ¡çš„é—¨é¢ç±»ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LiteJobFacade</span> <span class="keyword">implements</span> <span class="title">JobFacade</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šé…ç½®æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConfigurationService configService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåˆ†ç‰‡æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ShardingService shardingService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰§è¡Œä½œä¸šæœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutionService executionService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šè¿è¡Œæ—¶ä¸Šä¸‹æ–‡æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutionContextService executionContextService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šå¤±æ•ˆè½¬ç§»æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FailoverService failoverService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šç›‘å¬å™¨æ•°ç»„</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ElasticJobListener&gt; elasticJobListeners;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šäº‹ä»¶æ€»çº¿</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobEventBus jobEventBus;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LiteJobFacade</span><span class="params">(<span class="keyword">final</span> CoordinatorRegistryCenter regCenter, <span class="keyword">final</span> String jobName, <span class="keyword">final</span> List&lt;ElasticJobListener&gt; elasticJobListeners, <span class="keyword">final</span> JobEventBus jobEventBus)</span> </span>&#123;</div><div class="line">        <span class="comment">// .... çœç•¥ new XXXXX() å¯¹è±¡</span></div><div class="line">        failoverService = <span class="keyword">new</span> FailoverService(regCenter, jobName);</div><div class="line">        <span class="keyword">this</span>.elasticJobListeners = elasticJobListeners;</div><div class="line">        <span class="keyword">this</span>.jobEventBus = jobEventBus;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>SchedulerFacade å’Œ LiteJobFacadeï¼Œçœ‹èµ·æ¥å¾ˆç›¸è¿‘ï¼Œå®é™…å·®åˆ«å¾ˆå¤§ã€‚å®ƒä»¬åˆ†åˆ«ä¸ºè°ƒåº¦å™¨ã€ä½œä¸šæä¾›éœ€è¦çš„æ–¹æ³•ã€‚ä¸‹æ–‡ä¹Ÿä¼šä½“ç°è¿™ä¸€ç‰¹ç‚¹ã€‚</p>
<h2 id="3-2-åˆå§‹åŒ–"><a href="#3-2-åˆå§‹åŒ–" class="headerlink" title="3.2 åˆå§‹åŒ–"></a>3.2 åˆå§‹åŒ–</h2><p>ä½œä¸šè°ƒåº¦å™¨åˆ›å»ºåï¼Œè°ƒç”¨ <code>#init()</code> æ–¹æ³•åˆå§‹åŒ–ï¼Œä½œä¸šæ–¹<strong>å¼€å§‹</strong>è°ƒåº¦ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* åˆå§‹åŒ–ä½œä¸š.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// æ›´æ–° ä½œä¸šé…ç½®</span></div><div class="line">   LiteJobConfiguration liteJobConfigFromRegCenter = schedulerFacade.updateJobConfiguration(liteJobConfig);</div><div class="line">   <span class="comment">// è®¾ç½® å½“å‰ä½œä¸šåˆ†ç‰‡æ€»æ•°</span></div><div class="line">   JobRegistry.getInstance().setCurrentShardingTotalCount(liteJobConfigFromRegCenter.getJobName(), liteJobConfigFromRegCenter.getTypeConfig().getCoreConfig().getShardingTotalCount());</div><div class="line">   <span class="comment">// åˆ›å»º ä½œä¸šè°ƒåº¦æ§åˆ¶å™¨</span></div><div class="line">   JobScheduleController jobScheduleController = <span class="keyword">new</span> JobScheduleController(</div><div class="line">           createScheduler(), createJobDetail(liteJobConfigFromRegCenter.getTypeConfig().getJobClass()), liteJobConfigFromRegCenter.getJobName());</div><div class="line">   <span class="comment">// æ·»åŠ  ä½œä¸šè°ƒåº¦æ§åˆ¶å™¨</span></div><div class="line">   JobRegistry.getInstance().registerJob(liteJobConfigFromRegCenter.getJobName(), jobScheduleController, regCenter);</div><div class="line">   <span class="comment">// æ³¨å†Œ ä½œä¸šå¯åŠ¨ä¿¡æ¯</span></div><div class="line">   schedulerFacade.registerStartUpInfo(!liteJobConfigFromRegCenter.isDisabled());</div><div class="line">   <span class="comment">// è°ƒåº¦ä½œä¸š</span></div><div class="line">   jobScheduleController.scheduleJob(liteJobConfigFromRegCenter.getTypeConfig().getCoreConfig().getCron());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-1-æ›´æ–°ä½œä¸šé…ç½®"><a href="#3-2-1-æ›´æ–°ä½œä¸šé…ç½®" class="headerlink" title="3.2.1 æ›´æ–°ä½œä¸šé…ç½®"></a>3.2.1 æ›´æ–°ä½œä¸šé…ç½®</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerFacade.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ›´æ–°ä½œä¸šé…ç½®.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> liteJobConfig ä½œä¸šé…ç½®</div><div class="line">* <span class="doctag">@return</span> æ›´æ–°åçš„ä½œä¸šé…ç½®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> LiteJobConfiguration <span class="title">updateJobConfiguration</span><span class="params">(<span class="keyword">final</span> LiteJobConfiguration liteJobConfig)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ›´æ–° ä½œä¸šé…ç½®</span></div><div class="line">   configService.persist(liteJobConfig);</div><div class="line">   <span class="comment">// è¯»å– ä½œä¸šé…ç½®</span></div><div class="line">   <span class="keyword">return</span> configService.load(<span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä»<a href="http://www.yunai.me/Elastic-Job/job-config/?self">ã€ŠElastic-Job æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹</a>çš„ã€Œ3.2 æŒä¹…åŒ–ä½œä¸šé…ç½®ã€ï¼Œè°ƒç”¨ <code>ConfigService#persist(...)</code> æ–¹æ³•ä¹Ÿä¸ä¸€å®šä¼šæ›´æ–°ä½œä¸šé…ç½®ï¼Œå› æ­¤è°ƒç”¨ <code>ConfigService#load(...)</code> æ–¹æ³•è¿”å›çš„å¯èƒ½æ˜¯æœ¬åœ°çš„ä½œä¸šé…ç½®ï¼Œä¹Ÿå¯èƒ½æ˜¯<strong>æ³¨å†Œä¸­å¿ƒ</strong>å­˜å‚¨çš„ä½œä¸šé…ç½®ã€‚</li>
</ul>
<h3 id="3-2-2-è®¾ç½®å½“å‰ä½œä¸šåˆ†ç‰‡æ€»æ•°"><a href="#3-2-2-è®¾ç½®å½“å‰ä½œä¸šåˆ†ç‰‡æ€»æ•°" class="headerlink" title="3.2.2 è®¾ç½®å½“å‰ä½œä¸šåˆ†ç‰‡æ€»æ•°"></a>3.2.2 è®¾ç½®å½“å‰ä½œä¸šåˆ†ç‰‡æ€»æ•°</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobRegistry.java</span></div><div class="line"><span class="keyword">private</span> Map&lt;String, Integer&gt; currentShardingTotalCountMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¾ç½®å½“å‰åˆ†ç‰‡æ€»æ•°.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> jobName ä½œä¸šåç§°</div><div class="line">* <span class="doctag">@param</span> currentShardingTotalCount å½“å‰åˆ†ç‰‡æ€»æ•°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCurrentShardingTotalCount</span><span class="params">(<span class="keyword">final</span> String jobName, <span class="keyword">final</span> <span class="keyword">int</span> currentShardingTotalCount)</span> </span>&#123;</div><div class="line">   currentShardingTotalCountMap.put(jobName, currentShardingTotalCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-3-åˆ›å»ºä½œä¸šè°ƒåº¦æ§åˆ¶å™¨"><a href="#3-2-3-åˆ›å»ºä½œä¸šè°ƒåº¦æ§åˆ¶å™¨" class="headerlink" title="3.2.3 åˆ›å»ºä½œä¸šè°ƒåº¦æ§åˆ¶å™¨"></a>3.2.3 åˆ›å»ºä½œä¸šè°ƒåº¦æ§åˆ¶å™¨</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// .... çœç•¥</span></div><div class="line">   <span class="comment">// åˆ›å»º ä½œä¸šè°ƒåº¦æ§åˆ¶å™¨</span></div><div class="line">   JobScheduleController jobScheduleController = <span class="keyword">new</span> JobScheduleController(</div><div class="line">           createScheduler(), createJobDetail(liteJobConfigFromRegCenter.getTypeConfig().getJobClass()), liteJobConfigFromRegCenter.getJobName());</div><div class="line">   <span class="comment">// .... çœç•¥</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>JobScheduleControllerï¼Œä½œä¸šè°ƒåº¦æ§åˆ¶å™¨ï¼Œæä¾›å¯¹ Quartz æ–¹æ³•çš„å°è£…ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobScheduleController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Quartz è°ƒåº¦å™¨</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Scheduler scheduler;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šä¿¡æ¯</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobDetail jobDetail;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è§¦å‘å™¨ç¼–å·</div><div class="line">     * ç›®å‰ä½¿ç”¨å·¥ä½œåå­—( jobName )</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String triggerIdentity;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleJob</span><span class="params">(<span class="keyword">final</span> String cron)</span> </span>&#123;&#125; <span class="comment">// è°ƒåº¦ä½œä¸š</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">rescheduleJob</span><span class="params">(<span class="keyword">final</span> String cron)</span> </span>&#123;&#125; <span class="comment">// é‡æ–°è°ƒåº¦ä½œä¸š</span></div><div class="line">    <span class="function"><span class="keyword">private</span> CronTrigger <span class="title">createTrigger</span><span class="params">(<span class="keyword">final</span> String cron)</span> </span>&#123;&#125; <span class="comment">// åˆ›å»ºè§¦å‘å™¨</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">isPaused</span><span class="params">()</span> </span>&#123;&#125; <span class="comment">// åˆ¤æ–­ä½œä¸šæ˜¯å¦æš‚åœ</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">pauseJob</span><span class="params">()</span> </span>&#123;&#125; <span class="comment">// æš‚åœä½œä¸š</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">resumeJob</span><span class="params">()</span> </span>&#123;&#125; <span class="comment">// æ¢å¤ä½œä¸š</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">triggerJob</span><span class="params">()</span> </span>&#123;&#125; <span class="comment">// ç«‹åˆ»å¯åŠ¨ä½œä¸š</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;&#125; <span class="comment">// å…³é—­è°ƒåº¦å™¨</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>#createScheduler()</code> æ–¹æ³•åˆ›å»º Quartz è°ƒåº¦å™¨ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobScheduler.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> Scheduler <span class="title">createScheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">   Scheduler result;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       StdSchedulerFactory factory = <span class="keyword">new</span> StdSchedulerFactory();</div><div class="line">       factory.initialize(getBaseQuartzProperties());</div><div class="line">       result = factory.getScheduler();</div><div class="line">       result.getListenerManager().addTriggerListener(schedulerFacade.newJobTriggerListener());</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> Properties <span class="title">getBaseQuartzProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">   Properties result = <span class="keyword">new</span> Properties();</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.class"</span>, org.quartz.simpl.SimpleThreadPool.class.getName());</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.threadCount"</span>, <span class="string">"1"</span>); <span class="comment">// Quartz çº¿ç¨‹æ•°ï¼š1</span></div><div class="line">   result.put(<span class="string">"org.quartz.scheduler.instanceName"</span>, liteJobConfig.getJobName());</div><div class="line">   result.put(<span class="string">"org.quartz.jobStore.misfireThreshold"</span>, <span class="string">"1"</span>);</div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.class"</span>, JobShutdownHookPlugin.class.getName()); <span class="comment">// ä½œä¸šå…³é—­é’©å­</span></div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.cleanShutdown"</span>, Boolean.TRUE.toString()); <span class="comment">// å…³é—­æ—¶ï¼Œæ¸…ç†æ‰€æœ‰èµ„æº</span></div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>org.quartz.threadPool.threadCount = 1</code>ï¼Œå³ Quartz æ‰§è¡Œä½œä¸šçº¿ç¨‹æ•°é‡ä¸º 1ã€‚åŸå› ï¼šä¸€ä¸ª<strong>ä½œä¸š( ElasticJob )</strong>çš„è°ƒåº¦ï¼Œéœ€è¦é…ç½®<strong>ç‹¬æœ‰</strong>çš„ä¸€ä¸ª<strong>ä½œä¸šè°ƒåº¦å™¨( JobScheduler )</strong>ï¼Œä¸¤è€…æ˜¯ <code>1 : 1</code> çš„å…³ç³»ã€‚</li>
<li><code>org.quartz.plugin.shutdownhook.class</code> è®¾ç½®ä½œä¸š<strong>ä¼˜é›…å…³é—­</strong>é’©å­ï¼š<a href="https://github.com/dangdangdotcom/elastic-job/blob/7dc099541a16de49f024fc59e46377a726be7f6b/elastic-job-lite/elastic-job-lite-core/src/main/java/com/dangdang/ddframe/job/lite/internal/schedule/JobShutdownHookPlugin.java" rel="external nofollow noopener noreferrer" target="_blank">JobShutdownHookPlugin</a>ã€‚</li>
<li>è§¦å‘å™¨ç›‘å¬å™¨( TriggerListener )ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>#createJobDetail()</code> æ–¹æ³•åˆ›å»º Quartz ä½œä¸šï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobScheduler.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> JobDetail <span class="title">createJobDetail</span><span class="params">(<span class="keyword">final</span> String jobClass)</span> </span>&#123;</div><div class="line">   <span class="comment">// åˆ›å»º Quartz ä½œä¸š</span></div><div class="line">   JobDetail result = JobBuilder.newJob(LiteJob.class).withIdentity(liteJobConfig.getJobName()).build();</div><div class="line">   <span class="comment">//</span></div><div class="line">   result.getJobDataMap().put(JOB_FACADE_DATA_MAP_KEY, jobFacade);</div><div class="line">   <span class="comment">// åˆ›å»º Elastic-Job å¯¹è±¡</span></div><div class="line">   Optional&lt;ElasticJob&gt; elasticJobInstance = createElasticJobInstance();</div><div class="line">   <span class="keyword">if</span> (elasticJobInstance.isPresent()) &#123;</div><div class="line">       result.getJobDataMap().put(ELASTIC_JOB_DATA_MAP_KEY, elasticJobInstance.get());</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!jobClass.equals(ScriptJob.class.getCanonicalName())) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           result.getJobDataMap().put(ELASTIC_JOB_DATA_MAP_KEY, Class.forName(jobClass).newInstance());</div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ReflectiveOperationException ex) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Elastic-Job: Job class '%s' can not initialize."</span>, jobClass);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">protected</span> Optional&lt;ElasticJob&gt; <span class="title">createElasticJobInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> Optional.absent();</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">// SpringJobScheduler.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Optional&lt;ElasticJob&gt; <span class="title">createElasticJobInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> Optional.fromNullable(elasticJob);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>åˆ›å»º Quartz ä½œä¸šè®¾ç½®äº† LiteJob ç±»ï¼Œè¿™æ · Quartz è§¦å‘ä½œä¸šæ‰§è¡Œæ—¶ï¼ŒLiteJob ä¼šå»è°ƒç”¨ Elastic-Job ä½œä¸šå¯¹è±¡ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
<li>åœ¨ Spring é‡Œï¼ŒElastic-Job å¦‚æœå·²ç»åˆ›å»ºå¥½<strong>æ³¨å…¥</strong>åˆ° SpringJobSchedulerï¼Œæ— éœ€è¿›è¡Œåˆ›å»ºã€‚</li>
<li><code>Jodetail.jobDataMap</code> å±æ€§é‡Œæ·»åŠ äº†ä½œä¸šé—¨é¢å¯¹è±¡( LiteJobFacade )ã€Elastic-Job å¯¹è±¡ï¼ŒQuartz  è§¦å‘ä½œä¸šæ—¶ï¼Œä¼šè®¾ç½®åˆ° LiteJob å¯¹è±¡é‡Œã€‚</li>
</ul>
</li>
</ul>
<h3 id="3-2-4-æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯"><a href="#3-2-4-æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯" class="headerlink" title="3.2.4 æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯"></a>3.2.4 æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* æ³¨å†Œä½œä¸šå¯åŠ¨ä¿¡æ¯.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> enabled ä½œä¸šæ˜¯å¦å¯ç”¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStartUpInfo</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> enabled)</span> </span>&#123;</div><div class="line">   <span class="comment">// å¼€å¯ æ‰€æœ‰ç›‘å¬å™¨</span></div><div class="line">   listenerManager.startAllListeners();</div><div class="line">   <span class="comment">// é€‰ä¸¾ ä¸»èŠ‚ç‚¹</span></div><div class="line">   leaderService.electLeader();</div><div class="line">   <span class="comment">// æŒä¹…åŒ– ä½œä¸šæœåŠ¡å™¨ä¸Šçº¿ä¿¡æ¯</span></div><div class="line">   serverService.persistOnline(enabled);</div><div class="line">   <span class="comment">// æŒä¹…åŒ– ä½œä¸šè¿è¡Œå®ä¾‹ä¸Šçº¿ç›¸å…³ä¿¡æ¯</span></div><div class="line">   instanceService.persistOnline();</div><div class="line">   <span class="comment">// è®¾ç½® éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°</span></div><div class="line">   shardingService.setReshardingFlag();</div><div class="line">   <span class="comment">// åˆå§‹åŒ– ä½œä¸šç›‘å¬æœåŠ¡</span></div><div class="line">   monitorService.listen();</div><div class="line">   <span class="comment">// åˆå§‹åŒ– è°ƒè§£ä½œä¸šä¸ä¸€è‡´çŠ¶æ€æœåŠ¡</span></div><div class="line">   <span class="keyword">if</span> (!reconcileService.isRunning()) &#123;</div><div class="line">       reconcileService.startAsync();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å¼€å¯æ‰€æœ‰ç›‘å¬å™¨ã€‚æ¯ä¸ªåŠŸèƒ½æ¨¡å—éƒ½æœ‰å…¶ç›¸åº”çš„ç›‘å¬å™¨ï¼Œåœ¨<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31_bak.jpg">æ¨¡å—å¯¹åº”ã€Œæ–‡ç« ã€</a>è¯¦ç»†åˆ†äº«ã€‚</li>
<li>é€‰ä¸¾ä¸»èŠ‚ç‚¹ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/election/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
<li><p>è°ƒç”¨ <code>ServerService#persistOnline()</code> æ–¹æ³•ï¼ŒæŒä¹…åŒ–ä½œä¸šæœåŠ¡å™¨ä¸Šçº¿ä¿¡æ¯ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerService</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æŒä¹…åŒ–ä½œä¸šæœåŠ¡å™¨ä¸Šçº¿ä¿¡æ¯.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> enabled ä½œä¸šæ˜¯å¦å¯ç”¨</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">persistOnline</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> enabled)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!JobRegistry.getInstance().isShutdown(jobName)) &#123;</div><div class="line">            jobNodeStorage.fillJobNode(serverNode.getServerNode(JobRegistry.getInstance().getJobInstance(jobName).getIp()), enabled ? <span class="string">""</span> : ServerStatus.DISABLED.name());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å½“ä½œä¸šé…ç½®è®¾ç½®ä½œä¸š<strong>ç¦ç”¨</strong>æ—¶( <code>LiteJobConfiguration.disabled = true</code> )ï¼Œä½œä¸šè°ƒåº¦ä½†<strong>è°ƒåº¦ä½œä¸šåˆ†ç‰‡ä¸ºç©º</strong>ã€‚ä¸å¤ªå¥½ç†è§£ï¼Ÿ<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>InstanceService#persistOnline()</code> æ–¹æ³•ï¼ŒæŒä¹…åŒ–ä½œä¸šè¿è¡Œå®ä¾‹ä¸Šçº¿ç›¸å…³ä¿¡æ¯ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InstanceService</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æŒä¹…åŒ–ä½œä¸šè¿è¡Œå®ä¾‹ä¸Šçº¿ç›¸å…³ä¿¡æ¯.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">persistOnline</span><span class="params">()</span> </span>&#123;</div><div class="line">        jobNodeStorage.fillEphemeralJobNode(instanceNode.getLocalInstanceNode(), <span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è®¾ç½®éœ€è¦é‡æ–°åˆ†ç‰‡çš„æ ‡è®°ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-sharding/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
</li>
<li>åˆå§‹åŒ–ä½œä¸šç›‘å¬æœåŠ¡ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/job-monitor/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šç›‘æ§æœåŠ¡ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
<li>åˆå§‹åŒ–è°ƒè§£ä½œä¸šä¸ä¸€è‡´çŠ¶æ€æœåŠ¡ï¼Œåœ¨<a href="http://www.yunai.me/Elastic-Job/reconcile/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” è‡ªè¯Šæ–­ä¿®å¤ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
<h3 id="3-2-5-è°ƒåº¦ä½œä¸š"><a href="#3-2-5-è°ƒåº¦ä½œä¸š" class="headerlink" title="3.2.5 è°ƒåº¦ä½œä¸š"></a>3.2.5 è°ƒåº¦ä½œä¸š</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobScheduler.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">   <span class="comment">// è°ƒåº¦ä½œä¸š</span></div><div class="line">   jobScheduleController.scheduleJob(liteJobConfigFromRegCenter.getTypeConfig().getCoreConfig().getCron());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobScheduleController.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è°ƒåº¦ä½œä¸š.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> cron CRONè¡¨è¾¾å¼</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleJob</span><span class="params">(<span class="keyword">final</span> String cron)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">if</span> (!scheduler.checkExists(jobDetail.getKey())) &#123;</div><div class="line">           scheduler.scheduleJob(jobDetail, createTrigger(cron));</div><div class="line">       &#125;</div><div class="line">       scheduler.start();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>#scheduleJob()</code> æ–¹æ³•åï¼Œè¯¥ Elastic-Job ä½œä¸š<strong>å¼€å§‹</strong>è¢«è°ƒåº¦ã€‚</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ä½œä¸šåˆå§‹åŒ–ï¼Œå¦‚æœä½ å¯¹ Quartz ä¸æ˜¯ç‰¹åˆ«äº†è§£ï¼Œå¯ä»¥å†çœ‹ Quartz å†é‡æ–°ç†è§£ã€‚</p>
<p>ä¸‹ä¸€ç¯‡ï¼Œ<a href="http://www.yunai.me/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a> èµ·èˆªï¼</p>
<p>é“å‹ï¼Œåˆ†äº«ä¸€æ³¢<strong>å¾®ä¿¡æœ‹å‹åœˆ</strong>æ”¯æŒæ”¯æŒæ”¯æŒï¼Œå¯å¥½ï¼Ÿ</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ä½œä¸šæ³¨å†Œè¡¨&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;3
    
    </summary>
    
      <category term="Elastic-Job" scheme="http://www.yunai.me/categories/Elastic-Job/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®</title>
    <link href="http://www.yunai.me/Elastic-Job/job-config/"/>
    <id>http://www.yunai.me/Elastic-Job/job-config/</id>
    <published>2017-09-08T16:00:00.000Z</published>
    <updated>2017-08-28T11:05:15.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ä½œä¸šé…ç½®</a><ul>
<li><a href="#">2.1 æ³¨å†Œä¸­å¿ƒé…ç½®</a></li>
<li><a href="#">2.2 Liteä½œä¸šé…ç½®</a><ul>
<li><a href="#">2.2.1 ä½œä¸šç±»å‹é…ç½®</a></li>
<li><a href="#">2.2.2 ä½œä¸šæ ¸å¿ƒé…ç½®</a></li>
</ul>
</li>
<li><a href="#">2.3 ä½œä¸šäº‹ä»¶é…ç½®</a></li>
<li><a href="#">2.4 ä½œä¸šç›‘å¬å™¨</a></li>
</ul>
</li>
<li><a href="#">3. ä½œä¸šé…ç½®æœåŠ¡</a><ul>
<li><a href="#">3.1 è¯»å–ä½œä¸šé…ç½®</a></li>
<li><a href="#">3.2 æŒä¹…åŒ–ä½œä¸šé…ç½®</a></li>
<li><a href="#">3.3 æ ¡éªŒæœ¬æœºæ—¶é—´æ˜¯å¦åˆæ³•</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Lite ä½œä¸šé…ç½®</strong>ã€‚</p>
<p>æ¶‰åŠåˆ°ä¸»è¦ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.yunai.me/images/Elastic-Job/2017_09_09/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p>
<p><img src="http://www.yunai.me/images/Elastic-Job/2017_09_09/01.png" alt=""></p>
<ul>
<li><strong>é»„è‰²</strong>çš„ç±»åœ¨ <code>elastic-job-common-core</code> é¡¹ç›®é‡Œï¼Œä¸º Elastic-Job-Liteã€Elastic-Job-Cloud <strong>å…¬ç”¨</strong>ä½œä¸šé…ç½®ç±»ã€‚</li>
</ul>
<p>å¦å¤–å»ºè®®ä½ å·²ç»( éå¿…é¡» )ï¼š</p>
<ul>
<li>é˜…è¯»è¿‡<a href="http://dangdangdotcom.github.io/elastic-job/elastic-job-lite/02-guide/config-manual/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” é…ç½®æ‰‹å†Œã€‹</a></li>
<li>è¿è¡Œè¿‡ <a href="https://github.com/dangdangdotcom/elastic-job/blob/8926e94aa7c48dc635a36518da2c4b10194420a5/elastic-job-example/elastic-job-example-lite-java/src/main/java/com/dangdang/ddframe/job/example/JavaMain.java" rel="external nofollow noopener noreferrer" target="_blank">JavaMain.java</a></li>
</ul>
<blockquote>
<p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p>
</blockquote>
<h1 id="2-ä½œä¸šé…ç½®"><a href="#2-ä½œä¸šé…ç½®" class="headerlink" title="2. ä½œä¸šé…ç½®"></a>2. ä½œä¸šé…ç½®</h1><p>ä¸€ä¸ª<strong>ä½œä¸š( ElasticJob )</strong>çš„è°ƒåº¦ï¼Œéœ€è¦é…ç½®<strong>ç‹¬æœ‰</strong>çš„ä¸€ä¸ª<strong>ä½œä¸šè°ƒåº¦å™¨( JobScheduler )</strong>ï¼Œä¸¤è€…æ˜¯ <code>1 : 1</code> çš„å…³ç³»ã€‚<strong>è¿™ç‚¹å¤§å®¶è¦æ³¨æ„ä¸‹ï¼Œå½“ç„¶ä¸‹æ–‡çœ‹ä»£ç ä¹Ÿä¼šçœ‹åˆ°ã€‚</strong></p>
<p>ä½œä¸šè°ƒåº¦å™¨çš„åˆ›å»ºå¯ä»¥é…ç½®å››ä¸ªå‚æ•°ï¼š</p>
<ol>
<li>æ³¨å†Œä¸­å¿ƒ( CoordinatorRegistryCenter )ï¼šç”¨äºåè°ƒåˆ†å¸ƒå¼æœåŠ¡ã€‚<strong>å¿…å¡«</strong>ã€‚</li>
<li>Liteä½œä¸šé…ç½®( LiteJobConfiguration )ï¼š<strong>å¿…å¡«</strong>ã€‚</li>
<li>ä½œä¸šäº‹ä»¶æ€»çº¿( JobEventBus )ï¼šå¯¹ä½œä¸šäº‹ä»¶<strong>å¼‚æ­¥</strong>ç›‘å¬ã€‚<strong>é€‰å¡«</strong>ã€‚</li>
<li>ä½œä¸šç›‘å¬å™¨( ElasticJobListener )ï¼šå¯¹ä½œä¸šæ‰§è¡Œå‰ï¼Œæ‰§è¡Œåè¿›è¡Œ<strong>åŒæ­¥</strong>ç›‘å¬ã€‚<strong>é€‰å¡«</strong>ã€‚</li>
</ol>
<h2 id="2-1-æ³¨å†Œä¸­å¿ƒé…ç½®"><a href="#2-1-æ³¨å†Œä¸­å¿ƒé…ç½®" class="headerlink" title="2.1 æ³¨å†Œä¸­å¿ƒé…ç½®"></a>2.1 æ³¨å†Œä¸­å¿ƒé…ç½®</h2><p>Elastic-Job æŠ½è±¡äº†<strong>æ³¨å†Œä¸­å¿ƒæ¥å£( RegistryCenter )</strong>ï¼Œå¹¶æä¾›äº†é»˜è®¤<strong>åŸºäº Zookeeper çš„æ³¨å†Œä¸­å¿ƒå®ç°( ZookeeperRegistryCenter )</strong>ã€‚</p>
<p>ZookeeperRegistryCenter å¯¹åº”é…ç½®ç±»ä¸º ZookeeperConfigurationã€‚è¯¥ç±»æ³¨é‡Šå¾ˆå®Œæ•´ï¼Œå¯ä»¥ç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/7dc099541a16de49f024fc59e46377a726be7f6b/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/reg/zookeeper/ZookeeperConfiguration.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹æºç ï¼Œè¿™é‡Œæˆ‘ä»¬é‡ç‚¹è¯´ä¸‹ <code>namespace</code> å±æ€§ã€‚å¦‚æœä½ æœ‰å¤šä¸ª<strong>ä¸åŒ</strong> Elastic-Jobé›†ç¾¤ æ—¶ï¼Œä½¿ç”¨ç›¸åŒ Zookeeperï¼Œå¯ä»¥é…ç½®ä¸åŒçš„ <code>namespace</code> è¿›è¡Œéš”ç¦»ã€‚</p>
<p>æ³¨å†Œä¸­å¿ƒçš„<strong>åˆå§‹åŒ–</strong>ï¼Œæˆ‘ä»¬ä¼šåœ¨<a href="http://www.yunai.me/Elastic-Job/reg-center-zookeeper/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” æ³¨å†Œä¸­å¿ƒã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
<h2 id="2-2-Liteä½œä¸šé…ç½®"><a href="#2-2-Liteä½œä¸šé…ç½®" class="headerlink" title="2.2 Liteä½œä¸šé…ç½®"></a>2.2 Liteä½œä¸šé…ç½®</h2><p><a href="https://github.com/dangdangdotcom/elastic-job/blob/6617853bf059df373e2cb6ce959038c583ae5064/elastic-job-lite/elastic-job-lite-core/src/main/java/com/dangdang/ddframe/job/lite/config/LiteJobConfiguration.java" rel="external nofollow noopener noreferrer" target="_blank">LiteJobConfiguration</a> ç»§æ‰¿è‡ªæ¥å£ <a href="https://github.com/dangdangdotcom/elastic-job/blob/6617853bf059df373e2cb6ce959038c583ae5064/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/config/JobRootConfiguration.java" rel="external nofollow noopener noreferrer" target="_blank">JobRootConfiguration</a>ï¼Œä½œä¸º Elastic-Job-Lite é‡Œçš„ä½œä¸š( LiteJob )é…ç½®ã€‚<em>Elastic-Job-Cloud çš„ä½œä¸š( CloudJob )å¯¹åº”å¦å¤–çš„é…ç½®ç±»ï¼Œä¹Ÿå®ç°äº†è¯¥æ¥å£ã€‚</em></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LiteJobConfiguration</span> <span class="keyword">implements</span> <span class="title">JobRootConfiguration</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobTypeConfiguration typeConfig;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> monitorExecution;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxTimeDiffSeconds;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> monitorPort;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobShardingStrategyClass;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> reconcileIntervalMinutes;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> disabled;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> overwrite;</div><div class="line">    </div><div class="line">    <span class="comment">// .... çœç•¥éƒ¨åˆ†getæ–¹æ³•</span></div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</div><div class="line">    </div><div class="line">        <span class="comment">// .... çœç•¥éƒ¨åˆ†å±æ€§</span></div><div class="line">    </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> LiteJobConfiguration <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> LiteJobConfiguration(jobConfig, monitorExecution, maxTimeDiffSeconds, monitorPort, jobShardingStrategyClass, reconcileIntervalMinutes, disabled, overwrite);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>typeConfig</code>ï¼šä½œä¸šç±»å‹é…ç½®ã€‚<strong>å¿…å¡«</strong>ã€‚</li>
<li><p><code>monitorExecution</code>ï¼šç›‘æ§ä½œä¸šè¿è¡Œæ—¶çŠ¶æ€ã€‚é»˜è®¤ä¸º <code>false</code>ã€‚é€‰å¡«ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
<blockquote>
<p>æ¯æ¬¡ä½œä¸šæ‰§è¡Œæ—¶é—´å’Œé—´éš”æ—¶é—´å‡<strong>éå¸¸çŸ­</strong>çš„æƒ…å†µï¼Œå»ºè®®ä¸ç›‘æ§ä½œä¸šè¿è¡Œæ—¶çŠ¶æ€ä»¥æå‡æ•ˆç‡ã€‚å› ä¸ºæ˜¯ç¬æ—¶çŠ¶æ€ï¼Œæ‰€ä»¥æ— å¿…è¦ç›‘æ§ã€‚è¯·ç”¨æˆ·è‡ªè¡Œå¢åŠ æ•°æ®å †ç§¯ç›‘æ§ã€‚å¹¶ä¸”ä¸èƒ½ä¿è¯æ•°æ®é‡å¤é€‰å–ï¼Œåº”åœ¨ä½œä¸šä¸­å®ç°å¹‚ç­‰æ€§ã€‚<br>  æ¯æ¬¡ä½œä¸šæ‰§è¡Œæ—¶é—´å’Œé—´éš”æ—¶é—´å‡<strong>è¾ƒé•¿çš„</strong>æƒ…å†µï¼Œå»ºè®®ç›‘æ§ä½œä¸šè¿è¡Œæ—¶çŠ¶æ€ï¼Œå¯ä¿è¯æ•°æ®ä¸ä¼šé‡å¤é€‰å–ã€‚</p>
</blockquote>
</li>
<li><p><code>monitorPort</code>ï¼šä½œä¸šç›‘æ§ç«¯å£ã€‚é»˜è®¤ä¸º <code>-1</code>ï¼Œä¸å¼€å¯ä½œä¸šç›‘æ§ç«¯å£ã€‚é€‰å¡«ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-monitor/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šç›‘æ§æœåŠ¡ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
<blockquote>
<p>å»ºè®®é…ç½®ä½œä¸šç›‘æ§ç«¯å£, æ–¹ä¾¿å¼€å‘è€…dumpä½œä¸šä¿¡æ¯ã€‚<br>  ä½¿ç”¨æ–¹æ³•: echo â€œdumpâ€ | nc 127.0.0.1 9888</p>
</blockquote>
</li>
<li><p><code>maxTimeDiffSeconds</code>ï¼šè®¾ç½®æœ€å¤§å®¹å¿çš„æœ¬æœºä¸æ³¨å†Œä¸­å¿ƒçš„æ—¶é—´è¯¯å·®ç§’æ•°ã€‚é»˜è®¤ä¸º <code>-1</code>ï¼Œä¸æ£€æŸ¥æ—¶é—´è¯¯å·®ã€‚é€‰å¡«ã€‚</p>
</li>
<li><code>jobShardingStrategyClass</code>ï¼šä½œä¸šåˆ†ç‰‡ç­–ç•¥å®ç°ç±»å…¨è·¯å¾„ã€‚é»˜è®¤ä¸ºä½¿ç”¨åˆ†é…ä¾§è·¯ã€‚é€‰å¡«ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-sharding-strategy/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šåˆ†ç‰‡ç­–ç•¥ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
<li><p><code>reconcileIntervalMinutes</code>ï¼šä¿®å¤ä½œä¸šæœåŠ¡å™¨ä¸ä¸€è‡´çŠ¶æ€æœåŠ¡è°ƒåº¦é—´éš”æ—¶é—´ï¼Œé…ç½®ä¸ºå°äº1çš„ä»»æ„å€¼è¡¨ç¤ºä¸æ‰§è¡Œä¿®å¤ã€‚é»˜è®¤ä¸º <code>10</code>ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/reconcile/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” è‡ªè¯Šæ–­ä¿®å¤ ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
</li>
<li><p><code>disabled</code>ï¼šä½œä¸šæ˜¯å¦ç¦ç”¨æ‰§è¡Œã€‚é»˜è®¤ä¸º <code>false</code>ã€‚é€‰å¡«ã€‚</p>
</li>
<li><code>overwrite</code>ï¼šè®¾ç½®ä½¿ç”¨æœ¬åœ°ä½œä¸šé…ç½®è¦†ç›–æ³¨å†Œä¸­å¿ƒçš„ä½œä¸šé…ç½®ã€‚é»˜è®¤ä¸º <code>false</code>ã€‚é€‰å¡«ã€‚å»ºè®®ä½¿ç”¨<strong>è¿ç»´å¹³å°( console )</strong>é…ç½®ä½œä¸šé…ç½®ï¼Œç»Ÿä¸€ç®¡ç†ã€‚</li>
<li>Builder ç±»ï¼šä½¿ç”¨è¯¥ç±»é…ç½® LiteJobConfiguration å±æ€§ï¼Œè°ƒç”¨ <code>#build()</code> æ–¹æ³•æœ€ç»ˆç”Ÿæˆä½œä¸šé…ç½®ã€‚å‚è§ï¼š<a href="http://blog.csdn.net/top_code/article/details/8469297" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJAVAè®¾è®¡æ¨¡å¼ â€” ç”Ÿæˆå™¨æ¨¡å¼(Builder)ã€‹</a>ã€‚</li>
</ul>
<h3 id="2-2-1-ä½œä¸šç±»å‹é…ç½®"><a href="#2-2-1-ä½œä¸šç±»å‹é…ç½®" class="headerlink" title="2.2.1 ä½œä¸šç±»å‹é…ç½®"></a>2.2.1 ä½œä¸šç±»å‹é…ç½®</h3><p>ä½œä¸šç±»å‹é…ç½®<strong>æ¥å£</strong>( <a href="https://github.com/dangdangdotcom/elastic-job/blob/6617853bf059df373e2cb6ce959038c583ae5064/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/config/JobTypeConfiguration.java" rel="external nofollow noopener noreferrer" target="_blank">JobTypeConfiguration</a> ) æœ‰ä¸‰ç§é…ç½®å®ç°ï¼Œé’ˆå¯¹ä¸‰ç§ä½œä¸šç±»å‹ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">é…ç½®å®ç°</th>
<th style="text-align:left">ä½œä¸š</th>
<th style="text-align:left">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><a href="https://github.com/dangdangdotcom/elastic-job/blob/6617853bf059df373e2cb6ce959038c583ae5064/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/config/simple/SimpleJobConfiguration.java" rel="external nofollow noopener noreferrer" target="_blank">SimpleJobConfiguration</a></td>
<td style="text-align:left">SimpleJob</td>
<td style="text-align:left">ç®€å•ä½œä¸šã€‚ä¾‹å¦‚ï¼šè®¢å•è¿‡æœŸä½œä¸š</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://github.com/dangdangdotcom/elastic-job/blob/6617853bf059df373e2cb6ce959038c583ae5064/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/config/dataflow/DataflowJobConfiguration.java" rel="external nofollow noopener noreferrer" target="_blank">DataflowJobConfiguration</a></td>
<td style="text-align:left">DataflowJob</td>
<td style="text-align:left">æ•°æ®æµä½œä¸šã€‚TODOï¼šç¬”è€…æš‚æ—¶æœªäº†è§£æµå¼å¤„ç†æ•°æ®ï¼Œä¸è¯¯äººå­å¼Ÿ</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://github.com/dangdangdotcom/elastic-job/blob/6617853bf059df373e2cb6ce959038c583ae5064/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/config/script/ScriptJobConfiguration.java" rel="external nofollow noopener noreferrer" target="_blank">ScriptJobConfiguration</a></td>
<td style="text-align:left">ScriptJob</td>
<td style="text-align:left">è„šæœ¬ä½œä¸šã€‚ä¾‹å¦‚ï¼šè°ƒç”¨ shell è„šæœ¬å¤‡ä»½æ•°æ®åº“ä½œä¸š</td>
</tr>
</tbody>
</table>
<p>ä¸‰ç§<strong>é…ç½®ç±»</strong>å±æ€§å¯¹æ¯”å¦‚ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">å±æ€§</th>
<th style="text-align:left">SimpleJob</th>
<th style="text-align:left">DataflowJob</th>
<th style="text-align:left">ScriptJob</th>
<th style="text-align:left">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>coreConfig</code></td>
<td style="text-align:left">âˆš</td>
<td style="text-align:left">âˆš</td>
<td style="text-align:left">âˆš</td>
<td style="text-align:left">ä½œä¸šæ ¸å¿ƒé…ç½®</td>
</tr>
<tr>
<td style="text-align:left"><code>jobType</code></td>
<td style="text-align:left">JobType.SIMPLE</td>
<td style="text-align:left">JobType.DATAFLOW</td>
<td style="text-align:left">JobType.SCRIPT</td>
<td style="text-align:left">ä½œä¸šç±»å‹</td>
</tr>
<tr>
<td style="text-align:left"><code>jobClass</code></td>
<td style="text-align:left">âˆš</td>
<td style="text-align:left">âˆš</td>
<td style="text-align:left">âˆš (é»˜è®¤ï¼šScriptJob.class)</td>
<td style="text-align:left">ä½œä¸šå®ç°ç±»å…¨è·¯å¾„</td>
</tr>
<tr>
<td style="text-align:left"><code>streamingProcess</code></td>
<td style="text-align:left"></td>
<td style="text-align:left">âˆš</td>
<td style="text-align:left"></td>
<td style="text-align:left">æ˜¯å¦æµå¼å¤„ç†æ•°æ®</td>
</tr>
<tr>
<td style="text-align:left"><code>scriptCommandLine</code></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">âˆš</td>
<td style="text-align:left">è„šæœ¬å‹ä½œä¸šæ‰§è¡Œå‘½ä»¤è¡Œ</td>
</tr>
</tbody>
</table>
<p><strong>ä½œä¸šç±»å‹é…ç½®ä¸ä»…ä»…é€‚ç”¨äº Elastic-Job-Liteï¼Œä¹Ÿé€‚ç”¨äº Elastic-Job-Cloudã€‚</strong></p>
<h3 id="2-2-2-ä½œä¸šæ ¸å¿ƒé…ç½®"><a href="#2-2-2-ä½œä¸šæ ¸å¿ƒé…ç½®" class="headerlink" title="2.2.2 ä½œä¸šæ ¸å¿ƒé…ç½®"></a>2.2.2 ä½œä¸šæ ¸å¿ƒé…ç½®</h3><p>ä½œä¸šæ ¸å¿ƒé…ç½®( JobCoreConfiguration )ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨æ¯ç§ä½œä¸šç±»å‹é…ç½®éƒ½æœ‰è¯¥å±æ€§( <code>coreConfig</code> )ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobCoreConfiguration</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String cron;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String shardingItemParameters;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobParameter;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> failover;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> misfire;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String description;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobProperties jobProperties;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</div><div class="line">    </div><div class="line">        <span class="comment">// .... çœç•¥éƒ¨åˆ†å±æ€§</span></div><div class="line">    </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> JobCoreConfiguration <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">            Preconditions.checkArgument(!Strings.isNullOrEmpty(jobName), <span class="string">"jobName can not be empty."</span>);</div><div class="line">            Preconditions.checkArgument(!Strings.isNullOrEmpty(cron), <span class="string">"cron can not be empty."</span>);</div><div class="line">            Preconditions.checkArgument(shardingTotalCount &gt; <span class="number">0</span>, <span class="string">"shardingTotalCount should larger than zero."</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JobCoreConfiguration(jobName, cron, shardingTotalCount, shardingItemParameters, jobParameter, failover, misfire, description, jobProperties);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>jobName</code>ï¼šä½œä¸šåç§°ã€‚<strong>å¿…å¡«ã€‚</strong></li>
<li><code>cron</code>ï¼šcronè¡¨è¾¾å¼ï¼Œç”¨äºæ§åˆ¶ä½œä¸šè§¦å‘æ—¶é—´ã€‚<strong>å¿…å¡«ã€‚</strong></li>
<li><code>shardingTotalCount</code>ï¼šä½œä¸šåˆ†ç‰‡æ€»æ•°ã€‚å¦‚æœä¸€ä¸ªä½œä¸šå¯åŠ¨è¶…è¿‡ä½œä¸šåˆ†ç‰‡æ€»æ•°çš„èŠ‚ç‚¹ï¼Œåªæœ‰ <code>shardingTotalCount</code> ä¼šæ‰§è¡Œä½œä¸šã€‚<strong>å¿…å¡«ã€‚</strong>åœ¨<a href="http://www.yunai.me/Elastic-Job/job-sharding-strategy/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šåˆ†ç‰‡ç­–ç•¥ ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
<li><p><code>shardingItemParameters</code>ï¼šåˆ†ç‰‡åºåˆ—å·å’Œå‚æ•°ã€‚é€‰å¡«ã€‚</p>
<blockquote>
<p>åˆ†ç‰‡åºåˆ—å·å’Œå‚æ•°ç”¨ç­‰å·åˆ†éš”ï¼Œå¤šä¸ªé”®å€¼å¯¹ç”¨é€—å·åˆ†éš”<br>  åˆ†ç‰‡åºåˆ—å·ä»0å¼€å§‹ï¼Œ<strong>ä¸å¯å¤§äºæˆ–ç­‰äº</strong>ä½œä¸šåˆ†ç‰‡æ€»æ•°<br>  å¦‚ï¼š<br>  0=a,1=b,2=c  </p>
</blockquote>
</li>
<li><p><code>jobParameter</code>ï¼šä½œä¸šè‡ªå®šä¹‰å‚æ•°ã€‚é€‰å¡«ã€‚</p>
<blockquote>
<p>ä½œä¸šè‡ªå®šä¹‰å‚æ•°ï¼Œå¯é€šè¿‡ä¼ é€’è¯¥å‚æ•°ä¸ºä½œä¸šè°ƒåº¦çš„ä¸šåŠ¡æ–¹æ³•ä¼ å‚ï¼Œç”¨äºå®ç°å¸¦å‚æ•°çš„ä½œä¸š<br>  ä¾‹ï¼šæ¯æ¬¡è·å–çš„æ•°æ®é‡ã€ä½œä¸šå®ä¾‹ä»æ•°æ®åº“è¯»å–çš„ä¸»é”®ç­‰</p>
</blockquote>
</li>
<li><p><code>failover</code>ï¼šæ˜¯å¦å¼€å¯ä½œä¸šæ‰§è¡Œå¤±æ•ˆè½¬ç§»ã€‚<strong>å¼€å¯è¡¨ç¤ºå¦‚æœä½œä¸šåœ¨ä¸€æ¬¡ä½œä¸šæ‰§è¡Œä¸­é€”å®•æœºï¼Œå…è®¸å°†è¯¥æ¬¡æœªå®Œæˆçš„ä½œä¸šåœ¨å¦ä¸€ä½œä¸šèŠ‚ç‚¹ä¸Šè¡¥å¿æ‰§è¡Œ</strong>ã€‚é»˜è®¤ä¸º <code>false</code>ã€‚é€‰å¡«ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-failover/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§» ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
</li>
<li><code>misfire</code>ï¼šæ˜¯å¦å¼€å¯é”™è¿‡ä½œä¸šé‡æ–°æ‰§è¡Œã€‚é»˜è®¤ä¸º <code>true</code>ã€‚é€‰å¡«ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ‰§è¡Œ ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
<li><code>description</code>ï¼šä½œä¸šæè¿°ã€‚é€‰å¡«ã€‚</li>
<li><p><code>jobProperties</code>ï¼šä½œä¸šå±æ€§é…ç½®ã€‚é€‰å¡«ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ‰§è¡Œ ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobProperties</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> EnumMap&lt;JobPropertiesEnum, String&gt; map = <span class="keyword">new</span> EnumMap&lt;&gt;(JobPropertiesEnum.class);</div><div class="line">    </div><div class="line">   <span class="keyword">public</span> <span class="keyword">enum</span> JobPropertiesEnum &#123;</div><div class="line">        </div><div class="line">        <span class="comment">/**</span></div><div class="line">         * ä½œä¸šå¼‚å¸¸å¤„ç†å™¨.</div><div class="line">         */</div><div class="line">        JOB_EXCEPTION_HANDLER(<span class="string">"job_exception_handler"</span>, JobExceptionHandler.class, DefaultJobExceptionHandler.class.getCanonicalName()),</div><div class="line">        </div><div class="line">        <span class="comment">/**</span></div><div class="line">         * çº¿ç¨‹æ± æœåŠ¡å¤„ç†å™¨.</div><div class="line">         */</div><div class="line">        EXECUTOR_SERVICE_HANDLER(<span class="string">"executor_service_handler"</span>, ExecutorServiceHandler.class, DefaultExecutorServiceHandler.class.getCanonicalName());</div><div class="line">        </div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String key;</div><div class="line">    </div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; classType;</div><div class="line">        </div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String defaultValue;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>JOB_EXCEPTION_HANDLER</code>ï¼šç”¨äºæ‰©å±•<strong>å¼‚å¸¸å¤„ç†</strong>ç±»ã€‚</li>
<li><code>EXECUTOR_SERVICE_HANDLER</code>ï¼šç”¨äºæ‰©å±•<strong>ä½œä¸šå¤„ç†çº¿ç¨‹æ± </strong>ç±»ã€‚</li>
<li>é€šè¿‡è¿™ä¸ªå±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰<strong>æ¯ä¸ªä½œä¸š</strong>çš„å¼‚å¸¸å¤„ç†å’Œçº¿ç¨‹æ± æœåŠ¡ã€‚    </li>
</ul>
</li>
</ul>
<h2 id="2-3-ä½œä¸šäº‹ä»¶é…ç½®"><a href="#2-3-ä½œä¸šäº‹ä»¶é…ç½®" class="headerlink" title="2.3 ä½œä¸šäº‹ä»¶é…ç½®"></a>2.3 ä½œä¸šäº‹ä»¶é…ç½®</h2><p>é€šè¿‡ä½œä¸šäº‹ä»¶é…ç½®( JobEventConfiguration )ï¼Œå®ç°å¯¹ä½œä¸šäº‹ä»¶çš„<strong>å¼‚æ­¥</strong>ç›‘å¬ã€å¤„ç†ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-event-trace/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šäº‹ä»¶è¿½è¸ªã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
<h2 id="2-4-ä½œä¸šç›‘å¬å™¨"><a href="#2-4-ä½œä¸šç›‘å¬å™¨" class="headerlink" title="2.4 ä½œä¸šç›‘å¬å™¨"></a>2.4 ä½œä¸šç›‘å¬å™¨</h2><p>é€šè¿‡é…ç½®ä½œä¸šç›‘å¬å™¨( ElasticJobListener )ï¼Œå®ç°å¯¹ä½œä¸šæ‰§è¡Œçš„<strong>åŒæ­¥</strong>ç›‘å¬ã€å¤„ç†ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-listener/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šç›‘å¬å™¨ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</p>
<h1 id="3-ä½œä¸šé…ç½®æœåŠ¡"><a href="#3-ä½œä¸šé…ç½®æœåŠ¡" class="headerlink" title="3. ä½œä¸šé…ç½®æœåŠ¡"></a>3. ä½œä¸šé…ç½®æœåŠ¡</h1><p>å¤šä¸ª Elastic-Job-Lite ä½¿ç”¨ç›¸åŒ<strong>æ³¨å†Œä¸­å¿ƒ</strong>å’Œç›¸åŒ <strong><code>namespace</code></strong> ç»„æˆé›†ç¾¤ï¼Œå®ç°é«˜å¯ç”¨ã€‚é›†ç¾¤ä¸­ï¼Œä½¿ç”¨ä½œä¸šé…ç½®æœåŠ¡( ConfigurationService ) å…±äº«ä½œä¸šé…ç½®ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigurationService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ—¶é—´æœåŠ¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TimeService timeService;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šèŠ‚ç‚¹æ•°æ®è®¿é—®ç±»</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobNodeStorage jobNodeStorage;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConfigurationService</span><span class="params">(<span class="keyword">final</span> CoordinatorRegistryCenter regCenter, <span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">        jobNodeStorage = <span class="keyword">new</span> JobNodeStorage(regCenter, jobName);</div><div class="line">        timeService = <span class="keyword">new</span> TimeService();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>JobNodeStorageï¼Œå°è£…æ³¨å†Œä¸­å¿ƒï¼Œæä¾›å­˜å‚¨æœåŠ¡ã€‚åœ¨<a href="http://www.yunai.me/Elastic-Job/job-storage/?self">ã€ŠElastic-Job-Lite æºç è§£æ â€”â€” ä½œä¸šæ•°æ®å­˜å‚¨ã€‹</a>è¯¦ç»†åˆ†äº«ã€‚</li>
<li><p>TimeServiceï¼Œæ—¶é—´æœåŠ¡ï¼Œæä¾›å½“å‰æ—¶é—´æŸ¥è¯¢ã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–å½“å‰æ—¶é—´çš„æ¯«ç§’æ•°.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span> å½“å‰æ—¶é—´çš„æ¯«ç§’æ•°</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getCurrentMillis</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> System.currentTimeMillis();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="3-1-è¯»å–ä½œä¸šé…ç½®"><a href="#3-1-è¯»å–ä½œä¸šé…ç½®" class="headerlink" title="3.1 è¯»å–ä½œä¸šé…ç½®"></a>3.1 è¯»å–ä½œä¸šé…ç½®</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* è¯»å–ä½œä¸šé…ç½®.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> fromCache æ˜¯å¦ä»ç¼“å­˜ä¸­è¯»å–</div><div class="line">* <span class="doctag">@return</span> ä½œä¸šé…ç½®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> LiteJobConfiguration <span class="title">load</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> fromCache)</span> </span>&#123;</div><div class="line">   String result;</div><div class="line">   <span class="keyword">if</span> (fromCache) &#123; <span class="comment">// ç¼“å­˜</span></div><div class="line">       result = jobNodeStorage.getJobNodeData(ConfigurationNode.ROOT);</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> == result) &#123;</div><div class="line">           result = jobNodeStorage.getJobNodeDataDirectly(ConfigurationNode.ROOT);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       result = jobNodeStorage.getJobNodeDataDirectly(ConfigurationNode.ROOT);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> LiteJobConfigurationGsonFactory.fromJson(result);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-2-æŒä¹…åŒ–ä½œä¸šé…ç½®"><a href="#3-2-æŒä¹…åŒ–ä½œä¸šé…ç½®" class="headerlink" title="3.2 æŒä¹…åŒ–ä½œä¸šé…ç½®"></a>3.2 æŒä¹…åŒ–ä½œä¸šé…ç½®</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* æŒä¹…åŒ–åˆ†å¸ƒå¼ä½œä¸šé…ç½®ä¿¡æ¯.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> liteJobConfig ä½œä¸šé…ç½®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">persist</span><span class="params">(<span class="keyword">final</span> LiteJobConfiguration liteJobConfig)</span> </span>&#123;</div><div class="line">   checkConflictJob(liteJobConfig);</div><div class="line">   <span class="keyword">if</span> (!jobNodeStorage.isJobNodeExisted(ConfigurationNode.ROOT) || liteJobConfig.isOverwrite()) &#123;</div><div class="line">       jobNodeStorage.replaceJobNode(ConfigurationNode.ROOT, LiteJobConfigurationGsonFactory.toJson(liteJobConfig));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>#checkConflictJob(...)</code> æ–¹æ³•<strong>æ ¡éªŒ</strong>æ³¨å†Œä¸­å¿ƒå­˜å‚¨çš„ä½œä¸šé…ç½®çš„ä½œä¸šå®ç°ç±»å…¨è·¯å¾„( <code>jobClass</code> )å’Œå½“å‰çš„æ˜¯å¦ç›¸åŒï¼Œå¦‚æœä¸åŒï¼Œåˆ™è®¤ä¸ºæ˜¯<strong>å†²çª</strong>ï¼Œä¸å…è®¸å­˜å‚¨ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkConflictJob</span><span class="params">(<span class="keyword">final</span> LiteJobConfiguration liteJobConfig)</span> </span>&#123;</div><div class="line">   Optional&lt;LiteJobConfiguration&gt; liteJobConfigFromZk = find();</div><div class="line">   <span class="keyword">if</span> (liteJobConfigFromZk.isPresent()</div><div class="line">           &amp;&amp; !liteJobConfigFromZk.get().getTypeConfig().getJobClass().equals(liteJobConfig.getTypeConfig().getJobClass())) &#123; <span class="comment">// jobClass æ˜¯å¦ç›¸åŒ</span></div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Job conflict with register center. The job '%s' in register center's class is '%s', your job class is '%s'"</span>, </div><div class="line">               liteJobConfig.getJobName(), liteJobConfigFromZk.get().getTypeConfig().getJobClass(), liteJobConfig.getTypeConfig().getJobClass());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>å½“æ³¨å†Œä¸­å¿ƒ<strong>æœªå­˜å‚¨</strong>è¯¥ä½œä¸šé…ç½® æˆ–è€… å½“å‰ä½œä¸šé…ç½®å…è®¸æ›¿æ¢æ³¨å†Œä¸­å¿ƒä½œä¸šé…ç½®( <code>overwrite = true</code> )æ—¶ï¼ŒæŒä¹…åŒ–ä½œä¸šé…ç½®ã€‚</li>
</ul>
<h2 id="3-3-æ ¡éªŒæœ¬æœºæ—¶é—´æ˜¯å¦åˆæ³•"><a href="#3-3-æ ¡éªŒæœ¬æœºæ—¶é—´æ˜¯å¦åˆæ³•" class="headerlink" title="3.3 æ ¡éªŒæœ¬æœºæ—¶é—´æ˜¯å¦åˆæ³•"></a>3.3 æ ¡éªŒæœ¬æœºæ—¶é—´æ˜¯å¦åˆæ³•</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* æ£€æŸ¥æœ¬æœºä¸æ³¨å†Œä¸­å¿ƒçš„æ—¶é—´è¯¯å·®ç§’æ•°æ˜¯å¦åœ¨å…è®¸èŒƒå›´.</div><div class="line">* </div><div class="line">* <span class="doctag">@throws</span> JobExecutionEnvironmentException æœ¬æœºä¸æ³¨å†Œä¸­å¿ƒçš„æ—¶é—´è¯¯å·®ç§’æ•°ä¸åœ¨å…è®¸èŒƒå›´æ‰€æŠ›å‡ºçš„å¼‚å¸¸</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkMaxTimeDiffSecondsTolerable</span><span class="params">()</span> <span class="keyword">throws</span> JobExecutionEnvironmentException </span>&#123;</div><div class="line">   <span class="keyword">int</span> maxTimeDiffSeconds =  load(<span class="keyword">true</span>).getMaxTimeDiffSeconds();</div><div class="line">   <span class="keyword">if</span> (-<span class="number">1</span>  == maxTimeDiffSeconds) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">long</span> timeDiff = Math.abs(timeService.getCurrentMillis() - jobNodeStorage.getRegistryCenterTime());</div><div class="line">   <span class="keyword">if</span> (timeDiff &gt; maxTimeDiffSeconds * <span class="number">1000L</span>) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobExecutionEnvironmentException(</div><div class="line">               <span class="string">"Time different between job server and register center exceed '%s' seconds, max time different is '%s' seconds."</span>, timeDiff / <span class="number">1000</span>, maxTimeDiffSeconds);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Elastic-Job-Lite ä½œä¸šè§¦å‘æ˜¯<strong>ä¾èµ–æœ¬æœºæ—¶é—´</strong>ï¼Œç›¸åŒé›†ç¾¤ä½¿ç”¨æ³¨å†Œä¸­å¿ƒæ—¶é—´ä¸ºåŸºå‡†ï¼Œæ ¡éªŒæœ¬æœºä¸æ³¨å†Œä¸­å¿ƒçš„æ—¶é—´è¯¯å·®æ˜¯å¦åœ¨å…è®¸èŒƒå›´å†…( <code>LiteJobConfiguration.maxTimeDiffSeconds</code> )ã€‚</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>Elastic-Job-Lite æºç è§£æç³»åˆ—ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œå¸Œæœ›å¤§å®¶å¤šå¤šæ”¯æŒï¼Œé¢„è®¡å…¨éƒ¨æ›´æ–°å®Œä¼šæœ‰ 15+ ç¯‡ã€‚Elastic-Job-Cloud æºç ç³»åˆ—åç»­ä¹Ÿä¼šæ›´æ–°ã€‚</p>
<p>é“å‹ï¼Œåˆ†äº«ä¸€æ³¢<strong>å¾®ä¿¡æœ‹å‹åœˆ</strong>æ”¯æŒæ”¯æŒæ”¯æŒï¼Œå¯å¥½ï¼Ÿ</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ä½œä¸šé…ç½®&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2.1
    
    </summary>
    
      <category term="Elastic-Job" scheme="http://www.yunai.me/categories/Elastic-Job/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job æºç åˆ†æ â€”â€” ä¸ºä»€ä¹ˆé˜…è¯» Elastic-Job æºç ï¼Ÿ</title>
    <link href="http://www.yunai.me/Elastic-Job/why-read-Elastic-Job-source-code/"/>
    <id>http://www.yunai.me/Elastic-Job/why-read-Elastic-Job-source-code/</id>
    <published>2017-08-31T16:00:00.000Z</published>
    <updated>2017-08-26T13:35:19.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<h2 id="ä¸ºä»€ä¹ˆé˜…è¯»-Elastic-Job-æºç ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆé˜…è¯»-Elastic-Job-æºç ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆé˜…è¯» Elastic-Job æºç ï¼Ÿ"></a>ä¸ºä»€ä¹ˆé˜…è¯» Elastic-Job æºç ï¼Ÿ</h2><ol>
<li>ä¹‹å‰æ–­æ–­ç»­ç»­è¯»è¿‡ Quartz æºç ï¼Œå›¢é˜Ÿé‡Œä¹Ÿå¯¹ Quartz åšè¿‡ä¸€äº›å°è£…ç®¡ç†ï¼Œå¾ˆå¤š Quartz äºŒæ¬¡å°è£…å¼€æºé¡¹ç›®ï¼Œæƒ³äº†è§£ Elastic-Job åšäº†å“ªäº›åŠŸèƒ½ï¼Œæ˜¯æ€ä¹ˆå®ç°çš„</li>
<li>Quartz å¤šèŠ‚ç‚¹é€šè¿‡æ•°æ®åº“é”å®ç°ä»»åŠ¡æŠ¢å ï¼ŒElastic-Job åŸºäºä»€ä¹ˆç­–ç•¥å®ç°ä»»åŠ¡è°ƒåº¦ä¸åˆ†é…</li>
<li>ä»»åŠ¡åˆ†ç‰‡å¦‚ä½•å®ç°</li>
<li>Elastic-Job-Cloud å¦‚ä½•å®ç°ä»»åŠ¡åŠ¨æ€æ‰©å®¹å’Œç¼©å®¹</li>
<li>ä»»åŠ¡è¶…æ—¶å¦‚ä½•å¤„ç†ï¼Ÿä»»åŠ¡å‡æ­»æ€ä¹ˆåˆ¤æ–­ï¼Ÿ</li>
</ol>
<h2 id="ä½¿ç”¨å…¬å¸"><a href="#ä½¿ç”¨å…¬å¸" class="headerlink" title="ä½¿ç”¨å…¬å¸"></a>ä½¿ç”¨å…¬å¸</h2><h2 id="æ­¥éª¤-åŠŸèƒ½"><a href="#æ­¥éª¤-åŠŸèƒ½" class="headerlink" title="æ­¥éª¤/åŠŸèƒ½"></a>æ­¥éª¤/åŠŸèƒ½</h2><ul>
<li>[ ] åˆ†å¸ƒå¼è°ƒåº¦åè°ƒ</li>
<li>[ ] å¼¹æ€§æ‰©å®¹ç¼©å®¹</li>
<li>[ ] å¤±æ•ˆè½¬ç§»</li>
<li>[x] é”™è¿‡æ‰§è¡Œä½œä¸šé‡è§¦å‘</li>
<li>[x] ä½œä¸šåˆ†ç‰‡ç­–ç•¥</li>
<li>[x] ä½œä¸šå”¯ä¸€èŠ‚ç‚¹æ‰§è¡Œ</li>
<li>[ ] è‡ªè¯Šæ–­å¹¶ä¿®å¤åˆ†å¸ƒå¼ä¸ç¨³å®šé€ æˆçš„é—®é¢˜</li>
<li>[x] æ”¯æŒå¹¶è¡Œè°ƒåº¦</li>
<li>[ ] æ”¯æŒä½œä¸šç”Ÿå‘½å‘¨æœŸæ“ä½œ</li>
<li>[x] ä¸°å¯Œçš„ä½œä¸šç±»å‹</li>
<li>[ ] Springæ•´åˆä»¥åŠå‘½åç©ºé—´æä¾›</li>
<li>[ ] è¿ç»´å¹³å°</li>
<li>[ ] äº‹ä»¶è¿½è¸ª</li>
<li>[ ] DUMP ä½œä¸šè¿è¡Œä¿¡æ¯</li>
<li>[ ] ä½œä¸šç›‘å¬å™¨</li>
<li>[ ] åŸºäº Docker çš„è¿›ç¨‹éš”ç¦»ï¼ˆTBDï¼‰</li>
<li>[x] é«˜å¯ç”¨</li>
</ul>
<h2 id="XXL-JOB"><a href="#XXL-JOB" class="headerlink" title="XXL-JOB"></a>XXL-JOB</h2><p>åŸºäº V1.8ï¼Œä¼šé€æ¸å’Œ Elastic-Job åŠŸèƒ½åšå¯¹æ¯”</p>
<ul>
<li>[ ] 1ã€ç®€å•ï¼šæ”¯æŒé€šè¿‡Webé¡µé¢å¯¹ä»»åŠ¡è¿›è¡ŒCRUDæ“ä½œï¼Œæ“ä½œç®€å•ï¼Œä¸€åˆ†é’Ÿä¸Šæ‰‹ï¼›</li>
<li>[ ] 2ã€åŠ¨æ€ï¼šæ”¯æŒåŠ¨æ€ä¿®æ”¹ä»»åŠ¡çŠ¶æ€ã€æš‚åœ/æ¢å¤ä»»åŠ¡ï¼Œä»¥åŠç»ˆæ­¢è¿è¡Œä¸­ä»»åŠ¡ï¼Œå³æ—¶ç”Ÿæ•ˆï¼›</li>
<li>[ ] 3ã€è°ƒåº¦ä¸­å¿ƒHAï¼ˆä¸­å¿ƒå¼ï¼‰ï¼šè°ƒåº¦é‡‡ç”¨ä¸­å¿ƒå¼è®¾è®¡ï¼Œâ€œè°ƒåº¦ä¸­å¿ƒâ€åŸºäºé›†ç¾¤Quartzå®ç°ï¼Œå¯ä¿è¯è°ƒåº¦ä¸­å¿ƒHAï¼›</li>
<li>[ ] 4ã€æ‰§è¡Œå™¨HAï¼ˆåˆ†å¸ƒå¼ï¼‰ï¼šä»»åŠ¡åˆ†å¸ƒå¼æ‰§è¡Œï¼Œä»»åŠ¡â€æ‰§è¡Œå™¨â€æ”¯æŒé›†ç¾¤éƒ¨ç½²ï¼Œå¯ä¿è¯ä»»åŠ¡æ‰§è¡ŒHAï¼›</li>
<li>[ ] 5ã€ä»»åŠ¡Failoverï¼šæ‰§è¡Œå™¨é›†ç¾¤éƒ¨ç½²æ—¶ï¼Œä»»åŠ¡è·¯ç”±ç­–ç•¥é€‰æ‹©â€æ•…éšœè½¬ç§»â€æƒ…å†µä¸‹è°ƒåº¦å¤±è´¥æ—¶å°†ä¼šå¹³æ»‘åˆ‡æ¢æ‰§è¡Œå™¨è¿›è¡ŒFailoverï¼›</li>
<li>[ ] 6ã€ä¸€è‡´æ€§ï¼šâ€œè°ƒåº¦ä¸­å¿ƒâ€é€šè¿‡DBé”ä¿è¯é›†ç¾¤åˆ†å¸ƒå¼è°ƒåº¦çš„ä¸€è‡´æ€§, ä¸€æ¬¡ä»»åŠ¡è°ƒåº¦åªä¼šè§¦å‘ä¸€æ¬¡æ‰§è¡Œï¼›</li>
<li>[ ] 7ã€è‡ªå®šä¹‰ä»»åŠ¡å‚æ•°ï¼šæ”¯æŒåœ¨çº¿é…ç½®è°ƒåº¦ä»»åŠ¡å…¥å‚ï¼Œå³æ—¶ç”Ÿæ•ˆï¼›</li>
<li>[ ] 8ã€è°ƒåº¦çº¿ç¨‹æ± ï¼šè°ƒåº¦ç³»ç»Ÿå¤šçº¿ç¨‹è§¦å‘è°ƒåº¦è¿è¡Œï¼Œç¡®ä¿è°ƒåº¦ç²¾ç¡®æ‰§è¡Œï¼Œä¸è¢«å µå¡ï¼›</li>
<li>[ ] 9ã€å¼¹æ€§æ‰©å®¹ç¼©å®¹ï¼šä¸€æ—¦æœ‰æ–°æ‰§è¡Œå™¨æœºå™¨ä¸Šçº¿æˆ–è€…ä¸‹çº¿ï¼Œä¸‹æ¬¡è°ƒåº¦æ—¶å°†ä¼šé‡æ–°åˆ†é…ä»»åŠ¡ï¼›</li>
<li>[ ] 10ã€é‚®ä»¶æŠ¥è­¦ï¼šä»»åŠ¡å¤±è´¥æ—¶æ”¯æŒé‚®ä»¶æŠ¥è­¦ï¼Œæ”¯æŒé…ç½®å¤šé‚®ä»¶åœ°å€ç¾¤å‘æŠ¥è­¦é‚®ä»¶ï¼›</li>
<li>[ ] 11ã€çŠ¶æ€ç›‘æ§ï¼šæ”¯æŒå®æ—¶ç›‘æ§ä»»åŠ¡è¿›åº¦ï¼›</li>
<li>[ ] 12ã€Rollingæ‰§è¡Œæ—¥å¿—ï¼šæ”¯æŒåœ¨çº¿æŸ¥çœ‹è°ƒåº¦ç»“æœï¼Œå¹¶ä¸”æ”¯æŒä»¥Rollingæ–¹å¼å®æ—¶æŸ¥çœ‹æ‰§è¡Œå™¨è¾“å‡ºçš„å®Œæ•´çš„æ‰§è¡Œæ—¥å¿—ï¼›</li>
<li>[ ] 13ã€GLUEï¼šæä¾›Web IDEï¼Œæ”¯æŒåœ¨çº¿å¼€å‘ä»»åŠ¡é€»è¾‘ä»£ç ï¼ŒåŠ¨æ€å‘å¸ƒï¼Œå®æ—¶ç¼–è¯‘ç”Ÿæ•ˆï¼Œçœç•¥éƒ¨ç½²ä¸Šçº¿çš„è¿‡ç¨‹ã€‚æ”¯æŒ30ä¸ªç‰ˆæœ¬çš„å†å²ç‰ˆæœ¬å›æº¯ã€‚</li>
<li>[ ] 14ã€æ•°æ®åŠ å¯†ï¼šè°ƒåº¦ä¸­å¿ƒå’Œæ‰§è¡Œå™¨ä¹‹é—´çš„é€šè®¯è¿›è¡Œæ•°æ®åŠ å¯†ï¼Œæå‡è°ƒåº¦ä¿¡æ¯å®‰å…¨æ€§ï¼›</li>
<li>[ ] 15ã€ä»»åŠ¡ä¾èµ–ï¼šæ”¯æŒé…ç½®å­ä»»åŠ¡ä¾èµ–ï¼Œå½“çˆ¶ä»»åŠ¡æ‰§è¡Œç»“æŸä¸”æ‰§è¡ŒæˆåŠŸåå°†ä¼šä¸»åŠ¨è§¦å‘ä¸€æ¬¡å­ä»»åŠ¡çš„æ‰§è¡Œ, å¤šä¸ªå­ä»»åŠ¡ç”¨é€—å·åˆ†éš”ï¼›</li>
<li>[ ] 16ã€æ¨é€mavenä¸­å¤®ä»“åº“: å°†ä¼šæŠŠæœ€æ–°ç¨³å®šç‰ˆæ¨é€åˆ°mavenä¸­å¤®ä»“åº“, æ–¹ä¾¿ç”¨æˆ·æ¥å…¥å’Œä½¿ç”¨;</li>
<li>[ ] 17ã€ä»»åŠ¡æ³¨å†Œ: æ‰§è¡Œå™¨ä¼šå‘¨æœŸæ€§è‡ªåŠ¨æ³¨å†Œä»»åŠ¡, è°ƒåº¦ä¸­å¿ƒå°†ä¼šè‡ªåŠ¨å‘ç°æ³¨å†Œçš„ä»»åŠ¡å¹¶è§¦å‘æ‰§è¡Œã€‚åŒæ—¶ï¼Œä¹Ÿæ”¯æŒæ‰‹åŠ¨å½•å…¥æ‰§è¡Œå™¨åœ°å€ï¼›</li>
<li>[ ] 18ã€è·¯ç”±ç­–ç•¥ï¼šæ‰§è¡Œå™¨é›†ç¾¤éƒ¨ç½²æ—¶æä¾›ä¸°å¯Œçš„è·¯ç”±ç­–ç•¥ï¼ŒåŒ…æ‹¬ï¼šç¬¬ä¸€ä¸ªã€æœ€åä¸€ä¸ªã€è½®è¯¢ã€éšæœºã€ä¸€è‡´æ€§HASHã€æœ€ä¸ç»å¸¸ä½¿ç”¨ã€æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨ã€æ•…éšœè½¬ç§»ã€å¿™ç¢Œè½¬ç§»ç­‰ï¼›</li>
<li>[ ] 19ã€è¿è¡ŒæŠ¥è¡¨ï¼šæ”¯æŒå®æ—¶æŸ¥çœ‹è¿è¡Œæ•°æ®ï¼Œå¦‚ä»»åŠ¡æ•°é‡ã€è°ƒåº¦æ¬¡æ•°ã€æ‰§è¡Œå™¨æ•°é‡ç­‰ï¼›ä»¥åŠè°ƒåº¦æŠ¥è¡¨ï¼Œå¦‚è°ƒåº¦æ—¥æœŸåˆ†å¸ƒå›¾ï¼Œè°ƒåº¦æˆåŠŸåˆ†å¸ƒå›¾ç­‰ï¼›</li>
<li>[ ] 20ã€è„šæœ¬ä»»åŠ¡ï¼šæ”¯æŒä»¥GLUEæ¨¡å¼å¼€å‘å’Œè¿è¡Œè„šæœ¬ä»»åŠ¡ï¼ŒåŒ…æ‹¬Shellã€Pythonç­‰ç±»å‹è„šæœ¬;</li>
<li>[ ] 21ã€é˜»å¡å¤„ç†ç­–ç•¥ï¼šè°ƒåº¦è¿‡äºå¯†é›†æ‰§è¡Œå™¨æ¥ä¸åŠå¤„ç†æ—¶çš„å¤„ç†ç­–ç•¥ï¼Œç­–ç•¥åŒ…æ‹¬ï¼šå•æœºä¸²è¡Œï¼ˆé»˜è®¤ï¼‰ã€ä¸¢å¼ƒåç»­è°ƒåº¦ã€è¦†ç›–ä¹‹å‰è°ƒåº¦ï¼›</li>
<li>[ ] 22ã€å¤±è´¥å¤„ç†ç­–ç•¥ï¼›è°ƒåº¦å¤±è´¥æ—¶çš„å¤„ç†ç­–ç•¥ï¼Œç­–ç•¥åŒ…æ‹¬ï¼šå¤±è´¥å‘Šè­¦ï¼ˆé»˜è®¤ï¼‰ã€å¤±è´¥é‡è¯•ï¼›</li>
<li>[ ] 23ã€åˆ†ç‰‡å¹¿æ’­ä»»åŠ¡ï¼šæ‰§è¡Œå™¨é›†ç¾¤éƒ¨ç½²æ—¶ï¼Œä»»åŠ¡è·¯ç”±ç­–ç•¥é€‰æ‹©â€åˆ†ç‰‡å¹¿æ’­â€æƒ…å†µä¸‹ï¼Œä¸€æ¬¡ä»»åŠ¡è°ƒåº¦å°†ä¼šå¹¿æ’­è§¦å‘å¯¹åº”é›†ç¾¤ä¸­æ‰€æœ‰æ‰§è¡Œå™¨æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡ï¼ŒåŒæ—¶ä¼ é€’åˆ†ç‰‡å‚æ•°ï¼›å¯æ ¹æ®åˆ†ç‰‡å‚æ•°å¼€å‘åˆ†ç‰‡ä»»åŠ¡ï¼›</li>
<li>[ ] 24ã€åŠ¨æ€åˆ†ç‰‡ï¼šåˆ†ç‰‡å¹¿æ’­ä»»åŠ¡ä»¥æ‰§è¡Œå™¨ä¸ºç»´åº¦è¿›è¡Œåˆ†ç‰‡ï¼Œæ”¯æŒåŠ¨æ€æ‰©å®¹æ‰§è¡Œå™¨é›†ç¾¤ä»è€ŒåŠ¨æ€å¢åŠ åˆ†ç‰‡æ•°é‡ï¼ŒååŒè¿›è¡Œä¸šåŠ¡å¤„ç†ï¼›åœ¨è¿›è¡Œå¤§æ•°æ®é‡ä¸šåŠ¡æ“ä½œæ—¶å¯æ˜¾è‘—æå‡ä»»åŠ¡å¤„ç†èƒ½åŠ›å’Œé€Ÿåº¦ã€‚</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘&lt;/strong&gt;æœ‰ç¦
    
    </summary>
    
      <category term="Elastic-Job" scheme="http://www.yunai.me/categories/Elastic-Job/"/>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://www.yunai.me/Elastic-Job/x/"/>
    <id>http://www.yunai.me/Elastic-Job/x/</id>
    <published>2017-08-28T21:32:19.000Z</published>
    <updated>2017-08-28T21:32:19.000Z</updated>
    
    <content type="html"><![CDATA[<p>elastic-job-common-restful</p>
<ol>
<li>RestfulServer å†…åµŒæœåŠ¡</li>
<li>GSONProvider</li>
<li>RestfulExceptionMapper å¼‚å¸¸</li>
<li>WwwAuthFilter </li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;elastic-job-common-restful&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;RestfulServer å†…åµŒæœåŠ¡&lt;/li&gt;
&lt;li&gt;GSONProvider&lt;/li&gt;
&lt;li&gt;RestfulExceptionMapper å¼‚å¸¸&lt;/li&gt;
&lt;li&gt;WwwAuthFilte
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆäºŒï¼‰ä¹‹äº‹åŠ¡è¡¥å¿å‹</title>
    <link href="http://www.yunai.me/Sharding-JDBC/transaction-tcc/"/>
    <id>http://www.yunai.me/Sharding-JDBC/transaction-tcc/</id>
    <published>2017-08-21T16:00:00.000Z</published>
    <updated>2017-08-14T18:34:13.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<p>å å‘æ–‡ã€‚å…³æ³¨å…¬ä¼—å·ï¼Œç¬¬ä¸€æ—¶é—´è·å¾—æ›´æ–°é€šçŸ¥ã€‚<br>psï¼štcc æš‚æ—¶æœªå®ç°ï¼Œç›®å‰åœ¨ RoadMap ä¸­</p>
<hr>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘&lt;/strong&gt;æœ‰
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆä¸€ï¼‰ä¹‹æœ€å¤§åŠªåŠ›å‹</title>
    <link href="http://www.yunai.me/Sharding-JDBC/transaction-bed/"/>
    <id>http://www.yunai.me/Sharding-JDBC/transaction-bed/</id>
    <published>2017-08-19T16:00:00.000Z</published>
    <updated>2017-08-28T09:46:56.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. æœ€å¤§åŠªåŠ›é€è¾¾å‹</a></li>
<li><a href="#">3. æŸ”æ€§äº‹åŠ¡ç®¡ç†å™¨</a><ul>
<li><a href="#">3.1 æ¦‚å¿µ</a></li>
<li><a href="#">3.2 æŸ”æ€§äº‹åŠ¡é…ç½®</a></li>
<li><a href="#">3.3 æŸ”æ€§äº‹åŠ¡</a><ul>
<li><a href="#">3.3.1 åˆ›å»ºæŸ”æ€§äº‹åŠ¡</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#">4. äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨</a><ul>
<li><a href="#">4.1 #add()</a></li>
<li><a href="#">4.2 #remove()</a></li>
<li><a href="#">4.3 #findEligibleTransactionLogs()</a></li>
<li><a href="#">4.4 #increaseAsyncDeliveryTryTimes()</a></li>
<li><a href="#">4.5 #processData()</a></li>
</ul>
</li>
<li><a href="#">5. æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨</a></li>
<li><a href="#">6. æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š</a><ul>
<li><a href="#">6.1 BestEffortsDeliveryJob</a></li>
<li><a href="#">6.2 AsyncSoftTransactionJobConfiguration</a></li>
<li><a href="#">6.3 Elastic-Job æ˜¯å¦å¿…é¡»ï¼Ÿ</a></li>
</ul>
</li>
<li><a href="#">7. é€‚ç”¨åœºæ™¯</a></li>
<li><a href="#">8. å¼€å‘æŒ‡å— &amp; å¼€å‘ç¤ºä¾‹</a></li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æ•°æ®åº“è¡¨<strong>åˆ†åº“</strong>åï¼Œä¸šåŠ¡åœºæ™¯ä¸‹çš„<strong>å•åº“æœ¬åœ°äº‹åŠ¡</strong>å¯èƒ½å˜æˆ<strong>è·¨åº“åˆ†å¸ƒå¼äº‹åŠ¡</strong>ã€‚è™½ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆé€‚çš„<strong>åˆ†åº“è§„åˆ™</strong>è®©æ“ä½œçš„æ•°æ®åœ¨åŒåº“ä¸‹ï¼Œç»§ç»­ä¿è¯<strong>å•åº“æœ¬åœ°äº‹åŠ¡</strong>ï¼Œè¿™ä¹Ÿæ˜¯éå¸¸æ¨å´‡çš„ï¼Œä½†ä¸æ˜¯æ‰€æœ‰åœºæ™¯ä¸‹éƒ½èƒ½é€‚ç”¨ã€‚å¦‚æœè¿™äº›åœºæ™¯å¯¹äº‹åŠ¡çš„ä¸€è‡´æ€§æœ‰è¦æ±‚ï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡çš„â€œéº»çƒ¦â€ã€‚</p>
<p><strong>åˆ†å¸ƒå¼äº‹åŠ¡</strong>æ˜¯ä¸ªå¾ˆå¤§çš„è¯é¢˜ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ Sharding-JDBC å¯¹å¥¹çš„æƒè¡¡ï¼š</p>
<blockquote>
<p>Sharding-JDBCç”±äºæ€§èƒ½æ–¹é¢çš„è€ƒé‡ï¼Œå†³å®šä¸æ”¯æŒå¼ºä¸€è‡´æ€§åˆ†å¸ƒå¼äº‹åŠ¡ã€‚æˆ‘ä»¬å·²æ˜ç¡®è§„åˆ’çº¿è·¯å›¾ï¼Œæœªæ¥ä¼šæ”¯æŒæœ€ç»ˆä¸€è‡´æ€§çš„æŸ”æ€§äº‹åŠ¡ã€‚</p>
</blockquote>
<p>Sharding-JDBC æä¾›äº†ä¸¤ç§ <strong>æŸ”æ€§äº‹åŠ¡</strong>ï¼š</p>
<ul>
<li>æœ€å¤§åŠªåŠ›é€è¾¾å‹ BED ï¼šå·²ç»å®ç°</li>
<li>äº‹åŠ¡è¡¥å¿å‹ TCC ï¼šè®¡åˆ’ä¸­</li>
</ul>
<p><strong>æœ¬æ–‡åˆ†äº« æœ€å¤§åŠªåŠ›é€è¾¾å‹ çš„å®ç°</strong>ã€‚å»ºè®®å‰ç½®é˜…è¯»ï¼š<a href="http://www.yunai.me/Sharding-JDBC/sql-execute/?self">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œã€‹</a>ã€‚</p>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1 id="2-æœ€å¤§åŠªåŠ›é€è¾¾å‹"><a href="#2-æœ€å¤§åŠªåŠ›é€è¾¾å‹" class="headerlink" title="2. æœ€å¤§åŠªåŠ›é€è¾¾å‹"></a>2. æœ€å¤§åŠªåŠ›é€è¾¾å‹</h1><p><strong>æ¦‚å¿µ</strong></p>
<blockquote>
<p>åœ¨åˆ†å¸ƒå¼æ•°æ®åº“çš„åœºæ™¯ä¸‹ï¼Œç›¸ä¿¡å¯¹äºè¯¥æ•°æ®åº“çš„æ“ä½œæœ€ç»ˆä¸€å®šå¯ä»¥æˆåŠŸï¼Œæ‰€ä»¥é€šè¿‡æœ€å¤§åŠªåŠ›åå¤å°è¯•é€è¾¾æ“ä½œã€‚</p>
</blockquote>
<p>ä»æ¦‚å¿µçœ‹ï¼Œå¯èƒ½ä¸æ˜¯å¾ˆç›´ç™½çš„ç†è§£æ˜¯ä»€ä¹ˆæ„æ€ï¼Œæœ¬æ–‡ä¼š<strong>æœ€å¤§åŠªåŠ›</strong>è®©ä½ å¹²å‡€ç†è§£ã€‚</p>
<p><strong>æ¶æ„å›¾</strong></p>
<blockquote>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_20/01.jpeg" alt=""></p>
</blockquote>
<p>æ‰§è¡Œè¿‡ç¨‹æœ‰ <strong>å››ç§</strong> æƒ…å†µï¼š</p>
<ol>
<li>ã€çº¢çº¿ã€‘æ‰§è¡ŒæˆåŠŸ</li>
<li>ã€æ£•çº¿ã€‘æ‰§è¡Œå¤±è´¥ï¼ŒåŒæ­¥é‡è¯•æˆåŠŸ</li>
<li>ã€ç²‰çº¿ã€‘æ‰§è¡Œå¤±è´¥ï¼ŒåŒæ­¥é‡è¯•å¤±è´¥ï¼Œå¼‚æ­¥é‡è¯•æˆåŠŸ</li>
<li>ã€ç»¿çº¿ã€‘æ‰§è¡Œå¤±è´¥ï¼ŒåŒæ­¥é‡è¯•å¤±è´¥ï¼Œå¼‚æ­¥é‡è¯•å¤±è´¥ï¼Œäº‹åŠ¡æ—¥å¿—ä¿ç•™</li>
</ol>
<p>æ•´ä½“æˆæ¼æ–—å€’ä¸‰è§’ï¼Œä¸Šä¸€ä¸ªé˜¶æ®µå¤±è´¥ï¼Œäº¤ç»™ä¸‹ä¸€ä¸ªé˜¶æ®µé‡è¯•ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_20/02.png" alt=""></p>
<p>æ•´ä¸ªè¿‡ç¨‹é€šè¿‡å¦‚ä¸‹ <strong>ç»„ä»¶</strong> å®Œæˆï¼š</p>
<ul>
<li>æŸ”æ€§äº‹åŠ¡ç®¡ç†å™¨</li>
<li>æœ€å¤§åŠªåŠ›é€è¾¾å‹æŸ”æ€§äº‹åŠ¡</li>
<li>æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨</li>
<li>äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨</li>
<li>æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š</li>
</ul>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬é€èŠ‚åˆ†äº«æ¯ä¸ªç»„ä»¶ã€‚</p>
<h1 id="3-æŸ”æ€§äº‹åŠ¡ç®¡ç†å™¨"><a href="#3-æŸ”æ€§äº‹åŠ¡ç®¡ç†å™¨" class="headerlink" title="3. æŸ”æ€§äº‹åŠ¡ç®¡ç†å™¨"></a>3. æŸ”æ€§äº‹åŠ¡ç®¡ç†å™¨</h1><h2 id="3-1-æ¦‚å¿µ"><a href="#3-1-æ¦‚å¿µ" class="headerlink" title="3.1 æ¦‚å¿µ"></a>3.1 æ¦‚å¿µ</h2><p>æŸ”æ€§äº‹åŠ¡ç®¡ç†å™¨ï¼ŒSoftTransactionManager å®ç°ï¼Œè´Ÿè´£å¯¹æŸ”æ€§äº‹åŠ¡é…ç½®( SoftTransactionConfiguration ) ã€æŸ”æ€§äº‹åŠ¡( AbstractSoftTransaction )çš„ç®¡ç†ã€‚</p>
<h2 id="3-2-æŸ”æ€§äº‹åŠ¡é…ç½®"><a href="#3-2-æŸ”æ€§äº‹åŠ¡é…ç½®" class="headerlink" title="3.2 æŸ”æ€§äº‹åŠ¡é…ç½®"></a>3.2 æŸ”æ€§äº‹åŠ¡é…ç½®</h2><p>è°ƒç”¨ <code>#init()</code> åˆå§‹åŒ–æŸ”æ€§ç®¡ç†å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SoftTransactionManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æŸ”æ€§äº‹åŠ¡é…ç½®å¯¹è±¡</div><div class="line">*/</div><div class="line"><span class="meta">@Getter</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> SoftTransactionConfiguration transactionConfig;  </div><div class="line"></div><div class="line"><span class="comment">// SoftTransactionManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆå§‹åŒ–äº‹åŠ¡ç®¡ç†å™¨.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="comment">// åˆå§‹åŒ– æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨</span></div><div class="line">   EventBusInstance.getInstance().register(<span class="keyword">new</span> BestEffortsDeliveryListener());</div><div class="line">   <span class="comment">// åˆå§‹åŒ– äº‹åŠ¡æ—¥å¿—æ•°æ®åº“å­˜å‚¨è¡¨</span></div><div class="line">   <span class="keyword">if</span> (TransactionLogDataSourceType.RDB == transactionConfig.getStorageType()) &#123;</div><div class="line">       Preconditions.checkNotNull(transactionConfig.getTransactionLogDataSource());</div><div class="line">       createTable();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// åˆå§‹åŒ– å†…åµŒçš„æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š</span></div><div class="line">   <span class="keyword">if</span> (transactionConfig.getBestEffortsDeliveryJobConfiguration().isPresent()) &#123;</div><div class="line">       <span class="keyword">new</span> NestedBestEffortsDeliveryJobFactory(transactionConfig).init();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å°†æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨( BestEffortsDeliveryListener )æ³¨å†Œåˆ°äº‹åŠ¡æ€»çº¿ ( EventBus )ã€‚åœ¨ã€æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨ã€å°èŠ‚ä¼šè¯¦ç»†åˆ†äº«</li>
<li>å½“ä½¿ç”¨<strong>æ•°æ®åº“</strong>å­˜å‚¨äº‹åŠ¡æ—¥å¿—( TransactionLog ) æ—¶ï¼Œè‹¥<strong>äº‹åŠ¡æ—¥å¿—è¡¨( <code>transaction_log</code> )</strong>ä¸å­˜åœ¨åˆ™è¿›è¡Œåˆ›å»ºã€‚åœ¨ã€äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨ã€å°èŠ‚ä¼šè¯¦ç»†åˆ†äº«</li>
<li>å½“é…ç½®ä½¿ç”¨<strong>å†…åµŒçš„</strong>æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š( NestedBestEffortsDeliveryJob ) æ—¶ï¼Œè¿›è¡Œåˆå§‹åŒ–ã€‚åœ¨ã€æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸šã€å°èŠ‚ä¼šè¯¦ç»†åˆ†äº«</li>
</ul>
<p><strong>SoftTransactionConfiguration</strong></p>
<p>SoftTransactionConfigurationï¼ŒæŸ”æ€§äº‹åŠ¡é…ç½®å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SoftTransactionConfiguration</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * äº‹åŠ¡ç®¡ç†å™¨ç®¡ç†çš„æ•°æ®æº.</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span>(AccessLevel.NONE)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource targetDataSource;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åŒæ­¥çš„äº‹åŠ¡é€è¾¾çš„æœ€å¤§å°è¯•æ¬¡æ•°.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> syncMaxDeliveryTryTimes = <span class="number">3</span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * äº‹åŠ¡æ—¥å¿—å­˜å‚¨ç±»å‹.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> TransactionLogDataSourceType storageType = RDB;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å­˜å‚¨äº‹åŠ¡æ—¥å¿—çš„æ•°æ®æº.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> DataSource transactionLogDataSource;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å†…åµŒçš„æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸šé…ç½®å¯¹è±¡.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Optional&lt;NestedBestEffortsDeliveryJobConfiguration&gt; bestEffortsDeliveryJobConfiguration = Optional.absent();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-3-æŸ”æ€§äº‹åŠ¡"><a href="#3-3-æŸ”æ€§äº‹åŠ¡" class="headerlink" title="3.3 æŸ”æ€§äº‹åŠ¡"></a>3.3 æŸ”æ€§äº‹åŠ¡</h2><p>åœ¨ Sharding-JDBC é‡Œï¼Œç›®å‰æŸ”æ€§äº‹åŠ¡åˆ†æˆä¸¤ç§ï¼š</p>
<ul>
<li>BEDSoftTransaction ï¼šæœ€å¤§åŠªåŠ›é€è¾¾å‹æŸ”æ€§äº‹åŠ¡</li>
<li>TCCSoftTransaction ï¼šTCCå‹æŸ”æ€§äº‹åŠ¡</li>
</ul>
<p><strong>ç»§æ‰¿ AbstractSoftTransaction</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractSoftTransaction</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ†ç‰‡è¿æ¥åŸè‡ªåŠ¨æäº¤çŠ¶æ€</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> previousAutoCommit;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ†ç‰‡è¿æ¥</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> ShardingConnection connection;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * äº‹åŠ¡ç±»å‹</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> SoftTransactionType transactionType;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * äº‹åŠ¡ç¼–å·</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> String transactionId;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AbstractSoftTransaction å®ç°äº†å¼€å¯æŸ”æ€§äº‹åŠ¡ã€å…³é—­æŸ”æ€§äº‹åŠ¡ä¸¤ä¸ªæ–¹æ³•æä¾›ç»™å­ç±»è°ƒç”¨ï¼š</p>
<ul>
<li><p><code>#beginInternal()</code></p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* å¼€å¯æŸ”æ€§</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> conn åˆ†ç‰‡è¿æ¥</div><div class="line">* <span class="doctag">@param</span> type äº‹åŠ¡ç±»å‹</div><div class="line">* <span class="doctag">@throws</span> SQLException</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">beginInternal</span><span class="params">(<span class="keyword">final</span> Connection conn, <span class="keyword">final</span> SoftTransactionType type)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="comment">// TODO åˆ¤æ–­å¦‚æœåœ¨ä¼ ç»Ÿäº‹åŠ¡ä¸­ï¼Œåˆ™æŠ›å¼‚å¸¸</span></div><div class="line">   Preconditions.checkArgument(conn <span class="keyword">instanceof</span> ShardingConnection, <span class="string">"Only ShardingConnection can support eventual consistency transaction."</span>);</div><div class="line">   <span class="comment">// è®¾ç½®æ‰§è¡Œé”™è¯¯ï¼Œä¸æŠ›å‡ºå¼‚å¸¸</span></div><div class="line">   ExecutorExceptionHandler.setExceptionThrown(<span class="keyword">false</span>);</div><div class="line">   connection = (ShardingConnection) conn;</div><div class="line">   transactionType = type;</div><div class="line">   <span class="comment">// è®¾ç½®è‡ªåŠ¨æäº¤çŠ¶æ€</span></div><div class="line">   previousAutoCommit = connection.getAutoCommit();</div><div class="line">   connection.setAutoCommit(<span class="keyword">true</span>);</div><div class="line">   <span class="comment">// ç”Ÿæˆäº‹åŠ¡ç¼–å·</span></div><div class="line">   <span class="comment">// TODO æ›¿æ¢UUIDä¸ºæ›´æœ‰æ•ˆç‡çš„idç”Ÿæˆå™¨</span></div><div class="line">   transactionId = UUID.randomUUID().toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>ExecutorExceptionHandler.setExceptionThrown(false)</code> è®¾ç½®æ‰§è¡Œ SQL é”™è¯¯æ—¶ï¼Œä¹Ÿä¸æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<ul>
<li>å¯¹å¼‚å¸¸å¤„ç†çš„ä»£ç ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/884b38f4c2402e31464d15b444f4b405e07fe211/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/executor/threadlocal/ExecutorExceptionHandler.java#L59" rel="external nofollow noopener noreferrer" target="_blank">ExecutorExceptionHandler#setExceptionThrown()</a> </li>
<li>å¯¹äºå…¶ä»– SQLï¼Œä¸ä¼šå› ä¸º SQL é”™è¯¯ä¸æ‰§è¡Œï¼Œä¼šç»§ç»­æ‰§è¡Œ</li>
<li>å¯¹äºä¸Šå±‚ä¸šåŠ¡ï¼Œä¸ä¼šå› ä¸º SQL é”™è¯¯ç»ˆæ­¢é€»è¾‘ï¼Œä¼šç»§ç»­æ‰§è¡Œã€‚è¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ä¸‹ï¼Œä¸Šå±‚ä¸šåŠ¡ä¸èƒ½å¯¹è¯¥ SQL æ‰§è¡Œç»“æœæœ‰å¼ºä¾èµ–ï¼Œå› ä¸º SQL é”™è¯¯éœ€è¦é‡è¯•è¾¾åˆ°æ•°æ®æœ€ç»ˆä¸€è‡´æ€§</li>
<li>å¯¹äº<strong>æœ€å¤§åŠªåŠ›å‹äº‹åŠ¡</strong>( TCCæš‚æœªå®ç° )ï¼Œä¼šå¯¹æ‰§è¡Œé”™è¯¯çš„ SQL è¿›è¡Œé‡è¯•</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>connection.setAutoCommit(true);</code>ï¼Œè®¾ç½®æ‰§è¡Œè‡ªåŠ¨æäº¤ã€‚<strong>ä½¿ç”¨æœ€å¤§åŠªåŠ›å‹äº‹åŠ¡æ—¶ï¼Œä¸Šå±‚ä¸šåŠ¡æ‰§è¡Œ SQL ä¼šé©¬ä¸Šæäº¤ï¼Œå³ä½¿è°ƒç”¨  <code>Connection#rollback()</code> ä¹Ÿæ˜¯æ— æ³•å›æ»šçš„ï¼Œè¿™ç‚¹ä¸€å®šè¦æ³¨æ„ã€‚</strong></p>
</li>
</ul>
</li>
<li><p><code>#end()</code></p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* ç»“æŸæŸ”æ€§äº‹åŠ¡.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">  <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</div><div class="line">      ExecutorExceptionHandler.setExceptionThrown(<span class="keyword">true</span>);</div><div class="line">      connection.setAutoCommit(previousAutoCommit);</div><div class="line">      SoftTransactionManager.closeCurrentTransactionManager();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">// SoftTransactionManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å…³é—­å½“å‰çš„æŸ”æ€§äº‹åŠ¡ç®¡ç†å™¨.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">closeCurrentTransactionManager</span><span class="params">()</span> </span>&#123;</div><div class="line">   ExecutorDataMap.getDataMap().put(TRANSACTION, <span class="keyword">null</span>);</div><div class="line">   ExecutorDataMap.getDataMap().put(TRANSACTION_CONFIG, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>äº‹åŠ¡ç»“æŸåï¼Œä¸€å®šè¦è®°å¾—è°ƒç”¨ <code>#end()</code> æ¸…ç†çº¿ç¨‹å˜é‡ã€‚å¦åˆ™ï¼Œä¸‹æ¬¡è¯·æ±‚ä½¿ç”¨åˆ°è¯¥çº¿ç¨‹ï¼Œä¼šç»§ç»­åœ¨è¿™ä¸ªæŸ”æ€§äº‹åŠ¡å†…ã€‚</li>
</ul>
</li>
</ul>
<p><strong>BEDSoftTransaction</strong>    </p>
<p>BEDSoftTransactionï¼Œæœ€å¤§åŠªåŠ›é€è¾¾å‹æŸ”æ€§äº‹åŠ¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BEDSoftTransaction</span> <span class="keyword">extends</span> <span class="title">AbstractSoftTransaction</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¼€å¯æŸ”æ€§äº‹åŠ¡.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> connection æ•°æ®åº“è¿æ¥å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">(<span class="keyword">final</span> Connection connection)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        beginInternal(connection, SoftTransactionType.BestEffortsDelivery);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>TCCSoftTransaction</strong></p>
<p>TCCSoftTransactionï¼ŒTCC å‹æŸ”æ€§äº‹åŠ¡ï¼Œæš‚æœªå®ç°ã€‚å®ç°åï¼Œä¼šæ›´æ–°åˆ° <a href="http://www.yunai.me/Sharding-JDBC/transaction-tcc/?self">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆäºŒï¼‰ä¹‹äº‹åŠ¡è¡¥å¿å‹ã€‹</a>ã€‚</p>
<hr>
<h3 id="3-3-1-åˆ›å»ºæŸ”æ€§äº‹åŠ¡"><a href="#3-3-1-åˆ›å»ºæŸ”æ€§äº‹åŠ¡" class="headerlink" title="3.3.1 åˆ›å»ºæŸ”æ€§äº‹åŠ¡"></a>3.3.1 åˆ›å»ºæŸ”æ€§äº‹åŠ¡</h3><p>é€šè¿‡è°ƒç”¨ <code>SoftTransactionManager#getTransaction()</code> åˆ›å»ºæŸ”æ€§äº‹åŠ¡å¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* &#123;<span class="doctag">@link</span> ExecutorDataMap#dataMap&#125; æŸ”æ€§äº‹åŠ¡å¯¹è±¡ key</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRANSACTION = <span class="string">"transaction"</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line">* &#123;<span class="doctag">@link</span> ExecutorDataMap#dataMap&#125; æŸ”æ€§äº‹åŠ¡é…ç½® key</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRANSACTION_CONFIG = <span class="string">"transactionConfig"</span>;</div><div class="line"></div><div class="line"><span class="comment">// SoftTransactionManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ›å»ºæŸ”æ€§äº‹åŠ¡.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> type æŸ”æ€§äº‹åŠ¡ç±»å‹</div><div class="line">* <span class="doctag">@return</span> æŸ”æ€§äº‹åŠ¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> AbstractSoftTransaction <span class="title">getTransaction</span><span class="params">(<span class="keyword">final</span> SoftTransactionType type)</span> </span>&#123;</div><div class="line">   AbstractSoftTransaction result;</div><div class="line">   <span class="keyword">switch</span> (type) &#123;</div><div class="line">       <span class="keyword">case</span> BestEffortsDelivery: </div><div class="line">           result = <span class="keyword">new</span> BEDSoftTransaction();</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> TryConfirmCancel:</div><div class="line">           result = <span class="keyword">new</span> TCCSoftTransaction();</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">default</span>: </div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(type.toString());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// TODO ç›®å‰ä½¿ç”¨ä¸æ”¯æŒåµŒå¥—äº‹åŠ¡ï¼Œä»¥åè¿™é‡Œéœ€è¦å¯é…ç½®</span></div><div class="line">   <span class="keyword">if</span> (getCurrentTransaction().isPresent()) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support nested transaction."</span>);</div><div class="line">   &#125;</div><div class="line">   ExecutorDataMap.getDataMap().put(TRANSACTION, result);</div><div class="line">   ExecutorDataMap.getDataMap().put(TRANSACTION_CONFIG, transactionConfig);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>åç»­å¯ä»¥ä» <a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/884b38f4c2402e31464d15b444f4b405e07fe211/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/executor/threadlocal/ExecutorDataMap.java" rel="external nofollow noopener noreferrer" target="_blank">ExecutorDataMap</a> ä¸­è·å–å½“å‰çº¿ç¨‹çš„æŸ”æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡é…ç½®ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SoftTransactionManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–å½“å‰çº¿ç¨‹çš„æŸ”æ€§äº‹åŠ¡é…ç½®.</div><div class="line">* </div><div class="line">* <span class="doctag">@return</span> å½“å‰çº¿ç¨‹çš„æŸ”æ€§äº‹åŠ¡é…ç½®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Optional&lt;SoftTransactionConfiguration&gt; <span class="title">getCurrentTransactionConfiguration</span><span class="params">()</span> </span>&#123;</div><div class="line">   Object transactionConfig = ExecutorDataMap.getDataMap().get(TRANSACTION_CONFIG);</div><div class="line">   <span class="keyword">return</span> (<span class="keyword">null</span> == transactionConfig)</div><div class="line">           ? Optional.&lt;SoftTransactionConfiguration&gt;absent()</div><div class="line">           : Optional.of((SoftTransactionConfiguration) transactionConfig);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–å½“å‰çš„æŸ”æ€§äº‹åŠ¡.</div><div class="line">* </div><div class="line">* <span class="doctag">@return</span> å½“å‰çš„æŸ”æ€§äº‹åŠ¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Optional&lt;AbstractSoftTransaction&gt; <span class="title">getCurrentTransaction</span><span class="params">()</span> </span>&#123;</div><div class="line">   Object transaction = ExecutorDataMap.getDataMap().get(TRANSACTION);</div><div class="line">   <span class="keyword">return</span> (<span class="keyword">null</span> == transaction)</div><div class="line">           ? Optional.&lt;AbstractSoftTransaction&gt;absent()</div><div class="line">           : Optional.of((AbstractSoftTransaction) transaction);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="4-äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨"><a href="#4-äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨" class="headerlink" title="4. äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨"></a>4. äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨</h1><p>æŸ”æ€§äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šé€šè¿‡äº‹åŠ¡æ—¥å¿—( TransactionLog ) è®°å½•æ¯æ¡ SQL æ‰§è¡ŒçŠ¶æ€ï¼š</p>
<ul>
<li>SQL æ‰§è¡Œå‰ï¼Œè®°å½•ä¸€æ¡äº‹åŠ¡æ—¥å¿—</li>
<li>SQL æ‰§è¡ŒæˆåŠŸï¼Œç§»é™¤å¯¹åº”çš„äº‹åŠ¡æ—¥å¿— </li>
</ul>
<p>é€šè¿‡å®ç°äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨æ¥å£( TransactionLogStorage )ï¼Œæä¾›å­˜å‚¨åŠŸèƒ½ã€‚ç›®å‰æœ‰ä¸¤ç§å®ç°ï¼š</p>
<ul>
<li>MemoryTransactionLogStorage ï¼šåŸºäº<strong>å†…å­˜</strong>çš„äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨ã€‚ä¸»è¦ç”¨äºå¼€å‘æµ‹è¯•ï¼Œ<strong>ç”Ÿäº§ç¯å¢ƒä¸‹ä¸è¦ä½¿ç”¨</strong>ã€‚</li>
<li>RdbTransactionLogStorage ï¼šåŸºäº<strong>æ•°æ®åº“</strong>çš„äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨ã€‚</li>
</ul>
<p>æœ¬èŠ‚åªåˆ†æ RdbTransactionLogStorageã€‚å¯¹ <a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/884b38f4c2402e31464d15b444f4b405e07fe211/sharding-jdbc-transaction-parent/sharding-jdbc-transaction-storage/src/main/java/com/dangdang/ddframe/rdb/transaction/soft/storage/impl/RdbTransactionLogStorage.java" rel="external nofollow noopener noreferrer" target="_blank">MemoryTransactionLogStorage</a> æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç‚¹å‡»é“¾æ¥ä¼ é€åˆ°è¾¾ã€‚</p>
<p><strong>TransactionLogStorage æœ‰äº”ä¸ªæ¥å£æ–¹æ³•ï¼Œä¸‹æ–‡æ¯ä¸ªå°æ ‡é¢˜éƒ½æ˜¯ä¸€ä¸ªæ–¹æ³•ã€‚</strong></p>
<h2 id="4-1-add"><a href="#4-1-add" class="headerlink" title="4.1 #add()"></a>4.1 #add()</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionLogStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å­˜å‚¨äº‹åŠ¡æ—¥å¿—.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> transactionLog äº‹åŠ¡æ—¥å¿—</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(TransactionLog transactionLog)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">// RdbTransactionLogStorage.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> TransactionLog transactionLog)</span> </span>&#123;</div><div class="line">   String sql = <span class="string">"INSERT INTO `transaction_log` (`id`, `transaction_type`, `data_source`, `sql`, `parameters`, `creation_time`) VALUES (?, ?, ?, ?, ?, ?);"</span>;</div><div class="line">   <span class="keyword">try</span> (</div><div class="line">    <span class="comment">// ... çœç•¥ä½ ç†Ÿæ‚‰çš„ä»£ç </span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> TransactionLogStorageException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>æ³¨æ„</strong>ï¼šå¦‚æœæ’å…¥äº‹åŠ¡æ—¥å¿—<strong>å¤±è´¥</strong>ï¼ŒSQL ä¼šç»§ç»­æ‰§è¡Œï¼Œå¦‚æœæ­¤æ—¶ SQL æ‰§è¡Œå¤±è´¥ï¼Œåˆ™è¯¥ SQL ä¼šä¸è§äº†ã€‚å»ºè®®ï¼š<code>#add()</code> å’Œä¸‹æ–‡çš„ <code>#remove()</code> å¼‚å¸¸æ—¶ï¼Œéƒ½æ‰“å°ä¸‹å¼‚å¸¸æ—¥å¿—éƒ½æ–‡ä»¶ç³»ç»Ÿ</li>
</ul>
<p>TransactionLog (transaction_log) æ•°æ®åº“è¡¨ç»“æ„å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>åå­—</th>
<th>æ•°æ®åº“ç±»å‹</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>äº‹ä»¶ç¼–å·</td>
<td>VARCHAR(40)</td>
<td>EventBus äº‹ä»¶ç¼–å·ï¼Œ<strong>éäº‹åŠ¡ç¼–å·</strong></td>
</tr>
<tr>
<td>transaction_type</td>
<td>æŸ”æ€§äº‹åŠ¡ç±»å‹</td>
<td>VARCHAR(30)</td>
</tr>
<tr>
<td>data_source</td>
<td>çœŸå®æ•°æ®æºå</td>
<td>VARCHAR(255)</td>
<td></td>
</tr>
<tr>
<td>sql</td>
<td>æ‰§è¡Œ SQL</td>
<td>TEXT</td>
<td>å·²ç»æ”¹å†™è¿‡çš„ SQL</td>
</tr>
<tr>
<td>parameters</td>
<td>å ä½ç¬¦å‚æ•°</td>
<td>TEXT</td>
<td>JSON å­—ç¬¦ä¸²å­˜å‚¨</td>
</tr>
<tr>
<td>creation_time</td>
<td>è®°å½•æ—¶é—´</td>
<td>LONG</td>
</tr>
<tr>
<td>async_delivery_try_times</td>
<td>å·²å¼‚æ­¥é‡è¯•æ¬¡æ•°</td>
<td>INT</td>
</tr>
</tbody>
</table>
<h2 id="4-2-remove"><a href="#4-2-remove" class="headerlink" title="4.2 #remove()"></a>4.2 #remove()</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionLogStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">*Â æ ¹æ®ä¸»é”®åˆ é™¤äº‹åŠ¡æ—¥å¿—.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> id äº‹åŠ¡æ—¥å¿—ä¸»é”®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(String id)</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">// RdbTransactionLogStorage.java    </span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> String id)</span> </span>&#123;</div><div class="line">   String sql = <span class="string">"DELETE FROM `transaction_log` WHERE `id`=?;"</span>;</div><div class="line">   <span class="keyword">try</span> (</div><div class="line">          <span class="comment">// ... çœç•¥ä½ ç†Ÿæ‚‰çš„ä»£ç </span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> TransactionLogStorageException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-3-findEligibleTransactionLogs"><a href="#4-3-findEligibleTransactionLogs" class="headerlink" title="4.3 #findEligibleTransactionLogs()"></a>4.3 #findEligibleTransactionLogs()</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionLogStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è¯»å–éœ€è¦å¤„ç†çš„äº‹åŠ¡æ—¥å¿—.</div><div class="line">* </div><div class="line">* &lt;p&gt;éœ€è¦å¤„ç†çš„äº‹åŠ¡æ—¥å¿—ä¸º: &lt;/p&gt;</div><div class="line">* &lt;p&gt;1. å¼‚æ­¥å¤„ç†æ¬¡æ•°å°äºæœ€å¤§å¤„ç†æ¬¡æ•°.&lt;/p&gt;</div><div class="line">* &lt;p&gt;2. å¼‚æ­¥å¤„ç†çš„äº‹åŠ¡æ—¥å¿—æ—©äºå¼‚æ­¥å¤„ç†çš„é—´éš”æ—¶é—´.&lt;/p&gt;</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> size è·å–æ—¥å¿—çš„æ•°é‡</div><div class="line">* <span class="doctag">@param</span> maxDeliveryTryTimes äº‹åŠ¡é€è¾¾çš„æœ€å¤§å°è¯•æ¬¡æ•°</div><div class="line">* <span class="doctag">@param</span> maxDeliveryTryDelayMillis æ‰§è¡Œé€è¾¾äº‹åŠ¡çš„å»¶è¿Ÿæ¯«ç§’æ•°.</div><div class="line">*/</div><div class="line"><span class="function">List&lt;TransactionLog&gt; <span class="title">findEligibleTransactionLogs</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> maxDeliveryTryTimes, <span class="keyword">long</span> maxDeliveryTryDelayMillis)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">// RdbTransactionLogStorage.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;TransactionLog&gt; <span class="title">findEligibleTransactionLogs</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> size, <span class="keyword">final</span> <span class="keyword">int</span> maxDeliveryTryTimes, <span class="keyword">final</span> <span class="keyword">long</span> maxDeliveryTryDelayMillis)</span> </span>&#123;</div><div class="line">   List&lt;TransactionLog&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(size);</div><div class="line">   String sql = <span class="string">"SELECT `id`, `transaction_type`, `data_source`, `sql`, `parameters`, `creation_time`, `async_delivery_try_times` "</span></div><div class="line">       + <span class="string">"FROM `transaction_log` WHERE `async_delivery_try_times`&lt;? AND `transaction_type`=? AND `creation_time`&lt;? LIMIT ?;"</span>;</div><div class="line">   <span class="keyword">try</span> (Connection conn = dataSource.getConnection()) &#123;</div><div class="line">       <span class="comment">// ... çœç•¥ä½ ç†Ÿæ‚‰çš„ä»£ç </span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> TransactionLogStorageException(ex);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-4-increaseAsyncDeliveryTryTimes"><a href="#4-4-increaseAsyncDeliveryTryTimes" class="headerlink" title="4.4 #increaseAsyncDeliveryTryTimes()"></a>4.4 #increaseAsyncDeliveryTryTimes()</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionLogStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å¢åŠ äº‹åŠ¡æ—¥å¿—å¼‚æ­¥é‡è¯•æ¬¡æ•°.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> id äº‹åŠ¡ä¸»é”®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">increaseAsyncDeliveryTryTimes</span><span class="params">(String id)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">// RdbTransactionLogStorage.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increaseAsyncDeliveryTryTimes</span><span class="params">(<span class="keyword">final</span> String id)</span> </span>&#123;</div><div class="line">   String sql = <span class="string">"UPDATE `transaction_log` SET `async_delivery_try_times`=`async_delivery_try_times`+1 WHERE `id`=?;"</span>;</div><div class="line">   <span class="keyword">try</span> (</div><div class="line">       <span class="comment">// ... çœç•¥ä½ ç†Ÿæ‚‰çš„ä»£ç </span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> TransactionLogStorageException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-5-processData"><a href="#4-5-processData" class="headerlink" title="4.5 #processData()"></a>4.5 #processData()</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionLogStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å¤„ç†äº‹åŠ¡æ•°æ®.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> connection ä¸šåŠ¡æ•°æ®åº“è¿æ¥</div><div class="line">* <span class="doctag">@param</span> transactionLog äº‹åŠ¡æ—¥å¿—</div><div class="line">* <span class="doctag">@param</span> maxDeliveryTryTimes äº‹åŠ¡é€è¾¾çš„æœ€å¤§å°è¯•æ¬¡æ•°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">processData</span><span class="params">(Connection connection, TransactionLog transactionLog, <span class="keyword">int</span> maxDeliveryTryTimes)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">// RdbTransactionLogStorage.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">processData</span><span class="params">(<span class="keyword">final</span> Connection connection, <span class="keyword">final</span> TransactionLog transactionLog, <span class="keyword">final</span> <span class="keyword">int</span> maxDeliveryTryTimes)</span> </span>&#123;</div><div class="line">   <span class="comment">// é‡è¯•æ‰§è¡Œå¤±è´¥ SQL</span></div><div class="line">   <span class="keyword">try</span> (</div><div class="line">       Connection conn = connection;</div><div class="line">       PreparedStatement preparedStatement = conn.prepareStatement(transactionLog.getSql())) &#123;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> parameterIndex = <span class="number">0</span>; parameterIndex &lt; transactionLog.getParameters().size(); parameterIndex++) &#123;</div><div class="line">           preparedStatement.setObject(parameterIndex + <span class="number">1</span>, transactionLog.getParameters().get(parameterIndex));</div><div class="line">       &#125;</div><div class="line">       preparedStatement.executeUpdate();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">       <span class="comment">// é‡è¯•å¤±è´¥ï¼Œæ›´æ–°äº‹åŠ¡æ—¥å¿—ï¼Œå¢åŠ å·²å¼‚æ­¥é‡è¯•æ¬¡æ•°</span></div><div class="line">       increaseAsyncDeliveryTryTimes(transactionLog.getId());</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> TransactionCompensationException(ex);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç§»é™¤é‡è¯•æ‰§è¡ŒæˆåŠŸ SQL å¯¹åº”çš„äº‹åŠ¡æ—¥å¿—</span></div><div class="line">   remove(transactionLog.getId());</div><div class="line">   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä¸åŒäºå‰å››ä¸ª<strong>å¢åˆ æ”¹æŸ¥</strong>æ¥å£æ–¹æ³•çš„å®ç°ï¼Œ<code>#processData()</code> æ˜¯å¸¦æœ‰ä¸€äº›é€»è¾‘çš„ã€‚æ ¹æ®äº‹åŠ¡æ—¥å¿—( TransactionLog )é‡è¯•æ‰§è¡Œå¤±è´¥çš„ SQLï¼Œè‹¥æˆåŠŸï¼Œç§»é™¤äº‹åŠ¡æ—¥å¿—ï¼›è‹¥å¤±è´¥ï¼Œæ›´æ–°äº‹åŠ¡æ—¥å¿—ï¼Œå¢åŠ å·²å¼‚æ­¥é‡è¯•æ¬¡æ•°</li>
<li>è¯¥æ–¹æ³•ä¼šè¢«<strong>æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š</strong>è°ƒç”¨åˆ°</li>
</ul>
<h1 id="5-æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨"><a href="#5-æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨" class="headerlink" title="5. æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨"></a>5. æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨</h1><p>æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨ï¼ŒBestEffortsDeliveryListenerï¼Œè´Ÿè´£è®°å½•äº‹åŠ¡æ—¥å¿—ã€åŒæ­¥é‡è¯•æ‰§è¡Œå¤±è´¥ SQLã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// BestEffortsDeliveryListener.java</span></div><div class="line"><span class="meta">@Subscribe</span></div><div class="line"><span class="meta">@AllowConcurrentEvents</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(<span class="keyword">final</span> DMLExecutionEvent event)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!isProcessContinuously()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   SoftTransactionConfiguration transactionConfig = SoftTransactionManager.getCurrentTransactionConfiguration().get();</div><div class="line">   TransactionLogStorage transactionLogStorage = TransactionLogStorageFactory.createTransactionLogStorage(transactionConfig.buildTransactionLogDataSource());</div><div class="line">   BEDSoftTransaction bedSoftTransaction = (BEDSoftTransaction) SoftTransactionManager.getCurrentTransaction().get();</div><div class="line">   <span class="keyword">switch</span> (event.getEventExecutionType()) &#123;</div><div class="line">       <span class="keyword">case</span> BEFORE_EXECUTE: <span class="comment">// æ‰§è¡Œå‰ï¼Œæ’å…¥äº‹åŠ¡æ—¥å¿—</span></div><div class="line">           <span class="comment">//TODO å¯¹äºæ‰¹é‡æ‰§è¡Œçš„SQLéœ€è¦è§£ææˆä¸¤å±‚åˆ—è¡¨</span></div><div class="line">           transactionLogStorage.add(<span class="keyword">new</span> TransactionLog(event.getId(), bedSoftTransaction.getTransactionId(), bedSoftTransaction.getTransactionType(), </div><div class="line">                   event.getDataSource(), event.getSql(), event.getParameters(), System.currentTimeMillis(), <span class="number">0</span>));</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       <span class="keyword">case</span> EXECUTE_SUCCESS: <span class="comment">// æ‰§è¡ŒæˆåŠŸï¼Œç§»é™¤äº‹åŠ¡æ—¥å¿—</span></div><div class="line">           transactionLogStorage.remove(event.getId());</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       <span class="keyword">case</span> EXECUTE_FAILURE: <span class="comment">// æ‰§è¡Œå¤±è´¥ï¼ŒåŒæ­¥é‡è¯•</span></div><div class="line">           <span class="keyword">boolean</span> deliverySuccess = <span class="keyword">false</span>;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; transactionConfig.getSyncMaxDeliveryTryTimes(); i++) &#123; <span class="comment">// åŒæ­¥ã€å¤šæ¬¡ã€‘é‡è¯•</span></div><div class="line">               <span class="keyword">if</span> (deliverySuccess) &#123;</div><div class="line">                   <span class="keyword">return</span>;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">boolean</span> isNewConnection = <span class="keyword">false</span>;</div><div class="line">               Connection conn = <span class="keyword">null</span>;</div><div class="line">               PreparedStatement preparedStatement = <span class="keyword">null</span>;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">// è·å¾—æ•°æ®åº“è¿æ¥</span></div><div class="line">                   conn = bedSoftTransaction.getConnection().getConnection(event.getDataSource(), SQLType.DML);</div><div class="line">                   <span class="keyword">if</span> (!isValidConnection(conn)) &#123; <span class="comment">// å› ä¸ºå¯èƒ½æ‰§è¡Œå¤±è´¥æ˜¯æ•°æ®åº“è¿æ¥å¼‚å¸¸ï¼Œæ‰€ä»¥åˆ¤æ–­ä¸€æ¬¡ï¼Œå¦‚æœæ— æ•ˆï¼Œé‡æ–°è·å–æ•°æ®åº“è¿æ¥</span></div><div class="line">                       bedSoftTransaction.getConnection().release(conn);</div><div class="line">                       conn = bedSoftTransaction.getConnection().getConnection(event.getDataSource(), SQLType.DML);</div><div class="line">                       isNewConnection = <span class="keyword">true</span>;</div><div class="line">                   &#125;</div><div class="line">                   preparedStatement = conn.prepareStatement(event.getSql());</div><div class="line">                   <span class="comment">// åŒæ­¥é‡è¯•</span></div><div class="line">                   <span class="comment">//TODO å¯¹äºæ‰¹é‡äº‹ä»¶éœ€è¦è§£ææˆä¸¤å±‚åˆ—è¡¨</span></div><div class="line">                   <span class="keyword">for</span> (<span class="keyword">int</span> parameterIndex = <span class="number">0</span>; parameterIndex &lt; event.getParameters().size(); parameterIndex++) &#123;</div><div class="line">                       preparedStatement.setObject(parameterIndex + <span class="number">1</span>, event.getParameters().get(parameterIndex));</div><div class="line">                   &#125;</div><div class="line">                   preparedStatement.executeUpdate();</div><div class="line">                   deliverySuccess = <span class="keyword">true</span>;</div><div class="line">                   <span class="comment">// åŒæ­¥é‡è¯•æˆåŠŸï¼Œç§»é™¤äº‹åŠ¡æ—¥å¿—</span></div><div class="line">                   transactionLogStorage.remove(event.getId());</div><div class="line">               &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">                   log.error(String.format(<span class="string">"Delivery times %s error, max try times is %s"</span>, i + <span class="number">1</span>, transactionConfig.getSyncMaxDeliveryTryTimes()), ex);</div><div class="line">               &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                   close(isNewConnection, conn, preparedStatement);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       <span class="keyword">default</span>: </div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(event.getEventExecutionType().toString());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>BestEffortsDeliveryListener é€šè¿‡ EventBus å®ç°ç›‘å¬ SQL çš„æ‰§è¡Œã€‚Sharding-JDBC å¦‚ä½•å®ç° EventBus çš„ï¼Œè¯·çœ‹<a href="http://www.yunai.me/Sharding-JDBC/sql-execute/?self">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œã€‹</a></li>
<li>è°ƒç”¨ <code>#isProcessContinuously()</code> æ–¹æ³•åˆ¤æ–­æ˜¯å¦å¤„äº<strong>æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡</strong>ä¸­ï¼Œå½“ä¸”ä»…å½“å¤„äºè¯¥çŠ¶æ€æ‰è¿›è¡Œç›‘å¬äº‹ä»¶å¤„ç†</li>
<li>SQL æ‰§è¡Œ<strong>å‰</strong>ï¼Œæ’å…¥äº‹åŠ¡æ—¥å¿—</li>
<li>SQL æ‰§è¡Œ<strong>æˆåŠŸ</strong>ï¼Œç§»é™¤äº‹åŠ¡æ—¥å¿—</li>
<li><p>SQL æ‰§è¡Œ<strong>å¤±è´¥</strong>ï¼Œæ ¹æ®æŸ”æ€§äº‹åŠ¡é…ç½®( SoftTransactionConfiguration )åŒæ­¥çš„äº‹åŠ¡é€è¾¾çš„æœ€å¤§å°è¯•æ¬¡æ•°( <code>syncMaxDeliveryTryTimes</code> )è¿›è¡Œå¤šæ¬¡é‡è¯•<strong>ç›´åˆ°æˆåŠŸ</strong>ã€‚æ€»ä½“é€»è¾‘å’Œ <code>RdbTransactionLogStorage#processData()</code> æ–¹æ³•é€»è¾‘ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äº<strong>è·å–åˆ†ç‰‡æ•°æ®åº“è¿æ¥</strong>çš„ç‰¹æ®Šå¤„ç†ï¼šæ­¤å¤„è°ƒç”¨å¤±è´¥ï¼Œæ•°æ®åº“è¿æ¥å¯èƒ½æ˜¯å¼‚å¸¸æ— æ•ˆçš„ï¼Œå› æ­¤è°ƒç”¨äº† <code>#isValidConnection()</code> åˆ¤æ–­è¿æ¥çš„<strong>æœ‰æ•ˆæ€§</strong>ã€‚è‹¥æ— æ•ˆï¼Œåˆ™é‡æ–°è·å–åˆ†ç‰‡æ•°æ®åº“è¿æ¥ã€‚å¦å¤–ï¼Œè‹¥æ˜¯é‡æ–°è·å–åˆ†ç‰‡æ•°æ®åº“è¿æ¥ï¼Œéœ€è¦è¿›è¡Œå…³é—­é‡Šæ”¾ (<code>Connection#close()</code>)ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// BestEffortsDeliveryListener.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* é€šè¿‡ SELECT 1 æ ¡éªŒæ•°æ®åº“è¿æ¥æ˜¯å¦æœ‰æ•ˆ</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> conn æ•°æ®åº“è¿æ¥</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦æœ‰æ•ˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isValidConnection</span><span class="params">(<span class="keyword">final</span> Connection conn)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> (PreparedStatement preparedStatement = conn.prepareStatement(<span class="string">"SELECT 1"</span>)) &#123;</div><div class="line">       <span class="keyword">try</span> (ResultSet rs = preparedStatement.executeQuery()) &#123;</div><div class="line">           <span class="keyword">return</span> rs.next() &amp;&amp; <span class="number">1</span> == rs.getInt(<span class="string">"1"</span>);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* å…³é—­é‡Šæ”¾é¢„ç¼–è¯‘SQLå¯¹è±¡å’Œæ•°æ®åº“è¿æ¥</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> isNewConnection æ˜¯å¦æ–°åˆ›å»ºçš„æ•°æ®åº“è¿æ¥ï¼Œæ˜¯çš„æƒ…å†µä¸‹æ‰é‡Šæ”¾</div><div class="line">* <span class="doctag">@param</span> conn æ•°æ®åº“è¿æ¥</div><div class="line">* <span class="doctag">@param</span> preparedStatement é¢„ç¼–è¯‘SQL</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> isNewConnection, <span class="keyword">final</span> Connection conn, <span class="keyword">final</span> PreparedStatement preparedStatement)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != preparedStatement) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           preparedStatement.close();</div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">           log.error(<span class="string">"PreparedStatement closed error:"</span>, ex);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (isNewConnection &amp;&amp; <span class="keyword">null</span> != conn) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           conn.close();</div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">           log.error(<span class="string">"Connection closed error:"</span>, ex);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="6-æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š"><a href="#6-æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š" class="headerlink" title="6. æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š"></a>6. æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š</h1><p>å½“æœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨( BestEffortsDeliveryListener )<strong>å¤šæ¬¡åŒæ­¥</strong>é‡è¯•å¤±è´¥åï¼Œäº¤ç»™<strong>æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š</strong>è¿›è¡Œ<strong>å¤šæ¬¡å¼‚æ­¥</strong>é‡è¯•ï¼Œå¹¶ä¸”å¤šæ¬¡æ‰§è¡Œæœ‰<strong>å›ºå®šé—´éš”</strong>ã€‚</p>
<p>Sharding-JDBC æä¾›äº†ä¸¤ä¸ªæœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸šå®ç°ï¼š</p>
<ul>
<li>NestedBestEffortsDeliveryJob ï¼šå†…åµŒçš„æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š</li>
<li>BestEffortsDeliveryJob ï¼šæœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸š</li>
</ul>
<p>ä¸¤è€…å®ç°ä»£ç é€»è¾‘<strong>åŸºæœ¬ä¸€è‡´</strong>ã€‚å‰è€…ç›¸æ¯”åè€…ï¼Œç”¨äºå¼€å‘æµ‹è¯•ï¼Œå»é™¤å¯¹ Zookeeper ä¾èµ–ï¼Œæ— æ³•å®ç°<strong>é«˜å¯ç”¨</strong>ï¼Œå› æ­¤<strong>ç”Ÿäº§ç¯å¢ƒä¸‹ä¸é€‚åˆä½¿ç”¨</strong>ã€‚</p>
<h2 id="6-1-BestEffortsDeliveryJob"><a href="#6-1-BestEffortsDeliveryJob" class="headerlink" title="6.1 BestEffortsDeliveryJob"></a>6.1 BestEffortsDeliveryJob</h2><p>BestEffortsDeliveryJob æ‰€åœ¨ Maven é¡¹ç›®ä¸º <code>sharding-jdbc-transaction-async-job</code>ï¼ŒåŸºäºå½“å½“å¼€æºçš„ <a href="https://github.com/dangdangdotcom/elastic-job" rel="external nofollow noopener noreferrer" target="_blank">Elastic-Job</a> å®ç°ã€‚å¦‚ä¸‹æ˜¯å®˜æ–¹å¯¹è¯¥ Maven é¡¹ç›®çš„ç®€è¦è¯´æ˜ï¼š</p>
<blockquote>
<p>ç”±äºæŸ”æ€§äº‹åŠ¡é‡‡ç”¨å¼‚æ­¥å°è¯•ï¼Œéœ€è¦éƒ¨ç½²ç‹¬ç«‹çš„ä½œä¸šå’ŒZookeeperã€‚sharding-jdbc-transactioné‡‡ç”¨elastic-jobå®ç°çš„sharding-jdbc-transaction-async-jobï¼Œé€šè¿‡ç®€å•é…ç½®å³å¯å¯åŠ¨é«˜å¯ç”¨ä½œä¸šå¼‚æ­¥é€è¾¾æŸ”æ€§äº‹åŠ¡ï¼Œå¯åŠ¨è„šæœ¬ä¸ºstart.shã€‚</p>
</blockquote>
<p><strong>BestEffortsDeliveryJob</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BestEffortsDeliveryJob</span> <span class="keyword">extends</span> <span class="title">AbstractIndividualThroughputDataFlowElasticJob</span>&lt;<span class="title">TransactionLog</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸šé…ç½®å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> BestEffortsDeliveryConfiguration bedConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * äº‹åŠ¡æ—¥å¿—å­˜å‚¨å™¨å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> TransactionLogStorage transactionLogStorage;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;TransactionLog&gt; <span class="title">fetchData</span><span class="params">(<span class="keyword">final</span> JobExecutionMultipleShardingContext context)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> transactionLogStorage.findEligibleTransactionLogs(context.getFetchDataCount(),</div><div class="line">            bedConfig.getJobConfig().getMaxDeliveryTryTimes(), bedConfig.getJobConfig().getMaxDeliveryTryDelayMillis());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">processData</span><span class="params">(<span class="keyword">final</span> JobExecutionMultipleShardingContext context, <span class="keyword">final</span> TransactionLog data)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> (</div><div class="line">            Connection conn = bedConfig.getTargetDataSource(data.getDataSource()).getConnection()) &#123;</div><div class="line">            transactionLogStorage.processData(conn, data, bedConfig.getJobConfig().getMaxDeliveryTryTimes());</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException | TransactionCompensationException ex) &#123;</div><div class="line">            log.error(String.format(<span class="string">"Async delivery times %s error, max try times is %s, exception is %s"</span>, data.getAsyncDeliveryTryTimes() + <span class="number">1</span>, </div><div class="line">                bedConfig.getJobConfig().getMaxDeliveryTryTimes(), ex.getMessage()));</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStreamingProcess</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>#fetchData()</code> æ–¹æ³•è·å–éœ€è¦å¤„ç†çš„äº‹åŠ¡æ—¥å¿— (TransactionLog)ï¼Œå†…éƒ¨è°ƒç”¨äº† <code>TransactionLogStorage#findEligibleTransactionLogs()</code> æ–¹æ³•</li>
<li>è°ƒç”¨ <code>#processData()</code> æ–¹æ³•å¤„ç†äº‹åŠ¡æ—¥å¿—ï¼Œé‡è¯•æ‰§è¡Œå¤±è´¥çš„ SQLï¼Œå†…éƒ¨è°ƒç”¨äº† <code>TransactionLogStorage#processData()</code></li>
<li><code>#fetchData()</code> å’Œ <code>#processData()</code> è°ƒç”¨æ˜¯ Elastic-Job æ§åˆ¶çš„ã€‚æ¯ä¸€è½®å®šæ—¶è°ƒåº¦ï¼Œ<strong>æ¯æ¡</strong>äº‹åŠ¡æ—¥å¿—åªæ‰§è¡Œ<strong>ä¸€æ¬¡</strong>ã€‚å½“<strong>è¶…è¿‡</strong>æœ€å¤§å¼‚æ­¥è°ƒç”¨æ¬¡æ•°åï¼Œè¯¥æ¡äº‹åŠ¡æ—¥å¿—ä¸å†å¤„ç†ï¼Œæ‰€ä»¥<strong>ç”Ÿäº§ä½¿ç”¨æ—¶ï¼Œæœ€å¥½å¢åŠ ä¸‹ç›¸åº”ç›‘æ§è¶…è¿‡æœ€å¤§å¼‚æ­¥é‡è¯•æ¬¡æ•°çš„äº‹åŠ¡æ—¥å¿—</strong>ã€‚</li>
</ul>
<h2 id="6-2-AsyncSoftTransactionJobConfiguration"><a href="#6-2-AsyncSoftTransactionJobConfiguration" class="headerlink" title="6.2 AsyncSoftTransactionJobConfiguration"></a>6.2 AsyncSoftTransactionJobConfiguration</h2><p>AsyncSoftTransactionJobConfigurationï¼Œå¼‚æ­¥æŸ”æ€§äº‹åŠ¡ä½œä¸šé…ç½®å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncSoftTransactionJobConfiguration</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½œä¸šåç§°.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String name = <span class="string">"bestEffortsDeliveryJob"</span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è§¦å‘ä½œä¸šçš„cronè¡¨è¾¾å¼.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String cron = <span class="string">"0/5 * * * * ?"</span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ¯æ¬¡ä½œä¸šè·å–çš„äº‹åŠ¡æ—¥å¿—æœ€å¤§æ•°é‡.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> transactionLogFetchDataCount = <span class="number">100</span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * äº‹åŠ¡é€è¾¾çš„æœ€å¤§å°è¯•æ¬¡æ•°.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxDeliveryTryTimes = <span class="number">3</span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰§è¡Œäº‹åŠ¡çš„å»¶è¿Ÿæ¯«ç§’æ•°.</div><div class="line">     *</div><div class="line">     * &lt;p&gt;æ—©äºæ­¤é—´éš”æ—¶é—´çš„å…¥åº“äº‹åŠ¡æ‰ä¼šè¢«ä½œä¸šæ‰§è¡Œ.&lt;/p&gt;</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> maxDeliveryTryDelayMillis = <span class="number">60</span>  * <span class="number">1000L</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="6-3-Elastic-Job-æ˜¯å¦å¿…é¡»ï¼Ÿ"><a href="#6-3-Elastic-Job-æ˜¯å¦å¿…é¡»ï¼Ÿ" class="headerlink" title="6.3 Elastic-Job æ˜¯å¦å¿…é¡»ï¼Ÿ"></a>6.3 Elastic-Job æ˜¯å¦å¿…é¡»ï¼Ÿ</h2><p>Sharding-JDBC æä¾›çš„æœ€å¤§åŠªåŠ›é€è¾¾å‹å¼‚æ­¥ä½œä¸šå®ç°( BestEffortsDeliveryJob )ï¼Œé€šè¿‡ä¸ Elastic-Job é›†æˆï¼Œå¯ä»¥å¾ˆä¾¿æ·å¹¶ä¸”æœ‰è´¨é‡ä¿è¯çš„<strong>é«˜å¯ç”¨</strong>ã€<strong>é«˜æ€§èƒ½</strong>ä½¿ç”¨ã€‚ä¸€éƒ¨åˆ†å›¢é˜Ÿï¼Œå¯èƒ½å·²ç»å¼•å…¥æˆ–è‡ªç ”äº†ç±»ä¼¼ Elastic-Job çš„åˆ†å¸ƒå¼ä½œä¸šä¸­é—´ä»¶è§£å†³æ–¹æ¡ˆï¼Œæ¯å¤šä¸€ä¸ªä¸­é—´ä»¶ï¼Œå°±æ˜¯å¤šä¸€ä¸ªå­¦ä¹ ä¸è¿ç»´æˆæœ¬ã€‚é‚£ä¹ˆæ˜¯å¦å¯ä»¥ä½¿ç”¨è‡ªå·±çš„åˆ†å¸ƒå¼ä½œä¸šè§£å†³æ–¹æ¡ˆï¼Ÿç­”æ¡ˆæ˜¯ï¼Œå¯ä»¥çš„ã€‚å‚è€ƒ BestEffortsDeliveryJob çš„å®ç°ï¼Œé€šè¿‡è°ƒç”¨ TransactionLogStorage æ¥å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ä¼ªä»£ç (ä¸è€ƒè™‘æ€§èƒ½ã€å¼‚å¸¸)</span></div><div class="line">List&lt;TransactionLog&gt; transactionLogs = transactionLogStorage.findEligibleTransactionLogs(....);</div><div class="line"><span class="keyword">for</span> (TransactionLog transactionLog : transactionLogs) &#123;</div><div class="line">       transactionLogStorage.processData(conn, log, maxDeliveryTryTimes);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å½“ç„¶ï¼Œä¸ªäººè¿˜æ˜¯å¾ˆæ¨è Elastic-Jobã€‚  </p>
<p>ğŸ˜ˆ <strong>ç¬”è€…è¦å¼€å§‹å†™<a href="http://www.yunai.me/categories/Elastic-Job//?self">ã€ŠElastic-Job æºç åˆ†æã€‹</a></strong>ã€‚</p>
<hr>
<p>å¦å¤–ï¼Œå¦‚æœæœ‰æ”¯æŒ<strong>äº‹åŠ¡æ¶ˆæ¯</strong>çš„åˆ†å¸ƒå¼é˜Ÿåˆ—ç³»ç»Ÿï¼Œå¯ä»¥é€šè¿‡ TransactionLogStorage å®ç°å­˜å‚¨äº‹åŠ¡æ¶ˆæ¯å­˜å‚¨æˆæ¶ˆæ¯ã€‚ä¸ºä»€ä¹ˆè¦æ”¯æŒ<strong>äº‹åŠ¡æ¶ˆæ¯</strong>ï¼Ÿå¦‚æœ SQL æ‰§è¡Œæ˜¯æˆåŠŸçš„ï¼Œéœ€è¦å›æ»šï¼ˆåˆ é™¤ï¼‰äº‹åŠ¡æ¶ˆæ¯ã€‚</p>
<h1 id="7-é€‚ç”¨åœºæ™¯"><a href="#7-é€‚ç”¨åœºæ™¯" class="headerlink" title="7. é€‚ç”¨åœºæ™¯"></a>7. é€‚ç”¨åœºæ™¯</h1><p>è§<a href="http://dangdangdotcom.github.io/sharding-jdbc/02-guide/transaction/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ - äº‹åŠ¡æ”¯æŒã€‹</a>ã€‚</p>
<h1 id="8-å¼€å‘æŒ‡å—-amp-å¼€å‘ç¤ºä¾‹"><a href="#8-å¼€å‘æŒ‡å—-amp-å¼€å‘ç¤ºä¾‹" class="headerlink" title="8. å¼€å‘æŒ‡å— &amp; å¼€å‘ç¤ºä¾‹"></a>8. å¼€å‘æŒ‡å— &amp; å¼€å‘ç¤ºä¾‹</h1><p>è§<a href="http://dangdangdotcom.github.io/sharding-jdbc/02-guide/transaction/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ - äº‹åŠ¡æ”¯æŒã€‹</a>ã€‚</p>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å“ˆå“ˆå“ˆ</p>
<p>ç®—æ˜¯åšæŒæŠŠè¿™ä¸ªç³»åˆ—å†™å®Œäº†ï¼Œç»™è‡ªå·± 32 å€‹èµã€‚</p>
<p>æ»¡è¶³ï¼</p>
<p><a href="http://www.yunai.me/categories/Elastic-Job//?self">ã€ŠElastic-Job æºç åˆ†æã€‹</a> èµ°èµ·ï¼ä¸ High ä¸ç»“æŸï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘&lt;/strong&gt;æœ‰
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
  <entry>
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” JDBCå®ç°ä¸è¯»å†™åˆ†ç¦»</title>
    <link href="http://www.yunai.me/Sharding-JDBC/jdbc-implement-and-read-write-splitting/"/>
    <id>http://www.yunai.me/Sharding-JDBC/jdbc-implement-and-read-write-splitting/</id>
    <published>2017-08-17T16:00:00.000Z</published>
    <updated>2017-08-14T18:34:13.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Sharding-JDBC 1.5.0 æ­£å¼ç‰ˆ</strong>  </p>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. unspported åŒ…</a></li>
<li><a href="#">3. adapter åŒ…</a><ul>
<li><a href="#">3.1 WrapperAdapter</a></li>
<li><a href="#">3.2 AbstractDataSourceAdapter</a></li>
<li><a href="#">3.3 AbstractConnectionAdapter</a></li>
<li><a href="#">3.4 AbstractStatementAdapter</a></li>
<li><a href="#">3.5 AbstractPreparedStatementAdapter</a></li>
<li><a href="#">3.6 AbstractResultSetAdapter</a></li>
</ul>
</li>
<li><a href="#">4. æ’å…¥æµç¨‹</a></li>
<li><a href="#">5. æŸ¥è¯¢æµç¨‹</a></li>
<li><a href="#">6. è¯»å†™åˆ†ç¦»</a></li>
<li><a href="#">666. <del>å½©è›‹</del></a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>JDBC</strong> ä¸ <strong>è¯»å†™åˆ†ç¦»</strong> çš„å®ç°ã€‚ä¸ºä»€ä¹ˆä¼šæŠŠè¿™ä¸¤ä¸ªä¸œè¥¿æ”¾åœ¨ä¸€èµ·è®²å‘¢ï¼Ÿå®¢æˆ·ç«¯ç›´è¿æ•°æ®åº“çš„è¯»å†™åˆ†ç¦»ä¸»è¦é€šè¿‡è·å–è¯»åº“å’Œå†™åº“çš„ä¸åŒè¿æ¥æ¥å®ç°ï¼Œå’Œ JDBC Connection åˆšå¥½æ”¾åœ¨ä¸€å—ã€‚</p>
<p>OKï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€æ®µ Sharding-JDBC å®˜æ–¹å¯¹è‡ªå·±çš„å®šä¹‰å’Œå®šä½</p>
<blockquote>
<p>Sharding-JDBCå®šä½ä¸ºè½»é‡çº§javaæ¡†æ¶ï¼Œä½¿ç”¨å®¢æˆ·ç«¯ç›´è¿æ•°æ®åº“ï¼Œä»¥jaråŒ…å½¢å¼æä¾›æœåŠ¡ï¼Œæœªä½¿ç”¨ä¸­é—´å±‚ï¼Œæ— éœ€é¢å¤–éƒ¨ç½²ï¼Œæ— å…¶ä»–ä¾èµ–ï¼ŒDBAä¹Ÿæ— éœ€æ”¹å˜åŸæœ‰çš„è¿ç»´æ–¹å¼ï¼Œå¯ç†è§£ä¸º<strong>å¢å¼ºç‰ˆçš„JDBCé©±åŠ¨</strong>ï¼Œæ—§ä»£ç è¿ç§»æˆæœ¬å‡ ä¹ä¸ºé›¶ã€‚</p>
</blockquote>
<p>å¯ä»¥çœ‹å‡ºï¼ŒSharding-JDBC é€šè¿‡å®ç° <strong>JDBCè§„èŒƒ</strong>ï¼Œå¯¹ä¸Šå±‚æä¾›é€æ˜åŒ–æ•°æ®åº“åˆ†åº“åˆ†è¡¨çš„è®¿é—®ã€‚ğŸ˜ˆ é»‘ç§‘æŠ€ï¼Ÿå®é™…æˆ‘ä»¬ä½¿ç”¨çš„<strong>æ•°æ®åº“è¿æ¥æ± </strong>ä¹Ÿæ˜¯é€šè¿‡è¿™ç§æ–¹å¼å®ç°å¯¹ä¸Šå±‚æ— æ„ŸçŸ¥çš„æä¾›è¿æ¥æ± ã€‚ç”šè‡³è¿˜å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼å®ç°å¯¹ Luceneã€<a href="http://www.yunai.me/MyCAT/connect-mongodb/?self">MongoDB</a> ç­‰ç­‰çš„è®¿é—®ã€‚</p>
<p>æ‰¯è¿œäº†ï¼Œä¸‹é¢æ¥çœ‹çœ‹ Sharding-JDBC <code>jdbc</code> åŒ…çš„ç»“æ„ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_18/01.png" alt=""></p>
<ul>
<li><code>unsupported</code>ï¼šå£°æ˜<strong>ä¸æ”¯æŒ</strong>çš„æ•°æ®æ“ä½œæ–¹æ³•</li>
<li><code>adapter</code>ï¼šé€‚é…ç±»ï¼Œå®ç°å’Œåˆ†åº“åˆ†è¡¨<strong>æ— å…³</strong>çš„æ–¹æ³•</li>
<li><code>core</code>ï¼šæ ¸å¿ƒç±»ï¼Œå®ç°å’Œåˆ†åº“åˆ†è¡¨<strong>ç›¸å…³</strong>çš„æ–¹æ³•</li>
</ul>
<p>æ ¹æ® <code>core</code> åŒ…ï¼Œå¯ä»¥çœ‹å‡ºåˆ†åˆ°å››ç§æˆ‘ä»¬<strong>è¶…çº§ç†Ÿæ‚‰</strong>çš„å¯¹è±¡  </p>
<ul>
<li><p>Datasource</p>
<p>  <img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_18/02.png" alt="-w640"></p>
</li>
<li><p>Connection</p>
<p> <img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_18/03.png" alt="-w640"></p>
</li>
<li><p>Statement</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_18/04.png" alt="-w640"></p>
</li>
<li><p>ResultSet</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_18/05.png" alt="-w640"></p>
</li>
</ul>
<p><strong>å®ç°</strong>å±‚çº§å¦‚ä¸‹ï¼š<strong>JDBC æ¥å£</strong> &lt;=(ç»§æ‰¿)== <strong><code>unsupported</code>æŠ½è±¡ç±»</strong> &lt;=(ç»§æ‰¿)== <strong><code>unsupported</code>æŠ½è±¡ç±»</strong> &lt;=(ç»§æ‰¿)== <strong><code>core</code>ç±»</strong>ã€‚</p>
<hr>
<p><strong>æœ¬æ–‡å†…å®¹é¡ºåº</strong></p>
<ol>
<li><code>unspported</code> åŒ…</li>
<li><code>adapter</code> åŒ…</li>
<li>æ’å…¥æµç¨‹ï¼Œåˆ†æçš„ç±»ï¼š<ul>
<li>ShardingDataSource</li>
<li>ShardingConnection</li>
<li>ShardingPreparedStatementï¼ˆShardingStatement ç±»ä¼¼ï¼Œä¸é‡å¤åˆ†æï¼‰</li>
<li>GeneratedKeysResultSetã€GeneratedKeysResultSetMetaData</li>
</ul>
</li>
<li>æŸ¥è¯¢æµç¨‹ï¼Œåˆ†æçš„ç±»ï¼š<ul>
<li>ShardingPreparedStatement</li>
<li>ShardingResultSet</li>
</ul>
</li>
<li>è¯»å†™åˆ†ç¦»ï¼Œåˆ†æçš„ç±»ï¼š<ul>
<li>MasterSlaveDataSource</li>
</ul>
</li>
</ol>
<hr>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h1 id="2-unspported-åŒ…"><a href="#2-unspported-åŒ…" class="headerlink" title="2. unspported åŒ…"></a>2. unspported åŒ…</h1><p><code>unspported</code> åŒ…å†…çš„<strong>æŠ½è±¡</strong>ç±»ï¼Œå£°æ˜ä¸æ”¯æŒæ“ä½œçš„æ•°æ®å¯¹è±¡ï¼Œæ‰€æœ‰æ–¹æ³•éƒ½æ˜¯ <code>throw new SQLFeatureNotSupportedException()</code> æ–¹å¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractUnsupportedGeneratedKeysResultSet</span> <span class="keyword">extends</span> <span class="title">AbstractUnsupportedOperationResultSet</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SQLFeatureNotSupportedException(<span class="string">"getBoolean"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// .... çœç•¥å…¶å®ƒç±»ä¼¼æ–¹æ³•</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractUnsupportedOperationConnection</span> <span class="keyword">extends</span> <span class="title">WrapperAdapter</span> <span class="keyword">implements</span> <span class="title">Connection</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> CallableStatement <span class="title">prepareCall</span><span class="params">(<span class="keyword">final</span> String sql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SQLFeatureNotSupportedException(<span class="string">"prepareCall"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">   <span class="comment">// .... çœç•¥å…¶å®ƒç±»ä¼¼æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="3-adapter-åŒ…"><a href="#3-adapter-åŒ…" class="headerlink" title="3. adapter åŒ…"></a>3. adapter åŒ…</h1><p><code>adapter</code> åŒ…å†…çš„<strong>æŠ½è±¡</strong>ç±»ï¼Œå®ç°å’Œåˆ†åº“åˆ†è¡¨<strong>æ— å…³</strong>çš„æ–¹æ³•ã€‚</p>
<p><strong>è€ƒè™‘åˆ°ç¬¬4ã€5ä¸¤å°èŠ‚æ›´å®¹æ˜“ç†è§£ï¼Œæœ¬å°èŠ‚è´´çš„ä»£ç ä¼šç›¸å¯¹å¤š</strong></p>
<h2 id="3-1-WrapperAdapter"><a href="#3-1-WrapperAdapter" class="headerlink" title="3.1 WrapperAdapter"></a>3.1 WrapperAdapter</h2><p><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/jdbc/adapter/WrapperAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">WrapperAdapter</a>ï¼ŒJDBC Wrapper é€‚é…ç±»ã€‚</p>
<p><strong>å¯¹ Wrapper æ¥å£å®ç°å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> &lt;T&gt; <span class="function">T <span class="title">unwrap</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; iface)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">if</span> (isWrapperFor(iface)) &#123;</div><div class="line">       <span class="keyword">return</span> (T) <span class="keyword">this</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(String.format(<span class="string">"[%s] cannot be unwrapped as [%s]"</span>, getClass().getName(), iface.getName()));</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isWrapperFor</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; iface)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">return</span> iface.isInstance(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>æä¾›å­ç±» <code>#recordMethodInvocation()</code> è®°å½•æ–¹æ³•è°ƒç”¨ï¼Œ<code>#replayMethodsInvocation()</code> å›æ”¾è®°å½•çš„æ–¹æ³•è°ƒç”¨</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®°å½•çš„æ–¹æ³•æ•°ç»„</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Collection&lt;JdbcMethodInvocation&gt; jdbcMethodInvocations = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®°å½•æ–¹æ³•è°ƒç”¨.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> targetClass ç›®æ ‡ç±»</div><div class="line">* <span class="doctag">@param</span> methodName æ–¹æ³•åç§°</div><div class="line">* <span class="doctag">@param</span> argumentTypes å‚æ•°ç±»å‹</div><div class="line">* <span class="doctag">@param</span> arguments å‚æ•°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">recordMethodInvocation</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; targetClass, <span class="keyword">final</span> String methodName, <span class="keyword">final</span> Class&lt;?&gt;[] argumentTypes, <span class="keyword">final</span> Object[] arguments)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       jdbcMethodInvocations.add(<span class="keyword">new</span> JdbcMethodInvocation(targetClass.getMethod(methodName, argumentTypes), arguments));</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> NoSuchMethodException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ShardingJdbcException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line">* å›æ”¾è®°å½•çš„æ–¹æ³•è°ƒç”¨.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> target ç›®æ ‡å¯¹è±¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">replayMethodsInvocation</span><span class="params">(<span class="keyword">final</span> Object target)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (JdbcMethodInvocation each : jdbcMethodInvocations) &#123;</div><div class="line">       each.invoke(target);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>è¿™ä¸¤ä¸ªæ–¹æ³•æœ‰ä»€ä¹ˆç”¨é€”å‘¢ï¼Ÿä¾‹å¦‚ä¸‹æ–‡ä¼šæåˆ°çš„ AbstractConnectionAdapter çš„ <code>#setAutoCommit()</code>ï¼Œå½“å®ƒæ— æ•°æ®åº“è¿æ¥æ—¶ï¼Œå…ˆè®°å½•ï¼›ç­‰è·å¾—åˆ°æ•°æ®è¿æ¥åï¼Œå†å›æ”¾ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractConnectionAdapter.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setAutoCommit</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> autoCommit)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">this</span>.autoCommit = autoCommit;</div><div class="line">   <span class="keyword">if</span> (getConnections().isEmpty()) &#123; <span class="comment">// æ— æ•°æ®è¿æ¥æ—¶ï¼Œè®°å½•æ–¹æ³•è°ƒç”¨</span></div><div class="line">       recordMethodInvocation(Connection.class, <span class="string">"setAutoCommit"</span>, <span class="keyword">new</span> Class[] &#123;<span class="keyword">boolean</span>.class&#125;, <span class="keyword">new</span> Object[] &#123;autoCommit&#125;);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       each.setAutoCommit(autoCommit);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>JdbcMethodInvocationï¼Œåå°„è°ƒç”¨JDBCç›¸å…³æ–¹æ³•çš„å·¥å…·ç±»ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcMethodInvocation</span> </span>&#123;</div><div class="line">    </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * æ–¹æ³•</div><div class="line">    */</div><div class="line">   <span class="meta">@Getter</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Method method;</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * æ–¹æ³•å‚æ•°</div><div class="line">    */</div><div class="line">   <span class="meta">@Getter</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Object[] arguments;</div><div class="line">   </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Â è°ƒç”¨æ–¹æ³•.</div><div class="line">    * </div><div class="line">    * <span class="doctag">@param</span> target ç›®æ ‡å¯¹è±¡</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(<span class="keyword">final</span> Object target)</span> </span>&#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           method.invoke(target, arguments); <span class="comment">// åå°„è°ƒç”¨</span></div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IllegalAccessException | InvocationTargetException ex) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> ShardingJdbcException(<span class="string">"Invoke jdbc method exception"</span>, ex);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>æä¾›å­ç±» <code>#throwSQLExceptionIfNecessary()</code> æŠ›å‡ºå¼‚å¸¸é“¾</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">throwSQLExceptionIfNecessary</span><span class="params">(<span class="keyword">final</span> Collection&lt;SQLException&gt; exceptions)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">if</span> (exceptions.isEmpty()) &#123; <span class="comment">// ä¸ºç©ºä¸æŠ›å‡ºå¼‚å¸¸</span></div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   SQLException ex = <span class="keyword">new</span> SQLException();</div><div class="line">   <span class="keyword">for</span> (SQLException each : exceptions) &#123;</div><div class="line">       ex.setNextException(each); <span class="comment">// å¼‚å¸¸é“¾</span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> ex;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-2-AbstractDataSourceAdapter"><a href="#3-2-AbstractDataSourceAdapter" class="headerlink" title="3.2 AbstractDataSourceAdapter"></a>3.2 AbstractDataSourceAdapter</h2><p><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/jdbc/adapter/AbstractDataSourceAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractDataSourceAdapter</a>ï¼Œæ•°æ®æºé€‚é…ç±»ã€‚</p>
<p>ç›´æ¥ç‚¹å‡»é“¾æ¥æŸ¥çœ‹æºç ã€‚</p>
<h2 id="3-3-AbstractConnectionAdapter"><a href="#3-3-AbstractConnectionAdapter" class="headerlink" title="3.3 AbstractConnectionAdapter"></a>3.3 AbstractConnectionAdapter</h2><p><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/jdbc/adapter/AbstractConnectionAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractConnectionAdapter</a>ï¼Œæ•°æ®åº“è¿æ¥é€‚é…ç±»ã€‚</p>
<p>æˆ‘ä»¬æ¥ç…ç…å¤§å®¶æœ€å…³å¿ƒçš„<strong>äº‹åŠ¡</strong>ç›¸å…³æ–¹æ³•çš„å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦è‡ªåŠ¨æäº¤</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> autoCommit = <span class="keyword">true</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—é“¾æ¥</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> é“¾æ¥</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Collection&lt;Connection&gt; <span class="title">getConnections</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">getAutoCommit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">return</span> autoCommit;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setAutoCommit</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> autoCommit)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">this</span>.autoCommit = autoCommit;</div><div class="line">   <span class="keyword">if</span> (getConnections().isEmpty()) &#123; <span class="comment">// æ— æ•°æ®è¿æ¥æ—¶ï¼Œè®°å½•æ–¹æ³•è°ƒç”¨</span></div><div class="line">       recordMethodInvocation(Connection.class, <span class="string">"setAutoCommit"</span>, <span class="keyword">new</span> Class[] &#123;<span class="keyword">boolean</span>.class&#125;, <span class="keyword">new</span> Object[] &#123;autoCommit&#125;);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       each.setAutoCommit(autoCommit);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#setAutoCommit()</code> è°ƒç”¨æ—¶ï¼Œå®é™…ä¼šè®¾ç½®å…¶æ‰€æŒæœ‰çš„ Connection çš„ <code>autoCommit</code> å±æ€§</li>
<li><code>#getConnections()</code> å’Œåˆ†åº“åˆ†è¡¨ç›¸å…³ï¼Œå› è€Œä»…æŠ½è±¡è¯¥æ–¹æ³•ï¼Œç•™ç»™å­ç±»å®ç°</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       each.commit();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   Collection&lt;SQLException&gt; exceptions = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           each.rollback();</div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">           exceptions.add(ex);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   throwSQLExceptionIfNecessary(exceptions);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#commit()</code>ã€<code>#rollback()</code> è°ƒç”¨æ—¶ï¼Œå®é™…è°ƒç”¨å…¶æ‰€æŒæœ‰çš„ Connection çš„æ–¹æ³•</li>
<li><p>å¼‚å¸¸æƒ…å†µä¸‹ï¼Œ<code>#commit()</code> å’Œ <code>#rollback()</code> å¤„ç†æ–¹å¼ä¸åŒï¼Œç¬”è€…æš‚æ—¶ä¸çŸ¥é“ç­”æ¡ˆï¼Œæ±‚è¯åä¼šè¿›è¡Œæ›´æ–° </p>
<ul>
<li><p><code>#commit()</code> å¤„ç†æ–¹å¼éœ€è¦æ”¹æˆå’Œ <code>#rollback()</code> ä¸€æ ·ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   Collection&lt;SQLException&gt; exceptions = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           each.commit();</div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">           exceptions.add(ex);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   throwSQLExceptionIfNecessary(exceptions);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>äº‹åŠ¡çº§åˆ«å’Œæ˜¯å¦åªè¯»ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* åªè¯»</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> readOnly = <span class="keyword">true</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line">* äº‹åŠ¡çº§åˆ«</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> transactionIsolation = TRANSACTION_READ_UNCOMMITTED;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setReadOnly</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> readOnly)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">this</span>.readOnly = readOnly;</div><div class="line">   <span class="keyword">if</span> (getConnections().isEmpty()) &#123;</div><div class="line">       recordMethodInvocation(Connection.class, <span class="string">"setReadOnly"</span>, <span class="keyword">new</span> Class[] &#123;<span class="keyword">boolean</span>.class&#125;, <span class="keyword">new</span> Object[] &#123;readOnly&#125;);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       each.setReadOnly(readOnly);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setTransactionIsolation</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> level)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   transactionIsolation = level;</div><div class="line">   <span class="keyword">if</span> (getConnections().isEmpty()) &#123;</div><div class="line">       recordMethodInvocation(Connection.class, <span class="string">"setTransactionIsolation"</span>, <span class="keyword">new</span> Class[] &#123;<span class="keyword">int</span>.class&#125;, <span class="keyword">new</span> Object[] &#123;level&#125;);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       each.setTransactionIsolation(level);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-4-AbstractStatementAdapter"><a href="#3-4-AbstractStatementAdapter" class="headerlink" title="3.4 AbstractStatementAdapter"></a>3.4 AbstractStatementAdapter</h2><p><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/jdbc/adapter/AbstractStatementAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractStatementAdapter</a>ï¼Œé™æ€è¯­å¥å¯¹è±¡é€‚é…ç±»ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getUpdateCount</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">long</span> result = <span class="number">0</span>;</div><div class="line">   <span class="keyword">boolean</span> hasResult = <span class="keyword">false</span>;</div><div class="line">   <span class="keyword">for</span> (Statement each : getRoutedStatements()) &#123;</div><div class="line">       <span class="keyword">if</span> (each.getUpdateCount() &gt; -<span class="number">1</span>) &#123;</div><div class="line">           hasResult = <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       result += each.getUpdateCount();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (result &gt; Integer.MAX_VALUE) &#123;</div><div class="line">       result = Integer.MAX_VALUE;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> hasResult ? Long.valueOf(result).intValue() : -<span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–è·¯ç”±çš„é™æ€è¯­å¥å¯¹è±¡é›†åˆ.</div><div class="line">* </div><div class="line">* <span class="doctag">@return</span> è·¯ç”±çš„é™æ€è¯­å¥å¯¹è±¡é›†åˆ</div><div class="line">*/</div><div class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> Collection&lt;? extends Statement&gt; getRoutedStatements();</div></pre></td></tr></table></figure>
<ul>
<li><code>#getUpdateCount()</code> è°ƒç”¨æŒæœ‰çš„ Statement è®¡ç®—æ›´æ–°æ•°é‡</li>
<li><code>#getRoutedStatements()</code> å’Œåˆ†åº“åˆ†è¡¨ç›¸å…³ï¼Œå› è€Œä»…æŠ½è±¡è¯¥æ–¹æ³•ï¼Œç•™ç»™å­ç±»å®ç°</li>
</ul>
<h2 id="3-5-AbstractPreparedStatementAdapter"><a href="#3-5-AbstractPreparedStatementAdapter" class="headerlink" title="3.5 AbstractPreparedStatementAdapter"></a>3.5 AbstractPreparedStatementAdapter</h2><p><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/jdbc/adapter/AbstractPreparedStatementAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractPreparedStatementAdapter</a>ï¼Œé¢„ç¼–è¯‘è¯­å¥å¯¹è±¡çš„é€‚é…ç±»ã€‚</p>
<p><strong><code>#recordSetParameter()</code>å®ç°å¯¹å ä½ç¬¦å‚æ•°çš„è®¾ç½®</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* è®°å½•çš„è®¾ç½®å‚æ•°æ–¹æ³•æ•°ç»„</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;SetParameterMethodInvocation&gt; setParameterMethodInvocations = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line"><span class="comment">/**</span></div><div class="line">* å‚æ•°</div><div class="line">*/</div><div class="line"><span class="meta">@Getter</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; parameters = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setInt</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> parameterIndex, <span class="keyword">final</span> <span class="keyword">int</span> x)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   setParameter(parameterIndex, x);</div><div class="line">   recordSetParameter(<span class="string">"setInt"</span>, <span class="keyword">new</span> Class[]&#123;<span class="keyword">int</span>.class, <span class="keyword">int</span>.class&#125;, parameterIndex, x);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®°å½•å ä½ç¬¦å‚æ•°</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> parameterIndex å ä½ç¬¦å‚æ•°ä½ç½®</div><div class="line">* <span class="doctag">@param</span> value å‚æ•°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setParameter</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> parameterIndex, <span class="keyword">final</span> Object value)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (parameters.size() == parameterIndex - <span class="number">1</span>) &#123;</div><div class="line">       parameters.add(value);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = parameters.size(); i &lt;= parameterIndex - <span class="number">1</span>; i++) &#123; <span class="comment">// ç”¨ null å¡«å……å‰é¢æœªè®¾ç½®çš„ä½ç½®</span></div><div class="line">       parameters.add(<span class="keyword">null</span>);</div><div class="line">   &#125;</div><div class="line">   parameters.set(parameterIndex - <span class="number">1</span>, value);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®°å½•è®¾ç½®å‚æ•°æ–¹æ³•è°ƒç”¨</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> methodName æ–¹æ³•åï¼Œä¾‹å¦‚ setIntã€setLong ç­‰</div><div class="line">* <span class="doctag">@param</span> argumentTypes å‚æ•°ç±»å‹</div><div class="line">* <span class="doctag">@param</span> arguments å‚æ•°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recordSetParameter</span><span class="params">(<span class="keyword">final</span> String methodName, <span class="keyword">final</span> Class[] argumentTypes, <span class="keyword">final</span> Object... arguments)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       setParameterMethodInvocations.add(<span class="keyword">new</span> SetParameterMethodInvocation(PreparedStatement.class.getMethod(methodName, argumentTypes), arguments, arguments[<span class="number">1</span>]));</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> NoSuchMethodException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ShardingJdbcException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* å›æ”¾è®°å½•çš„è®¾ç½®å‚æ•°æ–¹æ³•è°ƒç”¨</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> preparedStatement é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">replaySetParameter</span><span class="params">(<span class="keyword">final</span> PreparedStatement preparedStatement)</span> </span>&#123;</div><div class="line">   addParameters();</div><div class="line">   <span class="keyword">for</span> (SetParameterMethodInvocation each : setParameterMethodInvocations) &#123;</div><div class="line">       updateParameterValues(each, parameters.get(each.getIndex() - <span class="number">1</span>)); <span class="comment">// åŒä¸€ä¸ªä½ç½®å¤šæ¬¡è®¾ç½®ï¼Œå€¼å¯èƒ½ä¸ä¸€æ ·ï¼Œéœ€è¦æ›´æ–°ä¸‹</span></div><div class="line">       each.invoke(preparedStatement);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* å½“ä½¿ç”¨åˆ†å¸ƒå¼ä¸»é”®æ—¶ï¼Œç”Ÿæˆåä¼šæ·»åŠ åˆ° parametersï¼Œæ­¤æ—¶ parameters æ•°é‡å¤šäº setParameterMethodInvocationsï¼Œéœ€è¦ç”Ÿæˆè¯¥åˆ†å¸ƒå¼ä¸»é”®çš„ SetParameterMethodInvocation</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addParameters</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = setParameterMethodInvocations.size(); i &lt; parameters.size(); i++) &#123;</div><div class="line">       recordSetParameter(<span class="string">"setObject"</span>, <span class="keyword">new</span> Class[]&#123;<span class="keyword">int</span>.class, Object.class&#125;, i + <span class="number">1</span>, parameters.get(i));</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateParameterValues</span><span class="params">(<span class="keyword">final</span> SetParameterMethodInvocation setParameterMethodInvocation, <span class="keyword">final</span> Object value)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!Objects.equals(setParameterMethodInvocation.getValue(), value)) &#123;</div><div class="line">       setParameterMethodInvocation.changeValueArgument(value); <span class="comment">// ä¿®æ”¹å ä½ç¬¦å‚æ•°</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>é€»è¾‘ç±»ä¼¼ <code>WrapperAdapter</code> çš„ <code>#recordMethodInvocation()</code>ï¼Œ<code>#replayMethodsInvocation()</code>ï¼Œè¯·<strong>è®¤çœŸ</strong>é˜…è¯»ä»£ç æ³¨é‡Š</p>
</li>
<li><p>SetParameterMethodInvocationï¼Œç»§æ‰¿ JdbcMethodInvocationï¼Œåå°„è°ƒç”¨å‚æ•°è®¾ç½®æ–¹æ³•çš„å·¥å…·ç±»ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SetParameterMethodInvocation</span> <span class="keyword">extends</span> <span class="title">JdbcMethodInvocation</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å‚æ•°å€¼</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object value;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è®¾ç½®å‚æ•°å€¼.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> value å‚æ•°å€¼</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changeValueArgument</span><span class="params">(<span class="keyword">final</span> Object value)</span> </span>&#123;</div><div class="line">        getArguments()[<span class="number">1</span>] = value;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="3-6-AbstractResultSetAdapter"><a href="#3-6-AbstractResultSetAdapter" class="headerlink" title="3.6 AbstractResultSetAdapter"></a>3.6 AbstractResultSetAdapter</h2><p><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/jdbc/adapter/AbstractResultSetAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractResultSetAdapter</a>ï¼Œä»£ç†ç»“æœé›†é€‚é…å™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractResultSetAdapter</span> <span class="keyword">extends</span> <span class="title">AbstractUnsupportedOperationResultSet</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç»“æœé›†é›†åˆ</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ResultSet&gt; resultSets;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="comment">// TODO should return sharding statement in future</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Statement <span class="title">getStatement</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">return</span> getResultSets().get(<span class="number">0</span>).getStatement();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ResultSetMetaData <span class="title">getMetaData</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">return</span> getResultSets().get(<span class="number">0</span>).getMetaData();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findColumn</span><span class="params">(<span class="keyword">final</span> String columnLabel)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">return</span> getResultSets().get(<span class="number">0</span>).findColumn(columnLabel);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// .... çœç•¥å…¶å®ƒæ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="4-æ’å…¥æµç¨‹"><a href="#4-æ’å…¥æµç¨‹" class="headerlink" title="4. æ’å…¥æµç¨‹"></a>4. æ’å…¥æµç¨‹</h1><p>æ’å…¥ä½¿ç”¨<strong>åˆ†å¸ƒå¼ä¸»é”®</strong>ä¾‹å­ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ä»£ç ä»…ä»…æ˜¯ä¾‹å­ï¼Œç”Ÿäº§ç¯å¢ƒä¸‹è¯·æ³¨æ„å¼‚å¸¸å¤„ç†å’Œèµ„æºå…³é—­</span></div><div class="line">String sql = <span class="string">"INSERT INTO t_order(uid, nickname, pid) VALUES (1, '2', ?)"</span>;</div><div class="line">DataSource dataSource = <span class="keyword">new</span> ShardingDataSource(shardingRule);</div><div class="line">Connection conn = dataSource.getConnection();</div><div class="line">PreparedStatement ps = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS); <span class="comment">// è¿”å›ä¸»é”®éœ€è¦  Statement.RETURN_GENERATED_KEYS</span></div><div class="line">ps.setLong(<span class="number">1</span>, <span class="number">100</span>);</div><div class="line">ps.executeUpdate();</div><div class="line">ResultSet rs = ps.getGeneratedKeys();</div><div class="line"><span class="keyword">if</span> (rs.next()) &#123;</div><div class="line">    System.out.println(<span class="string">"id:"</span> + rs.getLong(<span class="number">1</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>è°ƒç”¨ <code>#executeUpdate()</code> æ–¹æ³•ï¼Œå†…éƒ¨è¿‡ç¨‹å¦‚ä¸‹</strong>ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_18/06.png" alt=""></p>
<p>æ˜¯ä¸æ˜¯å¯¹ä¸Šå±‚<strong>å®Œå…¨é€æ˜</strong>ï¼Ÿï¼æˆ‘ä»¬æ¥çœ‹çœ‹å†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingPreparedStatement.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Collection&lt;PreparedStatementUnit&gt; preparedStatementUnits = route();</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> PreparedStatementExecutor(</div><div class="line">               getShardingConnection().getShardingContext().getExecutorEngine(), getRouteResult().getSqlStatement().getType(), preparedStatementUnits, getParameters()).executeUpdate();</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       clearBatch();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p><code>#route()</code> åˆ†åº“åˆ†è¡¨è·¯ç”±ï¼Œè·å¾—é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒ( PreparedStatementUnit )é›†åˆã€‚</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PreparedStatementUnit</span> <span class="keyword">implements</span> <span class="title">BaseStatementUnit</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL æ‰§è¡Œå•å…ƒ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SQLExecutionUnit sqlExecutionUnit;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PreparedStatement statement;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p><code>#executeUpdate()</code> è°ƒç”¨<a href="http://www.yunai.me/Sharding-JDBC/sql-execute/?self">æ‰§è¡Œå¼•æ“</a><strong>å¹¶è¡Œ</strong>æ‰§è¡Œ<strong>å¤šä¸ª</strong>é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡ã€‚æ‰§è¡Œæ—¶ï¼Œæœ€ç»ˆè°ƒç”¨é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡( PreparedStatement )ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PreparedStatementExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">()</span> </span>&#123;</div><div class="line">   Context context = MetricsContext.start(<span class="string">"ShardingPreparedStatement-executeUpdate"</span>);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       List&lt;Integer&gt; results = executorEngine.executePreparedStatement(sqlType, preparedStatementUnits, parameters, <span class="keyword">new</span> ExecuteCallback&lt;Integer&gt;() &#123;</div><div class="line">           </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> Integer <span class="title">execute</span><span class="params">(<span class="keyword">final</span> BaseStatementUnit baseStatementUnit)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">               <span class="comment">// è°ƒç”¨ PreparedStatement#executeUpdate()</span></div><div class="line">               <span class="keyword">return</span> ((PreparedStatement) baseStatementUnit.getStatement()).executeUpdate();</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       <span class="keyword">return</span> accumulate(results);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       MetricsContext.stop(context);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingPreparedStatement.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;PreparedStatementUnit&gt; <span class="title">route</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   Collection&lt;PreparedStatementUnit&gt; result = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">   <span class="comment">// è·¯ç”±</span></div><div class="line">   setRouteResult(routingEngine.route(getParameters()));</div><div class="line">   <span class="comment">// éå† SQL æ‰§è¡Œå•å…ƒ</span></div><div class="line">   <span class="keyword">for</span> (SQLExecutionUnit each : getRouteResult().getExecutionUnits()) &#123;</div><div class="line">       SQLType sqlType = getRouteResult().getSqlStatement().getType();</div><div class="line">       Collection&lt;PreparedStatement&gt; preparedStatements;</div><div class="line">       <span class="comment">// åˆ›å»ºå®é™…çš„ PreparedStatement</span></div><div class="line">       <span class="keyword">if</span> (SQLType.DDL == sqlType) &#123;</div><div class="line">           preparedStatements = generatePreparedStatementForDDL(each);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           preparedStatements = Collections.singletonList(generatePreparedStatement(each));</div><div class="line">       &#125;</div><div class="line">       getRoutedStatements().addAll(preparedStatements);</div><div class="line">       <span class="comment">// å›æ”¾è®¾ç½®å ä½ç¬¦å‚æ•°åˆ° PreparedStatement</span></div><div class="line">       <span class="keyword">for</span> (PreparedStatement preparedStatement : preparedStatements) &#123;</div><div class="line">           replaySetParameter(preparedStatement);</div><div class="line">           result.add(<span class="keyword">new</span> PreparedStatementUnit(each, preparedStatement));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ›å»º PreparedStatement</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlExecutionUnit SQL æ‰§è¡Œå•å…ƒ</div><div class="line">* <span class="doctag">@return</span> PreparedStatement</div><div class="line">* <span class="doctag">@throws</span> SQLException å½“ JDBC æ“ä½œå‘ç”Ÿå¼‚å¸¸æ—¶</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> PreparedStatement <span class="title">generatePreparedStatement</span><span class="params">(<span class="keyword">final</span> SQLExecutionUnit sqlExecutionUnit)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   Optional&lt;GeneratedKey&gt; generatedKey = getGeneratedKey();</div><div class="line">   <span class="comment">// è·å¾—è¿æ¥</span></div><div class="line">   Connection connection = getShardingConnection().getConnection(sqlExecutionUnit.getDataSource(), getRouteResult().getSqlStatement().getType());</div><div class="line">   <span class="comment">// å£°æ˜è¿”å›ä¸»é”®</span></div><div class="line">   <span class="keyword">if</span> (isReturnGeneratedKeys() || isReturnGeneratedKeys() &amp;&amp; generatedKey.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span> connection.prepareStatement(sqlExecutionUnit.getSql(), RETURN_GENERATED_KEYS);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> connection.prepareStatement(sqlExecutionUnit.getSql(), getResultSetType(), getResultSetConcurrency(), getResultSetHoldability());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>#generatePreparedStatement()</code> åˆ›å»º PreparedStatementï¼Œåè°ƒç”¨ <code>#replaySetParameter()</code> å›æ”¾è®¾ç½®å ä½ç¬¦å‚æ•°åˆ° PreparedStatement</li>
<li><p>å½“ <strong>å£°æ˜è¿”å›ä¸»é”®</strong> æ—¶ï¼Œå³ <code>#isReturnGeneratedKeys()</code> è¿”å› <code>true</code> æ—¶ï¼Œè°ƒç”¨ <code>connection.prepareStatement(sqlExecutionUnit.getSql(), RETURN_GENERATED_KEYS)</code>ã€‚ä¸ºä»€ä¹ˆè¯¥æ–¹æ³•ä¼šè¿”å› <code>true</code>ï¼Ÿä¸Šæ–‡ä¾‹å­ <code>conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)</code></p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingConnection.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> PreparedStatement <span class="title">prepareStatement</span><span class="params">(<span class="keyword">final</span> String sql, <span class="keyword">final</span> String[] columnNames)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line"> <span class="keyword">return</span> <span class="keyword">new</span> ShardingPreparedStatement(<span class="keyword">this</span>, sql, Statement.RETURN_GENERATED_KEYS);</div><div class="line">&#125;</div><div class="line">   </div><div class="line"><span class="comment">// ShardingPreparedStatement.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ShardingPreparedStatement</span><span class="params">(<span class="keyword">final</span> ShardingConnection shardingConnection, <span class="keyword">final</span> String sql, <span class="keyword">final</span> <span class="keyword">int</span> autoGeneratedKeys)</span> </span>&#123;</div><div class="line"> <span class="keyword">this</span>(shardingConnection, sql);</div><div class="line"> <span class="keyword">if</span> (RETURN_GENERATED_KEYS == autoGeneratedKeys) &#123;</div><div class="line">     markReturnGeneratedKeys();</div><div class="line"> &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">markReturnGeneratedKeys</span><span class="params">()</span> </span>&#123;</div><div class="line"> returnGeneratedKeys = <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  <strong>å£°æ˜è¿”å›ä¸»é”®</strong>åï¼Œæ’å…¥æ‰§è¡Œå®Œæˆï¼Œæˆ‘ä»¬è°ƒç”¨ <code>#getGeneratedKeys()</code> å¯ä»¥è·å¾—ä¸»é”® ï¼š</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingStatement.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ResultSet <span class="title">getGeneratedKeys</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    Optional&lt;GeneratedKey&gt; generatedKey = getGeneratedKey();</div><div class="line">    <span class="comment">// åˆ†å¸ƒå¼ä¸»é”®</span></div><div class="line">    <span class="keyword">if</span> (generatedKey.isPresent() &amp;&amp; returnGeneratedKeys) &#123;</div><div class="line">         <span class="keyword">return</span> <span class="keyword">new</span> GeneratedKeysResultSet(routeResult.getGeneratedKeys().iterator(), generatedKey.get().getColumn(), <span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// æ•°æ®åº“è‡ªå¢</span></div><div class="line">    <span class="keyword">if</span> (<span class="number">1</span> == getRoutedStatements().size()) &#123;</div><div class="line">        <span class="keyword">return</span> getRoutedStatements().iterator().next().getGeneratedKeys();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> GeneratedKeysResultSet();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>ShardingConnection#getConnection()</code> æ–¹æ³•è·å¾—è¯¥ PreparedStatement å¯¹åº”çš„<strong>çœŸå®</strong>æ•°æ®åº“è¿æ¥( Connection )ï¼š  </p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingConnection.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * æ ¹æ®æ•°æ®æºåç§°è·å–ç›¸åº”çš„æ•°æ®åº“è¿æ¥.</div><div class="line"> * </div><div class="line"> * <span class="doctag">@param</span> dataSourceName æ•°æ®æºåç§°</div><div class="line"> * <span class="doctag">@param</span> sqlType SQLè¯­å¥ç±»å‹</div><div class="line"> * <span class="doctag">@return</span> æ•°æ®åº“è¿æ¥</div><div class="line"> * <span class="doctag">@throws</span> SQLException SQLå¼‚å¸¸</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">(<span class="keyword">final</span> String dataSourceName, <span class="keyword">final</span> SQLType sqlType)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    <span class="comment">// ä»è¿æ¥ç¼“å­˜ä¸­è·å–è¿æ¥</span></div><div class="line">    Optional&lt;Connection&gt; connection = getCachedConnection(dataSourceName, sqlType);</div><div class="line">    <span class="keyword">if</span> (connection.isPresent()) &#123;</div><div class="line">        <span class="keyword">return</span> connection.get();</div><div class="line">    &#125;</div><div class="line">    Context metricsContext = MetricsContext.start(Joiner.on(<span class="string">"-"</span>).join(<span class="string">"ShardingConnection-getConnection"</span>, dataSourceName));</div><div class="line">    <span class="comment">//</span></div><div class="line">    DataSource dataSource = shardingContext.getShardingRule().getDataSourceRule().getDataSource(dataSourceName);</div><div class="line">    Preconditions.checkState(<span class="keyword">null</span> != dataSource, <span class="string">"Missing the rule of %s in DataSourceRule"</span>, dataSourceName);</div><div class="line">    String realDataSourceName;</div><div class="line">    <span class="keyword">if</span> (dataSource <span class="keyword">instanceof</span> MasterSlaveDataSource) &#123;</div><div class="line">        dataSource = ((MasterSlaveDataSource) dataSource).getDataSource(sqlType);</div><div class="line">        realDataSourceName = MasterSlaveDataSource.getDataSourceName(dataSourceName, sqlType);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        realDataSourceName = dataSourceName;</div><div class="line">    &#125;</div><div class="line">    Connection result = dataSource.getConnection();</div><div class="line">    MetricsContext.stop(metricsContext);</div><div class="line">    <span class="comment">// æ·»åŠ åˆ°è¿æ¥ç¼“å­˜</span></div><div class="line">    connectionMap.put(realDataSourceName, result);</div><div class="line">    <span class="comment">// å›æ”¾ Connection æ–¹æ³•</span></div><div class="line">    replayMethodsInvocation(result);</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Optional&lt;Connection&gt; <span class="title">getCachedConnection</span><span class="params">(<span class="keyword">final</span> String dataSourceName, <span class="keyword">final</span> SQLType sqlType)</span> </span>&#123;</div><div class="line">    String key = connectionMap.containsKey(dataSourceName) ? dataSourceName : MasterSlaveDataSource.getDataSourceName(dataSourceName, sqlType);</div><div class="line">    <span class="keyword">return</span> Optional.fromNullable(connectionMap.get(key));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ <code>#getCachedConnection()</code> å°è¯•è·å¾—<strong>å·²ç¼“å­˜</strong>çš„æ•°æ®åº“è¿æ¥ï¼›å¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œè·å–åˆ°è¿æ¥åä¼šè¿›è¡Œ<strong>ç¼“å­˜</strong></li>
<li>ä» ShardingRule é…ç½®çš„ DataSourceRule è·å–<strong>çœŸå®</strong>çš„æ•°æ®æº( DataSource )</li>
<li>MasterSlaveDataSource å®ç°<strong>ä¸»ä»</strong>æ•°æ®æºå°è£…ï¼Œæˆ‘ä»¬åœ¨<em>ä¸‹å°èŠ‚</em>åˆ†äº«</li>
<li>è°ƒç”¨ <code>#replayMethodsInvocation()</code> å›æ”¾è®°å½•çš„ Connection æ–¹æ³•</li>
</ul>
</li>
</ul>
<p><em>æ’å…¥å®ç°çš„ä»£ç åŸºæœ¬åˆ†äº«å®Œäº†ï¼Œå› ä¸ºæ˜¯ä¸æ–­ä»£ç ä¸‹é’»çš„æ–¹å¼åˆ†æï¼Œå¯ä»¥åå‘å‘ä¸Šåœ¨ç†ç†ï¼Œä¼šæ›´åŠ æ¸…æ™°</em>ã€‚</p>
<h1 id="5-æŸ¥è¯¢æµç¨‹"><a href="#5-æŸ¥è¯¢æµç¨‹" class="headerlink" title="5. æŸ¥è¯¢æµç¨‹"></a>5. æŸ¥è¯¢æµç¨‹</h1><p>å•çº¯ä» <code>core</code> åŒ…é‡Œçš„ JDBC å®ç°ï¼ŒæŸ¥è¯¢æµç¨‹ <code>#executeQuery()</code> å’Œ <code>#execute()</code> åŸºæœ¬ä¸€è‡´ï¼Œå·®åˆ«åœ¨äº<strong>æ‰§è¡Œ</strong>å’Œ<strong>å¤šç»“æœé›†å½’å¹¶</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ResultSet <span class="title">executeQuery</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   ResultSet result;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// è·¯ç”±</span></div><div class="line">       Collection&lt;PreparedStatementUnit&gt; preparedStatementUnits = route();</div><div class="line">       <span class="comment">// æ‰§è¡Œ</span></div><div class="line">       List&lt;ResultSet&gt; resultSets = <span class="keyword">new</span> PreparedStatementExecutor(</div><div class="line">               getShardingConnection().getShardingContext().getExecutorEngine(), getRouteResult().getSqlStatement().getType(), preparedStatementUnits, getParameters()).executeQuery();</div><div class="line">       <span class="comment">// ç»“æœå½’å¹¶</span></div><div class="line">       result = <span class="keyword">new</span> ShardingResultSet(resultSets, <span class="keyword">new</span> MergeEngine(</div><div class="line">               getShardingConnection().getShardingContext().getDatabaseType(), resultSets, (SelectStatement) getRouteResult().getSqlStatement()).merge());</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       clearBatch();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è®¾ç½®ç»“æœé›†</span></div><div class="line">   setCurrentResultSet(result);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>SQLæ‰§è¡Œ</strong> æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ï¼š<a href="http://www.yunai.me/Sharding-JDBC/sql-execute/?self">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œã€‹</a></li>
<li><strong>ç»“æœå½’å¹¶</strong> æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ï¼š<a href="http://www.yunai.me/Sharding-JDBC/result-merger/?self">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” ç»“æœå½’å¹¶ã€‹</a></li>
<li><p>ç»“æœå½’å¹¶ <code>#merge()</code> å®Œåï¼Œåˆ›å»ºåˆ†ç‰‡ç»“æœé›†( ShardingResultSet )</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ShardingResultSet</span> <span class="keyword">extends</span> <span class="title">AbstractResultSetAdapter</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å½’å¹¶ç»“æœé›†</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResultSetMerger mergeResultSet;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        Object result = mergeResultSet.getValue(columnIndex, <span class="keyword">int</span>.class);</div><div class="line">        wasNull = <span class="keyword">null</span> == result;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) ResultSetUtil.convertValue(result, <span class="keyword">int</span>.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">final</span> String columnLabel)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        Object result = mergeResultSet.getValue(columnLabel, <span class="keyword">int</span>.class);</div><div class="line">        wasNull = <span class="keyword">null</span> == result;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) ResultSetUtil.convertValue(result, <span class="keyword">int</span>.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// .... éšè—å…¶ä»–ç±»ä¼¼ getXXXX() æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="6-è¯»å†™åˆ†ç¦»"><a href="#6-è¯»å†™åˆ†ç¦»" class="headerlink" title="6. è¯»å†™åˆ†ç¦»"></a>6. è¯»å†™åˆ†ç¦»</h1><p>å»ºè®®å‰ç½®é˜…è¯»ï¼š<a href="http://dangdangdotcom.github.io/sharding-jdbc/02-guide/master-slave/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” è¯»å†™åˆ†ç¦»ã€‹</a></p>
<p>å½“ä½ æœ‰è¯»å†™åˆ†ç¦»çš„éœ€æ±‚æ—¶ï¼Œå°† ShardingRule é…ç½®<strong>å¯¹åº”çš„æ•°æ®æº</strong> ä» ShardingDataSource æ›¿æ¢æˆ MasterSlaveDataSourceã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ MasterSlaveDataSource çš„åŠŸèƒ½å’Œå®ç°ã€‚</p>
<p><strong>æ”¯æŒä¸€ä¸»å¤šä»çš„è¯»å†™åˆ†ç¦»é…ç½®ï¼Œå¯é…åˆåˆ†åº“åˆ†è¡¨ä½¿ç”¨</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MasterSlaveDataSourceFactory.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MasterSlaveDataSourceFactory</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ›å»ºè¯»å†™åˆ†ç¦»æ•°æ®æº.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> name è¯»å†™åˆ†ç¦»æ•°æ®æºåç§°</div><div class="line">     * <span class="doctag">@param</span> masterDataSource ä¸»èŠ‚ç‚¹æ•°æ®æº</div><div class="line">     * <span class="doctag">@param</span> slaveDataSource ä»èŠ‚ç‚¹æ•°æ®æº</div><div class="line">     * <span class="doctag">@param</span> otherSlaveDataSources å…¶ä»–ä»èŠ‚ç‚¹æ•°æ®æº</div><div class="line">     * <span class="doctag">@return</span> è¯»å†™åˆ†ç¦»æ•°æ®æº</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DataSource <span class="title">createDataSource</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> DataSource masterDataSource, <span class="keyword">final</span> DataSource slaveDataSource, <span class="keyword">final</span> DataSource... otherSlaveDataSources)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MasterSlaveDataSource(name, masterDataSource, Lists.asList(slaveDataSource, otherSlaveDataSources));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// MasterSlaveDataSource.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MasterSlaveDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractDataSourceAdapter</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•°æ®æºå</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸»æ•°æ®æº</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource masterDataSource;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä»æ•°æ®æºé›†åˆ</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;DataSource&gt; slaveDataSources;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>åŒä¸€çº¿ç¨‹ä¸”åŒä¸€æ•°æ®åº“è¿æ¥å†…ï¼Œå¦‚æœ‰å†™å…¥æ“ä½œï¼Œä»¥åçš„è¯»æ“ä½œå‡ä»ä¸»åº“è¯»å–ï¼Œç”¨äºä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingConnection.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">(<span class="keyword">final</span> String dataSourceName, <span class="keyword">final</span> SQLType sqlType)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">   String realDataSourceName;</div><div class="line">   <span class="keyword">if</span> (dataSource <span class="keyword">instanceof</span> MasterSlaveDataSource) &#123; <span class="comment">// è¯»å†™åˆ†ç¦»</span></div><div class="line">       dataSource = ((MasterSlaveDataSource) dataSource).getDataSource(sqlType);</div><div class="line">       realDataSourceName = MasterSlaveDataSource.getDataSourceName(dataSourceName, sqlType);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       realDataSourceName = dataSourceName;</div><div class="line">   &#125;</div><div class="line">   Connection result = dataSource.getConnection();</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// MasterSlaveDataSource.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ DML æ“ä½œæ ‡è¯†</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Boolean&gt; DML_FLAG = <span class="keyword">new</span> ThreadLocal&lt;Boolean&gt;() &#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> Boolean <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">/**</span></div><div class="line">* ä»åº“è´Ÿè½½å‡è¡¡ç­–ç•¥</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> SlaveLoadBalanceStrategy slaveLoadBalanceStrategy = <span class="keyword">new</span> RoundRobinSlaveLoadBalanceStrategy();</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–ä¸»æˆ–ä»èŠ‚ç‚¹çš„æ•°æ®æº.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlType SQLç±»å‹</div><div class="line">* <span class="doctag">@return</span> ä¸»æˆ–ä»èŠ‚ç‚¹çš„æ•°æ®æº</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">(<span class="keyword">final</span> SQLType sqlType)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (isMasterRoute(sqlType)) &#123;</div><div class="line">       DML_FLAG.set(<span class="keyword">true</span>);</div><div class="line">       <span class="keyword">return</span> masterDataSource;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> slaveLoadBalanceStrategy.getDataSource(name, slaveDataSources);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isMasterRoute</span><span class="params">(<span class="keyword">final</span> SQLType sqlType)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> SQLType.DQL != sqlType || DML_FLAG.get() || HintManagerHolder.isMasterRouteOnly();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ShardingConnection è·å–åˆ°çš„æ•°æ®æºæ˜¯ MasterSlaveDataSource æ—¶ï¼Œè°ƒç”¨ <code>MasterSlaveDataSource#getConnection()</code> æ–¹æ³•è·å–<strong>çœŸå®</strong>çš„æ•°æ®æº</li>
<li>é€šè¿‡ <code>#isMasterRoute()</code> åˆ¤æ–­æ˜¯å¦è¯»å–<strong>ä¸»åº“</strong>ï¼Œä»¥ä¸‹ä¸‰ç§æƒ…å†µä¼šè®¿é—®ä¸»åº“ï¼š<ul>
<li>éæŸ¥è¯¢è¯­å¥ (DQL)</li>
<li><strong>è¯¥</strong>æ•°æ®æºåœ¨<strong>å½“å‰</strong>çº¿ç¨‹è®¿é—®è¿‡ä¸»åº“ï¼šé€šè¿‡çº¿ç¨‹å˜é‡ <code>DML_FLAG</code> å®ç°</li>
<li>å¼ºåˆ¶ä¸»åº“ï¼šç¨‹åºé‡Œè°ƒç”¨ <code>HintManager.getInstance().setMasterRouteOnly()</code> å®ç°</li>
</ul>
</li>
<li><p>è®¿é—®ä»åº“æ—¶ï¼Œä¼šé€šè¿‡è´Ÿè½½å‡è¡¡ç­–ç•¥( SlaveLoadBalanceStrategy ) é€‰æ‹©ä¸€ä¸ªä»åº“</p>
<pre><code class="Java"><span class="comment">// SlaveLoadBalanceStrategy.java</span>
<span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SlaveLoadBalanceStrategy</span> </span>{

    <span class="comment">/**
     * æ ¹æ®è´Ÿè½½å‡è¡¡ç­–ç•¥è·å–ä»åº“æ•°æ®æº.
     * 
     * <span class="doctag">@param</span> name è¯»å†™åˆ†ç¦»æ•°æ®æºåç§°
     * <span class="doctag">@param</span> slaveDataSources ä»åº“æ•°æ®æºåˆ—è¡¨
     * <span class="doctag">@return</span> é€‰ä¸­çš„ä»åº“æ•°æ®æº
     */</span>
    <span class="function">DataSource <span class="title">getDataSource</span><span class="params">(String name, List&lt;DataSource&gt; slaveDataSources)</span></span>;
}

<span class="comment">// RoundRobinSlaveLoadBalanceStrategy.java</span>
<span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RoundRobinSlaveLoadBalanceStrategy</span> <span class="keyword">implements</span> <span class="title">SlaveLoadBalanceStrategy</span> </span>{

    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, AtomicInteger&gt; COUNT_MAP = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();

    <span class="meta">@Override</span>
    <span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> List&lt;DataSource&gt; slaveDataSources)</span> </span>{
        AtomicInteger count = COUNT_MAP.containsKey(name) ? COUNT_MAP.get(name) : <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);
        COUNT_MAP.putIfAbsent(name, count);
        count.compareAndSet(slaveDataSources.size(), <span class="number">0</span>);
        <span class="keyword">return</span> slaveDataSources.get(count.getAndIncrement() % slaveDataSources.size());
    }
}
</code></pre>
<ul>
<li>MasterSlaveDataSource é»˜è®¤ä½¿ç”¨ RoundRobinSlaveLoadBalanceStrategyï¼Œæš‚æ—¶ä¸æ”¯æŒé…ç½®</li>
<li>RoundRobinSlaveLoadBalanceStrategyï¼Œè½®è¯¢è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œ<strong>æ¯ä¸ªä»èŠ‚ç‚¹è®¿é—®æ¬¡æ•°å‡è¡¡ï¼Œæš‚ä¸æ”¯æŒæ•°æ®æºæ•…éšœç§»é™¤</strong></li>
</ul>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ²¡æœ‰å½©è›‹<br>æ²¡æœ‰å½©<br>æ²¡æœ‰<br>æ²¡  </p>
<p>ä¸‹ä¸€ç¯‡ï¼Œ<a href="http://www.yunai.me/Sharding-JDBC/transaction-bed/?self">ã€Šåˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆä¸€ï¼‰ä¹‹æœ€å¤§åŠªåŠ›å‹ã€‹</a>èµ°èµ·ã€‚è€å¸æœºï¼Œèµ¶ç´§ä¸Šè½¦ã€‚</p>
<p>é“å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿä¸ç„¶äº¤ä¸ªé“å§‘é‚£<del>æ•æ„Ÿè¯</del>ä½ ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘&lt;/strong&gt;æœ‰
    
    </summary>
    
      <category term="Sharding-JDBC" scheme="http://www.yunai.me/categories/Sharding-JDBC/"/>
    
    
  </entry>
  
</feed>
