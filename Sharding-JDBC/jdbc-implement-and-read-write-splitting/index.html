<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>Sharding-JDBC æºç åˆ†æ â€”â€” JDBCå®ç°ä¸è¯»å†™åˆ†ç¦» | èŠ‹è‰¿Vçš„åšå®¢</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="ç‹æ–‡æ–Œ"><meta name="description" content="ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘æœ‰ç¦åˆ©ï¼š  

RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨  
RocketMQ / MyCAT / Sharding-JDBC ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€  
æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚ç”šè‡³ä¸"><meta name="keywords" content="Sharding-JDBC,ShardingJDBC,Sharding-JDBC æºç ,JDBC,è¯»å†™åˆ†ç¦»,Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹è‰¿Vçš„åšå®¢" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?ef4ed89f6dc83d01803a2440ae21e666";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹è‰¿Vçš„åšå®¢">èŠ‹è‰¿Vçš„åšå®¢</a></h1><a class="blog-motto">æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li><li><a href="/link_url">å‹é“¾</a></li></ul></ul></nav></div></header><div id="container"><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-unspported-åŒ…"><span class="toc-number">2.</span> <span class="toc-text">2. unspported åŒ…</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-adapter-åŒ…"><span class="toc-number">3.</span> <span class="toc-text">3. adapter åŒ…</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-WrapperAdapter"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 WrapperAdapter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-AbstractDataSourceAdapter"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 AbstractDataSourceAdapter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-AbstractConnectionAdapter"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 AbstractConnectionAdapter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-AbstractStatementAdapter"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 AbstractStatementAdapter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-AbstractPreparedStatementAdapter"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 AbstractPreparedStatementAdapter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-AbstractResultSetAdapter"><span class="toc-number">3.6.</span> <span class="toc-text">3.6 AbstractResultSetAdapter</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-æ’å…¥æµç¨‹"><span class="toc-number">4.</span> <span class="toc-text">4. æ’å…¥æµç¨‹</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-æŸ¥è¯¢æµç¨‹"><span class="toc-number">5.</span> <span class="toc-text">5. æŸ¥è¯¢æµç¨‹</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-è¯»å†™åˆ†ç¦»"><span class="toc-number">6.</span> <span class="toc-text">6. è¯»å†™åˆ†ç¦»</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-å½©è›‹"><span class="toc-number">7.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/Elastic-Job/" title="Elastic-Job">Elastic-Job<sup>10</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/æŠ€æœ¯æ‚æ–‡/" title="æŠ€æœ¯æ‚æ–‡">æŠ€æœ¯æ‚æ–‡<sup>2</sup></a></li></ul></div></aside></div><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/Sharding-JDBC/jdbc-implement-and-read-write-splitting/" title="Sharding-JDBC æºç åˆ†æ â€”â€” JDBCå®ç°ä¸è¯»å†™åˆ†ç¦»" itemprop="url">Sharding-JDBC æºç åˆ†æ â€”â€” JDBCå®ç°ä¸è¯»å†™åˆ†ç¦»</a></h1><p class="article-author"></p><p class="article-time">æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Sharding-JDBC 1.5.0 æ­£å¼ç‰ˆ</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. unspported åŒ…</a></li><li><a href="#">3. adapter åŒ…</a><ul><li><a href="#">3.1 WrapperAdapter</a></li><li><a href="#">3.2 AbstractDataSourceAdapter</a></li><li><a href="#">3.3 AbstractConnectionAdapter</a></li><li><a href="#">3.4 AbstractStatementAdapter</a></li><li><a href="#">3.5 AbstractPreparedStatementAdapter</a></li><li><a href="#">3.6 AbstractResultSetAdapter</a></li></ul></li><li><a href="#">4. æ’å…¥æµç¨‹</a></li><li><a href="#">5. æŸ¥è¯¢æµç¨‹</a></li><li><a href="#">6. è¯»å†™åˆ†ç¦»</a></li><li><a href="#">666. <del>å½©è›‹</del></a></li></ul><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>JDBC</strong> ä¸ <strong>è¯»å†™åˆ†ç¦»</strong> çš„å®ç°ã€‚ä¸ºä»€ä¹ˆä¼šæŠŠè¿™ä¸¤ä¸ªä¸œè¥¿æ”¾åœ¨ä¸€èµ·è®²å‘¢ï¼Ÿå®¢æˆ·ç«¯ç›´è¿æ•°æ®åº“çš„è¯»å†™åˆ†ç¦»ä¸»è¦é€šè¿‡è·å–è¯»åº“å’Œå†™åº“çš„ä¸åŒè¿æ¥æ¥å®ç°ï¼Œå’Œ JDBC Connection åˆšå¥½æ”¾åœ¨ä¸€å—ã€‚</p><p>OKï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€æ®µ Sharding-JDBC å®˜æ–¹å¯¹è‡ªå·±çš„å®šä¹‰å’Œå®šä½</p><blockquote><p>Sharding-JDBCå®šä½ä¸ºè½»é‡çº§javaæ¡†æ¶ï¼Œä½¿ç”¨å®¢æˆ·ç«¯ç›´è¿æ•°æ®åº“ï¼Œä»¥jaråŒ…å½¢å¼æä¾›æœåŠ¡ï¼Œæœªä½¿ç”¨ä¸­é—´å±‚ï¼Œæ— éœ€é¢å¤–éƒ¨ç½²ï¼Œæ— å…¶ä»–ä¾èµ–ï¼ŒDBAä¹Ÿæ— éœ€æ”¹å˜åŸæœ‰çš„è¿ç»´æ–¹å¼ï¼Œå¯ç†è§£ä¸º<strong>å¢å¼ºç‰ˆçš„JDBCé©±åŠ¨</strong>ï¼Œæ—§ä»£ç è¿ç§»æˆæœ¬å‡ ä¹ä¸ºé›¶ã€‚</p></blockquote><p>å¯ä»¥çœ‹å‡ºï¼ŒSharding-JDBC é€šè¿‡å®ç° <strong>JDBCè§„èŒƒ</strong>ï¼Œå¯¹ä¸Šå±‚æä¾›é€æ˜åŒ–æ•°æ®åº“åˆ†åº“åˆ†è¡¨çš„è®¿é—®ã€‚ğŸ˜ˆ é»‘ç§‘æŠ€ï¼Ÿå®é™…æˆ‘ä»¬ä½¿ç”¨çš„<strong>æ•°æ®åº“è¿æ¥æ± </strong>ä¹Ÿæ˜¯é€šè¿‡è¿™ç§æ–¹å¼å®ç°å¯¹ä¸Šå±‚æ— æ„ŸçŸ¥çš„æä¾›è¿æ¥æ± ã€‚ç”šè‡³è¿˜å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼å®ç°å¯¹ Luceneã€<a href="http://www.yunai.me/MyCAT/connect-mongodb/?self">MongoDB</a> ç­‰ç­‰çš„è®¿é—®ã€‚</p><p>æ‰¯è¿œäº†ï¼Œä¸‹é¢æ¥çœ‹çœ‹ Sharding-JDBC <code>jdbc</code> åŒ…çš„ç»“æ„ï¼š</p><p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_18/01.png" alt=""></p><ul><li><code>unsupported</code>ï¼šå£°æ˜<strong>ä¸æ”¯æŒ</strong>çš„æ•°æ®æ“ä½œæ–¹æ³•</li><li><code>adapter</code>ï¼šé€‚é…ç±»ï¼Œå®ç°å’Œåˆ†åº“åˆ†è¡¨<strong>æ— å…³</strong>çš„æ–¹æ³•</li><li><code>core</code>ï¼šæ ¸å¿ƒç±»ï¼Œå®ç°å’Œåˆ†åº“åˆ†è¡¨<strong>ç›¸å…³</strong>çš„æ–¹æ³•</li></ul><p>æ ¹æ® <code>core</code> åŒ…ï¼Œå¯ä»¥çœ‹å‡ºåˆ†åˆ°å››ç§æˆ‘ä»¬<strong>è¶…çº§ç†Ÿæ‚‰</strong>çš„å¯¹è±¡</p><ul><li><p>Datasource</p><p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_18/02.png" alt="-w640"></p></li><li><p>Connection</p><p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_18/03.png" alt="-w640"></p></li><li><p>Statement</p><p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_18/04.png" alt="-w640"></p></li><li><p>ResultSet</p><p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_18/05.png" alt="-w640"></p></li></ul><p><strong>å®ç°</strong>å±‚çº§å¦‚ä¸‹ï¼š<strong>JDBC æ¥å£</strong> &lt;=(ç»§æ‰¿)== <strong><code>unsupported</code>æŠ½è±¡ç±»</strong> &lt;=(ç»§æ‰¿)== <strong><code>unsupported</code>æŠ½è±¡ç±»</strong> &lt;=(ç»§æ‰¿)== <strong><code>core</code>ç±»</strong>ã€‚</p><hr><p><strong>æœ¬æ–‡å†…å®¹é¡ºåº</strong></p><ol><li><code>unspported</code> åŒ…</li><li><code>adapter</code> åŒ…</li><li>æ’å…¥æµç¨‹ï¼Œåˆ†æçš„ç±»ï¼š<ul><li>ShardingDataSource</li><li>ShardingConnection</li><li>ShardingPreparedStatementï¼ˆShardingStatement ç±»ä¼¼ï¼Œä¸é‡å¤åˆ†æï¼‰</li><li>GeneratedKeysResultSetã€GeneratedKeysResultSetMetaData</li></ul></li><li>æŸ¥è¯¢æµç¨‹ï¼Œåˆ†æçš„ç±»ï¼š<ul><li>ShardingPreparedStatement</li><li>ShardingResultSet</li></ul></li><li>è¯»å†™åˆ†ç¦»ï¼Œåˆ†æçš„ç±»ï¼š<ul><li>MasterSlaveDataSource</li></ul></li></ol><hr><blockquote><p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p></blockquote><h1 id="2-unspported-åŒ…"><a href="#2-unspported-åŒ…" class="headerlink" title="2. unspported åŒ…"></a>2. unspported åŒ…</h1><p><code>unspported</code> åŒ…å†…çš„<strong>æŠ½è±¡</strong>ç±»ï¼Œå£°æ˜ä¸æ”¯æŒæ“ä½œçš„æ•°æ®å¯¹è±¡ï¼Œæ‰€æœ‰æ–¹æ³•éƒ½æ˜¯ <code>throw new SQLFeatureNotSupportedException()</code> æ–¹å¼ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractUnsupportedGeneratedKeysResultSet</span> <span class="keyword">extends</span> <span class="title">AbstractUnsupportedOperationResultSet</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SQLFeatureNotSupportedException(<span class="string">"getBoolean"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// .... çœç•¥å…¶å®ƒç±»ä¼¼æ–¹æ³•</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractUnsupportedOperationConnection</span> <span class="keyword">extends</span> <span class="title">WrapperAdapter</span> <span class="keyword">implements</span> <span class="title">Connection</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> CallableStatement <span class="title">prepareCall</span><span class="params">(<span class="keyword">final</span> String sql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SQLFeatureNotSupportedException(<span class="string">"prepareCall"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">   <span class="comment">// .... çœç•¥å…¶å®ƒç±»ä¼¼æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><h1 id="3-adapter-åŒ…"><a href="#3-adapter-åŒ…" class="headerlink" title="3. adapter åŒ…"></a>3. adapter åŒ…</h1><p><code>adapter</code> åŒ…å†…çš„<strong>æŠ½è±¡</strong>ç±»ï¼Œå®ç°å’Œåˆ†åº“åˆ†è¡¨<strong>æ— å…³</strong>çš„æ–¹æ³•ã€‚</p><p><strong>è€ƒè™‘åˆ°ç¬¬4ã€5ä¸¤å°èŠ‚æ›´å®¹æ˜“ç†è§£ï¼Œæœ¬å°èŠ‚è´´çš„ä»£ç ä¼šç›¸å¯¹å¤š</strong></p><h2 id="3-1-WrapperAdapter"><a href="#3-1-WrapperAdapter" class="headerlink" title="3.1 WrapperAdapter"></a>3.1 WrapperAdapter</h2><p><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/jdbc/adapter/WrapperAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">WrapperAdapter</a>ï¼ŒJDBC Wrapper é€‚é…ç±»ã€‚</p><p><strong>å¯¹ Wrapper æ¥å£å®ç°å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> &lt;T&gt; <span class="function">T <span class="title">unwrap</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; iface)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">if</span> (isWrapperFor(iface)) &#123;</div><div class="line">       <span class="keyword">return</span> (T) <span class="keyword">this</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(String.format(<span class="string">"[%s] cannot be unwrapped as [%s]"</span>, getClass().getName(), iface.getName()));</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isWrapperFor</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; iface)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">return</span> iface.isInstance(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p><strong>æä¾›å­ç±» <code>#recordMethodInvocation()</code> è®°å½•æ–¹æ³•è°ƒç”¨ï¼Œ<code>#replayMethodsInvocation()</code> å›æ”¾è®°å½•çš„æ–¹æ³•è°ƒç”¨</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®°å½•çš„æ–¹æ³•æ•°ç»„</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Collection&lt;JdbcMethodInvocation&gt; jdbcMethodInvocations = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®°å½•æ–¹æ³•è°ƒç”¨.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> targetClass ç›®æ ‡ç±»</div><div class="line">* <span class="doctag">@param</span> methodName æ–¹æ³•åç§°</div><div class="line">* <span class="doctag">@param</span> argumentTypes å‚æ•°ç±»å‹</div><div class="line">* <span class="doctag">@param</span> arguments å‚æ•°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">recordMethodInvocation</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; targetClass, <span class="keyword">final</span> String methodName, <span class="keyword">final</span> Class&lt;?&gt;[] argumentTypes, <span class="keyword">final</span> Object[] arguments)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       jdbcMethodInvocations.add(<span class="keyword">new</span> JdbcMethodInvocation(targetClass.getMethod(methodName, argumentTypes), arguments));</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> NoSuchMethodException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ShardingJdbcException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line">* å›æ”¾è®°å½•çš„æ–¹æ³•è°ƒç”¨.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> target ç›®æ ‡å¯¹è±¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">replayMethodsInvocation</span><span class="params">(<span class="keyword">final</span> Object target)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (JdbcMethodInvocation each : jdbcMethodInvocations) &#123;</div><div class="line">       each.invoke(target);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è¿™ä¸¤ä¸ªæ–¹æ³•æœ‰ä»€ä¹ˆç”¨é€”å‘¢ï¼Ÿä¾‹å¦‚ä¸‹æ–‡ä¼šæåˆ°çš„ AbstractConnectionAdapter çš„ <code>#setAutoCommit()</code>ï¼Œå½“å®ƒæ— æ•°æ®åº“è¿æ¥æ—¶ï¼Œå…ˆè®°å½•ï¼›ç­‰è·å¾—åˆ°æ•°æ®è¿æ¥åï¼Œå†å›æ”¾ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractConnectionAdapter.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setAutoCommit</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> autoCommit)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">this</span>.autoCommit = autoCommit;</div><div class="line">   <span class="keyword">if</span> (getConnections().isEmpty()) &#123; <span class="comment">// æ— æ•°æ®è¿æ¥æ—¶ï¼Œè®°å½•æ–¹æ³•è°ƒç”¨</span></div><div class="line">       recordMethodInvocation(Connection.class, <span class="string">"setAutoCommit"</span>, <span class="keyword">new</span> Class[] &#123;<span class="keyword">boolean</span>.class&#125;, <span class="keyword">new</span> Object[] &#123;autoCommit&#125;);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       each.setAutoCommit(autoCommit);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><ul><li><p>JdbcMethodInvocationï¼Œåå°„è°ƒç”¨JDBCç›¸å…³æ–¹æ³•çš„å·¥å…·ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcMethodInvocation</span> </span>&#123;</div><div class="line">    </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * æ–¹æ³•</div><div class="line">    */</div><div class="line">   <span class="meta">@Getter</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Method method;</div><div class="line">   <span class="comment">/**</span></div><div class="line">    * æ–¹æ³•å‚æ•°</div><div class="line">    */</div><div class="line">   <span class="meta">@Getter</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Object[] arguments;</div><div class="line">   </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Â è°ƒç”¨æ–¹æ³•.</div><div class="line">    * </div><div class="line">    * <span class="doctag">@param</span> target ç›®æ ‡å¯¹è±¡</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(<span class="keyword">final</span> Object target)</span> </span>&#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           method.invoke(target, arguments); <span class="comment">// åå°„è°ƒç”¨</span></div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IllegalAccessException | InvocationTargetException ex) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> ShardingJdbcException(<span class="string">"Invoke jdbc method exception"</span>, ex);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><p><strong>æä¾›å­ç±» <code>#throwSQLExceptionIfNecessary()</code> æŠ›å‡ºå¼‚å¸¸é“¾</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">throwSQLExceptionIfNecessary</span><span class="params">(<span class="keyword">final</span> Collection&lt;SQLException&gt; exceptions)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">if</span> (exceptions.isEmpty()) &#123; <span class="comment">// ä¸ºç©ºä¸æŠ›å‡ºå¼‚å¸¸</span></div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   SQLException ex = <span class="keyword">new</span> SQLException();</div><div class="line">   <span class="keyword">for</span> (SQLException each : exceptions) &#123;</div><div class="line">       ex.setNextException(each); <span class="comment">// å¼‚å¸¸é“¾</span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> ex;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="3-2-AbstractDataSourceAdapter"><a href="#3-2-AbstractDataSourceAdapter" class="headerlink" title="3.2 AbstractDataSourceAdapter"></a>3.2 AbstractDataSourceAdapter</h2><p><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/jdbc/adapter/AbstractDataSourceAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractDataSourceAdapter</a>ï¼Œæ•°æ®æºé€‚é…ç±»ã€‚</p><p>ç›´æ¥ç‚¹å‡»é“¾æ¥æŸ¥çœ‹æºç ã€‚</p><h2 id="3-3-AbstractConnectionAdapter"><a href="#3-3-AbstractConnectionAdapter" class="headerlink" title="3.3 AbstractConnectionAdapter"></a>3.3 AbstractConnectionAdapter</h2><p><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/jdbc/adapter/AbstractConnectionAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractConnectionAdapter</a>ï¼Œæ•°æ®åº“è¿æ¥é€‚é…ç±»ã€‚</p><p>æˆ‘ä»¬æ¥ç…ç…å¤§å®¶æœ€å…³å¿ƒçš„<strong>äº‹åŠ¡</strong>ç›¸å…³æ–¹æ³•çš„å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* æ˜¯å¦è‡ªåŠ¨æäº¤</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> autoCommit = <span class="keyword">true</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—é“¾æ¥</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span> é“¾æ¥</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Collection&lt;Connection&gt; <span class="title">getConnections</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">getAutoCommit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">return</span> autoCommit;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setAutoCommit</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> autoCommit)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">this</span>.autoCommit = autoCommit;</div><div class="line">   <span class="keyword">if</span> (getConnections().isEmpty()) &#123; <span class="comment">// æ— æ•°æ®è¿æ¥æ—¶ï¼Œè®°å½•æ–¹æ³•è°ƒç”¨</span></div><div class="line">       recordMethodInvocation(Connection.class, <span class="string">"setAutoCommit"</span>, <span class="keyword">new</span> Class[] &#123;<span class="keyword">boolean</span>.class&#125;, <span class="keyword">new</span> Object[] &#123;autoCommit&#125;);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       each.setAutoCommit(autoCommit);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>#setAutoCommit()</code> è°ƒç”¨æ—¶ï¼Œå®é™…ä¼šè®¾ç½®å…¶æ‰€æŒæœ‰çš„ Connection çš„ <code>autoCommit</code> å±æ€§</li><li><code>#getConnections()</code> å’Œåˆ†åº“åˆ†è¡¨ç›¸å…³ï¼Œå› è€Œä»…æŠ½è±¡è¯¥æ–¹æ³•ï¼Œç•™ç»™å­ç±»å®ç°</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       each.commit();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   Collection&lt;SQLException&gt; exceptions = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           each.rollback();</div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">           exceptions.add(ex);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   throwSQLExceptionIfNecessary(exceptions);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>#commit()</code>ã€<code>#rollback()</code> è°ƒç”¨æ—¶ï¼Œå®é™…è°ƒç”¨å…¶æ‰€æŒæœ‰çš„ Connection çš„æ–¹æ³•</li><li><p>å¼‚å¸¸æƒ…å†µä¸‹ï¼Œ<code>#commit()</code> å’Œ <code>#rollback()</code> å¤„ç†æ–¹å¼ä¸åŒï¼Œç¬”è€…æš‚æ—¶ä¸çŸ¥é“ç­”æ¡ˆï¼Œæ±‚è¯åä¼šè¿›è¡Œæ›´æ–°</p><ul><li><p><code>#commit()</code> å¤„ç†æ–¹å¼éœ€è¦æ”¹æˆå’Œ <code>#rollback()</code> ä¸€æ ·ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   Collection&lt;SQLException&gt; exceptions = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           each.commit();</div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">           exceptions.add(ex);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   throwSQLExceptionIfNecessary(exceptions);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul></li></ul><p>äº‹åŠ¡çº§åˆ«å’Œæ˜¯å¦åªè¯»ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* åªè¯»</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> readOnly = <span class="keyword">true</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line">* äº‹åŠ¡çº§åˆ«</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> transactionIsolation = TRANSACTION_READ_UNCOMMITTED;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setReadOnly</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> readOnly)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">this</span>.readOnly = readOnly;</div><div class="line">   <span class="keyword">if</span> (getConnections().isEmpty()) &#123;</div><div class="line">       recordMethodInvocation(Connection.class, <span class="string">"setReadOnly"</span>, <span class="keyword">new</span> Class[] &#123;<span class="keyword">boolean</span>.class&#125;, <span class="keyword">new</span> Object[] &#123;readOnly&#125;);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       each.setReadOnly(readOnly);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setTransactionIsolation</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> level)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   transactionIsolation = level;</div><div class="line">   <span class="keyword">if</span> (getConnections().isEmpty()) &#123;</div><div class="line">       recordMethodInvocation(Connection.class, <span class="string">"setTransactionIsolation"</span>, <span class="keyword">new</span> Class[] &#123;<span class="keyword">int</span>.class&#125;, <span class="keyword">new</span> Object[] &#123;level&#125;);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (Connection each : getConnections()) &#123;</div><div class="line">       each.setTransactionIsolation(level);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="3-4-AbstractStatementAdapter"><a href="#3-4-AbstractStatementAdapter" class="headerlink" title="3.4 AbstractStatementAdapter"></a>3.4 AbstractStatementAdapter</h2><p><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/jdbc/adapter/AbstractStatementAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractStatementAdapter</a>ï¼Œé™æ€è¯­å¥å¯¹è±¡é€‚é…ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getUpdateCount</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">long</span> result = <span class="number">0</span>;</div><div class="line">   <span class="keyword">boolean</span> hasResult = <span class="keyword">false</span>;</div><div class="line">   <span class="keyword">for</span> (Statement each : getRoutedStatements()) &#123;</div><div class="line">       <span class="keyword">if</span> (each.getUpdateCount() &gt; -<span class="number">1</span>) &#123;</div><div class="line">           hasResult = <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       result += each.getUpdateCount();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (result &gt; Integer.MAX_VALUE) &#123;</div><div class="line">       result = Integer.MAX_VALUE;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> hasResult ? Long.valueOf(result).intValue() : -<span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–è·¯ç”±çš„é™æ€è¯­å¥å¯¹è±¡é›†åˆ.</div><div class="line">* </div><div class="line">* <span class="doctag">@return</span> è·¯ç”±çš„é™æ€è¯­å¥å¯¹è±¡é›†åˆ</div><div class="line">*/</div><div class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> Collection&lt;? extends Statement&gt; getRoutedStatements();</div></pre></td></tr></table></figure><ul><li><code>#getUpdateCount()</code> è°ƒç”¨æŒæœ‰çš„ Statement è®¡ç®—æ›´æ–°æ•°é‡</li><li><code>#getRoutedStatements()</code> å’Œåˆ†åº“åˆ†è¡¨ç›¸å…³ï¼Œå› è€Œä»…æŠ½è±¡è¯¥æ–¹æ³•ï¼Œç•™ç»™å­ç±»å®ç°</li></ul><h2 id="3-5-AbstractPreparedStatementAdapter"><a href="#3-5-AbstractPreparedStatementAdapter" class="headerlink" title="3.5 AbstractPreparedStatementAdapter"></a>3.5 AbstractPreparedStatementAdapter</h2><p><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/jdbc/adapter/AbstractPreparedStatementAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractPreparedStatementAdapter</a>ï¼Œé¢„ç¼–è¯‘è¯­å¥å¯¹è±¡çš„é€‚é…ç±»ã€‚</p><p><strong><code>#recordSetParameter()</code>å®ç°å¯¹å ä½ç¬¦å‚æ•°çš„è®¾ç½®</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* è®°å½•çš„è®¾ç½®å‚æ•°æ–¹æ³•æ•°ç»„</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;SetParameterMethodInvocation&gt; setParameterMethodInvocations = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line"><span class="comment">/**</span></div><div class="line">* å‚æ•°</div><div class="line">*/</div><div class="line"><span class="meta">@Getter</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; parameters = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setInt</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> parameterIndex, <span class="keyword">final</span> <span class="keyword">int</span> x)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   setParameter(parameterIndex, x);</div><div class="line">   recordSetParameter(<span class="string">"setInt"</span>, <span class="keyword">new</span> Class[]&#123;<span class="keyword">int</span>.class, <span class="keyword">int</span>.class&#125;, parameterIndex, x);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®°å½•å ä½ç¬¦å‚æ•°</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> parameterIndex å ä½ç¬¦å‚æ•°ä½ç½®</div><div class="line">* <span class="doctag">@param</span> value å‚æ•°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setParameter</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> parameterIndex, <span class="keyword">final</span> Object value)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (parameters.size() == parameterIndex - <span class="number">1</span>) &#123;</div><div class="line">       parameters.add(value);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = parameters.size(); i &lt;= parameterIndex - <span class="number">1</span>; i++) &#123; <span class="comment">// ç”¨ null å¡«å……å‰é¢æœªè®¾ç½®çš„ä½ç½®</span></div><div class="line">       parameters.add(<span class="keyword">null</span>);</div><div class="line">   &#125;</div><div class="line">   parameters.set(parameterIndex - <span class="number">1</span>, value);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®°å½•è®¾ç½®å‚æ•°æ–¹æ³•è°ƒç”¨</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> methodName æ–¹æ³•åï¼Œä¾‹å¦‚ setIntã€setLong ç­‰</div><div class="line">* <span class="doctag">@param</span> argumentTypes å‚æ•°ç±»å‹</div><div class="line">* <span class="doctag">@param</span> arguments å‚æ•°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recordSetParameter</span><span class="params">(<span class="keyword">final</span> String methodName, <span class="keyword">final</span> Class[] argumentTypes, <span class="keyword">final</span> Object... arguments)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       setParameterMethodInvocations.add(<span class="keyword">new</span> SetParameterMethodInvocation(PreparedStatement.class.getMethod(methodName, argumentTypes), arguments, arguments[<span class="number">1</span>]));</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> NoSuchMethodException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ShardingJdbcException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* å›æ”¾è®°å½•çš„è®¾ç½®å‚æ•°æ–¹æ³•è°ƒç”¨</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> preparedStatement é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">replaySetParameter</span><span class="params">(<span class="keyword">final</span> PreparedStatement preparedStatement)</span> </span>&#123;</div><div class="line">   addParameters();</div><div class="line">   <span class="keyword">for</span> (SetParameterMethodInvocation each : setParameterMethodInvocations) &#123;</div><div class="line">       updateParameterValues(each, parameters.get(each.getIndex() - <span class="number">1</span>)); <span class="comment">// åŒä¸€ä¸ªä½ç½®å¤šæ¬¡è®¾ç½®ï¼Œå€¼å¯èƒ½ä¸ä¸€æ ·ï¼Œéœ€è¦æ›´æ–°ä¸‹</span></div><div class="line">       each.invoke(preparedStatement);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* å½“ä½¿ç”¨åˆ†å¸ƒå¼ä¸»é”®æ—¶ï¼Œç”Ÿæˆåä¼šæ·»åŠ åˆ° parametersï¼Œæ­¤æ—¶ parameters æ•°é‡å¤šäº setParameterMethodInvocationsï¼Œéœ€è¦ç”Ÿæˆè¯¥åˆ†å¸ƒå¼ä¸»é”®çš„ SetParameterMethodInvocation</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addParameters</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = setParameterMethodInvocations.size(); i &lt; parameters.size(); i++) &#123;</div><div class="line">       recordSetParameter(<span class="string">"setObject"</span>, <span class="keyword">new</span> Class[]&#123;<span class="keyword">int</span>.class, Object.class&#125;, i + <span class="number">1</span>, parameters.get(i));</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateParameterValues</span><span class="params">(<span class="keyword">final</span> SetParameterMethodInvocation setParameterMethodInvocation, <span class="keyword">final</span> Object value)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!Objects.equals(setParameterMethodInvocation.getValue(), value)) &#123;</div><div class="line">       setParameterMethodInvocation.changeValueArgument(value); <span class="comment">// ä¿®æ”¹å ä½ç¬¦å‚æ•°</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>é€»è¾‘ç±»ä¼¼ <code>WrapperAdapter</code> çš„ <code>#recordMethodInvocation()</code>ï¼Œ<code>#replayMethodsInvocation()</code>ï¼Œè¯·<strong>è®¤çœŸ</strong>é˜…è¯»ä»£ç æ³¨é‡Š</p></li><li><p>SetParameterMethodInvocationï¼Œç»§æ‰¿ JdbcMethodInvocationï¼Œåå°„è°ƒç”¨å‚æ•°è®¾ç½®æ–¹æ³•çš„å·¥å…·ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SetParameterMethodInvocation</span> <span class="keyword">extends</span> <span class="title">JdbcMethodInvocation</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å‚æ•°å€¼</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object value;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è®¾ç½®å‚æ•°å€¼.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> value å‚æ•°å€¼</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changeValueArgument</span><span class="params">(<span class="keyword">final</span> Object value)</span> </span>&#123;</div><div class="line">        getArguments()[<span class="number">1</span>] = value;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><h2 id="3-6-AbstractResultSetAdapter"><a href="#3-6-AbstractResultSetAdapter" class="headerlink" title="3.6 AbstractResultSetAdapter"></a>3.6 AbstractResultSetAdapter</h2><p><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/jdbc/adapter/AbstractResultSetAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractResultSetAdapter</a>ï¼Œä»£ç†ç»“æœé›†é€‚é…å™¨ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractResultSetAdapter</span> <span class="keyword">extends</span> <span class="title">AbstractUnsupportedOperationResultSet</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç»“æœé›†é›†åˆ</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ResultSet&gt; resultSets;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="comment">// TODO should return sharding statement in future</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Statement <span class="title">getStatement</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">return</span> getResultSets().get(<span class="number">0</span>).getStatement();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ResultSetMetaData <span class="title">getMetaData</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">return</span> getResultSets().get(<span class="number">0</span>).getMetaData();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findColumn</span><span class="params">(<span class="keyword">final</span> String columnLabel)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">return</span> getResultSets().get(<span class="number">0</span>).findColumn(columnLabel);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// .... çœç•¥å…¶å®ƒæ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><h1 id="4-æ’å…¥æµç¨‹"><a href="#4-æ’å…¥æµç¨‹" class="headerlink" title="4. æ’å…¥æµç¨‹"></a>4. æ’å…¥æµç¨‹</h1><p>æ’å…¥ä½¿ç”¨<strong>åˆ†å¸ƒå¼ä¸»é”®</strong>ä¾‹å­ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ä»£ç ä»…ä»…æ˜¯ä¾‹å­ï¼Œç”Ÿäº§ç¯å¢ƒä¸‹è¯·æ³¨æ„å¼‚å¸¸å¤„ç†å’Œèµ„æºå…³é—­</span></div><div class="line">String sql = <span class="string">"INSERT INTO t_order(uid, nickname, pid) VALUES (1, '2', ?)"</span>;</div><div class="line">DataSource dataSource = <span class="keyword">new</span> ShardingDataSource(shardingRule);</div><div class="line">Connection conn = dataSource.getConnection();</div><div class="line">PreparedStatement ps = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS); <span class="comment">// è¿”å›ä¸»é”®éœ€è¦  Statement.RETURN_GENERATED_KEYS</span></div><div class="line">ps.setLong(<span class="number">1</span>, <span class="number">100</span>);</div><div class="line">ps.executeUpdate();</div><div class="line">ResultSet rs = ps.getGeneratedKeys();</div><div class="line"><span class="keyword">if</span> (rs.next()) &#123;</div><div class="line">    System.out.println(<span class="string">"id:"</span> + rs.getLong(<span class="number">1</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure><p><strong>è°ƒç”¨ <code>#executeUpdate()</code> æ–¹æ³•ï¼Œå†…éƒ¨è¿‡ç¨‹å¦‚ä¸‹</strong>ï¼š</p><p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_18/06.png" alt=""></p><p>æ˜¯ä¸æ˜¯å¯¹ä¸Šå±‚<strong>å®Œå…¨é€æ˜</strong>ï¼Ÿï¼æˆ‘ä»¬æ¥çœ‹çœ‹å†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingPreparedStatement.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Collection&lt;PreparedStatementUnit&gt; preparedStatementUnits = route();</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> PreparedStatementExecutor(</div><div class="line">               getShardingConnection().getShardingContext().getExecutorEngine(), getRouteResult().getSqlStatement().getType(), preparedStatementUnits, getParameters()).executeUpdate();</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       clearBatch();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p><code>#route()</code> åˆ†åº“åˆ†è¡¨è·¯ç”±ï¼Œè·å¾—é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒ( PreparedStatementUnit )é›†åˆã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PreparedStatementUnit</span> <span class="keyword">implements</span> <span class="title">BaseStatementUnit</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL æ‰§è¡Œå•å…ƒ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SQLExecutionUnit sqlExecutionUnit;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PreparedStatement statement;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p><code>#executeUpdate()</code> è°ƒç”¨<a href="http://www.yunai.me/Sharding-JDBC/sql-execute/?self">æ‰§è¡Œå¼•æ“</a><strong>å¹¶è¡Œ</strong>æ‰§è¡Œ<strong>å¤šä¸ª</strong>é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡ã€‚æ‰§è¡Œæ—¶ï¼Œæœ€ç»ˆè°ƒç”¨é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡( PreparedStatement )ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PreparedStatementExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">()</span> </span>&#123;</div><div class="line">   Context context = MetricsContext.start(<span class="string">"ShardingPreparedStatement-executeUpdate"</span>);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       List&lt;Integer&gt; results = executorEngine.executePreparedStatement(sqlType, preparedStatementUnits, parameters, <span class="keyword">new</span> ExecuteCallback&lt;Integer&gt;() &#123;</div><div class="line">           </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> Integer <span class="title">execute</span><span class="params">(<span class="keyword">final</span> BaseStatementUnit baseStatementUnit)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">               <span class="comment">// è°ƒç”¨ PreparedStatement#executeUpdate()</span></div><div class="line">               <span class="keyword">return</span> ((PreparedStatement) baseStatementUnit.getStatement()).executeUpdate();</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       <span class="keyword">return</span> accumulate(results);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       MetricsContext.stop(context);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><hr><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingPreparedStatement.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;PreparedStatementUnit&gt; <span class="title">route</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   Collection&lt;PreparedStatementUnit&gt; result = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">   <span class="comment">// è·¯ç”±</span></div><div class="line">   setRouteResult(routingEngine.route(getParameters()));</div><div class="line">   <span class="comment">// éå† SQL æ‰§è¡Œå•å…ƒ</span></div><div class="line">   <span class="keyword">for</span> (SQLExecutionUnit each : getRouteResult().getExecutionUnits()) &#123;</div><div class="line">       SQLType sqlType = getRouteResult().getSqlStatement().getType();</div><div class="line">       Collection&lt;PreparedStatement&gt; preparedStatements;</div><div class="line">       <span class="comment">// åˆ›å»ºå®é™…çš„ PreparedStatement</span></div><div class="line">       <span class="keyword">if</span> (SQLType.DDL == sqlType) &#123;</div><div class="line">           preparedStatements = generatePreparedStatementForDDL(each);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           preparedStatements = Collections.singletonList(generatePreparedStatement(each));</div><div class="line">       &#125;</div><div class="line">       getRoutedStatements().addAll(preparedStatements);</div><div class="line">       <span class="comment">// å›æ”¾è®¾ç½®å ä½ç¬¦å‚æ•°åˆ° PreparedStatement</span></div><div class="line">       <span class="keyword">for</span> (PreparedStatement preparedStatement : preparedStatements) &#123;</div><div class="line">           replaySetParameter(preparedStatement);</div><div class="line">           result.add(<span class="keyword">new</span> PreparedStatementUnit(each, preparedStatement));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ›å»º PreparedStatement</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlExecutionUnit SQL æ‰§è¡Œå•å…ƒ</div><div class="line">* <span class="doctag">@return</span> PreparedStatement</div><div class="line">* <span class="doctag">@throws</span> SQLException å½“ JDBC æ“ä½œå‘ç”Ÿå¼‚å¸¸æ—¶</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> PreparedStatement <span class="title">generatePreparedStatement</span><span class="params">(<span class="keyword">final</span> SQLExecutionUnit sqlExecutionUnit)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   Optional&lt;GeneratedKey&gt; generatedKey = getGeneratedKey();</div><div class="line">   <span class="comment">// è·å¾—è¿æ¥</span></div><div class="line">   Connection connection = getShardingConnection().getConnection(sqlExecutionUnit.getDataSource(), getRouteResult().getSqlStatement().getType());</div><div class="line">   <span class="comment">// å£°æ˜è¿”å›ä¸»é”®</span></div><div class="line">   <span class="keyword">if</span> (isReturnGeneratedKeys() || isReturnGeneratedKeys() &amp;&amp; generatedKey.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span> connection.prepareStatement(sqlExecutionUnit.getSql(), RETURN_GENERATED_KEYS);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> connection.prepareStatement(sqlExecutionUnit.getSql(), getResultSetType(), getResultSetConcurrency(), getResultSetHoldability());</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#generatePreparedStatement()</code> åˆ›å»º PreparedStatementï¼Œåè°ƒç”¨ <code>#replaySetParameter()</code> å›æ”¾è®¾ç½®å ä½ç¬¦å‚æ•°åˆ° PreparedStatement</li><li><p>å½“ <strong>å£°æ˜è¿”å›ä¸»é”®</strong> æ—¶ï¼Œå³ <code>#isReturnGeneratedKeys()</code> è¿”å› <code>true</code> æ—¶ï¼Œè°ƒç”¨ <code>connection.prepareStatement(sqlExecutionUnit.getSql(), RETURN_GENERATED_KEYS)</code>ã€‚ä¸ºä»€ä¹ˆè¯¥æ–¹æ³•ä¼šè¿”å› <code>true</code>ï¼Ÿä¸Šæ–‡ä¾‹å­ <code>conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)</code></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingConnection.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> PreparedStatement <span class="title">prepareStatement</span><span class="params">(<span class="keyword">final</span> String sql, <span class="keyword">final</span> String[] columnNames)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line"> <span class="keyword">return</span> <span class="keyword">new</span> ShardingPreparedStatement(<span class="keyword">this</span>, sql, Statement.RETURN_GENERATED_KEYS);</div><div class="line">&#125;</div><div class="line">   </div><div class="line"><span class="comment">// ShardingPreparedStatement.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ShardingPreparedStatement</span><span class="params">(<span class="keyword">final</span> ShardingConnection shardingConnection, <span class="keyword">final</span> String sql, <span class="keyword">final</span> <span class="keyword">int</span> autoGeneratedKeys)</span> </span>&#123;</div><div class="line"> <span class="keyword">this</span>(shardingConnection, sql);</div><div class="line"> <span class="keyword">if</span> (RETURN_GENERATED_KEYS == autoGeneratedKeys) &#123;</div><div class="line">     markReturnGeneratedKeys();</div><div class="line"> &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">markReturnGeneratedKeys</span><span class="params">()</span> </span>&#123;</div><div class="line"> returnGeneratedKeys = <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p><strong>å£°æ˜è¿”å›ä¸»é”®</strong>åï¼Œæ’å…¥æ‰§è¡Œå®Œæˆï¼Œæˆ‘ä»¬è°ƒç”¨ <code>#getGeneratedKeys()</code> å¯ä»¥è·å¾—ä¸»é”® ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingStatement.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ResultSet <span class="title">getGeneratedKeys</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    Optional&lt;GeneratedKey&gt; generatedKey = getGeneratedKey();</div><div class="line">    <span class="comment">// åˆ†å¸ƒå¼ä¸»é”®</span></div><div class="line">    <span class="keyword">if</span> (generatedKey.isPresent() &amp;&amp; returnGeneratedKeys) &#123;</div><div class="line">         <span class="keyword">return</span> <span class="keyword">new</span> GeneratedKeysResultSet(routeResult.getGeneratedKeys().iterator(), generatedKey.get().getColumn(), <span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// æ•°æ®åº“è‡ªå¢</span></div><div class="line">    <span class="keyword">if</span> (<span class="number">1</span> == getRoutedStatements().size()) &#123;</div><div class="line">        <span class="keyword">return</span> getRoutedStatements().iterator().next().getGeneratedKeys();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> GeneratedKeysResultSet();</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>ShardingConnection#getConnection()</code> æ–¹æ³•è·å¾—è¯¥ PreparedStatement å¯¹åº”çš„<strong>çœŸå®</strong>æ•°æ®åº“è¿æ¥( Connection )ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingConnection.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * æ ¹æ®æ•°æ®æºåç§°è·å–ç›¸åº”çš„æ•°æ®åº“è¿æ¥.</div><div class="line"> * </div><div class="line"> * <span class="doctag">@param</span> dataSourceName æ•°æ®æºåç§°</div><div class="line"> * <span class="doctag">@param</span> sqlType SQLè¯­å¥ç±»å‹</div><div class="line"> * <span class="doctag">@return</span> æ•°æ®åº“è¿æ¥</div><div class="line"> * <span class="doctag">@throws</span> SQLException SQLå¼‚å¸¸</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">(<span class="keyword">final</span> String dataSourceName, <span class="keyword">final</span> SQLType sqlType)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    <span class="comment">// ä»è¿æ¥ç¼“å­˜ä¸­è·å–è¿æ¥</span></div><div class="line">    Optional&lt;Connection&gt; connection = getCachedConnection(dataSourceName, sqlType);</div><div class="line">    <span class="keyword">if</span> (connection.isPresent()) &#123;</div><div class="line">        <span class="keyword">return</span> connection.get();</div><div class="line">    &#125;</div><div class="line">    Context metricsContext = MetricsContext.start(Joiner.on(<span class="string">"-"</span>).join(<span class="string">"ShardingConnection-getConnection"</span>, dataSourceName));</div><div class="line">    <span class="comment">//</span></div><div class="line">    DataSource dataSource = shardingContext.getShardingRule().getDataSourceRule().getDataSource(dataSourceName);</div><div class="line">    Preconditions.checkState(<span class="keyword">null</span> != dataSource, <span class="string">"Missing the rule of %s in DataSourceRule"</span>, dataSourceName);</div><div class="line">    String realDataSourceName;</div><div class="line">    <span class="keyword">if</span> (dataSource <span class="keyword">instanceof</span> MasterSlaveDataSource) &#123;</div><div class="line">        dataSource = ((MasterSlaveDataSource) dataSource).getDataSource(sqlType);</div><div class="line">        realDataSourceName = MasterSlaveDataSource.getDataSourceName(dataSourceName, sqlType);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        realDataSourceName = dataSourceName;</div><div class="line">    &#125;</div><div class="line">    Connection result = dataSource.getConnection();</div><div class="line">    MetricsContext.stop(metricsContext);</div><div class="line">    <span class="comment">// æ·»åŠ åˆ°è¿æ¥ç¼“å­˜</span></div><div class="line">    connectionMap.put(realDataSourceName, result);</div><div class="line">    <span class="comment">// å›æ”¾ Connection æ–¹æ³•</span></div><div class="line">    replayMethodsInvocation(result);</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Optional&lt;Connection&gt; <span class="title">getCachedConnection</span><span class="params">(<span class="keyword">final</span> String dataSourceName, <span class="keyword">final</span> SQLType sqlType)</span> </span>&#123;</div><div class="line">    String key = connectionMap.containsKey(dataSourceName) ? dataSourceName : MasterSlaveDataSource.getDataSourceName(dataSourceName, sqlType);</div><div class="line">    <span class="keyword">return</span> Optional.fromNullable(connectionMap.get(key));</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#getCachedConnection()</code> å°è¯•è·å¾—<strong>å·²ç¼“å­˜</strong>çš„æ•°æ®åº“è¿æ¥ï¼›å¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œè·å–åˆ°è¿æ¥åä¼šè¿›è¡Œ<strong>ç¼“å­˜</strong></li><li>ä» ShardingRule é…ç½®çš„ DataSourceRule è·å–<strong>çœŸå®</strong>çš„æ•°æ®æº( DataSource )</li><li>MasterSlaveDataSource å®ç°<strong>ä¸»ä»</strong>æ•°æ®æºå°è£…ï¼Œæˆ‘ä»¬åœ¨<em>ä¸‹å°èŠ‚</em>åˆ†äº«</li><li>è°ƒç”¨ <code>#replayMethodsInvocation()</code> å›æ”¾è®°å½•çš„ Connection æ–¹æ³•</li></ul></li></ul><p><em>æ’å…¥å®ç°çš„ä»£ç åŸºæœ¬åˆ†äº«å®Œäº†ï¼Œå› ä¸ºæ˜¯ä¸æ–­ä»£ç ä¸‹é’»çš„æ–¹å¼åˆ†æï¼Œå¯ä»¥åå‘å‘ä¸Šåœ¨ç†ç†ï¼Œä¼šæ›´åŠ æ¸…æ™°</em>ã€‚</p><h1 id="5-æŸ¥è¯¢æµç¨‹"><a href="#5-æŸ¥è¯¢æµç¨‹" class="headerlink" title="5. æŸ¥è¯¢æµç¨‹"></a>5. æŸ¥è¯¢æµç¨‹</h1><p>å•çº¯ä» <code>core</code> åŒ…é‡Œçš„ JDBC å®ç°ï¼ŒæŸ¥è¯¢æµç¨‹ <code>#executeQuery()</code> å’Œ <code>#execute()</code> åŸºæœ¬ä¸€è‡´ï¼Œå·®åˆ«åœ¨äº<strong>æ‰§è¡Œ</strong>å’Œ<strong>å¤šç»“æœé›†å½’å¹¶</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ResultSet <span class="title">executeQuery</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   ResultSet result;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// è·¯ç”±</span></div><div class="line">       Collection&lt;PreparedStatementUnit&gt; preparedStatementUnits = route();</div><div class="line">       <span class="comment">// æ‰§è¡Œ</span></div><div class="line">       List&lt;ResultSet&gt; resultSets = <span class="keyword">new</span> PreparedStatementExecutor(</div><div class="line">               getShardingConnection().getShardingContext().getExecutorEngine(), getRouteResult().getSqlStatement().getType(), preparedStatementUnits, getParameters()).executeQuery();</div><div class="line">       <span class="comment">// ç»“æœå½’å¹¶</span></div><div class="line">       result = <span class="keyword">new</span> ShardingResultSet(resultSets, <span class="keyword">new</span> MergeEngine(</div><div class="line">               getShardingConnection().getShardingContext().getDatabaseType(), resultSets, (SelectStatement) getRouteResult().getSqlStatement()).merge());</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       clearBatch();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è®¾ç½®ç»“æœé›†</span></div><div class="line">   setCurrentResultSet(result);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>SQLæ‰§è¡Œ</strong> æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ï¼š<a href="http://www.yunai.me/Sharding-JDBC/sql-execute/?self">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œã€‹</a></li><li><strong>ç»“æœå½’å¹¶</strong> æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ï¼š<a href="http://www.yunai.me/Sharding-JDBC/result-merger/?self">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” ç»“æœå½’å¹¶ã€‹</a></li><li><p>ç»“æœå½’å¹¶ <code>#merge()</code> å®Œåï¼Œåˆ›å»ºåˆ†ç‰‡ç»“æœé›†( ShardingResultSet )</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ShardingResultSet</span> <span class="keyword">extends</span> <span class="title">AbstractResultSetAdapter</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å½’å¹¶ç»“æœé›†</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResultSetMerger mergeResultSet;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        Object result = mergeResultSet.getValue(columnIndex, <span class="keyword">int</span>.class);</div><div class="line">        wasNull = <span class="keyword">null</span> == result;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) ResultSetUtil.convertValue(result, <span class="keyword">int</span>.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">final</span> String columnLabel)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        Object result = mergeResultSet.getValue(columnLabel, <span class="keyword">int</span>.class);</div><div class="line">        wasNull = <span class="keyword">null</span> == result;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) ResultSetUtil.convertValue(result, <span class="keyword">int</span>.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// .... éšè—å…¶ä»–ç±»ä¼¼ getXXXX() æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><h1 id="6-è¯»å†™åˆ†ç¦»"><a href="#6-è¯»å†™åˆ†ç¦»" class="headerlink" title="6. è¯»å†™åˆ†ç¦»"></a>6. è¯»å†™åˆ†ç¦»</h1><p>å»ºè®®å‰ç½®é˜…è¯»ï¼š<a href="http://dangdangdotcom.github.io/sharding-jdbc/02-guide/master-slave/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” è¯»å†™åˆ†ç¦»ã€‹</a></p><p>å½“ä½ æœ‰è¯»å†™åˆ†ç¦»çš„éœ€æ±‚æ—¶ï¼Œå°† ShardingRule é…ç½®<strong>å¯¹åº”çš„æ•°æ®æº</strong> ä» ShardingDataSource æ›¿æ¢æˆ MasterSlaveDataSourceã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ MasterSlaveDataSource çš„åŠŸèƒ½å’Œå®ç°ã€‚</p><p><strong>æ”¯æŒä¸€ä¸»å¤šä»çš„è¯»å†™åˆ†ç¦»é…ç½®ï¼Œå¯é…åˆåˆ†åº“åˆ†è¡¨ä½¿ç”¨</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MasterSlaveDataSourceFactory.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MasterSlaveDataSourceFactory</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ›å»ºè¯»å†™åˆ†ç¦»æ•°æ®æº.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> name è¯»å†™åˆ†ç¦»æ•°æ®æºåç§°</div><div class="line">     * <span class="doctag">@param</span> masterDataSource ä¸»èŠ‚ç‚¹æ•°æ®æº</div><div class="line">     * <span class="doctag">@param</span> slaveDataSource ä»èŠ‚ç‚¹æ•°æ®æº</div><div class="line">     * <span class="doctag">@param</span> otherSlaveDataSources å…¶ä»–ä»èŠ‚ç‚¹æ•°æ®æº</div><div class="line">     * <span class="doctag">@return</span> è¯»å†™åˆ†ç¦»æ•°æ®æº</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DataSource <span class="title">createDataSource</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> DataSource masterDataSource, <span class="keyword">final</span> DataSource slaveDataSource, <span class="keyword">final</span> DataSource... otherSlaveDataSources)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MasterSlaveDataSource(name, masterDataSource, Lists.asList(slaveDataSource, otherSlaveDataSources));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// MasterSlaveDataSource.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MasterSlaveDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractDataSourceAdapter</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•°æ®æºå</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸»æ•°æ®æº</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource masterDataSource;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä»æ•°æ®æºé›†åˆ</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;DataSource&gt; slaveDataSources;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p><strong>åŒä¸€çº¿ç¨‹ä¸”åŒä¸€æ•°æ®åº“è¿æ¥å†…ï¼Œå¦‚æœ‰å†™å…¥æ“ä½œï¼Œä»¥åçš„è¯»æ“ä½œå‡ä»ä¸»åº“è¯»å–ï¼Œç”¨äºä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingConnection.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">(<span class="keyword">final</span> String dataSourceName, <span class="keyword">final</span> SQLType sqlType)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">   String realDataSourceName;</div><div class="line">   <span class="keyword">if</span> (dataSource <span class="keyword">instanceof</span> MasterSlaveDataSource) &#123; <span class="comment">// è¯»å†™åˆ†ç¦»</span></div><div class="line">       dataSource = ((MasterSlaveDataSource) dataSource).getDataSource(sqlType);</div><div class="line">       realDataSourceName = MasterSlaveDataSource.getDataSourceName(dataSourceName, sqlType);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       realDataSourceName = dataSourceName;</div><div class="line">   &#125;</div><div class="line">   Connection result = dataSource.getConnection();</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// MasterSlaveDataSource.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ DML æ“ä½œæ ‡è¯†</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Boolean&gt; DML_FLAG = <span class="keyword">new</span> ThreadLocal&lt;Boolean&gt;() &#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> Boolean <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">/**</span></div><div class="line">* ä»åº“è´Ÿè½½å‡è¡¡ç­–ç•¥</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> SlaveLoadBalanceStrategy slaveLoadBalanceStrategy = <span class="keyword">new</span> RoundRobinSlaveLoadBalanceStrategy();</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–ä¸»æˆ–ä»èŠ‚ç‚¹çš„æ•°æ®æº.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlType SQLç±»å‹</div><div class="line">* <span class="doctag">@return</span> ä¸»æˆ–ä»èŠ‚ç‚¹çš„æ•°æ®æº</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">(<span class="keyword">final</span> SQLType sqlType)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (isMasterRoute(sqlType)) &#123;</div><div class="line">       DML_FLAG.set(<span class="keyword">true</span>);</div><div class="line">       <span class="keyword">return</span> masterDataSource;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> slaveLoadBalanceStrategy.getDataSource(name, slaveDataSources);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isMasterRoute</span><span class="params">(<span class="keyword">final</span> SQLType sqlType)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> SQLType.DQL != sqlType || DML_FLAG.get() || HintManagerHolder.isMasterRouteOnly();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ShardingConnection è·å–åˆ°çš„æ•°æ®æºæ˜¯ MasterSlaveDataSource æ—¶ï¼Œè°ƒç”¨ <code>MasterSlaveDataSource#getConnection()</code> æ–¹æ³•è·å–<strong>çœŸå®</strong>çš„æ•°æ®æº</li><li>é€šè¿‡ <code>#isMasterRoute()</code> åˆ¤æ–­æ˜¯å¦è¯»å–<strong>ä¸»åº“</strong>ï¼Œä»¥ä¸‹ä¸‰ç§æƒ…å†µä¼šè®¿é—®ä¸»åº“ï¼š<ul><li>éæŸ¥è¯¢è¯­å¥ (DQL)</li><li><strong>è¯¥</strong>æ•°æ®æºåœ¨<strong>å½“å‰</strong>çº¿ç¨‹è®¿é—®è¿‡ä¸»åº“ï¼šé€šè¿‡çº¿ç¨‹å˜é‡ <code>DML_FLAG</code> å®ç°</li><li>å¼ºåˆ¶ä¸»åº“ï¼šç¨‹åºé‡Œè°ƒç”¨ <code>HintManager.getInstance().setMasterRouteOnly()</code> å®ç°</li></ul></li><li><p>è®¿é—®ä»åº“æ—¶ï¼Œä¼šé€šè¿‡è´Ÿè½½å‡è¡¡ç­–ç•¥( SlaveLoadBalanceStrategy ) é€‰æ‹©ä¸€ä¸ªä»åº“</p><pre><code class="Java"><span class="comment">// SlaveLoadBalanceStrategy.java</span>
<span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SlaveLoadBalanceStrategy</span> </span>{

    <span class="comment">/**
     * æ ¹æ®è´Ÿè½½å‡è¡¡ç­–ç•¥è·å–ä»åº“æ•°æ®æº.
     * 
     * <span class="doctag">@param</span> name è¯»å†™åˆ†ç¦»æ•°æ®æºåç§°
     * <span class="doctag">@param</span> slaveDataSources ä»åº“æ•°æ®æºåˆ—è¡¨
     * <span class="doctag">@return</span> é€‰ä¸­çš„ä»åº“æ•°æ®æº
     */</span>
    <span class="function">DataSource <span class="title">getDataSource</span><span class="params">(String name, List&lt;DataSource&gt; slaveDataSources)</span></span>;
}

<span class="comment">// RoundRobinSlaveLoadBalanceStrategy.java</span>
<span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RoundRobinSlaveLoadBalanceStrategy</span> <span class="keyword">implements</span> <span class="title">SlaveLoadBalanceStrategy</span> </span>{

    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, AtomicInteger&gt; COUNT_MAP = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();

    <span class="meta">@Override</span>
    <span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> List&lt;DataSource&gt; slaveDataSources)</span> </span>{
        AtomicInteger count = COUNT_MAP.containsKey(name) ? COUNT_MAP.get(name) : <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);
        COUNT_MAP.putIfAbsent(name, count);
        count.compareAndSet(slaveDataSources.size(), <span class="number">0</span>);
        <span class="keyword">return</span> slaveDataSources.get(count.getAndIncrement() % slaveDataSources.size());
    }
}
</code></pre><ul><li>MasterSlaveDataSource é»˜è®¤ä½¿ç”¨ RoundRobinSlaveLoadBalanceStrategyï¼Œæš‚æ—¶ä¸æ”¯æŒé…ç½®</li><li>RoundRobinSlaveLoadBalanceStrategyï¼Œè½®è¯¢è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œ<strong>æ¯ä¸ªä»èŠ‚ç‚¹è®¿é—®æ¬¡æ•°å‡è¡¡ï¼Œæš‚ä¸æ”¯æŒæ•°æ®æºæ•…éšœç§»é™¤</strong></li></ul></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ²¡æœ‰å½©è›‹<br>æ²¡æœ‰å½©<br>æ²¡æœ‰<br>æ²¡</p><p>ä¸‹ä¸€ç¯‡ï¼Œ<a href="http://www.yunai.me/Sharding-JDBC/transaction-bed/?self">ã€Šåˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆä¸€ï¼‰ä¹‹æœ€å¤§åŠªåŠ›å‹ã€‹</a>èµ°èµ·ã€‚è€å¸æœºï¼Œèµ¶ç´§ä¸Šè½¦ã€‚</p><p>é“å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿä¸ç„¶äº¤ä¸ªé“å§‘é‚£<del>æ•æ„Ÿè¯</del>ä½ ã€‚</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/Sharding-JDBC/">Sharding-JDBC</a></div><div class="article-share" id="share"><div data-url="http://www.yunai.me/Sharding-JDBC/jdbc-implement-and-read-write-splitting/" data-title="Sharding-JDBC æºç åˆ†æ â€”â€” JDBCå®ç°ä¸è¯»å†™åˆ†ç¦» | èŠ‹è‰¿Vçš„åšå®¢" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/Sharding-JDBC/transaction-bed/" title="Sharding-JDBC æºç åˆ†æ â€”â€” åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆä¸€ï¼‰ä¹‹æœ€å¤§åŠªåŠ›å‹"><strong>PREVIOUS:</strong><br><span>Sharding-JDBC æºç åˆ†æ â€”â€” åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆä¸€ï¼‰ä¹‹æœ€å¤§åŠªåŠ›å‹</span></a></div><div class="next"><a href="/Sharding-JDBC/result-merger/" title="Sharding-JDBC æºç åˆ†æ â€”â€” ç»“æœå½’å¹¶"><strong>NEXT:</strong><br><span>Sharding-JDBC æºç åˆ†æ â€”â€” ç»“æœå½’å¹¶</span></a></div></nav></div></div><footer><div id="footer"><p class="copyright">Â© 2017 <a href="http://www.yunai.me" target="_blank" title="ç‹æ–‡æ–Œ">ç‹æ–‡æ–Œ</a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a> && Powered by <a href="http://hexo.io" target="_blank" title="hexo" rel="external nofollow noopener noreferrer">hexo</a> && Theme by <a href="http://gengbiao.me" target="_blank" title="coney" rel="external nofollow noopener noreferrer">coney</a></p></div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2");ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script>$(document).ready(function(){function e(){var e=jqueryAlert({title:"ğŸ‘¼æ¯å‘¨å…­æ›´æ–°ä¸€ç¯‡æºç è§£æï¼Œã€æ‰«ä¸€æ‰«ã€‘å…³æ³¨å…¬ä¼—å·ğŸ‘¼",width:"500",height:"600",modal:!0,content:n+'<p style="color: red">ä»Šæ—¥'+c+"å·²å…³æ³¨äººæ•°ï¼š"+p+'</p><img width="400" src="http://www.yunai.me/images/common/wechat_mp_simple.png" /><p style="color: red">å…³æ³¨åï¼Œæ¬¢è¿åŠ å…¥ã€æºç åœˆã€‘å¾®ä¿¡ç¾¤äº¤æµ</p><p style="color: red">ä¸€èµ·çœ‹æºç ï¼Œè¯»æºç ï¼Œæå‡æŠ€æœ¯ï¼</p>',buttons:{"å·²å…³æ³¨ï¼Œå…³é—­çª—å£ï¼ˆå…¬ä¼—å·å‘é€ï¼šã€å£ä»¤ã€‘å±è”½å¼¹çª—ï¼‰":function(){e.close()}}});$.cookie(o,i+1,{expires:1,path:"/"})}if(!(location.href.indexOf("vip")>=0||location.href.indexOf("127.0.0.1")>=0)){var o="doubi",i=$.cookie(o);i?i=parseInt(i):($.cookie(o,0,{expires:1,path:"/"}),i=0),$.cookie(o,i,{expires:1,path:"/"});var t="default",r={juejin:"æ˜é‡‘",oschina:"å¼€æºä¸­å›½",sjdbc:"Sharding-JDBC",jianshu:"ç®€ä¹¦",csdn:"CSDN",iteye:"iteye",cnblogs:"åšå®¢å›­"};for(var a in r)if(location.search.indexOf(a)>=0){t=a;break}"default"===t&&(t=$.cookie("from")||"default"),$.cookie("from",t,{expires:365,path:"/"});var n="",c="";if(t&&r[t]&&(n='<p style="color: red">æ¬¢è¿æ¥è‡ªã€'+r[t]+"ã€‘çš„åŒå­¦</p>",c="ã€"+r[t]+"ã€‘"),i<=3){var p=103+5*(new Date).getHours();setTimeout(e,2e4*(i+1))}}})</script></body>