<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±æ”¹å†™ | èŠ‹è‰¿Vçš„åšå®¢</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="ç‹æ–‡æ–Œ"><meta name="description" content="ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘æœ‰ç¦åˆ©ï¼š  

RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨  
RocketMQ / MyCAT / Sharding-JDBC ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€  
æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚"><link rel="alternate" href="atom.xml" title="èŠ‹è‰¿Vçš„åšå®¢" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?ef4ed89f6dc83d01803a2440ae21e666";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹è‰¿Vçš„åšå®¢">èŠ‹è‰¿Vçš„åšå®¢</a></h1><a class="blog-motto">æ„¿ç¼–ç åŠç”Ÿï¼Œå¦‚è€å‹ç›¸ä¼´ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li></ul></ul></nav></div></header><div id="container"><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-SQLToken"><span class="toc-number">2.</span> <span class="toc-text">2. SQLToken</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-SQL-æ”¹å†™"><span class="toc-number">3.</span> <span class="toc-text">3.SQL æ”¹å†™</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-TableToken"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 TableToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-ItemsToken"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 ItemsToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-OffsetToken"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 OffsetToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-RowCountToken"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 RowCountToken</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-åˆ†é¡µè¡¥å……"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 åˆ†é¡µè¡¥å……</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-OrderByToken"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 OrderByToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-GeneratedKeyToken"><span class="toc-number">3.6.</span> <span class="toc-text">3.6 GeneratedKeyToken</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-SQL-ç”Ÿæˆ"><span class="toc-number">4.</span> <span class="toc-text">4. SQL ç”Ÿæˆ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-å½©è›‹"><span class="toc-number">5.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹è‰¿çš„åç«¯å°å±‹</p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>17</sup></a></li><li><a href="/categories/æŠ€æœ¯æ‚æ–‡/" title="æŠ€æœ¯æ‚æ–‡">æŠ€æœ¯æ‚æ–‡<sup>2</sup></a></li></ul></div></aside></div><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/Sharding-JDBC/sql-rewrite/" title="Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±æ”¹å†™" itemprop="url">Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±æ”¹å†™</a></h1><p class="article-author"></p><p class="article-time"><time datetime="2017-08-09T16:00:00.000Z" itemprop="datePublished">2017-08-10</time> æ›´æ–°æ—¥æœŸ:<time datetime="2017-08-03T13:12:30.000Z" itemprop="dateModified">2017-08-03</time> æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><div id="toc" class="toc-article"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-SQLToken"><span class="toc-number">2.</span> <span class="toc-text">2. SQLToken</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-SQL-æ”¹å†™"><span class="toc-number">3.</span> <span class="toc-text">3.SQL æ”¹å†™</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-TableToken"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 TableToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-ItemsToken"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 ItemsToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-OffsetToken"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 OffsetToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-RowCountToken"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 RowCountToken</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-åˆ†é¡µè¡¥å……"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 åˆ†é¡µè¡¥å……</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-OrderByToken"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 OrderByToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-GeneratedKeyToken"><span class="toc-number">3.6.</span> <span class="toc-text">3.6 GeneratedKeyToken</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-SQL-ç”Ÿæˆ"><span class="toc-number">4.</span> <span class="toc-text">4. SQL ç”Ÿæˆ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-å½©è›‹"><span class="toc-number">5.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol></div><p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. SQLToken</a></li><li><a href="#">3.SQL æ”¹å†™</a><ul><li><a href="#">3.1 TableToken</a></li><li><a href="#">3.2 ItemsToken</a></li><li><a href="#">3.3 OffsetToken</a></li><li><a href="#">3.4 RowCountToken</a><ul><li><a href="#">3.4.1 åˆ†é¡µè¡¥å……</a></li></ul></li><li><a href="#">3.5 OrderByToken</a></li><li><a href="#">3.6 GeneratedKeyToken</a></li></ul></li><li><a href="#">4. SQL ç”Ÿæˆ</a></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>å‰ç½®é˜…è¯»ï¼š<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-3/?mp">ã€ŠSQL è§£æï¼ˆä¸‰ï¼‰ä¹‹æŸ¥è¯¢SQLã€‹</a></p><p>æœ¬æ–‡åˆ†äº«<strong>SQL æ”¹å†™</strong>çš„æºç å®ç°ã€‚ä¸»è¦æ¶‰åŠä¸¤æ–¹é¢ï¼š</p><ol><li>SQL æ”¹å†™ï¼šæ”¹å†™ SQLï¼Œè§£å†³åˆ†åº“åˆ†è¡¨åï¼ŒæŸ¥è¯¢ç»“æœéœ€è¦èšåˆï¼Œéœ€è¦å¯¹ SQL è¿›è¡Œè°ƒæ•´ï¼Œä¾‹å¦‚åˆ†é¡µ</li><li>SQL ç”Ÿæˆï¼šç”Ÿæˆåˆ†è¡¨åˆ†åº“çš„æ‰§è¡Œ SQL</li></ol><p>SQLRewriteEngineï¼ŒSQLé‡å†™å¼•æ“ï¼Œå®ç° SQL æ”¹å†™ã€ç”ŸæˆåŠŸèƒ½ã€‚ä» Sharding-JDBC 1.5.0 ç‰ˆæœ¬ï¼ŒSQL æ”¹å†™è¿›è¡Œäº†è°ƒæ•´å’Œå¤§é‡ä¼˜åŒ–ã€‚</p><blockquote><p>1.4.xåŠä¹‹å‰ç‰ˆæœ¬ï¼ŒSQLæ”¹å†™æ˜¯åœ¨SQLè·¯ç”±ä¹‹å‰å®Œæˆçš„ï¼Œåœ¨1.5.xä¸­è°ƒæ•´ä¸ºSQLè·¯ç”±ä¹‹åï¼Œå› ä¸ºSQLæ”¹å†™å¯ä»¥æ ¹æ®è·¯ç”±è‡³å•åº“è¡¨è¿˜æ˜¯å¤šåº“è¡¨è€Œè¿›è¡Œè¿›ä¸€æ­¥ä¼˜åŒ–ã€‚</p></blockquote><p>ğŸ˜† å¾ˆå¤šåŒå­¦çœ‹å®Œ<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL è§£æ-ç³»åˆ—ã€‹</a> å¯èƒ½æ˜¯ä¸€è„¸æ‡µé€¼ï¼Œç‰¹åˆ«å¯¹<strong>â€œSQL åŠç†è§£â€</strong>ã€‚<img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/01.png" alt="">å¸Œæœ›æœ¬æ–‡èƒ½ç»™ä½ ä¸€äº›å¯å‘ã€‚</p><blockquote><p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p></blockquote><h1 id="2-SQLToken"><a href="#2-SQLToken" class="headerlink" title="2. SQLToken"></a>2. SQLToken</h1><p>ğŸ˜ SQLToken åœ¨æœ¬æ–‡ä¸­å¾ˆé‡è¦ï¼Œæ‰€ä»¥å³ä½¿åœ¨<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL è§£æ-ç³»åˆ—ã€‹</a>å·²ç»åˆ†äº«è¿‡ï¼Œæˆ‘ä»¬ä¹Ÿæ¢ä¸ªå§¿åŠ¿ï¼Œå†æ¥ä¸€æ¬¡ã€‚</p><p>SQLTokenï¼ŒSQLæ ‡è®°å¯¹è±¡<strong>æ¥å£</strong>ã€‚SQLRewriteEngine åŸºäº SQLToken å®ç° <strong>SQLæ”¹å†™</strong>ã€‚SQLè§£æå™¨åœ¨ SQLè§£æè¿‡ç¨‹ä¸­ï¼Œå¾ˆé‡è¦çš„ä¸€ä¸ªç›®çš„æ˜¯<strong>æ ‡è®°éœ€è¦SQLæ”¹å†™çš„éƒ¨åˆ†</strong>ï¼Œä¹Ÿå°±æ˜¯ SQLTokenã€‚</p><p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/02.png" alt=""></p><p><strong>å„ SQLToken ç”Ÿæˆæ¡ä»¶å¦‚ä¸‹</strong>(<em>æ‚²ä¼¤ï¼Œåšæˆè¡¨æ ¼å½¢å¼æ’ç‰ˆæ˜¯ä¹±çš„</em>)ï¼š</p><ol><li>GeneratedKeyToken è‡ªå¢ä¸»é”®æ ‡è®°å¯¹è±¡<ul><li>æ’å…¥SQLè‡ªå¢åˆ—ä¸å­˜åœ¨ï¼š<code>INSERT INTO t_order(nickname) VALUES ...</code> ä¸­æ²¡æœ‰è‡ªå¢åˆ— <code>order_id</code></li></ul></li><li>TableToken è¡¨æ ‡è®°å¯¹è±¡<ul><li>æŸ¥è¯¢åˆ—çš„è¡¨åˆ«åï¼š<code>SELECT o.order_id</code> çš„ <code>o</code></li><li>æŸ¥è¯¢çš„è¡¨åï¼š<code>SELECT * FROM t_order</code> çš„ <code>t_order</code></li></ul></li><li>ItemsToken é€‰æ‹©é¡¹æ ‡è®°å¯¹è±¡<ul><li>AVGæŸ¥è¯¢åˆ—ï¼š<code>SELECT AVG(price) FROM t_order</code> çš„ <code>AVG(price)</code></li><li>ORDER BY å­—æ®µä¸åœ¨æŸ¥è¯¢åˆ—ï¼š<code>SELECT order_id FROM t_order ORDER BY create_time</code> çš„ <code>create_time</code></li><li>GROUP BY å­—æ®µä¸åœ¨æŸ¥è¯¢åˆ—ï¼š<code>SELECT COUNT(order_id) FROM t_order GROUP BY user_id</code> çš„ <code>user_id</code></li><li>è‡ªå¢ä¸»é”®æœªåœ¨æ’å…¥åˆ—ä¸­ï¼š<code>INSERT INTO t_order(nickname) VALUES ...</code> ä¸­æ²¡æœ‰è‡ªå¢åˆ— <code>order_id</code></li></ul></li><li>OffsetToken åˆ†é¡µåç§»é‡æ ‡è®°å¯¹è±¡<ul><li>åˆ†é¡µæœ‰åç§»é‡ï¼Œä½†<strong>ä¸æ˜¯</strong>å ä½ç¬¦ <code>?</code></li></ul></li><li>RowCountToken åˆ†é¡µé•¿åº¦æ ‡è®°å¯¹è±¡<ul><li>åˆ†é¡µæœ‰é•¿åº¦ï¼Œä½†<strong>ä¸æ˜¯</strong>å ä½ç¬¦ <code>?</code></li></ul></li><li>OrderByToken æ’åºæ ‡è®°å¯¹è±¡<ul><li>æœ‰ GROUP BY æ¡ä»¶ï¼Œæ—  ORDER BY æ¡ä»¶ï¼š<code>SELECT COUNT(*) FROM t_order GROUP BY order_id</code> çš„ <code>order_id</code></li></ul></li></ol><h1 id="3-SQL-æ”¹å†™"><a href="#3-SQL-æ”¹å†™" class="headerlink" title="3.SQL æ”¹å†™"></a>3.SQL æ”¹å†™</h1><p><code>SQLRewriteEngine#rewrite()</code> å®ç°äº† <strong>SQLæ”¹å†™</strong> åŠŸèƒ½ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* SQLæ”¹å†™.</div><div class="line">* <span class="doctag">@param</span> isRewriteLimit æ˜¯å¦é‡å†™Limit</div><div class="line">* <span class="doctag">@return</span> SQLæ„å»ºå™¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> SQLBuilder <span class="title">rewrite</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> isRewriteLimit)</span> </span>&#123;</div><div class="line">   SQLBuilder result = <span class="keyword">new</span> SQLBuilder();</div><div class="line">   <span class="keyword">if</span> (sqlTokens.isEmpty()) &#123;</div><div class="line">       result.appendLiterals(originalSQL);</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">   <span class="comment">// æ’åºSQLTokenï¼ŒæŒ‰ç…§ beginPosition é€’å¢</span></div><div class="line">   sortByBeginPosition();</div><div class="line">   <span class="keyword">for</span> (SQLToken each : sqlTokens) &#123;</div><div class="line">       <span class="keyword">if</span> (<span class="number">0</span> == count) &#123; <span class="comment">// æ‹¼æ¥ç¬¬ä¸€ä¸ª SQLToken å‰çš„å­—ç¬¦ä¸²</span></div><div class="line">           result.appendLiterals(originalSQL.substring(<span class="number">0</span>, each.getBeginPosition()));</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// æ‹¼æ¥æ¯ä¸ªSQLToken</span></div><div class="line">       <span class="keyword">if</span> (each <span class="keyword">instanceof</span> TableToken) &#123;</div><div class="line">           appendTableToken(result, (TableToken) each, count, sqlTokens);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (each <span class="keyword">instanceof</span> ItemsToken) &#123;</div><div class="line">           appendItemsToken(result, (ItemsToken) each, count, sqlTokens);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (each <span class="keyword">instanceof</span> RowCountToken) &#123;</div><div class="line">           appendLimitRowCount(result, (RowCountToken) each, count, sqlTokens, isRewriteLimit);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (each <span class="keyword">instanceof</span> OffsetToken) &#123;</div><div class="line">           appendLimitOffsetToken(result, (OffsetToken) each, count, sqlTokens, isRewriteLimit);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (each <span class="keyword">instanceof</span> OrderByToken) &#123;</div><div class="line">           appendOrderByToken(result);</div><div class="line">       &#125;</div><div class="line">       count++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>SQLæ”¹å†™ä»¥ SQLToken ä¸º<strong>é—´éš”</strong>ï¼Œ<strong>é¡ºåº</strong>æ”¹å†™ã€‚<ul><li>é¡ºåºï¼šè°ƒç”¨ <code>#sortByBeginPosition()</code> å°† SQLToken æŒ‰ç…§ <code>beginPosition</code> <strong>å‡åº</strong>ã€‚</li><li>é—´éš”ï¼šéå† SQLTokenï¼Œé€ä¸ªæ‹¼æ¥ã€‚</li></ul></li></ul><p>ä¾‹å¦‚ï¼š<br><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/03.png" alt=""></p><hr><p>SQLBuilderï¼ŒSQLæ„å»ºå™¨ã€‚ä¸‹æ–‡ä¼šå¤§é‡ç”¨åˆ°ï¼Œæˆ‘ä»¬çœ‹ä¸‹å®ç°ä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SQLBuilder</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ®µé›†åˆ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; segments;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å½“å‰æ®µ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> StringBuilder currentSegment;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SQLBuilder</span><span class="params">()</span> </span>&#123;</div><div class="line">        segments = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">        currentSegment = <span class="keyword">new</span> StringBuilder();</div><div class="line">        segments.add(currentSegment);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¿½åŠ å­—é¢é‡.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> literals å­—é¢é‡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendLiterals</span><span class="params">(<span class="keyword">final</span> String literals)</span> </span>&#123;</div><div class="line">        currentSegment.append(literals);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¿½åŠ è¡¨å ä½ç¬¦.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> tableName è¡¨åç§°</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendTable</span><span class="params">(<span class="keyword">final</span> String tableName)</span> </span>&#123;</div><div class="line">        <span class="comment">// æ·»åŠ  TableToken</span></div><div class="line">        segments.add(<span class="keyword">new</span> TableToken(tableName));</div><div class="line">        <span class="comment">// æ–°å»ºå½“å‰æ®µ</span></div><div class="line">        currentSegment = <span class="keyword">new</span> StringBuilder();</div><div class="line">        segments.add(currentSegment);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toSQL</span><span class="params">(<span class="keyword">final</span> Map&lt;String, String&gt; tableTokens)</span> </span>&#123;</div><div class="line">        <span class="comment">// ... çœç•¥ä»£ç ï¼Œã€SQLç”Ÿæˆã€‘å¤„åˆ†äº«</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@RequiredArgsConstructor</span></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">TableToken</span> </span>&#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * è¡¨å</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String tableName;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><hr><p>ç°åœ¨æˆ‘ä»¬æ¥é€ä¸ªåˆ†ææ¯ç§ SQLToken çš„<strong>æ‹¼æ¥</strong>å®ç°ã€‚</p><h2 id="3-1-TableToken"><a href="#3-1-TableToken" class="headerlink" title="3.1 TableToken"></a>3.1 TableToken</h2><p>è°ƒç”¨ <code>#appendTableToken()</code> æ–¹æ³•æ‹¼æ¥ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‹¼æ¥ TableToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLæ„å»ºå™¨</div><div class="line">* <span class="doctag">@param</span> tableToken tableToken</div><div class="line">* <span class="doctag">@param</span> count tableToken åœ¨ sqlTokens çš„é¡ºåº</div><div class="line">* <span class="doctag">@param</span> sqlTokens sqlTokens</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendTableToken</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder, <span class="keyword">final</span> TableToken tableToken, <span class="keyword">final</span> <span class="keyword">int</span> count, <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ‹¼æ¥ TableToken</span></div><div class="line">   String tableName = sqlStatement.getTables().getTableNames().contains(tableToken.getTableName()) ? tableToken.getTableName() : tableToken.getOriginalLiterals();</div><div class="line">   sqlBuilder.appendTable(tableName);</div><div class="line">   <span class="comment">// æ‹¼æ¥ SQLToken åé¢çš„å­—ç¬¦ä¸²</span></div><div class="line">   <span class="keyword">int</span> beginPosition = tableToken.getBeginPosition() + tableToken.getOriginalLiterals().length();</div><div class="line">   <span class="keyword">int</span> endPosition = sqlTokens.size() - <span class="number">1</span> == count ? originalSQL.length() : sqlTokens.get(count + <span class="number">1</span>).getBeginPosition();</div><div class="line">   sqlBuilder.appendLiterals(originalSQL.substring(beginPosition, endPosition));</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>SQLBuilder#appendTable()</code> æ‹¼æ¥ TableTokenã€‚</li><li><code>sqlStatement.getTables().getTableNames().contains(tableToken.getTableName())</code> ç›®çš„æ˜¯å¤„ç†æ‰<strong>è¡¨åå‰åæœ‰çš„ç‰¹æ®Šå­—ç¬¦</strong>ï¼Œä¾‹å¦‚<code>SELECT * FROM &#39;t_order&#39;</code> ä¸­ <code>t_order</code> å‰åæœ‰ <code>&#39;</code> ç¬¦å·ã€‚</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TableToken.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å–è¡¨åç§°.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getTableName</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> SQLUtil.getExactlyValue(originalLiterals);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SQLUtil.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getExactlyValue</span><span class="params">(<span class="keyword">final</span> String value)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span> == value ? <span class="keyword">null</span> : CharMatcher.anyOf(<span class="string">"[]`'\""</span>).removeFrom(value);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å½“ SQL ä¸º <code>SELECT o.* FROM t_order o</code><ul><li>TableToken ä¸ºæŸ¥è¯¢åˆ—å‰çš„è¡¨åˆ«å <code>o</code> æ—¶è¿”å›ç»“æœï¼š<br><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/04.png" alt=""></li><li>TableToken ä¸ºè¡¨å <code>t_order</code> æ—¶è¿”å›ç»“æœï¼š<br><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/05.png" alt=""></li></ul></li></ul><h2 id="3-2-ItemsToken"><a href="#3-2-ItemsToken" class="headerlink" title="3.2 ItemsToken"></a>3.2 ItemsToken</h2><p>è°ƒç”¨ <code>#appendItemsToken()</code> æ–¹æ³•æ‹¼æ¥ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‹¼æ¥ TableToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLæ„å»ºå™¨</div><div class="line">* <span class="doctag">@param</span> itemsToken itemsToken</div><div class="line">* <span class="doctag">@param</span> count itemsToken åœ¨ sqlTokens çš„é¡ºåº</div><div class="line">* <span class="doctag">@param</span> sqlTokens sqlTokens</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendItemsToken</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder, <span class="keyword">final</span> ItemsToken itemsToken, <span class="keyword">final</span> <span class="keyword">int</span> count, <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ‹¼æ¥ ItemsToken</span></div><div class="line">   <span class="keyword">for</span> (String item : itemsToken.getItems()) &#123;</div><div class="line">       sqlBuilder.appendLiterals(<span class="string">", "</span>);</div><div class="line">       sqlBuilder.appendLiterals(item);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// SQLToken åé¢çš„å­—ç¬¦ä¸²</span></div><div class="line">   <span class="keyword">int</span> beginPosition = itemsToken.getBeginPosition();</div><div class="line">   <span class="keyword">int</span> endPosition = sqlTokens.size() - <span class="number">1</span> == count ? originalSQL.length() : sqlTokens.get(count + <span class="number">1</span>).getBeginPosition();</div><div class="line">   sqlBuilder.appendLiterals(originalSQL.substring(beginPosition, endPosition));</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ä¸€ç§æƒ…å†µï¼Œ<strong>AVGæŸ¥è¯¢åˆ—</strong>ï¼ŒSQL ä¸º <code>SELECT AVG(order_id) FROM t_order o</code> æ—¶è¿”å›ç»“æœï¼š<br><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/06.png" alt=""></li><li>ç¬¬äºŒç§æƒ…å†µï¼Œ<strong>ORDER BY å­—æ®µä¸åœ¨æŸ¥è¯¢åˆ—</strong>ï¼ŒSQL ä¸º <code>SELECT userId FROM t_order o ORDER BY order_id</code> æ—¶è¿”å›ç»“æœï¼š<br><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/07.png" alt=""></li><li>ç¬¬ä¸‰ç§æƒ…å†µï¼Œ<strong>GROUP BY å­—æ®µä¸åœ¨æŸ¥è¯¢åˆ—</strong>ï¼Œç±»ä¼¼ç¬¬äºŒç§æƒ…å†µï¼Œå°±ä¸ä¸¾ä¾‹å­åˆ—ã€‚</li></ul><h2 id="3-3-OffsetToken"><a href="#3-3-OffsetToken" class="headerlink" title="3.3 OffsetToken"></a>3.3 OffsetToken</h2><p>è°ƒç”¨ <code>#appendLimitOffsetToken()</code> æ–¹æ³•æ‹¼æ¥ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‹¼æ¥ OffsetToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLæ„å»ºå™¨</div><div class="line">* <span class="doctag">@param</span> offsetToken offsetToken</div><div class="line">* <span class="doctag">@param</span> count offsetToken åœ¨ sqlTokens çš„é¡ºåº</div><div class="line">* <span class="doctag">@param</span> sqlTokens sqlTokens</div><div class="line">* <span class="doctag">@param</span> isRewrite æ˜¯å¦é‡å†™ã€‚å½“è·¯ç”±ç»“æœä¸ºå•åˆ†ç‰‡æ—¶æ— éœ€é‡å†™</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendLimitOffsetToken</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder, <span class="keyword">final</span> OffsetToken offsetToken, <span class="keyword">final</span> <span class="keyword">int</span> count, <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens, <span class="keyword">final</span> <span class="keyword">boolean</span> isRewrite)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ‹¼æ¥ OffsetToken</span></div><div class="line">   sqlBuilder.appendLiterals(isRewrite ? <span class="string">"0"</span> : String.valueOf(offsetToken.getOffset()));</div><div class="line">   <span class="comment">// SQLToken åé¢çš„å­—ç¬¦ä¸²</span></div><div class="line">   <span class="keyword">int</span> beginPosition = offsetToken.getBeginPosition() + String.valueOf(offsetToken.getOffset()).length();</div><div class="line">   <span class="keyword">int</span> endPosition = sqlTokens.size() - <span class="number">1</span> == count ? originalSQL.length() : sqlTokens.get(count + <span class="number">1</span>).getBeginPosition();</div><div class="line">   sqlBuilder.appendLiterals(originalSQL.substring(beginPosition, endPosition));</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å½“åˆ†é¡µ<strong>è·¨åˆ†ç‰‡</strong>æ—¶ï¼Œéœ€è¦æ¯ä¸ªåˆ†ç‰‡éƒ½æŸ¥è¯¢ååœ¨<strong>å†…å­˜</strong>ä¸­è¿›è¡Œèšåˆã€‚æ­¤æ—¶ <code>isRewrite = true</code>ã€‚ä¸ºä»€ä¹ˆæ˜¯ <code>&quot;0&quot;</code> å¼€å§‹å‘¢ï¼Ÿæ¯ä¸ªåˆ†ç‰‡åœ¨ [0, offset) çš„è®°å½•<strong>å¯èƒ½</strong>å±äºå®é™…åˆ†é¡µç»“æœï¼Œå› è€ŒæŸ¥è¯¢æ¯ä¸ªåˆ†ç‰‡éœ€è¦ä» 0 å¼€å§‹ã€‚</li><li>å½“åˆ†é¡µ<strong>å•åˆ†ç‰‡</strong>æ—¶ï¼Œåˆ™æ— éœ€é‡å†™ï¼Œè¯¥åˆ†ç‰‡æ‰§è¡Œçš„ç»“æœå³æ˜¯æœ€ç»ˆç»“æœã€‚<strong>SQLæ”¹å†™åœ¨SQLè·¯ç”±ä¹‹åå°±æœ‰è¿™ä¸ªå¥½å¤„</strong>ã€‚å¦‚æœå…ˆæ”¹å†™ï¼Œå› ä¸ºæ²¡åŠæ³•çŸ¥é“æœ€ç»ˆæ˜¯å•åˆ†ç‰‡è¿˜æ˜¯è·¨åˆ†ç‰‡ï¼Œè€ƒè™‘æ­£ç¡®æ€§ï¼Œåªèƒ½ç»Ÿä¸€ä½¿ç”¨è·¨åˆ†ç‰‡ã€‚</li></ul><h2 id="3-4-RowCountToken"><a href="#3-4-RowCountToken" class="headerlink" title="3.4 RowCountToken"></a>3.4 RowCountToken</h2><p>è°ƒç”¨ <code>#appendLimitRowCount()</code> æ–¹æ³•æ‹¼æ¥ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendLimitRowCount</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder, <span class="keyword">final</span> RowCountToken rowCountToken, <span class="keyword">final</span> <span class="keyword">int</span> count, <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens, <span class="keyword">final</span> <span class="keyword">boolean</span> isRewrite)</span> </span>&#123;</div><div class="line">   SelectStatement selectStatement = (SelectStatement) sqlStatement;</div><div class="line">   Limit limit = selectStatement.getLimit();</div><div class="line">   <span class="keyword">if</span> (!isRewrite) &#123; <span class="comment">// è·¯ç”±ç»“æœä¸ºå•åˆ†ç‰‡</span></div><div class="line">       sqlBuilder.appendLiterals(String.valueOf(rowCountToken.getRowCount()));</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((!selectStatement.getGroupByItems().isEmpty() || <span class="comment">// [1.1] è·¨åˆ†ç‰‡åˆ†ç»„éœ€è¦åœ¨å†…å­˜è®¡ç®—ï¼Œå¯èƒ½éœ€è¦å…¨éƒ¨åŠ è½½</span></div><div class="line">           !selectStatement.getAggregationSelectItems().isEmpty()) <span class="comment">// [1.2] è·¨åˆ†ç‰‡èšåˆåˆ—éœ€è¦åœ¨å†…å­˜è®¡ç®—ï¼Œå¯èƒ½éœ€è¦å…¨éƒ¨åŠ è½½</span></div><div class="line">           &amp;&amp; !selectStatement.isSameGroupByAndOrderByItems()) &#123; <span class="comment">// [2] å¦‚æœæ’åºä¸€è‡´ï¼Œå³å„åˆ†ç‰‡å·²ç»æ’åºå¥½ç»“æœï¼Œå°±ä¸éœ€è¦å…¨éƒ¨åŠ è½½</span></div><div class="line">       sqlBuilder.appendLiterals(String.valueOf(Integer.MAX_VALUE));</div><div class="line">   &#125; <span class="keyword">else</span> &#123; <span class="comment">// è·¯ç”±ç»“æœä¸ºå¤šåˆ†ç‰‡</span></div><div class="line">       sqlBuilder.appendLiterals(String.valueOf(limit.isRowCountRewriteFlag() ? rowCountToken.getRowCount() + limit.getOffsetValue() : rowCountToken.getRowCount()));</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// SQLToken åé¢çš„å­—ç¬¦ä¸²</span></div><div class="line">   <span class="keyword">int</span> beginPosition = rowCountToken.getBeginPosition() + String.valueOf(rowCountToken.getRowCount()).length();</div><div class="line">   <span class="keyword">int</span> endPosition = sqlTokens.size() - <span class="number">1</span> == count ? originalSQL.length() : sqlTokens.get(count + <span class="number">1</span>).getBeginPosition();</div><div class="line">   sqlBuilder.appendLiterals(originalSQL.substring(beginPosition, endPosition));</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>[1.1] <code>!selectStatement.getGroupByItems().isEmpty()</code> è·¨åˆ†ç‰‡<strong>åˆ†ç»„</strong>éœ€è¦åœ¨å†…å­˜è®¡ç®—ï¼Œ<strong>å¯èƒ½</strong>éœ€è¦å…¨éƒ¨åŠ è½½ã€‚å¦‚æœä¸å…¨éƒ¨åŠ è½½ï¼Œéƒ¨åˆ†ç»“æœè¢«åˆ†é¡µæ¡ä»¶é”™è¯¯ç»“æœï¼Œä¼šå¯¼è‡´ç»“æœä¸æ­£ç¡®ã€‚</li><li>[1.2] <code>!selectStatement.getAggregationSelectItems().isEmpty())</code> è·¨åˆ†ç‰‡<strong>èšåˆåˆ—</strong>éœ€è¦åœ¨å†…å­˜è®¡ç®—ï¼Œ<strong>å¯èƒ½</strong>éœ€è¦å…¨éƒ¨åŠ è½½ã€‚å¦‚æœä¸å…¨éƒ¨åŠ è½½ï¼Œéƒ¨åˆ†ç»“æœè¢«åˆ†é¡µæ¡ä»¶é”™è¯¯ç»“æœï¼Œä¼šå¯¼è‡´ç»“æœä¸æ­£ç¡®ã€‚</li><li>[1.1][1.2]ï¼Œ<strong>å¯èƒ½</strong>å˜æˆå¿…é¡»çš„å‰ææ˜¯ GROUP BY å’Œ ORDER BY æ’åºä¸ä¸€è‡´ã€‚å¦‚æœä¸€è‡´ï¼Œå„åˆ†ç‰‡å·²ç»æ’åºå®Œæˆï¼Œæ— éœ€å†…å­˜ä¸­æ’åºã€‚</li></ul><h3 id="3-4-1-åˆ†é¡µè¡¥å……"><a href="#3-4-1-åˆ†é¡µè¡¥å……" class="headerlink" title="3.4.1 åˆ†é¡µè¡¥å……"></a>3.4.1 åˆ†é¡µè¡¥å……</h3><p>OffsetTokenã€RowCountToken åªæœ‰åœ¨åˆ†é¡µå¯¹åº”ä½ç½®éå ä½ç¬¦ <code>?</code> æ‰å­˜åœ¨ã€‚å½“å¯¹åº”ä½ç½®æ˜¯å ä½ç¬¦æ—¶ï¼Œä¼šå¯¹<strong>åˆ†é¡µæ¡ä»¶å¯¹åº”çš„é¢„ç¼–è¯‘ SQL å ä½ç¬¦å‚æ•°</strong>è¿›è¡Œé‡å†™ï¼Œ<strong>æ•´ä½“é€»è¾‘å’Œ OffsetTokenã€RowCountToken æ˜¯ä¸€è‡´çš„</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ğŸ‘¼ ParsingSQLRouter#route() è°ƒç”¨ #processLimit() </span></div><div class="line"></div><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å¤„ç†åˆ†é¡µæ¡ä»¶</div><div class="line">*</div><div class="line">* <span class="doctag">@see</span> SQLRewriteEngine#appendLimitRowCount(SQLBuilder, RowCountToken, int, List, boolean) </div><div class="line">* <span class="doctag">@param</span> parameters å ä½ç¬¦å¯¹åº”å‚æ•°åˆ—è¡¨</div><div class="line">* <span class="doctag">@param</span> selectStatement Select SQLè¯­å¥å¯¹è±¡</div><div class="line">* <span class="doctag">@param</span> isSingleRouting æ˜¯å¦å•è¡¨è·¯ç”±</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processLimit</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SelectStatement selectStatement, <span class="keyword">final</span> <span class="keyword">boolean</span> isSingleRouting)</span> </span>&#123;</div><div class="line">   <span class="keyword">boolean</span> isNeedFetchAll = (!selectStatement.getGroupByItems().isEmpty() <span class="comment">// // [1.1] è·¨åˆ†ç‰‡åˆ†ç»„éœ€è¦åœ¨å†…å­˜è®¡ç®—ï¼Œå¯èƒ½éœ€è¦å…¨éƒ¨åŠ è½½</span></div><div class="line">                               || !selectStatement.getAggregationSelectItems().isEmpty()) <span class="comment">// [1.2] è·¨åˆ†ç‰‡èšåˆåˆ—éœ€è¦åœ¨å†…å­˜è®¡ç®—ï¼Œå¯èƒ½éœ€è¦å…¨éƒ¨åŠ è½½</span></div><div class="line">                           &amp;&amp; !selectStatement.isSameGroupByAndOrderByItems(); <span class="comment">// [2] å¦‚æœæ’åºä¸€è‡´ï¼Œå³å„åˆ†ç‰‡å·²ç»æ’åºå¥½ç»“æœï¼Œå°±ä¸éœ€è¦å…¨éƒ¨åŠ è½½</span></div><div class="line">   selectStatement.getLimit().processParameters(parameters, !isSingleRouting, isNeedFetchAll);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Limit.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å¡«å……æ”¹å†™åˆ†é¡µå‚æ•°.</div><div class="line">* <span class="doctag">@param</span> parameters å‚æ•°</div><div class="line">* <span class="doctag">@param</span> isRewrite æ˜¯å¦é‡å†™å‚æ•°</div><div class="line">* <span class="doctag">@param</span> isFetchAll æ˜¯å¦è·å–æ‰€æœ‰æ•°æ®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processParameters</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> <span class="keyword">boolean</span> isRewrite, <span class="keyword">final</span> <span class="keyword">boolean</span> isFetchAll)</span> </span>&#123;</div><div class="line">   fill(parameters);</div><div class="line">   <span class="keyword">if</span> (isRewrite) &#123;</div><div class="line">       rewrite(parameters, isFetchAll);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* å°†å ä½ç¬¦å‚æ•°é‡Œæ˜¯åˆ†é¡µçš„å‚æ•°èµ‹å€¼ç»™ offset ã€rowCount</div><div class="line">* èµ‹å€¼çš„å‰ææ¡ä»¶æ˜¯ offsetã€rowCount æ˜¯ å ä½ç¬¦</div><div class="line">* <span class="doctag">@param</span> parameters å ä½ç¬¦å‚æ•°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fill</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> offset = <span class="number">0</span>;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != <span class="keyword">this</span>.offset) &#123;</div><div class="line">       offset = -<span class="number">1</span> == <span class="keyword">this</span>.offset.getIndex() ? getOffsetValue() : NumberUtil.roundHalfUp(parameters.get(<span class="keyword">this</span>.offset.getIndex()));</div><div class="line">       <span class="keyword">this</span>.offset.setValue(offset);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">int</span> rowCount = <span class="number">0</span>;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != <span class="keyword">this</span>.rowCount) &#123;</div><div class="line">       rowCount = -<span class="number">1</span> == <span class="keyword">this</span>.rowCount.getIndex() ? getRowCountValue() : NumberUtil.roundHalfUp(parameters.get(<span class="keyword">this</span>.rowCount.getIndex()));</div><div class="line">       <span class="keyword">this</span>.rowCount.setValue(rowCount);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (offset &lt; <span class="number">0</span> || rowCount &lt; <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingException(<span class="string">"LIMIT offset and row count can not be a negative value."</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* é‡å†™åˆ†é¡µæ¡ä»¶å¯¹åº”çš„å‚æ•°</div><div class="line">* <span class="doctag">@param</span> parameters å‚æ•°</div><div class="line">* <span class="doctag">@param</span> isFetchAll æ˜¯å¦æ‹‰å–æ‰€æœ‰</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rewrite</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> <span class="keyword">boolean</span> isFetchAll)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> rewriteOffset = <span class="number">0</span>;</div><div class="line">   <span class="keyword">int</span> rewriteRowCount;</div><div class="line">   <span class="comment">// é‡å†™</span></div><div class="line">   <span class="keyword">if</span> (isFetchAll) &#123;</div><div class="line">       rewriteRowCount = Integer.MAX_VALUE;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rowCountRewriteFlag) &#123;</div><div class="line">       rewriteRowCount = <span class="keyword">null</span> == rowCount ? -<span class="number">1</span> : getOffsetValue() + rowCount.getValue();</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       rewriteRowCount = rowCount.getValue();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å‚æ•°è®¾ç½®</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != offset &amp;&amp; offset.getIndex() &gt; -<span class="number">1</span>) &#123;</div><div class="line">       parameters.set(offset.getIndex(), rewriteOffset);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != rowCount &amp;&amp; rowCount.getIndex() &gt; -<span class="number">1</span>) &#123;</div><div class="line">       parameters.set(rowCount.getIndex(), rewriteRowCount);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="3-5-OrderByToken"><a href="#3-5-OrderByToken" class="headerlink" title="3.5 OrderByToken"></a>3.5 OrderByToken</h2><p>è°ƒç”¨ <code>#appendOrderByToken()</code> æ–¹æ³•æ‹¼æ¥ã€‚æ•°æ®åº“é‡Œï¼Œå½“æ—  ORDER BYæ¡ä»¶ è€Œæœ‰ GROUP BY æ¡ä»¶æ—¶å€™ï¼Œä¼šä½¿ç”¨ GROUP BYæ¡ä»¶å°†ç»“æœå‡åºæ’åºï¼š</p><ul><li><code>SELECT order_id FROM t_order GROUP BY order_id</code> ç­‰ä»·äº <code>SELECT order_id FROM t_order GROUP BY order_id ORDER BY order_id ASC</code></li><li><code>SELECT order_id FROM t_order GROUP BY order_id DESC</code> ç­‰ä»·äº <code>SELECT order_id FROM t_order GROUP BY order_id ORDER BY order_id DESC</code></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‹¼æ¥ OrderByToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLæ„å»ºå™¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendOrderByToken</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder)</span> </span>&#123;</div><div class="line">   SelectStatement selectStatement = (SelectStatement) sqlStatement;</div><div class="line">   <span class="comment">// æ‹¼æ¥ OrderByToken</span></div><div class="line">   StringBuilder orderByLiterals = <span class="keyword">new</span> StringBuilder(<span class="string">" ORDER BY "</span>);</div><div class="line">   <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (OrderItem each : selectStatement.getOrderByItems()) &#123;</div><div class="line">       <span class="keyword">if</span> (<span class="number">0</span> == i) &#123;</div><div class="line">           orderByLiterals.append(each.getColumnLabel()).append(<span class="string">" "</span>).append(each.getType().name());</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           orderByLiterals.append(<span class="string">","</span>).append(each.getColumnLabel()).append(<span class="string">" "</span>).append(each.getType().name());</div><div class="line">       &#125;</div><div class="line">       i++;</div><div class="line">   &#125;</div><div class="line">   orderByLiterals.append(<span class="string">" "</span>);</div><div class="line">   sqlBuilder.appendLiterals(orderByLiterals.toString());</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å½“ SQL ä¸º <code>SELECT order_id FROM t_order o GROUP BY order_id</code> è¿”å›ç»“æœï¼š<br><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/08.png" alt=""></li></ul><h2 id="3-6-GeneratedKeyToken"><a href="#3-6-GeneratedKeyToken" class="headerlink" title="3.6 GeneratedKeyToken"></a>3.6 GeneratedKeyToken</h2><p>å‰ç½®é˜…è¯»ï¼š<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-4/?mp">ã€ŠSQL è§£æï¼ˆå››ï¼‰ä¹‹æ’å…¥SQLã€‹</a></p><p>GeneratedKeyTokenï¼Œå’Œå…¶å®ƒ SQLToken ä¸åŒï¼Œåœ¨ <strong>SQLè§£æ</strong> å®Œè¿›è¡Œå¤„ç†ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLStatement <span class="title">parse</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> <span class="keyword">int</span> parametersSize)</span> </span>&#123;</div><div class="line">   SQLParsingEngine parsingEngine = <span class="keyword">new</span> SQLParsingEngine(databaseType, logicSQL, shardingRule);</div><div class="line">   Context context = MetricsContext.start(<span class="string">"Parse SQL"</span>);</div><div class="line">   SQLStatement result = parsingEngine.parse();</div><div class="line">   <span class="keyword">if</span> (result <span class="keyword">instanceof</span> InsertStatement) &#123; <span class="comment">// å¤„ç† GenerateKeyToken</span></div><div class="line">       ((InsertStatement) result).appendGenerateKeyToken(shardingRule, parametersSize);</div><div class="line">   &#125;</div><div class="line">   MetricsContext.stop(context);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// InsertStatement.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è¿½åŠ è‡ªå¢ä¸»é”®æ ‡è®°å¯¹è±¡.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingRule åˆ†ç‰‡è§„åˆ™</div><div class="line">* <span class="doctag">@param</span> parametersSize å‚æ•°ä¸ªæ•°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendGenerateKeyToken</span><span class="params">(<span class="keyword">final</span> ShardingRule shardingRule, <span class="keyword">final</span> <span class="keyword">int</span> parametersSize)</span> </span>&#123;</div><div class="line">   <span class="comment">// SQL é‡Œæœ‰ä¸»é”®åˆ—</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != generatedKey) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// TableRule å­˜åœ¨</span></div><div class="line">   Optional&lt;TableRule&gt; tableRule = shardingRule.tryFindTableRule(getTables().getSingleTableName());</div><div class="line">   <span class="keyword">if</span> (!tableRule.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// GeneratedKeyToken å­˜åœ¨</span></div><div class="line">   Optional&lt;GeneratedKeyToken&gt; generatedKeysToken = findGeneratedKeyToken();</div><div class="line">   <span class="keyword">if</span> (!generatedKeysToken.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å¤„ç† GenerateKeyToken</span></div><div class="line">   ItemsToken valuesToken = <span class="keyword">new</span> ItemsToken(generatedKeysToken.get().getBeginPosition());</div><div class="line">   <span class="keyword">if</span> (<span class="number">0</span> == parametersSize) &#123;</div><div class="line">       appendGenerateKeyToken(shardingRule, tableRule.get(), valuesToken);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       appendGenerateKeyToken(shardingRule, tableRule.get(), valuesToken, parametersSize);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç§»é™¤ generatedKeysToken</span></div><div class="line">   getSqlTokens().remove(generatedKeysToken.get());</div><div class="line">   <span class="comment">// æ–°å¢ ItemsToken</span></div><div class="line">   getSqlTokens().add(valuesToken);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>æ ¹æ®<strong>å ä½ç¬¦å‚æ•°</strong>æ•°é‡ä¸åŒï¼Œè°ƒç”¨çš„ <code>#appendGenerateKeyToken()</code> æ˜¯<strong>ä¸åŒ</strong>çš„ï¼š</li><li><strong>å ä½ç¬¦å‚æ•°æ•°é‡ = 0</strong> æ—¶ï¼Œç›´æ¥ç”Ÿæˆ<strong>åˆ†å¸ƒå¼ä¸»é”®</strong>ï¼Œä¿æŒæ— å ä½ç¬¦çš„åšæ³•ã€‚</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// InsertStatement.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendGenerateKeyToken</span><span class="params">(<span class="keyword">final</span> ShardingRule shardingRule, <span class="keyword">final</span> TableRule tableRule, <span class="keyword">final</span> ItemsToken valuesToken)</span> </span>&#123;</div><div class="line">   <span class="comment">// ç”Ÿæˆåˆ†å¸ƒå¼ä¸»é”®</span></div><div class="line">   Number generatedKey = shardingRule.generateKey(tableRule.getLogicTable());</div><div class="line">   <span class="comment">// æ·»åŠ åˆ° ItemsToken</span></div><div class="line">   valuesToken.getItems().add(generatedKey.toString());</div><div class="line">   <span class="comment">// å¢åŠ  Conditionï¼Œç”¨äºè·¯ç”±</span></div><div class="line">   getConditions().add(<span class="keyword">new</span> Condition(<span class="keyword">new</span> Column(tableRule.getGenerateKeyColumn(), tableRule.getLogicTable()), <span class="keyword">new</span> SQLNumberExpression(generatedKey)), shardingRule);</div><div class="line">   <span class="comment">// ç”Ÿæˆ GeneratedKey</span></div><div class="line">   <span class="keyword">this</span>.generatedKey = <span class="keyword">new</span> GeneratedKey(tableRule.getLogicTable(), -<span class="number">1</span>, generatedKey);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>å ä½ç¬¦å‚æ•°æ•°é‡ &gt; 0</strong> æ—¶ï¼Œç”Ÿæˆè‡ªå¢åˆ—çš„å ä½ç¬¦ï¼Œä¿æŒæœ‰å ä½ç¬¦çš„åšæ³•ã€‚</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendGenerateKeyToken</span><span class="params">(<span class="keyword">final</span> ShardingRule shardingRule, <span class="keyword">final</span> TableRule tableRule, <span class="keyword">final</span> ItemsToken valuesToken, <span class="keyword">final</span> <span class="keyword">int</span> parametersSize)</span> </span>&#123;</div><div class="line">   <span class="comment">// ç”Ÿæˆå ä½ç¬¦</span></div><div class="line">   valuesToken.getItems().add(<span class="string">"?"</span>);</div><div class="line">   <span class="comment">// å¢åŠ  Conditionï¼Œç”¨äºè·¯ç”±</span></div><div class="line">   getConditions().add(<span class="keyword">new</span> Condition(<span class="keyword">new</span> Column(tableRule.getGenerateKeyColumn(), tableRule.getLogicTable()), <span class="keyword">new</span> SQLPlaceholderExpression(parametersSize)), shardingRule);</div><div class="line">   <span class="comment">// ç”Ÿæˆ GeneratedKey</span></div><div class="line">   generatedKey = <span class="keyword">new</span> GeneratedKey(tableRule.getGenerateKeyColumn(), parametersSize, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å› ä¸º GenerateKeyToken å·²ç»å¤„ç†å®Œï¼Œæ‰€ä»¥ç§»é™¤ï¼Œé¿å… <code>SQLRewriteEngine#rewrite()</code> äºŒæ¬¡æ”¹å†™ã€‚å¦å¤–ï¼Œé€šè¿‡ ItemsToken è¡¥å……è‡ªå¢åˆ—ã€‚</li><li>ç”Ÿæˆ GeneratedKey ä¼šåœ¨ ParsingSQLRouter è¿›ä¸€æ­¥å¤„ç†ã€‚</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLRouteResult <span class="title">route</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   <span class="keyword">final</span> Context context = MetricsContext.start(<span class="string">"Route SQL"</span>);</div><div class="line">   SQLRouteResult result = <span class="keyword">new</span> SQLRouteResult(sqlStatement);</div><div class="line">   <span class="comment">// å¤„ç† æ’å…¥SQL ä¸»é”®å­—æ®µ</span></div><div class="line">   <span class="keyword">if</span> (sqlStatement <span class="keyword">instanceof</span> InsertStatement &amp;&amp; <span class="keyword">null</span> != ((InsertStatement) sqlStatement).getGeneratedKey()) &#123;</div><div class="line">       processGeneratedKey(parameters, (InsertStatement) sqlStatement, result);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">&#125;  </div><div class="line"><span class="comment">/**</span></div><div class="line">* å¤„ç† æ’å…¥SQL ä¸»é”®å­—æ®µ</div><div class="line">* å½“ ä¸»é”®ç¼–å· æœªç”Ÿæˆæ—¶ï¼Œ&#123;<span class="doctag">@link</span> ShardingRule#generateKey(String)&#125; è¿›è¡Œç”Ÿæˆ</div><div class="line">* <span class="doctag">@param</span> parameters å ä½ç¬¦å‚æ•°</div><div class="line">* <span class="doctag">@param</span> insertStatement Insert SQLè¯­å¥å¯¹è±¡</div><div class="line">* <span class="doctag">@param</span> sqlRouteResult SQLè·¯ç”±ç»“æœ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processGeneratedKey</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> InsertStatement insertStatement, <span class="keyword">final</span> SQLRouteResult sqlRouteResult)</span> </span>&#123;</div><div class="line">   GeneratedKey generatedKey = insertStatement.getGeneratedKey();</div><div class="line">   <span class="keyword">if</span> (parameters.isEmpty()) &#123; <span class="comment">// å·²æœ‰ä¸»é”®ï¼Œæ— å ä½ç¬¦ï¼ŒINSERT INTO t_order(order_id, user_id) VALUES (1, 100);</span></div><div class="line">       sqlRouteResult.getGeneratedKeys().add(generatedKey.getValue());</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parameters.size() == generatedKey.getIndex()) &#123; <span class="comment">// ä¸»é”®å­—æ®µä¸å­˜åœ¨å­˜åœ¨ï¼ŒINSERT INTO t_order(user_id) VALUES(?);</span></div><div class="line">       Number key = shardingRule.generateKey(insertStatement.getTables().getSingleTableName()); <span class="comment">// ç”Ÿæˆä¸»é”®ç¼–å·</span></div><div class="line">       parameters.add(key);</div><div class="line">       setGeneratedKeys(sqlRouteResult, key);</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (-<span class="number">1</span> != generatedKey.getIndex()) &#123; <span class="comment">// ä¸»é”®å­—æ®µå­˜åœ¨ï¼ŒINSERT INTO t_order(order_id, user_id) VALUES(?, ?);</span></div><div class="line">       setGeneratedKeys(sqlRouteResult, (Number) parameters.get(generatedKey.getIndex()));</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¾ç½® ä¸»é”®ç¼–å· åˆ° SQLè·¯ç”±ç»“æœ</div><div class="line">* <span class="doctag">@param</span> sqlRouteResult SQLè·¯ç”±ç»“æœ</div><div class="line">* <span class="doctag">@param</span> generatedKey ä¸»é”®ç¼–å·</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setGeneratedKeys</span><span class="params">(<span class="keyword">final</span> SQLRouteResult sqlRouteResult, <span class="keyword">final</span> Number generatedKey)</span> </span>&#123;</div><div class="line">   generatedKeys.add(generatedKey);</div><div class="line">   sqlRouteResult.getGeneratedKeys().clear();</div><div class="line">   sqlRouteResult.getGeneratedKeys().addAll(generatedKeys);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>parameters.size() == generatedKey.getIndex()</code> å¤„å¯¹åº” <code>#appendGenerateKeyToken()</code> çš„ <strong>å ä½ç¬¦å‚æ•°æ•°é‡ &gt; 0</strong> æƒ…å†µï¼Œæ­¤æ—¶ä¼šç”Ÿæˆ<strong>åˆ†å¸ƒå¼ä¸»é”®</strong>ã€‚ğŸ˜ˆ è¯¥å¤„æ˜¯ä¸æ˜¯å¯ä»¥è€ƒè™‘æŠŠç”Ÿæˆ<strong>åˆ†å¸ƒå¼ä¸»é”®</strong>æŒªåˆ° <code>#appendGenerateKeyToken()</code>ï¼Œè¿™æ ·æ›´åŠ ç»Ÿä¸€ä¸€äº›ã€‚</li></ul><h1 id="4-SQL-ç”Ÿæˆ"><a href="#4-SQL-ç”Ÿæˆ" class="headerlink" title="4. SQL ç”Ÿæˆ"></a>4. SQL ç”Ÿæˆ</h1><p><strong>SQLè·¯ç”±</strong>å®Œåï¼Œä¼šç”Ÿæˆå„æ•°æ®åˆ†ç‰‡çš„<strong>æ‰§è¡ŒSQL</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLRouteResult <span class="title">route</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   SQLRouteResult result = <span class="keyword">new</span> SQLRouteResult(sqlStatement);</div><div class="line">   <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç ... å¤„ç† æ’å…¥SQL ä¸»é”®å­—æ®µ</span></div><div class="line">   </div><div class="line">   <span class="comment">// è·¯ç”±</span></div><div class="line">   RoutingResult routingResult = route(parameters, sqlStatement);</div><div class="line">   </div><div class="line">   <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç ... SQLé‡å†™å¼•æ“</span></div><div class="line">   SQLRewriteEngine rewriteEngine = <span class="keyword">new</span> SQLRewriteEngine(shardingRule, logicSQL, sqlStatement);</div><div class="line">   <span class="keyword">boolean</span> isSingleRouting = routingResult.isSingleRouting();</div><div class="line">   <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç ... å¤„ç†åˆ†é¡µ</span></div><div class="line">   <span class="comment">// SQL é‡å†™</span></div><div class="line">   SQLBuilder sqlBuilder = rewriteEngine.rewrite(!isSingleRouting);</div><div class="line">   <span class="comment">// ç”Ÿæˆ ExecutionUnit</span></div><div class="line">   <span class="keyword">if</span> (routingResult <span class="keyword">instanceof</span> CartesianRoutingResult) &#123;</div><div class="line">       <span class="keyword">for</span> (CartesianDataSource cartesianDataSource : ((CartesianRoutingResult) routingResult).getRoutingDataSources()) &#123;</div><div class="line">           <span class="keyword">for</span> (CartesianTableReference cartesianTableReference : cartesianDataSource.getRoutingTableReferences()) &#123;</div><div class="line">               <span class="comment">// ğŸ‘¼ ç”Ÿæˆ SQL</span></div><div class="line">               result.getExecutionUnits().add(<span class="keyword">new</span> SQLExecutionUnit(cartesianDataSource.getDataSource(), rewriteEngine.generateSQL(cartesianTableReference, sqlBuilder)));</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">for</span> (TableUnit each : routingResult.getTableUnits().getTableUnits()) &#123;</div><div class="line">           <span class="comment">// ğŸ‘¼ ç”Ÿæˆ SQL</span></div><div class="line">           result.getExecutionUnits().add(<span class="keyword">new</span> SQLExecutionUnit(each.getDataSourceName(), rewriteEngine.generateSQL(each, sqlBuilder)));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>RewriteEngine#generateSQL()</code> ç”Ÿæˆ<strong>æ‰§è¡ŒSQL</strong>ã€‚å¯¹äºç¬›å¡å°”ç§¯è·¯ç”±ç»“æœå’Œç®€å•è·¯ç”±ç»“æœä¼ é€’çš„å‚æ•°ç•¥æœ‰ä¸åŒï¼šå‰è€…ä½¿ç”¨ CartesianDataSource ( CartesianTableReference )ï¼Œåè€…ä½¿ç”¨è·¯ç”±è¡¨å•å…ƒ ( TableUnit )ã€‚å¯¹è·¯ç”±ç»“æœä¸æ˜¯å¾ˆäº†è§£çš„åŒå­¦ï¼Œå»ºè®®çœ‹ä¸‹ <a href="http://www.yunai.me/Sharding-JDBC/sql-route-2/?mp">ã€ŠSQL è·¯ç”±ï¼ˆäºŒï¼‰ä¹‹åˆ†åº“åˆ†è¡¨è·¯ç”±ã€‹</a>ã€‚</li></ul><p><code>RewriteEngine#generateSQL()</code> å¯¹äºç¬›å¡å°”ç§¯è·¯ç”±ç»“æœå’Œç®€å•è·¯ç”±ç»“æœä¸¤ç§æƒ…å†µï¼Œå¤„ç†ä¸Šå¤§ä½“æ˜¯ä¸€è‡´çš„ï¼š1. è·å¾— SQL ç›¸å…³<strong>é€»è¾‘è¡¨</strong>å¯¹åº”çš„<strong>çœŸå®è¡¨</strong>æ˜ å°„ï¼Œ2. æ ¹æ®æ˜ å°„æ”¹å†™ SQL ç›¸å…³<strong>é€»è¾‘è¡¨</strong>ä¸º<strong>çœŸå®è¡¨</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ç”ŸæˆSQLè¯­å¥.</div><div class="line">* <span class="doctag">@param</span> tableUnit è·¯ç”±è¡¨å•å…ƒ</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLæ„å»ºå™¨</div><div class="line">* <span class="doctag">@return</span> SQLè¯­å¥</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">generateSQL</span><span class="params">(<span class="keyword">final</span> TableUnit tableUnit, <span class="keyword">final</span> SQLBuilder sqlBuilder)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> sqlBuilder.toSQL(getTableTokens(tableUnit));</div><div class="line">&#125;  </div><div class="line"><span class="comment">/**</span></div><div class="line">* ç”ŸæˆSQLè¯­å¥.</div><div class="line">* <span class="doctag">@param</span> cartesianTableReference ç¬›å¡å°”ç§¯è·¯ç”±è¡¨å•å…ƒ</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLæ„å»ºå™¨</div><div class="line">* <span class="doctag">@return</span> SQLè¯­å¥</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">generateSQL</span><span class="params">(<span class="keyword">final</span> CartesianTableReference cartesianTableReference, <span class="keyword">final</span> SQLBuilder sqlBuilder)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> sqlBuilder.toSQL(getTableTokens(cartesianTableReference));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">// SQLBuilder.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ç”ŸæˆSQLè¯­å¥.</div><div class="line">* <span class="doctag">@param</span> tableTokens å ä½ç¬¦é›†åˆï¼ˆé€»è¾‘è¡¨ä¸çœŸå®è¡¨æ˜ å°„ï¼‰</div><div class="line">* <span class="doctag">@return</span> SQLè¯­å¥</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toSQL</span><span class="params">(<span class="keyword">final</span> Map&lt;String, String&gt; tableTokens)</span> </span>&#123;</div><div class="line">   StringBuilder result = <span class="keyword">new</span> StringBuilder();</div><div class="line">   <span class="keyword">for</span> (Object each : segments) &#123;</div><div class="line">       <span class="keyword">if</span> (each <span class="keyword">instanceof</span> TableToken &amp;&amp; tableTokens.containsKey(((TableToken) each).tableName)) &#123;</div><div class="line">           result.append(tableTokens.get(((TableToken) each).tableName));</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           result.append(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>#toSQL()</code> ç»“æœå¦‚å›¾ï¼š <img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/09.png" alt=""><br>ğŸ˜œ å¯¹ <strong>SQLæ”¹å†™</strong> æ˜¯ä¸æ˜¯æ¸…æ™°å¾ˆå¤šäº†ã€‚</li></ul><hr><p>ä¸‹é¢æˆ‘ä»¬ä»¥<strong>ç¬›å¡å°”ç§¯è·¯ç”±ç»“æœ</strong>è·å¾— SQL ç›¸å…³<strong>é€»è¾‘è¡¨</strong>å¯¹åº”çš„<strong>çœŸå®è¡¨</strong>æ˜ å°„ä¸ºä¾‹å­(<em>ç®€å•è·¯ç”±ç»“æœåŸºæœ¬ç±»ä¼¼è€Œä¸”ç®€å•</em>)ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—ï¼ˆç¬›å¡å°”ç§¯è¡¨è·¯ç”±ç»„é‡Œçš„è·¯ç”±è¡¨å•å…ƒé€»è¾‘è¡¨ å’Œ ä¸å…¶äº’ä¸ºBindingTableå…³ç³»çš„é€»è¾‘è¡¨ï¼‰å¯¹åº”çš„çœŸå®è¡¨æ˜ å°„ï¼ˆé€»è¾‘è¡¨éœ€è¦åœ¨ SQL ä¸­å­˜åœ¨ï¼‰</div><div class="line">* <span class="doctag">@param</span> cartesianTableReference ç¬›å¡å°”ç§¯è¡¨è·¯ç”±ç»„</div><div class="line">* <span class="doctag">@return</span> é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">getTableTokens</span><span class="params">(<span class="keyword">final</span> CartesianTableReference cartesianTableReference)</span> </span>&#123;</div><div class="line">   Map&lt;String, String&gt; tableTokens = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (TableUnit each : cartesianTableReference.getTableUnits()) &#123;</div><div class="line">       tableTokens.put(each.getLogicTableName(), each.getActualTableName());</div><div class="line">       <span class="comment">// æŸ¥æ‰¾ BindingTableRule</span></div><div class="line">       Optional&lt;BindingTableRule&gt; bindingTableRule = shardingRule.findBindingTableRule(each.getLogicTableName());</div><div class="line">       <span class="keyword">if</span> (bindingTableRule.isPresent()) &#123;</div><div class="line">           tableTokens.putAll(getBindingTableTokens(each, bindingTableRule.get()));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> tableTokens;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾— BindingTable å…³ç³»çš„é€»è¾‘è¡¨å¯¹åº”çš„çœŸå®è¡¨æ˜ å°„ï¼ˆé€»è¾‘è¡¨éœ€è¦åœ¨ SQL ä¸­å­˜åœ¨ï¼‰</div><div class="line">* <span class="doctag">@param</span> tableUnit è·¯ç”±å•å…ƒ</div><div class="line">* <span class="doctag">@param</span> bindingTableRule Bindingè¡¨è§„åˆ™é…ç½®å¯¹è±¡</div><div class="line">* <span class="doctag">@return</span> æ˜ å°„</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">getBindingTableTokens</span><span class="params">(<span class="keyword">final</span> TableUnit tableUnit, <span class="keyword">final</span> BindingTableRule bindingTableRule)</span> </span>&#123;</div><div class="line">   Map&lt;String, String&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (String eachTable : sqlStatement.getTables().getTableNames()) &#123;</div><div class="line">       <span class="keyword">if</span> (!eachTable.equalsIgnoreCase(tableUnit.getLogicTableName()) &amp;&amp; bindingTableRule.hasLogicTable(eachTable)) &#123;</div><div class="line">           result.put(eachTable, bindingTableRule.getBindingActualTable(tableUnit.getDataSourceName(), eachTable, tableUnit.getActualTableName()));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ç¬›å¡å°”ç§¯è¡¨è·¯ç”±ç»„( CartesianTableReference )åŒ…å«<strong>å¤šä¸ª</strong>è·¯ç”±è¡¨å•å…ƒ( TableUnit )ã€‚æ¯ä¸ªè·¯ç”±è¡¨å•å…ƒéœ€è¦éå†ã€‚</li><li>è·¯ç”±è¡¨å•å…ƒæœ¬èº«åŒ…å«é€»è¾‘è¡¨å’ŒçœŸå®è¡¨ï¼Œç›´æ¥æ·»åŠ åˆ°æ˜ å°„å³å¯ã€‚</li><li>äº’ä¸º BindingTable å…³ç³»çš„è¡¨åªè®¡ç®—ä¸€æ¬¡è·¯ç”±åˆ†ç‰‡ï¼Œå› æ­¤<strong>æœªè®¡ç®—</strong>çš„çœŸå®è¡¨éœ€è¦ä»¥å…¶å¯¹åº”çš„<strong>å·²è®¡ç®—</strong>çš„çœŸå®è¡¨å»æŸ¥æ‰¾ï¼Œå³ <code>bindingTableRule.getBindingActualTable(tableUnit.getDataSourceName(), eachTable, tableUnit.getActualTableName())</code> å¤„é€»è¾‘ã€‚</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// BindingTableRule.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ ¹æ®å…¶ä»–Bindingè¡¨çœŸå®è¡¨åç§°è·å–ç›¸åº”çš„çœŸå®Bindingè¡¨åç§°.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> dataSource æ•°æ®æºåç§°</div><div class="line">* <span class="doctag">@param</span> logicTable é€»è¾‘è¡¨åç§°</div><div class="line">* <span class="doctag">@param</span> otherActualTable å…¶ä»–çœŸå®Bindingè¡¨åç§°</div><div class="line">* <span class="doctag">@return</span> çœŸå®Bindingè¡¨åç§°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getBindingActualTable</span><span class="params">(<span class="keyword">final</span> String dataSource, <span class="keyword">final</span> String logicTable, <span class="keyword">final</span> String otherActualTable)</span> </span>&#123;</div><div class="line">   <span class="comment">// è®¡ç®— otherActualTable åœ¨å…¶ TableRule çš„ actualTable æ˜¯ç¬¬å‡ ä¸ª</span></div><div class="line">   <span class="keyword">int</span> index = -<span class="number">1</span>;</div><div class="line">   <span class="keyword">for</span> (TableRule each : tableRules) &#123;</div><div class="line">       <span class="keyword">if</span> (each.isDynamic()) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Dynamic table cannot support Binding table."</span>);</div><div class="line">       &#125;</div><div class="line">       index = each.findActualTableIndex(dataSource, otherActualTable);</div><div class="line">       <span class="keyword">if</span> (-<span class="number">1</span> != index) &#123;</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   Preconditions.checkState(-<span class="number">1</span> != index, String.format(<span class="string">"Actual table [%s].[%s] is not in table config"</span>, dataSource, otherActualTable));</div><div class="line">   <span class="comment">// è®¡ç®— logicTable åœ¨å…¶ TableRule çš„ ç¬¬index çš„ çœŸå®è¡¨</span></div><div class="line">   <span class="keyword">for</span> (TableRule each : tableRules) &#123;</div><div class="line">       <span class="keyword">if</span> (each.getLogicTable().equalsIgnoreCase(logicTable)) &#123;</div><div class="line">           <span class="keyword">return</span> each.getActualTables().get(index).getTableName();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(String.format(<span class="string">"Cannot find binding actual table, data source: %s, logic table: %s, other actual table: %s"</span>, dataSource, logicTable, otherActualTable));</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>å¯èƒ½çœ‹èµ·æ¥æœ‰äº›ç»•ï¼Œæˆ‘ä»¬çœ‹å¼ å›¾ï¼š</p><p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/10.png" alt=""></p><p><strong>å‹æƒ…æç¤º</strong>ï¼šè¿™é‡Œä¸å«Œå•°å—¦åœ¨æä¸€å¥ï¼Œäº’ä¸º BindingTable çš„è¡¨ï¼Œé…ç½® TableRule æ—¶ï¼Œ<code>actualTables</code> æ•°é‡ä¸€å®šè¦ä¸€è‡´ï¼Œå¦åˆ™å¤šå‡ºæ¥çš„è¡¨ï¼Œå¯èƒ½ä¼šæ— æ³•è¢«è·¯ç”±åˆ°ã€‚</p><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å“ˆå“ˆå“ˆï¼Œçœ‹å®Œ<strong>SQLæ”¹å†™</strong>åï¼Œ<strong>SQLè§£æ</strong>æ˜¯ä¸æ˜¯æ¸…æ™°å¤šäº†ï¼å˜¿å˜¿å˜¿ï¼Œåæ­£æˆ‘ç°åœ¨æœ‰ç‚¹å—¨ã€‚æ©ï¼Œè›®å—¨çš„ã€‚</p><p>å½“ç„¶ï¼Œå¦‚æœ<strong>SQLè§£æ</strong>ç†è§£ä¸Šæœ‰ç‚¹ç–‘æƒ‘çš„ä½ ï¼Œ<strong>æ¬¢è¿</strong>åŠ æˆ‘çš„å¾®ä¿¡ï¼Œå’± <strong>1å¯¹1</strong> æåŸºã€‚å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ï¼š<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</a> å³å¯è·å¾—ã€‚</p><p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><p>é“å‹ï¼Œè½¬å‘ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼Ÿ</p><p>Letâ€™s Go! <a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šåˆ†å¸ƒå¼ä¸»é”®ã€‹</a>ã€<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL æ‰§è¡Œã€‹</a>ã€<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šç»“æœèšåˆã€‹</a> ç»§ç»­ã€‚</p><p><em>æ„Ÿè°¢æŠ€æœ¯ç‰›é€¼å¦‚ä½ è€å¿ƒçš„é˜…è¯»æœ¬æ–‡ã€‚</em></p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/Sharding-JDBC/">Sharding-JDBC</a></div><div class="article-share" id="share"><div data-url="http://www.yunai.me/Sharding-JDBC/sql-rewrite/" data-title="Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±æ”¹å†™ | èŠ‹è‰¿Vçš„åšå®¢" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/Sharding-JDBC/distributed-id/" title="Sharding-JDBC æºç åˆ†æ â€”â€” åˆ†å¸ƒå¼ä¸»é”®"><strong>PREVIOUS:</strong><br><span>Sharding-JDBC æºç åˆ†æ â€”â€” åˆ†å¸ƒå¼ä¸»é”®</span></a></div><div class="next"><a href="/Sharding-JDBC/sql-route-3/" title="Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±ï¼ˆä¸‰ï¼‰ä¹‹Springä¸YAMLé…ç½®"><strong>NEXT:</strong><br><span>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±ï¼ˆä¸‰ï¼‰ä¹‹Springä¸YAMLé…ç½®</span></a></div></nav></div></div><footer><div id="footer"><p class="copyright">Â© 2017 <a href="http://www.yunai.me" target="_blank" title="ç‹æ–‡æ–Œ">ç‹æ–‡æ–Œ</a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a> && Powered by <a href="http://hexo.io" target="_blank" title="hexo" rel="external nofollow noopener noreferrer">hexo</a> && Theme by <a href="http://gengbiao.me" target="_blank" title="coney" rel="external nofollow noopener noreferrer">coney</a></p></div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2"),ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script></body>