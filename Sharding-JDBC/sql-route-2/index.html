<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±ï¼ˆäºŒï¼‰ä¹‹åˆ†åº“åˆ†è¡¨è·¯ç”± | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="ç‹æ–‡æ–Œ"><meta name="description" content="ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘æœ‰ç¦åˆ©ï¼š  

RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨  
RocketMQ / MyCAT / Sharding-JDBC ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€  
æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚ç”šè‡³ä¸"><meta name="keywords" content="Sharding-JDBC,ShardingJDBC,Sharding-JDBC æºç ,SQL è·¯ç”±,è·¯ç”±,è·¯ç”±é…ç½®,Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?ef4ed89f6dc83d01803a2440ae21e666";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG">èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</a></h1><a class="blog-motto">æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li><li><a href="/link_url">å‹é“¾</a></li></ul></ul></nav></div></header><div id="container"><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-SQLRouteResult"><span class="toc-number">2.</span> <span class="toc-text">2. SQLRouteResult</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-è·¯ç”±ç­–ç•¥-x-ç®—æ³•"><span class="toc-number">3.</span> <span class="toc-text">3. è·¯ç”±ç­–ç•¥ x ç®—æ³•</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-SQL-è·¯ç”±"><span class="toc-number">4.</span> <span class="toc-text">4. SQL è·¯ç”±</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-DatabaseHintSQLRouter"><span class="toc-number">5.</span> <span class="toc-text">5. DatabaseHintSQLRouter</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-ParsingSQLRouter"><span class="toc-number">6.</span> <span class="toc-text">6. ParsingSQLRouter</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-SimpleRoutingEngine"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 SimpleRoutingEngine</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-ComplexRoutingEngine"><span class="toc-number">6.2.</span> <span class="toc-text">6.2 ComplexRoutingEngine</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-CartesianRoutingEngine"><span class="toc-number">6.3.</span> <span class="toc-text">6.3 CartesianRoutingEngine</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-ParsingSQLRouter-ä¸»-route"><span class="toc-number">6.4.</span> <span class="toc-text">6.4 ParsingSQLRouter ä¸»#route()</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-å½©è›‹"><span class="toc-number">7.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/Elastic-Job/" title="Elastic-Job">Elastic-Job<sup>16</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/æŠ€æœ¯æ‚æ–‡/" title="æŠ€æœ¯æ‚æ–‡">æŠ€æœ¯æ‚æ–‡<sup>3</sup></a></li></ul></div></aside></div><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/Sharding-JDBC/sql-route-2/" title="Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±ï¼ˆäºŒï¼‰ä¹‹åˆ†åº“åˆ†è¡¨è·¯ç”±" itemprop="url">Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±ï¼ˆäºŒï¼‰ä¹‹åˆ†åº“åˆ†è¡¨è·¯ç”±</a></h1><p class="article-author"></p><p class="article-time">æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Sharding-JDBC 1.5.0 æ­£å¼ç‰ˆ</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. SQLRouteResult</a></li><li><a href="#">3. è·¯ç”±ç­–ç•¥ x ç®—æ³•</a></li><li><a href="#">4. SQL è·¯ç”±</a></li><li><a href="#">5. DatabaseHintSQLRouter</a></li><li><a href="#">6. ParsingSQLRouter</a><ul><li><a href="#">6.1 SimpleRoutingEngine</a></li><li><a href="#">6.2 ComplexRoutingEngine</a></li><li><a href="#">6.3 CartesianRoutingEngine</a></li><li><a href="#">6.3 ParsingSQLRouter ä¸»#route()</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº«åˆ†è¡¨åˆ†åº“<strong>è·¯ç”±</strong>ç›¸å…³çš„å®ç°ã€‚æ¶‰åŠå†…å®¹å¦‚ä¸‹ï¼š</p><ol><li>SQL è·¯ç”±ç»“æœ</li><li>è·¯ç”±ç­–ç•¥ x ç®—æ³•</li><li>SQL è·¯ç”±å™¨</li></ol><p>å†…å®¹é¡ºåºå¦‚ç¼–å·ã€‚</p><blockquote><p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p></blockquote><p>SQL è·¯ç”±å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/06.png" alt=""></p><h1 id="2-SQLRouteResult"><a href="#2-SQLRouteResult" class="headerlink" title="2. SQLRouteResult"></a>2. SQLRouteResult</h1><p>ç»è¿‡ <strong>SQLè§£æ</strong>ã€<strong>SQLè·¯ç”±</strong>åï¼Œäº§ç”Ÿ<strong>SQLè·¯ç”±ç»“æœ</strong>ï¼Œå³ SQLRouteResultã€‚æ ¹æ®è·¯ç”±ç»“æœï¼Œ<strong>ç”ŸæˆSQL</strong>ï¼Œ<strong>æ‰§è¡ŒSQL</strong>ã€‚</p><p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/01.png" alt=""></p><ul><li><code>sqlStatement</code> ï¼šSQLè¯­å¥å¯¹è±¡ï¼Œç»è¿‡<strong>SQLè§£æ</strong>çš„ç»“æœå¯¹è±¡ã€‚</li><li><code>executionUnits</code> ï¼šSQLæœ€å°æ‰§è¡Œå•å…ƒé›†åˆã€‚<strong>SQLæ‰§è¡Œ</strong>æ—¶ï¼Œæ‰§è¡Œæ¯ä¸ªå•å…ƒã€‚</li><li><code>generatedKeys</code> ï¼š<strong>æ’å…¥</strong>SQLè¯­å¥ç”Ÿæˆçš„ä¸»é”®ç¼–å·é›†åˆã€‚ç›®å‰ä¸æ”¯æŒæ‰¹é‡æ’å…¥è€Œä½¿ç”¨é›†åˆçš„åŸå› ï¼ŒçŒœæµ‹æ˜¯ä¸ºäº†æœªæ¥æ”¯æŒæ‰¹é‡æ’å…¥åšå‡†å¤‡ã€‚</li></ul><h1 id="3-è·¯ç”±ç­–ç•¥-x-ç®—æ³•"><a href="#3-è·¯ç”±ç­–ç•¥-x-ç®—æ³•" class="headerlink" title="3. è·¯ç”±ç­–ç•¥ x ç®—æ³•"></a>3. è·¯ç”±ç­–ç•¥ x ç®—æ³•</h1><p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_04/04.png" alt=""></p><p>ShardingStrategyï¼Œåˆ†ç‰‡ç­–ç•¥ã€‚ç›®å‰æ”¯æŒä¸¤ç§åˆ†ç‰‡ï¼š</p><p><em>åˆ†ç‰‡èµ„æºï¼šåœ¨åˆ†åº“ç­–ç•¥é‡ŒæŒ‡çš„æ˜¯åº“ï¼Œåœ¨åˆ†è¡¨ç­–ç•¥é‡ŒæŒ‡çš„æ˜¯è¡¨ã€‚</em></p><p>ã€1ã€‘ è®¡ç®—<strong>é™æ€</strong>åˆ†ç‰‡ï¼ˆå¸¸ç”¨ï¼‰</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingStrategy.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¡ç®—é™æ€åˆ†ç‰‡.</div><div class="line">* <span class="doctag">@param</span> sqlType SQLè¯­å¥çš„ç±»å‹</div><div class="line">* <span class="doctag">@param</span> availableTargetNames æ‰€æœ‰çš„å¯ç”¨åˆ†ç‰‡èµ„æºé›†åˆ</div><div class="line">* <span class="doctag">@param</span> shardingValues åˆ†ç‰‡å€¼é›†åˆ</div><div class="line">* <span class="doctag">@return</span> åˆ†åº“åæŒ‡å‘çš„æ•°æ®æºåç§°é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doStaticSharding</span><span class="params">(<span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> Collection&lt;ShardingValue&lt;?&gt;&gt; shardingValues)</span> </span>&#123;</div><div class="line">   Collection&lt;String&gt; result = <span class="keyword">new</span> TreeSet&lt;&gt;(String.CASE_INSENSITIVE_ORDER);</div><div class="line">   <span class="keyword">if</span> (shardingValues.isEmpty()) &#123;</div><div class="line">       Preconditions.checkState(!isInsertMultiple(sqlType, availableTargetNames), <span class="string">"INSERT statement should contain sharding value."</span>); <span class="comment">// æ’å…¥ä¸èƒ½æœ‰å¤šèµ„æºå¯¹è±¡</span></div><div class="line">       result.addAll(availableTargetNames);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       result.addAll(doSharding(shardingValues, availableTargetNames));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* æ’å…¥SQL æ˜¯å¦æ’å…¥å¤šä¸ªåˆ†ç‰‡</div><div class="line">* <span class="doctag">@param</span> sqlType SQLç±»å‹</div><div class="line">* <span class="doctag">@param</span> availableTargetNames æ‰€æœ‰çš„å¯ç”¨åˆ†ç‰‡èµ„æºé›†åˆ</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isInsertMultiple</span><span class="params">(<span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> SQLType.INSERT == sqlType &amp;&amp; availableTargetNames.size() &gt; <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>æ’å…¥SQL éœ€è¦æœ‰ç‰‡é”®å€¼ï¼Œå¦åˆ™æ— æ³•åˆ¤æ–­å•ä¸ªåˆ†ç‰‡èµ„æºã€‚<em>ï¼ˆSharding-JDBC ç›®å‰ä»…æ”¯æŒå•æ¡è®°å½•æ’å…¥ï¼‰</em></li></ul><p>ã€2ã€‘è®¡ç®—<strong>åŠ¨æ€</strong>åˆ†ç‰‡</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingStrategy.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¡ç®—åŠ¨æ€åˆ†ç‰‡.</div><div class="line">* <span class="doctag">@param</span> shardingValues åˆ†ç‰‡å€¼é›†åˆ</div><div class="line">* <span class="doctag">@return</span> åˆ†åº“åæŒ‡å‘çš„åˆ†ç‰‡èµ„æºé›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doDynamicSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;ShardingValue&lt;?&gt;&gt; shardingValues)</span> </span>&#123;</div><div class="line">   Preconditions.checkState(!shardingValues.isEmpty(), <span class="string">"Dynamic table should contain sharding value."</span>); <span class="comment">// åŠ¨æ€åˆ†ç‰‡å¿…é¡»æœ‰åˆ†ç‰‡å€¼</span></div><div class="line">   Collection&lt;String&gt; availableTargetNames = Collections.emptyList();</div><div class="line">   Collection&lt;String&gt; result = <span class="keyword">new</span> TreeSet&lt;&gt;(String.CASE_INSENSITIVE_ORDER);</div><div class="line">   result.addAll(doSharding(shardingValues, availableTargetNames));</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>åŠ¨æ€åˆ†ç‰‡å¯¹åº” <code>TableRule.dynamic=true</code></li><li>åŠ¨æ€åˆ†ç‰‡å¿…é¡»æœ‰åˆ†ç‰‡å€¼</li></ul><p>ğŸ˜ˆ é—·äº†ï¼Œçœ‹èµ·æ¥ä¸¤è€…æ²¡å•¥åŒºåˆ«ï¼Ÿç­”æ¡ˆåœ¨<strong>åˆ†ç‰‡ç®—æ³•</strong>ä¸Šã€‚æˆ‘ä»¬å…ˆçœ‹ <code>#doSharding()</code> æ–¹æ³•çš„å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingStrategy.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¡ç®—åˆ†ç‰‡</div><div class="line">* <span class="doctag">@param</span> shardingValues åˆ†ç‰‡å€¼é›†åˆ</div><div class="line">* <span class="doctag">@param</span> availableTargetNames æ‰€æœ‰çš„å¯ç”¨åˆ†ç‰‡èµ„æºé›†åˆ</div><div class="line">* <span class="doctag">@return</span> åˆ†åº“åæŒ‡å‘çš„åˆ†ç‰‡èµ„æºé›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;String&gt; <span class="title">doSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;ShardingValue&lt;?&gt;&gt; shardingValues, <span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ— ç‰‡é”®</span></div><div class="line">   <span class="keyword">if</span> (shardingAlgorithm <span class="keyword">instanceof</span> NoneKeyShardingAlgorithm) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.singletonList(((NoneKeyShardingAlgorithm) shardingAlgorithm).doSharding(availableTargetNames, shardingValues.iterator().next()));</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å•ç‰‡é”®</span></div><div class="line">   <span class="keyword">if</span> (shardingAlgorithm <span class="keyword">instanceof</span> SingleKeyShardingAlgorithm) &#123;</div><div class="line">       SingleKeyShardingAlgorithm&lt;?&gt; singleKeyShardingAlgorithm = (SingleKeyShardingAlgorithm&lt;?&gt;) shardingAlgorithm;</div><div class="line">       ShardingValue shardingValue = shardingValues.iterator().next();</div><div class="line">       <span class="keyword">switch</span> (shardingValue.getType()) &#123;</div><div class="line">           <span class="keyword">case</span> SINGLE:</div><div class="line">               <span class="keyword">return</span> Collections.singletonList(singleKeyShardingAlgorithm.doEqualSharding(availableTargetNames, shardingValue));</div><div class="line">           <span class="keyword">case</span> LIST:</div><div class="line">               <span class="keyword">return</span> singleKeyShardingAlgorithm.doInSharding(availableTargetNames, shardingValue);</div><div class="line">           <span class="keyword">case</span> RANGE:</div><div class="line">               <span class="keyword">return</span> singleKeyShardingAlgorithm.doBetweenSharding(availableTargetNames, shardingValue);</div><div class="line">           <span class="keyword">default</span>:</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(shardingValue.getType().getClass().getName());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å¤šç‰‡é”®</span></div><div class="line">   <span class="keyword">if</span> (shardingAlgorithm <span class="keyword">instanceof</span> MultipleKeysShardingAlgorithm) &#123;</div><div class="line">       <span class="keyword">return</span> ((MultipleKeysShardingAlgorithm) shardingAlgorithm).doSharding(availableTargetNames, shardingValues);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(shardingAlgorithm.getClass().getName());</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>æ— åˆ†ç‰‡é”®ç®—æ³•ï¼šå¯¹åº” NoneKeyShardingAlgorithm åˆ†ç‰‡ç®—æ³•æ¥å£ã€‚</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NoneKeyShardingAlgorithm</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;?&gt;&gt; <span class="keyword">extends</span> <span class="title">ShardingAlgorithm</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">doSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, ShardingValue&lt;T&gt; shardingValue)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å•ç‰‡é”®ç®—æ³•ï¼šå¯¹åº” SingleKeyShardingAlgorithm åˆ†ç‰‡ç®—æ³•æ¥å£ã€‚</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SingleKeyShardingAlgorithm</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;?&gt;&gt; <span class="keyword">extends</span> <span class="title">ShardingAlgorithm</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">doEqualSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, ShardingValue&lt;T&gt; shardingValue)</span></span>;</div><div class="line">    <span class="function">Collection&lt;String&gt; <span class="title">doInSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, ShardingValue&lt;T&gt; shardingValue)</span></span>;</div><div class="line">    <span class="function">Collection&lt;String&gt; <span class="title">doBetweenSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, ShardingValue&lt;T&gt; shardingValue)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left">ShardingValueType</th><th style="text-align:left">SQL æ“ä½œç¬¦</th><th style="text-align:left">æ¥å£æ–¹æ³•</th></tr></thead><tbody><tr><td style="text-align:left">SINGLE</td><td style="text-align:left">=</td><td style="text-align:left"><code>#doEqualSharding()</code></td></tr><tr><td style="text-align:left">LIST</td><td style="text-align:left">IN</td><td style="text-align:left"><code>#doInSharding()</code></td></tr><tr><td style="text-align:left">RANGE</td><td style="text-align:left">BETWEEN</td><td style="text-align:left"><code>#doBetweenSharding()</code></td></tr></tbody></table><ul><li>å¤šç‰‡é”®ç®—æ³•ï¼šå¯¹åº” MultipleKeysShardingAlgorithm åˆ†ç‰‡ç®—æ³•æ¥å£ã€‚</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MultipleKeysShardingAlgorithm</span> <span class="keyword">extends</span> <span class="title">ShardingAlgorithm</span> </span>&#123;</div><div class="line">    <span class="function">Collection&lt;String&gt; <span class="title">doSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, Collection&lt;ShardingValue&lt;?&gt;&gt; shardingValues)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>åˆ†ç‰‡ç®—æ³•ç±»ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/02.png" alt=""></p><p>æ¥çœ‹çœ‹ Sharding-JDBC å®ç°çš„æ— éœ€åˆ†åº“çš„åˆ†ç‰‡ç®—æ³• NoneDatabaseShardingAlgorithm (NoneTableShardingAlgorithm åŸºæœ¬ä¸€æ¨¡ä¸€æ ·)ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NoneDatabaseShardingAlgorithm</span> <span class="keyword">implements</span> <span class="title">SingleKeyDatabaseShardingAlgorithm</span>&lt;<span class="title">String</span>&gt;, <span class="title">MultipleKeysDatabaseShardingAlgorithm</span> </span>&#123; </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> Collection&lt;ShardingValue&lt;?&gt;&gt; shardingValues)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> availableTargetNames;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doEqualSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> ShardingValue&lt;String&gt; shardingValue)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> availableTargetNames.isEmpty() ? <span class="keyword">null</span> : availableTargetNames.iterator().next();</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doInSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> ShardingValue&lt;String&gt; shardingValue)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> availableTargetNames;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doBetweenSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> ShardingValue&lt;String&gt; shardingValue)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> availableTargetNames;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>ä¸€å®šè¦æ³¨æ„ï¼ŒNoneXXXXShardingAlgorithm åªé€‚ç”¨äºæ— åˆ†åº“/è¡¨çš„éœ€æ±‚ï¼Œå¦åˆ™ä¼šæ˜¯é”™è¯¯çš„è·¯ç”±ç»“æœã€‚</strong>ä¾‹å¦‚ï¼Œ<code>#doEqualSharding()</code> è¿”å›çš„æ˜¯ç¬¬ä¸€ä¸ªåˆ†ç‰‡èµ„æºã€‚</li></ul><hr><p>å†æ¥çœ‹æµ‹è¯•ç›®å½•ä¸‹å®ç°çš„<strong>ä½™æ•°åŸºå¶åˆ†è¡¨ç®—æ³•</strong> ModuloTableShardingAlgorithm çš„å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// com.dangdang.ddframe.rdb.integrate.fixture.ModuloTableShardingAlgorithm.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ModuloTableShardingAlgorithm</span> <span class="keyword">implements</span> <span class="title">SingleKeyTableShardingAlgorithm</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doEqualSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; tableNames, <span class="keyword">final</span> ShardingValue&lt;Integer&gt; shardingValue)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (String each : tableNames) &#123;</div><div class="line">            <span class="keyword">if</span> (each.endsWith(shardingValue.getValue() % <span class="number">2</span> + <span class="string">""</span>)) &#123;</div><div class="line">                <span class="keyword">return</span> each;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doInSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; tableNames, <span class="keyword">final</span> ShardingValue&lt;Integer&gt; shardingValue)</span> </span>&#123;</div><div class="line">        Collection&lt;String&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(tableNames.size());</div><div class="line">        <span class="keyword">for</span> (Integer value : shardingValue.getValues()) &#123;</div><div class="line">            <span class="keyword">for</span> (String tableName : tableNames) &#123;</div><div class="line">                <span class="keyword">if</span> (tableName.endsWith(value % <span class="number">2</span> + <span class="string">""</span>)) &#123;</div><div class="line">                    result.add(tableName);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doBetweenSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; tableNames, <span class="keyword">final</span> ShardingValue&lt;Integer&gt; shardingValue)</span> </span>&#123;</div><div class="line">        Collection&lt;String&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(tableNames.size());</div><div class="line">        Range&lt;Integer&gt; range = shardingValue.getValueRange();</div><div class="line">        <span class="keyword">for</span> (Integer i = range.lowerEndpoint(); i &lt;= range.upperEndpoint(); i++) &#123;</div><div class="line">            <span class="keyword">for</span> (String each : tableNames) &#123;</div><div class="line">                <span class="keyword">if</span> (each.endsWith(i % <span class="number">2</span> + <span class="string">""</span>)) &#123;</div><div class="line">                    result.add(each);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>æˆ‘ä»¬å¯ä»¥å‚è€ƒè¿™ä¸ªä¾‹å­ç¼–å†™è‡ªå·±çš„åˆ†ç‰‡ç®—å“Ÿ ğŸ‘¼ã€‚</li><li>å¤šç‰‡é”®åˆ†åº“ç®—æ³•æ¥å£å®ç°ä¾‹å­ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/d6ac50704f5e45beeeded09a4f0b160c7320b993/sharding-jdbc-core/src/test/java/com/dangdang/ddframe/rdb/integrate/fixture/MultipleKeysModuloDatabaseShardingAlgorithm.java" rel="external nofollow noopener noreferrer" target="_blank">MultipleKeysModuloDatabaseShardingAlgorithm.java</a></li></ul><hr><p>ğŸ˜ˆ æ¥çœ‹çœ‹<strong>åŠ¨æ€è®¡ç®—åˆ†ç‰‡</strong>éœ€è¦æ€ä¹ˆå®ç°åˆ†ç‰‡ç®—æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// com.dangdang.ddframe.rdb.integrate.fixture.SingleKeyDynamicModuloTableShardingAlgorithm.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleKeyDynamicModuloTableShardingAlgorithm</span> <span class="keyword">implements</span> <span class="title">SingleKeyTableShardingAlgorithm</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * è¡¨å‰ç¼€</div><div class="line">    */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String tablePrefix;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doEqualSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> ShardingValue&lt;Integer&gt; shardingValue)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> tablePrefix + shardingValue.getValue() % <span class="number">10</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doInSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> ShardingValue&lt;Integer&gt; shardingValue)</span> </span>&#123;</div><div class="line">        Collection&lt;String&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(shardingValue.getValues().size());</div><div class="line">        <span class="keyword">for</span> (Integer value : shardingValue.getValues()) &#123;</div><div class="line">            result.add(tablePrefix + value % <span class="number">10</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doBetweenSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> ShardingValue&lt;Integer&gt; shardingValue)</span> </span>&#123;</div><div class="line">        Collection&lt;String&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(availableTargetNames.size());</div><div class="line">        Range&lt;Integer&gt; range = shardingValue.getValueRange();</div><div class="line">        <span class="keyword">for</span> (Integer i = range.lowerEndpoint(); i &lt;= range.upperEndpoint(); i++) &#123;</div><div class="line">            result.add(tablePrefix + i % <span class="number">10</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>éªšå¹´ï¼Œæ˜¯ä¸æ˜¯æ˜ç™½äº†ä¸€äº›ï¼Ÿ<strong>åŠ¨æ€è¡¨</strong>æ— éœ€æŠŠçœŸå®è¡¨é…ç½®åˆ° TableRuleï¼Œè€Œæ˜¯é€šè¿‡<strong>åˆ†ç‰‡ç®—æ³•</strong>è®¡ç®—å‡º<strong>çœŸå®è¡¨</strong>ã€‚</li></ul><h1 id="4-SQL-è·¯ç”±"><a href="#4-SQL-è·¯ç”±" class="headerlink" title="4. SQL è·¯ç”±"></a>4. SQL è·¯ç”±</h1><p>SQLRouterï¼ŒSQL è·¯ç”±å™¨æ¥å£ï¼Œå…±æœ‰ä¸¤ç§å®ç°ï¼š</p><ul><li>DatabaseHintSQLRouterï¼šé€šè¿‡æç¤ºä¸”ä»…è·¯ç”±è‡³æ•°æ®åº“çš„SQLè·¯ç”±å™¨</li><li>ParsingSQLRouterï¼šéœ€è¦è§£æçš„SQLè·¯ç”±å™¨</li></ul><p>å®ƒä»¬å®ç° <code>#parse()</code>è¿›è¡Œ<strong>SQLè§£æ</strong>ï¼Œ<code>#route()</code>è¿›è¡Œ<strong>SQLè·¯ç”±</strong>ã€‚</p><p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/03.png" alt=""></p><hr><p>RoutingEngineï¼Œè·¯ç”±å¼•æ“æ¥å£ï¼Œå…±æœ‰å››ç§å®ç°ï¼š</p><ul><li>DatabaseHintRoutingEngineï¼šåŸºäºæ•°æ®åº“æç¤ºçš„è·¯ç”±å¼•æ“</li><li>SimpleRoutingEngineï¼šç®€å•è·¯ç”±å¼•æ“</li><li>CartesianRoutingEngineï¼šç¬›å¡å°”ç§¯çš„åº“è¡¨è·¯ç”±</li><li>ComplexRoutingEngineï¼šæ··åˆå¤šåº“è¡¨è·¯ç”±å¼•æ“</li></ul><p><strong>ComplexRoutingEngine æ ¹æ®è·¯ç”±ç»“æœä¼šè½¬åŒ–æˆ SimpleRoutingEngine æˆ– ComplexRoutingEngine</strong>ã€‚ä¸‹æ–‡ä¼šçœ‹ç›¸åº”æºç ã€‚</p><p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/04.png" alt=""></p><hr><p>è·¯ç”±ç»“æœæœ‰ä¸¤ç§ï¼š</p><ul><li>RoutingResultï¼šç®€å•è·¯ç”±ç»“æœ</li><li>CartesianRoutingResultï¼šç¬›å¡å°”ç§¯è·¯ç”±ç»“æœ</li></ul><p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/05.png" alt=""></p><p>ä»å›¾ä¸­ï¼Œæˆ‘ä»¬å·²ç»èƒ½å¤§æ¦‚çœ‹åˆ°ä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œæ›´å…·ä½“çš„ä¸‹æ–‡éšæºç ä¸€èµ·åˆ†äº«ã€‚</p><p>ğŸ˜ˆ SQLRouteResult å’Œ RoutingResult æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p><ul><li>SQLRouteResultï¼š<strong>æ•´ä¸ªSQLè·¯ç”±</strong>è¿”å›çš„è·¯ç”±ç»“æœ</li><li>RoutingResultï¼š<strong>RoutingEngine</strong>è¿”å›è·¯ç”±ç»“æœ</li></ul><p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/06.png" alt=""></p><hr><p>ä¸€ä¸‹å­çœ‹åˆ°è¿™ä¹ˆå¤š<strong>â€œå¯¹è±¡â€</strong>ï¼Œå¯èƒ½æœ‰ç‚¹<strong>ç´§å¼ </strong>ã€‚ä¸è¦ç´§å¼ ï¼Œæˆ‘ä»¬ä¸€èµ·åœ¨æ•´ç†ä¸‹ã€‚</p><table><thead><tr><th style="text-align:left">è·¯ç”±å™¨</th><th style="text-align:left">è·¯ç”±å¼•æ“</th><th style="text-align:left">è·¯ç”±ç»“æœ</th></tr></thead><tbody><tr><td style="text-align:left">DatabaseHintSQLRouter</td><td style="text-align:left">DatabaseHintRoutingEngine</td><td style="text-align:left">RoutingResult</td></tr><tr><td style="text-align:left">ParsingSQLRouter</td><td style="text-align:left">SimpleRoutingEngine</td><td style="text-align:left">RoutingResult</td></tr><tr><td style="text-align:left">ParsingSQLRouter</td><td style="text-align:left">CartesianRoutingEngine</td><td style="text-align:left">CartesianRoutingResult</td></tr></tbody></table><p>ğŸ˜ˆ é€—æ¯”åšä¸»ç»™å¤§å®¶è§£å†³äº†<strong>â€œå¯¹è±¡â€</strong>ï¼Œæ˜¯ä¸æ˜¯åº”è¯¥<strong>åˆ†äº«æœ‹å‹åœˆ</strong>ã€‚</p><h1 id="5-DatabaseHintSQLRouter"><a href="#5-DatabaseHintSQLRouter" class="headerlink" title="5. DatabaseHintSQLRouter"></a>5. DatabaseHintSQLRouter</h1><p>DatabaseHintSQLRouterï¼ŒåŸºäºæ•°æ®åº“æç¤ºçš„è·¯ç”±å¼•æ“ã€‚è·¯ç”±å™¨å·¥å‚ SQLRouterFactory åˆ›å»ºè·¯ç”±å™¨æ—¶ï¼Œåˆ¤æ–­åˆ°ä½¿ç”¨æ•°æ®åº“æç¤º( Hint ) æ—¶ï¼Œåˆ›å»º DatabaseHintSQLRouterã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DatabaseHintRoutingEngine.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SQLRouter <span class="title">createSQLRouter</span><span class="params">(<span class="keyword">final</span> ShardingContext shardingContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> HintManagerHolder.isDatabaseShardingOnly() ? <span class="keyword">new</span> DatabaseHintSQLRouter(shardingContext) : <span class="keyword">new</span> ParsingSQLRouter(shardingContext);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>å…ˆæ¥çœ‹ä¸‹ HintManagerHolderã€HintManager <strong>éƒ¨åˆ†ç›¸å…³</strong>çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// HintManagerHolder.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HintManagerHolder</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * HintManager çº¿ç¨‹å˜é‡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;HintManager&gt; HINT_MANAGER_HOLDER = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ¤æ–­æ˜¯å¦å½“å‰åªåˆ†åº“.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span> æ˜¯å¦å½“å‰åªåˆ†åº“.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isDatabaseShardingOnly</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span> != HINT_MANAGER_HOLDER.get() &amp;&amp; HINT_MANAGER_HOLDER.get().isDatabaseShardingOnly();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ¸…ç†çº¿ç´¢åˆ†ç‰‡ç®¡ç†å™¨çš„æœ¬åœ°çº¿ç¨‹æŒæœ‰è€….</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</div><div class="line">        HINT_MANAGER_HOLDER.remove();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// HintManager.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HintManager</span> <span class="keyword">implements</span> <span class="title">AutoCloseable</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åº“åˆ†ç‰‡å€¼é›†åˆ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ShardingKey, ShardingValue&lt;?&gt;&gt; databaseShardingValues = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åªåšåº“åˆ†ç‰‡</div><div class="line">     * &#123;<span class="doctag">@link</span> DatabaseHintRoutingEngine&#125;</div><div class="line">     */</div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> databaseShardingOnly;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–çº¿ç´¢åˆ†ç‰‡ç®¡ç†å™¨å®ä¾‹.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span> çº¿ç´¢åˆ†ç‰‡ç®¡ç†å™¨å®ä¾‹</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HintManager <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        HintManager result = <span class="keyword">new</span> HintManager();</div><div class="line">        HintManagerHolder.setHintManager(result);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è®¾ç½®åˆ†åº“åˆ†ç‰‡å€¼.</div><div class="line">     * </div><div class="line">     * &lt;p&gt;åˆ†ç‰‡æ“ä½œç¬¦ä¸ºç­‰å·.è¯¥æ–¹æ³•é€‚ç”¨äºåªåˆ†åº“çš„åœºæ™¯&lt;/p&gt;</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> value åˆ†ç‰‡å€¼</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDatabaseShardingValue</span><span class="params">(<span class="keyword">final</span> Comparable&lt;?&gt; value)</span> </span>&#123;</div><div class="line">        databaseShardingOnly = <span class="keyword">true</span>;</div><div class="line">        addDatabaseShardingValue(HintManagerHolder.DB_TABLE_NAME, HintManagerHolder.DB_COLUMN_NAME, value);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>é‚£ä¹ˆå¦‚æœè¦ä½¿ç”¨ DatabaseHintSQLRouterï¼Œæˆ‘ä»¬åªéœ€è¦ <code>HintManager.getInstance().setDatabaseShardingValue(åº“åˆ†ç‰‡å€¼)</code> å³å¯ã€‚è¿™é‡Œæœ‰ä¸¤ç‚¹è¦æ³¨æ„ä¸‹ï¼š</p><ul><li><code>HintManager#getInstance()</code>ï¼Œæ¯æ¬¡è·å–åˆ°çš„éƒ½æ˜¯<strong>æ–°</strong>çš„ HintManagerï¼Œå¤šæ¬¡èµ‹å€¼éœ€è¦å°å¿ƒã€‚</li><li><code>HintManager#close()</code>ï¼Œä½¿ç”¨å®Œéœ€è¦å»æ¸…ç†ï¼Œé¿å…ä¸‹ä¸ªè¯·æ±‚è¯»åˆ°é—æ¼çš„çº¿ç¨‹å˜é‡ã€‚</li></ul><hr><p>çœ‹çœ‹ DatabaseHintSQLRouter çš„å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DatabaseHintSQLRouter.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLStatement <span class="title">parse</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> <span class="keyword">int</span> parametersSize)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> SQLJudgeEngine(logicSQL).judge(); <span class="comment">// åªè§£æ SQL ç±»å‹</span></div><div class="line">&#125;  </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="comment">// TODO insertçš„SQLä»ç„¶éœ€è¦è§£æè‡ªå¢ä¸»é”®</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLRouteResult <span class="title">route</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   Context context = MetricsContext.start(<span class="string">"Route SQL"</span>);</div><div class="line">   SQLRouteResult result = <span class="keyword">new</span> SQLRouteResult(sqlStatement);</div><div class="line">   <span class="comment">// è·¯ç”±</span></div><div class="line">   RoutingResult routingResult = <span class="keyword">new</span> DatabaseHintRoutingEngine(shardingRule.getDataSourceRule(), shardingRule.getDatabaseShardingStrategy(), sqlStatement.getType())</div><div class="line">           .route();</div><div class="line">   <span class="comment">// SQLæœ€å°æ‰§è¡Œå•å…ƒ</span></div><div class="line">   <span class="keyword">for</span> (TableUnit each : routingResult.getTableUnits().getTableUnits()) &#123;</div><div class="line">       result.getExecutionUnits().add(<span class="keyword">new</span> SQLExecutionUnit(each.getDataSourceName(), logicSQL));</div><div class="line">   &#125;</div><div class="line">   MetricsContext.stop(context);</div><div class="line">   <span class="keyword">if</span> (showSQL) &#123;</div><div class="line">       SQLLogger.logSQL(logicSQL, sqlStatement, result.getExecutionUnits(), parameters);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>#parse()</code> åªè§£æäº† SQL ç±»å‹ï¼Œå³ SELECT / UPDATE / DELETE / INSERT ã€‚</li><li><strong>ä½¿ç”¨çš„åˆ†åº“ç­–ç•¥æ¥è‡ª ShardingRuleï¼Œä¸æ˜¯ TableRuleï¼Œè¿™ä¸ªä¸€å®šè¦ç•™å¿ƒã€‚</strong>â“å› ä¸º SQL æœªè§£æ<strong>è¡¨å</strong>ã€‚å› æ­¤ï¼Œå³ä½¿åœ¨ TableRule è®¾ç½®äº† <code>actualTables</code> å±æ€§ä¹Ÿæ˜¯æ²¡æœ‰æ•ˆæœçš„ã€‚</li><li>ç›®å‰ä¸æ”¯æŒ Sharding-JDBC çš„ä¸»é”®è‡ªå¢ã€‚â“å› ä¸º SQL æœªè§£æ<strong>è‡ªå¢ä¸»é”®</strong>ã€‚ä»ä»£ç ä¸Šçš„<code>TODO</code>åº”è¯¥ä¼šæ”¯æŒã€‚</li><li><code>HintManager.getInstance().setDatabaseShardingValue(åº“åˆ†ç‰‡å€¼)</code> è®¾ç½®çš„åº“åˆ†ç‰‡å€¼ä½¿ç”¨çš„æ˜¯ EQUALSï¼Œå› è€Œåˆ†åº“ç­–ç•¥è®¡ç®—å‡ºæ¥çš„åªæœ‰<strong>ä¸€ä¸ªåº“åˆ†ç‰‡</strong>ï¼Œå³ TableUnit åªæœ‰ä¸€ä¸ªï¼ŒSQLExecutionUnit åªæœ‰ä¸€ä¸ªã€‚</li></ul><hr><p>çœ‹çœ‹ DatabaseHintSQLRouter çš„å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DatabaseHintRoutingEngine.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> RoutingResult <span class="title">route</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ä» Hint è·å¾— åˆ†ç‰‡é”®å€¼</span></div><div class="line">   Optional&lt;ShardingValue&lt;?&gt;&gt; shardingValue = HintManagerHolder.getDatabaseShardingValue(<span class="keyword">new</span> ShardingKey(HintManagerHolder.DB_TABLE_NAME, HintManagerHolder.DB_COLUMN_NAME));</div><div class="line">   Preconditions.checkState(shardingValue.isPresent());</div><div class="line">   log.debug(<span class="string">"Before database sharding only db:&#123;&#125; sharding values: &#123;&#125;"</span>, dataSourceRule.getDataSourceNames(), shardingValue.get());</div><div class="line">   <span class="comment">// è·¯ç”±ã€‚è¡¨åˆ†ç‰‡è§„åˆ™ä½¿ç”¨çš„æ˜¯ ShardingRule é‡Œçš„ã€‚å› ä¸ºæ²¡ SQL è§£æã€‚</span></div><div class="line">   Collection&lt;String&gt; routingDataSources = databaseShardingStrategy.doStaticSharding(sqlType, dataSourceRule.getDataSourceNames(), Collections.&lt;ShardingValue&lt;?&gt;&gt;singleton(shardingValue.get()));</div><div class="line">   Preconditions.checkState(!routingDataSources.isEmpty(), <span class="string">"no database route info"</span>);</div><div class="line">   log.debug(<span class="string">"After database sharding only result: &#123;&#125;"</span>, routingDataSources);</div><div class="line">   <span class="comment">// è·¯ç”±ç»“æœ</span></div><div class="line">   RoutingResult result = <span class="keyword">new</span> RoutingResult();</div><div class="line">   <span class="keyword">for</span> (String each : routingDataSources) &#123;</div><div class="line">       result.getTableUnits().getTableUnits().add(<span class="keyword">new</span> TableUnit(each, <span class="string">""</span>, <span class="string">""</span>));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>åª</strong>è°ƒç”¨ <code>databaseShardingStrategy.doStaticSharding()</code> æ–¹æ³•è®¡ç®—<strong>åº“</strong>åˆ†ç‰‡ã€‚</li><li><code>new TableUnit(each, &quot;&quot;, &quot;&quot;)</code> çš„ <code>logicTableName</code>ï¼Œ<code>actualTableName</code> éƒ½æ˜¯ç©ºä¸²ï¼Œç›¸ä¿¡åŸå› ä½ å·²ç»çŸ¥é“ã€‚</li></ul><h1 id="6-ParsingSQLRouter"><a href="#6-ParsingSQLRouter" class="headerlink" title="6. ParsingSQLRouter"></a>6. ParsingSQLRouter</h1><p>ParsingSQLRouterï¼Œéœ€è¦è§£æçš„SQLè·¯ç”±å™¨ã€‚</p><p>ParsingSQLRouter ä½¿ç”¨ SQLParsingEngine <strong>è§£æSQL</strong>ã€‚å¯¹<strong>SQLè§£æ</strong>æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹çœ‹æ‹™ä½œ<a href="http://www.yunai.me/categories/Sharding-JDBC/?mp">ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æã€‹</a>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLStatement <span class="title">parse</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> <span class="keyword">int</span> parametersSize)</span> </span>&#123;</div><div class="line">   SQLParsingEngine parsingEngine = <span class="keyword">new</span> SQLParsingEngine(databaseType, logicSQL, shardingRule);</div><div class="line">   Context context = MetricsContext.start(<span class="string">"Parse SQL"</span>);</div><div class="line">   SQLStatement result = parsingEngine.parse();</div><div class="line">   <span class="keyword">if</span> (result <span class="keyword">instanceof</span> InsertStatement) &#123;</div><div class="line">       ((InsertStatement) result).appendGenerateKeyToken(shardingRule, parametersSize);</div><div class="line">   &#125;</div><div class="line">   MetricsContext.stop(context);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>#appendGenerateKeyToken()</code> ä¼šåœ¨<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL æ”¹å†™ã€‹</a>åˆ†äº«</li></ul><hr><p>ParsingSQLRouter åœ¨è·¯ç”±æ—¶ï¼Œä¼šæ ¹æ®<strong>è¡¨æƒ…å†µ</strong>ä½¿ç”¨ SimpleRoutingEngine æˆ– CartesianRoutingEngine è¿›è¡Œè·¯ç”±ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> RoutingResult <span class="title">route</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   Collection&lt;String&gt; tableNames = sqlStatement.getTables().getTableNames();</div><div class="line">   RoutingEngine routingEngine;</div><div class="line">   <span class="keyword">if</span> (<span class="number">1</span> == tableNames.size() || shardingRule.isAllBindingTables(tableNames)) &#123;</div><div class="line">       routingEngine = <span class="keyword">new</span> SimpleRoutingEngine(shardingRule, parameters, tableNames.iterator().next(), sqlStatement);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="comment">// TODO å¯é…ç½®æ˜¯å¦æ‰§è¡Œç¬›å¡å°”ç§¯</span></div><div class="line">       routingEngine = <span class="keyword">new</span> ComplexRoutingEngine(shardingRule, parameters, tableNames, sqlStatement);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> routingEngine.route();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å½“åªè¿›è¡Œ<strong>ä¸€å¼ è¡¨</strong>æˆ–è€…<strong>å¤šè¡¨äº’ä¸ºBindingTableå…³ç³»</strong>æ—¶ï¼Œä½¿ç”¨ SimpleRoutingEngine ç®€å•è·¯ç”±å¼•æ“ã€‚<strong>å¤šè¡¨äº’ä¸ºBindingTableå…³ç³»</strong>æ—¶ï¼Œæ¯å¼ è¡¨çš„è·¯ç”±ç»“æœæ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥åªè¦è®¡ç®—ç¬¬ä¸€å¼ è¡¨çš„åˆ†ç‰‡å³å¯ã€‚</li><li><code>tableNames.iterator().next()</code> æ³¨æ„ä¸‹ï¼Œ<code>tableNames</code> å˜é‡æ˜¯ <code>new TreeMap&lt;&gt;(String.CASE_INSENSITIVE_ORDER)</code>ã€‚æ‰€ä»¥ <code>SELECT * FROM t_order o join t_order_item i ON o.order_id = i.order_id</code> å³ä½¿ <code>t_order_item</code> æ’åœ¨ <code>t_order</code> å‰é¢ï¼Œ<code>tableNames.iterator().next()</code> è¿”å›çš„æ˜¯ <code>t_order</code>ã€‚å½“ <code>t_order</code> å’Œ <code>t_order_item</code> ä¸º <strong>BindingTableå…³ç³»</strong> æ—¶ï¼Œè®¡ç®—çš„æ˜¯ <code>t_order</code> è·¯ç”±åˆ†ç‰‡ã€‚</li><li>BindingTableå…³ç³»åœ¨ ShardingRule çš„ <code>tableRules</code> é…ç½®ã€‚é…ç½®è¯¥å…³ç³» TableRule æœ‰å¦‚ä¸‹éœ€è¦éµå®ˆçš„è§„åˆ™ï¼š<ul><li>åˆ†ç‰‡ç­–ç•¥ä¸ç®—æ³•ç›¸åŒ</li><li>æ•°æ®æºé…ç½®å¯¹è±¡ç›¸åŒ</li><li>çœŸå®è¡¨<strong>æ•°é‡</strong>ç›¸åŒ</li></ul></li></ul><p><strong>ä¸¾ä¸ªä¾‹å­</strong>ï¼š</p><ul><li>SQL ï¼š<code>SELECT * FROM t_order o join t_order_item i ON o.order_id = i.order_id</code></li><li>åˆ†åº“åˆ†è¡¨æƒ…å†µï¼š</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">multi_db_multi_table_01</div><div class="line">  â”œâ”€â”€ t_order_0                        â”œâ”€â”€ t_order_item_01</div><div class="line">  â””â”€â”€ t_order_1                        â”œâ”€â”€ t_order_item_02</div><div class="line">                                       â”œâ”€â”€ t_order_item_03</div><div class="line">                                       â”œâ”€â”€ t_order_item_04</div><div class="line">multi_db_multi_table_02</div><div class="line">  â”œâ”€â”€ t_order_0                        â”œâ”€â”€ t_order_item_01</div><div class="line">  â””â”€â”€ t_order_1                        â”œâ”€â”€ t_order_item_02</div><div class="line">                                       â”œâ”€â”€ t_order_item_03</div><div class="line">                                       â”œâ”€â”€ t_order_item_04</div></pre></td></tr></table></figure><p>æœ€ç»ˆæ‰§è¡Œçš„SQLå¦‚ä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order_item_01 i <span class="keyword">JOIN</span> t_order_01 o <span class="keyword">ON</span> o.order_id = i.order_id </div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order_item_01 i <span class="keyword">JOIN</span> t_order_01 o <span class="keyword">ON</span> o.order_id = i.order_id </div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order_item_02 i <span class="keyword">JOIN</span> t_order_02 o <span class="keyword">ON</span> o.order_id = i.order_id</div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order_item_02 i <span class="keyword">JOIN</span> t_order_02 o <span class="keyword">ON</span> o.order_id = i.order_id</div></pre></td></tr></table></figure><ul><li><code>t_order_item_03</code>ã€<code>t_order_item_04</code> æ— æ³•è¢«æŸ¥è¯¢åˆ°ã€‚</li></ul><p>ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹ <code>#isAllBindingTables()</code> å¦‚ä½•å®ç°<strong>å¤šè¡¨äº’ä¸ºBindingTableå…³ç³»</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingRule.java</span></div><div class="line"><span class="comment">// è°ƒç”¨é¡ºåº #isAllBindingTables()=&gt;#filterAllBindingTables()=&gt;#findBindingTableRule()=&gt;#findBindingTableRule()</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* åˆ¤æ–­é€»è¾‘è¡¨åç§°é›†åˆæ˜¯å¦å…¨éƒ¨å±äºBindingè¡¨.</div><div class="line">* <span class="doctag">@param</span> logicTables é€»è¾‘è¡¨åç§°é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAllBindingTables</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; logicTables)</span> </span>&#123;</div><div class="line">   Collection&lt;String&gt; bindingTables = filterAllBindingTables(logicTables);</div><div class="line">   <span class="keyword">return</span> !bindingTables.isEmpty() &amp;&amp; bindingTables.containsAll(logicTables);</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è¿‡æ»¤å‡ºæ‰€æœ‰çš„Bindingè¡¨åç§°.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">filterAllBindingTables</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; logicTables)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (logicTables.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   Optional&lt;BindingTableRule&gt; bindingTableRule = findBindingTableRule(logicTables);</div><div class="line">   <span class="keyword">if</span> (!bindingTableRule.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// äº¤é›†</span></div><div class="line">   Collection&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(bindingTableRule.get().getAllLogicTables());</div><div class="line">   result.retainAll(logicTables);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—åŒ…å«&lt;strong&gt;ä»»ä¸€&lt;/strong&gt;åœ¨é€»è¾‘è¡¨åç§°é›†åˆçš„bindingè¡¨é…ç½®çš„é€»è¾‘è¡¨åç§°é›†åˆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Optional&lt;BindingTableRule&gt; <span class="title">findBindingTableRule</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; logicTables)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (String each : logicTables) &#123;</div><div class="line">       Optional&lt;BindingTableRule&gt; result = findBindingTableRule(each);</div><div class="line">       <span class="keyword">if</span> (result.isPresent()) &#123;</div><div class="line">           <span class="keyword">return</span> result;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> Optional.absent();</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* æ ¹æ®é€»è¾‘è¡¨åç§°è·å–bindingè¡¨é…ç½®çš„é€»è¾‘è¡¨åç§°é›†åˆ.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Optional&lt;BindingTableRule&gt; <span class="title">findBindingTableRule</span><span class="params">(<span class="keyword">final</span> String logicTable)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (BindingTableRule each : bindingTableRules) &#123;</div><div class="line">       <span class="keyword">if</span> (each.hasLogicTable(logicTable)) &#123;</div><div class="line">           <span class="keyword">return</span> Optional.of(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> Optional.absent();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>é€»è¾‘çœ‹èµ·æ¥æ¯”è¾ƒé•¿ï¼Œç›®çš„æ˜¯æ‰¾åˆ°ä¸€æ¡ BindingTableRule åŒ…å«<strong>æ‰€æœ‰</strong>é€»è¾‘è¡¨é›†åˆ</li><li>ä¸æ”¯æŒ<a href="https://zh.wikipedia.org/wiki/%E4%BC%A0%E9%80%92%E5%85%B3%E7%B3%BB" rel="external nofollow noopener noreferrer" target="_blank">ã€Šä¼ é€’å…³ç³»ã€‹</a>ï¼šé…ç½® BindingTableRule æ—¶ï¼Œ<strong>ç›¸åŒç»‘å®šå…³ç³»ä¸€å®šè¦é…ç½®åœ¨ä¸€æ¡</strong>ï¼Œå¿…é¡»æ˜¯ <code>[a, b, c]</code>ï¼Œè€Œä¸èƒ½æ˜¯ <code>[a, b], [b, c]</code>ã€‚</li></ul><h2 id="6-1-SimpleRoutingEngine"><a href="#6-1-SimpleRoutingEngine" class="headerlink" title="6.1 SimpleRoutingEngine"></a>6.1 SimpleRoutingEngine</h2><p>SimpleRoutingEngineï¼Œç®€å•è·¯ç”±å¼•æ“ã€‚</p><p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_06/07.png" alt=""></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SimpleRoutingEngine.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;String&gt; <span class="title">routeDataSources</span><span class="params">(<span class="keyword">final</span> TableRule tableRule)</span> </span>&#123;</div><div class="line">   DatabaseShardingStrategy strategy = shardingRule.getDatabaseShardingStrategy(tableRule);</div><div class="line">   List&lt;ShardingValue&lt;?&gt;&gt; shardingValues = HintManagerHolder.isUseShardingHint() ? getDatabaseShardingValuesFromHint(strategy.getShardingColumns())</div><div class="line">           : getShardingValues(strategy.getShardingColumns());</div><div class="line">   Collection&lt;String&gt; result = strategy.doStaticSharding(sqlStatement.getType(), tableRule.getActualDatasourceNames(), shardingValues);</div><div class="line">   Preconditions.checkState(!result.isEmpty(), <span class="string">"no database route info"</span>);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="keyword">private</span> List&lt;ShardingValue&lt;?&gt;&gt; getShardingValues(<span class="keyword">final</span> Collection&lt;String&gt; shardingColumns) &#123;</div><div class="line">   List&lt;ShardingValue&lt;?&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(shardingColumns.size());</div><div class="line">   <span class="keyword">for</span> (String each : shardingColumns) &#123;</div><div class="line">       Optional&lt;Condition&gt; condition = sqlStatement.getConditions().find(<span class="keyword">new</span> Column(each, logicTableName));</div><div class="line">       <span class="keyword">if</span> (condition.isPresent()) &#123;</div><div class="line">           result.add(condition.get().getShardingValue(parameters));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å¯ä»¥ä½¿ç”¨ HintManager è®¾ç½®<strong>åº“</strong>åˆ†ç‰‡å€¼è¿›è¡Œ<strong>å¼ºåˆ¶è·¯ç”±</strong>ã€‚</li><li><code>#getShardingValues()</code> æˆ‘ä»¬çœ‹åˆ°äº†<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹</a>åˆ†äº«çš„ Condition å¯¹è±¡ã€‚ä¹‹å‰æˆ‘ä»¬æåˆ°è¿‡<strong>Parser åŠç†è§£SQLçš„ç›®çš„ä¹‹ä¸€æ˜¯ï¼šæç‚¼åˆ†ç‰‡ä¸Šä¸‹æ–‡</strong>ï¼Œæ­¤å¤„å³æ˜¯è¯¥ç›®çš„çš„ä½“ç°ã€‚Condition é‡Œåªæ”¾<strong>æ˜ç¡®</strong>å½±å“è·¯ç”±çš„æ¡ä»¶ï¼Œä¾‹å¦‚ï¼š<code>order_id = 1</code>, <code>order_id IN (1, 2)</code>, <code>order_id BETWEEN (1, 3)</code>ï¼Œä¸æ”¾<strong>æ— æ³•è®¡ç®—</strong>çš„æ¡ä»¶ï¼Œä¾‹å¦‚ï¼š<code>o.order_id = i.order_id</code>ã€‚è¯¥æ–¹æ³•é‡Œï¼Œä½¿ç”¨<strong>åˆ†ç‰‡é”®</strong>ä» Condition æŸ¥æ‰¾ <strong>åˆ†ç‰‡å€¼</strong>ã€‚ğŸ™‚ æ˜¯ä¸æ˜¯å¯¹ Condition çš„è®¤è¯†æ›´åŠ æ¸…æ™°ä¸€ä¸¢ä¸¢è½ã€‚</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SimpleRoutingEngine.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;String&gt; <span class="title">routeTables</span><span class="params">(<span class="keyword">final</span> TableRule tableRule, <span class="keyword">final</span> Collection&lt;String&gt; routedDataSources)</span> </span>&#123;</div><div class="line">   TableShardingStrategy strategy = shardingRule.getTableShardingStrategy(tableRule);</div><div class="line">   List&lt;ShardingValue&lt;?&gt;&gt; shardingValues = HintManagerHolder.isUseShardingHint() ? getTableShardingValuesFromHint(strategy.getShardingColumns())</div><div class="line">           : getShardingValues(strategy.getShardingColumns());</div><div class="line">   Collection&lt;String&gt; result = tableRule.isDynamic() ? strategy.doDynamicSharding(shardingValues)</div><div class="line">           : strategy.doStaticSharding(sqlStatement.getType(), tableRule.getActualTableNames(routedDataSources), shardingValues);</div><div class="line">   Preconditions.checkState(!result.isEmpty(), <span class="string">"no table route info"</span>);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å¯ä»¥ä½¿ç”¨ HintManager è®¾ç½®<strong>è¡¨</strong>åˆ†ç‰‡å€¼è¿›è¡Œ<strong>å¼ºåˆ¶è·¯ç”±</strong>ã€‚</li><li>æ ¹æ® <code>dynamic</code> å±æ€§æ¥åˆ¤æ–­è°ƒç”¨ <code>#doDynamicSharding()</code> è¿˜æ˜¯ <code>#doStaticSharding()</code> è®¡ç®—åˆ†ç‰‡ã€‚</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SimpleRoutingEngine.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> RoutingResult <span class="title">generateRoutingResult</span><span class="params">(<span class="keyword">final</span> TableRule tableRule, <span class="keyword">final</span> Collection&lt;String&gt; routedDataSources, <span class="keyword">final</span> Collection&lt;String&gt; routedTables)</span> </span>&#123;</div><div class="line">   RoutingResult result = <span class="keyword">new</span> RoutingResult();</div><div class="line">   <span class="keyword">for</span> (DataNode each : tableRule.getActualDataNodes(routedDataSources, routedTables)) &#123;</div><div class="line">       result.getTableUnits().getTableUnits().add(<span class="keyword">new</span> TableUnit(each.getDataSourceName(), logicTableName, each.getTableName()));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// TableRule.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ ¹æ®æ•°æ®æºåç§°è¿‡æ»¤è·å–çœŸå®æ•°æ®å•å…ƒ.</div><div class="line">* <span class="doctag">@param</span> targetDataSources æ•°æ®æºåç§°é›†åˆ</div><div class="line">* <span class="doctag">@param</span> targetTables çœŸå®è¡¨åç§°é›†åˆ</div><div class="line">* <span class="doctag">@return</span> çœŸå®æ•°æ®å•å…ƒ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;DataNode&gt; <span class="title">getActualDataNodes</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; targetDataSources, <span class="keyword">final</span> Collection&lt;String&gt; targetTables)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> dynamic ? getDynamicDataNodes(targetDataSources, targetTables) : getStaticDataNodes(targetDataSources, targetTables);</div><div class="line">&#125;  </div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;DataNode&gt; <span class="title">getDynamicDataNodes</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; targetDataSources, <span class="keyword">final</span> Collection&lt;String&gt; targetTables)</span> </span>&#123;</div><div class="line">   Collection&lt;DataNode&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(targetDataSources.size() * targetTables.size());</div><div class="line">   <span class="keyword">for</span> (String targetDataSource : targetDataSources) &#123;</div><div class="line">       <span class="keyword">for</span> (String targetTable : targetTables) &#123;</div><div class="line">           result.add(<span class="keyword">new</span> DataNode(targetDataSource, targetTable));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125; </div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;DataNode&gt; <span class="title">getStaticDataNodes</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; targetDataSources, <span class="keyword">final</span> Collection&lt;String&gt; targetTables)</span> </span>&#123;</div><div class="line">   Collection&lt;DataNode&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(actualTables.size());</div><div class="line">   <span class="keyword">for</span> (DataNode each : actualTables) &#123;</div><div class="line">       <span class="keyword">if</span> (targetDataSources.contains(each.getDataSourceName()) &amp;&amp; targetTables.contains(each.getTableName())) &#123;</div><div class="line">           result.add(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>åœ¨ SimpleRoutingEngine åªç”Ÿæˆäº†å½“å‰è¡¨çš„ TableUnitsã€‚å¦‚æœå­˜åœ¨<strong>ä¸å…¶äº’ä¸ºBindingTableå…³ç³»</strong>çš„è¡¨çš„ TableUnits æ€ä¹ˆè·å¾—ï¼Ÿä½ å¯ä»¥æƒ³æƒ³å™¢ï¼Œå½“ç„¶åœ¨åæ–‡<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL æ”¹å†™ã€‹</a>ä¹Ÿä¼šç»™å‡ºç­”æ¡ˆï¼Œçœ‹çœ‹å’Œä½ æƒ³çš„æ˜¯å¦ä¸€æ ·ã€‚</li></ul><h2 id="6-2-ComplexRoutingEngine"><a href="#6-2-ComplexRoutingEngine" class="headerlink" title="6.2 ComplexRoutingEngine"></a>6.2 ComplexRoutingEngine</h2><p>ComplexRoutingEngineï¼Œæ··åˆå¤šåº“è¡¨è·¯ç”±å¼•æ“ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ComplexRoutingEngine.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> RoutingResult <span class="title">route</span><span class="params">()</span> </span>&#123;</div><div class="line">   Collection&lt;RoutingResult&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(logicTables.size());</div><div class="line">   Collection&lt;String&gt; bindingTableNames = <span class="keyword">new</span> TreeSet&lt;&gt;(String.CASE_INSENSITIVE_ORDER);</div><div class="line">   <span class="comment">// è®¡ç®—æ¯ä¸ªé€»è¾‘è¡¨çš„ç®€å•è·¯ç”±åˆ†ç‰‡</span></div><div class="line">   <span class="keyword">for</span> (String each : logicTables) &#123;</div><div class="line">       Optional&lt;TableRule&gt; tableRule = shardingRule.tryFindTableRule(each);</div><div class="line">       <span class="keyword">if</span> (tableRule.isPresent()) &#123;</div><div class="line">           <span class="keyword">if</span> (!bindingTableNames.contains(each)) &#123;</div><div class="line">               result.add(<span class="keyword">new</span> SimpleRoutingEngine(shardingRule, parameters, tableRule.get().getLogicTable(), sqlStatement).route());</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// äº’ä¸º BindingTable å…³ç³»çš„è¡¨åŠ åˆ° bindingTableNames é‡Œï¼Œä¸é‡å¤è®¡ç®—åˆ†ç‰‡</span></div><div class="line">           Optional&lt;BindingTableRule&gt; bindingTableRule = shardingRule.findBindingTableRule(each);</div><div class="line">           <span class="keyword">if</span> (bindingTableRule.isPresent()) &#123;</div><div class="line">               bindingTableNames.addAll(Lists.transform(bindingTableRule.get().getTableRules(), <span class="keyword">new</span> Function&lt;TableRule, String&gt;() &#123;</div><div class="line">                   </div><div class="line">                   <span class="meta">@Override</span></div><div class="line">                   <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(<span class="keyword">final</span> TableRule input)</span> </span>&#123;</div><div class="line">                       <span class="keyword">return</span> input.getLogicTable();</div><div class="line">                   &#125;</div><div class="line">               &#125;));</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   log.trace(<span class="string">"mixed tables sharding result: &#123;&#125;"</span>, result);</div><div class="line">   <span class="keyword">if</span> (result.isEmpty()) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ShardingJdbcException(<span class="string">"Cannot find table rule and default data source with logic tables: '%s'"</span>, logicTables);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// é˜²å¾¡æ€§ç¼–ç¨‹ã€‚shardingRule#isAllBindingTables() å·²ç»è¿‡æ»¤äº†è¿™ä¸ªæƒ…å†µã€‚</span></div><div class="line">   <span class="keyword">if</span> (<span class="number">1</span> == result.size()) &#123;</div><div class="line">       <span class="keyword">return</span> result.iterator().next();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// äº¤ç»™ CartesianRoutingEngine å½¢æˆç¬›å¡å°”ç§¯ç»“æœ</span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> CartesianRoutingEngine(result).route();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ComplexRoutingEngine è®¡ç®—æ¯ä¸ªé€»è¾‘è¡¨çš„ç®€å•è·¯ç”±åˆ†ç‰‡ï¼Œè·¯ç”±ç»“æœäº¤ç»™ CartesianRoutingEngine <strong>ç»§ç»­</strong>è·¯ç”±å½¢æˆç¬›å¡å°”ç§¯ç»“æœã€‚</li></ul><p><img src="http://www.yunai.me//images/Sharding-JDBC/2017_08_06/08.png" alt=""></p><ul><li>ç”±äºç›®å‰ ComplexRoutingEngine è·¯ç”±å‰å·²ç»åˆ¤æ–­<strong>å…¨éƒ¨è¡¨äº’ä¸º BindingTable å…³ç³»</strong>ï¼Œå› è€Œä¸ä¼šå‡ºç° <code>result.size == 1</code>ï¼Œå±äºé˜²å¾¡æ€§ç¼–ç¨‹ã€‚</li><li><strong>éƒ¨åˆ†è¡¨äº’ä¸º BindingTable å…³ç³»</strong>æ—¶ï¼ŒComplexRoutingEngine ä¸é‡å¤è®¡ç®—åˆ†ç‰‡ã€‚</li></ul><h2 id="6-3-CartesianRoutingEngine"><a href="#6-3-CartesianRoutingEngine" class="headerlink" title="6.3 CartesianRoutingEngine"></a>6.3 CartesianRoutingEngine</h2><p>CartesianRoutingEngineï¼Œç¬›å¡å°”ç§¯çš„åº“è¡¨è·¯ç”±ã€‚</p><p>å®ç°é€»è¾‘ä¸Š<strong>ç›¸å¯¹</strong>å¤æ‚ï¼Œè¯·ä¿æŒè€å¿ƒå“Ÿï¼ŒğŸ˜ˆ å…¶å®ç›®çš„å°±æ˜¯å®ç°<strong>è¿è¿çœ‹</strong>çš„æ•ˆæœï¼š</p><ul><li>RoutingResult[0] <code>x</code> RoutingResult[1] â€¦â€¦ <code>x</code> RoutingResult[n- 1] <code>x</code> RoutingResult[n]</li><li><strong>åŒåº“</strong> æ‰å¯ä»¥è¿›è¡Œç¬›å¡å°”ç§¯</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CartesianRoutingEngine.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> CartesianRoutingResult <span class="title">route</span><span class="params">()</span> </span>&#123;</div><div class="line">   CartesianRoutingResult result = <span class="keyword">new</span> CartesianRoutingResult();</div><div class="line">   <span class="keyword">for</span> (Entry&lt;String, Set&lt;String&gt;&gt; entry : getDataSourceLogicTablesMap().entrySet()) &#123; <span class="comment">// Entry&lt;æ•°æ®æºï¼ˆåº“ï¼‰, Set&lt;é€»è¾‘è¡¨&gt;&gt; entry</span></div><div class="line">       <span class="comment">// è·å¾—å½“å‰æ•°æ®æºï¼ˆåº“ï¼‰çš„ è·¯ç”±è¡¨å•å…ƒåˆ†ç»„</span></div><div class="line">       List&lt;Set&lt;String&gt;&gt; actualTableGroups = getActualTableGroups(entry.getKey(), entry.getValue()); <span class="comment">// List&lt;Set&lt;çœŸå®è¡¨&gt;&gt;</span></div><div class="line">       List&lt;Set&lt;TableUnit&gt;&gt; tableUnitGroups = toTableUnitGroups(entry.getKey(), actualTableGroups);</div><div class="line">       <span class="comment">// ç¬›å¡å°”ç§¯ï¼Œå¹¶åˆå¹¶ç»“æœ</span></div><div class="line">       result.merge(entry.getKey(), getCartesianTableReferences(Sets.cartesianProduct(tableUnitGroups)));</div><div class="line">   &#125;</div><div class="line">   log.trace(<span class="string">"cartesian tables sharding result: &#123;&#125;"</span>, result);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ä¸€æ­¥ï¼Œè·å¾—<strong>åŒåº“</strong>å¯¹åº”çš„<strong>é€»è¾‘è¡¨</strong>é›†åˆï¼Œå³ <strong>Entry&lt;æ•°æ®æºï¼ˆåº“ï¼‰, Set&lt;é€»è¾‘è¡¨&gt;&gt; entry</strong>ã€‚</li><li>ç¬¬äºŒæ­¥ï¼Œéå†<strong>æ•°æ®æºï¼ˆåº“ï¼‰</strong>ï¼Œè·å¾—å½“å‰<strong>æ•°æ®æºï¼ˆåº“ï¼‰</strong>çš„<strong>è·¯ç”±è¡¨å•å…ƒåˆ†ç»„</strong>ã€‚</li><li>ç¬¬ä¸‰æ­¥ï¼Œå¯¹<strong>è·¯ç”±è¡¨å•å…ƒåˆ†ç»„</strong>è¿›è¡Œ<strong>ç¬›å¡å°”ç§¯</strong>ï¼Œå¹¶åˆå¹¶åˆ°è·¯ç”±ç»“æœã€‚</li></ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬ä¸€èµ·é€æ­¥çœ‹çœ‹ä»£ç å®ç°ã€‚</p><ul><li>SQL ï¼š<code>SELECT * FROM t_order o join t_order_item i ON o.order_id = i.order_id</code></li><li>åˆ†åº“åˆ†è¡¨æƒ…å†µï¼š</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">multi_db_multi_table_01</div><div class="line">  â”œâ”€â”€ t_order_0                        â”œâ”€â”€ t_order_item_01</div><div class="line">  â””â”€â”€ t_order_1                        â”œâ”€â”€ t_order_item_02</div><div class="line">multi_db_multi_table_02</div><div class="line">  â”œâ”€â”€ t_order_0                        â”œâ”€â”€ t_order_item_01</div><div class="line">  â””â”€â”€ t_order_1                        â”œâ”€â”€ t_order_item_02</div></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ç¬¬ä¸€æ­¥</span></div><div class="line"><span class="comment">// CartesianRoutingEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—åŒåº“å¯¹åº”çš„é€»è¾‘è¡¨é›†åˆ</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> Map&lt;String, Set&lt;String&gt;&gt; getDataSourceLogicTablesMap() &#123;</div><div class="line">   Collection&lt;String&gt; intersectionDataSources = getIntersectionDataSources();</div><div class="line">   Map&lt;String, Set&lt;String&gt;&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;(routingResults.size());</div><div class="line">   <span class="comment">// è·å¾—åŒåº“å¯¹åº”çš„é€»è¾‘è¡¨é›†åˆ</span></div><div class="line">   <span class="keyword">for</span> (RoutingResult each : routingResults) &#123;</div><div class="line">       <span class="keyword">for</span> (Entry&lt;String, Set&lt;String&gt;&gt; entry : each.getTableUnits().getDataSourceLogicTablesMap(intersectionDataSources).entrySet()) &#123; <span class="comment">// è¿‡æ»¤æ‰ä¸åœ¨æ•°æ®æºï¼ˆåº“ï¼‰äº¤é›†çš„é€»è¾‘è¡¨</span></div><div class="line">           <span class="keyword">if</span> (result.containsKey(entry.getKey())) &#123;</div><div class="line">               result.get(entry.getKey()).addAll(entry.getValue());</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               result.put(entry.getKey(), entry.getValue());</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è·å¾—æ‰€æœ‰è·¯ç”±ç»“æœé‡Œçš„æ•°æ®æºï¼ˆåº“ï¼‰äº¤é›†</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;String&gt; <span class="title">getIntersectionDataSources</span><span class="params">()</span> </span>&#123;</div><div class="line">   Collection&lt;String&gt; result = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (RoutingResult each : routingResults) &#123;</div><div class="line">       <span class="keyword">if</span> (result.isEmpty()) &#123;</div><div class="line">           result.addAll(each.getTableUnits().getDataSourceNames());</div><div class="line">       &#125;</div><div class="line">       result.retainAll(each.getTableUnits().getDataSourceNames()); <span class="comment">// äº¤é›†</span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>#getDataSourceLogicTablesMap()</code> è¿”å›å¦‚å›¾ï¼š<img src="http://www.yunai.me//images/Sharding-JDBC/2017_08_06/09.png" alt=""></li></ul><hr><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ç¬¬äºŒæ­¥</span></div><div class="line"><span class="comment">// CartesianRoutingEngine.java</span></div><div class="line"><span class="keyword">private</span> List&lt;Set&lt;String&gt;&gt; getActualTableGroups(<span class="keyword">final</span> String dataSource, <span class="keyword">final</span> Set&lt;String&gt; logicTables) &#123;</div><div class="line">   List&lt;Set&lt;String&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(logicTables.size());</div><div class="line">   <span class="keyword">for</span> (RoutingResult each : routingResults) &#123;</div><div class="line">       result.addAll(each.getTableUnits().getActualTableNameGroups(dataSource, logicTables));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="keyword">private</span> List&lt;Set&lt;TableUnit&gt;&gt; toTableUnitGroups(<span class="keyword">final</span> String dataSource, <span class="keyword">final</span> List&lt;Set&lt;String&gt;&gt; actualTableGroups) &#123;</div><div class="line">   List&lt;Set&lt;TableUnit&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(actualTableGroups.size());</div><div class="line">   <span class="keyword">for</span> (Set&lt;String&gt; each : actualTableGroups) &#123;</div><div class="line">       result.add(<span class="keyword">new</span> HashSet&lt;&gt;(Lists.transform(<span class="keyword">new</span> ArrayList&lt;&gt;(each), <span class="keyword">new</span> Function&lt;String, TableUnit&gt;() &#123;</div><div class="line">    </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> TableUnit <span class="title">apply</span><span class="params">(<span class="keyword">final</span> String input)</span> </span>&#123;</div><div class="line">               <span class="keyword">return</span> findTableUnit(dataSource, input);</div><div class="line">           &#125;</div><div class="line">       &#125;)));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>#getActualTableGroups()</code> è¿”å›å¦‚å›¾ï¼š<img src="http://www.yunai.me//images/Sharding-JDBC/2017_08_06/10.png" alt=""></li><li><code>#toTableUnitGroups()</code> è¿”å›å¦‚å›¾ï¼š<img src="http://www.yunai.me//images/Sharding-JDBC/2017_08_06/11.png" alt=""></li></ul><hr><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CartesianRoutingEngine.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> List&lt;CartesianTableReference&gt; <span class="title">getCartesianTableReferences</span><span class="params">(<span class="keyword">final</span> Set&lt;List&lt;TableUnit&gt;&gt; cartesianTableUnitGroups)</span> </span>&#123;</div><div class="line">   List&lt;CartesianTableReference&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(cartesianTableUnitGroups.size());</div><div class="line">   <span class="keyword">for</span> (List&lt;TableUnit&gt; each : cartesianTableUnitGroups) &#123;</div><div class="line">       result.add(<span class="keyword">new</span> CartesianTableReference(each));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CartesianRoutingResult.java</span></div><div class="line"><span class="meta">@Getter</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;CartesianDataSource&gt; routingDataSources = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">final</span> String dataSource, <span class="keyword">final</span> Collection&lt;CartesianTableReference&gt; routingTableReferences)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (CartesianTableReference each : routingTableReferences) &#123;</div><div class="line">       merge(dataSource, each);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">final</span> String dataSource, <span class="keyword">final</span> CartesianTableReference routingTableReference)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (CartesianDataSource each : routingDataSources) &#123;</div><div class="line">       <span class="keyword">if</span> (each.getDataSource().equalsIgnoreCase(dataSource)) &#123;</div><div class="line">           each.getRoutingTableReferences().add(routingTableReference);</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   routingDataSources.add(<span class="keyword">new</span> CartesianDataSource(dataSource, routingTableReference));</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>Sets.cartesianProduct(tableUnitGroups)</code> è¿”å›å¦‚å›¾ï¼ˆGuava å·¥å…·åº“çœŸå¼ºå¤§ï¼‰ï¼š<img src="http://www.yunai.me//images/Sharding-JDBC/2017_08_06/12.png" alt=""></li><li><p><code>#getCartesianTableReferences()</code> è¿”å›å¦‚å›¾ï¼š<img src="http://www.yunai.me//images/Sharding-JDBC/2017_08_06/13.png" alt=""></p><p>CartesianTableReferenceï¼Œç¬›å¡å°”ç§¯è¡¨<strong>è·¯ç”±ç»„</strong>ï¼ŒåŒ…å«<strong>å¤šæ¡</strong> TableUnitï¼Œå³ TableUnit[0] <code>x</code> TableUnit[1] â€¦â€¦ <code>x</code> TableUnit[n]ã€‚ä¾‹å¦‚å›¾ä¸­ï¼š<code>t_order_01 x t_order_item_02</code>ï¼Œæœ€ç»ˆè½¬æ¢æˆ SQL ä¸º <code>SELECT * FROM t_order_01 o join t_order_item_02 i ON o.order_id = i.order_id</code>ã€‚</p></li><li><code>#merge()</code> åˆå¹¶ç¬›å¡å°”ç§¯è·¯ç”±ç»“æœã€‚CartesianRoutingResult åŒ…å«å¤šä¸ª CartesianDataSourceï¼Œå› æ­¤éœ€è¦å°† CartesianTableReference åˆå¹¶ï¼ˆæ·»åŠ ï¼‰åˆ°å¯¹åº”çš„ CartesianDataSourceã€‚å½“ç„¶ï¼Œç›®å‰åœ¨å®ç°æ—¶å·²ç»æ˜¯æŒ‰ç…§<strong>æ•°æ®æºï¼ˆåº“ï¼‰</strong>ç”Ÿæˆå¯¹åº”çš„ CartesianTableReferenceã€‚</li></ul><h2 id="6-4-ParsingSQLRouter-ä¸»-route"><a href="#6-4-ParsingSQLRouter-ä¸»-route" class="headerlink" title="6.4 ParsingSQLRouter ä¸»#route()"></a>6.4 ParsingSQLRouter ä¸»#route()</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLRouteResult <span class="title">route</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   <span class="keyword">final</span> Context context = MetricsContext.start(<span class="string">"Route SQL"</span>);</div><div class="line">   SQLRouteResult result = <span class="keyword">new</span> SQLRouteResult(sqlStatement);</div><div class="line">   <span class="comment">// å¤„ç† æ’å…¥SQL ä¸»é”®å­—æ®µ</span></div><div class="line">   <span class="keyword">if</span> (sqlStatement <span class="keyword">instanceof</span> InsertStatement &amp;&amp; <span class="keyword">null</span> != ((InsertStatement) sqlStatement).getGeneratedKey()) &#123;</div><div class="line">       processGeneratedKey(parameters, (InsertStatement) sqlStatement, result);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ğŸ’ğŸ’ğŸ’ è·¯ç”± ğŸ’ğŸ’ğŸ’</span></div><div class="line">   RoutingResult routingResult = route(parameters, sqlStatement);</div><div class="line">   <span class="comment">// SQLé‡å†™å¼•æ“</span></div><div class="line">   SQLRewriteEngine rewriteEngine = <span class="keyword">new</span> SQLRewriteEngine(shardingRule, logicSQL, sqlStatement);</div><div class="line">   <span class="keyword">boolean</span> isSingleRouting = routingResult.isSingleRouting();</div><div class="line">   <span class="comment">// å¤„ç†åˆ†é¡µ</span></div><div class="line">   <span class="keyword">if</span> (sqlStatement <span class="keyword">instanceof</span> SelectStatement &amp;&amp; <span class="keyword">null</span> != ((SelectStatement) sqlStatement).getLimit()) &#123;</div><div class="line">       processLimit(parameters, (SelectStatement) sqlStatement, isSingleRouting);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// SQL é‡å†™</span></div><div class="line">   SQLBuilder sqlBuilder = rewriteEngine.rewrite(!isSingleRouting);</div><div class="line">   <span class="comment">// ç”Ÿæˆ ExecutionUnit</span></div><div class="line">   <span class="keyword">if</span> (routingResult <span class="keyword">instanceof</span> CartesianRoutingResult) &#123;</div><div class="line">       <span class="keyword">for</span> (CartesianDataSource cartesianDataSource : ((CartesianRoutingResult) routingResult).getRoutingDataSources()) &#123;</div><div class="line">           <span class="keyword">for</span> (CartesianTableReference cartesianTableReference : cartesianDataSource.getRoutingTableReferences()) &#123;</div><div class="line">               result.getExecutionUnits().add(<span class="keyword">new</span> SQLExecutionUnit(cartesianDataSource.getDataSource(), rewriteEngine.generateSQL(cartesianTableReference, sqlBuilder))); <span class="comment">// ç”Ÿæˆ SQL</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">for</span> (TableUnit each : routingResult.getTableUnits().getTableUnits()) &#123;</div><div class="line">           result.getExecutionUnits().add(<span class="keyword">new</span> SQLExecutionUnit(each.getDataSourceName(), rewriteEngine.generateSQL(each, sqlBuilder))); <span class="comment">// ç”Ÿæˆ SQL</span></div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   MetricsContext.stop(context);</div><div class="line">   <span class="comment">// æ‰“å° SQL</span></div><div class="line">   <span class="keyword">if</span> (showSQL) &#123;</div><div class="line">       SQLLogger.logSQL(logicSQL, sqlStatement, result.getExecutionUnits(), parameters);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>RoutingResult routingResult = route(parameters, sqlStatement);</code> <strong>è°ƒç”¨</strong>çš„å°±æ˜¯ä¸Šæ–‡åˆ†æçš„ SimpleRoutingEngineã€ComplexRoutingEngineã€CartesianRoutingEngine çš„ <code>#route()</code> æ–¹æ³•ã€‚</li><li><code>#processGeneratedKey()</code>ã€<code>#processLimit()</code>ã€<code>#rewrite()</code>ã€<code>#generateSQL()</code> ç­‰ä¼šæ”¾åœ¨<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠSQL æ”¹å†™ã€‹</a> åˆ†äº«ã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ç¯‡å¹…æœ‰äº›é•¿ï¼Œå¸Œæœ›èƒ½è®©å¤§å®¶å¯¹<strong>è·¯ç”±</strong>æœ‰æ¯”è¾ƒå®Œæ•´çš„è®¤è¯†ã€‚<br>å¦‚æœå†…å®¹æœ‰é”™è¯¯ï¼Œçƒ¦è¯·æ‚¨æŒ‡æ­£ï¼Œæˆ‘ä¼š<strong>è®¤çœŸ</strong>ä¿®æ”¹ã€‚<br>å¦‚æœè¡¨è¿°ä¸æ¸…æ™°ï¼Œä¸å¤ªç†è§£çš„ï¼Œæ¬¢è¿åŠ æˆ‘å¾®ä¿¡ï¼ˆwangwenbin-serverï¼‰ä¸€èµ·æ¢è®¨ã€‚</p><p>è°¢è°¢ä½ æŠ€æœ¯è¿™ä¹ˆå¥½ï¼Œè¿˜<strong>è€å¿ƒ</strong>çœ‹å®Œäº†æœ¬æ–‡ã€‚</p><p>å¼ºåˆ¶è·¯ç”± HintManager è®²çš„ç›¸å¯¹ç•¥è¿‡ï¼Œå¯ä»¥çœ‹å¦‚ä¸‹å†…å®¹è¿›ä¸€æ­¥äº†è§£ï¼š</p><ol><li><a href="http://dangdangdotcom.github.io/sharding-jdbc/02-guide/hint-sharding-value/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£-å¼ºåˆ¶è·¯ç”±ã€‹</a></li><li><a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/9354031743b63e44cbded5618980ae71a15f0260/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/api/HintManager.java#L41" rel="external nofollow noopener noreferrer" target="_blank">HintManager.java æºç </a></li></ol><p>åšç€è„¸çš®ï¼Œé“å‹ï¼Œè¾›è‹¦<strong>åˆ†äº«æœ‹å‹åœˆ</strong>å¯å¥½ï¼Ÿï¼</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/Sharding-JDBC/">Sharding-JDBC</a></div><div class="article-share" id="share"><div data-url="http://www.yunai.me/Sharding-JDBC/sql-route-2/" data-title="Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±ï¼ˆäºŒï¼‰ä¹‹åˆ†åº“åˆ†è¡¨è·¯ç”± | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/Sharding-JDBC/sql-route-3/" title="Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±ï¼ˆä¸‰ï¼‰ä¹‹Springä¸YAMLé…ç½®"><strong>PREVIOUS:</strong><br><span>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±ï¼ˆä¸‰ï¼‰ä¹‹Springä¸YAMLé…ç½®</span></a></div><div class="next"><a href="/Sharding-JDBC/sql-route-1/" title="Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±ï¼ˆä¸€ï¼‰ä¹‹åˆ†åº“åˆ†è¡¨é…ç½®"><strong>NEXT:</strong><br><span>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è·¯ç”±ï¼ˆä¸€ï¼‰ä¹‹åˆ†åº“åˆ†è¡¨é…ç½®</span></a></div></nav></div></div><footer><div id="footer"><img src="http://www.yunai.me/images/common/wechat_mp_simple.png" style="display:none"><p class="copyright">Â© 2017 <a href="http://www.yunai.me" target="_blank" title="ç‹æ–‡æ–Œ">ç‹æ–‡æ–Œ</a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a> && Powered by <a href="http://hexo.io" target="_blank" title="hexo" rel="external nofollow noopener noreferrer">hexo</a> && Theme by <a href="http://gengbiao.me" target="_blank" title="coney" rel="external nofollow noopener noreferrer">coney</a></p></div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2"),ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script src="/js/util.js"></script></body>