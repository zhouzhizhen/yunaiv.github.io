<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆä¸‰ï¼‰ä¹‹æŸ¥è¯¢SQL | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="ç‹æ–‡æ–Œ"><meta name="description" content="ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘æœ‰ç¦åˆ©ï¼š  

RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨  
RocketMQ / MyCAT / Sharding-JDBC ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€  
æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚ç”šè‡³ä¸"><meta name="keywords" content="Sharding-JDBC,ShardingJDBC,Sharding-JDBC æºç ,SQLè§£æ, SQL è§£æ,Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?9e70e3362807c1bd185a79655b307027";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG">èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</a></h1><a class="blog-motto">æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li><li><a href="/link_url">å‹é“¾</a></li></ul></ul></nav></div></header><div id="container"><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-SelectStatement"><span class="toc-number">2.</span> <span class="toc-text">2. SelectStatement</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-AbstractSQLStatement"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 AbstractSQLStatement</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-SQLToken"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 SQLToken</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-query"><span class="toc-number">3.</span> <span class="toc-text">3. #query()</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-parseDistinct"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 #parseDistinct()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-parseSelectList"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 #parseSelectList()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-SelectItem-é€‰æ‹©é¡¹"><span class="toc-number">3.2.1.</span> <span class="toc-text">3.2.1 SelectItem é€‰æ‹©é¡¹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-parseAlias-è§£æåˆ«å"><span class="toc-number">3.2.2.</span> <span class="toc-text">3.2.2 #parseAlias() è§£æåˆ«å</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-TableToken-è¡¨æ ‡è®°å¯¹è±¡"><span class="toc-number">3.2.3.</span> <span class="toc-text">3.2.3 TableToken è¡¨æ ‡è®°å¯¹è±¡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-skipToFrom"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 #skipToFrom()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-parseFrom"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 #parseFrom()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-JOIN-ON-FROM-TABLE"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 JOIN ON / FROM TABLE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-å­æŸ¥è¯¢"><span class="toc-number">3.4.2.</span> <span class="toc-text">3.4.2 å­æŸ¥è¯¢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-parseJoinTable"><span class="toc-number">3.4.3.</span> <span class="toc-text">3.4.3 #parseJoinTable()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-4-Tables-è¡¨é›†åˆå¯¹è±¡"><span class="toc-number">3.4.4.</span> <span class="toc-text">3.4.4 Tables è¡¨é›†åˆå¯¹è±¡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-parseWhere"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 #parseWhere()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-parseGroupBy"><span class="toc-number">3.6.</span> <span class="toc-text">3.6 #parseGroupBy()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-1-OrderItem-æ’åºé¡¹"><span class="toc-number">3.6.1.</span> <span class="toc-text">3.6.1 OrderItem æ’åºé¡¹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-7-parseOrderBy"><span class="toc-number">3.7.</span> <span class="toc-text">3.7 #parseOrderBy()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-8-parseLimit"><span class="toc-number">3.8.</span> <span class="toc-text">3.8 #parseLimit()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-1-Limit"><span class="toc-number">3.8.1.</span> <span class="toc-text">3.8.1 Limit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-2-OffsetToken-RowCountToken"><span class="toc-number">3.8.2.</span> <span class="toc-text">3.8.2 OffsetToken RowCountToken</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-9-queryRest"><span class="toc-number">3.9.</span> <span class="toc-text">3.9 #queryRest()</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-appendDerivedç­‰æ–¹æ³•"><span class="toc-number">4.</span> <span class="toc-text">4. appendDerivedç­‰æ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-appendAvgDerivedColumns"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 appendAvgDerivedColumns</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-appendDerivedOrderColumns"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 appendDerivedOrderColumns</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-ItemsToken"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 ItemsToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-appendDerivedOrderBy"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 appendDerivedOrderBy()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-OrderByToken"><span class="toc-number">4.4.1.</span> <span class="toc-text">4.3.1 OrderByToken</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-å½©è›‹"><span class="toc-number">5.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li><li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/æŠ€æœ¯æ‚æ–‡/" title="æŠ€æœ¯æ‚æ–‡">æŠ€æœ¯æ‚æ–‡<sup>3</sup></a></li></ul></div></aside></div><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/Sharding-JDBC/sql-parse-3/" title="Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆä¸‰ï¼‰ä¹‹æŸ¥è¯¢SQL" itemprop="url">Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆä¸‰ï¼‰ä¹‹æŸ¥è¯¢SQL</a></h1><p class="article-author"></p><p class="article-time">æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><p><img src="https://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Sharding-JDBC 1.5.0 æ­£å¼ç‰ˆ</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. SelectStatement</a><ul><li><a href="#">2.1 AbstractSQLStatement</a></li><li><a href="#">2.2 SQLToken</a></li></ul></li><li><a href="#">3. #query()</a><ul><li><a href="#">3.1 #parseDistinct()</a></li><li><a href="#">3.2 #parseSelectList()</a></li><li><a href="#">3.3 #skipToFrom()</a></li><li><a href="#">3.4 #parseFrom()</a></li><li><a href="#">3.5 #parseWhere()</a></li><li><a href="#">3.6 #parseGroupBy()</a></li><li><a href="#">3.7 #parseOrderBy()</a></li><li><a href="#">3.8 #parseLimit()</a></li><li><a href="#">3.9 #queryRest()</a></li></ul></li><li><a href="#">4. appendDerivedç­‰æ–¹æ³•</a><ul><li><a href="#">4.1 appendAvgDerivedColumns</a></li><li><a href="#">4.2 appendDerivedOrderColumns</a></li><li><a href="#">4.3 ItemsToken</a></li><li><a href="#">4.4 appendDerivedOrderBy()</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡å‰ç½®é˜…è¯»ï¼š</p><ul><li><a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-1/?self">ã€ŠSQL è§£æï¼ˆä¸€ï¼‰ä¹‹è¯æ³•è§£æã€‹</a></li><li><a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹</a></li></ul><p>æœ¬æ–‡åˆ†äº«<strong>æ’å…¥SQLè§£æ</strong>çš„æºç å®ç°ã€‚</p><p>ç”±äºæ¯ä¸ªæ•°æ®åº“åœ¨éµå®ˆ SQL è¯­æ³•è§„èŒƒçš„åŒæ—¶ï¼Œåˆæœ‰å„è‡ªç‹¬ç‰¹çš„è¯­æ³•ã€‚å› æ­¤ï¼Œåœ¨ Sharding-JDBC é‡Œæ¯ä¸ªæ•°æ®åº“éƒ½æœ‰è‡ªå·±çš„ SELECT è¯­å¥çš„è§£æå™¨å®ç°æ–¹å¼ï¼Œå½“ç„¶ç»å¤§éƒ¨åˆ†é€»è¾‘æ˜¯ç›¸åŒçš„ã€‚<strong>æœ¬æ–‡ä¸»è¦åˆ†äº«ç¬”è€…æœ€å¸¸ç”¨çš„ MySQL æŸ¥è¯¢</strong>ã€‚</p><p>æŸ¥è¯¢ SQL è§£æä¸»æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/Sharding-JDBC/2017_07_27/03.png" alt=""></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> SelectStatement <span class="title">parse</span><span class="params">()</span> </span>&#123;</div><div class="line">   query();</div><div class="line">   parseOrderBy();</div><div class="line">   customizedSelect();</div><div class="line">   appendDerivedColumns();</div><div class="line">   appendDerivedOrderBy();</div><div class="line">   <span class="keyword">return</span> selectStatement;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>#parseOrderBy()</code> ï¼šå¯¹äº MySQL æŸ¥è¯¢è¯­å¥è§£æå™¨æ— æ•ˆæœï¼Œå› ä¸ºå·²ç»åœ¨ <code>#query()</code> æ–¹æ³•é‡Œé¢å·²ç»è°ƒç”¨ <code>#parseOrderBy()</code>ï¼Œå› æ­¤å›¾ä¸­çœç•¥è¯¥æ–¹æ³•ã€‚</li><li><code>#customizedSelect()</code> ï¼šOracleã€SQLServer æŸ¥è¯¢è¯­å¥è§£æå™¨é‡å†™äº†è¯¥æ–¹æ³•ï¼Œå¯¹äº MySQL æŸ¥è¯¢è§£æå™¨æ˜¯ä¸ªç©ºæ–¹æ³•ï¼Œè¿›è¡Œçœç•¥ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å•ç‹¬å»ç ”ç©¶ç ”ç©¶ã€‚</li></ul><blockquote><p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p></blockquote><p>ğŸ‘¼ æŸ¥è¯¢è¯­å¥è§£ææ˜¯å¢åˆ æ”¹æŸ¥é‡Œé¢<strong>æœ€çµæ´»ä¹Ÿæ˜¯æœ€å¤æ‚çš„</strong>ï¼Œå¸Œæœ›å¤§å®¶æœ‰è€å¿ƒçœ‹å®Œæœ¬æ–‡ã€‚ç†è§£æŸ¥è¯¢è¯­å¥è§£æï¼Œå¦å¤–ä¸‰ç§è¯­å¥ç†è§£èµ·æ¥ç®€ç›´æ˜¯ SO EASYã€‚éª—äººæ˜¯å°ç‹—ğŸ¶ã€‚<br>ğŸ™‚å¦‚æœå¯¹æœ¬æ–‡æœ‰ä¸ç†è§£çš„åœ°æ–¹ï¼Œå¯ä»¥ç»™æˆ‘çš„å…¬ä¼—å·<strong>ï¼ˆ<a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">èŠ‹é“æºç </a>ï¼‰</strong>ç•™è¨€ï¼Œæˆ‘ä¼š<strong>é€æ¡è®¤çœŸè€å¿ƒ</strong>å›å¤ã€‚éª—äººæ˜¯å°çŒªğŸ·ã€‚</p><p>OKï¼Œä¸åºŸè¯å•¦ï¼Œå¼€å§‹æˆ‘ä»¬è¿™æ®µç—›å¹¶å¿«ä¹çš„æ—…é€”ã€‚</p><h1 id="2-SelectStatement"><a href="#2-SelectStatement" class="headerlink" title="2. SelectStatement"></a>2. SelectStatement</h1><p>ğŸ™‚ <strong>æœ¬èŠ‚åªä»‹ç»è¿™äº›ç±»ï¼Œæ–¹ä¾¿æœ¬æ–‡ä¸‹èŠ‚åˆ†ææºç å®ç°å¤§å®¶èƒ½çŸ¥é“è®¤è¯†å®ƒä»¬</strong> ğŸ™‚</p><p>SelectStatementï¼ŒæŸ¥è¯¢è¯­å¥è§£æç»“æœå¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SelectStatement.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectStatement</span> <span class="keyword">extends</span> <span class="title">AbstractSQLStatement</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ˜¯å¦è¡Œ DISTINCT / DISTINCTROW / UNION</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> distinct;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ˜¯å¦æŸ¥è¯¢æ‰€æœ‰å­—æ®µï¼Œå³ SELECT *</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> containStar;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æœ€åä¸€ä¸ªæŸ¥è¯¢é¡¹ä¸‹ä¸€ä¸ª Token çš„å¼€å§‹ä½ç½®</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #items</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> selectListLastPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æœ€åä¸€ä¸ªåˆ†ç»„é¡¹ä¸‹ä¸€ä¸ª Token çš„å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> groupByLastPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æŸ¥è¯¢é¡¹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;SelectItem&gt; items = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ†ç»„é¡¹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;OrderItem&gt; groupByItems = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ’åºé¡¹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;OrderItem&gt; orderByItems = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ†é¡µ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Limit limit;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯¹å±æ€§æŒ‰ç…§ç±»å‹è¿›è¡Œå½’ç±»ï¼š</p><ul><li>ç‰¹æ®Š<ul><li>distinct</li></ul></li><li>æŸ¥è¯¢å­—æ®µ<ul><li>containStar</li><li>items</li><li>selectListLastPosition</li></ul></li><li>åˆ†ç»„æ¡ä»¶<ul><li>groupByItems</li><li>groupByLastPosition</li></ul></li><li>æ’åºæ¡ä»¶<ul><li>orderByItems</li></ul></li><li>åˆ†é¡µæ¡ä»¶<ul><li>limit</li></ul></li></ul><h2 id="2-1-AbstractSQLStatement"><a href="#2-1-AbstractSQLStatement" class="headerlink" title="2.1 AbstractSQLStatement"></a>2.1 AbstractSQLStatement</h2><p>å¢åˆ æ”¹æŸ¥è§£æç»“æœå¯¹è±¡çš„<strong>æŠ½è±¡çˆ¶ç±»</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractSQLStatement</span> <span class="keyword">implements</span> <span class="title">SQLStatement</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL ç±»å‹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SQLType type;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¡¨</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Tables tables = <span class="keyword">new</span> Tables();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¿‡æ»¤æ¡ä»¶ã€‚</div><div class="line">     * åªæœ‰å¯¹è·¯ç”±ç»“æœæœ‰å½±å“çš„æ¡ä»¶ï¼Œæ‰æ·»åŠ è¿›æ•°ç»„</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Conditions conditions = <span class="keyword">new</span> Conditions();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQLæ ‡è®°å¯¹è±¡</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="2-2-SQLToken"><a href="#2-2-SQLToken" class="headerlink" title="2.2 SQLToken"></a>2.2 SQLToken</h2><p>SQLTokenï¼ŒSQLæ ‡è®°å¯¹è±¡æ¥å£ï¼ŒSQL æ”¹å†™æ—¶ä½¿ç”¨åˆ°ã€‚ä¸‹é¢éƒ½æ˜¯å®ƒçš„å®ç°ç±»ï¼š</p><table><thead><tr><th style="text-align:left">ç±»</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left">GeneratedKeyToken</td><td style="text-align:left">è‡ªå¢ä¸»é”®æ ‡è®°å¯¹è±¡</td></tr><tr><td style="text-align:left">TableToken</td><td style="text-align:left">è¡¨æ ‡è®°å¯¹è±¡</td></tr><tr><td style="text-align:left">ItemsToken</td><td style="text-align:left">é€‰æ‹©é¡¹æ ‡è®°å¯¹è±¡</td></tr><tr><td style="text-align:left">OffsetToken</td><td style="text-align:left">åˆ†é¡µåç§»é‡æ ‡è®°å¯¹è±¡</td></tr><tr><td style="text-align:left">OrderByToken</td><td style="text-align:left">æ’åºæ ‡è®°å¯¹è±¡</td></tr><tr><td style="text-align:left">RowCountToken</td><td style="text-align:left">åˆ†é¡µé•¿åº¦æ ‡è®°å¯¹è±¡</td></tr></tbody></table><h1 id="3-query"><a href="#3-query" class="headerlink" title="3. #query()"></a>3. #query()</h1><p><code>#query()</code>ï¼ŒæŸ¥è¯¢ SQL è§£æã€‚</p><p><strong>MySQL SELECT Syntax</strong>ï¼š</p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">// https://dev.mysql.com/doc/refman/5.7/en/select.html</div><div class="line"><span class="keyword">SELECT</span></div><div class="line">    [ALL | <span class="keyword">DISTINCT</span> | <span class="keyword">DISTINCTROW</span> ]</div><div class="line">      [<span class="keyword">HIGH_PRIORITY</span>]</div><div class="line">      [<span class="keyword">STRAIGHT_JOIN</span>]</div><div class="line">      [<span class="keyword">SQL_SMALL_RESULT</span>] [<span class="keyword">SQL_BIG_RESULT</span>] [<span class="keyword">SQL_BUFFER_RESULT</span>]</div><div class="line">      [<span class="keyword">SQL_CACHE</span> | SQL_NO_CACHE] [<span class="keyword">SQL_CALC_FOUND_ROWS</span>]</div><div class="line">    select_expr [, select_expr ...]</div><div class="line">    [<span class="keyword">FROM</span> table_references</div><div class="line">      [<span class="keyword">PARTITION</span> partition_list]</div><div class="line">    [<span class="keyword">WHERE</span> where_condition]</div><div class="line">    [<span class="keyword">GROUP</span> <span class="keyword">BY</span> &#123;col_name | expr | <span class="keyword">position</span>&#125;</div><div class="line">      [<span class="keyword">ASC</span> | <span class="keyword">DESC</span>], ... [<span class="keyword">WITH</span> <span class="keyword">ROLLUP</span>]]</div><div class="line">    [<span class="keyword">HAVING</span> where_condition]</div><div class="line">    [<span class="keyword">ORDER</span> <span class="keyword">BY</span> &#123;col_name | expr | <span class="keyword">position</span>&#125;</div><div class="line">      [<span class="keyword">ASC</span> | <span class="keyword">DESC</span>], ...]</div><div class="line">    [<span class="keyword">LIMIT</span> &#123;[<span class="keyword">offset</span>,] <span class="keyword">row_count</span> | <span class="keyword">row_count</span> <span class="keyword">OFFSET</span> <span class="keyword">offset</span>&#125;]</div><div class="line">    [<span class="keyword">PROCEDURE</span> procedure_name(argument_list)]</div><div class="line">    [<span class="keyword">INTO</span> <span class="keyword">OUTFILE</span> <span class="string">'file_name'</span></div><div class="line">        [<span class="built_in">CHARACTER</span> <span class="keyword">SET</span> charset_name]</div><div class="line">        export_options</div><div class="line">      | <span class="keyword">INTO</span> <span class="keyword">DUMPFILE</span> <span class="string">'file_name'</span></div><div class="line">      | <span class="keyword">INTO</span> var_name [, var_name]]</div><div class="line">    [<span class="keyword">FOR</span> <span class="keyword">UPDATE</span> | <span class="keyword">LOCK</span> <span class="keyword">IN</span> <span class="keyword">SHARE</span> <span class="keyword">MODE</span>]]</div></pre></td></tr></table></figure><p>å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/Sharding-JDBC/2017_07_27/04.png" alt=""></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MySQLSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (getSqlParser().equalAny(DefaultKeyword.SELECT)) &#123;</div><div class="line">       getSqlParser().getLexer().nextToken();</div><div class="line">       parseDistinct();</div><div class="line">       getSqlParser().skipAll(MySQLKeyword.HIGH_PRIORITY, DefaultKeyword.STRAIGHT_JOIN, MySQLKeyword.SQL_SMALL_RESULT, MySQLKeyword.SQL_BIG_RESULT, MySQLKeyword.SQL_BUFFER_RESULT,</div><div class="line">               MySQLKeyword.SQL_CACHE, MySQLKeyword.SQL_NO_CACHE, MySQLKeyword.SQL_CALC_FOUND_ROWS);</div><div class="line">       parseSelectList(); <span class="comment">// è§£æ æŸ¥è¯¢å­—æ®µ</span></div><div class="line">       skipToFrom(); <span class="comment">// è·³åˆ° FROM å¤„</span></div><div class="line">   &#125;</div><div class="line">   parseFrom();<span class="comment">// è§£æ è¡¨ï¼ˆJOIN ON / FROM å•&amp;å¤šè¡¨ï¼‰</span></div><div class="line">   parseWhere(); <span class="comment">// è§£æ WHERE æ¡ä»¶</span></div><div class="line">   parseGroupBy(); <span class="comment">// è§£æ Group By å’Œ Havingï¼ˆç›®å‰ä¸æ”¯æŒï¼‰æ¡ä»¶</span></div><div class="line">   parseOrderBy(); <span class="comment">// è§£æ Order By æ¡ä»¶</span></div><div class="line">   parseLimit(); <span class="comment">// è§£æ åˆ†é¡µ Limit æ¡ä»¶</span></div><div class="line">   <span class="comment">// [PROCEDURE] æš‚ä¸æ”¯æŒ</span></div><div class="line">   <span class="keyword">if</span> (getSqlParser().equalAny(DefaultKeyword.PROCEDURE)) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(getSqlParser().getLexer().getCurrentToken().getType());</div><div class="line">   &#125;</div><div class="line">   queryRest();</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="3-1-parseDistinct"><a href="#3-1-parseDistinct" class="headerlink" title="3.1 #parseDistinct()"></a>3.1 #parseDistinct()</h2><p>è§£æ DISTINCTã€DISTINCTROWã€UNION è°“è¯­ã€‚</p><p>æ ¸å¿ƒä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseDistinct</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.DISTINCT, DefaultKeyword.DISTINCTROW, DefaultKeyword.UNION)) &#123;</div><div class="line">       selectStatement.setDistinct(<span class="keyword">true</span>);</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       <span class="keyword">if</span> (hasDistinctOn() &amp;&amp; sqlParser.equalAny(DefaultKeyword.ON)) &#123; <span class="comment">// PostgreSQL ç‹¬æœ‰è¯­æ³•ï¼š DISTINCT ON</span></div><div class="line">           sqlParser.getLexer().nextToken();</div><div class="line">           sqlParser.skipParentheses();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.ALL)) &#123;</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>æ­¤å¤„ DISTINCT å’Œ DISTINCT(å­—æ®µ) ä¸åŒï¼Œå®ƒæ˜¯é’ˆå¯¹æŸ¥è¯¢ç»“æœåšå»é‡ï¼Œå³æ•´è¡Œé‡å¤ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">mysql&gt; SELECT item_id, order_id FROM t_order_item;</div><div class="line">+---------+----------+</div><div class="line">| item_id | order_id |</div><div class="line">+---------+----------+</div><div class="line">| 1       | 1        |</div><div class="line">| 1       | 1        |</div><div class="line">+---------+----------+</div><div class="line">2 rows in set (0.03 sec)</div><div class="line"></div><div class="line">mysql&gt; SELECT DISTINCT item_id, order_id FROM t_order_item;</div><div class="line">+---------+----------+</div><div class="line">| item_id | order_id |</div><div class="line">+---------+----------+</div><div class="line">| 1       | 1        |</div><div class="line">+---------+----------+</div><div class="line">1 rows in set (0.02 sec)</div></pre></td></tr></table></figure><h2 id="3-2-parseSelectList"><a href="#3-2-parseSelectList" class="headerlink" title="3.2 #parseSelectList()"></a>3.2 #parseSelectList()</h2><table><thead><tr><th>SELECT</th><th>o.user_id</th><th>COUNT(DISTINCT i.item_id) AS item_count</th><th>MAX(i.item_id)</th><th>FROM</th></tr></thead><tbody><tr><td></td><td>SelectItem</td><td>SelectItem</td><td>SelectItem</td></tr></tbody></table><p>å°† SQL <strong>æŸ¥è¯¢å­—æ®µ</strong> æŒ‰ç…§<strong>é€—å·( , )</strong>åˆ‡å‰²æˆ<strong>å¤šä¸ª</strong>é€‰æ‹©é¡¹( SelectItem)ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseSelectList</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">do</span> &#123;</div><div class="line">       <span class="comment">// è§£æå•ä¸ªé€‰æ‹©é¡¹</span></div><div class="line">       parseSelectItem();</div><div class="line">   &#125; <span class="keyword">while</span> (sqlParser.skipIfEqual(Symbol.COMMA));</div><div class="line">   <span class="comment">// è®¾ç½® æœ€åä¸€ä¸ªæŸ¥è¯¢é¡¹ä¸‹ä¸€ä¸ª Token çš„å¼€å§‹ä½ç½®</span></div><div class="line">   selectStatement.setSelectListLastPosition(sqlParser.getLexer().getCurrentToken().getEndPosition() - sqlParser.getLexer().getCurrentToken().getLiterals().length());</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="3-2-1-SelectItem-é€‰æ‹©é¡¹"><a href="#3-2-1-SelectItem-é€‰æ‹©é¡¹" class="headerlink" title="3.2.1 SelectItem é€‰æ‹©é¡¹"></a>3.2.1 SelectItem é€‰æ‹©é¡¹</h3><p>SelectItem æ¥å£ï¼Œ<strong>å±äºåˆ†ç‰‡ä¸Šä¸‹æ–‡ä¿¡æ¯</strong>ï¼Œæœ‰ 2 ä¸ªå®ç°ç±»ï¼š</p><ul><li>CommonSelectItem ï¼šé€šç”¨é€‰æ‹©é¡¹</li><li>AggregationSelectItem ï¼šèšåˆé€‰æ‹©é¡¹</li></ul><p><img src="http://www.iocoder.cn/images/Sharding-JDBC/2017_07_27/01.png" alt=""></p><p>è§£æå•ä¸ª SelectItem æ ¸å¿ƒä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSelectItem</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ç¬¬å››ç§æƒ…å†µï¼ŒSQL Server ç‹¬æœ‰</span></div><div class="line">   <span class="keyword">if</span> (isRowNumberSelectItem()) &#123;</div><div class="line">       selectStatement.getItems().add(parseRowNumberSelectItem());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   sqlParser.skipIfEqual(DefaultKeyword.CONNECT_BY_ROOT); <span class="comment">// Oracle ç‹¬æœ‰ï¼šhttps://docs.oracle.com/cd/B19306_01/server.102/b14200/operators004.htm</span></div><div class="line">   String literals = sqlParser.getLexer().getCurrentToken().getLiterals();</div><div class="line">   <span class="comment">// ç¬¬ä¸€ç§æƒ…å†µï¼Œ* é€šç”¨é€‰æ‹©é¡¹ï¼ŒSELECT *</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(Symbol.STAR) || Symbol.STAR.getLiterals().equals(SQLUtil.getExactlyValue(literals))) &#123;</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       selectStatement.getItems().add(<span class="keyword">new</span> CommonSelectItem(Symbol.STAR.getLiterals(), sqlParser.parseAlias()));</div><div class="line">       selectStatement.setContainStar(<span class="keyword">true</span>);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç¬¬äºŒç§æƒ…å†µï¼Œèšåˆé€‰æ‹©é¡¹</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.MAX, DefaultKeyword.MIN, DefaultKeyword.SUM, DefaultKeyword.AVG, DefaultKeyword.COUNT)) &#123;</div><div class="line">       selectStatement.getItems().add(<span class="keyword">new</span> AggregationSelectItem(AggregationType.valueOf(literals.toUpperCase()), sqlParser.skipParentheses(), sqlParser.parseAlias()));</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ç¬¬ä¸‰ç§æƒ…å†µï¼Œé * é€šç”¨é€‰æ‹©é¡¹</span></div><div class="line">   StringBuilder expression = <span class="keyword">new</span> StringBuilder();</div><div class="line">   Token lastToken = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">while</span> (!sqlParser.equalAny(DefaultKeyword.AS) &amp;&amp; !sqlParser.equalAny(Symbol.COMMA) &amp;&amp; !sqlParser.equalAny(DefaultKeyword.FROM) &amp;&amp; !sqlParser.equalAny(Assist.END)) &#123;</div><div class="line">       String value = sqlParser.getLexer().getCurrentToken().getLiterals();</div><div class="line">       <span class="keyword">int</span> position = sqlParser.getLexer().getCurrentToken().getEndPosition() - value.length();</div><div class="line">       expression.append(value);</div><div class="line">       lastToken = sqlParser.getLexer().getCurrentToken();</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       <span class="keyword">if</span> (sqlParser.equalAny(Symbol.DOT)) &#123;</div><div class="line">           selectStatement.getSqlTokens().add(<span class="keyword">new</span> TableToken(position, value));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ä¸å¸¦ ASï¼Œå¹¶ä¸”æœ‰åˆ«åï¼Œå¹¶ä¸”åˆ«åä¸ç­‰äºè‡ªå·±ï¼ˆtipsï¼šè¿™é‡Œé‡ç‚¹çœ‹ã€‚åˆ¤æ–­è¿™ä¹ˆå¤æ‚çš„åŸå› ï¼šé˜²æ­¢substringæ“ä½œæˆªå–ç»“æœé”™è¯¯ï¼‰</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != lastToken &amp;&amp; Literals.IDENTIFIER == lastToken.getType()</div><div class="line">           &amp;&amp; !isSQLPropertyExpression(expression, lastToken) <span class="comment">// è¿‡æ»¤æ‰ï¼Œåˆ«åæ˜¯è‡ªå·±çš„æƒ…å†µã€1ã€‘ï¼ˆä¾‹å¦‚ï¼ŒSELECT u.user_id u.user_id FROM t_userï¼‰</span></div><div class="line">           &amp;&amp; !expression.toString().equals(lastToken.getLiterals())) &#123; <span class="comment">// è¿‡æ»¤æ‰ï¼Œæ— åˆ«åçš„æƒ…å†µã€2ã€‘ï¼ˆä¾‹å¦‚ï¼ŒSELECT user_id FROM t_userï¼‰</span></div><div class="line">       selectStatement.getItems().add(</div><div class="line">               <span class="keyword">new</span> CommonSelectItem(SQLUtil.getExactlyValue(expression.substring(<span class="number">0</span>, expression.lastIndexOf(lastToken.getLiterals()))), Optional.of(lastToken.getLiterals())));</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å¸¦ ASï¼ˆä¾‹å¦‚ï¼ŒSELECT user_id AS userIdï¼‰ æˆ–è€… æ— åˆ«åï¼ˆä¾‹å¦‚ï¼ŒSELECT user_idï¼‰</span></div><div class="line">   selectStatement.getItems().add(<span class="keyword">new</span> CommonSelectItem(SQLUtil.getExactlyValue(expression.toString()), sqlParser.parseAlias()));</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ä¸€å…±åˆ†æˆ 4 ç§å¤§çš„æƒ…å†µï¼Œæˆ‘ä»¬æ¥é€æ¡æ¢³ç†ï¼š</p><ul><li>ç¬¬ä¸€ç§ï¼š<strong><code>*</code> é€šç”¨é€‰æ‹©é¡¹</strong>ï¼š<br>ä¾‹å¦‚ï¼Œ<code>SELECT * FROM t_user</code> çš„ <code>*</code>ã€‚<br>ä¸ºä»€ä¹ˆè¦åŠ  <code>Symbol.STAR.getLiterals().equals(SQLUtil.getExactlyValue(literals))</code> åˆ¤æ–­å‘¢ï¼Ÿ</li></ul><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="string">`*`</span> <span class="keyword">FROM</span> t_user; // ä¹Ÿèƒ½è¾¾åˆ°æŸ¥è¯¢æ‰€æœ‰å­—æ®µçš„æ•ˆæœ</div></pre></td></tr></table></figure><ul><li>ç¬¬äºŒç§ï¼š<strong>èšåˆé€‰æ‹©é¡¹</strong>ï¼š<br>ä¾‹å¦‚ï¼Œ<code>SELECT COUNT(user_id) FROM t_user</code> çš„ <code>COUNT(user_id)</code>ã€‚</li></ul><p>è§£æç»“æœ AggregationSelectItemï¼š<br><img src="http://www.iocoder.cn/images/Sharding-JDBC/2017_07_27/05.png" alt=""></p><p><code>sqlParser.skipParentheses()</code> è§£æè§<a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹çš„AbstractParserå°èŠ‚</a>ã€‚</p><ul><li>ç¬¬ä¸‰ç§ï¼š<strong>é <code>*</code> é€šç”¨é€‰æ‹©é¡¹</strong>ï¼š</li></ul><p>ä¾‹å¦‚ï¼Œ<code>SELECT user_id FROM t_user</code>ã€‚</p><p>ä»å®ç°ä¸Šï¼Œé€»è¾‘ä¼šå¤æ‚å¾ˆå¤šã€‚ç›¸æ¯”ç¬¬ä¸€ç§ï¼Œå¯ä»¥æ ¹æ® <code>*</code> åšå­—æ®µåˆ¤æ–­ï¼›ç›¸æ¯”ç¬¬äºŒç§ï¼Œå¯ä»¥ä½¿ç”¨ <code>(</code> å’Œ <code>)</code> åšå­—æ®µåˆ¤æ–­ã€‚èƒ½å¤Ÿåˆ¤æ–­ä¸€ä¸ª<strong>åŒ…å«åˆ«åçš„</strong> SelectItem ç»“æŸæœ‰ 4 ç§ Tokenï¼Œæ ¹æ®ç»“æŸæ–¹å¼æˆ‘ä»¬åˆ†æˆ 2 ç§ï¼š</p><ul><li>DefaultKeyword.AS ï¼šèƒ½å¤Ÿæ¥è§¦å‡º SelectItem å­—æ®µï¼Œ<strong>å³ä¸åŒ…å«åˆ«å</strong>ã€‚ä¾‹å¦‚ï¼Œ<code>SELECT user_id AS uid FROM t_user</code>ï¼Œèƒ½å¤Ÿç›´æ¥è§£æå‡º <code>user_id</code>ã€‚</li><li>Symbol.COMMA / DefaultKeyword.FROM / Assist.END ï¼š<strong>åŒ…å«åˆ«å</strong>ã€‚ä¾‹å¦‚ï¼Œ<code>SELECT user_id uid FROM t_user</code>ï¼Œè§£æç»“æœä¸º <code>user_id uid</code>ã€‚</li></ul><p>åŸºäºè¿™ä¸ªåœ¨é…åˆä¸Šé¢çš„ä»£ç æ³¨é‡Šï¼Œå¤§å®¶å†é‡æ–°ç†è§£ä¸‹ç¬¬ä¸‰ç§æƒ…å†µçš„å®ç°ã€‚</p><ul><li>ç¬¬å››ç§ï¼šSQLServer ROW_NUMBERï¼š</li></ul><p>ROW_NUMBER æ˜¯ SQLServer ç‹¬æœ‰çš„ã€‚ç”±äºæœ¬æ–‡å¤§éƒ¨åˆ†çš„è¯»è€…ä½¿ç”¨çš„ MySQL / Oracleï¼Œå°±è·³è¿‡äº†ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ <a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/9354031743b63e44cbded5618980ae71a15f0260/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/parsing/parser/dialect/sqlserver/SQLServerSelectParser.java" rel="external nofollow noopener noreferrer" target="_blank">SQLServerSelectParser#parseRowNumberSelectItem()</a> æ–¹æ³•ã€‚</p><h3 id="3-2-2-parseAlias-è§£æåˆ«å"><a href="#3-2-2-parseAlias-è§£æåˆ«å" class="headerlink" title="3.2.2 #parseAlias() è§£æåˆ«å"></a>3.2.2 #parseAlias() è§£æåˆ«å</h3><p>è§£æåˆ«åï¼Œåˆ†æˆæ˜¯å¦å¸¦ <code>AS</code> ä¸¤ç§æƒ…å†µã€‚è§£æä»£ç ï¼š<a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹çš„#parseAlias()å°èŠ‚</a>ã€‚</p><h3 id="3-2-3-TableToken-è¡¨æ ‡è®°å¯¹è±¡"><a href="#3-2-3-TableToken-è¡¨æ ‡è®°å¯¹è±¡" class="headerlink" title="3.2.3 TableToken è¡¨æ ‡è®°å¯¹è±¡"></a>3.2.3 TableToken è¡¨æ ‡è®°å¯¹è±¡</h3><p>TableTokenï¼Œè®°å½•è¡¨ååœ¨ SQL é‡Œå‡ºç°çš„<strong>ä½ç½®</strong>å’Œ<strong>åå­—</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TableToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¡¨è¾¾å¼</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String originalLiterals;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–è¡¨åç§°.</div><div class="line">     * <span class="doctag">@return</span> è¡¨åç§°</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTableName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> SQLUtil.getExactlyValue(originalLiterals);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ä¾‹å¦‚ä¸Šæ–‡ç¬¬ä¸‰ç§æƒ…å†µã€‚<br><img src="http://www.iocoder.cn/images/Sharding-JDBC/2017_07_27/06.png" alt=""></p><h2 id="3-3-skipToFrom"><a href="#3-3-skipToFrom" class="headerlink" title="3.3 #skipToFrom()"></a>3.3 #skipToFrom()</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* è·³åˆ° FROM å¤„</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">skipToFrom</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">while</span> (!getSqlParser().equalAny(DefaultKeyword.FROM) &amp;&amp; !getSqlParser().equalAny(Assist.END)) &#123;</div><div class="line">       getSqlParser().getLexer().nextToken();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="3-4-parseFrom"><a href="#3-4-parseFrom" class="headerlink" title="3.4 #parseFrom()"></a>3.4 #parseFrom()</h2><p>è§£æè¡¨ä»¥åŠè¡¨è¿æ¥å…³ç³»ã€‚<strong>è¿™å—ç›¸å¯¹æ¯”è¾ƒå¤æ‚ï¼Œè¯·å¤§å®¶è€å¿ƒ+è€å¿ƒ+è€å¿ƒã€‚</strong></p><p><strong>MySQL JOIN Syntax</strong>ï¼š</p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">// https://dev.mysql.com/doc/refman/5.7/en/join.html</div><div class="line">table_references:</div><div class="line">    escaped_table_reference [, escaped_table_reference] ...</div><div class="line"></div><div class="line">escaped_table_reference:</div><div class="line">    table_reference</div><div class="line">  | &#123; OJ table_reference &#125;</div><div class="line"></div><div class="line">table_reference:</div><div class="line">    table_factor</div><div class="line">  | join_table</div><div class="line"></div><div class="line">table_factor:</div><div class="line">    tbl_name [PARTITION (partition_names)]</div><div class="line">        [[AS] alias] [index_hint_list]</div><div class="line">  | table_subquery [AS] alias</div><div class="line">  | ( table_references )</div><div class="line"></div><div class="line">join_table:</div><div class="line">    table_reference [INNER | CROSS] JOIN table_factor [join_condition]</div><div class="line">  | table_reference STRAIGHT_JOIN table_factor</div><div class="line">  | table_reference STRAIGHT_JOIN table_factor ON conditional_expr</div><div class="line">  | table_reference &#123;LEFT|RIGHT&#125; [OUTER] JOIN table_reference join_condition</div><div class="line">  | table_reference NATURAL [&#123;LEFT|RIGHT&#125; [OUTER]] JOIN table_factor</div><div class="line"></div><div class="line">join_condition:</div><div class="line">    ON conditional_expr</div><div class="line">  | USING (column_list)</div><div class="line"></div><div class="line">index_hint_list:</div><div class="line">    index_hint [, index_hint] ...</div><div class="line"></div><div class="line">index_hint:</div><div class="line">    USE &#123;INDEX|KEY&#125;</div><div class="line">      [FOR &#123;JOIN|ORDER BY|GROUP BY&#125;] ([index_list])</div><div class="line">  | IGNORE &#123;INDEX|KEY&#125;</div><div class="line">      [FOR &#123;JOIN|ORDER BY|GROUP BY&#125;] (index_list)</div><div class="line">  | FORCE &#123;INDEX|KEY&#125;</div><div class="line">      [FOR &#123;JOIN|ORDER BY|GROUP BY&#125;] (index_list)</div><div class="line"></div><div class="line">index_list:</div><div class="line">    index_name [, index_name] ...</div></pre></td></tr></table></figure><h3 id="3-4-1-JOIN-ON-FROM-TABLE"><a href="#3-4-1-JOIN-ON-FROM-TABLE" class="headerlink" title="3.4.1 JOIN ON / FROM TABLE"></a>3.4.1 JOIN ON / FROM TABLE</h3><p>å…ˆæŠ›å¼€<strong>å­æŸ¥è¯¢</strong>çš„æƒ…å†µï¼Œåªè€ƒè™‘å¦‚ä¸‹ä¸¤ç§ SQL æƒ…å†µã€‚</p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">// JOIN ON ï¼š å®é™…å¯ä»¥ç»§ç»­ JOIN ON æ›´å¤šè¡¨</div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o <span class="keyword">JOIN</span> t_order_item i <span class="keyword">ON</span> o.order_id = i.order_id; </div><div class="line">// FROM å¤šè¡¨ ï¼šå®é™…å¯ä»¥ç»§ç»­ FROM å¤šæ›´è¡¨</div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o, t_order_item i</div></pre></td></tr></table></figure><p>åœ¨çœ‹å®ç°ä»£ç ä¹‹å‰ï¼Œå…ˆä¸€èµ·çœ‹ä¸‹è°ƒç”¨é¡ºåºå›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Sharding-JDBC/2017_07_27/02.png" alt=""></p><p>çœ‹æ‡‚ä¸Šå›¾åï¼Œæ¥ç»§ç»­çœ‹ä¸‹å®ç°ä»£ç ï¼ˆğŸ™‚<strong>ä»£ç æœ‰ç‚¹å¤šï¼Œä¸è¦æ–¹ï¼</strong>ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£ææ‰€æœ‰è¡¨åå’Œè¡¨åˆ«å</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseFrom</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.FROM)) &#123;</div><div class="line">       parseTable();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£ææ‰€æœ‰è¡¨åå’Œè¡¨åˆ«å</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseTable</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è§£æå­æŸ¥è¯¢</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(Symbol.LEFT_PAREN)) &#123;</div><div class="line">       <span class="keyword">if</span> (!selectStatement.getTables().isEmpty()) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support subquery for nested tables."</span>);</div><div class="line">       &#125;</div><div class="line">       selectStatement.setContainStar(<span class="keyword">false</span>);</div><div class="line">       sqlParser.skipUselessParentheses(); <span class="comment">// å»æ‰å­æŸ¥è¯¢å·¦æ‹¬å·</span></div><div class="line">       parse(); <span class="comment">// è§£æå­æŸ¥è¯¢ SQL</span></div><div class="line">       sqlParser.skipUselessParentheses(); <span class="comment">// å»æ‰å­æŸ¥è¯¢å³æ‹¬å·</span></div><div class="line">       <span class="comment">//</span></div><div class="line">       <span class="keyword">if</span> (!selectStatement.getTables().isEmpty()) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   parseTableFactor(); <span class="comment">// è§£æå½“å‰è¡¨</span></div><div class="line">   parseJoinTable(); <span class="comment">// è§£æä¸‹ä¸€ä¸ªè¡¨</span></div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æå•ä¸ªè¡¨åå’Œè¡¨åˆ«å</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseTableFactor</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> beginPosition = sqlParser.getLexer().getCurrentToken().getEndPosition() - sqlParser.getLexer().getCurrentToken().getLiterals().length();</div><div class="line">   String literals = sqlParser.getLexer().getCurrentToken().getLiterals();</div><div class="line">   sqlParser.getLexer().nextToken();</div><div class="line">   <span class="comment">// TODO åŒ…å«Schemaè§£æ</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(Symbol.DOT)) &#123; <span class="comment">// https://dev.mysql.com/doc/refman/5.7/en/information-schema.html ï¼šSELECT table_name, table_type, engine FROM information_schema.tables</span></div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       sqlParser.parseAlias();</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// FIXME æ ¹æ®shardingRuleè¿‡æ»¤table</span></div><div class="line">   selectStatement.getSqlTokens().add(<span class="keyword">new</span> TableToken(beginPosition, literals));</div><div class="line">   <span class="comment">// è¡¨ ä»¥åŠ è¡¨åˆ«å</span></div><div class="line">   selectStatement.getTables().add(<span class="keyword">new</span> Table(SQLUtil.getExactlyValue(literals), sqlParser.parseAlias()));</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æ Join Table æˆ–è€… FROM ä¸‹ä¸€å¼  Table</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseJoinTable</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.skipJoin()) &#123;</div><div class="line">       <span class="comment">// è¿™é‡Œè°ƒç”¨ parseJoinTable() è€Œä¸æ˜¯ parseTableFactor() ï¼šä¸‹ä¸€ä¸ª Table å¯èƒ½æ˜¯å­æŸ¥è¯¢</span></div><div class="line">       <span class="comment">// ä¾‹å¦‚ï¼šSELECT * FROM t_order JOIN (SELECT * FROM t_order_item JOIN t_order_other ON ) .....</span></div><div class="line">       parseTable();</div><div class="line">       <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.ON)) &#123; <span class="comment">// JOIN è¡¨æ—¶ ON æ¡ä»¶</span></div><div class="line">           <span class="keyword">do</span> &#123;</div><div class="line">               parseTableCondition(sqlParser.getLexer().getCurrentToken().getEndPosition());</div><div class="line">               sqlParser.accept(Symbol.EQ);</div><div class="line">               parseTableCondition(sqlParser.getLexer().getCurrentToken().getEndPosition() - sqlParser.getLexer().getCurrentToken().getLiterals().length());</div><div class="line">           &#125; <span class="keyword">while</span> (sqlParser.skipIfEqual(DefaultKeyword.AND));</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.USING)) &#123; <span class="comment">// JOIN è¡¨æ—¶ USING ä¸ºä½¿ç”¨ä¸¤è¡¨ç›¸åŒå­—æ®µç›¸åŒæ—¶å¯¹ ON çš„ç®€åŒ–ã€‚ä¾‹å¦‚ä»¥ä¸‹ä¸¤æ¡ SQL ç­‰ä»·ï¼š</span></div><div class="line">                                                                   <span class="comment">// SELECT * FROM t_order o JOIN t_order_item i USING (order_id);</span></div><div class="line">                                                                   <span class="comment">// SELECT * FROM t_order o JOIN t_order_item i ON o.order_id = i.order_id</span></div><div class="line">           sqlParser.skipParentheses();</div><div class="line">       &#125;</div><div class="line">       parseJoinTable(); <span class="comment">// ç»§ç»­é€’å½’</span></div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æ ON æ¡ä»¶é‡Œçš„ TableToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> startPosition å¼€å§‹ä½ç½®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseTableCondition</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> startPosition)</span> </span>&#123;</div><div class="line">   SQLExpression sqlExpression = sqlParser.parseExpression();</div><div class="line">   <span class="keyword">if</span> (!(sqlExpression <span class="keyword">instanceof</span> SQLPropertyExpression)) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   SQLPropertyExpression sqlPropertyExpression = (SQLPropertyExpression) sqlExpression;</div><div class="line">   <span class="keyword">if</span> (selectStatement.getTables().getTableNames().contains(SQLUtil.getExactlyValue(sqlPropertyExpression.getOwner().getName()))) &#123;</div><div class="line">       selectStatement.getSqlTokens().add(<span class="keyword">new</span> TableToken(startPosition, sqlPropertyExpression.getOwner().getName()));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>OKï¼Œé€’å½’å› ä¸ºå¹³æ—¶æ—¥å¸¸ä¸­å†™çš„æ¯”è¾ƒå°‘ï¼Œå¯èƒ½ç†è§£èµ·æ¥å¯èƒ½ä¼šå›°éš¾ä¸€äº›ï¼ŒåŠªåŠ›çœ‹æ‡‚ï¼ğŸ™‚<strong>å¦‚æœçœŸçš„çœ‹ä¸æ‡‚ï¼Œå¯ä»¥åŠ å¾®ä¿¡å…¬ä¼—å·ï¼ˆ<a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">èŠ‹é“æºç </a>ï¼‰ï¼Œæˆ‘æ¥å¸®ä½ ä¸€èµ·ç†è§£ã€‚</strong></p><h3 id="3-4-2-å­æŸ¥è¯¢"><a href="#3-4-2-å­æŸ¥è¯¢" class="headerlink" title="3.4.2 å­æŸ¥è¯¢"></a>3.4.2 å­æŸ¥è¯¢</h3><p>Sharding-JDBC ç›®å‰æ”¯æŒ<strong>ç¬¬ä¸€ä¸ª</strong>åŒ…å«å¤šå±‚çº§çš„æ•°æ®å­æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> o3.* <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o) o2) o3;</div><div class="line"><span class="keyword">SELECT</span> o3.* <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o) o2) o3 <span class="keyword">JOIN</span> t_order_item i <span class="keyword">ON</span> o3.order_id = i.order_id;</div></pre></td></tr></table></figure><p>ä¸æ”¯æŒ<strong>ç¬¬äºŒä¸ªå¼€å§‹</strong>åŒ…å«å¤šå±‚çº§çš„æ•°æ®å­æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> o3.* <span class="keyword">FROM</span> t_order_item i <span class="keyword">JOIN</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o) o2) o3 <span class="keyword">ON</span> o3.order_id = i.order_id; // æ­¤æ¡ SQL æ˜¯ä¸Šé¢ç¬¬äºŒæ¡ SQL å·¦å³é‡è¡¨é¢ å€’</div><div class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o <span class="keyword">WHERE</span> o.id <span class="keyword">IN</span> (<span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> t_order <span class="keyword">WHERE</span> <span class="keyword">status</span> = ?)) // <span class="keyword">FROM</span> å®˜æ–¹ä¸æ”¯æŒ <span class="keyword">SQL</span> ä¸¾ä¾‹</div></pre></td></tr></table></figure><p>ä½¿ç”¨<strong>ç¬¬äºŒä¸ªå¼€å§‹</strong>çš„å­æŸ¥è¯¢ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// AbstractSelectParser.java#parseTable()ç‰‡æ®µ</div><div class="line">if (!selectStatement.getTables().isEmpty()) &#123;</div><div class="line">    throw new UnsupportedOperationException(&quot;Cannot support subquery for nested tables.&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ä½¿ç”¨å­æŸ¥è¯¢ï¼Œå»ºè®®è®¤çœŸé˜…è¯»å®˜æ–¹<a href="http://dangdangdotcom.github.io/sharding-jdbc/02-guide/subquery/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šåˆ†é¡µåŠå­æŸ¥è¯¢ã€‹</a>æ–‡æ¡£ã€‚</p><h3 id="3-4-3-parseJoinTable"><a href="#3-4-3-parseJoinTable" class="headerlink" title="3.4.3 #parseJoinTable()"></a>3.4.3 #parseJoinTable()</h3><p>MySQLSelectParser é‡å†™äº† <code>#parseJoinTable()</code> æ–¹æ³•ç”¨äºè§£æ USE / IGNORE / FORCE index_hintã€‚å…·ä½“è¯­æ³•è§ä¸Šæ–‡ <strong>JOIN Syntax</strong>ã€‚è¿™é‡Œå°±è·³è¿‡ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»çœ‹çœ‹ã€‚</p><h3 id="3-4-4-Tables-è¡¨é›†åˆå¯¹è±¡"><a href="#3-4-4-Tables-è¡¨é›†åˆå¯¹è±¡" class="headerlink" title="3.4.4 Tables è¡¨é›†åˆå¯¹è±¡"></a>3.4.4 Tables è¡¨é›†åˆå¯¹è±¡</h3><p><strong>å±äºåˆ†ç‰‡ä¸Šä¸‹æ–‡ä¿¡æ¯</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Tables.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Tables</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Table&gt; tables = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Table.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Table</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¡¨</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ«å</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Optional&lt;String&gt; alias;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// AbstractSelectParser.java#parseTableFactor()ç‰‡æ®µ</span></div><div class="line">selectStatement.getTables().add(<span class="keyword">new</span> Table(SQLUtil.getExactlyValue(literals), sqlParser.parseAlias()));</div></pre></td></tr></table></figure><h2 id="3-5-parseWhere"><a href="#3-5-parseWhere" class="headerlink" title="3.5 #parseWhere()"></a>3.5 #parseWhere()</h2><p>è§£æ WHERE æ¡ä»¶ã€‚è§£æä»£ç ï¼š<a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/?self">ã€ŠSQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æã€‹çš„#parseWhere()å°èŠ‚</a>ã€‚</p><h2 id="3-6-parseGroupBy"><a href="#3-6-parseGroupBy" class="headerlink" title="3.6 #parseGroupBy()"></a>3.6 #parseGroupBy()</h2><p>è§£æåˆ†ç»„æ¡ä»¶ï¼Œå®ç°ä¸Šæ¯”è¾ƒç±»ä¼¼ <code>#parseSelectList</code>ï¼Œä¼šæ›´åŠ ç®€å•ä¸€äº›ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æ Group By å’Œ Havingï¼ˆæš‚æ—¶ä¸æ”¯æŒï¼‰</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseGroupBy</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.GROUP)) &#123;</div><div class="line">       sqlParser.accept(DefaultKeyword.BY);</div><div class="line">       <span class="comment">// è§£æ Group By æ¯ä¸ªå­—æ®µ</span></div><div class="line">       <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">           addGroupByItem(sqlParser.parseExpression(selectStatement));</div><div class="line">           <span class="keyword">if</span> (!sqlParser.equalAny(Symbol.COMMA)) &#123;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           sqlParser.getLexer().nextToken();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">while</span> (sqlParser.equalAny(DefaultKeyword.WITH) || sqlParser.getLexer().getCurrentToken().getLiterals().equalsIgnoreCase(<span class="string">"ROLLUP"</span>)) &#123;</div><div class="line">           sqlParser.getLexer().nextToken();</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// Havingï¼ˆæš‚æ—¶ä¸æ”¯æŒï¼‰</span></div><div class="line">       <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.HAVING)) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support Having"</span>);</div><div class="line">       &#125;</div><div class="line">       selectStatement.setGroupByLastPosition(sqlParser.getLexer().getCurrentToken().getEndPosition());</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.HAVING)) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support Having"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è§£æ Group By å•ä¸ªå­—æ®µ</div><div class="line">* Group By æ¡ä»¶æ˜¯å¸¦æœ‰æ’åºåŠŸèƒ½ï¼Œé»˜è®¤ASC</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlExpression è¡¨è¾¾å¼</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addGroupByItem</span><span class="params">(<span class="keyword">final</span> SQLExpression sqlExpression)</span> </span>&#123;</div><div class="line">   <span class="comment">// Group By å­—æ®µ DESC / ASC / ;é»˜è®¤æ˜¯ ASCã€‚</span></div><div class="line">   OrderType orderByType = OrderType.ASC;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.ASC)) &#123;</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.DESC)) &#123;</div><div class="line">       orderByType = OrderType.DESC;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è§£æ OrderItem</span></div><div class="line">   OrderItem orderItem;</div><div class="line">   <span class="keyword">if</span> (sqlExpression <span class="keyword">instanceof</span> SQLPropertyExpression) &#123;</div><div class="line">       SQLPropertyExpression sqlPropertyExpression = (SQLPropertyExpression) sqlExpression;</div><div class="line">       orderItem = <span class="keyword">new</span> OrderItem(SQLUtil.getExactlyValue(sqlPropertyExpression.getOwner().getName()), SQLUtil.getExactlyValue(sqlPropertyExpression.getName()), orderByType,</div><div class="line">               getAlias(SQLUtil.getExactlyValue(sqlPropertyExpression.getOwner() + <span class="string">"."</span> + SQLUtil.getExactlyValue(sqlPropertyExpression.getName()))));</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlExpression <span class="keyword">instanceof</span> SQLIdentifierExpression) &#123;</div><div class="line">       SQLIdentifierExpression sqlIdentifierExpression = (SQLIdentifierExpression) sqlExpression;</div><div class="line">       orderItem = <span class="keyword">new</span> OrderItem(SQLUtil.getExactlyValue(sqlIdentifierExpression.getName()), orderByType, getAlias(SQLUtil.getExactlyValue(sqlIdentifierExpression.getName())));</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   selectStatement.getGroupByItems().add(orderItem);</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* å­—æ®µåœ¨æŸ¥è¯¢é¡¹é‡Œçš„åˆ«å</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> name å­—æ®µ</div><div class="line">* <span class="doctag">@return</span> åˆ«å</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Optional&lt;String&gt; <span class="title">getAlias</span><span class="params">(<span class="keyword">final</span> String name)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (selectStatement.isContainStar()) &#123;</div><div class="line">       <span class="keyword">return</span> Optional.absent();</div><div class="line">   &#125;</div><div class="line">   String rawName = SQLUtil.getExactlyValue(name);</div><div class="line">   <span class="keyword">for</span> (SelectItem each : selectStatement.getItems()) &#123;</div><div class="line">       <span class="keyword">if</span> (rawName.equalsIgnoreCase(SQLUtil.getExactlyValue(each.getExpression()))) &#123;</div><div class="line">           <span class="keyword">return</span> each.getAlias();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (rawName.equalsIgnoreCase(each.getAlias().orNull())) &#123;</div><div class="line">           <span class="keyword">return</span> Optional.of(rawName);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> Optional.absent();</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="3-6-1-OrderItem-æ’åºé¡¹"><a href="#3-6-1-OrderItem-æ’åºé¡¹" class="headerlink" title="3.6.1 OrderItem æ’åºé¡¹"></a>3.6.1 OrderItem æ’åºé¡¹</h3><p><strong>å±äºåˆ†ç‰‡ä¸Šä¸‹æ–‡ä¿¡æ¯</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderItem</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * æ‰€å±è¡¨åˆ«å</div><div class="line">    */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Optional&lt;String&gt; owner;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * æ’åºå­—æ®µ</div><div class="line">    */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Optional&lt;String&gt; name;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * æ’åºç±»å‹</div><div class="line">    */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderType type;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * æŒ‰ç…§ç¬¬å‡ ä¸ªæŸ¥è¯¢å­—æ®µæ’åº</div><div class="line">    * ORDER BY æ•°å­— çš„ æ•°å­—ä»£è¡¨çš„æ˜¯ç¬¬å‡ ä¸ªå­—æ®µ</div><div class="line">    */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index = -<span class="number">1</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * å­—æ®µåœ¨æŸ¥è¯¢é¡¹(&#123;<span class="doctag">@link</span> com.dangdang.ddframe.rdb.sharding.parsing.parser.context.selectitem.SelectItem&#125; çš„åˆ«å</div><div class="line">    */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> Optional&lt;String&gt; alias;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="3-7-parseOrderBy"><a href="#3-7-parseOrderBy" class="headerlink" title="3.7 #parseOrderBy()"></a>3.7 #parseOrderBy()</h2><p>è§£ææ’åºæ¡ä»¶ã€‚å®ç°é€»è¾‘ç±»ä¼¼ <code>#parseGroupBy()</code>ï¼Œè¿™é‡Œå°±è·³è¿‡ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»çœ‹çœ‹ã€‚</p><h2 id="3-8-parseLimit"><a href="#3-8-parseLimit" class="headerlink" title="3.8 #parseLimit()"></a>3.8 #parseLimit()</h2><p>è§£æåˆ†é¡µ Limit æ¡ä»¶ã€‚ç›¸å¯¹ç®€å•ï¼Œè¿™é‡Œå°±è·³è¿‡ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»çœ‹çœ‹ã€‚æ³¨æ„ä¸‹ï¼Œåˆ†æˆ 3 ç§æƒ…å†µï¼š</p><ul><li>LIMIT row_count</li><li>LIMIT offset, row_count</li><li>LIMIT row_count OFFSET offset</li></ul><h3 id="3-8-1-Limit"><a href="#3-8-1-Limit" class="headerlink" title="3.8.1 Limit"></a>3.8.1 Limit</h3><p>åˆ†é¡µå¯¹è±¡ã€‚<strong>å±äºåˆ†ç‰‡ä¸Šä¸‹æ–‡ä¿¡æ¯</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Limit.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Limit</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ˜¯å¦é‡å†™rowCount</div><div class="line">     * TODO å¾…è¡¥å……ï¼šé¢„è®¡å’Œå†…å­˜åˆ†é¡µåˆå¹¶æœ‰å…³</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> rowCountRewriteFlag;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * offset</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> LimitValue offset;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * row</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> LimitValue rowCount;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// LimitValue.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LimitValue</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å€¼</div><div class="line">     * å½“ value == -1 æ—¶ï¼Œä¸ºå ä½ç¬¦</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> value;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç¬¬å‡ ä¸ªå ä½ç¬¦</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="3-8-2-OffsetToken-RowCountToken"><a href="#3-8-2-OffsetToken-RowCountToken" class="headerlink" title="3.8.2 OffsetToken RowCountToken"></a>3.8.2 OffsetToken RowCountToken</h3><ul><li>OffsetTokenï¼šåˆ†é¡µåç§»é‡æ ‡è®°å¯¹è±¡</li><li>RowCountTokenï¼šåˆ†é¡µé•¿åº¦æ ‡è®°å¯¹è±¡</li></ul><p><strong>åªæœ‰åœ¨å¯¹åº”ä½ç½®éå ä½ç¬¦æ‰æœ‰è¯¥ SQLToken</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// OffsetToken.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OffsetToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL æ‰€åœ¨å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åç§»å€¼</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> offset;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RowCountToken.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RowCountToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL æ‰€åœ¨å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¡Œæ•°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> rowCount;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="3-9-queryRest"><a href="#3-9-queryRest" class="headerlink" title="3.9 #queryRest()"></a>3.9 #queryRest()</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">queryRest</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.UNION, DefaultKeyword.EXCEPT, DefaultKeyword.INTERSECT, DefaultKeyword.MINUS)) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(sqlParser.getLexer().getCurrentToken().getType());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ä¸æ”¯æŒ UNION / EXCEPT / INTERSECT / MINUS ï¼Œè°ƒç”¨ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p><h1 id="4-appendDerivedç­‰æ–¹æ³•"><a href="#4-appendDerivedç­‰æ–¹æ³•" class="headerlink" title="4. appendDerivedç­‰æ–¹æ³•"></a>4. appendDerivedç­‰æ–¹æ³•</h1><p>å› ä¸º Sharding-JDBC å¯¹è¡¨åšäº†åˆ†ç‰‡ï¼Œåœ¨ AVG , GROUP BY , ORDER BY éœ€è¦å¯¹ SQL è¿›è¡Œä¸€äº›æ”¹å†™ï¼Œ<strong>ä»¥è¾¾åˆ°èƒ½åœ¨å†…å­˜é‡Œå¯¹ç»“æœåšè¿›ä¸€æ­¥å¤„ç†</strong>ï¼Œä¾‹å¦‚æ±‚å¹³å‡å€¼ã€åˆ†ç»„ã€æ’åºç­‰ã€‚</p><p>ğŸ˜ˆï¼šæ‰“èµ·ç²¾ç¥ï¼Œæ­¤å—æ˜¯éå¸¸æœ‰è¶£çš„ã€‚</p><h2 id="4-1-appendAvgDerivedColumns"><a href="#4-1-appendAvgDerivedColumns" class="headerlink" title="4.1 appendAvgDerivedColumns"></a>4.1 appendAvgDerivedColumns</h2><p>è§£å†³ AVG æŸ¥è¯¢ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* é’ˆå¯¹ AVG èšåˆå­—æ®µï¼Œå¢åŠ æ¨å¯¼å­—æ®µ</div><div class="line">* AVG æ”¹å†™æˆ SUM + COUNT æŸ¥è¯¢ï¼Œå†…å­˜è®¡ç®—å‡º AVG ç»“æœã€‚</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> itemsToken é€‰æ‹©é¡¹æ ‡è®°å¯¹è±¡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendAvgDerivedColumns</span><span class="params">(<span class="keyword">final</span> ItemsToken itemsToken)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> derivedColumnOffset = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (SelectItem each : selectStatement.getItems()) &#123;</div><div class="line">       <span class="keyword">if</span> (!(each <span class="keyword">instanceof</span> AggregationSelectItem) || AggregationType.AVG != ((AggregationSelectItem) each).getType()) &#123;</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       AggregationSelectItem avgItem = (AggregationSelectItem) each;</div><div class="line">       <span class="comment">// COUNT å­—æ®µ</span></div><div class="line">       String countAlias = String.format(DERIVED_COUNT_ALIAS, derivedColumnOffset);</div><div class="line">       AggregationSelectItem countItem = <span class="keyword">new</span> AggregationSelectItem(AggregationType.COUNT, avgItem.getInnerExpression(), Optional.of(countAlias));</div><div class="line">       <span class="comment">// SUM å­—æ®µ</span></div><div class="line">       String sumAlias = String.format(DERIVED_SUM_ALIAS, derivedColumnOffset);</div><div class="line">       AggregationSelectItem sumItem = <span class="keyword">new</span> AggregationSelectItem(AggregationType.SUM, avgItem.getInnerExpression(), Optional.of(sumAlias));</div><div class="line">       <span class="comment">// AggregationSelectItem è®¾ç½®</span></div><div class="line">       avgItem.getDerivedAggregationSelectItems().add(countItem);</div><div class="line">       avgItem.getDerivedAggregationSelectItems().add(sumItem);</div><div class="line">       <span class="comment">// TODO å°†AVGåˆ—æ›¿æ¢æˆå¸¸æ•°ï¼Œé¿å…æ•°æ®åº“å†è®¡ç®—æ— ç”¨çš„AVGå‡½æ•°</span></div><div class="line">       <span class="comment">// ItemsToken</span></div><div class="line">       itemsToken.getItems().add(countItem.getExpression() + <span class="string">" AS "</span> + countAlias + <span class="string">" "</span>);</div><div class="line">       itemsToken.getItems().add(sumItem.getExpression() + <span class="string">" AS "</span> + sumAlias + <span class="string">" "</span>);</div><div class="line">       <span class="comment">//</span></div><div class="line">       derivedColumnOffset++;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="4-2-appendDerivedOrderColumns"><a href="#4-2-appendDerivedOrderColumns" class="headerlink" title="4.2 appendDerivedOrderColumns"></a>4.2 appendDerivedOrderColumns</h2><p>è§£å†³ GROUP BY , ORDER BYã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* é’ˆå¯¹ GROUP BY æˆ– ORDER BY å­—æ®µï¼Œå¢åŠ æ¨å¯¼å­—æ®µ</div><div class="line">* å¦‚æœè¯¥å­—æ®µä¸åœ¨æŸ¥è¯¢å­—æ®µé‡Œï¼Œéœ€è¦é¢å¤–æŸ¥è¯¢è¯¥å­—æ®µï¼Œè¿™æ ·æ‰èƒ½åœ¨å†…å­˜é‡Œ GROUP BY æˆ– ORDER BY</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> itemsToken é€‰æ‹©é¡¹æ ‡è®°å¯¹è±¡</div><div class="line">* <span class="doctag">@param</span> orderItems æ’åºå­—æ®µ</div><div class="line">* <span class="doctag">@param</span> aliasPattern åˆ«åæ¨¡å¼</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendDerivedOrderColumns</span><span class="params">(<span class="keyword">final</span> ItemsToken itemsToken, <span class="keyword">final</span> List&lt;OrderItem&gt; orderItems, <span class="keyword">final</span> String aliasPattern)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> derivedColumnOffset = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (OrderItem each : orderItems) &#123;</div><div class="line">       <span class="keyword">if</span> (!isContainsItem(each)) &#123;</div><div class="line">           String alias = String.format(aliasPattern, derivedColumnOffset++);</div><div class="line">           each.setAlias(Optional.of(alias));</div><div class="line">           itemsToken.getItems().add(each.getQualifiedName().get() + <span class="string">" AS "</span> + alias + <span class="string">" "</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* æŸ¥è¯¢å­—æ®µæ˜¯å¦åŒ…å«æ’åºå­—æ®µ</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> orderItem æ’åºå­—æ®µ</div><div class="line">* <span class="doctag">@return</span> æ˜¯å¦</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isContainsItem</span><span class="params">(<span class="keyword">final</span> OrderItem orderItem)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (selectStatement.isContainStar()) &#123; <span class="comment">// SELECT *</span></div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (SelectItem each : selectStatement.getItems()) &#123;</div><div class="line">       <span class="keyword">if</span> (-<span class="number">1</span> != orderItem.getIndex()) &#123; <span class="comment">// ORDER BY ä½¿ç”¨æ•°å­—</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (each.getAlias().isPresent() &amp;&amp; orderItem.getAlias().isPresent() &amp;&amp; each.getAlias().get().equalsIgnoreCase(orderItem.getAlias().get())) &#123; <span class="comment">// å­—æ®µåˆ«åæ¯”è¾ƒ</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!each.getAlias().isPresent() &amp;&amp; orderItem.getQualifiedName().isPresent() &amp;&amp; each.getExpression().equalsIgnoreCase(orderItem.getQualifiedName().get())) &#123; <span class="comment">// å­—æ®µåŸåæ¯”è¾ƒ</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="4-3-ItemsToken"><a href="#4-3-ItemsToken" class="headerlink" title="4.3 ItemsToken"></a>4.3 ItemsToken</h2><p>é€‰æ‹©é¡¹æ ‡è®°å¯¹è±¡ï¼Œ<strong>å±äºåˆ†ç‰‡ä¸Šä¸‹æ–‡ä¿¡æ¯</strong>ï¼Œç›®å‰æœ‰ 3 ä¸ªæƒ…å†µä¼šåˆ›å»ºï¼š</p><ol><li><code>AVG</code> æŸ¥è¯¢é¢å¤– COUNT å’Œ SUMï¼š<code>#appendAvgDerivedColumns()</code></li><li><code>GROUP BY</code> ä¸åœ¨ æŸ¥è¯¢å­—æ®µï¼Œé¢å¤–æŸ¥è¯¢è¯¥å­—æ®µ ï¼š<code>#appendDerivedOrderColumns()</code></li><li><code>ORDER BY</code> ä¸åœ¨ æŸ¥è¯¢å­—æ®µï¼Œé¢å¤–æŸ¥è¯¢è¯¥å­—æ®µ ï¼š<code>#appendDerivedOrderColumns()</code></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemsToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å­—æ®µåæ•°ç»„</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; items = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="4-4-appendDerivedOrderBy"><a href="#4-4-appendDerivedOrderBy" class="headerlink" title="4.4 appendDerivedOrderBy()"></a>4.4 appendDerivedOrderBy()</h2><p>å½“ SQL æœ‰èšåˆæ¡ä»¶è€Œæ— æ’åºæ¡ä»¶ï¼Œæ ¹æ®èšåˆæ¡ä»¶è¿›è¡Œæ’åºã€‚è¿™æ˜¯æ•°æ®åº“è‡ªå·±çš„æ‰§è¡Œè§„åˆ™ã€‚</p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">mysql&gt; SELECT order_id FROM t_order GROUP BY order_id;</div><div class="line">+----------+</div><div class="line">| order_id |</div><div class="line">+----------+</div><div class="line">| 1        |</div><div class="line">| 2        |</div><div class="line">| 3        |</div><div class="line">+----------+</div><div class="line">3 rows in set (0.05 sec)</div><div class="line"></div><div class="line">mysql&gt; SELECT order_id FROM t_order GROUP BY order_id DESC;</div><div class="line">+----------+</div><div class="line">| order_id |</div><div class="line">+----------+</div><div class="line">| 3        |</div><div class="line">| 2        |</div><div class="line">| 1        |</div><div class="line">+----------+</div><div class="line">3 rows in set (0.02 sec)</div></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* å½“æ—  Order By æ¡ä»¶æ—¶ï¼Œä½¿ç”¨ Group By ä½œä¸ºæ’åºæ¡ä»¶ï¼ˆæ•°æ®åº“æœ¬èº«è§„åˆ™ï¼‰</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendDerivedOrderBy</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!getSelectStatement().getGroupByItems().isEmpty() &amp;&amp; getSelectStatement().getOrderByItems().isEmpty()) &#123;</div><div class="line">       getSelectStatement().getOrderByItems().addAll(getSelectStatement().getGroupByItems());</div><div class="line">       getSelectStatement().getSqlTokens().add(<span class="keyword">new</span> OrderByToken(getSelectStatement().getGroupByLastPosition()));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="4-3-1-OrderByToken"><a href="#4-3-1-OrderByToken" class="headerlink" title="4.3.1 OrderByToken"></a>4.3.1 OrderByToken</h3><p>æ’åºæ ‡è®°å¯¹è±¡ã€‚å½“æ—  Order By æ¡ä»¶æ—¶ï¼Œä½¿ç”¨ Group By ä½œä¸ºæ’åºæ¡ä»¶ï¼ˆæ•°æ®åº“æœ¬èº«è§„åˆ™ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// OrderByToken.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderByToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL æ‰€åœ¨å¼€å§‹ä½ç½®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å’³å’³å’³ï¼Œç¡®å®æœ‰ä¸€äº›ç•¥é•¿ã€‚ä½†è¯·ç›¸ä¿¡ï¼ŒINSERT / UPDATE / DELETE ä¼šç®€å•å¾ˆå¤šå¾ˆå¤šã€‚è€ƒè¯•è€ƒçš„ SQL æœ€å¤šçš„æ˜¯ä»€ä¹ˆï¼ŸSELECT è¯­å¥å‘€ï¼ä¸ºå•¥ï¼Œéš¾å‘—ã€‚æ©ï¼Œæˆ‘ç›¸ä¿¡çœ‹åˆ°æ­¤å¤„çš„ä½ ï¼Œä¸€å®šæ˜¯èƒ½çœ‹æ‡‚çš„ï¼ŒåŠ æ²¹ï¼</p><p>ğŸ™‚å¦‚æœå¯¹æœ¬æ–‡æœ‰ä¸ç†è§£çš„åœ°æ–¹ï¼Œå¯ä»¥å…³æ³¨æˆ‘çš„å…¬ä¼—å·<strong>ï¼ˆ<a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">èŠ‹é“æºç </a>ï¼‰</strong>è·å¾—<strong>å¾®ä¿¡å·</strong>ï¼Œæˆ‘ä»¬æ¥ä¸€åœºï¼Œ1 å¯¹ 1 çš„æåŸºå§ï¼Œä¸ä¸ä¸ï¼Œæ˜¯äº¤æµäº¤æµã€‚</p><p>é“å‹ï¼Œå¸®æˆ‘åˆ†äº«ä¸€æ³¢æ€ä¹ˆæ ·ï¼Ÿ</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/Sharding-JDBC/">Sharding-JDBC</a></div><div class="article-share" id="share"><div data-url="http://www.iocoder.cn/Sharding-JDBC/sql-parse-3/" data-title="Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆä¸‰ï¼‰ä¹‹æŸ¥è¯¢SQL | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/Sharding-JDBC/sql-parse-4/" title="Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆå››ï¼‰ä¹‹æ’å…¥SQL"><strong>PREVIOUS:</strong><br><span>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆå››ï¼‰ä¹‹æ’å…¥SQL</span></a></div><div class="next"><a href="/Sharding-JDBC/sql-parse-2/" title="Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æ"><strong>NEXT:</strong><br><span>Sharding-JDBC æºç åˆ†æ â€”â€” SQL è§£æï¼ˆäºŒï¼‰ä¹‹SQLè§£æ</span></a></div></nav></div></div><footer><div id="footer"><img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display:none"><p class="copyright">Â© 2017 <a href="http://www.iocoder.cn" target="_blank" title="ç‹æ–‡æ–Œ">ç‹æ–‡æ–Œ</a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a> && Powered by <a href="http://hexo.io" target="_blank" title="hexo" rel="external nofollow noopener noreferrer">hexo</a> && Theme by <a href="http://gengbiao.me" target="_blank" title="coney" rel="external nofollow noopener noreferrer">coney</a></p></div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2"),ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script src="/js/util.js"></script></body>