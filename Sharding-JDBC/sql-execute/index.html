<!DOCTYPE html>
<html lang="zh">
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E">
    <meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0">
    <meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1">
    <meta name="sogou_site_verification" content="MpPsku240L">
    <meta name="description" content="ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘æœ‰ç¦åˆ©ï¼š    RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨   RocketMQ / MyCAT / Sharding-JDBC ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€   æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢ã€‚   æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ã€‚æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³ã€‚   è®¤">
<meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢">
<meta property="og:type" content="article">
<meta property="og:title" content="Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ">
<meta property="og:url" content="http://www.yunai.me/Sharding-JDBC/sql-execute/index.html">
<meta property="og:site_name" content="èŠ‹è‰¿Vçš„åšå®¢">
<meta property="og:description" content="ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘æœ‰ç¦åˆ©ï¼š    RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨   RocketMQ / MyCAT / Sharding-JDBC ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€   æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢ã€‚   æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ã€‚æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³ã€‚   è®¤">
<meta property="og:image" content="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/01.png">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/06.png">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/02.png">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/03.gif">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/04.png">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/05.png">
<meta property="og:updated_time" content="2017-08-04T18:07:37.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ">
<meta name="twitter:description" content="ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘æœ‰ç¦åˆ©ï¼š    RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨   RocketMQ / MyCAT / Sharding-JDBC ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€   æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢ã€‚   æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ã€‚æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³ã€‚   è®¤">
<meta name="twitter:image" content="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ</title>
    <!-- keywords -->
    
    <meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢">
    
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    


    <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
    <script>AV.initialize("uxUSudJeAFuAk0PKwFMY7MJW-gzGzoHsz", "NTPUE2VIEE0gyPPGbAaLPtLb");</script>
    <!-- ç™¾åº¦ç»Ÿè®¡ -->
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ef4ed89f6dc83d01803a2440ae21e666";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    <!-- ç™¾åº¦ç«™é•¿-è¢«åŠ¨æ¨é€ -->
    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

    <!-- 360æœç´¢-è‡ªåŠ¨æ”¶å½• -->
    <script>
        (function(){
            var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";
            document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:visible;">
    <i class="fa fa-chevron-up fa-lg"></i>
  </a>
  <span id="menu" style="visibility: visible;">
    <span id="nav">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="http://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">GitHub</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/Sharding-JDBC/distributed-id/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$(" #i-next").toggle();"="" onmouseout="$("></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$(" #i-top").toggle();"="" onmouseout="$("></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$(" #i-share").toggle();"="" onmouseout="$(" onclick="$(" #share").toggle();return="" false;"=""></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/Sharding-JDBC/sql-execute/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/Sharding-JDBC/sql-execute/&text=Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/Sharding-JDBC/sql-execute/&title=Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/Sharding-JDBC/sql-execute/&is_video=false&description=Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ&body=Check out this article: http://www.yunai.me/Sharding-JDBC/sql-execute/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/Sharding-JDBC/sql-execute/&title=Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/Sharding-JDBC/sql-execute/&title=Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/Sharding-JDBC/sql-execute/&title=Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/Sharding-JDBC/sql-execute/&title=Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/Sharding-JDBC/sql-execute/&name=Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-ExecutorEngine"><span class="toc-number">2.</span> <span class="toc-text">2. ExecutorEngine</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-ListeningExecutorService"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 ListeningExecutorService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-å…³é—­"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 å…³é—­</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-æ‰§è¡Œ-SQL-ä»»åŠ¡"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 æ‰§è¡Œ SQL ä»»åŠ¡</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Executor"><span class="toc-number">3.</span> <span class="toc-text">3. Executor</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-StatementExecutor"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 StatementExecutor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-PreparedStatementExecutor"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 PreparedStatementExecutor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-BatchPreparedStatementExecutor"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 BatchPreparedStatementExecutor</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-ExecutionEvent"><span class="toc-number">4.</span> <span class="toc-text">4. ExecutionEvent</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-EventBus"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 EventBus</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-BestEffortsDeliveryListener"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 BestEffortsDeliveryListener</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-å½©è›‹"><span class="toc-number">5.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">èŠ‹è‰¿Vçš„åšå®¢</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-08-13T16:00:00.000Z" itemprop="datePublished">2017-08-14</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. æ¦‚è¿°</a></li>
<li><a href="#">2. ExecutorEngine</a><ul>
<li><a href="#">2.1 ListeningExecutorService</a></li>
<li><a href="#">2.2 å…³é—­</a></li>
<li><a href="#">2.3 æ‰§è¡Œ SQL ä»»åŠ¡</a></li>
</ul>
</li>
<li><a href="#">3. Executor</a><ul>
<li><a href="#">3.1 StatementExecutor</a></li>
<li><a href="#">3.2 PreparedStatementExecutor</a></li>
<li><a href="#">3.3 BatchPreparedStatementExecutor</a></li>
</ul>
</li>
<li><a href="#">4. ExecutionEvent</a><ul>
<li><a href="#">4.1 EventBus</a></li>
<li><a href="#">4.2 BestEffortsDeliveryListener</a></li>
</ul>
</li>
<li><a href="#">666. å½©è›‹</a></li>
</ul>
<hr>
<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>è¶Šè¿‡åƒå±±ä¸‡æ°´ï¼ˆSQL è§£æã€SQL è·¯ç”±ã€SQL æ”¹å†™ï¼‰ï¼Œæˆ‘ä»¬ç»ˆäºæ¥åˆ°äº† <strong>SQL æ‰§è¡Œ</strong>ã€‚å¼€æ£®ä¸å¼€æ£®ï¼Ÿï¼</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/01.png" alt=""></p>
<p>æœ¬æ–‡ä¸»è¦åˆ†äº«<strong>SQL æ‰§è¡Œ</strong>çš„è¿‡ç¨‹ï¼Œä¸åŒ…æ‹¬<strong>ç»“æœèšåˆ</strong>ã€‚<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€Šç»“æœèšåˆã€‹</a> <strong>ä¸œåŠçƒç¬¬äºŒè‰¯å¿ƒç¬”è€…</strong>ä¼šæ›´æ–°ï¼Œå…³æ³¨å¾®ä¿¡å…¬ä¼—å·<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</a>å®Œç¨¿å<strong>ç¬¬ä¸€æ—¶é—´</strong>é€šçŸ¥æ‚¨å“Ÿã€‚</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/06.png" alt=""></p>
<p><strong>ç»¿æ¡†éƒ¨åˆ†</strong> SQL æ‰§è¡Œä¸»æµç¨‹ã€‚</p>
<h1 id="2-ExecutorEngine"><a href="#2-ExecutorEngine" class="headerlink" title="2. ExecutorEngine"></a>2. ExecutorEngine</h1><p>ExecutorEngineï¼ŒSQLæ‰§è¡Œå¼•æ“ã€‚</p>
<p>åˆ†è¡¨åˆ†åº“ï¼Œéœ€è¦æ‰§è¡Œçš„ SQL æ•°é‡ä»å•æ¡å˜æˆäº†å¤šæ¡ï¼Œæ­¤æ—¶æœ‰ä¸¤ç§æ–¹å¼æ‰§è¡Œï¼š</p>
<ul>
<li><strong>ä¸²è¡Œ</strong>æ‰§è¡Œ SQL</li>
<li><strong>å¹¶è¡Œ</strong>æ‰§è¡Œ SQL</li>
</ul>
<p>å‰è€…ï¼Œç¼–ç å®¹æ˜“ï¼Œæ€§èƒ½è¾ƒå·®ï¼Œæ€»è€—æ—¶æ˜¯å¤šæ¡ SQL æ‰§è¡Œæ—¶é—´ç´¯åŠ ã€‚<br>åè€…ï¼Œç¼–ç å¤æ‚ï¼Œæ€§èƒ½è¾ƒå¥½ï¼Œæ€»è€—æ—¶çº¦ç­‰äºæ‰§è¡Œæ—¶é—´æœ€é•¿çš„ SQLã€‚</p>
<p>ğŸ‘¼ ExecutorEngine å½“ç„¶é‡‡ç”¨çš„æ˜¯<strong>åè€…</strong>ï¼Œå¹¶è¡Œæ‰§è¡Œ SQLã€‚</p>
<h2 id="2-1-ListeningExecutorService"><a href="#2-1-ListeningExecutorService" class="headerlink" title="2.1 ListeningExecutorService"></a>2.1 ListeningExecutorService</h2><p><a href="http://www.yiibai.com/guava/" rel="external nofollow noopener noreferrer" target="_blank">Guava( Java å·¥å…·åº“ )</a> æä¾›çš„ç»§æ‰¿è‡ª  ExecutorService çš„<strong>çº¿ç¨‹æœåŠ¡æ¥å£</strong>ï¼Œæä¾›åˆ›å»º ListenableFuture åŠŸèƒ½ã€‚ListenableFuture æ¥å£ï¼Œç»§æ‰¿ Future æ¥å£ï¼Œæœ‰å¦‚ä¸‹å¥½å¤„ï¼š</p>
<blockquote>
<p>æˆ‘ä»¬å¼ºçƒˆåœ°å»ºè®®ä½ åœ¨ä»£ç ä¸­å¤šä½¿ç”¨ListenableFutureæ¥ä»£æ›¿JDKçš„ Future, å› ä¸ºï¼š  </p>
<ul>
<li>å¤§å¤šæ•°Futures æ–¹æ³•ä¸­éœ€è¦å®ƒã€‚  </li>
<li>è½¬åˆ°ListenableFuture ç¼–ç¨‹æ¯”è¾ƒå®¹æ˜“ã€‚  </li>
<li>Guavaæä¾›çš„é€šç”¨å…¬å…±ç±»å°è£…äº†å…¬å…±çš„æ“ä½œæ–¹æ–¹æ³•ï¼Œä¸éœ€è¦æä¾›Futureå’ŒListenableFutureçš„æ‰©å±•æ–¹æ³•ã€‚  </li>
</ul>
<p>ä¼ ç»ŸJDKä¸­çš„Futureé€šè¿‡å¼‚æ­¥çš„æ–¹å¼è®¡ç®—è¿”å›ç»“æœ:åœ¨å¤šçº¿ç¨‹è¿ç®—ä¸­å¯èƒ½æˆ–è€…å¯èƒ½åœ¨æ²¡æœ‰ç»“æŸè¿”å›ç»“æœï¼ŒFutureæ˜¯è¿è¡Œä¸­çš„å¤šçº¿ç¨‹çš„ä¸€ä¸ªå¼•ç”¨å¥æŸ„ï¼Œç¡®ä¿åœ¨æœåŠ¡æ‰§è¡Œè¿”å›ä¸€ä¸ªResultã€‚   </p>
<p>ListenableFutureå¯ä»¥å…è®¸ä½ æ³¨å†Œå›è°ƒæ–¹æ³•(callbacks)ï¼Œåœ¨è¿ç®—ï¼ˆå¤šçº¿ç¨‹æ‰§è¡Œï¼‰å®Œæˆçš„æ—¶å€™è¿›è¡Œè°ƒç”¨,  æˆ–è€…åœ¨è¿ç®—ï¼ˆå¤šçº¿ç¨‹æ‰§è¡Œï¼‰å®Œæˆåç«‹å³æ‰§è¡Œã€‚è¿™æ ·ç®€å•çš„æ”¹è¿›ï¼Œä½¿å¾—å¯ä»¥æ˜æ˜¾çš„æ”¯æŒæ›´å¤šçš„æ“ä½œï¼Œè¿™æ ·çš„åŠŸèƒ½åœ¨JDK concurrentä¸­çš„Futureæ˜¯ä¸æ”¯æŒçš„ã€‚</p>
</blockquote>
<p>å¦‚ä¸Šå†…å®¹æ¥è‡ª<a href="http://ifeve.com/google-guava-listenablefuture/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠGoogle GuavaåŒ…çš„ListenableFutureè§£æ<br>ã€‹</a>ï¼Œæ–‡ç« å†™çš„å¾ˆæ£’ã€‚ä¸‹æ–‡ä½ ä¼šçœ‹åˆ° Sharding-JDBC æ˜¯<strong>å¦‚ä½•é€šè¿‡ ListenableFuture ç®€åŒ–å¹¶å‘ç¼–ç¨‹çš„</strong>ã€‚</p>
<p>ä¸‹é¢çœ‹çœ‹ ExecutorEngine å¦‚ä½•<strong>åˆå§‹åŒ–</strong> ListeningExecutorService </p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingDataSource.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ShardingDataSource</span><span class="params">(<span class="keyword">final</span> ShardingRule shardingRule, <span class="keyword">final</span> Properties props)</span> </span>&#123;</div><div class="line">    <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">   shardingProperties = <span class="keyword">new</span> ShardingProperties(props);</div><div class="line">   <span class="keyword">int</span> executorSize = shardingProperties.getValue(ShardingPropertiesConstant.EXECUTOR_SIZE);</div><div class="line">   executorEngine = <span class="keyword">new</span> ExecutorEngine(executorSize);</div><div class="line">   <span class="comment">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ExecutorEngine</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ExecutorEngine</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> executorSize)</span> </span>&#123;</div><div class="line">   executorService = MoreExecutors.listeningDecorator(<span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">           executorSize, executorSize, <span class="number">0</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(),</div><div class="line">           <span class="keyword">new</span> ThreadFactoryBuilder().setDaemon(<span class="keyword">true</span>).setNameFormat(<span class="string">"ShardingJDBC-%d"</span>).build()));</div><div class="line">   MoreExecutors.addDelayedShutdownHook(executorService, <span class="number">60</span>, TimeUnit.SECONDS);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä¸€ä¸ªåˆ†ç‰‡æ•°æ®æº( ShardingDataSource ) <strong>ç‹¬å </strong> ä¸€ä¸ª SQLæ‰§è¡Œå¼•æ“( ExecutorEngine )ã€‚</li>
<li><code>MoreExecutors#listeningDecorator()</code> åˆ›å»º ListeningExecutorServiceï¼Œè¿™æ · <code>#submit()</code>ï¼Œ<code>#invokeAll()</code> å¯ä»¥è¿”å› ListenableFutureã€‚</li>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ± å¤§å°ä¸º <strong>8</strong>ã€‚å¯ä»¥æ ¹æ®å®é™…ä¸šåŠ¡éœ€è¦ï¼Œè®¾ç½® ShardingProperties è¿›è¡Œè°ƒæ•´ã€‚</li>
<li><code>#setNameFormat()</code> å¹¶å‘ç¼–ç¨‹æ—¶ï¼Œä¸€å®šè¦å¯¹çº¿ç¨‹åå­—åšä¸‹å®šä¹‰ï¼Œè¿™æ ·æ’æŸ¥é—®é¢˜ä¼šæ–¹ä¾¿å¾ˆå¤šã€‚</li>
<li><code>MoreExecutors#addDelayedShutdownHook()</code>ï¼Œ<strong>åº”ç”¨å…³é—­</strong>æ—¶ï¼Œç­‰å¾…<strong>æ‰€æœ‰ä»»åŠ¡å…¨éƒ¨å®Œæˆ</strong>å†å…³é—­ã€‚é»˜è®¤é…ç½®ç­‰å¾…æ—¶é—´ä¸º 60 ç§’ï¼Œ<strong>å»ºè®®</strong>å°†ç­‰å¾…æ—¶é—´åšæˆå¯é…çš„ã€‚</li>
</ul>
<h2 id="2-2-å…³é—­"><a href="#2-2-å…³é—­" class="headerlink" title="2.2 å…³é—­"></a>2.2 å…³é—­</h2><p>æ•°æ®æºå…³é—­æ—¶ï¼Œä¼šè°ƒç”¨ ExecutorEngine ä¹Ÿè¿›è¡Œå…³é—­ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingDataSource.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</div><div class="line">   executorEngine.close();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ExecutorEngine</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</div><div class="line">   executorService.shutdownNow();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       executorService.awaitTermination(<span class="number">5</span>, TimeUnit.SECONDS);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException ignored) &#123;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (!executorService.isTerminated()) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ShardingJdbcException(<span class="string">"ExecutorEngine can not been terminated"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#shutdownNow()</code> å°è¯•ä½¿ç”¨ <code>Thread.interrupt()</code> æ‰“æ–­æ­£åœ¨æ‰§è¡Œä¸­çš„ä»»åŠ¡ï¼Œæœªæ‰§è¡Œçš„ä»»åŠ¡ä¸å†æ‰§è¡Œã€‚<strong>å»ºè®®</strong>æ‰“å°ä¸‹å“ªäº›ä»»åŠ¡æœªæ‰§è¡Œï¼Œå› ä¸º SQL æœªæ‰§è¡Œï¼Œå¯èƒ½æ•°æ®æœªèƒ½æŒä¹…åŒ–ã€‚</li>
<li><code>#awaitTermination()</code> å› ä¸º <code>#shutdownNow()</code> æ‰“æ–­ä¸æ˜¯<strong>ç«‹å³</strong>ç»“æŸï¼Œéœ€è¦ä¸€ä¸ªè¿‡ç¨‹ï¼Œå› æ­¤è¿™é‡Œ<strong>ç­‰å¾…</strong>äº† 5 ç§’ã€‚</li>
<li><strong>ç­‰å¾…</strong> 5 ç§’åï¼Œçº¿ç¨‹æ± ä¸ä¸€å®šå·²ç»å…³é—­ï¼Œæ­¤æ—¶æŠ›å‡ºå¼‚å¸¸ç»™ä¸Šå±‚ã€‚<strong>å»ºè®®</strong>æ‰“å°ä¸‹æ—¥å¿—ï¼Œè®°å½•å‡ºç°è¿™ä¸ªæƒ…å†µã€‚</li>
</ul>
<h2 id="2-3-æ‰§è¡Œ-SQL-ä»»åŠ¡"><a href="#2-3-æ‰§è¡Œ-SQL-ä»»åŠ¡" class="headerlink" title="2.3 æ‰§è¡Œ SQL ä»»åŠ¡"></a>2.3 æ‰§è¡Œ SQL ä»»åŠ¡</h2><p>ExecutorEngine å¯¹å¤–æš´éœ² <code>#executeStatement()</code>ï¼Œ<code>#executePreparedStatement()</code>ï¼Œ<code>#executeBatch()</code> </p>
<p>ä¸‰ä¸ªæ–¹æ³•åˆ†åˆ«æä¾›ç»™ StatementExecutorã€PreparedStatementExecutorã€BatchPreparedStatementExecutor è°ƒç”¨ã€‚è€Œè¿™ä¸‰ä¸ªæ–¹æ³•ï¼Œå†…éƒ¨è°ƒç”¨çš„éƒ½æ˜¯ <code>#execute()</code> ç§æœ‰æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ExecutorEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡ŒStatement.</div><div class="line">* <span class="doctag">@param</span> sqlType SQLç±»å‹</div><div class="line">* <span class="doctag">@param</span> statementUnits è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒé›†åˆ</div><div class="line">* <span class="doctag">@param</span> executeCallback æ‰§è¡Œå›è°ƒå‡½æ•°</div><div class="line">* <span class="doctag">@param</span> &lt;T&gt; è¿”å›å€¼ç±»å‹</div><div class="line">* <span class="doctag">@return</span> æ‰§è¡Œç»“æœ</div><div class="line">*/</div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">executeStatement</span><span class="params">(<span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;StatementUnit&gt; statementUnits, <span class="keyword">final</span> ExecuteCallback&lt;T&gt; executeCallback)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> execute(sqlType, statementUnits, Collections.&lt;List&lt;Object&gt;&gt;emptyList(), executeCallback);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡ŒPreparedStatement.</div><div class="line">* <span class="doctag">@param</span> sqlType SQLç±»å‹</div><div class="line">* <span class="doctag">@param</span> preparedStatementUnits è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒé›†åˆ</div><div class="line">* <span class="doctag">@param</span> parameters å‚æ•°åˆ—è¡¨</div><div class="line">* <span class="doctag">@param</span> executeCallback æ‰§è¡Œå›è°ƒå‡½æ•°</div><div class="line">* <span class="doctag">@param</span> &lt;T&gt; è¿”å›å€¼ç±»å‹</div><div class="line">* <span class="doctag">@return</span> æ‰§è¡Œç»“æœ</div><div class="line">*/</div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">executePreparedStatement</span><span class="params">(</span></span></div><div class="line">       <span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;PreparedStatementUnit&gt; preparedStatementUnits, <span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> ExecuteCallback&lt;T&gt; executeCallback) &#123;</div><div class="line">   <span class="keyword">return</span> execute(sqlType, preparedStatementUnits, Collections.singletonList(parameters), executeCallback);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡ŒBatch.</div><div class="line">* <span class="doctag">@param</span> sqlType SQLç±»å‹</div><div class="line">* <span class="doctag">@param</span> batchPreparedStatementUnits è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒé›†åˆ</div><div class="line">* <span class="doctag">@param</span> parameterSets å‚æ•°åˆ—è¡¨é›†</div><div class="line">* <span class="doctag">@param</span> executeCallback æ‰§è¡Œå›è°ƒå‡½æ•°</div><div class="line">* <span class="doctag">@return</span> æ‰§è¡Œç»“æœ</div><div class="line">*/</div><div class="line"><span class="keyword">public</span> List&lt;<span class="keyword">int</span>[]&gt; executeBatch(</div><div class="line">       <span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;BatchPreparedStatementUnit&gt; batchPreparedStatementUnits, <span class="keyword">final</span> List&lt;List&lt;Object&gt;&gt; parameterSets, <span class="keyword">final</span> ExecuteCallback&lt;<span class="keyword">int</span>[]&gt; executeCallback) &#123;</div><div class="line">   <span class="keyword">return</span> execute(sqlType, batchPreparedStatementUnits, parameterSets, executeCallback);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>#execute()</code> æ‰§è¡Œè¿‡ç¨‹å¤§ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/02.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œ</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlType SQL ç±»å‹</div><div class="line">* <span class="doctag">@param</span> baseStatementUnits è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒé›†åˆ</div><div class="line">* <span class="doctag">@param</span> parameterSets å‚æ•°åˆ—è¡¨é›†</div><div class="line">* <span class="doctag">@param</span> executeCallback æ‰§è¡Œå›è°ƒå‡½æ•°</div><div class="line">* <span class="doctag">@param</span> &lt;T&gt; è¿”å›å€¼ç±»å‹</div><div class="line">* <span class="doctag">@return</span> æ‰§è¡Œç»“æœ</div><div class="line">*/</div><div class="line"><span class="keyword">private</span>  &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">execute</span><span class="params">(</span></span></div><div class="line">       <span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;? extends BaseStatementUnit&gt; baseStatementUnits, <span class="keyword">final</span> List&lt;List&lt;Object&gt;&gt; parameterSets, <span class="keyword">final</span> ExecuteCallback&lt;T&gt; executeCallback) &#123;</div><div class="line">   <span class="keyword">if</span> (baseStatementUnits.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   Iterator&lt;? extends BaseStatementUnit&gt; iterator = baseStatementUnits.iterator();</div><div class="line">   BaseStatementUnit firstInput = iterator.next();</div><div class="line">   <span class="comment">// ç¬¬äºŒä¸ªä»»åŠ¡å¼€å§‹æ‰€æœ‰ SQLä»»åŠ¡ æäº¤çº¿ç¨‹æ± ã€å¼‚æ­¥ã€‘æ‰§è¡Œä»»åŠ¡</span></div><div class="line">   ListenableFuture&lt;List&lt;T&gt;&gt; restFutures = asyncExecute(sqlType, Lists.newArrayList(iterator), parameterSets, executeCallback);</div><div class="line">   T firstOutput;</div><div class="line">   List&lt;T&gt; restOutputs;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// ç¬¬ä¸€ä¸ªä»»åŠ¡ã€åŒæ­¥ã€‘æ‰§è¡Œä»»åŠ¡</span></div><div class="line">       firstOutput = syncExecute(sqlType, firstInput, parameterSets, executeCallback);</div><div class="line">       <span class="comment">// ç­‰å¾…ç¬¬äºŒä¸ªä»»åŠ¡å¼€å§‹æ‰€æœ‰ SQLä»»åŠ¡å®Œæˆ</span></div><div class="line">       restOutputs = restFutures.get();</div><div class="line">       <span class="comment">//CHECKSTYLE:OFF</span></div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       <span class="comment">//CHECKSTYLE:ON</span></div><div class="line">       ExecutorExceptionHandler.handleException(ex);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è¿”å›ç»“æœ</span></div><div class="line">   List&lt;T&gt; result = Lists.newLinkedList(restOutputs);</div><div class="line">   result.add(<span class="number">0</span>, firstOutput);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ç¬¬ä¸€ä¸ªä»»åŠ¡<strong>ã€åŒæ­¥ã€‘</strong>è°ƒç”¨ <code>#executeInternal()</code> æ‰§è¡Œä»»åŠ¡ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">syncExecute</span><span class="params">(<span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> BaseStatementUnit baseStatementUnit, <span class="keyword">final</span> List&lt;List&lt;Object&gt;&gt; parameterSets, <span class="keyword">final</span> ExecuteCallback&lt;T&gt; executeCallback)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">   <span class="comment">// ã€åŒæ­¥ã€‘æ‰§è¡Œä»»åŠ¡</span></div><div class="line">   <span class="keyword">return</span> executeInternal(sqlType, baseStatementUnit, parameterSets, executeCallback, ExecutorExceptionHandler.isExceptionThrown(), ExecutorDataMap.getDataMap());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ç¬¬äºŒä¸ªå¼€å§‹çš„ä»»åŠ¡<strong>æäº¤çº¿ç¨‹æ± å¼‚æ­¥</strong>è°ƒç”¨ <code>#executeInternal()</code> æ‰§è¡Œä»»åŠ¡ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> &lt;T&gt; ListenableFuture&lt;List&lt;T&gt;&gt; asyncExecute(</div><div class="line">       <span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> Collection&lt;BaseStatementUnit&gt; baseStatementUnits, <span class="keyword">final</span> List&lt;List&lt;Object&gt;&gt; parameterSets, <span class="keyword">final</span> ExecuteCallback&lt;T&gt; executeCallback) &#123;</div><div class="line">   List&lt;ListenableFuture&lt;T&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(baseStatementUnits.size());</div><div class="line">   <span class="keyword">final</span> <span class="keyword">boolean</span> isExceptionThrown = ExecutorExceptionHandler.isExceptionThrown();</div><div class="line">   <span class="keyword">final</span> Map&lt;String, Object&gt; dataMap = ExecutorDataMap.getDataMap();</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">final</span> BaseStatementUnit each : baseStatementUnits) &#123;</div><div class="line">       <span class="comment">// æäº¤çº¿ç¨‹æ± ã€å¼‚æ­¥ã€‘æ‰§è¡Œä»»åŠ¡</span></div><div class="line">       result.add(executorService.submit(<span class="keyword">new</span> Callable&lt;T&gt;() &#123;</div><div class="line">           </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> T <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">               <span class="keyword">return</span> executeInternal(sqlType, each, parameterSets, executeCallback, isExceptionThrown, dataMap);</div><div class="line">           &#125;</div><div class="line">       &#125;));</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è¿”å› ListenableFuture</span></div><div class="line">   <span class="keyword">return</span> Futures.allAsList(result);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æˆ‘ä»¬æ³¨æ„ä¸‹ <code>Futures.allAsList(result);</code> å’Œ <code>restOutputs = restFutures.get();</code>ã€‚ç¥å™¨ Guava <strong>ç®€åŒ–å¹¶å‘ç¼–ç¨‹</strong> çš„å¥½å¤„å°±æç°å‡ºæ¥äº†ã€‚<code>ListenableFuture#get()</code> å½“<strong>æ‰€æœ‰ä»»åŠ¡éƒ½æˆåŠŸ</strong>æ—¶ï¼Œè¿”å›æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œç»“æœï¼›å½“<strong>ä»»ä½•ä¸€ä¸ªä»»åŠ¡å¤±è´¥</strong>æ—¶ï¼Œ<strong>é©¬ä¸Š</strong>æŠ›å‡ºå¼‚å¸¸ï¼Œæ— éœ€ç­‰å¾…å…¶ä»–ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/03.gif" alt=""></p>
<p>_ğŸ˜® Guava çœŸå¥¹å–µç¥å™¨ï¼Œå…¬ä¼—å·ï¼š<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</a>ä¼šæ›´æ–° Guava æºç åˆ†äº«çš„ä¸€ä¸ªç³»åˆ—å“Ÿï¼è€å¸æœºè¿˜ä¸èµ¶ç´§ä¸Šè½¦ï¼Ÿ_</p>
<ul>
<li>ä¸ºä»€ä¹ˆä¼šåˆ†åŒæ­¥æ‰§è¡Œå’Œå¼‚æ­¥æ‰§è¡Œå‘¢ï¼ŸçŒœæµ‹ï¼Œå½“<strong>SQL æ‰§è¡Œæ˜¯å•è¡¨æ—¶</strong>ï¼Œåªè¦è¿›è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡çš„åŒæ­¥è°ƒç”¨ï¼Œæ€§èƒ½æ›´åŠ ä¼˜ç§€ã€‚ç­‰è·Ÿå¼ äº®å¤§ç¥è¯·æ•™ç¡®è®¤åŸå› åï¼Œå’±ä¼šè¿›è¡Œæ›´æ–°ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ExecutorEngine.java</span></div><div class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">executeInternal</span><span class="params">(<span class="keyword">final</span> SQLType sqlType, <span class="keyword">final</span> BaseStatementUnit baseStatementUnit, <span class="keyword">final</span> List&lt;List&lt;Object&gt;&gt; parameterSets, <span class="keyword">final</span> ExecuteCallback&lt;T&gt; executeCallback, </span></span></div><div class="line">                     <span class="keyword">final</span> <span class="keyword">boolean</span> isExceptionThrown, <span class="keyword">final</span> Map&lt;String, Object&gt; dataMap) <span class="keyword">throws</span> Exception &#123;</div><div class="line">   <span class="keyword">synchronized</span> (baseStatementUnit.getStatement().getConnection()) &#123;</div><div class="line">       T result;</div><div class="line">       ExecutorExceptionHandler.setExceptionThrown(isExceptionThrown);</div><div class="line">       ExecutorDataMap.setDataMap(dataMap);</div><div class="line">       List&lt;AbstractExecutionEvent&gt; events = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">       <span class="comment">// ç”Ÿæˆ Event</span></div><div class="line">       <span class="keyword">if</span> (parameterSets.isEmpty()) &#123;</div><div class="line">           events.add(getExecutionEvent(sqlType, baseStatementUnit, Collections.emptyList()));</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">for</span> (List&lt;Object&gt; each : parameterSets) &#123;</div><div class="line">               events.add(getExecutionEvent(sqlType, baseStatementUnit, each));</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// EventBus å‘å¸ƒ EventExecutionType.BEFORE_EXECUTE</span></div><div class="line">       <span class="keyword">for</span> (AbstractExecutionEvent event : events) &#123;</div><div class="line">           EventBusInstance.getInstance().post(event);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// æ‰§è¡Œå›è°ƒå‡½æ•°</span></div><div class="line">           result = executeCallback.execute(baseStatementUnit);</div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">           <span class="comment">// EventBus å‘å¸ƒ EventExecutionType.EXECUTE_FAILURE</span></div><div class="line">           <span class="keyword">for</span> (AbstractExecutionEvent each : events) &#123;</div><div class="line">               each.setEventExecutionType(EventExecutionType.EXECUTE_FAILURE);</div><div class="line">               each.setException(Optional.of(ex));</div><div class="line">               EventBusInstance.getInstance().post(each);</div><div class="line">               ExecutorExceptionHandler.handleException(ex);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// EventBus å‘å¸ƒ EventExecutionType.EXECUTE_SUCCESS</span></div><div class="line">       <span class="keyword">for</span> (AbstractExecutionEvent each : events) &#123;</div><div class="line">           each.setEventExecutionType(EventExecutionType.EXECUTE_SUCCESS);</div><div class="line">           EventBusInstance.getInstance().post(each);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>result = executeCallback.execute(baseStatementUnit);</code> æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚StatementExecutorï¼ŒPreparedStatementExecutorï¼ŒBatchPreparedStatementExecutor é€šè¿‡ä¼ é€’<strong>æ‰§è¡Œå›è°ƒå‡½æ•°</strong>( ExecuteCallback )å®ç°ç»™ ExecutorEngine å®ç°å¹¶è¡Œæ‰§è¡Œã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExecuteCallback</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰§è¡Œä»»åŠ¡.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> baseStatementUnit è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒ</div><div class="line">     * <span class="doctag">@return</span> å¤„ç†ç»“æœ</div><div class="line">     * <span class="doctag">@throws</span> Exception æ‰§è¡ŒæœŸå¼‚å¸¸</div><div class="line">     */</div><div class="line">    <span class="function">T <span class="title">execute</span><span class="params">(BaseStatementUnit baseStatementUnit)</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>synchronized (baseStatementUnit.getStatement().getConnection())</code> åŸä»¥ä¸º Connection éçº¿ç¨‹å®‰å…¨ï¼Œå› æ­¤éœ€è¦ç”¨<strong>åŒæ­¥</strong>ï¼Œåç¿»æŸ¥èµ„æ–™<a href="http://blog.csdn.net/goldenfish1919/article/details/9089667" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ•°æ®åº“è¿æ¥æ± ä¸ºä»€ä¹ˆè¦å»ºç«‹å¤šä¸ªè¿æ¥ã€‹</a>ï¼ŒConnection æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ç­‰è·Ÿå¼ äº®å¤§ç¥è¯·æ•™ç¡®è®¤åŸå› åï¼Œå’±ä¼šè¿›è¡Œæ›´æ–°ã€‚</li>
<li>ExecutionEvent è¿™é‡Œå…ˆä¸è§£é‡Šï¼Œåœ¨æœ¬æ–‡ç¬¬å››èŠ‚ã€EventBusã€‘åˆ†äº«ã€‚</li>
<li>ExecutorExceptionHandlerã€ExecutorDataMap å’Œ æŸ”æ€§äº‹åŠ¡ ( AbstractSoftTransaction )ï¼Œæ”¾åœ¨<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠæŸ”æ€§äº‹åŠ¡ã€‹</a>åˆ†äº«ã€‚</li>
</ul>
<h1 id="3-Executor"><a href="#3-Executor" class="headerlink" title="3. Executor"></a>3. Executor</h1><p>Executorï¼Œæ‰§è¡Œå™¨ï¼Œç›®å‰ä¸€å…±æœ‰ä¸‰ä¸ªæ‰§è¡Œå™¨ã€‚ä¸åŒçš„æ‰§è¡Œå™¨å¯¹åº”ä¸åŒçš„æ‰§è¡Œå•å…ƒ (BaseStatementUnit)ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">æ‰§è¡Œå™¨ç±»</th>
<th style="text-align:left">æ‰§è¡Œå™¨å</th>
<th style="text-align:left">æ‰§è¡Œå•å…ƒ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">StatementExecutor</td>
<td style="text-align:left">é™æ€è¯­å¥å¯¹è±¡æ‰§è¡Œå•å…ƒ</td>
<td style="text-align:left">StatementUnit</td>
</tr>
<tr>
<td style="text-align:left">PreparedStatementExecutor</td>
<td style="text-align:left">é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡è¯·æ±‚çš„æ‰§è¡Œå™¨</td>
<td style="text-align:left">PreparedStatementUnit</td>
</tr>
<tr>
<td style="text-align:left">BatchPreparedStatementExecutor</td>
<td style="text-align:left">æ‰¹é‡é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡è¯·æ±‚çš„æ‰§è¡Œå™¨</td>
<td style="text-align:left">BatchPreparedStatementUnit</td>
</tr>
</tbody>
</table>
<ul>
<li>æ‰§è¡Œå™¨æä¾›çš„æ–¹æ³•ä¸åŒï¼Œå› æ­¤ä¸å­˜åœ¨å…¬ç”¨æ¥å£æˆ–è€…æŠ½è±¡ç±»ã€‚</li>
<li>æ‰§è¡Œå•å…ƒç»§æ‰¿è‡ª BaseStatementUnit</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/04.png" alt=""></p>
<h2 id="3-1-StatementExecutor"><a href="#3-1-StatementExecutor" class="headerlink" title="3.1 StatementExecutor"></a>3.1 StatementExecutor</h2><p>StatementExecutorï¼Œ<strong>å¤šçº¿ç¨‹</strong>æ‰§è¡Œé™æ€è¯­å¥å¯¹è±¡è¯·æ±‚çš„æ‰§è¡Œå™¨ï¼Œä¸€å…±æœ‰ä¸‰ç±»æ–¹æ³•ï¼š</p>
<ul>
<li><code>#executeQuery()</code> </li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// StatementExecutor.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡ŒSQLæŸ¥è¯¢.</div><div class="line">* <span class="doctag">@return</span> ç»“æœé›†åˆ—è¡¨</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;ResultSet&gt; <span class="title">executeQuery</span><span class="params">()</span> </span>&#123;</div><div class="line">   Context context = MetricsContext.start(<span class="string">"ShardingStatement-executeQuery"</span>);</div><div class="line">   List&lt;ResultSet&gt; result;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       result = executorEngine.executeStatement(sqlType, statementUnits, <span class="keyword">new</span> ExecuteCallback&lt;ResultSet&gt;() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> ResultSet <span class="title">execute</span><span class="params">(<span class="keyword">final</span> BaseStatementUnit baseStatementUnit)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">               <span class="keyword">return</span> baseStatementUnit.getStatement().executeQuery(baseStatementUnit.getSqlExecutionUnit().getSql());</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       MetricsContext.stop(context);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#executeUpdate()</code> å› ä¸ºæœ‰å››ä¸ªä¸åŒæƒ…å†µçš„<code>#executeUpdate()</code>ï¼Œæ‰€ä»¥æŠ½è±¡äº† Updater æ¥å£ï¼Œä»è€Œè¾¾åˆ°é€»è¾‘é‡ç”¨ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// StatementExecutor.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡ŒSQLæ›´æ–°.</div><div class="line">* <span class="doctag">@return</span> æ›´æ–°æ•°é‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> executeUpdate(<span class="keyword">new</span> Updater() &#123;</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">(<span class="keyword">final</span> Statement statement, <span class="keyword">final</span> String sql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">           <span class="keyword">return</span> statement.executeUpdate(sql);</div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">(<span class="keyword">final</span> Updater updater)</span> </span>&#123;</div><div class="line">   Context context = MetricsContext.start(<span class="string">"ShardingStatement-executeUpdate"</span>);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       List&lt;Integer&gt; results = executorEngine.executeStatement(sqlType, statementUnits, <span class="keyword">new</span> ExecuteCallback&lt;Integer&gt;() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> Integer <span class="title">execute</span><span class="params">(<span class="keyword">final</span> BaseStatementUnit baseStatementUnit)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">               <span class="keyword">return</span> updater.executeUpdate(baseStatementUnit.getStatement(), baseStatementUnit.getSqlExecutionUnit().getSql());</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       <span class="keyword">return</span> accumulate(results);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       MetricsContext.stop(context);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¡ç®—æ€»çš„æ›´æ–°æ•°é‡</div><div class="line">* <span class="doctag">@param</span> results æ›´æ–°æ•°é‡æ•°ç»„</div><div class="line">* <span class="doctag">@return</span> æ›´æ–°æ•°é‡</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">accumulate</span><span class="params">(<span class="keyword">final</span> List&lt;Integer&gt; results)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> result = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (Integer each : results) &#123;</div><div class="line">       result += <span class="keyword">null</span> == each ? <span class="number">0</span> : each;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#execute()</code> å› ä¸ºæœ‰å››ä¸ªä¸åŒæƒ…å†µçš„<code>#execute()</code>ï¼Œæ‰€ä»¥æŠ½è±¡äº† Executor æ¥å£ï¼Œä»è€Œè¾¾åˆ°é€»è¾‘é‡ç”¨ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡ŒSQLè¯·æ±‚.</div><div class="line">* <span class="doctag">@return</span> trueè¡¨ç¤ºæ‰§è¡ŒDQLè¯­å¥, falseè¡¨ç¤ºæ‰§è¡Œçš„DMLè¯­å¥</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> execute(<span class="keyword">new</span> Executor() &#123;</div><div class="line">       </div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Statement statement, <span class="keyword">final</span> String sql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">           <span class="keyword">return</span> statement.execute(sql);</div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Executor executor)</span> </span>&#123;</div><div class="line">   Context context = MetricsContext.start(<span class="string">"ShardingStatement-execute"</span>);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       List&lt;Boolean&gt; result = executorEngine.executeStatement(sqlType, statementUnits, <span class="keyword">new</span> ExecuteCallback&lt;Boolean&gt;() &#123; </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> Boolean <span class="title">execute</span><span class="params">(<span class="keyword">final</span> BaseStatementUnit baseStatementUnit)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">               <span class="keyword">return</span> executor.execute(baseStatementUnit.getStatement(), baseStatementUnit.getSqlExecutionUnit().getSql());</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> == result || result.isEmpty() || <span class="keyword">null</span> == result.get(<span class="number">0</span>)) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> result.get(<span class="number">0</span>);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       MetricsContext.stop(context);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-2-PreparedStatementExecutor"><a href="#3-2-PreparedStatementExecutor" class="headerlink" title="3.2 PreparedStatementExecutor"></a>3.2 PreparedStatementExecutor</h2><p>PreparedStatementExecutorï¼Œ<strong>å¤šçº¿ç¨‹</strong>æ‰§è¡Œé¢„ç¼–è¯‘è¯­å¥å¯¹è±¡è¯·æ±‚çš„æ‰§è¡Œå™¨ã€‚æ¯” StatementExecutor å¤šäº† <code>parameters</code> å‚æ•°ï¼Œæ–¹æ³•é€»è¾‘ä¸ŠåŸºæœ¬ä¸€è‡´ï¼Œå°±ä¸é‡å¤åˆ†äº«å•¦ã€‚</p>
<h2 id="3-3-BatchPreparedStatementExecutor"><a href="#3-3-BatchPreparedStatementExecutor" class="headerlink" title="3.3 BatchPreparedStatementExecutor"></a>3.3 BatchPreparedStatementExecutor</h2><p>BatchPreparedStatementExecutorï¼Œ<strong>å¤šçº¿ç¨‹</strong>æ‰§è¡Œæ‰¹é‡é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡è¯·æ±‚çš„æ‰§è¡Œå™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// BatchPreparedStatementExecutor.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* æ‰§è¡Œæ‰¹é‡SQL.</div><div class="line">* </div><div class="line">* <span class="doctag">@return</span> æ‰§è¡Œç»“æœ</div><div class="line">*/</div><div class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] executeBatch() &#123;</div><div class="line">   Context context = MetricsContext.start(<span class="string">"ShardingPreparedStatement-executeBatch"</span>);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">return</span> accumulate(executorEngine.executeBatch(sqlType, batchPreparedStatementUnits, parameterSets, <span class="keyword">new</span> ExecuteCallback&lt;<span class="keyword">int</span>[]&gt;() &#123;</div><div class="line">           </div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="keyword">public</span> <span class="keyword">int</span>[] execute(<span class="keyword">final</span> BaseStatementUnit baseStatementUnit) <span class="keyword">throws</span> Exception &#123;</div><div class="line">               <span class="keyword">return</span> baseStatementUnit.getStatement().executeBatch();</div><div class="line">           &#125;</div><div class="line">       &#125;));</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       MetricsContext.stop(context);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* è®¡ç®—æ¯ä¸ªè¯­å¥çš„æ›´æ–°æ•°é‡</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> results æ¯æ¡ SQL æ›´æ–°æ•°é‡</div><div class="line">* <span class="doctag">@return</span> æ¯ä¸ªè¯­å¥çš„æ›´æ–°æ•°é‡</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span>[] accumulate(<span class="keyword">final</span> List&lt;<span class="keyword">int</span>[]&gt; results) &#123;</div><div class="line">   <span class="keyword">int</span>[] result = <span class="keyword">new</span> <span class="keyword">int</span>[parameterSets.size()];</div><div class="line">   <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">   <span class="comment">// æ¯ä¸ªè¯­å¥æŒ‰ç…§é¡ºåºï¼Œè¯»å–åˆ°å…¶å¯¹åº”çš„æ¯ä¸ªåˆ†ç‰‡SQLå½±å“çš„è¡Œæ•°è¿›è¡Œç´¯åŠ </span></div><div class="line">   <span class="keyword">for</span> (BatchPreparedStatementUnit each : batchPreparedStatementUnits) &#123;</div><div class="line">       <span class="keyword">for</span> (Map.Entry&lt;Integer, Integer&gt; entry : each.getJdbcAndActualAddBatchCallTimesMap().entrySet()) &#123;</div><div class="line">           result[entry.getKey()] += <span class="keyword">null</span> == results.get(count) ? <span class="number">0</span> : results.get(count)[entry.getValue()];</div><div class="line">       &#125;</div><div class="line">       count++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>çœ¼å°–</strong>çš„åŒå­¦ä¼šå‘ç°ï¼Œä¸ºä»€ä¹ˆæœ‰ BatchPreparedStatementExecutorï¼Œè€Œæ²¡æœ‰ BatchStatementExecutor å‘¢ï¼Ÿç›®å‰ Sharding-JDBC ä¸æ”¯æŒ Statement æ‰¹é‡æ“ä½œï¼Œåªèƒ½è¿›è¡Œ PreparedStatement çš„æ‰¹æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PreparedStatement æ‰¹é‡æ“ä½œï¼Œä¸ä¼šæŠ¥é”™</span></div><div class="line">PreparedStatement ps = conn.prepareStatement(sql)</div><div class="line">ps.addBatch();</div><div class="line">ps.addBatch();</div><div class="line"></div><div class="line"><span class="comment">// Statement æ‰¹é‡æ“ä½œï¼Œä¼šæŠ¥é”™</span></div><div class="line">ps.addBatch(sql); <span class="comment">// æŠ¥é”™ï¼šat com.dangdang.ddframe.rdb.sharding.jdbc.unsupported.AbstractUnsupportedOperationStatement.addBatch</span></div></pre></td></tr></table></figure>
<h1 id="4-ExecutionEvent"><a href="#4-ExecutionEvent" class="headerlink" title="4. ExecutionEvent"></a>4. ExecutionEvent</h1><p>AbstractExecutionEventï¼ŒSQL æ‰§è¡Œäº‹ä»¶æŠ½è±¡æ¥å£ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractExecutionEvent</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * äº‹ä»¶ç¼–å·</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String id;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•°æ®æº</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String dataSource;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String sql;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å‚æ•°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; parameters;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * äº‹ä»¶ç±»å‹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> EventExecutionType eventExecutionType;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¼‚å¸¸</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Optional&lt;SQLException&gt; exception;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AbstractExecutionEvent æœ‰ä¸¤ä¸ªå®ç°å­ç±»ï¼š</p>
<ul>
<li>DMLExecutionEventï¼šDMLç±»SQLæ‰§è¡Œæ—¶äº‹ä»¶</li>
<li>DQLExecutionEventï¼šDQLç±»SQLæ‰§è¡Œæ—¶äº‹ä»¶</li>
</ul>
<p>EventExecutionTypeï¼Œäº‹ä»¶è§¦å‘ç±»å‹ã€‚</p>
<ul>
<li>BEFORE_EXECUTEï¼šæ‰§è¡Œå‰</li>
<li>EXECUTE_SUCCESSï¼šæ‰§è¡ŒæˆåŠŸ</li>
<li>EXECUTE_FAILUREï¼šæ‰§è¡Œå¤±è´¥</li>
</ul>
<h2 id="4-1-EventBus"><a href="#4-1-EventBus" class="headerlink" title="4.1 EventBus"></a>4.1 EventBus</h2><p><strong>é‚£ç©¶ç«Ÿæœ‰ä»€ä¹ˆç”¨é€”å‘¢ï¼Ÿ</strong> Sharding-JDBC ä½¿ç”¨ Guavaï¼ˆ<strong>æ²¡é”™ï¼Œåˆæ˜¯å®ƒ</strong>ï¼‰çš„ <strong>EventBus</strong> å®ç°äº†<strong>äº‹ä»¶çš„å‘å¸ƒå’Œè®¢é˜…</strong>ã€‚ä»ä¸Šæ–‡ <code>ExecutorEngine#executeInternal()</code> æˆ‘ä»¬å¯ä»¥çœ‹åˆ°<strong>æ¯ä¸ªåˆ†ç‰‡</strong> SQL æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¼šå‘å¸ƒç›¸åº”äº‹ä»¶ï¼š</p>
<ul>
<li>æ‰§è¡Œ SQL å‰ï¼šå‘å¸ƒç±»å‹ç±»å‹ä¸º BEFORE_EXECUTE çš„äº‹ä»¶</li>
<li>æ‰§è¡Œ SQL æˆåŠŸï¼šå‘å¸ƒç±»å‹ç±»å‹ä¸º EXECUTE_SUCCESS çš„äº‹ä»¶</li>
<li>æ‰§è¡Œ SQL å¤±è´¥ï¼šå‘å¸ƒç±»å‹ç±»å‹ä¸º EXECUTE_FAILURE çš„äº‹ä»¶</li>
</ul>
<p><strong>æ€ä¹ˆè®¢é˜…äº‹ä»¶å‘¢ï¼Ÿ</strong>éå¸¸ç®€å•ï¼Œä¾‹å­å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">EventBusInstance.getInstance().register(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Subscribe</span> <span class="comment">// è®¢é˜…</span></div><div class="line">  <span class="meta">@AllowConcurrentEvents</span> <span class="comment">// æ˜¯å¦å…è®¸å¹¶å‘æ‰§è¡Œï¼Œå³çº¿ç¨‹å®‰å…¨</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(<span class="keyword">final</span> DMLExecutionEvent event)</span> </span>&#123; <span class="comment">// DMLExecutionEvent</span></div><div class="line">      System.out.println(<span class="string">"DMLExecutionEventï¼š"</span> + event.getSql() + <span class="string">"\t"</span> + event.getEventExecutionType());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Subscribe</span> <span class="comment">// è®¢é˜…</span></div><div class="line">  <span class="meta">@AllowConcurrentEvents</span> <span class="comment">// æ˜¯å¦å…è®¸å¹¶å‘æ‰§è¡Œï¼Œå³çº¿ç¨‹å®‰å…¨</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen2</span><span class="params">(<span class="keyword">final</span> DQLExecutionEvent event)</span> </span>&#123; <span class="comment">//DQLExecutionEvent</span></div><div class="line">      System.out.println(<span class="string">"DQLExecutionEventï¼š"</span> + event.getSql() + <span class="string">"\t"</span> + event.getEventExecutionType());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ul>
<li><code>#register()</code> ä»»ä½•ç±»éƒ½å¯ä»¥ï¼Œå¹¶éä¸€å®šéœ€è¦ä½¿ç”¨ Runnable ç±»ã€‚æ­¤å¤„ä¾‹å­å•çº¯å› ä¸ºæ–¹ä¾¿</li>
<li><code>@Subscribe</code> æ³¨è§£åœ¨æ–¹æ³•ä¸Šï¼Œå®ç°å¯¹äº‹ä»¶çš„è®¢é˜…</li>
<li><code>@AllowConcurrentEvents</code> æ³¨è§£åœ¨æ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºçº¿ç¨‹å®‰å…¨ï¼Œå…è®¸å¹¶å‘æ‰§è¡Œ</li>
<li>æ–¹æ³•ä¸Šçš„<strong>å‚æ•°å¯¹åº”çš„ç±»</strong>å³æ˜¯è®¢é˜…çš„äº‹ä»¶ã€‚ä¾‹å¦‚ï¼Œ<code>#listen()</code> è®¢é˜…äº† DMLExecutionEvent äº‹ä»¶</li>
<li><code>EventBus#post()</code> å‘å¸ƒäº‹ä»¶ï¼Œ<strong>åŒæ­¥</strong>è°ƒç”¨è®¢é˜…é€»è¾‘</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_14/05.png" alt=""></p>
<ul>
<li>æ¨èé˜…è¯»æ–‡ç« ï¼š<a href="http://www.cnblogs.com/peida/p/EventBus.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠGuavaå­¦ä¹ ç¬”è®°ï¼šEventBusã€‹</a></li>
</ul>
<blockquote>
<p><strong>Sharding-JDBC æ­£åœ¨æ”¶é›†ä½¿ç”¨å…¬å¸åå•ï¼š<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a>ã€‚<br>ğŸ™‚ ä½ çš„ç™»è®°ï¼Œä¼šè®©æ›´å¤šäººå‚ä¸å’Œä½¿ç”¨ Sharding-JDBCã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>Sharding-JDBC ä¹Ÿä¼šå› æ­¤ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a><br>ç™»è®°å§ï¼Œéªšå¹´ï¼<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></strong></p>
</blockquote>
<h2 id="4-2-BestEffortsDeliveryListener"><a href="#4-2-BestEffortsDeliveryListener" class="headerlink" title="4.2 BestEffortsDeliveryListener"></a>4.2 BestEffortsDeliveryListener</h2><p>BestEffortsDeliveryListenerï¼Œæœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ç›‘å¬å™¨ã€‚</p>
<p>æœ¬æ–‡æš‚æ—¶æš‚æ—¶ä¸åˆ†æå…¶å®ç°ï¼Œä»…ä»…ä½œä¸ºå¦å¤–ä¸€ä¸ª<strong>è®¢é˜…è€…</strong>çš„ä¾‹å­ã€‚æˆ‘ä»¬ä¼šåœ¨<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠæŸ”æ€§äº‹åŠ¡ã€‹</a>è¿›è¡Œåˆ†äº«ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BestEffortsDeliveryListener</span> </span>&#123;</div><div class="line">    <span class="meta">@Subscribe</span></div><div class="line">    <span class="meta">@AllowConcurrentEvents</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(<span class="keyword">final</span> DMLExecutionEvent event)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!isProcessContinuously()) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        SoftTransactionConfiguration transactionConfig = SoftTransactionManager.getCurrentTransactionConfiguration().get();</div><div class="line">        TransactionLogStorage transactionLogStorage = TransactionLogStorageFactory.createTransactionLogStorage(transactionConfig.buildTransactionLogDataSource());</div><div class="line">        BEDSoftTransaction bedSoftTransaction = (BEDSoftTransaction) SoftTransactionManager.getCurrentTransaction().get();</div><div class="line">        <span class="keyword">switch</span> (event.getEventExecutionType()) &#123;</div><div class="line">            <span class="keyword">case</span> BEFORE_EXECUTE:</div><div class="line">                <span class="comment">//TODO å¯¹äºæ‰¹é‡æ‰§è¡Œçš„SQLéœ€è¦è§£ææˆä¸¤å±‚åˆ—è¡¨</span></div><div class="line">                transactionLogStorage.add(<span class="keyword">new</span> TransactionLog(event.getId(), bedSoftTransaction.getTransactionId(), bedSoftTransaction.getTransactionType(), </div><div class="line">                        event.getDataSource(), event.getSql(), event.getParameters(), System.currentTimeMillis(), <span class="number">0</span>));</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            <span class="keyword">case</span> EXECUTE_SUCCESS: </div><div class="line">                transactionLogStorage.remove(event.getId());</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            <span class="keyword">case</span> EXECUTE_FAILURE: </div><div class="line">                <span class="keyword">boolean</span> deliverySuccess = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; transactionConfig.getSyncMaxDeliveryTryTimes(); i++) &#123;</div><div class="line">                    <span class="keyword">if</span> (deliverySuccess) &#123;</div><div class="line">                        <span class="keyword">return</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">boolean</span> isNewConnection = <span class="keyword">false</span>;</div><div class="line">                    Connection conn = <span class="keyword">null</span>;</div><div class="line">                    PreparedStatement preparedStatement = <span class="keyword">null</span>;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        conn = bedSoftTransaction.getConnection().getConnection(event.getDataSource(), SQLType.UPDATE);</div><div class="line">                        <span class="keyword">if</span> (!isValidConnection(conn)) &#123;</div><div class="line">                            bedSoftTransaction.getConnection().release(conn);</div><div class="line">                            conn = bedSoftTransaction.getConnection().getConnection(event.getDataSource(), SQLType.UPDATE);</div><div class="line">                            isNewConnection = <span class="keyword">true</span>;</div><div class="line">                        &#125;</div><div class="line">                        preparedStatement = conn.prepareStatement(event.getSql());</div><div class="line">                        <span class="comment">//TODO å¯¹äºæ‰¹é‡äº‹ä»¶éœ€è¦è§£ææˆä¸¤å±‚åˆ—è¡¨</span></div><div class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> parameterIndex = <span class="number">0</span>; parameterIndex &lt; event.getParameters().size(); parameterIndex++) &#123;</div><div class="line">                            preparedStatement.setObject(parameterIndex + <span class="number">1</span>, event.getParameters().get(parameterIndex));</div><div class="line">                        &#125;</div><div class="line">                        preparedStatement.executeUpdate();</div><div class="line">                        deliverySuccess = <span class="keyword">true</span>;</div><div class="line">                        transactionLogStorage.remove(event.getId());</div><div class="line">                    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException ex) &#123;</div><div class="line">                        log.error(String.format(<span class="string">"Delivery times %s error, max try times is %s"</span>, i + <span class="number">1</span>, transactionConfig.getSyncMaxDeliveryTryTimes()), ex);</div><div class="line">                    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                        close(isNewConnection, conn, preparedStatement);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            <span class="keyword">default</span>: </div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(event.getEventExecutionType().toString());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æœ¬æ–‡å®Œï¼Œä½†ä¹Ÿæœªå®Œã€‚</p>
<p><strong>è·¨åˆ†ç‰‡äº‹åŠ¡é—®é¢˜</strong>ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">UPDATE</span> t_order <span class="keyword">SET</span> nickname = ? <span class="keyword">WHERE</span> user_id = ?</div></pre></td></tr></table></figure>
<p>A èŠ‚ç‚¹ <code>connection.commit()</code> æ—¶ï¼Œåº”ç”¨çªç„¶æŒ‚äº†ï¼BèŠ‚ç‚¹ <code>connection.commit()</code> è¿˜æ¥ä¸åŠæ‰§è¡Œã€‚<br>æˆ‘ä»¬ä¸€èµ·å»<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ã€ŠæŸ”æ€§äº‹åŠ¡ã€‹</a>å¯»æ‰¾ç­”æ¡ˆã€‚</p>
<p><strong>é“å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼Ÿ</strong></p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">GitHub</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-ExecutorEngine"><span class="toc-number">2.</span> <span class="toc-text">2. ExecutorEngine</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-ListeningExecutorService"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 ListeningExecutorService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-å…³é—­"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 å…³é—­</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-æ‰§è¡Œ-SQL-ä»»åŠ¡"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 æ‰§è¡Œ SQL ä»»åŠ¡</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Executor"><span class="toc-number">3.</span> <span class="toc-text">3. Executor</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-StatementExecutor"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 StatementExecutor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-PreparedStatementExecutor"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 PreparedStatementExecutor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-BatchPreparedStatementExecutor"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 BatchPreparedStatementExecutor</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-ExecutionEvent"><span class="toc-number">4.</span> <span class="toc-text">4. ExecutionEvent</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-EventBus"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 EventBus</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-BestEffortsDeliveryListener"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 BestEffortsDeliveryListener</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-å½©è›‹"><span class="toc-number">5.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/Sharding-JDBC/sql-execute/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/Sharding-JDBC/sql-execute/&text=Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/Sharding-JDBC/sql-execute/&title=Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/Sharding-JDBC/sql-execute/&is_video=false&description=Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ&body=Check out this article: http://www.yunai.me/Sharding-JDBC/sql-execute/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/Sharding-JDBC/sql-execute/&title=Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/Sharding-JDBC/sql-execute/&title=Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/Sharding-JDBC/sql-execute/&title=Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/Sharding-JDBC/sql-execute/&title=Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/Sharding-JDBC/sql-execute/&name=Sharding-JDBC æºç åˆ†æ â€”â€” SQL æ‰§è¡Œ&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$(" #toc-footer").toggle();return="" false;"=""><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$(" #share-footer").toggle();return="" false;"=""><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$(" #nav-footer").toggle();return="" false;"=""><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 ç‹æ–‡æ–Œ
  </div>

  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">GitHub</a></li>
        
          <li>
              Hosted by <a href="https://pages.coding.me" style="font-weight: bold" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a>
          </li>
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

<!-- Disqus Comments -->


<!--page counter part-->
<script>
    function addCount(Counter) {
        // TODO å¾…ä¼˜åŒ–ï¼šè¿‡æ»¤ çˆ¬è™«
        url = $('#actions .icon').attr('href').trim(); // æ–‡ç« url
//        alert(url);
        title = $('.posttitle').text().trim(); // æ–‡ç« æ ‡é¢˜
        var query = new AV.Query(Counter);
        //use url as unique idnetfication
        query.equalTo("url", url);
        query.find({
            success: function (results) {
                if (results.length > 0) {
                    var counter = results[0];
                    counter.fetchWhenSave(true); //get recent result
                    counter.increment("time");
                    counter.save();
                    // æ’å…¥æ¬¡æ•°
                    $('.postdate').append('&nbsp;' + (counter.get('time') + 1) + '  Views');
                } else {
                    var newcounter = new Counter();
                    newcounter.set("title", title);
                    newcounter.set("url", url);
                    newcounter.set("time", 1);
                    newcounter.save(null, {
                        success: function (newcounter) {
                            // æ’å…¥æ¬¡æ•°
                            $('.postdate').append('&nbsp;1  Views');
                        },
                        error: function (newcounter, error) {
                        }
                    });
                }
            },
            error: function (error) {
            }
        });
    }

    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(c_name + "=")
            if (c_start != -1) {
                c_start = c_start + c_name.length + 1
                c_end = document.cookie.indexOf(";", c_start)
                if (c_end == -1) c_end = document.cookie.length
                return unescape(document.cookie.substring(c_start, c_end))
            }
        }
        return ""
    }

    function setCookie(c_name, value, expiredays) {
        var exdate = new Date()
        exdate.setDate(exdate.getDate() + expiredays)
        document.cookie = c_name + "=" + escape(value) +
            ((expiredays == null) ? "" : ";expires=" + exdate.toGMTString())
    }

    function addVisitLog() {
        // è·å–uid
        var visitorId = getCookie('blog_visitor_id');
        if (visitorId.length != 36) {
            visitorId = uuid();
            setCookie('blog_visitor_id', visitorId);
        }
        // ip æµè§ˆå™¨æ— æ³•è·å–
        // time æœåŠ¡ç«¯å·²ç»è®°å½•
        var url = location.href;
        var ua = navigator.userAgent;
        var referer = document.referrer;
        var Log = AV.Object.extend("VisitLog");
        var log = new Log();
        log.set('url', url);
        log.set('ua', ua);
        log.set('referer', referer);
        log.set('visitorId', visitorId);
        log.save();
    }

    function uuid() {
        var s = [];
        var hexDigits = "0123456789abcdef";
        for (var i = 0; i < 36; i++) {
            s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
        }
        s[14] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
        s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
        s[8] = s[13] = s[18] = s[23] = "-";

        var uuid = s.join("");
        return uuid;
    }

    // TODO å¾…ä¼˜åŒ–ï¼šæ­¤å¤„æ€§èƒ½è¾ƒå·®ï¼Œå¯èƒ½
    function countVisitLog() {
        var Log = AV.Object.extend("VisitLog");
        var query = new AV.Query(Log);
        query.count({
            success: function (results) {
                $('.footer-left').append('&nbsp;' + results + '  Views');
            },
            error: function (error) {
            }
        });
    }

    $(function () {
        // åˆ¤æ–­æ˜¯å¦åœ¨æ–‡ç« é¡µ
        setTimeout(function () {
            if ($('.posttitle').length == 1) {
                var Counter = AV.Object.extend("Counter");
                // å¢åŠ æ–‡ç« è®¿é—®æ¬¡æ•°
                addCount(Counter);
            }
            // è®°å½•è®¿é—®æ—¥å¿—
            addVisitLog();
            // è®¡ç®—å¤šå°‘äººè®¿é—®
            countVisitLog();
        }, 1000);
    });
</script>
