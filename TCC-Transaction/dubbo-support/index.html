<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>TCC-Transaction æºç åˆ†æ â€”â€” Dubbo æ”¯æŒ | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="ç‹æ–‡æ–Œ"><meta name="description" content="æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ  

1. æ¦‚è¿°
2. Dubbo ä»£ç†
2.1 JavassistProxyFactory
2.1.1 Javassist
2.1.2 TccJavassistProxyFactory
2.1.3 TccProxy &amp;amp; "><meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?9e70e3362807c1bd185a79655b307027";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG">èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</a></h1><a class="blog-motto">æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li><li><a href="/link_url">å‹é“¾</a></li></ul></ul></nav></div></header><div id="container"><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Dubbo-ä»£ç†"><span class="toc-number">2.</span> <span class="toc-text">2. Dubbo ä»£ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-JavassistProxyFactory"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 JavassistProxyFactory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-Javassist"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1 Javassist</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-TccJavassistProxyFactory"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.1.2 TccJavassistProxyFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3-TccProxy-amp-TccClassGenerator"><span class="toc-number">2.1.3.</span> <span class="toc-text">2.1.3 TccProxy & TccClassGenerator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-4-é…ç½®-Dubbo-Proxy"><span class="toc-number">2.1.4.</span> <span class="toc-text">2.1.4 é…ç½® Dubbo Proxy</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-JdkProxyFactory"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 JdkProxyFactory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-JDK-Proxy"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 JDK Proxy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-TccJdkProxyFactory"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 TccJdkProxyFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-TccInvokerInvocationHandler"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.2.3 TccInvokerInvocationHandler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-4-é…ç½®-Dubbo-Proxy"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.2.4 é…ç½® Dubbo Proxy</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Dubbo-äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨"><span class="toc-number">3.</span> <span class="toc-text">3. Dubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-å½©è›‹"><span class="toc-number">4.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li><li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/TCC-Transaction/" title="TCC-Transaction">TCC-Transaction<sup>7</sup></a></li><li><a href="/categories/æŠ€æœ¯æ‚æ–‡/" title="æŠ€æœ¯æ‚æ–‡">æŠ€æœ¯æ‚æ–‡<sup>4</sup></a></li></ul></div></aside></div><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/TCC-Transaction/dubbo-support/" title="TCC-Transaction æºç åˆ†æ â€”â€” Dubbo æ”¯æŒ" itemprop="url">TCC-Transaction æºç åˆ†æ â€”â€” Dubbo æ”¯æŒ</a></h1><p class="article-author"></p><p class="article-time">æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ</strong></p><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. æ¦‚è¿°</a></li><li><a href="#2-dubbo-%E4%BB%A3%E7%90%86">2. Dubbo ä»£ç†</a><ul><li><a href="#21-javassistproxyfactory">2.1 JavassistProxyFactory</a><ul><li><a href="#211-javassist">2.1.1 Javassist</a></li><li><a href="#212-tccjavassistproxyfactory">2.1.2 TccJavassistProxyFactory</a></li><li><a href="#213-tccproxy--tccclassgenerator">2.1.3 TccProxy &amp; TccClassGenerator</a></li><li><a href="#214-%E9%85%8D%E7%BD%AE-dubbo-proxy">2.1.4 é…ç½® Dubbo Proxy</a></li></ul></li><li><a href="#22-jdkproxyfactory">2.2 JdkProxyFactory</a><ul><li><a href="#221-jdk-proxy">2.2.1 JDK Proxy</a></li><li><a href="#222-tccjdkproxyfactory">2.2.2 TccJdkProxyFactory</a></li><li><a href="#223-tccinvokerinvocationhandler">2.2.3 TccInvokerInvocationHandler</a></li><li><a href="#224-%E9%85%8D%E7%BD%AE-dubbo-proxy">2.2.4 é…ç½® Dubbo Proxy</a></li></ul></li></ul></li><li><a href="#3-dubbo-%E4%BA%8B%E5%8A%A1%E4%B8%8A%E4%B8%8B%E6%96%87%E7%BC%96%E8%BE%91%E5%99%A8">3. Dubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨</a></li><li><a href="#666-%E5%BD%A9%E8%9B%8B">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« <strong>Dubbo æ”¯æŒ</strong>ã€‚</p><p>TCC-Transaction é€šè¿‡ Dubbo <strong>éšå¼ä¼ å‚</strong>çš„åŠŸèƒ½ï¼Œé¿å…è‡ªå·±å¯¹ä¸šåŠ¡ä»£ç çš„å…¥ä¾µã€‚å¯èƒ½æœ‰åŒå­¦ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆè¯´ TCC-Transaction å¯¹ä¸šåŠ¡ä»£ç æœ‰ä¸€å®šçš„å…¥ä¾µæ€§ï¼Œä¸€èµ·æ¥çœ‹ä¸ªä»£ç ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CapitalTradeOrderService</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">record</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä»£ç æ¥è‡ª <code>tcc-transaction-http-sample</code> ã€‚å£°æ˜è¿œç¨‹è°ƒç”¨æ—¶ï¼Œå¢åŠ äº†å‚æ•° TransactionContextã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡è‡ªå·±ä½¿ç”¨çš„è¿œç¨‹è°ƒç”¨æ¡†æ¶åšä¸€å®šå°è£…ï¼Œé¿å…å…¥ä¾µã€‚</li></ul><p>å¦‚ä¸‹æ˜¯å¯¹ Dubbo å°è£…äº†åï¼ŒDubbo Service æ–¹æ³•çš„ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CapitalTradeOrderService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Compensable</span></div><div class="line">    <span class="function">String <span class="title">record</span><span class="params">(CapitalTradeOrderDto tradeOrderDto)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä»£ç æ¥è‡ª <code>http-transaction-dubbo-sample</code> ã€‚æ˜¯ä¸æ˜¯ä¸éœ€è¦ä¼ å…¥å‚æ•° TransactionContextã€‚å½“ç„¶ï¼Œæ³¨è§£æ˜¯è‚¯å®šéœ€è¦çš„ï¼Œå¦åˆ™ TCC-Transaction æ€ä¹ˆçŸ¥é“å“ªäº›æ–¹æ³•æ˜¯ TCC æ–¹æ³•ã€‚</li></ul><p>TCC-Transaction é€šè¿‡ Dubbo Proxy çš„æœºåˆ¶ï¼Œå®ç° <code>@Compensable</code> å±æ€§è‡ªåŠ¨ç”Ÿæˆï¼Œå¢åŠ å¼€å‘ä½“éªŒï¼Œä¹Ÿé¿å…å‡ºé”™ã€‚</p><hr><p>Dubbo æ”¯æŒ( Maven é¡¹ç›® <code>tcc-transaction-dubbo</code> ) æ•´ä½“ä»£ç ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/01.png" alt=""></p><ul><li><code>proxy</code></li><li><code>context</code></li></ul><p>æˆ‘ä»¬åˆ†æˆä¸¤ä¸ªå°èŠ‚åˆ†äº«è¿™ä¸¤ä¸ªåŒ…å®ç°çš„åŠŸèƒ½ã€‚</p><p><strong>ç¬”è€…æš‚æ—¶å¯¹ Dubbo äº†è§£çš„ä¸å¤Ÿæ·±å…¥ï¼Œå¦‚æœæœ‰é”™è¯¯çš„åœ°æ–¹ï¼Œè¿˜çƒ¦è¯·æŒ‡å‡ºï¼Œè°¢è°¢ã€‚</strong></p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º TCC-Transaction ç‚¹èµï¼<a href="https://github.com/changmingxie/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>psï¼šç¬”è€…å‡è®¾ä½ å·²ç»é˜…è¯»è¿‡<a href="https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x" rel="external nofollow noopener noreferrer" target="_blank">ã€Štcc-transaction å®˜æ–¹æ–‡æ¡£ â€”â€” ä½¿ç”¨æŒ‡å—1.2.xã€‹</a>ã€‚</p><h1 id="2-Dubbo-ä»£ç†"><a href="#2-Dubbo-ä»£ç†" class="headerlink" title="2. Dubbo ä»£ç†"></a>2. Dubbo ä»£ç†</h1><p>å°† Dubbo Service æ–¹æ³•ä¸Šçš„<strong>æ³¨è§£</strong> <code>@Compensable</code> ï¼Œè‡ªåŠ¨ç”Ÿæˆæ³¨è§£çš„ <code>confirmMethod</code>ã€<code>cancelMethod</code>ã€<code>transactionContextEditor</code> å±æ€§ï¼Œä¾‹å­ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Compensable</span>(propagation=Propagation.SUPPORTS, confirmMethod=<span class="string">"record"</span>, cancelMethod=<span class="string">"record"</span>, transactionContextEditor=DubboTransactionContextEditor.class)</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">record</span><span class="params">(RedPacketTradeOrderDto paramRedPacketTradeOrderDto)</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è¯¥ä»£ç é€šè¿‡ Javassist ç”Ÿæˆçš„ Proxy ä»£ç çš„ç¤ºä¾‹ã€‚</li><li><code>propagation=Propagation.SUPPORTS</code> ï¼šæ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œã€‚<strong>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ REQUIRED</strong> ï¼Ÿå¦‚æœä½¿ç”¨ REQUIRED äº‹åŠ¡ä¼ æ’­çº§åˆ«ï¼Œäº‹åŠ¡æ¢å¤é‡è¯•æ—¶ï¼Œä¼šå‘èµ·æ–°çš„äº‹åŠ¡ã€‚</li><li><code>confirmMethod</code>ã€<code>cancelMethod</code> ä½¿ç”¨å’Œ try æ–¹æ³•<strong>ç›¸åŒæ–¹æ³•å</strong>ï¼š<strong>æœ¬åœ°å‘èµ·</strong>è¿œç¨‹æœåŠ¡ TCC confirm / cancel é˜¶æ®µï¼Œè°ƒç”¨ç›¸åŒæ–¹æ³•è¿›è¡Œäº‹åŠ¡çš„æäº¤æˆ–å›æ»šã€‚è¿œç¨‹æœåŠ¡çš„ CompensableTransactionInterceptor ä¼šæ ¹æ®äº‹åŠ¡çš„çŠ¶æ€æ˜¯ CONFIRMING / CANCELLING æ¥è°ƒç”¨å¯¹åº”æ–¹æ³•ã€‚<ul><li><img src="../../../images/TCC-Transaction/2018_03_07/02.png" alt=""></li></ul></li><li><code>transactionContextEditor=DubboTransactionContextEditor.class</code>ï¼Œä½¿ç”¨ Dubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨ï¼Œåœ¨<a href="#">ã€Œ3. Dubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨ã€</a>è¯¦ç»†åˆ†äº«ã€‚</li></ul><p>Dubbo Service Proxy æä¾›äº†ä¸¤ç§ç”Ÿæˆæ–¹å¼ï¼š</p><ul><li>JavassistProxyFactoryï¼ŒåŸºäº Javassist æ–¹å¼</li><li>JdkProxyFactoryï¼ŒåŸºäº JDK åŠ¨æ€ä»£ç†æœºåˆ¶</li></ul><p>è¿™å—å†…å®¹æˆ‘ä»¬ä¸æ‹“å±•å¼€ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦ç‚¹å‡»å¦‚ä¸‹æ–‡ç« ï¼š</p><ul><li><a href="http://daveztong.github.io/2016/11/23/Dubbo%E5%AD%A6%E4%B9%A0-%E7%90%86%E8%A7%A3%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDubboå­¦ä¹ -ç†è§£åŠ¨æ€ä»£ç†ã€‹</a></li><li><a href="http://javatar.iteye.com/blog/814426" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDubbo ä½œè€…åšå®¢ â€”â€” åŠ¨æ€ä»£ç†æ–¹æ¡ˆæ€§èƒ½å¯¹æ¯”ã€‹</a></li><li><a href="http://blog.csdn.net/quhongwei_zhanqiu/article/details/41597261" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDubboåŸç†è§£æ-ä»£ç†ä¹‹Javassistç”Ÿæˆçš„ä¼ªä»£ç ã€‹</a></li><li><strong><a href="http://blog.kazaff.me/2015/01/27/dubbo%E4%B8%AD%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2%E7%9A%84%E7%BB%86%E8%8A%82/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDubboçš„æœåŠ¡æš´éœ²ç»†èŠ‚ã€‹</a></strong></li></ul><p>Dubbo çš„ Invoker æ¨¡å‹æ˜¯éå¸¸å…³é”®çš„æ¦‚å¿µï¼Œçœ‹ä¸‹å›¾ï¼š</p><p><img src="../../../images/TCC-Transaction/2018_03_07/03.jpeg" alt=""></p><h2 id="2-1-JavassistProxyFactory"><a href="#2-1-JavassistProxyFactory" class="headerlink" title="2.1 JavassistProxyFactory"></a>2.1 JavassistProxyFactory</h2><h3 id="2-1-1-Javassist"><a href="#2-1-1-Javassist" class="headerlink" title="2.1.1 Javassist"></a>2.1.1 Javassist</h3><blockquote><p>Javassist æ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†æã€ç¼–è¾‘å’Œåˆ›å»º Java å­—èŠ‚ç çš„ç±»åº“ã€‚é€šè¿‡ä½¿ç”¨Javassist å¯¹å­—èŠ‚ç æ“ä½œå¯ä»¥å®ç°åŠ¨æ€ â€AOPâ€ æ¡†æ¶ã€‚</p><p>å…³äº Java å­—èŠ‚ç çš„å¤„ç†ï¼Œç›®å‰æœ‰å¾ˆå¤šå·¥å…·ï¼Œå¦‚ bcelï¼Œasm( cglibåªæ˜¯å¯¹asmåˆå°è£…äº†ä¸€å±‚ )ã€‚ä¸è¿‡è¿™äº›éƒ½éœ€è¦ç›´æ¥è·Ÿè™šæ‹ŸæœºæŒ‡ä»¤æ‰“äº¤é“ã€‚</p><p>Javassist çš„ä¸»è¦çš„ä¼˜ç‚¹ï¼Œåœ¨äºç®€å•ï¼Œè€Œä¸”å¿«é€Ÿï¼Œç›´æ¥ä½¿ç”¨ Java ç¼–ç çš„å½¢å¼ï¼Œè€Œä¸éœ€è¦äº†è§£è™šæ‹ŸæœºæŒ‡ä»¤ï¼Œå°±èƒ½åŠ¨æ€æ”¹å˜ç±»çš„ç»“æ„ï¼Œæˆ–è€…åŠ¨æ€ç”Ÿæˆç±»ã€‚</p></blockquote><ul><li>ç²—ç•¥ä¸€çœ‹ï¼Œå¯èƒ½ä¸å¤Ÿå½¢è±¡ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡çœ‹ TCC-Transaction å¦‚ä½•ä½¿ç”¨æ¥ç†è§£ç†è§£ã€‚</li><li><a href="http://www.cnblogs.com/sunfie/p/5154246.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJavaå­¦ä¹ ä¹‹javassist<br>ã€‹</a></li><li><a href="http://blog.csdn.net/qbg19881206/article/details/8993562" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJavassist å­—èŠ‚ç æ“ä½œã€‹</a></li></ul><h3 id="2-1-2-TccJavassistProxyFactory"><a href="#2-1-2-TccJavassistProxyFactory" class="headerlink" title="2.1.2 TccJavassistProxyFactory"></a>2.1.2 TccJavassistProxyFactory</h3><p><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccJavassistProxyFactory</code>ï¼ŒTCC Javassist ä»£ç†å·¥å‚ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TccJavassistProxyFactory</span> <span class="keyword">extends</span> <span class="title">JavassistProxyFactory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker, Class&lt;?&gt;[] interfaces)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (T) TccProxy.getProxy(interfaces).newInstance(<span class="keyword">new</span> InvokerInvocationHandler(invoker));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>é¡¹ç›®å¯åŠ¨æ—¶</strong>ï¼Œè°ƒç”¨ <code>TccJavassistProxyFactory#getProxy(...)</code> æ–¹æ³•ï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨ Proxyã€‚</li><li><code>com.alibaba.dubbo.rpc.proxy.InvokerInvocationHandler</code>ï¼ŒDubbo è°ƒç”¨å¤„ç†å™¨ï¼Œç‚¹å‡»<a href="https://github.com/alibaba/dubbo/blob/17619dfa974457b00fe27cf68ae3f9d266709666/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/proxy/InvokerInvocationHandler.java" rel="external nofollow noopener noreferrer" target="_blank">è¿æ¥</a>æŸ¥çœ‹ä»£ç ã€‚</li></ul><h3 id="2-1-3-TccProxy-amp-TccClassGenerator"><a href="#2-1-3-TccProxy-amp-TccClassGenerator" class="headerlink" title="2.1.3 TccProxy &amp; TccClassGenerator"></a>2.1.3 TccProxy &amp; TccClassGenerator</h3><p><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccProxy</code>ï¼ŒTCC Proxy å·¥å‚ï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨ Proxy ã€‚ç¬”è€…è®¤ä¸ºï¼ŒTccProxy æ”¹æˆ TccProxyFactory æ›´åˆé€‚ï¼ŒåŸå› åœ¨ä¸‹æ–‡ã€‚</p><p><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccClassGenerator</code>ï¼ŒTCC ç±»ä»£ç ç”Ÿæˆå™¨ï¼ŒåŸºäº Javassist å®ç°ã€‚</p><p><strong>ğŸ¦…æ¡ˆä¾‹</strong></p><p>ä¸€ä¸ª Dubbo Serviceï¼ŒTccProxy ä¼šåŠ¨æ€ç”Ÿæˆä¸¤ä¸ªç±»ï¼š</p><ul><li>Dubbo Service è°ƒç”¨ Proxy</li><li>Dubbo Service è°ƒç”¨ ProxyFactoryï¼Œç”Ÿæˆå¯¹åº”çš„ Dubbo Service Proxy</li></ul><p>ä¾‹å¦‚ Dubbo Service æ¥å£å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedPacketTradeOrderService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Compensable</span></div><div class="line">    <span class="function">String <span class="title">record</span><span class="params">(RedPacketTradeOrderDto tradeOrderDto)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ç”Ÿæˆ Dubbo Service è°ƒç”¨ <strong>ProxyFactory</strong> å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TccProxy3</span> <span class="keyword">extends</span> <span class="title">TccProxy</span> <span class="keyword">implements</span> <span class="title">TccClassGenerator</span>.<span class="title">DC</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">(InvocationHandler paramInvocationHandler)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> proxy3(paramInvocationHandler);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>TccProxy æä¾› <code>#newInstance(handler)</code> æ–¹æ³•ï¼Œåˆ›å»º Proxyï¼Œæ‰€ä»¥ç¬”è€…è®¤ä¸ºï¼ŒTccProxy æ”¹æˆ TccProxyFactory æ›´åˆé€‚ã€‚</li><li><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccClassGenerator.DC</code> åŠ¨æ€ç”Ÿæˆç±»æ ‡è®°ï¼Œæ ‡è®°è¯¥ç±»ç”± TccClassGenerator ç”Ÿæˆçš„ã€‚</li></ul><p>ç”Ÿæˆ Dubbo Service è°ƒç”¨ <strong>Proxy</strong> å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">proxy3</span> <span class="keyword">implements</span> <span class="title">TccClassGenerator</span>.<span class="title">DC</span>, <span class="title">RedPacketTradeOrderService</span>, <span class="title">EchoService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Method[] methods;</div><div class="line">    <span class="keyword">private</span> InvocationHandler handler;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">proxy3</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">proxy3</span><span class="params">(InvocationHandler paramInvocationHandler)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.handler = paramInvocationHandler;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Compensable</span>(propagation = Propagation.SUPPORTS, confirmMethod = <span class="string">"record"</span>, cancelMethod = <span class="string">"record"</span>, transactionContextEditor = DubboTransactionContextEditor.class)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">record</span><span class="params">(RedPacketTradeOrderDto paramRedPacketTradeOrderDto)</span> </span>&#123;</div><div class="line">        Object[] arrayOfObject = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">        arrayOfObject[<span class="number">0</span>] = paramRedPacketTradeOrderDto;</div><div class="line">        Object localObject = <span class="keyword">this</span>.handler.invoke(<span class="keyword">this</span>, methods[<span class="number">0</span>], arrayOfObject);</div><div class="line">        <span class="keyword">return</span> (String) localObject;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> Object $echo(Object paramObject) &#123;</div><div class="line">        Object[] arrayOfObject = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">        arrayOfObject[<span class="number">0</span>] = paramObject;</div><div class="line">        Object localObject = <span class="keyword">this</span>.handler.invoke(<span class="keyword">this</span>, methods[<span class="number">1</span>], arrayOfObject);</div><div class="line">        <span class="keyword">return</span> (Object) localObject;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>com.alibaba.dubbo.rpc.service.EchoService</code>ï¼ŒDubbo Service å›å£°æœåŠ¡æ¥å£ï¼Œç”¨äºæœåŠ¡å¥åº·æ£€æŸ¥ï¼ŒDubbo Service é»˜è®¤è‡ªåŠ¨å®ç°è¯¥æ¥å£ï¼Œç‚¹å‡»<a href="https://github.com/alibaba/dubbo/blob/17619dfa974457b00fe27cf68ae3f9d266709666/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/service/EchoService.java" rel="external nofollow noopener noreferrer" target="_blank">è¿æ¥</a>æŸ¥çœ‹ä»£ç ã€‚</li><li><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccClassGenerator.DC</code> åŠ¨æ€ç”Ÿæˆç±»æ ‡è®°ï¼Œæ ‡è®°è¯¥ç±»ç”± TccClassGenerator ç”Ÿæˆçš„ã€‚</li></ul><p><strong>ğŸ¦…å®ç°</strong></p><p>è°ƒç”¨ <code>TccProxy#getProxy(...)</code> æ–¹æ³•ï¼Œè·å¾— <strong>TCC Proxy å·¥å‚</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">// ã€TccProxy.javaã€‘</span></div><div class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TccProxy <span class="title">getProxy</span><span class="params">(ClassLoader cl, Class&lt;?&gt;... ics)</span> </span>&#123;</div><div class="line">  <span class="number">3</span>:     <span class="comment">// æ ¡éªŒæ¥å£è¶…è¿‡ä¸Šé™</span></div><div class="line">  <span class="number">4</span>:     <span class="keyword">if</span> (ics.length &gt; <span class="number">65535</span>) &#123;</div><div class="line">  <span class="number">5</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"interface limit exceeded"</span>);</div><div class="line">  <span class="number">6</span>:     &#125;</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:     <span class="comment">// use interface class name list as key.</span></div><div class="line">  <span class="number">9</span>:     StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line"> <span class="number">10</span>:     <span class="keyword">for</span> (Class&lt;?&gt; ic : ics) &#123;</div><div class="line"> <span class="number">11</span>:         String itf = ic.getName();</div><div class="line"> <span class="number">12</span>:         <span class="comment">// æ ¡éªŒæ˜¯å¦ä¸ºæ¥å£</span></div><div class="line"> <span class="number">13</span>:         <span class="keyword">if</span> (!ic.isInterface()) &#123;</div><div class="line"> <span class="number">14</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(itf + <span class="string">" is not a interface."</span>);</div><div class="line"> <span class="number">15</span>:         &#125;</div><div class="line"> <span class="number">16</span>:         <span class="comment">// åŠ è½½æ¥å£ç±»</span></div><div class="line"> <span class="number">17</span>:         Class&lt;?&gt; tmp = <span class="keyword">null</span>;</div><div class="line"> <span class="number">18</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">19</span>:             tmp = Class.forName(itf, <span class="keyword">false</span>, cl);</div><div class="line"> <span class="number">20</span>:         &#125; <span class="keyword">catch</span> (ClassNotFoundException ignored) &#123;</div><div class="line"> <span class="number">21</span>:         &#125;</div><div class="line"> <span class="number">22</span>:         <span class="keyword">if</span> (tmp != ic) &#123; <span class="comment">// åŠ è½½æ¥å£ç±»å¤±è´¥</span></div><div class="line"> <span class="number">23</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(ic + <span class="string">" is not visible from class loader"</span>);</div><div class="line"> <span class="number">24</span>:         &#125;</div><div class="line"> <span class="number">25</span>:         sb.append(itf).append(<span class="string">';'</span>);</div><div class="line"> <span class="number">26</span>:     &#125;</div><div class="line"> <span class="number">27</span>:     String key = sb.toString();</div><div class="line"> <span class="number">28</span>: </div><div class="line"> <span class="number">29</span>:     <span class="comment">// get cache by class loader.</span></div><div class="line"> <span class="number">30</span>:     Map&lt;String, Object&gt; cache;</div><div class="line"> <span class="number">31</span>:     <span class="keyword">synchronized</span> (ProxyCacheMap) &#123;</div><div class="line"> <span class="number">32</span>:         cache = ProxyCacheMap.get(cl);</div><div class="line"> <span class="number">33</span>:         <span class="keyword">if</span> (cache == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">34</span>:             cache = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</div><div class="line"> <span class="number">35</span>:             ProxyCacheMap.put(cl, cache);</div><div class="line"> <span class="number">36</span>:         &#125;</div><div class="line"> <span class="number">37</span>:     &#125;</div><div class="line"> <span class="number">38</span>: </div><div class="line"> <span class="number">39</span>:     <span class="comment">// è·å¾— TccProxy å·¥å‚</span></div><div class="line"> <span class="number">40</span>:     TccProxy proxy = <span class="keyword">null</span>;</div><div class="line"> <span class="number">41</span>:     <span class="keyword">synchronized</span> (cache) &#123;</div><div class="line"> <span class="number">42</span>:         <span class="keyword">do</span> &#123;</div><div class="line"> <span class="number">43</span>:             <span class="comment">// ä»ç¼“å­˜ä¸­è·å– TccProxy å·¥å‚</span></div><div class="line"> <span class="number">44</span>:             Object value = cache.get(key);</div><div class="line"> <span class="number">45</span>:             <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Reference&lt;?&gt;) &#123;</div><div class="line"> <span class="number">46</span>:                 proxy = (TccProxy) ((Reference&lt;?&gt;) value).get();</div><div class="line"> <span class="number">47</span>:                 <span class="keyword">if</span> (proxy != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">48</span>:                     <span class="keyword">return</span> proxy;</div><div class="line"> <span class="number">49</span>:                 &#125;</div><div class="line"> <span class="number">50</span>:             &#125;</div><div class="line"> <span class="number">51</span>:             <span class="comment">// ç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œè®¾ç½®ç”Ÿæˆ TccProxy ä»£ç æ ‡è®°ã€‚åˆ›å»ºä¸­æ—¶ï¼Œå…¶ä»–åˆ›å»ºè¯·æ±‚ç­‰å¾…ï¼Œé¿å…å¹¶å‘ã€‚</span></div><div class="line"> <span class="number">52</span>:             <span class="keyword">if</span> (value == PendingGenerationMarker) &#123;</div><div class="line"> <span class="number">53</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">54</span>:                     cache.wait();</div><div class="line"> <span class="number">55</span>:                 &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</div><div class="line"> <span class="number">56</span>:                 &#125;</div><div class="line"> <span class="number">57</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">58</span>:                 cache.put(key, PendingGenerationMarker);</div><div class="line"> <span class="number">59</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">60</span>:             &#125;</div><div class="line"> <span class="number">61</span>:         &#125;</div><div class="line"> <span class="number">62</span>:         <span class="keyword">while</span> (<span class="keyword">true</span>);</div><div class="line"> <span class="number">63</span>:     &#125;</div><div class="line"> <span class="number">64</span>: </div><div class="line"> <span class="number">65</span>:     <span class="keyword">long</span> id = PROXY_CLASS_COUNTER.getAndIncrement();</div><div class="line"> <span class="number">66</span>:     String pkg = <span class="keyword">null</span>;</div><div class="line"> <span class="number">67</span>:     TccClassGenerator ccp = <span class="keyword">null</span>; <span class="comment">// proxy class generator</span></div><div class="line"> <span class="number">68</span>:     TccClassGenerator ccm = <span class="keyword">null</span>; <span class="comment">// proxy factory class generator</span></div><div class="line"> <span class="number">69</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">70</span>:         <span class="comment">// åˆ›å»º Tcc class ä»£ç ç”Ÿæˆå™¨</span></div><div class="line"> <span class="number">71</span>:         ccp = TccClassGenerator.newInstance(cl);</div><div class="line"> <span class="number">72</span>: </div><div class="line"> <span class="number">73</span>:         Set&lt;String&gt; worked = <span class="keyword">new</span> HashSet&lt;String&gt;(); <span class="comment">// å·²å¤„ç†æ–¹æ³•ç­¾åé›†åˆã€‚keyï¼šæ–¹æ³•ç­¾å</span></div><div class="line"> <span class="number">74</span>:         List&lt;Method&gt; methods = <span class="keyword">new</span> ArrayList&lt;Method&gt;(); <span class="comment">// å·²å¤„ç†æ–¹æ³•é›†åˆã€‚</span></div><div class="line"> <span class="number">75</span>: </div><div class="line"> <span class="number">76</span>:         <span class="comment">// å¤„ç†æ¥å£</span></div><div class="line"> <span class="number">77</span>:         <span class="keyword">for</span> (Class&lt;?&gt; ic : ics) &#123;</div><div class="line"> <span class="number">78</span>:             <span class="comment">// é public æ¥å£ï¼Œä½¿ç”¨æ¥å£åŒ…å</span></div><div class="line"> <span class="number">79</span>:             <span class="keyword">if</span> (!Modifier.isPublic(ic.getModifiers())) &#123;</div><div class="line"> <span class="number">80</span>:                 String npkg = ic.getPackage().getName();</div><div class="line"> <span class="number">81</span>:                 <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">82</span>:                     pkg = npkg;</div><div class="line"> <span class="number">83</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">84</span>:                     <span class="keyword">if</span> (!pkg.equals(npkg)) &#123; <span class="comment">// å®ç°äº†ä¸¤ä¸ªé public çš„æ¥å£ï¼Œ</span></div><div class="line"> <span class="number">85</span>:                         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"non-public interfaces from different packages"</span>);</div><div class="line"> <span class="number">86</span>:                     &#125;</div><div class="line"> <span class="number">87</span>:                 &#125;</div><div class="line"> <span class="number">88</span>:             &#125;</div><div class="line"> <span class="number">89</span>:             <span class="comment">// æ·»åŠ æ¥å£</span></div><div class="line"> <span class="number">90</span>:             ccp.addInterface(ic);</div><div class="line"> <span class="number">91</span>:             <span class="comment">// å¤„ç†æ¥å£æ–¹æ³•</span></div><div class="line"> <span class="number">92</span>:             <span class="keyword">for</span> (Method method : ic.getMethods()) &#123;</div><div class="line"> <span class="number">93</span>:                 <span class="comment">// æ·»åŠ æ–¹æ³•ç­¾ååˆ°å·²å¤„ç†æ–¹æ³•ç­¾åé›†åˆ</span></div><div class="line"> <span class="number">94</span>:                 String desc = ReflectUtils.getDesc(method);</div><div class="line"> <span class="number">95</span>:                 <span class="keyword">if</span> (worked.contains(desc)) &#123;</div><div class="line"> <span class="number">96</span>:                     <span class="keyword">continue</span>;</div><div class="line"> <span class="number">97</span>:                 &#125;</div><div class="line"> <span class="number">98</span>:                 worked.add(desc);</div><div class="line"> <span class="number">99</span>:                 <span class="comment">// ç”Ÿæˆæ¥å£æ–¹æ³•å®ç°ä»£ç </span></div><div class="line"><span class="number">100</span>:                 <span class="keyword">int</span> ix = methods.size();</div><div class="line"><span class="number">101</span>:                 Class&lt;?&gt; rt = method.getReturnType();</div><div class="line"><span class="number">102</span>:                 Class&lt;?&gt;[] pts = method.getParameterTypes();</div><div class="line"><span class="number">103</span>:                 StringBuilder code = <span class="keyword">new</span> StringBuilder(<span class="string">"Object[] args = new Object["</span>).append(pts.length).append(<span class="string">"];"</span>);</div><div class="line"><span class="number">104</span>:                 <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; pts.length; j++) &#123;</div><div class="line"><span class="number">105</span>:                     code.append(<span class="string">" args["</span>).append(j).append(<span class="string">"] = ($w)$"</span>).append(j + <span class="number">1</span>).append(<span class="string">";"</span>);</div><div class="line"><span class="number">106</span>:                 &#125;</div><div class="line"><span class="number">107</span>:                 code.append(<span class="string">" Object ret = handler.invoke(this, methods["</span>).append(ix).append(<span class="string">"], args);"</span>);</div><div class="line"><span class="number">108</span>:                 <span class="keyword">if</span> (!Void.TYPE.equals(rt)) &#123;</div><div class="line"><span class="number">109</span>:                     code.append(<span class="string">" return "</span>).append(asArgument(rt, <span class="string">"ret"</span>)).append(<span class="string">";"</span>);</div><div class="line"><span class="number">110</span>:                 &#125;</div><div class="line"><span class="number">111</span>:                 methods.add(method);</div><div class="line"><span class="number">112</span>:                 <span class="comment">// æ·»åŠ æ–¹æ³•</span></div><div class="line"><span class="number">113</span>:                 Compensable compensable = method.getAnnotation(Compensable.class);</div><div class="line"><span class="number">114</span>:                 <span class="keyword">if</span> (compensable != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">115</span>:                     ccp.addMethod(<span class="keyword">true</span>, method.getName(), method.getModifiers(), rt, pts, method.getExceptionTypes(), code.toString());</div><div class="line"><span class="number">116</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">117</span>:                     ccp.addMethod(<span class="keyword">false</span>, method.getName(), method.getModifiers(), rt, pts, method.getExceptionTypes(), code.toString());</div><div class="line"><span class="number">118</span>:                 &#125;</div><div class="line"><span class="number">119</span>:             &#125;</div><div class="line"><span class="number">120</span>:         &#125;</div><div class="line"><span class="number">121</span>: </div><div class="line"><span class="number">122</span>:         <span class="comment">// è®¾ç½®åŒ…è·¯å¾„</span></div><div class="line"><span class="number">123</span>:         <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">124</span>:             pkg = PACKAGE_NAME;</div><div class="line"><span class="number">125</span>:         &#125;</div><div class="line"><span class="number">126</span>: </div><div class="line"><span class="number">127</span>:         <span class="comment">// create ProxyInstance class.</span></div><div class="line"><span class="number">128</span>:         <span class="comment">// è®¾ç½®ç±»å</span></div><div class="line"><span class="number">129</span>:         String pcn = pkg + <span class="string">".proxy"</span> + id;</div><div class="line"><span class="number">130</span>:         ccp.setClassName(pcn);</div><div class="line"><span class="number">131</span>:         <span class="comment">// æ·»åŠ é™æ€å±æ€§ methods</span></div><div class="line"><span class="number">132</span>:         ccp.addField(<span class="string">"public static java.lang.reflect.Method[] methods;"</span>);</div><div class="line"><span class="number">133</span>:         <span class="comment">// æ·»åŠ å±æ€§ handler</span></div><div class="line"><span class="number">134</span>:         ccp.addField(<span class="string">"private "</span> + InvocationHandler.class.getName() + <span class="string">" handler;"</span>);</div><div class="line"><span class="number">135</span>:         <span class="comment">// æ·»åŠ æ„é€ æ–¹æ³•ï¼Œå‚æ•° handler</span></div><div class="line"><span class="number">136</span>:         ccp.addConstructor(Modifier.PUBLIC, <span class="keyword">new</span> Class&lt;?&gt;[]&#123;InvocationHandler.class&#125;, <span class="keyword">new</span> Class&lt;?&gt;[<span class="number">0</span>], <span class="string">"handler=$1;"</span>);</div><div class="line"><span class="number">137</span>:         <span class="comment">// æ·»åŠ æ„é€ æ–¹æ³•ï¼Œå‚æ•° ç©º</span></div><div class="line"><span class="number">138</span>:         ccp.addDefaultConstructor();</div><div class="line"><span class="number">139</span>:         <span class="comment">// ç”Ÿæˆç±»</span></div><div class="line"><span class="number">140</span>:         Class&lt;?&gt; clazz = ccp.toClass();</div><div class="line"><span class="number">141</span>:         <span class="comment">// è®¾ç½®é™æ€å±æ€§ methods</span></div><div class="line"><span class="number">142</span>:         clazz.getField(<span class="string">"methods"</span>).set(<span class="keyword">null</span>, methods.toArray(<span class="keyword">new</span> Method[<span class="number">0</span>]));</div><div class="line"><span class="number">143</span>: </div><div class="line"><span class="number">144</span>:         <span class="comment">// create TccProxy class.</span></div><div class="line"><span class="number">145</span>:         <span class="comment">// åˆ›å»º Tcc class ä»£ç ç”Ÿæˆå™¨</span></div><div class="line"><span class="number">146</span>:         ccm = TccClassGenerator.newInstance(cl);</div><div class="line"><span class="number">147</span>:         <span class="comment">// è®¾ç½®ç±»å</span></div><div class="line"><span class="number">148</span>:         String fcn = TccProxy.class.getName() + id;</div><div class="line"><span class="number">149</span>:         ccm.setClassName(fcn);</div><div class="line"><span class="number">150</span>:         <span class="comment">// æ·»åŠ æ„é€ æ–¹æ³•ï¼Œå‚æ•° ç©º</span></div><div class="line"><span class="number">151</span>:         ccm.addDefaultConstructor();</div><div class="line"><span class="number">152</span>:         <span class="comment">// è®¾ç½®çˆ¶ç±»ä¸º TccProxy.class</span></div><div class="line"><span class="number">153</span>:         ccm.setSuperClass(TccProxy.class);</div><div class="line"><span class="number">154</span>:         <span class="comment">// æ·»åŠ æ–¹æ³• #newInstance(handler)</span></div><div class="line"><span class="number">155</span>:         ccm.addMethod(<span class="string">"public Object newInstance("</span> + InvocationHandler.class.getName() + <span class="string">" h)&#123; return new "</span> + pcn + <span class="string">"($1); &#125;"</span>);</div><div class="line"><span class="number">156</span>:         <span class="comment">// ç”Ÿæˆç±»</span></div><div class="line"><span class="number">157</span>:         Class&lt;?&gt; pc = ccm.toClass();</div><div class="line"><span class="number">158</span>:         <span class="comment">// åˆ›å»º TccProxy å¯¹è±¡</span></div><div class="line"><span class="number">159</span>:         proxy = (TccProxy) pc.newInstance();</div><div class="line"><span class="number">160</span>:     &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line"><span class="number">161</span>:         <span class="keyword">throw</span> e;</div><div class="line"><span class="number">162</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">163</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e.getMessage(), e);</div><div class="line"><span class="number">164</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">165</span>:         <span class="comment">// release TccClassGenerator</span></div><div class="line"><span class="number">166</span>:         <span class="keyword">if</span> (ccp != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">167</span>:             ccp.release();</div><div class="line"><span class="number">168</span>:         &#125;</div><div class="line"><span class="number">169</span>:         <span class="keyword">if</span> (ccm != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">170</span>:             ccm.release();</div><div class="line"><span class="number">171</span>:         &#125;</div><div class="line"><span class="number">172</span>:         <span class="comment">// å”¤é†’ç¼“å­˜ wait</span></div><div class="line"><span class="number">173</span>:         <span class="keyword">synchronized</span> (cache) &#123;</div><div class="line"><span class="number">174</span>:             <span class="keyword">if</span> (proxy == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">175</span>:                 cache.remove(key);</div><div class="line"><span class="number">176</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">177</span>:                 cache.put(key, <span class="keyword">new</span> WeakReference&lt;TccProxy&gt;(proxy));</div><div class="line"><span class="number">178</span>:             &#125;</div><div class="line"><span class="number">179</span>:             cache.notifyAll();</div><div class="line"><span class="number">180</span>:         &#125;</div><div class="line"><span class="number">181</span>:     &#125;</div><div class="line"><span class="number">182</span>:     <span class="keyword">return</span> proxy;</div><div class="line"><span class="number">183</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 3 è‡³ 7 è¡Œ ï¼šæ ¡éªŒæ¥å£è¶…è¿‡ä¸Šé™ã€‚</li><li>ç¬¬ 8 è‡³ 27 è¡Œ ï¼šä½¿ç”¨æ¥å£é›†åˆç±»åä»¥ <code>;</code> åˆ†éš”æ‹¼æ¥ï¼Œä½œä¸º Proxy çš„å”¯ä¸€æ ‡è¯†ã€‚ä¾‹å¦‚ ï¼š<code>key=org.mengyun.tcctransaction.sample.dubbo.redpacket.api.RedPacketAccountService;com.alibaba.dubbo.rpc.service.EchoService;</code> ã€‚</li><li><p>ç¬¬ 29 è‡³ 37 è¡Œ ï¼šè·å¾— Proxy å¯¹åº”çš„ ClassLoaderã€‚è¿™é‡Œæˆ‘ä»¬çœ‹ä¸‹é™æ€å±æ€§ <code>ProxyCacheMap</code> çš„å®šä¹‰ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* Proxy å¯¹è±¡ç¼“å­˜</span></div><div class="line"><span class="comment">* key ï¼šClassLoader</span></div><div class="line"><span class="comment">* value.key ï¼šTcc Proxy æ ‡è¯†ã€‚ä½¿ç”¨ Tcc Proxy å®ç°æ¥å£åæ‹¼æ¥</span></div><div class="line"><span class="comment">* value.value ï¼šTcc Proxy å·¥å‚å¯¹è±¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;ClassLoader, Map&lt;String, Object&gt;&gt; ProxyCacheMap = <span class="keyword">new</span> WeakHashMap&lt;ClassLoader, Map&lt;String, Object&gt;&gt;();</div></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ WeakHashMapï¼Œå½“ ClassLoader è¢«å›æ”¶æ—¶ï¼Œå…¶å¯¹åº”çš„å€¼ä¸€èµ·è¢«ç§»é™¤ã€‚</li><li><a href="http://blog.csdn.net/yangzl2008/article/details/6980709" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠWeakHashMapå’ŒHashMapçš„åŒºåˆ«ã€‹</a></li><li><a href="http://www.cnblogs.com/skywang12345/p/3311092.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJava é›†åˆç³»åˆ—13ä¹‹ WeakHashMapè¯¦ç»†ä»‹ç»(æºç è§£æ)å’Œä½¿ç”¨ç¤ºä¾‹ã€‹</a></li></ul></li><li>ç¬¬ 39 è‡³ 63 è¡Œ ï¼šä¸€ç›´è·å¾— <strong>TCC Proxy å·¥å‚</strong>ç›´åˆ°æˆåŠŸã€‚<ul><li>ç¬¬ 43 è‡³ 50 è¡Œ ï¼šä»<strong>ç¼“å­˜</strong>ä¸­è·å– TCC Proxy å·¥å‚ã€‚</li><li>ç¬¬ 51 è‡³ 60 è¡Œ ï¼šè‹¥ç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œè®¾ç½®<strong>æ­£åœ¨ç”Ÿæˆ TccProxy ä»£ç æ ‡è®°</strong>ã€‚åˆ›å»ºä¸­æ—¶ï¼Œå…¶ä»–åˆ›å»ºè¯·æ±‚ç­‰å¾…ï¼Œé¿å…å¹¶å‘ã€‚</li></ul></li><li><p>ç¬¬ 65 è¡Œ ï¼š<code>PROXY_CLASS_COUNTER</code>ï¼ŒProxy Class è®¡æ•°ï¼Œç”¨äºç”Ÿæˆ Proxy ç±»åè‡ªå¢ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicLong PROXY_CLASS_COUNTER = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</div></pre></td></tr></table></figure></li><li><p>ç¬¬ 66 è‡³ 67 è¡Œ</p><ul><li><code>ccm</code>ï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨ <strong>ProxyFactory</strong> çš„ä»£ç ç”Ÿæˆå™¨</li><li><code>ccp</code>ï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨ <strong>Proxy</strong> çš„ä»£ç ç”Ÿæˆå™¨</li></ul></li><li><p><strong>ç¬¬ 70 è‡³ 142 è¡Œ ï¼šç”Ÿæˆ Dubbo Service è°ƒç”¨ Proxy çš„ä»£ç </strong>ã€‚</p><ul><li><p>ç¬¬ 70 è‡³ 71 è¡Œ ï¼šè°ƒç”¨ <code>TccClassGenerator#newInstance(loader)</code> æ–¹æ³•ï¼Œ åˆ›å»ºç”Ÿæˆ Dubbo Service è°ƒç”¨ <strong>Proxy</strong> çš„ä»£ç ç”Ÿæˆå™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TccClassGenerator.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TccClassGenerator</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * CtClass hash é›†åˆ</span></div><div class="line"><span class="comment">     * keyï¼šç±»å</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ClassPool mPool;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TccClassGenerator <span class="title">newInstance</span><span class="params">(ClassLoader loader)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TccClassGenerator(getClassPool(loader));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">TccClassGenerator</span><span class="params">(ClassPool pool)</span> </span>&#123;</div><div class="line">        mPool = pool;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>ClassPool</strong> æ˜¯ä¸€ä¸ª CtClass å¯¹è±¡çš„ hash è¡¨ï¼Œç±»ååšä¸º key ã€‚ClassPool çš„ <code>#get(key)</code> æœç´¢ hash è¡¨æ‰¾åˆ°ä¸æŒ‡å®š key å…³è”çš„ CtClass å¯¹è±¡ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ° CtClass å¯¹è±¡ï¼Œ<code>#get(key)</code> è¯»ä¸€ä¸ªç±»æ–‡ä»¶æ„å»ºæ–°çš„ CtClass å¯¹è±¡ï¼Œå®ƒæ˜¯è¢«è®°å½•åœ¨ hash è¡¨ä¸­ç„¶åè¿”å›è¿™ä¸ªå¯¹è±¡ã€‚</li></ul></li><li><p>ç¬¬ 76 è‡³ 120 è¡Œï¼Œå¤„ç†æ¥å£ã€‚</p><ul><li>ç¬¬ 79 è‡³ 88 è¡Œï¼Œç”Ÿæˆç±»çš„åŒ…åã€‚</li><li><p>ç¬¬ 89 è‡³ 90 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#addInterface(cl)</code> æ–¹æ³•ï¼Œæ·»åŠ ç”Ÿæˆç±»çš„æ¥å£( <strong>Dubbo Service æ¥å£</strong> )ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç”Ÿæˆç±»çš„æ¥å£é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> Set&lt;String&gt; mInterfaces;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addInterface</span><span class="params">(Class&lt;?&gt; cl)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> addInterface(cl.getName());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addInterface</span><span class="params">(String cn)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mInterfaces == <span class="keyword">null</span>) &#123;</div><div class="line">       mInterfaces = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mInterfaces.add(cn);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li><li><p>ç¬¬ 93 è‡³ 98 è¡Œï¼Œæ·»åŠ æ–¹æ³•ç­¾ååˆ°å·²å¤„ç†æ–¹æ³•ç­¾åé›†åˆã€‚å¤šä¸ªæ¥å£å¯èƒ½å­˜åœ¨ç›¸åŒçš„æ¥å£æ–¹æ³•ï¼Œè·³è¿‡ç›¸åŒçš„æ–¹æ³•ï¼Œé¿å…å†²çªã€‚</p></li><li><p>ç¬¬ 99 è‡³ 110 è¡Œï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨å®ç°ä»£ç ã€‚æ¡ˆä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">record</span><span class="params">(RedPacketTradeOrderDto paramRedPacketTradeOrderDto)</span> </span>&#123;</div><div class="line">  Object[] arrayOfObject = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">  arrayOfObject[<span class="number">0</span>] = paramRedPacketTradeOrderDto;</div><div class="line">  Object localObject = <span class="keyword">this</span>.handler.invoke(<span class="keyword">this</span>, methods[<span class="number">0</span>], arrayOfObject);</div><div class="line">  <span class="keyword">return</span> (String)localObject;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><img src="../../../images/TCC-Transaction/2018_03_07/04.png" alt=""></li></ul></li><li><p>ç¬¬ 112 è‡³ 118 è¡Œ ï¼šè°ƒç”¨ <code>TccClassGenerator#addMethod(...)</code> æ–¹æ³•ï¼Œæ·»åŠ ç”Ÿæˆçš„æ–¹æ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç”Ÿæˆç±»çš„æ–¹æ³•ä»£ç é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> List&lt;String&gt; mMethods;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å¸¦ <span class="doctag">@Compensable</span> æ–¹æ³•ä»£ç é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> Set&lt;String&gt; compensableMethods = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addMethod</span><span class="params">(<span class="keyword">boolean</span> isCompensableMethod, String name, <span class="keyword">int</span> mod, Class&lt;?&gt; rt, Class&lt;?&gt;[] pts, Class&lt;?&gt;[] ets, String body)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ‹¼æ¥æ–¹æ³•</span></div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">   sb.append(modifier(mod)).append(<span class="string">' '</span>).append(ReflectUtils.getName(rt)).append(<span class="string">' '</span>).append(name);</div><div class="line">   sb.append(<span class="string">'('</span>);</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; i++) &#123;</div><div class="line">       <span class="keyword">if</span> (i &gt; <span class="number">0</span>)</div><div class="line">           sb.append(<span class="string">','</span>);</div><div class="line">       sb.append(ReflectUtils.getName(pts[i]));</div><div class="line">       sb.append(<span class="string">" arg"</span>).append(i);</div><div class="line">   &#125;</div><div class="line">   sb.append(<span class="string">')'</span>);</div><div class="line">   <span class="keyword">if</span> (ets != <span class="keyword">null</span> &amp;&amp; ets.length &gt; <span class="number">0</span>) &#123;</div><div class="line">       sb.append(<span class="string">" throws "</span>);</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ets.length; i++) &#123;</div><div class="line">           <span class="keyword">if</span> (i &gt; <span class="number">0</span>)</div><div class="line">               sb.append(<span class="string">','</span>);</div><div class="line">           sb.append(ReflectUtils.getName(ets[i]));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   sb.append(<span class="string">'&#123;'</span>).append(body).append(<span class="string">'&#125;'</span>);</div><div class="line">   <span class="comment">// æ˜¯å¦æœ‰ @Compensable æ³¨è§£</span></div><div class="line">   <span class="keyword">if</span> (isCompensableMethod) &#123;</div><div class="line">       compensableMethods.add(sb.toString());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> addMethod(sb.toString());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addMethod</span><span class="params">(String code)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mMethods == <span class="keyword">null</span>) &#123;</div><div class="line">       mMethods = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mMethods.add(code);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul></li><li><p>ç¬¬ 122 è‡³ 130 è¡Œï¼Œç”Ÿæˆç±»å( ä¾‹å¦‚ï¼Œ<code>org.mengyun.tcctransaction.dubbo.proxy.javassist.proxy3</code> )ï¼Œå¹¶è°ƒç”¨ <code>TccClassGenerator#setClassName(...)</code> æ–¹æ³•ï¼Œè®¾ç½®ç±»åã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç”Ÿæˆç±»çš„ç±»å</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> String mClassName;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">setClassName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">   mClassName = name;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li><li><p>ç¬¬ 131 è‡³ 134 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#addField(...)</code> æ–¹æ³•ï¼Œæ·»åŠ <strong>é™æ€</strong>å±æ€§ <code>methods</code> ( Dubbo Service æ–¹æ³•é›†åˆ )å’Œå±æ€§ <code>handler</code> ( Dubbo InvocationHandler )ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç”Ÿæˆç±»çš„å±æ€§é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> List&lt;String&gt; mFields;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addField</span><span class="params">(String code)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mFields == <span class="keyword">null</span>) &#123;</div><div class="line">       mFields = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mFields.add(code);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li><li><p>ç¬¬ 135 è‡³ 136 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#addConstructor(...)</code> æ–¹æ³•ï¼Œæ·»åŠ å‚æ•°ä¸º <code>handler</code> çš„æ„é€ æ–¹æ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç”Ÿæˆç±»çš„éç©ºæ„é€ æ–¹æ³•ä»£ç é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> List&lt;String&gt; mConstructors;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addConstructor</span><span class="params">(<span class="keyword">int</span> mod, Class&lt;?&gt;[] pts, Class&lt;?&gt;[] ets, String body)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ„é€ æ–¹æ³•ä»£ç </span></div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">   sb.append(modifier(mod)).append(<span class="string">' '</span>).append(SIMPLE_NAME_TAG);</div><div class="line">   sb.append(<span class="string">'('</span>);</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; i++) &#123;</div><div class="line">       <span class="keyword">if</span> (i &gt; <span class="number">0</span>)</div><div class="line">           sb.append(<span class="string">','</span>);</div><div class="line">       sb.append(ReflectUtils.getName(pts[i]));</div><div class="line">       sb.append(<span class="string">" arg"</span>).append(i);</div><div class="line">   &#125;</div><div class="line">   sb.append(<span class="string">')'</span>);</div><div class="line">   <span class="keyword">if</span> (ets != <span class="keyword">null</span> &amp;&amp; ets.length &gt; <span class="number">0</span>) &#123;</div><div class="line">       sb.append(<span class="string">" throws "</span>);</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ets.length; i++) &#123;</div><div class="line">           <span class="keyword">if</span> (i &gt; <span class="number">0</span>)</div><div class="line">               sb.append(<span class="string">','</span>);</div><div class="line">           sb.append(ReflectUtils.getName(ets[i]));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   sb.append(<span class="string">'&#123;'</span>).append(body).append(<span class="string">'&#125;'</span>);</div><div class="line">   <span class="comment">//</span></div><div class="line">   <span class="keyword">return</span> addConstructor(sb.toString());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addConstructor</span><span class="params">(String code)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mConstructors == <span class="keyword">null</span>) &#123;</div><div class="line">       mConstructors = <span class="keyword">new</span> LinkedList&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mConstructors.add(code);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addConstructor</span><span class="params">(String code)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mConstructors == <span class="keyword">null</span>) &#123;</div><div class="line">       mConstructors = <span class="keyword">new</span> LinkedList&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mConstructors.add(code);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li><li><p>ç¬¬ 137 è‡³ 138 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#addDefaultConstructor()</code> æ–¹æ³•ï¼Œæ·»åŠ é»˜è®¤ç©ºæ„é€ æ–¹æ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* é»˜è®¤ç©ºæ„é€ æ–¹æ³•</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mDefaultConstructor = <span class="keyword">false</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addDefaultConstructor</span><span class="params">()</span> </span>&#123;</div><div class="line">   mDefaultConstructor = <span class="keyword">true</span>;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li><li><p>ç¬¬ 139 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#toClass()</code> æ–¹æ³•ï¼Œ<strong>ç”Ÿæˆç±»</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> Class&lt;?&gt; toClass() &#123;</div><div class="line"> <span class="number">2</span>:    <span class="comment">// mCtc éç©ºæ—¶ï¼Œè¿›è¡Œé‡Šæ”¾ï¼›ä¸‹é¢ä¼šè¿›è¡Œåˆ›å»º mCtc</span></div><div class="line"> <span class="number">3</span>:    <span class="keyword">if</span> (mCtc != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">4</span>:        mCtc.detach();</div><div class="line"> <span class="number">5</span>:    &#125;</div><div class="line"> <span class="number">6</span>:    <span class="keyword">long</span> id = CLASS_NAME_COUNTER.getAndIncrement();</div><div class="line"> <span class="number">7</span>:    <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">8</span>:        CtClass ctcs = mSuperClass == <span class="keyword">null</span> ? <span class="keyword">null</span> : mPool.get(mSuperClass);</div><div class="line"> <span class="number">9</span>:        <span class="keyword">if</span> (mClassName == <span class="keyword">null</span>) &#123; <span class="comment">// ç±»å</span></div><div class="line"><span class="number">10</span>:            mClassName = (mSuperClass == <span class="keyword">null</span> || javassist.Modifier.isPublic(ctcs.getModifiers())</div><div class="line"><span class="number">11</span>:                    ? TccClassGenerator.class.getName() : mSuperClass + <span class="string">"$sc"</span>) + id;</div><div class="line"><span class="number">12</span>:        &#125;</div><div class="line"><span class="number">13</span>:        <span class="comment">// åˆ›å»º mCtc</span></div><div class="line"><span class="number">14</span>:        mCtc = mPool.makeClass(mClassName);</div><div class="line"><span class="number">15</span>:        <span class="keyword">if</span> (mSuperClass != <span class="keyword">null</span>) &#123; <span class="comment">// ç»§æ‰¿ç±»</span></div><div class="line"><span class="number">16</span>:            mCtc.setSuperclass(ctcs);</div><div class="line"><span class="number">17</span>:        &#125;</div><div class="line"><span class="number">18</span>:        mCtc.addInterface(mPool.get(DC.class.getName())); <span class="comment">// add dynamic class tag.</span></div><div class="line"><span class="number">19</span>:        <span class="keyword">if</span> (mInterfaces != <span class="keyword">null</span>) &#123; <span class="comment">// å®ç°æ¥å£é›†åˆ</span></div><div class="line"><span class="number">20</span>:            <span class="keyword">for</span> (String cl : mInterfaces) &#123;</div><div class="line"><span class="number">21</span>:                mCtc.addInterface(mPool.get(cl));</div><div class="line"><span class="number">22</span>:            &#125;</div><div class="line"><span class="number">23</span>:        &#125;</div><div class="line"><span class="number">24</span>:        <span class="keyword">if</span> (mFields != <span class="keyword">null</span>) &#123; <span class="comment">// å±æ€§é›†åˆ</span></div><div class="line"><span class="number">25</span>:            <span class="keyword">for</span> (String code : mFields) &#123;</div><div class="line"><span class="number">26</span>:                mCtc.addField(CtField.make(code, mCtc));</div><div class="line"><span class="number">27</span>:            &#125;</div><div class="line"><span class="number">28</span>:        &#125;</div><div class="line"><span class="number">29</span>:        <span class="keyword">if</span> (mMethods != <span class="keyword">null</span>) &#123; <span class="comment">// æ–¹æ³•é›†åˆ</span></div><div class="line"><span class="number">30</span>:            <span class="keyword">for</span> (String code : mMethods) &#123;</div><div class="line"><span class="number">31</span>:                <span class="keyword">if</span> (code.charAt(<span class="number">0</span>) == <span class="string">':'</span>) &#123;</div><div class="line"><span class="number">32</span>:                    mCtc.addMethod(CtNewMethod.copy(getCtMethod(mCopyMethods.get(code.substring(<span class="number">1</span>))), code.substring(<span class="number">1</span>, code.indexOf(<span class="string">'('</span>)), mCtc, <span class="keyword">null</span>));</div><div class="line"><span class="number">33</span>:                &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">34</span>:                    CtMethod ctMethod = CtNewMethod.make(code, mCtc);</div><div class="line"><span class="number">35</span>:                    <span class="keyword">if</span> (compensableMethods.contains(code)) &#123;</div><div class="line"><span class="number">36</span>:                        <span class="comment">// è®¾ç½® @Compensable å±æ€§</span></div><div class="line"><span class="number">37</span>:                        ConstPool constpool = mCtc.getClassFile().getConstPool();</div><div class="line"><span class="number">38</span>:                        AnnotationsAttribute attr = <span class="keyword">new</span> AnnotationsAttribute(constpool, AnnotationsAttribute.visibleTag);</div><div class="line"><span class="number">39</span>:                        Annotation annot = <span class="keyword">new</span> Annotation(<span class="string">"org.mengyun.tcctransaction.api.Compensable"</span>, constpool);</div><div class="line"><span class="number">40</span>:                        EnumMemberValue enumMemberValue = <span class="keyword">new</span> EnumMemberValue(constpool);</div><div class="line"><span class="number">41</span>:                        enumMemberValue.setType(<span class="string">"org.mengyun.tcctransaction.api.Propagation"</span>);</div><div class="line"><span class="number">42</span>:                        enumMemberValue.setValue(<span class="string">"SUPPORTS"</span>);</div><div class="line"><span class="number">43</span>:                        annot.addMemberValue(<span class="string">"propagation"</span>, enumMemberValue);</div><div class="line"><span class="number">44</span>:                        annot.addMemberValue(<span class="string">"confirmMethod"</span>, <span class="keyword">new</span> StringMemberValue(ctMethod.getName(), constpool));</div><div class="line"><span class="number">45</span>:                        annot.addMemberValue(<span class="string">"cancelMethod"</span>, <span class="keyword">new</span> StringMemberValue(ctMethod.getName(), constpool));</div><div class="line"><span class="number">46</span>:                        ClassMemberValue classMemberValue = <span class="keyword">new</span> ClassMemberValue(<span class="string">"org.mengyun.tcctransaction.dubbo.context.DubboTransactionContextEditor"</span>, constpool);</div><div class="line"><span class="number">47</span>:                        annot.addMemberValue(<span class="string">"transactionContextEditor"</span>, classMemberValue);</div><div class="line"><span class="number">48</span>:                        attr.addAnnotation(annot);</div><div class="line"><span class="number">49</span>:                        ctMethod.getMethodInfo().addAttribute(attr);</div><div class="line"><span class="number">50</span>:                    &#125;</div><div class="line"><span class="number">51</span>:                    mCtc.addMethod(ctMethod);</div><div class="line"><span class="number">52</span>:                &#125;</div><div class="line"><span class="number">53</span>:            &#125;</div><div class="line"><span class="number">54</span>:        &#125;</div><div class="line"><span class="number">55</span>:        <span class="keyword">if</span> (mDefaultConstructor) &#123; <span class="comment">// ç©ºå‚æ•°æ„é€ æ–¹æ³•</span></div><div class="line"><span class="number">56</span>:            mCtc.addConstructor(CtNewConstructor.defaultConstructor(mCtc));</div><div class="line"><span class="number">57</span>:        &#125;</div><div class="line"><span class="number">58</span>:        <span class="keyword">if</span> (mConstructors != <span class="keyword">null</span>) &#123; <span class="comment">// å¸¦å‚æ•°æ„é€ æ–¹æ³•</span></div><div class="line"><span class="number">59</span>:            <span class="keyword">for</span> (String code : mConstructors) &#123;</div><div class="line"><span class="number">60</span>:                <span class="keyword">if</span> (code.charAt(<span class="number">0</span>) == <span class="string">':'</span>) &#123;</div><div class="line"><span class="number">61</span>:                    mCtc.addConstructor(CtNewConstructor.copy(getCtConstructor(mCopyConstructors.get(code.substring(<span class="number">1</span>))), mCtc, <span class="keyword">null</span>));</div><div class="line"><span class="number">62</span>:                &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">63</span>:                    String[] sn = mCtc.getSimpleName().split(<span class="string">"\\$+"</span>); <span class="comment">// inner class name include $.</span></div><div class="line"><span class="number">64</span>:                    mCtc.addConstructor(CtNewConstructor.make(code.replaceFirst(SIMPLE_NAME_TAG, sn[sn.length - <span class="number">1</span>]), mCtc));</div><div class="line"><span class="number">65</span>:                &#125;</div><div class="line"><span class="number">66</span>:            &#125;</div><div class="line"><span class="number">67</span>:        &#125;</div><div class="line"><span class="number">68</span>: <span class="comment">//            mCtc.debugWriteFile("/Users/yunai/test/" + mCtc.getSimpleName().replaceAll(".", "/") + ".class");</span></div><div class="line"><span class="number">69</span>:        <span class="comment">// ç”Ÿæˆ</span></div><div class="line"><span class="number">70</span>:        <span class="keyword">return</span> mCtc.toClass();</div><div class="line"><span class="number">71</span>:    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line"><span class="number">72</span>:        <span class="keyword">throw</span> e;</div><div class="line"><span class="number">73</span>:    &#125; <span class="keyword">catch</span> (NotFoundException e) &#123;</div><div class="line"><span class="number">74</span>:        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e.getMessage(), e);</div><div class="line"><span class="number">75</span>:    &#125; <span class="keyword">catch</span> (CannotCompileException e) &#123;</div><div class="line"><span class="number">76</span>:        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e.getMessage(), e);</div><div class="line"><span class="number">77</span>:    &#125;</div><div class="line"><span class="number">78</span>: &#125;</div></pre></td></tr></table></figure><ul><li>åŸºäº Javassist ç”Ÿæˆç±»ã€‚è¿™é‡Œä¸åšæ‹“å±•è§£é‡Šï¼Œé…åˆ<a href="http://www.cnblogs.com/sunfie/p/5154246.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJavaå­¦ä¹ ä¹‹javassistã€‹</a>ä¸€èµ·ç†è§£ã€‚</li><li>ç¬¬ 18 è¡Œï¼Œæ·»åŠ  <code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccClassGenerator.DC</code> åŠ¨æ€ç”Ÿæˆç±»æ ‡è®°ï¼Œæ ‡è®°è¯¥ç±»ç”± TccClassGenerator ç”Ÿæˆçš„ã€‚</li><li>ç¬¬ 34 è‡³ 50 è¡Œï¼Œè®¾ç½® @Compensable é»˜è®¤å±æ€§ã€‚</li></ul></li><li><p>ç¬¬ 141 è‡³ 142 è¡Œï¼Œè®¾ç½® Dubbo Service æ–¹æ³•é›†åˆè®¾ç½®åˆ°é™æ€å±æ€§ <code>methods</code> ä¸Šã€‚</p></li></ul></li><li><p><strong>ç¬¬ 144 è‡³ 157 è¡Œï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨ Proxy å·¥å‚çš„ä»£ç </strong>ã€‚</p><ul><li>ç¬¬ 146 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#newInstance(loader)</code> æ–¹æ³•ï¼Œ åˆ›å»ºç”Ÿæˆ Dubbo Service è°ƒç”¨ <strong>Proxy å·¥å‚</strong> çš„ä»£ç ç”Ÿæˆå™¨ã€‚</li><li>ç¬¬ 147 è‡³ 149 è¡Œï¼Œç”Ÿæˆç±»å( ä¾‹å¦‚ï¼Œ<code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccProxy3</code> )ï¼Œå¹¶è°ƒç”¨ <code>TccClassGenerator#setClassName(...)</code> æ–¹æ³•ï¼Œè®¾ç½®ç±»åã€‚</li><li>ç¬¬ 150 è‡³ 151 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#addDefaultConstructor()</code> æ–¹æ³•ï¼Œæ·»åŠ é»˜è®¤ç©ºæ„é€ æ–¹æ³•ã€‚</li><li><p>ç¬¬ 152 è‡³ 153 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#mSuperClass()</code> æ–¹æ³•ï¼Œè®¾ç½®ç»§æ‰¿çˆ¶ç±» <strong><code>TccProxy</code></strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç”Ÿæˆç±»çš„çˆ¶ç±»åå­—</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> String mSuperClass;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">setSuperClass</span><span class="params">(Class&lt;?&gt; cl)</span> </span>&#123;</div><div class="line">   mSuperClass = cl.getName();</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li><li><p>ç¬¬ 154 è‡³ 155 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#addInterface(cl)</code> æ–¹æ³•ï¼Œæ·»åŠ ç”Ÿæˆ Proxy å®ç°ä»£ç çš„æ–¹æ³•ã€‚ä»£ç æ¡ˆä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">(InvocationHandler paramInvocationHandler)</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> <span class="keyword">new</span> proxy3(paramInvocationHandler);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li><li><p>ç¬¬ 156 è‡³ 157 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#toClass()</code> æ–¹æ³•ï¼Œ<strong>ç”Ÿæˆç±»</strong>ã€‚</p></li></ul></li><li><p>ç¬¬ 159 è¡Œï¼Œè°ƒç”¨ <code>TccProxy#newInstance()</code> æ–¹æ³•ï¼Œåˆ›å»º Proxy ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* get instance with default handler.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> instance.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> newInstance(THROW_UNSUPPORTED_INVOKER);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* get instance with special handler.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> instance.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">(InvocationHandler handler)</span></span>;</div></pre></td></tr></table></figure><ul><li><code>#newInstance(handler)</code>ï¼ŒæŠ½è±¡æ–¹æ³•ï¼Œä¸Šé¢ç¬¬ 154 è‡³ 155 è¡Œç”Ÿæˆã€‚TccJavassistProxyFactory è°ƒç”¨è¯¥æ–¹æ³•ï¼Œè·å¾— Proxy ã€‚</li></ul></li><li><p>ç¬¬ 165 è‡³ 171 è¡Œï¼Œé‡Šæ”¾ TccClassGenerator ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mCtc != <span class="keyword">null</span>) &#123;</div><div class="line">       mCtc.detach();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mInterfaces != <span class="keyword">null</span>) &#123;</div><div class="line">       mInterfaces.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mFields != <span class="keyword">null</span>) &#123;</div><div class="line">       mFields.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mMethods != <span class="keyword">null</span>) &#123;</div><div class="line">       mMethods.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mConstructors != <span class="keyword">null</span>) &#123;</div><div class="line">       mConstructors.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mCopyMethods != <span class="keyword">null</span>) &#123;</div><div class="line">       mCopyMethods.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mCopyConstructors != <span class="keyword">null</span>) &#123;</div><div class="line">       mCopyConstructors.clear();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>ç¬¬ 172 è‡³ 180 è¡Œï¼Œè®¾ç½® Proxy å·¥å‚ç¼“å­˜ï¼Œå¹¶å”¤é†’ç­‰å¾…çº¿ç¨‹ã€‚</p></li></ul><p><strong>psï¼š</strong>ä»£ç æ¯”è¾ƒå¤šï¼Œæ”¶è·ä¼šæ¯”è¾ƒå¤šï¼Œç®—æ˜¯ Javassist å®æˆ˜æ¡ˆä¾‹äº†ã€‚TCC-Transaction ä½œè€…åœ¨å®ç°ä¸Šè¿°ç±»ï¼Œå¯èƒ½å‚è€ƒäº† Dubbo è‡ªå¸¦çš„å®ç°ï¼š</p><ul><li><a href="https://github.com/alibaba/dubbo/blob/8f20e3a68efc350e3fbaa965e0a8e8a59fef1b3c/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/Proxy.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.alibaba.dubbo.common.bytecode.Proxy</code></a></li><li><a href="https://github.com/alibaba/dubbo/blob/8f20e3a68efc350e3fbaa965e0a8e8a59fef1b3c/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/ClassGenerator.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.alibaba.dubbo.common.bytecode.ClassGenerator</code></a></li><li><a href="https://github.com/alibaba/dubbo/blob/8f20e3a68efc350e3fbaa965e0a8e8a59fef1b3c/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/Wrapper.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.alibaba.dubbo.common.bytecode.Wrapper</code></a></li></ul><h3 id="2-1-4-é…ç½®-Dubbo-Proxy"><a href="#2-1-4-é…ç½®-Dubbo-Proxy" class="headerlink" title="2.1.4 é…ç½® Dubbo Proxy"></a>2.1.4 é…ç½® Dubbo Proxy</h3><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// META-INF.dubbo/com.alibaba.dubbo.rpc.ProxyFactory</div><div class="line">tccJavassist=org.mengyun.tcctransaction.dubbo.proxy.javassist.TccJavassistProxyFactory</div><div class="line"></div><div class="line">// tcc-transaction-dubbo.xml</div><div class="line"><span class="tag">&lt;<span class="name">dubbo:provider</span> <span class="attr">proxy</span>=<span class="string">"tccJavassist"</span>/&gt;</span></div></pre></td></tr></table></figure><p>ç›®å‰ Maven é¡¹ç›® <code>tcc-transaction-dubbo</code> å·²ç»<strong>é»˜è®¤</strong>é…ç½®ï¼Œå¼•å…¥å³å¯ã€‚</p><p><img src="../../../images/TCC-Transaction/2018_03_07/05.png" alt=""></p><h2 id="2-2-JdkProxyFactory"><a href="#2-2-JdkProxyFactory" class="headerlink" title="2.2 JdkProxyFactory"></a>2.2 JdkProxyFactory</h2><h3 id="2-2-1-JDK-Proxy"><a href="#2-2-1-JDK-Proxy" class="headerlink" title="2.2.1 JDK Proxy"></a>2.2.1 JDK Proxy</h3><p><a href="http://blog.csdn.net/jiankunking/article/details/52143504#" rel="external nofollow noopener noreferrer" target="_blank">ã€Š Java JDK åŠ¨æ€ä»£ç†ï¼ˆAOPï¼‰ä½¿ç”¨åŠå®ç°åŸç†åˆ†æã€‹</a></p><h3 id="2-2-2-TccJdkProxyFactory"><a href="#2-2-2-TccJdkProxyFactory" class="headerlink" title="2.2.2 TccJdkProxyFactory"></a>2.2.2 TccJdkProxyFactory</h3><p><code>org.mengyun.tcctransaction.dubbo.proxy.jd.TccJdkProxyFactory</code>ï¼ŒTCC JDK ä»£ç†å·¥å‚ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TccJdkProxyFactory</span> <span class="keyword">extends</span> <span class="title">JdkProxyFactory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker, Class&lt;?&gt;[] interfaces)</span> </span>&#123;</div><div class="line">        T proxy = (T) Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), interfaces, <span class="keyword">new</span> InvokerInvocationHandler(invoker));</div><div class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), interfaces, <span class="keyword">new</span> TccInvokerInvocationHandler(proxy, invoker));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>é¡¹ç›®å¯åŠ¨æ—¶</strong>ï¼Œè°ƒç”¨ <code>TccJavassistProxyFactory#getProxy(...)</code> æ–¹æ³•ï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨ Proxyã€‚</li><li><strong>ç¬¬ä¸€æ¬¡</strong>è°ƒç”¨ <code>Proxy#newProxyInstance(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºè°ƒç”¨ Dubbo Service æœåŠ¡çš„ Proxyã€‚<code>com.alibaba.dubbo.rpc.proxy.InvokerInvocationHandler</code>ï¼ŒDubbo è°ƒç”¨å¤„ç†å™¨ï¼Œç‚¹å‡»<a href="https://github.com/alibaba/dubbo/blob/17619dfa974457b00fe27cf68ae3f9d266709666/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/proxy/InvokerInvocationHandler.java" rel="external nofollow noopener noreferrer" target="_blank">è¿æ¥</a>æŸ¥çœ‹ä»£ç ã€‚</li><li><strong>ç¬¬äºŒæ¬¡</strong>è°ƒç”¨ <code>Proxy#newProxyInstance(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºå¯¹è°ƒç”¨ Dubbo Service çš„ Proxy çš„ Proxyã€‚ä¸ºä»€ä¹ˆä¼šæœ‰ä¸¤å±‚ Proxyï¼Ÿç­”æ¡ˆåœ¨ä¸‹èŠ‚ TccInvokerInvocationHandler ã€‚</li></ul><h3 id="2-2-3-TccInvokerInvocationHandler"><a href="#2-2-3-TccInvokerInvocationHandler" class="headerlink" title="2.2.3 TccInvokerInvocationHandler"></a>2.2.3 TccInvokerInvocationHandler</h3><p><code>org.mengyun.tcctransaction.dubbo.proxy.jdk.TccInvokerInvocationHandler</code>ï¼ŒTCC è°ƒç”¨å¤„ç†å™¨ï¼Œåœ¨è°ƒç”¨ Dubbo Service æœåŠ¡æ—¶ï¼Œä½¿ç”¨ ResourceCoordinatorInterceptor æ‹¦æˆªå¤„ç†ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TccInvokerInvocationHandler</span> <span class="keyword">extends</span> <span class="title">InvokerInvocationHandler</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment"> 4:      * proxy</span></div><div class="line"><span class="comment"> 5:      */</span></div><div class="line"> <span class="number">6</span>:     <span class="keyword">private</span> Object target;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:     <span class="function"><span class="keyword">public</span> <span class="title">TccInvokerInvocationHandler</span><span class="params">(Invoker&lt;?&gt; handler)</span> </span>&#123;</div><div class="line"> <span class="number">9</span>:         <span class="keyword">super</span>(handler);</div><div class="line"><span class="number">10</span>:     &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:     <span class="keyword">public</span> &lt;T&gt; TccInvokerInvocationHandler(T target, Invoker&lt;T&gt; invoker) &#123;</div><div class="line"><span class="number">13</span>:         <span class="keyword">super</span>(invoker);</div><div class="line"><span class="number">14</span>:         <span class="keyword">this</span>.target = target;</div><div class="line"><span class="number">15</span>:     &#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:     <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line"><span class="number">18</span>:         Compensable compensable = method.getAnnotation(Compensable.class);</div><div class="line"><span class="number">19</span>:         <span class="keyword">if</span> (compensable != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">20</span>:             <span class="comment">// è®¾ç½® @Compensable å±æ€§</span></div><div class="line"><span class="number">21</span>:             <span class="keyword">if</span> (StringUtils.isEmpty(compensable.confirmMethod())) &#123;</div><div class="line"><span class="number">22</span>:                 ReflectionUtils.changeAnnotationValue(compensable, <span class="string">"confirmMethod"</span>, method.getName());</div><div class="line"><span class="number">23</span>:                 ReflectionUtils.changeAnnotationValue(compensable, <span class="string">"cancelMethod"</span>, method.getName());</div><div class="line"><span class="number">24</span>:                 ReflectionUtils.changeAnnotationValue(compensable, <span class="string">"transactionContextEditor"</span>, DubboTransactionContextEditor.class);</div><div class="line"><span class="number">25</span>:                 ReflectionUtils.changeAnnotationValue(compensable, <span class="string">"propagation"</span>, Propagation.SUPPORTS);</div><div class="line"><span class="number">26</span>:             &#125;</div><div class="line"><span class="number">27</span>:             <span class="comment">// ç”Ÿæˆåˆ‡é¢</span></div><div class="line"><span class="number">28</span>:             ProceedingJoinPoint pjp = <span class="keyword">new</span> MethodProceedingJoinPoint(proxy, target, method, args);</div><div class="line"><span class="number">29</span>:             <span class="comment">// æ‰§è¡Œ</span></div><div class="line"><span class="number">30</span>:             <span class="keyword">return</span> FactoryBuilder.factoryOf(ResourceCoordinatorAspect.class).getInstance().interceptTransactionContextMethod(pjp);</div><div class="line"><span class="number">31</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">32</span>:             <span class="keyword">return</span> <span class="keyword">super</span>.invoke(target, method, args);</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:     &#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 18 è‡³ 26 è¡Œï¼Œè®¾ç½®å¸¦æœ‰ @Compensable å±æ€§çš„é»˜è®¤å±æ€§ã€‚</li><li><p>ç¬¬ 28 è¡Œï¼Œç”Ÿæˆæ–¹æ³•åˆ‡é¢ <code>org.mengyun.tcctransaction.dubbo.proxy.jdk.MethodProceedingJoinPoint</code>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodProceedingJoinPoint</span> <span class="keyword">implements</span> <span class="title">ProceedingJoinPoint</span>, <span class="title">JoinPoint</span>.<span class="title">StaticPart</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»£ç†å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Object proxy;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç›®æ ‡å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Object target;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ–¹æ³•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Method method;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‚æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Object[] args;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">proceed</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="comment">// Use reflection to invoke the method.</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ReflectionUtils.makeAccessible(method);</div><div class="line">            <span class="keyword">return</span> method.invoke(target, args);</div><div class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</div><div class="line">            <span class="comment">// Invoked method threw a checked exception.</span></div><div class="line">            <span class="comment">// We must rethrow it. The client won't see the interceptor.</span></div><div class="line">            <span class="keyword">throw</span> ex.getTargetException();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"Tried calling method ["</span> +</div><div class="line">                    method + <span class="string">"] on target ["</span> + target + <span class="string">"] failed"</span>, ex);</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"Could not access method ["</span> + method + <span class="string">"]"</span>, ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">proceed</span><span class="params">(Object[] objects)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="comment">//        throw new UnsupportedOperationException(); // TODO èŠ‹è‰¿ï¼šç–‘é—®</span></div><div class="line">        <span class="keyword">return</span> proceed();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥ä¸é‡è¦çš„æ–¹æ³•å’Œå¯¹è±¡</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è¯¥ç±»å‚è€ƒ <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-aop/src/main/java/org/springframework/aop/aspectj/MethodInvocationProceedingJoinPoint.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.aop.aspectj.MethodInvocationProceedingJoinPoint</code></a> å®ç°ã€‚</li><li>TODOã€1ã€‘ proxy å’Œ target æ˜¯å¦ä¿ç•™ä¸€ä¸ªå³å¯ï¼Ÿ</li><li>åœ¨åˆ‡é¢å¤„ç†å®Œæˆåï¼Œè°ƒç”¨ <code>#proceed(...)</code> æ–¹æ³•ï¼Œè¿›è¡Œè¿œç¨‹ Dubbo Service æœåŠ¡è°ƒç”¨ã€‚</li><li>TODOã€2ã€‘<code>#proceed(objects)</code> æŠ›å‡º throw new UnsupportedOperationException();ã€‚éœ€è¦è·Ÿä½œè€…ç¡®è®¤ä¸‹ã€‚</li></ul></li><li>è°ƒç”¨ <code>ResourceCoordinatorAspect#interceptTransactionContextMethod(...)</code> æ–¹æ³•ï¼Œå¯¹æ–¹æ³•åˆ‡é¢æ‹¦æˆªå¤„ç†ã€‚<strong>ä¸ºä»€ä¹ˆæ— éœ€è°ƒç”¨ CompensableTransactionAspect åˆ‡é¢</strong>ï¼Ÿå› ä¸ºä¼ æ’­çº§åˆ«ä¸º Propagation.SUPPORTSï¼Œä¸ä¼šå‘èµ·äº‹åŠ¡ã€‚</li></ul><h3 id="2-2-4-é…ç½®-Dubbo-Proxy"><a href="#2-2-4-é…ç½®-Dubbo-Proxy" class="headerlink" title="2.2.4 é…ç½® Dubbo Proxy"></a>2.2.4 é…ç½® Dubbo Proxy</h3><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// META-INF.dubbo/com.alibaba.dubbo.rpc.ProxyFactory</div><div class="line">tccJdk=org.mengyun.tcctransaction.dubbo.proxy.jdk.TccJdkProxyFactory</div><div class="line"></div><div class="line">// appcontext-service-dubbo.xml</div><div class="line"><span class="tag">&lt;<span class="name">dubbo:provider</span> <span class="attr">proxy</span>=<span class="string">"tccJdk"</span>/&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">proxy</span>=<span class="string">"tccJdk"</span> <span class="attr">id</span>=<span class="string">"captialTradeOrderService"</span></span></div><div class="line"><span class="tag">                     <span class="attr">interface</span>=<span class="string">"org.mengyun.tcctransaction.sample.dubbo.capital.api.CapitalTradeOrderService"</span> <span class="attr">timeout</span>=<span class="string">"5000"</span>/&gt;</span></div></pre></td></tr></table></figure><ul><li>ProxyFactory çš„ <code>tccJdk</code> åœ¨ Maven é¡¹ <code>tcc-transaction-dubbo</code> å·²ç»å£°æ˜ã€‚</li><li>å£°æ˜ <code>dubbo:provider</code> çš„ <code>proxy=&quot;tccJdk&quot;</code>ã€‚</li><li>å£°æ˜ <code>dubbo:reference</code> çš„ <code>proxy=&quot;tccJdk&quot;</code>ï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆã€‚</li></ul><h1 id="3-Dubbo-äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨"><a href="#3-Dubbo-äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨" class="headerlink" title="3. Dubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨"></a>3. Dubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨</h1><p><code>org.mengyun.tcctransaction.dubbo.context.DubboTransactionContextEditor</code>ï¼ŒDubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨å®ç°ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboTransactionContextEditor</span> <span class="keyword">implements</span> <span class="title">TransactionContextEditor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> TransactionContext <span class="title">get</span><span class="params">(Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">        String context = RpcContext.getContext().getAttachment(TransactionContextConstants.TRANSACTION_CONTEXT);</div><div class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(context)) &#123;</div><div class="line">            <span class="keyword">return</span> JSON.parseObject(context, TransactionContext.class);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(TransactionContext transactionContext, Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">        RpcContext.getContext().setAttachment(TransactionContextConstants.TRANSACTION_CONTEXT, JSON.toJSONString(transactionContext));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>é€šè¿‡ Dubbo çš„éšå¼ä¼ å‚çš„æ–¹å¼ï¼Œé¿å…åœ¨ Dubbo Service æ¥å£ä¸Šå£°æ˜ TransactionContext å‚æ•°ï¼Œå¯¹æ¥å£äº§ç”Ÿä¸€å®šçš„å…¥ä¾µã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>HOHOï¼Œå¯¹åŠ¨æ€ä»£ç†åˆå­¦ä¹ äº†ä¸€éï¼Œè›® High çš„ã€‚</p><p>è¿™é‡Œæ¨èåŠ¨æ€ä»£ç†æ— å…³ï¼Œå’Œ Dubbo ç›¸å…³çš„æ–‡ç« ï¼š</p><ul><li><a href="http://blog.kazaff.me/2015/01/27/dubbo%E4%B8%AD%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2%E7%9A%84%E7%BB%86%E8%8A%82/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDubboçš„æœåŠ¡æš´éœ²ç»†èŠ‚ã€‹</a>ã€‚</li><li><a href="http://weifuwu.io/2016/01/03/dubbo-provider-start/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDubbo Providerå¯åŠ¨ä¸»æµç¨‹ã€‹</a></li></ul><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/06.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ã€‚</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/TCC-Transaction/">TCC-Transaction</a></div><div class="article-share" id="share"><div data-url="http://www.iocoder.cn/TCC-Transaction/dubbo-support/" data-title="TCC-Transaction æºç åˆ†æ â€”â€” Dubbo æ”¯æŒ | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/TCC-Transaction/console/" title="TCC-Transaction æºç åˆ†æ â€”â€” è¿ç»´å¹³å°"><strong>PREVIOUS:</strong><br><span>TCC-Transaction æºç åˆ†æ â€”â€” è¿ç»´å¹³å°</span></a></div><div class="next"><a href="/TCC-Transaction/transaction-recovery/" title="TCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡æ¢å¤"><strong>NEXT:</strong><br><span>TCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡æ¢å¤</span></a></div></nav></div></div><footer><div id="footer"><img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display:none"><p class="copyright">Â© 2017 <a href="http://www.iocoder.cn" target="_blank" title="ç‹æ–‡æ–Œ">ç‹æ–‡æ–Œ</a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a> && Powered by <a href="http://hexo.io" target="_blank" title="hexo" rel="external nofollow noopener noreferrer">hexo</a> && Theme by <a href="http://gengbiao.me" target="_blank" title="coney" rel="external nofollow noopener noreferrer">coney</a></p></div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2");ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script src="/js/util.js"></script></body>