<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>TCC-Transaction æºç åˆ†æ â€”â€” TCC å®ç° | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="ç‹æ–‡æ–Œ"><meta name="description" content="1. æ¦‚è¿°
2. TCC åŸç†
3. TCC-Transaction åŸç†
4. äº‹åŠ¡ä¸å‚ä¸è€…

4.1 äº‹åŠ¡
4.2 å‚ä¸è€…


5. äº‹åŠ¡ç®¡ç†å™¨

5.1 å‘èµ·æ ¹äº‹åŠ¡
5.2 ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡
5.3 ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡
5.4 æäº¤äº‹åŠ¡
5.5 å›æ»šäº‹åŠ¡
5.6 æ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡


6. äº‹åŠ¡"><meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?9e70e3362807c1bd185a79655b307027";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG">èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</a></h1><a class="blog-motto">æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li><li><a href="/link_url">å‹é“¾</a></li></ul></ul></nav></div></header><div id="container"><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">2.</span> <span class="toc-text">2. TCC åŸç†</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">3.</span> <span class="toc-text">3. TCC-Transaction åŸç†</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">4.</span> <span class="toc-text">4. äº‹åŠ¡ä¸å‚ä¸è€…</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 äº‹åŠ¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 å‚ä¸è€…</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">5.</span> <span class="toc-text">5. äº‹åŠ¡ç®¡ç†å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 å‘èµ·æ ¹äº‹åŠ¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">5.4.</span> <span class="toc-text">5.4 æäº¤äº‹åŠ¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">5.5.</span> <span class="toc-text">5.5 å›æ»šäº‹åŠ¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">5.6.</span> <span class="toc-text">5.6 æ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">6.</span> <span class="toc-text">6. äº‹åŠ¡æ‹¦æˆªå™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 Compensable</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">6.2.</span> <span class="toc-text">6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">6.3.</span> <span class="toc-text">6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">7.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li><li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/TCC-Transaction/" title="TCC-Transaction">TCC-Transaction<sup>6</sup></a></li><li><a href="/categories/æŠ€æœ¯æ‚æ–‡/" title="æŠ€æœ¯æ‚æ–‡">æŠ€æœ¯æ‚æ–‡<sup>4</sup></a></li></ul></div></aside></div><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/TCC-Transaction/tcc-core/" title="TCC-Transaction æºç åˆ†æ â€”â€” TCC å®ç°" itemprop="url">TCC-Transaction æºç åˆ†æ â€”â€” TCC å®ç°</a></h1><p class="article-author"></p><p class="article-time">æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. TCC åŸç†</a></li><li><a href="#">3. TCC-Transaction åŸç†</a></li><li><a href="#">4. äº‹åŠ¡ä¸å‚ä¸è€…</a><ul><li><a href="#">4.1 äº‹åŠ¡</a></li><li><a href="#">4.2 å‚ä¸è€…</a></li></ul></li><li><a href="#">5. äº‹åŠ¡ç®¡ç†å™¨</a><ul><li><a href="#">5.1 å‘èµ·æ ¹äº‹åŠ¡</a></li><li><a href="#">5.2 ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡</a></li><li><a href="#">5.3 ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡</a></li><li><a href="#">5.4 æäº¤äº‹åŠ¡</a></li><li><a href="#">5.5 å›æ»šäº‹åŠ¡</a></li><li><a href="#">5.6 æ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡</a></li></ul></li><li><a href="#">6. äº‹åŠ¡æ‹¦æˆªå™¨</a><ul><li><a href="#">6.1 Compensable</a></li><li><a href="#">6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨</a></li><li><a href="#">6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« <strong>TCC å®ç°</strong>ã€‚ä¸»è¦æ¶‰åŠå¦‚ä¸‹ä¸‰ä¸ª Maven é¡¹ç›®ï¼š</p><ul><li><code>tcc-transaction-core</code> ï¼štcc-transaction åº•å±‚å®ç°ã€‚</li><li><code>tcc-transaction-api</code> ï¼štcc-transaction ä½¿ç”¨ APIã€‚</li><li><code>tcc-transaction-spring</code> ï¼štcc-transaction Spring æ”¯æŒã€‚</li></ul><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º TCC-Transaction ç‚¹èµï¼<a href="https://github.com/changmingxie/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>OKï¼Œå¼€å§‹æˆ‘ä»¬çš„ç¬¬ä¸€æ®µ TCC æ—…ç¨‹å§ã€‚</p><p>psï¼šç¬”è€…å‡è®¾ä½ å·²ç»é˜…è¯»è¿‡<a href="https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x" rel="external nofollow noopener noreferrer" target="_blank">ã€Štcc-transaction å®˜æ–¹æ–‡æ¡£ â€”â€” ä½¿ç”¨æŒ‡å—1.2.xã€‹</a>ã€‚</p><p>ps2ï¼š<strong>æœªç‰¹æ®Šè¯´æ˜çš„æƒ…å†µä¸‹ï¼Œæœ¬æ–‡äº‹åŠ¡æŒ‡çš„æ˜¯ TCCäº‹åŠ¡</strong>ã€‚</p><h1>2. TCC åŸç†</h1><blockquote><p>FROM https://support.hwclouds.com/devg-servicestage/zh-cn_topic_0056814426.html<br><strong>TCCäº‹åŠ¡</strong><br>ä¸ºäº†è§£å†³åœ¨äº‹åŠ¡è¿è¡Œè¿‡ç¨‹ä¸­å¤§é¢—ç²’åº¦èµ„æºé”å®šçš„é—®é¢˜ï¼Œä¸šç•Œæå‡ºä¸€ç§æ–°çš„äº‹åŠ¡æ¨¡å‹ï¼Œå®ƒæ˜¯åŸºäº<strong>ä¸šåŠ¡å±‚é¢</strong>çš„äº‹åŠ¡å®šä¹‰ã€‚é”ç²’åº¦å®Œå…¨ç”±ä¸šåŠ¡è‡ªå·±æ§åˆ¶ã€‚å®ƒæœ¬è´¨æ˜¯ä¸€ç§è¡¥å¿çš„æ€è·¯ã€‚å®ƒæŠŠäº‹åŠ¡è¿è¡Œè¿‡ç¨‹åˆ†æˆ Tryã€Confirm / Cancel ä¸¤ä¸ªé˜¶æ®µã€‚åœ¨æ¯ä¸ªé˜¶æ®µçš„é€»è¾‘ç”±<strong>ä¸šåŠ¡ä»£ç æ§åˆ¶</strong>ã€‚è¿™æ ·å°±äº‹åŠ¡çš„é”ç²’åº¦å¯ä»¥å®Œå…¨è‡ªç”±æ§åˆ¶ã€‚ä¸šåŠ¡å¯ä»¥åœ¨ç‰ºç‰²éš”ç¦»æ€§çš„æƒ…å†µä¸‹ï¼Œè·å–æ›´é«˜çš„æ€§èƒ½ã€‚</p></blockquote><ul><li>Try é˜¶æ®µ<ul><li>Try ï¼šå°è¯•æ‰§è¡Œä¸šåŠ¡<ul><li>å®Œæˆæ‰€æœ‰ä¸šåŠ¡æ£€æŸ¥( ä¸€è‡´æ€§ )</li><li>é¢„ç•™å¿…é¡»ä¸šåŠ¡èµ„æº( å‡†éš”ç¦»æ€§ )</li></ul></li></ul></li><li>Confirm / Cancel é˜¶æ®µï¼š<ul><li>Confirm ï¼šç¡®è®¤æ‰§è¡Œä¸šåŠ¡<ul><li>çœŸæ­£æ‰§è¡Œä¸šåŠ¡</li><li>ä¸åšä»»åŠ¡ä¸šåŠ¡æ£€æŸ¥</li><li>Confirm æ“ä½œæ»¡è¶³å¹‚ç­‰æ€§</li></ul></li><li>Cancel ï¼šå–æ¶ˆæ‰§è¡Œä¸šåŠ¡<ul><li>é‡Šæ”¾ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æº</li><li>Cancel æ“ä½œæ»¡è¶³å¹‚ç­‰æ€§</li></ul></li><li>Confirm ä¸ Cancel äº’æ–¥</li></ul></li></ul><p>æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_08/01.jpeg" alt=""></p><ul><li><p><strong>çº¢æ¡†éƒ¨åˆ†</strong>åŠŸèƒ½ç”± <code>tcc-transaction-core</code> å®ç°ï¼š</p><ul><li>å¯åŠ¨ä¸šåŠ¡æ´»åŠ¨</li><li>ç™»è®°ä¸šåŠ¡æ“ä½œ</li><li>æäº¤ / å›æ»šä¸šåŠ¡æ´»åŠ¨</li></ul></li><li><p><strong>é»„æ¡†éƒ¨åˆ†</strong>åŠŸèƒ½ç”± <code>tcc-transaction-http-sample</code> å®ç°( å®˜æ–¹æä¾›çš„ç¤ºä¾‹é¡¹ç›® )ï¼š</p><ul><li>Try æ“ä½œ</li><li>Confirm æ“ä½œ</li><li>Cancel æ“ä½œ</li></ul></li></ul><p><strong>ä¸ 2PCåè®® æ¯”è¾ƒ</strong>ï¼š</p><ul><li>ä½äºä¸šåŠ¡æœåŠ¡å±‚è€Œéè‡ªæ„¿å±‚</li><li>æ²¡æœ‰å•ç‹¬çš„å‡†å¤‡( Prepare )é˜¶æ®µï¼ŒTry æ“ä½œå…¼å¤‡è‡ªæ„¿æ“ä½œä¸å‡†å¤‡èƒ½åŠ›</li><li>Try æ“ä½œå¯ä»¥çµæ´»é€‰æ‹©ä¸šåŠ¡èµ„æºçš„é”å®šç²’åº¦</li><li>è¾ƒé«˜å¼€å‘æˆæœ¬</li></ul><p>å‚è€ƒèµ„æ–™ï¼š</p><ul><li><a href="https://www.zhihu.com/question/31813039" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ”¯ä»˜å®è¿è¥æ¶æ„ä¸­æŸ”æ€§äº‹åŠ¡æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿã€‹</a></li><li><a href="http://kaimingwan.com/post/fen-bu-shi/fen-bu-shi-shi-wu-de-dian-xing-chu-li-fang-shi-2pc-tcc-yi-bu-que-bao-he-zui-da-nu-li-xing" rel="external nofollow noopener noreferrer" target="_blank">ã€Šåˆ†å¸ƒå¼äº‹åŠ¡çš„å…¸å‹å¤„ç†æ–¹å¼:2PCã€TCCã€å¼‚æ­¥ç¡®ä¿å’Œæœ€å¤§åŠªåŠ›å‹ã€‹</a></li></ul><h1>3. TCC-Transaction åŸç†</h1><p>åœ¨ TCC é‡Œï¼Œä¸€ä¸ªä¸šåŠ¡æ´»åŠ¨å¯ä»¥æœ‰å¤šä¸ªäº‹åŠ¡ï¼Œæ¯ä¸ªä¸šåŠ¡æ“ä½œå½’å±äºä¸åŒçš„äº‹åŠ¡ï¼Œå³ä¸€ä¸ªäº‹åŠ¡å¯ä»¥åŒ…å«å¤šä¸ªä¸šåŠ¡æ“ä½œã€‚TCC-Transaction å°†æ¯ä¸ªä¸šåŠ¡æ“ä½œæŠ½è±¡æˆ<strong>äº‹åŠ¡å‚ä¸è€…</strong>ï¼Œæ¯ä¸ªäº‹åŠ¡å¯ä»¥åŒ…å«å¤šä¸ª<strong>å‚ä¸è€…</strong>ã€‚</p><p>å‚ä¸è€…éœ€è¦å£°æ˜ try / confirm / cancel ä¸‰ä¸ªç±»å‹çš„æ–¹æ³•ï¼Œå’Œ TCC çš„æ“ä½œä¸€ä¸€å¯¹åº”ã€‚åœ¨ç¨‹åºé‡Œï¼Œé€šè¿‡ @Compensable æ³¨è§£æ ‡è®°åœ¨ try æ–¹æ³•ä¸Šï¼Œå¹¶å¡«å†™å¯¹åº”çš„ confirm / cancel æ–¹æ³•ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// try</span></div><div class="line"><span class="meta">@Compensable</span>(confirmMethod = <span class="string">"confirmRecord"</span>, cancelMethod = <span class="string">"cancelRecord"</span>, transactionContextEditor = MethodTransactionContextEditor.class)</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">record</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">// confirm</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirmRecord</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">// cancel</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelRecord</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> </span>&#123;&#125;</div></pre></td></tr></table></figure><p></p><ul><li>åœ¨ç¤ºä¾‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° TransactionContextï¼Œäº‹åŠ¡ä¸Šä¸‹æ–‡ï¼Œè¿™ä¸ªæ˜¯æ€ä¹ˆç”Ÿæˆçš„å‘¢ï¼Ÿè¿™é‡Œå…ˆå–ä¸€ä¸ªå…³å­ã€‚</li></ul><p>TCC-Transaction æœ‰ä¸¤ä¸ªæ‹¦æˆªå™¨ï¼Œé€šè¿‡å¯¹ @Compensable AOP åˆ‡é¢( å‚ä¸è€… try æ–¹æ³• )è¿›è¡Œæ‹¦æˆªï¼Œé€æ˜åŒ–å¯¹å‚ä¸è€… confirm / cancel æ–¹æ³•è°ƒç”¨ï¼Œä»è€Œå®ç° TCC ã€‚<strong>ç®€åŒ–</strong>æµç¨‹å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_08/03.png" alt=""></p><p>ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œå¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ï¼Œå®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š</p><ul><li>åœ¨ Try é˜¶æ®µï¼Œå¯¹äº‹åŠ¡çš„å‘èµ·ã€ä¼ æ’­ã€‚</li><li>åœ¨ Confirm / Cancel é˜¶æ®µï¼Œå¯¹äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚</li><li><strong>ä¸ºä»€ä¹ˆä¼šæœ‰å¯¹äº‹åŠ¡çš„ä¼ æ’­å‘¢</strong>ï¼Ÿåœ¨è¿œç¨‹è°ƒç”¨æœåŠ¡çš„å‚ä¸è€…æ—¶ï¼Œä¼šé€šè¿‡**&quot;å‚æ•°&quot;**( éœ€è¦åºåˆ—åŒ– )çš„å½¢å¼ä¼ é€’äº‹åŠ¡ç»™è¿œç¨‹å‚ä¸è€…ã€‚</li></ul><p>ç¬¬äºŒä¸ªæ‹¦æˆªå™¨ï¼Œèµ„æºåè°ƒè€…æ‹¦æˆªå™¨ï¼Œå®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š</p><ul><li>åœ¨ Try é˜¶æ®µï¼Œæ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡ä¸­ã€‚å½“äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸å­˜åœ¨æ—¶ï¼Œè¿›è¡Œåˆ›å»ºã€‚</li></ul><p>å®é™…æ‹¦æˆªå™¨å¯¹äº‹åŠ¡çš„å¤„ç†ä¼šæ¯”ä¸Šå›¾å¤æ‚ä¸€äº›ï¼Œåœ¨æœ¬æ–‡<a href="#">ã€Œ6. äº‹åŠ¡æ‹¦æˆªå™¨ã€</a>è¯¦ç»†è§£æã€‚</p><p>åœ¨ TCC-Transaction ä»£ç å®ç°ä¸Šï¼Œç»„ä»¶åˆ†å±‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_08/04.png" alt=""></p><p>æœ¬æ–‡æŒ‰ç…§å¦‚ä¸‹é¡ºåºåˆ†äº«ï¼š</p><ul><li><a href="#">ã€Œ4. äº‹åŠ¡æ‹¦æˆªå™¨ã€</a></li><li><a href="#">ã€Œ5. äº‹åŠ¡ç®¡ç†å™¨ã€</a></li><li><a href="#">ã€Œ6. äº‹åŠ¡ç®¡ç†å™¨ã€</a></li></ul><p>å†…å®¹æ˜¯<strong>è‡ªä¸‹è€Œä¸Š</strong>çš„æ–¹å¼åˆ†äº«ï¼Œæ¯ä¸ªç»„ä»¶å¯ä»¥æ›´åŠ æ•´ä½“çš„è¢«è®¤è¯†ã€‚å½“ç„¶è¿™å¯èƒ½å¯¹ä½ ç†è§£æ—¶äº§ç”Ÿä¸€è„¸é—·é€¼ï¼Œæ‰€ä»¥æ¨èä¸¤ç§é˜…è¯»æ–¹å¼ï¼š</p><ul><li>ç®€è¯» x 1 + æ·±è¯» x 1</li><li>å€’ç€è¯»ï¼Œå‘ç°æœªåˆ†äº«çš„æ–¹æ³•ï¼Œå…¨æ–‡æ£€ç´¢è¯¥æ–¹æ³•ã€‚</li></ul><p>äº‹åŠ¡å­˜å‚¨å™¨åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-repository/?self">ã€ŠTCC-Transaction æºç è§£æ â€”â€” äº‹åŠ¡å­˜å‚¨äºæ¢å¤ã€‹</a>è¯¦ç»†è§£æã€‚</p><p>äº‹åŠ¡æ¢å¤åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-recovery/?self">ã€ŠTCC-Transaction æºç è§£æ â€”â€” äº‹åŠ¡æ¢å¤ã€‹</a>è¯¦ç»†è§£æã€‚</p><h1>4. äº‹åŠ¡ä¸å‚ä¸è€…</h1><p>åœ¨ TCC é‡Œï¼Œ<strong>ä¸€ä¸ª</strong>äº‹åŠ¡( <code>org.mengyun.tcctransaction.Transaction</code> ) å¯ä»¥æœ‰<strong>å¤šä¸ª</strong>å‚ä¸è€…( <code>org.mengyun.tcctransaction.Participant</code> )å‚ä¸ä¸šåŠ¡æ´»åŠ¨ã€‚ç±»å›¾å…³ç³»å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/TCC-Transaction/2018_02_08/02.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_08/02.png" alt=""></p><h2>4.1 äº‹åŠ¡</h2><p><strong>Transaction å®ç°ä»£ç å¦‚ä¸‹</strong>ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Transaction</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7291423944314337931L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> TransactionXid xid;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡çŠ¶æ€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> TransactionStatus status;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ç±»å‹</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> TransactionType transactionType;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é‡è¯•æ¬¡æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> retriedCount = <span class="number">0</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ›å»ºæ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Date createTime = <span class="keyword">new</span> Date();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æœ€åæ›´æ–°æ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Date lastUpdateTime = <span class="keyword">new</span> Date();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç‰ˆæœ¬å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> version = <span class="number">1</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‚ä¸è€…é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> List&lt;Participant&gt; participants = <span class="keyword">new</span> ArrayList&lt;Participant&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é™„å¸¦å±æ€§æ˜ å°„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; attachments = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Object&gt;();</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ·»åŠ å‚ä¸è€…</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> participant å‚ä¸è€…</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enlistParticipant</span><span class="params">(Participant participant)</span> </span>&#123;</div><div class="line">        participants.add(participant);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æäº¤ TCC äº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Participant participant : participants) &#123;</div><div class="line">            participant.commit();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å›æ»š TCC äº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Participant participant : participants) &#123;</div><div class="line">            participant.rollback();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><p>xidï¼Œäº‹åŠ¡ç¼–å·( TransactionXid )ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªäº‹åŠ¡ã€‚ä½¿ç”¨ UUID ç®—æ³•ç”Ÿæˆï¼Œ<strong>ä¿è¯å”¯ä¸€æ€§</strong>ã€‚<code>org.mengyun.tcctransaction.api.TransactionXid</code> å®ç° <a href="https://docs.oracle.com/javase/8/docs/api/javax/transaction/xa/Xid.html" rel="external nofollow noopener noreferrer" target="_blank"><code>javax.transaction.xa.Xid</code></a> æ¥å£ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionXid</span> <span class="keyword">implements</span> <span class="title">Xid</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">6817267250789142043L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * xid æ ¼å¼æ ‡è¯†ç¬¦</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> formatId = <span class="number">1</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å…¨å±€äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] globalTransactionId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ†æ”¯äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] branchQualifier;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>TODO ä¸ºä»€ä¹ˆè¦ç»§æ‰¿ Xid æ¥å£ï¼Ÿ</li></ul></li><li><p>statusï¼Œäº‹åŠ¡çŠ¶æ€( TransactionStatus )ã€‚<code>org.mengyun.tcctransaction.api.TransactionStatus</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> TransactionStatus &#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å°è¯•ä¸­çŠ¶æ€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    TRYING(<span class="number">1</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¡®è®¤ä¸­çŠ¶æ€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    CONFIRMING(<span class="number">2</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å–æ¶ˆä¸­çŠ¶æ€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    CANCELLING(<span class="number">3</span>);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p></li><li><p>transactionTypeï¼Œäº‹åŠ¡ç±»å‹( TransactionType )ã€‚<code>org.mengyun.tcctransaction.common.TransactionType</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> TransactionType &#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ ¹äº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    ROOT(<span class="number">1</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ†æ”¯äº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    BRANCH(<span class="number">2</span>);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> id;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>åœ¨<a href="#">ã€Œ6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ã€</a>æœ‰è¯¦ç»†è§£æï¼Œå¯ä»¥çœ‹åˆ°çœ‹åˆ°è¿™ä¸¤ç§äº‹åŠ¡æ˜¯å¦‚ä½•å‘èµ·ã€‚</li></ul></li><li><p>retriedCountï¼Œé‡è¯•æ¬¡æ•°ã€‚åœ¨ TCC è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å‚ä¸è€…å¼‚å¸¸å´©æºƒï¼Œè¿™ä¸ªæ—¶å€™ä¼šè¿›è¡Œé‡è¯•ç›´åˆ°æˆåŠŸæˆ–è¶…è¿‡æœ€å¤§æ¬¡æ•°ã€‚åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-recovery/?self">ã€ŠTCC-Transaction æºç è§£æ â€”â€” äº‹åŠ¡æ¢å¤ã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>versionï¼Œç‰ˆæœ¬å·ï¼Œç”¨äºä¹è§‚é”æ›´æ–°äº‹åŠ¡ã€‚åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-repository/?self">ã€ŠTCC-Transaction æºç è§£æ â€”â€” äº‹åŠ¡å­˜å‚¨å™¨ã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>attachmentsï¼Œé™„å¸¦å±æ€§æ˜ å°„ã€‚åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/?self">ã€ŠTCC-Transaction æºç è§£æ â€”â€” Dubbo æ”¯æŒã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>æä¾› <code>#enlistParticipant()</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡å‚ä¸è€…ã€‚</p></li><li><p>æä¾› <code>#commit()</code> æ–¹æ³•ï¼Œè°ƒç”¨å‚ä¸è€…ä»¬æäº¤äº‹åŠ¡ã€‚</p></li><li><p>æä¾› <code>#rollback()</code> æ–¹æ³•ï¼Œè°ƒç”¨å‚ä¸è€…å›æ»šäº‹åŠ¡ã€‚</p></li></ul><h2>4.2 å‚ä¸è€…</h2><p><strong>Participant å®ç°ä»£ç å¦‚ä¸‹</strong>ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Participant</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">4127729421281425247L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> TransactionXid xid;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> InvocationContext confirmInvocationContext;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ–¹æ³•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> InvocationContext cancelInvocationContext;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Terminator terminator = <span class="keyword">new</span> Terminator();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Class&lt;? extends TransactionContextEditor&gt; transactionContextEditorClass;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æäº¤äº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> </span>&#123;</div><div class="line">        terminator.invoke(<span class="keyword">new</span> TransactionContext(xid, TransactionStatus.CONFIRMING.getId()), confirmInvocationContext, transactionContextEditorClass);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å›æ»šäº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> </span>&#123;</div><div class="line">        terminator.invoke(<span class="keyword">new</span> TransactionContext(xid, TransactionStatus.CANCELLING.getId()), cancelInvocationContext, transactionContextEditorClass);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><p>xidï¼Œå‚ä¸è€…äº‹åŠ¡ç¼–å·ã€‚é€šè¿‡ <code>TransactionXid.globalTransactionId</code> å±æ€§ï¼Œå…³è”ä¸Šå…¶æ‰€å±çš„äº‹åŠ¡ã€‚å½“å‚ä¸è€…è¿›è¡Œè¿œç¨‹è°ƒç”¨æ—¶ï¼Œè¿œç¨‹çš„<strong>åˆ†æ”¯</strong>äº‹åŠ¡çš„äº‹åŠ¡ç¼–å·ç­‰äºè¯¥å‚ä¸è€…çš„äº‹åŠ¡ç¼–å·ã€‚é€šè¿‡äº‹åŠ¡ç¼–å·çš„å…³è”ï¼ŒTCC Confirm / Cancel é˜¶æ®µï¼Œä½¿ç”¨å‚ä¸è€…çš„äº‹åŠ¡ç¼–å·å’Œè¿œç¨‹çš„<strong>åˆ†æ”¯</strong>äº‹åŠ¡è¿›è¡Œå…³è”ï¼Œä»è€Œå®ç°äº‹åŠ¡çš„æäº¤å’Œå›æ»šï¼Œåœ¨<a href="#">ã€Œ5.2 ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡ã€ + ã€Œ6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ã€</a>å¯ä»¥çœ‹åˆ°å…·ä½“å®ç°ã€‚</p></li><li><p>confirmInvocationContextï¼Œç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡( InvocationContext )ã€‚<code>org.mengyun.tcctransaction.InvocationContext</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvocationContext</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">7969140711432461165L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç±»</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Class targetClass;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ–¹æ³•å</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String methodName;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‚æ•°ç±»å‹æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Class[] parameterTypes;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‚æ•°æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Object[] args;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>InvocationContextï¼Œæ‰§è¡Œæ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡ï¼Œè®°å½•ç±»ã€æ–¹æ³•åã€å‚æ•°ç±»å‹æ•°ç»„ã€å‚æ•°æ•°ç»„ã€‚é€šè¿‡è¿™äº›å±æ€§ï¼Œå¯ä»¥æ‰§è¡Œæäº¤ / å›æ»šäº‹åŠ¡ã€‚åœ¨ <code>org.mengyun.tcctransaction.Terminator</code> ä¼šçœ‹åˆ°å…·ä½“çš„ä»£ç å®ç°ã€‚<strong>æœ¬è´¨ä¸Šï¼ŒTCC é€šè¿‡å¤šä¸ªå‚ä¸è€…çš„ try / confirm / cancel æ–¹æ³•ï¼Œå®ç°äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´æ€§</strong>ã€‚</li></ul></li><li><p>cancelInvocationContextï¼Œå–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡( InvocationContext )ã€‚</p></li><li><p>terminatorï¼Œæ‰§è¡Œå™¨( Terminator )ã€‚<code>org.mengyun.tcctransaction.Terminator</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Terminator</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">164958655471605778L</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(TransactionContext transactionContext, InvocationContext invocationContext, Class&lt;? extends TransactionContextEditor&gt; transactionContextEditorClass)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(invocationContext.getMethodName())) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// è·å¾— å‚ä¸è€…å¯¹è±¡</span></div><div class="line">                Object target = FactoryBuilder.factoryOf(invocationContext.getTargetClass()).getInstance();</div><div class="line">                <span class="comment">// è·å¾— æ–¹æ³•</span></div><div class="line">                Method method = target.getClass().getMethod(invocationContext.getMethodName(), invocationContext.getParameterTypes());</div><div class="line">                <span class="comment">// è®¾ç½® äº‹åŠ¡ä¸Šä¸‹æ–‡ åˆ°æ–¹æ³•å‚æ•°</span></div><div class="line">                FactoryBuilder.factoryOf(transactionContextEditorClass).getInstance().set(transactionContext, target, method, invocationContext.getArgs());</div><div class="line">                <span class="comment">// æ‰§è¡Œæ–¹æ³•</span></div><div class="line">                <span class="keyword">return</span> method.invoke(target, invocationContext.getArgs());</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>FactoryBuilderï¼Œå·¥å‚ Builderï¼Œæ„Ÿå…´è¶£çš„åŒå­¦ç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/8553baad29597603d9007d61aec3ea5201632d1b/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/support/FactoryBuilder.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ï¼Œå·²ç»æ·»åŠ å®Œæ•´ä¸­æ–‡ä»£ç æ³¨é‡Šã€‚</li><li>TransactionContextEditorï¼Œåœ¨æœ¬æ–‡<a href="#">ã€Œ6.1 Compensableã€</a>è¯¦ç»†è§£æã€‚</li></ul></li><li><p>transactionContextEditorClassï¼Œäº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘ï¼Œåœ¨<a href="#">ã€Œ6.1 Compensableã€</a>è¯¦ç»†è§£æã€‚</p></li><li><p>æäº¤ <code>#commit()</code> æ–¹æ³•ï¼Œæäº¤å‚ä¸è€…è‡ªå·±çš„äº‹åŠ¡ã€‚</p></li><li><p>æäº¤ <code>#rollback()</code> æ–¹æ³•ï¼Œå›æ»šå‚ä¸è€…è‡ªå·±çš„äº‹åŠ¡ã€‚</p></li></ul><h1>5. äº‹åŠ¡ç®¡ç†å™¨</h1><p><code>org.mengyun.tcctransaction.TransactionManager</code>ï¼Œäº‹åŠ¡ç®¡ç†å™¨ï¼Œæä¾›äº‹åŠ¡çš„è·å–ã€å‘èµ·ã€æäº¤ã€å›æ»šï¼Œå‚ä¸è€…çš„æ–°å¢ç­‰ç­‰æ–¹æ³•ã€‚</p><h2>5.1 å‘èµ·æ ¹äº‹åŠ¡</h2><p>æä¾› <code>begin()</code> æ–¹æ³•ï¼Œå‘èµ·æ ¹äº‹åŠ¡ã€‚è¯¥æ–¹æ³•åœ¨<strong>è°ƒç”¨æ–¹æ³•ç±»å‹ä¸º MethodType.ROOT å¹¶ä¸” äº‹åŠ¡å¤„äº Try é˜¶æ®µ</strong>è¢«è°ƒç”¨ã€‚MethodType åœ¨<a href="#">ã€Œ6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ã€</a>è¯¦ç»†è§£æã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å‘èµ·æ ¹äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Transaction <span class="title">begin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// åˆ›å»º æ ¹äº‹åŠ¡</span></div><div class="line">   Transaction transaction = <span class="keyword">new</span> Transaction(TransactionType.ROOT);</div><div class="line">   <span class="comment">// å­˜å‚¨ äº‹åŠ¡</span></div><div class="line">   transactionRepository.create(transaction);</div><div class="line">   <span class="comment">// æ³¨å†Œ äº‹åŠ¡</span></div><div class="line">   registerTransaction(transaction);</div><div class="line">   <span class="keyword">return</span> transaction;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><p>è°ƒç”¨ Transaction æ„é€ æ–¹æ³•ï¼Œåˆ›å»º<strong>æ ¹äº‹åŠ¡</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Transaction.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºæŒ‡å®šç±»å‹çš„äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionType äº‹åŠ¡ç±»å‹</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Transaction</span><span class="params">(TransactionType transactionType)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.xid = <span class="keyword">new</span> TransactionXid();</div><div class="line">   <span class="keyword">this</span>.status = TransactionStatus.TRYING; <span class="comment">// å°è¯•ä¸­çŠ¶æ€</span></div><div class="line">   <span class="keyword">this</span>.transactionType = transactionType;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>ç›®å‰è¯¥æ„é€ æ–¹æ³•åªæœ‰ <code>TransactionManager#begin()</code> åœ¨è°ƒç”¨ï¼Œå³åªåˆ›å»º<strong>æ ¹äº‹åŠ¡</strong>ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>TransactionRepository#crete()</code> æ–¹æ³•ï¼Œå­˜å‚¨äº‹åŠ¡ã€‚</p></li><li><p>è°ƒç”¨ <code>#registerTransaction(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œäº‹åŠ¡åˆ°å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt; CURRENT = <span class="keyword">new</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt;();</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ³¨å†Œäº‹åŠ¡åˆ°å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerTransaction</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (CURRENT.get() == <span class="keyword">null</span>) &#123;</div><div class="line">       CURRENT.set(<span class="keyword">new</span> LinkedList&lt;Transaction&gt;());</div><div class="line">   &#125;</div><div class="line">   CURRENT.get().push(transaction); <span class="comment">// æ·»åŠ åˆ°å¤´éƒ¨</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><strong>å¯èƒ½æœ‰åŒå­¦ä¼šæ¯”è¾ƒå¥½å¥‡ï¼Œä¸ºä»€ä¹ˆä½¿ç”¨é˜Ÿåˆ—å­˜å‚¨å½“å‰çº¿ç¨‹äº‹åŠ¡</strong>ï¼ŸTCC-Transaction æ”¯æŒ<strong>å¤šä¸ª</strong>çš„äº‹åŠ¡<strong>ç‹¬ç«‹å­˜åœ¨</strong>ï¼Œååˆ›å»ºçš„äº‹åŠ¡å…ˆæäº¤ï¼Œç±»ä¼¼ Spring çš„<code>org.springframework.transaction.annotation.Propagation.REQUIRES_NEW</code> ã€‚åœ¨ä¸‹æ–‡ï¼Œå¾ˆå¿«æˆ‘ä»¬å°±ä¼šçœ‹åˆ° TCC-Transaction è‡ªå·±çš„ <code>org.mengyun.tcctransaction.api.Propagation</code> ã€‚</li></ul></li></ul><h2>5.2 ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡</h2><p>è°ƒç”¨ <code>#propagationNewBegin(...)</code> æ–¹æ³•ï¼Œä¼ æ’­å‘èµ·<strong>åˆ†æ”¯</strong>äº‹åŠ¡ã€‚è¯¥æ–¹æ³•åœ¨<strong>è°ƒç”¨æ–¹æ³•ç±»å‹ä¸º MethodType.PROVIDER å¹¶ä¸” äº‹åŠ¡å¤„äº Try é˜¶æ®µ</strong>è¢«è°ƒç”¨ã€‚MethodType åœ¨<a href="#">ã€Œ6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ã€</a>è¯¦ç»†è§£æã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionContext äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> åˆ†æ”¯äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Transaction <span class="title">propagationNewBegin</span><span class="params">(TransactionContext transactionContext)</span> </span>&#123;</div><div class="line">  <span class="comment">// åˆ›å»º åˆ†æ”¯äº‹åŠ¡</span></div><div class="line">  Transaction transaction = <span class="keyword">new</span> Transaction(transactionContext);</div><div class="line">  <span class="comment">// å­˜å‚¨ äº‹åŠ¡</span></div><div class="line">  transactionRepository.create(transaction);</div><div class="line">  <span class="comment">// æ³¨å†Œ äº‹åŠ¡</span></div><div class="line">  registerTransaction(transaction);</div><div class="line">  <span class="keyword">return</span> transaction;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><p>è°ƒç”¨ Transaction æ„é€ æ–¹æ³•ï¼Œåˆ›å»º<strong>åˆ†æ”¯äº‹åŠ¡</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºåˆ†æ”¯äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionContext äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Transaction</span><span class="params">(TransactionContext transactionContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.xid = transactionContext.getXid(); <span class="comment">// äº‹åŠ¡ä¸Šä¸‹æ–‡çš„ xid</span></div><div class="line">   <span class="keyword">this</span>.status = TransactionStatus.TRYING; <span class="comment">// å°è¯•ä¸­çŠ¶æ€</span></div><div class="line">   <span class="keyword">this</span>.transactionType = TransactionType.BRANCH; <span class="comment">// åˆ†æ”¯äº‹åŠ¡</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><strong>åˆ†æ”¯</strong>äº‹åŠ¡ä½¿ç”¨ä¼ æ’­çš„äº‹åŠ¡ä¸Šä¸‹æ–‡çš„äº‹åŠ¡ç¼–å·ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>TransactionRepository#crete()</code> æ–¹æ³•ï¼Œå­˜å‚¨äº‹åŠ¡ã€‚ä¸ºä»€ä¹ˆè¦å­˜å‚¨<strong>åˆ†æ”¯</strong>äº‹åŠ¡ï¼Œåœ¨<a href="#">ã€Œ6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨ã€</a>è¯¦ç»†è§£æã€‚</p></li><li><p>è°ƒç”¨ <code>#registerTransaction(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œäº‹åŠ¡åˆ°å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ã€‚</p></li></ul><h2>5.3 ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡</h2><p>è°ƒç”¨ <code>#propagationExistBegin(...)</code> æ–¹æ³•ï¼Œä¼ æ’­å‘èµ·<strong>åˆ†æ”¯</strong>äº‹åŠ¡ã€‚è¯¥æ–¹æ³•åœ¨<strong>è°ƒç”¨æ–¹æ³•ç±»å‹ä¸º MethodType.PROVIDER å¹¶ä¸” äº‹åŠ¡å¤„äº Confirm / Cancel é˜¶æ®µ</strong>è¢«è°ƒç”¨ã€‚MethodType åœ¨<a href="#">ã€Œ6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ã€</a>è¯¦ç»†è§£æã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionContext äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> åˆ†æ”¯äº‹åŠ¡</span></div><div class="line"><span class="comment">* <span class="doctag">@throws</span> NoExistedTransactionException å½“äº‹åŠ¡ä¸å­˜åœ¨æ—¶</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Transaction <span class="title">propagationExistBegin</span><span class="params">(TransactionContext transactionContext)</span> <span class="keyword">throws</span> NoExistedTransactionException </span>&#123;</div><div class="line">   <span class="comment">// æŸ¥è¯¢ äº‹åŠ¡</span></div><div class="line">   Transaction transaction = transactionRepository.findByXid(transactionContext.getXid());</div><div class="line">   <span class="keyword">if</span> (transaction != <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="comment">// è®¾ç½® äº‹åŠ¡ çŠ¶æ€</span></div><div class="line">       transaction.changeStatus(TransactionStatus.valueOf(transactionContext.getStatus()));</div><div class="line">       <span class="comment">// æ³¨å†Œ äº‹åŠ¡</span></div><div class="line">       registerTransaction(transaction);</div><div class="line">       <span class="keyword">return</span> transaction;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> NoExistedTransactionException();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>è°ƒç”¨ <code>TransactionRepository#findByXid()</code> æ–¹æ³•ï¼ŒæŸ¥è¯¢äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>Transaction#changeStatus(...)</code> æ–¹æ³•ï¼Œ<strong>è®¾ç½®</strong>äº‹åŠ¡çŠ¶æ€ä¸º CONFIRMING æˆ– CANCELLINGã€‚</li><li>è°ƒç”¨ <code>#registerTransaction(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œäº‹åŠ¡åˆ°å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ã€‚</li><li>ä¸ºä»€ä¹ˆæ­¤å¤„æ˜¯<strong>åˆ†æ”¯</strong>äº‹åŠ¡å‘¢ï¼Ÿç»“åˆ <code>#propagationNewBegin(...)</code> æ€è€ƒä¸‹ã€‚</li></ul><h2>5.4 æäº¤äº‹åŠ¡</h2><p>è°ƒç”¨ <code>#commit(...)</code> æ–¹æ³•ï¼Œæäº¤äº‹åŠ¡ã€‚è¯¥æ–¹æ³•åœ¨<strong>äº‹åŠ¡å¤„äº Confirm / Cancel é˜¶æ®µ</strong>è¢«è°ƒç”¨ã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æäº¤äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å– äº‹åŠ¡</span></div><div class="line">   Transaction transaction = getCurrentTransaction();</div><div class="line">   <span class="comment">// è®¾ç½® äº‹åŠ¡çŠ¶æ€ ä¸º CONFIRMING</span></div><div class="line">   transaction.changeStatus(TransactionStatus.CONFIRMING);</div><div class="line">   <span class="comment">// æ›´æ–° äº‹åŠ¡</span></div><div class="line">   transactionRepository.update(transaction);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// æäº¤ äº‹åŠ¡</span></div><div class="line">       transaction.commit();</div><div class="line">       <span class="comment">// åˆ é™¤ äº‹åŠ¡</span></div><div class="line">       transactionRepository.delete(transaction);</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable commitException) &#123;</div><div class="line">       logger.error(<span class="string">"compensable transaction confirm failed."</span>, commitException);</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ConfirmingException(commitException);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><p>è°ƒç”¨ <code>#getCurrentTransaction()</code> æ–¹æ³•ï¼Œ è·å–äº‹åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Transaction <span class="title">getCurrentTransaction</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (isTransactionActive()) &#123;</div><div class="line">       <span class="keyword">return</span> CURRENT.get().peek(); <span class="comment">// è·å¾—å¤´éƒ¨å…ƒç´ </span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTransactionActive</span><span class="params">()</span> </span>&#123;</div><div class="line">   Deque&lt;Transaction&gt; transactions = CURRENT.get();</div><div class="line">   <span class="keyword">return</span> transactions != <span class="keyword">null</span> &amp;&amp; !transactions.isEmpty();</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>ä¸ºä»€ä¹ˆè·å¾—é˜Ÿåˆ—<strong>å¤´éƒ¨</strong>å…ƒç´ å‘¢ï¼Ÿè¯¥å…ƒç´ å³æ˜¯ä¸Šæ–‡è°ƒç”¨ <code>#registerTransaction(...)</code> æ³¨å†Œåˆ°é˜Ÿåˆ—å¤´éƒ¨ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>Transaction#changeStatus(...)</code> æ–¹æ³•ï¼Œ <strong>è®¾ç½®</strong>äº‹åŠ¡çŠ¶æ€ä¸º CONFIRMINGã€‚</p></li><li><p>è°ƒç”¨ <code>TransactionRepository#update(...)</code> æ–¹æ³•ï¼Œ <strong>æ›´æ–°</strong>äº‹åŠ¡ã€‚</p></li><li><p>è°ƒç”¨ <code>Transaction#commit(...)</code> æ–¹æ³•ï¼Œ <strong>æäº¤</strong>äº‹åŠ¡ã€‚</p></li><li><p>è°ƒç”¨ <code>TransactionRepository#delete(...)</code> æ–¹æ³•ï¼Œ<strong>åˆ é™¤</strong>äº‹åŠ¡ã€‚</p></li></ul><h2>5.5 å›æ»šäº‹åŠ¡</h2><p>è°ƒç”¨ <code>#rollback(...)</code> æ–¹æ³•ï¼Œå–æ¶ˆäº‹åŠ¡ï¼Œå’Œ <code>#commit()</code> æ–¹æ³•åŸºæœ¬ç±»ä¼¼ã€‚è¯¥æ–¹æ³•åœ¨<strong>äº‹åŠ¡å¤„äº Confirm / Cancel é˜¶æ®µ</strong>è¢«è°ƒç”¨ã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å›æ»šäº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å– äº‹åŠ¡</span></div><div class="line">   Transaction transaction = getCurrentTransaction();</div><div class="line">   <span class="comment">// è®¾ç½® äº‹åŠ¡çŠ¶æ€ ä¸º CANCELLING</span></div><div class="line">   transaction.changeStatus(TransactionStatus.CANCELLING);</div><div class="line">   <span class="comment">// æ›´æ–° äº‹åŠ¡</span></div><div class="line">   transactionRepository.update(transaction);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// æäº¤ äº‹åŠ¡</span></div><div class="line">       transaction.rollback();</div><div class="line">       <span class="comment">// åˆ é™¤ äº‹åŠ¡</span></div><div class="line">       transactionRepository.delete(transaction);</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable rollbackException) &#123;</div><div class="line">       logger.error(<span class="string">"compensable transaction rollback failed."</span>, rollbackException);</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> CancellingException(rollbackException);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>è°ƒç”¨ <code>#getCurrentTransaction()</code> æ–¹æ³•ï¼Œè·å–äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>Transaction#changeStatus(...)</code> æ–¹æ³•ï¼Œ <strong>è®¾ç½®</strong>äº‹åŠ¡çŠ¶æ€ä¸º CANCELLINGã€‚</li><li>è°ƒç”¨ <code>TransactionRepository#update(...)</code> æ–¹æ³•ï¼Œ <strong>æ›´æ–°</strong>äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>Transaction#rollback(...)</code> æ–¹æ³•ï¼Œ <strong>å›æ»š</strong>äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>TransactionRepository#delete(...)</code> æ–¹æ³•ï¼Œ<strong>åˆ é™¤</strong>äº‹åŠ¡ã€‚</li></ul><h2>5.6 æ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡</h2><p>è°ƒç”¨ <code>#enlistParticipant(...)</code> æ–¹æ³•ï¼Œæ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡ã€‚è¯¥æ–¹æ³•åœ¨<strong>äº‹åŠ¡å¤„äº Try é˜¶æ®µ</strong>è¢«è°ƒç”¨ï¼Œåœ¨<a href="#">ã€Œ6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨ã€</a>æœ‰è¯¦ç»†è§£æã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> participant å‚ä¸è€…</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enlistParticipant</span><span class="params">(Participant participant)</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å– äº‹åŠ¡</span></div><div class="line">   Transaction transaction = <span class="keyword">this</span>.getCurrentTransaction();</div><div class="line">   <span class="comment">// æ·»åŠ å‚ä¸è€…</span></div><div class="line">   transaction.enlistParticipant(participant);</div><div class="line">   <span class="comment">// æ›´æ–° äº‹åŠ¡</span></div><div class="line">   transactionRepository.update(transaction);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>è°ƒç”¨ <code>#getCurrentTransaction()</code> æ–¹æ³•ï¼Œè·å–äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>Transaction#enlistParticipant(...)</code> æ–¹æ³•ï¼Œ æ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>TransactionRepository#update(...)</code> æ–¹æ³•ï¼Œ <strong>æ›´æ–°</strong>äº‹åŠ¡ã€‚</li></ul><h1>6. äº‹åŠ¡æ‹¦æˆªå™¨</h1><p>TCC-Transaction åŸºäº <code>org.mengyun.tcctransaction.api.@Compensable</code> + <code>org.aspectj.lang.annotation.@Aspect</code> <strong>æ³¨è§£</strong> <strong>AOP åˆ‡é¢</strong>å®ç°ä¸šåŠ¡æ–¹æ³•çš„ TCC äº‹åŠ¡å£°æ˜<strong>æ‹¦æˆª</strong>ï¼ŒåŒ Spring çš„ <code>org.springframework.transaction.annotation.@Transactional</code> çš„å®ç°ã€‚</p><p>TCC-Transaction æœ‰ä¸¤ä¸ªæ‹¦æˆªå™¨ï¼š</p><ul><li><code>org.mengyun.tcctransaction.interceptor.CompensableTransactionInterceptor</code>ï¼Œå¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ã€‚</li><li><code>org.mengyun.tcctransaction.interceptor.ResourceCoordinatorInterceptor</code>ï¼Œèµ„æºåè°ƒè€…æ‹¦æˆªå™¨ã€‚</li></ul><p>åœ¨åˆ†äº«æ‹¦æˆªå™¨çš„å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä¸€èµ·çœ‹çœ‹ @Compensable æ³¨è§£ã€‚</p><h2>6.1 Compensable</h2><p>@Compensableï¼Œæ ‡è®°å¯è¡¥å¿çš„æ–¹æ³•æ³¨è§£ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Compensable &#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä¼ æ’­çº§åˆ«</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">Propagation <span class="title">propagation</span><span class="params">()</span> <span class="keyword">default</span> Propagation.REQUIRED</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ–¹æ³•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">String <span class="title">confirmMethod</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ–¹æ³•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">String <span class="title">cancelMethod</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Class&lt;? extends TransactionContextEditor&gt; transactionContextEditor() <span class="keyword">default</span> DefaultTransactionContextEditor.class;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><p>propagationï¼Œä¼ æ’­çº§åˆ«( Propagation )ï¼Œé»˜è®¤ Propagation.REQUIREDã€‚å’Œ Spring çš„ Propagation é™¤äº†ç¼ºå°‘å‡ ä¸ªå±æ€§ï¼ŒåŸºæœ¬ä¸€è‡´ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Propagation &#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æ–°å»ºä¸€ä¸ªäº‹åŠ¡ã€‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    REQUIRED(<span class="number">0</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œã€‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    SUPPORTS(<span class="number">1</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æŠ›å‡ºå¼‚å¸¸ã€‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    MANDATORY(<span class="number">2</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ–°å»ºäº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    REQUIRES_NEW(<span class="number">3</span>);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> value;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p></li><li><p>confirmMethodï¼Œç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ–¹æ³•åã€‚</p></li><li><p>cancelMethodï¼Œå–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ–¹æ³•åã€‚</p></li><li><p>TransactionContextEditorï¼Œäº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨( TransactionContextEditor )ï¼Œç”¨äºè®¾ç½®å’Œè·å¾—äº‹åŠ¡ä¸Šä¸‹æ–‡( TransactionContext )ï¼Œåœ¨<a href="#">ã€Œ6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨ã€</a>å¯ä»¥çœ‹åˆ°è¢«è°ƒç”¨ï¼Œæ­¤å¤„åªçœ‹å®ƒçš„ä»£ç å®ç°ã€‚<code>org.mengyun.tcctransaction.api.TransactionContextEditor</code> æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionContextEditor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»å‚æ•°ä¸­è·å¾—äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> target å¯¹è±¡</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> method æ–¹æ³•</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> args å‚æ•°</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">TransactionContext <span class="title">get</span><span class="params">(Object target, Method method, Object[] args)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®¾ç½®äº‹åŠ¡ä¸Šä¸‹æ–‡åˆ°å‚æ•°ä¸­</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> transactionContext äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> target å¯¹è±¡</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> method æ–¹æ³•</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> args å‚æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(TransactionContext transactionContext, Object target, Method method, Object[] args)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><p>DefaultTransactionContextEditorï¼Œ<strong>é»˜è®¤</strong>äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨å®ç°ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DefaultTransactionContextEditor</span> <span class="keyword">implements</span> <span class="title">TransactionContextEditor</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> TransactionContext <span class="title">get</span><span class="params">(Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> position = getTransactionContextParamPosition(method.getParameterTypes());</div><div class="line">        <span class="keyword">if</span> (position &gt;= <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> (TransactionContext) args[position];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(TransactionContext transactionContext, Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> position = getTransactionContextParamPosition(method.getParameterTypes());</div><div class="line">        <span class="keyword">if</span> (position &gt;= <span class="number">0</span>) &#123;</div><div class="line">            args[position] = transactionContext; <span class="comment">// è®¾ç½®æ–¹æ³•å‚æ•°</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·å¾—äº‹åŠ¡ä¸Šä¸‹æ–‡åœ¨æ–¹æ³•å‚æ•°é‡Œçš„ä½ç½®</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> parameterTypes å‚æ•°ç±»å‹é›†åˆ</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> ä½ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getTransactionContextParamPosition</span><span class="params">(Class&lt;?&gt;[] parameterTypes)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> position = -<span class="number">1</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterTypes.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (parameterTypes[i].equals(org.mengyun.tcctransaction.api.TransactionContext.class)) &#123;</div><div class="line">                position = i;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> position;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>x</li></ul></li><li><p>NullableTransactionContextEditorï¼Œæ— äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨å®ç°ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">NullableTransactionContextEditor</span> <span class="keyword">implements</span> <span class="title">TransactionContextEditor</span> </span>&#123;</div><div class="line">    </div><div class="line">     <span class="meta">@Override</span></div><div class="line">     <span class="function"><span class="keyword">public</span> TransactionContext <span class="title">get</span><span class="params">(Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">     &#125;</div><div class="line">    </div><div class="line">     <span class="meta">@Override</span></div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(TransactionContext transactionContext, Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure><p></p></li><li><p>DubboTransactionContextEditorï¼ŒDubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨å®ç°ï¼Œé€šè¿‡ Dubbo éšå¼ä¼ å‚æ–¹å¼è·å¾—äº‹åŠ¡ä¸Šä¸‹æ–‡ï¼Œåœ¨<a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/?self">ã€ŠTCC-Transaction æºç è§£æ â€”â€” Dubbo æ”¯æŒã€‹</a>è¯¦ç»†è§£æã€‚</p></li></ul></li></ul><h2>6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨</h2><p>å…ˆä¸€èµ·æ¥çœ‹ä¸‹å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨å¯¹åº”çš„åˆ‡é¢ <code>org.mengyun.tcctransaction.interceptor.CompensableTransactionAspect</code>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CompensableTransactionAspect</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> CompensableTransactionInterceptor compensableTransactionInterceptor;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCompensableTransactionInterceptor</span><span class="params">(CompensableTransactionInterceptor compensableTransactionInterceptor)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.compensableTransactionInterceptor = compensableTransactionInterceptor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(org.mengyun.tcctransaction.api.Compensable)"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">compensableService</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Around</span>(<span class="string">"compensableService()"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interceptCompensableMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="keyword">return</span> compensableTransactionInterceptor.interceptCompensableMethod(pjp);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>é€šè¿‡ <code>org.aspectj.lang.annotation.@Pointcut</code> + <code>org.aspectj.lang.annotation.@Around</code> æ³¨è§£ï¼Œé…ç½®å¯¹ <strong>@Compensable æ³¨è§£çš„æ–¹æ³•</strong>è¿›è¡Œæ‹¦æˆªï¼Œè°ƒç”¨ <code>CompensableTransactionInterceptor#interceptCompensableMethod(...)</code> æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</li></ul><p><strong>CompensableTransactionInterceptor å®ç°ä»£ç å¦‚ä¸‹</strong>ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompensableTransactionInterceptor</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> TransactionManager transactionManager;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Set&lt;Class&lt;? extends Exception&gt;&gt; delayCancelExceptions;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interceptCompensableMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="comment">// è·å¾—å¸¦ @Compensable æ³¨è§£çš„æ–¹æ³•</span></div><div class="line">        Method method = CompensableMethodUtils.getCompensableMethod(pjp);</div><div class="line">        <span class="comment">//</span></div><div class="line">        Compensable compensable = method.getAnnotation(Compensable.class);</div><div class="line">        Propagation propagation = compensable.propagation();</div><div class="line">        <span class="comment">// è·å¾— äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line">        TransactionContext transactionContext = FactoryBuilder.factoryOf(compensable.transactionContextEditor()).getInstance().get(pjp.getTarget(), method, pjp.getArgs());</div><div class="line">        <span class="comment">// å½“å‰çº¿ç¨‹æ˜¯å¦åœ¨äº‹åŠ¡ä¸­</span></div><div class="line">        <span class="keyword">boolean</span> isTransactionActive = transactionManager.isTransactionActive();</div><div class="line">        <span class="comment">// åˆ¤æ–­äº‹åŠ¡ä¸Šä¸‹æ–‡æ˜¯å¦åˆæ³•</span></div><div class="line">        <span class="keyword">if</span> (!TransactionUtils.isLegalTransactionContext(isTransactionActive, propagation, transactionContext)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"no active compensable transaction while propagation is mandatory for method "</span> + method.getName());</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// è®¡ç®—æ–¹æ³•ç±»å‹</span></div><div class="line">        MethodType methodType = CompensableMethodUtils.calculateMethodType(propagation, isTransactionActive, transactionContext);</div><div class="line">        <span class="comment">// å¤„ç†</span></div><div class="line">        <span class="keyword">switch</span> (methodType) &#123;</div><div class="line">            <span class="keyword">case</span> ROOT:</div><div class="line">                <span class="keyword">return</span> rootMethodProceed(pjp);</div><div class="line">            <span class="keyword">case</span> PROVIDER:</div><div class="line">                <span class="keyword">return</span> providerMethodProceed(pjp, transactionContext);</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">return</span> pjp.proceed();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><p>è°ƒç”¨ <code>CompensableMethodUtils#getCompensableMethod(...)</code> æ–¹æ³•ï¼Œè·å¾—å¸¦ @Compensable æ³¨è§£çš„æ–¹æ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CompensableMethodUtils.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å¾—å¸¦ <span class="doctag">@Compensable</span> æ³¨è§£çš„æ–¹æ³•</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> pjp åˆ‡é¢ç‚¹</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ–¹æ³•</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Method <span class="title">getCompensableMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> </span>&#123;</div><div class="line">   Method method = ((MethodSignature) (pjp.getSignature())).getMethod(); <span class="comment">// ä»£ç†æ–¹æ³•å¯¹è±¡</span></div><div class="line">   <span class="keyword">if</span> (method.getAnnotation(Compensable.class) == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           method = pjp.getTarget().getClass().getMethod(method.getName(), method.getParameterTypes()); <span class="comment">// å®é™…æ–¹æ³•å¯¹è±¡</span></div><div class="line">       &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> method;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p></li><li><p>è°ƒç”¨ <code>TransactionContextEditor#get(...)</code> æ–¹æ³•ï¼Œä»å‚æ•°ä¸­è·å¾—äº‹åŠ¡ä¸Šä¸‹æ–‡ã€‚<strong>ä¸ºä»€ä¹ˆä»å‚æ•°ä¸­å¯ä»¥è·å¾—äº‹åŠ¡ä¸Šä¸‹æ–‡å‘¢</strong>ï¼Ÿåœ¨<a href="#">ã€Œ6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨ã€</a>æ­æ™“ç­”æ¡ˆã€‚</p></li><li><p>è°ƒç”¨ <code>TransactionManager#isTransactionActive()</code> æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹æ˜¯å¦åœ¨äº‹åŠ¡ä¸­ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionManager.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt; CURRENT = <span class="keyword">new</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTransactionActive</span><span class="params">()</span> </span>&#123;</div><div class="line">   Deque&lt;Transaction&gt; transactions = CURRENT.get();</div><div class="line">   <span class="keyword">return</span> transactions != <span class="keyword">null</span> &amp;&amp; !transactions.isEmpty();</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p></li><li><p>è°ƒç”¨ <code>TransactionUtils#isLegalTransactionContext(...)</code> æ–¹æ³•ï¼Œåˆ¤æ–­äº‹åŠ¡ä¸Šä¸‹æ–‡æ˜¯å¦åˆæ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionUtils.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ¤æ–­äº‹åŠ¡ä¸Šä¸‹æ–‡æ˜¯å¦åˆæ³•</span></div><div class="line"><span class="comment">* åœ¨ Propagation.MANDATORY å¿…é¡»æœ‰åœ¨äº‹åŠ¡å†…</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> isTransactionActive æ˜¯å¦</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> propagation ä¼ æ’­çº§åˆ«</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionContext äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ˜¯å¦åˆæ³•</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isLegalTransactionContext</span><span class="params">(<span class="keyword">boolean</span> isTransactionActive, Propagation propagation, TransactionContext transactionContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (propagation.equals(Propagation.MANDATORY) &amp;&amp; !isTransactionActive &amp;&amp; transactionContext == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>å½“ä¼ æ’­çº§åˆ«ä¸º Propagation.MANDATORY æ—¶ï¼Œè¦æ±‚å¿…é¡»åœ¨äº‹åŠ¡ä¸­ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>CompensableMethodUtils#calculateMethodType(...)</code> æ–¹æ³•ï¼Œè®¡ç®—æ–¹æ³•ç±»å‹ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è®¡ç®—æ–¹æ³•ç±»å‹</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> propagation ä¼ æ’­çº§åˆ«</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> isTransactionActive æ˜¯å¦äº‹åŠ¡å¼€å¯</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionContext äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ–¹æ³•ç±»å‹</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MethodType <span class="title">calculateMethodType</span><span class="params">(Propagation propagation, <span class="keyword">boolean</span> isTransactionActive, TransactionContext transactionContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> ((propagation.equals(Propagation.REQUIRED) &amp;&amp; !isTransactionActive &amp;&amp; transactionContext == <span class="keyword">null</span>) <span class="comment">// Propagation.REQUIREDï¼šæ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æ–°å»ºä¸€ä¸ªäº‹åŠ¡ã€‚</span></div><div class="line">           || propagation.equals(Propagation.REQUIRES_NEW)) &#123; <span class="comment">// Propagation.REQUIRES_NEWï¼šæ–°å»ºäº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚</span></div><div class="line">       <span class="keyword">return</span> MethodType.ROOT;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((propagation.equals(Propagation.REQUIRED) <span class="comment">// Propagation.REQUIREDï¼šæ”¯æŒå½“å‰äº‹åŠ¡</span></div><div class="line">               || propagation.equals(Propagation.MANDATORY)) <span class="comment">// Propagation.MANDATORYï¼šæ”¯æŒå½“å‰äº‹åŠ¡</span></div><div class="line">           &amp;&amp; !isTransactionActive &amp;&amp; transactionContext != <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span> MethodType.PROVIDER;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">return</span> MethodType.NORMAL;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>è®¡ç®—æ–¹æ³•ç±»å‹( MethodType )çš„ç›®çš„ï¼Œå¯ä»¥æ ¹æ®ä¸åŒæ–¹æ³•ç±»å‹ï¼Œåšä¸åŒçš„äº‹åŠ¡å¤„ç†ã€‚</li><li>æ–¹æ³•ç±»å‹ä¸º MethodType.ROOT æ—¶ï¼Œå‘èµ·<strong>æ ¹äº‹åŠ¡</strong>ï¼Œåˆ¤æ–­æ¡ä»¶å¦‚ä¸‹äºŒé€‰ä¸€ï¼š<ul><li>äº‹åŠ¡ä¼ æ’­çº§åˆ«ä¸º Propagation.REQUIREDï¼Œå¹¶ä¸”å½“å‰æ²¡æœ‰äº‹åŠ¡ã€‚</li><li>äº‹åŠ¡ä¼ æ’­çº§åˆ«ä¸º Propagation.REQUIRES_NEWï¼Œæ–°å»ºäº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚<strong>æ­¤æ—¶ï¼Œäº‹åŠ¡ç®¡ç†å™¨çš„å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—å¯èƒ½ä¼šå­˜åœ¨å¤šä¸ªäº‹åŠ¡</strong>ã€‚</li></ul></li><li>æ–¹æ³•ç±»å‹ä¸º MethodType.ROOT æ—¶ï¼Œå‘èµ·<strong>åˆ†æ”¯äº‹åŠ¡</strong>ï¼Œåˆ¤æ–­æ¡ä»¶å¦‚ä¸‹äºŒé€‰ä¸€ï¼š<ul><li>äº‹åŠ¡ä¼ æ’­çº§åˆ«ä¸º Propagation.REQUIREDï¼Œå¹¶ä¸”å½“å‰ä¸å­˜åœ¨äº‹åŠ¡ï¼Œ<strong>å¹¶ä¸”æ–¹æ³•å‚æ•°ä¼ é€’äº†äº‹åŠ¡ä¸Šä¸‹æ–‡</strong>ã€‚</li><li>äº‹åŠ¡ä¼ æ’­çº§åˆ«ä¸º Propagation.PROVIDERï¼Œå¹¶ä¸”å½“å‰ä¸å­˜åœ¨äº‹åŠ¡ï¼Œ<strong>å¹¶ä¸”æ–¹æ³•å‚æ•°ä¼ é€’äº†äº‹åŠ¡ä¸Šä¸‹æ–‡</strong>ã€‚</li><li><strong>å½“å‰ä¸å­˜åœ¨äº‹åŠ¡ï¼Œæ–¹æ³•å‚æ•°ä¼ é€’äº†äº‹åŠ¡ä¸Šä¸‹æ–‡æ˜¯ä»€ä¹ˆæ„æ€</strong>ï¼Ÿå½“è·¨æœåŠ¡<strong>è¿œç¨‹</strong>è°ƒç”¨æ—¶ï¼Œè¢«è°ƒç”¨æœåŠ¡æœ¬èº«( <strong>æœåŠ¡æä¾›è€…</strong> )ä¸åœ¨äº‹åŠ¡ä¸­ï¼Œé€šè¿‡ä¼ é€’äº‹åŠ¡ä¸Šä¸‹æ–‡å‚æ•°ï¼Œèå…¥å½“å‰äº‹åŠ¡ã€‚</li></ul></li><li>æ–¹æ³•ç±»å‹ä¸º MethodType.Normal æ—¶ï¼Œä¸è¿›è¡Œäº‹åŠ¡å¤„ç†ã€‚</li><li>MethodType.CONSUMER é¡¹ç›®å·²ç»ä¸å†ä½¿ç”¨ï¼ŒçŒœæµ‹å·²åºŸå¼ƒã€‚</li></ul></li><li><p>å½“æ–¹æ³•ç±»å‹ä¸º MethodType.ROOT æ—¶ï¼Œè°ƒç”¨ <code>#rootMethodProceed(...)</code> æ–¹æ³•ï¼Œå‘èµ· <strong>TCC æ•´ä½“æµç¨‹</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">rootMethodProceed</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">   Object returnValue;</div><div class="line">   Transaction transaction = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// å‘èµ·æ ¹äº‹åŠ¡</span></div><div class="line">       transaction = transactionManager.begin();</div><div class="line">       <span class="comment">// æ‰§è¡Œæ–¹æ³•åŸé€»è¾‘</span></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           returnValue = pjp.proceed();</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable tryingException) &#123;</div><div class="line">           <span class="keyword">if</span> (isDelayCancelException(tryingException)) &#123; <span class="comment">// æ˜¯å¦å»¶è¿Ÿå›æ»š</span></div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               logger.warn(String.format(<span class="string">"compensable transaction trying failed. transaction content:%s"</span>, JSON.toJSONString(transaction)), tryingException);</div><div class="line">               <span class="comment">// å›æ»šäº‹åŠ¡</span></div><div class="line">               transactionManager.rollback();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">throw</span> tryingException;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// æäº¤äº‹åŠ¡</span></div><div class="line">       transactionManager.commit();</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="comment">// å°†äº‹åŠ¡ä»å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ç§»é™¤</span></div><div class="line">       transactionManager.cleanAfterCompletion(transaction);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> returnValue;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><p>è°ƒç”¨ <code>#transactionManager()</code> æ–¹æ³•ï¼Œå‘èµ·<strong>æ ¹äº‹åŠ¡</strong>ï¼Œ<strong>TCC Try é˜¶æ®µå¼€å§‹</strong>ã€‚</p></li><li><p>è°ƒç”¨ <code>ProceedingJoinPoint#proceed()</code> æ–¹æ³•ï¼Œæ‰§è¡Œæ–¹æ³•<strong>åŸé€»è¾‘( å³ Try é€»è¾‘ )</strong>ã€‚</p></li><li><p>å½“åŸé€»è¾‘æ‰§è¡Œå¼‚å¸¸æ—¶ï¼Œ<strong>TCC Try é˜¶æ®µå¤±è´¥</strong>ï¼Œè°ƒç”¨ <code>TransactionManager#rollback(...)</code> æ–¹æ³•ï¼Œ<strong>TCC Cancel é˜¶æ®µ</strong>ï¼Œå›æ»šäº‹åŠ¡ã€‚æ­¤å¤„ <code>#isDelayCancelException(...)</code> æ–¹æ³•ï¼Œåˆ¤æ–­å¼‚å¸¸æ˜¯å¦ä¸ºå»¶è¿Ÿå–æ¶ˆå›æ»šå¼‚å¸¸ï¼Œéƒ¨åˆ†å¼‚å¸¸ä¸é€‚åˆç«‹å³å›æ»šäº‹åŠ¡ï¼Œåœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-recovery/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡æ¢å¤ã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>å½“åŸé€»è¾‘æ‰§è¡ŒæˆåŠŸæ—¶ï¼Œ<strong>TCC Try é˜¶æ®µæˆåŠŸ</strong>ï¼Œè°ƒç”¨ <code>TransactionManager#commit(...)</code> æ–¹æ³•ï¼Œ<strong>TCC Confirm é˜¶æ®µ</strong>ï¼Œæäº¤äº‹åŠ¡ã€‚</p></li><li><p>è°ƒç”¨ <code>TransactionManager#cleanAfterCompletion(...)</code> æ–¹æ³•ï¼Œå°†äº‹åŠ¡ä»å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ç§»é™¤ï¼Œé¿å…çº¿ç¨‹å†²çªã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionManager.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanAfterCompletion</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (isTransactionActive() &amp;&amp; transaction != <span class="keyword">null</span>) &#123;</div><div class="line">        Transaction currentTransaction = getCurrentTransaction();</div><div class="line">        <span class="keyword">if</span> (currentTransaction == transaction) &#123;</div><div class="line">            CURRENT.get().pop();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"Illegal transaction when clean after completion"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>x</li></ul></li></ul></li><li><p>å½“æ–¹æ³•ç±»å‹ä¸º Propagation.PROVIDER æ—¶ï¼ŒæœåŠ¡æä¾›è€…å‚ä¸ <strong>TCC æ•´ä½“æµç¨‹</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">providerMethodProceed</span><span class="params">(ProceedingJoinPoint pjp, TransactionContext transactionContext)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">   Transaction transaction = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">switch</span> (TransactionStatus.valueOf(transactionContext.getStatus())) &#123;</div><div class="line">           <span class="keyword">case</span> TRYING:</div><div class="line">               <span class="comment">// ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡</span></div><div class="line">               transaction = transactionManager.propagationNewBegin(transactionContext);</div><div class="line">               <span class="keyword">return</span> pjp.proceed();</div><div class="line">           <span class="keyword">case</span> CONFIRMING:</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">// ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡</span></div><div class="line">                   transaction = transactionManager.propagationExistBegin(transactionContext);</div><div class="line">                   <span class="comment">// æäº¤äº‹åŠ¡</span></div><div class="line">                   transactionManager.commit();</div><div class="line">               &#125; <span class="keyword">catch</span> (NoExistedTransactionException excepton) &#123;</div><div class="line">                   <span class="comment">//the transaction has been commit,ignore it.</span></div><div class="line">               &#125;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> CANCELLING:</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">// ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡</span></div><div class="line">                   transaction = transactionManager.propagationExistBegin(transactionContext);</div><div class="line">                   <span class="comment">// å›æ»šäº‹åŠ¡</span></div><div class="line">                   transactionManager.rollback();</div><div class="line">               &#125; <span class="keyword">catch</span> (NoExistedTransactionException exception) &#123;</div><div class="line">                   <span class="comment">//the transaction has been rollback,ignore it.</span></div><div class="line">               &#125;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="comment">// å°†äº‹åŠ¡ä»å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ç§»é™¤</span></div><div class="line">       transactionManager.cleanAfterCompletion(transaction);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è¿”å›ç©ºå€¼</span></div><div class="line">   Method method = ((MethodSignature) (pjp.getSignature())).getMethod();</div><div class="line">   <span class="keyword">return</span> ReflectionUtils.getNullValue(method.getReturnType());</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><p>å½“äº‹åŠ¡å¤„äº TransactionStatus.TRYING æ—¶ï¼Œè°ƒç”¨ <code>TransactionManager#propagationExistBegin(...)</code> æ–¹æ³•ï¼Œä¼ æ’­å‘èµ·<strong>åˆ†æ”¯</strong>äº‹åŠ¡ã€‚å‘èµ·<strong>åˆ†æ”¯</strong>äº‹åŠ¡å®Œæˆåï¼Œè°ƒç”¨ <code>ProceedingJoinPoint#proceed()</code> æ–¹æ³•ï¼Œæ‰§è¡Œæ–¹æ³•<strong>åŸé€»è¾‘( å³ Try é€»è¾‘ )</strong>ã€‚</p><ul><li><strong>ä¸ºä»€ä¹ˆè¦ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡</strong>ï¼Ÿåœ¨<strong>æ ¹äº‹åŠ¡</strong>è¿›è¡Œ Confirm / Cancel æ—¶ï¼Œè°ƒç”¨<strong>æ ¹äº‹åŠ¡</strong>ä¸Šçš„å‚ä¸è€…ä»¬æäº¤æˆ–å›æ»šäº‹åŠ¡æ—¶ï¼Œè¿›è¡Œè¿œç¨‹æœåŠ¡æ–¹æ³•è°ƒç”¨çš„å‚ä¸è€…ï¼Œå¯ä»¥é€šè¿‡è‡ªå·±çš„äº‹åŠ¡ç¼–å·å…³è”ä¸Šä¼ æ’­çš„<strong>åˆ†æ”¯</strong>äº‹åŠ¡( ä¸¤è€…çš„äº‹åŠ¡ç¼–å·ç›¸ç­‰ )ï¼Œè¿›è¡Œäº‹åŠ¡çš„æäº¤æˆ–å›æ»šã€‚</li></ul></li><li><p>å½“äº‹åŠ¡å¤„äº TransactionStatus.CONFIRMING æ—¶ï¼Œè°ƒç”¨ <code>TransactionManager#commit()</code> æ–¹æ³•ï¼Œæäº¤äº‹åŠ¡ã€‚</p></li><li><p>å½“äº‹åŠ¡å¤„äº TransactionStatus.CANCELLING æ—¶ï¼Œè°ƒç”¨ <code>TransactionManager#rollback()</code> æ–¹æ³•ï¼Œæäº¤äº‹åŠ¡ã€‚</p></li><li><p>è°ƒç”¨ <code>TransactionManager#cleanAfterCompletion(...)</code> æ–¹æ³•ï¼Œå°†äº‹åŠ¡ä»å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ç§»é™¤ï¼Œé¿å…çº¿ç¨‹å†²çªã€‚</p></li><li><p>å½“äº‹åŠ¡å¤„äº TransactionStatus.CONFIRMING / TransactionStatus.CANCELLING æ—¶ï¼Œè°ƒç”¨ <code>ReflectionUtils#getNullValue(...)</code> æ–¹æ³•ï¼Œè¿”å›ç©ºå€¼ã€‚<strong>ä¸ºä»€ä¹ˆè¿”å›ç©ºå€¼</strong>ï¼ŸConfirm / Cancel ç›¸å…³æ–¹æ³•ï¼Œæ˜¯é€šè¿‡ AOP åˆ‡é¢è°ƒç”¨ï¼Œåªè°ƒç”¨ï¼Œä¸å¤„ç†è¿”å›å€¼ï¼Œä½†æ˜¯åˆä¸èƒ½æ²¡æœ‰è¿”å›å€¼ï¼Œå› æ­¤ç›´æ¥è¿”å›ç©ºã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getNullValue</span><span class="params">(Class type)</span> </span>&#123;</div><div class="line">   <span class="comment">// å¤„ç†åŸºæœ¬ç±»å‹</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">boolean</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">byte</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">short</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">int</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">long</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">float</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">double</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å¤„ç†å¯¹è±¡</span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p></li></ul></li><li><p>å½“æ–¹æ³•ç±»å‹ä¸º Propagation.NORMAL æ—¶ï¼Œæ‰§è¡Œæ–¹æ³•åŸé€»è¾‘ï¼Œ<strong>ä¸è¿›è¡Œäº‹åŠ¡å¤„ç†</strong>ã€‚</p></li></ul><h2>6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨</h2><p>å…ˆä¸€èµ·æ¥çœ‹ä¸‹èµ„æºåè°ƒè€…æ‹¦æˆªå™¨ å¯¹åº”çš„åˆ‡é¢ <code>org.mengyun.tcctransaction.interceptor.CompensableTransactionAspect</code>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceCoordinatorAspect</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ResourceCoordinatorInterceptor resourceCoordinatorInterceptor;</div><div class="line"></div><div class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(org.mengyun.tcctransaction.api.Compensable)"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transactionContextCall</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Around</span>(<span class="string">"transactionContextCall()"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interceptTransactionContextMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="keyword">return</span> resourceCoordinatorInterceptor.interceptTransactionContextMethod(pjp);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResourceCoordinatorInterceptor</span><span class="params">(ResourceCoordinatorInterceptor resourceCoordinatorInterceptor)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.resourceCoordinatorInterceptor = resourceCoordinatorInterceptor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>é€šè¿‡ <code>org.aspectj.lang.annotation.@Pointcut</code> + <code>org.aspectj.lang.annotation.@Around</code> æ³¨è§£ï¼Œé…ç½®å¯¹ <strong>@Compensable æ³¨è§£çš„æ–¹æ³•</strong>è¿›è¡Œæ‹¦æˆªï¼Œè°ƒç”¨ <code>ResourceCoordinatorInterceptor#interceptTransactionContextMethod(...)</code> æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</li></ul><p><strong>ResourceCoordinatorInterceptor å®ç°ä»£ç å¦‚ä¸‹</strong>ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceCoordinatorInterceptor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> TransactionManager transactionManager;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interceptTransactionContextMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        Transaction transaction = transactionManager.getCurrentTransaction();</div><div class="line">        <span class="keyword">if</span> (transaction != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">switch</span> (transaction.getStatus()) &#123;</div><div class="line">                <span class="keyword">case</span> TRYING:</div><div class="line">                    <span class="comment">// æ·»åŠ äº‹åŠ¡å‚ä¸è€…</span></div><div class="line">                    enlistParticipant(pjp);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> CONFIRMING:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> CANCELLING:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// æ‰§è¡Œæ–¹æ³•åŸé€»è¾‘</span></div><div class="line">        <span class="keyword">return</span> pjp.proceed(pjp.getArgs());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>å½“äº‹åŠ¡å¤„äº TransactionStatus.TRYING æ—¶ï¼Œè°ƒç”¨ <code>#enlistParticipant(...)</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡å‚ä¸è€…ã€‚</li><li>è°ƒç”¨ <code>ProceedingJoinPoint#proceed(...)</code> æ–¹æ³•ï¼Œæ‰§è¡Œæ–¹æ³•åŸé€»è¾‘ã€‚</li></ul><p><strong><code>ResourceCoordinatorInterceptor#enlistParticipant()</code> å®ç°ä»£ç å¦‚ä¸‹</strong>ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enlistParticipant</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> IllegalAccessException, InstantiationException </span>&#123;</div><div class="line">   <span class="comment">// è·å¾— @Compensable æ³¨è§£</span></div><div class="line">   Method method = CompensableMethodUtils.getCompensableMethod(pjp);</div><div class="line">   <span class="keyword">if</span> (method == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(String.format(<span class="string">"join point not found method, point is : %s"</span>, pjp.getSignature().getName()));</div><div class="line">   &#125;</div><div class="line">   Compensable compensable = method.getAnnotation(Compensable.class);</div><div class="line">   <span class="comment">// è·å¾— ç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ–¹æ³• å’Œ å–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ–¹æ³•</span></div><div class="line">   String confirmMethodName = compensable.confirmMethod();</div><div class="line">   String cancelMethodName = compensable.cancelMethod();</div><div class="line">   <span class="comment">// è·å– å½“å‰çº¿ç¨‹äº‹åŠ¡ç¬¬ä¸€ä¸ª(å¤´éƒ¨)å…ƒç´ </span></div><div class="line">   Transaction transaction = transactionManager.getCurrentTransaction();</div><div class="line">   <span class="comment">// åˆ›å»º äº‹åŠ¡ç¼–å·</span></div><div class="line">   TransactionXid xid = <span class="keyword">new</span> TransactionXid(transaction.getXid().getGlobalTransactionId());</div><div class="line">   <span class="comment">// TODO</span></div><div class="line">   <span class="keyword">if</span> (FactoryBuilder.factoryOf(compensable.transactionContextEditor()).getInstance().get(pjp.getTarget(), method, pjp.getArgs()) == <span class="keyword">null</span>) &#123;</div><div class="line">       FactoryBuilder.factoryOf(compensable.transactionContextEditor()).getInstance().set(<span class="keyword">new</span> TransactionContext(xid, TransactionStatus.TRYING.getId()), pjp.getTarget(), ((MethodSignature) pjp.getSignature()).getMethod(), pjp.getArgs());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è·å¾—ç±»</span></div><div class="line">   Class targetClass = ReflectionUtils.getDeclaringType(pjp.getTarget().getClass(), method.getName(), method.getParameterTypes());</div><div class="line">   <span class="comment">// åˆ›å»º ç¡®è®¤æ‰§è¡Œæ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡ å’Œ å–æ¶ˆæ‰§è¡Œæ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡</span></div><div class="line">   InvocationContext confirmInvocation = <span class="keyword">new</span> InvocationContext(targetClass,</div><div class="line">           confirmMethodName,</div><div class="line">           method.getParameterTypes(), pjp.getArgs());</div><div class="line">   InvocationContext cancelInvocation = <span class="keyword">new</span> InvocationContext(targetClass,</div><div class="line">           cancelMethodName,</div><div class="line">           method.getParameterTypes(), pjp.getArgs());</div><div class="line">   <span class="comment">// åˆ›å»º äº‹åŠ¡å‚ä¸è€…</span></div><div class="line">   Participant participant =</div><div class="line">           <span class="keyword">new</span> Participant(</div><div class="line">                   xid,</div><div class="line">                   confirmInvocation,</div><div class="line">                   cancelInvocation,</div><div class="line">                   compensable.transactionContextEditor());</div><div class="line">   <span class="comment">// æ·»åŠ  äº‹åŠ¡å‚ä¸è€… åˆ° äº‹åŠ¡</span></div><div class="line">   transactionManager.enlistParticipant(participant);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><p>è°ƒç”¨ <code>CompensableMethodUtils#getCompensableMethod(...)</code> æ–¹æ³•ï¼Œè·å¾—å¸¦ @Compensable æ³¨è§£çš„æ–¹æ³•ã€‚</p></li><li><p>è°ƒç”¨ <code>#getCurrentTransaction()</code> æ–¹æ³•ï¼Œ è·å–äº‹åŠ¡ã€‚</p></li><li><p>è°ƒç”¨ TransactionXid æ„é€ æ–¹æ³•ï¼Œåˆ›å»º<strong>åˆ†æ”¯</strong>äº‹åŠ¡ç¼–å·ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * å…¨å±€äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] globalTransactionId;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * åˆ†æ”¯äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] branchQualifier;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">TransactionXid</span><span class="params">(<span class="keyword">byte</span>[] globalTransactionId)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.globalTransactionId = globalTransactionId;</div><div class="line">   branchQualifier = uuidToByteArray(UUID.randomUUID()); <span class="comment">// ç”Ÿæˆ åˆ†æ”¯äº‹åŠ¡ç¼–å·</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>åˆ†æ”¯äº‹åŠ¡ç¼–å·( <code>branchQualifier</code> ) éœ€è¦ç”Ÿæˆã€‚</li></ul></li><li><p>TODO TransactionContext å’Œ Participant çš„å…³ç³»ã€‚</p></li><li><p>è°ƒç”¨ <code>ReflectionUtils#getDeclaringType(...)</code> æ–¹æ³•ï¼Œè·å¾—å£°æ˜ @Compensable æ–¹æ³•çš„å®é™…ç±»ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Class <span class="title">getDeclaringType</span><span class="params">(Class aClass, String methodName, Class&lt;?&gt;[] parameterTypes)</span> </span>&#123;</div><div class="line">   Method method;</div><div class="line">   Class findClass = aClass;</div><div class="line">   <span class="keyword">do</span> &#123;</div><div class="line">       Class[] clazzes = findClass.getInterfaces();</div><div class="line">       <span class="keyword">for</span> (Class clazz : clazzes) &#123;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               method = clazz.getDeclaredMethod(methodName, parameterTypes);</div><div class="line">           &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">               method = <span class="keyword">null</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (method != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">return</span> clazz;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       findClass = findClass.getSuperclass();</div><div class="line">   &#125; <span class="keyword">while</span> (!findClass.equals(Object.class));</div><div class="line">   <span class="keyword">return</span> aClass;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p></li><li><p>è°ƒç”¨ InvocationContext æ„é€ æ–¹æ³•ï¼Œåˆ†åˆ«åˆ›å»ºç¡®è®¤æ‰§è¡Œæ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡å’Œå–æ¶ˆæ‰§è¡Œæ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç±»</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> Class targetClass;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ–¹æ³•å</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> String methodName;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å‚æ•°ç±»å‹æ•°ç»„</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> Class[] parameterTypes;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å‚æ•°æ•°ç»„</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> Object[] args;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvocationContext</span><span class="params">(Class targetClass, String methodName, Class[] parameterTypes, Object... args)</span> </span>&#123;</div><div class="line">  <span class="keyword">this</span>.methodName = methodName;</div><div class="line">  <span class="keyword">this</span>.parameterTypes = parameterTypes;</div><div class="line">  <span class="keyword">this</span>.targetClass = targetClass;</div><div class="line">  <span class="keyword">this</span>.args = args;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p></li><li><p>è°ƒç”¨ Participant æ„é€ æ–¹æ³•ï¼Œåˆ›å»ºäº‹åŠ¡å‚ä¸è€…ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Participant</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">4127729421281425247L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> TransactionXid xid;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> InvocationContext confirmInvocationContext;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ–¹æ³•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> InvocationContext cancelInvocationContext;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Terminator terminator = <span class="keyword">new</span> Terminator();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Class&lt;? extends TransactionContextEditor&gt; transactionContextEditorClass;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Participant</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Participant</span><span class="params">(TransactionXid xid, InvocationContext confirmInvocationContext, InvocationContext cancelInvocationContext, Class&lt;? extends TransactionContextEditor&gt; transactionContextEditorClass)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.xid = xid;</div><div class="line">        <span class="keyword">this</span>.confirmInvocationContext = confirmInvocationContext;</div><div class="line">        <span class="keyword">this</span>.cancelInvocationContext = cancelInvocationContext;</div><div class="line">        <span class="keyword">this</span>.transactionContextEditorClass = transactionContextEditorClass;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p></li><li><p>è°ƒç”¨ <code>TransactionManager#enlistParticipant(...)</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡å‚ä¸è€…åˆ°äº‹åŠ¡ã€‚</p></li></ul><h1>666. å½©è›‹</h1><p>å—é™äºæœ¬äººçš„èƒ½åŠ›ï¼Œè›®å¤šå¤„è¡¨è¾¾ä¸å¤Ÿæ¸…æ™°æˆ–è€…æ˜“æ‡‚ï¼Œéå¸¸æŠ±æ­‰ã€‚å¦‚æœä½ å¯¹ä»»ä½•åœ°æ–¹æœ‰ä»»ä½•ç–‘é—®ï¼Œæ¬¢è¿æ·»åŠ æœ¬äººå¾®ä¿¡å·( wangwenbin-server )ï¼ŒæœŸå¾…ä¸ä½ çš„äº¤æµã€‚ä¸é™äº TCCï¼Œä¹Ÿå¯ä»¥æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä¹Ÿå¯ä»¥æ˜¯å¾®æœåŠ¡ï¼Œä»¥åŠç­‰ç­‰ã€‚</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_08/05.png" alt=""></p><p>å¤–é€ä¸€æœ¬æ­¦æ—ç§˜ç±ï¼šå¸¦ä¸­æ–‡æ³¨é‡Šçš„ TCC-Transaction ä»“åº“åœ°å€ï¼Œç›®å‰æ­£åœ¨æ…¢æ…¢å®Œå–„ã€‚ä¼ é€é—¨ï¼š<a href="https://github.com/YunaiV/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/YunaiV/tcc-transaction</a>ã€‚</p><p>å†é€ä¸€æœ¬è‘µèŠ±å®å…¸ï¼š<a href="https://my.oschina.net/fileoptions/blog/899991" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠTCCå‹åˆ†å¸ƒå¼äº‹åŠ¡åŸç†å’Œå®ç°ã€‹ç³»åˆ—</a>ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/TCC-Transaction/">TCC-Transaction</a></div><div class="article-share" id="share"><div data-url="http://www.iocoder.cn/TCC-Transaction/tcc-core/" data-title="TCC-Transaction æºç åˆ†æ â€”â€” TCC å®ç° | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/TCC-Transaction/transaction-repository/" title="TCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡å­˜å‚¨å™¨"><strong>PREVIOUS:</strong><br><span>TCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡å­˜å‚¨å™¨</span></a></div><div class="next"><a href="/TCC-Transaction/build-debugging-environment/" title="TCC-Transaction æºç åˆ†æ â€”â€” è°ƒè¯•ç¯å¢ƒæ­å»º"><strong>NEXT:</strong><br><span>TCC-Transaction æºç åˆ†æ â€”â€” è°ƒè¯•ç¯å¢ƒæ­å»º</span></a></div></nav></div></div><footer><div id="footer"><img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display:none"><p class="copyright">Â© 2017 <a href="http://www.iocoder.cn" target="_blank" title="ç‹æ–‡æ–Œ">ç‹æ–‡æ–Œ</a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a> && Powered by <a href="http://hexo.io" target="_blank" title="hexo" rel="external nofollow noopener noreferrer">hexo</a> && Theme by <a href="http://gengbiao.me" target="_blank" title="coney" rel="external nofollow noopener noreferrer">coney</a></p></div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2");ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script src="/js/util.js"></script></body>