<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>TCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡å­˜å‚¨å™¨ | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="ç‹æ–‡æ–Œ"><meta name="description" content="1. æ¦‚è¿°
2. åºåˆ—åŒ–
2.1 JDK åºåˆ—åŒ–å®ç°
2.2 Kyro åºåˆ—åŒ–å®ç°
2.3 JSON åºåˆ—åŒ–å®ç°


3. å­˜å‚¨å™¨
3.1 å¯ç¼“å­˜çš„äº‹åŠ¡å­˜å‚¨å™¨æŠ½è±¡ç±»
3.2 JDBC äº‹åŠ¡å­˜å‚¨å™¨
3.3 Redis äº‹åŠ¡å­˜å‚¨å™¨
3.4 Zookeeper äº‹åŠ¡å­˜å‚¨å™¨
3.5 File äº‹åŠ¡å­˜å‚¨å™¨

"><meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?9e70e3362807c1bd185a79655b307027";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG">èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</a></h1><a class="blog-motto">æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li><li><a href="/link_url">å‹é“¾</a></li></ul></ul></nav></div></header><div id="container"><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-åºåˆ—åŒ–"><span class="toc-number">2.</span> <span class="toc-text">2. åºåˆ—åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-JDK-åºåˆ—åŒ–å®ç°"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 JDK åºåˆ—åŒ–å®ç°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-Kyro-åºåˆ—åŒ–å®ç°"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 Kyro åºåˆ—åŒ–å®ç°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-JSON-åºåˆ—åŒ–å®ç°"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 JSON åºåˆ—åŒ–å®ç°</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-å­˜å‚¨å™¨"><span class="toc-number">3.</span> <span class="toc-text">3. å­˜å‚¨å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-å¯ç¼“å­˜çš„äº‹åŠ¡å­˜å‚¨å™¨æŠ½è±¡ç±»"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 å¯ç¼“å­˜çš„äº‹åŠ¡å­˜å‚¨å™¨æŠ½è±¡ç±»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-JDBC-äº‹åŠ¡å­˜å‚¨å™¨"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 JDBC äº‹åŠ¡å­˜å‚¨å™¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-Redis-äº‹åŠ¡å­˜å‚¨å™¨"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 Redis äº‹åŠ¡å­˜å‚¨å™¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-Zookeeper-äº‹åŠ¡å­˜å‚¨å™¨"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 Zookeeper äº‹åŠ¡å­˜å‚¨å™¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-File-äº‹åŠ¡å­˜å‚¨å™¨"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 File äº‹åŠ¡å­˜å‚¨å™¨</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-å½©è›‹"><span class="toc-number">4.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li><li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/TCC-Transaction/" title="TCC-Transaction">TCC-Transaction<sup>6</sup></a></li><li><a href="/categories/æŠ€æœ¯æ‚æ–‡/" title="æŠ€æœ¯æ‚æ–‡">æŠ€æœ¯æ‚æ–‡<sup>4</sup></a></li></ul></div></aside></div><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/TCC-Transaction/transaction-repository/" title="TCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡å­˜å‚¨å™¨" itemprop="url">TCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡å­˜å‚¨å™¨</a></h1><p class="article-author"></p><p class="article-time">æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. åºåˆ—åŒ–</a><ul><li><a href="#">2.1 JDK åºåˆ—åŒ–å®ç°</a></li><li><a href="#">2.2 Kyro åºåˆ—åŒ–å®ç°</a></li><li><a href="#">2.3 JSON åºåˆ—åŒ–å®ç°</a></li></ul></li><li><a href="#">3. å­˜å‚¨å™¨</a><ul><li><a href="#">3.1 å¯ç¼“å­˜çš„äº‹åŠ¡å­˜å‚¨å™¨æŠ½è±¡ç±»</a></li><li><a href="#">3.2 JDBC äº‹åŠ¡å­˜å‚¨å™¨</a></li><li><a href="#">3.3 Redis äº‹åŠ¡å­˜å‚¨å™¨</a></li><li><a href="#">3.4 Zookeeper äº‹åŠ¡å­˜å‚¨å™¨</a></li><li><a href="#">3.5 File äº‹åŠ¡å­˜å‚¨å™¨</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« <strong>äº‹åŠ¡å­˜å‚¨å™¨</strong>ã€‚ä¸»è¦æ¶‰åŠå¦‚ä¸‹ Maven é¡¹ç›®ï¼š</p><ul><li><code>tcc-transaction-core</code> ï¼štcc-transaction åº•å±‚å®ç°ã€‚</li></ul><p>åœ¨ TCC çš„è¿‡ç¨‹ä¸­ï¼Œæ ¹æ®åº”ç”¨å†…å­˜ä¸­çš„äº‹åŠ¡ä¿¡æ¯å®Œæˆæ•´ä¸ªäº‹åŠ¡æµç¨‹ã€‚But å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå°†äº‹åŠ¡ä¿¡æ¯åªæ”¾åœ¨åº”ç”¨å†…å­˜ä¸­æ˜¯è¿œè¿œä¸å¤Ÿå¯é çš„ã€‚ä¾‹å¦‚ï¼š</p><ol><li>åº”ç”¨è¿›ç¨‹å¼‚å¸¸å´©æºƒï¼Œæœªå®Œæˆçš„äº‹åŠ¡ä¿¡æ¯å°†ä¸¢å¤±ã€‚</li><li>åº”ç”¨è¿›ç¨‹é›†ç¾¤ï¼Œå½“æä¾›è¿œç¨‹æœåŠ¡è°ƒç”¨æ—¶ï¼Œäº‹åŠ¡ä¿¡æ¯éœ€è¦é›†ç¾¤å†…å…±äº«ã€‚</li><li>å‘èµ·äº‹åŠ¡çš„åº”ç”¨éœ€è¦é‡å¯éƒ¨ç½²æ–°ç‰ˆæœ¬ï¼Œå› ä¸ºå„ç§åŸå› ï¼Œæœ‰æœªå®Œæˆçš„äº‹åŠ¡ã€‚</li></ol><p>å› æ­¤ï¼ŒTCC-Transaction å°†äº‹åŠ¡ä¿¡æ¯æ·»åŠ åˆ°å†…å­˜ä¸­çš„åŒæ—¶ï¼Œä¼šä½¿ç”¨å¤–éƒ¨å­˜å‚¨è¿›è¡ŒæŒä¹…åŒ–ã€‚ç›®å‰æä¾›å››ç§å¤–éƒ¨å­˜å‚¨ï¼š</p><ul><li>JdbcTransactionRepositoryï¼ŒJDBC äº‹åŠ¡å­˜å‚¨å™¨</li><li>RedisTransactionRepositoryï¼ŒRedis äº‹åŠ¡å­˜å‚¨å™¨</li><li>ZooKeeperTransactionRepositoryï¼ŒZookeeper äº‹åŠ¡å­˜å‚¨å™¨</li><li>FileSystemTransactionRepositoryï¼ŒFile äº‹åŠ¡å­˜å‚¨å™¨</li></ul><p>æœ¬æ–‡æ¶‰åŠåˆ°çš„ç±»å…³ç³»å¦‚ä¸‹å›¾( <a href="http://www.iocoder.cn/images/TCC-Transaction/2018_02_15/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_15/01.png" alt=""></p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º TCC-Transaction ç‚¹èµï¼<a href="https://github.com/changmingxie/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>psï¼šç¬”è€…å‡è®¾ä½ å·²ç»é˜…è¯»è¿‡<a href="https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x" rel="external nofollow noopener noreferrer" target="_blank">ã€Štcc-transaction å®˜æ–¹æ–‡æ¡£ â€”â€” ä½¿ç”¨æŒ‡å—1.2.xã€‹</a>ã€‚</p><h1 id="2-åºåˆ—åŒ–"><a href="#2-åºåˆ—åŒ–" class="headerlink" title="2. åºåˆ—åŒ–"></a>2. åºåˆ—åŒ–</h1><p>åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/tcc-core/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” TCC å®ç°ã€‹ã€Œ4. äº‹åŠ¡ä¸å‚ä¸è€…ã€</a>ï¼Œå¯ä»¥çœ‹åˆ° Transaction æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„å¯¹è±¡ï¼Œå†…åµŒ Participant æ•°ç»„ï¼Œè€Œ Participant æœ¬èº«ä¹Ÿæ˜¯å¤æ‚çš„å¯¹è±¡ï¼Œå†…åµŒäº†æ›´å¤šçš„å…¶ä»–å¯¹è±¡ï¼Œå› æ­¤ï¼Œå­˜å‚¨å™¨åœ¨æŒä¹…åŒ– Transaction æ—¶ï¼Œéœ€è¦åºåˆ—åŒ–åæ‰èƒ½å­˜å‚¨ã€‚</p><p><code>org.mengyun.tcctransaction.serializer.ObjectSerializer</code>ï¼Œå¯¹è±¡åºåˆ—åŒ–<strong>æ¥å£</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ObjectSerializer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">byte</span>[] serialize(T t);</div><div class="line">    </div><div class="line">    <span class="function">T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ç›®å‰æä¾› <strong>JDKè‡ªå¸¦åºåˆ—åŒ–</strong> å’Œ <strong>Kyroåºåˆ—åŒ–</strong> ä¸¤ç§å®ç°ã€‚</p><h2 id="2-1-JDK-åºåˆ—åŒ–å®ç°"><a href="#2-1-JDK-åºåˆ—åŒ–å®ç°" class="headerlink" title="2.1 JDK åºåˆ—åŒ–å®ç°"></a>2.1 JDK åºåˆ—åŒ–å®ç°</h2><p><code>org.mengyun.tcctransaction.serializer.JdkSerializationSerializer</code>ï¼ŒJDK åºåˆ—åŒ–å®ç°ã€‚æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»<a href="https://github.com/changmingxie/tcc-transaction/blob/70130d12004456fd4b97510c210c24502a1b3acb/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/serializer/JdkSerializationSerializer.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</p><p><strong>TCC-Transaction ä½¿ç”¨çš„é»˜è®¤çš„åºåˆ—åŒ–</strong>ã€‚</p><h2 id="2-2-Kyro-åºåˆ—åŒ–å®ç°"><a href="#2-2-Kyro-åºåˆ—åŒ–å®ç°" class="headerlink" title="2.2 Kyro åºåˆ—åŒ–å®ç°"></a>2.2 Kyro åºåˆ—åŒ–å®ç°</h2><p><code>org.mengyun.tcctransaction.serializer.KryoTransactionSerializer</code>ï¼ŒKyro åºåˆ—åŒ–å®ç°ã€‚æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»<a href="https://github.com/changmingxie/tcc-transaction/blob/70130d12004456fd4b97510c210c24502a1b3acb/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/serializer/KryoTransactionSerializer.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</p><h2 id="2-3-JSON-åºåˆ—åŒ–å®ç°"><a href="#2-3-JSON-åºåˆ—åŒ–å®ç°" class="headerlink" title="2.3 JSON åºåˆ—åŒ–å®ç°"></a>2.3 JSON åºåˆ—åŒ–å®ç°</h2><p>JDK å’Œ Kyro çš„åºåˆ—åŒ–å®ç°ï¼Œè‚‰çœ¼æ— æ³•ç›´è§‚å…·ä½“å­˜å‚¨äº‹åŠ¡çš„ä¿¡æ¯ï¼Œä½ å¯ä»¥é€šè¿‡å®ç° ObjectSerializer æ¥å£ï¼Œå®ç°è‡ªå®šä¹‰çš„ JSON åºåˆ—åŒ–ã€‚</p><h1 id="3-å­˜å‚¨å™¨"><a href="#3-å­˜å‚¨å™¨" class="headerlink" title="3. å­˜å‚¨å™¨"></a>3. å­˜å‚¨å™¨</h1><p><code>org.mengyun.tcctransaction.TransactionRepository</code>ï¼Œäº‹åŠ¡å­˜å‚¨å™¨<strong>æ¥å£</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ–°å¢äº‹åŠ¡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æ–°å¢æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">create</span><span class="params">(Transaction transaction)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ›´æ–°äº‹åŠ¡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æ›´æ–°æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">update</span><span class="params">(Transaction transaction)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ é™¤äº‹åŠ¡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> åˆ é™¤æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">delete</span><span class="params">(Transaction transaction)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·å–äº‹åŠ¡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> xid äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> äº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">Transaction <span class="title">findByXid</span><span class="params">(TransactionXid xid)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·å–è¶…è¿‡æŒ‡å®šæ—¶é—´çš„äº‹åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> date æŒ‡å®šæ—¶é—´</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> äº‹åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">List&lt;Transaction&gt; <span class="title">findAllUnmodifiedSince</span><span class="params">(Date date)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ä¸åŒçš„å­˜å‚¨å™¨é€šè¿‡å®ç°è¯¥æ¥å£ï¼Œæä¾›äº‹åŠ¡çš„å¢åˆ æ”¹æŸ¥åŠŸèƒ½ã€‚</p><h2 id="3-1-å¯ç¼“å­˜çš„äº‹åŠ¡å­˜å‚¨å™¨æŠ½è±¡ç±»"><a href="#3-1-å¯ç¼“å­˜çš„äº‹åŠ¡å­˜å‚¨å™¨æŠ½è±¡ç±»" class="headerlink" title="3.1 å¯ç¼“å­˜çš„äº‹åŠ¡å­˜å‚¨å™¨æŠ½è±¡ç±»"></a>3.1 å¯ç¼“å­˜çš„äº‹åŠ¡å­˜å‚¨å™¨æŠ½è±¡ç±»</h2><p><code>org.mengyun.tcctransaction.repository.CachableTransactionRepository</code>ï¼Œ<strong>å¯ç¼“å­˜</strong>çš„äº‹åŠ¡å­˜å‚¨å™¨<strong>æŠ½è±¡ç±»</strong>ï¼Œå®ç°å¢åˆ æ”¹æŸ¥äº‹åŠ¡æ—¶ï¼ŒåŒæ—¶ç¼“å­˜äº‹åŠ¡ä¿¡æ¯ã€‚åœ¨ä¸Šé¢ç±»å›¾ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ° TCC-Transaction è‡ªå¸¦çš„å¤šç§å­˜å‚¨å™¨éƒ½ç»§æ‰¿è¯¥æŠ½è±¡ç±»ã€‚</p><p><strong>CachableTransactionRepository æ„é€ æ–¹æ³•</strong>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CachableTransactionRepository</span> <span class="keyword">implements</span> <span class="title">TransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¼“å­˜è¿‡æœŸæ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> expireDuration = <span class="number">120</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¼“å­˜</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Cache&lt;Xid, Transaction&gt; transactionXidCompensableTransactionCache;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CachableTransactionRepository</span><span class="params">()</span> </span>&#123;</div><div class="line">        transactionXidCompensableTransactionCache = CacheBuilder.newBuilder().expireAfterAccess(expireDuration, TimeUnit.SECONDS).maximumSize(<span class="number">1000</span>).build();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ <a href="https://github.com/google/guava/wiki/CachesExplained" rel="external nofollow noopener noreferrer" target="_blank">Guava Cache</a> å†…å­˜ç¼“å­˜äº‹åŠ¡ä¿¡æ¯ï¼Œè®¾ç½®æœ€å¤§ç¼“å­˜ä¸ªæ•°ä¸º 1000 ä¸ªï¼Œç¼“å­˜è¿‡æœŸæ—¶é—´ä¸ºæœ€åè®¿é—®æ—¶é—´ 120 ç§’ã€‚</li></ul><hr><p><strong><code>#create(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">create</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> result = doCreate(transaction);</div><div class="line">   <span class="keyword">if</span> (result &gt; <span class="number">0</span>) &#123;</div><div class="line">       putToCache(transaction);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ·»åŠ åˆ°ç¼“å­˜</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">putToCache</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   transactionXidCompensableTransactionCache.put(transaction.getXid(), transaction);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ–°å¢äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ–°å¢æ•°é‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">doCreate</span><span class="params">(Transaction transaction)</span></span>;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#doCreate(...)</code> æ–¹æ³•ï¼Œæ–°å¢äº‹åŠ¡ã€‚æ–°å¢æˆåŠŸåï¼Œè°ƒç”¨ <code>#putToCache(...)</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡åˆ°ç¼“å­˜ã€‚</li><li><code>#doCreate(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›æ–°å¢äº‹åŠ¡åŠŸèƒ½ã€‚</li></ul><hr><p><strong><code>#update(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> result = <span class="number">0</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       result = doUpdate(transaction);</div><div class="line">       <span class="keyword">if</span> (result &gt; <span class="number">0</span>) &#123;</div><div class="line">           putToCache(transaction);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> OptimisticLockException();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="keyword">if</span> (result &lt;= <span class="number">0</span>) &#123; <span class="comment">// æ›´æ–°å¤±è´¥ï¼Œç§»é™¤ç¼“å­˜ã€‚ä¸‹æ¬¡è®¿é—®ï¼Œä»å­˜å‚¨å™¨è¯»å–</span></div><div class="line">           removeFromCache(transaction);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç§»é™¤äº‹åŠ¡ä»ç¼“å­˜</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">removeFromCache</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   transactionXidCompensableTransactionCache.invalidate(transaction.getXid());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ›´æ–°äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ›´æ–°æ•°é‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">doUpdate</span><span class="params">(Transaction transaction)</span></span>;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#doUpdate(...)</code> æ–¹æ³•ï¼Œæ›´æ–°äº‹åŠ¡ã€‚<ul><li>è‹¥æ›´æ–°æˆåŠŸåï¼Œè°ƒç”¨ <code>#putToCache(...)</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡åˆ°ç¼“å­˜ã€‚</li><li>è‹¥æ›´æ–°å¤±è´¥åï¼ŒæŠ›å‡º OptimisticLockException å¼‚å¸¸ã€‚æœ‰ä¸¤ç§æƒ…å†µä¼šå¯¼è‡´æ›´æ–°å¤±è´¥ï¼š(1) è¯¥äº‹åŠ¡å·²ç»è¢«æäº¤ï¼Œè¢«åˆ é™¤ï¼›(2) ä¹è§‚é”æ›´æ–°æ—¶ï¼Œç¼“å­˜çš„äº‹åŠ¡çš„ç‰ˆæœ¬å·( <code>Transaction.version</code> )å’Œå­˜å‚¨å™¨é‡Œçš„äº‹åŠ¡çš„ç‰ˆæœ¬å·ä¸åŒï¼Œæ›´æ–°å¤±è´¥ã€‚<strong>ä¸ºä»€ä¹ˆ</strong>ï¼Ÿåœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-recovery/">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡æ¢å¤ã€‹</a>è¯¦ç»†è§£æã€‚æ›´æ–°å¤±è´¥ï¼Œæ„å‘³ç€ç¼“å­˜å·²ç»ä¸ä¸ä¸€è‡´ï¼Œè°ƒç”¨ <code>#removeFromCache(...)</code> æ–¹æ³•ï¼Œç§»é™¤äº‹åŠ¡ä»ç¼“å­˜ä¸­ã€‚</li></ul></li><li><code>#doUpdate(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›æ›´æ–°äº‹åŠ¡åŠŸèƒ½ã€‚</li></ul><hr><p><strong><code>#delete(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> result;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       result = doDelete(transaction);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       removeFromCache(transaction);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ é™¤äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> åˆ é™¤æ•°é‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">doDelete</span><span class="params">(Transaction transaction)</span></span>;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#doDelete(...)</code> æ–¹æ³•ï¼Œåˆ é™¤äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>#removeFromCache(...)</code> æ–¹æ³•ï¼Œç§»é™¤äº‹åŠ¡ä»ç¼“å­˜ä¸­ã€‚</li><li><code>#doDelete(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›åˆ é™¤äº‹åŠ¡åŠŸèƒ½ã€‚</li></ul><hr><p><strong><code>#findByXid(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Transaction <span class="title">findByXid</span><span class="params">(TransactionXid transactionXid)</span> </span>&#123;</div><div class="line">   Transaction transaction = findFromCache(transactionXid);</div><div class="line">   <span class="keyword">if</span> (transaction == <span class="keyword">null</span>) &#123;</div><div class="line">       transaction = doFindOne(transactionXid);</div><div class="line">       <span class="keyword">if</span> (transaction != <span class="keyword">null</span>) &#123;</div><div class="line">           putToCache(transaction);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> transaction;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å¾—äº‹åŠ¡ä»ç¼“å­˜ä¸­</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionXid äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Transaction <span class="title">findFromCache</span><span class="params">(TransactionXid transactionXid)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> transactionXidCompensableTransactionCache.getIfPresent(transactionXid);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æŸ¥è¯¢äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> xid äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Transaction <span class="title">doFindOne</span><span class="params">(Xid xid)</span></span>;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#findFromCache()</code> æ–¹æ³•ï¼Œä¼˜å…ˆä»ç¼“å­˜ä¸­è·å–äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>#doFindOne()</code> æ–¹æ³•ï¼Œç¼“å­˜ä¸­äº‹åŠ¡ä¸å­˜åœ¨ï¼Œä»å­˜å‚¨å™¨ä¸­è·å–ã€‚è·å–åˆ°åï¼Œè°ƒç”¨ <code>#putToCache()</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡åˆ°ç¼“å­˜ä¸­ã€‚</li><li><code>#doFindOne(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›æŸ¥è¯¢äº‹åŠ¡åŠŸèƒ½ã€‚</li></ul><hr><p><strong><code>#findAllUnmodifiedSince(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Transaction&gt; <span class="title">findAllUnmodifiedSince</span><span class="params">(Date date)</span> </span>&#123;</div><div class="line">   List&lt;Transaction&gt; transactions = doFindAllUnmodifiedSince(date);</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°ç¼“å­˜</span></div><div class="line">   <span class="keyword">for</span> (Transaction transaction : transactions) &#123;</div><div class="line">       putToCache(transaction);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> transactions;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å–è¶…è¿‡æŒ‡å®šæ—¶é—´çš„äº‹åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> date æŒ‡å®šæ—¶é—´</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> äº‹åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> List&lt;Transaction&gt; <span class="title">doFindAllUnmodifiedSince</span><span class="params">(Date date)</span></span>;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#findAllUnmodifiedSince(...)</code> æ–¹æ³•ï¼Œä»å­˜å‚¨å™¨è·å–è¶…è¿‡æŒ‡å®šæ—¶é—´çš„äº‹åŠ¡é›†åˆã€‚è°ƒç”¨ <code>#putToCache(...)</code> æ–¹æ³•ï¼Œå¾ªç¯äº‹åŠ¡é›†åˆæ·»åŠ åˆ°ç¼“å­˜ã€‚</li><li><code>#doFindAllUnmodifiedSince(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›è·å–è¶…è¿‡æŒ‡å®šæ—¶é—´çš„äº‹åŠ¡é›†åˆåŠŸèƒ½ã€‚</li></ul><h2 id="3-2-JDBC-äº‹åŠ¡å­˜å‚¨å™¨"><a href="#3-2-JDBC-äº‹åŠ¡å­˜å‚¨å™¨" class="headerlink" title="3.2 JDBC äº‹åŠ¡å­˜å‚¨å™¨"></a>3.2 JDBC äº‹åŠ¡å­˜å‚¨å™¨</h2><p><code>org.mengyun.tcctransaction.repository.JdbcTransactionRepository</code>ï¼ŒJDBC äº‹åŠ¡å­˜å‚¨å™¨ï¼Œé€šè¿‡ JDBC é©±åŠ¨ï¼Œå°† Transaction å­˜å‚¨åˆ° MySQL / Oracle / PostgreSQL / SQLServer ç­‰å…³ç³»æ•°æ®åº“ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcTransactionRepository</span> <span class="keyword">extends</span> <span class="title">CachableTransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é¢†åŸŸ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String domain;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¡¨åç¼€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String tbSuffix;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ•°æ®æº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> DataSource dataSource;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åºåˆ—åŒ–</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ObjectSerializer serializer = <span class="keyword">new</span> JdkSerializationSerializer();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>domain</code>ï¼Œé¢†åŸŸï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ç§°ä¸ºæ¨¡å—åï¼Œåº”ç”¨åï¼Œ<strong>ç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªèµ„æº</strong>ã€‚ä¾‹å¦‚ï¼ŒMaven æ¨¡å— <code>xxx-order</code>ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®è¯¥å±æ€§ä¸º <code>ORDER</code>ã€‚</li><li><code>tbSuffix</code>ï¼Œè¡¨åç¼€ã€‚é»˜è®¤å­˜å‚¨è¡¨åä¸º <code>TCC_TRANSACTION</code>ï¼Œé…ç½®è¡¨ååï¼Œä¸º <code>TCC_TRANSACTION${tbSuffix}</code>ã€‚</li><li><code>dataSource</code>ï¼Œå­˜å‚¨æ•°æ®çš„æ•°æ®æºã€‚</li><li><code>serializer</code>ï¼Œåºåˆ—åŒ–ã€‚<strong>å½“æ•°æ®åº“é‡Œå·²ç»æœ‰æ•°æ®çš„æƒ…å†µä¸‹ï¼Œä¸è¦æ›´æ¢åˆ«çš„åºåˆ—åŒ–ï¼Œå¦åˆ™ä¼šå¯¼è‡´ååºåˆ—åŒ–æŠ¥é”™ã€‚</strong>å»ºè®®ï¼šTCC-Transaction å­˜å‚¨æ—¶ï¼Œæ–°å¢å­—æ®µï¼Œè®°å½•åºåˆ—åŒ–çš„æ–¹å¼ã€‚</li></ul><p>è¡¨ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">CREATE TABLE `TCC_TRANSACTION` (</div><div class="line">  `TRANSACTION_ID` <span class="keyword">int</span>(<span class="number">11</span>) NOT NULL AUTO_INCREMENT,</div><div class="line">  `DOMAIN` varchar(<span class="number">100</span>) DEFAULT NULL,</div><div class="line">  `GLOBAL_TX_ID` varbinary(<span class="number">32</span>) NOT NULL,</div><div class="line">  `BRANCH_QUALIFIER` varbinary(<span class="number">32</span>) NOT NULL,</div><div class="line">  `CONTENT` varbinary(<span class="number">8000</span>) DEFAULT NULL,</div><div class="line">  `STATUS` <span class="keyword">int</span>(<span class="number">11</span>) DEFAULT NULL,</div><div class="line">  `TRANSACTION_TYPE` <span class="keyword">int</span>(<span class="number">11</span>) DEFAULT NULL,</div><div class="line">  `RETRIED_COUNT` <span class="keyword">int</span>(<span class="number">11</span>) DEFAULT NULL,</div><div class="line">  `CREATE_TIME` datetime DEFAULT NULL,</div><div class="line">  `LAST_UPDATE_TIME` datetime DEFAULT NULL,</div><div class="line">  `VERSION` <span class="keyword">int</span>(<span class="number">11</span>) DEFAULT NULL,</div><div class="line">  <span class="function">PRIMARY <span class="title">KEY</span> <span class="params">(`TRANSACTION_ID`)</span>,</span></div><div class="line"><span class="function">  UNIQUE KEY `UX_TX_BQ` <span class="params">(`GLOBAL_TX_ID`,`BRANCH_QUALIFIER`)</span></span></div><div class="line"><span class="function">) ENGINE</span>=InnoDB DEFAULT CHARSET=utf8</div></pre></td></tr></table></figure><ul><li><code>TRANSACTION_ID</code>ï¼Œä»…ä»…æ•°æ®åº“è‡ªå¢ï¼Œæ— å®é™…ç”¨é€”ã€‚</li><li><code>CONTENT</code>ï¼ŒTransaction åºåˆ—åŒ–ã€‚</li></ul><p>psï¼šç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/c164ff5ab29d31e08bc7061de5bc7403f3e40f1d/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/repository/JdbcTransactionRepository.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ JdbcTransactionRepository ä»£ç å®ç°ï¼Œå·²ç»æ·»åŠ å®Œæ•´ä¸­æ–‡æ³¨é‡Šã€‚</p><h2 id="3-3-Redis-äº‹åŠ¡å­˜å‚¨å™¨"><a href="#3-3-Redis-äº‹åŠ¡å­˜å‚¨å™¨" class="headerlink" title="3.3 Redis äº‹åŠ¡å­˜å‚¨å™¨"></a>3.3 Redis äº‹åŠ¡å­˜å‚¨å™¨</h2><p><code>org.mengyun.tcctransaction.repository.RedisTransactionRepository</code>ï¼ŒRedis äº‹åŠ¡å­˜å‚¨å™¨ï¼Œå°† Transaction å­˜å‚¨åˆ° Redisã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisTransactionRepository</span> <span class="keyword">extends</span> <span class="title">CachableTransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Jedis Pool</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> JedisPool jedisPool;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * key å‰ç¼€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String keyPrefix = <span class="string">"TCC:"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åºåˆ—åŒ–</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ObjectSerializer serializer = <span class="keyword">new</span> JdkSerializationSerializer();</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>keyPrefix</code>ï¼Œkey å‰ç¼€ã€‚ç±»ä¼¼ JdbcTransactionRepository çš„ <code>domain</code> å±æ€§ã€‚</li></ul><p>ä¸€ä¸ªäº‹åŠ¡å­˜å‚¨åˆ° Reidsï¼Œä½¿ç”¨ Redis çš„æ•°æ®ç»“æ„ä¸º <a href="https://redis.io/commands#hash" rel="external nofollow noopener noreferrer" target="_blank">HASHES</a>ã€‚</p><ul><li><p>key : ä½¿ç”¨ <code>keyPrefix</code> + <code>xid</code>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºäº‹åŠ¡çš„ Redis Key</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> keyPrefix key å‰ç¼€</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> xid äº‹åŠ¡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> Redis Key</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getRedisKey(String keyPrefix, Xid xid) &#123;</div><div class="line">   <span class="keyword">byte</span>[] prefix = keyPrefix.getBytes();</div><div class="line">   <span class="keyword">byte</span>[] globalTransactionId = xid.getGlobalTransactionId();</div><div class="line">   <span class="keyword">byte</span>[] branchQualifier = xid.getBranchQualifier();</div><div class="line">   <span class="comment">// æ‹¼æ¥ key</span></div><div class="line">   <span class="keyword">byte</span>[] key = <span class="keyword">new</span> <span class="keyword">byte</span>[prefix.length + globalTransactionId.length + branchQualifier.length];</div><div class="line">   System.arraycopy(prefix, <span class="number">0</span>, key, <span class="number">0</span>, prefix.length);</div><div class="line">   System.arraycopy(globalTransactionId, <span class="number">0</span>, key, prefix.length, globalTransactionId.length);</div><div class="line">   System.arraycopy(branchQualifier, <span class="number">0</span>, key, prefix.length + globalTransactionId.length, branchQualifier.length);</div><div class="line">   <span class="keyword">return</span> key;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>HASHES çš„ key ï¼šä½¿ç”¨ <code>version</code>ã€‚</p><ul><li>æ·»åŠ å’Œæ›´æ–° Transaction æ—¶ï¼Œä½¿ç”¨ Redis <a href="https://redis.io/commands/hsetnx" rel="external nofollow noopener noreferrer" target="_blank">HSETNX</a>ï¼Œä¸å­˜åœ¨å½“å‰ç‰ˆæœ¬çš„å€¼æ—¶ï¼Œè¿›è¡Œè®¾ç½®ï¼Œé‡è€Œå®ç°ç±»ä¼¼ä¹è§‚é”çš„æ›´æ–°ã€‚</li><li>è¯»å– Transaction æ—¶ï¼Œä½¿ç”¨ Redis <a href="https://redis.io/commands/hgetall" rel="external nofollow noopener noreferrer" target="_blank">HGETALL</a>ï¼Œå°† Transaction æ‰€æœ‰ <code>version</code> å¯¹åº”çš„å€¼è¯»å–åˆ°å†…å­˜åï¼Œå– <code>version</code> å€¼æœ€å¤§çš„å¯¹åº”çš„å€¼ã€‚</li></ul></li><li><p>HASHES çš„ value ï¼šè°ƒç”¨ <code>TransactionSerializer#serialize(...)</code> æ–¹æ³•ï¼Œåºåˆ—åŒ– Transactionã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] serialize(ObjectSerializer serializer, Transaction transaction) &#123;</div><div class="line">   Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</div><div class="line">   map.put(<span class="string">"GLOBAL_TX_ID"</span>, transaction.getXid().getGlobalTransactionId());</div><div class="line">   map.put(<span class="string">"BRANCH_QUALIFIER"</span>, transaction.getXid().getBranchQualifier());</div><div class="line">   map.put(<span class="string">"STATUS"</span>, transaction.getStatus().getId());</div><div class="line">   map.put(<span class="string">"TRANSACTION_TYPE"</span>, transaction.getTransactionType().getId());</div><div class="line">   map.put(<span class="string">"RETRIED_COUNT"</span>, transaction.getRetriedCount());</div><div class="line">   map.put(<span class="string">"CREATE_TIME"</span>, transaction.getCreateTime());</div><div class="line">   map.put(<span class="string">"LAST_UPDATE_TIME"</span>, transaction.getLastUpdateTime());</div><div class="line">   map.put(<span class="string">"VERSION"</span>, transaction.getVersion());</div><div class="line">   <span class="comment">// åºåˆ—åŒ–</span></div><div class="line">   map.put(<span class="string">"CONTENT"</span>, serializer.serialize(transaction));</div><div class="line">   <span class="keyword">return</span> serializer.serialize(map);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>TODO ä¸ºä»€ä¹ˆåºåˆ—åŒ–ä¸¤æ¬¡</li></ul></li></ul><p>åœ¨å®ç° <code>#doFindAllUnmodifiedSince(date)</code> æ–¹æ³•ï¼Œæ— æ³•åƒæ•°æ®åº“ä½¿ç”¨æ—¶é—´æ¡ä»¶è¿›è¡Œè¿‡æ»¤ï¼Œå› æ­¤ï¼ŒåŠ è½½æ‰€æœ‰äº‹åŠ¡ååœ¨å†…å­˜ä¸­è¿‡æ»¤ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> List&lt;Transaction&gt; <span class="title">doFindAllUnmodifiedSince</span><span class="params">(Date date)</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å¾—æ‰€æœ‰äº‹åŠ¡</span></div><div class="line">   List&lt;Transaction&gt; allTransactions = doFindAll();</div><div class="line">   <span class="comment">// è¿‡æ»¤æ—¶é—´</span></div><div class="line">   List&lt;Transaction&gt; allUnmodifiedSince = <span class="keyword">new</span> ArrayList&lt;Transaction&gt;();</div><div class="line">   <span class="keyword">for</span> (Transaction transaction : allTransactions) &#123;</div><div class="line">       <span class="keyword">if</span> (transaction.getLastUpdateTime().compareTo(date) &lt; <span class="number">0</span>) &#123;</div><div class="line">           allUnmodifiedSince.add(transaction);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> allUnmodifiedSince;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>psï¼šç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/c164ff5ab29d31e08bc7061de5bc7403f3e40f1d/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/repository/RedisTransactionRepository.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ RedisTransactionRepository ä»£ç å®ç°ï¼Œå·²ç»æ·»åŠ å®Œæ•´ä¸­æ–‡æ³¨é‡Šã€‚</p><blockquote><p>FROM <a href="https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x#%E9%85%8D%E7%BD%AEtcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠTCC-Transaction å®˜æ–¹æ–‡æ¡£ â€”â€” ä½¿ç”¨æŒ‡å—1.2.xã€‹</a><br>ä½¿ç”¨ RedisTransactionRepository éœ€è¦é…ç½® Redis æœåŠ¡å™¨å¦‚ä¸‹ï¼š<br>appendonly yes<br>appendfsync always</p></blockquote><h2 id="3-4-Zookeeper-äº‹åŠ¡å­˜å‚¨å™¨"><a href="#3-4-Zookeeper-äº‹åŠ¡å­˜å‚¨å™¨" class="headerlink" title="3.4 Zookeeper äº‹åŠ¡å­˜å‚¨å™¨"></a>3.4 Zookeeper äº‹åŠ¡å­˜å‚¨å™¨</h2><p><code>org.mengyun.tcctransaction.repository.ZooKeeperTransactionRepository</code>ï¼ŒZookeeper äº‹åŠ¡å­˜å‚¨å™¨ï¼Œå°† Transaction å­˜å‚¨åˆ° Zookeeperã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZooKeeperTransactionRepository</span> <span class="keyword">extends</span> <span class="title">CachableTransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Zookeeper æœåŠ¡å™¨åœ°å€æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String zkServers;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Zookeeper è¶…æ—¶æ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> zkTimeout;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * TCC å­˜å‚¨ Zookeeper æ ¹ç›®å½•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String zkRootPath = <span class="string">"/tcc"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Zookeeper è¿æ¥</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ZooKeeper zk;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åºåˆ—åŒ–</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ObjectSerializer serializer = <span class="keyword">new</span> JdkSerializationSerializer();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>zkRootPath</code>ï¼Œå­˜å‚¨ Zookeeper æ ¹ç›®å½•ï¼Œç±»ä¼¼ JdbcTransactionRepository çš„ <code>domain</code> å±æ€§ã€‚</li></ul><p>ä¸€ä¸ªäº‹åŠ¡å­˜å‚¨åˆ° Zookeeperï¼Œä½¿ç”¨ Zookeeper çš„<strong>æŒä¹…æ•°æ®èŠ‚ç‚¹</strong>ã€‚</p><ul><li><p>pathï¼š<code>${zkRootPath}</code> + <code>/</code> + <code>${xid}</code>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ZooKeeperTransactionRepository.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getTxidPath</span><span class="params">(Xid xid)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> String.format(<span class="string">"%s/%s"</span>, zkRootPath, xid);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// TransactionXid.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">   StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</div><div class="line">   stringBuilder.append(<span class="string">"globalTransactionId:"</span>).append(UUID.nameUUIDFromBytes(globalTransactionId).toString());</div><div class="line">   stringBuilder.append(<span class="string">","</span>).append(<span class="string">"branchQualifier:"</span>).append(UUID.nameUUIDFromBytes(branchQualifier).toString());</div><div class="line">   <span class="keyword">return</span> stringBuilder.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>dataï¼šè°ƒç”¨ <code>TransactionSerializer#serialize(...)</code> æ–¹æ³•ï¼Œåºåˆ—åŒ– Transactionã€‚</p></li><li>versionï¼šä½¿ç”¨ Zookeeper æ•°æ®èŠ‚ç‚¹è‡ªå¸¦ç‰ˆæœ¬åŠŸèƒ½ã€‚è¿™é‡Œè¦æ³¨æ„ä¸‹ï¼ŒTransaction çš„ç‰ˆæœ¬ä» 1 å¼€å§‹ï¼Œè€Œ Zookeeper æ•°æ®èŠ‚ç‚¹ç‰ˆæœ¬ä» 0 å¼€å§‹ã€‚</li></ul><p>psï¼šç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/c164ff5ab29d31e08bc7061de5bc7403f3e40f1d/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/repository/ZooKeeperTransactionRepository.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ ZooKeeperTransactionRepository ä»£ç å®ç°ï¼Œå·²ç»æ·»åŠ å®Œæ•´ä¸­æ–‡æ³¨é‡Šã€‚</p><p>å¦å¤–ï¼Œåœ¨ç”Ÿäº§ä¸Šæš‚æ—¶ä¸å»ºè®®ä½¿ç”¨ ZooKeeperTransactionRepositoryï¼ŒåŸå› æœ‰ä¸¤ç‚¹ï¼š</p><ul><li>ä¸æ”¯æŒ Zookeeper å®‰å…¨è®¤è¯ã€‚</li><li>ä½¿ç”¨ Zookeeper æ—¶ï¼Œæœªè€ƒè™‘æ–­ç½‘é‡è¿ç­‰æƒ…å†µã€‚</li></ul><p>å¦‚æœä½ è¦ä½¿ç”¨ Zookeeper è¿›è¡Œäº‹åŠ¡çš„å­˜å‚¨ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ <a href="https://curator.apache.org/" rel="external nofollow noopener noreferrer" target="_blank">Apache Curator</a> æ“ä½œ Zookeeperï¼Œé‡å†™ ZooKeeperTransactionRepository éƒ¨åˆ†ä»£ç ã€‚</p><h2 id="3-5-File-äº‹åŠ¡å­˜å‚¨å™¨"><a href="#3-5-File-äº‹åŠ¡å­˜å‚¨å™¨" class="headerlink" title="3.5 File äº‹åŠ¡å­˜å‚¨å™¨"></a>3.5 File äº‹åŠ¡å­˜å‚¨å™¨</h2><p><code>org.mengyun.tcctransaction.repository.FileSystemTransactionRepository</code>ï¼ŒFile äº‹åŠ¡å­˜å‚¨å™¨ï¼Œå°† Transaction å­˜å‚¨åˆ°æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>å®ç°ä¸Šå’Œ ZooKeeperTransactionRepositoryï¼ŒåŒºåˆ«ä¸»è¦åœ¨äºä¸æ”¯æŒä¹è§‚é”æ›´æ–°ã€‚æœ‰å…´è¶£çš„åŒå­¦ç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/c164ff5ab29d31e08bc7061de5bc7403f3e40f1d/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/repository/FileSystemTransactionRepository.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ï¼Œè¿™é‡Œå°±ä¸æ‹“å±•å¼€æ¥ã€‚</p><p>å¦å¤–ï¼Œåœ¨ç”Ÿäº§ä¸Šä¸å»ºè®®ä½¿ç”¨ FileSystemTransactionRepositoryï¼Œå› ä¸ºä¸æ”¯æŒå¤šèŠ‚ç‚¹å…±äº«ã€‚ç”¨åˆ†å¸ƒå¼å­˜å‚¨æŒ‚è½½æ–‡ä»¶å¦è¯´ï¼Œå½“ç„¶è¿˜æ˜¯ä¸å»ºè®®ï¼Œå› ä¸ºä¸æ”¯æŒä¹è§‚é”å¹¶å‘æ›´æ–°ã€‚</p><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>è¿™ç¯‡ç•¥( è¶… )å¾®( çº§ )æ°´æ›´ï¼Œå“ˆå“ˆå“ˆï¼Œä¸º<a href="http://www.iocoder.cn/TCC-Transaction/transaction-recover/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡æ¢å¤ã€‹</a>åšé“ºå«å•¦ã€‚</p><p>ä½¿ç”¨ RedisTransactionRepository å’Œ ZooKeeperTransactionRepository å­˜å‚¨äº‹åŠ¡è¿˜æ˜¯ Get è›®å¤šç‚¹çš„ã€‚</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_15/02.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/TCC-Transaction/">TCC-Transaction</a></div><div class="article-share" id="share"><div data-url="http://www.iocoder.cn/TCC-Transaction/transaction-repository/" data-title="TCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡å­˜å‚¨å™¨ | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/TCC-Transaction/transaction-recovery/" title="TCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡æ¢å¤"><strong>PREVIOUS:</strong><br><span>TCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡æ¢å¤</span></a></div><div class="next"><a href="/TCC-Transaction/tcc-core/" title="TCC-Transaction æºç åˆ†æ â€”â€” TCC å®ç°"><strong>NEXT:</strong><br><span>TCC-Transaction æºç åˆ†æ â€”â€” TCC å®ç°</span></a></div></nav></div></div><footer><div id="footer"><img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display:none"><p class="copyright">Â© 2017 <a href="http://www.iocoder.cn" target="_blank" title="ç‹æ–‡æ–Œ">ç‹æ–‡æ–Œ</a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a> && Powered by <a href="http://hexo.io" target="_blank" title="hexo" rel="external nofollow noopener noreferrer">hexo</a> && Theme by <a href="http://gengbiao.me" target="_blank" title="coney" rel="external nofollow noopener noreferrer">coney</a></p></div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2");ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script src="/js/util.js"></script></body>