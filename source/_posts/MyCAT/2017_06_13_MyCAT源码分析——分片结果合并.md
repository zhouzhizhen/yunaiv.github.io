title: MyCAT æºç è§£æ â€”â€” åˆ†ç‰‡ç»“æœåˆå¹¶
date: 2017-06-13
tags:
categories: MyCAT
permalink: MyCAT/sharding-result-merge

---

# 1. æ¦‚è¿°

ç›¸ä¿¡å¾ˆå¤šåŒå­¦éƒ½çœ‹è¿‡ MySQL å„ç§ä¼˜åŒ–çš„æ–‡ç« ï¼Œé‡Œé¢ 99% éƒ½ä¼šæåˆ°ï¼šå•è¡¨æ•°æ®é‡å¤§äº†ï¼Œéœ€è¦è¿›è¡Œåˆ†ç‰‡ã€‚æ‹†åˆ†ä¹‹åï¼Œä¸šåŠ¡ä¸Šå¿…ç„¶é¢ä¸´çš„åœºæ™¯ï¼šè·¨åˆ†ç‰‡çš„æ•°æ®åˆå¹¶ã€‚ä»Šå¤©æˆ‘ä»¬å°±ä¸€èµ·æ¥ç…ç… MyCAT æ˜¯å¦‚ä½•å®ç°**åˆ†ç‰‡ç»“æœåˆå¹¶**ã€‚

è·¨åˆ†ç‰‡æŸ¥è¯¢å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š

![flow](http://www.yunai.me/images/MyCAT/2017_06_13/flow.png)

å’Œ [ã€Šã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹](http://www.yunai.me/Mycat/single-db-single-table-select/) ä¸åŒçš„ä¸¤ä¸ªè¿‡ç¨‹ï¼š

* ã€2ã€‘å¤šåˆ†ç‰‡æ‰§è¡Œ SQL
* ã€4ã€‘åˆå¹¶å¤šåˆ†ç‰‡ç»“æœ

ä¸‹é¢ï¼Œæˆ‘ä»¬é€æ¡æ¥è®²è§£è¿™ä¸¤ä¸ªè¿‡ç¨‹ã€‚

# 2. å¤šåˆ†ç‰‡æ‰§è¡Œ SQL

![execute_sql](http://www.yunai.me/images/MyCAT/2017_06_13/execute_sql.png)

ç»è¿‡ SQL è§£æåï¼Œè®¡ç®—å‡ºéœ€è¦æ‰§è¡Œ SQL çš„**åˆ†ç‰‡èŠ‚ç‚¹**ï¼Œéå†**åˆ†ç‰‡èŠ‚ç‚¹**å‘é€ SQL è¿›è¡Œæ‰§è¡Œã€‚æ ¸å¿ƒä»£ç ï¼šã€[MultiNodeQueryHandler.java#execute(...)](https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/nio/handler/MultiNodeQueryHandler.java)ã€‘ã€‚

_**SQL è§£æ** è¯¦ç»†è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ï¼Œé¿å…å†…å®¹è¿‡å¤šï¼Œå½±å“å¤§å®¶å¯¹ **åˆ†ç‰‡ç»“æœåˆå¹¶** æµç¨‹å’Œé€»è¾‘çš„ç†è§£ã€‚_

# 3. åˆå¹¶å¤šåˆ†ç‰‡ç»“æœ

![handle_response](http://www.yunai.me/images/MyCAT/2017_06_13/handle_response.png)

å’Œ [ã€Šã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹](http://www.yunai.me/Mycat/single-db-single-table-select/) ä¸åŒï¼Œå¤šä¸ª**åˆ†ç‰‡èŠ‚ç‚¹**éƒ½ä¼š**åˆ†åˆ«**å“åº” _è®°å½•å¤´(header)_ å’Œ _è®°å½•è¡Œ(row)_ ã€‚åœ¨å¼€å§‹åˆ†æ MyCAT æ˜¯æ€ä¹ˆåˆå¹¶å¤šåˆ†ç‰‡ç»“æœä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥å›æƒ³ä¸‹ SQL çš„æ‰§è¡Œé¡ºåºã€‚

```SQL
FROM       // [1] é€‰æ‹©è¡¨
WHERE      // [2] è¿‡æ»¤è¡¨
GROUP BY   // [3] åˆ†ç»„
SELECT     // [4] æ™®é€šå­—æ®µï¼Œmax / min / avg / sum / count ç­‰å‡½æ•°ï¼Œdistinct
HAVING     // [5] å†è¿‡æ»¤è¡¨
ORDER BY   // [6] æ’åº
LIMIT      // [7] åˆ†é¡µ
```

## 3.1 è®°å½•å¤´(header)

å¤šä¸ª**åˆ†ç‰‡èŠ‚ç‚¹**å“åº”æ—¶ï¼Œä¼šå“åº”å¤šæ¬¡ _è®°å½•å¤´(header)_ ã€‚MyCAT å®é™…åœ¨å¤„ç†æ—¶ï¼Œåªå¤„ç†ç¬¬ä¸€ä¸ªè¿”å›çš„ _è®°å½•å¤´(header)_ ã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨æ—¶è¦ä¿è¯è¡¨çš„ Schema ç›¸åŒã€‚

**åˆ†ç‰‡èŠ‚ç‚¹**å“åº”çš„ _è®°å½•å¤´(header)_ å¯ä»¥ç›´æ¥è¿”å› MySQL Client å—ï¼Ÿç­”æ¡ˆæ˜¯ä¸å¯ä»¥ã€‚`AVG`å‡½æ•° æ˜¯ç‰¹æ®Šæƒ…å†µï¼ŒMyCAT éœ€è¦å°† `AVG` æ‹†æˆ `SUM` + `COUNT` è¿›è¡Œè®¡ç®—ã€‚ä¸¾ä¸ªä¾‹å­ï¼š

```SQL
// [1] MySQL Client => MyCAT ï¼š
SELECT AVG(age) FROM student;

// [2] MyCAT => MySQL Server ï¼š
SELECT SUM(age) AS AVG0SUM, COUNT(age) AS AVG0COUNT FROM student;

// [3] æœ€ç»ˆï¼šAVG(age) = SUM(age) AS AVG0SUM / COUNT(age)
```

æ ¸å¿ƒä»£ç ï¼šã€[MultiNodeQueryHandler.java#fieldEofResponse(...)](https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/nio/handler/MultiNodeQueryHandler.java)ã€‘

## 3.2 è®°å½•è¡Œ(row)

### 3.1 AbstractDataNodeMerge

MyCAT å¯¹åˆ†ç‰‡ç»“æœåˆå¹¶é€šè¿‡ `AbstractDataNodeMerge` å­ç±»æ¥å®Œæˆã€‚

![merge_service](http://www.yunai.me/images/MyCAT/2017_06_13/merge_service.png) 

`AbstractDataNodeMerge` ï¼š

* -packs ï¼šå¾…åˆå¹¶è®°å½•è¡Œ(row)é˜Ÿåˆ—ã€‚é˜Ÿåˆ—å°¾éƒ¨æ’å…¥ `END_FLAG_PACK` è¡¨ç¤ºé˜Ÿåˆ—å·²ç»“æŸã€‚
* -running ï¼šåˆå¹¶é€»è¾‘æ˜¯å¦æ­£åœ¨æ‰§è¡Œä¸­çš„æ ‡è®°ã€‚
* ~onRowMetaData(...) ï¼šæ ¹æ®**è®°å½•åˆ—ä¿¡æ¯(ColMeta)**æ„å»ºå¯¹åº”çš„æ’åºç»„ä»¶å’Œèšåˆç»„ä»¶ã€‚éœ€è¦å­ç±»è¿›è¡Œå®ç°ã€‚
* ~onNewRecord(...) ï¼šæ’å…¥è®°å½•è¡Œ(row) åˆ° `packs`ã€‚
* ~outputMergeResult(...) ï¼šæ’å…¥ `END_FLAG_PACK` åˆ° `packs`ã€‚
* ~run(...) ï¼šæ‰§è¡Œ**åˆå¹¶**åˆ†ç‰‡ç»“æœé€»è¾‘ï¼Œå¹¶å°†åˆå¹¶ç»“æœè¿”å›ç»™ MySQL Clientã€‚éœ€è¦å­ç±»è¿›è¡Œå®ç°ã€‚

TODO ç®€å•é€»è¾‘å›¾

è¯¦ç»†ä»£ç è§ï¼šTODO

### 3.2 DataNodeMergeManager

`AbstractDataNodeMerge` æœ‰ä¸¤ç§å­ç±»å®ç°ï¼š

* `DataMergeService` ï¼šåŸºäº**å †å†…å†…å­˜**åˆå¹¶åˆ†ç‰‡ç»“æœã€‚
* `DataNodeMergeManager` ï¼šåŸºäº**å †å¤–å†…å­˜**åˆå¹¶åˆ†ç‰‡ç»“æœã€‚

ç›®å‰å®˜æ–¹é»˜è®¤é…ç½®ä½¿ç”¨ `DataNodeMergeManager`ã€‚ä¸»è¦æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š

1. å¯ä»¥ä½¿ç”¨æ›´å¤§çš„å†…å­˜ç©ºé—´ã€‚å½“å¹¶å‘é‡å¤§æˆ–è€…æ•°æ®é‡å¤§æ—¶ï¼Œæ›´å¤§çš„å†…å­˜ç©ºé—´æ„å‘³ç€æ›´å¥½çš„æ€§èƒ½ã€‚
2. å‡å°‘ GC æš‚åœæ—¶é—´ã€‚è®°å½•è¡Œ(row)å¯¹è±¡å°ä¸”é‡ç”¨æ€§å¾ˆä½ï¼Œéœ€è¦èƒ½å¤Ÿè¿›è¡Œç±»ä¼¼ C / C++ çš„è‡ªä¸»å†…å­˜é‡Šæ”¾ã€‚
3. æ›´å¿«çš„å†…å­˜å¤åˆ¶å’Œè¯»å–é€Ÿåº¦ï¼Œå¯¹æ’åºå’Œèšåˆå¸¦æ¥å¾ˆå¥½çš„æé€Ÿã€‚

å¦‚æœå¯¹**å †å¤–å†…å­˜**ä¸å¤ªäº†è§£ï¼Œæ¨èé˜…è¯»å¦‚ä¸‹æ–‡ç« ï¼š

1. [ã€Šä»0åˆ°1èµ·æ­¥-è·Ÿæˆ‘è¿›å…¥å †å¤–å†…å­˜çš„å¥‡å¦™ä¸–ç•Œã€‹](http://www.jianshu.com/p/50be08b54bee)
2. [ã€Šå †å†…å†…å­˜è¿˜æ˜¯å †å¤–å†…å­˜ï¼Ÿã€‹](http://www.infoq.com/cn/news/2014/12/external-memory-heap-memory)
3. [ã€ŠJAVAå †å¤–å†…å­˜ã€‹](http://www.cnblogs.com/moonandstar08/p/5107648.html)
4. [ã€ŠJVMæºç åˆ†æä¹‹å †å¤–å†…å­˜å®Œå…¨è§£è¯»ã€‹](https://yq.aliyun.com/articles/2948?spm=5176.100239.blogcont62539.11.a3HdFE)

æœ¬æ–‡ä¸»è¦åˆ†æ `DataNodeMergeManager` å®ç°ï¼Œ`DataMergeService` å¯ä»¥è‡ªå·±é˜…è¯»æˆ–è€…ç­‰å¾…åç»­æ–‡ç« ï¼ˆğŸ˜ˆ**æ¬¢è¿è®¢é˜…æˆ‘çš„å…¬ä¼—å·å™¢**ï¼‰ã€‚

`DataNodeMergeManager` æœ‰ä¸‰ä¸ªç»„ä»¶ï¼š

* `globalSorter` ï¼š`UnsafeExternalRowSorter` => å®ç°è®°å½•è¡Œ(row)**åˆå¹¶å¹¶æ’åº**é€»è¾‘ã€‚
* `globalMergeResult` ï¼š`UnsafeExternalRowSorter` => å®ç°è®°å½•è¡Œ(row)**åˆå¹¶ä¸æ’åº**é€»è¾‘ã€‚
* `unsafeRowGrouper` ï¼š `UnsafeRowGrouper` => å®ç°è®°å½•è¡Œ(row)**èšåˆ**é€»è¾‘ã€‚

`DataNodeMergeManager#run(...)` é€»è¾‘å¦‚ä¸‹ï¼š

1. å†™å…¥è®°å½•è¡Œ(row)åˆ° `UnsafeRow`ã€‚
2. æ ¹æ®æƒ…å†µæ’å…¥åˆ° `globalSorter`ã€

TODO å†è€ƒè™‘ä¸‹æ€ä¹ˆè¡¨è¿°

### 3.3 UnsafeRow

### 3.4 UnsafeExternalRowSorter

### 3.5 UnsafeRowGrouper


