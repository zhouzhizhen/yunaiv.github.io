<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>MyCAT æºç è§£æ â€”â€” åˆ†ç‰‡ç»“æœåˆå¹¶ï¼ˆä¸€ï¼‰ | èŠ‹è‰¿Vçš„åšå®¢</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="ç‹æ–‡æ–Œ"><meta name="description" content="ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š

RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨
RocketMQ / MyCAT / Sharding-JDBC ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€
æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚ç”šè‡³ä¸çŸ¥é“"><meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹è‰¿Vçš„åšå®¢" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?ef4ed89f6dc83d01803a2440ae21e666";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹è‰¿Vçš„åšå®¢">èŠ‹è‰¿Vçš„åšå®¢</a></h1><a class="blog-motto">æ„¿ç¼–ç åŠç”Ÿï¼Œå¦‚è€å‹ç›¸ä¼´ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li></ul></ul></nav></div></header><div id="container"><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">2.</span> <span class="toc-text">2. å¤šåˆ†ç‰‡æ‰§è¡Œ SQL</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">3.</span> <span class="toc-text">3. åˆå¹¶å¤šåˆ†ç‰‡ç»“æœ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 è®°å½•å¤´(header)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 è®°å½•è¡Œ(row)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.2.1.</span> <span class="toc-text">3.1 AbstractDataNodeMerge</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.2.2.</span> <span class="toc-text">3.2 DataNodeMergeManager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.2.3.</span> <span class="toc-text">3.3 UnsafeRow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.2.4.</span> <span class="toc-text">3.4 UnsafeExternalRowSorter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.2.5.</span> <span class="toc-text">3.5 UnsafeRowGrouper</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">4.</span> <span class="toc-text">4. æ•‘æŠ¤ä¸­å¿ƒ</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/Elastic-Job/" title="Elastic-Job">Elastic-Job<sup>8</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/æŠ€æœ¯æ‚æ–‡/" title="æŠ€æœ¯æ‚æ–‡">æŠ€æœ¯æ‚æ–‡<sup>2</sup></a></li></ul></div></aside></div><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/MyCAT/sharding-result-merge-first/" title="MyCAT æºç è§£æ â€”â€” åˆ†ç‰‡ç»“æœåˆå¹¶ï¼ˆä¸€ï¼‰" itemprop="url">MyCAT æºç è§£æ â€”â€” åˆ†ç‰‡ç»“æœåˆå¹¶ï¼ˆä¸€ï¼‰</a></h1><p class="article-author"></p><p class="article-time">æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>ç›¸ä¿¡å¾ˆå¤šåŒå­¦çœ‹è¿‡ MySQL å„ç§ä¼˜åŒ–çš„æ–‡ç« ï¼Œé‡Œé¢ 99% ä¼šæåˆ°ï¼šå•è¡¨æ•°æ®é‡å¤§äº†ï¼Œéœ€è¦è¿›è¡Œåˆ†ç‰‡ï¼ˆæ°´å¹³æ‹†åˆ† or å‚ç›´æ‹†åˆ†ï¼‰ã€‚åˆ†ç‰‡ä¹‹åï¼Œä¸šåŠ¡ä¸Šå¿…ç„¶é¢ä¸´çš„åœºæ™¯ï¼šè·¨åˆ†ç‰‡çš„æ•°æ®åˆå¹¶ã€‚ä»Šå¤©æˆ‘ä»¬å°±ä¸€èµ·æ¥ç…ç… MyCAT æ˜¯å¦‚ä½•å®ç°<strong>åˆ†ç‰‡ç»“æœåˆå¹¶</strong>ã€‚</p><p>è·¨åˆ†ç‰‡æŸ¥è¯¢å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/flow.png" alt="flow"></p><p>å’Œ <a href="http://www.yunai.me/Mycat/single-db-single-table-select/">ã€Šã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹</a> ä¸åŒçš„ä¸¤ä¸ªè¿‡ç¨‹ï¼š</p><ul><li>ã€2ã€‘å¤šåˆ†ç‰‡æ‰§è¡Œ SQL</li><li>ã€4ã€‘åˆå¹¶å¤šåˆ†ç‰‡ç»“æœ</li></ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥é€æ¡è®²è§£è¿™ä¸¤ä¸ªè¿‡ç¨‹ã€‚</p><h1>2. å¤šåˆ†ç‰‡æ‰§è¡Œ SQL</h1><p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/execute_sql.png" alt="execute_sql"></p><p>ç»è¿‡ SQL è§£æåï¼Œè®¡ç®—å‡ºéœ€è¦æ‰§è¡Œ SQL çš„<strong>åˆ†ç‰‡èŠ‚ç‚¹</strong>ï¼Œéå†<strong>åˆ†ç‰‡èŠ‚ç‚¹</strong>å‘é€ SQL è¿›è¡Œæ‰§è¡Œã€‚</p><p><strong>æ ¸å¿ƒä»£ç </strong>ï¼š</p><ul><li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/nio/handler/MultiNodeQueryHandler.java" rel="external nofollow noopener noreferrer" target="_blank">MultiNodeQueryHandler.java#execute(...)</a></li></ul><p><em><strong>SQL è§£æ</strong> è¯¦ç»†è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ï¼Œé¿å…å†…å®¹è¿‡å¤šï¼Œå½±å“å¤§å®¶å¯¹ <strong>åˆ†ç‰‡ç»“æœåˆå¹¶</strong> æµç¨‹å’Œé€»è¾‘çš„ç†è§£ã€‚</em></p><h1>3. åˆå¹¶å¤šåˆ†ç‰‡ç»“æœ</h1><p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/handle_response.png" alt="handle_response"></p><p>å’Œ <a href="http://www.yunai.me/Mycat/single-db-single-table-select/">ã€Šã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹</a> ä¸åŒï¼Œå¤šä¸ª<strong>åˆ†ç‰‡èŠ‚ç‚¹</strong>éƒ½ä¼š<strong>åˆ†åˆ«</strong>å“åº” <em>è®°å½•å¤´(header)</em> å’Œ <em>è®°å½•è¡Œ(row)</em> ã€‚åœ¨å¼€å§‹åˆ†æ MyCAT æ˜¯æ€ä¹ˆåˆå¹¶å¤šåˆ†ç‰‡ç»“æœä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥å›æƒ³ä¸‹ SQL çš„æ‰§è¡Œé¡ºåºã€‚</p><p></p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">FROM       // [1] é€‰æ‹©è¡¨</div><div class="line">WHERE      // [2] è¿‡æ»¤è¡¨</div><div class="line">GROUP BY   // [3] åˆ†ç»„</div><div class="line"><span class="keyword">SELECT</span>     // [<span class="number">4</span>] æ™®é€šå­—æ®µï¼Œ<span class="keyword">max</span> / <span class="keyword">min</span> / <span class="keyword">avg</span> / <span class="keyword">sum</span> / <span class="keyword">count</span> ç­‰å‡½æ•°ï¼Œ<span class="keyword">distinct</span></div><div class="line"><span class="keyword">HAVING</span>     // [<span class="number">5</span>] å†è¿‡æ»¤è¡¨</div><div class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span>   // [<span class="number">6</span>] æ’åº</div><div class="line"><span class="keyword">LIMIT</span>      // [<span class="number">7</span>] åˆ†é¡µ</div></pre></td></tr></table></figure><p></p><h2>3.1 è®°å½•å¤´(header)</h2><p>å¤šä¸ª<strong>åˆ†ç‰‡èŠ‚ç‚¹</strong>å“åº”æ—¶ï¼Œä¼šå“åº”å¤šæ¬¡ <em>è®°å½•å¤´(header)</em> ã€‚MyCAT åœ¨å®é™…å¤„ç†æ—¶ï¼Œåªå¤„ç†ç¬¬ä¸€ä¸ªè¿”å›çš„ <em>è®°å½•å¤´(header)</em> ã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨æ—¶è¦ä¿è¯è¡¨çš„ Schema ç›¸åŒã€‚</p><p><strong>åˆ†ç‰‡èŠ‚ç‚¹</strong>å“åº”çš„ <em>è®°å½•å¤´(header)</em> å¯ä»¥ç›´æ¥è¿”å› MySQL Client å—ï¼Ÿç­”æ¡ˆæ˜¯ä¸å¯ä»¥ã€‚<code>AVG</code>å‡½æ•° æ˜¯ç‰¹æ®Šæƒ…å†µï¼ŒMyCAT éœ€è¦å°† <code>AVG</code> æ‹†æˆ <code>SUM</code> + <code>COUNT</code> è¿›è¡Œè®¡ç®—ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><p></p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">// [1] MySQL Client =&gt; MyCAT ï¼š</div><div class="line">SELECT AVG(age) FROM student;</div><div class="line"></div><div class="line">// [2] MyCAT =&gt; MySQL Server ï¼š</div><div class="line">SELECT SUM(age) AS AVG0SUM, COUNT(age) AS AVG0COUNT FROM student;</div><div class="line"></div><div class="line">// [3] æœ€ç»ˆï¼šAVG(age) = SUM(age) AS AVG0SUM / COUNT(age)</div></pre></td></tr></table></figure><p></p><p><strong>æ ¸å¿ƒä»£ç </strong>ï¼š</p><ul><li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/nio/handler/MultiNodeQueryHandler.java" rel="external nofollow noopener noreferrer" target="_blank">MultiNodeQueryHandler.java#fieldEofResponse(...)</a>ã€‚</li></ul><h2>3.2 è®°å½•è¡Œ(row)</h2><h3>3.1 AbstractDataNodeMerge</h3><p>MyCAT å¯¹åˆ†ç‰‡ç»“æœåˆå¹¶é€šè¿‡ <code>AbstractDataNodeMerge</code> å­ç±»æ¥å®Œæˆã€‚</p><p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/merge_service.png" alt="merge_service"></p><p><code>AbstractDataNodeMerge</code> ï¼š</p><ul><li>-packs ï¼šå¾…åˆå¹¶è®°å½•è¡Œ(row)é˜Ÿåˆ—ã€‚é˜Ÿåˆ—å°¾éƒ¨æ’å…¥ <code>END_FLAG_PACK</code> è¡¨ç¤ºé˜Ÿåˆ—å·²ç»“æŸã€‚</li><li>-running ï¼šåˆå¹¶é€»è¾‘æ˜¯å¦æ­£åœ¨æ‰§è¡Œä¸­çš„æ ‡è®°ã€‚</li><li>~onRowMetaData(...) ï¼šæ ¹æ®**è®°å½•åˆ—ä¿¡æ¯(ColMeta)**æ„å»ºå¯¹åº”çš„æ’åºç»„ä»¶å’Œèšåˆç»„ä»¶ã€‚éœ€è¦å­ç±»è¿›è¡Œå®ç°ã€‚</li><li>~onNewRecord(...) ï¼šæ’å…¥è®°å½•è¡Œ(row) åˆ° <code>packs</code>ã€‚</li><li>~outputMergeResult(...) ï¼šæ’å…¥ <code>END_FLAG_PACK</code> åˆ° <code>packs</code>ã€‚</li><li>~run(...) ï¼šæ‰§è¡Œ<strong>åˆå¹¶</strong>åˆ†ç‰‡ç»“æœé€»è¾‘ï¼Œå¹¶å°†åˆå¹¶ç»“æœè¿”å›ç»™ MySQL Clientã€‚éœ€è¦å­ç±»è¿›è¡Œå®ç°ã€‚</li></ul><p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/AbstractDataNodeMerge_run.png" alt="AbstractDataNodeMerge_run.png"></p><p><em><em>é€šè¿‡ <code>running</code> æ ‡è®°ä¿è¯åŒä¸€æ¡ SQL åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œï¼Œå¹¶ä¸”ä¸éœ€è¦ç­‰åˆ°æ¯ä¸ªåˆ†ç‰‡ç»“æœéƒ½è¿”å›å°±å¯ä»¥æ‰§è¡Œ</em>èšåˆ</em>é€»è¾‘ã€‚å½“ç„¶ï¼Œ<em>æ’åº</em>é€»è¾‘éœ€è¦ç­‰åˆ°æ‰€æœ‰åˆ†ç‰‡ç»“æœéƒ½è¿”å›æ‰å¯ä»¥æ‰§è¡Œã€‚**</p><p><strong>æ ¸å¿ƒä»£ç </strong>ï¼š</p><ul><li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/sqlengine/mpp/AbstractDataNodeMerge.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractDataNodeMerge.java</a></li><li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/sqlengine/mpp/DataNodeMergeManager.java" rel="external nofollow noopener noreferrer" target="_blank">DataNodeMergeManager.java#run(...)</a></li></ul><h3>3.2 DataNodeMergeManager</h3><p><code>AbstractDataNodeMerge</code> æœ‰ä¸¤ç§å­ç±»å®ç°ï¼š</p><ul><li><code>DataMergeService</code> ï¼šåŸºäº<strong>å †å†…å†…å­˜</strong>åˆå¹¶åˆ†ç‰‡ç»“æœã€‚</li><li><code>DataNodeMergeManager</code> ï¼šåŸºäº<strong>å †å¤–å†…å­˜</strong>åˆå¹¶åˆ†ç‰‡ç»“æœã€‚</li></ul><p>ç›®å‰å®˜æ–¹é»˜è®¤é…ç½®ä½¿ç”¨ <code>DataNodeMergeManager</code>ã€‚ä¸»è¦æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š</p><ol><li>å¯ä»¥ä½¿ç”¨æ›´å¤§çš„å†…å­˜ç©ºé—´ã€‚å½“å¹¶å‘é‡å¤§æˆ–è€…æ•°æ®é‡å¤§æ—¶ï¼Œæ›´å¤§çš„å†…å­˜ç©ºé—´æ„å‘³ç€æ›´å¥½çš„æ€§èƒ½ã€‚</li><li>å‡å°‘ GC æš‚åœæ—¶é—´ã€‚è®°å½•è¡Œ(row)å¯¹è±¡å°ä¸”é‡ç”¨æ€§å¾ˆä½ï¼Œéœ€è¦èƒ½å¤Ÿè¿›è¡Œç±»ä¼¼ C / C++ çš„è‡ªä¸»å†…å­˜é‡Šæ”¾ã€‚</li><li>æ›´å¿«çš„å†…å­˜å¤åˆ¶å’Œè¯»å–é€Ÿåº¦ï¼Œå¯¹æ’åºå’Œèšåˆå¸¦æ¥å¾ˆå¥½çš„æé€Ÿã€‚</li></ol><p>å¦‚æœå¯¹<strong>å †å¤–å†…å­˜</strong>ä¸å¤ªäº†è§£ï¼Œæ¨èé˜…è¯»å¦‚ä¸‹æ–‡ç« ï¼š</p><ol><li><a href="http://www.jianshu.com/p/50be08b54bee" rel="external nofollow noopener noreferrer" target="_blank">ã€Šä»0åˆ°1èµ·æ­¥-è·Ÿæˆ‘è¿›å…¥å †å¤–å†…å­˜çš„å¥‡å¦™ä¸–ç•Œã€‹</a></li><li><a href="http://www.infoq.com/cn/news/2014/12/external-memory-heap-memory" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå †å†…å†…å­˜è¿˜æ˜¯å †å¤–å†…å­˜ï¼Ÿã€‹</a></li><li><a href="http://www.cnblogs.com/moonandstar08/p/5107648.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJAVAå †å¤–å†…å­˜ã€‹</a></li><li><a href="https://yq.aliyun.com/articles/2948?spm=5176.100239.blogcont62539.11.a3HdFE" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJVMæºç åˆ†æä¹‹å †å¤–å†…å­˜å®Œå…¨è§£è¯»ã€‹</a></li></ol><p>æœ¬æ–‡ä¸»è¦åˆ†æ <code>DataNodeMergeManager</code> å®ç°ï¼Œ<code>DataMergeService</code> å¯ä»¥è‡ªå·±é˜…è¯»æˆ–è€…ç­‰å¾…åç»­æ–‡ç« ï¼ˆğŸ˜ˆ<strong>æ¬¢è¿è®¢é˜…æˆ‘çš„å…¬ä¼—å·å™¢</strong>ï¼‰ã€‚</p><p><code>DataNodeMergeManager</code> æœ‰ä¸‰ä¸ªç»„ä»¶ï¼š</p><ul><li><code>globalSorter</code> ï¼š<code>UnsafeExternalRowSorter</code> =&gt; å®ç°è®°å½•è¡Œ(row)<strong>åˆå¹¶å¹¶æ’åº</strong>é€»è¾‘ã€‚</li><li><code>globalMergeResult</code> ï¼š<code>UnsafeExternalRowSorter</code> =&gt; å®ç°è®°å½•è¡Œ(row)<strong>åˆå¹¶ä¸æ’åº</strong>é€»è¾‘ã€‚</li><li><code>unsafeRowGrouper</code> ï¼š <code>UnsafeRowGrouper</code> =&gt; å®ç°è®°å½•è¡Œ(row)<strong>èšåˆ</strong>é€»è¾‘ã€‚</li></ul><p><code>DataNodeMergeManager#run(...)</code> é€»è¾‘å¦‚ä¸‹ï¼š</p><ul><li>[1] å†™å…¥è®°å½•è¡Œ(row)åˆ° <code>UnsafeRow</code>ã€‚</li><li>[2] æ ¹æ®æƒ…å†µå°† <code>UnsafeRow</code> æ’å…¥å¯¹åº”ç»„ä»¶ã€‚</li><li>[3] å½“æ‰€æœ‰ <code>UnsafeRow</code> æ’å…¥å®Œåï¼Œæ ¹æ®æƒ…å†µä½¿ç”¨ç»„ä»¶èšåˆã€æ’åºã€‚</li></ul><table><thead><tr><th>æ˜¯å¦æ’åº</th><th>æ˜¯å¦èšåˆ</th><th>ä¾èµ–ç»„ä»¶</th><th>[2]</th><th>[3]</th></tr></thead><tbody><tr><td>å¦</td><td>å¦</td><td><code>globalSorter</code></td><td>æ’å…¥ <code>globalSorter</code></td><td>ä½¿ç”¨ <code>globalSorter</code> åˆå¹¶å¹¶æ’åº</td></tr><tr><td>æ˜¯</td><td>å¦</td><td><code>globalMergeResult</code></td><td>æ’å…¥ <code>globalMergeResult</code></td><td>ä½¿ç”¨ <code>globalMergeResult</code> åˆå¹¶ä¸æ’åº</td></tr><tr><td>å¦</td><td>æ˜¯</td><td><code>unsafeRowGrouper</code> +Â <code>globalSorter</code></td><td>æ’å…¥ <code>unsafeRowGrouper</code> è¿›è¡Œèšåˆ</td><td>ä½¿ç”¨ <code>globalSorter</code> åˆå¹¶å¹¶æ’åº</td></tr><tr><td>æ˜¯</td><td>æ˜¯</td><td><code>unsafeRowGrouper</code> +Â <code>globalMergeResult</code></td><td>æ’å…¥ <code>unsafeRowGrouper</code> è¿›è¡Œèšåˆ</td><td>ä½¿ç”¨ <code>globalMergeResult</code> åˆå¹¶ä¸æ’åº</td></tr></tbody></table><p><strong>æ ¸å¿ƒä»£ç </strong>ï¼š</p><ul><li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/sqlengine/mpp/DataNodeMergeManager.java" rel="external nofollow noopener noreferrer" target="_blank">DataNodeMergeManager.java</a>ã€‚</li></ul><p>ğŸ™ƒçœ‹åˆ°è¿™é‡Œï¼Œå¯èƒ½å¾ˆå¤šåŒå­¦éƒ½æœ‰ç‚¹æ‡µé€¼ï¼Œé—®é¢˜ä¸å¤§ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹ç…ã€‚</p><h3>3.3 UnsafeRow</h3><p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/unsafe_row.png" alt="unsafe_row"></p><p>è®°å½•è¡Œ(row)å†™åˆ° <code>UnsafeRow</code> çš„ <code>baseObject</code> å±æ€§ï¼Œç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/unsafe_row_object.png" alt="unsafe_row_object"> <img src="http://www.yunai.me/images/MyCAT/2017_06_13/unsafe_row_2.png" alt="unsafe_row_2.png"></p><ul><li>æ‹†åˆ†æˆä¸‰ä¸ªåŒºåŸŸï¼Œ<strong>æ¯ä¸ªåŒºåŸŸæŒ‰ç…§æ ¼å­è®°å½•ä¿¡æ¯ï¼Œæ¯ä¸ªæ ¼å­ 64bits(8 Bytes)</strong>ã€‚</li><li>è®°å½•è¡Œ(row)æŒ‰ç…§å­—æ®µé¡ºåºä½ç½®è®°å½•åˆ° <code>baseObject</code>ã€‚</li><li>[1] ç©ºæ ‡è®°ä½åŒºåŸŸ ï¼šæ ‡è®°å­—æ®µå¯¹åº”çš„å€¼æ˜¯å¦ä¸º NULLã€‚<ul><li>å½“å­—æ®µå¯¹åº”çš„å€¼ä¸º NULL æ—¶ï¼Œå…¶å¯¹åº”çš„å­—æ®µé¡ºåºå¯¹åº”çš„ bit è®¾ç½®ä¸º 1ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œç¬¬ 0 ä¸ªä½ç½®å­—æ®µä¸º NULLï¼Œåˆ™ç¬¬ä¸€ä¸ªæ ¼å­å¯¹åº”çš„ 64 bits ä»å³è¾¹ç¬¬ä¸€ä¸ª bit è®¾ç½®ä¸º 1ã€‚</li><li>å› ä¸ºæ¯ä¸ªæ ¼å­æ˜¯ 64 bitsï¼Œæ¯ 64 ä¸ªå­—æ®µå ç”¨ä¸€ä¸ªæ ¼å­ï¼Œä¸æ»¡ä¸€ä¸ªæ ¼å­ï¼ŒæŒ‰ç…§ä¸€ä¸ªæ ¼å­è®¡ç®—ã€‚å› æ­¤ï¼Œè¯¥åŒºåŸŸçš„é•¿åº¦(<code>bitSetWidthInBytes</code>) = å­—æ®µå ç”¨çš„æ ¼å­æ•° * 64 bitsã€‚</li></ul></li><li>[2] ä½ç½®é•¿åº¦åŒºåŸŸ ï¼šè®°å½•å­—æ®µå¯¹åº”çš„å€¼åœ¨<code>[3]åŒºåŸŸ</code>æ‰€åœ¨çš„ä½ç½®å’Œé•¿åº¦ã€‚<ul><li>æ¯ä¸ªå­—æ®µè®°å½•<code>[2]åŒºåŸŸ</code>çš„ä½ç½® = <code>baseOffset</code> + <code>bitSetWidthInBytes</code> + 8 Bytes * å­—æ®µé¡ºåºã€‚</li><li>å ç”¨ä¸€ä¸ªæ ¼å­ï¼Œå‰ 32 bits ä¸º<code>[3]åŒºåŸŸ</code>çš„ä½ç½®ï¼Œå 32 bits ä¸ºå­—æ®µå¯¹åº”çš„å€¼é•¿åº¦ã€‚</li></ul></li><li>[3] å€¼åŒºåŸŸ ï¼šè®°å½•å­—æ®µå¯¹åº”çš„å€¼ã€‚<ul><li>æ¯ä¸ªå­—æ®µå¯¹åº”çš„å€¼å ç”¨æ ¼å­æ•° = å­—æ®µå¯¹åº”çš„å€¼é•¿åº¦ / 8 Byteï¼Œå¦‚æœæ— æ³•æ•´é™¤å† + 1ã€‚</li><li>å› ä¸ºå­—æ®µå¯¹åº”çš„å€¼å¯èƒ½æ— æ³•åˆšå¥½å æ»¡æ¯ä¸ªæ ¼å­ï¼Œæœªä½¿ç”¨çš„ bit ç”¨ 0 å ä½ã€‚</li></ul></li></ul><p><strong>å†™å…¥ <code>UnsafeRow</code>ï¼ŒMyCAT å¯ä»¥é¡ºåºè®¿é—®æ¯ä¸ªå­—æ®µï¼Œè€Œä¸éœ€è¦åœ¨è®°å½•è¡Œ(row)è¿›è¡Œéå†ã€‚</strong></p><p>ğŸ™ƒæ—¥å¸¸å¼€å‘ä½¿ç”¨ä½æ“ä½œçš„æœºä¼šæ¯”è¾ƒå°‘ï¼Œå¯èƒ½è¾ƒä¸ºéš¾ç†è§£ï¼Œéœ€è¦åå¤ç†è§£ä¸‹ï¼Œç›¸ä¿¡ä¼šè·å¾—å¾ˆå¤§å¯å‘ã€‚æ©ï¼Œè¯¥éƒ¨åˆ†ä»£ç å¼•ç”¨è‡ªå¼€æºè¿ç®—æ¡†æ¶ <code>Spark</code>ï¼Œæ˜¯ä¸æ˜¯æ›´åŠ æœ‰åŠ¨åŠ›åˆ—ğŸ˜ˆã€‚</p><p><strong>æ ¸å¿ƒä»£ç </strong>ï¼š</p><ul><li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/row/UnsafeRow.java" rel="external nofollow noopener noreferrer" target="_blank">UnsafeRow.java</a></li><li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/row/BufferHolder.java" rel="external nofollow noopener noreferrer" target="_blank">BufferHolder.java</a></li><li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/row/UnsafeRowWriter.java" rel="external nofollow noopener noreferrer" target="_blank">UnsafeRowWriter.java</a></li></ul><h3>3.4 UnsafeExternalRowSorter</h3><p>å¦‚æœä½¿ç”¨ Java å®ç° <code>SELECT * FROM student ORDER BY age desc, nickname asc</code>ï¼Œä¸è€ƒè™‘ç®—æ³•ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•å¦‚ä¸‹å®ç°ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">Collections.sort(students, <span class="keyword">new</span> Comparator&lt;Comparable&gt;() &#123;</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Student o1, Student o2)</span> </span>&#123;</div><div class="line">           <span class="keyword">int</span> cmp = compare(o2.age, o1.age);</div><div class="line">           <span class="keyword">return</span> cmp != <span class="number">0</span> ? cmp : compare(o1.nickname, o2.nickname);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure><p></p><p>ä»åŠŸèƒ½ä¸Šï¼Œ<code>UnsafeExternalRowSorter</code> æ˜¯è¿™ä¹ˆå®ç°æ’åºé€»è¾‘ã€‚å½“ç„¶è‚¯å®šçš„æ˜¯ï¼Œä¸æ˜¯è¿™ä¹ˆâ€œç®€å•â€çš„å®ç°ã€‚</p><p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/sorter_write.jpeg" alt="sorter_write"></p><p><code>UnsafeRow</code> ä¼šå†™å…¥åˆ°ä¸¤ä¸ªåœ°æ–¹ï¼š</p><ol><li><code>List&lt;MemoryBlock&gt;</code> ï¼šå†…å­˜å—æ•°ç»„ã€‚å½“å‰ <code>MemoryBlock</code> æ— æ³•å®¹çº³å†™å…¥çš„ <code>UnsafeRow</code> æ—¶ï¼Œç”Ÿæˆæ–°çš„ <code>MemoryBlock</code> æä¾›å†™å…¥ã€‚æ¯æ¡ <code>UnsafeRow</code> å­˜å‚¨åœ¨ <code>MemoryBlock</code> ç”± é•¿åº¦ + å­—èŠ‚å†…å®¹ ç»„æˆã€‚</li><li><code>LongArray</code> ï¼šæ¯æ¡ <code>UnsafeRow</code> å­˜å‚¨åœ¨ <code>LongArray</code> ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šaddress + prefixã€‚<ul><li><code>address</code> ï¼š<code>UnsafeRow</code> å­˜å‚¨åœ¨ <code>List&lt;MemoryBlock&gt;</code> çš„ä½ç½®ã€‚å‰ 13 bits è®°å½•æ‰€åœ¨ <code>MemoryBlock</code> çš„ indexï¼Œå 51 bit è®°å½•åœ¨ <code>MemoryBlock</code> çš„ offsetã€‚</li><li><code>prefix</code> ï¼š<code>UnsafeRow</code> ç¬¬ä¸€ä¸ªæ’åºå­—æ®µ<strong>å€¼</strong>å‰ 64 bits è®¡ç®—çš„å€¼ã€‚</li></ul></li></ol><p><strong><code>UnsafeExternalRowSorter</code> æ’åºå®ç°æ–¹å¼</strong> ï¼šæä¾› <strong><a href="http://blog.csdn.net/yangzhongblog/article/details/8184707" rel="external nofollow noopener noreferrer" target="_blank">TimSort</a></strong> å’Œ <strong>RadixSort</strong> ä¸¤ç§æ’åºç®—æ³•ï¼Œå‰è€…ä¸ºé»˜è®¤å®ç°ã€‚<strong>TimSort</strong> æŠ˜åŠæŸ¥æ‰¾æ—¶ï¼Œä½¿ç”¨ <code>LongArray</code>ï¼Œå…ˆæ¯”è¾ƒ <code>prefix</code>ï¼Œè‹¥ç›¸ç­‰ï¼Œåˆ™é¡ºåºå¯¹æ¯”æ¯ä¸ªæ’åºå­—æ®µç›´åˆ°ä¸ç­‰ï¼Œæå‡è®¡ç®—æ•ˆç‡ã€‚æ’å…¥æ“ä½œåœ¨ <code>LongArray</code> æ“ä½œï¼Œ<code>List&lt;MemoryBlock&gt;</code> åªä½œä¸ºåŸå§‹æ•°æ®ã€‚</p><p>å¦å¤–ï¼Œå½“éœ€è¦æ’åºç‰¹åˆ«å¤§çš„æ•°æ®é‡æ—¶ï¼Œä¼šä½¿ç”¨å­˜å‚¨æ•°æ®åˆ°æ–‡ä»¶è¿›è¡Œæ’åºã€‚é™äºç¬”è€…æš‚æ—¶æœªé˜…è¯»è¯¥å¤„æºç ï¼Œåç»­ä¼šå¦å¼€æ–‡ç« åˆ†æã€‚ğŸ™‚</p><p>æ ¸å¿ƒæºç ï¼š</p><ul><li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/utils/sort/UnsafeExternalRowSorter.java" rel="external nofollow noopener noreferrer" target="_blank">UnsafeExternalRowSorter.java</a></li><li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/utils/sort/UnsafeExternalRowSorter.java" rel="external nofollow noopener noreferrer" target="_blank">UnsafeExternalRowSorter.java</a></li><li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/utils/sort/TimSort.java" rel="external nofollow noopener noreferrer" target="_blank">TimSort.java</a></li></ul><h3>3.5 UnsafeRowGrouper</h3><p>å¦‚æœä½¿ç”¨ Java å®ç° <code>SELECT nickname, COUNT(*) FROM student group by nickname</code>ï¼Œä¸è€ƒè™‘ç®—æ³•ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•å¦‚ä¸‹å®ç°ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">Map&lt;String, List&lt;Object&gt;&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"><span class="comment">// èšåˆ</span></div><div class="line"><span class="keyword">for</span> (student : students) &#123;</div><div class="line">    <span class="keyword">if</span> (map.contains(student.nickname)) &#123;</div><div class="line">        map.put(student.nickname, map.get(student.nickname).get(<span class="number">1</span>) + <span class="number">1</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        List&lt;Object&gt; value = <span class="keyword">new</span> Array&lt;&gt;();</div><div class="line">        value.add(nickname);</div><div class="line">        value.add(<span class="number">1</span>);</div><div class="line">        map.put(student.nickname, value);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// è¾“å‡º</span></div><div class="line"><span class="keyword">for</span> (value : map.values) &#123;</div><div class="line">    System.out.println(value);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>ä»åŠŸèƒ½ä¸Šï¼Œ<code>UnsafeRowGrouper</code> æ˜¯è¿™ä¹ˆå®ç°æ’åºé€»è¾‘ã€‚å½“ç„¶è‚¯å®šçš„æ˜¯ï¼Œä¹Ÿä¸æ˜¯è¿™ä¹ˆâ€œç®€å•â€çš„å®ç°ã€‚</p><p>ğŸ˜ˆå…·ä½“æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿæˆ‘ä»¬åœ¨ã€ŠMyCAT æºç è§£æ â€”â€” åˆ†ç‰‡ç»“æœåˆå¹¶ï¼ˆäºŒï¼‰ã€‹ç»§ç»­åˆ†æã€‚</p><h1>4. æ•‘æŠ¤ä¸­å¿ƒ</h1><p>çœ‹åˆ°æ­¤å¤„çš„åº”è¯¥æ˜¯çœŸçˆ±å§ï¼Ÿï¼å¦‚æœå†…å®¹ä¸Šæœ‰ä»€ä¹ˆé”™è¯¯æˆ–è€…éš¾æ‡‚çš„åœ°æ–¹ï¼Œå¯ä»¥å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ç»™æˆ‘ç•™è¨€ï¼Œæˆ‘ä¼šå¾ˆè®¤çœŸçš„é€æ¡è§£ç­”çš„ã€‚â€œä¸‡ä¸€â€è§‰å¾—æœ¬æ–‡è¿˜å¯ä»¥ï¼Œå¸Œæœ›è½¬å‘åˆ°æœ‹å‹åœˆè®©æ›´å¤šçš„äººçœ‹åˆ°ã€‚</p><p>æœ€åçš„æœ€åï¼Œæ„Ÿè°¢è€å¿ƒé˜…è¯»æœ¬æ–‡çš„åŒå­¦ã€‚</p><p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt="wechat_mp"></p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/MyCAT/">MyCAT</a></div><div class="article-share" id="share"><div data-url="http://www.yunai.me/MyCAT/sharding-result-merge-first/" data-title="MyCAT æºç è§£æ â€”â€” åˆ†ç‰‡ç»“æœåˆå¹¶ï¼ˆä¸€ï¼‰ | èŠ‹è‰¿Vçš„åšå®¢" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/MyCAT/two-table-share-join/" title="MyCAT æºç åˆ†æ  â€”â€” è·¨åº“ä¸¤è¡¨Join"><strong>PREVIOUS:</strong><br><span>MyCAT æºç åˆ†æ â€”â€” è·¨åº“ä¸¤è¡¨Join</span></a></div><div class="next"><a href="/MyCAT/single-db-single-table-select/" title="MyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢"><strong>NEXT:</strong><br><span>MyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢</span></a></div></nav></div></div><footer><div id="footer"><p class="copyright">Â© 2017 <a href="http://www.yunai.me" target="_blank" title="ç‹æ–‡æ–Œ">ç‹æ–‡æ–Œ</a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a> && Powered by <a href="http://hexo.io" target="_blank" title="hexo" rel="external nofollow noopener noreferrer">hexo</a> && Theme by <a href="http://gengbiao.me" target="_blank" title="coney" rel="external nofollow noopener noreferrer">coney</a></p></div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2");ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script>$(document).ready(function(){function e(){var e=jqueryAlert({title:"ğŸ‘¼æ¯å‘¨å…­æ›´æ–°ä¸€ç¯‡æºç è§£æï¼Œã€æ‰«ä¸€æ‰«ã€‘å…³æ³¨å…¬ä¼—å·ğŸ‘¼",width:"500",height:"580",modal:!0,content:n+'<p style="color: red">ä»Šæ—¥'+c+"å·²å…³æ³¨äººæ•°ï¼š"+p+'</p><img width="400" src="http://www.yunai.me/images/common/wechat_mp_simple.png" /><p style="color: red">å…³æ³¨åï¼Œæ¬¢è¿åŠ å…¥ã€æºç åœˆã€‘å¾®ä¿¡ç¾¤äº¤æµ</p><p style="color: red">ä¸€èµ·çœ‹æºç ï¼Œè¯»æºç ï¼Œæå‡æŠ€æœ¯ï¼</p>',buttons:{"å·²å…³æ³¨ï¼Œå…³é—­çª—å£ï¼ˆå…¬ä¼—å·å‘é€ï¼šã€å£ä»¤ã€‘å±è”½å¼¹çª—ï¼‰":function(){e.close()}}});$.cookie(o,i+1,{expires:1,path:"/"})}if(!(location.href.indexOf("vip")>=0||location.href.indexOf("127.0.0.1")>=0)){var o="doubi",i=$.cookie(o);i?i=parseInt(i):($.cookie(o,0,{expires:1,path:"/"}),i=0),$.cookie(o,i,{expires:1,path:"/"});var t="default",r={juejin:"æ˜é‡‘",oschina:"å¼€æºä¸­å›½",sjdbc:"Sharding-JDBC",jianshu:"ç®€ä¹¦",csdn:"CSDN",iteye:"iteye",cnblogs:"åšå®¢å›­"};for(var a in r)if(location.search.indexOf(a)>=0){t=a;break}"default"===t&&(t=$.cookie("from")||"default"),$.cookie("from",t,{expires:365,path:"/"});var n="",c="";if(t&&r[t]&&(n='<p style="color: red">æ¬¢è¿æ¥è‡ªã€'+r[t]+"ã€‘çš„åŒå­¦</p>",c="ã€"+r[t]+"ã€‘"),i<=3){var p=103+5*(new Date).getHours();setTimeout(e,1e4*(i+1))}}})</script></body>