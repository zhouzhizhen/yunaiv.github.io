<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>MyCAT æºç åˆ†æ â€”â€” XAåˆ†å¸ƒå¼äº‹åŠ¡ | èŠ‹è‰¿Vçš„åšå®¢</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="ç‹æ–‡æ–Œ"><meta name="description" content="ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘æœ‰ç¦åˆ©ï¼š  

RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨  
RocketMQ / MyCAT / Sharding-JDBC ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€  
æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚"><meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹è‰¿Vçš„åšå®¢" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?ef4ed89f6dc83d01803a2440ae21e666";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹è‰¿Vçš„åšå®¢">èŠ‹è‰¿Vçš„åšå®¢</a></h1><a class="blog-motto">æ„¿ç¼–ç åŠç”Ÿï¼Œå¦‚è€å‹ç›¸ä¼´ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li></ul></ul></nav></div></header><div id="container"><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-XA-æ¦‚å¿µ"><span class="toc-number">2.</span> <span class="toc-text">2. XA æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-MyCAT-ä»£ç å®ç°"><span class="toc-number">3.</span> <span class="toc-text">3. MyCAT ä»£ç å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-JDBC-Demo-ä»£ç "><span class="toc-number">3.1.</span> <span class="toc-text">3.1 JDBC Demo ä»£ç </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-MyCAT-å¼€å¯-XA-äº‹åŠ¡"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 MyCAT å¼€å¯ XA äº‹åŠ¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-MyCAT-æ¥æ”¶-SQL"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 MyCAT æ¥æ”¶ SQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-MySQL-æ¥æ”¶-COMMIT"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 MySQL æ¥æ”¶ COMMIT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-å•èŠ‚ç‚¹äº‹åŠ¡-or-å¤šèŠ‚ç‚¹äº‹åŠ¡"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 å•èŠ‚ç‚¹äº‹åŠ¡ or å¤šèŠ‚ç‚¹äº‹åŠ¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-åè°ƒæ—¥å¿—"><span class="toc-number">3.4.2.</span> <span class="toc-text">3.4.2 åè°ƒæ—¥å¿—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-MultiNodeCoordinator"><span class="toc-number">3.4.3.</span> <span class="toc-text">3.4.3 MultiNodeCoordinator</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-MyCAT-å¯åŠ¨å›æ»š-XAäº‹åŠ¡"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 MyCAT å¯åŠ¨å›æ»š XAäº‹åŠ¡</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-MyCAT-å®ç°ç¼ºé™·"><span class="toc-number">4.</span> <span class="toc-text">4. MyCAT å®ç°ç¼ºé™·</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨-PREPARE-å°±è¿›è¡Œ-COMMIT"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨ PREPARE å°±è¿›è¡Œ COMMIT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-MyCAT-å¯åŠ¨å›æ»š-PREPARE-çš„-XAäº‹åŠ¡"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 MyCAT å¯åŠ¨å›æ»š PREPARE çš„ XAäº‹åŠ¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-XA-COMMIT-éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†"><span class="toc-number">4.5.</span> <span class="toc-text">4.5 XA COMMIT éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-å½©è›‹"><span class="toc-number">5.</span> <span class="toc-text">5. å½©è›‹</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹è‰¿çš„åç«¯å°å±‹</p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/Elastic-Job/" title="Elastic-Job">Elastic-Job<sup>1</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/æŠ€æœ¯æ‚æ–‡/" title="æŠ€æœ¯æ‚æ–‡">æŠ€æœ¯æ‚æ–‡<sup>2</sup></a></li></ul></div></aside></div><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/MyCAT/xa-distributed-transaction/" title="MyCAT æºç åˆ†æ  â€”â€” XAåˆ†å¸ƒå¼äº‹åŠ¡" itemprop="url">MyCAT æºç åˆ†æ â€”â€” XAåˆ†å¸ƒå¼äº‹åŠ¡</a></h1><p class="article-author"></p><p class="article-time"><time datetime="2017-07-14T16:00:00.000Z" itemprop="datePublished">2017-07-15</time> æ›´æ–°æ—¥æœŸ:<time datetime="2017-07-31T12:30:52.000Z" itemprop="dateModified">2017-07-31</time> æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><div id="toc" class="toc-article"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-XA-æ¦‚å¿µ"><span class="toc-number">2.</span> <span class="toc-text">2. XA æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-MyCAT-ä»£ç å®ç°"><span class="toc-number">3.</span> <span class="toc-text">3. MyCAT ä»£ç å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-JDBC-Demo-ä»£ç "><span class="toc-number">3.1.</span> <span class="toc-text">3.1 JDBC Demo ä»£ç </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-MyCAT-å¼€å¯-XA-äº‹åŠ¡"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 MyCAT å¼€å¯ XA äº‹åŠ¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-MyCAT-æ¥æ”¶-SQL"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 MyCAT æ¥æ”¶ SQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-MySQL-æ¥æ”¶-COMMIT"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 MySQL æ¥æ”¶ COMMIT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-å•èŠ‚ç‚¹äº‹åŠ¡-or-å¤šèŠ‚ç‚¹äº‹åŠ¡"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 å•èŠ‚ç‚¹äº‹åŠ¡ or å¤šèŠ‚ç‚¹äº‹åŠ¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-åè°ƒæ—¥å¿—"><span class="toc-number">3.4.2.</span> <span class="toc-text">3.4.2 åè°ƒæ—¥å¿—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-MultiNodeCoordinator"><span class="toc-number">3.4.3.</span> <span class="toc-text">3.4.3 MultiNodeCoordinator</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-MyCAT-å¯åŠ¨å›æ»š-XAäº‹åŠ¡"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 MyCAT å¯åŠ¨å›æ»š XAäº‹åŠ¡</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-MyCAT-å®ç°ç¼ºé™·"><span class="toc-number">4.</span> <span class="toc-text">4. MyCAT å®ç°ç¼ºé™·</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨-PREPARE-å°±è¿›è¡Œ-COMMIT"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨ PREPARE å°±è¿›è¡Œ COMMIT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-MyCAT-å¯åŠ¨å›æ»š-PREPARE-çš„-XAäº‹åŠ¡"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 MyCAT å¯åŠ¨å›æ»š PREPARE çš„ XAäº‹åŠ¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-XA-COMMIT-éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†"><span class="toc-number">4.5.</span> <span class="toc-text">4.5 XA COMMIT éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-å½©è›‹"><span class="toc-number">5.</span> <span class="toc-text">5. å½©è›‹</span></a></li></ol></div><p><img src="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹è‰¿çš„åç«¯å°å±‹ã€‘</strong>æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. XA æ¦‚å¿µ</a></li><li><a href="#">3. MyCAT ä»£ç å®ç°</a><ul><li><a href="#">3.1 JDBC Demo ä»£ç </a></li><li><a href="#">3.2 MyCAT å¼€å¯ XA äº‹åŠ¡</a></li><li><a href="#">3.3 MyCAT æ¥æ”¶ SQL</a></li><li><a href="#">3.4 MySQL æ¥æ”¶ COMMIT</a><ul><li><a href="#">3.4.1 å•èŠ‚ç‚¹äº‹åŠ¡ or å¤šèŠ‚ç‚¹äº‹åŠ¡</a></li><li><a href="#">3.4.2 åè°ƒæ—¥å¿—</a></li><li><a href="#">3.4.3 MultiNodeCoordinator</a></li></ul></li><li><a href="#">3.5 MyCAT å¯åŠ¨å›æ»š XAäº‹åŠ¡</a></li></ul></li><li><a href="#">4. MyCAT å®ç°ç¼ºé™·</a><ul><li><a href="#">4.1 åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½</a></li><li><a href="#">4.2 æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨ PREPARE å°±è¿›è¡Œ COMMIT</a></li><li><a href="#">4.3 MyCAT å¯åŠ¨å›æ»š PREPARE çš„ XAäº‹åŠ¡</a></li><li><a href="#">4.4 å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—</a></li><li><a href="#">4.5 XA COMMIT éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†</a></li></ul></li><li><a href="#">5. å½©è›‹</a></li></ul><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æ•°æ®åº“æ‹†åˆ†åï¼Œä¸šåŠ¡ä¸Šä¼šç¢°åˆ°éœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡çš„åœºæ™¯ã€‚MyCAT åŸºäº XA å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚å›½å†…ç›®å‰å¦å¤–ä¸€æ¬¾å¾ˆç«çš„æ•°æ®åº“ä¸­é—´ä»¶ Sharding-JDBC å‡†å¤‡åŸºäº TCC å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚</p><p>æœ¬æ–‡å†…å®¹åˆ†æˆä¸‰éƒ¨åˆ†ï¼š</p><ol><li>XA æ¦‚å¿µç®€è¿°</li><li>MyCAT ä»£ç å¦‚ä½•å®ç° XA</li><li>MyCAT åœ¨å®ç° XA å­˜åœ¨çš„ä¸€äº›ç¼ºé™·</li></ol><h1 id="2-XA-æ¦‚å¿µ"><a href="#2-XA-æ¦‚å¿µ" class="headerlink" title="2. XA æ¦‚å¿µ"></a>2. XA æ¦‚å¿µ</h1><p>&gt;<br>X/Open ç»„ç»‡ï¼ˆå³ç°åœ¨çš„ Open Group ï¼‰å®šä¹‰äº†åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†æ¨¡å‹ã€‚ X/Open DTP æ¨¡å‹ï¼ˆ 1994 ï¼‰åŒ…æ‹¬ï¼š</p><ol><li>åº”ç”¨ç¨‹åºï¼ˆ <strong>AP</strong> ï¼‰</li><li>äº‹åŠ¡ç®¡ç†å™¨ï¼ˆ <strong>TM</strong> ï¼‰</li><li>èµ„æºç®¡ç†å™¨ï¼ˆ <strong>RM</strong> ï¼‰</li><li>é€šä¿¡èµ„æºç®¡ç†å™¨ï¼ˆ <strong>CRM</strong> ï¼‰<br>ä¸€èˆ¬ï¼Œå¸¸è§çš„äº‹åŠ¡ç®¡ç†å™¨ï¼ˆ TM ï¼‰æ˜¯äº¤æ˜“ä¸­é—´ä»¶ï¼Œå¸¸è§çš„èµ„æºç®¡ç†å™¨ï¼ˆ <strong>RM</strong> ï¼‰æ˜¯æ•°æ®åº“ï¼Œå¸¸è§çš„é€šä¿¡èµ„æºç®¡ç†å™¨ï¼ˆ <strong>CRM</strong> ï¼‰æ˜¯æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œä¸‹å›¾æ˜¯X/Open DTPæ¨¡å‹ï¼š</li></ol><p><img src="http://www.yunai.me/images/MyCAT/2017_07_15/01.png" alt=""></p><blockquote><p>ä¸€èˆ¬çš„ç¼–ç¨‹æ–¹å¼æ˜¯è¿™æ ·çš„ï¼š</p><ol><li>é…ç½® <strong>TM</strong> ï¼Œé€šè¿‡ <strong>TM</strong> æˆ–è€… <strong>RM</strong> æä¾›çš„æ–¹å¼ï¼ŒæŠŠ <strong>RM</strong> æ³¨å†Œåˆ° <strong>TM</strong>ã€‚å¯ä»¥ç†è§£ä¸ºç»™ <strong>TM</strong> æ³¨å†Œ <strong>RM</strong> ä½œä¸ºæ•°æ®æºã€‚ä¸€ä¸ª <strong>TM</strong> å¯ä»¥æ³¨å†Œå¤šä¸ª <strong>RM</strong>ã€‚</li><li><strong>AP</strong> ä» <strong>TM</strong> è·å–èµ„æºç®¡ç†å™¨çš„ä»£ç†ï¼ˆä¾‹å¦‚ï¼šä½¿ç”¨JTAæ¥å£ï¼Œä»TMç®¡ç†çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè·å–å‡ºè¿™ä¸ªTMæ‰€ç®¡ç†çš„RMçš„JDBCè¿æ¥æˆ–JMSè¿æ¥ï¼‰<br><strong>AP</strong> å‘ <strong>TM</strong> å‘èµ·ä¸€ä¸ªå…¨å±€äº‹åŠ¡ã€‚è¿™æ—¶ï¼Œ<strong>TM</strong> ä¼šé€šçŸ¥å„ä¸ª <strong>RM</strong>ã€‚<strong>XID</strong>ï¼ˆå…¨å±€äº‹åŠ¡IDï¼‰ä¼šé€šçŸ¥åˆ°å„ä¸ªRMã€‚</li><li><strong>AP</strong> é€šè¿‡ <strong>TM</strong> ä¸­è·å–çš„è¿æ¥ï¼Œ<strong>é—´æ¥</strong>æ“ä½œ <strong>RM</strong> è¿›è¡Œä¸šåŠ¡æ“ä½œã€‚è¿™æ—¶ï¼Œ<strong>TM</strong> åœ¨æ¯æ¬¡ <strong>AP</strong> æ“ä½œæ—¶æŠŠ <strong>XID</strong>(åŒ…æ‹¬æ‰€å±åˆ†æ”¯çš„ä¿¡æ¯)ä¼ é€’ç»™ <strong>RM</strong>ï¼Œ<strong>RM</strong> æ­£æ˜¯é€šè¿‡è¿™ä¸ª <strong>XID</strong> å…³è”æ¥æ“ä½œå’Œäº‹åŠ¡çš„å…³ç³»çš„ã€‚</li><li><strong>AP</strong> ç»“æŸå…¨å±€äº‹åŠ¡æ—¶ï¼Œ<strong>TM</strong> ä¼šé€šçŸ¥ <strong>RM</strong> å…¨å±€äº‹åŠ¡ç»“æŸã€‚å¼€å§‹äºŒæ®µæäº¤ï¼Œä¹Ÿå°±æ˜¯prepare - commitçš„è¿‡ç¨‹ã€‚</li></ol></blockquote><hr><blockquote><p>XAåè®®æŒ‡çš„æ˜¯TMï¼ˆäº‹åŠ¡ç®¡ç†å™¨ï¼‰å’ŒRMï¼ˆèµ„æºç®¡ç†å™¨ï¼‰ä¹‹é—´çš„æ¥å£ã€‚ç›®å‰ä¸»æµçš„å…³ç³»å‹æ•°æ®åº“äº§å“éƒ½æ˜¯å®ç°äº†XAæ¥å£çš„ã€‚JTA(Java Transaction API)æ˜¯ç¬¦åˆX/Open DTPæ¨¡å‹çš„ï¼Œäº‹åŠ¡ç®¡ç†å™¨å’Œèµ„æºç®¡ç†å™¨ä¹‹é—´ä¹Ÿä½¿ç”¨äº†XAåè®®ã€‚ æœ¬è´¨ä¸Šä¹Ÿæ˜¯å€ŸåŠ©ä¸¤é˜¶æ®µæäº¤åè®®æ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡çš„ï¼Œä¸‹é¢åˆ†åˆ«æ¥çœ‹çœ‹XAäº‹åŠ¡æˆåŠŸå’Œå¤±è´¥çš„æ¨¡å‹å›¾ï¼š</p></blockquote><p><img src="http://www.yunai.me/images/MyCAT/2017_07_15/02.png" alt="æˆåŠŸ"></p><p><img src="http://www.yunai.me/images/MyCAT/2017_07_15/03.png" alt="å¤±è´¥"></p><hr><p>ğŸ˜ˆ çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯æœ‰ç§é»‘äººé—®å·çš„æ„Ÿè§‰ï¼Ÿæ·¡å®šï¼æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ MyCAT ä»£ç å±‚é¢æ˜¯å¦‚ä½•å®ç° XA çš„ã€‚å¦å¤–ï¼Œæœ‰å…´è¶£å¯¹æ¦‚å¿µäº†è§£æ›´å¤šçš„ï¼Œå¯ä»¥å‚çœ‹å¦‚ä¸‹æ–‡ç« ï¼š</p><ol><li><a href="http://www.infoq.com/cn/articles/xa-transactions-handle" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠXAäº‹åŠ¡å¤„ç†ã€‹</a></li><li><a href="https://dev.mysql.com/doc/refman/5.7/en/xa-statements.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠXA Transaction SQL Syntaxã€‹</a></li><li><a href="http://www.voidcn.com/blog/gao1738/article/p-4554083.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMySQL XA äº‹åŠ¡æ”¯æŒè°ƒç ”ã€‹</a></li></ol><h1 id="3-MyCAT-ä»£ç å®ç°"><a href="#3-MyCAT-ä»£ç å®ç°" class="headerlink" title="3. MyCAT ä»£ç å®ç°"></a>3. MyCAT ä»£ç å®ç°</h1><ul><li>MyCAT ï¼šTMï¼Œåè°ƒè€…ã€‚</li><li>æ•°æ®èŠ‚ç‚¹ ï¼šRMï¼Œå‚ä¸è€…ã€‚</li></ul><h2 id="3-1-JDBC-Demo-ä»£ç "><a href="#3-1-JDBC-Demo-ä»£ç " class="headerlink" title="3.1 JDBC Demo ä»£ç "></a>3.1 JDBC Demo ä»£ç </h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCATXAClientDemo</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException </span>&#123;</div><div class="line">        <span class="comment">// 1. è·å¾—æ•°æ®åº“è¿æ¥</span></div><div class="line">        Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</div><div class="line">        Connection conn = DriverManager.getConnection(<span class="string">"jdbc:mysql://127.0.0.1:8066/dbtest"</span>, <span class="string">"root"</span>, <span class="string">"123456"</span>);</div><div class="line">        conn.setAutoCommit(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 2. å¼€å¯ MyCAT XA äº‹åŠ¡</span></div><div class="line">        conn.prepareStatement(<span class="string">"set xa=on"</span>).execute();</div><div class="line"></div><div class="line">        <span class="comment">// 3. æ’å…¥ SQL</span></div><div class="line">        <span class="comment">// 3.1 SQL1 Aåº“</span></div><div class="line">        <span class="keyword">long</span> uid = Math.abs(<span class="keyword">new</span> Random().nextLong());</div><div class="line">        String username = UUID.randomUUID().toString();</div><div class="line">        String password = UUID.randomUUID().toString();</div><div class="line">        String sql1 = String.format(<span class="string">"insert into t_user(id, username, password) VALUES (%d, '%s', '%s')"</span>,</div><div class="line">                uid, username, password);</div><div class="line">        conn.prepareStatement(sql1).execute();</div><div class="line">        <span class="comment">// 3.2 SQL2 Båº“</span></div><div class="line">        <span class="keyword">long</span> orderId = Math.abs(<span class="keyword">new</span> Random().nextLong());</div><div class="line">        String nickname = UUID.randomUUID().toString();</div><div class="line">        String sql2 = String.format(<span class="string">"insert into t_order(id, uid, nickname) VALUES(%d, %s, '%s')"</span>, orderId, uid, nickname);</div><div class="line">        conn.prepareStatement(sql2).execute();</div><div class="line"></div><div class="line">        <span class="comment">// 4. æäº¤ XA äº‹åŠ¡</span></div><div class="line">        conn.commit();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>set xa=on</code> MyCAT å¼€å¯ XA äº‹åŠ¡ã€‚</li><li><code>conn.commit</code> æäº¤ XA äº‹åŠ¡ã€‚</li></ul><h2 id="3-2-MyCAT-å¼€å¯-XA-äº‹åŠ¡"><a href="#3-2-MyCAT-å¼€å¯-XA-äº‹åŠ¡" class="headerlink" title="3.2 MyCAT å¼€å¯ XA äº‹åŠ¡"></a>3.2 MyCAT å¼€å¯ XA äº‹åŠ¡</h2><p>å½“ MyCAT æ¥æ”¶åˆ° <code>set xa = on</code> å‘½ä»¤æ—¶ï¼Œå¼€å¯ XA äº‹åŠ¡ï¼Œå¹¶ç”Ÿæˆ XA äº‹åŠ¡ç¼–å·ã€‚XA äº‹åŠ¡ç¼–å·ç”Ÿæˆç®—æ³•ä¸º UUIDã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SetHandler.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String stmt, ServerConnection c, <span class="keyword">int</span> offset)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> rs = ServerParseSet.parse(stmt, offset);</div><div class="line">		<span class="keyword">switch</span> (rs &amp; <span class="number">0xff</span>) &#123;</div><div class="line">		<span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line">		<span class="keyword">case</span> XA_FLAG_ON: &#123;</div><div class="line">			<span class="keyword">if</span> (c.isAutocommit()) &#123;</div><div class="line">				c.writeErrMessage(ErrorCode.ERR_WRONG_USED, <span class="string">"set xa cmd on can't used in autocommit connection "</span>);</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			c.getSession2().setXATXEnabled(<span class="keyword">true</span>);</div><div class="line">			c.write(c.writeToBuffer(OkPacket.OK, c.allocate()));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">case</span> XA_FLAG_OFF: &#123;</div><div class="line">			c.writeErrMessage(ErrorCode.ERR_WRONG_USED,</div><div class="line">					<span class="string">"set xa cmd off not for external use "</span>);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// NonBlockingSession.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setXATXEnabled</span><span class="params">(<span class="keyword">boolean</span> xaTXEnabled)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (xaTXEnabled) &#123;</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.xaTXID == <span class="keyword">null</span>) &#123;</div><div class="line">           xaTXID = genXATXID(); <span class="comment">// ğŸ˜ˆğŸ˜ˆğŸ˜ˆè·å¾— XA äº‹åŠ¡ç¼–å·</span></div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">this</span>.xaTXID = <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">genXATXID</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> MycatServer.getInstance().getXATXIDGLOBAL();</div><div class="line">&#125;</div><div class="line"><span class="comment">// MycatServer.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getXATXIDGLOBAL</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="string">"'"</span> + getUUID() + <span class="string">"'"</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUUID</span><span class="params">()</span> </span>&#123; <span class="comment">// ğŸ˜ˆğŸ˜ˆğŸ˜ˆ</span></div><div class="line">   String s = UUID.randomUUID().toString();</div><div class="line">   <span class="keyword">return</span> s.substring(<span class="number">0</span>, <span class="number">8</span>) + s.substring(<span class="number">9</span>, <span class="number">13</span>) + s.substring(<span class="number">14</span>, <span class="number">18</span>) + s.substring(<span class="number">19</span>, <span class="number">23</span>) + s.substring(<span class="number">24</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="3-3-MyCAT-æ¥æ”¶-SQL"><a href="#3-3-MyCAT-æ¥æ”¶-SQL" class="headerlink" title="3.3 MyCAT æ¥æ”¶ SQL"></a>3.3 MyCAT æ¥æ”¶ SQL</h2><p>æ­¤å¤„ SQL æŒ‡çš„æ˜¯ <code>insert</code>ã€<code>update</code>ã€<code>delete</code> æ“ä½œã€‚</p><p>å½“å‘æŸä¸ªæ•°æ®èŠ‚ç‚¹<strong>ç¬¬ä¸€æ¬¡</strong>å‘èµ· SQL æ—¶ï¼Œä¼šåœ¨ SQL å‰é¢é™„åŠ  <code>XA START &#39;xaTranId&#39;</code>ï¼Œå¹¶è®¾ç½®è¯¥æ•°æ®èŠ‚ç‚¹<strong>è¿æ¥</strong>äº‹åŠ¡çŠ¶æ€ä¸º <code>TxState.TX_STARTED_STATE</code>ï¼ˆ<em>åˆ†å¸ƒå¼äº‹åŠ¡çŠ¶æ€ï¼Œä¸‹æ–‡ä¼šä¸“é—¨æ•´ç†</em>ï¼‰ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MySQLConnection.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">synAndDoExecute</span><span class="params">(String xaTxID, RouteResultsetNode rrn,</span></span></div><div class="line">                                 <span class="keyword">int</span> clientCharSetIndex, <span class="keyword">int</span> clientTxIsoLation,</div><div class="line">                                 <span class="keyword">boolean</span> clientAutoCommit) &#123;</div><div class="line">   String xaCmd = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">boolean</span> conAutoComit = <span class="keyword">this</span>.autocommit;</div><div class="line">   String conSchema = <span class="keyword">this</span>.schema;</div><div class="line">   <span class="comment">// never executed modify sql,so auto commit</span></div><div class="line">   <span class="keyword">boolean</span> expectAutocommit = !modifiedSQLExecuted || isFromSlaveDB() || clientAutoCommit;</div><div class="line">   <span class="keyword">if</span> (expectAutocommit == <span class="keyword">false</span> &amp;&amp; xaTxID != <span class="keyword">null</span> &amp;&amp; xaStatus == TxState.TX_INITIALIZE_STATE) &#123; <span class="comment">// ğŸ˜ˆğŸ˜ˆğŸ˜ˆ</span></div><div class="line">       xaCmd = <span class="string">"XA START "</span> + xaTxID + <span class="string">';'</span>;</div><div class="line">       <span class="keyword">this</span>.xaStatus = TxState.TX_STARTED_STATE;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">   <span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line">   <span class="keyword">if</span> (xaCmd != <span class="keyword">null</span>) &#123;</div><div class="line">       sb.append(xaCmd);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// and our query sql to multi command at last</span></div><div class="line">   sb.append(rrn.getStatement() + <span class="string">";"</span>);</div><div class="line">   <span class="comment">// syn and execute others</span></div><div class="line">   <span class="keyword">this</span>.sendQueryCmd(sb.toString());</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ä¸¾ä¸ª å˜é‡<code>sb</code> çš„ä¾‹å­ï¼š</p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SET</span> <span class="keyword">names</span> utf8;<span class="keyword">SET</span> autocommit=<span class="number">0</span>;XA <span class="keyword">START</span> <span class="string">'1f2da7353e8846e5833b8d8dd041cfb1'</span>,<span class="string">'db2'</span>;<span class="keyword">insert</span> <span class="keyword">into</span> t_user(<span class="keyword">id</span>, username, <span class="keyword">password</span>) <span class="keyword">VALUES</span> (<span class="number">3400</span>, <span class="string">'b7c5ec1f-11cc-4599-851c-06ad617fec42'</span>, <span class="string">'d2694679-f6a2-4623-a339-48d4a868be90'</span>);</div></pre></td></tr></table></figure><h2 id="3-4-MySQL-æ¥æ”¶-COMMIT"><a href="#3-4-MySQL-æ¥æ”¶-COMMIT" class="headerlink" title="3.4 MySQL æ¥æ”¶ COMMIT"></a>3.4 MySQL æ¥æ”¶ COMMIT</h2><h3 id="3-4-1-å•èŠ‚ç‚¹äº‹åŠ¡-or-å¤šèŠ‚ç‚¹äº‹åŠ¡"><a href="#3-4-1-å•èŠ‚ç‚¹äº‹åŠ¡-or-å¤šèŠ‚ç‚¹äº‹åŠ¡" class="headerlink" title="3.4.1 å•èŠ‚ç‚¹äº‹åŠ¡ or å¤šèŠ‚ç‚¹äº‹åŠ¡"></a>3.4.1 å•èŠ‚ç‚¹äº‹åŠ¡ or å¤šèŠ‚ç‚¹äº‹åŠ¡</h3><p><code>COMMIT</code> æ‰§è¡Œæ—¶ï¼ŒMyCAT ä¼šåˆ¤æ–­ XA äº‹åŠ¡é‡Œï¼Œæ¶‰åŠåˆ°çš„æ•°æ®åº“èŠ‚ç‚¹æ•°é‡ã€‚</p><ul><li>å¦‚æœèŠ‚ç‚¹æ•°é‡ä¸º 1ï¼Œå•èŠ‚ç‚¹äº‹åŠ¡ï¼Œä½¿ç”¨ <code>CommitNodeHandler</code> å¤„ç†ã€‚</li><li>å¦‚æœèŠ‚ç‚¹æ•°é‡ &gt; 1ï¼Œå¤šèŠ‚ç‚¹äº‹åŠ¡ï¼Œä½¿ç”¨ <code>MultiNodeCoordinator</code> å¤„ç†ã€‚</li></ul><p><code>CommitNodeHandler</code> ç›¸æ¯” <code>MultiNodeCoordinator</code> æ¥è¯´ï¼Œåªæœ‰ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ï¼Œä¸éœ€è¦è¿›è¡Œå¤šèŠ‚ç‚¹åè°ƒï¼Œé€»è¾‘ä¼šç›¸å¯¹ç®€å•ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å¦å¤–çœ‹ã€‚æˆ‘ä»¬ä¸»è¦åˆ†æ <code>MultiNodeCoordinator</code>ã€‚</p><h3 id="3-4-2-åè°ƒæ—¥å¿—"><a href="#3-4-2-åè°ƒæ—¥å¿—" class="headerlink" title="3.4.2 åè°ƒæ—¥å¿—"></a>3.4.2 åè°ƒæ—¥å¿—</h3><p><strong>åè°ƒæ—¥å¿—</strong>ï¼Œè®°å½•åè°ƒè¿‡ç¨‹ä¸­å„æ•°æ®èŠ‚ç‚¹ XA äº‹åŠ¡çŠ¶æ€ï¼Œå¤„ç†<strong>MyCATå¼‚å¸¸å¥”æºƒ</strong>æˆ–è€…<strong>æ•°æ®èŠ‚ç‚¹éƒ¨åˆ†XA COMMITï¼Œå¦å¤–éƒ¨åˆ† XA PREPARE</strong>ä¸‹çš„çŠ¶æ€æ¢å¤ã€‚</p><p><strong>XA äº‹åŠ¡å…±æœ‰ç§</strong>ï¼š</p><ol><li>TX_INITIALIZE_STATE ï¼šäº‹åŠ¡åˆå§‹åŒ–</li><li>TX_STARTED_STATE ï¼šäº‹åŠ¡å¼€å§‹å®Œæˆ</li><li>TX_PREPARED_STATE ï¼šäº‹åŠ¡å‡†å¤‡å®Œæˆ</li><li>TX_COMMITED_STATE ï¼šäº‹åŠ¡æäº¤å®Œæˆ</li><li>TX_ROLLBACKED_STATE ï¼šäº‹åŠ¡å›æ»šå®Œæˆ</li></ol><p><strong>çŠ¶æ€å˜æ›´æµ</strong> ï¼šTX_INITIALIZE_STATE =&gt; TX_STARTED_STATE =&gt; TX_PREPARED_STATE =&gt; TX_COMMITED_STATE / TX_ROLLBACKED_STATE ã€‚</p><p><strong>åè°ƒæ—¥å¿—åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†</strong>ï¼š</p><ol><li>CoordinatorLogEntry ï¼šåè°ƒè€…æ—¥å¿—</li><li>ParticipantLogEntry ï¼šå‚ä¸è€…æ—¥å¿—ã€‚<strong>æ­¤å¤„ï¼Œæ•°æ®èŠ‚ç‚¹æ‰®æ¼”å‚ä¸è€…çš„è§’è‰²ã€‚ä¸‹æ–‡ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°å‚ä¸è€…ä¸æ•°æ®èŠ‚ç‚¹æ··ç”¨çš„æƒ…å†µï¼Œæœ›è§è°…ã€‚</strong></li></ol><p><em>ä¸€æ¬¡ XA äº‹åŠ¡ï¼Œå¯¹åº”ä¸€æ¡ <code>CoordinatorLogEntry</code>ã€‚ä¸€æ¡<code>CoordinatorLogEntry</code> åŒ…å« Næ¡<code>ParticipantLogEntry</code></em>ã€‚ æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CoordinatorLogEntry ï¼šåè°ƒè€…æ—¥å¿—</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CoordinatorLogEntry</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * XA äº‹åŠ¡ç¼–å·</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String id;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å‚ä¸è€…æ—¥å¿—æ•°ç»„</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ParticipantLogEntry[] participants;</div><div class="line">&#125;</div><div class="line"><span class="comment">// ParticipantLogEntry ï¼šå‚ä¸è€…æ—¥å¿—</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParticipantLogEntry</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * XA äº‹åŠ¡ç¼–å·</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> String coordinatorId;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•°æ®åº“ uri</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> String uri;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¿‡æœŸæè¿°</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">long</span> expires;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * XA äº‹åŠ¡çŠ¶æ€</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> txState;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å‚ä¸è€…åå­—</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> String resourceName;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p><strong>MyCAT è®°å½•åè°ƒæ—¥å¿—ä»¥ JSONæ ¼å¼ åˆ°æ–‡ä»¶</strong>ã€‚<strong>æ¯è¡Œ</strong>åŒ…å«ä¸€æ¡<code>CoordinatorLogEntry</code>ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;<span class="attr">"id"</span>:<span class="string">"'e827b3fe666c4d968961350d19adda31'"</span>,<span class="attr">"participants"</span>:[&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db3"</span>&#125;,&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db1"</span>&#125;]&#125;</div><div class="line">&#123;<span class="attr">"id"</span>:<span class="string">"'f00b61fa17cb4ec5b8264a6d82f847d0'"</span>,<span class="attr">"participants"</span>:[&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db2"</span>&#125;,&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db1"</span>&#125;]&#125;</div></pre></td></tr></table></figure><p>å®ç°ç±»ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// XA åè°ƒè€…æ—¥å¿— å­˜å‚¨æ¥å£ï¼šhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/Repository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Repository</span> </span>&#123;&#125;</div><div class="line"><span class="comment">// XA åè°ƒè€…æ—¥å¿— æ–‡ä»¶å­˜å‚¨ï¼šhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/impl/FileSystemRepository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileSystemRepository</span> <span class="keyword">implements</span> <span class="title">Repository</span> </span>&#123;&#125;</div><div class="line"><span class="comment">// XA åè°ƒè€…æ—¥å¿— æ–‡ä»¶å­˜å‚¨ï¼šhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/impl/InMemoryRepository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InMemoryRepository</span> <span class="keyword">implements</span> <span class="title">Repository</span> </span>&#123;&#125;</div></pre></td></tr></table></figure><p>ç›®å‰æ—¥å¿—æ–‡ä»¶å†™å…¥çš„æ–¹å¼æ€§èƒ½è¾ƒå·®ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸åšåˆ†æï¼Œåœ¨ã€4. MyCAT å®ç°ç¼ºé™·ã€‘é‡Œä¸€èµ·è®²ã€‚</p><h3 id="3-4-3-MultiNodeCoordinator"><a href="#3-4-3-MultiNodeCoordinator" class="headerlink" title="3.4.3 MultiNodeCoordinator"></a>3.4.3 MultiNodeCoordinator</h3><p>æ•²æ•²æ•²ï¼Œè¿™é‡Œæ˜¯æœ¬æ–‡çš„é‡ç‚¹ä¹‹ä¸€å™¢ã€‚ğŸ˜ˆ</p><p><strong>ç¬¬ä¸€é˜¶æ®µï¼šå‘èµ· PREPAREã€‚</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeBatchNodeCmd</span><span class="params">(SQLCtrlCommand cmdHandler)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.cmdHandler = cmdHandler;</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> initCount = session.getTargetCount();</div><div class="line">   runningCount.set(initCount);</div><div class="line">   nodeCount = initCount;</div><div class="line">   failed.set(<span class="keyword">false</span>);</div><div class="line">   faileCount.set(<span class="number">0</span>);</div><div class="line">   <span class="comment">//recovery nodes log</span></div><div class="line">   ParticipantLogEntry[] participantLogEntry = <span class="keyword">new</span> ParticipantLogEntry[initCount];</div><div class="line">   <span class="comment">// æ‰§è¡Œ</span></div><div class="line">   <span class="keyword">int</span> started = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (RouteResultsetNode rrn : session.getTargetKeys()) &#123;</div><div class="line">       <span class="keyword">if</span> (rrn == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">final</span> BackendConnection conn = session.getTarget(rrn);</div><div class="line">       <span class="keyword">if</span> (conn != <span class="keyword">null</span>) &#123;</div><div class="line">           conn.setResponseHandler(<span class="keyword">this</span>);</div><div class="line">           <span class="comment">//process the XA_END XA_PREPARE Command</span></div><div class="line">           MySQLConnection mysqlCon = (MySQLConnection) conn;</div><div class="line">           String xaTxId = <span class="keyword">null</span>;</div><div class="line">           <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) &#123;</div><div class="line">               xaTxId = session.getXaTXID() + <span class="string">",'"</span> + mysqlCon.getSchema() + <span class="string">"'"</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (mysqlCon.getXaStatus() == TxState.TX_STARTED_STATE) &#123; <span class="comment">// XA äº‹åŠ¡</span></div><div class="line">               <span class="comment">//recovery Log</span></div><div class="line">               participantLogEntry[started] = <span class="keyword">new</span> ParticipantLogEntry(xaTxId, conn.getHost(), <span class="number">0</span>, conn.getSchema(), ((MySQLConnection) conn).getXaStatus());</div><div class="line">               String[] cmds = <span class="keyword">new</span> String[]&#123;<span class="string">"XA END "</span> + xaTxId, <span class="comment">// XA END å‘½ä»¤</span></div><div class="line">                       <span class="string">"XA PREPARE "</span> + xaTxId&#125;; <span class="comment">// XA PREPARE å‘½ä»¤</span></div><div class="line">               mysqlCon.execBatchCmd(cmds);</div><div class="line">           &#125; <span class="keyword">else</span> &#123; <span class="comment">// é XA äº‹åŠ¡</span></div><div class="line">               <span class="comment">// recovery Log</span></div><div class="line">               participantLogEntry[started] = <span class="keyword">new</span> ParticipantLogEntry(xaTxId, conn.getHost(), <span class="number">0</span>, conn.getSchema(), ((MySQLConnection) conn).getXaStatus());</div><div class="line">               cmdHandler.sendCommand(session, conn);</div><div class="line">           &#125;</div><div class="line">           ++started;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// xa recovery log</span></div><div class="line">   <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) &#123;</div><div class="line">       CoordinatorLogEntry coordinatorLogEntry = <span class="keyword">new</span> CoordinatorLogEntry(session.getXaTXID(), <span class="keyword">false</span>, participantLogEntry);</div><div class="line">       inMemoryRepository.put(session.getXaTXID(), coordinatorLogEntry);</div><div class="line">       fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (started &lt; nodeCount) &#123; <span class="comment">// TODO ç–‘é—®ï¼šå¦‚ä½•è§¦å‘</span></div><div class="line">       runningCount.set(started);</div><div class="line">       LOGGER.warn(<span class="string">"some connection failed to execute "</span> + (nodeCount - started));</div><div class="line">       <span class="comment">/**</span></div><div class="line">        * assumption: only caused by front-end connection close. &lt;br/&gt;</div><div class="line">        * Otherwise, packet must be returned to front-end</div><div class="line">        */</div><div class="line">       failed.set(<span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å‘å„æ•°æ®èŠ‚ç‚¹å‘é€ <code>XA END</code> + <code>XA PREPARE</code> æŒ‡ä»¤ã€‚ä¸¾ä¸ª å˜é‡<code>cmds</code> ä¾‹å­ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">XA <span class="keyword">END</span> <span class="string">'4cbb18214d0b47adbdb0658598666677'</span>,<span class="string">'db3'</span>;XA <span class="keyword">PREPARE</span> <span class="string">'4cbb18214d0b47adbdb0658598666677'</span>,<span class="string">'db3'</span>;</div></pre></td></tr></table></figure><ul><li>è®°å½•åè°ƒæ—¥å¿—ã€‚æ¯æ¡å‚ä¸è€…æ—¥å¿—çŠ¶æ€ä¸º <code>TxState.TX_STARTED_STATE</code>ã€‚</li></ul><hr><p><strong>ç¬¬äºŒé˜¶æ®µï¼šå‘èµ· COMMITã€‚</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">okResponse</span><span class="params">(<span class="keyword">byte</span>[] ok, BackendConnection conn)</span> </span>&#123;</div><div class="line">   <span class="comment">// process the XA Transatcion 2pc commit</span></div><div class="line">   <span class="keyword">if</span> (conn <span class="keyword">instanceof</span> MySQLConnection) &#123;</div><div class="line">       MySQLConnection mysqlCon = (MySQLConnection) conn;</div><div class="line">       <span class="keyword">switch</span> (mysqlCon.getXaStatus()) &#123;</div><div class="line">           <span class="keyword">case</span> TxState.TX_STARTED_STATE:</div><div class="line">               <span class="comment">//if there have many SQL execute wait the okResponse,will come to here one by one</span></div><div class="line">               <span class="comment">//should be wait all nodes ready ,then send xa commit to all nodes.</span></div><div class="line">               <span class="keyword">if</span> (mysqlCon.batchCmdFinished()) &#123;</div><div class="line">                   String xaTxId = session.getXaTXID();</div><div class="line">                   String cmd = <span class="string">"XA COMMIT "</span> + xaTxId + <span class="string">",'"</span> + mysqlCon.getSchema() + <span class="string">"'"</span>;</div><div class="line">                   <span class="keyword">if</span> (LOGGER.isDebugEnabled()) &#123;</div><div class="line">                       LOGGER.debug(<span class="string">"Start execute the cmd :"</span> + cmd + <span class="string">",current host:"</span> + mysqlCon.getHost() + <span class="string">":"</span> + mysqlCon.getPort());</div><div class="line">                   &#125;</div><div class="line">                   <span class="comment">// recovery log</span></div><div class="line">                   CoordinatorLogEntry coordinatorLogEntry = inMemoryRepository.get(xaTxId);</div><div class="line">                   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntry.participants.length; i++) &#123;</div><div class="line">                       LOGGER.debug(<span class="string">"[In Memory CoordinatorLogEntry]"</span> + coordinatorLogEntry.participants[i]);</div><div class="line">                       <span class="keyword">if</span> (coordinatorLogEntry.participants[i].resourceName.equals(conn.getSchema())) &#123;</div><div class="line">                           coordinatorLogEntry.participants[i].txState = TxState.TX_PREPARED_STATE;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">                   inMemoryRepository.put(xaTxId, coordinatorLogEntry);</div><div class="line">                   fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">                   <span class="comment">// send commit</span></div><div class="line">                   mysqlCon.setXaStatus(TxState.TX_PREPARED_STATE);</div><div class="line">                   mysqlCon.execCmd(cmd);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           <span class="keyword">case</span> TxState.TX_PREPARED_STATE: &#123;</div><div class="line">               <span class="comment">// recovery log</span></div><div class="line">               String xaTxId = session.getXaTXID();</div><div class="line">               CoordinatorLogEntry coordinatorLogEntry = inMemoryRepository.get(xaTxId);</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntry.participants.length; i++) &#123;</div><div class="line">                   <span class="keyword">if</span> (coordinatorLogEntry.participants[i].resourceName.equals(conn.getSchema())) &#123;</div><div class="line">                       coordinatorLogEntry.participants[i].txState = TxState.TX_COMMITED_STATE;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">               inMemoryRepository.put(xaTxId, coordinatorLogEntry);</div><div class="line">               fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">               <span class="comment">// XA reset status now</span></div><div class="line">               mysqlCon.setXaStatus(TxState.TX_INITIALIZE_STATE);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">default</span>:</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// é‡Šæ”¾è¿æ¥</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.cmdHandler.relaseConOnOK()) &#123;</div><div class="line">       session.releaseConnection(conn);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       session.releaseConnectionIfSafe(conn, LOGGER.isDebugEnabled(), <span class="keyword">false</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ˜¯å¦æ‰€æœ‰èŠ‚ç‚¹éƒ½å®Œæˆcommitï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å›Client æˆåŠŸ</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.finished()) &#123;</div><div class="line">       cmdHandler.okResponse(session, ok);</div><div class="line">       <span class="keyword">if</span> (cmdHandler.isAutoClearSessionCons()) &#123;</div><div class="line">           session.clearResources(<span class="keyword">false</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">/* 1.  äº‹åŠ¡æäº¤å,xa äº‹åŠ¡ç»“æŸ   */</span></div><div class="line">       <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) &#123;</div><div class="line">           session.setXATXEnabled(<span class="keyword">false</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">/* 2. preAcStates ä¸ºtrue,äº‹åŠ¡ç»“æŸå,éœ€è¦è®¾ç½®ä¸ºtrueã€‚preAcStates ä¸ºacä¸Šä¸€ä¸ªçŠ¶æ€    */</span></div><div class="line">       <span class="keyword">if</span> (session.getSource().isPreAcStates()) &#123;</div><div class="line">           session.getSource().setAutocommit(<span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>mysqlCon.batchCmdFinished()</code> æ¯ä¸ªæ•°æ®èŠ‚ç‚¹ï¼Œç¬¬ä¸€æ¬¡è¿”å›çš„æ˜¯ <code>XA END</code> æˆåŠŸï¼Œç¬¬äºŒæ¬¡è¿”å›çš„æ˜¯ <code>XA PREPARE</code>ã€‚åœ¨ <code>XA PREPARE</code> æˆåŠŸåï¼Œè®°å½•è¯¥æ•°æ®èŠ‚ç‚¹çš„<strong>å‚ä¸è€…æ—¥å¿—</strong>çŠ¶æ€ä¸º <code>TxState.TX_PREPARED_STATE</code>ã€‚ä¹‹åï¼Œå‘è¯¥æ•°æ®èŠ‚ç‚¹å‘èµ· <code>XA COMMIT</code> å‘½ä»¤ã€‚</li><li><code>XA COMMIT</code> è¿”å›æˆåŠŸåï¼Œè®°å½•è¯¥æ•°æ®èŠ‚ç‚¹çš„<strong>äº‹åŠ¡å‚ä¸è€…æ—¥å¿—</strong>çŠ¶æ€ä¸º <code>TxState.TX_COMMITED_STATE</code>ã€‚</li><li>å½“æ‰€æœ‰æ•°æ®èŠ‚ç‚¹ï¼ˆå‚ä¸è€…ï¼‰éƒ½æ‰§è¡Œå®Œæˆ <code>XA COMMIT</code> è¿”å›ï¼Œå³ <code>this.finished() == true</code>ï¼Œè¿”å› MySQL Client XA äº‹åŠ¡æäº¤æˆåŠŸã€‚</li></ul><p>[x] <code>XA PREPARE</code> å’Œ <code>XA COMMIT</code>ï¼Œæ•°æ®èŠ‚ç‚¹å¯èƒ½è¿”å›å¤±è´¥ï¼Œç›®å‰æš‚æ—¶æ²¡æ¨¡æ‹Ÿå‡ºæ¥ï¼Œå¯¹åº”æ–¹æ³•ä¸º <code>#errorResponse(....)</code>ã€‚</p><h2 id="3-5-MyCAT-å¯åŠ¨å›æ»š-XAäº‹åŠ¡"><a href="#3-5-MyCAT-å¯åŠ¨å›æ»š-XAäº‹åŠ¡" class="headerlink" title="3.5 MyCAT å¯åŠ¨å›æ»š XAäº‹åŠ¡"></a>3.5 MyCAT å¯åŠ¨å›æ»š XAäº‹åŠ¡</h2><p>MyCAT å¯åŠ¨æ—¶ï¼Œä¼š<strong>å›æ»šå¤„äºTxState.TX_PREPARED_STATE</strong>çš„ <code>ParticipantLogEntry</code> å¯¹åº”çš„æ•°æ®èŠ‚ç‚¹çš„ XA äº‹åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MycatServer.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performXARecoveryLog</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// fetch the recovery log</span></div><div class="line">   CoordinatorLogEntry[] coordinatorLogEntries = getCoordinatorLogEntries();</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntries.length; i++) &#123;</div><div class="line">       CoordinatorLogEntry coordinatorLogEntry = coordinatorLogEntries[i];</div><div class="line">       <span class="keyword">boolean</span> needRollback = <span class="keyword">false</span>;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; coordinatorLogEntry.participants.length; j++) &#123;</div><div class="line">           ParticipantLogEntry participantLogEntry = coordinatorLogEntry.participants[j];</div><div class="line">           <span class="keyword">if</span> (participantLogEntry.txState == TxState.TX_PREPARED_STATE) &#123;</div><div class="line">               needRollback = <span class="keyword">true</span>;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (needRollback) &#123;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; coordinatorLogEntry.participants.length; j++) &#123;</div><div class="line">               ParticipantLogEntry participantLogEntry = coordinatorLogEntry.participants[j];</div><div class="line">               <span class="comment">//XA rollback</span></div><div class="line">               String xacmd = <span class="string">"XA ROLLBACK "</span> + coordinatorLogEntry.id + <span class="string">';'</span>;</div><div class="line">               OneRawSQLQueryResultHandler resultHandler = <span class="keyword">new</span> OneRawSQLQueryResultHandler(<span class="keyword">new</span> String[<span class="number">0</span>], <span class="keyword">new</span> XARollbackCallback());</div><div class="line">               outloop:</div><div class="line">               <span class="keyword">for</span> (SchemaConfig schema : MycatServer.getInstance().getConfig().getSchemas().values()) &#123;</div><div class="line">                   <span class="keyword">for</span> (TableConfig table : schema.getTables().values()) &#123;</div><div class="line">                       <span class="keyword">for</span> (String dataNode : table.getDataNodes()) &#123;</div><div class="line">                           PhysicalDBNode dn = MycatServer.getInstance().getConfig().getDataNodes().get(dataNode);</div><div class="line">                           <span class="keyword">if</span> (dn.getDbPool().getSource().getConfig().getIp().equals(participantLogEntry.uri)</div><div class="line">                                   &amp;&amp; dn.getDatabase().equals(participantLogEntry.resourceName)) &#123;</div><div class="line">                               <span class="comment">//XA STATE ROLLBACK</span></div><div class="line">                               participantLogEntry.txState = TxState.TX_ROLLBACKED_STATE;</div><div class="line">                               SQLJob sqlJob = <span class="keyword">new</span> SQLJob(xacmd, dn.getDatabase(), resultHandler, dn.getDbPool().getSource());</div><div class="line">                               sqlJob.run();</div><div class="line">                               <span class="keyword">break</span> outloop;</div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// init into in memory cached</span></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntries.length; i++) &#123;</div><div class="line">  MultiNodeCoordinator.inMemoryRepository.put(coordinatorLogEntries[i].id, coordinatorLogEntries[i]);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// discard the recovery log</span></div><div class="line">    MultiNodeCoordinator.fileRepository.writeCheckpoint(MultiNodeCoordinator.inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">&#125;</div></pre></td></tr></table></figure><h1 id="4-MyCAT-å®ç°ç¼ºé™·"><a href="#4-MyCAT-å®ç°ç¼ºé™·" class="headerlink" title="4. MyCAT å®ç°ç¼ºé™·"></a>4. MyCAT å®ç°ç¼ºé™·</h1><p>MyCAT 1.6.5 ç‰ˆæœ¬å®ç°å¼±XAäº‹åŠ¡ï¼Œç›¸å¯¹æ¥è¯´ï¼Œç¬”è€…è®¤ä¸ºè·ç¦»å®é™…ç”Ÿäº§ä½¿ç”¨å­˜åœ¨ä¸€äº›å·®è·ã€‚ä¸‹é¢ç½—åˆ—å¯èƒ½å­˜åœ¨çš„ç¼ºé™·ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œéº»çƒ¦æŒ‡å‡ºã€‚ğŸ™‚å¸Œæœ› MyCAT åœ¨åˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°ä¸Šï¼Œèƒ½å¤Ÿè¶Šæ¥è¶Šç»™åŠ›ã€‚</p><h2 id="4-1-åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½"><a href="#4-1-åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½" class="headerlink" title="4.1 åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½"></a>4.1 åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½</h2><p>1ã€<code>CoordinatorLogEntry</code>ã€<code>ParticipantLogEntry</code> åœ¨æ¯æ¬¡å†™å…¥æ–‡ä»¶æ—¶ï¼Œæ˜¯å°†å†…å­˜ä¸­æ‰€æœ‰çš„æ—¥å¿—<strong>å…¨éƒ¨é‡æ–°</strong>å†™å…¥ï¼Œå¯¼è‡´å†™å…¥æ€§èƒ½éšç€ XA äº‹åŠ¡æ¬¡æ•°çš„å¢åŠ ï¼Œæ€§èƒ½ä¼šè¶Šæ¥è¶Šç³Ÿç³•ï¼Œå¯¼è‡´ XA äº‹åŠ¡æ•´ä½“æ€§èƒ½ä¼šéå¸¸å·®ã€‚å¦å¤–ï¼Œè¯¥æ–¹æ³•æ˜¯<strong>åŒæ­¥</strong>çš„ï¼Œä¹ŸåŠ å¤§äº†å†™å…¥çš„å»¶è¿Ÿã€‚</p><p>å»ºè®®ï¼šå…ˆè·å¾—å¯å†™å…¥æ–‡ä»¶çš„ OFFSETï¼Œå†™å…¥åè°ƒæ—¥å¿—åˆ°æ–‡ä»¶ï¼Œå†…å­˜ç»´æŠ¤å¥½ XAäº‹åŠ¡ç¼–å· ä¸ OFFSET çš„æ˜ å°„å…³ç³»ï¼Œä»è€Œå®ç°<strong>é¡ºåºå†™å…¥</strong> + <strong>å¹¶è¡Œå†™å…¥</strong>ã€‚</p><p>2ã€å†…å­˜é‡Œç»´æŠ¤äº†æ‰€æœ‰çš„åè°ƒæ—¥å¿—ï¼Œå ç”¨å†…å­˜ä¼šè¶Šæ¥è¶Šå¤§ï¼Œå¹¶ä¸”æ— é‡Šæ”¾æœºåˆ¶ã€‚å³ä½¿é‡å¯ï¼Œåè°ƒæ—¥å¿—ä¹Ÿä¼šé‡æ–°åŠ è½½åˆ°å†…å­˜ã€‚</p><p>å»ºè®®ï¼šå·²å®Œå…¨å›æ»šæˆ–è€…æäº¤çš„åè°ƒæ—¥å¿—ä¸æ”¾å…¥å†…å­˜ã€‚å¦å¤–æœ‰æ–‡ä»¶å­˜å‚¨å¥½ XAäº‹åŠ¡ç¼–å· ä¸ OFFSET çš„æ˜ å°„å…³ç³»ã€‚</p><p>3ã€åè°ƒæ—¥å¿—åªå†™å…¥å•ä¸ªæ–‡ä»¶ã€‚</p><p>å»ºè®®ï¼šåˆ†æ‹†åè°ƒæ—¥å¿—æ–‡ä»¶ã€‚</p><p>PSï¼šæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹ <code>RocketMQ</code> å¯¹ <code>CommitLog</code> çš„å­˜å‚¨ï¼Œæ€§èƒ½ä¸Šå¾ˆèµï¼</p><h2 id="4-2-æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨-PREPARE-å°±è¿›è¡Œ-COMMIT"><a href="#4-2-æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨-PREPARE-å°±è¿›è¡Œ-COMMIT" class="headerlink" title="4.2 æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨ PREPARE å°±è¿›è¡Œ COMMIT"></a>4.2 æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨ PREPARE å°±è¿›è¡Œ COMMIT</h2><p>XA äº‹åŠ¡å®šä¹‰ï¼Œéœ€è¦ç­‰å¾…æ‰€æœ‰å‚ä¸è€…<strong>å…¨éƒ¨</strong> <code>XA PREPARE</code> æˆåŠŸå®Œæˆåå‘èµ· <code>XA COMMIT</code>ã€‚ç›®å‰ MyCAT æ˜¯æŸä¸ªæ•°æ®èŠ‚ç‚¹ <code>XA PREPARE</code> å®Œæˆå<strong>ç«‹å³</strong>è¿›è¡Œ <code>XA COMMIT</code>ã€‚æ¯”å¦‚è¯´ï¼šç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹æäº¤äº† <code>XA END;XA PREPARE</code> æ—¶ï¼Œç¬¬äºŒä¸ªæ•°æ®èŠ‚åœ¨è¿›è¡Œ <code>XA END;XA PREAPRE;</code> å‰æŒ‚äº†ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¾ç„¶ä¼š <code>XA COMMIT</code> æˆåŠŸã€‚</p><p>å»ºè®®ï¼šæŒ‰ç…§ä¸¥æ ¼çš„ XA äº‹åŠ¡å®šä¹‰ã€‚</p><h2 id="4-3-MyCAT-å¯åŠ¨å›æ»š-PREPARE-çš„-XAäº‹åŠ¡"><a href="#4-3-MyCAT-å¯åŠ¨å›æ»š-PREPARE-çš„-XAäº‹åŠ¡" class="headerlink" title="4.3 MyCAT å¯åŠ¨å›æ»š PREPARE çš„ XAäº‹åŠ¡"></a>4.3 MyCAT å¯åŠ¨å›æ»š PREPARE çš„ XAäº‹åŠ¡</h2><p>1ã€MyCAT å¯åŠ¨æ—¶ï¼Œå›æ»šæ‰€æœ‰çš„ <code>PREPARE</code> çš„ XA äº‹åŠ¡ï¼Œå¯èƒ½æŸä¸ª XA äº‹åŠ¡ï¼Œéƒ¨åˆ† <code>COMMIT</code>ï¼Œéƒ¨åˆ† <code>PREPARE</code>ã€‚æ­¤æ—¶ç›´æ¥å›æ»šï¼Œä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚</p><p>å»ºè®®ï¼šå½“åˆ¤æ–­åˆ°æŸä¸ª XA äº‹åŠ¡å­˜åœ¨ <code>PREPARE</code> çš„å‚ä¸è€…ï¼Œ<strong>åŒæ—¶åˆ¤æ–­è¯¥ XA äº‹åŠ¡é‡Œå…¶ä»–å‚ä¸è€…çš„äº‹åŠ¡çŠ¶æ€</strong>ä»¥åŠ<strong>æ•°æ®èŠ‚ç‚¹é‡Œ XA äº‹åŠ¡çŠ¶æ€</strong>ï¼Œæ¯”å¦‚å‚ä¸è€…ä¸º <code>MySQL</code>æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>XA RECOVER</code> æŸ¥è¯¢å¤„äº <code>PREPARE</code> æ‰€æœ‰çš„ XA äº‹åŠ¡ã€‚</p><p>2ã€å›æ»š <code>PREPARE</code> æ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œåœ¨æœªè¿›è¡Œå®Œæˆæ—¶å·²ç»è®¾ç½®æ–‡ä»¶é‡Œå›æ»šæˆåŠŸã€‚å¦‚æœå¼‚æ­¥è¿‡ç¨‹ä¸­å¤±è´¥ï¼Œä¼šå¯¼è‡´ XA äº‹åŠ¡çŠ¶æ€ä¸ä¸€è‡´ã€‚</p><p>å»ºè®®ï¼šå›è°ƒæˆåŠŸåï¼Œæ›´æ–°è¯¥ XA äº‹åŠ¡çŠ¶æ€ã€‚</p><h2 id="4-4-å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—"><a href="#4-4-å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—" class="headerlink" title="4.4 å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—"></a>4.4 å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—</h2><p>è¯¥æƒ…å†µè¾ƒä¸ºæç«¯ã€‚å‘èµ· <code>XA PREPARE</code>å®Œåï¼ŒMyCAT æŒ‚äº†ã€‚é‡å¯åï¼Œè¯¥ XA äº‹åŠ¡åœ¨ MyCAT é‡Œå°±â€œæ¶ˆå¤±â€œäº†ï¼Œå‚ä¸è€…çš„è¯¥ XA äº‹åŠ¡ä¸€ç›´å¤„äº <code>PREPARE</code> çŠ¶æ€ã€‚ä»ç†è®ºä¸Šæ¥è¯´ï¼Œéœ€è¦å›æ»šè¯¥ XA äº‹åŠ¡ã€‚</p><p>å»ºè®®ï¼šè®°å½•åè°ƒæ—¥å¿—ã€‚</p><h2 id="4-5-XA-COMMIT-éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†"><a href="#4-5-XA-COMMIT-éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†" class="headerlink" title="4.5 XA COMMIT éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†"></a>4.5 XA COMMIT éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†</h2><p>å½“ä¸€éƒ¨åˆ†èŠ‚ç‚¹ <code>XA COMMIT</code> å®Œæˆï¼Œå¦å¤–ä¸€éƒ¨åˆ†æ­¤æ—¶æŒ‚äº†ã€‚åœ¨ç®¡ç†å‘˜é‡å¯æŒ‚æ‰çš„èŠ‚ç‚¹ï¼Œå…¶å¯¹åº”çš„ XA äº‹åŠ¡æœªè¿›ä¸€æ­¥å¤„ç†ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚</p><p>å»ºè®®ï¼šğŸ˜ˆæœ¨æœ‰å»ºè®®ã€‚ä¹Ÿå¾ˆå¥½å¥‡ï¼Œå¦‚æœæ˜¯è¿™æ ·çš„æƒ…å†µï¼Œå¦‚ä½•å¤„ç†è¾ƒä¸ºåˆé€‚ã€‚å¦‚æœ‰å¤§å¤§çŸ¥é“ï¼Œçƒ¦è¯·å‘ŠçŸ¥ä¸‹ã€‚</p><h1 id="5-å½©è›‹"><a href="#5-å½©è›‹" class="headerlink" title="5. å½©è›‹"></a>5. å½©è›‹</h1><p>ä¾‹è¡Œâ€œå½©è›‹â€ï¼Ÿ</p><ul><li><a href="http://blog.csdn.net/d6619309/article/details/52330334" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMycatæºç ç¯‡ : MyCatäº‹åŠ¡ç®¡ç†æœºåˆ¶åˆ†æã€‹</a> æ¥è‡ª MyCAT Committer çš„æ–‡ç« </li><li><a href="http://mysql.taobao.org/monthly/2015/04/05/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMySQL Â· æ‰è™«åŠ¨æ€ Â· è¿æ¥æ–­å¼€å¯¼è‡´XAäº‹åŠ¡ä¸¢å¤±ã€‹</a></li><li><a href="http://www.infoq.com/cn/articles/solution-of-distributed-system-transaction-consistency" rel="external nofollow noopener noreferrer" target="_blank">ã€Šåˆ†å¸ƒå¼ç³»ç»Ÿäº‹åŠ¡ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆã€‹</a></li><li><a href="http://blog.csdn.net/fly2749/article/details/44998203" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMySQLæ•°æ®åº“åˆ†å¸ƒå¼äº‹åŠ¡XAä¼˜ç¼ºç‚¹ä¸æ”¹è¿›æ–¹æ¡ˆã€‹</a></li><li><a href="http://www.hollischuang.com/archives/1580" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥ç†è§£åˆ†å¸ƒå¼ç³»ç»Ÿçš„2PCå’Œ3PCã€‹</a></li><li><a href="https://github.com/YunaiV/yunaiv.github.io/blob/master/source/_drafts/MyCAT/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1.xmind" rel="external nofollow noopener noreferrer" target="_blank">ã€åˆ†å¸ƒå¼äº‹åŠ¡.xmindã€‘</a> ç¬”è€…æ‹™ä½œ</li><li><a href="http://www.yunai.me/RocketMQ/message-transaction/?self">ã€ŠRocketMQ æºç åˆ†æ â€”â€” äº‹åŠ¡æ¶ˆæ¯ã€‹</a> ç¬”è€…æ‹™ä½œ</li></ul></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/MyCAT/">MyCAT</a></div><div class="article-share" id="share"><div data-url="http://www.yunai.me/MyCAT/xa-distributed-transaction/" data-title="MyCAT æºç åˆ†æ  â€”â€” XAåˆ†å¸ƒå¼äº‹åŠ¡ | èŠ‹è‰¿Vçš„åšå®¢" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/Sharding-JDBC/why-read-Sharding-JDBC-source-code/" title="Sharding-JDBC æºç åˆ†æ â€”â€” ä¸ºä»€ä¹ˆé˜…è¯» Sharding-JDBC æºç ï¼Ÿ"><strong>PREVIOUS:</strong><br><span>Sharding-JDBC æºç åˆ†æ â€”â€” ä¸ºä»€ä¹ˆé˜…è¯» Sharding-JDBC æºç ï¼Ÿ</span></a></div><div class="next"><a href="/MyCAT/two-table-share-join/" title="MyCAT æºç åˆ†æ  â€”â€” è·¨åº“ä¸¤è¡¨Join"><strong>NEXT:</strong><br><span>MyCAT æºç åˆ†æ â€”â€” è·¨åº“ä¸¤è¡¨Join</span></a></div></nav></div></div><footer><div id="footer"><p class="copyright">Â© 2017 <a href="http://www.yunai.me" target="_blank" title="ç‹æ–‡æ–Œ">ç‹æ–‡æ–Œ</a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a> && Powered by <a href="http://hexo.io" target="_blank" title="hexo" rel="external nofollow noopener noreferrer">hexo</a> && Theme by <a href="http://gengbiao.me" target="_blank" title="coney" rel="external nofollow noopener noreferrer">coney</a></p></div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2");ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script>$(document).ready(function(){function e(){var e=jqueryAlert({title:"ğŸ‘¼æ¯å‘¨å…­æ›´æ–°ä¸€ç¯‡æºç è§£æï¼Œã€æ‰«ä¸€æ‰«ã€‘å…³æ³¨å…¬ä¼—å·ğŸ‘¼",width:"500",height:"500",modal:!0,content:'<img width="400" src="http://www.yunai.me/images/common/wechat_mp_simple.png" />',buttons:{"å·²å…³æ³¨ï¼Œå…³é—­çª—å£":function(){e.close()}}});$.cookie(t,i+1,{expires:1})}var t="doubi",i=$.cookie(t);i?i=parseInt(i):($.cookie(t,0,{expires:1}),i=0),i<=3&&setTimeout(e,1e4*(i+1))})</script></body>